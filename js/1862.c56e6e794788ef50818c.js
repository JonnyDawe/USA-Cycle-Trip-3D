(self.webpackChunk=self.webpackChunk||[]).push([[1862],{21862:(e,t,s)=>{"use strict";s.r(t),s.d(t,{default:()=>b});var a=s(78155),r=s(80987),i=s(73574),u=s(91236),n=s(20215),l=s(80219),o=s(31531),d=s(88903),c=s(98548),h=s(89710),y=s(93028),p=s(56803),m=s(98843),F=s(92858);s(20736),s(4169),s(82906),s(40130),s(52957),s(29126),s(6585),s(3621),s(63358),s(62121),s(81135),s(94527),s(17762),s(60816),s(61888),s(29832),s(31516),s(52109),s(16408),s(78730),s(18143),s(47365),s(67079),s(2903),s(85570),s(71470),s(80136),s(91507),s(65352),s(85289),s(91790),s(52737),s(30316),s(29831);const R=new o.o({originalAndCurrentFeatures:"original-and-current-features",none:"none"}),g=new Set(["Feature Layer","Table"]);let f=class extends r.f{constructor(){super(...arguments),this.type="feature-layer"}load(e){const t=(0,l.r)(e)?e.signal:null;return this.addResolvingPromise(this._fetchService(t)),Promise.resolve(this)}get queryTask(){const{capabilities:{query:{supportsFormatPBF:e}},parsedUrl:t,dynamicDataSource:s,infoFor3D:a,gdbVersion:r,spatialReference:i,fieldsIndex:u}=this.layer,n=(0,l.c)("featurelayer-pbf")&&e&&(0,l.t)(a)?"pbf":"json";return new p.Q({url:t.path,format:n,fieldsIndex:u,infoFor3D:a,dynamicDataSource:s,gdbVersion:r,sourceSpatialReference:i})}async addAttachment(e,t){await this.load();const s=e.attributes[this.layer.objectIdField],a=this.layer.parsedUrl.path+"/"+s+"/addAttachment",i=this._getLayerRequestOptions(),u=this._getFormDataForAttachment(t,i.query);try{const e=await(0,r.L)(a,{body:u});return this._createFeatureEditResult(e.data.addAttachmentResult)}catch(e){throw this._createAttachmentErrorResult(s,e)}}async updateAttachment(e,t,s){await this.load();const a=e.attributes[this.layer.objectIdField],i=this.layer.parsedUrl.path+"/"+a+"/updateAttachment",u=this._getLayerRequestOptions({query:{attachmentId:t}}),n=this._getFormDataForAttachment(s,u.query);try{const e=await(0,r.L)(i,{body:n});return this._createFeatureEditResult(e.data.updateAttachmentResult)}catch(e){throw this._createAttachmentErrorResult(a,e)}}async applyEdits(e,t){await this.load();const s=e.addFeatures.map(this._serializeFeature,this),a=e.updateFeatures.map(this._serializeFeature,this),i=this._getFeatureIds(e.deleteFeatures,null==t?void 0:t.globalIdUsed);(0,m.l)(s,a,this.layer.spatialReference);const u=[],n=[],l=[...e.deleteAttachments];for(const t of e.addAttachments)u.push(await this._serializeAttachment(t));for(const t of e.updateAttachments)n.push(await this._serializeAttachment(t));const o=u.length||n.length||l.length?{adds:u,updates:n,deletes:l}:null,d={gdbVersion:(null==t?void 0:t.gdbVersion)||this.layer.gdbVersion,rollbackOnFailure:null==t?void 0:t.rollbackOnFailureEnabled,useGlobalIds:null==t?void 0:t.globalIdUsed,returnEditMoment:null==t?void 0:t.returnEditMoment,usePreviousEditMoment:null==t?void 0:t.usePreviousEditMoment,sessionId:null==t?void 0:t.sessionId};null!=t&&t.returnServiceEditsOption?(d.edits=JSON.stringify([{id:this.layer.layerId,adds:s,updates:a,deletes:i,attachments:o}]),d.returnServiceEditsOption=R.toJSON(null==t?void 0:t.returnServiceEditsOption),d.returnServiceEditsInSourceSR=null==t?void 0:t.returnServiceEditsInSourceSR):(d.adds=s.length?JSON.stringify(s):null,d.updates=a.length?JSON.stringify(a):null,d.deletes=i.length?null!=t&&t.globalIdUsed?JSON.stringify(i):i.join(","):null,d.attachments=o&&JSON.stringify(o));const c=this._getLayerRequestOptions({method:"post",query:d}),h=null!=t&&t.returnServiceEditsOption?this.layer.url:this.layer.parsedUrl.path,y=await(0,r.L)(h+"/applyEdits",c);return this._createEditsResult(y)}async deleteAttachments(e,t){await this.load();const s=e.attributes[this.layer.objectIdField],a=this.layer.parsedUrl.path+"/"+s+"/deleteAttachments";try{return(await(0,r.L)(a,this._getLayerRequestOptions({query:{attachmentIds:t.join(",")},method:"post"}))).data.deleteAttachmentResults.map(this._createFeatureEditResult)}catch(e){throw this._createAttachmentErrorResult(s,e)}}fetchRecomputedExtents(e={}){const t=e.signal;return this.load({signal:t}).then((async()=>{const t=this._getLayerRequestOptions({...e,query:{returnUpdates:!0}}),{layerId:s,url:a}=this.layer,{data:i}=await(0,r.L)(`${a}/${s}`,t),{id:n,extent:l,fullExtent:o,timeExtent:d}=i,h=l||o;return{id:n,fullExtent:h&&c.M.fromJSON(h),timeExtent:d&&u.y.fromJSON({start:d[0],end:d[1]})}}))}async queryAttachments(e,t={}){const{parsedUrl:s}=this.layer,a=s.path;await this.load();const i=this._getLayerRequestOptions(t);if(!this.layer.get("capabilities.operations.supportsQueryAttachments")){const{objectIds:t}=e,s=[];for(const e of t){const t=a+"/"+e+"/attachments";s.push((0,r.L)(t,i))}return Promise.all(s).then((e=>t.map(((t,s)=>({parentObjectId:t,attachmentInfos:e[s].data.attachmentInfos}))))).then((e=>(0,p.a)(e,a)))}return this.queryTask.executeAttachmentQuery(e,i)}async queryFeatures(e,t){return await this.load(),this.queryTask.execute(e,{...t,query:this._createRequestQueryOptions(t)})}async queryFeaturesJSON(e,t){return await this.load(),this.queryTask.executeJSON(e,{...t,query:this._createRequestQueryOptions(t)})}async queryObjectIds(e,t){return await this.load(),this.queryTask.executeForIds(e,{...t,query:this._createRequestQueryOptions(t)})}async queryFeatureCount(e,t){return await this.load(),this.queryTask.executeForCount(e,{...t,query:this._createRequestQueryOptions(t)})}async queryExtent(e,t){return await this.load(),this.queryTask.executeForExtent(e,{...t,query:this._createRequestQueryOptions(t)})}async queryRelatedFeatures(e,t){return await this.load(),this.queryTask.executeRelationshipQuery(e,{...t,query:this._createRequestQueryOptions(t)})}async queryRelatedFeaturesCount(e,t){return await this.load(),this.queryTask.executeRelationshipQueryForCount(e,{...t,query:this._createRequestQueryOptions(t)})}async queryTopFeatures(e,t){return await this.load(),this.queryTask.executeTopFeaturesQuery(e,{...t,query:this._createRequestQueryOptions(t)})}async queryTopObjectIds(e,t){return await this.load(),this.queryTask.executeForTopIds(e,{...t,query:this._createRequestQueryOptions(t)})}async queryTopExtents(e,t){return await this.load(),this.queryTask.executeForTopExtents(e,{...t,query:this._createRequestQueryOptions(t)})}async queryTopCount(e,t){return await this.load(),this.queryTask.executeForTopCount(e,{...t,query:this._createRequestQueryOptions(t)})}_createRequestQueryOptions(e){return{...this.layer.customParameters,token:this.layer.apiKey,...null==e?void 0:e.query}}async _fetchService(e){let t=this.layer.sourceJSON;if(!t){const{data:s}=await(0,r.L)(this.layer.parsedUrl.path,this._getLayerRequestOptions({query:(0,l.c)("featurelayer-advanced-symbols")?{returnAdvancedSymbols:!0}:{},signal:e}));t=s}this.sourceJSON=this._patchServiceJSON(t);const s=t.type;if(!g.has(s))throw new n.s("feature-layer-source:unsupported-type",`Source type "${s}" is not supported`)}_patchServiceJSON(e){var t;if("Table"!==e.type&&e.geometryType&&(null==e||null==(t=e.drawingInfo)||!t.renderer)&&!e.defaultSymbol){const t=(0,y.u)(e.geometryType).renderer;(0,l.o)("drawingInfo.renderer",t,e)}return"esriGeometryMultiPatch"===e.geometryType&&e.infoFor3D&&(e.geometryType="mesh"),e}_serializeFeature(e){const{geometry:t,attributes:s}=e;return(0,l.t)(t)?{attributes:s}:"mesh"===t.type||"extent"===t.type?null:{geometry:t.toJSON(),attributes:s}}async _serializeAttachment(e){const{feature:t,attachment:s}=e,{globalId:a,name:i,contentType:u,data:n,uploadId:l}=s,o={globalId:a,parentGlobalId:null,contentType:null,name:null,uploadId:null,data:null};if(t&&(o.parentGlobalId="attributes"in t?t.attributes&&t.attributes[this.layer.globalIdField]:t.globalId),l)o.uploadId=l;else if(n){const e=await async function(e){return"string"==typeof e?(0,r.V)(e)||{data:e}:new Promise(((t,s)=>{const a=new FileReader;a.readAsDataURL(e),a.onload=()=>t((0,r.V)(a.result)),a.onerror=e=>s(e)}))}(n);o.contentType=e.mediaType,o.data=e.data,n instanceof File&&(o.name=n.name)}return i&&(o.name=i),u&&(o.contentType=u),o}_getFeatureIds(e,t){const s=e[0];return s?this._canUseGlobalIds(t,e)?this._getGlobalIdsFromFeatureIdentifier(e):"objectId"in s?this._getObjectIdsFromFeatureIdentifier(e):this._getIdsFromFeatures(e):[]}_getIdsFromFeatures(e){const t=this.layer.objectIdField;return e.map((e=>e.attributes&&e.attributes[t]))}_canUseGlobalIds(e,t){return e&&"globalId"in t[0]}_getObjectIdsFromFeatureIdentifier(e){return e.map((e=>e.objectId))}_getGlobalIdsFromFeatureIdentifier(e){return e.map((e=>e.globalId))}_createEditsResult(e){var t;const s=e.data,{layerId:a}=this.layer,r=[];let i=null;if(Array.isArray(s))for(const e of s)r.push({id:e.id,editedFeatures:e.editedFeatures}),e.id===a&&(i={addResults:e.addResults,updateResults:e.updateResults,deleteResults:e.deleteResults,attachments:e.attachments,editMoment:e.editMoment});else i=s;const u=null==(t=i)?void 0:t.attachments,n={addFeatureResults:i.addResults?i.addResults.map(this._createFeatureEditResult,this):[],updateFeatureResults:i.updateResults?i.updateResults.map(this._createFeatureEditResult,this):[],deleteFeatureResults:i.deleteResults?i.deleteResults.map(this._createFeatureEditResult,this):[],addAttachmentResults:u&&u.addResults?u.addResults.map(this._createFeatureEditResult,this):[],updateAttachmentResults:u&&u.updateResults?u.updateResults.map(this._createFeatureEditResult,this):[],deleteAttachmentResults:u&&u.deleteResults?u.deleteResults.map(this._createFeatureEditResult,this):[]};if(i.editMoment&&(n.editMoment=i.editMoment),r.length>0){n.editedFeatureResults=[];for(const e of r){const{adds:t,updates:s,deletes:a,spatialReference:r}=e.editedFeatures,i=r?new F.k(r):null;n.editedFeatureResults.push({layerId:e.id,editedFeatures:{adds:(null==t?void 0:t.map((e=>this._createEditedFeature(e,i))))||[],updates:(null==s?void 0:s.map((e=>({original:this._createEditedFeature(e[0],i),current:this._createEditedFeature(e[1],i)}))))||[],deletes:(null==a?void 0:a.map((e=>this._createEditedFeature(e,i))))||[],spatialReference:i}})}}return n}_createEditedFeature(e,t){return new i.h({attributes:e.attributes,geometry:(0,h.p)({...e.geometry,spatialReference:t})})}_createFeatureEditResult(e){const t=!0===e.success?null:e.error||{code:void 0,description:void 0};return{objectId:e.objectId,globalId:e.globalId,error:t?new n.s("feature-layer-source:edit-failure",t.description,{code:t.code}):null}}_createAttachmentErrorResult(e,t){const s=t.details.messages&&t.details.messages[0]||t.message,a=t.details.httpStatus||t.details.messageCode;return{objectId:e,globalId:null,error:new n.s("feature-layer-source:attachment-failure",s,{code:a})}}_getFormDataForAttachment(e,t){const s=e instanceof FormData?e:e&&e.elements?new FormData(e):null;if(s)for(const e in t){const a=t[e];null!=a&&(s.set?s.set(e,a):s.append(e,a))}return s}_getLayerRequestOptions(e={}){const{parsedUrl:t,gdbVersion:s,dynamicDataSource:a}=this.layer;return{...e,query:{gdbVersion:s,layer:a?JSON.stringify({source:a}):void 0,...t.query,f:"json",...this._createRequestQueryOptions(e)},responseType:"json"}}};(0,a.e)([(0,d.y)()],f.prototype,"type",void 0),(0,a.e)([(0,d.y)({constructOnly:!0})],f.prototype,"layer",void 0),(0,a.e)([(0,d.y)({readOnly:!0})],f.prototype,"queryTask",null),f=(0,a.e)([(0,d.n)("esri.layers.graphics.sources.FeatureLayerSource")],f);const b=f}}]);