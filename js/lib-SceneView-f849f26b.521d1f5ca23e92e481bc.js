(self.webpackChunk=self.webpackChunk||[]).push([[8167],{32422:(e,t,i)=>{"use strict";i.d(t,{$:()=>Wt,A:()=>wp,B:()=>Dy,C:()=>Ks,D:()=>TO,E:()=>qt,F:()=>AD,G:()=>RO,H:()=>SO,I:()=>NC,J:()=>Ru,K:()=>wa,L:()=>hp,M:()=>ip,N:()=>cu,O:()=>zO,P:()=>Tu,Q:()=>Sa,R:()=>bu,S:()=>fm,T:()=>Ih,U:()=>LO,V:()=>Iu,W:()=>EO,X:()=>Ra,Y:()=>PS,Z:()=>vu,_:()=>NR,a:()=>Ew,a0:()=>vm,a1:()=>ym,a2:()=>fC,a3:()=>Ib,a4:()=>yf,a5:()=>Ay,a6:()=>Qs,a7:()=>by,a8:()=>mL,a9:()=>PO,aA:()=>aE,aB:()=>Qp,aC:()=>Wp,aD:()=>LE,aE:()=>$E,aF:()=>YE,aG:()=>qz,aH:()=>Kz,aI:()=>rI,aJ:()=>df,aK:()=>xI,aL:()=>fg,aM:()=>qy,aN:()=>Hx,aO:()=>Gb,aP:()=>Mb,aQ:()=>TL,aa:()=>MO,ab:()=>AO,ac:()=>CO,ad:()=>Ws,ae:()=>De,af:()=>OO,ag:()=>DO,ah:()=>Ie,ai:()=>BS,aj:()=>We,ak:()=>Tt,al:()=>St,am:()=>ut,an:()=>lt,ao:()=>HA,ap:()=>Yi,aq:()=>mr,ar:()=>Br,as:()=>$h,at:()=>Xh,au:()=>Kh,av:()=>Bg,aw:()=>TA,ax:()=>EA,ay:()=>ID,az:()=>LD,b:()=>Ap,c:()=>gu,d:()=>Op,e:()=>hm,f:()=>oS,g:()=>Zf,h:()=>rp,i:()=>ap,j:()=>um,k:()=>Iw,l:()=>iR,m:()=>JP,n:()=>nf,o:()=>KC,p:()=>Jd,q:()=>lr,r:()=>Bv,s:()=>By,t:()=>Uy,u:()=>sn,v:()=>py,w:()=>bp,x:()=>jC,y:()=>hu,z:()=>tR}),i(33807);var r=i(78155),s=i(71391),n=i(80987),a=i(73574),o=i(55688),l=i(40130),c=i(95559),h=i(20215),d=i(88903),u=i(80219),p=i(36845),m=i(26779),f=i(94527),g=i(20736),v=i(60816),y=i(82361),_=i(7571),x=i(65352),b=i(58404),w=i(79679),C=i(93242),T=i(71542),S=i(72105),P=i(37762),R=i(83731),A=i(98548),M=i(92722),O=i(92858),D=i(25290),E=i(4169),z=i(17762),I=i(29126),L=i(81135),F=i(60183),V=i(93875),U=i(7552),G=i(20868),B=i(72600),q=i(14215),k=i(67726),N=i(59312),j=i(15346),H=i(63358),W=i(32769),Q=i(61481),Z=i(30316),Y=i(95186),X=i(62654),$=i(80657),K=i(27270),J=i(37191),ee=i(9612),te=i(89710),ie=i(30665),re=i(84796),se=i(53185),ne=i(13895),ae=i(52957),oe=i(24776),le=i(7121),ce=i(29831),he=i(87405),de=i(65311),ue=i(48643),pe=i(84320),me=i(11838),fe=i(97431),ge=i(4618),ve=i(32892),ye=i(41374),_e=i(86897),xe=i(41392),be=i(79949),we=i(3629),Ce=i(6660),Te=i(18559),Se=i(82906),Pe=i(49293),Re=i(50822),Ae=i(30494),Me=i(93450),Oe=i(732);function De(e=st){return[e[0],e[1],e[2],e[3]]}function Ee(e,t=De()){return ze(e[0],e[1],e[2],e[3],t)}function ze(e,t,i,r,s=De()){return s[0]=e,s[1]=t,s[2]=i,s[3]=r,s}function Ie(e,t,i){return(0,v.h)(i,e),i[3]=t,i}function Le(e,t,i){(0,v.h)(i,t);const r=(0,v.z)(t,t);return Math.abs(r-1)>1e-5&&r>1e-12&&(0,v.d)(i,i,1/Math.sqrt(r)),je(i,e,i)}function Fe(e,t,i,r=De()){return We((0,v.c)(w.c.get(),e,t),(0,v.c)(w.c.get(),i,t),e,r)}function Ve(e,t,i,r,s){if(e.count<3)return!1;e.getVec(i,Ge);let n=r,a=!1;for(;n<e.count-1&&!a;)e.getVec(n,Be),n++,a=!(0,v.F)(Ge,Be);if(!a)return!1;for(n=Math.max(n,s),a=!1;n<e.count&&!a;)e.getVec(n,qe),n++,(0,v.c)(ke,Ge,Be),(0,v.j)(ke,ke),(0,v.c)(Ne,Be,qe),(0,v.j)(Ne,Ne),a=!(0,v.F)(Ge,qe)&&!(0,v.F)(Be,qe)&&Math.abs((0,v.z)(ke,Ne))<Ue;return a?(Fe(Ge,Be,qe,t),!0):(0!==i||1!==r||2!==s)&&Ve(e,t,0,1,2)}const Ue=.99619469809,Ge=(0,v.n)(),Be=(0,v.n)(),qe=(0,v.n)(),ke=(0,v.n)(),Ne=(0,v.n)();function je(e,t,i){return e!==i&&Ee(e,i),i[3]=-(0,v.z)(i,t),i}function He(e,t){return t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t[3]=-e[3],t}function We(e,t,i,r){return Le(i,(0,v._)(qe,t,e),r)}function Qe(e,t,i){return!!(0,u.r)(t)&&rt(e,t.origin,t.direction,nt,i)}function Ze(e,t,i){return rt(e,t.origin,t.vector,0,i)}function Ye(e,t,i){return rt(e,t.origin,t.vector,1,i)}function Xe(e,t){return it(e,(0,S.O)(t))-t[3]>=0}function $e(e,t){return it(e,t)>=0}function Ke(e,t){return it(e,t)<0}function Je(e,t){const i=t[0],r=t[1],s=t[2],n=t[3],a=t[4],o=t[5];return e[0]*(e[0]>0?i:n)+e[1]*(e[1]>0?r:a)+e[2]*(e[2]>0?s:o)+e[3]>=0}function et(e,t){const i=(0,v.z)(e,t.ray.direction),r=-it(e,t.ray.origin);if(r<0&&i>=0)return!1;if(i>-1e-6&&i<1e-6)return r>0;if((r<0||i<0)&&!(r<0&&i<0))return!0;const s=r/i;return i>0?s<t.c1&&(t.c1=s):s>t.c0&&(t.c0=s),t.c0<=t.c1}function tt(e,t,i){const r=(0,v.d)(w.c.get(),e,(0,v.z)(e,t));return(0,v.c)(i,t,r),i}function it(e,t){return(0,v.z)(e,t)+e[3]}function rt(e,t,i,r,s){const n=(0,v.z)(e,i);if(0===n)return!1;let a=-((0,v.z)(e,t)+e[3])/n;return 1&r&&(a=(0,v.o)(a,0,1)),!(!(4&r)&&a<0||!(8&r)&&a>1||((0,v.u)(s,t,(0,v.d)(s,i,a)),0))}const st=[0,0,1,0],nt=8,at=u.n.getLogger("esri.views.3d.support.geometryUtils.boundedPlane");class ot{constructor(){this.plane=De(),this.origin=(0,v.n)(),this.basis1=(0,v.n)(),this.basis2=(0,v.n)()}}function lt(e=Ot){return{plane:De(e.plane),origin:(0,v.k)(e.origin),basis1:(0,v.k)(e.basis1),basis2:(0,v.k)(e.basis2)}}function ct(e,t=lt()){return dt(e.origin,e.basis1,e.basis2,t)}function ht(e,t){(0,v.h)(t.origin,e.origin),(0,v.h)(t.basis1,e.basis1),(0,v.h)(t.basis2,e.basis2),Ee(e.plane,t.plane)}function dt(e,t,i,r=lt()){return(0,v.h)(r.origin,e),(0,v.h)(r.basis1,t),(0,v.h)(r.basis2,i),ut(r),function(e,t){Math.abs((0,v.z)(e.basis1,e.basis2)/((0,v.s)(e.basis1)*(0,v.s)(e.basis2)))>1e-6&&at.warn(t,"Provided basis vectors are not perpendicular"),Math.abs((0,v.z)(e.basis1,St(e)))>1e-6&&at.warn(t,"Basis vectors and plane normal are not perpendicular"),Math.abs(-(0,v.z)(St(e),e.origin)-e.plane[3])>1e-6&&at.warn(t,"Plane offset is not consistent with plane origin")}(r,"fromValues()"),r}function ut(e){We(e.basis2,e.basis1,e.origin,e.plane)}function pt(e,t,i){e!==i&&ct(e,i);const r=(0,v.d)(w.c.get(),St(e),t);return(0,v.u)(i.origin,i.origin,r),i.plane[3]-=t,i}function mt(e,t=lt()){const i=(e[2]-e[0])/2,r=(e[3]-e[1])/2;return(0,v.a)(t.origin,e[0]+i,e[1]+r,0),(0,v.a)(t.basis1,i,0,0),(0,v.a)(t.basis2,0,r,0),ze(0,0,1,0,t.plane),t}function ft(e,t,i){return!!Qe(e.plane,t,i)&&Pt(e,i)}function gt(e,t,i){const r=Dt.get();Mt(e,t,r,Dt.get());let s=Number.POSITIVE_INFINITY;for(const n of Lt){const a=At(e,n,Et.get()),o=w.c.get();if(Ze(r,a,o)){const e=(0,v.H)(w.c.get(),t.origin,o),r=Math.abs((0,v.x)((0,v.z)(t.direction,e)));r<s&&(s=r,(0,v.h)(i,o))}}return s===Number.POSITIVE_INFINITY?vt(e,t,i):i}function vt(e,t,i){if(ft(e,t,i))return i;const r=Dt.get(),s=Dt.get();Mt(e,t,r,s);let n=Number.POSITIVE_INFINITY;for(const a of Lt){const o=At(e,a,Et.get()),l=w.c.get();if(Ye(r,o,l)){const e=(0,S.k)(t,l);if(!$e(s,l))continue;e<n&&(n=e,(0,v.h)(i,l))}}return xt(e,t.origin)<n&&yt(e,t.origin,i),i}function yt(e,t,i){const r=function(e,t,i){const r=(0,v.d)(w.c.get(),e,-e[3]),s=tt(e,(0,v.c)(w.c.get(),t,r),w.c.get());return(0,v.u)(i,s,r),i}(e.plane,t,w.c.get()),s=(0,w.A)(Rt(e,e.basis1),r,-1,1,w.c.get()),n=(0,w.A)(Rt(e,e.basis2),r,-1,1,w.c.get());return(0,v.c)(i,(0,v.u)(w.c.get(),s,n),e.origin),i}function _t(e,t,i){const{origin:r,basis1:s,basis2:n}=e,a=(0,v.c)(w.c.get(),t,r),o=(0,S.e)(s,a),l=(0,S.e)(n,a),c=(0,S.e)(St(e),a);return(0,v.a)(i,o,l,c)}function xt(e,t){const i=_t(e,t,w.c.get()),{basis1:r,basis2:s}=e,n=(0,v.s)(r),a=(0,v.s)(s),o=Math.max(Math.abs(i[0])-n,0),l=Math.max(Math.abs(i[1])-a,0),c=i[2];return o*o+l*l+c*c}function bt(e,t){return $e(e.plane,t)&&Pt(e,t)}function wt(e,t){const i=-e.plane[3];return(0,S.e)(St(e),t)-i}function Ct(e,t,i){return e!==i&&ct(e,i),(0,C.h)(Ft,t),(0,C.o)(Ft,Ft),(0,v.I)(i.basis1,e.basis1,Ft),(0,v.I)(i.basis2,e.basis2,Ft),(0,v.I)(i.plane,e.plane,Ft),(0,v.I)(i.origin,e.origin,t),je(i.plane,i.origin,i.plane),i}function Tt(e,t,i,r){return e!==r&&ct(e,r),(0,C.f)(Vt,(0,C.r)(Vt),t,i),(0,v.I)(r.basis1,e.basis1,Vt),(0,v.I)(r.basis2,e.basis2,Vt),ut(r),r}function St(e){return e.plane}function Pt(e,t){const i=(0,v.c)(w.c.get(),t,e.origin),r=(0,v.m)(e.basis1),s=(0,v.m)(e.basis2),n=(0,v.z)(e.basis1,i),a=(0,v.z)(e.basis2,i);return-n-r<0&&n-r<0&&-a-s<0&&a-s<0}function Rt(e,t){const i=Et.get();return(0,v.h)(i.origin,e.origin),(0,v.h)(i.vector,t),i}function At(e,t,i){const{basis1:r,basis2:s,origin:n}=e,a=(0,v.d)(w.c.get(),r,t.origin[0]),o=(0,v.d)(w.c.get(),s,t.origin[1]);(0,v.u)(i.origin,a,o),(0,v.u)(i.origin,i.origin,n);const l=(0,v.d)(w.c.get(),r,t.direction[0]),c=(0,v.d)(w.c.get(),s,t.direction[1]);return(0,v.d)(i.vector,(0,v.u)(l,l,c),2),i}function Mt(e,t,i,r){const s=St(e);We(s,t.direction,t.origin,i),We(i,s,t.origin,r)}const Ot={plane:De(),origin:(0,v.i)(0,0,0),basis1:(0,v.i)(1,0,0),basis2:(0,v.i)(0,1,0)},Dt=new w.s(De),Et=new w.s(w.v),zt=(0,v.n)(),It=new w.s((()=>({origin:null,basis1:null,basis2:null,plane:null}))),Lt=[{origin:[-1,-1],direction:[1,0]},{origin:[1,-1],direction:[0,1]},{origin:[1,1],direction:[-1,0]},{origin:[-1,1],direction:[0,-1]}],Ft=(0,T.e)(),Vt=(0,T.e)();var Ut=Object.freeze({__proto__:null,BoundedPlaneClass:ot,create:lt,wrap:function(e,t,i){const r=It.get();return r.origin=e,r.basis1=t,r.basis2=i,r.plane=ze(0,0,0,0,w.r.get()),ut(r),r},copy:ct,copyWithoutVerify:ht,fromValues:dt,updateUnboundedPlane:ut,elevate:pt,setExtent:function(e,t,i){return mt(t,i),pt(i,wt(e,e.origin),i),i},fromAABoundingRect:mt,intersectRay:ft,intersectRayClosestSilhouette:function(e,t,i){if(ft(e,t,i))return i;const r=gt(e,t,w.c.get());return(0,v.u)(i,t.origin,(0,v.d)(w.c.get(),t.direction,(0,v.q)(t.origin,r)/(0,v.s)(t.direction))),i},closestPointOnSilhouette:gt,closestPoint:vt,projectPoint:yt,projectPointLocal:_t,distance2:xt,distance:function(e,t){return Math.sqrt(xt(e,t))},distanceToSilhouette:function(e,t){let i=Number.NEGATIVE_INFINITY;for(const r of Lt){const s=At(e,r,Et.get()),n=(0,w.b)(s,t);n>i&&(i=n)}return Math.sqrt(i)},extrusionContainsPoint:bt,axisAt:function(e,t,i,r){return function(e,t,i){switch(t){case 0:(0,v.h)(i,e.basis1),(0,v.j)(i,i);break;case 1:(0,v.h)(i,e.basis2),(0,v.j)(i,i);break;case 2:(0,v.h)(i,St(e))}return i}(e,i,r)},altitudeAt:wt,setAltitudeAt:function(e,t,i,r){const s=wt(e,t),n=(0,v.d)(zt,St(e),i-s);return(0,v.u)(r,t,n),r},equals:function(e,t){return(0,v.F)(e.basis1,t.basis1)&&(0,v.F)(e.basis2,t.basis2)&&(0,v.F)(e.origin,t.origin)},transform:Ct,rotate:Tt,normal:St,UP:Ot});function Gt(e){return e&&"base-tile"===e.type||"tile"===e.type||"elevation"===e.type||"imagery-tile"===e.type||"base-elevation"===e.type||"open-street-map"===e.type||"wcs"===e.type||"web-tile"===e.type||"wmts"===e.type||"vector-tile"===e.type}function Bt(e){return e.parent&&"esri.Basemap"===e.parent.declaredClass&&e.parent.baseLayers.indexOf(e)>-1}function qt(e){return!0===e.labelsVisible&&null!=e.labelingInfo&&e.labelingInfo.length>0}function kt(e){return"point"===e.type}class Nt{constructor(e,t=null,i=0){this.array=e,this.spatialReference=t,this.offset=i}}function jt(e){return"array"in e}function Ht(e,t,i="ground"){if(kt(t))return e.getElevation(t.x,t.y,t.z||0,t.spatialReference,i);if(jt(t)){let r=t.offset;return e.getElevation(t.array[r++],t.array[r++],t.array[r]||0,(0,u.q)(t.spatialReference,e.spatialReference),i)}return e.getElevation(t[0],t[1],t[2]||0,e.spatialReference,i)}class Wt{constructor(e){const t=Wt.checkUnsupported(e);if(t)throw t;this.spatialReference=e.spatialReference,this._isWebMercator=this.spatialReference.isWebMercator,this._isGCS=(0,_.Z)(this.spatialReference)||(0,O.a)(this.spatialReference)||(0,O.P)(this.spatialReference),this.origin=[e.origin.x,e.origin.y],this.pixelSize=e.size[0],this.dpi=e.dpi;const i=e.lods.reduce((function(e,t,i){return t.level<e.min&&(e.min=t.level,e.minIndex=i),e.max=Math.max(e.max,t.level),e}),{min:1/0,minIndex:0,max:-1/0}),r=e.lods[i.minIndex],s=2**r.level;let n=r.resolution*s,a=r.scale*s;this.levels=new Array(i.max+1);for(let t=0;t<this.levels.length;t++)this.levels[t]={resolution:n,scale:a,tileSize:[n*e.size[0],n*e.size[1]]},n/=2,a/=2}clone(){return new Wt(this.toTileInfo())}toTileInfo(){return new D.S({dpi:this.dpi,origin:{x:this.origin[0],y:this.origin[1],spatialReference:this.spatialReference},size:[this.pixelSize,this.pixelSize],spatialReference:this.spatialReference,lods:this.levels.map(((e,t)=>({level:t,scale:e.scale,resolution:e.resolution})))})}getExtent(e,t,i,r){const s=this.levels[e],n=s.tileSize[0],a=s.tileSize[1];r[0]=this.origin[0]+i*n,r[2]=r[0]+n,r[3]=this.origin[1]-t*a,r[1]=r[3]-a}convertExtentToRadians(e,t){this._isWebMercator?(t[0]=(0,g.a)(e[0]),t[1]=(0,g.f)(e[1]),t[2]=(0,g.a)(e[2]),t[3]=(0,g.f)(e[3])):this._isGCS&&(t[0]=(0,v.g)(e[0]),t[1]=(0,v.g)(e[1]),t[2]=(0,v.g)(e[2]),t[3]=(0,v.g)(e[3]))}getExtentGeometry(e,t,i,r=new A.M){return this.getExtent(e,t,i,Qt),r.spatialReference=this.spatialReference,r.xmin=Qt[0],r.ymin=Qt[1],r.xmax=Qt[2],r.ymax=Qt[3],r.zmin=void 0,r.zmax=void 0,r}ensureMaxLod(e){if(null==e)return!1;let t=!1;for(;this.levels.length<=e;){const e=this.levels[this.levels.length-1],i=e.resolution/2;this.levels.push({resolution:i,scale:e.scale/2,tileSize:[i*this.pixelSize,i*this.pixelSize]}),t=!0}return t}capMaxLod(e){this.levels.length>e+1&&(this.levels.length=e+1)}getMaxLod(){return this.levels.length-1}scaleAtLevel(e){return this.levels[0].scale/2**e}levelAtScale(e){const t=this.levels[0].scale;return e>=t?0:Math.log(t/e)*Math.LOG2E}resolutionAtLevel(e){return this.levels[0].resolution/2**e}compatibleWith(e){if(!(e instanceof Wt)){if(Wt.checkUnsupported(e))return!1;e=new Wt(e)}if(!e.spatialReference.equals(this.spatialReference))return!1;if(e.pixelSize!==this.pixelSize)return!1;const t=Math.min(this.levels.length,e.levels.length)-1,i=this.levels[t].resolution;let r=.5*i;return!(!(0,v.v)(e.origin[0],this.origin[0],r)||!(0,v.v)(e.origin[1],this.origin[1],r))&&(r=.5*i/2**t/this.pixelSize*12,(0,v.v)(i,e.levels[t].resolution,r))}rootTilesInExtent(e,t=null,i=1/0){const r=this.levels[0].tileSize;if(0===r[0]||0===r[1])return[];Wt.computeRowColExtent(e,r,this.origin,Qt);let s=Qt[1],n=Qt[3],a=Qt[0],o=Qt[2];const l=o-a,c=n-s;if(l*c>i){const e=Math.floor(Math.sqrt(i));c>e&&(s=s+Math.floor(.5*c)-Math.floor(.5*e),n=s+e),l>e&&(a=a+Math.floor(.5*l)-Math.floor(.5*e),o=a+e)}const h=[];for(let e=s;e<n;e++)for(let t=a;t<o;t++)h.push([0,e,t]);return(0,u.r)(t)&&(t[0]=this.origin[0]+a*r[0],t[1]=this.origin[1]-n*r[1],t[2]=this.origin[0]+o*r[0],t[3]=this.origin[1]-s*r[1]),h}static computeRowColExtent(e,t,i,r){const s=.001*(e[2]-e[0]+(e[3]-e[1]));r[0]=Math.max(0,Math.floor((e[0]+s-i[0])/t[0])),r[2]=Math.max(0,Math.ceil((e[2]-s-i[0])/t[0])),r[1]=Math.max(0,Math.floor((i[1]-e[3]+s)/t[1])),r[3]=Math.max(0,Math.ceil((i[1]-e[1]-s)/t[1]))}static isPowerOfTwo(e){const t=e.lods,i=t[0].resolution*2**t[0].level;return!t.some((function(e){return!(0,v.w)(e.resolution,i/2**e.level)}))}static hasGapInLevels(e){const t=e.lods.map((function(e){return e.level}));t.sort((function(e,t){return e-t}));for(let e=1;e<t.length;e++)if(t[e]!==t[0]+e)return!0;return!1}static tileSizeSupported(e){const t=e.size[1];return t===e.size[0]&&0==(t&t-1)&&t>=128&&t<=512}static checkUnsupported(e){return e?e.lods.length<1?new h.s("tilingscheme:generic","Tiling scheme must have at least one level"):Wt.isPowerOfTwo(e)?Wt.hasGapInLevels(e)?new h.s("tilingscheme:gaps","Tiling scheme levels must not have gaps between min and max level"):Wt.tileSizeSupported(e)?null:new h.s("tilingscheme:tile-size","Tiles must be square and size must be one of [128, 256, 512]"):new h.s("tilingscheme:power-of-two","Tiling scheme must be power of two"):new h.s("tilingscheme:tile-info-missing","Tiling scheme must have tiling information")}static fromExtent(e,t){const i=e[2]-e[0],r=e[3]-e[1],s=(0,x.G)(t),n=1.2*Math.max(i,r),a=256,o=new Wt(new D.S({size:[a,a],origin:{x:e[0]-.5*(n-i),y:e[3]+.5*(n-r)},lods:[{level:0,resolution:n/a,scale:1/(a/96*.0254/(n*s))}],spatialReference:t}));return o.ensureMaxLod(20),o}static makeWebMercatorAuxiliarySphere(e){const t=new Wt(Wt.WebMercatorAuxiliarySphereTileInfo);return t.ensureMaxLod(e),t}static makeGCSWithTileSize(e,t=256,i=16){const r=256/t,s=new Wt(new D.S({size:[t,t],origin:{x:-180,y:90,spatialReference:e},spatialReference:e,lods:[{level:0,resolution:.703125*r,scale:295497598.570834*r}]}));return s.ensureMaxLod(i),s}get test(){return{isWebMercator:this._isWebMercator,isGCS:this._isGCS}}}Wt.WebMercatorAuxiliarySphereTileInfo=new D.S({size:[256,256],origin:{x:-20037508.342787,y:20037508.342787,spatialReference:O.k.WebMercator},spatialReference:O.k.WebMercator,lods:[{level:0,resolution:156543.03392800014,scale:591657527.591555}]}),Wt.WebMercatorAuxiliarySphere=Wt.makeWebMercatorAuxiliarySphere(19);const Qt=(0,b.i)(),Zt=[0,1],Yt=(0,v.A)(v.B/10),Xt=(0,b.i)();Wt.WebMercatorAuxiliarySphere.getExtent(0,0,0,Xt);const $t=(0,b.i)([-180,-90,180,90]),Kt="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAQAAAAEACAIAAADTED8xAAAACXBIWXMAAAsTAAALEwEAmpwYAAAKT2lDQ1BQaG90b3Nob3AgSUNDIHByb2ZpbGUAAHjanVNnVFPpFj333vRCS4iAlEtvUhUIIFJCi4AUkSYqIQkQSoghodkVUcERRUUEG8igiAOOjoCMFVEsDIoK2AfkIaKOg6OIisr74Xuja9a89+bN/rXXPues852zzwfACAyWSDNRNYAMqUIeEeCDx8TG4eQuQIEKJHAAEAizZCFz/SMBAPh+PDwrIsAHvgABeNMLCADATZvAMByH/w/qQplcAYCEAcB0kThLCIAUAEB6jkKmAEBGAYCdmCZTAKAEAGDLY2LjAFAtAGAnf+bTAICd+Jl7AQBblCEVAaCRACATZYhEAGg7AKzPVopFAFgwABRmS8Q5ANgtADBJV2ZIALC3AMDOEAuyAAgMADBRiIUpAAR7AGDIIyN4AISZABRG8lc88SuuEOcqAAB4mbI8uSQ5RYFbCC1xB1dXLh4ozkkXKxQ2YQJhmkAuwnmZGTKBNA/g88wAAKCRFRHgg/P9eM4Ors7ONo62Dl8t6r8G/yJiYuP+5c+rcEAAAOF0ftH+LC+zGoA7BoBt/qIl7gRoXgugdfeLZrIPQLUAoOnaV/Nw+H48PEWhkLnZ2eXk5NhKxEJbYcpXff5nwl/AV/1s+X48/Pf14L7iJIEyXYFHBPjgwsz0TKUcz5IJhGLc5o9H/LcL//wd0yLESWK5WCoU41EScY5EmozzMqUiiUKSKcUl0v9k4t8s+wM+3zUAsGo+AXuRLahdYwP2SycQWHTA4vcAAPK7b8HUKAgDgGiD4c93/+8//UegJQCAZkmScQAAXkQkLlTKsz/HCAAARKCBKrBBG/TBGCzABhzBBdzBC/xgNoRCJMTCQhBCCmSAHHJgKayCQiiGzbAdKmAv1EAdNMBRaIaTcA4uwlW4Dj1wD/phCJ7BKLyBCQRByAgTYSHaiAFiilgjjggXmYX4IcFIBBKLJCDJiBRRIkuRNUgxUopUIFVIHfI9cgI5h1xGupE7yAAygvyGvEcxlIGyUT3UDLVDuag3GoRGogvQZHQxmo8WoJvQcrQaPYw2oefQq2gP2o8+Q8cwwOgYBzPEbDAuxsNCsTgsCZNjy7EirAyrxhqwVqwDu4n1Y8+xdwQSgUXACTYEd0IgYR5BSFhMWE7YSKggHCQ0EdoJNwkDhFHCJyKTqEu0JroR+cQYYjIxh1hILCPWEo8TLxB7iEPENyQSiUMyJ7mQAkmxpFTSEtJG0m5SI+ksqZs0SBojk8naZGuyBzmULCAryIXkneTD5DPkG+Qh8lsKnWJAcaT4U+IoUspqShnlEOU05QZlmDJBVaOaUt2ooVQRNY9aQq2htlKvUYeoEzR1mjnNgxZJS6WtopXTGmgXaPdpr+h0uhHdlR5Ol9BX0svpR+iX6AP0dwwNhhWDx4hnKBmbGAcYZxl3GK+YTKYZ04sZx1QwNzHrmOeZD5lvVVgqtip8FZHKCpVKlSaVGyovVKmqpqreqgtV81XLVI+pXlN9rkZVM1PjqQnUlqtVqp1Q61MbU2epO6iHqmeob1Q/pH5Z/YkGWcNMw09DpFGgsV/jvMYgC2MZs3gsIWsNq4Z1gTXEJrHN2Xx2KruY/R27iz2qqaE5QzNKM1ezUvOUZj8H45hx+Jx0TgnnKKeX836K3hTvKeIpG6Y0TLkxZVxrqpaXllirSKtRq0frvTau7aedpr1Fu1n7gQ5Bx0onXCdHZ4/OBZ3nU9lT3acKpxZNPTr1ri6qa6UbobtEd79up+6Ynr5egJ5Mb6feeb3n+hx9L/1U/W36p/VHDFgGswwkBtsMzhg8xTVxbzwdL8fb8VFDXcNAQ6VhlWGX4YSRudE8o9VGjUYPjGnGXOMk423GbcajJgYmISZLTepN7ppSTbmmKaY7TDtMx83MzaLN1pk1mz0x1zLnm+eb15vft2BaeFostqi2uGVJsuRaplnutrxuhVo5WaVYVVpds0atna0l1rutu6cRp7lOk06rntZnw7Dxtsm2qbcZsOXYBtuutm22fWFnYhdnt8Wuw+6TvZN9un2N/T0HDYfZDqsdWh1+c7RyFDpWOt6azpzuP33F9JbpL2dYzxDP2DPjthPLKcRpnVOb00dnF2e5c4PziIuJS4LLLpc+Lpsbxt3IveRKdPVxXeF60vWdm7Obwu2o26/uNu5p7ofcn8w0nymeWTNz0MPIQ+BR5dE/C5+VMGvfrH5PQ0+BZ7XnIy9jL5FXrdewt6V3qvdh7xc+9j5yn+M+4zw33jLeWV/MN8C3yLfLT8Nvnl+F30N/I/9k/3r/0QCngCUBZwOJgUGBWwL7+Hp8Ib+OPzrbZfay2e1BjKC5QRVBj4KtguXBrSFoyOyQrSH355jOkc5pDoVQfujW0Adh5mGLw34MJ4WHhVeGP45wiFga0TGXNXfR3ENz30T6RJZE3ptnMU85ry1KNSo+qi5qPNo3ujS6P8YuZlnM1VidWElsSxw5LiquNm5svt/87fOH4p3iC+N7F5gvyF1weaHOwvSFpxapLhIsOpZATIhOOJTwQRAqqBaMJfITdyWOCnnCHcJnIi/RNtGI2ENcKh5O8kgqTXqS7JG8NXkkxTOlLOW5hCepkLxMDUzdmzqeFpp2IG0yPTq9MYOSkZBxQqohTZO2Z+pn5mZ2y6xlhbL+xW6Lty8elQfJa7OQrAVZLQq2QqboVFoo1yoHsmdlV2a/zYnKOZarnivN7cyzytuQN5zvn//tEsIS4ZK2pYZLVy0dWOa9rGo5sjxxedsK4xUFK4ZWBqw8uIq2Km3VT6vtV5eufr0mek1rgV7ByoLBtQFr6wtVCuWFfevc1+1dT1gvWd+1YfqGnRs+FYmKrhTbF5cVf9go3HjlG4dvyr+Z3JS0qavEuWTPZtJm6ebeLZ5bDpaql+aXDm4N2dq0Dd9WtO319kXbL5fNKNu7g7ZDuaO/PLi8ZafJzs07P1SkVPRU+lQ27tLdtWHX+G7R7ht7vPY07NXbW7z3/T7JvttVAVVN1WbVZftJ+7P3P66Jqun4lvttXa1ObXHtxwPSA/0HIw6217nU1R3SPVRSj9Yr60cOxx++/p3vdy0NNg1VjZzG4iNwRHnk6fcJ3/ceDTradox7rOEH0x92HWcdL2pCmvKaRptTmvtbYlu6T8w+0dbq3nr8R9sfD5w0PFl5SvNUyWna6YLTk2fyz4ydlZ19fi753GDborZ752PO32oPb++6EHTh0kX/i+c7vDvOXPK4dPKy2+UTV7hXmq86X23qdOo8/pPTT8e7nLuarrlca7nuer21e2b36RueN87d9L158Rb/1tWeOT3dvfN6b/fF9/XfFt1+cif9zsu72Xcn7q28T7xf9EDtQdlD3YfVP1v+3Njv3H9qwHeg89HcR/cGhYPP/pH1jw9DBY+Zj8uGDYbrnjg+OTniP3L96fynQ89kzyaeF/6i/suuFxYvfvjV69fO0ZjRoZfyl5O/bXyl/erA6xmv28bCxh6+yXgzMV70VvvtwXfcdx3vo98PT+R8IH8o/2j5sfVT0Kf7kxmTk/8EA5jz/GMzLdsAAAAgY0hSTQAAeiUAAICDAAD5/wAAgOkAAHUwAADqYAAAOpgAABdvkl/FRgAAA2JJREFUeNrs3d1O20AQgFFvRJInQLQBhHj/h0JVW34El1yQ2F73DVq3jTys55zrqUBbPrErZUSZ+vcOsto4AjK76Lqu1vr8+G3mPzjc3D/+eJj/Bcz/cd75R80fbu79BsAVCAQAAgABgABAACAAEAAIAAQAAgABQPOKfQAy83Ho+HnnHzXv49B4A4AAQAAgABAACAAEAAIAAYAAQAAgABAANM4+AKnZB4ifd/5R8/YB8AYAAYAAQAAgABAACAAEAAIAAYAAQAAgAGicfQBSsw8QP+/8o+btA+ANAAIAAYAAQAAgABAACAAEAAIAAYAAQADQOPsApGYfIH7e+UfN2wfAGwAEAAIAAYAAQAAgABAACAAEAAIAAXA201QdggAggH0AUrMPED8/jsPL03fns/y8fQC8AUAAIAAQAAgABAACAAGAAEAAIAAQAAgAGmcfgNTsA8TP2weImrcPgDcACAAEAAIAAYAAQAAgABAACAAEAAIAAUDj7AOQmn2A+Hn7AFHz9gHwBgABgABAACAAEAAIAAQAAgABgABgNS4cAf9pu9u3O1+m/n2aplKK/0j+TX86/tVP5+eZ3+729gFIfwWyDxA7bx8gat4+ANkJAAGAAEAAIAAQAAgABAACAAGAAEAAIABonn0AUrMPED9vHyBq3j4A3gAgABAACAAEAAIAAYAAQAAgABAA51VrdQgCAAHAsuwDkJp9gPj5vj+9vvx0PsvP2wfAGwAEAAIAAYAAQAAgABAACAAEAAIAAYAAoHH2AUjNPkD8vH2AqHn7AHgDgABAACAAEAAIAAQAAgABgABAACAAEAA0zj4AqdkHiJ+3DxA1bx8AbwAQACQ0DL0AyKuOowBwBYKUSikCIHUBAsAVCAQAAgABgABAALBy9gFIzT5A/Lx9gKj5y6trVyC8AUAAIAAQAAgAVq90Pg5N5gA2AsAVCAQAAgABgABAALB29gFIzT5A/Lx9gKj5q6+3rkB4A4AAQAAgABAACADWzB/IIHsCAsAVCARAlKlWhyAAEAAIABZjH4DU7APEz5+OH2+vT85n+fkvhztXILwBQAAgABAACAAEAGtWigBIHcBGALgCgQBAACAAyPMO9nHosxuHodZx5vB2t691HIdh/nx/Os7/Zsz/fvgXAAAA//8DAF1P1hM2ICMfAAAAAElFTkSuQmCC",Jt=u.n.getLogger("esri.views.support.GroundViewElevationSampler");let ei=class extends n.n.EventedAccessor{constructor(e){super(e),this.demResolution={min:-1,max:-1},this.noDataValue=Yt}initialize(){this.view.basemapTerrain.on("elevation-change",(()=>this.emit("changed",{})))}get extent(){const e=this.view.basemapTerrain;return e.extent&&e.spatialReference?(0,b.o)(e.extent,e.spatialReference):null}elevationAt(e){const t=e.spatialReference,i=this.spatialReference;if(!(0,g.x)(t,i)){const e=t?t.wkid:"unknown";return Jt.error(`Cannot sample elevation at a location with spatial reference (${e}) different from the view (${i.wkid})`),null}if(!(0,A.t)(this.extent,e)){const t=this.extent,i=`${t.xmin}, ${t.ymin}, ${t.xmax}, ${t.ymax}`;Jt.warn("#elevationAt()",`Point used to sample elevation (${e.x}, ${e.y}) is outside of the sampler extent (${i})`)}return Ht(this.view.elevationProvider,e)}queryElevation(e){return(0,M.h)(e.clone(),this)}};(0,r.e)([(0,d.y)({readOnly:!0})],ei.prototype,"demResolution",void 0),(0,r.e)([(0,d.y)({readOnly:!0})],ei.prototype,"extent",null),(0,r.e)([(0,d.y)({readOnly:!0})],ei.prototype,"noDataValue",void 0),(0,r.e)([(0,d.y)({readOnly:!0,aliasOf:"view.basemapTerrain.spatialReference"})],ei.prototype,"spatialReference",void 0),(0,r.e)([(0,d.y)({constructOnly:!0})],ei.prototype,"view",void 0),ei=(0,r.e)([(0,d.n)("esri.views.support.GroundViewElevationSampler")],ei);var ti=ei;let ii=class extends r.p{constructor(e){super(e),this.handles=new R.u,this.view=null,this.layerViews=new l.L}initialize(){this.handles.add((0,p.y)(this,"view.map.ground",(e=>e.load()))),this.handles.add(this.layerViews.on("after-changes",(()=>this.layerViewsAfterChangesHandler())))}destroy(){this._set("view",null),this.handles&&(this.handles.destroy(),this.handles=null)}get elevationSampler(){return this.view?"2d"===this.view.type?null:this.view.ready&&this.view.basemapTerrain&&this.view.basemapTerrain.ready?new ti({view:this.view}):null:null}get updating(){return!this.suspended&&this.layerViews.some((e=>e.updating))}get suspended(){return!this.view||this.view.suspended}layerViewsAfterChangesHandler(){this.handles.remove("updating"),this.handles.add(this.layerViews.map((e=>e.watch("updating",(()=>this.updateUpdating()),!0))).toArray(),"updating"),this.updateUpdating()}updateUpdating(){this.notifyChange("updating")}};(0,r.e)([(0,d.y)({readOnly:!0})],ii.prototype,"elevationSampler",null),(0,r.e)([(0,d.y)({type:Boolean,readOnly:!0})],ii.prototype,"updating",null),(0,r.e)([(0,d.y)({constructOnly:!0})],ii.prototype,"view",void 0),(0,r.e)([(0,d.y)({type:l.L,readOnly:!0})],ii.prototype,"layerViews",void 0),(0,r.e)([(0,d.y)({readOnly:!0})],ii.prototype,"suspended",null),ii=(0,r.e)([(0,d.n)("esri.views.GroundView")],ii);var ri=ii;function si(e){return"global"===e?1:2}const ni=()=>Promise.all([i.e(9351),i.e(5038)]).then(i.bind(i,85038)),ai=()=>Promise.resolve().then((function(){return nR})),oi={"base-dynamic":()=>Promise.all([i.e(9351),i.e(6981)]).then(i.bind(i,56981)),"base-elevation":ai,"base-tile":ni,"bing-maps":ni,"building-scene":()=>Promise.all([i.e(9351),i.e(432)]).then(i.bind(i,50432)),csv:()=>Promise.all([i.e(9351),i.e(9856)]).then(i.bind(i,39856)),"direct-line-measurement":()=>Promise.all([i.e(1337),i.e(9351),i.e(8098)]).then(i.bind(i,68098)).then((function(e){return e.D})),"area-measurement":()=>Promise.all([i.e(1337),i.e(9351),i.e(8065)]).then(i.bind(i,78065)).then((function(e){return e.A})),elevation:ai,feature:()=>Promise.all([i.e(9351),i.e(4462)]).then(i.bind(i,54462)),geojson:()=>Promise.all([i.e(9351),i.e(1485)]).then(i.bind(i,81485)),graphics:()=>Promise.all([i.e(9351),i.e(7041)]).then(i.bind(i,97041)),group:()=>i.e(9351).then(i.bind(i,2695)),imagery:()=>Promise.all([i.e(9351),i.e(3135)]).then(i.bind(i,93135)),"integrated-mesh":()=>Promise.all([i.e(9351),i.e(1369)]).then(i.bind(i,70573)),"line-of-sight":()=>Promise.all([i.e(9351),i.e(8771)]).then(i.bind(i,28771)),"map-image":()=>Promise.all([i.e(9351),i.e(5621)]).then(i.bind(i,15621)),"ogc-feature":()=>Promise.all([i.e(9351),i.e(2747)]).then(i.bind(i,72747)),"open-street-map":ni,"point-cloud":()=>Promise.all([i.e(9351),i.e(2578)]).then(i.bind(i,22578)).then((function(e){return e.P})),voxel:()=>i.e(626).then(i.bind(i,90626)),scene:e=>null==e.profile||"mesh-pyramids"===e.profile?Promise.all([i.e(9351),i.e(8797)]).then(i.bind(i,98797)):Promise.all([i.e(9351),i.e(2241)]).then(i.bind(i,92241)),stream:()=>Promise.all([i.e(9351),i.e(6802)]).then(i.bind(i,96802)),tile:ni,"imagery-tile":()=>Promise.all([i.e(9351),i.e(4343)]).then(i.bind(i,54343)),"vector-tile":()=>Promise.all([i.e(918),i.e(9351),i.e(9532)]).then(i.bind(i,49532)),wcs:()=>Promise.all([i.e(9351),i.e(4343)]).then(i.bind(i,54343)),"web-tile":ni,wfs:()=>Promise.all([i.e(9351),i.e(4864)]).then(i.bind(i,94864)),wms:()=>Promise.all([i.e(9351),i.e(1780)]).then(i.bind(i,61780)),wmts:()=>i.e(3530).then(i.bind(i,73530)),slice:()=>Promise.all([i.e(9351),i.e(150)]).then(i.bind(i,10150)).then((function(e){return e.S})),"geo-rss":null,kml:null,"map-notes":null,route:null,"subtype-group":null,unknown:null,unsupported:null},li=u.n.getLogger("esri.views.3d.state.Constraints");let ci=class extends r.p{constructor(e){super(e),this.collision=new pi,this.distance=1/0,this.minimumPoiDistance=4}get altitude(){return 2===this.mode?null:this._get("altitude")||null}set altitude(e){2!==this.mode?this._set("altitude",e):li.warn("Altitude constraint is ignored in local scenes")}clampAltitude(e){return this.altitude?(0,v.o)(e,this.altitude.min,this.altitude.max):e}clampTilt(e,t){if(!this.tilt)return t;const i=this.tilt(e);return(0,v.o)(t,i.min,i.max)}clampDistance(e){return Math.min(e,this.distance)}createDefaultTilt(){return 2===this.mode?this.createDefaultTiltLocal():this.createDefaultTiltGlobal()}createConstantMaxTilt(e){return(t,i=ui)=>(i.min=di.min,i.max=e,i)}createDefaultTiltLocal(){const e=this.collision.enabled?(0,s.I)([[4e3,di.max],[1e4,(0,v.g)(88)],[6e6,(0,v.g)(88)]]):()=>di.max;return(t,i=ui)=>(i.min=di.min,i.max=e(t),i)}createDefaultTiltGlobal(){const e=this.collision.enabled?(0,s.I)([[4e3,di.max],[5e4,(0,v.g)(88)],[6e6,(0,v.g)(88)],[2e7,di.min]]):(0,s.I)([[3e5,di.max],[3e6,(0,v.g)(88)],[6e6,(0,v.g)(88)],[2e7,di.min]]);return(t,i=ui)=>(i.min=di.min,i.max=e(t),i)}};(0,r.e)([(0,d.y)()],ci.prototype,"altitude",null),(0,r.e)([(0,d.y)({readOnly:!0})],ci.prototype,"collision",void 0),(0,r.e)([(0,d.y)()],ci.prototype,"distance",void 0),(0,r.e)([(0,d.y)({readOnly:!0})],ci.prototype,"minimumPoiDistance",void 0),(0,r.e)([(0,d.y)()],ci.prototype,"tilt",void 0),(0,r.e)([(0,d.y)({constructOnly:!0})],ci.prototype,"mode",void 0),ci=(0,r.e)([(0,d.n)("esri.views.3d.state.Constraints")],ci);const hi={min:-2e5,max:4*g.s.radius},di={min:(0,v.g)(.5),max:(0,v.g)(179.5)},ui={min:0,max:0};let pi=class extends r.p{constructor(){super(...arguments),this.enabled=!0,this.elevationMargin=5}};(0,r.e)([(0,d.y)({type:Boolean})],pi.prototype,"enabled",void 0),(0,r.e)([(0,d.y)({type:Number})],pi.prototype,"elevationMargin",void 0),pi=(0,r.e)([(0,d.n)("esri.views.3d.state.Constraints.CollisionConstraint")],pi);var mi=ci;let fi=class extends r.p{constructor(){super(...arguments),this.min=hi.min,this.max=hi.max}set mode(e){(0,r.x)(u.n.getLogger(this.declaredClass),"esri.views.SceneView.constraints.altitude.mode is deprecated. The altitude constraint no longer applies to local scenes and does not have an automatic mode anymore.",{version:"4.6"})}get mode(){return(0,r.x)(u.n.getLogger(this.declaredClass),"esri.views.SceneView.constraints.altitude.mode is deprecated. The altitude constraint no longer applies to local scenes and does not have an automatic mode anymore.",{version:"4.6"}),"manual"}};(0,r.e)([(0,d.y)({type:Number})],fi.prototype,"min",void 0),(0,r.e)([(0,d.y)({type:Number})],fi.prototype,"max",void 0),fi=(0,r.e)([(0,d.n)("esri.views.3d.constraints.AltitudeConstraint")],fi);var gi=fi;let vi=class extends r.p{constructor(){super(...arguments),this.mode="auto"}get near(){return this._get("near")}set near(e){this._set("near",e),e>=this._get("far")&&(this.far=e+1e-9),this.mode="manual"}castNear(e){return Math.max(1e-8,e)}get far(){return this._get("far")}set far(e){this._set("far",e),e<=this._get("near")&&(this.near=e-1e-9),this.mode="manual"}castFar(e){return Math.max(1e-8,e)}autoUpdate(e,t){"auto"===this.mode&&(this._get("near")!==e&&this._set("near",e),this._get("far")!==t&&this._set("far",t))}};(0,r.e)([(0,d.y)({type:Number,value:1e-8})],vi.prototype,"near",null),(0,r.e)([(0,g.c)("near")],vi.prototype,"castNear",null),(0,r.e)([(0,d.y)({type:Number,value:1e-8})],vi.prototype,"far",null),(0,r.e)([(0,g.c)("far")],vi.prototype,"castFar",null),(0,r.e)([(0,d.y)({type:["auto","manual"]})],vi.prototype,"mode",void 0),vi=(0,r.e)([(0,d.n)("esri.views.3d.constraints.ClipDistanceConstraint")],vi);var yi=vi;const _i={min:(0,v.N)(di.min),max:(0,v.N)(di.max)};let xi=class extends r.p{constructor(){super(...arguments),this.mode="auto"}get max(){return this._get("max")}set max(e){this._set("max",e),this.mode="manual"}castMax(e){return(0,v.o)(e,_i.min,_i.max)}autoUpdate(e){"auto"===this.mode&&this._get("max")!==e&&this._set("max",e)}};(0,r.e)([(0,d.y)({type:["auto","manual"]})],xi.prototype,"mode",void 0),(0,r.e)([(0,d.y)({type:Number,value:_i.max})],xi.prototype,"max",null),(0,r.e)([(0,g.c)("max")],xi.prototype,"castMax",null),xi=(0,r.e)([(0,d.n)("esri.views.3d.constraints.TiltConstraint")],xi);var bi=xi;let wi=class extends r.p{constructor(){super(...arguments),this.tilt=new bi,this.altitude=new gi,this.clipDistance=new yi}};(0,r.e)([(0,d.y)({type:bi})],wi.prototype,"tilt",void 0),(0,r.e)([(0,d.y)({type:gi})],wi.prototype,"altitude",void 0),(0,r.e)([(0,d.y)({type:yi})],wi.prototype,"clipDistance",void 0),wi=(0,r.e)([(0,d.n)("esri.views.3d.constraints.Constraints")],wi);var Ci,Ti=wi;let Si=Ci=class extends r.p{set quality(e){-1!==["low","high"].indexOf(e)&&this._set("quality",e)}clone(){return new Ci({quality:this.quality})}};(0,r.e)([(0,d.y)({type:["low","high"],value:"low"})],Si.prototype,"quality",null),Si=Ci=(0,r.e)([(0,d.n)("esri.views.3d.environment.SceneViewAtmosphere")],Si);var Pi,Ri=Si;let Ai=Pi=class extends r.a{constructor(e){super(e),this.date=null,this.directShadowsEnabled=!1,this.displayUTCOffset=null}readDate(e,t){return null!=t.datetime&&new Date(t.datetime)||null}writeDate(e,t,i){t[i]=e.getTime()}readDirectShadowsEnabled(e,t){return!!t.directShadows}writedirectShadowsEnabled(e,t,i){e&&(t[i]=e)}writeDisplayUTCOffset(e,t){null!=e&&(t.displayUTCOffset=e)}clone(){return new Pi(this.cloneConstructProperties())}cloneConstructProperties(){const e={directShadowsEnabled:this.directShadowsEnabled,displayUTCOffset:null!=this.displayUTCOffset?this.displayUTCOffset:null};return null!=this.date&&(e.date=new Date(this.date.getTime())),e}};(0,r.e)([(0,d.y)({type:Date,json:{type:Number,write:{target:"datetime"}}})],Ai.prototype,"date",void 0),(0,r.e)([(0,E.e)("date",["datetime"])],Ai.prototype,"readDate",null),(0,r.e)([(0,r.o)("date")],Ai.prototype,"writeDate",null),(0,r.e)([(0,d.y)({type:Boolean,json:{default:!1,write:{target:"directShadows"}}})],Ai.prototype,"directShadowsEnabled",void 0),(0,r.e)([(0,E.e)("directShadowsEnabled",["directShadows"])],Ai.prototype,"readDirectShadowsEnabled",null),(0,r.e)([(0,r.o)("directShadowsEnabled")],Ai.prototype,"writedirectShadowsEnabled",null),(0,r.e)([(0,d.y)({type:Number,json:{write:!0}})],Ai.prototype,"displayUTCOffset",void 0),(0,r.e)([(0,r.o)("displayUTCOffset")],Ai.prototype,"writeDisplayUTCOffset",null),Ai=Pi=(0,r.e)([(0,d.n)("esri.webscene.Lighting")],Ai);var Mi,Oi=Ai;let Di=Mi=class extends(n.n.EventedMixin(Oi)){constructor(e){super(e),this.positionTimezoneInfo={hours:0,minutes:0,seconds:0,autoUpdated:!0},this.cameraTrackingEnabled=!0,this.ambientOcclusionEnabled=!1,this.waterReflectionEnabled=!1;const t=(new Date).getFullYear(),i=new Date("March 15, "+t+" 12:00:00 UTC");this._set("defaultDate",i),this._set("date",i)}static fromWebsceneLighting(e){return new Mi({...e.cloneConstructProperties()})}get defaultDate(){return new Date(this._get("defaultDate").getTime())}set defaultDate(e){const t=this._get("date")===this._get("defaultDate");e=new Date(e.getTime()),this._set("defaultDate",e),t&&this._set("date",e)}set date(e){null!=e&&(this.positionTimezoneInfo.autoUpdated=!1,this._set("date",new Date(e.getTime())))}autoUpdate(e,t){const i=Ei(this.positionTimezoneInfo);this.positionTimezoneInfo.hours=t.hours,this.positionTimezoneInfo.minutes=t.minutes,this.positionTimezoneInfo.seconds=t.seconds;let r=null;null!=e&&(this.positionTimezoneInfo.autoUpdated=!0,r=this.date&&this.date.getTime(),this._set("date",new Date(e.getTime())));const s=Ei(this.positionTimezoneInfo);if(i!==s&&(zi.target=this,zi.timezoneOffset=s,this.emit("timezone-will-change",zi)),null!=e)return r!==e.getTime()}clone(){const e=this._get("date")===this._get("defaultDate"),t=new Mi({...this.cloneConstructProperties(),defaultDate:this.defaultDate,cameraTrackingEnabled:this.cameraTrackingEnabled,ambientOcclusionEnabled:this.ambientOcclusionEnabled,waterReflectionEnabled:this.waterReflectionEnabled});return e&&t._set("date",t._get("defaultDate")),t.positionTimezoneInfo.autoUpdated=this.positionTimezoneInfo.autoUpdated,t.positionTimezoneInfo.hours=this.positionTimezoneInfo.hours,t.positionTimezoneInfo.minutes=this.positionTimezoneInfo.minutes,t.positionTimezoneInfo.seconds=this.positionTimezoneInfo.seconds,t}cloneWithWebsceneLighting(e){const t=this.clone();return null!=e.date&&(t.date=e.date),t.directShadowsEnabled=e.directShadowsEnabled,t.displayUTCOffset=e.displayUTCOffset,t}};function Ei({hours:e,minutes:t,seconds:i}){return Math.round(e+t/60+i/3600)}(0,r.e)([(0,d.y)({type:Boolean})],Di.prototype,"cameraTrackingEnabled",void 0),(0,r.e)([(0,d.y)({type:Boolean})],Di.prototype,"ambientOcclusionEnabled",void 0),(0,r.e)([(0,d.y)({type:Boolean})],Di.prototype,"waterReflectionEnabled",void 0),(0,r.e)([(0,d.y)({type:Date})],Di.prototype,"defaultDate",null),(0,r.e)([(0,d.y)({type:Date})],Di.prototype,"date",null),Di=Mi=(0,r.e)([(0,d.n)("esri.views.3d.environment.SceneViewLighting")],Di);const zi={target:null,timezoneOffset:0};let Ii=class extends r.a{constructor(e){super(e)}clone(){}};(0,r.e)([(0,d.y)({readOnly:!0,json:{read:!1}})],Ii.prototype,"type",void 0),Ii=(0,r.e)([(0,d.n)("esri.webscene.background.Background")],Ii);var Li,Fi=Ii;const Vi={...L.q,nonNullable:!0};let Ui=Li=class extends Fi{constructor(e){super(e),this.type="color",this.color=new z.o([0,0,0,1])}clone(){return new Li(this.cloneProperties())}cloneProperties(){return{color:this.color.clone()}}};(0,r.e)([(0,I.r)({color:"color"},{readOnly:!0})],Ui.prototype,"type",void 0),(0,r.e)([(0,d.y)(Vi)],Ui.prototype,"color",void 0),Ui=Li=(0,r.e)([(0,d.n)("esri.webscene.background.ColorBackground")],Ui);var Gi=Ui;const Bi={base:Fi,key:"type",typeMap:{color:Gi}},qi={types:Bi,json:{read:function(e){return(t,i,r)=>{if(!t)return t;for(const i in e.typeMap)if(t.type===i){const s=new e.typeMap[i];return s.read(t,r),s}}}(Bi),write:{overridePolicy:(e,t,i)=>({enabled:!i||!i.isPresentation})}}};var ki;const Ni=(e,t,i)=>({enabled:!i||!i.isPresentation});let ji=ki=class extends r.a{constructor(e){super(e),this.lighting=new Oi,this.background=null,this.atmosphereEnabled=!0,this.starsEnabled=!0}clone(){return new ki(this.cloneConstructProperties())}cloneConstructProperties(){return{lighting:Oi.prototype.clone.call(this.lighting),background:(0,u.y)(this.background),atmosphereEnabled:this.atmosphereEnabled,starsEnabled:this.starsEnabled}}};(0,r.e)([(0,d.y)({type:Oi,json:{write:!0}})],ji.prototype,"lighting",void 0),(0,r.e)([(0,d.y)(qi)],ji.prototype,"background",void 0),(0,r.e)([(0,d.y)({type:Boolean,nonNullable:!0,json:{write:{overridePolicy:Ni}}})],ji.prototype,"atmosphereEnabled",void 0),(0,r.e)([(0,d.y)({type:Boolean,nonNullable:!0,json:{write:{overridePolicy:Ni}}})],ji.prototype,"starsEnabled",void 0),ji=ki=(0,r.e)([(0,d.n)("esri.webscene.Environment")],ji);var Hi,Wi=ji;let Qi=Hi=class extends Wi{constructor(e){super(e),this.atmosphere=new Ri}static fromWebsceneEnvironment(e){const t=e.cloneConstructProperties();return new Hi({...t,lighting:Di.fromWebsceneLighting(t.lighting)})}castLighting(e){return this.convertLighting(e)}applyLighting(e){this.lighting=this.convertLighting(e)}convertLighting(e){return e?e instanceof Di?e:e instanceof Oi?this.lighting?this.lighting.cloneWithWebsceneLighting(e):Di.fromWebsceneLighting(e):(0,d.d)(Di,e):new Di}clone(){return new Hi({lighting:this.lighting.clone(),atmosphere:this.atmosphere.clone(),atmosphereEnabled:this.atmosphereEnabled,starsEnabled:this.starsEnabled,background:(0,u.y)(this.background)})}cloneWithWebsceneEnvironment(e){return new Hi({atmosphere:this.atmosphere.clone(),atmosphereEnabled:this.atmosphereEnabled,starsEnabled:this.starsEnabled,background:(0,u.y)(this.background),...e.cloneConstructProperties(),lighting:null!=this.lighting?this.lighting.cloneWithWebsceneLighting(e.lighting):Di.fromWebsceneLighting(e.lighting)})}};(0,r.e)([(0,d.y)({type:Ri,json:{read:!1}})],Qi.prototype,"atmosphere",void 0),(0,r.e)([(0,d.y)()],Qi.prototype,"lighting",void 0),(0,r.e)([(0,g.c)("lighting")],Qi.prototype,"castLighting",null),Qi=Hi=(0,r.e)([(0,d.n)("esri.views.3d.environment.SceneViewEnvironment")],Qi);var Zi=Qi;function Yi(e){const t=new S.n;if(2===e.geometry)t.attributes.add("position","vec2"),t.varyings.add("color","vec4"),t.vertex.uniforms.add("lightingMainDirection","vec3").add("cameraPosition","vec3").add("undergroundFadeAlpha","float"),t.vertex.code.add(S.t`void main(void) {
float ndotl = dot(normalize(cameraPosition), lightingMainDirection);
float lighting = max(0.0, smoothstep(-1.0, 0.8, 2.0 * ndotl));
color = vec4(vec3(lighting), undergroundFadeAlpha);
gl_Position = vec4(position.xy, 1.0, 1.0);
}`),t.fragment.code.add(S.t`void main() {
gl_FragColor = color;
}`);else{t.include(S.r,{linearDepth:!1}),t.attributes.add("position","vec3"),t.varyings.add("vtc","vec2"),t.varyings.add("falloff","float");const i=1===e.geometry;t.vertex.uniforms.add("proj","mat4").add("view","mat4").add("lightingMainDirection","vec3"),i||(t.varyings.add("innerFactor","float"),t.vertex.uniforms.add("silCircleCenter","vec3").add("silCircleV1","vec3").add("silCircleV2","vec3").add("texV","vec2").add("innerScale","float"));const r=6.2831853,s=1/128;t.vertex.code.add(S.t`
		void main(void) {
      ${i?S.t`
      vec3 pos = position;
      float ndotl = lightingMainDirection.z;
      vtc = vec2(0.0, position.z + 0.05);`:S.t`
      innerFactor = clamp(-position.z, 0.0, 1.0);
      float scale = position.y * (1.0 + innerFactor * innerScale);
      float phi = position.x * ${S.t.float(r*s)} + 1.0;
      vec3 pos =  (silCircleCenter + sin(phi) * silCircleV1 + cos(phi) * silCircleV2) * scale;
      float ndotl = dot(normalize(position.y > 0.0 ? pos: silCircleCenter), lightingMainDirection);
      vtc.x = position.x  * ${S.t.float(s)};
      vtc.y = texV.x * (1.0 - position.z) + texV.y * position.z;
      `}
      falloff = max(0.0, smoothstep(-1.0, 0.8, 2.0 * ndotl));

		  gl_Position = transformPosition(proj, view, pos);
		  gl_Position.z = gl_Position.w; // project atmosphere onto the far plane
    }
	  `),t.fragment.uniforms.add("tex","sampler2D"),i||t.fragment.uniforms.add("altitudeFade","float"),t.fragment.code.add(S.t`
		void main() {
			vec4 atmosphereColor = texture2D(tex, vtc) * falloff;
      ${i?S.t`gl_FragColor = atmosphereColor;`:S.t`
			vec4 innerColor = vec4(atmosphereColor.rgb, 1.0 - altitudeFade);
			gl_FragColor = mix(atmosphereColor, innerColor, smoothstep(0.0, 1.0, innerFactor));
      `}
    }`)}return t}var Xi=Object.freeze({__proto__:null,build:Yi});class $i extends S.c{initializeProgram(e){const t=$i.shader.get(),i=this.configuration,r=t.build({geometry:i.geometry});return new S.d(e.rctx,r,S.o)}initializePipeline(){return 1===this.configuration.geometry?(0,V.g)({blending:(0,V.e)(770,1,771,771),culling:V.i,depthTest:{func:515},colorWrite:V.r}):(0,V.g)({blending:(0,V.e)(770,1,771,771),depthTest:{func:515},colorWrite:V.r})}}$i.shader=new S.f(Xi,(()=>i.e(7294).then(i.bind(i,77294))));class Ki extends S.b{constructor(){super(...arguments),this.geometry=0}}(0,r.e)([(0,S.a)({count:3})],Ki.prototype,"geometry",void 0);var Ji,er="data:image/png;base64, iVBORw0KGgoAAAANSUhEUgAAAAEAAAIACAYAAABD1gYFAAAACXBIWXMAAC4jAAAuIwF4pT92AAAKT2lDQ1BQaG90b3Nob3AgSUNDIHByb2ZpbGUAAHjanVNnVFPpFj333vRCS4iAlEtvUhUIIFJCi4AUkSYqIQkQSoghodkVUcERRUUEG8igiAOOjoCMFVEsDIoK2AfkIaKOg6OIisr74Xuja9a89+bN/rXXPues852zzwfACAyWSDNRNYAMqUIeEeCDx8TG4eQuQIEKJHAAEAizZCFz/SMBAPh+PDwrIsAHvgABeNMLCADATZvAMByH/w/qQplcAYCEAcB0kThLCIAUAEB6jkKmAEBGAYCdmCZTAKAEAGDLY2LjAFAtAGAnf+bTAICd+Jl7AQBblCEVAaCRACATZYhEAGg7AKzPVopFAFgwABRmS8Q5ANgtADBJV2ZIALC3AMDOEAuyAAgMADBRiIUpAAR7AGDIIyN4AISZABRG8lc88SuuEOcqAAB4mbI8uSQ5RYFbCC1xB1dXLh4ozkkXKxQ2YQJhmkAuwnmZGTKBNA/g88wAAKCRFRHgg/P9eM4Ors7ONo62Dl8t6r8G/yJiYuP+5c+rcEAAAOF0ftH+LC+zGoA7BoBt/qIl7gRoXgugdfeLZrIPQLUAoOnaV/Nw+H48PEWhkLnZ2eXk5NhKxEJbYcpXff5nwl/AV/1s+X48/Pf14L7iJIEyXYFHBPjgwsz0TKUcz5IJhGLc5o9H/LcL//wd0yLESWK5WCoU41EScY5EmozzMqUiiUKSKcUl0v9k4t8s+wM+3zUAsGo+AXuRLahdYwP2SycQWHTA4vcAAPK7b8HUKAgDgGiD4c93/+8//UegJQCAZkmScQAAXkQkLlTKsz/HCAAARKCBKrBBG/TBGCzABhzBBdzBC/xgNoRCJMTCQhBCCmSAHHJgKayCQiiGzbAdKmAv1EAdNMBRaIaTcA4uwlW4Dj1wD/phCJ7BKLyBCQRByAgTYSHaiAFiilgjjggXmYX4IcFIBBKLJCDJiBRRIkuRNUgxUopUIFVIHfI9cgI5h1xGupE7yAAygvyGvEcxlIGyUT3UDLVDuag3GoRGogvQZHQxmo8WoJvQcrQaPYw2oefQq2gP2o8+Q8cwwOgYBzPEbDAuxsNCsTgsCZNjy7EirAyrxhqwVqwDu4n1Y8+xdwQSgUXACTYEd0IgYR5BSFhMWE7YSKggHCQ0EdoJNwkDhFHCJyKTqEu0JroR+cQYYjIxh1hILCPWEo8TLxB7iEPENyQSiUMyJ7mQAkmxpFTSEtJG0m5SI+ksqZs0SBojk8naZGuyBzmULCAryIXkneTD5DPkG+Qh8lsKnWJAcaT4U+IoUspqShnlEOU05QZlmDJBVaOaUt2ooVQRNY9aQq2htlKvUYeoEzR1mjnNgxZJS6WtopXTGmgXaPdpr+h0uhHdlR5Ol9BX0svpR+iX6AP0dwwNhhWDx4hnKBmbGAcYZxl3GK+YTKYZ04sZx1QwNzHrmOeZD5lvVVgqtip8FZHKCpVKlSaVGyovVKmqpqreqgtV81XLVI+pXlN9rkZVM1PjqQnUlqtVqp1Q61MbU2epO6iHqmeob1Q/pH5Z/YkGWcNMw09DpFGgsV/jvMYgC2MZs3gsIWsNq4Z1gTXEJrHN2Xx2KruY/R27iz2qqaE5QzNKM1ezUvOUZj8H45hx+Jx0TgnnKKeX836K3hTvKeIpG6Y0TLkxZVxrqpaXllirSKtRq0frvTau7aedpr1Fu1n7gQ5Bx0onXCdHZ4/OBZ3nU9lT3acKpxZNPTr1ri6qa6UbobtEd79up+6Ynr5egJ5Mb6feeb3n+hx9L/1U/W36p/VHDFgGswwkBtsMzhg8xTVxbzwdL8fb8VFDXcNAQ6VhlWGX4YSRudE8o9VGjUYPjGnGXOMk423GbcajJgYmISZLTepN7ppSTbmmKaY7TDtMx83MzaLN1pk1mz0x1zLnm+eb15vft2BaeFostqi2uGVJsuRaplnutrxuhVo5WaVYVVpds0atna0l1rutu6cRp7lOk06rntZnw7Dxtsm2qbcZsOXYBtuutm22fWFnYhdnt8Wuw+6TvZN9un2N/T0HDYfZDqsdWh1+c7RyFDpWOt6azpzuP33F9JbpL2dYzxDP2DPjthPLKcRpnVOb00dnF2e5c4PziIuJS4LLLpc+Lpsbxt3IveRKdPVxXeF60vWdm7Obwu2o26/uNu5p7ofcn8w0nymeWTNz0MPIQ+BR5dE/C5+VMGvfrH5PQ0+BZ7XnIy9jL5FXrdewt6V3qvdh7xc+9j5yn+M+4zw33jLeWV/MN8C3yLfLT8Nvnl+F30N/I/9k/3r/0QCngCUBZwOJgUGBWwL7+Hp8Ib+OPzrbZfay2e1BjKC5QRVBj4KtguXBrSFoyOyQrSH355jOkc5pDoVQfujW0Adh5mGLw34MJ4WHhVeGP45wiFga0TGXNXfR3ENz30T6RJZE3ptnMU85ry1KNSo+qi5qPNo3ujS6P8YuZlnM1VidWElsSxw5LiquNm5svt/87fOH4p3iC+N7F5gvyF1weaHOwvSFpxapLhIsOpZATIhOOJTwQRAqqBaMJfITdyWOCnnCHcJnIi/RNtGI2ENcKh5O8kgqTXqS7JG8NXkkxTOlLOW5hCepkLxMDUzdmzqeFpp2IG0yPTq9MYOSkZBxQqohTZO2Z+pn5mZ2y6xlhbL+xW6Lty8elQfJa7OQrAVZLQq2QqboVFoo1yoHsmdlV2a/zYnKOZarnivN7cyzytuQN5zvn//tEsIS4ZK2pYZLVy0dWOa9rGo5sjxxedsK4xUFK4ZWBqw8uIq2Km3VT6vtV5eufr0mek1rgV7ByoLBtQFr6wtVCuWFfevc1+1dT1gvWd+1YfqGnRs+FYmKrhTbF5cVf9go3HjlG4dvyr+Z3JS0qavEuWTPZtJm6ebeLZ5bDpaql+aXDm4N2dq0Dd9WtO319kXbL5fNKNu7g7ZDuaO/PLi8ZafJzs07P1SkVPRU+lQ27tLdtWHX+G7R7ht7vPY07NXbW7z3/T7JvttVAVVN1WbVZftJ+7P3P66Jqun4lvttXa1ObXHtxwPSA/0HIw6217nU1R3SPVRSj9Yr60cOxx++/p3vdy0NNg1VjZzG4iNwRHnk6fcJ3/ceDTradox7rOEH0x92HWcdL2pCmvKaRptTmvtbYlu6T8w+0dbq3nr8R9sfD5w0PFl5SvNUyWna6YLTk2fyz4ydlZ19fi753GDborZ752PO32oPb++6EHTh0kX/i+c7vDvOXPK4dPKy2+UTV7hXmq86X23qdOo8/pPTT8e7nLuarrlca7nuer21e2b36RueN87d9L158Rb/1tWeOT3dvfN6b/fF9/XfFt1+cif9zsu72Xcn7q28T7xf9EDtQdlD3YfVP1v+3Njv3H9qwHeg89HcR/cGhYPP/pH1jw9DBY+Zj8uGDYbrnjg+OTniP3L96fynQ89kzyaeF/6i/suuFxYvfvjV69fO0ZjRoZfyl5O/bXyl/erA6xmv28bCxh6+yXgzMV70VvvtwXfcdx3vo98PT+R8IH8o/2j5sfVT0Kf7kxmTk/8EA5jz/GMzLdsAAAAgY0hSTQAAeiUAAICDAAD5/wAAgOkAAHUwAADqYAAAOpgAABdvkl/FRgAAAXVJREFUeNq0k9GWhDAIQ3PjzP9/cuehFqhW19mz++IhkCZAq1prsqT+kSQS9g8Vnqp6VGVWkYVktR6tj3Gr968nLnfwlHzHYyHapkKS73bPd/39eI38AYWj24OGvqdwWjZ3l8IDgacXyl1Dj9tdLOzZiicj+P1YcGk0H2O2vN/VQpTveEHmPHQxZxYlqsQdhUeuCWREuDEvAjqlCqDIMYwIo2ijR1HdYUS58dQrKpgQ0EGeMocsTNXrxzyOhS9kfzlWjn82YuWLqwAnvfNEWJFjYXkJCT0s7AmS0NG4x7Lt6Cpy2MiVPBZmS668QT5AR1cevp7b6CpzQ/ZSNH0vmhy5CsNtdax0MBpXDBiFsrDiMSLKMc8b6hH93bNbEpRsIyHDUhNcfTyeKF16PC7c/2QdczvUnvOB1ylZHVFSMtd5s8C2IW/7w6hwM5GLavLCd1zkiFjB+BwH1DSgctQ7mPOimBLJrw35beSXkd8BM/cCqbXWPgMA+GQQ5sIgkfAAAAAASUVORK5CYII=";!function(e){e.length=function(e,t){const i=e[t],r=e[t+1],s=e[t+2];return Math.sqrt(i*i+r*r+s*s)},e.normalize=function(e,t){const i=e[t],r=e[t+1],s=e[t+2],n=1/Math.sqrt(i*i+r*r+s*s);e[t]*=n,e[t+1]*=n,e[t+2]*=n},e.scale=function(e,t,i){e[t]*=i,e[t+1]*=i,e[t+2]*=i},e.add=function(e,t,i,r,s,n=t){(s=s||e)[n]=e[t]+i[r],s[n+1]=e[t+1]+i[r+1],s[n+2]=e[t+2]+i[r+2]},e.subtract=function(e,t,i,r,s,n=t){(s=s||e)[n]=e[t]-i[r],s[n+1]=e[t+1]-i[r+1],s[n+2]=e[t+2]-i[r+2]}}(Ji||(Ji={}));const tr=Ji;var ir,rr,sr,nr;!function(e){const t=.5,i=[[-t,-t,t],[t,-t,t],[t,t,t],[-t,t,t],[-t,-t,-t],[t,-t,-t],[t,t,-t],[-t,t,-t]],r=[0,0,1,-1,0,0,1,0,0,0,-1,0,0,1,0,0,0,-1],s=[0,0,1,0,1,1,0,1],n=new Uint16Array([0,1,2,2,3,0,4,0,3,3,7,4,1,5,6,6,2,1,1,0,4,4,5,1,3,2,6,6,7,3,5,4,7,7,6,5]),a=new Uint16Array(36);for(let e=0;e<6;e++)for(let t=0;t<6;t++)a[6*e+t]=e;const o=new Uint16Array(36);for(let e=0;e<6;e++)o[6*e+0]=0,o[6*e+1]=1,o[6*e+2]=2,o[6*e+3]=2,o[6*e+4]=3,o[6*e+5]=0;e.createGeometry=function(e){Array.isArray(e)||(e=[e,e,e]);const t=new Array(24);for(let r=0;r<8;r++)t[3*r]=i[r][0]*e[0],t[3*r+1]=i[r][1]*e[1],t[3*r+2]=i[r][2]*e[2];return new S.u([["position",{size:3,data:t,exclusive:!0}],["normal",{size:3,data:r}],["uv0",{size:2,data:s}]],[["position",n],["normal",a],["uv0",o]])}}(ir||(ir={})),function(e){const t=.5,i=[[-t,0,-t],[t,0,-t],[t,0,t],[-t,0,t],[0,-t,0],[0,t,0]],r=[0,1,-1,1,1,0,0,1,1,-1,1,0,0,-1,-1,1,-1,0,0,-1,1,-1,-1,0],s=new Uint16Array([5,1,0,5,2,1,5,3,2,5,0,3,4,0,1,4,1,2,4,2,3,4,3,0]),n=new Uint16Array([0,0,0,1,1,1,2,2,2,3,3,3,4,4,4,5,5,5,6,6,6,7,7,7]);e.createGeometry=function(e){Array.isArray(e)||(e=[e,e,e]);const t=new Array(18);for(let r=0;r<6;r++)t[3*r]=i[r][0]*e[0],t[3*r+1]=i[r][1]*e[1],t[3*r+2]=i[r][2]*e[2];return new S.u([["position",{size:3,data:t,exclusive:!0}],["normal",{size:3,data:r}]],[["position",s],["normal",n]])}}(rr||(rr={})),function(e){const t=.5,i=(0,B.t)(-t,0,-t),r=(0,B.t)(t,0,-t),s=(0,B.t)(0,0,t),n=(0,B.t)(0,.5,0),a=(0,B.n)(),o=(0,B.n)(),l=(0,B.n)(),c=(0,B.n)(),h=(0,B.n)();(0,v.c)(a,i,n),(0,v.c)(o,i,r),(0,v._)(l,a,o),(0,v.j)(l,l),(0,v.c)(a,r,n),(0,v.c)(o,r,s),(0,v._)(c,a,o),(0,v.j)(c,c),(0,v.c)(a,s,n),(0,v.c)(o,s,i),(0,v._)(h,a,o),(0,v.j)(h,h);const d=[i,r,s,n],u=[0,-1,0,l[0],l[1],l[2],c[0],c[1],c[2],h[0],h[1],h[2]],p=[0,1,2,3,1,0,3,2,1,3,0,2],m=[0,0,0,1,1,1,2,2,2,3,3,3];e.createGeometry=function(e){Array.isArray(e)||(e=[e,e,e]);const t=new Array(12);for(let i=0;i<4;i++)t[3*i]=d[i][0]*e[0],t[3*i+1]=d[i][1]*e[1],t[3*i+2]=d[i][2]*e[2];return new S.u([["position",{size:3,data:t,exclusive:!0}],["normal",{size:3,data:u}]],[["position",new Uint16Array(p)],["normal",new Uint16Array(m)]])}}(sr||(sr={})),function(e){e.createBoxGeometry=ir.createGeometry,e.createDiamondGeometry=rr.createGeometry,e.createTetrahedronGeometry=sr.createGeometry,e.createSphereGeometry=function(e,t,i,r={uv:!0}){const s=-Math.PI,n=2*Math.PI,a=-Math.PI/2,o=Math.PI,l=Math.max(3,Math.floor(t)),c=Math.max(2,Math.floor(i)),h=(l+1)*(c+1),d=new Float32Array(3*h),u=new Float32Array(3*h),p=new Float32Array(2*h),m=[];let f=0;for(let t=0;t<=c;t++){const i=[],r=t/c,h=a+r*o,g=Math.cos(h);for(let t=0;t<=l;t++){const a=t/l,o=s+a*n,c=Math.cos(o)*g,m=Math.sin(h),v=-Math.sin(o)*g;d[3*f]=c*e,d[3*f+1]=m*e,d[3*f+2]=v*e,u[3*f]=c,u[3*f+1]=m,u[3*f+2]=v,p[2*f]=a,p[2*f+1]=r,i.push(f),++f}m.push(i)}const g=new Uint32Array(2*l*(c-1)*3);f=0;for(let e=0;e<c;e++)for(let t=0;t<l;t++){const i=m[e][t],r=m[e][t+1],s=m[e+1][t+1],n=m[e+1][t];0===e?(g[f++]=i,g[f++]=s,g[f++]=n):e===c-1?(g[f++]=i,g[f++]=r,g[f++]=s):(g[f++]=i,g[f++]=r,g[f++]=s,g[f++]=s,g[f++]=n,g[f++]=i)}const v=[["position",g],["normal",g]],y=[["position",{size:3,data:d,exclusive:!0}],["normal",{size:3,data:u,exclusive:!0}]];return r.uv&&(y.push(["uv0",{size:2,data:p,exclusive:!0}]),v.push(["uv0",g])),r.offset&&(v[0][0]="offset",y[0][0]="offset",v.push(["position",new Uint32Array(g.length)]),y.push(["position",{size:3,data:Float64Array.from(r.offset),exclusive:!0}])),new S.u(y,v)},e.createPolySphereGeometry=function(e,t,i){const r=e;let s,n;if(i)s=[0,-1,0,1,0,0,0,0,1,-1,0,0,0,0,-1,0,1,0],n=new Uint32Array([0,1,2,0,2,3,0,3,4,0,4,1,1,5,2,2,5,3,3,5,4,4,5,1]);else{const e=r*(1+Math.sqrt(5))/2;s=[-r,e,0,r,e,0,-r,-e,0,r,-e,0,0,-r,e,0,r,e,0,-r,-e,0,r,-e,e,0,-r,e,0,r,-e,0,-r,-e,0,r],n=new Uint32Array([0,11,5,0,5,1,0,1,7,0,7,10,0,10,11,1,5,9,5,11,4,11,10,2,10,7,6,7,1,8,3,9,4,3,4,2,3,2,6,3,6,8,3,8,9,4,9,5,2,4,11,6,2,10,8,6,7,9,8,1])}for(let t=0;t<s.length;t+=3)tr.scale(s,t,e/tr.length(s,t));let a={};function o(t,i){t>i&&([t,i]=[i,t]);const r=t.toString()+"."+i.toString();if(a[r])return a[r];let n=s.length;return s.length+=3,tr.add(s,3*t,s,3*i,s,n),tr.scale(s,n,e/tr.length(s,n)),n/=3,a[r]=n,n}for(let e=0;e<t;e++){const e=n.length,t=new Uint32Array(4*e);for(let i=0;i<e;i+=3){const e=n[i],r=n[i+1],s=n[i+2],a=o(e,r),l=o(r,s),c=o(s,e),h=4*i;t[h]=e,t[h+1]=a,t[h+2]=c,t[h+3]=r,t[h+4]=l,t[h+5]=a,t[h+6]=s,t[h+7]=c,t[h+8]=l,t[h+9]=a,t[h+10]=l,t[h+11]=c}n=t,a={}}const l=new Float32Array(s);for(let e=0;e<l.length;e+=3)tr.normalize(l,e);const c=[["position",n],["normal",n]],h=[["position",{size:3,data:new Float32Array(s),exclusive:!0}],["normal",{size:3,data:l,exclusive:!0}]];return new S.u(h,c)},e.createPointGeometry=function(e,t,i,r,s,n,a){const o=t?[t[0],t[1],t[2]]:[0,0,0],l=e?[e[0],e[1],e[2]]:[0,0,1];n=n||[0,0];const c=i?[255*i[0],255*i[1],255*i[2],i.length>3?255*i[3]:255]:[255,255,255,255],h=null!=r&&2===r.length?r:[1,1],d=[["position",{size:3,data:o,exclusive:!0}],["normal",{size:3,data:l,exclusive:!0}],["uv0",{size:n.length,data:n}],["color",{size:4,data:c,exclusive:!0}],["size",{size:2,data:h}]];if(null!=s){const e=new Float32Array([s[0],s[1],s[2],s[3]]);d.push(["auxpos1",{size:4,data:e}])}if(null!=a){const e=new Float32Array([a[0],a[1],a[2],a[3]]);d.push(["auxpos2",{size:4,data:e}])}return new S.u(d,null,1)},e.updatePointGeometry=function(e,t,i,r,s,n,a,o){if(null!=e){const{data:t}=o.getMutableAttribute("normal");t[0]=e[0],t[1]=e[1],t[2]=e[2]}if(null!=t){const{data:e}=o.getMutableAttribute("position");e[0]=t[0],e[1]=t[1],e[2]=t[2]}if(null!=i){const{data:e}=o.getMutableAttribute("color");e[0]=i[0],e[1]=i[1],e[2]=i[2],e[3]=i[3]}if(null!=r){const{data:e}=o.getMutableAttribute("size");e[0]=r[0],e[1]=r[1]}if(null!=s){const{data:e}=o.getMutableAttribute("auxpos1");e[0]=s[0],e[1]=s[1],e[2]=s[2],e[3]=s[3]}if(null!=n){const{data:e}=o.getMutableAttribute("uv0");e[0]=n[0],e[1]=n[1]}if(null!=a){const{data:e}=o.getMutableAttribute("auxpos2");e[0]=a[0],e[1]=a[1],e[2]=a[2],e[3]=a[3]}},e.createPointArrayGeometry=function(e,t){const i=new Float32Array(3*e.length),r=new Float32Array(t?3*e.length:3),s=new Uint32Array(e.length),n=new Uint32Array(e.length);for(let a=0;a<e.length;a++)i[3*a]=e[a][0],i[3*a+1]=e[a][1],i[3*a+2]=e[a][2],t&&(r[3*a]=t[a][0],r[3*a+1]=t[a][1],r[3*a+2]=t[a][2]),s[a]=a,n[a]=0;return t||(r[0]=0,r[1]=1,r[2]=0),new S.u([["position",{size:3,data:i,exclusive:!0}],["normal",{size:3,data:r,exclusive:!0}],["uv0",{size:2,data:[0,0],exclusive:!0}]],[["position",s],["normal",t?s:n],["uv0",n]],1)},e.createTriangleGeometry=function(){const e=new Uint16Array([0,1,2]),t=new Uint16Array([0,0,0]),i=new Uint16Array([0,0,0]);return new S.u([["position",{size:3,data:[0,0,0,0,0,100,100,0,0],exclusive:!0}],["normal",{size:3,data:[0,1,0],exclusive:!0}],["uv0",{size:2,data:[0,0],exclusive:!0}]],[["position",e],["normal",t],["uv0",i]])};const t=[[-1,-1,0],[1,-1,0],[1,1,0],[-1,1,0]];function i(e,t,i,r,s){return!(Math.abs((0,v.z)(t,e))>s||((0,v._)(i,e,t),(0,v.j)(i,i),(0,v._)(r,i,e),(0,v.j)(r,r),0))}function r(e,t,r,s,n,a,o){return i(e,t,n,a,o)||i(e,r,n,a,o)||i(e,s,n,a,o)}e.createSquareGeometry=function(e=t){const i=new Array(12);for(let t=0;t<4;t++)for(let r=0;r<3;r++)i[3*t+r]=e[t][r];const r=new Uint32Array([0,1,2,2,3,0]),s=new Uint32Array([0,0,0,0,0,0]);return new S.u([["position",{size:3,data:i,exclusive:!0}],["normal",{size:3,data:[0,0,1],exclusive:!0}],["uv0",{size:2,data:[0,0,1,0,1,1,0,1],exclusive:!0}],["color",{size:4,data:[255,255,255,255],exclusive:!0}]],[["position",r],["normal",s],["uv0",r],["color",s]])},e.createConeGeometry=function(e,t,i,r,s=!0,n=!0){let a=0;const o=t,l=e;let c=(0,B.t)(0,a,0),h=(0,B.t)(0,a+l,0),d=(0,B.t)(0,-1,0),u=(0,B.t)(0,1,0);r&&(a=l,h=(0,B.t)(0,0,0),c=(0,B.t)(0,a,0),d=(0,B.t)(0,1,0),u=(0,B.t)(0,-1,0));const p=[h,c],m=[d,u],f=i+2,g=Math.sqrt(l*l+o*o);if(r)for(let e=i-1;e>=0;e--){const t=e*(2*Math.PI/i),r=(0,B.t)(Math.cos(t)*o,a,Math.sin(t)*o);p.push(r);const s=(0,B.t)(l*Math.cos(t)/g,-o/g,l*Math.sin(t)/g);m.push(s)}else for(let e=0;e<i;e++){const t=e*(2*Math.PI/i),r=(0,B.t)(Math.cos(t)*o,a,Math.sin(t)*o);p.push(r);const s=(0,B.t)(l*Math.cos(t)/g,o/g,l*Math.sin(t)/g);m.push(s)}const v=new Uint32Array(2*(i+2)*3),y=new Uint32Array(2*(i+2)*3);let _=0,x=0;if(s){for(let e=3;e<p.length;e++)v[_++]=1,v[_++]=e-1,v[_++]=e,y[x++]=0,y[x++]=0,y[x++]=0;v[_++]=p.length-1,v[_++]=2,v[_++]=1,y[x++]=0,y[x++]=0,y[x++]=0}if(n){for(let e=3;e<p.length;e++)v[_++]=e,v[_++]=e-1,v[_++]=0,y[x++]=e,y[x++]=e-1,y[x++]=1;v[_++]=0,v[_++]=2,v[_++]=p.length-1,y[x++]=1,y[x++]=2,y[x++]=m.length-1}const b=new Float32Array(3*f);for(let e=0;e<f;e++)b[3*e]=p[e][0],b[3*e+1]=p[e][1],b[3*e+2]=p[e][2];const w=new Float32Array(3*f);for(let e=0;e<f;e++)w[3*e]=m[e][0],w[3*e+1]=m[e][1],w[3*e+2]=m[e][2];return new S.u([["position",{size:3,data:b,exclusive:!0}],["normal",{size:3,data:w,exclusive:!0}]],[["position",v],["normal",y]])},e.createCylinderGeometry=function(e,t,i,r,s,n){const a=r?(0,B.r)(r):(0,B.t)(1,0,0),o=s?(0,B.r)(s):(0,B.t)(0,0,0);n=null==n||n;const l=(0,B.n)();(0,v.j)(l,a);const c=(0,B.n)();(0,v.d)(c,l,Math.abs(e));const h=(0,B.n)();(0,v.d)(h,c,-.5),(0,v.u)(h,h,o);const d=(0,B.t)(0,1,0);Math.abs(1-(0,v.z)(l,d))<.2&&(0,v.a)(d,0,0,1);const u=(0,B.n)();(0,v._)(u,l,d),(0,v.j)(u,u),(0,v._)(d,u,l);const p=2*i+(n?2:0),m=i+(n?2:0),f=new Float32Array(3*p),g=new Float32Array(3*m),y=new Float32Array(2*p),_=new Uint32Array(3*i*(n?4:2)),x=new Uint32Array(3*i*(n?4:2));n&&(f[3*(p-2)+0]=h[0],f[3*(p-2)+1]=h[1],f[3*(p-2)+2]=h[2],y[2*(p-2)]=0,y[2*(p-2)+1]=0,f[3*(p-1)+0]=f[3*(p-2)+0]+c[0],f[3*(p-1)+1]=f[3*(p-2)+1]+c[1],f[3*(p-1)+2]=f[3*(p-2)+2]+c[2],y[2*(p-1)]=1,y[2*(p-1)+1]=1,g[3*(m-2)+0]=-l[0],g[3*(m-2)+1]=-l[1],g[3*(m-2)+2]=-l[2],g[3*(m-1)+0]=l[0],g[3*(m-1)+1]=l[1],g[3*(m-1)+2]=l[2]);const b=function(e,t,i){_[e]=t,x[e]=i};let w=0;const C=(0,B.n)(),T=(0,B.n)();for(let e=0;e<i;e++){const r=e*(2*Math.PI/i);(0,v.d)(C,d,Math.sin(r)),(0,v.d)(T,u,Math.cos(r)),(0,v.u)(C,C,T),g[3*e+0]=C[0],g[3*e+1]=C[1],g[3*e+2]=C[2],(0,v.d)(C,C,t),(0,v.u)(C,C,h),f[3*e+0]=C[0],f[3*e+1]=C[1],f[3*e+2]=C[2],y[2*e+0]=e/i,y[2*e+1]=0,f[3*(e+i)+0]=f[3*e+0]+c[0],f[3*(e+i)+1]=f[3*e+1]+c[1],f[3*(e+i)+2]=f[3*e+2]+c[2],y[2*(e+i)+0]=e/i,y[2*e+1]=1;const s=(e+1)%i;b(w++,e,e),b(w++,e+i,e),b(w++,s,s),b(w++,s,s),b(w++,e+i,e),b(w++,s+i,s)}if(n){for(let e=0;e<i;e++){const t=(e+1)%i;b(w++,p-2,m-2),b(w++,e,m-2),b(w++,t,m-2)}for(let e=0;e<i;e++){const t=(e+1)%i;b(w++,e+i,m-1),b(w++,p-1,m-1),b(w++,t+i,m-1)}}return new S.u([["position",{size:3,data:f,exclusive:!0}],["normal",{size:3,data:g,exclusive:!0}],["uv0",{size:2,data:y,exclusive:!0}]],[["position",_],["normal",x],["uv0",_]])},e.createTubeGeometry=function(t,i,r,s,n){r=r||10,s=null==s||s,(0,S.i)(t.length>1);const a=[],o=[];for(let e=0;e<r;e++){a.push([0,-e-1,-(e+1)%r-1]);const t=e/r*2*Math.PI;o.push([Math.cos(t)*i,Math.sin(t)*i])}return e.createPathExtrusionGeometry(o,t,[[0,0,0]],a,s,n)},e.createPathExtrusionGeometry=function(e,t,i,s,n,a=(0,B.t)(0,0,0)){const o=e.length,l=new Float32Array(t.length*o*3+(6*i.length||0)),c=new Float32Array(t.length*o*3+(i?6:0)),h=(t.length-1)*o*6+3*s.length*2,d=new Uint32Array(h),u=new Uint32Array(h);let p=0,m=0,f=0,g=0;const y=(0,B.n)(),_=(0,B.n)(),x=(0,B.n)(),b=(0,B.n)(),w=(0,B.n)(),C=(0,B.n)(),T=(0,B.n)(),P=(0,v.n)(),R=(0,B.n)(),A=(0,B.n)(),M=(0,B.n)(),O=(0,B.n)(),D=(0,B.n)(),E=De();(0,v.a)(R,0,1,0),(0,v.c)(_,t[1],t[0]),(0,v.j)(_,_),n?((0,v.u)(P,t[0],a),(0,v.j)(x,P)):(0,v.a)(x,0,0,1),r(_,x,R,R,w,x,ar),(0,v.h)(b,x),(0,v.h)(O,w);for(let e=0;e<i.length;e++)(0,v.d)(C,w,i[e][0]),(0,v.d)(P,x,i[e][2]),(0,v.u)(C,C,P),(0,v.u)(C,C,t[0]),l[p++]=C[0],l[p++]=C[1],l[p++]=C[2];c[m++]=-_[0],c[m++]=-_[1],c[m++]=-_[2];for(let e=0;e<s.length;e++)d[f++]=s[e][0]>0?s[e][0]:-s[e][0]-1+i.length,d[f++]=s[e][1]>0?s[e][1]:-s[e][1]-1+i.length,d[f++]=s[e][2]>0?s[e][2]:-s[e][2]-1+i.length,u[g++]=0,u[g++]=0,u[g++]=0;let z=i.length;const I=i.length-1;for(let i=0;i<t.length;i++){let s=!1;i>0&&((0,v.h)(y,_),i<t.length-1?((0,v.c)(_,t[i+1],t[i]),(0,v.j)(_,_)):s=!0,(0,v.u)(A,y,_),(0,v.j)(A,A),(0,v.u)(M,t[i-1],b),Le(t[i],A,E),Qe(E,(0,S.g)(M,y),P)?((0,v.c)(P,P,t[i]),(0,v.j)(x,P),(0,v._)(w,A,x),(0,v.j)(w,w)):r(A,b,O,R,w,x,ar),(0,v.h)(b,x),(0,v.h)(O,w)),n&&((0,v.u)(P,t[i],a),(0,v.j)(D,P));for(let r=0;r<o;r++)if((0,v.d)(C,w,e[r][0]),(0,v.d)(P,x,e[r][1]),(0,v.u)(C,C,P),(0,v.j)(T,C),c[m++]=T[0],c[m++]=T[1],c[m++]=T[2],(0,v.u)(C,C,t[i]),l[p++]=C[0],l[p++]=C[1],l[p++]=C[2],!s){const e=(r+1)%o;d[f++]=z+r,d[f++]=z+o+r,d[f++]=z+e,d[f++]=z+e,d[f++]=z+o+r,d[f++]=z+o+e;for(let e=0;e<6;e++)u[g++]=d[f-6+e]-I}z+=o}const L=t[t.length-1];for(let e=0;e<i.length;e++)(0,v.d)(C,w,i[e][0]),(0,v.d)(P,x,i[e][1]),(0,v.u)(C,C,P),(0,v.u)(C,C,L),l[p++]=C[0],l[p++]=C[1],l[p++]=C[2];const F=m/3;c[m++]=_[0],c[m++]=_[1],c[m++]=_[2];const V=z-o;for(let e=0;e<s.length;e++)d[f++]=s[e][0]>=0?z+s[e][0]:-s[e][0]-1+V,d[f++]=s[e][2]>=0?z+s[e][2]:-s[e][2]-1+V,d[f++]=s[e][1]>=0?z+s[e][1]:-s[e][1]-1+V,u[g++]=F,u[g++]=F,u[g++]=F;return new S.u([["position",{size:3,data:l,exclusive:!0}],["normal",{size:3,data:c,exclusive:!0}]],[["position",d],["normal",u]])},e.createPolylineGeometry=function(e,t,i){(0,S.i)(e.length>1,"createPolylineGeometry(): polyline needs at least 2 points"),(0,S.i)(3===e[0].length,"createPolylineGeometry(): malformed vertex"),(0,S.i)(null==t||t.length===e.length,"createPolylineGeometry: need same number of points and normals"),(0,S.i)(null==t||3===t[0].length,"createPolylineGeometry(): malformed normal");const r=new Float64Array(3*e.length),s=new Uint32Array(2*(e.length-1));let n=0,a=0;for(let t=0;t<e.length;t++){for(let i=0;i<3;i++)r[n++]=e[t][i];t>0&&(s[a++]=t-1,s[a++]=t)}const o=[],l=[];if(o.push(["position",s]),l.push(["position",{size:3,data:r,exclusive:!0}]),t){const i=new Float32Array(3*t.length);let r=0;for(let s=0;s<e.length;s++)for(let e=0;e<3;e++)i[r++]=t[s][e];o.push(["normal",s]),l.push(["normal",{size:3,data:i,exclusive:!0}])}return i&&(l.push(["color",{size:4,data:i}]),o.push(["color",(0,w.l)(i.length/4)])),new S.u(l,o,2)},e.createExtrudedTriangle=function(e,t,i,r,s=0){const n=new Array(18),a=[[-t,s,r/2],[i,s,r/2],[0,e+s,r/2],[-t,s,-r/2],[i,s,-r/2],[0,e+s,-r/2]],o=new Uint16Array([0,1,2,3,0,2,2,5,3,1,4,5,5,2,1,1,0,3,3,4,1,4,3,5]);for(let e=0;e<6;e++)n[3*e]=a[e][0],n[3*e+1]=a[e][1],n[3*e+2]=a[e][2];return new S.u([["position",{size:3,data:n,exclusive:!0}]],[["position",o]])},e.transformInPlace=function(e,t){const i=e.getMutableAttribute("position").data;for(let e=0;e<i.length;e+=3){const r=i[e],s=i[e+1],n=i[e+2];(0,v.a)(or,r,s,n),(0,v.I)(or,or,t),i[e]=or[0],i[e+1]=or[1],i[e+2]=or[2]}},e.cgToGIS=function(e,t=e){const i=e.vertexAttributes,r=i.get("position").data,s=i.get("normal").data;if(s){const e=t.getMutableAttribute("normal").data;for(let t=0;t<s.length;t+=3){const i=s[t+1];e[t+1]=-s[t+2],e[t+2]=i}}if(r){const e=t.getMutableAttribute("position").data;for(let t=0;t<r.length;t+=3){const i=r[t+1];e[t+1]=-r[t+2],e[t+2]=i}}return t},e.makeOrthoBasisDirUp=i,e.makeOrthoBasisDirUpFallback=r}(nr||(nr={}));const ar=.99619469809,or=(0,B.n)();var lr=nr;const cr=u.n.getLogger("esri.views.3d.environment.PanoramicAtmosphere");class hr{constructor(){this.slot=14,this._atmosphereTechniqueConfig=new Ki,this._readyResolver=(0,h.D)(),this._readyController=(0,h.h)()}get canRender(){return null!=this._texture}destroy(){this._readyResolver.reject(),this._texture=(0,u.z)(this._texture),this._vao=(0,u.z)(this._vao),this._readyController=(0,u.B)(this._readyController)}when(){return this._readyResolver.promise}initializeRenderContext(e){this._atmosphereTechniqueConfig.geometry=1,this._atmosphereTechnique=e.shaderTechniqueRep.acquire($i,this._atmosphereTechniqueConfig);const t=e.renderContext.rctx;this._vao=this._createVertexArrayObject(t),this._vaoCount=(0,V.a)(this._vao,"geometry"),(0,F.t)(er,{signal:this._readyController.signal}).then((i=>{this._texture=new q.r(t,{pixelFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9729,flipped:!0},i),e.requestRender(),this._readyController=null,this._readyResolver.resolve()})).catch((e=>{(0,h.g)(e)||cr.error("Unable to initialize atmosphere: image request failed",e),this._readyResolver.reject()}))}uninitializeRenderContext(){this.destroy()}render(e){if(e.slot!==this.slot||0!==e.pass)return!1;const t=e.rctx,i=this._atmosphereTechnique.program;return t.useProgram(i),this._atmosphereTechnique.bindPipelineState(t),i.bindTexture(this._texture,"tex"),(0,S.h)(i,e.camera.projectionMatrix),function(e,t){(0,C.n)(e,t),e[12]=0,e[13]=0,e[14]=0,e[15]=1}(dr,e.camera.viewMatrix),i.setUniformMatrix4fv("view",dr),i.setUniform4f("color",1,1,1,1),e.scenelightingData.setLightDirectionUniform(i),t.bindVAO(this._vao),i.assertCompatibleVertexAttributeLocations(this._vao),t.drawArrays(4,0,this._vaoCount),!0}_createVertexArrayObject(e){const t=lr.createPolySphereGeometry(1,2,!1),i=t.indices.get("position");for(let e=0;e<i.length;e+=3){const t=i[e];i[e]=i[e+2],i[e+2]=t}const r=t.vertexAttributes.get("position").data,s=ur.createBuffer(i.length),n=s.position;for(let e=0;e<i.length;++e){const t=3*i[e];n.set(e,0,r[t]),n.set(e,1,r[t+1]),n.set(e,2,r[t+2])}return new V.f(e,S.o,{geometry:(0,U.t)(ur)},{geometry:V.h.createVertex(e,35044,s.buffer)})}}const dr=(0,T.e)(),ur=(0,G.A)().vec3f("position");function pr(e){return Math.min(1,Math.max(0,(e-1e5)/9e5))}function mr(e){const t=new S.n;return t.attributes.add("position","vec2"),t.attributes.add("uv0","vec2"),t.varyings.add("worldRay","vec3"),t.varyings.add("vtc","vec2"),e.haze&&t.varyings.add("eyeDir","vec3"),t.vertex.uniforms.add("projectionInverse","mat4"),t.vertex.uniforms.add("viewInverse","mat4"),t.vertex.code.add(S.t`
    void main(void) {
      vec3 posViewNear = (projectionInverse * vec4(position, -1, 1)).xyz;

      worldRay = (viewInverse * vec4(posViewNear, 0)).xyz;
      vtc = uv0;

      ${e.haze?S.t`eyeDir = posViewNear;`:""}

      gl_Position = vec4(position, 1, 1);
    }
  `),t.fragment.uniforms.add("lightingMainDirection","vec3").add("invWavelength","vec3").add("invWavelengthScaled","vec3").add("radii","vec2").add("atmosphereParameters1","vec4").add("atmosphereParameters2","vec4").add("cameraPosition","vec3").add("nearFar","vec2").add("heightParameters","vec4"),e.haze?t.fragment.uniforms.add("depthTex","sampler2D"):t.fragment.uniforms.add("atmosphereParameters3","vec3").add("innerFadeDistance","float").add("altitudeFade","float"),t.fragment.include(S.j),t.fragment.code.add(S.t`const float krESun = 0.075;
const float kmESun = 0.015;
#define innerRadius radii[0]
#define outerRadius radii[1]
#define shellScale atmosphereParameters1.x
#define shellDepth vec2(atmosphereParameters1.y, atmosphereParameters2.y)
#define scaleOverScaleDepth vec2(atmosphereParameters1.z, atmosphereParameters2.z)
#define oneOverScaleDepth vec2(atmosphereParameters1.w, atmosphereParameters2.w)`),e.haze||t.fragment.code.add(S.t`#define g atmosphereParameters2.x
#define gSq atmosphereParameters3.x
#define miePhaseCoefficients atmosphereParameters3.y
#define lowerAlphaBlendBound atmosphereParameters3.z`),t.fragment.code.add(S.t`
  // The camera's current height
  #define cameraHeight heightParameters[0]
  // cameraHeight^2
  #define cameraHeightSq heightParameters[1]
  // cameraHeightSq - outerRadiusSq; // C = ||o-c||^2 - r^2
  #define C heightParameters[2]
  // cameraHeightSq - (innerRadiusSq - 63756370000.0); // C = ||o-c||^2 - r^2
  #define CSur heightParameters[3]

  ${e.haze?"// Camera HDR\n        const float exposure = 1.5;\n        const vec3 oneOverGamma = vec3(1.0); //Gamma = 1.0":"const float exposure = 2.0;\n        const vec3 oneOverGamma = vec3(0.454545); // Gamma = 2.2\n        vec3 reinhardTM(vec3 inputColor, float _exposure) {\n          vec3 intermediate = inputColor * _exposure;\n          intermediate /= ( 1.0 + intermediate );\n          return pow(intermediate, oneOverGamma);\n        }\n        "}
    // Loop constants for integral approximation
    const float samples = 5.0;
    const int maxSamples = 5;

    // ToneMapping operators
    vec3 expTM(vec3 inputColor,float _exposure) {
        return pow(1.0 - exp(inputColor * -_exposure), oneOverGamma);
    }

    // Approximation for inner integral based on a radii ratio of 10.25:10
    float scale(float _cos) {
      float x = 1.0 - _cos;
      return exp( -0.00287 + x * ( 0.459 + x * ( 3.83 + x * (-6.80 + x * 5.25 ))));
    }

    void main() {
      // Obtain ray from Camera
      vec3 worldSpaceRay = normalize(worldRay);

      // Compute Atmosphere intersection; i.e. ray/sphere intersection
      float B = 2.0 * dot(cameraPosition, worldSpaceRay); // B = 2(l * (o-c))
      float det = B * B - 4.0 * C; // det = B^2 - 4.0* C

      // idealized sphere intersection to discard early some pixels
      float detSur = B * B - 4.0 * CSur; // det = B^2 - 4.0* C

      // the minimal sample start position:
      // at the camera by default, on the earth radius surface if the camera is underground.
      float minRayStart = 0.0;
  `),e.haze||t.fragment.code.add(S.t`float surfaceBlend = 0.0;
vec4 surfaceColor = vec4(0.0);
if (detSur >= 0.0) {
float nearSurface = max(0.0, 0.5 *(-B - sqrt(detSur)));
float farSurface = max(0.0, 0.5 *(-B + sqrt(detSur)));
if (nearSurface == 0.0) {
minRayStart = farSurface;
}
vec3 vPos = cameraPosition + worldSpaceRay * nearSurface;
float lightAngle = dot(lightingMainDirection, normalize(vPos));
float brightness = max(0.0, (smoothstep(-1.0, 0.8, 2.0 * lightAngle)));
surfaceColor = vec4(brightness, brightness, brightness, 1.0 - altitudeFade);
float relDist = (farSurface - nearSurface) / innerFadeDistance;
if (relDist > 1.0) {
gl_FragColor = surfaceColor;
return;
}
surfaceBlend = smoothstep(0.0, 1.0, relDist * relDist);
}`),t.fragment.code.add(S.t`
    if (det >= 0.0) {
    ${e.haze?"\n          float depthSample = texture2D(depthTex, vtc).r;\n\n          float zNear = nearFar[0];\n          float zFar = nearFar[1];\n\n          // http://web.archive.org/web/20130416194336/http://olivers.posterous.com/linear-depth-in-glsl-for-real\n          float zNorm = 2.0 * depthSample - 1.0;\n          float linDepth = 2.0 * zNear * zFar /\n            (zFar + zNear - zNorm * (zFar - zNear));\n\n          float rayEnd;\n          float altitudeAlpha = 1.0;\n\n          // find intersections with ground, but only between the near and far\n          // clipping planes.\n          if (depthSample < 1.0 && depthSample > 0.0) {\n            vec3 cameraSpaceRay = normalize(eyeDir);\n            cameraSpaceRay /= cameraSpaceRay.z;\n            cameraSpaceRay *= linDepth;\n\n            float cameraSpaceRayLength = length(cameraSpaceRay);\n\n            vec3 world = cameraPosition + worldSpaceRay * cameraSpaceRayLength;\n            float worldRadiusSq = dot(world, world);\n\n            // Handle tall structures:\n            // https://devtopia.esri.com/WebGIS/arcgis-js-api/issues/5450\n            float transitionStart = innerRadius + 20000.0;\n            float transitionHeight = 25000.0;\n            float transitionEnd = transitionStart + transitionHeight;\n\n            float edge0 = transitionStart * transitionStart;\n            float edge1 = transitionEnd * transitionEnd;\n\n            altitudeAlpha = 1.0 - clamp((worldRadiusSq - edge0) / (edge1 - edge0), 0.0, 1.0);\n            rayEnd = cameraSpaceRayLength;\n\n            if (altitudeAlpha > 0.0 && detSur > 0.0) {\n              float nearSurface = 0.5 * ( -B - sqrt(detSur) );\n              float interp = clamp(((cameraHeight - innerRadius) - 2000000.0) / 6000000.0, 0.0, 1.0);\n              rayEnd = mix(cameraSpaceRayLength, nearSurface, interp);\n            }\n          }":""}
    float rayStart = 0.5 *(-B - sqrt(det)); //near intersection with atmosphere
    ${e.haze?"float near = abs(rayStart);\n        float far = abs(rayEnd);":"float rayEnd = 0.5 *(-B + sqrt(det)); //far intersection with atmosphere"}

    float scatterDistance; // calculate its scattering offset
    // Calculate the ray's starting position
    if (rayStart < minRayStart)
    { // ray starts from camera or inner radius sphere to far
      rayStart = minRayStart;
      ${e.haze?"":"// clamp to value at inner radius altitude\n          scatterDistance = shellScale * min(0.0, innerRadius - cameraHeight);"}
    }
    ${e.haze?"":"else { // outside atmosphere\n          scatterDistance = -1.0;\n        }"}
    // Initialize the scattering loop variables
    vec3 start = cameraPosition + worldSpaceRay * rayStart;
  `),e.haze&&t.fragment.code.add(S.t`vec3 end = cameraPosition + worldSpaceRay * rayEnd;
float endLength = length(end);
vec2 altitudeInterval = vec2(length(start) - innerRadius, endLength - innerRadius);
if (altitudeInterval.x < 0.0) {
altitudeInterval = -altitudeInterval;
}
float lightAngle = dot(lightingMainDirection, end) / endLength;
if (near > far)
{
if (altitudeInterval.x < altitudeInterval.y)
{
end = cameraPosition + worldSpaceRay * rayStart;
start = cameraPosition + worldSpaceRay * rayEnd;
worldSpaceRay *= -1.0;
float tmp = altitudeInterval.x;
altitudeInterval.x = altitudeInterval.y;
altitudeInterval.y = tmp;
}
else if (altitudeInterval.x == altitudeInterval.y)
{
altitudeInterval.x += 1.0;
}
}
if (altitudeInterval.x > outerRadius - innerRadius)
{
scatterDistance = innerRadius - outerRadius;
} else
{
scatterDistance = altitudeInterval.y - altitudeInterval.x;
}`),t.fragment.code.add(S.t`vec2 opticalStartDepth = exp(scatterDistance * oneOverScaleDepth);
float rayLength = rayEnd - rayStart;
float sampleLength = rayLength / samples;
float scaledLength = sampleLength * shellScale;
vec3 sampleRay = worldSpaceRay * sampleLength;
vec3 samplePoint = start + sampleRay * 0.5;`),e.haze?t.fragment.code.add(S.t`float cameraAngle = dot(-worldSpaceRay, end) / length(end);
float scaleCameraAngle = scale(cameraAngle);
vec2 cameraOffset = scaleCameraAngle * opticalStartDepth;
float scaledValues = scale(lightAngle) + scaleCameraAngle;
vec2 scaledValuesDepth = scaledValues * shellDepth;`):t.fragment.code.add(S.t`float cameraAngle = dot(worldSpaceRay, start / length(start));
float angleMultiplier = cameraAngle > 0.0 ? cameraAngle : 0.0;
float scaleCameraAngle = scale(cameraAngle);
vec2 cameraOffset = scaleCameraAngle * opticalStartDepth * shellDepth;`),t.fragment.code.add(S.t`vec3 frontColor = vec3(0.0);
vec3 frontColorBlue = vec3(0.0);
vec3 attenuate = vec3(0.0);
vec3 attenuateBlue = vec3(0.0);
for(int i=0; i<maxSamples; i++) {
float height = length(samplePoint);
float altitude = abs(height - innerRadius);
vec2 depth = exp(-altitude * scaleOverScaleDepth);`),e.haze?t.fragment.code.add(S.t`vec2 scatter = depth * scaledValuesDepth - cameraOffset;`):t.fragment.code.add(S.t`float lightAngle = dot(lightingMainDirection, samplePoint) / height;
float cameraAngle = dot(worldSpaceRay, samplePoint) / height;
float tmpScaledValues = scale(lightAngle) - scale(cameraAngle);
vec2 scatter = cameraOffset + tmpScaledValues * depth * shellDepth;`),t.fragment.code.add(S.t`attenuate = exp(-scatter.x * invWavelengthScaled);
attenuateBlue = exp(-scatter.y * invWavelengthScaled);
frontColor += attenuate * depth.x;
frontColorBlue += attenuateBlue * depth.y;
samplePoint += sampleRay;
}
float LdotR = clamp(dot(lightingMainDirection, -worldSpaceRay ),-0.9999999,1.0);
float LdotRSq = LdotR * LdotR + 1.0;`),e.haze?t.fragment.code.add(S.t`vec3 colorCoefficients = (scaledLength * 0.75 * LdotRSq) * (krESun * invWavelength + kmESun );
vec3 color = colorCoefficients * frontColor;
vec3 colorBlue = colorCoefficients * frontColorBlue;`):t.fragment.code.add(S.t`vec3 rayleighCoefficients = (scaledLength * 0.75 * LdotRSq * krESun) * invWavelength;
float mieCoefficients = scaledLength * kmESun * miePhaseCoefficients * LdotRSq / pow(1.0 + gSq - 2.0 * g * LdotR, 1.5);
vec3 color = rayleighCoefficients * frontColor + mieCoefficients * frontColor;
vec3 colorBlue = rayleighCoefficients * frontColorBlue + mieCoefficients * frontColorBlue;`),t.fragment.code.add(S.t`vec3 ldrBlue = expTM(colorBlue, 2.0 * exposure);
vec3 ldrRed = expTM(color, exposure);
vec3 LDR = mix(ldrBlue, ldrRed, 0.2);`),e.haze?t.fragment.code.add(S.t`LDR *= (1.0 - cameraAngle);
vec3 hsv = rgb2hsv(LDR);
hsv.y = clamp(hsv.y * 1.5, 0.0, 1.0);
LDR = hsv2rgb(hsv);
vec3 finalColor = LDR;`):t.fragment.code.add(S.t`vec3 ldrReinhard = reinhardTM(color, exposure);
LDR += angleMultiplier * ldrReinhard;
float side = (rayEnd + rayStart) * 0.5;
float atmoHeight = sqrt(cameraHeightSq - side * side);
float h2 = clamp(1.0 - ( atmoHeight - lowerAlphaBlendBound ) / ( outerRadius - lowerAlphaBlendBound ), 0.0, 1.0);
vec3 finalColor = LDR * h2;
vec3 hsv = rgb2hsv(finalColor);
hsv.y = clamp(hsv.y * 1.5, 0.0, 1.0);
finalColor = hsv2rgb(hsv);`),t.fragment.code.add(S.t`
    ${e.haze?"gl_FragColor = vec4(finalColor, 1.0) * altitudeAlpha;":"float atmosStrength = clamp((length(ldrRed) - 0.05) * 1.05, 0.0, 1.0);\n          gl_FragColor = vec4(finalColor, atmosStrength * clamp(1.0 - ( atmoHeight - innerRadius ) / (outerRadius - innerRadius), 0.0, 1.0));\n          if (surfaceBlend > 0.0) {\n            gl_FragColor = mix(gl_FragColor, surfaceColor, surfaceBlend);\n          }"}
      } else { // Outside Atmosphere
        gl_FragColor = vec4(0.0);
      }
    }
  `),t}var fr=Object.freeze({__proto__:null,build:mr});class gr extends S.c{initializeProgram(e){const t=gr.shader.get(),i=this.configuration,r=t.build({haze:i.haze});return new S.d(e.rctx,r,S.o)}initializePipeline(){return this.configuration.haze?(0,V.g)({blending:(0,V.e)(1,0,769,1),colorWrite:V.r}):(0,V.g)({blending:(0,V.e)(770,1,771,771),depthTest:{func:515},colorWrite:V.r})}}gr.shader=new S.f(fr,(()=>i.e(444).then(i.bind(i,90444))));class vr extends S.b{constructor(){super(...arguments),this.haze=!1}}(0,r.e)([(0,S.a)()],vr.prototype,"haze",void 0);class yr{constructor(e){this._view=e,this.canRender=!0,this._skyslot=14,this._hazeSlot=15,this._renderData={texDepth:(0,N.n)(),cameraPosition:(0,v.n)(),projectionInverse:(0,T.e)(),viewInverse:(0,T.e)(),heightParameters:(0,w.n)(),atmosphereParameters1:(0,w.n)(),atmosphereParameters2:(0,w.n)(),atmosphereParameters3:(0,v.n)(),invWavelength:br,invWavelengthScaled:wr,radii:(0,N.n)(),scale:0,scaleDepth:Cr,lowerAlphaBlendBound:0,scaleOverScaleDepth:0,oneOverScaleDepth:0,scaleDepthBlue:Tr,oneOverScaleDepthBlue:Pr,scaleOverScaleDepthBlue:0,g:Rr,g2:Rr*Rr,miePhaseCoefficients:Ar,nearFar:(0,N.n)(),cameraHeight:0,cameraHeightSq:0,C:0,CSur:0,innerFadeDistance:0,altitudeFade:0},this._lowerElevationBoundRadius=0,this._lowerBoundEarthRadius=g.s.radius,this._updateRadius(g.s.radius)}destroy(){this._handles&&(this._handles.destroy(),this._handles=null),this._vao&&(this._vao.dispose(),this._vao=null)}when(){return Promise.resolve()}initializeRenderContext(e){const t=e.renderContext.rctx;this._handles=new R.u,this._updateElevation({spatialReference:this._view.basemapTerrain.spatialReference,tile:this._view.basemapTerrain.rootTiles[0],extent:this._view.basemapTerrain.rootTiles[0].extent,context:"ground"}),this._handles.add((0,p.C)(this._view,"basemapTerrain","elevation-change",(e=>this._updateElevation(e)),(()=>this._updateElevation()))),this._handles.add((0,p.C)(this._view,"basemapTerrain","elevation-bounds-change",(()=>this._updateVisibleElevationBounds()),(()=>this._updateVisibleElevationBounds())));const i=new vr;i.haze=!1,this._atmosphereTechnique=e.shaderTechniqueRep.acquire(gr,i),i.haze=!0,this._atmosphereHazeTechnique=e.shaderTechniqueRep.acquire(gr,i),this._vao=this._createVertexArrayObject(t)}uninitializeRenderContext(){this.destroy()}render(e){return(e.slot===this._hazeSlot||e.slot===this._skyslot)&&0===e.pass&&(this._update(e.camera),e.slot===this._skyslot&&this._renderSky(e),e.slot===this._hazeSlot&&this._renderHaze(e),!0)}_renderSky(e){const t=e.rctx,i=this._atmosphereTechnique.program;t.useProgram(i),this._atmosphereTechnique.bindPipelineState(t),i.setUniform3fv("atmosphereParameters3",this._renderData.atmosphereParameters3),this._renderCommon(i,e)}_renderHaze(e){const t=e.rctx,i=e.offscreenRenderingHelper,r=this._atmosphereHazeTechnique.program;t.useProgram(r),this._atmosphereHazeTechnique.bindPipelineState(t),i.renderDepthDetached((()=>{const t=i.depthTexture;r.bindTexture(t,"depthTex"),this._renderCommon(r,e)}))}_renderCommon(e,t){const i=t.rctx;e.setUniform3fv("invWavelength",this._renderData.invWavelength),e.setUniform3fv("invWavelengthScaled",this._renderData.invWavelengthScaled),t.scenelightingData.setLightDirectionUniform(e),e.setUniform4fv("heightParameters",this._renderData.heightParameters),e.setUniform3fv("cameraPosition",this._renderData.cameraPosition),e.setUniformMatrix4fv("projectionInverse",this._renderData.projectionInverse),e.setUniformMatrix4fv("viewInverse",this._renderData.viewInverse),e.setUniform2fv("nearFar",this._renderData.nearFar),e.setUniform2fv("radii",this._renderData.radii),e.setUniform4fv("atmosphereParameters1",this._renderData.atmosphereParameters1),e.setUniform4fv("atmosphereParameters2",this._renderData.atmosphereParameters2),e.setUniform1f("innerFadeDistance",this._renderData.innerFadeDistance),e.setUniform1f("altitudeFade",this._renderData.altitudeFade),i.bindVAO(this._vao),e.assertCompatibleVertexAttributeLocations(this._vao),i.drawArrays(5,0,4)}_createVertexArrayObject(e){const t=Mr.createBuffer(4);return t.position.setVec(0,[-1,-1]),t.position.setVec(1,[1,-1]),t.position.setVec(2,[-1,1]),t.position.setVec(3,[1,1]),t.uv0.setVec(0,[0,0]),t.uv0.setVec(1,[1,0]),t.uv0.setVec(2,[0,1]),t.uv0.setVec(3,[1,1]),new V.f(e,S.o,{geometry:(0,U.t)(Mr)},{geometry:V.h.createVertex(e,35044,t.buffer)})}_adjustRadiusForTesselation(e){const t=Math.PI/16/16;return e*Math.cos(t)}_updateElevation(e){const t=e?e.tile:this._view.basemapTerrain.rootTiles[0];if(0!==t.lij[0])return;const i=this._adjustRadiusForTesselation(g.s.radius+t.elevationBounds[0]);i!==this._lowerElevationBoundRadius&&(this._lowerElevationBoundRadius=i,this._lowerBoundEarthRadius=-1,this._updateVisibleElevationBounds())}_updateVisibleElevationBounds(){const e=this._adjustRadiusForTesselation(g.s.radius+this._view.basemapTerrain.elevationBounds.min);(this._lowerBoundEarthRadius<0||e<this._lowerBoundEarthRadius)&&this._updateRadius(e)}_updateRadius(e){this._lowerBoundEarthRadius=e;const t=e,i=t/10*10.25,r=1/(i-t),s=r/Cr,n=r/Tr,a=.3*(i-t)+t,o=this._renderData;(0,j.r)(o.atmosphereParameters1,r,Cr,s,Sr),(0,j.r)(o.atmosphereParameters2,Rr,Tr,n,Pr),(0,v.a)(o.atmosphereParameters3,Rr*Rr,Ar,a),(0,k.r)(o.radii,t,i),o.scale=r,o.lowerAlphaBlendBound=a,o.scaleOverScaleDepth=s,o.scaleOverScaleDepthBlue=n,o.innerFadeDistance=2*Math.sqrt(1e4*(2*t-1e4))}_update(e){e&&(this._renderData.cameraHeight=(0,v.s)(e.eye),this._renderData.cameraHeightSq=this._renderData.cameraHeight*this._renderData.cameraHeight,this._renderData.C=this._renderData.cameraHeightSq-this._renderData.radii[1]*this._renderData.radii[1],this._renderData.CSur=this._renderData.cameraHeightSq-this._renderData.radii[0]*this._renderData.radii[0],this._renderData.heightParameters=(0,w.a)(this._renderData.cameraHeight,this._renderData.cameraHeightSq,this._renderData.C,this._renderData.CSur),(0,v.h)(this._renderData.cameraPosition,e.eye),(0,C.h)(this._renderData.projectionInverse,e.projectionMatrix),(0,C.h)(this._renderData.viewInverse,e.viewMatrix),(0,k.r)(this._renderData.nearFar,e.near,e.far),this._renderData.altitudeFade=pr(this._renderData.cameraHeight-this._lowerBoundEarthRadius))}static isSupported(e){return e.renderContext.rctx.capabilities.depthTexture}}const _r=.02*Math.PI,xr=.004*Math.PI,br=(0,v.i)(1/.65**4,1/.57**4,1/.475**4),wr=(0,v.k)(br);(0,v.d)(wr,wr,_r),(0,v.u)(wr,wr,(0,v.i)(xr,xr,xr));const Cr=.25,Tr=.05,Sr=1/Cr,Pr=1/Tr,Rr=-.99999,Ar=(1-Rr*Rr)/(2+Rr*Rr)*1.5,Mr=(0,G.A)().vec2f("position").vec2f("uv0"),Or=u.n.getLogger("esri.views.3d.environment.SimpleAtmosphere"),Dr=-1e4,Er=(0,s.I)([[50,.1015625],[500,.21875],[5e3,1-250/512],[5e4,.4140625]]);class zr{constructor(e){this.view=e,this.slot=14,this._renderData={texV:(0,N.n)(),silCircleCenter:(0,v.n)(),silCircleV1:(0,v.n)(),silCircleV2:(0,v.n)(),altitudeFade:0,innerScale:0,undergroundFadeAlpha:0},this._fadeVaoCount=0,this._readyResolver=(0,h.D)(),this._readyController=(0,h.h)(),this.texV1=1,this.isOnMars=(0,O.a)(e.spatialReference);const t=(0,x.p)(e.spatialReference);this.planetRadius=t.radius,this.outerRimWidth=t.outerAtmosphereRimWidth,this.innerRimFactor=(this.planetRadius+Dr)/this.planetRadius,this.middleRimFactor=(this.planetRadius+0)/this.planetRadius,this.outerRimFactor=(this.planetRadius+this.outerRimWidth)/this.planetRadius,this.texV0=0/this.outerRimWidth,this.texVScale=this.texV1-this.texV0}get canRender(){return null!=this._texture}when(){return this._readyResolver.promise}initializeRenderContext(e){const t=e.renderContext.rctx;this._cameraChangeHandle=(0,p.d)(this.view,"state.camera",(()=>e.requestRender()),!0);const i=new Ki;i.geometry=0,this._atmosphereConeTechnique=e.shaderTechniqueRep.acquire($i,i),i.geometry=2,this._atmosphereUndergroundTechnique=e.shaderTechniqueRep.acquire($i,i),this._vao=this._createRibbon(t),this._vaoCount=(0,V.a)(this._vao,"geometry"),this._fadeVao=(0,S.l)(t),this._fadeVaoCount=(0,V.a)(this._fadeVao,"geometry"),(0,F.t)(this.isOnMars?"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAIACAYAAAE00TaTAAAACXBIWXMAAA7AAAAOwAFq1okJAAAKT2lDQ1BQaG90b3Nob3AgSUNDIHByb2ZpbGUAAHjanVNnVFPpFj333vRCS4iAlEtvUhUIIFJCi4AUkSYqIQkQSoghodkVUcERRUUEG8igiAOOjoCMFVEsDIoK2AfkIaKOg6OIisr74Xuja9a89+bN/rXXPues852zzwfACAyWSDNRNYAMqUIeEeCDx8TG4eQuQIEKJHAAEAizZCFz/SMBAPh+PDwrIsAHvgABeNMLCADATZvAMByH/w/qQplcAYCEAcB0kThLCIAUAEB6jkKmAEBGAYCdmCZTAKAEAGDLY2LjAFAtAGAnf+bTAICd+Jl7AQBblCEVAaCRACATZYhEAGg7AKzPVopFAFgwABRmS8Q5ANgtADBJV2ZIALC3AMDOEAuyAAgMADBRiIUpAAR7AGDIIyN4AISZABRG8lc88SuuEOcqAAB4mbI8uSQ5RYFbCC1xB1dXLh4ozkkXKxQ2YQJhmkAuwnmZGTKBNA/g88wAAKCRFRHgg/P9eM4Ors7ONo62Dl8t6r8G/yJiYuP+5c+rcEAAAOF0ftH+LC+zGoA7BoBt/qIl7gRoXgugdfeLZrIPQLUAoOnaV/Nw+H48PEWhkLnZ2eXk5NhKxEJbYcpXff5nwl/AV/1s+X48/Pf14L7iJIEyXYFHBPjgwsz0TKUcz5IJhGLc5o9H/LcL//wd0yLESWK5WCoU41EScY5EmozzMqUiiUKSKcUl0v9k4t8s+wM+3zUAsGo+AXuRLahdYwP2SycQWHTA4vcAAPK7b8HUKAgDgGiD4c93/+8//UegJQCAZkmScQAAXkQkLlTKsz/HCAAARKCBKrBBG/TBGCzABhzBBdzBC/xgNoRCJMTCQhBCCmSAHHJgKayCQiiGzbAdKmAv1EAdNMBRaIaTcA4uwlW4Dj1wD/phCJ7BKLyBCQRByAgTYSHaiAFiilgjjggXmYX4IcFIBBKLJCDJiBRRIkuRNUgxUopUIFVIHfI9cgI5h1xGupE7yAAygvyGvEcxlIGyUT3UDLVDuag3GoRGogvQZHQxmo8WoJvQcrQaPYw2oefQq2gP2o8+Q8cwwOgYBzPEbDAuxsNCsTgsCZNjy7EirAyrxhqwVqwDu4n1Y8+xdwQSgUXACTYEd0IgYR5BSFhMWE7YSKggHCQ0EdoJNwkDhFHCJyKTqEu0JroR+cQYYjIxh1hILCPWEo8TLxB7iEPENyQSiUMyJ7mQAkmxpFTSEtJG0m5SI+ksqZs0SBojk8naZGuyBzmULCAryIXkneTD5DPkG+Qh8lsKnWJAcaT4U+IoUspqShnlEOU05QZlmDJBVaOaUt2ooVQRNY9aQq2htlKvUYeoEzR1mjnNgxZJS6WtopXTGmgXaPdpr+h0uhHdlR5Ol9BX0svpR+iX6AP0dwwNhhWDx4hnKBmbGAcYZxl3GK+YTKYZ04sZx1QwNzHrmOeZD5lvVVgqtip8FZHKCpVKlSaVGyovVKmqpqreqgtV81XLVI+pXlN9rkZVM1PjqQnUlqtVqp1Q61MbU2epO6iHqmeob1Q/pH5Z/YkGWcNMw09DpFGgsV/jvMYgC2MZs3gsIWsNq4Z1gTXEJrHN2Xx2KruY/R27iz2qqaE5QzNKM1ezUvOUZj8H45hx+Jx0TgnnKKeX836K3hTvKeIpG6Y0TLkxZVxrqpaXllirSKtRq0frvTau7aedpr1Fu1n7gQ5Bx0onXCdHZ4/OBZ3nU9lT3acKpxZNPTr1ri6qa6UbobtEd79up+6Ynr5egJ5Mb6feeb3n+hx9L/1U/W36p/VHDFgGswwkBtsMzhg8xTVxbzwdL8fb8VFDXcNAQ6VhlWGX4YSRudE8o9VGjUYPjGnGXOMk423GbcajJgYmISZLTepN7ppSTbmmKaY7TDtMx83MzaLN1pk1mz0x1zLnm+eb15vft2BaeFostqi2uGVJsuRaplnutrxuhVo5WaVYVVpds0atna0l1rutu6cRp7lOk06rntZnw7Dxtsm2qbcZsOXYBtuutm22fWFnYhdnt8Wuw+6TvZN9un2N/T0HDYfZDqsdWh1+c7RyFDpWOt6azpzuP33F9JbpL2dYzxDP2DPjthPLKcRpnVOb00dnF2e5c4PziIuJS4LLLpc+Lpsbxt3IveRKdPVxXeF60vWdm7Obwu2o26/uNu5p7ofcn8w0nymeWTNz0MPIQ+BR5dE/C5+VMGvfrH5PQ0+BZ7XnIy9jL5FXrdewt6V3qvdh7xc+9j5yn+M+4zw33jLeWV/MN8C3yLfLT8Nvnl+F30N/I/9k/3r/0QCngCUBZwOJgUGBWwL7+Hp8Ib+OPzrbZfay2e1BjKC5QRVBj4KtguXBrSFoyOyQrSH355jOkc5pDoVQfujW0Adh5mGLw34MJ4WHhVeGP45wiFga0TGXNXfR3ENz30T6RJZE3ptnMU85ry1KNSo+qi5qPNo3ujS6P8YuZlnM1VidWElsSxw5LiquNm5svt/87fOH4p3iC+N7F5gvyF1weaHOwvSFpxapLhIsOpZATIhOOJTwQRAqqBaMJfITdyWOCnnCHcJnIi/RNtGI2ENcKh5O8kgqTXqS7JG8NXkkxTOlLOW5hCepkLxMDUzdmzqeFpp2IG0yPTq9MYOSkZBxQqohTZO2Z+pn5mZ2y6xlhbL+xW6Lty8elQfJa7OQrAVZLQq2QqboVFoo1yoHsmdlV2a/zYnKOZarnivN7cyzytuQN5zvn//tEsIS4ZK2pYZLVy0dWOa9rGo5sjxxedsK4xUFK4ZWBqw8uIq2Km3VT6vtV5eufr0mek1rgV7ByoLBtQFr6wtVCuWFfevc1+1dT1gvWd+1YfqGnRs+FYmKrhTbF5cVf9go3HjlG4dvyr+Z3JS0qavEuWTPZtJm6ebeLZ5bDpaql+aXDm4N2dq0Dd9WtO319kXbL5fNKNu7g7ZDuaO/PLi8ZafJzs07P1SkVPRU+lQ27tLdtWHX+G7R7ht7vPY07NXbW7z3/T7JvttVAVVN1WbVZftJ+7P3P66Jqun4lvttXa1ObXHtxwPSA/0HIw6217nU1R3SPVRSj9Yr60cOxx++/p3vdy0NNg1VjZzG4iNwRHnk6fcJ3/ceDTradox7rOEH0x92HWcdL2pCmvKaRptTmvtbYlu6T8w+0dbq3nr8R9sfD5w0PFl5SvNUyWna6YLTk2fyz4ydlZ19fi753GDborZ752PO32oPb++6EHTh0kX/i+c7vDvOXPK4dPKy2+UTV7hXmq86X23qdOo8/pPTT8e7nLuarrlca7nuer21e2b36RueN87d9L158Rb/1tWeOT3dvfN6b/fF9/XfFt1+cif9zsu72Xcn7q28T7xf9EDtQdlD3YfVP1v+3Njv3H9qwHeg89HcR/cGhYPP/pH1jw9DBY+Zj8uGDYbrnjg+OTniP3L96fynQ89kzyaeF/6i/suuFxYvfvjV69fO0ZjRoZfyl5O/bXyl/erA6xmv28bCxh6+yXgzMV70VvvtwXfcdx3vo98PT+R8IH8o/2j5sfVT0Kf7kxmTk/8EA5jz/GMzLdsAAAAgY0hSTQAAeiUAAICDAAD5/wAAgOkAAHUwAADqYAAAOpgAABdvkl/FRgAAAp1JREFUSMd9lcmSEzEQRCtflnqxYZgIThBDAP//kXDQ0pJtuDhqycxWZ5fKERFCERARIAVEyCjCtSFFEjWVa9q7OdJE0oiidIhKhRBROlhloiGVhaYERQHJWFEwMpYKrjUlibI2cqSJIJEpKNmM2c3GkRTOJDnThTMpnMWu0VFszs3Jfbe5bza3w+a229yOIs6zmP3czfn1K2w/for8+EVU15pNmmyqkeJyclinXNJRu1xrUaJmjmdzJiejVNt7zZVBRAIq1RwrsrrWnez+SR7WmQQP/1itKz2q/pmzuJtYnNy2bth9x9z2NLfDcB7FHOcGx6ebOb9/iPzxG/ztg4iorglFiKjzF9HSNphCoRb1OY3RZQJrYgRdT68bmgXGDdBzrTG8qNS7QP/m19ef7tGlcoH7vESYkK70uoPuOLEetz0IqeGoWQW6MlB/j36EnipYGKPWwDRg/RkNhXCNJIzAhMk6PrDePJNII6JHqM5VWqYApCtNFPe0GFFGtOWopWCrEVBSoiQi06KkRRaD08IlxXa/ifz8Jvz2LvjyLnh7F/r8Rei8a8xfjNkIrpmMOQ1C02COrkTEHxGhh+6DQJfXc/eZprXxcIyVIf1LJVgWvKaHvwI/1aQxtv851SQ/nqGXL6MHFVY3nmhLyqKsWO/+qzWif+yS1TpNKq8NezjGPCV69ciZoQj1PwfN6QRpWyCGVMe1D/AAHt3/gefu1Ign3AVpjOiNXkN90JlpL6TUnzFEUU+Jvks0tkp/dY3Fy1TzI24BWwsYJPyg11Q0FqDwK72xIz2kLojbeuxS1FpgtfNWyMX1gFw0j3W7RNeSHTVEe3VaV7SdCzVywFaEt02w7QH7Eeg4AvZDNdJ+Cu1HENsutO+Byi6ilEBZ9BeCNBJceJIjHgAAAABJRU5ErkJggg==":er,{signal:this._readyController.signal}).then((i=>{this._texture=new q.r(t,{pixelFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9729,flipped:!0},i),e.requestRender(),this._readyController=null,this._readyResolver.resolve()})).catch((e=>{(0,h.g)(e)||Or.error("Unable to initialize simple atmosphere: image request failed",e),this._readyResolver.reject()}))}uninitializeRenderContext(){this.destroy()}destroy(){this._readyResolver.reject(),this._cameraChangeHandle&&(this._cameraChangeHandle.remove(),this._cameraChangeHandle=null),this._texture&&(this._texture.dispose(),this._texture=null),this._fadeVao&&(this._fadeVao.dispose(),this._fadeVao=null),this._vao&&(this._vao.dispose(),this._vao=null),this._readyController&&(this._readyController.abort(),this._readyController=null)}render(e){if(e.slot!==this.slot||0!==e.pass)return!1;this._update(e.camera);const t=e.rctx;if(this._atmosphereConeTechnique.bindPipelineState(t),this._renderData.undergroundFadeAlpha<1){const i=this._atmosphereConeTechnique.program;t.useProgram(i),i.setUniformMatrix4fv("proj",e.camera.projectionMatrix),i.setUniformMatrix4fv("view",e.camera.viewMatrix),i.setUniform3fv("silCircleCenter",this._renderData.silCircleCenter),i.setUniform3fv("silCircleV1",this._renderData.silCircleV1),i.setUniform3fv("silCircleV2",this._renderData.silCircleV2),i.setUniform2fv("texV",this._renderData.texV),i.bindTexture(this._texture,"tex"),e.scenelightingData.setLightDirectionUniform(i),i.setUniform1f("altitudeFade",this._renderData.altitudeFade),i.setUniform1f("innerScale",this._renderData.innerScale),t.bindVAO(this._vao),t.drawArrays(4,0,this._vaoCount)}if(this._renderData.undergroundFadeAlpha>0){const i=this._atmosphereUndergroundTechnique.program;t.useProgram(i),i.setUniform1f("undergroundFadeAlpha",this._renderData.undergroundFadeAlpha),e.scenelightingData.setLightDirectionUniform(i),i.setUniform3fv("cameraPosition",e.camera.eye),t.bindVAO(this._fadeVao),t.drawArrays(5,0,this._fadeVaoCount)}return!0}_update(e){const t=(0,v.n)(),i=this.planetRadius,r=(0,v.s)(e.eye),s=r-i;if(s<0){const e=Math.min(-s/5e3,1);this._renderData.undergroundFadeAlpha=e}else this._renderData.undergroundFadeAlpha=0;const n=Math.max(50,s),a=i+Dr;this._renderData.innerScale=function(e,t,i){return e*e/(Math.sqrt(e*e-t*t)*Math.sqrt(e*e-i*i)+t*i)}(i+n,i,a)-1,this._renderData.altitudeFade=pr(s),(0,v.d)(t,e.eye,(i+50)/r),Ir(t,e.center,e.up,i,this._renderData);const o=this._computeScreenRimWidth(e,t,e.up,this._renderData),l=1-511/512,c=Er(s);let h=this.texV0+l*this.texVScale,d=this.texV0+o*c*this.texVScale;if(s>50){Ir(e.eye,e.center,e.up,i,this._renderData);const t=this._computeScreenRimWidth(e,e.eye,e.up,this._renderData),r=(0,v.o)((t-1.5)/(o-1.5),0,1);h=this.texV0+r*l*this.texVScale,d=this.texV0+(0,v.C)(this.texV1,o*c,r)*this.texVScale}(0,k.r)(this._renderData.texV,h,d)}_createRibbon(e){const t=new Float32Array(1155),i=new Uint32Array(1920);t[0]=0,t[1]=0,t[2]=-1;for(let e=0;e<128;e++){const r=9*e+3;t[r+0]=e,t[r+1]=this.innerRimFactor,t[r+2]=-1,t[r+3]=e,t[r+4]=this.middleRimFactor,t[r+5]=0,t[r+6]=e,t[r+7]=this.outerRimFactor,t[r+8]=1;const s=3*e+1,n=127===e?1:s+3,a=15*e;i[a+0]=s,i[a+1]=s+1,i[a+2]=n+1,i[a+3]=n+1,i[a+4]=n,i[a+5]=s,i[a+6]=s+1,i[a+7]=s+2,i[a+8]=n+2,i[a+9]=n+2,i[a+10]=n+1,i[a+11]=s+1,i[a+12]=s,i[a+13]=n,i[a+14]=0}const r=Ur.createBuffer(i.length),s=r.position;for(let e=0;e<i.length;++e){const r=3*i[e];s.set(e,0,t[r]),s.set(e,1,t[r+1]),s.set(e,2,t[r+2])}return new V.f(e,S.o,{geometry:(0,U.t)(Ur)},{geometry:V.h.createVertex(e,35044,r.buffer)})}_computeScreenRimWidth(e,t,i,r){return(0,v.u)(Fr,r.silCircleCenter,r.silCircleV2),(0,v.d)(Vr,Fr,this.outerRimFactor),(0,C.F)(Lr,t,Fr,i),(0,S.v)(Fr,Lr,e.projectionMatrix,e.viewport),(0,S.v)(Vr,Lr,e.projectionMatrix,e.viewport),(0,v.q)(Fr,Vr)/e.height}}function Ir(e,t,i,r,s){const n=(0,v.s)(e),a=r*Math.sqrt(n*n-r*r)/n,o=Math.sqrt(r*r-a*a),l=s.silCircleV1,c=s.silCircleV2;return(0,v.d)(s.silCircleCenter,e,o/n),(0,v._)(l,e,t),(0,v.m)(l)<1&&(0,v._)(l,e,i),(0,v.d)(l,l,a/(0,v.s)(l)),(0,v._)(c,l,e),(0,v.d)(c,c,a/(0,v.s)(c)),a}const Lr=(0,T.e)(),Fr=(0,v.n)(),Vr=(0,v.n)(),Ur=(0,G.A)().vec3f("position");function Gr(e){const t=S.t`vec4 alignToPixelCenter(vec4 clipCoord, vec2 widthHeight) {
vec2 xy = vec2(0.500123) + 0.5 * clipCoord.xy / clipCoord.w;
vec2 pixelSz = vec2(1.0) / widthHeight;
vec2 ij = (floor(xy * widthHeight) + vec2(0.5)) * pixelSz;
vec2 result = (ij * 2.0 - vec2(1.0)) * clipCoord.w;
return vec4(result, clipCoord.zw);
}`,i=S.t`vec4 alignToPixelOrigin(vec4 clipCoord, vec2 widthHeight) {
vec2 xy = vec2(0.5) + 0.5 * clipCoord.xy / clipCoord.w;
vec2 pixelSz = vec2(1.0) / widthHeight;
vec2 ij = floor((xy + 0.5 * pixelSz) * widthHeight) * pixelSz;
vec2 result = (ij * 2.0 - vec2(1.0)) * clipCoord.w;
return vec4(result, clipCoord.zw);
}`;e.vertex.code.add(t),e.vertex.code.add(i),e.fragment.code.add(t),e.fragment.code.add(i)}function Br(){const e=new S.n;return e.attributes.add("position","vec3"),e.attributes.add("color","vec4"),e.attributes.add("size","float"),e.varyings.add("vcolor","vec4"),e.varyings.add("vsize","float"),e.vertex.uniforms.add("transform","mat4").add("viewport","vec4").add("pixelRatio","float"),e.include(Gr),e.vertex.code.add(S.t`void main(void) {
vec4 posProj = transform * vec4(position, 0);
gl_Position = alignToPixelCenter(posProj, viewport.zw);
vcolor = color / 1.2;
vsize = size * 5.0 * pixelRatio;
gl_PointSize = vsize;
}`),e.fragment.code.add(S.t`void main() {
float cap = 0.7;
float scale = 1.0 / cap;
float helper = clamp(length(abs(gl_PointCoord - vec2(0.5))), 0.0, cap);
float alpha = clamp((cap - helper) * scale, 0.0, 1.0);
float intensity = alpha * alpha * alpha;
if (vsize < 3.0) {
intensity *= 0.5;
}
gl_FragColor = vec4(vcolor.xyz, intensity);
}`),e}var qr=Object.freeze({__proto__:null,build:Br});class kr extends S.c{initializeProgram(e){const t=kr.shader.get().build();return new S.d(e.rctx,t,S.o)}initializePipeline(){return(0,V.g)({blending:(0,V.e)(770,1,771,771),depthTest:{func:515},colorWrite:V.r})}bindPass({camera:e,modelMatrix:t}){const i=this.makeInfiniteProjectionMatrix(e.projectionMatrix,e.near,Nr);(0,C.e)(i,i,e.viewMatrix),(0,C.e)(i,i,t),this.program.setUniformMatrix4fv("transform",i),this.program.setUniform4fv("viewport",e.fullViewport),this.program.setUniform1f("pixelRatio",e.pixelRatio)}makeInfiniteProjectionMatrix(e,t,i){const r=24e-8;return(0,C.n)(i,e),i[10]=r-1,i[11]=-1,i[14]=(r-2)*t,i}}kr.shader=new S.f(qr,(()=>i.e(7529).then(i.bind(i,17529))));const Nr=(0,T.e)(),jr=u.n.getLogger("esri.views.3d.environment.Stars");let Hr=class extends r.p{constructor(e){super(e),this.slot=14,this._loadDataTask=null,this._numPoints=0,this._modelMatrix=(0,T.e)(),this._updatingTracking=new W.l,this._requestRender=()=>{}}get updating(){return this._updatingTracking.updating||this.loading}get loading(){return(0,u.r)(this._loadDataTask)&&!this._loadDataTask.finished}get canRender(){return!this.loading}initialize(){this._loadDataTask=this._createLoadDataTask()}destroy(){this._loadDataTask=(0,u.B)(this._loadDataTask),this._updatingTracking.destroy(),this._numPoints=0,this._technique=(0,u.z)(this._technique),this._vao=(0,u.z)(this._vao),this._requestRender=null}initializeRenderContext(e){this._requestRender=e.requestRender}uninitializeRenderContext(){this.destroy()}render(e){if(e.slot!==this.slot||0!==e.pass)return!1;if(this._ensureResources(e),(0,u.t)(this._technique)||(0,u.t)(this._vao))return!0;const t=e.rctx,i=this._technique.program;return t.useProgram(i),this._technique.bindPass({camera:e.camera,modelMatrix:this._modelMatrix}),this._technique.bindPipelineState(t),t.bindVAO(this._vao),i.assertCompatibleVertexAttributeLocations(this._vao),t.drawArrays(0,0,this._numPoints),!0}_ensureResources(e){if((0,u.r)(this._technique)||(0,u.t)($r))return;const t=e.rctx;this._technique=new kr({rctx:t,viewingMode:this.view.state.viewingMode},null),this._numPoints=$r.byteLength/Yr;const i=new Float32Array($r,0,2*this._numPoints),r=new Uint8Array($r,2*this._numPoints*4,this._numPoints);this._vao=this._createVertexArrayObject(e.rctx,i,r,this._numPoints),this._updatingTracking.add(this.view,"environment.lighting.date",(e=>this._update(e)),2)}_computeDayDuration(e){const t=e,i=new Date(e.getFullYear(),0,1,11,58,56);return(+t-+i)/(+new Date(e.getFullYear()+1,0,1,11,58,55)-+i)}_update(e){if(!e)return;const t=(e.getHours()/12+e.getMinutes()/60*(2/24)+e.getSeconds()/60*(2/1440)-.9972222)%2,i=2*this._computeDayDuration(e),r=this._modelMatrix;(0,C.n)(r,Zr),(0,C.m)(r,r,-i*Math.PI),(0,C.e)(r,Qr,r),(0,C.m)(r,r,-t*Math.PI),this._requestRender()}_hexToRGB(e){return[parseInt(e.substring(0,2),16),parseInt(e.substring(2,4),16),parseInt(e.substring(4,6),16)]}_unpackUint8Attributes(e){return e>=192?[2.9,e-192]:e>=160?[2.5,e-160]:e>=128?[2,e-128]:e>=96?[1.5,e-96]:e>=64?[1,e-64]:e>=32?[.7,e-32]:[.4,e]}_createVertexArrayObject(e,t,i,r){const s=Xr.createBuffer(r),n=s.position,a=s.color,o=s.size;for(let e=0;e<r;e++){const r=t[2*e+0],s=t[2*e+1];n.set(e,0,-Math.cos(r)*Math.sin(s)),n.set(e,1,-Math.sin(r)*Math.sin(s)),n.set(e,2,-Math.cos(s));const l=this._unpackUint8Attributes(i[e]),c=this._hexToRGB(Wr[l[1]]);a.set(e,0,255*c[0]),a.set(e,1,255*c[1]),a.set(e,2,255*c[2]),a.set(e,3,255),o.set(e,l[0])}return new V.f(e,S.o,{geometry:(0,U.t)(Xr)},{geometry:V.h.createVertex(e,35044,s.buffer)})}_createLoadDataTask(){if((0,u.r)($r))return null;const e=(0,h.G)((async e=>{const{data:t}=await(0,H.n)("esri/views/3d/environment/resources/stars.wsv",{responseType:"array-buffer",signal:e});this._verifyStarData(t),$r=t}));return e.promise.catch((e=>{(0,h.g)(e)||jr.error(e)})).then((()=>{this.destroyed||(this._requestRender(),this.notifyChange("updating"))})),e}_verifyStarData(e){if(!e)throw new h.s("stars:no-data-received","Failed to create stars because star catalogue is missing");const t=e.byteLength/Yr;if(t%1!=0||t>5e4||t<5e3)throw new h.s("stars:invalid-data","Failed to create stars because star catalogue data is invalid")}};(0,r.e)([(0,d.y)({constructOnly:!0})],Hr.prototype,"view",void 0),(0,r.e)([(0,d.y)({readOnly:!0})],Hr.prototype,"updating",null),(0,r.e)([(0,d.y)()],Hr.prototype,"_loadDataTask",void 0),(0,r.e)([(0,d.y)()],Hr.prototype,"_updatingTracking",void 0),Hr=(0,r.e)([(0,d.n)("esri.views.3d.environment.Stars")],Hr);const Wr=["9bb2ff","9eb5ff","aabfff","bbccff","ccd8ff ","dae2ff","e4e9ff","eeefff","f8f6ff","fff9fb","fff5ef","fff1e5","ffeddb","ffe9d2","ffe6ca","ffe3c3","ffe0bb","ffddb4","ffdaad","ffd6a5","ffd29c","ffcc8f","ffc178","ffa94b","ff7b00"],Qr=(0,T.n)(1,0,0,0,0,.9174771405229186,.39778850739794974,0,0,-.39778850739794974,.9174771405229186,0,0,0,0,1),Zr=(0,T.n)(1,0,0,0,0,.9174771405229186,-.39778850739794974,0,0,.39778850739794974,.9174771405229186,0,0,0,0,1),Yr=9,Xr=(0,G.A)().vec3f("position").vec4u8("color").f32("size");let $r=null;const Kr=[14,15];let Jr=class extends r.p{constructor(){super(...arguments),this._handles=new R.u,this._context=null,this._pendingAtmosphere=null,this._atmosphere=null,this._stars=null}get canRender(){return!(!this.view.basemapTerrain||!this.view.basemapTerrain.renderer.canRender)||"global"!==this.view.viewingMode}get updating(){return(0,u.r)(this._pendingAtmosphere)||(0,u.r)(this._stars)&&this._stars.updating}initialize(){this.view._stage.addRenderPlugin(Kr,this)}destroy(){this._pendingAtmosphere=(0,u.k)(this._pendingAtmosphere),this._atmosphere=(0,u.k)(this._atmosphere),this._stars=(0,u.k)(this._stars),this._handles=(0,u.k)(this._handles),this.view&&null!=this.view._stage&&(this.view._stage.removeRenderPlugin(this),this._set("view",null))}initializeRenderContext(e){this._context=e,this.setup()}setup(){this._handles.add((0,p.y)(this.view,"basemapTerrain",(()=>this._updateBasemapTerrain()),!0)),this._handles.add([(0,p.d)(this.view,["viewingMode","environment.atmosphereEnabled","environment.atmosphere.quality"],(()=>this._updateAtmosphere()),!0),(0,p.d)(this.view,"environment.starsEnabled",(()=>this._updateStars()),!0)])}uninitializeRenderContext(){(0,u.r)(this._stars)&&(this._stars.uninitializeRenderContext(),this._stars.destroy(),this._stars=null),(0,u.r)(this._atmosphere)&&(this._atmosphere.uninitializeRenderContext(),this._atmosphere.destroy(),this._atmosphere=null)}render(e){let t=!0;return(0,u.r)(this._stars)&&this._stars.canRender&&(t=this._stars.render(e)&&t),(0,u.r)(this._atmosphere)&&this._atmosphere.canRender&&(t=this._atmosphere.render(e)&&t),t}_setNeedsRender(){this._context&&this._context.requestRender()}_updateStars(){var e,t,i;const r=null!=(e=null==(t=this.view)||null==(i=t.environment)?void 0:i.starsEnabled)&&e;r&&(0,u.t)(this._stars)?(this._stars=new Hr({view:this.view}),this._stars.initializeRenderContext(this._context),this._setNeedsRender()):!r&&(0,u.r)(this._stars)&&(this._stars.destroy(),this._stars=null,this._setNeedsRender())}_updateAtmosphere(){const e=this._getAtmosphereType();if(this.atmosphereType===e)return;this.atmosphereType=e,(0,u.r)(this._pendingAtmosphere)&&(this._pendingAtmosphere!==this._atmosphere&&this._pendingAtmosphere.destroy(),this._pendingAtmosphere=null);const t=this._getAtmosphereClass();if(!t)return(0,u.r)(this._atmosphere)&&(this._atmosphere.destroy(),this._atmosphere=null,this._setNeedsRender()),void this._updateBasemapTerrain();const i=new t(this.view);i.initializeRenderContext(this._context),(0,u.t)(this._atmosphere)&&(this._atmosphere=i,this._setNeedsRender()),this._pendingAtmosphere=i,i.when().then((()=>{(0,u.r)(this._atmosphere)&&this._pendingAtmosphere!==this._atmosphere&&(this._atmosphere.destroy(),this._atmosphere=this._pendingAtmosphere),this._pendingAtmosphere=null,this._setNeedsRender(),this._updateBasemapTerrain()})).catch((()=>{this._pendingAtmosphere===i&&(this._pendingAtmosphere=null)}))}_getAtmosphereClass(){const e=this._getAtmosphereType();if(this.atmosphereClassFromType)return this.atmosphereClassFromType(e);switch(e){case"none":return null;case"realistic":return yr;case"panoramic":return hr;case"simple":return zr;default:return}}_getAtmosphereType(){const e=this.view.get("environment.atmosphereEnabled"),t=this.view.get("environment.atmosphere.quality"),i=this.view.viewingMode;return!e||null==t||(0,O.P)(this.view.spatialReference)?"none":"local"===i?"panoramic":"high"===t&&yr.isSupported(this._context)&&!(0,O.a)(this.view.spatialReference)?"realistic":"simple"}_updateBasemapTerrain(){const e=this.view.basemapTerrain;e&&(e.velvetOverground=null!=this._atmosphere&&"simple"===this.atmosphereType)}get test(){return{atmosphere:this._atmosphere}}};(0,r.e)([(0,d.y)({constructOnly:!0})],Jr.prototype,"view",void 0),(0,r.e)([(0,d.y)({constructOnly:!0})],Jr.prototype,"atmosphereClassFromType",void 0),(0,r.e)([(0,d.y)()],Jr.prototype,"updating",null),(0,r.e)([(0,d.y)()],Jr.prototype,"_pendingAtmosphere",void 0),(0,r.e)([(0,d.y)()],Jr.prototype,"_stars",void 0),Jr=(0,r.e)([(0,d.n)("esri.views.3d.environment.EnvironmentRenderer")],Jr);var es=Jr;function ts(e,t,i){return function(e,t,i,r,s){const n=(0,v.g)(i),a=(0,v.g)(s),o=n-a,l=(0,v.g)(t)-(0,v.g)(r),c=Math.sin(o/2),h=Math.sin(l/2),d=2*(0,v.p)(Math.sqrt(c*c+Math.cos(n)*Math.cos(a)*h*h))*e;return Math.round(1e4*d)/1e4}(e,t.longitude,t.latitude,i.longitude,i.latitude)}function is(e,t){t||(t={hours:0,minutes:0,seconds:0}),t.hours=function(e,t){let i=e/15;return i}(e[0]);const i=t.hours%1;t.hours-=i,t.minutes=60*i;const r=t.minutes%1;return t.minutes-=r,t.seconds=Math.round(60*r),t}var rs,ss,ns={exports:{}};rs=ns,void 0!==(ss=function(){var e=Math.PI,t=Math.sin,i=Math.cos,r=Math.tan,s=Math.asin,n=Math.atan2,a=Math.acos,o=e/180,l=864e5,c=2440588,h=2451545,d={dec:0,ra:0};function u(e){return new Date((e+.5-c)*l)}function p(e){return function(e){return e.valueOf()/l-.5+c}(e)-h}var m=23.4397*o;function f(e,s){return n(t(e)*i(m)-r(s)*t(m),i(e))}function g(e,r){return s(t(r)*i(m)+i(r)*t(m)*t(e))}function v(e,s,a){return n(t(e),i(e)*t(s)-r(a)*i(s))}function y(e,r,n){return s(t(r)*t(n)+i(r)*i(n)*i(e))}function _(e,t){return o*(280.16+360.9856235*e)-t}function x(e){return o*(357.5291+.98560028*e)}function b(e){return o*(1.9148*t(e)+.02*t(2*e)+3e-4*t(3*e))}function w(t,i){return t+i+102.9372*o+e}function C(e,t){var i=x(e),r=w(i,b(i));return t||(t={dec:0,ra:0}),t.dec=g(r,0),t.ra=f(r,0),t}var T={POLAR_EXCEPTION:{NORMAL:0,MIDNIGHT_SUN:1,POLAR_NIGHT:2},getPosition:function(e,t,i,r){var s=o*-i,n=o*t,a=p(e),l=C(a,d),c=_(a,s)-l.ra;return r||(r={azimuth:0,altitude:0}),r.azimuth=v(c,n,l.dec),r.altitude=y(c,n,l.dec),r}},S=[[-.83,"sunrise","sunset"]];T.addTime=function(e,t,i){S.push([e,t,i])};var P=9e-4;function R(t,i){return Math.round(t-P-i/(2*e))}function A(t,i,r){return P+(t+i)/(2*e)+r}function M(e,i,r){return h+e+.0053*t(i)-.0069*t(2*r)}function O(e,r,s){return a((t(e)-t(r)*t(s))/(i(r)*i(s)))}function D(e){var r=o*(134.963+13.064993*e),s=o*(93.272+13.22935*e),n=o*(218.316+13.176396*e)+6.289*o*t(r),a=5.128*o*t(s),l=385001-20905*i(r);return{ra:f(n,a),dec:g(n,a),dist:l}}return T.getTimes=function(e,r,s){var n=o*-s,a=o*r,l=R(p(e),n),c=A(0,n,l),h=x(c),d=b(h),m=w(h,d),f=g(m,0),v=M(c,h,m);function y(e){return M(A(O(e,a,f),n,l),h,m)}var _,C,P,D,E,z={solarNoon:u(v),nadir:u(v-.5),polarException:T.POLAR_EXCEPTION.NORMAL};for(_=0,C=S.length;_<C;_+=1)E=v-((D=y((P=S[_])[0]*o))-v),z[P[1]]=u(E),z[P[2]]=u(D);return z.polarException=function(e){var r=(t(e)-t(a)*t(f))/(i(a)*i(f));return r<-1?T.POLAR_EXCEPTION.MIDNIGHT_SUN:r>1?T.POLAR_EXCEPTION.POLAR_NIGHT:T.POLAR_EXCEPTION.NORMAL}(S[0][0]*o),z},T.getMoonPosition=function(e,t,i){var s=o*-i,n=o*t,a=p(e),l=D(a),c=_(a,s)-l.ra,h=y(c,n,l.dec);return h+=.017*o/r(h+10.26*o/(h+5.1*o)),{azimuth:v(c,n,l.dec),altitude:h,distance:l.dist}},T.getMoonFraction=function(e){var r=p(e),s=C(r),o=D(r),l=149598e3,c=a(t(s.dec)*t(o.dec)+i(s.dec)*i(o.dec)*i(s.ra-o.ra)),h=n(l*t(c),o.dist-l*i(c));return(1+i(h))/2},T}())&&(rs.exports=ss);var as=ns.exports;const os={local:{altitude:1500,ambientAtNight:.1,ambientAtNoon:.45,ambientAtTwilight:.2,diffuseAtNoon:.65,diffuseAtTwilight:.7},global:{altitude:8e5,ambient:.015,diffuse:.75},planarDirection:{localAltitude:1e4,globalAltitude:1e6,globalAngles:{azimuth:1.3*Math.PI,altitude:.6*Math.PI}}};const ls=(0,T.e)(),cs={azimuth:0,altitude:0},hs={ambient:{color:(0,v.n)(),intensity:0},diffuse:{color:(0,v.n)(),intensity:0,directionToLightSource:(0,v.n)()},globalFactor:0,noonFactor:0};function ds(e,t,i,r){const s=[];for(let n=0;n<i.length;n++)s[n]=(r[n]-i[n])*e/t+i[n];return s}class us{constructor(e=(0,v.n)()){this.intensity=e}}class ps{constructor(e=(0,v.n)(),t=(0,v.i)(.57735,.57735,.57735)){this.intensity=e,this.direction=t}}class ms{constructor(e=(0,v.n)(),t=(0,v.i)(.57735,.57735,.57735),i=!0){this.intensity=e,this.direction=t,this.castShadows=i}}class fs{constructor(){this.r=[0],this.g=[0],this.b=[0]}}const gs=(0,v.i)(.5773502691896258,-.5773502691896258,.5773502691896258);let vs=class extends n.n.EventedAccessor{constructor(...e){super(...e),this._referencePointUpdateDelay=200,this._referencePointUpdateInterval=3e3,this._referencePointUpdateDistThreshold=1e6,this._referencePosUpdateQuery=null,this._referencePosMapCoordsRequested=null,this._viewHandles=new R.u,this._preserveAbsoluteDateTime=!1,this._trackingEnabled=!1,this._referencePosResetPreserveAbsoluteTime=!1,this.referencePosUpdateTimer=null,this._referencePosMapCoords=null,this._mainLight=new ms,this._ambientLight=new us,this._moonLight=new ps,this._renderer=null,this._referencePosWGS84Comparable=null,this._resetReferencePosition()}destroy(){this.disconnectView(),this._viewHandles.destroy()}get updating(){return!!(!this.disableQueries&&(this._referencePosUpdateQuery||this._referencePosMapCoordsRequested)||this._renderer&&this._renderer.updating)}get referencePositionWGS84Comparable(){return this._referencePosWGS84Comparable}connectView(e){this._renderer||(this._view=e,this._renderer=new es({view:e}),this._viewHandles.add([e.watch("environment.lighting.date",(e=>this._lightingDateHandler(e)),!0),e.watch("stationary",(()=>this._interactingStationaryHandler())),e.watch(["environment.lighting.directShadowsEnabled","environment.lighting.ambientOcclusionEnabled","environment.lighting.waterReflectionEnabled","environment.background.color"],(()=>this._updateRenderParamsHandler()),!0),e.watch("spatialReference",(()=>this._resetReferencePosition(!0)),!0),(0,p.d)(e,"viewingMode",(()=>this._resetReferencePosition(!0)),!0),(0,p.d)(e,"environment.lighting.cameraTrackingEnabled",(e=>this._updateCameraTracking(e)),!0),(0,p.d)(e,"state.camera",(()=>this._cameraHandler(null)),!0),this.watch("disableQueries",(()=>this._cameraHandler(null)))]),this._updateRenderParamsHandler(),this._updateLightParams(),this._cameraHandler(),this.notifyChange("updating"))}disconnectView(){this._renderer&&(this._viewHandles.removeAll(),this._resetReferencePosition(),this._renderer.destroy(),this._renderer=null,this._view=null)}_updateCameraTracking(e){if(this._trackingEnabled=e,e)this._cameraHandler();else{const e=this._view.environment.lighting;e&&(e.positionTimezoneInfo.autoUpdated=!1)}}_lightingDateHandler(e){if(!e)return;const t=this._view.environment.lighting;if(!t.positionTimezoneInfo.autoUpdated){this._preserveAbsoluteDateTime=!0;const i=this._view.spatialReference;if(!(0,_.Z)(i)){const e=this._view.camera.position;if(!this._referencePosMapCoords||!this._referencePosMapCoords.equals(e))return void this._requestReferencePositionUpdate(e)}if(this._preupdateTracking(e),(0,u.r)(this._referencePosWGS84Comparable)){const e=is(this._referencePosWGS84Comparable,_s);(0,u.r)(e)&&(t.autoUpdate(null,e),this._trackingEnabled&&(t.positionTimezoneInfo.autoUpdated=!0))}}this._updateLightParams(e)}_preupdateTracking(e){!this._trackingEnabled&&this._view.environment.lighting.cameraTrackingEnabled&&this._cameraHandler(e)}_cameraHandler(e=null){if(!this._view.ready)return;const t=this._view.camera;t&&(this._cameraHandlerClientSide(t,e)||this._cameraHandlerServerSide(t))}_cameraHandlerClientSide(e,t){const i=(0,O.o)(this._view.spatialReference);if(i&&!(0,_.Z)(this._view.spatialReference))return!1;const r=e.position;return(0,u.t)(this._referencePosWGS84Comparable)&&(this._referencePosWGS84Comparable=(0,v.n)()),i?(0,_.y)(r,this._referencePosWGS84Comparable):(0,v.a)(this._referencePosWGS84Comparable,r.longitude,r.latitude,r.z),this.notifyChange("referencePositionWGS84Comparable"),this._autoUpdateTimezone(this._referencePosWGS84Comparable,t)||this._updateLightParams(t),!0}_cameraHandlerServerSide(e){const t=e.position;(!this._referencePosMapCoords||this._referencePosMapCoordsRequested||this._exceedsReferencePosDistThreshold(t))&&this._requestReferencePositionUpdate(t,!0),this._view.mapCoordsHelper&&this._referencePosWGS84Comparable&&(this._referencePosWGS84Comparable[2]=t.z*this._view.mapCoordsHelper.unitInMeters,this._referencePosChanged())}_interactingStationaryHandler(){this._view.stationary&&this._executePendingReferencePositionUpdate()}_updateLightParams(e){const t=this._view.environment.lighting;e=e||t.date;const i=this._view._stage;let r;(0,u.r)(this._referencePosWGS84Comparable)?(r=function(e,t){const i=t[2],r=hs;(0,v.a)(r.ambient.color,1,1,1),r.ambient.intensity=os.global.ambient,(0,v.a)(r.diffuse.color,1,1,1),r.diffuse.intensity=os.global.diffuse;let s=(Math.abs(i)-os.local.altitude)/(os.global.altitude-os.local.altitude);s=(0,v.o)(s,0,1),r.globalFactor=s;const n=as.getTimes(e,t[1],t[0]);if(s<1){const t=function(e,t){const i=e.valueOf();let r,s;t.polarException===as.POLAR_EXCEPTION.MIDNIGHT_SUN?(r=i-60*(e.getHours()+48)*60*1e3-60*e.getMinutes()*1e3,s=r+432e6):t.polarException===as.POLAR_EXCEPTION.POLAR_NIGHT?(r=i-2,s=i-1):(r=t.sunrise.valueOf(),s=t.sunset.valueOf());const n=s-r,a=r+n/2,o=n/4,l=a-o,c=a+o,h=.06*n,d=r-h/2,u=r+h/2,p=s-h/2,m=s+h/2,f=os.local,g=[.01,f.ambientAtNight],y=[.8,.8,1],_=[.01,.01,.01],x=[f.diffuseAtTwilight,f.ambientAtTwilight],b=[1,.75,.75],w=[.8,.8,1],C=[.9*f.diffuseAtNoon,f.ambientAtNoon],T=[1,.98,.98],S=[.98,.98,1],P=[f.diffuseAtNoon,f.ambientAtNoon],R=[1,1,1],A=[1,1,1],M=C,O=T,D=S,E=x,z=b,I=w;let L,F,V=[0,0],U=[0,0,0],G=[0,0,0];return i<d||i>m?(V=g,U=_,G=y,F="night"):i<u?(L=u-d,V=ds(i-d,L,g,x),U=ds(i-d,L,_,b),G=ds(i-d,L,y,w),F="sun rising"):i<l?(L=l-u,V=ds(i-u,L,x,C),U=ds(i-u,L,b,T),G=ds(i-u,L,w,S),F="early morning"):i<a?(L=a-l,V=ds(i-l,L,C,P),U=ds(i-l,L,T,R),G=ds(i-l,L,S,A),F="late morning"):i<c?(L=c-a,V=ds(i-a,L,P,M),U=ds(i-a,L,R,O),G=ds(i-a,L,A,D),F="early afternoon"):i<p?(L=p-c,V=ds(i-c,L,M,E),U=ds(i-c,L,O,z),G=ds(i-c,L,D,I),F="late afternoon"):i<m&&(L=m-p,V=ds(i-p,L,E,g),U=ds(i-p,L,z,_),G=ds(i-p,L,I,y),F="sun setting"),{diffuse:{intensity:V[0],color:(0,v.i)(U[0],U[1],U[2])},ambient:{intensity:V[1],color:(0,v.i)(G[0],G[1],G[2])},timeOfDay:F}}(e,n);(0,v.y)(r.ambient.color,t.ambient.color,r.ambient.color,s),r.ambient.intensity=(0,v.C)(t.ambient.intensity,r.ambient.intensity,s),(0,v.y)(r.diffuse.color,t.diffuse.color,r.diffuse.color,s),r.diffuse.intensity=(0,v.C)(t.diffuse.intensity,r.diffuse.intensity,s)}return r.noonFactor=function(e,t){const i=e.valueOf();let r,s;t.polarException===as.POLAR_EXCEPTION.MIDNIGHT_SUN?(r=i-60*(e.getHours()+48)*60*1e3-60*e.getMinutes()*1e3,s=r+432e6):t.polarException===as.POLAR_EXCEPTION.POLAR_NIGHT?(r=i-2,s=i-1):(r=t.sunrise.valueOf(),s=t.sunset.valueOf());const n=r+(s-r)/2;return 1-(0,v.o)(Math.abs(i-n)/432e5,0,1)}(e,n),r}(e,this._referencePosWGS84Comparable),function(e,t,i,r){r||(r=(0,v.n)());const s=cs,n=(0,C.r)(ls);if("global"===i)as.getPosition(e,0,0,s),(0,v.a)(r,0,0,-1),(0,C.b)(n,n,-s.azimuth),(0,C.l)(n,n,-s.altitude),(0,v.I)(r,r,n);else{const i=os.planarDirection,a=i.globalAngles,o=t[2];let l=(Math.abs(o)-i.localAltitude)/(i.globalAltitude-i.localAltitude);l=(0,v.o)(l,0,1),l<1?(as.getPosition(e,t[1],t[0],s),s.azimuth=(1-l)*s.azimuth+l*a.azimuth,s.altitude=(1-l)*s.altitude+l*a.altitude):(s.azimuth=a.azimuth,s.altitude=a.altitude),(0,v.a)(r,0,-1,0),(0,C.m)(n,n,-s.azimuth),(0,C.b)(n,n,-s.altitude),(0,v.I)(r,r,n)}}(e,this._referencePosWGS84Comparable,this._view.viewingMode,r.diffuse.directionToLightSource)):r={diffuse:{color:[1,1,1],intensity:.55,directionToLightSource:gs},ambient:{color:[1,1,1],intensity:.55},noonFactor:.5,globalFactor:0},(0,v.d)(this._mainLight.intensity,r.diffuse.color,r.diffuse.intensity*Math.PI),(0,v.h)(this._mainLight.direction,r.diffuse.directionToLightSource),(0,v.d)(this._ambientLight.intensity,r.ambient.color,r.ambient.intensity),(0,v.y)(this._moonLight.intensity,xs,bs,r.globalFactor);const s=(1-.5*r.globalFactor)*(1-.4*r.noonFactor*(1-r.globalFactor));(0,v.d)(this._moonLight.intensity,this._moonLight.intensity,s),(0,v.h)(this._moonLight.direction,r.diffuse.directionToLightSource),i.renderView.updateLightSources([this._mainLight,this._ambientLight,this._moonLight],1-r.noonFactor,r.globalFactor),this._updateRenderParamsHandler()}_autoUpdateTimezone(e,t=null){if(!this._view.environment.lighting.cameraTrackingEnabled||(0,u.t)(e))return!1;const i=ys;i.setTime((t||this._view.environment.lighting.date).getTime());const r=is(e,_s);if((0,u.t)(r))return!1;let s=this._view.environment.lighting.positionTimezoneInfo;if(s.autoUpdated){if(s.hours===r.hours&&s.minutes===r.minutes&&s.seconds===r.seconds)return!1}else s=r;const n=i.getUTCHours()-(r.hours-s.hours),a=i.getUTCMinutes()-(r.minutes-s.minutes),o=i.getUTCSeconds()-(r.seconds-s.seconds);return i.setUTCHours(n),i.setUTCMinutes(a),i.setUTCSeconds(o),!t&&this._view.environment.lighting.autoUpdate(i,r)}_updateRenderParamsHandler(){const e=this._view._stage;if(!e)return;const t=(0,u.v)(this._referencePosWGS84Comparable,!0,(e=>function(e,t){if("global"===t)return!0;{const t=os.planarDirection,i=e[2];return Math.abs(i)<t.localAltitude}}(e,this._view.viewingMode))),i=this._view.environment.background,r=i instanceof Gi?{type:"color",color:(0,w.e)(z.o.toUnitRGBA(i.color))}:{type:"color",color:(0,w.a)(0,0,0,1)};e.renderView.setRenderParameters({shadowMap:this._view.environment.lighting.directShadowsEnabled&&t,ssao:this._view.environment.lighting.ambientOcclusionEnabled,waterReflectionEnabled:this._view.environment.lighting.waterReflectionEnabled,background:r})}_resetReferencePosition(e=!1){this._cancelReferencePosUpdates(),this._referencePosMapCoords=null,this._referencePosMapCoordsRequested=null,this._referencePosResetPreserveAbsoluteTime=null,this._referencePosWGS84Comparable=null,this.notifyChange("updating"),e&&this._cameraHandler(null)}_requestReferencePositionUpdate(e,t=!1){if(!this.disableQueries&&(this._referencePosMapCoordsRequested?this._referencePosMapCoordsRequested.copy(e):this._referencePosMapCoordsRequested=e.clone(),this._referencePosResetPreserveAbsoluteTime=!!t,!this._referencePosUpdateQuery&&!this.referencePosUpdateTimer&&this._view.stationary)){const e=this._referencePosUpdateQuery=(0,h.C)(this._referencePointUpdateDelay).then((()=>{if(this._referencePosUpdateQuery===e){const t=()=>this._referencePosUpdateQuery!==e;return this._doReferencePositionUpdateQuery(t)}})).catch((e=>{"mapcoordshelper:missing-geometry-service"===e.name&&(this.disableQueries=!0)})).then((()=>{this._referencePosUpdateQuery===e&&(this._referencePosUpdateQuery=null,this.referencePosUpdateTimer||this._executePendingReferencePositionUpdate(),this.notifyChange("updating"))})),t=this.referencePosUpdateTimer=(0,h.C)(this._referencePointUpdateInterval).then((()=>{this.referencePosUpdateTimer===t&&(this.referencePosUpdateTimer=null,this._referencePosUpdateQuery||this._executePendingReferencePositionUpdate())}));this.notifyChange("updating")}}async _doReferencePositionUpdateQuery(e){this._referencePosResetPreserveAbsoluteTime&&(this._preserveAbsoluteDateTime=!1),this._referencePosMapCoords?this._referencePosMapCoords.copy(this._referencePosMapCoordsRequested):this._referencePosMapCoords=this._referencePosMapCoordsRequested.clone(),this._referencePosResetPreserveAbsoluteTime=null,this._referencePosMapCoordsRequested=null;const t=await this._view.mapCoordsHelper.toGeographic(this._referencePosMapCoords);if(!e()&&!isNaN(t[0])&&!isNaN(t[1])){const e=this._referencePosMapCoords.z*this._view.mapCoordsHelper.unitInMeters;this._referencePosWGS84Comparable?(this._referencePosWGS84Comparable[0]=t[0],this._referencePosWGS84Comparable[1]=t[1],this._referencePosWGS84Comparable[2]=e):this._referencePosWGS84Comparable=[t[0],t[1],e],this._referencePosChanged()}}_executePendingReferencePositionUpdate(){const e=this._referencePosMapCoordsRequested;e&&this._requestReferencePositionUpdate(e,this._referencePosResetPreserveAbsoluteTime)}_referencePosChanged(){this._preserveAbsoluteDateTime?this._updateLightParams():this._autoUpdateTimezone(this._referencePosWGS84Comparable)||this._updateLightParams(),this.notifyChange("referencePositionWGS84Comparable")}_exceedsReferencePosDistThreshold(e){if(this._referencePosMapCoords){let t=this._referencePosMapCoords.distance(e);return this._view.mapCoordsHelper&&(t*=this._view.mapCoordsHelper.unitInMeters),t>this._referencePointUpdateDistThreshold}return!0}_cancelReferencePosUpdates(){const e=!!this._referencePosUpdateQuery;return this._referencePosUpdateQuery=null,this.referencePosUpdateTimer=null,e}get test(){const e=this;return{renderer:this._renderer,set referencePointUpdateInterval(t){e._referencePointUpdateInterval=t},set referencePointUpdateDistThreshold(t){e._referencePointUpdateDistThreshold=t},set referencePosUpdateTimer(t){e.referencePosUpdateTimer=t},set referencePointUpdateDelay(t){e._referencePointUpdateDelay=t}}}};vs.FIXED_LIGHT_DIRECTION=gs,(0,r.e)([(0,d.y)({type:Boolean,readOnly:!0})],vs.prototype,"updating",null),(0,r.e)([(0,d.y)()],vs.prototype,"disableQueries",void 0),(0,r.e)([(0,d.y)()],vs.prototype,"referencePositionWGS84Comparable",null),(0,r.e)([(0,d.y)()],vs.prototype,"_renderer",void 0),(0,r.e)([(0,d.y)()],vs.prototype,"_referencePosWGS84Comparable",void 0),vs=(0,r.e)([(0,d.n)("esri.views.3d.environment.SceneViewEnvironmentManager")],vs);const ys=new Date,_s={hours:0,minutes:0,seconds:0},xs=(0,v.i)(.22,.22,.33),bs=(0,v.i)(.22,.22,.22);var ws=vs;function Cs(e,t){return 0!=(e&t)}function Ts(e,t,i,r,s,n){0!==e&&(i?(n.min=Math.min(n.min,t),n.max=Math.max(n.max,t)):null!=r?(n.min-=Math.max(0,(t-n.min)*(1-r)),n.max+=Math.max(0,(t-n.max)*(1-r))):s&&(n.min-=Math.max(0,t-n.min-s),n.max+=Math.max(0,t-n.max-s)))}const Ss={selection:0,interactionType:0,interactionFactor:0,interactionStartCamera:null,interactionDirection:null,tiltMode:0};function Ps(e,t,i,r){return t=t||e.viewForward,(0,v.h)(r,t),(0,v.d)(r,r,(0,v.e)((0,v.z)(t,i))),r}function Rs(e,t,i,r){return function(e,t,i,r){r.clip[0]=0,r.clip[1]=i?r.len:Number.MAX_VALUE;for(let i=0;i<e.length;i++)if(!Ms(e[i],t,r))return!1;return!0}(e,t,i,function(e,t,i,r){const s=As;return e?(i&&(s.len=(0,v.q)(t,i)),(0,v.h)(s.dir,e)):(s.len=(0,v.q)(t,i),(0,v.c)(s.dir,i,t),(0,v.d)(s.dir,s.dir,1/s.len)),s}(r,t,i))}const As={dir:(0,v.n)(),len:0,clip:(0,N.n)()};function Ms(e,t,i){const r=(0,v.z)(e,i.dir),s=-it(e,t);if(s<0&&r>=0)return!1;if(r>-1e-6&&r<1e-6)return s>0;if((s<0||r<0)&&!(s<0&&r<0))return!0;const n=s/r;return r>0?n<i.clip[1]&&(i.clip[1]=n):n>i.clip[0]&&(i.clip[0]=n),i.clip[0]<=i.clip[1]}function Os(e,t,i=Ss){if(!function(e,t){const i=e.state.constraints.altitude;return!(!e.state.isGlobal||!i||2===t.interactionType&&Cs(t.selection,1))}(e,i))return 0;const r=function(e,t){return t.min=e.min,t.max=e.max,t}(e.state.constraints.altitude,Ds);!function(e,t,i){const r=t.interactionType;if(0===r)return;const{min:s,max:n}=i,{interactionStartCamera:a,interactionFactor:o}=t,l=2===r||1===r,c=Os(e,a),h=0===c?0:e.renderCoordsHelper.getAltitude(a.eye);i.min=s,i.max=n,Ts(c,h,l,o,.05*h,i)}(e,i,r);const s=e.renderCoordsHelper.getAltitude(t.eye),n=(0,v.o)(s,r.min,r.max)-s;return Math.abs(n)<=1e-6?0:n}const Ds={min:0,max:0},Es=(0,v.n)(),zs=(0,v.n)(),Is=(0,v.n)(),Ls=(0,v.n)();function Fs(e,t,i=Ss){if(!e.state.isLocal)return 0;const r=e.state.constraints.distance;if(!e.pointsOfInterest.surfaceOrigin.renderLocation||r===1/0)return 0;Us.min=0,Us.max=r,function(e,t,i){const r=t.interactionType;if(0===r)return;const{min:s,max:n}=i,{interactionStartCamera:a,interactionFactor:o}=t,l=1===r||4===r,c=Fs(e,a),h=0===c?0:Vs(e,a);i.min=s,i.max=n,Ts(c,h,l,o,.05*h,i)}(e,i,Us);const s=Vs(e,t),n=Us.max-s;return n>=-1e-6?0:n}function Vs(e,t){const i=e.pointsOfInterest.surfaceOrigin;return(0,v.q)(t.eye,i.renderLocation)}const Us={min:0,max:0},Gs=(0,v.n)(),Bs=(0,v.n)(),qs=(0,v.n)(),ks=(0,v.n)(),Ns=(0,v.n)();class js{constructor(){this.verticalOffset=0,this.selectionMode=!1,this.hud=!0,this.selectOpaqueTerrainOnly=!0,this.invisibleTerrain=!1,this.backfacesTerrain=!0,this.isFiltered=!1,this.store=2}}class Hs{constructor(){this._disposed=!1}get disposed(){return this._disposed}get shaderTransformation(){return this._shaderTransformation}acquire(e,t,i,r,s,n){this.id=(0,Q.e)(),this.geometry=e,this.material=t,this.transformation=i,this.instanceParameters=r,this.origin=s,this._shaderTransformation=n,this._disposed=!1}release(){this._disposed=!1}dispose(){this._disposed=!0}getStaticTransformation(){return this.transformation}getShaderTransformation(){return(0,u.r)(this._shaderTransformation)?this._shaderTransformation(this.transformation):this.transformation}computeAttachmentOrigin(e){return!!(this.material.computeAttachmentOrigin?this.material.computeAttachmentOrigin(this.geometry,e):this.geometry.computeAttachmentOrigin(e))&&((0,v.I)(e,e,this.getStaticTransformation()),!0)}}Hs.pool=new r.h(Hs);class Ws{constructor(e){this.channel=e,this.id=(0,Q.e)()}}class Qs extends S.m{constructor(e={}){super(),this.type=1,this._geometryRecords=new Array,this._geometries=new Array,this._objectTransformation=(0,T.e)(),this._bvObjectSpace=new Ys,this._bvWorldSpace=new Ys,this._bvDirty=!0,this._hasVolatileTransformation=!1,this._visible=!0,this.castShadow=null==e.castShadow||e.castShadow,this.metadata=e.metadata,this.metadata&&this.metadata.isElevationSource&&(this.metadata.lastValidElevationBB=new Zs),this.transformation=(0,T.e)();const{geometries:t,materials:i,transformations:r,origins:s}=e;if(Array.isArray(t)){(0,S.i)(i.length===t.length,"Object3D: materials don't match geometries"),(0,S.i)(r.length===t.length,"Object3D: transformations don't match geometries"),this._geometryRecords.length=t.length,this._geometries.length=t.length;for(let e=0;e<t.length;e++)this._geometries[e]=t[e],this._geometryRecords[e]=Hs.pool.acquire(t[e],i[e],(0,T.r)(r[e]),{highlights:null,occludees:null,visible:!0},s&&s[e])}}get geometryRecords(){return this._geometryRecords}get geometries(){return this._geometries}get transformation(){return this._objectTransformation}set transformation(e){(0,C.n)(this._objectTransformation,e),this._invalidateBoundingVolume(),this._emit("objectTransformation",this)}dispose(){this._geometryRecords.length=0,this._geometries.length=0}get parentLayer(){return this._parentLayer}set parentLayer(e){(0,S.i)(null==this._parentLayer||null==e,"Object3D can only be added to a single Layer"),this._parentLayer=e}getNumGeometryRecords(){return this._geometryRecords.length}getGeometryRecord(e){return(0,S.i)(e>=0&&e<this._geometryRecords.length,"Object3d.getGeometryDataByIndex: index out of range"),this._geometryRecords[e]}addGeometry(e,t,i,r,s,n){i=i||T.a,this._geometries.push(e);const a=Hs.pool.acquire(e,t,i,r||{highlights:null,occludees:null,visible:!0},s,n);return this._geometryRecords.push(a),this._hasVolatileTransformation=this._hasVolatileTransformation||(0,u.r)(a.shaderTransformation),this._emit("objectGeometryAdded",{object:this,record:a}),this._invalidateBoundingVolume(),a}removeGeometry(e){const t=this._geometryRecords.splice(e,1)[0];return this._hasVolatileTransformation=(0,u.r)(t.shaderTransformation)?this._geometryRecords.some((e=>(0,u.r)(e.shaderTransformation))):this._hasVolatileTransformation,t.dispose(),this._geometries.splice(e,1),this._emit("objectGeometryRemoved",{object:this,record:t}),this._invalidateBoundingVolume(),t}removeAllGeometries(){for(;this.getNumGeometryRecords()>0;)this.removeGeometry(0)}geometryVertexAttrsUpdated(e){this._emit("vertexAttrsUpdated",{object:this,record:this._geometryRecords[e]}),this._invalidateBoundingVolume()}get isVisible(){return this._visible}setVisible(e){this._visible=e;for(const e of this._geometryRecords)e.instanceParameters.visible=this._visible;this._emit("visibilityChanged",this)}maskOccludee(){const e=new Ws(1);for(const t of this._geometryRecords)t.instanceParameters.occludees=(0,S.p)(t.instanceParameters.occludees,e);return this._emit("occlusionChanged",this),e}removeOcclude(e){for(const t of this._geometryRecords)t.instanceParameters.occludees=(0,S.q)(t.instanceParameters.occludees,e);this._emit("occlusionChanged",this)}highlight(){const e=new Ws(0);for(const t of this._geometryRecords)t.instanceParameters.highlights=(0,S.p)(t.instanceParameters.highlights,e);return this._emit("highlightChanged",this),e}removeHighlight(e){for(const t of this._geometryRecords)t.instanceParameters.highlights=(0,S.q)(t.instanceParameters.highlights,e);this._emit("highlightChanged",this)}getCombinedStaticTransformation(e,t){return(0,C.e)((0,u.q)(t,(0,T.e)()),this.transformation,e.getStaticTransformation())}getCombinedShaderTransformation(e,t){return t=t||(0,T.e)(),(0,C.e)(t,this.transformation,e.getShaderTransformation()),t}hasVolativeTransformation(){return this._hasVolatileTransformation}get boundingVolumeWorldSpace(){return this._validateBoundingVolume(),this._bvWorldSpace}get boundingVolumeObjectSpace(){return this._validateBoundingVolume(),this._bvObjectSpace}_validateBoundingVolume(){if(!this._bvDirty&&!this._hasVolatileTransformation)return;this._bvObjectSpace.init(),this._bvWorldSpace.init();for(let e=0;e<this._geometryRecords.length;++e){const t=this._geometries[e],i=this._geometryRecords[e],r=t.boundingInfo;(0,u.r)(r)&&(this._calculateTransformedBoundingVolume(r,this._bvObjectSpace,i.getShaderTransformation()),this._calculateTransformedBoundingVolume(r,this._bvWorldSpace,this.getCombinedShaderTransformation(i)))}(0,v.y)(this._bvObjectSpace.bounds,this._bvObjectSpace.min,this._bvObjectSpace.max,.5),(0,v.y)(this._bvWorldSpace.bounds,this._bvWorldSpace.min,this._bvWorldSpace.max,.5);const e=(0,v.n)(),t=(0,v.n)(),i=(0,s.H)(this.transformation);for(let r=0;r<this._geometryRecords.length;++r){const n=this._geometries[r].boundingInfo;if((0,u.t)(n))continue;const a=this._geometryRecords[r].getShaderTransformation(),o=(0,s.H)(a);(0,v.I)(e,n.getCenter(),a);const l=(0,v.q)(e,this._bvObjectSpace.bounds),c=n.getBSRadius()*o;this._bvObjectSpace.bounds[3]=Math.max(this._bvObjectSpace.bounds[3],l+c),(0,v.I)(t,e,this.transformation);const h=(0,v.q)(t,this._bvWorldSpace.bounds),d=c*i;this._bvWorldSpace.bounds[3]=Math.max(this._bvWorldSpace.bounds[3],h+d)}this._bvDirty=!1}_calculateTransformedBoundingVolume(e,t,i){const r=e.getBBMin(),s=e.getBBMax(),n=(0,v.k)(r),a=(0,v.k)(s);(0,v.I)(n,n,i),(0,v.I)(a,a,i);for(let e=0;e<3;++e)t.min[e]=Math.min(t.min[e],n[e],a[e]),t.max[e]=Math.max(t.max[e],n[e],a[e]);for(let e=0;e<3;++e){(0,v.h)(n,r),(0,v.h)(a,s),n[e]=s[e],a[e]=r[e],(0,v.I)(n,n,i),(0,v.I)(a,a,i);for(let e=0;e<3;++e)t.min[e]=Math.min(t.min[e],n[e],a[e]),t.max[e]=Math.max(t.max[e],n[e],a[e])}}_invalidateBoundingVolume(){this._bvDirty=!0,(0,u.r)(this._parentLayer)&&this._parentLayer.notifyObjectBBChanged(this,this._bvWorldSpace.bounds)}_emit(e,t){(0,u.r)(this._parentLayer)&&this._parentLayer.events.emit(e,t)}get test(){const e=this;return{hasGeometry:t=>e._geometries.indexOf(t)>-1,getGeometryIndex:t=>e._geometries.indexOf(t)}}}class Zs{constructor(){this.min=(0,v.i)(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this.max=(0,v.i)(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE)}isEmpty(){return this.max[0]<this.min[0]&&this.max[1]<this.min[1]&&this.max[2]<this.min[2]}}class Ys extends Zs{constructor(){super(...arguments),this.bounds=(0,S._)()}init(){(0,v.a)(this.min,Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),(0,v.a)(this.max,-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),(0,S.s)(this.bounds)}}function Xs(e){return(t,i,r)=>((0,v.y)(Js,t,i,r),!bt(e,Js))}class $s{constructor(){this.min=new Ks,this.max=new Ks,this.hud=new Ks,this.ground=new Ks}init(e){this.min.init(e),this.max.init(e),this.hud.init(e),this.ground.init(e),this.all=[]}}class Ks{constructor(e){this.normal=(0,v.n)(),this.transformation=(0,T.e)(),this._ray=(0,S.x)(),this.init(e)}get ray(){return this._ray}get hasIntersectionPoint(){return null!=this.dist}get distanceInRenderSpace(){if(null!=this.dist)return(0,v.d)(en,this.ray.direction,this.dist),(0,v.s)(en)}getIntersectionPoint(e){return!!this.hasIntersectionPoint&&((0,v.d)(en,this.ray.direction,this.dist),(0,v.u)(e,this.ray.origin,en),!0)}getTransformedNormal(e){return(0,v.h)(tn,this.normal),tn[3]=0,(0,j.y)(tn,tn,this.transformation),(0,v.h)(e,tn),(0,v.j)(e,e),e}init(e){this.dist=void 0,this.target=void 0,this.name=void 0,this.drapedLayerOrder=void 0,this.drapedLayerGraphicOrder=void 0,this.center=null,this.geometryId=null,this.triangleNr=null,this.intersector="Stage",e?(0,S.y)(e,this._ray):this._ray=(0,S.x)()}set(e,t,i,r,s,n,a,o,l,c){e instanceof Qs&&(e={type:"stage",obj:e}),this.dist=i,(0,v.h)(this.normal,r),(0,C.n)(this.transformation,s),this.target=e,this.name=t,this.drapedLayerOrder=n,this.center=a?(0,v.k)(a):null,this.geometryId=o,this.triangleNr=l,this.drapedLayerGraphicOrder=c}copyFrom(e){(0,S.y)(e.ray,this._ray),this.dist=e.dist,this.target=e.target,this.name=e.name,this.drapedLayerOrder=e.drapedLayerOrder,this.center=e.center?(0,v.k)(e.center):null,this.geometryId=e.geometryId,this.triangleNr=e.triangleNr,this.intersector=e.intersector,this.drapedLayerGraphicOrder=e.drapedLayerGraphicOrder,(0,v.h)(this.normal,e.normal),(0,C.n)(this.transformation,e.transformation)}}const Js=(0,v.n)(),en=(0,v.n)(),tn=(0,w.n)(),rn=1e-5;class sn{constructor(e){this.options=new js,this.results=new $s,this.transform=new S.z,this.performanceInfo={queryDuration:0,numObjectsTested:0},this.tolerance=rn,this.verticalOffset=null,this._ray={origin:(0,v.n)(),direction:(0,v.n)()},this._rayEndPoint=(0,v.n)(),this._rayStartPointTransformed=(0,v.n)(),this._rayEndPointTransformed=(0,v.n)(),this.viewingMode=null==e?1:e}get ray(){return this._ray}get rayBeginPoint(){return this._ray.origin}get rayEndPoint(){return this._rayEndPoint}reset(e,t){this.resetWithRay((0,S.A)(e,t,this._ray))}resetWithRay(e){e!==this._ray&&(0,S.y)(e,this._ray),0!==this.options.verticalOffset?2===this.viewingMode?this._ray.origin[2]-=this.options.verticalOffset:this.verticalOffset=this.options.verticalOffset:this.verticalOffset=null,(0,v.u)(this._rayEndPoint,this._ray.origin,this._ray.direction),this._numObjectsTested=0,this.results.init(this._ray)}intersect(e=null,t,i,r,s,n){this.point=t,this.camera=i,this.filterPredicate=s,this.tolerance=null==r?rn:r;const a=(0,S.B)(this.verticalOffset);if((0,u.r)(e)&&e.length>0){const t=n?e=>{n(e)&&this.intersectObject(e)}:e=>{this.intersectObject(e)};for(const i of e){const e=i.getSpatialQueryAccelerator&&i.getSpatialQueryAccelerator();(0,u.r)(e)?((0,u.r)(a)?e.forEachAlongRayWithVerticalOffset(this._ray.origin,this._ray.direction,t,a):e.forEachAlongRay(this._ray.origin,this._ray.direction,t),this.options.selectionMode&&this.options.hud&&e.forEachDegenerateObject(t)):i.objects.forAll((e=>t(e)))}}this.sortResults()}intersectObject(e){this._numObjectsTested++;const t=e.geometryRecords;if(!t)return;const i=e.id,r=e.transformation;let s;const n=(0,S.B)(this.verticalOffset);for(const a of t){const{geometry:t,material:o,instanceParameters:l}=a;if((0,S.C)(l))continue;s=t.id,this.transform.setAndInvalidateLazyTransforms(r,a.getShaderTransformation()),(0,v.I)(this._rayStartPointTransformed,this._ray.origin,this.transform.inverse),(0,v.I)(this._rayEndPointTransformed,this._rayEndPoint,this.transform.inverse);const c=this.transform.transform;(0,u.r)(n)&&(n.objectTransform=this.transform),o.intersect(t,l,this.transform.transform,this,this._rayStartPointTransformed,this._rayEndPointTransformed,((t,r,n,a,o,l)=>{if(t>=0){if((0,u.r)(this.filterPredicate)&&!this.filterPredicate(this._ray.origin,this._rayEndPoint,t))return;const h=`Object3D ${i}`;if(o)return void((null==this.results.hud.dist||t<this.results.hud.dist)&&this.results.hud.set(e,h,t,r,T.a,a,l,s,n));const d=i=>i.set(e,h,t,r,c,a,null,s,n);if((null==this.results.min.drapedLayerOrder||a>=this.results.min.drapedLayerOrder)&&(null==this.results.min.dist||t<this.results.min.dist)&&d(this.results.min),0!==this.options.store&&(null==this.results.max.drapedLayerOrder||a<this.results.max.drapedLayerOrder)&&(null==this.results.max.dist||t>this.results.max.dist)&&d(this.results.max),2===this.options.store){const e=new Ks(this._ray);d(e),this.results.all.push(e)}}}),a.shaderTransformation)}}sortResults(){this.results.all.sort(((e,t)=>e.dist!==t.dist?e.dist-t.dist:e.drapedLayerOrder!==t.drapedLayerOrder?(void 0!==e.drapedLayerOrder?e.drapedLayerOrder:Number.MAX_VALUE)-(void 0!==t.drapedLayerOrder?t.drapedLayerOrder:Number.MAX_VALUE):(void 0!==t.drapedLayerGraphicOrder?t.drapedLayerGraphicOrder:Number.MIN_VALUE)-(void 0!==e.drapedLayerGraphicOrder?e.drapedLayerGraphicOrder:Number.MIN_VALUE)))}}function nn(e,t,i,r){return(0,u.r)(e.renderCoordsHelper.fromRenderCoords(t.eye,hn,r))&&(0,b.g)(i,hn)}function an(e,t){return e.elevationProvider?(0,u.q)(e.elevationProvider.getElevation(t[0],t[1],t[2],e.renderCoordsHelper.spatialReference,"ground"),0):0}function on(e,t,i,r){const s=e.state.camera.clone();t&&(s.eye=t,s.center=i,s.up=r),function(e,t,i){let r=cn[e.viewingMode];r||(r=new sn(e.state.viewingMode),r.options.backfacesTerrain=!e.state.isGlobal,r.options.invisibleTerrain=!0,cn[e.viewingMode]=r);const{isGlobal:s}=e.state;return!(!e.sceneIntersectionHelper.intersectRay(t,r,i)||ln(e,t.origin,i))||!(!e.renderCoordsHelper.intersectManifold(t,0,i)||ln(e,t.origin,i))||!!s&&function(e,t,i){const r=(0,v.z)(e.origin,e.origin)-i*i,s=r>0?Math.sqrt(r)/3:1;return(0,v.d)(t,e.direction,s/(0,v.s)(e.direction)),(0,v.u)(t,t,e.origin),!0}(t,i,(0,x.p)(e.spatialReference).radius)}(e,s.ray,dn)||(0,v.h)(dn,s.center);const n=e.state.constraints,a=n.minimumPoiDistance;if((0,v.D)(s.eye,dn)<a){const t=n.collision.enabled;(0,v.h)(un,s.viewForward),(0,v.d)(un,un,a),t?s.eye=(0,v.c)(hn,dn,un):(0,v.u)(dn,s.eye,un);const i=e.renderCoordsHelper,r=i.getAltitude(s.eye),o=n.collision.elevationMargin;t&&r<o&&((0,v.c)(un,dn,s.eye),s.eye=i.setAltitude(hn,o,s.eye),(0,v.u)(dn,s.eye,un))}return s.center=dn,s}function ln(e,t,i){if(!e.state.isGlobal)return!1;const r=an(e,t),s=e.stateManager.constraintsManager.nearFarHeuristic,{far:n}=s.compute(t,i,e.dataExtent,r,pn),a=n*n;return(0,v.D)(t,i)>a}sn.DEFAULT_TOLERANCE=rn;const cn={},hn=(0,v.n)(),dn=(0,v.n)(),un=(0,v.n)(),pn={near:0,far:0};function mn(e,t,i=0){const r=e.state.constraints;if(!r.collision.enabled)return!1;const s=an(e,t.eye),n=e.renderCoordsHelper.getAltitude(t.eye),a=s+r.collision.elevationMargin;if(n>=a)return!1;const o=(0,v.s)(t.eye);if((0,v.c)(fn,t.center,t.eye),t.eye=e.renderCoordsHelper.setAltitude(gn,a,t.eye),1===i)t.center=(0,v.u)(fn,t.eye,fn);else if(2===i){const e=(o-n+a)/o;t.center=(0,v.d)(fn,t.center,e)}return!0}const fn=(0,v.n)(),gn=(0,v.n)();function vn(e,t,i){e.worldUpAtPosition(t,yn),(0,v.c)(_n,i,t);const r=(0,v.s)(_n);return 0===r?0:(0,v.x)((0,v.z)(_n,yn)/r)}const yn=(0,v.n)(),_n=(0,v.n)();function xn(e,t,i=Ss,r=Ss,s){if(!e.state.constraints.tilt)return 0;const n=t.distance,a=e.state.constraints.tilt(n,An);return function(e,t,i){if(0===t.interactionType)return;const{interactionStartCamera:r,interactionFactor:s}=t,{min:n,max:a}=i,o=xn(e,r,Ss,t),l=0===o?0:vn(e.renderCoordsHelper,r.center,r.eye);i.min=n,i.max=a,2===t.interactionType?(Cs(t.selection,2)&&Cn(e,r,i),Ts(o,l,!0,s,Rn,i)):Ts(o,l,!1,s,Rn,i)}(e,i,a),2===r.interactionType&&Cs(r.selection,2)&&Cn(e,r.interactionStartCamera,a),1===i.tiltMode||1===r.tiltMode?function(e,t,i,r){switch(r&&(r.requiresTwoSteps=!1),e.viewingMode){case"global":return function(e,t,i,r){const s=function(e,t,i){const r=e.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,s=r+(0,x.p)(e.spatialReference).radius,n=e.renderCoordsHelper.intersectManifold(t.ray,r,Pn);return i.eyeCenterDistance=t.distance,i.centerIsOnSurface=!1,(0,u.r)(n)?(i.eyeCenterDistance=(0,v.q)(t.eye,n),i.tiltAtCenter=vn(e.renderCoordsHelper,n,t.eye),i.centerIsOnSurface=!0):e.state.isLocal?i.tiltAtCenter=vn(e.renderCoordsHelper,t.center,t.eye):((0,S.F)((0,S.E)(s),t.ray,Pn),i.eyeCenterDistance=(0,v.q)(t.eye,Pn),i.tiltAtCenter=(0,v.x)(-(0,v.z)(t.viewForward,(0,v.j)(Pn,Pn)))),i.radius=s,i.eyeRadius=(0,v.s)(t.eye),i.constraints=e.state.constraints,i}(e,t,Mn),n=(0,v.o)(s.tiltAtCenter,i.min,i.max);if(!bn(s.tiltAtCenter-n))return 0;let a,o;return s.centerIsOnSurface?(a=function(e){const{constraints:t,eyeCenterDistance:i,tiltAtCenter:r}=e;let s=r,n=t.clampTilt(i,r);const a=wn(e,n);if(t.clampTilt(a,r)===n)return n;let o=0;for(;o<10&&bn(n-s);){const i=(s+n)/2,r=wn(e,i);bn(t.clampTilt(r,i)-i)?s=i:n=i,o++}return n}(s),o=function(e,t){const i=(0,v.p)(e.radius/e.eyeRadius*Math.sin(e.tiltAtCenter)),r=(0,v.p)(e.radius/e.eyeRadius*Math.sin(t));return e.eyeRadius>e.radius?i-r:r-i}(s,a)):(a=s.constraints.clampTilt(s.eyeCenterDistance,s.tiltAtCenter),r&&a<Math.PI/2&&(r.requiresTwoSteps=!0,a=Math.PI/2-1e-5),o=function(e,t){return e.tiltAtCenter-Math.PI/2-(t-Math.PI/2)}(s,a)),r&&(r.eyeCenterDistance=wn(s,a)),o}(e,t,i,r);case"local":return function(e,t,i,r){const s=vn(e.renderCoordsHelper,t.center,t.eye),n=(0,v.o)(s,i.min,i.max),a=s-n;if(!bn(a))return 0;if(r){const i=e.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,s=e.renderCoordsHelper.getAltitude(t.eye)-i,a=Math.cos(n);Math.abs(a)>1e-4?r.eyeCenterDistance=s/a:r.eyeCenterDistance=t.distance}return a}(e,t,i,r);default:return void(0,Z.n)(e.viewingMode)}}(e,t,a,s):function(e,t,i){const r=vn(e.renderCoordsHelper,t.center,t.eye),s=r-(0,v.o)(r,i.min,i.max);return bn(s)?s:0}(e,t,a)}function bn(e){return Math.abs(e)>1e-9}function wn(e,t){if(!e.centerIsOnSurface)return e.eyeCenterDistance;const i=Math.PI-(0,v.o)(t,0,Math.PI),r=(0,v.p)(e.radius/e.eyeRadius*Math.sin(i)),s=Math.PI-i-r,n=Math.sin(s)/Math.sin(i);if(e.eyeRadius<e.radius&&n>1){const t=Math.PI-r,s=Math.PI-i-t;return Math.sin(s)/Math.sin(i)*e.eyeRadius}return n*e.eyeRadius}function Cn(e,t,i){if(e.state.isLocal)return;const r=e.state.constraints;if(!r.altitude)return;const s=(0,v.m)(t.center),n=Math.sqrt(s),a=t.distance,o=(0,x.p)(e.spatialReference).radius,l=r.altitude.min+o,c=r.altitude.max+o,h=(l*l-a*a-s)/(-2*n*a),d=(c*c-a*a-s)/(-2*n*a);i.min=Math.max(i.min,Math.min(Math.PI-(0,v.x)(d),i.max)),i.max=Math.min(i.max,Math.PI-(0,v.x)(h))}const Tn=(0,v.n)(),Sn=(0,T.e)(),Pn=(0,v.n)(),Rn=(0,v.g)(5),An={min:0,max:0},Mn={constraints:null,radius:0,eyeRadius:0,centerIsOnSurface:!0,eyeCenterDistance:0,tiltAtCenter:0},On={eyeCenterDistance:0,requiresTwoSteps:!1},Dn=e=>e*e,En=e=>1-Dn(1-e),zn=e=>e*e*e,In=e=>1-zn(1-e),Ln=e=>e<.5?zn(2*e)/2:(In(2*(e-.5))+1)/2,Fn=e=>e*e*e*e,Vn=e=>1-Fn(1-e),Un=e=>e*e*e*e*e,Gn=e=>1-Un(1-e),Bn=e=>1-Math.cos(e*Math.PI/2),qn=e=>1-Bn(1-e),kn=e=>2**(10*(e-1)),Nn=e=>1-kn(1-e),jn=e=>-(Math.sqrt(1-e*e)-1),Hn=e=>1-jn(1-e);function Wn(e){const t=2*(e-Math.sqrt((e-1)*e)),i=t/2/e;return r=>r<i?e*r*r:t*r-t+1}function Qn(e,t){return(i,r)=>i<t?t*e(i/t,r):1-e((1-i)/(1-t),r)*(1-t)}const Zn=Qn(Wn(1),1),Yn=Qn(Wn(1),0),Xn=Qn(Wn(1),.5),$n=Qn(Wn(2),1),Kn=Qn(Wn(2),0),Jn=Qn(Wn(2),.5),ea=Qn(Wn(3),1),ta=Qn(Wn(3),0),ia=Qn(Wn(3),.5),ra=Qn(Wn(4),1),sa=Qn(Wn(4),0),na=Qn(Wn(4),.5),aa={linear:function(e){return e},"in-quad":Dn,"out-quad":En,"in-out-quad":e=>e<.5?Dn(2*e)/2:(En(2*(e-.5))+1)/2,"in-coast-quad":Zn,"out-coast-quad":Yn,"in-out-coast-quad":Xn,"in-cubic":zn,"out-cubic":In,"in-out-cubic":Ln,"in-coast-cubic":$n,"out-coast-cubic":Kn,"in-out-coast-cubic":Jn,"in-quart":Fn,"out-quart":Vn,"in-out-quart":e=>e<.5?Fn(2*e)/2:(Vn(2*(e-.5))+1)/2,"in-coast-quart":ea,"out-coast-quart":ta,"in-out-coast-quart":ia,"in-quint":Un,"out-quint":Gn,"in-out-quint":e=>e<.5?Un(2*e)/2:(Gn(2*(e-.5))+1)/2,"in-coast-quint":ra,"out-coast-quint":sa,"in-out-coast-quint":na,"in-sine":Bn,"out-sine":qn,"in-out-sine":e=>e<.5?Bn(2*e)/2:(qn(2*(e-.5))+1)/2,"in-expo":kn,"out-expo":Nn,"in-out-expo":e=>e<.5?kn(2*e)/2:(Nn(2*(e-.5))+1)/2,"in-circ":jn,"out-circ":Hn,"in-out-circ":e=>e<.5?jn(2*e)/2:(Hn(2*(e-.5))+1)/2};function oa(e,t,i=ha,r=t){let s=!1;r!==t&&r.copyFrom(t),r.computeUp(e.state.viewingMode);for(let t=0;t<da;t++){let t=0;for(const n of ca)if(Cs(i.selection,n.type)){const a=Math.abs(n.error(e,r,i));n.apply(e,r,i)&&(s=!0,t+=a)}if(0===t)break}const n=Cs(i.selection,8),a=function(e,t){switch(e){case 4:return 1;case 5:return t.state.isGlobal?2:1;default:return 0}}(i.interactionType,e);return n&&mn(e,r,a)&&(s=!0),s&&r.computeUp(e.state.viewingMode),s}function la(e,t){const i="number"==typeof e?e:(0,k.d)(e,t),r=Math.min(1,i/150);return Ln(r)}const ca=[{type:1,error:function(e,t,i){return xn(e,t,i)*t.distance},apply:function e(t,i,r=Ss,s=!0){On.eyeCenterDistance=0,On.requiresTwoSteps=!1;const n=xn(t,i,r,void 0,On);if(0===n)return!1;switch((0,C.r)(Sn),(0,C.f)(Sn,Sn,-n,i.viewRight),r.tiltMode){case 1:(0,v.I)(Tn,i.viewForward,Sn),(0,v.d)(Tn,Tn,On.eyeCenterDistance),i.center=(0,v.u)(Pn,i.eye,Tn);break;case 0:(0,v.c)(Tn,i.center,i.eye),(0,v.I)(Tn,Tn,Sn),i.eye=(0,v.c)(Pn,i.center,Tn);break;default:(0,Z.n)(r.tiltMode)}return i.up=(0,v.I)(Pn,i.up,Sn),!On.requiresTwoSteps||!s||e(t,i,r,!1)}},{type:2,error:Os,apply:function(e,t,i=Ss){const r=Os(e,t,i);if(0===r)return!1;const s=e.renderCoordsHelper,n=s.getAltitude(t.eye)+r,a=Ps(t,i.interactionDirection,function(e,t,i,r){return e.renderCoordsHelper.worldUpAtPosition(t.eye,r),(0,v.d)(r,r,i),r}(e,t,(0,v.e)(r),zs),Es),o=(0,v.h)(Is,t.viewForward),l=s.intersectInfiniteManifold((0,S.g)(t.eye,a),n,Ls);return t.eye=(0,u.r)(l)?l:s.setAltitude(Ls,n,t.eye),t.center=function(e,t,i,r){const s=(0,v.z)(i,(0,v.c)(e,r,t));return(0,v.u)(e,t,(0,v.d)(e,i,s))}(Ls,t.eye,o,t.center),!0}},{type:4,error:Fs,apply:function(e,t,i=Ss){const r=Fs(e,t,i);if(0===r)return!1;const s=e.pointsOfInterest.surfaceOrigin,n=Vs(e,t)+r,a=(0,v.h)(Gs,t.eye),o=Ps(t,i.interactionDirection,function(e,t,i){const r=e.pointsOfInterest.surfaceOrigin;return(0,v.H)(i,t.eye,r.renderLocation)}(e,t,ks),qs);if(!(0,S.V)((0,S.w)(s.renderLocation,n),(0,S.g)(t.eye,o),Ns))return!1;t.eye=Ns;const l=(0,v.c)(Bs,t.eye,a);t.center=(0,v.u)(Ns,t.center,l);const c=e.renderCoordsHelper.getAltitude(t.center),h=e.renderCoordsHelper.intersectInfiniteManifold(t.ray,c,Ns);return(0,u.r)(h)&&(t.center=h),!0}}],ha={selection:15,interactionType:0,interactionFactor:0,interactionStartCamera:null,interactionDirection:null,tiltMode:0},da=5,ua=(0,v.n)(),pa=(0,v.n)(),ma=(0,v.n)(),fa=(0,v.n)(),ga=(0,v.n)(),va=(0,v.n)(),ya={upward:(0,v.i)(0,0,1),forward:(0,v.i)(0,1,0),sideway:(0,v.i)(1,0,0)},_a=(0,X.e)();class xa{constructor(e=1){this.viewingMode=e,this.center=(0,v.n)(),this.pitch=0,this.yaw=0,this.distance=0,this.lookAtDirection=(0,v.k)(ya.forward)}pixelsPerPanAtZoom(e){return this.size/2/(this._zoomToPanScale*e)}zoomAtPixelsPerPan(e){return this.size/2/(this._zoomToPanScale*e)}pixelsPerRotateAtZoom(){const e=Math.max(Math.cos(Math.abs(this.pitch)),.5);return this.size/2/e}compareTo(e,t){if(t||(t={pan:0,rotate:0,sourceZoom:0,targetZoom:0}),1===this.viewingMode){const i=((0,v.s)(this.center)+(0,v.s)(e.center))/2;t.pan=(0,s.K)(this.center,e.center)*i}else t.pan=(0,v.q)(this.center,e.center);let i=Math.abs(e.yaw-this.yaw);i>=Math.PI&&(i=2*Math.PI-i);const r=Math.abs(e.pitch-this.pitch);return t.rotate=Math.max(i,r),t.sourceZoom=this.distance,t.targetZoom=e.distance,t}interpolate(e,t,i){1===this.viewingMode?(0,s.L)(e.center,t.center,i.pan,this.center):(0,v.y)(this.center,e.center,t.center,i.pan),this.distance=(0,v.C)(e.distance,t.distance,i.zoom),this.pitch=(0,v.C)(e.pitch,t.pitch,i.rotate);let r=e.yaw;const n=t.yaw;Math.abs(n-r)>=Math.PI&&(r+=2*(r<n?1:-1)*Math.PI),this.yaw=(0,v.C)(r,n,i.rotate)}copyFrom(e){(0,v.h)(this.center,e.center),this.pitch=e.pitch,this.yaw=e.yaw,this.distance=e.distance,(0,v.h)(this.lookAtDirection,e.lookAtDirection),this.size=e.size,this.copyFromCommon(e),this.viewingMode=e.viewingMode}copyFromRenderCamera(e){const t=this._lookAtOrientation(e.center,_a);(0,v.h)(this.center,e.center),(0,v.c)(fa,e.center,e.eye),(0,v.L)(fa,fa,t),(0,v.L)(ga,e.up,t),this.distance=(0,v.s)(fa),fa[0]/=this.distance,fa[1]/=this.distance,fa[2]/=this.distance,this.pitch=this._eyeUpToPitch(fa),this.yaw=this._eyeUpToYaw(fa,ga),this.size=Math.sqrt(e.width*e.width+e.height*e.height),this.copyFromCommon(e)}copyFromCommon(e){this.fov=e.fov,this._zoomToPanScale=Math.atan(.5*this.fov)}copyToRenderCamera(e){const t=this._lookAtOrientation(this.center,_a);(0,Y.o)(t,t),this._axisAngleVec3(ya.sideway,this.pitch-Math.PI/2,ya.forward,fa),this._axisAngleVec3(ya.upward,this.yaw,fa),this._axisAngleVec3(ya.sideway,this.pitch-Math.PI/2,ya.upward,ga),this._axisAngleVec3(ya.upward,this.yaw,ga),(0,v.d)(fa,fa,this.distance),(0,v.L)(fa,fa,t),(0,v.L)(ga,ga,t),e.center=this.center,e.eye=(0,v.c)(fa,this.center,fa),e.up=ga}_axisAngleVec3(e,t,i,r=i){const s=Math.cos(t),n=Math.sin(t);return(0,v.d)(ua,i,s),(0,v._)(pa,e,i),(0,v.d)(pa,pa,n),(0,v.d)(ma,e,(1-s)*(0,v.z)(e,i)),(0,v.u)(r,(0,v.u)(r,ua,pa),ma)}_lookAtOrientation(e,t=(0,X.e)()){return this._upAtLookAt(e,ma),(0,v._)(ua,this.lookAtDirection,ma),(0,v.j)(ua,ua),0===ua[0]&&0===ua[1]&&0===ua[2]&&(0,v.h)(ua,ya.sideway),(0,v._)(pa,ma,ua),(0,v.j)(pa,pa),t[0]=ua[0],t[1]=pa[0],t[2]=ma[0],t[3]=ua[1],t[4]=pa[1],t[5]=ma[1],t[6]=ua[2],t[7]=pa[2],t[8]=ma[2],t}_upAtLookAt(e,t){return 2===this.viewingMode?(0,v.h)(t,ya.upward):(0,v.j)(t,e)}_eyeUpToPitch(e){return Math.PI-(0,s.K)(ya.upward,e)}_eyeUpToYaw(e,t){const i=va;return Math.abs(t[2])<.5?((0,v.h)(i,t),e[2]>0&&(0,v.d)(i,i,-1)):(0,v.h)(i,e),(0,v._)(pa,i,ya.upward),(0,v.j)(pa,pa),(0,s.K)(ya.sideway,pa,ya.upward)}}function ba(e){return e?{ray:(0,S.x)(e.ray),c0:e.c0,c1:e.c1}:{ray:(0,S.x)(),c0:0,c1:Number.MAX_VALUE}}function wa(e){return e?[De(e[0]),De(e[1]),De(e[2]),De(e[3]),De(e[4]),De(e[5])]:[De(),De(),De(),De(),De(),De()]}function Ca(){return[(0,v.n)(),(0,v.n)(),(0,v.n)(),(0,v.n)(),(0,v.n)(),(0,v.n)(),(0,v.n)(),(0,v.n)()]}function Ta(e,t=wa()){for(let i=0;i<6;i++)Ee(e[i],t[i])}function Sa(e,t,i,r=Ea){const s=(0,C.e)(w.f.get(),t,e);(0,C.h)(s,s);for(let e=0;e<8;++e){const t=(0,j.y)(w.r.get(),Oa[e],s);(0,v.a)(r[e],t[0]/t[3],t[1]/t[3],t[2]/t[3])}Pa(i,r)}function Pa(e,t){Fe(t[4],t[0],t[3],e[0]),Fe(t[1],t[5],t[6],e[1]),Fe(t[4],t[5],t[1],e[2]),Fe(t[3],t[2],t[6],e[3]),Fe(t[0],t[1],t[2],e[4]),Fe(t[5],t[4],t[7],e[5])}function Ra(e,t){for(let i=0;i<6;i++)if(Xe(e[i],t))return!1;return!0}function Aa(e,t){for(let i=0;i<6;i++)if(it(e[i],t)>0)return!1;return!0}function Ma(e,t){for(let i=0;i<6;i++)if(!et(e[i],t))return!1;return!0}new w.s((()=>({c0:0,c1:0,ray:null})));const Oa=[(0,w.a)(-1,-1,-1,1),(0,w.a)(1,-1,-1,1),(0,w.a)(1,1,-1,1),(0,w.a)(-1,1,-1,1),(0,w.a)(-1,-1,1,1),(0,w.a)(1,-1,1,1),(0,w.a)(1,1,1,1),(0,w.a)(-1,1,1,1)],Da=new w.s(ba),Ea=Ca(),za=u.n.getLogger("esri.views.3d.webgl-engine.lib.Camera");class Ia{constructor(e=null,t=null,i=null){this._viewUp=(0,v.n)(),this._viewForward=(0,v.n)(),this._viewRight=(0,v.n)(),this._ray=(0,S.x)(),this._viewport=(0,w.a)(0,0,1,1),this._padding=(0,w.a)(0,0,0,0),this._fov=55/180*Math.PI,this._nearFar=(0,N.t)(1,1e3),this._viewDirty=!0,this._viewMatrix=(0,T.e)(),this._projectionDirty=!0,this._projectionMatrix=(0,T.e)(),this._viewProjectionDirty=!0,this._viewProjectionMatrix=(0,T.e)(),this._viewInverseTransposeMatrixDirty=!0,this._viewInverseTransposeMatrix=(0,T.e)(),this._frustumDirty=!0,this._frustum=wa(),this._fullViewport=(0,w.n)(),this.pixelRatio=1,this.relativeElevation=0,(0,u.r)(e)&&(0,v.h)(this._ray.origin,e),this._center=(0,u.r)(t)?(0,v.k)(t):(0,v.n)(),this._up=(0,u.r)(i)?(0,v.k)(i):(0,v.i)(0,0,1)}get eye(){return this._ray.origin}set eye(e){this._compareAndSetView(e,this._ray.origin)}get center(){return this._center}set center(e){this._compareAndSetView(e,this._center)}get ray(){return(0,v.c)(this._ray.direction,this.center,this.eye),this._ray}get up(){return this._up}set up(e){this._compareAndSetView(e,this._up)}get viewMatrix(){return this._ensureViewClean(),this._viewMatrix}set viewMatrix(e){(0,C.n)(this._viewMatrix,e),this._viewDirty=!1,this._viewInverseTransposeMatrixDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0}get viewForward(){return this._ensureViewClean(),this._viewForward}get viewUp(){return this._ensureViewClean(),this._viewUp}get viewRight(){return this._ensureViewClean(),this._viewRight}get nearFar(){return this._nearFar}get near(){return this._nearFar[0]}set near(e){this._nearFar[0]!==e&&(this._nearFar[0]=e,this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)}get far(){return this._nearFar[1]}set far(e){this._nearFar[1]!==e&&(this._nearFar[1]=e,this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)}get viewport(){return this._viewport}set viewport(e){this.x=e[0],this.y=e[1],this.width=e[2],this.height=e[3]}get x(){return this._viewport[0]}set x(e){e+=this._padding[3],this._viewport[0]!==e&&(this._viewport[0]=e,this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)}get y(){return this._viewport[1]}set y(e){e+=this._padding[2],this._viewport[1]!==e&&(this._viewport[1]=e,this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)}get width(){return this._viewport[2]}set width(e){this._viewport[2]!==e&&(this._viewport[2]=e,this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)}get height(){return this._viewport[3]}set height(e){this._viewport[3]!==e&&(this._viewport[3]=e,this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)}get fullWidth(){return this._viewport[2]+this._padding[1]+this._padding[3]}set fullWidth(e){this.width=e-(this._padding[1]+this._padding[3])}get fullHeight(){return this._viewport[3]+this._padding[0]+this._padding[2]}set fullHeight(e){this.height=e-(this._padding[0]+this._padding[2])}get fullViewport(){return this._fullViewport[0]=this._viewport[0]-this._padding[3],this._fullViewport[1]=this._viewport[1]-this._padding[2],this._fullViewport[2]=this.fullWidth,this._fullViewport[3]=this.fullHeight,this._fullViewport}get aspect(){return this.width/this.height}get padding(){return this._padding}set padding(e){this._padding[0]===e[0]&&this._padding[1]===e[1]&&this._padding[2]===e[2]&&this._padding[3]===e[3]||(this._viewport[0]+=e[3]-this._padding[3],this._viewport[1]+=e[2]-this._padding[2],this._viewport[2]-=e[1]+e[3]-(this._padding[1]+this._padding[3]),this._viewport[3]-=e[0]+e[2]-(this._padding[0]+this._padding[2]),(0,j.a)(this._padding,e),this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)}get viewProjectionMatrix(){return this._viewProjectionDirty&&((0,C.e)(this._viewProjectionMatrix,this.projectionMatrix,this.viewMatrix),this._viewProjectionDirty=!1),this._viewProjectionMatrix}get projectionMatrix(){if(this._projectionDirty){const e=this.width,t=this.height,i=this.near*Math.tan(this.fovY/2),r=i*this.aspect;(0,C.A)(this._projectionMatrix,-r*(1+2*this._padding[3]/e),r*(1+2*this._padding[1]/e),-i*(1+2*this._padding[2]/t),i*(1+2*this._padding[0]/t),this.near,this.far),this._projectionDirty=!1}return this._projectionMatrix}set projectionMatrix(e){(0,C.n)(this._projectionMatrix,e),this._projectionDirty=!1,this._viewProjectionDirty=!0,this._frustumDirty=!0}get fov(){return this._fov}set fov(e){this._fov=e,this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0}get fovX(){return(0,S.G)(this._fov,this.width,this.height)}set fovX(e){this._fov=(0,S.H)(e,this.width,this.height),this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0}get fovY(){return(0,S.I)(this._fov,this.width,this.height)}set fovY(e){this._fov=(0,S.$)(e,this.width,this.height),this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0}get distance(){return(0,v.q)(this._center,this.eye)}get frustum(){return this._recomputeFrustum(),this._frustum}get viewInverseTransposeMatrix(){return(this._viewInverseTransposeMatrixDirty||this._viewDirty)&&((0,C.h)(this._viewInverseTransposeMatrix,this.viewMatrix),(0,C.o)(this._viewInverseTransposeMatrix,this._viewInverseTransposeMatrix),this._viewInverseTransposeMatrixDirty=!1),this._viewInverseTransposeMatrix}depthNDCToWorld(e){const t=2*e-1;return 2*this.near*this.far/(this.far+this.near-t*(this.far-this.near))}get perRenderPixelRatio(){return Math.tan(this.fovX/2)/(this.width/2)}get perScreenPixelRatio(){return this.perRenderPixelRatio*this.pixelRatio}get aboveGround(){return this.relativeElevation&&this.relativeElevation>=0}copyFrom(e){(0,v.h)(this._ray.origin,e.eye),(0,v.h)(this._center,e.center),(0,v.h)(this._up,e.up),(0,j.a)(this._viewport,e.viewport),(0,j.a)(this._padding,e.padding),(0,k.a)(this._nearFar,e.nearFar),this._fov=e.fov,this.relativeElevation=e.relativeElevation;const t=e;return this._viewDirty=t._viewDirty,this._viewDirty||((0,C.n)(this._viewMatrix,e.viewMatrix),(0,v.h)(this._viewRight,e.viewRight),(0,v.h)(this._viewUp,e.viewUp),(0,v.h)(this._viewForward,e.viewForward)),t._projectionDirty?this._projectionDirty=!0:((0,C.n)(this._projectionMatrix,e.projectionMatrix),this._projectionDirty=!1),this._viewProjectionDirty=!0,this._frustumDirty=t._frustumDirty,this._frustumDirty||(Ta(e.frustum,this._frustum),this._frustumDirty=!1),t._viewInverseTransposeMatrixDirty?this._viewInverseTransposeMatrixDirty=!0:((0,C.n)(this._viewInverseTransposeMatrix,e.viewInverseTransposeMatrix),this._viewInverseTransposeMatrixDirty=!1),(0,j.a)(this._fullViewport,e.fullViewport),this.pixelRatio=e.pixelRatio,this}copyViewFrom(e){this.eye=e.eye,this.center=e.center,this.up=e.up}clone(){return(new Ia).copyFrom(this)}equals(e){return(0,v.F)(this.eye,e.eye)&&(0,v.F)(this._center,e.center)&&(0,v.F)(this._up,e.up)&&(0,j.D)(this._viewport,e.viewport)&&(0,j.D)(this._padding,e.padding)&&(0,k.k)(this._nearFar,e.nearFar)&&this._fov===e.fov&&this.pixelRatio===e.pixelRatio&&this.relativeElevation===e.relativeElevation}almostEquals(e){if(this.pixelRatio!==e.pixelRatio||Math.abs(e.fov-this._fov)>=.001)return!1;const t=5e-4;(0,v.J)(Va,e.eye,e.center),(0,v.J)(Ua,this.eye,this._center);const i=(0,v.z)(Va,Ua),r=(0,v.Z)(Va),s=(0,v.Z)(Ua);return i*i>=(1-1e-10)*r*s&&(0,v.X)(e.eye,this.eye)<Math.max(r,s)*t*t&&(0,j.b)(e.padding,this._padding)<.5&&(0,j.b)(e.viewport,this._viewport)<.5}computeRenderPixelSizeAt(e){return this.computeRenderPixelSizeAtDist(this.viewDirectionDistance(e))}computeRenderPixelSizeAtDist(e){return e*this.perRenderPixelRatio}computeScreenPixelSizeAt(e){return this.computeScreenPixelSizeAtDist(this.viewDirectionDistance(e))}viewDirectionDistance(e){return Math.abs((0,S.e)(this.viewForward,(0,v.c)(Va,e,this.eye)))}computeScreenPixelSizeAtDist(e){return e*this.perScreenPixelRatio}computeDistanceFromRadius(e,t){return e/Math.tan(Math.min(this.fovX,this.fovY)/(2*(t||1)))}getScreenCenter(e=(0,f.i)()){return e[0]=(this.padding[3]+this.width/2)/this.pixelRatio,e[1]=(this.padding[0]+this.height/2)/this.pixelRatio,e}getRenderCenter(e,t=.5,i=.5){return e||(e=(0,f.x)()),e[0]=this.padding[3]+this.width*t,e[1]=this.padding[2]+this.height*i,e.length>2&&(e[2]=.5),e}setGLViewport(e){const t=this.viewport,i=this.padding;e.setViewport(t[0]-i[3],t[1]-i[2],t[2]+i[1]+i[3],t[3]+i[0]+i[2])}applyProjection(e,t,i=!1){e!==La&&(0,v.h)(La,e),La[3]=1,i&&(t[2]=-La[2]),(0,j.y)(La,La,this.projectionMatrix),(0,v.d)(La,La,1/Math.abs(La[3]));const r=this.fullViewport;return t[0]=(0,v.C)(0,r[0]+r[2],.5+.5*La[0]),t[1]=(0,v.C)(0,r[1]+r[3],.5+.5*La[1]),i||(t[2]=.5*(La[2]+1)),t}projectToScreen(e,t){this.projectToRenderScreen(e,Ga),this.renderToScreen(Ga,t)}projectToRenderScreen(e,t){if(La[0]=e[0],La[1]=e[1],La[2]=e[2],La[3]=1,(0,j.y)(La,La,this.viewProjectionMatrix),0===La[3])return null;(0,v.d)(La,La,1/Math.abs(La[3]));const i=this.fullViewport;return"x"in t?(t.x=(0,v.C)(0,i[0]+i[2],.5+.5*La[0]),t.y=(0,v.C)(0,i[1]+i[3],.5+.5*La[1])):(t[0]=(0,v.C)(0,i[0]+i[2],.5+.5*La[0]),t[1]=(0,v.C)(0,i[1]+i[3],.5+.5*La[1]),t.length>2&&(t[2]=.5*(La[2]+1))),t}unprojectFromScreen(e,t){return this.unprojectFromRenderScreen(this.screenToRender(e,Ga),t)}unprojectFromRenderScreen(e,t){if((0,C.e)(Fa,this.projectionMatrix,this.viewMatrix),!(0,C.h)(Fa,Fa))return null;const i=this.fullViewport;return La[0]=2*(e[0]-i[0])/i[2]-1,La[1]=2*(e[1]-i[1])/i[3]-1,La[2]=2*e[2]-1,La[3]=1,(0,j.y)(La,La,Fa),0===La[3]?null:(t[0]=La[0]/La[3],t[1]=La[1]/La[3],t[2]=La[2]/La[3],t)}constrainWindowSize(e,t,i,r=i){const s=e*this.pixelRatio,n=t*this.pixelRatio,a=Math.max(s-i/2,0),o=Math.max(this.fullHeight-n-r/2,0),l=-Math.min(s-i/2,0),c=-Math.min(this.fullHeight-n-r/2,0);return[a,o,i-l- -Math.min(this.fullWidth-s-i/2,0),r-c- -Math.min(n-r/2,0)]}computeUp(e){1===e?this.computeUpGlobal():this.computeUpLocal()}screenToRender(e,t){const i=e[0]*this.pixelRatio,r=this.fullHeight-e[1]*this.pixelRatio;return t[0]=i,t[1]=r,t}renderToScreen(e,t){const i=e[0]/this.pixelRatio,r=(this.fullHeight-e[1])/this.pixelRatio;t[0]=i,t[1]=r}computeUpGlobal(){(0,v.c)(Va,this.center,this.eye);const e=(0,v.s)(this.center);e<1?((0,v.a)(this._up,0,0,1),this._markViewDirty()):Math.abs((0,v.z)(Va,this.center))>.9999*(0,v.s)(Va)*e||((0,v._)(this._up,Va,this.center),(0,v._)(this._up,this._up,Va),(0,v.j)(this._up,this._up),this._markViewDirty())}computeUpLocal(){(0,v.H)(Va,this.eye,this.center),Math.abs(Va[2])<=.9999&&((0,v.d)(Va,Va,Va[2]),(0,v.a)(this._up,-Va[0],-Va[1],1-Va[2]),(0,v.j)(this._up,this._up),this._markViewDirty())}_compareAndSetView(e,t){"number"==typeof e[0]&&isFinite(e[0])&&"number"==typeof e[1]&&isFinite(e[1])&&"number"==typeof e[2]&&isFinite(e[2])?(0,v.F)(e,t)||((0,v.h)(t,e),this._markViewDirty()):za.warn("Camera vector contains invalid number, ignoring value")}_markViewDirty(){this._viewDirty=!0,this._frustumDirty=!0,this._viewProjectionDirty=!0}_recomputeFrustum(){this._frustumDirty&&(Sa(this.viewMatrix,this.projectionMatrix,this._frustum),this._frustumDirty=!1)}_ensureViewClean(){this._viewDirty&&((0,C.F)(this._viewMatrix,this.eye,this._center,this._up),(0,v.a)(this._viewForward,-this._viewMatrix[2],-this._viewMatrix[6],-this._viewMatrix[10]),(0,v.a)(this._viewUp,this._viewMatrix[1],this._viewMatrix[5],this._viewMatrix[9]),(0,v.a)(this._viewRight,this._viewMatrix[0],this._viewMatrix[4],this._viewMatrix[8]),this._viewDirty=!1,this._viewInverseTransposeMatrixDirty=!0)}}const La=(0,w.n)(),Fa=(0,T.e)(),Va=(0,v.n)(),Ua=(0,v.n)(),Ga=(0,f.x)(),Ba=(0,r.w)(500),qa=(0,r.w)(8e3);class ka{constructor(e){this.createCamera=e,this.compared={sourceZoom:0,targetZoom:0,pan:0,rotate:0},this.settings={desiredScreenFlow:2},this.source=e(),this.target=e()}clone(){const e=new ka(this.createCamera);return e.copyFrom(this),e}copyFrom(e){this.update(e.source,e.target,e.settings)}update(e,t,i){this.source!==e&&this.source.copyFrom(e),this.target!==t&&this.target.copyFrom(t),this.compared=this.source.compareTo(this.target,this.compared),this.settings.desiredScreenFlow=null!=i.desiredScreenFlow?i.desiredScreenFlow:2,this.desiredPixelFlow=this.settings.desiredScreenFlow*this.target.size,this.halfWindowSize=this.target.size/2}halfWindowPanAtZoom(e){const t=this.target.pixelsPerPanAtZoom(e);return this.halfWindowSize/t}get hasZoom(){return Math.abs(this.compared.sourceZoom-this.compared.targetZoom)>1e-5}get hasPan(){return this.compared.pan>1e-9}get hasRotate(){return this.compared.rotate>1e-9}}class Na{constructor(e){e&&this.update(e)}get time(){return this._time}update(e){e&&(this.definition?this.definition.copyFrom(e):this.definition=e.clone()),this._updatePrecomputedVariables(),this._updatePixelFlow()}_updatePrecomputedVariables(){const e=this.definition,t=e.compared,i=t.sourceZoom,r=t.targetZoom;this._zoomSign=i>r?1:-1,this._panPixelsAtSource=t.pan*e.source.pixelsPerPanAtZoom(i);const s=(e.source.pixelsPerRotateAtZoom(i)+e.target.pixelsPerRotateAtZoom(r))/2;this._rotatePixels=t.rotate*s}_updatePixelFlow(){const e=this.definition.compared.sourceZoom,t=this.definition.compared.targetZoom,{hasZoom:i,hasPan:s,hasRotate:n}=this.definition;let a=0,o=0;i&&(s&&(a=(t/e-1)/(-1/(this._zoomSign*this.definition.halfWindowSize)*Math.LN2*this._panPixelsAtSource)),n&&(o=this._zoomSign*(Math.log(e/t)/Math.LN2)*this.definition.halfWindowSize/this._rotatePixels)),this._zoomPixelFlow=0,this._panPixelFlow=0,this._rotatePixelFlow=0;const l=this.definition.desiredPixelFlow;if(i&&s&&n){const e=a+o+a*o;this._zoomPixelFlow=a*o/e*l,this._panPixelFlow=o/e*l,this._rotatePixelFlow=a/e*l}else if(i&&s){const e=1+a;this._zoomPixelFlow=a/e*l,this._panPixelFlow=1/e*l}else if(i&&n){const e=1+o;this._zoomPixelFlow=o/e*l,this._rotatePixelFlow=1/e*l}else if(s&&n){const e=this._panPixelsAtSource/this._rotatePixels,t=1+e;this._panPixelFlow=e/t*l,this._rotatePixelFlow=1/t*l}else s?this._panPixelFlow=l:i?this._zoomPixelFlow=l:n&&(this._rotatePixelFlow=l);this._time=n?this.rotateTime:i?this.zoomTime:s?this.panTime:(0,r.B)(0)}get rotateTime(){return this.definition.hasRotate?(0,r.B)(this._rotatePixels/this._rotatePixelFlow):(0,r.B)(0)}get zoomTime(){return this.definition.hasZoom?(0,r.B)(this._zoomSign*(Math.log(this.definition.compared.sourceZoom/this.definition.compared.targetZoom)/Math.LN2)*this.definition.halfWindowSize/this._zoomPixelFlow):(0,r.B)(0)}get panTime(){if(this.definition.hasPan){if(this.definition.hasZoom){const e=-1/(this._zoomSign*this.definition.halfWindowSize)*Math.LN2,t=e*this._panPixelsAtSource;return(0,r.B)(Math.log(t*(this._zoomPixelFlow/this._panPixelFlow)+1)/(e*this._zoomPixelFlow))}return(0,r.B)(this._panPixelsAtSource/this._panPixelFlow)}return(0,r.B)(0)}_interpolateComponentsZoom(e){if(0===e||1===e)return e;if(this.definition.hasZoom){const t=this.definition.compared.sourceZoom,i=this.definition.compared.targetZoom;return(t*(t/i)**-e-t)/(i-t)}return e}_interpolateComponentsPan(e){if(0===e||1===e)return e;if(this.definition.hasPan&&this.definition.hasZoom){const t=-1/(this._zoomSign*this.definition.halfWindowSize)*this._zoomPixelFlow;return 1/this._panPixelsAtSource*(this._panPixelFlow*(2**(t*e*this._time)-1))/(t*Math.LN2)}return e}_interpolateComponentsRotate(e){return e}interpolateComponentsAt(e,t){e=Math.min(Math.max(e,0),1);const i=this._interpolateComponentsZoom(e),r=this._interpolateComponentsPan(e),s=this._interpolateComponentsRotate(e);return t?(t.zoom=i,t.pan=r,t.rotate=s):t={zoom:i,pan:r,rotate:s},t}}function ja(e,t,i){const r=t-e.compared.sourceZoom,s=e.halfWindowPanAtZoom(r);return-e.halfWindowSize*(i.ascensionFactor*Math.LN2*e.compared.pan+s)*Math.log(e.compared.sourceZoom/t)/(e.desiredPixelFlow*Math.LN2*s)}function Ha(e,t,i){const r=1/t,s=Math.log(e.compared.sourceZoom*r),n=1/e.desiredPixelFlow,a=1/Math.LN2,o=t-e.compared.sourceZoom,l=1/o,c=(i.ascensionFactor*Math.LN2*e.compared.pan+e.halfWindowPanAtZoom(o))/e.halfWindowPanAtZoom(1);return e.halfWindowSize*r*n*a*l*c-e.halfWindowSize*s*n*a*l+e.halfWindowSize*s*n*a*c/(o*o)}function Wa(e,t,i){const r=t-e.compared.sourceZoom,s=1/r,n=1/t,a=Math.log(e.compared.sourceZoom*n),o=(i.ascensionFactor*Math.LN2*e.compared.pan+e.halfWindowPanAtZoom(r))/e.halfWindowPanAtZoom(1);return e.halfWindowSize*s*(-2*s*n*o+2*s*a+2*n-2*a*o/(r*r)-o/(t*t))/(e.desiredPixelFlow*Math.LN2)}function Qa(e,t){return-e.halfWindowSize*Math.log(e.compared.sourceZoom/t)/(e.desiredPixelFlow*Math.LN2)}function Za(e,t){return e.halfWindowSize/(t*e.desiredPixelFlow*Math.LN2)}function Ya(e,t){return-e.halfWindowSize/(t*t*e.desiredPixelFlow*Math.LN2)}function Xa(e,t,i){return e.halfWindowSize*(-e.halfWindowPanAtZoom(t)-i.descensionFactor*Math.LN2*e.compared.pan+e.halfWindowPanAtZoom(e.compared.targetZoom))*Math.log(t/e.compared.targetZoom)/(e.desiredPixelFlow*Math.LN2*e.halfWindowPanAtZoom(-t+e.compared.targetZoom))}function $a(e,t,i){const r=Math.log(t/e.compared.targetZoom),s=1/e.desiredPixelFlow,n=1/Math.LN2,a=-t+e.compared.targetZoom,o=1/a,l=(-e.halfWindowPanAtZoom(t)-i.descensionFactor*Math.LN2*e.compared.pan+e.halfWindowPanAtZoom(e.compared.targetZoom))/e.halfWindowPanAtZoom(1);return-e.halfWindowSize*r*s*n*o+e.halfWindowSize*r*s*n*l/(a*a)+e.halfWindowSize*s*n*o*l/t}function Ka(e,t,i){const r=t-e.compared.targetZoom,s=1/r,n=1/t,a=Math.log(t/e.compared.targetZoom),o=(e.halfWindowPanAtZoom(t)+i.descensionFactor*Math.LN2*e.compared.pan-e.halfWindowPanAtZoom(e.compared.targetZoom))/e.halfWindowPanAtZoom(1);return e.halfWindowSize*s*(-2*s*n*o-2*s*a+2*n+2*a*o/(r*r)-o/(t*t))/(e.desiredPixelFlow*Math.LN2)}function Ja(e,t){return e.halfWindowSize*Math.log(t/e.compared.targetZoom)/(e.desiredPixelFlow*Math.LN2)}function eo(e,t){return e.halfWindowSize/(t*e.desiredPixelFlow*Math.LN2)}function to(e,t){return-e.halfWindowSize/(t*t*e.desiredPixelFlow*Math.LN2)}class io extends class{constructor(){this.segments=[]}get time(){return this.segments.reduce(((e,t)=>(0,r.B)(e+t.time)),(0,r.B)(0))}interpolateComponentsAt(e,t){e=Math.min(Math.max(e,0),1),e*=this.time;let i=0,r=0;const s=this.definition;for(let n=0;n<this.segments.length;n++){const a=this.segments[n],o=a.definition;if(e<=a.time||n===this.segments.length-1){t=this.segmentInterpolateComponentsAt(a,e/a.time,t),s.hasPan?t.pan=(i+o.compared.pan*t.pan)/s.compared.pan:t.pan=1,s.hasRotate?t.rotate=(r+o.compared.rotate*t.rotate)/s.compared.rotate:t.rotate=1;const n=t.zoom*(o.compared.targetZoom-o.compared.sourceZoom)+o.compared.sourceZoom,l=this.segments[0].definition.compared.sourceZoom,c=this.segments[this.segments.length-1].definition.compared.targetZoom;return s.hasZoom?t.zoom=(n-l)/(c-l):t.zoom=1,t}e-=a.time,i+=o.compared.pan,r+=o.compared.rotate}}segmentInterpolateComponentsAt(e,t,i){return e.interpolateComponentsAt(t,i)}}{constructor(e,t){super(),this._preallocSegments=[new Na,new Na,new Na],this.update(e,t)}update(e,t){if(!e)return;this.definition?this.definition.copyFrom(e):this.definition=e.clone();let i=null;t&&t.apex&&(i=function(e,t){let i=function(e,t){const i=Math.max(e.compared.sourceZoom,e.compared.targetZoom),r=e.source.zoomAtPixelsPerPan(e.desiredPixelFlow/e.compared.pan)/2;return r<i?null!=t.maximumDistance?i+(t.maximumDistance-i)/2:1.5*i:t.maximumDistance?Math.min(t.maximumDistance,r):r}(e,t);const r={ascensionFactor:null!=t.ascensionFactor?t.ascensionFactor:.5,descensionFactor:null!=t.descensionFactor?t.descensionFactor:.5},s=0===r.ascensionFactor,n=0===r.descensionFactor,a=s?Qa:ja,o=s?Za:Ha,l=s?Ya:Wa,c=n?Ja:Xa,h=n?eo:$a,d=n?to:Ka,u=t=>a(e,t,r)+function(e,t,i){return-e.compared.pan*e.halfWindowSize*(i.ascensionFactor+i.descensionFactor-1)/(e.desiredPixelFlow*e.halfWindowPanAtZoom(t))}(e,t,r)+c(e,t,r),p=t=>o(e,t,r)+function(e,t,i){return e.compared.pan*e.halfWindowSize*(i.ascensionFactor+i.descensionFactor-1)/(e.desiredPixelFlow*e.halfWindowPanAtZoom(t*t))}(e,t,r)+h(e,t,r),m=t=>l(e,t,r)+function(e,t,i){return-2*e.compared.pan*e.halfWindowSize*(i.ascensionFactor+i.descensionFactor-1)/(e.desiredPixelFlow*e.halfWindowPanAtZoom(t*t*t))}(e,t,r)+d(e,t,r);let f=u(i);const g=function(e){const t=Math.LN2*e.compared.pan,i=e.compared.sourceZoom-e.compared.targetZoom,r=e.halfWindowPanAtZoom(i),s=e.halfWindowSize*Math.log(e.compared.sourceZoom/e.compared.targetZoom)/(e.desiredPixelFlow*Math.LN2*r);return e.compared.sourceZoom<=e.compared.targetZoom?s*(t-r):s*(t+r)}(e);let v;const y=t.maximumIterations||20,_=null!=t.maximumDistance?t.maximumDistance:1/0;for(v=0;v<y;v++){const t=1e-6,r=(p(i)+t)/m(i);if(isNaN(r)||i>=_&&r<0){if(!isFinite(_))return null;i=_,f=u(i);break}if(i-=r,i<e.compared.sourceZoom||i<e.compared.targetZoom)return null;const s=u(i);if(Math.abs(s-f)/f<=.005)break;f=s}return f>.7*g||i<e.compared.sourceZoom||i<e.compared.targetZoom?null:i}(e,t.apex)),this.segments.length=0,this._ascensionSegment=null,this._descensionSegment=null,null==i?this._updateWithoutApex():this._updateWithApex(i,t.apex)}segmentInterpolateComponentsAt(e,t,i){return i=e.interpolateComponentsAt(t,i),e===this._ascensionSegment?i.zoom=En(i.zoom):e===this._descensionSegment&&(i.zoom=Dn(i.zoom)),i}_updateWithApex(e,t){const[i,r,s]=this._preallocSegments,n=null!=t.ascensionFactor?t.ascensionFactor:.5,a=Math.min(1-n,null!=t.ascensionFactor?t.descensionFactor:.5),o=1-n-a;i.definition?i.definition.copyFrom(this.definition):i.definition=this.definition.clone(),i.definition.compared.targetZoom=e,i.definition.compared.pan=this.definition.compared.pan*n,i.definition.compared.rotate=this.definition.compared.rotate*n,i.update(),this._ascensionSegment=i,this.segments.push(i),o>0&&(r.definition?r.definition.copyFrom(this.definition):r.definition=this.definition.clone(),r.definition.copyFrom(this.definition),r.definition.compared.sourceZoom=e,r.definition.compared.targetZoom=e,r.definition.compared.pan=this.definition.compared.pan*o,r.definition.compared.rotate=this.definition.compared.rotate*o,r.update(),this.segments.push(r)),s.definition?s.definition.copyFrom(this.definition):s.definition=this.definition.clone(),s.definition.compared.sourceZoom=e,s.definition.compared.pan=this.definition.compared.pan*a,s.definition.compared.rotate=this.definition.compared.rotate*a,s.update(),this._descensionSegment=s,this.segments.push(s)}_updateWithoutApex(){const[e]=this._preallocSegments;e.update(this.definition),this.segments.push(e)}}const ro={zoom:0,pan:0,rotate:0};class so{constructor(e){this.createCamera=e,this._time=(0,r.w)(0),this.definition=new ka(e),this.path=new io}get time(){return this._time}update(e,t,i){this.definition.update(e,t,i),this.path.update(this.definition,i),this._time=this._applyTimeSettings((0,r.D)(this.path.time),i),this._easing=i.easing?i.easing:this._time>=1e3?Xn:Nn}cameraAt(e,t){t=t||this.createCamera(),e=Math.min(Math.max(0,e),1),e=this._normalizedEasing(e);const i=this.path.interpolateComponentsAt(e,ro);return t.interpolate(this.definition.source,this.definition.target,i),t}_normalizedEasing(e){const t=this._easing(0,this._time),i=this._easing(1,this._time);return(this._easing(e,this._time)-t)/(i-t)}_applyTimeSettings(e,t){const i=null!=t.speedFactor?t.speedFactor:1;null!=t.duration?e=t.duration:null!=t.speedFactor&&(e=(0,r.w)(e/i));const s=null!=t.minDuration?t.minDuration:Ba/i,n=null!=t.maxDuration?t.maxDuration:qa/i;return(0,r.w)(Math.min(Math.max(s,e),n))}}const no=(0,v.n)();class ao{constructor(e){this.currentTime=(0,r.w)(0),this._animation=new so((()=>new xa(e))),this._current=new xa(e)}get finished(){return this.currentTime>=this._animation.time}get time(){return this._animation.time}update(e,t,i){const s=this._animation.definition.source,n=this._animation.definition.target,a=(0,v.c)(no,t.center,e.center),o=(0,v.s)(a);o>=1e-5?(a[0]/=o,a[1]/=o,a[2]/=o):(a[0]=0,a[1]=1,a[0]=0),(0,v.h)(s.lookAtDirection,a),(0,v.h)(n.lookAtDirection,a),s.copyFromRenderCamera(e),n.copyFromRenderCamera(t),this._current.copyFrom(s),this._animation.update(s,n,i),this.currentTime=(0,r.w)(0),e.almostEquals(t)&&(this.currentTime=this._animation.time)}cameraAt(e,t){return this._animation.cameraAt(e,this._current),t=t||new Ia,this._current.copyToRenderCamera(t),t}step(e,t){return this.finished||(this.currentTime=(0,r.w)(this.currentTime+(0,r.D)(e)),this.currentTime>=this.time&&(this.currentTime=this.time)),this.cameraAt(this.currentTime/this.time,t)}}var oo;!function(e){e.Ready="ready",e.Rejected="rejected",e.Running="running",e.Stopped="stopped",e.Finished="finished"}(oo||(oo={}));let lo=class extends r.p{constructor(){super(...arguments),this.state=oo.Ready}get active(){return this.state===oo.Running}get isInteractive(){return!1}get canStop(){return!1}stopController(){return!!this.canStop&&(this.state=oo.Stopped,!0)}finishController(){this.state=oo.Finished}get steppingFinished(){return!1}};(0,r.e)([(0,d.y)({readOnly:!0})],lo.prototype,"active",null),(0,r.e)([(0,d.y)()],lo.prototype,"state",void 0),lo=(0,r.e)([(0,d.n)("esri.views.3d.state.controllers.CameraController")],lo);let co=class extends lo{get canStop(){return!0}set asyncResult(e){this._asyncResult&&(this._asyncResult.reject((0,h.m)()),this._asyncResult=null),this.state===oo.Finished||this.state===oo.Stopped?this.state===oo.Finished?e.resolve():e.reject((0,h.m)()):this._asyncResult=e}get asyncResult(){return this._asyncResult}onControllerStart(){this.state=oo.Running,(0,u.r)(this.viewAnimation)&&this.viewAnimation.when((()=>this.updateStateFromViewAnimation()),(()=>this.updateStateFromViewAnimation()))}updateStateFromViewAnimation(){!(0,u.r)(this.viewAnimation)||this.state!==oo.Ready&&this.state!==oo.Running||(this.viewAnimation.state===s.n.State.FINISHED?this.finish():this.viewAnimation.state===s.n.State.STOPPED&&(this.state=oo.Stopped))}onControllerEnd(){(0,u.r)(this.viewAnimation)&&!this.viewAnimation.done&&(this.state===oo.Finished?this.viewAnimation.finish():this.state===oo.Stopped&&this.viewAnimation.stop()),this._asyncResult&&(this.state===oo.Finished?this._asyncResult.resolve():this._asyncResult.reject((0,h.m)()))}finish(){this.finishController()}};co=(0,r.e)([(0,d.n)("esri.views.3d.state.controllers.AnimationController")],co);let ho=class extends co{constructor(e){super(e),this.view=null,this.mode="interaction",this.hasTarget=!1}get intersectionHelper(){return this.view.sceneIntersectionHelper}initialize(){this.animation=new ao(this.view.state.viewingMode),this.viewAnimation="interaction"===this.mode?null:new s.n}get isInteractive(){return"interaction"===this.mode}begin(e,t){this.hasTarget=!0;const i=this.animationSettings(t);uo.copyFrom(this.view.state.camera);const r=new sn(this.view.state.viewingMode);this.intersectionHelper.intersectRay(uo.ray,r,po)&&(uo.center=po),this.animation.update(uo,e,i),this.animation.finished&&this.finish()}finish(){this.animation.currentTime=this.animation.time,super.finish()}get steppingFinished(){return this.hasTarget&&this.animation.finished}stepController(e,t){this.hasTarget&&this.animation.step(e,t)}onControllerEnd(e){this.hasTarget&&(this.animation.cameraAt(this.animation.currentTime/this.animation.time,e),this.animation.currentTime=this.animation.time),super.onControllerEnd(e)}animationSettings(e={}){return{apex:{maximumDistance:this.view.state.constraints.clampAltitude(1/0)/6,ascensionFactor:void 0,descensionFactor:void 0},...e,easing:"string"==typeof e.easing?aa[e.easing]:e.easing}}};(0,r.e)([(0,d.y)({constructOnly:!0})],ho.prototype,"view",void 0),(0,r.e)([(0,d.y)({constructOnly:!0})],ho.prototype,"mode",void 0),ho=(0,r.e)([(0,d.n)("esri.views.3d.state.controllers.PointToPointAnimationController")],ho);const uo=new Ia,po=(0,v.n)();function mo(e=vo){return[e[0],e[1],e[2],e[3]]}function fo(e,t){return function(e,t,i,r,s=mo()){return s[0]=e,s[1]=t,s[2]=i,s[3]=r,s}(e[0],e[1],e[2],t,w.r.get())}function go(e,t,i=mo()){return(0,v._)(i,e,t),(0,v.j)(i,i),i[3]=(0,S.J)(e,t),i}const vo=[0,0,1,0];function yo(e,t,i=function(e){return{operations:e,value:e.create()}}(e)){return i.operations=e,e.copy(t,i.value),i}const _o=2**50;function xo(e,t,i,r){return e.operations.setAltitudeAt(e.value,t,i,r)}function bo(e,t,i){return e.operations.elevate(e.value,t,i.value)}const wo=(0,v.n)();function Co(e,t,i,r,s){return s[0]=(0,v.z)(e,t),s[1]=(0,v.z)(e,i),s[2]=(0,v.z)(e,r),s}function To(e,t,i,r,s){(0,v.h)(i,e),(0,v.h)(So,t),(0,v.j)(So,So),(0,v._)(r,So,i),(0,v._)(s,r,i)}const So=(0,v.n)();function Po(e,t,i=(0,S.x)()){return function(e,t,i=(0,S.x)()){const r=(0,f.p)((0,k.a)(w.c.get(),t));if(r[2]=0,!e.unprojectFromRenderScreen(r,i.origin))return null;const s=(0,f.p)((0,k.a)(w.c.get(),t));s[2]=1;const n=e.unprojectFromRenderScreen(s,w.c.get());return(0,u.t)(n)?null:((0,v.c)(i.direction,n,i.origin),i)}(e,e.screenToRender(t,(0,f.p)(w.c.get())),i)}function Ro(e,t,i=(0,S.x)()){return Ao(e,e.screenToRender(t,(0,f.p)(w.c.get())),i)}function Ao(e,t,i=(0,S.x)()){(0,v.h)(i.origin,e.eye);const r=(0,v.a)(w.c.get(),t[0],t[1],1),s=e.unprojectFromRenderScreen(r,w.c.get());return(0,u.t)(s)?null:((0,v.c)(i.direction,s,i.origin),i)}function Mo(e,t,i,r){const s=Ro(t,i,Oo);return(0,S.V)(e,s,r)}const Oo=(0,S.x)();function Do(e,t,i){return i[0]=t[0]/(e.fullWidth/e.pixelRatio),i[1]=t[1]/(e.fullHeight/e.pixelRatio),i}function Eo(e){for(;e>Math.PI;)e-=2*Math.PI;for(;e<-Math.PI;)e+=2*Math.PI;return e}function zo(e,t,i){const r=w.f.get();(0,C.r)(r),(0,C.f)(r,r,i[3],i),(0,v.c)(wl,e.eye,t),(0,v.I)(wl,wl,r),e.eye=(0,v.u)(wl,wl,t),(0,v.c)(wl,e.center,t),(0,v.I)(wl,wl,r),e.center=(0,v.u)(wl,wl,t),e.up=(0,v.I)(wl,e.up,r)}function Io(e,t,i,r){return Qe(e,Po(t,i,Rl),r)}function Lo(e,t,i,r){const s=w.c.get();let n=1-i;(0,v.c)(s,t,e.eye);const a=(0,v.s)(s);let o=a*(1-n);n>=0&&o<r&&(o=r,n=-(o-a)/a),Math.abs(a-o)<1e-6||((0,v.d)(s,s,n),e.eye=(0,v.u)(wl,e.eye,s),e.center=(0,v.y)(wl,e.center,t,n))}function Fo(e,t,i){t.getScreenCenter(Vo),Mo(e,t,Vo,wl)&&(t.center=wl);const r=t.distance,s=r*i;if(Math.abs(r-s)<1e-6)return;const n=(0,v.d)(w.c.get(),t.viewForward,s);t.eye=(0,v.c)(wl,t.center,n)}const Vo=(0,f.i)();function Uo(e,t){(0,v.a)(t,0,0,0);for(const i of e)(0,v.u)(t,t,i);(0,v.d)(t,t,1/e.length)}function Go(e,t,i,r){return Math.sin(e/(0,v.s)(t))*(i+r.radius)}function Bo(e,t,i,r){return Go(Math.PI/2,t,i,r)+(e-Math.PI/2)}var qo;!function(e){e[e.Vertical=0]="Vertical",e[e.Horizontal=1]="Horizontal"}(qo||(qo={}));const ko=(0,v.g)(6),No={Pole:.95,Angle:(0,v.g)(18),Tilt:45},jo=(0,v.g)(80);function Ho(e,t,i,r,s){const n=(0,v.n)(),a=(0,S._)();let o=!0,l=!0;return e.intersectScreen(i,n)?a[3]=(0,v.s)(n):(l=!1,t.aboveGround?a[3]=Math.max((0,v.s)(t.center),.9*s.radius):a[3]=(0,v.s)(t.eye)-t.relativeElevation,r?Yo(a,t,i,n):o=Mo(a,t,i,n)),{sphere:a,scenePickPoint:o?n:null,hasGeometryIntersection:l}}function Wo(e,t,i,r){return(0,v.s)(e.eye)-r.radius>3e4?qo.Horizontal:i?(Ro(e,t,Al),-(0,v.e)(e.relativeElevation)*(.5*Math.PI+(0,S.J)(e.eye,Al.direction))<ko?qo.Vertical:qo.Horizontal):qo.Vertical}function Qo(e,t,i){(0,v.c)(Zo,i,t),e.eye=(0,v.c)(wl,e.eye,Zo),e.center=(0,v.c)(wl,e.center,Zo)}const Zo=(0,v.n)();function Yo(e,t,i,r){const s=Ro(t,i,Rl);return!((0,u.t)(s)||((0,S.F)(e,s,Xo),(0,S.V)(e,s,r)?(0,v.D)(Xo,s.origin)<(0,v.D)(r,s.origin)&&((0,v.h)(r,Xo),1):((0,v.c)($o,t.eye,t.center),(0,v.j)($o,$o),Ie($o,-(0,v.z)((0,v.j)($o,$o),Xo),Ko),Qe(Ko,s,r),1)))}const Xo=(0,v.n)(),$o=(0,v.n)(),Ko=De();function Jo(e,t,i,r,n,a){let o;if((0,v._)(Sl,e,t),(0,v.c)(Cl,e,t),(0,v.s)(e)<=n||!r.aboveGround){(0,v._)(i,Cl,r.eye);const l=(0,v.z)(e,t)/((0,v.s)(e)*(0,v.s)(t)),c=Math.cos((0,v.o)(s.M.normalize((0,v.g)(a)),0,jo));o=-(0,v.x)(l)-Math.max(0,(0,v.s)(t)-n)/(c*n)}else(0,v.c)(el,r.eye,r.center),(0,v._)(i,Cl,el),o=-(0,v.s)(Cl)/n;return(0,v.j)(i,i),(0,v.d)(i,i,(0,v.s)(Sl)),o}const el=(0,v.n)();function tl(e,t,i,r){let n,a;const o=Math.cos((0,v.o)(s.M.normalize((0,v.g)(r)),0,jo));return n=t>i?-(t-i)/(o*i):t<-i?Math.PI-(t+i)/(o*i):(0,v.x)(t/i),a=e>i?-(e-i)/(o*i):e<-i?Math.PI-(e+i)/(o*i):(0,v.x)(e/i),(a-n)*i}function il(e,t,i,r,s,n,a,o,l,c){(0,v._)(Sl,e,t),To(n.up,n.eye,dl,ul,pl),To([0,0,1],n.eye,ll,cl,hl),(0,v.h)(i,cl),(0,v.h)(r,ll),(0,v.j)(i,i),(0,v.d)(i,i,(0,v.s)(Sl)),Co(e,(0,v.j)(ul,ul),(0,v.j)(pl,pl),(0,v.j)(dl,dl),ml),Co(t,ul,pl,dl,fl),function(e,t,i,r,s,n,a,o,l,c){const h=tl(e[2],t[2],a[3],l),d=c?tl(e[0],t[0],a[3],180):t[0]-e[0],u=Math.sin(o)*d-Math.cos(o)*h,p=Math.cos(o)*d+Math.sin(o)*h;(0,v.j)(wl,s);const m=c?u/Math.sqrt(Math.abs(a[3]**2-(0,v.z)(i,wl)**2)):u/a[3],f=p/Math.sqrt(Math.abs(a[3]**2-(0,v.z)(i,r)**2));(0,k.r)(n,m,f)}(ml,fl,e,ll,cl,s,a,o,l,c)}function rl(e,t,i,r,s,n,a){(0,C.r)(yl),(0,C.r)(_l),(0,C.r)(xl),(0,C.f)(yl,yl,s,r),(0,C.f)(_l,_l,a,n),(0,C.e)(xl,yl,_l),(0,v.c)(t,e,i),(0,v.I)(t,t,xl),(0,v.u)(t,t,i)}function sl(e,t,i,r,s,n){(0,C.r)(yl),(0,C.r)(_l),(0,C.r)(xl),(0,C.f)(yl,yl,r,i),(0,C.f)(_l,_l,n,s),(0,C.e)(xl,yl,_l),(0,v.c)(wl,e.eye,t),(0,v.I)(wl,wl,xl),e.eye=(0,v.u)(wl,wl,t),(0,v.c)(wl,e.center,t),(0,v.I)(wl,wl,xl),e.center=(0,v.u)(wl,wl,t),(0,v.c)(wl,e.up,t),(0,v.I)(wl,wl,xl),e.up=(0,v.u)(wl,wl,t)}function nl(e,t,i,r,s,n,a=No.Pole,o=No.Angle){const l=Math.abs(r)>Math.PI-o||Math.abs(r)<o,c=Math.abs(e[2])<i*a||Math.abs(t)>i;return!!(l&&c&&n.aboveGround&&s<No.Tilt)}function al(e,t,i,r,s,n){if(n)go(i,r,vl),zo(t,e,vl);else{const n=Jo(i,r,Pl,t,e[3],s);zo(t,e,fo(Pl,n))}}function ol(e,t,i,r,s,n,a){const o=a?20:1;let l,c;(0,v.h)(bl,r),Tl.copyFrom(t);for(let r=0;r<o&&(0,v.D)(i,bl)>1e-12&&(l=(0,v.D)(i,bl),il(i,bl,cl,ll,gl,Tl,e,s,n,a),sl(Tl,e,ll,gl[1],cl,gl[0]),rl(bl,bl,e,ll,gl[1],cl,gl[0]),c=(0,v.D)(i,bl),c<l||0===r);r++)t.copyFrom(Tl)}const ll=(0,v.n)(),cl=(0,v.n)(),hl=(0,v.n)(),dl=(0,v.n)(),ul=(0,v.n)(),pl=(0,v.n)(),ml=(0,v.n)(),fl=(0,v.n)(),gl=(0,N.n)(),vl=mo(),yl=(0,T.e)(),_l=(0,T.e)(),xl=(0,T.e)(),bl=(0,v.n)(),wl=(0,v.n)(),Cl=(0,v.n)(),Tl=new Ia,Sl=(0,v.n)(),Pl=(0,v.n)(),Rl={origin:(0,v.n)(),direction:(0,v.n)()},Al={origin:(0,v.n)(),direction:(0,v.n)()};let Ml=class extends ho{constructor(){super(...arguments),this.zoomLocation=(0,v.n)(),this.tmpCamera=new Ia,this.tmpViewDir=(0,v.n)(),this.tmpRayDir={origin:(0,v.n)(),direction:(0,v.n)()},this.targetOnSphere=(0,v.n)(),this.tmpCenter=(0,v.n)(),this.constraintOptions={selection:7,interactionType:1,interactionFactor:null,interactionStartCamera:new Ia,interactionDirection:null,tiltMode:0},this.sphere=(0,S._)()}initialize(){this.intersector=new sn(this.view.state.viewingMode)}zoomStep(e,t){if(!this.active)return;const i=this.view.state,{interactionStartCamera:r}=this.constraintOptions;this.animation.finished?r.copyFrom(i.camera):this.animation.cameraAt(1,r);let s=!1,n=!1;this.intersectionHelper.intersectScreen(t,this.zoomLocation)&&(s=e>0,n=!0),this.tmpCamera.copyFrom(i.camera),s?this.intersectionHelper.intersectRay(this.tmpCamera.ray,this.intersector,this.tmpCenter)&&(this.tmpCamera.center=this.tmpCenter):this.intersectionHelper.intersectRay(this.tmpCamera.ray,this.intersector,this.zoomLocation)?this.tmpCamera.center=this.zoomLocation:(0,v.h)(this.zoomLocation,this.tmpCamera.center),this.updateCamera(this.tmpCamera,e,this.zoomLocation,t,n),this.begin(this.tmpCamera)}animationSettings(){return{apex:null,duration:(0,r.w)(600),easing:Nn}}updateCamera(e,t,i,r,n){if(Wo(e,r,n,(0,x.p)(this.view.spatialReference))===qo.Horizontal||(0,u.c)("disable-feature:context-navigation")){let n=.6**t;this.sphere[3]=(0,v.s)(i),(0,v.c)(this.tmpViewDir,e.center,e.eye);const a=(0,v.s)(this.tmpViewDir);let o=a*n;if(n<=1&&o<4&&(o=4,n=o/a),Math.abs(a-o)<1e-6)return;const l=(0,v.s)(e.center);if(this.sphere[3]!==l){const t=this.sphere[3]+n*(l-this.sphere[3]);e.center=(0,v.d)(Ol,e.center,t/l)}(0,v.d)(this.tmpViewDir,this.tmpViewDir,-n),e.eye=(0,v.u)(Ol,e.center,this.tmpViewDir),oa(this.view,e,this.constraintOptions),(0,v.D)(i,e.center)>1e-12&&Mo(this.sphere,e,r,this.targetOnSphere)&&function(e,t,i,r,n,a,o){nl(i,(0,v.z)(t.up,i),e[3],-s.M.normalize((0,v.g)(n)),a,t,No.Pole,No.Angle)?ol(e,t,i,r,-s.M.normalize((0,v.g)(n)),a,true):al(e,t,i,r,a,true)}(this.sphere,e,i,this.targetOnSphere,this.view.camera.heading,this.view.camera.tilt)}else{let s=.6**Math.abs(t);const n=t>0?1:-1;let a;Ro(e,r,this.tmpRayDir),(0,v.j)(this.tmpRayDir.direction,this.tmpRayDir.direction),this.view.camera.position.hasZ&&(a=Math.abs(this.view.camera.position.z));let o=Math.max(12*a,20);const l=this.view._stage.renderView.getMinimalDepthForArea(r[0],r[1],this.view.state.camera,60);o=o>l?l:o,(0,v.d)(this.tmpRayDir.direction,this.tmpRayDir.direction,o),(0,v.u)(i,this.tmpRayDir.origin,this.tmpRayDir.direction);let c=o*s;if(t>0&&c<4&&(c=4,s=c/o),Math.abs(o-c)<1e-6)return;(0,v.d)(this.tmpRayDir.direction,this.tmpRayDir.direction,n*(1-s)),e.eye=(0,v.u)(Ol,e.eye,this.tmpRayDir.direction),e.center=(0,v.u)(Ol,e.center,this.tmpRayDir.direction)}mn(this.view,e)}};Ml=(0,r.e)([(0,d.n)("esri.views.3d.state.controllers.global.ZoomStepController")],Ml);const Ol=(0,v.n)();let Dl=class extends ho{constructor(){super(...arguments),this.zoomLocation=(0,v.n)(),this.tmpCamera=new Ia,this.tmpRayDir=(0,v.n)(),this.tmpCenter=(0,v.n)(),this.constraintOptions={selection:15,interactionType:1,interactionFactor:null,interactionStartCamera:new Ia,interactionDirection:null,tiltMode:0}}zoomStep(e,t){if(!this.active)return;const i=this.view.state,{interactionStartCamera:r}=this.constraintOptions;this.animation.finished?r.copyFrom(i.camera):this.animation.cameraAt(1,r),this.tmpCamera.copyFrom(i.camera);const s=new sn(this.view.state.viewingMode);e>0?(this.intersectionHelper.intersectScreenFreePointFallback(t,this.zoomLocation),this.intersectionHelper.intersectRay(this.tmpCamera.ray,s,this.tmpCenter)&&(this.tmpCamera.center=this.tmpCenter)):this.intersectionHelper.intersectRay(this.tmpCamera.ray,s,this.zoomLocation)?this.tmpCamera.center=this.zoomLocation:(0,v.h)(this.zoomLocation,this.tmpCamera.center);const n=.6**e;if(!(0,$.r)()){let e=this.view._stage.renderView.getMinimalDepthForArea(t[0],t[1],this.view.state.camera,60);const i=Math.max(14*Math.abs(this.view.camera.position.z),20);if(e=e?Math.min(e,i):i,e){const t=(0,v.n)();(0,v.c)(t,this.zoomLocation,this.tmpCamera.eye),e<(0,v.s)(t)&&((0,v.j)(t,t),(0,v.u)(this.zoomLocation,this.tmpCamera.eye,(0,v.d)(t,t,e)))}}this.updateCamera(this.tmpCamera,n,this.zoomLocation),this.begin(this.tmpCamera)}animationSettings(){return{apex:null,duration:(0,r.w)(600),easing:Nn}}updateCamera(e,t,i){(0,v.c)(this.tmpRayDir,i,e.eye);const r=(0,v.s)(this.tmpRayDir);let s=r*t;t<=1&&s<4&&(s=4,t=s/r),Math.abs(r-s)<1e-6||((0,v.d)(this.tmpRayDir,this.tmpRayDir,t),e.eye=(0,v.c)(El,i,this.tmpRayDir),e.center=(0,v.y)(El,e.center,i,1-t),oa(this.view,e,this.constraintOptions))}};Dl=(0,r.e)([(0,d.n)("esri.views.3d.state.controllers.local.ZoomStepController")],Dl);const El=(0,v.n)();class zl extends s.i{constructor(e,t){super(!0),this.view=e,this.registerIncoming("double-click",t,(e=>this.handleDoubleClick(e)))}handleDoubleClick(e){const t=e.data;if((0,s.c)(t,"primary")){const i=this.view.state.isGlobal?new Ml({view:this.view,mode:"animation"}):new Dl({view:this.view,mode:"animation"});this.view.state.switchCameraController(i),i.zoomStep(Math.log(.5)/Math.log(.6),(0,f.i)(t.x,t.y)),e.stopPropagation()}}}let Il=class extends lo{constructor(){super(...arguments),this.startCamera=new Ia,this.currentCamera=new Ia}get isInteractive(){return!0}stepController(e,t){t.copyViewFrom(this.currentCamera),this.currentCamera.copyFrom(t)}onControllerStart(e){this.state=oo.Running,this.startCamera.copyFrom(e),this.currentCamera.copyFrom(e)}onControllerEnd(e){e.copyViewFrom(this.currentCamera)}};Il=(0,r.e)([(0,d.n)("esri.views.3d.state.controllers.InteractiveController")],Il);let Ll=class extends Il{constructor(e){super(e),this.view=null,this.pivot=0,this.lastPoint=(0,N.n)(),this.tmpWorldUp=(0,v.n)(),this.tmpViewDir=(0,v.n)(),this.tmpRotCurPoint=(0,N.n)(),this.tmpTransf=(0,T.e)(),this.tmpAxis=(0,v.n)(),this.tmpPivotPoint=(0,v.n)(),this.pivotPos=(0,v.n)(),this.constraintOptions={selection:15,interactionType:2,interactionFactor:0,interactionStartCamera:null,interactionDirection:null,tiltMode:0}}get intersectionHelper(){return this.view.sceneIntersectionHelper}initialize(){this.rotScale=0===this.pivot?3:1.5}begin(e){if(this.active){switch(this.pivot){case 1:(0,v.h)(this.pivotPos,this.startCamera.eye),this.constraintOptions.interactionType=3,this.constraintOptions.tiltMode=1,this.constraintOptions.selection=0;break;case 0:this.intersectionHelper.intersectRayFreePointFallback(this.startCamera.ray,this.pivotPos)||(0,v.h)(this.pivotPos,this.startCamera.center),(0,u.c)("disable-feature:context-navigation")||this.constrainPivotPoint(e),this.startCamera.center=this.pivotPos,this.constraintOptions.interactionType=2,this.constraintOptions.tiltMode=0,this.constraintOptions.selection=11}this.constraintOptions.interactionStartCamera=this.startCamera,Do(this.startCamera,e,this.lastPoint)}}constrainPivotPoint(e){const t=this.startCamera,i=(0,v.n)();(0,v.c)(i,this.pivotPos,t.eye);let r=(0,v.s)(i);this.view.camera.position.hasZ&&(r=Math.min(r,7*Math.abs(this.view.camera.position.z)));const s=(0,x.p)(this.view.spatialReference),n=(0,f.i)(t.width/t.pixelRatio*.5,t.height/t.pixelRatio*.5),a=Wo(this.startCamera,n,!0,s);let o=this.view._stage.renderView.getMinimalDepthForArea(t.fullWidth/t.pixelRatio*.5,t.fullHeight/t.pixelRatio*.5,t,225,90),l=this.view._stage.renderView.getMinimalDepthForArea(e[0],e[1],t,90);void 0===o&&void 0===l||(o=void 0===o?l:o,l=void 0===l||a===qo.Horizontal?o:l,r=o>l?l:o),(0,v.j)(i,i),(0,v.h)(this.pivotPos,(0,v.u)(this.tmpPivotPoint,t.eye,(0,v.d)(this.tmpPivotPoint,i,r)))}update(e){if(this.active){switch(this.pivot){case 1:this.currentCamera.center=this.applyRotation(this.currentCamera,e,this.currentCamera.center,this.pivotPos);break;case 0:this.currentCamera.center=this.pivotPos,this.currentCamera.eye=this.applyRotation(this.currentCamera,e,this.currentCamera.eye,this.pivotPos)}oa(this.view,this.currentCamera,this.constraintOptions)}}end(){this.active&&this.finishController()}applyRotation(e,t,i,r){this.view.renderCoordsHelper.worldUpAtPosition(r,this.tmpWorldUp),Do(e,t,this.tmpRotCurPoint);let s=(this.lastPoint[1]-this.tmpRotCurPoint[1])*this.rotScale,n=(this.tmpRotCurPoint[0]-this.lastPoint[0])*this.rotScale;(0,v.c)(this.tmpViewDir,i,r);const a=(0,v.s)(this.tmpViewDir),o=(0,v.x)((0,v.z)(this.tmpViewDir,this.tmpWorldUp)/a);if(1===this.pivot){s*=-.5;const e=.5*Math.PI-o,t=.5*Math.PI*.99;s=e-Math.max(-t,Math.min(t,e+s))}return s=(0,v.o)(s+o,di.min,di.max)-o,(0,C.r)(this.tmpTransf),(0,v._)(this.tmpAxis,e.up,this.tmpViewDir),0===this.pivot&&(n=-n),(0,C.f)(this.tmpTransf,this.tmpTransf,n,this.tmpWorldUp),(0,C.f)(this.tmpTransf,this.tmpTransf,s,this.tmpAxis),(0,v.I)(this.tmpViewDir,this.tmpViewDir,this.tmpTransf),e.up=(0,v.I)(Fl,e.up,this.tmpTransf),(0,v.u)(Fl,r,this.tmpViewDir),(0,k.a)(this.lastPoint,this.tmpRotCurPoint),Fl}};(0,r.e)([(0,d.y)({constructOnly:!0})],Ll.prototype,"view",void 0),(0,r.e)([(0,d.y)()],Ll.prototype,"pivot",void 0),Ll=(0,r.e)([(0,d.n)("esri.views.3d.state.controllers.RotateController")],Ll);const Fl=(0,v.n)();class Vl extends s.i{constructor(e,t,i,r){super(!0),this.view=e,this.pointerAction=t,this.pivot=i,this.registerIncoming("drag",r,(e=>this.handleDrag(e)))}handleDrag(e){const t=e.data;if(t.pointers.size>1)return;if(!(0,s.N)(e.data,this.pointerAction))return;const i=(0,f.i)(t.center.x,t.center.y);switch(t.action){case"start":this.cameraController&&(this.cameraController.end(),this.cameraController=null),this.cameraController=new Ll({view:this.view,pivot:this.pivot}),this.view.state.switchCameraController(this.cameraController),this.cameraController.begin(i);break;case"update":this.cameraController&&this.cameraController.update(i);break;case"end":this.cameraController&&(this.cameraController.end(),this.cameraController=null)}e.stopPropagation()}}let Ul=class extends Il{constructor(e){super(e),this.view=null,this.pickPoint=(0,v.n)(),this.tmpP0=(0,N.n)(),this.panAxisAngle=mo(),this.tmpRayDir=(0,v.n)(),this.targetOnSphere=(0,v.n)(),this.tmpRay={origin:(0,v.n)(),direction:(0,v.n)()},this.dragBeginPoint=(0,f.i)(),this.normalizedAnchorPoint=(0,N.n)(),this.constraintOptions={selection:7,interactionType:1,interactionFactor:0,interactionStartCamera:null,interactionDirection:null,tiltMode:0},this.sphere=(0,S._)(),this.hasPickPoint=!1}get intersectionHelper(){return this.view.sceneIntersectionHelper}begin(e){if(!this.active)return;(0,k.a)(this.dragBeginPoint,e),Do(this.startCamera,e,this.normalizedAnchorPoint);const t=(0,x.p)(this.view.spatialReference),i=Ho(this.intersectionHelper,this.startCamera,e,!1,t);if(this.navMode=Wo(this.startCamera,e,i.hasGeometryIntersection,t),this.navMode===qo.Horizontal||(0,u.c)("disable-feature:context-navigation"))this.hasPickPoint=!!i.scenePickPoint,this.pickPoint=i.scenePickPoint,this.sphere=i.sphere;else{let t;Ro(this.startCamera,e,this.tmpRay),(0,v.j)(this.tmpRay.direction,this.tmpRay.direction),this.view.camera.position.hasZ&&(t=Math.abs(this.view.camera.position.z));let i=30*t;const r=this.view._stage.renderView.getMinimalDepthForArea(e[0],e[1],this.view.state.camera,70);i=i>r?r:i,this.hasPickPoint=!0,(0,v.d)(this.tmpRay.direction,this.tmpRay.direction,i),(0,v.u)(this.pickPoint,this.tmpRay.origin,this.tmpRay.direction)}this.constraintOptions.interactionStartCamera=this.startCamera}update(e){if(this.active){if(this.currentCamera.eye=this.startCamera.eye,this.currentCamera.center=this.startCamera.center,this.currentCamera.up=this.startCamera.up,this.navMode===qo.Horizontal||(0,u.c)("disable-feature:context-navigation")){(0,v.c)(this.tmpRayDir,this.currentCamera.center,this.currentCamera.eye);const t=(0,v.s)(this.tmpRayDir);Do(this.currentCamera,e,this.tmpP0);const i=12*(this.normalizedAnchorPoint[1]-this.tmpP0[1]);let r=t*2**i;const s=this.view.state.constraints.minimumPoiDistance;if(i<0&&r<s&&(r=s),Math.abs(t-r)<1e-6)return;if(this.hasPickPoint&&r<t){const e=1-(1-r/t)*(1-this.sphere[3]/(0,v.s)(this.currentCamera.center));this.currentCamera.center=(0,v.d)(Gl,this.currentCamera.center,e)}(0,v.d)(this.tmpRayDir,this.tmpRayDir,-r/t),this.currentCamera.eye=(0,v.u)(Gl,this.currentCamera.center,this.tmpRayDir),this.constraintOptions.interactionFactor=la(this.dragBeginPoint,e),oa(this.view,this.currentCamera,this.constraintOptions),this.hasPickPoint&&(Yo(this.sphere,this.currentCamera,this.dragBeginPoint,this.targetOnSphere),go(this.pickPoint,this.targetOnSphere,this.panAxisAngle),zo(this.currentCamera,this.sphere,this.panAxisAngle))}else{const t=(0,v.s)(this.tmpRay.direction);Do(this.currentCamera,e,this.tmpP0);const i=12*(this.normalizedAnchorPoint[1]-this.tmpP0[1]);let r=t*2**i;const s=this.view.state.constraints.minimumPoiDistance;if(i<0&&r<s&&(r=s),Math.abs(t-r)<1e-6)return;(0,v.d)(this.tmpRayDir,this.tmpRay.direction,1-r/t),this.currentCamera.eye=(0,v.u)(Gl,this.currentCamera.eye,this.tmpRayDir),this.currentCamera.center=(0,v.u)(Gl,this.currentCamera.center,this.tmpRayDir)}mn(this.view,this.currentCamera)}}end(){this.active&&this.finishController()}};(0,r.e)([(0,d.y)({constructOnly:!0})],Ul.prototype,"view",void 0),Ul=(0,r.e)([(0,d.n)("esri.views.3d.state.controllers.global.ZoomController")],Ul);const Gl=(0,v.n)();let Bl=class extends Il{constructor(e){super(e),this.view=null,this.tmpP=(0,v.n)(),this.tmpDir=(0,v.n)(),this.tmpN=(0,v.n)(),this.tmpP0=(0,N.n)(),this.tmpPoi=(0,v.n)(),this.tmpRayDir=(0,v.n)(),this.dragBeginPoint=(0,f.i)(),this.normalizedAnchorPoint=(0,N.n)(),this.constraintOptions={selection:15,interactionType:1,interactionFactor:0,interactionStartCamera:null,interactionDirection:(0,v.n)(),tiltMode:0},this.plane=De()}get intersectionHelper(){return this.view.sceneIntersectionHelper}begin(e){if(!this.active)return;let t;(0,k.a)(this.dragBeginPoint,e),Do(this.startCamera,e,this.normalizedAnchorPoint),this.intersectionHelper.intersectScreenFreePointFallback(e,this.tmpP),(0,v.c)(this.tmpDir,this.tmpP,this.startCamera.eye),(0,v.j)(this.tmpDir,this.tmpDir),this.view.camera.position.hasZ&&(t=Math.abs(this.view.camera.position.z));let i=30*t;const r=this.view._stage.renderView.getMinimalDepthForArea(e[0],e[1],this.view.state.camera,70);i=i>r?r:i,(0,v.d)(this.tmpDir,this.tmpDir,i),(0,v.u)(this.tmpP,this.startCamera.eye,this.tmpDir),(0,v.c)(this.tmpN,this.startCamera.eye,this.startCamera.center),(0,v.j)(this.tmpN,this.tmpN),this.tmpN[1]<0&&(0,v.E)(this.tmpN,this.tmpN),Le(this.tmpP,this.tmpN,this.plane),this.constraintOptions.interactionStartCamera=this.startCamera}update(e){if(!this.active)return;Io(this.plane,this.currentCamera,this.dragBeginPoint,this.tmpPoi)||(0,v.h)(this.tmpPoi,this.currentCamera.center),Do(this.currentCamera,e,this.tmpP0);let t=4*(this.tmpP0[1]-this.normalizedAnchorPoint[1]);(0,k.a)(this.normalizedAnchorPoint,this.tmpP0),(0,v.c)(this.tmpRayDir,this.tmpPoi,this.currentCamera.eye);const i=(0,v.s)(this.tmpRayDir);let r=i*(1-t);(0,v.h)(this.constraintOptions.interactionDirection,this.tmpRayDir),(0,v.d)(this.constraintOptions.interactionDirection,this.constraintOptions.interactionDirection,(0,v.e)(t)/i);const s=this.view.state.constraints.minimumPoiDistance;t>=0&&r<s&&(r=s,t=-(r-i)/i),Math.abs(i-r)<1e-6||((0,v.d)(this.tmpRayDir,this.tmpRayDir,t),this.currentCamera.eye=(0,v.u)(ql,this.currentCamera.eye,this.tmpRayDir),(0,v.y)(ql,this.currentCamera.center,this.tmpPoi,t),this.tmpPoi[2]>this.startCamera.center[2]?ql[2]=Math.max(this.startCamera.center[2],ql[2]):ql[2]=Math.min(this.startCamera.center[2],ql[2]),this.currentCamera.center=ql,this.constraintOptions.interactionFactor=la(this.dragBeginPoint,e),oa(this.view,this.currentCamera,this.constraintOptions))}end(){this.active&&this.finishController()}};(0,r.e)([(0,d.y)({constructOnly:!0})],Bl.prototype,"view",void 0),Bl=(0,r.e)([(0,d.n)("esri.views.3d.state.controllers.local.ZoomController")],Bl);const ql=(0,v.n)();class kl extends s.i{constructor(e,t,i){super(!0),this.view=e,this.pointerAction=t,this.registerIncoming("drag",i,(e=>this.handleDrag(e)))}handleDrag(e){const t=e.data;if(t.pointers.size>1)return;if(!(0,s.N)(e.data,this.pointerAction))return;const i=(0,f.i)(t.center.x,t.center.y);switch(t.action){case"start":this.cameraController&&(this.cameraController.end(),this.cameraController=null),this.view.state.isGlobal?this.cameraController=new Ul({view:this.view}):this.cameraController=new Bl({view:this.view}),this.view.state.switchCameraController(this.cameraController),this.cameraController.begin(i);break;case"update":this.cameraController&&this.cameraController.update(i);break;case"end":this.cameraController&&(this.cameraController.end(),this.cameraController=null)}e.stopPropagation()}}const Nl=(0,v.n)(),jl=(0,v.n)();function Hl(){return{direction:(0,v.n)(),up:(0,v.n)()}}function Wl(e,t,i,r,s){let n=(0,v.j)(Nl,e),a=(0,v.z)(n,r);const o=a>0;a=Math.abs(a),a>.99&&(a=Math.abs((0,v.z)(t,r)),a<.99?((0,v.h)(n,t),o&&(0,v.d)(n,n,-1)):n=null);let l=0;if(n){(0,v.d)(jl,r,(0,v.z)(r,n)),(0,v.c)(n,n,jl);const e=(0,v.z)(n,s)/((0,v.s)(n)*(0,v.s)(s));(0,v._)(jl,n,s),l=((0,v.z)(jl,r)>0?1:-1)*(0,v.N)((0,v.x)(e))}const c=(0,v.N)((0,v.x)(-(0,v.z)(r,e)/(0,v.s)(e)));return i?(i.heading=l,i.tilt=c,i):{heading:l,tilt:c}}const Ql=(0,v.i)(0,1,0),Zl=(0,v.i)(0,0,1),Yl=(0,T.e)(),Xl=(0,v.n)(),$l=(0,v.n)();function Kl(e,t,i,r=Hl()){(0,C.r)(Yl);const{direction:s,up:n}=r;return(0,C.m)(Yl,Yl,-(0,v.g)(t)),(0,C.b)(Yl,Yl,(0,v.g)(i)),(0,v.I)(s,Zl,Yl),(0,v.d)(s,s,-1),(0,v.I)(n,Ql,Yl),r}function Jl(e,t,i,r,s){const n=e.renderSpatialReference,a=e.map&&e.spatialReference||t.spatialReference;return(0,_.R)(t,Xl,n),(0,_.R)(t,$l,n),Xl[0]-=i/2,$l[0]+=i/2,Xl[1]-=r/2,$l[1]+=r/2,(0,_.w)(Xl,n,Xl,a),(0,_.w)($l,n,$l,a),s?(s.xmin=Xl[0],s.ymin=Xl[1],s.xmax=$l[0],s.ymax=$l[1],s.spatialReference=a):s=new A.M(Xl[0],Xl[1],$l[0],$l[1],a),s}var ec=Object.freeze({__proto__:null,headingTiltToDirectionUp:Kl,directionToHeadingTilt:function(e,t,i,r){return Wl(t,i,r,Zl,Ql)},eyeForCenterWithHeadingTilt:function(e,t,i,r){const s=Kl(0,i,r),n=(0,v.n)();return(0,v.d)(n,s.direction,-t),(0,v.u)(n,n,e),{up:s.up,eye:n,heading:i,tilt:r}},lookAtTiltToEyeTilt:function(e){return(0,v.N)(e)},eyeTiltToLookAtTilt:function(e){return(0,v.g)(e)},toExtent:Jl});const tc=(0,v.i)(0,0,1),ic=(0,v.j)((0,v.n)(),(0,v.i)(1,1,1)),rc=new s.Q(-180,180),sc=(0,T.e)(),nc=(0,v.n)(),ac=(0,v.n)();function oc(e,t,i,r=Hl()){(0,v._)(nc,e,tc),0===(0,v.z)(nc,nc)&&(0,v._)(nc,e,ic),(0,C.r)(sc),(0,C.f)(sc,sc,-(0,v.g)(t),e),(0,C.f)(sc,sc,-(0,v.g)(i),nc);const{up:s,direction:n}=r;return(0,v._)(s,nc,e),(0,v.j)(s,s),(0,v.I)(s,s,sc),(0,v.j)(n,e),(0,v.E)(n,n),(0,v.I)(n,n,sc),r}function lc(e){const t=e[1];e[1]=-e[2],e[2]=t}function cc(e,t){const i=oc(t,e.heading,e.tilt);return e.up=i.up,e}function hc(e,t,i,r,n){let a,o,l,c;const h=t.latitude,d=t.longitude,u=function(e,t,i){const r=t/i,s=(0,v.g)(e),n=Math.sin(r/2),a=Math.cos(s),o=2*(0,v.p)(Math.sqrt(n*n/(a*a)));return(0,v.N)(o)}(h,i,(0,x.p)(e.spatialReference).radius)/2;a=d-u,o=d+u;const p=(0,v.g)(h),m=(0,x.p)(e.spatialReference).radius,f=(1+Math.sin(p))/(1-Math.sin(p)),y=(f+1)*Math.tan(r/m/2),_=y*y;function b(e){const t=Math.PI/2;return(e=s.O.normalize(e,-t))>t&&(e=Math.PI-e),e}if(l=1.5*Math.PI-2*Math.atan(.5*(y+Math.sqrt(4*f+_))),c=l+r/m,l=b(l),c=b(c),c<l){const e=c;c=l,l=e}if(l=Math.max((0,v.N)(l),-90),c=Math.min((0,v.N)(c),90),o=rc.monotonic(a,o),o-a>180){const e=(o-a-180)/2;a+=e,o-=e}const w=e.spatialReference&&e.spatialReference.isGeographic?e.spatialReference:O.k.WGS84;return n?(n.xmin=a,n.ymin=l,n.xmax=o,n.ymax=c,n.spatialReference=w):n=new A.M(a,l,o,c,w),e.spatialReference&&e.spatialReference.isWebMercator&&(0,g.d)(n,!1,n),n}var dc=Object.freeze({__proto__:null,headingTiltToDirectionUp:oc,directionToHeadingTilt:function(e,t,i,r){const s=nc,n=ac;return(0,v.j)(s,e),(0,v._)(ac,s,tc),0===(0,v.z)(ac,ac)&&(0,v._)(ac,s,ic),(0,v._)(n,ac,s),Wl(t,i,r,s,n)},eyeForCenterWithHeadingTilt:function(e,t,i,r){const s={eye:(0,v.n)(),up:null,tilt:r,heading:i},n=nc;n[0]=e[0],n[1]=e[2],n[2]=-e[1];const a=t,o=(0,v.g)(i),l=(0,v.g)(r),c=Math.sin(o),h=Math.cos(o),d=Math.sin(l),u=Math.cos(l),p=(0,v.s)(n);let m;if(Math.abs(l)<1e-8)m=a+p;else{const e=p/d,t=(0,v.p)(a/e),i=Math.PI-l-t;m=e*Math.sin(i)}const f=u*a,g=a*a*(d*d),y=h*h*g,_=m-f,x=_*_,b=y*(y+x-n[1]*n[1]);if(b<0)return(0,v.d)(s.eye,n,m/p),s.tilt=0,s;const w=Math.sqrt(b),C=n[1]*_,T=y+x;let S;if(S=h>0?-w+C:w+C,Math.abs(T)<1e-8)return p<1e-8?(s.eye[0]=0,s.eye[1]=0,s.eye[2]=a):(0,v.d)(s.eye,n,m/p),s.tilt=0,lc(s.eye),cc(s,e);s.eye[1]=S/T;const P=c*c*g,R=d*a,A=h*R*s.eye[1],M=s.eye[1]*s.eye[1],O=1-M,D=Math.sqrt(O),E=y*M+P-2*A*D*_+O*x;return Math.abs(E)<1e-8?((0,v.d)(s.eye,n,m/p),s.tilt=0,lc(s.eye),cc(s,e)):(s.eye[0]=(O*(m*n[0]-f*n[0])-R*D*(n[0]*s.eye[1]*h+n[2]*c))/E,s.eye[2]=(O*(m*n[2]-f*n[2])-R*D*(n[2]*s.eye[1]*h-n[0]*c))/E,(0,v.d)(s.eye,s.eye,m),lc(s.eye),cc(s,e))},lookAtTiltToEyeTilt:function(e,t,i){const r=(0,v.s)(t),s=Math.sqrt(i*i+r*r-2*i*r*Math.cos(Math.PI-e)),n=(0,v.p)(i/(s/Math.sin(e)));return(0,v.N)(e-n)},eyeTiltToLookAtTilt:function(e,t,i){const r=(0,v.g)(e),s=(0,v.s)(t);return(0,v.p)(i/(s/Math.sin(r)))+r},toExtent:hc});function uc(e,t){return null!=e&&("2d"===t||("local"===t?!e.isGeographic:e.isWebMercator||e.isWGS84||4490===e.wkid||104971===e.wkid||104905===e.wkid||104903===e.wkid))}const pc=u.n.getLogger("esri.views.3d.support.cameraUtils"),mc=(0,v.n)(),fc=(0,v.n)(),gc={heading:0,tilt:0},vc=new g.b,yc=new s.Q(-20037508.342788905,20037508.342788905),_c=new s.Q(-180,180);function xc(e){return e.spatialReference||O.k.WGS84}function bc(e){return"global"===e.viewingMode?dc:ec}function wc(e,t){if((0,u.t)(t))return null;const i=e.renderSpatialReference,r=bc(e).headingTiltToDirectionUp,s=(0,v.n)();if(!(0,_.R)(t.position,s,i))return null;const n=r(s,t.heading,t.tilt);(0,v.d)(n.direction,n.direction,e.state.camera.distance),(0,v.u)(n.direction,n.direction,s);const a=on(e,s,n.direction,n.up);return a.fov=(0,v.g)(t.fov),a}const Cc=(0,v.n)();function Tc(e,t,i){const r=e.renderSpatialReference,n=Mc(e,t.eye,t.viewForward,t.up,gc);let a=xc(e);return(0,_.w)(t.eye,r,Cc,a)||(a=O.k.WGS84,(0,_.w)(t.eye,r,Cc,a)),(0,u.t)(i)?new s.R(new g.b(Cc,a),n.heading,n.tilt,(0,v.N)(t.fov)):(i.position.x=Cc[0],i.position.y=Cc[1],i.position.z=Cc[2],i.position.spatialReference=a,i.heading=n.heading,i.tilt=n.tilt,i.fov=(0,v.N)(t.fov),i)}function Sc(e,t,i){const r=e.state.camera,s=r.width/2/r.pixelRatio;return 1===e.renderCoordsHelper.viewingMode&&null!=i&&(t*=Math.cos((0,v.g)(i))),s/(96*39.37/(t/=e.renderCoordsHelper.unitInMeters))/Math.tan(r.fovX/2)}function Pc(e,t,i){const r=e.state.camera,s=t*Math.tan(r.fovX/2);let n=96*39.37/(r.width/2/r.pixelRatio/s);return 1===e.renderCoordsHelper.viewingMode&&(n/=Math.cos((0,v.g)(i))),n*=e.renderCoordsHelper.unitInMeters,n}function Rc(e,t,i,r,s,n){return Ac(e,t,Sc(e,i,t.latitude),r,s,n)}function Ac(e,t,i,r,s,n){if(qc(n)){const a=new Bc(n.signal);return Oc(e,r.heading,r.tilt,t,i,s,a),void a.resolver.promise.then((t=>{const i=Fc(e,t,r.fov);if(!(0,u.t)(i))return n.resolver.resolve(i);n.resolver.reject()}),(e=>n.resolver.reject(e)))}const a=Oc(e,r.heading,r.tilt,t,i,s);return Fc(e,a,r.fov,n)}function Mc(e,t,i,r,s){return bc(e).directionToHeadingTilt(t,i,r,s)}function Oc(e,t,i,r,s,n,a){const o=r&&r instanceof g.b?r:null;if(qc(a))return async function(e,t,i){const r=(0,v.n)();if(t)if(t instanceof g.b){if((0,_.R)(t,r,e.renderSpatialReference),null==t.z&&null!=e.basemapTerrain){const s=await e.elevationProvider.queryElevation(t.x,t.y,t.z,t.spatialReference,"ground",i);return(0,u.r)(s)&&e.renderCoordsHelper.setAltitude(r,s),r}}else(0,v.h)(r,t);else(0,v.h)(r,e.state.camera.center);return r}(e,r,a.signal).then((r=>{Dc(e,t,i,o,r,s,n,a)}),(e=>a.resolver.reject(e))),null;const l=function(e,t){const i=(0,v.n)();if(t&&t instanceof g.b){if((0,_.R)(t,i,e.renderSpatialReference),null==t.z&&null!=e.basemapTerrain){const r=Ht(e.elevationProvider,t);(0,u.r)(r)&&e.renderCoordsHelper.setAltitude(i,r)}}else(0,v.h)(i,t||e.state.camera.center);return i}(e,r);return Dc(e,t,i,o,l,s,n,a)}function Dc(e,t,i,r,s,n,a,o){if((0,u.t)(r)){const t=e.renderSpatialReference;if(r=(0,_.d)(s,t,xc(e)),(0,u.t)(r))return null}n=Math.max(n,e.state.constraints.minimumPoiDistance);const l=function(e,t,i,r,s,n){let a=0;return 1===n&&function(e,t,i){const r=e.pointsOfInterest.centerOnSurfaceFrequent.distance;if(Math.log(i/r)/Math.LN2>8)return!0;const s=e.renderSpatialReference,n=xc(e),a=(0,_.d)(t,s,n),o=(0,_.d)(e.pointsOfInterest.centerOnSurfaceFrequent.renderLocation,s,n);if((0,u.t)(a)||(0,u.t)(o))return!1;const l=Math.tan(.5*e.state.camera.fov)*r;return o.distance(a)/l>5}(e,r,s)?(t=0,a=function(e,t,i,r){const s=e.state.constraints.tilt(t);s.max=Math.min(s.max,.5*Math.PI);const n=s.min*(1-zc)+s.max*zc,a=Lc(e,r,t,i);return Math.min(a,n)}(e,s,i,r)):a=Lc(e,r,s,i),a=e.state.constraints.clampTilt(s,a),{heading:t,tilt:i=Ic(e,r,s,a)}}(e,t,i,s,n,a),c=(0,bc(e).eyeForCenterWithHeadingTilt)(s,n,l.heading,l.tilt);if(1===a&&"global"===e.viewingMode&&i>0){const l=()=>{const l=Ic(e,s,n,function(e,t,i,r){const s=e.state.constraints.tilt(t);let n=Lc(e,r,t,i);return n=Math.min(n,.5*Math.PI),s.min*(1-zc)+n*zc}(e,n,i,s));return Dc(e,t,l,r,s,n,a=i-l<1?0:1,o)},h=e.map.ground.navigationConstraint;if(!h||"stay-above"===h.type){if(function(e,t){return!!(e.basemapTerrain&&e.renderCoordsHelper.fromRenderCoords(t,vc,e.spatialReference)&&(0,u.q)(Ht(e.elevationProvider,vc),0)>vc.z-1)}(e,c.eye))return l();if(qc(o))return async function(e,t,i){if(!e.renderCoordsHelper.fromRenderCoords(t,vc,e.spatialReference))return!1;const r=await e.elevationProvider.queryElevation(vc.x,vc.y,vc.z,vc.spatialReference,"ground",i);return(0,u.q)(r,0)>vc.z-1}(e,c.eye,o.signal).then((e=>e?l():(o.resolver.resolve({eye:c.eye,up:c.up,center:(0,v.k)(s),heading:c.heading,tilt:c.tilt}),null))),null}}const h=!o||qc(o)?{center:(0,v.n)(),eye:(0,v.n)(),up:(0,v.n)(),tilt:0,heading:0}:o;return h.eye=c.eye,h.up=c.up,h.center=(0,v.k)(s),h.heading=c.heading,h.tilt=c.tilt,qc(o)&&o.resolver.resolve(h),h}function Ec(e,t,i,r,s,n=null){let a,o,l,c,h=0;if(null!=t.zmax&&null!=t.zmin&&(a=(t.zmax+t.zmin)/2,h=t.zmax-t.zmin),"global"===e.viewingMode){if(!uc(t.spatialReference,"global"))return qc(n)&&n.resolver.reject(),null;const e=new g.b(t.xmin,t.ymin,t.spatialReference),i=new g.b(t.xmax,t.ymax,t.spatialReference),r=t.spatialReference.isGeographic?_c:yc;o=new g.b(r.center(e.x,i.x),(i.y+e.y)/2,t.spatialReference),null!=a&&(o.z=a);const s=(0,x.p)(t.spatialReference),h=function(e,t,i){const r=t.spatialReference,s=(0,x.p)(r),n=new g.b(t.x,e.y,r),a=new g.b(i.x,e.y,r),o=new g.b(e.x,t.y,r),l=new g.b(e.x,i.y,r);return{lon:ts(s.radius,n,a),lat:ts(s.radius,o,l)}}(o,e,i);l=h.lon,c=h.lat,r.diff(e.x,i.x)>r.range/2&&(l+=s.halfCircumference),l=Math.min(l,s.halfCircumference),c=Math.min(c,s.halfCircumference)}else{const i=xc(e);l=t.xmax-t.xmin,c=t.ymax-t.ymin,o=new g.b({x:t.xmin+.5*l,y:t.ymin+.5*c,z:a,spatialReference:i})}const d=e.state.camera,p=1/Math.tan(d.fovX/2),m=1/Math.tan(d.fovY/2),f=1/Math.tan(d.fov/2),v=Math.max(.5*l*p,.5*c*m,.5*h*f)/1;if(qc(n)){const t=new Bc(n.signal);return Oc(e,i,r,o,v,s,t),void t.resolver.promise.then((t=>{const i=Fc(e,t,e.camera.fov);if(!(0,u.t)(i))return n.resolver.resolve(i);n.resolver.reject()}),(e=>n.resolver.reject(e)))}const y=Oc(e,i,r,o,v,s);return Fc(e,y,e.camera.fov,n)}const zc=.7;function Ic(e,t,i,r){return bc(e).lookAtTiltToEyeTilt(r,t,i)}function Lc(e,t,i,r){return bc(e).eyeTiltToLookAtTilt(r,t,i)}function Fc(e,t,i,r){if((0,u.t)(t))return null;const n=e.renderSpatialReference,a=(0,_.d)(t.eye,n,xc(e));return(0,u.t)(a)?null:(0,u.r)(r)?(r.position=a,r.heading=t.heading,r.tilt=t.tilt,r.fov=i,r):new s.R(a,t.heading,t.tilt,i)}function Vc(e,t){var i;const r=null==(i=e.basemapTerrain)?void 0:i.tilingScheme;if(r)return r.levelAtScale(t);pc.error("#scaleToZoom()","Cannot compute zoom from scale without a tiling scheme")}function Uc(e,t){var i;const r=null==(i=e.basemapTerrain)?void 0:i.tilingScheme;if(r)return r.scaleAtLevel(t);pc.error("#zoomToScale()","Cannot compute scale from zoom without a tiling scheme")}function Gc(e,t,i){const r=e.renderSpatialReference;let n,a;t||(t=e.state.camera);const o=O.k.WGS84;return t instanceof s.R?(n=t.position.latitude,(0,_.R)(t.position,mc,r),(0,_.R)(i,fc,r),a=(0,v.q)(mc,fc)):((0,_.w)(t.center,r,fc,o),n=fc[1],a=t.distance),Pc(e,a,n)}class Bc{constructor(e){this.signal=e,this.resolver=(0,h.D)()}}function qc(e){return e&&"resolver"in e}let kc=class extends Il{constructor(e){super(e),this.transformation={translation:[0,0,0],heading:0,tilt:0,zoom:0},this.keysButtonState=[0,0,0,0,0,0,0,0,0,0,0,0],this.tmpCamera=new Ia,this.constraintOptions={selection:15,interactionType:0,interactionStartCamera:new Ia,interactionFactor:0,interactionDirection:null,tiltMode:1}}handleEventGamepad(e){const t=(0,s.f)(e,this.view.navigation.gamepad,this.transformation);("end"===e.action||(0,s.s)(t))&&this.finishController()}activateDirection(e){this.keysButtonState[e]=1,(0,s.T)(this.keysButtonState,this.transformation)}deactivateDirection(e){this.keysButtonState[e]=0;const t=(0,s.T)(this.keysButtonState,this.transformation);(0,s.s)(t)&&this.finishController()}onControllerStart(e){this.filteredSurfaceElevation=this.view.pointsOfInterest.cameraOnSurface.location.z,this.headingStart=this.view.camera.heading,super.onControllerStart(e)}updateFilteredSurfaceElevation(e){const t=this.view.pointsOfInterest.cameraOnSurface.location.z;this.filteredSurfaceElevation+=1*(t-this.filteredSurfaceElevation)*e}stepController(e,t){this.updateStartHeading(),this.updateFilteredSurfaceElevation(e),this.currentCamera.copyViewFrom(t),this.updateCameraCenter(),this.constraintOptions.interactionStartCamera.copyFrom(this.currentCamera),this.calculateControlTransformation(e,this.currentCamera,Xc),this.applyDisabledMovementTypes(Xc),this.applyPan(Xc.pan),this.applyRotate(Xc.rotate),this.applyZoom(Xc.zoom),this.applyAscend(Xc.ascend),this.constraintOptions.interactionType=0,this.constraintOptions.selection=8,oa(this.view,this.currentCamera,this.constraintOptions),super.stepController(e,t)}updateStartHeading(){0!==this.transformation.heading&&(this.headingStart=this.view.camera.heading)}applyRotate(e){if(!e.enabled)return;const t=this.currentCamera;(0,v.c)($c,t.center,t.eye),(0,v.I)($c,$c,e.matrix),t.center=(0,v.u)($c,$c,t.eye),t.up=(0,v.I)($c,t.up,e.matrix),this.constraintOptions.interactionType=3,this.constraintOptions.selection=7,oa(this.view,t,this.constraintOptions)}applyPan(e,t=this.currentCamera){e.enabled&&(t.eye=(0,v.I)($c,t.eye,e.matrix),t.center=(0,v.I)($c,t.center,e.matrix),this.view.state.isGlobal&&(t.up=(0,v.I)($c,t.up,e.matrix)),this.constraintOptions.interactionType=4,this.constraintOptions.selection=15,oa(this.view,t,this.constraintOptions))}applyZoom(e){if(!e)return;const t=this.currentCamera.viewForward;this.currentCamera.eye=(0,v.u)($c,this.currentCamera.eye,(0,v.d)(w.c.get(),t,e)),(0,v.h)(Kc,t),(0,v.E)(Kc,Kc),this.constraintOptions.interactionDirection=Kc,this.constraintOptions.interactionType=1,this.constraintOptions.selection=7,oa(this.view,this.currentCamera,this.constraintOptions),this.constraintOptions.interactionDirection=null}applyAscend(e){if(!e)return;const t=this.view.renderCoordsHelper.worldUpAtPosition(this.currentCamera.eye,w.c.get());if(this.constraintOptions.interactionDirection=(0,v.h)(Kc,t),this.view.state.isGlobal){const t=(0,v.s)(this.currentCamera.eye),i=(t+e)/t;this.currentCamera.eye=(0,v.d)($c,this.currentCamera.eye,i),this.currentCamera.center=(0,v.d)($c,this.currentCamera.center,i)}else{const i=(0,v.d)(w.c.get(),t,e);this.currentCamera.eye=(0,v.u)($c,this.currentCamera.eye,i),this.currentCamera.center=(0,v.u)($c,this.currentCamera.center,i)}this.updateCameraCenter(),this.constraintOptions.interactionType=5,this.constraintOptions.selection=8,oa(this.view,this.currentCamera,this.constraintOptions)&&this.updateCameraCenter(),this.constraintOptions.selection=7,oa(this.view,this.currentCamera,this.constraintOptions),this.constraintOptions.interactionDirection=null}calculateControlTransformation(e,t,i){!function(e){e.zoom=0,e.ascend=0,e.pan.enabled=!1,(0,C.r)(e.pan.matrix),e.rotate.enabled=!1,(0,C.r)(e.rotate.matrix)}(i);const r=this.computeVelocities(e);this.view.state.isLocal?this.calculateControlTransformationLocal(r,t,i):this.calculateControlTransformationGlobal(r,t,i)}updateCameraCenter(){const e=this.view.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,t=this.view.renderCoordsHelper,i=this.currentCamera.ray;this.currentCamera.center=t.intersectManifoldClosestSilhouette(i,e,$c)}calculateControlTransformationLocal(e,t,i){const{viewRight:r,viewForward:s}=t,n=this.transformation,a=this.view.navigation.gamepad,o=(0,v.a)(w.c.get(),s[0],s[1],0);(0,v.j)(o,o);const l=n.translation[0]*e.pan;if(0!==l){const e=(0,v.d)(w.c.get(),r,l);(0,C.c)(i.pan.matrix,i.pan.matrix,e),i.pan.enabled=!0}switch(a.mode){case"pan":{const t=-n.translation[1]*e.pan;if(0!==t){const e=(0,v.d)(w.c.get(),o,t);(0,C.c)(i.pan.matrix,i.pan.matrix,e),i.pan.enabled=!0}i.zoom=n.zoom*e.zoom;break}case"zoom":i.zoom=(-n.translation[1]+n.zoom)*e.zoom;break;default:(0,Z.n)(a.mode)}const c=n.translation[2]*e.ascend;i.ascend=c;const h=-n.heading*e.rotate;0!==h&&((0,C.f)(i.rotate.matrix,i.rotate.matrix,h,this.view.renderCoordsHelper.worldUpAtPosition(t.eye,w.c.get())),i.rotate.enabled=!0);const d=n.tilt*e.rotate,u=vn(this.view.renderCoordsHelper,t.center,t.eye),p=(0,v.o)(u+d,di.min,di.max)-u;p&&((0,C.f)(i.rotate.matrix,i.rotate.matrix,p,r),i.rotate.enabled=!0)}calculateControlTransformationGlobal(e,t,i){const{eye:r,viewRight:n}=t,a=this.transformation,o=this.view.navigation.gamepad,l=(0,v._)(w.c.get(),n,r);(0,v.j)(l,l),(0,v.E)(l,l),function(e,t,i,r,n,a,o,l,c){nl(e.center,(0,v.z)(e.up,e.center),(0,v.s)(e.center),-s.M.normalize((0,v.g)(a)),o,t)?function(e,t,i,r,s,n){const{eye:a}=e;To([0,0,1],a,ll,cl,hl);const o=t.translation[0]*i.pan,l="zoom"===s.mode?0:t.translation[1]*i.pan,c=Math.max(Math.sqrt(Math.abs(1-(0,v.z)(e.center,ll)**2/(0,v.s)(e.center)**2)),.5),h=(Math.sin(n)*l+Math.cos(n)*o)/c,d=-Math.cos(n)*l+Math.sin(n)*o;switch((0,C.f)(r.pan.matrix,r.pan.matrix,h,ll),r.pan.enabled=!0,s.mode){case"pan":(0,C.f)(r.pan.matrix,r.pan.matrix,d,cl),r.pan.enabled=!0;break;case"zoom":r.zoom=-t.translation[1]*i.zoom}}(t,i,r,l,c,-s.M.normalize((0,v.g)(n))):function(e,t,i,r,s){const{eye:n,viewRight:a}=e,o=(0,v._)(w.c.get(),a,n),l=t.translation[0]*i.pan;switch(0!==l&&((0,C.f)(r.pan.matrix,r.pan.matrix,-l,o),r.pan.enabled=!0),s.mode){case"pan":{const e=t.translation[1]*i.pan;0!==e&&((0,C.f)(r.pan.matrix,r.pan.matrix,e,a),r.pan.enabled=!0);break}case"zoom":r.zoom=-t.translation[1]*i.zoom}}(t,i,r,l,c)}(this.startCamera,t,a,e,this.view.camera.heading,this.headingStart,this.view.camera.tilt,i,o),this.tmpCamera.copyFrom(this.currentCamera),this.applyPan(Xc.pan,this.tmpCamera);const c=this.view.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,h=a.translation[2]*e.ascend;i.ascend=h;const d=-a.heading*e.rotate;0!==d&&((0,C.f)(i.rotate.matrix,i.rotate.matrix,d,this.tmpCamera.eye),i.rotate.enabled=!0);const u=a.tilt*e.rotate,p=this.clampTiltDeltaGlobalToValidRange(u,t.ray,c);0!==p&&((0,C.f)(i.rotate.matrix,i.rotate.matrix,p,this.tmpCamera.viewRight),i.rotate.enabled=!0),i.zoom+=a.zoom*e.zoom}clampTiltDeltaGlobalToValidRange(e,t,i){const r=(0,x.p)(this.view.spatialReference),s=Go(di.min,t.origin,i,r);let n=0,a=0;const o=w.c.get();return this.view.renderCoordsHelper.intersectManifold(t,i,o)?(n=Go(vn(this.view.renderCoordsHelper,o,t.origin),t.origin,i,r),a=Go(di.max,t.origin,i,r)):((0,S.F)((0,S.E)(i+r.radius),t,o),n=Bo((0,v.x)(-(0,v.z)(t.direction,(0,v.j)(o,o))),t.origin,i,r),a=Bo(di.max,t.origin,i,r)),(0,v.o)(n+e,s,a)-n}getPointAbsoluteSurfaceElevation(e,t,i){const{renderCoordsHelper:r}=this.view,s=r.getAltitude(e),n=t+Math.abs(s-t);return r.setAltitude(i,n,e),n}clampedDistanceToSurface(e,t){const{renderCoordsHelper:i}=this.view,{camera:r}=this.view.state,{direction:s}=function(e,t,i,r,s){return bc(e).headingTiltToDirectionUp(t,0,r,s)}(this.view,t,0,jc,Jc),n=i.intersectManifoldClosestSilhouette((0,S.g)(t,s),e,w.c.get()),a=(0,v.q)(t,n),o=i.intersectManifoldClosestSilhouette((0,S.g)(t,(0,v.H)(w.c.get(),t,r.center)),e,w.c.get()),l=(0,v.q)(t,o);return Math.min(a,l)}computeHeadingRotateRadius(e){const{renderCoordsHelper:t,state:i}=this.view,{camera:r,isGlobal:s}=i,n=t.intersectManifoldClosestSilhouette(r.ray,this.filteredSurfaceElevation,w.c.get());if(s){const t=(0,v.c)(w.c.get(),e,n),i=(0,v.s)(t);(0,v.d)(t,t,1/i);const r=(0,v.j)(w.c.get(),e),s=(0,v.x)((0,v.z)(r,t));return i*Math.sin(Math.min(Hc,s))}{const i=(0,v.h)(w.c.get(),e);return t.setAltitude(i,this.filteredSurfaceElevation),(0,v.q)(n,i)}}minimumAscendVelocity(){return this.view.state.constraints.collision.enabled?0:Qc}computeVelocities(e){const t=this.filteredSurfaceElevation,i=t+(0,x.p)(this.view.spatialReference).radius,{camera:r,isGlobal:s}=this.view.state,n=w.c.get(),a=this.getPointAbsoluteSurfaceElevation(r.eye,t,n),o=this.clampedDistanceToSurface(t,n),l=r.width/2,c=Wc*r.width,h=Wc*r.width,d=o*Math.tan(.5*r.fovX)/l,u=d/i,p=d/this.computeHeadingRotateRadius(n),m=a-t;return{pan:(s?u:d)*c*e,ascend:Math.max(this.minimumAscendVelocity()*e,2**(c*e/l)*m-m),zoom:2**(c*e/l)*o-o,rotate:(0,v.o)(p*h,Zc,Yc)*e}}applyDisabledMovementTypes(e){!(0,u.r)(this.disableMovements)||void 0!==this.disableMovements.mode&&this.view.state.viewingMode!==this.disableMovements.mode||(e.zoom=this.disableMovements.zoom?0:e.zoom,e.ascend=this.disableMovements.ascend?0:e.ascend,e.pan.enabled=!this.disableMovements.pan,this.disableMovements.pan&&(0,C.r)(e.pan.matrix),e.rotate.enabled=!this.disableMovements.rotate,this.disableMovements.rotate&&(0,C.r)(e.rotate.matrix))}static activatesFor(e,t){const i=(0,s.f)(t,e.navigation.gamepad,Nc);return!("end"===t.action||(0,s.s)(i))}};(0,r.e)([(0,d.y)({constructOnly:!0})],kc.prototype,"view",void 0),(0,r.e)([(0,d.y)({constructOnly:!0})],kc.prototype,"gamepadDevice",void 0),(0,r.e)([(0,d.y)({constructOnly:!0})],kc.prototype,"disableMovements",void 0),kc=(0,r.e)([(0,d.n)("esri.views.3d.state.controllers.GamepadKeyboardController")],kc);const Nc={translation:[0,0,0],heading:0,tilt:0,zoom:0},jc=80,Hc=(0,v.g)(jc),Wc=.75,Qc=5,Zc=(0,v.g)(30),Yc=(0,v.g)(80),Xc={zoom:0,ascend:0,pan:{enabled:!1,matrix:(0,T.e)()},rotate:{enabled:!1,matrix:(0,T.e)()}},$c=(0,v.n)(),Kc=(0,v.n)(),Jc=Hl();class eh extends s.i{constructor(e){super(!0),this.view=e,this.watchHandles=new R.u,this.handle=this.registerIncoming("gamepad",(e=>this.handleEventGamepad(e))),this.handle.pause()}onInstall(e){super.onInstall(e),this.watchHandles.add([(0,p.d)(this.view.navigation.gamepad,"enabled",(e=>{e?this.handle.resume():(this.handle.pause(),this.cameraControllerGamepad&&(this.cameraControllerGamepad.finishController(),this.cameraControllerGamepad=null))})),this.view.navigation.gamepad.watch("device",(e=>{this.cameraControllerGamepad&&e&&this.cameraControllerGamepad.gamepadDevice!==e&&(this.cameraControllerGamepad.finishController(),this.cameraControllerGamepad=null)}))])}onUninstall(){this.watchHandles.removeAll(),super.onUninstall()}handleEventGamepad(e){const t=this.view.navigation.gamepad.device;if(t&&e.data.device!==t)return;const i=this.cameraControllerGamepad&&this.cameraControllerGamepad.active;if(i||kc.activatesFor(this.view,e.data)){if(!i){const t=new kc({view:this.view,gamepadDevice:e.data.device});this.view.state.switchCameraController(t)&&(this.cameraControllerGamepad=t)}this.cameraControllerGamepad&&this.cameraControllerGamepad.active&&this.cameraControllerGamepad.gamepadDevice===e.data.device&&this.cameraControllerGamepad.handleEventGamepad(e.data)}}}class th extends s.i{constructor(e,t){super(!0),this.view=e,this.disableMovements={pan:!0,zoom:!1,ascend:!0,rotate:!1,mode:2},this.keyToNumber={[t.left]:0,[t.right]:1,[t.forward]:2,[t.backward]:3,[t.up]:4,[t.down]:5,[t.headingLeft]:6,[t.headingRight]:7,[t.tiltUp]:8,[t.tiltDown]:9,[t.zoomIn]:10,[t.zoomOut]:11},this.registerIncoming("key-down",null,(e=>this.handleKeyDown(e))),this.registerIncoming("key-up",null,(e=>this.handleKeyUp(e))),this.registerIncoming("blur",null,(()=>this.handleBlur()))}handleKeyDown(e){if(e.data.native.ctrlKey||e.data.native.metaKey)return;const t=this.keyToNumber[e.data.key];null!=t&&(this.cameraControllerKeyboard&&this.cameraControllerKeyboard.active||(this.cameraControllerKeyboard=new kc({view:this.view,disableMovements:this.disableMovements}),this.view.state.switchCameraController(this.cameraControllerKeyboard)),this.cameraControllerKeyboard.active&&(this.cameraControllerKeyboard.activateDirection(t),e.stopPropagation()))}handleBlur(){this.cameraControllerKeyboard&&this.cameraControllerKeyboard.active&&(this.cameraControllerKeyboard.finishController(),this.cameraControllerKeyboard=null)}handleKeyUp(e){if(e.data.native.ctrlKey||e.data.native.metaKey)return;const t=this.keyToNumber[e.data.key];null!=t&&this.cameraControllerKeyboard&&this.cameraControllerKeyboard.active&&(this.cameraControllerKeyboard.deactivateDirection(t),e.stopPropagation())}}class ih extends s.i{constructor(e,t){super(!0),this.view=e,this.registerIncoming("mouse-wheel",t,(e=>this.handleMouseWheel(e)))}handleMouseWheel(e){if(!this.view.navigation.mouseWheelZoomEnabled)return;const t=e.data;this.cameraController&&this.cameraController.active||(this.cameraController=this.view.state.isGlobal?new Ml({view:this.view,mode:"interaction"}):new Dl({view:this.view,mode:"interaction"}),this.view.state.switchCameraController(this.cameraController)),this.cameraController.zoomStep(-1/60*t.deltaY,(0,f.i)(t.x,t.y)),e.preventDefault(),e.stopPropagation()}}class rh{constructor(e){this._gain=e}reset(e){this._value=e}set gain(e){this._gain=e}get value(){return void 0===this._value?0:this._value}update(e){void 0===this._value?this._value=e:this._value=this._gain*e+(1-this._gain)*this._value}}let sh=class extends co{constructor(e){super(e),this.view=null,this.beginCamera=new Ia,this.elapsedTimeSec=0,this.constraintOptions={selection:15,interactionType:4,interactionFactor:0,interactionStartCamera:new Ia,interactionDirection:null,tiltMode:0}}initialize(){this.constraintOptions.interactionType=this.interactionType,this.viewAnimation=new s.n}get steppingFinished(){return this.momentum.isFinished(this.elapsedTimeSec)}onControllerStart(e){this.beginCamera.copyFrom(e),this.constraintOptions.interactionStartCamera=this.beginCamera,super.onControllerStart(e)}stepController(e,t){t.copyViewFrom(this.beginCamera),this.elapsedTimeSec+=e,this.momentumStep(this.elapsedTimeSec,t),oa(this.view,t,this.constraintOptions)}};(0,r.e)([(0,d.y)({constructOnly:!0})],sh.prototype,"view",void 0),sh=(0,r.e)([(0,d.n)("esri.views.3d.state.controllers.momentum.MomentumController")],sh);let nh=class extends sh{constructor(e){super(e),this.interactionType=4,this.tmpPan=(0,v.n)()}momentumStep(e,t){const i=this.momentum.value(e);(0,v.d)(this.tmpPan,this.momentum.direction,i),t.eye=(0,v.c)(ah,t.eye,this.tmpPan),t.center=(0,v.c)(ah,t.center,this.tmpPan),this.constraintOptions.interactionDirection=this.tmpPan}};(0,r.e)([(0,d.y)({constructOnly:!0})],nh.prototype,"momentum",void 0),nh=(0,r.e)([(0,d.n)("esri.views.3d.state.controllers.momentum.PanPlanarMomentumController")],nh);const ah=(0,v.n)(),oh=(0,v.n)(),lh=(0,v.n)();let ch=class extends sh{constructor(e){super(e),this.interactionType=4}momentumStep(e,t){const i=this.momentum.value1(e),r=this.momentum.value2(e);(0,v.h)(lh,t.eye),(0,v.j)(lh,lh),(0,v._)(this.momentum.axis2,lh,this.momentum.axis1),sl(t,oh,this.momentum.axis1,i,this.momentum.axis2,r)}};(0,r.e)([(0,d.y)({constructOnly:!0})],ch.prototype,"momentum",void 0),ch=(0,r.e)([(0,d.n)("esri.views.3d.state.controllers.momentum.PanSphericalMomentumController")],ch);let hh=class extends sh{constructor(e){super(e),this.interactionType=2}set center(e){this._set("center",(0,v.k)(e))}set axis(e){this._set("axis",(0,v.k)(e))}momentumStep(e,t){const i=this.momentum.value(e);zo(t,this.center,fo(this.axis,i))}};(0,r.e)([(0,d.y)({constructOnly:!0})],hh.prototype,"momentum",void 0),(0,r.e)([(0,d.y)({constructOnly:!0})],hh.prototype,"center",null),(0,r.e)([(0,d.y)({constructOnly:!0})],hh.prototype,"axis",null),hh=(0,r.e)([(0,d.n)("esri.views.3d.state.controllers.momentum.MomentumController")],hh);let dh=class extends sh{constructor(e){super(e),this.interactionType=1,this.constraintOptions.interactionDirection=(0,v.n)()}set zoomCenter(e){this._set("zoomCenter",(0,v.k)(e))}momentumStep(e,t){(0,v.h)(this.constraintOptions.interactionDirection,t.eye);const i=this.momentum.valueDelta(0,e);Lo(t,this.zoomCenter,i,this.view.state.constraints.minimumPoiDistance),this.constraintOptions.interactionDirection=(0,v.H)(this.constraintOptions.interactionDirection,t.eye,this.constraintOptions.interactionDirection)}};(0,r.e)([(0,d.y)({constructOnly:!0})],dh.prototype,"momentum",void 0),(0,r.e)([(0,d.y)({constructOnly:!0})],dh.prototype,"zoomCenter",null),dh=(0,r.e)([(0,d.n)("esri.views.3d.state.controllers.momentum.ZoomPlanarMomentumController")],dh);let uh=class extends sh{constructor(e){super(e),this.interactionType=1,this.radius=0,this.tmpSceneCenter=(0,v.n)(),this.tmpZoomAxisAngle=mo(),this.sphere=(0,S._)()}set screenCenter(e){this._set("screenCenter",(0,f.i)(e[0],e[1]))}set sceneCenter(e){this._set("sceneCenter",(0,v.k)(e))}initialize(){this.sphere[3]=this.radius}momentumStep(e,t){const i=this.momentum.valueDelta(0,e);Fo(this.sphere,t,i),this.constraintOptions.interactionType=1,oa(this.view,t,this.constraintOptions),Yo(this.sphere,t,this.screenCenter,this.tmpSceneCenter),go(this.sceneCenter,this.tmpSceneCenter,this.tmpZoomAxisAngle),zo(t,this.sphere,this.tmpZoomAxisAngle),this.constraintOptions.interactionType=4}};(0,r.e)([(0,d.y)({constructOnly:!0})],uh.prototype,"momentum",void 0),(0,r.e)([(0,d.y)({constructOnly:!0})],uh.prototype,"screenCenter",null),(0,r.e)([(0,d.y)({constructOnly:!0})],uh.prototype,"sceneCenter",null),(0,r.e)([(0,d.y)({constructOnly:!0})],uh.prototype,"radius",void 0),uh=(0,r.e)([(0,d.n)("esri.views.3d.state.controllers.momentum.ZoomSphericalMomentumController")],uh);class ph{constructor(e){this.gain=e}update(e){this.hasFilteredValue?this.filteredValue=(1-this.gain)*this.filteredValue+this.gain*e:this.filteredValue=e}reset(){this.filteredValue=void 0}get hasFilteredValue(){return void 0!==this.filteredValue}}const mh=1e-5;class fh extends K.a{constructor(e,t,i,r,s,n=0,a){super(e,t,i),this.angularVelocity1=r,this.axis1=s,this.angularVelocity2=n,this.axis2=a}value1(e){return super.valueFromInitialVelocity(this.angularVelocity1,e)}value2(e){return super.valueFromInitialVelocity(this.angularVelocity2,e)}}class gh{constructor(e=300,t=12,i=.84){this.minimumInitialVelocity=e,this.stopVelocity=t,this.friction=i,this.enabled=!0,this.tmpAxis1=(0,v.n)(),this.tmpAxis2=(0,v.n)(),this.tmpAngles=(0,N.n)(),this.time=new K.t(.3),this.screen=[new K.t(.4),new K.t(.4)],this.angle1=new ph(.6),this.angle2=new ph(.6),this.axis1=(0,v.n)(),this.axis2=(0,v.n)(),this.lastScene=(0,v.n)()}addMomentumDirectRotation(e,t,i,r,s,n){if(this.enabled){if(this.time.hasLastValue){if(this.time.computeDelta(i)<.01)return;let e=Jo(this.lastScene,t,this.tmpAxis2,r,s,n);this.angle2.update(0),(0,v.m)(this.tmpAxis2)<mh?e=0:(0,v.j)(this.axis1,this.tmpAxis2),this.angle1.update(e),(0,v.h)(this.lastScene,t)}this.screen[0].update(e[0]),this.screen[1].update(e[1]),this.time.update(i)}}addMomentumPreserveHeading(e,t,i,r,s,n,a){if(this.enabled){if(this.time.hasLastValue){if(this.time.computeDelta(i)<.01)return;il(this.lastScene,t,this.tmpAxis2,this.tmpAxis1,this.tmpAngles,r,s,n,a,!1),(0,v.m)(this.tmpAxis2)<mh?(this.angle1.update(0),this.angle2.update(0)):(this.angle1.update(this.tmpAngles[1]),this.angle2.update(this.tmpAngles[0]),(0,v.j)(this.axis1,this.tmpAxis1),(0,v.j)(this.axis2,this.tmpAxis2)),(0,v.h)(this.lastScene,t)}this.screen[0].update(e[0]),this.screen[1].update(e[1]),this.time.update(i)}}reset(){this.screen[0].reset(),this.screen[1].reset(),this.angle1.reset(),this.angle2.reset(),this.time.reset()}evaluateMomentum(){if(!this.enabled||!this.screen[0].hasFilteredDelta)return null;const e=this.screen[0].filteredDelta,t=this.screen[1].filteredDelta,i=Math.sqrt(e*e+t*t)/this.time.filteredDelta;return Math.abs(i)<this.minimumInitialVelocity?null:this.createMomentum(i,this.stopVelocity,this.friction)}createMomentum(e,t,i){const r=this.angle1.filteredValue/this.time.filteredDelta,s=this.angle2.filteredValue/this.time.filteredDelta;return new fh(e,t,i,r,this.axis1,s,this.axis2)}}let vh=class extends Il{constructor(e){super(e),this.view=null,this.smoothRotation=new rh(.05),this.rotationAxis=(0,v.n)(),this.panningPlane=De(),this.smoothScaling=new rh(.05),this.zoomCenterScreen=(0,f.i)(),this.zoomMomentumEstimator=new K.s,this.rotationMomentumEstimator=new K.b,this.panSphericalMomentumEstimator=new gh,this.panPlanarMomentumEstimator=new K.h,this.adjustedSphere=(0,S._)(),this.tmp3d=(0,v.n)(),this.tmpScreenPointArray=(0,f.i)(),this.beginScreenPoint=(0,f.i)(),this.beginScenePoint=(0,v.n)(),this.screenPickPoint=(0,f.i)(),this.navMode=qo.Horizontal,this.tmpInteractionDirection=(0,v.n)(),this.constraintOptions={selection:15,interactionType:0,interactionFactor:0,interactionStartCamera:new Ia,interactionDirection:null,tiltMode:0}}get intersectionHelper(){return this.view.sceneIntersectionHelper}begin(e){if(!this.active)return;const t=this.view.navigation.momentumEnabled;this.zoomMomentumEstimator.enabled=t,this.rotationMomentumEstimator.enabled=t,this.panPlanarMomentumEstimator.enabled=t,this.panSphericalMomentumEstimator.enabled=t,this.beginHeading=-s.M.normalize((0,v.g)(this.view.camera.heading)),this.beginRadius=e.radius,this.pointerCount=e.pointers.size,this.beginAngle=e.angle,this.smoothRotation.reset(),(0,f.d)(e.center,this.screenPickPoint),(0,k.a)(this.beginScreenPoint,this.screenPickPoint);const i=(0,x.p)(this.view.spatialReference),r=Ho(this.intersectionHelper,this.startCamera,this.screenPickPoint,!0,i);this.scenePickPoint=r.scenePickPoint,this.sphere=r.sphere,(0,v.h)(this.beginScenePoint,this.scenePickPoint),this.navMode=Wo(this.startCamera,this.screenPickPoint,r.hasGeometryIntersection,i),this.navMode===qo.Vertical&&this.preparePlanarPanMode(e),this.constraintOptions.interactionStartCamera.copyFrom(this.startCamera)}preparePlanarPanMode(e){const t=(0,v.E)(this.tmp3d,this.startCamera.viewForward);Le(this.scenePickPoint,t,this.panningPlane);const i=(0,f.i)(this.screenPickPoint[0],0),r=(0,v.n)(),s=(0,v.s)(this.startCamera.eye);this.adjustedSphere[3]=s<this.sphere[3]?s-100:this.sphere[3],Yo(this.adjustedSphere,this.startCamera,i,r);const n=(0,f.x)();this.startCamera.projectToRenderScreen(r,n);const a=.9*n[1];if(this.screenPickPoint[1]=Math.min(this.screenPickPoint[1],a),this.intersectionHelper.intersectScreen(this.screenPickPoint,this.scenePickPoint)&&Le(this.scenePickPoint,this.panningPlane,this.panningPlane),!(0,$.r)()){const e=(0,v.n)(),t=(0,v.n)(),i=(0,v.n)(),r=80,s=5,n=50;(0,v.c)(e,this.scenePickPoint,this.currentCamera.eye),(0,v.j)(e,e);const a=s*Math.max(Math.abs(this.view.camera.position.z),n),o=this.view._stage.renderView.getMinimalDepthForArea(this.screenPickPoint[0],this.screenPickPoint[1],this.view.state.camera,r),l=o?Math.min(o,a):a;(0,v.h)(i,(0,v.u)(t,this.currentCamera.eye,(0,v.d)(t,e,l))),this.panningPlane[3]=-(0,v.z)(this.panningPlane,i),this.startCamera.center=(0,v.u)(t,this.startCamera.eye,(0,v.d)(t,this.startCamera.viewForward,l))}const o=(0,f.d)(e.center,this.tmpScreenPointArray);Io(this.panningPlane,this.startCamera,o,this.beginScenePoint)}update(e){if(!this.active)return;this.currentCamera.copyFrom(this.startCamera);const t=e.pointers.size>1;this.navMode===qo.Horizontal?(t&&this.zoomSpherical(e),this.panningSpherical(e),t&&this.rotateSpherical(e)):(t&&this.zoomPlanar(e),this.panningPlanar(e),t&&this.rotatePlanar(e))}end(e){e.pointers.size===this.pointerCount&&this.update(e),this.finishController();const t=this.zoomMomentumEstimator.evaluateMomentum();if(t)return this.navMode===qo.Horizontal?new uh({view:this.view,momentum:t,screenCenter:this.zoomCenterScreen,sceneCenter:this.beginScenePoint,radius:this.sphere[3]}):new dh({view:this.view,momentum:t,zoomCenter:this.beginScenePoint});const i=this.rotationMomentumEstimator.evaluateMomentum();if(i)return new hh({view:this.view,momentum:i,center:this.sphere,axis:this.rotationAxis});if(this.navMode===qo.Horizontal){const e=this.panSphericalMomentumEstimator.evaluateMomentum();if(e)return new ch({view:this.view,momentum:e})}else{const e=this.panPlanarMomentumEstimator.evaluateMomentum();if(e)return new nh({view:this.view,momentum:e})}return null}zoomSpherical(e){const t=this.beginRadius/e.radius,i=.001875*Math.min(Math.max(e.radius,40),120);this.smoothScaling.gain=i,this.smoothScaling.update(t),Fo(this.sphere,this.currentCamera,this.smoothScaling.value),(0,f.d)(e.center,this.zoomCenterScreen),this.zoomMomentumEstimator.add(this.smoothScaling.value,.001*e.timestamp),this.constraintOptions.interactionType=1,this.constraintOptions.interactionFactor=la(e.radius-this.beginRadius),oa(this.view,this.currentCamera,this.constraintOptions)}panningSpherical(e){const t=(0,f.d)(e.center,this.tmpScreenPointArray);Yo(this.sphere,this.currentCamera,t,this.tmp3d),nl(this.beginScenePoint,(0,v.z)(this.currentCamera.up,this.beginScenePoint),this.sphere[3],this.beginHeading,this.view.camera.tilt,this.startCamera)?(ol(this.sphere,this.currentCamera,this.beginScenePoint,this.tmp3d,this.beginHeading,this.view.camera.tilt,!1),this.panSphericalMomentumEstimator.addMomentumPreserveHeading(t,this.tmp3d,.001*e.timestamp,this.startCamera,this.sphere,this.beginHeading,this.view.camera.tilt)):(al(this.sphere,this.currentCamera,this.beginScenePoint,this.tmp3d,this.view.camera.tilt,!1),this.panSphericalMomentumEstimator.addMomentumDirectRotation(t,this.tmp3d,.001*e.timestamp,this.startCamera,this.sphere[3],this.view.camera.tilt)),this.constraintOptions.interactionType=4,this.constraintOptions.interactionFactor=la(this.screenPickPoint,t),oa(this.view,this.currentCamera,this.constraintOptions)}rotateSpherical(e){(0,v.j)(this.rotationAxis,this.scenePickPoint),this.currentCamera.aboveGround||(0,v.E)(this.rotationAxis,this.rotationAxis);const t=this.smoothRotation.value,i=t+Eo(e.angle-t),r=.00125*Math.min(Math.max(e.radius,40),120);this.smoothRotation.gain=r,this.smoothRotation.update(i);const s=this.smoothRotation.value-this.beginAngle;this.rotationMomentumEstimator.add(s,.001*e.timestamp),zo(this.currentCamera,this.sphere,fo(this.rotationAxis,s)),this.constraintOptions.interactionType=2,this.constraintOptions.interactionFactor=la(e.radius*i),oa(this.view,this.currentCamera,this.constraintOptions)}panningPlanar(e){const t=(0,f.d)(e.center,this.tmpScreenPointArray);Io(this.panningPlane,this.currentCamera,t,this.tmp3d)&&(Qo(this.currentCamera,this.beginScenePoint,this.tmp3d),this.panPlanarMomentumEstimator.add(t,this.tmp3d,.001*e.timestamp),this.constraintOptions.interactionType=4,this.constraintOptions.interactionFactor=la(this.beginScreenPoint,t),this.constraintOptions.interactionDirection=this.view.renderCoordsHelper.worldUpAtPosition(this.currentCamera.eye,this.tmpInteractionDirection),oa(this.view,this.currentCamera,this.constraintOptions),this.constraintOptions.interactionDirection=null)}zoomPlanar(e){const t=this.beginRadius/e.radius,i=.001875*Math.min(Math.max(e.radius,40),120);this.smoothScaling.gain=i,this.smoothScaling.update(t),this.zoomMomentumEstimator.add(this.smoothScaling.value,.001*e.timestamp),Lo(this.currentCamera,this.beginScenePoint,this.smoothScaling.value,this.view.state.constraints.minimumPoiDistance),this.constraintOptions.interactionType=1,this.constraintOptions.interactionFactor=la(e.radius-this.beginRadius),oa(this.view,this.currentCamera,this.constraintOptions)}rotatePlanar(e){(0,v.h)(this.rotationAxis,this.beginScenePoint),this.currentCamera.aboveGround||(0,v.E)(this.rotationAxis,this.rotationAxis);const t=this.smoothRotation.value;let i=e.angle-t;i=Eo(i);const r=t+i,s=.00125*Math.min(Math.max(e.radius,40),120);this.smoothRotation.gain=s,this.smoothRotation.update(r);const n=this.smoothRotation.value-this.beginAngle;this.rotationMomentumEstimator.add(n,.001*e.timestamp),zo(this.currentCamera,this.sphere,fo(this.rotationAxis,n)),this.constraintOptions.interactionType=2,this.constraintOptions.interactionFactor=la(e.radius*n),oa(this.view,this.currentCamera,this.constraintOptions)}};(0,r.e)([(0,d.y)({constructOnly:!0})],vh.prototype,"view",void 0),vh=(0,r.e)([(0,d.n)("esri.views.3d.state.controllers.global.PinchAndPanController")],vh);const yh=(0,v.i)(0,0,1),_h=16/180*Math.PI;let xh=class extends Il{constructor(e){super(e),this.view=null,this.rotationValueSmooth=new rh(.05),this.scalingValueSmooth=new rh(.05),this.planeHorizontal=De(),this.planeVertical=De(),this.rotationMomentumEstimator=new K.b,this.panMomentumEstimator=new K.h(300,12,.9),this.zoomMomentumEstimator=new K.s,this.beginCenter=(0,v.n)(),this.tmpPoints=[],this.beginCenterScreen=(0,f.i)(),this.tmpCentroid3d=(0,v.n)(),this.tmpCentroid2d=(0,f.i)(),this.tmp2d=(0,f.i)(),this.constraintOptions={selection:15,interactionType:0,interactionFactor:0,interactionStartCamera:new Ia,interactionDirection:null,tiltMode:0}}get intersectionHelper(){return this.view.sceneIntersectionHelper}begin(e){if(!this.active)return;const t=this.view.navigation.momentumEnabled;this.zoomMomentumEstimator.enabled=t,this.rotationMomentumEstimator.enabled=t,this.panMomentumEstimator.enabled=t,this.beginRadius=e.radius,this.pointerCount=e.pointers.size,this.beginAngle=e.angle,this.rotationValueSmooth.reset(),this.scalingValueSmooth.reset(),(0,f.d)(e.center,this.beginCenterScreen),Ie(yh,0,this.planeHorizontal);const i=(0,v.n)();this.intersectionHelper.intersectScreenFreePointFallback(this.beginCenterScreen,i);const r=(0,v.n)();(0,v.E)(r,this.startCamera.viewForward);const s=(0,v.n)();(0,v.h)(s,yh);const n=(0,v.z)(r,s),a=(0,v.p)(n<0?-n:n);if(this.panMode=a>=_h?qo.Horizontal:qo.Vertical,je(this.planeHorizontal,i,this.planeHorizontal),this.startCamera.aboveGround||He(this.planeHorizontal,this.planeHorizontal),this.panMode===qo.Vertical){if((0,v.d)(s,s,n),(0,v.c)(this.planeVertical,r,s),(0,v.j)(this.planeVertical,this.planeVertical),je(this.planeVertical,i,this.planeVertical),!(0,$.r)()){const e=(0,v.n)(),t=(0,v.n)(),r=(0,v.n)();(0,v.c)(e,i,this.currentCamera.eye),(0,v.j)(e,e);const s=5*Math.max(Math.abs(this.view.camera.position.z),50),n=this.view._stage.renderView.getMinimalDepthForArea(this.beginCenterScreen[0],this.beginCenterScreen[1],this.view.state.camera,80),a=n?Math.min(n,s):s;(0,v.h)(r,(0,v.u)(t,this.currentCamera.eye,(0,v.d)(t,e,a))),this.planeVertical[3]=-(0,v.z)(this.planeVertical,r)}this.computePlanePoints(e.pointers,this.planeVertical,this.startCamera,this.tmpPoints),Uo(this.tmpPoints,this.beginCenter)}else this.computePlanePoints(e.pointers,this.planeHorizontal,this.startCamera,this.tmpPoints),Uo(this.tmpPoints,this.beginCenter);this.constraintOptions.interactionStartCamera.copyFrom(this.startCamera)}update(e){if(!this.active)return;this.currentCamera.copyFrom(this.startCamera);const t=e.pointers.size>1,i=this.panMode===qo.Horizontal?this.planeHorizontal:this.planeVertical,r=this.beginCenter;if(t){const t=this.beginRadius/e.radius,i=.001875*Math.min(Math.max(e.radius,40),120);this.scalingValueSmooth.gain=i,this.scalingValueSmooth.update(t),Lo(this.currentCamera,r,this.scalingValueSmooth.value,this.view.state.constraints.minimumPoiDistance),this.zoomMomentumEstimator.add(this.scalingValueSmooth.value,.001*e.timestamp),this.constraintOptions.interactionType=1,this.constraintOptions.interactionFactor=la(Math.abs(e.radius-this.beginRadius)),oa(this.view,this.currentCamera,this.constraintOptions)}if(this.computePlanePoints(e.pointers,i,this.currentCamera,this.tmpPoints),Uo(this.tmpPoints,this.tmpCentroid3d),(0,f.d)(e.center,this.tmpCentroid2d),Qo(this.currentCamera,r,this.tmpCentroid3d),this.panMomentumEstimator.add(this.tmpCentroid2d,this.tmpCentroid3d,.001*e.timestamp),this.constraintOptions.interactionType=4,this.constraintOptions.interactionFactor=la(this.beginCenterScreen,this.tmpCentroid2d),oa(this.view,this.currentCamera,this.constraintOptions),t){const t=this.planeHorizontal,i=r,s=this.rotationValueSmooth.value,n=s+Eo(e.angle-s),a=.00125*Math.min(Math.max(e.radius,40),120);this.rotationValueSmooth.gain=a,this.rotationValueSmooth.update(n);const o=this.rotationValueSmooth.value-this.beginAngle;this.rotationMomentumEstimator.add(o,.001*e.timestamp),zo(this.currentCamera,i,fo(t,o)),this.constraintOptions.interactionType=2,this.constraintOptions.interactionFactor=la(Math.abs(e.radius*o)),oa(this.view,this.currentCamera,this.constraintOptions)}}end(e){e.pointers.size===this.pointerCount&&this.update(e),this.finishController();const t=this.zoomMomentumEstimator.evaluateMomentum();if(t)return new dh({view:this.view,momentum:t,zoomCenter:this.beginCenter});const i=this.rotationMomentumEstimator.evaluateMomentum();if(i)return new hh({view:this.view,momentum:i,center:this.beginCenter,axis:this.planeHorizontal});const r=this.panMomentumEstimator.evaluateMomentum();return r?new nh({view:this.view,momentum:r}):null}computePlanePoints(e,t,i,r){r.length=e.size;const s=this.tmp2d;let n=0;return e.forEach((e=>{s[0]=e.x,s[1]=e.y,void 0===r[n]&&(r[n]=(0,v.n)()),Io(t,i,s,r[n]),n+=1})),r}};(0,r.e)([(0,d.y)({constructOnly:!0})],xh.prototype,"view",void 0),xh=(0,r.e)([(0,d.n)("esri.views.3d.state.controllers.local.PinchAndPanController")],xh);class bh extends s.i{constructor(e,t,i){super(!0),this.view=e,this.pointerAction=t,this.lastEndTimestamp=0,this.lastTimestamp=0,this.registerIncoming("drag",i,(e=>this.handleDrag(e)))}handleDrag(e){if("mouse"===e.data.pointerType&&!(0,s.N)(e.data,this.pointerAction))return;const t=e.timestamp-this.lastEndTimestamp,i=this.momentum&&this.momentum.active&&t<40;switch(e.data.action){case"start":case"update":if(i)break;this.controller&&this.controller.active?e.data.timestamp-this.lastTimestamp>2&&(this.controller.update(e.data),this.lastTimestamp=e.timestamp):this.startController(e);break;case"end":case"removed":this.endController(e,!0);break;case"added":this.endController(e,!1),this.startController(e)}e.stopPropagation()}endController(e,t){if(this.controller&&this.controller.active){this.lastEndTimestamp=e.timestamp;const i=this.controller.end(e.data);t&&i&&(this.momentum=i,this.view.state.switchCameraController(this.momentum))}this.controller=null}startController(e){this.controller=this.createController(),this.view.state.switchCameraController(this.controller),this.controller.begin(e.data),this.lastTimestamp=e.timestamp}createController(){return this.view.state.isGlobal?new vh({view:this.view}):new xh({view:this.view})}}class wh extends s.i{constructor(e,t){super(!0),this.view=e,this.registerIncoming("pointer-down",t,(()=>this.view.state.stopActiveCameraController()))}}class Ch extends s.i{constructor(e,t){super(!0),this.key=e,this.registerIncoming("key-down",t,(e=>this._handleKeyDown(e)))}_handleKeyDown(e){e.data.key===this.key&&(this.activate(),e.stopPropagation())}}class Th extends Ch{constructor(e,t,i){super(t,i),this.view=e,this.key=t}activate(){this.view.goTo({heading:0}).catch((()=>{}))}}class Sh extends Ch{constructor(e,t,i){super(t,i),this.view=e,this.key=t}activate(){this.view.goTo({tilt:0}).catch((()=>{}))}}class Ph extends s.i{constructor(e,t=!1){super(!0),this.view=e,this.invert=t,this.registerIncoming("vertical-two-finger-drag",(e=>this.handleTwoFinger(e)))}handleTwoFinger(e){var t,i,r;const s=this.invert?-1:1,n=(0,f.i)(0,e.data.delta*s);switch(e.data.action){case"begin":null==(t=this.cameraController)||t.end(),this.cameraController=new Ll({view:this.view,pivot:0}),this.view.state.switchCameraController(this.cameraController),this.cameraController.begin(n);break;case"update":null==(i=this.cameraController)||i.update(n);break;case"end":null==(r=this.cameraController)||r.end(),this.cameraController=null}}}class Rh extends s.i{constructor(e=20,t=40){super(!1),this._threshold=e,this._maxDelta=t,this.state="ready",this.emittedArtificalEnd2=!1,this._vertical=this.registerOutgoing("vertical-two-finger-drag"),this._artificalDrag=this.registerOutgoing("drag"),this.dragEventSeparator=new s.d({start:(e,t)=>this.observeStart(e,t),update:(e,t,i)=>this.observeUpdate(e,t,i),end:(e,t)=>this.observeEnd(t)}),this.registerIncoming("drag",(e=>this.dragEventSeparator.handle(e)))}get failed(){return"failed"===this.state}observeStart(e,t){1===e&&this.emittedArtificalEnd2&&(this.emittedArtificalEnd2=!1,this._artificalDrag.emit({action:"start",button:t.data.button,buttons:t.data.buttons,pointerType:t.data.pointerType,timestamp:t.data.timestamp,pointers:t.data.pointers,pointer:t.data.pointer,angle:t.data.angle,radius:t.data.radius,center:t.data.center}),t.stopPropagation()),this.state=2===e?"ready":"failed"}observeUpdate(e,t,i){if("failed"!==this.state&&2===e)return"active"===this.state?(this._vertical.emit({delta:t.data.center.y-this._thresholdReachedCenter.y,action:"update"}),void t.stopPropagation()):void(this.checkMovementWithinLimits(t.data,i.data)?this.checkVerticalThresholdReached(t.data,i.data)&&(this.state="active",this.emittedArtificalEnd2=!0,this._thresholdReachedCenter=t.data.center,this._artificalDrag.emit({action:"end",button:t.data.button,buttons:t.data.buttons,pointerType:t.data.pointerType,timestamp:t.data.timestamp,pointers:t.data.pointers,pointer:t.data.pointer,angle:t.data.angle,radius:t.data.radius,center:t.data.center}),this._vertical.emit({delta:t.data.center.y-this._thresholdReachedCenter.y,action:"begin"}),t.stopPropagation()):this.state="failed")}observeEnd(e){"active"===this.state&&(this._vertical.emit({delta:e.data.center.y-this._thresholdReachedCenter.y,action:"end"}),this.state="ready",e.stopPropagation())}checkMovementWithinLimits(e,t){let i=-1/0,r=1/0,s=-1/0,n=1/0;t.pointers.forEach((e=>{i=Math.max(i,e.x),r=Math.min(r,e.x),s=Math.max(s,e.y),n=Math.min(n,e.y)}));let a=-1/0,o=1/0,l=-1/0,c=1/0;e.pointers.forEach((e=>{a=Math.max(a,e.x),o=Math.min(o,e.x),l=Math.max(l,e.y),c=Math.min(c,e.y)}));const h=i-r,d=s-n,u=a-o,p=l-c;return Math.abs(e.center.x-t.center.x)<this._threshold&&Math.abs(u-h)<=this._maxDelta&&Math.abs(p-d)<=this._maxDelta}checkVerticalThresholdReached(e,t){let i=Math.abs(e.center.y-t.center.y);return e.pointers.forEach(((e,r)=>{const s=t.pointers.get(r);i=Math.min(i,Math.abs(e.y-s.y))})),i>=this._threshold}}let Ah=class extends r.p{constructor(){super(...arguments),this._handles=new R.u}destroy(){this._handles&&(this._handles.removeAll(),this._handles=null),this.disconnect()}get primaryDragAction(){return this._get("primaryDragAction")}set primaryDragAction(e){"pan"!==e&&"rotate"!==e||e===this._get("primaryDragAction")||(this._set("primaryDragAction",e),this._updateMode())}get mode(){return this._get("mode")}set mode(e){"default"!==e&&"pro"!==e||e===this._get("mode")||(this._set("mode",e),this._updateMode())}disconnect(){this.view.viewEvents.disconnect(),this._inputManager&&(this._inputManager.destroy(),this._inputManager=null),this._source&&(this._source.destroy(),this._source=null)}connect(){const e=this.view;this._source=new s.m(this.view.surface,e.input);const t=[new s.o,new s.p,new s.q,new s.r(this.view.navigation),new Rh],i=new s.v({eventSource:this._source,recognizers:t});this._inputManager=i,i.installHandlers("prevent-context-menu",[new s.x],s.y.INTERNAL),this._modeDragPan=new bh(e,"primary"),this._modeDragRotate=new Vl(e,"secondary",0),this._modeDragZoom=new kl(e,"tertiary");i.installHandlers("navigation",[new wh(e),new zl(e),new eh(e),new th(e,{left:"ArrowLeft",right:"ArrowRight",forward:"ArrowUp",backward:"ArrowDown",up:"u",down:"j",headingLeft:"a",headingRight:"d",tiltUp:"w",tiltDown:"s",zoomIn:"+",zoomOut:"-"}),new ih(e),new Sh(e,"p"),new Th(e,"n"),new Vl(e,"primary",1,["b"]),new Vl(e,"secondary",0,["b"]),new bh(e,"tertiary",["b"]),this._modeDragRotate,this._modeDragZoom,this._modeDragPan,new Ph(e)],s.y.INTERNAL),this.view.viewEvents.connect(i),this._updateMode(),(0,p.d)(this.view.navigation,"browserTouchPanEnabled",(e=>{this._source.browserTouchPanningEnabled=!e}))}_updateMode(){const e=this.mode,t=this.primaryDragAction,i=Mh.get(e).get(t);this._modeDragPan&&(this._modeDragPan.pointerAction=i.pan),this._modeDragRotate&&(this._modeDragRotate.pointerAction=i.rotate),this._modeDragZoom&&(this._modeDragZoom.pointerAction=i.zoom)}get test(){return{inputManager:this._inputManager,modeDragPan:this._modeDragPan,modeDragRotate:this._modeDragRotate,modeDragZoom:this._modeDragZoom}}};(0,r.e)([(0,d.y)()],Ah.prototype,"view",void 0),(0,r.e)([(0,d.y)({value:"pan"})],Ah.prototype,"primaryDragAction",null),(0,r.e)([(0,d.y)({value:"default"})],Ah.prototype,"mode",null),(0,r.e)([(0,d.y)({readOnly:!0,aliasOf:"_inputManager.hasPendingInputs"})],Ah.prototype,"hasPendingInputs",void 0),(0,r.e)([(0,d.y)({readOnly:!0,aliasOf:"_inputManager.latestPointerType"})],Ah.prototype,"latestPointerType",void 0),(0,r.e)([(0,d.y)()],Ah.prototype,"_inputManager",void 0),Ah=(0,r.e)([(0,d.n)("esri.views.3d.input.SceneInputManager")],Ah);const Mh=new Map,Oh=new Map,Dh=new Map;Oh.set("pan",{pan:"primary",rotate:"secondary",zoom:"tertiary"}),Oh.set("rotate",{pan:"secondary",rotate:"primary",zoom:"tertiary"}),Dh.set("pan",{pan:"primary",rotate:"tertiary",zoom:"secondary"}),Dh.set("rotate",{pan:"tertiary",rotate:"primary",zoom:"secondary"}),Mh.set("default",Oh),Mh.set("pro",Dh);var Eh=Ah;let zh=class extends r.p{constructor(){super(...arguments),this.SCENEVIEW_HITTEST_RETURN_INTERSECTOR=!1,this.SCENEVIEW_LOCKING_LOG=!1,this.HIGHLIGHTS_GRID_OPTIMIZATION_ENABLED=!0,this.HIGHLIGHTS_PROFILE_TO_CONSOLE=!1,this.DECONFLICTOR_SHOW_VISIBLE=!1,this.DECONFLICTOR_SHOW_INVISIBLE=!1,this.DECONFLICTOR_SHOW_GRID=!1,this.LABELS_SHOW_BORDER=!1,this.OVERLAY_DRAW_DEBUG_TEXTURE=!1,this.OVERLAY_SHOW_CENTER=!1,this.SHOW_POI=!1,this.TESTS_DISABLE_UPDATE_THRESHOLDS=!1,this.DISABLE_DECONFLICTOR_VISIBILITY_OFFSET=!1,this.DISABLE_ELEVATION_ALIGNERS_ITERATIVE_UPDATES=!1,this.DRAW_MESH_GEOMETRY_NORMALS=!1,this.FEATURE_TILE_FETCH_SHOW_TILES=!1,this.FEATURE_TILE_TREE_SHOW_TILES=!1,this.TERRAIN_TILE_TREE_SHOW_TILES=!1,this.I3S_TREE_SHOW_TILES=!1,this.I3S_SHOW_MODIFICATIONS=!1,this.ENABLE_PROFILE_DEPTH_RANGE=!1,this.DISABLE_FAST_UPDATES=!1,this.LOD_INSTANCE_RENDERER_DISABLE_UPDATES=!1,this.LOD_INSTANCE_RENDERER_COLORIZE_BY_LEVEL=!1,this.EDGES_SHOW_HIDDEN_TRANSPARENT_EDGES=!1}};(0,r.e)([(0,d.y)()],zh.prototype,"SCENEVIEW_HITTEST_RETURN_INTERSECTOR",void 0),(0,r.e)([(0,d.y)()],zh.prototype,"SCENEVIEW_LOCKING_LOG",void 0),(0,r.e)([(0,d.y)()],zh.prototype,"HIGHLIGHTS_GRID_OPTIMIZATION_ENABLED",void 0),(0,r.e)([(0,d.y)()],zh.prototype,"HIGHLIGHTS_PROFILE_TO_CONSOLE",void 0),(0,r.e)([(0,d.y)()],zh.prototype,"DECONFLICTOR_SHOW_VISIBLE",void 0),(0,r.e)([(0,d.y)()],zh.prototype,"DECONFLICTOR_SHOW_INVISIBLE",void 0),(0,r.e)([(0,d.y)()],zh.prototype,"DECONFLICTOR_SHOW_GRID",void 0),(0,r.e)([(0,d.y)()],zh.prototype,"LABELS_SHOW_BORDER",void 0),(0,r.e)([(0,d.y)()],zh.prototype,"OVERLAY_DRAW_DEBUG_TEXTURE",void 0),(0,r.e)([(0,d.y)()],zh.prototype,"OVERLAY_SHOW_CENTER",void 0),(0,r.e)([(0,d.y)()],zh.prototype,"SHOW_POI",void 0),(0,r.e)([(0,d.y)()],zh.prototype,"TESTS_DISABLE_UPDATE_THRESHOLDS",void 0),(0,r.e)([(0,d.y)()],zh.prototype,"DISABLE_DECONFLICTOR_VISIBILITY_OFFSET",void 0),(0,r.e)([(0,d.y)()],zh.prototype,"DISABLE_ELEVATION_ALIGNERS_ITERATIVE_UPDATES",void 0),(0,r.e)([(0,d.y)()],zh.prototype,"DRAW_MESH_GEOMETRY_NORMALS",void 0),(0,r.e)([(0,d.y)()],zh.prototype,"FEATURE_TILE_FETCH_SHOW_TILES",void 0),(0,r.e)([(0,d.y)()],zh.prototype,"FEATURE_TILE_TREE_SHOW_TILES",void 0),(0,r.e)([(0,d.y)()],zh.prototype,"TERRAIN_TILE_TREE_SHOW_TILES",void 0),(0,r.e)([(0,d.y)()],zh.prototype,"I3S_TREE_SHOW_TILES",void 0),(0,r.e)([(0,d.y)()],zh.prototype,"I3S_SHOW_MODIFICATIONS",void 0),(0,r.e)([(0,d.y)()],zh.prototype,"ENABLE_PROFILE_DEPTH_RANGE",void 0),(0,r.e)([(0,d.y)()],zh.prototype,"DISABLE_FAST_UPDATES",void 0),(0,r.e)([(0,d.y)()],zh.prototype,"LOD_INSTANCE_RENDERER_DISABLE_UPDATES",void 0),(0,r.e)([(0,d.y)()],zh.prototype,"LOD_INSTANCE_RENDERER_COLORIZE_BY_LEVEL",void 0),(0,r.e)([(0,d.y)()],zh.prototype,"EDGES_SHOW_HIDDEN_TRANSPARENT_EDGES",void 0),zh=(0,r.e)([(0,d.n)("esri.views.3d.support.DebugFlags")],zh);const Ih=new zh;let Lh,Fh,Vh=!1,Uh=!1,Gh=!1,Bh=!1,qh=null;function kh(){qh&&(qh(),qh=null)}function Nh(e,t,i,r,s){kh();const n=Lh.height,a=Fh;a.beginPath(),a.lineWidth=1,a.strokeStyle=s,a.moveTo(e,n-i),a.lineTo(t,n-i),a.stroke(),a.lineTo(t,n-r),a.stroke(),a.lineTo(t,n-i),a.stroke(),a.lineTo(e,n-i),a.stroke(),a.lineTo(e,n-i),a.stroke(),a.closePath()}function jh(e,t){Vh&&(t&&Gh||!t&&Bh)&&Nh(e.aabr[0],e.aabr[2],e.aabr[1],e.aabr[3],t?"green":"red")}function Hh(e,t){const i=e;i.include(S.K),i.attributes.add("position","vec3"),i.attributes.add("normal","vec3"),i.attributes.add("auxpos1","vec4"),i.vertex.uniforms.add("proj","mat4"),i.vertex.uniforms.add("view","mat4"),i.vertex.uniforms.add("viewNormal","mat4"),i.vertex.uniforms.add("viewport","vec4"),i.vertex.uniforms.add("camPos","vec3"),i.vertex.uniforms.add("polygonOffset","float"),i.vertex.uniforms.add("cameraGroundRelative","float"),i.vertex.uniforms.add("pixelRatio","float"),i.vertex.uniforms.add("perDistancePixelRatio","float"),i.vertex.uniforms.add("uRenderTransparentlyOccludedHUD","float"),t.verticalOffsetEnabled&&i.vertex.uniforms.add("verticalOffset","vec4"),t.screenSizePerspectiveEnabled&&i.vertex.uniforms.add("screenSizePerspectiveAlignment","vec4"),i.vertex.uniforms.add("hudVisibilityTexture","sampler2D"),i.vertex.constants.add("smallOffsetAngle","float",.984807753012208),i.vertex.code.add(S.t`struct ProjectHUDAux {
vec3 posModel;
vec3 posView;
vec3 vnormal;
float distanceToCamera;
float absCosAngle;
};`),i.vertex.code.add(S.t`float applyHUDViewDependentPolygonOffset(float pointGroundDistance, float absCosAngle, inout vec3 posView) {
float pointGroundSign = sign(pointGroundDistance);
if (pointGroundSign == 0.0) {
pointGroundSign = cameraGroundRelative;
}
float groundRelative = cameraGroundRelative * pointGroundSign;
if (polygonOffset > .0) {
float cosAlpha = clamp(absCosAngle, 0.01, 1.0);
float tanAlpha = sqrt(1.0 - cosAlpha * cosAlpha) / cosAlpha;
float factor = (1.0 - tanAlpha / viewport[2]);
if (groundRelative > 0.0) {
posView *= factor;
}
else {
posView /= factor;
}
}
return groundRelative;
}`),t.isDraped||i.vertex.code.add(S.t`void applyHUDVerticalGroundOffset(vec3 normalModel, inout vec3 posModel, inout vec3 posView) {
float distanceToCamera = length(posView);
float pixelOffset = distanceToCamera * perDistancePixelRatio * 0.5;
vec3 modelOffset = normalModel * cameraGroundRelative * pixelOffset;
vec3 viewOffset = (viewNormal * vec4(modelOffset, 1.0)).xyz;
posModel += modelOffset;
posView += viewOffset;
}`),i.vertex.code.add(S.t`
    vec4 projectPositionHUD(out ProjectHUDAux aux) {
      // centerOffset is in view space and is used to implement world size offsetting
      // of labels with respect to objects. It also pulls the label towards the viewer
      // so that the label is visible in front of the object.
      vec3 centerOffset = auxpos1.xyz;

      // The pointGroundDistance is the distance of the geometry to the ground and is
      // negative if the point is below the ground, or positive if the point is above
      // ground.
      float pointGroundDistance = auxpos1.w;

      aux.posModel = position;
      aux.posView = (view * vec4(aux.posModel, 1.0)).xyz;
      aux.vnormal = normal;
      ${t.isDraped?"":"applyHUDVerticalGroundOffset(aux.vnormal, aux.posModel, aux.posView);"}

      // Screen sized offset in world space, used for example for line callouts
      // Note: keep this implementation in sync with the CPU implementation, see
      //   - MaterialUtil.verticalOffsetAtDistance
      //   - HUDMaterial.applyVerticalOffsetTransformation

      aux.distanceToCamera = length(aux.posView);

      vec3 viewDirObjSpace = normalize(camPos - aux.posModel);
      float cosAngle = dot(aux.vnormal, viewDirObjSpace);

      aux.absCosAngle = abs(cosAngle);

      ${t.screenSizePerspectiveEnabled&&(t.verticalOffsetEnabled||1===t.screenCenterOffsetUnitsEnabled)?"vec4 perspectiveFactor = screenSizePerspectiveScaleFactor(aux.absCosAngle, aux.distanceToCamera, screenSizePerspectiveAlignment);":""}

      ${t.verticalOffsetEnabled?t.screenSizePerspectiveEnabled?"float verticalOffsetScreenHeight = applyScreenSizePerspectiveScaleFactorFloat(verticalOffset.x, perspectiveFactor);":"float verticalOffsetScreenHeight = verticalOffset.x;":""}

      ${t.verticalOffsetEnabled?S.t`
            float worldOffset = clamp(verticalOffsetScreenHeight * verticalOffset.y * aux.distanceToCamera, verticalOffset.z, verticalOffset.w);
            vec3 modelOffset = aux.vnormal * worldOffset;
            aux.posModel += modelOffset;
            vec3 viewOffset = (viewNormal * vec4(modelOffset, 1.0)).xyz;
            aux.posView += viewOffset;
            // Since we elevate the object, we need to take that into account
            // in the distance to ground
            pointGroundDistance += worldOffset;`:""}

      float groundRelative = applyHUDViewDependentPolygonOffset(pointGroundDistance, aux.absCosAngle, aux.posView);

      ${1!==t.screenCenterOffsetUnitsEnabled?S.t`
            // Apply x/y in view space, but z in screen space (i.e. along posView direction)
            aux.posView += vec3(centerOffset.x, centerOffset.y, 0.0);

            // Same material all have same z != 0.0 condition so should not lead to
            // branch fragmentation and will save a normalization if it's not needed
            if (centerOffset.z != 0.0) {
              aux.posView -= normalize(aux.posView) * centerOffset.z;
            }
          `:""}

      vec4 posProj = proj * vec4(aux.posView, 1.0);

      ${1===t.screenCenterOffsetUnitsEnabled?t.screenSizePerspectiveEnabled?"float centerOffsetY = applyScreenSizePerspectiveScaleFactorFloat(centerOffset.y, perspectiveFactor);":"float centerOffsetY = centerOffset.y;":""}

      ${1===t.screenCenterOffsetUnitsEnabled?"posProj.xy += vec2(centerOffset.x, centerOffsetY) * pixelRatio * 2.0 / viewport.zw * posProj.w;":""}

      // constant part of polygon offset emulation
      posProj.z -= groundRelative * polygonOffset * posProj.w;
      return posProj;
    }
  `),i.vertex.code.add(S.t`bool testVisibilityHUD(vec4 posProj) {
vec4 posProjCenter = alignToPixelCenter(posProj, viewport.zw);
vec4 occlusionPixel = texture2D(hudVisibilityTexture, .5 + .5 * posProjCenter.xy / posProjCenter.w);
if (uRenderTransparentlyOccludedHUD > 0.5) {
return occlusionPixel.r * occlusionPixel.g > 0.0 && occlusionPixel.g * uRenderTransparentlyOccludedHUD < 1.0;
}
return occlusionPixel.r * occlusionPixel.g > 0.0 && occlusionPixel.g == 1.0;
}`)}function Wh(e,t){e.setUniform1f("uRenderTransparentlyOccludedHUD",0===t.renderTransparentlyOccludedHUD?1:1===t.renderTransparentlyOccludedHUD?0:.75)}function Qh(e){e.include(S.L),e.uniforms.add("geometryDepthTexture","sampler2D"),e.uniforms.add("cameraNearFar","vec2"),e.code.add(S.t`bool geometryDepthTest(vec2 pos, float elementDepth) {
float geometryDepth = linearDepthFromTexture(geometryDepthTexture, pos, cameraNearFar);
return (elementDepth < (geometryDepth - 1.0));
}`)}function Zh(e,t){t.multipassGeometryEnabled&&t.geometryLinearDepthTexture&&e.bindTexture(t.geometryLinearDepthTexture,"geometryDepthTexture")}function Yh(e,t){t.multipassGeometryEnabled&&e.vertex.include(Qh),t.multipassTerrainEnabled&&e.varyings.add("depth","float"),e.vertex.code.add(S.t`
  void main(void) {
    vec4 posProjCenter;
    if (dot(position, position) > 0.0) {
      // Render single point to center of the pixel to avoid subpixel
      // filtering to affect the marker color
      ProjectHUDAux projectAux;
      vec4 posProj = projectPositionHUD(projectAux);
      posProjCenter = alignToPixelCenter(posProj, viewport.zw);

      ${t.multipassGeometryEnabled?S.t`
        // Don't draw vertices behind geometry
        if(geometryDepthTest(.5 + .5 * posProjCenter.xy / posProjCenter.w, projectAux.posView.z)){
          posProjCenter = vec4(1e038, 1e038, 1e038, 1.0);
        }`:""}

      ${t.multipassTerrainEnabled?"depth = projectAux.posView.z;":""}
      vec3 vpos = projectAux.posModel;
      if (rejectBySlice(vpos)) {
        // Project out of clip space
        posProjCenter = vec4(1e038, 1e038, 1e038, 1.0);
      }

    } else {
      // Project out of clip space
      posProjCenter = vec4(1e038, 1e038, 1e038, 1.0);
    }

    gl_Position = posProjCenter;
    gl_PointSize = 1.0;
  }
  `),t.multipassTerrainEnabled&&e.fragment.include(S.L),e.fragment.uniforms.add("terrainDepthTexture","sampler2D"),e.fragment.uniforms.add("cameraNearFar","vec2"),e.fragment.uniforms.add("inverseViewport","vec2"),e.fragment.include(S.M),e.fragment.code.add(S.t`
  void main() {
    gl_FragColor = vec4(1, 1, 1, 1);
    ${t.multipassTerrainEnabled?S.t`

          vec2 uv = gl_FragCoord.xy * inverseViewport;

          //Read the rgba data from the texture linear depth
          vec4 terrainDepthData = texture2D(terrainDepthTexture, uv);

          float terrainDepth = linearDepthFromFloat(rgba2float(terrainDepthData), cameraNearFar);

          //If HUD vertex is behind terrain and the terrain depth is not the initialize value (e.g. we are not looking at the sky)
          //Mark the HUD vertex as occluded by transparent terrain
          if(depth < terrainDepth && terrainDepthData != vec4(0,0,0,1)){
            gl_FragColor.g = 0.5;
          }`:""}
  }
  `)}function Xh(e){const t=new S.n,i=e.signedDistanceFieldEnabled;if(t.include(Gr),t.include(Hh,e),t.include(S.N,e),6===e.output)return t.include(Yh,e),t;t.include(S.K),t.fragment.include(S.M),t.fragment.include(S.j),t.include(S.P,e),t.varyings.add("vcolor","vec4"),t.varyings.add("vtc","vec2"),t.varyings.add("vsize","vec2"),e.binaryHighlightOcclusionEnabled&&t.varyings.add("voccluded","float"),t.vertex.uniforms.add("screenOffset","vec2").add("anchorPos","vec2").add("textureCoordinateScaleFactor","vec2").add("materialColor","vec4"),i&&t.vertex.uniforms.add("outlineColor","vec4"),e.screenSizePerspectiveEnabled&&t.vertex.uniforms.add("screenSizePerspective","vec4"),(e.debugDrawBorder||e.binaryHighlightOcclusionEnabled)&&t.varyings.add("debugBorderCoords","vec4"),t.attributes.add("uv0","vec2"),t.attributes.add("color","vec4"),t.attributes.add("size","vec2"),t.attributes.add("auxpos2","vec4"),t.vertex.code.add(S.t`
    void main(void) {
      ProjectHUDAux projectAux;
      vec4 posProj = projectPositionHUD(projectAux);

      if (rejectBySlice(projectAux.posModel)) {
        // Project outside of clip plane
        gl_Position = vec4(1e038, 1e038, 1e038, 1.0);
        return;
      }
      vec2 inputSize;
      ${e.screenSizePerspectiveEnabled?S.t`
      inputSize = screenSizePerspectiveScaleVec2(size, projectAux.absCosAngle, projectAux.distanceToCamera, screenSizePerspective);
      vec2 screenOffsetScaled = screenSizePerspectiveScaleVec2(screenOffset, projectAux.absCosAngle, projectAux.distanceToCamera, screenSizePerspectiveAlignment);
         `:S.t`
      inputSize = size;
      vec2 screenOffsetScaled = screenOffset;`}

      ${e.vvSize?"inputSize *= vvScale(auxpos2).xx;":""}

      vec2 combinedSize = inputSize * pixelRatio;
      vec4 quadOffset = vec4(0.0);

      ${e.occlusionTestEnabled||e.binaryHighlightOcclusionEnabled?"bool visible = testVisibilityHUD(posProj);":""}

      ${e.binaryHighlightOcclusionEnabled?"voccluded = visible ? 0.0 : 1.0;":""}
    `);const r=S.t`vec2 uv01 = floor(uv0);
vec2 uv = uv0 - uv01;
quadOffset.xy = ((uv01 - anchorPos) * 2.0 * combinedSize + screenOffsetScaled) / viewport.zw * posProj.w;`,s=e.pixelSnappingEnabled?i?S.t`posProj = alignToPixelOrigin(posProj, viewport.zw) + quadOffset;`:S.t`posProj += quadOffset;
if (inputSize.x == size.x) {
posProj = alignToPixelOrigin(posProj, viewport.zw);
}`:S.t`posProj += quadOffset;`;t.vertex.code.add(S.t`
      ${e.occlusionTestEnabled?"if (visible) {":""}
      ${r}
      ${e.vvColor?"vcolor = vvGetColor(auxpos2, vvColorValues, vvColorColors) * materialColor;":"vcolor = color / 255.0 * materialColor;"}

      bool alphaDiscard = vcolor.a < ${S.t.float(S.Q)};
      ${i?`alphaDiscard = alphaDiscard && outlineColor.a < ${S.t.float(S.Q)};`:""}
      if (alphaDiscard) {
        // "early discard" if both symbol color (= fill) and outline color (if applicable) are transparent
        gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
        return;
      } else {
        ${s}
        gl_Position = posProj;
      }

      vtc = uv * textureCoordinateScaleFactor;

      ${e.debugDrawBorder?"debugBorderCoords = vec4(uv01, 1.5 / combinedSize);":""}
      vsize = inputSize;
      ${e.occlusionTestEnabled?S.t`} else { vtc = vec2(0.0);
        ${e.debugDrawBorder?"debugBorderCoords = vec4(0.5, 0.5, 1.5 / combinedSize);}":"}"}`:""}
    }
    `),t.fragment.uniforms.add("tex","sampler2D"),i&&(t.fragment.uniforms.add("outlineColor","vec4"),t.fragment.uniforms.add("outlineSize","float"));const n=e.debugDrawBorder?S.t`(isBorder > 0.0 ? 0.0 : ${S.t.float(S.R)})`:S.t.float(S.R),a=S.t`
    ${e.debugDrawBorder?S.t`
      float isBorder = float(any(lessThan(debugBorderCoords.xy, debugBorderCoords.zw)) || any(greaterThan(debugBorderCoords.xy, 1.0 - debugBorderCoords.zw)));`:""}

    ${i?S.t`
      vec4 fillPixelColor = vcolor;

      // Attempt to sample texel centers to avoid that thin cross outlines
      // disappear with large symbol sizes.
      // see: https://devtopia.esri.com/WebGIS/arcgis-js-api/issues/7058#issuecomment-603041
      const float txSize = 128.0;
      const float texelSize = 1.0 / txSize;
      // Calculate how much we have to add/subtract to/from each texel to reach the size of an onscreen pixel
      vec2 scaleFactor = (vsize - txSize) * texelSize;
      vec2 samplePos = vtc + (vec2(1.0, -1.0) * texelSize) * scaleFactor;

      // Get distance and map it into [-0.5, 0.5]
      float d = rgba2float(texture2D(tex, samplePos)) - 0.5;

      // Distance in output units (i.e. pixels)
      float dist = d * vsize.x;

      // Create smooth transition from the icon into its outline
      float fillAlphaFactor = clamp(0.5 - dist, 0.0, 1.0);
      fillPixelColor.a *= fillAlphaFactor;

      if (outlineSize > 0.25) {
        vec4 outlinePixelColor = outlineColor;
        float clampedOutlineSize = min(outlineSize, 0.5*vsize.x);

        // Create smooth transition around outline
        float outlineAlphaFactor = clamp(0.5 - (abs(dist) - 0.5*clampedOutlineSize), 0.0, 1.0);
        outlinePixelColor.a *= outlineAlphaFactor;

        if (
          outlineAlphaFactor + fillAlphaFactor < ${n} ||
          fillPixelColor.a + outlinePixelColor.a < ${S.t.float(S.Q)}
        ) {
          discard;
        }

        // perform un-premultiplied over operator (see https://en.wikipedia.org/wiki/Alpha_compositing#Description)
        float compositeAlpha = outlinePixelColor.a + fillPixelColor.a * (1.0 - outlinePixelColor.a);
        vec3 compositeColor = vec3(outlinePixelColor) * outlinePixelColor.a +
          vec3(fillPixelColor) * fillPixelColor.a * (1.0 - outlinePixelColor.a);

        gl_FragColor = vec4(compositeColor, compositeAlpha);
      } else {
        if (fillAlphaFactor < ${n}) {
          discard;
        }

        gl_FragColor = premultiplyAlpha(fillPixelColor);
      }

      // visualize SDF:
      // gl_FragColor = vec4(clamp(-dist/vsize.x*2.0, 0.0, 1.0), clamp(dist/vsize.x*2.0, 0.0, 1.0), 0.0, 1.0);
      `:S.t`
          vec4 texColor = texture2D(tex, vtc, -0.5);
          if (texColor.a < ${n}) {
            discard;
          }
          gl_FragColor = texColor * premultiplyAlpha(vcolor);
          `}

    ${e.debugDrawBorder?S.t`gl_FragColor = mix(gl_FragColor, vec4(1.0, 0.0, 1.0, 1.0), isBorder);`:""}
  `;return 7===e.output&&t.fragment.code.add(S.t`
      void main() {
        ${a}
        gl_FragColor = vec4(gl_FragColor.a);
      }
      `),0===e.output&&t.fragment.code.add(S.t`
    void main() {
      ${a}
      ${e.FrontFacePass?"gl_FragColor.rgb /= gl_FragColor.a;":""}
    }
    `),4===e.output&&(t.include(S.S),t.fragment.code.add(S.t`
    void main() {
      ${a}
      ${e.binaryHighlightOcclusionEnabled?S.t`
          if (voccluded == 1.0) {
            gl_FragColor = vec4(1.0, 1.0, 0.0, 1.0);
          } else {
            gl_FragColor = vec4(1.0, 0.0, 1.0, 1.0);
          }`:"outputHighlight();"}
    }
    `)),t}function $h(e,t,i){e.setUniform4fv("materialColor",t.color),t.textureIsSignedDistanceField&&(t.outlineColor[3]<=0||t.outlineSize<=0?(e.setUniform4fv("outlineColor",w._),e.setUniform1f("outlineSize",0)):(e.setUniform4fv("outlineColor",t.outlineColor),e.setUniform1f("outlineSize",t.outlineSize))),e.setUniform2f("screenOffset",2*t.screenOffset[0]*i,2*t.screenOffset[1]*i),e.setUniform2fv("anchorPos",Kh(t))}function Kh(e,t=Jh){return e.textureIsSignedDistanceField?function(e,t,i){i[0]=e[0]*(t[2]-t[0])+t[0],i[1]=e[1]*(t[3]-t[1])+t[1]}(e.anchorPos,e.distanceFieldBoundingBox,t):(0,k.a)(t,e.anchorPos),t}const Jh=(0,N.n)();var ed=Object.freeze({__proto__:null,build:Xh,bindHUDMaterialUniforms:$h,calculateAnchorPosForRendering:Kh});class td extends S.c{initializeProgram(e){const t=td.shader.get(),i=this.configuration,r=t.build({output:i.output,FrontFacePass:2===i.transparencyPassType,viewingMode:e.viewingMode,occlusionTestEnabled:i.occlusionTestEnabled,signedDistanceFieldEnabled:i.sdf,slicePlaneEnabled:i.slicePlaneEnabled,sliceHighlightDisabled:!1,sliceEnabledForVertexPrograms:!0,debugDrawBorder:i.debugDrawBorder,binaryHighlightOcclusionEnabled:i.binaryHighlightOcclusion,screenCenterOffsetUnitsEnabled:i.screenCenterOffsetUnitsEnabled,screenSizePerspectiveEnabled:i.screenSizePerspective,verticalOffsetEnabled:i.verticalOffset,pixelSnappingEnabled:i.pixelSnappingEnabled,vvSize:i.vvSize,vvColor:i.vvColor,vvInstancingEnabled:!1,isDraped:i.isDraped,multipassGeometryEnabled:i.multipassGeometryEnabled,multipassTerrainEnabled:i.multipassTerrainEnabled,cullAboveGround:i.cullAboveGround});return new S.d(e.rctx,r,S.o)}bindPass(e,t){(0,S.h)(this.program,t.camera.projectionMatrix),this.program.setUniform1f("cameraGroundRelative",t.camera.aboveGround?1:-1),this.program.setUniform1f("perDistancePixelRatio",Math.tan(t.camera.fovY/2)/(t.camera.fullViewport[2]/2)),this.program.setUniformMatrix4fv("viewNormal",t.camera.viewInverseTransposeMatrix),this.program.setUniform1f("polygonOffset",e.shaderPolygonOffset),(0,S.U)(this.program,e,t),(0,S.W)(this.program,e),this.program.setUniform1f("pixelRatio",t.camera.pixelRatio||1),(0,S.X)(this.program,t),6===this.configuration.output?(this.program.setUniform2fv("cameraNearFar",t.camera.nearFar),this.program.setUniform2fv("inverseViewport",t.inverseViewport),Zh(this.program,t),(0,S.Y)(this.program,t)):(Wh(this.program,t),$h(this.program,e,t.camera.pixelRatio||1),(0,S.a0)(this.program,e),this.configuration.occlusionTestEnabled&&this.program.bindTexture(t.hudVisibilityTexture,"hudVisibilityTexture")),4===this.configuration.output&&(0,S.a1)(this.program,t)}bindDraw(e){(0,S.a2)(this.program,e),(0,S.a3)(this.program,e.origin,e.camera.viewInverseTransposeMatrix),(0,S.a4)(this.program,this.configuration,e),this.program.rebindTextures()}setPipelineState(e){const t=this.configuration,i=3===e,r=2===e,s=this.configuration.polygonOffsetEnabled&&id,n=(i||r)&&4!==t.output?(t.depthEnabled||6===t.output)&&V.l:null;return(0,V.g)({blending:0===t.output||7===t.output||4===t.output?i?rd:(0,S.a5)(e):null,depthTest:{func:515},depthWrite:n,colorWrite:V.r,polygonOffset:s})}initializePipeline(){return this.setPipelineState(this.configuration.transparencyPassType)}get primitiveType(){return 6===this.configuration.output?0:4}}td.shader=new S.f(ed,(()=>i.e(3851).then(i.bind(i,3851))));const id={factor:0,units:-4},rd=(0,V.t)(1,771);class sd extends S.b{constructor(){super(...arguments),this.output=0,this.occlusionTestEnabled=!0,this.sdf=!1,this.vvSize=!1,this.vvColor=!1,this.verticalOffset=!1,this.screenSizePerspective=!1,this.screenCenterOffsetUnitsEnabled=0,this.debugDrawBorder=!0,this.binaryHighlightOcclusion=!0,this.slicePlaneEnabled=!1,this.polygonOffsetEnabled=!1,this.depthEnabled=!0,this.transparencyPassType=3,this.pixelSnappingEnabled=!0,this.isDraped=!1,this.multipassGeometryEnabled=!1,this.multipassTerrainEnabled=!1,this.cullAboveGround=!1}}(0,r.e)([(0,S.a)({count:8})],sd.prototype,"output",void 0),(0,r.e)([(0,S.a)()],sd.prototype,"occlusionTestEnabled",void 0),(0,r.e)([(0,S.a)()],sd.prototype,"sdf",void 0),(0,r.e)([(0,S.a)()],sd.prototype,"vvSize",void 0),(0,r.e)([(0,S.a)()],sd.prototype,"vvColor",void 0),(0,r.e)([(0,S.a)()],sd.prototype,"verticalOffset",void 0),(0,r.e)([(0,S.a)()],sd.prototype,"screenSizePerspective",void 0),(0,r.e)([(0,S.a)({count:2})],sd.prototype,"screenCenterOffsetUnitsEnabled",void 0),(0,r.e)([(0,S.a)()],sd.prototype,"debugDrawBorder",void 0),(0,r.e)([(0,S.a)()],sd.prototype,"binaryHighlightOcclusion",void 0),(0,r.e)([(0,S.a)()],sd.prototype,"slicePlaneEnabled",void 0),(0,r.e)([(0,S.a)()],sd.prototype,"polygonOffsetEnabled",void 0),(0,r.e)([(0,S.a)()],sd.prototype,"depthEnabled",void 0),(0,r.e)([(0,S.a)({count:4})],sd.prototype,"transparencyPassType",void 0),(0,r.e)([(0,S.a)()],sd.prototype,"pixelSnappingEnabled",void 0),(0,r.e)([(0,S.a)()],sd.prototype,"isDraped",void 0),(0,r.e)([(0,S.a)()],sd.prototype,"multipassGeometryEnabled",void 0),(0,r.e)([(0,S.a)()],sd.prototype,"multipassTerrainEnabled",void 0),(0,r.e)([(0,S.a)()],sd.prototype,"cullAboveGround",void 0);class nd extends S.a6{constructor(e){super(e,Rd),this.techniqueConfig=new sd}getTechniqueConfig(e,t){return this.techniqueConfig.output=e,this.techniqueConfig.slicePlaneEnabled=this.params.slicePlaneEnabled,this.techniqueConfig.verticalOffset=!!this.params.verticalOffset,this.techniqueConfig.screenSizePerspective=!!this.params.screenSizePerspective,this.techniqueConfig.screenCenterOffsetUnitsEnabled="screen"===this.params.centerOffsetUnits?1:0,this.techniqueConfig.polygonOffsetEnabled=this.params.polygonOffset,this.techniqueConfig.isDraped=this.params.isDraped,this.techniqueConfig.occlusionTestEnabled=this.params.occlusionTest,this.techniqueConfig.pixelSnappingEnabled=this.params.pixelSnappingEnabled,this.techniqueConfig.sdf=this.params.textureIsSignedDistanceField,this.techniqueConfig.vvSize=!!this.params.vvSizeEnabled,this.techniqueConfig.vvColor=!!this.params.vvColorEnabled,0===e&&(this.techniqueConfig.debugDrawBorder=!!this.params.debugDrawBorder),4===e&&(this.techniqueConfig.binaryHighlightOcclusion=this.params.binaryHighlightOcclusion),this.techniqueConfig.depthEnabled=this.params.depthEnabled,this.techniqueConfig.transparencyPassType=t?t.transparencyPassType:3,this.techniqueConfig.multipassGeometryEnabled=!!t&&t.multipassGeometryEnabled,this.techniqueConfig.multipassTerrainEnabled=!!t&&t.multipassTerrainEnabled,this.techniqueConfig.cullAboveGround=!!t&&t.cullAboveGround,this.techniqueConfig}intersect(e,t,i,r,s,n,a,o,l){l?this.intersectDrapedHudGeometry(e,n,a,o):this.intersectHudGeometry(e,t,i,r,a,o)}intersectDrapedHudGeometry(e,t,i,r){const s=e.vertexAttributes.get("position"),n=e.vertexAttributes.get("size"),a=this.params,o=Kh(a);let l=1,c=1;if((0,u.r)(r)){const e=r(wd);l=e[0],c=e[5]}l*=e.screenToWorldRatio,c*=e.screenToWorldRatio;const h=Td*e.screenToWorldRatio;for(let r=0;r<s.data.length/s.size;r++){const d=r*s.size,u=s.data[d],p=s.data[d+1],m=r*n.size;let f;Sd[0]=n.data[m]*l,Sd[1]=n.data[m+1]*c,a.textureIsSignedDistanceField&&(f=a.outlineSize*e.screenToWorldRatio/2),cd(t,u,p,Sd,h,f,a,o)&&i()}}intersectHudGeometry(e,t,i,r,s,n){if(!r.options.selectionMode||!r.options.hud)return;if((0,S.C)(t))return;const a=this.params;let o=1,l=1;if((0,Y.a)(vd,i),(0,u.r)(n)){const e=n(wd);o=e[0],l=e[5],function(e){const t=e[0],i=e[1],r=e[2],s=e[3],n=e[4],a=e[5],o=e[6],l=e[7],c=e[8],h=1/Math.sqrt(t*t+i*i+r*r),d=1/Math.sqrt(s*s+n*n+a*a),u=1/Math.sqrt(o*o+l*l+c*c);e[0]=t*h,e[1]=i*h,e[2]=r*h,e[3]=s*d,e[4]=n*d,e[5]=a*d,e[6]=o*u,e[7]=l*u,e[8]=c*u}(vd)}const c=e.vertexAttributes.get("position"),h=e.vertexAttributes.get("size"),d=e.vertexAttributes.get("normal"),p=e.vertexAttributes.get("auxpos1");(0,S.i)(c.size>=3);const m=r.point,f=r.camera,g=Kh(a);o*=f.pixelRatio,l*=f.pixelRatio;const y="screen"===this.params.centerOffsetUnits;for(let e=0;e<c.data.length/c.size;e++){const t=e*c.size;(0,v.a)(ud,c.data[t],c.data[t+1],c.data[t+2]),(0,v.I)(ud,ud,i);const n=e*h.size;Sd[0]=h.data[n]*o,Sd[1]=h.data[n+1]*l,(0,v.I)(ud,ud,f.viewMatrix);const u=e*p.size;if((0,v.a)(xd,p.data[u+0],p.data[u+1],p.data[u+2]),!y&&(ud[0]+=xd[0],ud[1]+=xd[1],0!==xd[2])){const e=xd[2];(0,v.j)(xd,ud),(0,v.c)(ud,ud,(0,v.d)(xd,xd,e))}const _=e*d.size;if((0,v.a)(pd,d.data[_],d.data[_+1],d.data[_+2]),this.normalAndViewAngle(pd,vd,f,bd),this.applyVerticalOffsetTransformationView(ud,bd,f,hd),f.applyProjection(ud,md),md[0]>-1){let e=Math.floor(md[0])+this.params.screenOffset[0],t=Math.floor(md[1])+this.params.screenOffset[1];y&&(e+=xd[0],0!==xd[1]&&(t+=(0,S.a7)(xd[1],hd.factorAlignment))),(0,S.a8)(Sd,hd.factor,Sd);const i=Cd*f.pixelRatio;let n;if(a.textureIsSignedDistanceField&&(n=a.outlineSize*f.pixelRatio/2),cd(m,e,t,Sd,i,n,a,g)){const e=r.ray;if((0,v.I)(gd,ud,(0,C.h)(_d,f.viewMatrix)),md[0]=m[0],md[1]=m[1],f.unprojectFromRenderScreen(md,ud)){const t=(0,v.n)();(0,v.h)(t,e.direction);const i=1/(0,v.s)(t);(0,v.d)(t,t,i),s((0,v.q)(e.origin,ud)*i,t,-1,1,!0,gd)}}}}}computeAttachmentOrigin(e,t){const i=e.vertexAttributes;if(!i)return!1;const r=i.get("position"),s=e.indices.get("position");return(0,w.h)(r,s,t)}createBufferWriter(){return new Md(this)}normalAndViewAngle(e,t,i,r){return function(e){return function(e){return e instanceof Float32Array&&e.length>=16}(e)||function(e){return Array.isArray(e)&&e.length>=16}(e)}(t)&&(t=(0,Y.a)(yd,t)),(0,v.L)(r.normal,e,t),(0,v.I)(r.normal,r.normal,i.viewInverseTransposeMatrix),r.cosAngle=(0,v.z)(fd,Pd),r}updateScaleInfo(e,t,i){const r=this.params;r.screenSizePerspective?(0,S.a9)(i,t,r.screenSizePerspective,e.factor):(e.factor.scale=1,e.factor.factor=0,e.factor.minPixelSize=0,e.factor.paddingPixels=0),r.screenSizePerspectiveAlignment?(0,S.a9)(i,t,r.screenSizePerspectiveAlignment,e.factorAlignment):(e.factorAlignment.factor=e.factor.factor,e.factorAlignment.scale=e.factor.scale,e.factorAlignment.minPixelSize=e.factor.minPixelSize,e.factorAlignment.paddingPixels=e.factor.paddingPixels)}applyShaderOffsetsView(e,t,i,r,s,n,a){const o=this.normalAndViewAngle(t,i,s,bd);return this.applyVerticalGroundOffsetView(e,o,s,a),this.applyVerticalOffsetTransformationView(a,o,s,n),this.applyPolygonOffsetView(a,o,r[3],s,a),this.applyCenterOffsetView(a,r,a),a}applyShaderOffsetsNDC(e,t,i,r,s){return this.applyCenterOffsetNDC(e,t,i,r),(0,u.r)(s)&&(0,v.h)(s,r),this.applyPolygonOffsetNDC(r,t,i,r),r}applyPolygonOffsetView(e,t,i,r,s){const n=r.aboveGround?1:-1;let a=(0,v.e)(i);0===a&&(a=n);const o=n*a;if(this.params.shaderPolygonOffset<=0)return(0,v.h)(s,e);const l=(0,v.o)(Math.abs(t.cosAngle),.01,1),c=1-Math.sqrt(1-l*l)/l/r.viewport[2];return(0,v.d)(s,e,o>0?c:1/c),s}applyVerticalGroundOffsetView(e,t,i,r){const s=(0,v.s)(e),n=i.aboveGround?1:-1,a=.5*i.computeRenderPixelSizeAtDist(s),o=(0,v.d)(ud,t.normal,n*a);return(0,v.u)(r,e,o),r}applyVerticalOffsetTransformationView(e,t,i,r){const s=this.params;if(!s.verticalOffset||!s.verticalOffset.screenLength){if(s.screenSizePerspective||s.screenSizePerspectiveAlignment){const i=(0,v.s)(e);this.updateScaleInfo(r,i,t.cosAngle)}else r.factor.scale=1,r.factorAlignment.scale=1;return e}const n=(0,v.s)(e),a=s.screenSizePerspectiveAlignment||s.screenSizePerspective,o=(0,S.aa)(i,n,s.verticalOffset,t.cosAngle,a);return this.updateScaleInfo(r,n,t.cosAngle),(0,v.d)(t.normal,t.normal,o),(0,v.u)(e,e,t.normal)}applyCenterOffsetView(e,t,i){const r="screen"!==this.params.centerOffsetUnits;return i!==e&&(0,v.h)(i,e),r&&(i[0]+=t[0],i[1]+=t[1],t[2]&&((0,v.j)(pd,i),(0,v.u)(i,i,(0,v.d)(pd,pd,t[2])))),i}applyCenterOffsetNDC(e,t,i,r){const s="screen"!==this.params.centerOffsetUnits;return r!==e&&(0,v.h)(r,e),s||(r[0]+=t[0]/i.fullWidth*2,r[1]+=t[1]/i.fullHeight*2),r}applyPolygonOffsetNDC(e,t,i,r){const s=this.params.shaderPolygonOffset;if(e!==r&&(0,v.h)(r,e),s){const e=i.aboveGround?1:-1,n=e*(0,v.e)(t[3]);r[2]-=(n||e)*s}return r}getGLMaterial(e){return 0===e.output||7===e.output?new od(e):4===e.output?new ld(e):void 0}calculateRelativeScreenBounds(e,t,i=(0,b.i)()){return function(e,t,i,r=dd){(0,k.a)(r,e.anchorPos),r[0]*=-t[0],r[1]*=-t[1],r[0]+=e.screenOffset[0]*i,r[1]+=e.screenOffset[1]*i}(this.params,e,t,i),i[2]=i[0]+e[0],i[3]=i[1]+e[1],i}}class ad extends S.ag{constructor(e){super({...e,...e.material.params}),this.updateParameters()}beginSlot(e){return e===(this._material.params.drawInSecondSlot?19:18)}updateParameters(e){this.updateTexture(this._material.params.textureId),this.selectProgram(e)}selectProgram(e){this._technique=this._techniqueRep.releaseAndAcquire(td,this._material.getTechniqueConfig(this._output,e),this._technique)}ensureParameters(e){this.updateParameters(e)}bind(e){this.bindTextures(this._technique.program),this.bindTextureScale(this._technique.program),this._technique.bindPass(this._material.params,e)}}class od extends ad{constructor(e){super(e),this._isOcclusionSlot=!1}beginSlot(e){const t=this._material.params.drawInSecondSlot?19:18;return this._material.params.occlusionTest?(this._isOcclusionSlot=12===e,12===e||e===t):(this._isOcclusionSlot=!1,e===t)}get technique(){return this._isOcclusionSlot?this._occlusionTechnique:this._technique}selectProgram(e){this._technique=this._techniqueRep.releaseAndAcquire(td,this._material.getTechniqueConfig(this._output,e),this._technique),this._occlusionTechnique=this._techniqueRep.releaseAndAcquire(td,this._material.getTechniqueConfig(6,e),this._occlusionTechnique)}bind(e){const t=this.technique;this._isOcclusionSlot||(this.bindTextures(t.program),this.bindTextureScale(t.program)),t.bindPass(this._material.params,e)}}class ld extends ad{constructor(e){super({...e,output:4})}}function cd(e,t,i,r,s,n,a,o){let l=t-s-(o[0]>0?r[0]*o[0]:0),c=l+r[0]+2*s,h=i-s-(o[1]>0?r[1]*o[1]:0),d=h+r[1]+2*s;if(a.textureIsSignedDistanceField){const e=a.distanceFieldBoundingBox;l+=r[0]*e[0],h+=r[1]*e[1],c-=r[0]*(1-e[2]),d-=r[1]*(1-e[3]),l-=n,c+=n,h-=n,d+=n}return e[0]>l&&e[0]<c&&e[1]>h&&e[1]<d}const hd={factor:{scale:0,factor:0,minPixelSize:0,paddingPixels:0},factorAlignment:{scale:0,factor:0,minPixelSize:0,paddingPixels:0}},dd=(0,N.n)(),ud=(0,v.n)(),pd=(0,v.n)(),md=(0,f.x)(),fd=(0,v.n)(),gd=(0,v.n)(),vd=(0,X.e)(),yd=(0,X.e)(),_d=(0,T.e)(),xd=(0,v.n)(),bd={normal:fd,cosAngle:0},wd=(0,T.e)(),Cd=1,Td=2,Sd=[0,0],Pd=(0,v.i)(0,0,1),Rd={texCoordScale:[1,1],occlusionTest:!0,binaryHighlightOcclusion:!0,drawInSecondSlot:!1,color:[1,1,1,1],outlineColor:[1,1,1,1],outlineSize:0,textureIsSignedDistanceField:!1,distanceFieldBoundingBox:null,vvSizeEnabled:!1,vvSizeMinSize:[1,1,1],vvSizeMaxSize:[100,100,100],vvSizeOffset:[0,0,0],vvSizeFactor:[1,1,1],vvColorEnabled:!1,vvColorValues:[0,0,0,0,0,0,0,0],vvColorColors:[1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0],screenOffset:[0,0],verticalOffset:null,screenSizePerspective:null,screenSizePerspectiveAlignment:null,slicePlaneEnabled:!1,anchorPos:(0,N.t)(.5,.5),shaderPolygonOffset:1e-5,polygonOffset:!1,textureId:null,centerOffsetUnits:"world",depthEnabled:!0,pixelSnappingEnabled:!0,debugDrawBorder:!1,isDraped:!1,...S.ab},Ad=(0,G.A)().vec3f("position").vec3f("normal").vec2f("uv0").vec4u8("color").vec2f("size").vec4f("auxpos1").vec4f("auxpos2");class Md{constructor(e){this.material=e,this.vertexBufferLayout=Ad}allocate(e){return this.vertexBufferLayout.createBuffer(e)}elementCount(e){return 6*e.indices.get("position").length}write(e,t,i,r){(0,S.ac)(t.indices.get("position"),t.vertexAttributes.get("position").data,e.transformation,i.position,r,6),(0,S.ad)(t.indices.get("normal"),t.vertexAttributes.get("normal").data,e.invTranspTransformation,i.normal,r,6);{const e=t.vertexAttributes.get("uv0").data;let s,n,a,o;if(null==e||e.length<4){const e=this.material.params;s=0,n=0,a=e.texCoordScale[0],o=e.texCoordScale[1]}else s=e[0],n=e[1],a=e[2],o=e[3];a=Math.min(1.99999,a+1),o=Math.min(1.99999,o+1);const l=t.indices.get("position").length,c=i.uv0;let h=r;for(let e=0;e<l;++e)c.set(h,0,s),c.set(h,1,n),h+=1,c.set(h,0,a),c.set(h,1,n),h+=1,c.set(h,0,a),c.set(h,1,o),h+=1,c.set(h,0,a),c.set(h,1,o),h+=1,c.set(h,0,s),c.set(h,1,o),h+=1,c.set(h,0,s),c.set(h,1,n),h+=1}(0,S.ae)(t.indices.get("color"),t.vertexAttributes.get("color").data,4,i.color,r,6);{const e=t.indices.get("size"),s=t.vertexAttributes.get("size").data,n=e.length,a=i.size;let o=r;for(let t=0;t<n;++t){const i=s[2*e[t]],r=s[2*e[t]+1];for(let e=0;e<6;++e)a.set(o,0,i),a.set(o,1,r),o+=1}}t.indices.get("auxpos1")&&t.vertexAttributes.get("auxpos1")&&(0,S.af)(t.indices.get("auxpos1"),t.vertexAttributes.get("auxpos1").data,i.auxpos1,r,6),t.indices.get("auxpos2")&&t.vertexAttributes.get("auxpos2")&&(0,S.af)(t.indices.get("auxpos2"),t.vertexAttributes.get("auxpos2").data,i.auxpos2,r,6)}}const Od=(0,v.n)(),Dd=(0,w.n)(),Ed=(0,w.n)(),zd=(0,v.n)(),Id=(0,T.e)(),Ld=(0,S._)(),Fd=(0,S.x)(),Vd=(0,v.n)(),Ud=(0,b.i)();class Gd{constructor(){this.aabr=(0,b.i)(),this.distance=0,this.culled=!1,this.visible=!1}}class Bd{constructor(e,t,i={}){this.graphics3DGraphic=e,this.slicePlaneEnabled=t,this.info=i}}class qd{constructor(){this.active=new Map,this.visible=new Map}clear(){this.active.clear(),this.visible.clear()}}class kd{}class Nd{constructor(){this.sortArray=new r.f({allocator:e=>e||new kd})}}class jd{constructor(){this.camera=new Ia,this.slicePlane=lt(),this.slicePlaneEnabled=!1}copyFrom(e){this.camera.copyFrom(e.camera),ct(e.slicePlane,this.slicePlane),this.slicePlaneEnabled=e.slicePlaneEnabled}}let Hd=class extends r.p{constructor(){super(...arguments),this._dirty=!1,this._runningViewState=new jd,this._state=0,this.graphics=new qd,this.iterators=new Nd,this.accBinsNumX=15,this.accBinsNumY=20,this.accBinsSizeX=0,this.accBinsSizeY=0,this.accBins=null,this.accNumTests=0}get dirty(){return this._dirty}get state(){return this._state}destroy(){this.graphics.clear(),this.iterators=null}setDirty(){!this._dirty&&this.graphics.active.size>0&&(this._dirty=!0,this.notifyChange("updating"))}get updating(){return 0!==this._state||this._dirty}get updatingProgress(){if(!this.updating)return 1;const e=this._state/4;return this._dirty?.5*e:e}get running(){return this.view.ready&&null!=this.view.state&&this.updating}runTask(e){switch(this._state){case 0:this.startUpdate(),e.madeProgress();case 1:if(this._state=1,!this.processActiveGraphics(e))return;case 2:if(this._state=2,!this.sortVisibleGraphics(e))return;case 3:if(this._state=3,!this.deconflictVisibleGraphics(e))return;default:(function(e,t){if(!Uh||!Fh)return;kh();const i=Fh;let r=0;for(let t=0;t<e.accBinsNumX;t++)for(let s=0;s<e.accBinsNumY;s++){const n=e.accBins[t][e.accBinsNumY-1-s];r+=n.length;const a=t*e.accBinsSizeX,o=(t+1)*e.accBinsSizeX,l=s*e.accBinsSizeY,c=(s+1)*e.accBinsSizeY;i.fillText(n.length.toFixed(),a+5,l+15),Nh(a,o,l,c,"blue")}i.fillText("total totalShownLabels: "+r,70,40),i.fillText("total visible labels: "+t.size,70,50),i.fillText("total numTests: "+e.accNumTests,70,30)})(this,this.graphics.visible),this._state=0,this.notifyChange("updating")}}modifyGraphics(e,t){t?e.forEach((e=>this.addToActiveGraphics(e))):e.forEach((e=>this.removeFromActiveGraphics(e))),this.setDirty()}layerSupportsDeconfliction(e){if((0,u.t)(e)||"object3d"!==e.type)return!1;const t=e.stageObject;return 1===(t?t.getNumGeometryRecords():0)&&t.getGeometryRecord(0).material instanceof nd}startUpdate(){(function(e){Gh=Ih.DECONFLICTOR_SHOW_VISIBLE,Bh=Ih.DECONFLICTOR_SHOW_INVISIBLE,Vh=Gh||Bh,Uh=Ih.DECONFLICTOR_SHOW_GRID,qh=null,Vh||Uh?qh=()=>function(e){null==Lh&&(Lh=document.createElement("canvas"),Lh.setAttribute("id","canvas2d"),e.surface.parentElement.style.position="relative",e.surface.parentElement.appendChild(Lh));const t=e.width*e.pixelRatio,i=e.height*e.pixelRatio;Lh.setAttribute("width",`${t}px`),Lh.setAttribute("height",`${i}px`),Lh.setAttribute("style",`position:absolute;left:0px;top:0px;display:block;pointer-events:none;width:${e.width}px;height:${e.height}px`),Fh=Lh.getContext("2d"),Fh.clearRect(0,0,e.width,e.height),Fh.font="12px Arial"}(e):Lh&&(Lh.parentElement.removeChild(Lh),Lh=null)})(this.view),this._dirty=!1,this._runningViewState.copyFrom(this.viewState);const{fullWidth:e,fullHeight:t}=this._runningViewState.camera;this.initBins(e,t),this.resetIterators()}addToActiveGraphics(e){e.info[this.visibilityGroup]=new Gd,this.graphics.active.set(e.graphics3DGraphic.graphic.uid,e),this.setDirty()}removeFromActiveGraphics(e){this.removeFromVisibleGraphics(e),function(e,t){const i=e.graphics3DGraphic;i.destroyed||i.clearVisibilityFlag(3,t)}(e,this.visibilityGroup),delete e.info[this.visibilityGroup],this.graphics.active.delete(e.graphics3DGraphic.graphic.uid),this.setDirty()}addToVisibleGraphics(e){this.graphics.visible.set(e.graphics3DGraphic.graphic.uid,e)}removeFromVisibleGraphics(e){this.graphics.visible.delete(e.graphics3DGraphic.graphic.uid)}processActiveGraphics(e){const t=this.ensureActiveGraphicsIterator(),i=(0,C.h)(Id,this._runningViewState.camera.projectionMatrix),r="global"===this.view.viewingMode&&1===this.view.map.ground.opacity&&this._runningViewState.camera.relativeElevation>0?Ld:null;let s=0;for((0,u.r)(r)&&((0,v.I)(r,v.G,this._runningViewState.camera.viewMatrix),r[3]=(0,x.p)(this.view.spatialReference).radius,s=(0,S.ah)(r,v.G));!e.done;){e.madeProgress();const n=t.next();if(n.done)return this.resetActiveGraphicsIterator(),!0;const a=n.value,o=a&&a.info[this.visibilityGroup];o&&(this.collectGraphics3DGraphics(a,i,r,s),o.culled?this.removeFromVisibleGraphics(a):this.addToVisibleGraphics(a))}return!1}sortVisibleGraphics(e){const t=this.ensureSortGraphicsIterator();for(;!e.done;){const i=t.next();if(e.madeProgress(),i.done)return this.resetSortGraphicsIterator(),!0}return!1}deconflictVisibleGraphics(e){const t=this.ensureVisibleGraphicsIterator(),i=1===this.visibilityGroup;for(;!e.done;){e.madeProgress();const r=t.next();if(r.done)return this.resetVisibleGraphicsIterator(),!0;const s=r.value,n=s.info[this.visibilityGroup];if(!n||n.culled)continue;const a=s.graphics3DGraphic,o=(!i||a.isVisible())&&!this.isConflicted(s);o&&this.addToBins(s),n.visible=o,this.setGraphicVisibility(s,o),jh(n,o)}return!1}resetIterators(){this.iterators.active=null,this.iterators.visible=null,this.iterators.sort=null}ensureActiveGraphicsIterator(){return this.iterators.active||(this.iterators.active=Wd(this.graphics.active)),this.iterators.active}resetActiveGraphicsIterator(){this.iterators.active=null}ensureVisibleGraphicsIterator(){return this.iterators.visible||(this.iterators.visible=Wd(this.graphics.visible)),this.iterators.visible}resetVisibleGraphicsIterator(){this.iterators.visible=null}ensureSortGraphicsIterator(){return this.iterators.sort||(this.iterators.sort=function*(e,t,i){t.clear(),e.forEach(((e,r)=>{const s=t.pushNew();s.id=r,s.prio=e.info?-e.info[i].distance:Number.MAX_VALUE})),yield;const r=t.iterableSort(((e,t)=>t.prio-e.prio));for(let e=r.next();!e.done;e=r.next())yield;t.forAll((t=>{const i=e.get(t.id);i&&(e.delete(t.id),e.set(t.id,i))})),t.clear()}(this.graphics.visible,this.iterators.sortArray,this.visibilityGroup)),this.iterators.sort}resetSortGraphicsIterator(){this.iterators.sort=null}collectGraphics3DGraphics(e,t,i,r){const s=e.graphics3DGraphic;if(s.destroyed)return;const n=e.info[this.visibilityGroup];if(!s.isVisible(0,3))return void(n.culled=!0);const a=this.getGraphicsLayers(s);(0,b.B)(n.aabr);let o=null;for(const s of a){if(!this.layerSupportsDeconfliction(s))continue;const a=s.stageObject.getGeometryRecord(0).material;if((0,u.t)(o)){if(o=this.getProjectionInfo(s,t,Zd),o.isOutsideScreen||this.isCulledBySlice(e,Od)||(0,u.r)(i)&&this.isCulledByHorizon(o,i,r))return void(n.culled=!0);!Ih.DISABLE_DECONFLICTOR_VISIBILITY_OFFSET&&n.visible&&(o.distance*=.7)}this.expandBoundingRect(n,s,a,o)}(0,u.t)(o)?n.culled=!0:(n.distance=o.distance,n.culled=!1)}getProjectionInfo(e,t,i){const r=this._runningViewState.camera,s=e.stageObject,n=s.getGeometryRecord(0),a=n.material,o=(0,S.O)(s.boundingVolumeWorldSpace.bounds);(0,v.I)(Od,o,r.viewMatrix);const l=n.geometry.vertexAttributes,c=l.get("normal").data,h=l.get("auxpos1").data;return a.applyShaderOffsetsView(Od,c,s.transformation,h,r,i.scaleInfo,Od),(0,j.r)(Dd,Od[0],Od[1],Od[2],1),(0,j.y)(Ed,Dd,r.projectionMatrix),(0,v.d)(i.positionNDC,Ed,1/Ed[3]),a.applyShaderOffsetsNDC(i.positionNDC,h,r,i.positionNDC,zd),i.distanceWithoutPolygonOffset=r.depthNDCToWorld(zd[2]),i.distance=zd[2]===i.positionNDC[2]?i.distanceWithoutPolygonOffset:r.depthNDCToWorld(i.positionNDC[2]),(0,j.r)(Ed,i.positionNDC[0],i.positionNDC[1],i.positionNDC[2],1),(0,j.y)(Dd,Ed,t),(0,j.l)(Dd,Dd,1/Dd[3]),(0,v.a)(i.positionView,Od[0],Od[1],Od[2]),i}isCulledByHorizon(e,t,i){return(0,v.h)(Fd.direction,e.positionView),(0,v.a)(Fd.origin,0,0,0),!!(0,S.V)(t,Fd,Vd)&&e.distanceWithoutPolygonOffset>i}isCulledBySlice(e,t){return e.slicePlaneEnabled&&this._runningViewState.slicePlaneEnabled&&bt(this._runningViewState.slicePlane,t)}expandBoundingRect(e,t,i,{positionNDC:r,scaleInfo:s}){const n=this._runningViewState.camera,a=t.getScreenSize(Qd);(0,S.a8)(a,s.factor,a),a[0]*=n.pixelRatio,a[1]*=n.pixelRatio;const o=(0,b.R)(i.calculateRelativeScreenBounds(a,s.factorAlignment.scale,Ud),(0,v.C)(0,n.fullWidth,.5+.5*r[0]),(0,v.C)(0,n.fullHeight,.5+.5*r[1])),l=this.iconMarginFactor;if(0!==l){const e=l*Math.min((0,b.x)(o),(0,b.M)(o));o[0]-=e,o[1]-=e,o[2]+=e,o[3]+=e}(0,b.c)(e.aabr,o)}isConflicted(e){const t=e.graphics3DGraphic.graphic.uid,i=e.info[this.visibilityGroup];for(let e=Math.floor(i.aabr[0]/this.accBinsSizeX);e<=Math.floor(i.aabr[2]/this.accBinsSizeX);e++)if(!(e<0||e>=this.accBinsNumX))for(let r=Math.floor(i.aabr[1]/this.accBinsSizeY);r<=Math.floor(i.aabr[3]/this.accBinsSizeY);r++){if(r<0||r>=this.accBinsNumY)continue;const s=this.accBins[e][r];for(let e=0;e<s.length;e++){const r=s.data[e],n=r.info[this.visibilityGroup];if(n&&n.visible&&r.graphics3DGraphic.graphic.uid!==t&&(this.accNumTests++,(0,b.F)(n.aabr,i.aabr)))return!0}}return!1}initBins(e,t){if(null==this.accBins){this.accBins=[];for(let e=0;e<this.accBinsNumX;e++){this.accBins.push([]);const e=this.accBins[this.accBins.length-1];for(let t=0;t<this.accBinsNumY;t++)e.push(new r.f)}}else for(let e=0;e<this.accBinsNumX;e++)for(let t=0;t<this.accBinsNumY;t++)this.accBins[e][t].clear();this.accBinsSizeX=e/this.accBinsNumX,this.accBinsSizeY=t/this.accBinsNumY,this.accNumTests=0}addToBins(e){const t=e.info[this.visibilityGroup],i=Math.floor(t.aabr[0]/this.accBinsSizeX),r=Math.floor(t.aabr[2]/this.accBinsSizeX),s=Math.floor(t.aabr[1]/this.accBinsSizeY),n=Math.floor(t.aabr[3]/this.accBinsSizeY);for(let t=i;t<=r;t++)if(!(t<0||t>=this.accBinsNumX))for(let i=s;i<=n;i++)i<0||i>=this.accBinsNumY||this.accBins[t][i].push(e)}setGraphicVisibility(e,t){const i=e.graphics3DGraphic;i.destroyed||(i.setVisibilityFlag(3,t,this.visibilityGroup),1===this.visibilityGroup&&this.view.labeler.setLabelGraphicVisibility(i,t))}};function*Wd(e){if(Map.prototype.entries){const t=e.entries();for(let e=t.next();!e.done;e=t.next())yield e.value[1]}else yield*e.values()}(0,r.e)([(0,d.y)({constructOnly:!0})],Hd.prototype,"view",void 0),(0,r.e)([(0,d.y)({type:Boolean,readOnly:!0})],Hd.prototype,"updating",null),Hd=(0,r.e)([(0,d.n)("esri.views.3d.layers.graphics.Deconflictor")],Hd);const Qd=(0,N.n)(),Zd=new class{constructor(){this.positionView=(0,v.n)(),this.positionNDC=(0,v.n)(),this.distance=0,this.distanceWithoutPolygonOffset=0,this.scaleInfo={factor:{scale:0,factor:0,minPixelSize:0,paddingPixels:0},factorAlignment:{scale:0,factor:0,minPixelSize:0,paddingPixels:0}}}get isOutsideScreen(){const e=this.positionNDC;return e[0]<-1||e[1]<-1||e[2]<-1||e[0]>=1||e[1]>=1}};let Yd=class extends Hd{constructor(){super(...arguments),this.visibilityGroup=1,this.iconMarginFactor=0,this._lastDeconfliction=0}get viewState(){return this.parent.viewState}runTask(e){if(this.parent.running)return;const t=performance.now();(2===e.state||t-this._lastDeconfliction>2e3)&&(super.runTask(e),0===this.state&&(this._lastDeconfliction=t))}enabledChanged(e,t){this.modifyGraphics(t,e.labelsEnabled)}getGraphicsLayers(e){return e.labelGraphics}};(0,r.e)([(0,d.y)({constructOnly:!0})],Yd.prototype,"parent",void 0),Yd=(0,r.e)([(0,d.n)("esri.views.3d.layers.graphics.LabelDeconflictor")],Yd);let Xd=class extends r.p{constructor(){super(...arguments),this.SCHEDULER_LOG_SLOW_TASKS=!1,this.FEATURE_SERVICE_SNAPPING_SOURCE_TILE_TREE_SHOW_TILES=!1}};(0,r.e)([(0,d.y)()],Xd.prototype,"SCHEDULER_LOG_SLOW_TASKS",void 0),(0,r.e)([(0,d.y)()],Xd.prototype,"FEATURE_SERVICE_SNAPPING_SOURCE_TILE_TREE_SHOW_TILES",void 0),Xd=(0,r.e)([(0,d.n)("esri.views.support.DebugFlags")],Xd);const $d=new Xd,Kd=u.n.getLogger("esri.views.support.Scheduler");var Jd;!function(e){e.RESOURCE_CONTROLLER="schedule",e.SLIDE="slide",e.STREAM_DATA_LOADER="stream loader",e.ELEVATION_QUERY="elevation query",e.TERRAIN_SURFACE="terrain",e.SURFACE_GEOMETRY_UPDATES="surface geometry updates",e.GRAPHICS_CORE="Graphics3D",e.I3S_CONTROLLER="I3S",e.POINT_CLOUD_LAYER="point cloud",e.FEATURE_TILE_FETCHER="feature fetcher",e.STAGE="stage",e.GRAPHICS_DECONFLICTOR="graphics deconflictor",e.FILTER_VISIBILITY="Graphics3D filter visibility",e.SCALE_VISIBILITY="Graphics3D scale visibility",e.FRUSTUM_VISIBILITY="Graphics3D frustum visibility",e.POINT_OF_INTEREST_FREQUENT="POI frequent",e.POINT_OF_INTEREST_INFREQUENT="POI infrequent",e.LABELER="labeler",e.FEATURE_QUERY_ENGINE="feature query",e.FEATURE_TILE_TREE="feature tile tree",e.FEATURE_TILE_TREE_ACTIVE="fast feature tile tree",e.ELEVATION_ALIGNMENT="elevation alignment",e.TEXT_TEXTURE_ATLAS="text texture atlas",e.TEXTURE_UNLOAD="texture unload",e.OVERLAY_MANAGER="overlay manager",e.LINE_OF_SIGHT_TOOL="line of sight tool",e.LINE_OF_SIGHT_TOOL_INTERACTIVE="interactive line of sight tool",e.ELEVATION_PROFILE="elevation profile",e.SNAPPING="snapping",e.SHADOW_ACCUMULATOR="shadow accumulator",e[e.TEST_PRIO=1]="TEST_PRIO"}(Jd||(Jd={}));const eu=new Map([[Jd.RESOURCE_CONTROLLER,0],[Jd.SLIDE,0],[Jd.STREAM_DATA_LOADER,0],[Jd.ELEVATION_QUERY,0],[Jd.TERRAIN_SURFACE,1],[Jd.SURFACE_GEOMETRY_UPDATES,1],[Jd.GRAPHICS_CORE,2],[Jd.I3S_CONTROLLER,2],[Jd.POINT_CLOUD_LAYER,2],[Jd.FEATURE_TILE_FETCHER,2],[Jd.STAGE,4],[Jd.GRAPHICS_DECONFLICTOR,4],[Jd.FILTER_VISIBILITY,4],[Jd.SCALE_VISIBILITY,4],[Jd.FRUSTUM_VISIBILITY,4],[Jd.POINT_OF_INTEREST_FREQUENT,6],[Jd.POINT_OF_INTEREST_INFREQUENT,30],[Jd.LABELER,8],[Jd.FEATURE_QUERY_ENGINE,8],[Jd.FEATURE_TILE_TREE,16],[Jd.FEATURE_TILE_TREE_ACTIVE,0],[Jd.ELEVATION_ALIGNMENT,12],[Jd.TEXT_TEXTURE_ATLAS,12],[Jd.TEXTURE_UNLOAD,12],[Jd.OVERLAY_MANAGER,12],[Jd.LINE_OF_SIGHT_TOOL,16],[Jd.LINE_OF_SIGHT_TOOL_INTERACTIVE,0],[Jd.SNAPPING,0],[Jd.SHADOW_ACCUMULATOR,30]]);function tu(e){return eu.has(e)?eu.get(e):"number"==typeof e?e:1}const iu=(0,r.w)(6.5),ru=(0,r.w)(1),su=(0,r.w)(30),nu=(0,r.w)(1e3/30),au=(0,r.w)(100);var ou,lu;!function(e){let t=class extends r.p{constructor(e){super(e),this.updating=!0,this.performanceInfo={total:new r.E("total"),tasks:new Map},this._frameTaskTimes=new Map,this._budget=null,this._state=1,this._tasks=new r.f,this._runQueue=new r.f,this._load=0,this._idleStateCallbacks=new r.f,this._idleUpdatesStartFired=!1,this._maxReschedule=du,this._forceTask=!1,this._debug=!1,this._debugHandle=(0,p.d)($d,"SCHEDULER_LOG_SLOW_TASKS",(e=>this._debug=e)),this._budget=new s(e.nowFunc);for(const e of Object.keys(Jd))this.performanceInfo.tasks.set(Jd[e],new r.E(Jd[e]));let t;const i=this;this._test={get state(){return(0,u.t)(t)?i._state:t},set state(e){t=e},FRAME_SAFETY_BUDGET:iu,INTERACTING_BUDGET:nu,IDLE_BUDGET:au,get budget(){return i._budget.budget},usedBudget:0,updateTask:e=>this._updateTask(e),getState:e=>this._getState(e),getRuntime:e=>this._getRuntime(e),resetRuntimes:()=>this._resetRuntimes(),getRunning:()=>this._getRunning()}}destroy(){this._debugHandle&&this._debugHandle.remove()}registerTask(e,t){const s=tu(e),n=new i(this,e,t,s);return this._tasks.push(n),this.performanceInfo.tasks.has(e)||this.performanceInfo.tasks.set(e,new r.E(e)),n}registerIdleStateCallbacks(e,t){const i={idleBegin:e,idleEnd:t};this._idleStateCallbacks.push(i),2===this.state&&this._idleUpdatesStartFired&&i.idleBegin();const r=this;return{remove:()=>this._removeIdleStateCallbacks(i),set idleBegin(e){r._idleUpdatesStartFired&&(i.idleEnd(),2===r._state&&e()),i.idleBegin=e},set idleEnd(e){i.idleEnd=e}}}get now(){return this.nowFunc()}get load(){return this._load}set state(e){this._state!==e&&(this._state=e,2!==this.state&&this._idleUpdatesStartFired&&(this._idleUpdatesStartFired=!1,this._idleStateCallbacks.forAll((e=>e.idleEnd()))))}get state(){return(0,u.t)(this._test.state)?this._state:this._test.state}updateBudget(e){this._test.usedBudget=0;let t=iu,i=e.frameDuration,s=ru;switch(this.state){case 2:t=(0,r.w)(0),i=(0,r.w)(Math.max(au,e.frameDuration)),s=su;break;case 1:i=(0,r.w)(Math.max(nu,e.frameDuration))}return i=(0,r.w)(i-e.elapsedFrameTime-t),2!==this.state&&i<ru&&!this._forceTask?(this._forceTask=!0,!1):(i=(0,r.w)(Math.max(i,s)),this._budget.reset(i,this.state),this._maxReschedule=du,this._updateLoad(),this._schedule())}frame(){switch(this._forceTask=!1,this.state){case 2:this._idleUpdatesStartFired||(this._idleUpdatesStartFired=!0,this._idleStateCallbacks.forAll((e=>e.idleBegin()))),this._runIdle();break;case 1:this._runInteracting();break;default:this._runAnimating()}this._test.usedBudget=this._budget.elapsed}stopFrame(){this._budget.reset((0,r.w)(0),this._state),this._budget.madeProgress()}_removeIdleStateCallbacks(e){this._idleUpdatesStartFired&&e.idleEnd(),this._idleStateCallbacks.removeUnordered(e)}removeTask(e){this._tasks.removeUnordered(e),this._runQueue.removeUnordered(e)}_updateTask(e){this._tasks.forAll((t=>{t.name===e&&t.setPriority(e)}))}_getState(e){if(this._runQueue.some((t=>t.name===e)))return lu.SCHEDULED;let t=lu.IDLE;return this._tasks.forAll((i=>{i.name===e&&i.needsUpdate&&(i.schedulePriority<=1?t=lu.READY:t!==lu.READY&&(t=lu.WAITING))})),t}_getRuntime(e){let t=0;return this._tasks.forAll((i=>{i.name===e&&(t+=i.runtime)})),t}_resetRuntimes(){this._tasks.forAll((e=>e.runtime=0))}_getRunning(){const e=new Map;if(this._tasks.forAll((t=>{t.needsUpdate&&e.set(t.name,(e.get(t.name)||0)+1)})),0===e.size)return null;let t="";return e.forEach(((e,i)=>{t+=e>1?` ${e}x ${i}`:` ${i}`})),t}_runIdle(){this._run()}_runInteracting(){this._run()}_runAnimating(){this._run()}_updateLoad(){const e=this._tasks.reduce(((e,t)=>t.needsUpdate?++e:e),0);this._load=.9*this._load+e*(1-.9)}_schedule(){if(this._maxReschedule<=0)return!1;for(this._runQueue.filterInPlace((e=>!!e.needsUpdate||(e.schedulePriority=e.basePriority,!1))),this._tasks.forAll((e=>{0===e.basePriority&&e.needsUpdate&&!this._runQueue.some((t=>t===e))&&this._runQueue.unshift(e)}));0===this._runQueue.length;){let e=!1,t=0;if(this._tasks.forAll((i=>{if(i.needsUpdate&&0!==i.schedulePriority&&0!==i.basePriority)switch(e=!0,t=Math.max(t,i.basePriority),i.schedulePriority){case 1:i.schedulePriority=0,this._runQueue.push(i);break;default:--i.schedulePriority}})),!e)return this.updating=!1,!1;this._maxReschedule===du&&(this._maxReschedule=t),--this._maxReschedule}return this.updating=!0,!0}_run(){const e=this._budget.now();this._startFrameTaskTimes();do{for(;this._runQueue.length>0;){const t=this._budget.now(),i=this._runQueue.pop();this._budget.resetProgress();try{i.task.runTask(this._budget)}catch(e){Kd.error(`Exception in task "${i.name}"`,e)}i.schedulePriority=i.basePriority;const r=this._budget.now()-t;if(i.runtime+=r,this._frameTaskTimes.set(i.priority,this._frameTaskTimes.get(i.priority)+r),this._debug&&this._budget.elapsed>2*this._budget.budget&&console.log("Task",i.name,"used",this._budget.elapsed,"of max",this._budget.budget,"ms"),this._budget.remaining<=0)return void this._recordFrameTaskTimes(this._budget.now()-e)}}while(this._schedule());this._recordFrameTaskTimes(this._budget.now()-e)}_startFrameTaskTimes(){for(const e of Object.keys(Jd))this._frameTaskTimes.set(Jd[e],0)}_recordFrameTaskTimes(e){this._frameTaskTimes.forEach(((e,t)=>this.performanceInfo.tasks.get(t).record(e))),this.performanceInfo.total.record(e)}get test(){return this._test}};(0,r.e)([(0,d.y)()],t.prototype,"updating",void 0),(0,r.e)([(0,d.y)()],t.prototype,"nowFunc",void 0),t=(0,r.e)([(0,d.n)("esri.views.support.Scheduler")],t),e.Scheduler=t;let i=class extends r.p{constructor(e,t,i,r){super({}),this._scheduler=e,this.name=t,this._basePriority=r,this.runtime=0,this._queue=new J.r,this.updating=!1,this.schedulePriority=this._basePriority,this.task=(0,u.r)(i)?i:{running:!1,runTask:e=>this.processQueue(e)}}normalizeCtorArgs(){return{}}remove(){this.processQueue(cu),this._scheduler.removeTask(this),this.schedule=hu.schedule,this.reschedule=hu.reschedule}get basePriority(){return this._basePriority}setPriority(e){this.name=e;const t=tu(e);0!==this._basePriority&&0===this.schedulePriority||(this.schedulePriority=t),this._basePriority=t}get priority(){return this.name}set priority(e){this.setPriority(e)}get needsUpdate(){return this.updating||this.task.running}schedule(e,t,i){return this.updating=!0,this._queue.push(e,t,i)}reschedule(e,t,i){return this.updating=!0,this._queue.unshift(e,t,i)}processQueue(e){for(;!e.done&&this._queue.process();)e.madeProgress();this.updating=this._queue.length>0}};(0,r.e)([(0,d.y)()],i.prototype,"updating",void 0),i=(0,r.e)([(0,d.n)("esri.views.support.SchedulerTask")],i);class s{constructor(e){this.now=e,this._begin=0,this._budget=0,this._state=2,this._didWork=!1,this._enabled=!0}run(e){return!this.done&&(!0===e()&&(this._didWork=!0),!0)}get done(){return this._didWork&&this.elapsed>=this._budget&&this._enabled}get budget(){return this._budget}madeProgress(){this._didWork=!0}get state(){return this._state}get enabled(){return this._enabled}set enabled(e){this._enabled=e}reset(e,t){this._begin=this.now(),this._budget=e,this._state=t,this._didWork=!1}get remaining(){return Math.max(this._budget-this.elapsed,0)}get elapsed(){return this.now()-this._begin}resetProgress(){this._didWork=!1}get hasProgressed(){return this._didWork}}e.Budget=s}(ou||(ou={})),function(e){e.SCHEDULED="s",e.READY="r",e.WAITING="w",e.IDLE="i"}(lu||(lu={}));const cu=(()=>{const e=new ou.Budget((()=>performance.now()));return e.enabled=!1,e})(),hu=new class{remove(){}processQueue(){}schedule(e,t,i){try{if((0,h.b)(t)){const e=(0,h.m)();return i?Promise.resolve(i(e)):Promise.reject(e)}return(0,h.q)(e())}catch(e){return Promise.reject(e)}}reschedule(e,t,i){return this.schedule(e,t,i)}},du=Number.MAX_SAFE_INTEGER;let uu=class extends Hd{constructor(){super(...arguments),this._handles=new R.u,this._contexts=new Map,this._viewState=new jd,this.visibilityGroup=0,this._iconMarginFactor=-.1}get labels(){return this._labels}get viewState(){return this._viewState}initialize(){this._handles.add([this.view.watch("state.camera",(()=>{this.updateViewState(),this.setDirty()})),this.view.watch("map.ground.opacity",((e,t)=>{1!==e&&1!==t||this.setDirty()})),(0,p.d)(this.view,"slicePlane",(()=>{this.updateSlicePlane(),this.slicePlaneChanged()}))]),this._frameTask=this.view.resourceController.scheduler.registerTask(Jd.GRAPHICS_DECONFLICTOR,this),this._labels=new Yd({view:this.view,parent:this})}destroy(){this._labels.destroy(),this._labels=null,this._handles.destroy(),this._handles=null,this._frameTask&&(this._frameTask.remove(),this._frameTask=null)}get iconMarginFactor(){return this._iconMarginFactor}set iconMarginFactor(e){this._iconMarginFactor=e,this.setDirty()}setDirty(){this._contexts.size>0&&(super.setDirty(),this._labels.setDirty())}runTask(e){super.runTask(e),this.running||this._labels.setDirty()}setInitialIconVisibilityFlag(e,t){const i=!(this._graphicSupportsDeconfliction(t)&&pu(e));t.setVisibilityFlag(3,i,0)}updateViewState(){this.view&&this.view.state&&(this._viewState.camera.copyFrom(this.view.state.camera),this.updateSlicePlane())}updateSlicePlane(){const e=this.view?this.view.slicePlane:null;(0,u.r)(e)&&Ct(e,this._viewState.camera.viewMatrix,this._viewState.slicePlane),this._viewState.slicePlaneEnabled=(0,u.r)(e)}slicePlaneChanged(){(0,s.g)(this._contexts,((e,t)=>t.symbolCreationContext.slicePlaneEnabled))&&this.setDirty()}addGraphicsOwner(e){let t=this._contexts.get(e);return null==t&&(t=new Map,this._contexts.set(e,t),this.setDirty()),{addGraphic:i=>this.addGraphic(e,t,i),removeGraphic:e=>this.removeGraphic(t,e),labelingInfoChange:()=>this._labels.enabledChanged(e,t),featureReductionChange:()=>this.enabledChanged(e,t),slicePlaneEnabledChange:()=>this._slicePlaneEnabledChanged(e,t),clear:()=>t.forEach((e=>this.removeGraphic(t,e.graphics3DGraphic)))}}removeGraphicsOwner(e){const t=this._contexts.get(e);t&&(t.forEach((e=>this.removeGraphic(t,e.graphics3DGraphic))),this._contexts.delete(e),this.setDirty())}addGraphic(e,t,i){const r=i.graphic.uid,s=new Bd(i,e.symbolCreationContext.slicePlaneEnabled);t.set(r,s),pu(e)&&this.addToActiveGraphics(s),e.labelsEnabled&&this._labels.addToActiveGraphics(s)}removeGraphic(e,t){const i=t.graphic.uid,r=e.get(i);r&&(this.removeFromActiveGraphics(r),this._labels.removeFromActiveGraphics(r),e.delete(i),this.setDirty())}enabledChanged(e,t){const i=pu(e);i||function(e){const t=e.graphics3DGraphics;t&&t.forEach((e=>e.clearVisibilityFlag(3)))}(e),this.modifyGraphics(t,i)}_slicePlaneEnabledChanged(e,t){const i=e.symbolCreationContext.slicePlaneEnabled;t.forEach((e=>e.slicePlaneEnabled=i)),this.setDirty()}getGraphicsLayers(e){return e._graphics}_graphicSupportsDeconfliction(e){if(e.isDraped)return!1;const t=e._graphics;if(!t||!t.length)return!1;for(const e of t)if(this.layerSupportsDeconfliction(e))return!0;return!1}};function pu(e){const t=e.layer;return!(!t||!t.featureReduction||"selection"!==t.featureReduction.type)}function mu(e){return"declaredClass"in e}function fu(e){return"declaredClass"in e}function gu(e,t){if(!e)return null;if(function(e){return"declaredClass"in e}(e))return e;const i=new a.h({layer:t,sourceLayer:t});return i.visible=e.visible,i.symbol=(0,u.y)(e.symbol),i.attributes=(0,u.y)(e.attributes),i.geometry=vu(e.geometry),i}function vu(e){return(0,u.t)(e)?null:mu(e)?e:(0,te.p)(function(e){const t=e.spatialReference.toJSON();switch(e.type){case"point":{const{x:i,y:r,z:s,m:n}=e;return{x:i,y:r,z:s,m:n,spatialReference:t}}case"polygon":{const{rings:i,hasZ:r,hasM:s}=e;return{rings:yu(i),hasZ:r,hasM:s,spatialReference:t}}case"polyline":{const{paths:i,hasZ:r,hasM:s}=e;return{paths:yu(i),hasZ:r,hasM:s,spatialReference:t}}case"extent":{const{xmin:i,xmax:r,ymin:s,ymax:n,zmin:a,zmax:o,mmin:l,mmax:c,hasZ:h,hasM:d}=e;return{xmin:i,xmax:r,ymin:s,ymax:n,zmin:a,zmax:o,mmin:l,mmax:c,hasZ:h,hasM:d,spatialReference:t}}case"multipoint":{const{points:i,hasZ:r,hasM:s}=e;return{points:xu(i)?_u(i):i,hasZ:r,hasM:s,spatialReference:t}}default:return}}(e))}function yu(e){return function(e){for(const t of e)if(0!==t.length)return xu(t);return!1}(e)?e.map((e=>_u(e))):e}function _u(e){return e.map((e=>(0,u.E)(e)))}function xu(e){return e.length&&((0,u.C)(e[0])||(0,u.D)(e[0]))}function bu(e,t){if("point"===e.type)return Cu(e,t,!1);if(mu(e))switch(e.type){case"extent":return Cu(e.center,t,!1);case"polygon":return Cu(e.centroid,t,!1);case"polyline":return Cu(wu(e),t,!0);case"mesh":return Cu(e.origin,t,!1)}else switch(e.type){case"extent":return Cu(function(e){const t=(0,v.K)(e.zmin);return(0,ie.v)(.5*(e.xmax+e.xmin),.5*(e.ymax+e.ymin),t?.5*(e.zmax+e.zmin):void 0,e.spatialReference)}(e),t,!0);case"polygon":return Cu(function(e){const t=e.rings[0];if(!t||0===t.length)return null;const i=(0,A.a)(e.rings,e.hasZ);return(0,ie.v)(i[0],i[1],i[2],e.spatialReference)}(e),t,!0);case"polyline":return Cu(wu(e),t,!0)}}function wu(e){const t=e.paths[0];if(!t||0===t.length)return null;const i=(0,A.l)(t,(0,A.s)(t)/2);return(0,ie.v)(i[0],i[1],i[2],e.spatialReference)}function Cu(e,t,i){const r=i?e:function(e,t){if(!e)return null;let i;return fu(e)?e.clone():(i=(0,ie.v)(e.x,e.y,e.z,e.spatialReference),e.hasM&&(i.m=e.m,i.hasM=!0),i)}(e);return t&&e?(0,_.l)(e,r,t)?r:null:r}function Tu(e,t,i,r=0){if(e){t||(t=(0,b.i)());const s=e;let n=.5*s.width*(i-1),a=.5*s.height*(i-1);return s.width<1e-7*s.height?n+=a/20:s.height<1e-7*s.width&&(a+=n/20),(0,j.r)(t,s.xmin-n-r,s.ymin-a-r,s.xmax+n+r,s.ymax+a+r),t}return null}function Su(e,t){for(let i=0;i<e.geometries.length;++i){const r=e.geometries[i].getMutableAttribute("auxpos1");r&&r.data[3]!==t&&(r.data[3]=t,e.geometryVertexAttrsUpdated(i))}}function Pu(e,t){const i=(0,w.t)(w.d);return(0,u.r)(e)&&(i[0]=e[0],i[1]=e[1],i[2]=e[2]),(0,u.r)(t)?i[3]=t:(0,u.r)(e)&&e.length>3&&(i[3]=e[3]),i}function Ru(e,t,i,r,s,n=[0,0,0,0]){for(let t=0;t<3;++t)(0,u.r)(e)&&null!=e[t]?n[t]=e[t]:(0,u.r)(i)&&null!=i[t]?n[t]=i[t]:n[t]=s[t];return(0,u.r)(t)?n[3]=t:(0,u.r)(r)?n[3]=r:n[3]=s[3],n}function Au(e=v.l,t,i,r=1){const s=new Array(3);if((0,u.t)(t)||(0,u.t)(i))s[0]=1,s[1]=1,s[2]=1;else{let r,n=0;for(let a=2;a>=0;a--){const o=e[a];let l;const c=null!=o,h=0===a&&!r&&!c,d=i[a];"symbol-value"===o||h?l=0!==d?t[a]/d:1:c&&"proportional"!==o&&isFinite(o)&&(l=0!==d?o/d:1),null!=l&&(s[a]=l,r=l,n=Math.max(n,Math.abs(l)))}for(let e=2;e>=0;e--)null==s[e]?s[e]=r:0===s[e]&&(s[e]=.001*n)}for(let e=2;e>=0;e--)s[e]/=r;return(0,v.M)(s)}function Mu(e){return function(e){return null!=e.isPrimitive}(e)&&(e=[e.width,e.depth,e.height]),Ou(e)?null:"Symbol sizes may not be negative values"}function Ou(e){if(Array.isArray(e)){for(const t of e)if(!Ou(t))return!1;return!0}return null==e||e>=0}function Du(e,t){return null!=t.minDemResolution?t.minDemResolution:(0,se.S)(e)?t.minDemResolutionForPoints:.01*(0,se.z)(e)}uu=(0,r.e)([(0,d.n)("esri.views.3d.layers.graphics.GraphicsDeconflictor")],uu);const Eu={"bottom-left":(0,N.t)(0,0),bottom:(0,N.t)(.5,0),"bottom-right":(0,N.t)(1,0),left:(0,N.t)(0,.5),center:(0,N.t)(.5,.5),right:(0,N.t)(1,.5),"top-left":(0,N.t)(0,1),top:(0,N.t)(.5,1),"top-right":(0,N.t)(1,1)};function zu(e,t,i,r,s,n,a,o,l,c,h){const d=Bu[h.mode];let u,p,m=0;if((0,_.x)(e,t,i,r,l.spatialReference,s,o))return d.requiresAlignment(h)?(m=d.applyElevationAlignmentBuffer(r,s,n,a,o,l,c,h),u=n,p=a):(u=r,p=s),(0,_.x)(u,l.spatialReference,p,n,c.spatialReference,a,o)?m:void 0}function Iu(e,t,i,r,s){const n=(kt(e)?e.z:jt(e)?e.array[e.offset+2]:e[2])||0;switch(i.mode){case"on-the-ground":{const i=(0,u.q)(Ht(t,e,"ground"),0);return s&&(s.verticalDistanceToGround=0,s.sampledElevation=i),i}case"relative-to-ground":{const a=(0,u.q)(Ht(t,e,"ground"),0),o=i.geometryZWithOffset(n,r);return s&&(s.verticalDistanceToGround=o,s.sampledElevation=a),o+a}case"relative-to-scene":{const a=(0,u.q)(Ht(t,e,"scene"),0),o=i.geometryZWithOffset(n,r);return s&&(s.verticalDistanceToGround=o,s.sampledElevation=a),o+a}case"absolute-height":{const a=i.geometryZWithOffset(n,r);if(s){const i=(0,u.q)(Ht(t,e,"ground"),0);s.verticalDistanceToGround=a-i,s.sampledElevation=i}return a}default:return(0,Z.n)(i.mode),0}}function Lu(e,t,i){return null==t||null==i?e.definedChanged:"on-the-ground"===t&&"on-the-ground"===i?e.staysOnTheGround:t===i||"on-the-ground"!==t&&"on-the-ground"!==i?Gu.UPDATE:e.onTheGroundChanged}function Fu(e){return"relative-to-ground"===e||"relative-to-scene"===e}function Vu(e){return"absolute-height"!==e}function Uu(e,t,i,r,s){const n=Iu(t,i,s,r,ku);Su(e,ku.verticalDistanceToGround);const a=ku.sampledElevation,o=(0,C.n)(qu,e.transformation);return Nu[0]=t.x,Nu[1]=t.y,Nu[2]=n,(0,_.S)(t.spatialReference,Nu,o,r.spatialReference)?e.transformation=o:console.warn("Could not locate symbol object properly, it might be misplaced"),a}var Gu;!function(e){e[e.NONE=0]="NONE",e[e.UPDATE=1]="UPDATE",e[e.RECREATE=2]="RECREATE"}(Gu||(Gu={}));const Bu={"absolute-height":{applyElevationAlignmentBuffer:function(e,t,i,r,s,n,a,o){const l=o.calculateOffsetRenderUnits(a),c=o.featureExpressionInfoContext;t*=3,r*=3;for(let n=0;n<s;++n){const s=e[t+0],n=e[t+1],a=e[t+2];i[r+0]=s,i[r+1]=n,i[r+2]=null==c?a+l:l,t+=3,r+=3}return 0},requiresAlignment:function(e){const t=e.meterUnitOffset,i=e.featureExpressionInfoContext;return 0!==t||null!=i}},"on-the-ground":{applyElevationAlignmentBuffer:function(e,t,i,r,s,n){let a=0;const o=n.spatialReference;t*=3,r*=3;for(let l=0;l<s;++l){const s=e[t+0],l=e[t+1],c=e[t+2],h=(0,u.q)(n.getElevation(s,l,c,o,"ground"),0);a+=h,i[r+0]=s,i[r+1]=l,i[r+2]=h,t+=3,r+=3}return a/s},requiresAlignment:()=>!0},"relative-to-ground":{applyElevationAlignmentBuffer:function(e,t,i,r,s,n,a,o){let l=0;const c=o.calculateOffsetRenderUnits(a),h=o.featureExpressionInfoContext,d=n.spatialReference;t*=3,r*=3;for(let a=0;a<s;++a){const s=e[t+0],a=e[t+1],o=e[t+2],p=(0,u.q)(n.getElevation(s,a,o,d,"ground"),0);l+=p,i[r+0]=s,i[r+1]=a,i[r+2]=null==h?o+p+c:p+c,t+=3,r+=3}return l/s},requiresAlignment:()=>!0},"relative-to-scene":{applyElevationAlignmentBuffer:function(e,t,i,r,s,n,a,o){let l=0;const c=o.calculateOffsetRenderUnits(a),h=o.featureExpressionInfoContext,d=n.spatialReference;t*=3,r*=3;for(let a=0;a<s;++a){const s=e[t+0],a=e[t+1],o=e[t+2],p=(0,u.q)(n.getElevation(s,a,o,d,"scene"),0);l+=p,i[r+0]=s,i[r+1]=a,i[r+2]=null==h?o+p+c:p+c,t+=3,r+=3}return l/s},requiresAlignment:()=>!0}},qu=(0,T.e)(),ku={verticalDistanceToGround:0,sampledElevation:0},Nu=(0,v.n)();function ju(e,t,i,r){const s=e.stageObject,n=i.spatialReference,a=s.geometryRecords,o=a.length,l="absolute-height"!==t.mode;let c=0;for(let e=0;e<o;e++){const o=a[e].geometry,h=a[e].getShaderTransformation();Xu[0]=h[12],Xu[1]=h[13],Xu[2]=h[14],o.invalidateBoundingInfo();const d=o.getMutableAttribute("position"),u=d.data,p=o.vertexAttributes.get("mapPos").data,m=d.size,f=u.length/m,g=new Nt(p,n);let v=0,y=!1,x=0;for(let e=0;e<f;e++){$u[0]=u[v],$u[1]=u[v+1],$u[2]=u[v+2];const e=Iu(g,i,t,r,l?ep:null);if(l&&(x+=ep.sampledElevation),Ih.DISABLE_ELEVATION_ALIGNERS_ITERATIVE_UPDATES?(u[v]=g.array[g.offset],u[v+1]=g.array[g.offset+1],u[v+2]=e,(0,_.x)(u,n,v,u,r.spatialReference,v,1),u[v]-=Xu[0],u[v+1]-=Xu[1],u[v+2]-=Xu[2]):(Yu[0]=u[v]+Xu[0],Yu[1]=u[v+1]+Xu[1],Yu[2]=u[v+2]+Xu[2],r.setAltitude(Yu,e),u[v]=Yu[0]-Xu[0],u[v+1]=Yu[1]-Xu[1],u[v+2]=Yu[2]-Xu[2]),Ih.TESTS_DISABLE_UPDATE_THRESHOLDS)y=!0;else{const e=Zu/r.unitInMeters;(Math.abs($u[0]-u[v])>=e||Math.abs($u[1]-u[v+1])>=e||Math.abs($u[2]-u[v+2])>=e)&&(y=!0)}v+=m,g.offset+=3}c+=x/f,y&&s.geometryVertexAttrsUpdated(e)}return c/o}function Hu(e,t,i,r){const s=e.stageObject,n=t.centerPointInElevationSR;let a=0,o=0;if(s.metadata.usesVerticalDistanceToGround)a=Iu(n,i,t,r,ep),Su(s,ep.verticalDistanceToGround),o=ep.sampledElevation;else{const e="absolute-height"!==t.mode;a=Iu(n,i,t,r,e?ep:null),e&&(o=ep.sampledElevation)}const l=(0,C.n)(Wu,s.transformation),c=(0,v.a)(Ju,l[12],l[13],l[14]);Ih.DISABLE_ELEVATION_ALIGNERS_ITERATIVE_UPDATES?(Yu[0]=n.x,Yu[1]=n.y,Yu[2]=a,(0,_.S)(n.spatialReference,Yu,l,r.spatialReference)&&(s.transformation=l)):r.setAltitudeOfTransformation(a,l);const h=Zu/r.unitInMeters;return(Math.abs(l[12]-c[0])>=h||Math.abs(l[13]-c[1])>=h||Math.abs(l[14]-c[2])>=h)&&(s.transformation=l),o}const Wu=(0,T.e)();function Qu(e,t,i,r){const s=e.graphics3DSymbolLayer.lodRenderer;if((0,u.t)(s))return 0;const n=t.centerPointInElevationSR;let a=0,o=0;const l="absolute-height"!==t.mode;a=Iu(n,i,t,r,l?ep:null),l&&(o=ep.sampledElevation);const c=s.instanceData,h=e.instanceIndex,d=Ku;c.getGlobalTransform(h,d);const p=(0,v.a)(Ju,d[12],d[13],d[14]);Ih.DISABLE_ELEVATION_ALIGNERS_ITERATIVE_UPDATES?(Yu[0]=n.x,Yu[1]=n.y,Yu[2]=a,(0,_.S)(n.spatialReference,Yu,d,r.spatialReference)&&c.setGlobalTransform(h,d)):r.setAltitudeOfTransformation(a,d);const m=Zu/r.unitInMeters;return(Ih.TESTS_DISABLE_UPDATE_THRESHOLDS||Math.abs(d[12]-p[0])>=m||Math.abs(d[13]-p[1])>=m||Math.abs(d[14]-p[2])>=m)&&c.setGlobalTransform(h,d),o}const Zu=.01,Yu=(0,v.n)(),Xu=(0,v.n)(),$u=(0,v.n)(),Ku=(0,T.e)(),Ju=(0,v.n)(),ep={verticalDistanceToGround:0,sampledElevation:0},tp=u.n.getLogger("esri.views.3d.layers.graphics.featureExpressionInfoUtils");function ip(e){const t=e&&e.expression;if("string"==typeof t){const e=cp(t);if(null!=e)return{cachedResult:e}}return null}async function rp(e,t,i){const r=e&&e.expression;if("string"!=typeof r)return null;const s=cp(r);if(null!=s)return{cachedResult:s};const n=await(0,ae.a)(),a=n.arcadeUtils,o=a.createSyntaxTree(r);return a.dependsOnView(o)?(null!=i&&i.error("Expressions containing '$view' are not supported on ElevationInfo"),{cachedResult:0}):{arcade:{func:a.createFunction(o),context:a.createExecContext(null,{sr:t}),modules:n}}}function sp(e,t,i){return e.arcadeUtils.createFeature(t.attributes,t.geometry,i)}function np(e,t){if(null!=e&&!lp(e)){if(!t||!e.arcade)return void tp.errorOncePerTick("Arcade support required but not provided");const i=t;i._geometry&&(i._geometry=vu(i._geometry)),e.arcade.modules.arcadeUtils.updateExecContext(e.arcade.context,t)}}function ap(e,t=!1){let i=e&&e.featureExpressionInfo;const r=i&&i.expression;return t||"0"===r||(i=null),i}const op={cachedResult:0};function lp(e){return null!=e.cachedResult}function cp(e){return"0"===e?0:null}class hp{constructor(){this._meterUnitOffset=0,this._renderUnitOffset=0,this._unit="meters",this._metersPerElevationInfoUnit=1,this._featureExpressionInfoContext=null,this.centerPointInElevationSR=null,this.mode=null}get featureExpressionInfoContext(){return this._featureExpressionInfoContext}get meterUnitOffset(){return this._meterUnitOffset}get unit(){return this._unit}set unit(e){this._unit=e,this._metersPerElevationInfoUnit=(0,ne.r)(e)}reset(){this.mode=null,this._meterUnitOffset=0,this._renderUnitOffset=0,this._featureExpressionInfoContext=null,this.unit="meters"}set offsetMeters(e){this._meterUnitOffset=e,this._renderUnitOffset=0}set offsetElevationInfoUnits(e){this._meterUnitOffset=e*this._metersPerElevationInfoUnit,this._renderUnitOffset=0}addOffsetRenderUnits(e){this._renderUnitOffset+=e}geometryZWithOffset(e,t){const i=this.calculateOffsetRenderUnits(t);return null!=this.featureExpressionInfoContext?i:e+i}calculateOffsetRenderUnits(e){let t=this._meterUnitOffset;const i=this.featureExpressionInfoContext;return null!=i&&(t+=function(e){if(null!=e){if(lp(e))return e.cachedResult;const t=e.arcade;let i=e.arcade.modules.arcadeUtils.executeFunction(t.func,t.context);return"number"!=typeof i&&(e.cachedResult=0,i=0),i}return 0}(i)*this._metersPerElevationInfoUnit),t/e.unitInMeters+this._renderUnitOffset}setFromElevationInfo(e){this.mode=e.mode,this.unit=(0,ne.n)(e.unit)?e.unit:"meters",this.offsetElevationInfoUnits=(0,u.q)(e.offset,0)}updateFeatureExpressionInfoContext(e,t,i){if((0,u.t)(e))return void(this._featureExpressionInfoContext=null);const r=e&&e.arcade;r&&(0,u.r)(t)&&(0,u.r)(i)?(this._featureExpressionInfoContext=function(e){return{cachedResult:e.cachedResult,arcade:e.arcade?{func:e.arcade.func,context:e.arcade.modules.arcadeUtils.createExecContext(null,{sr:e.arcade.context.spatialReference}),modules:e.arcade.modules}:null}}(e),np(this._featureExpressionInfoContext,sp(r.modules,t,i))):this._featureExpressionInfoContext=e}static fromElevationInfo(e){const t=new hp;return(0,u.r)(e)&&t.setFromElevationInfo(e),t}}class dp{constructor(e,t,i,r,s,n,a,o=null){this.graphics3DSymbolLayer=e,this.stageObject=t,this._uniqueGeometries=i,this._uniqueMaterials=r,this._uniqueTextures=s,this.elevationAligner=n,this.elevationContext=a,this._edgeState=o,this.type="object3d",this.stageLayer=null,this.stage=null,this._visible=!1,this._addedToStage=!1,this.alignedSampledElevation=0,this.needsElevationUpdates=!1,this.useObjectOriginAsAttachmentOrigin=!1,this.graphics3DSymbolLayer=e,this.stageObject=t}get isElevationSource(){return!(!this.stageObject.metadata||!this.stageObject.metadata.isElevationSource)}initialize(e,t){this.stageLayer=t,this.stage=e,e.addMany(this._uniqueMaterials),e.addMany(this._uniqueGeometries),e.addMany(this._uniqueTextures),e.add(this.stageObject)}destroy(){const e=this.stage;this.stageLayer&&(e.removeMany(this._uniqueMaterials),e.removeMany(this._uniqueGeometries),e.removeMany(this._uniqueTextures)),e.remove(this.stageObject),this._addedToStage&&(this.stageLayer.remove(this.stageObject),this._addedToStage=!1);const t=this.stage.renderView.ensureEdgeView();t.hasObject(this.stageObject)&&t.removeObject(this.stageObject),this.stageObject.dispose(),this._visible=!1,this.stageLayer=null,this.stage=null}layerOpacityChanged(e,t){if((0,u.t)(this._edgeState))return;const i=up(this._edgeState.baseMaterial);let r=!1;for(const e of this._edgeState.edgeMaterials)e.objectTransparency!==i&&(e.objectTransparency=i,r=!0);r&&this.resetEdgeObject(t),this.stage.renderView.ensureEdgeView().updateAllComponentOpacities(this.stageObject,[e])}slicePlaneEnabledChanged(e,t){(0,u.t)(this._edgeState)||(this.stage.renderView.ensureEdgeView().updateAllComponentMaterials(this.stageObject,this._edgeState.edgeMaterials,{slicePlaneEnabled:e},!t),this._edgeState.properties.slicePlaneEnabled=e)}setVisibility(e){if(null!=this.stage&&this._visible!==e&&(this._visible=e,this._visible?this._addedToStage?this.stageObject.setVisible(!0):(this.stageLayer.add(this.stageObject),this._addedToStage=!0):this.stageObject.setVisible(!1),(0,u.r)(this._edgeState))){const t=this.stage.renderView.ensureEdgeView();t.hasObject(this.stageObject)?t.updateObjectVisibility(this.stageObject,e):e&&this.addOrUpdateEdgeObject(t,!1)}}get visible(){return this._visible}alignWithElevation(e,t,i,r){if(null==this.elevationAligner)return;(0,u.r)(i)&&np(this.elevationContext.featureExpressionInfoContext,i);const s=this.elevationAligner(this,this.elevationContext,e,t);null!=s&&(this.alignedSampledElevation=s),this.resetEdgeObject(r)}getCenterObjectSpace(e=(0,v.n)()){return(0,v.h)(e,(0,S.O)(this.stageObject.boundingVolumeObjectSpace.bounds))}getBoundingBoxObjectSpace(e=(0,se.a)()){const t=this.stageObject.boundingVolumeObjectSpace;return(0,se.q)(e,t.min),(0,se.w)(e,t.max),e}computeAttachmentOrigin(e){if(this.useObjectOriginAsAttachmentOrigin){const t=this.stageObject.transformation;e.render.origin[0]+=t[12],e.render.origin[1]+=t[13],e.render.origin[2]+=t[14],e.render.num++}else for(const t of this.stageObject.geometryRecords)t.computeAttachmentOrigin(fp)&&((0,v.I)(fp,fp,this.stageObject.transformation),(0,v.u)(e.render.origin,e.render.origin,fp),e.render.num++)}async getProjectedBoundingBox(e,t,i,r,s){const n=this.getBoundingBoxObjectSpace(s),a=gp,o=(0,se.S)(n)?1:a.length;for(let e=0;e<o;e++){const t=a[e];mp[0]=n[t[0]],mp[1]=n[t[1]],mp[2]=n[t[2]],(0,v.I)(mp,mp,this.stageObject.transformation),pp[3*e+0]=mp[0],pp[3*e+1]=mp[1],pp[3*e+2]=mp[2]}if(!e(pp,0,o))return null;(0,se.B)(n);let l=null;this.calculateRelativeScreenBounds&&(l=this.calculateRelativeScreenBounds());for(let e=0;e<3*o;e+=3){for(let t=0;t<3;t++)n[t]=Math.min(n[t],pp[e+t]),n[t+3]=Math.max(n[t+3],pp[e+t]);l&&i.push({location:pp.slice(e,e+3),screenSpaceBoundingRect:l})}if(t&&t.service&&"absolute-height"!==this.elevationContext.mode){(0,se.p)(n,fp);const e="relative-to-scene"===this.elevationContext.mode?"scene":"ground";let i=0;if(t.useViewElevation)i=(0,u.q)(t.service.getElevation(fp[0],fp[1],e),0);else try{const s=Du(n,t);i=(0,u.q)(await t.service.queryElevation(fp[0],fp[1],r,s,e),0)}catch(e){}(0,se.V)(n,0,0,-this.alignedSampledElevation+i)}return n}addObjectState(e,t){0===e&&t.addObject(this.stageObject,this.stageObject.highlight()),1===e&&t.addObject(this.stageObject,this.stageObject.maskOccludee())}removeObjectState(e){e.removeObject(this.stageObject)}resetEdgeObject(e){if((0,u.t)(this._edgeState))return;const t=this.stage.renderView.ensureEdgeView();this._visible?this.addOrUpdateEdgeObject(t,e):t.removeObject(this.stageObject)}addOrUpdateEdgeObject(e,t){const i=this._edgeState;if((0,u.t)(i))return;const r=up(i.baseMaterial);for(const e of i.edgeMaterials)e.objectTransparency=r;e.addOrUpdateObject3D(this.stageObject,i.edgeMaterials,i.properties,!t).then((()=>{var e;return null==(e=this.stageLayer)?void 0:e.sync()}))}}function up(e){return e.isVisible?e.params.transparent?1:2:0}const pp=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],mp=(0,v.n)(),fp=(0,v.n)(),gp=[[0,1,2],[3,1,2],[0,4,2],[3,4,2],[0,1,5],[3,1,5],[0,4,5],[3,4,5]];class vp{constructor(e){this.schedule=e,this._abortController=null,this._loadStatus=0,this._loadError=null,this._loader=null,this.logger=null}get loadStatus(){return this._loadStatus}load(e,t){return 1===this._loadStatus?(e&&e(),this._loader):2===this._loadStatus?(t&&t(this._loadError),this._loader):(this._loader||(this._abortController=(0,h.h)(),this._loader=this.doLoad(this._abortController.signal).then((()=>{this._abortController=null,this._loadStatus=1}),(e=>{throw this._loadError=e,this._abortController=null,this._loadStatus=2,!(0,h.g)(e)&&this.logger&&e.message&&this.logger.warn(e.message),e}))),this._loader.then(e,t).catch((()=>{})),this._loader)}abortLoad(){this._abortController?(this._abortController.abort(),this._abortController=null):0===this._loadStatus&&(this._loadStatus=2),this._loader=null}}function yp(e,t){const i=(e,i,r=!1)=>({levels:e.map((e=>{const s=i(e.tesselation);return r&&lr.cgToGIS(s),{components:[{geometry:s,material:t}],faceCount:s.indexCount/3,minScreenSpaceRadius:e.minScreenSpaceRadius}}))});switch(e){case"sphere":return i([{tesselation:0,minScreenSpaceRadius:0},{tesselation:1,minScreenSpaceRadius:8},{tesselation:2,minScreenSpaceRadius:16},{tesselation:3,minScreenSpaceRadius:50},{tesselation:4,minScreenSpaceRadius:250}],(e=>lr.createPolySphereGeometry(.5,e,!0)));case"cube":return i([{tesselation:0,minScreenSpaceRadius:0}],(()=>lr.createBoxGeometry(1)));case"cone":return i(_p,(e=>lr.createConeGeometry(1,.5,e,!1)),!0);case"inverted-cone":return i(_p,(e=>lr.createConeGeometry(1,.5,e,!0)),!0);case"cylinder":return i(_p,(e=>lr.createCylinderGeometry(1,.5,e,[0,0,1],[0,0,.5])));case"tetrahedron":return i([{tesselation:0,minScreenSpaceRadius:0}],(()=>lr.createTetrahedronGeometry(1)),!0);case"diamond":return i([{tesselation:0,minScreenSpaceRadius:0}],(()=>lr.createDiamondGeometry(1)),!0);default:return}}const _p=[{tesselation:6,minScreenSpaceRadius:0},{tesselation:18,minScreenSpaceRadius:7},{tesselation:64,minScreenSpaceRadius:65}];function xp(e,t){return bp(function(e){return e&&e.enabled&&e.edges||null}(e),t)}function bp(e,t){if((0,u.t)(e))return null;const i=(0,u.r)(e.color)?(0,w.e)(z.o.toUnitRGBA(e.color)):(0,w.a)(0,0,0,0),r=(0,f.u)(e.size),s=(0,f.u)(e.extensionLength);switch(e.type){case"solid":return wp({color:i,size:r,extensionLength:s,...t});case"sketch":return function(e){return{...Tp,...e,type:"sketch"}}({color:i,size:r,extensionLength:s,...t});default:return}}function wp(e){return{...Cp,...e,type:"solid"}}const Cp={color:(0,w.a)(0,0,0,.2),size:1,extensionLength:0,opacity:1,objectTransparency:2},Tp={color:(0,w.a)(0,0,0,.2),size:1,extensionLength:0,opacity:1,objectTransparency:2};function Sp(e){const t=[];return e.levels.forEach((e=>{e.components.forEach((e=>{t.push(e.material)}))})),(0,r.F)(t)}function Pp(e){const t=[];return e.components.forEach((e=>{t.push(e.geometry)})),(0,r.F)(t)}const Rp={primitivesPerFeature:0,primitivesPerCoordinate:0,drawCallsPerFeature:0,estimated:!0,memory:{bytesPerFeature:0,bytesPerCoordinate:0,bytesPerFeatureLabel:0,draped:{bytesPerFeature:0,bytesPerFeatureLabel:0,bytesPerCoordinate:0}}};function Ap(e){return"web-style"===e.type?Rp:Mp(e.symbolLayers.toArray().map((t=>Ep(e,t))))}function Mp(e){let t=0,i=0,r=0,s=!1,n=0;const a={bytesPerFeature:0,bytesPerFeatureLabel:0,bytesPerCoordinate:0,draped:{bytesPerFeature:0,bytesPerFeatureLabel:0,bytesPerCoordinate:0}};for(const o of e)(0,u.t)(o)||(t+=o.primitivesPerFeature,i+=o.primitivesPerCoordinate,r+=o.drawCallsPerFeature,a.bytesPerFeature+=o.memory.bytesPerFeature,a.bytesPerFeatureLabel+=o.memory.bytesPerFeatureLabel,a.bytesPerCoordinate+=o.memory.bytesPerCoordinate,a.draped.bytesPerFeature+=o.memory.bytesPerFeature,a.draped.bytesPerFeatureLabel+=o.memory.bytesPerFeatureLabel,a.draped.bytesPerCoordinate+=o.memory.bytesPerCoordinate,s=s||o.estimated,++n);return{primitivesPerFeature:t,primitivesPerCoordinate:i,drawCallsPerFeature:r,estimated:s,memory:a,numComplexities:n}}function Op(e){const t=Mp(e);return t.numComplexities>0&&(t.primitivesPerFeature/=t.numComplexities,t.primitivesPerCoordinate/=t.numComplexities,t.drawCallsPerFeature/=t.numComplexities,t.memory.bytesPerFeature/=t.numComplexities,t.memory.bytesPerFeatureLabel/=t.numComplexities,t.memory.bytesPerCoordinate/=t.numComplexities,t.memory.draped.bytesPerFeature/=t.numComplexities,t.memory.draped.bytesPerFeatureLabel/=t.numComplexities,t.memory.draped.bytesPerCoordinate/=t.numComplexities),t}const Dp={};function Ep(e,t){const i=zp(e,t),r=function(e){return e&&e.enabled&&(function(e){return"extrude"===e.type}(e)||function(e){return"fill"===e.type}(e))&&(0,u.r)(e.edges)}(t)?2:0;switch(t.type){case"extrude":return{primitivesPerFeature:-4,primitivesPerCoordinate:4,drawCallsPerFeature:r,estimated:!1,memory:i};case"fill":return"mesh-3d"===e.type?{primitivesPerFeature:0,primitivesPerCoordinate:0,drawCallsPerFeature:r,estimated:!1,memory:i}:(0,u.r)(t.outline)&&t.outline.size>0?{primitivesPerFeature:-4,primitivesPerCoordinate:3,drawCallsPerFeature:0,estimated:!1,memory:i}:{primitivesPerFeature:-2,primitivesPerCoordinate:1,drawCallsPerFeature:0,estimated:!1,memory:i};case"water":return{primitivesPerFeature:-2,primitivesPerCoordinate:1,drawCallsPerFeature:0,estimated:!1,memory:i};case"line":return{primitivesPerFeature:-2,primitivesPerCoordinate:2,drawCallsPerFeature:0,estimated:!1,memory:i};case"object":return t.resource&&t.resource.href?{primitivesPerFeature:16,primitivesPerCoordinate:0,drawCallsPerFeature:0,estimated:!0,memory:i}:{...Ip(t.resource&&t.resource.primitive||L.r),memory:i};case"path":{const e=3,r=3,s=10;let n=0,a=0;switch(t.profile){case"circle":n=s;break;case"quad":n=4;break;default:return void(0,Z.n)(t.profile)}switch(t.join){case"round":a=e;break;case"miter":case"bevel":a=1;break;default:return void(0,Z.n)(t.join)}const o=2*n,l=n*a*2;let c=-2*l-o;switch(t.cap){case"none":break;case"butt":case"square":c+=2*(n-1);break;case"round":c+=2*(n*(r-1)*2+n);break;default:return}return{primitivesPerFeature:c,primitivesPerCoordinate:l+o,drawCallsPerFeature:0,estimated:!1,memory:i}}case"text":case"icon":return{primitivesPerFeature:2,primitivesPerCoordinate:0,drawCallsPerFeature:0,estimated:!1,memory:i};default:return}}function zp(e,t){const i="point-3d"===e.type;switch(t.type){case"extrude":return t.edges&&t.edges.size>0?Lp.EXTRUDE_EDGES:Lp.EXTRUDE;case"fill":return(0,u.r)(t.outline)&&t.outline.size>0?Lp.FILL_OUTLINE:Lp.FILL;case"water":return Lp.FILL;case"line":return"round"===t.join?Lp.LINE_ROUND:Lp.LINE_MITER;case"path":switch(t.join){case"round":switch(t.profile){case"circle":return Lp.PATH_ROUND_CIRCLE;case"quad":return Lp.PATH_ROUND_QUAD;default:return void(0,Z.n)(t.profile)}case"miter":case"bevel":switch(t.profile){case"circle":return Lp.PATH_MITER_CIRCLE;case"quad":return Lp.PATH_MITER_QUAD;default:return void(0,Z.n)(t.profile)}default:return void(0,Z.n)(t.join)}case"object":return i?Lp.OBJECT_POINT:Lp.OBJECT_POLYGON;case"icon":case"text":return i?Lp.ICON_POINT:Lp.ICON_POLYGON;default:return}}function Ip(e){let t=Dp[e];return t||(t={primitivesPerFeature:Pp(yp(e,null).levels[0]).reduce(((e,t)=>e+t.indices.get("position").length/3),0),primitivesPerCoordinate:0,drawCallsPerFeature:0,estimated:!1},Dp[e]=t,t)}const Lp={ICON_POINT:{bytesPerFeature:7127.413186968842,bytesPerFeatureLabel:4826.302896296296,bytesPerCoordinate:0,draped:{bytesPerFeature:3929.4396628895197,bytesPerFeatureLabel:3550.1332222222227,bytesPerCoordinate:0}},ICON_POLYGON:{bytesPerFeature:9329.452613976147,bytesPerFeatureLabel:3675.3372604938268,bytesPerCoordinate:60.177252982212096,draped:{bytesPerFeature:6190.247450139383,bytesPerFeatureLabel:3744.074358024691,bytesPerCoordinate:59.488211068026104}},OBJECT_POINT:{bytesPerFeature:2350.5884192634558,bytesPerFeatureLabel:4446.651003703703,bytesPerCoordinate:0,draped:{bytesPerFeature:2350.5884192634558,bytesPerFeatureLabel:4446.651003703703,bytesPerCoordinate:0}},OBJECT_POLYGON:{bytesPerFeature:4583.807620302299,bytesPerFeatureLabel:3665.342685185186,bytesPerCoordinate:60.11621818101506,draped:{bytesPerFeature:4583.807620302299,bytesPerFeatureLabel:3665.342685185186,bytesPerCoordinate:60.11621818101506}},LINE_MITER:{bytesPerFeature:7321.028181375921,bytesPerFeatureLabel:4048.0226716049388,bytesPerCoordinate:186.55621386363578,draped:{bytesPerFeature:4246.856619435009,bytesPerFeatureLabel:3852.3737679012347,bytesPerCoordinate:163.47884002621583}},LINE_ROUND:{bytesPerFeature:7482.205842738954,bytesPerFeatureLabel:4045.886987654321,bytesPerCoordinate:191.5452524171851,draped:{bytesPerFeature:4473.481387957992,bytesPerFeatureLabel:3842.1112395061728,bytesPerCoordinate:167.27703460226945}},PATH_MITER_CIRCLE:{bytesPerFeature:9010.489006415351,bytesPerFeatureLabel:4230.9109,bytesPerCoordinate:4618.2594178027275,draped:{bytesPerFeature:9010.489006415351,bytesPerFeatureLabel:4230.9109,bytesPerCoordinate:4618.2594178027275}},PATH_ROUND_CIRCLE:{bytesPerFeature:4104.727250200398,bytesPerFeatureLabel:4251.8525,bytesPerCoordinate:8019.043777064957,draped:{bytesPerFeature:4104.727250200398,bytesPerFeatureLabel:4251.8525,bytesPerCoordinate:8019.043777064957}},PATH_MITER_QUAD:{bytesPerFeature:9416.372942261387,bytesPerFeatureLabel:4241.2757,bytesPerCoordinate:3176.7222742582203,draped:{bytesPerFeature:9416.372942261387,bytesPerFeatureLabel:4241.2757,bytesPerCoordinate:3176.7222742582203}},PATH_ROUND_QUAD:{bytesPerFeature:6614.431545308682,bytesPerFeatureLabel:4206.7461,bytesPerCoordinate:5141.817789093826,draped:{bytesPerFeature:6614.431545308682,bytesPerFeatureLabel:4206.7461,bytesPerCoordinate:5141.817789093826}},FILL:{bytesPerFeature:9478.244183633637,bytesPerFeatureLabel:3713.816824691358,bytesPerCoordinate:95.9343604185578,draped:{bytesPerFeature:6287.911108168086,bytesPerFeatureLabel:3790.785032098766,bytesPerCoordinate:83.08783220478168}},FILL_OUTLINE:{bytesPerFeature:13085.871870349445,bytesPerFeatureLabel:3392.613241975309,bytesPerCoordinate:118.63968023169875,draped:{bytesPerFeature:8437.199992480122,bytesPerFeatureLabel:3973.5431172839503,bytesPerCoordinate:106.33556817014312}},EXTRUDE:{bytesPerFeature:19459.53727140414,bytesPerFeatureLabel:3743.7045209876546,bytesPerCoordinate:372.6819978900477,draped:{bytesPerFeature:19459.53727140414,bytesPerFeatureLabel:3743.7045209876546,bytesPerCoordinate:372.6819978900477}},EXTRUDE_EDGES:{bytesPerFeature:22266.888534913724,bytesPerFeatureLabel:3064.3193358024696,bytesPerCoordinate:374.3725221561312,draped:{bytesPerFeature:22266.888534913724,bytesPerFeatureLabel:3064.3193358024696,bytesPerCoordinate:374.3725221561312}}},Fp=u.n.getLogger("esri.views.3d.layers.graphics.Graphics3DSymbolLayer");class Vp extends vp{constructor(e,t,i,r){super(i.schedule),this._context=i,this._elevationInfoOverride=null,this.complexity=null,this.logger=Fp,this._elevationOptions={supportsOffsetAdjustment:!1,supportsOnTheGround:!0},this.symbol=e,this.symbolLayer=t,this._renderPriority=r.renderPriority,this._renderPriorityStep=r.renderPriorityStep,this._elevationContext=new hp,this.complexity=this.computeComplexity(),this._updateDrivenProperties(r.ignoreDrivers),this._updateElevationContext()}getCachedSize(){return null}get extentPadding(){return 0}get needsDrivenTransparentPass(){return this._drivenProperties.opacity&&!this._drivenProperties.opacityAlwaysOpaque}_logGeometryCreationWarnings(e,t,i,r){const s=e.projectionSuccess,n="polygons"in e?e.polygons:null,a=`${r} geometry failed to be created`;let o=null;s?!t.length||1===t.length&&!t[0].length?o=`${a} (no ${i} were defined)`:Array.isArray(t)&&Array.isArray(t[0])?n&&0===n.length&&"rings"===i&&t.length>0&&t[0].length>2&&(o=`${a} (filled rings should use clockwise winding - try reversing the order of vertices)`):o=`${a} (${i} should be defined as a 2D array)`:o=`${a} (failed to project geometry to view spatial reference)`,o&&Fp.warnOncePerTick(o)}_validateGeometry(e,t=null,i=null){if((0,u.r)(t)&&!t.includes(e.type))return this.logger.warn("unsupported geometry type for "+i+` symbol: ${e.type}`),!1;if("point"===e.type){const t=e;if(!(0,v.K)(t.x)||!(0,v.K)(t.y))return Fp.warn("point coordinate is not a valid number, graphic skipped"),!1}return!0}_defaultElevationInfoNoZ(){return Gp}_defaultElevationInfoZ(){return Bp}_updateElevationContext(){(0,u.r)(this._elevationInfoOverride)?(this._elevationContext.setFromElevationInfo(this._elevationInfoOverride),this._elevationContext.updateFeatureExpressionInfoContext(null)):this._context.layer.elevationInfo?(this._elevationContext.setFromElevationInfo(this._context.layer.elevationInfo),this._elevationContext.updateFeatureExpressionInfoContext(this._context.featureExpressionInfoContext)):this._elevationContext.reset()}getDefaultElevationInfo(e){return e.hasZ?this._defaultElevationInfoZ():this._defaultElevationInfoNoZ()}getGeometryElevationMode(e,t=this.getDefaultElevationInfo(e)){return this._elevationContext.mode||t.mode}setElevationInfoOverride(e){this._elevationInfoOverride=e,this._updateElevationContext()}setGraphicElevationContext(e,t){const i=(0,u.f)(e.geometry),r=this.getDefaultElevationInfo(i);t.unit=null!=this._elevationContext.unit?this._elevationContext.unit:r.unit,t.mode=this.getGeometryElevationMode(i,r),t.offsetMeters=(0,u.q)(this._elevationContext.meterUnitOffset,(0,u.q)(r.offset,0));const s=!this._elevationOptions.supportsOnTheGround&&"on-the-ground"===t.mode;s&&(t.mode="relative-to-ground",t.offsetMeters=0);const n=s?op:this._elevationContext.featureExpressionInfoContext;return t.updateFeatureExpressionInfoContext(n,e,this._context.layer),t}prepareSymbolLayerPatch(e){}updateGeometry(e,t){return!1}onRemoveGraphic(e){}_updateDrivenProperties(e){const t={color:!1,opacity:!1,opacityAlwaysOpaque:!0,size:!1};if(e)return void(this._drivenProperties=t);const i=this._context.renderer;i&&"visualVariables"in i&&i.visualVariables&&i.visualVariables.forEach((e=>{switch(e.type){case"color":if(t.color=!0,e.stops)for(let i=0;i<e.stops.length;i++){const r=e.stops[i].color;r&&(t.opacity=!0,r.a<1&&(t.opacityAlwaysOpaque=!1))}break;case"opacity":t.opacity=!0,t.opacityAlwaysOpaque=!1;break;case"size":t.size=!0}})),this._drivenProperties=t}_getLayerOpacity(){if(this._context.layerView&&"fullOpacity"in this._context.layerView)return this._context.layerView.fullOpacity;const e=this._context.layer.opacity;return null==e?1:e}_getCombinedOpacity(e,t=qp){let i=1;return this.draped||(i*=this._getLayerOpacity()),this._drivenProperties.opacity||((0,u.r)(e)?i*=e.a:t.hasIntrinsicColor||(i=0)),i}_getCombinedOpacityAndColor(e,t=qp){const i=this._getCombinedOpacity(e,t);return this._drivenProperties.color?Pu(null,i):Pu((0,u.r)(e)?z.o.toUnitRGB(e):v.l,i)}_getVertexOpacityAndColor(e,t=null){const i=Pu(this._drivenProperties.color?e.color:null,this._drivenProperties.opacity?e.opacity:null);return(0,u.r)(t)&&(i[0]*=t,i[1]*=t,i[2]*=t,i[3]*=t),i}isFastUpdatesEnabled(){return this._fastUpdates&&this._fastUpdates.enabled}computeComplexity(){return Ep(this.symbol,this.symbolLayer)}destroy(){this.abortLoad()}globalPropertyChanged(e,t,i){switch(e){case"opacity":return this.layerOpacityChanged(t,i);case"elevationInfo":{const e=this._elevationContext.mode;return this._updateElevationContext(),this.layerElevationInfoChanged(t,i,e)!==Gu.RECREATE}case"slicePlaneEnabled":return this.slicePlaneEnabledChanged(t,i);case"physicalBasedRenderingEnabled":return this.physicalBasedRenderingChanged();case"pixelRatio":return this.pixelRatioChanged();default:return!1}}updateGraphics3DGraphicElevationInfo(e,t,i){let r=Gu.UPDATE;return e.forEach((e=>{const s=t(e);if((0,u.r)(s)){const t=e.graphic;this.setGraphicElevationContext(t,s.elevationContext),s.needsElevationUpdates=i(s.elevationContext.mode)}else r=Gu.RECREATE})),r}applyRendererDiff(e,t){return!1}getFastUpdateAttrValues(e){if(!this._fastUpdates.enabled)return null;const t=this._fastUpdates.visualVariables,i=t.size?Up(t.size.field,e):0,r=t.color?Up(t.color.field,e):0,s=t.opacity?Up(t.opacity.field,e):0;return(0,w.a)(i,r,s,0)}get draped(){return this._draped}ensureDrapedStatus(e){return null==this._draped?(this._draped=e,!0):(e!==this.draped&&Fp.warnOnce("A symbol can only produce either draped or non-draped visualizations. Use two separate symbol instances for draped and non-draped graphics if necessary."),!1)}}function Up(e,t){const i=null!=e?t.attributes[e]:0;return null!=i&&isFinite(i)?i:0}const Gp={mode:"on-the-ground",offset:0,unit:"meters"},Bp={mode:"absolute-height",offset:0,unit:"meters"},qp={hasIntrinsicColor:!1},kp=(0,v.n)();function Np(e,t,i,r,s,n,a,o,l,c){const h=i?i.length:0,d=e.clippingExtent;if((0,_.R)(t,kp,e.elevationProvider.spatialReference),(0,u.r)(d)&&!(0,se.E)(d,kp))return null;const p=e.renderCoordsHelper.spatialReference;(0,_.R)(t,kp,p);const m=e.localOriginFactory.getOrigin(kp),f=new Qs({castShadow:!1,metadata:{layerUid:o,graphicUid:l,usesVerticalDistanceToGround:!0}});for(let e=0;e<h;e++){const t=s?s[e]:T.a;f.addGeometry(i[e],r[e],t,n,m,c)}return{object:f,sampledElevation:Uu(f,t,e.elevationProvider,e.renderCoordsHelper,a)}}function jp(e,t,i){const r=e.elevationContext,s=i.spatialReference;(0,_.R)(t,kp,s),r.centerPointInElevationSR=(0,ie.v)(kp[0],kp[1],t.hasZ?kp[2]:0,s)}function Hp(e){switch(e.type){case"point":return e;case"polygon":case"extent":return bu(e);case"polyline":{const t=e.paths[0];if(!t||0===t.length)return null;const i=(0,A.l)(t,(0,A.s)(t)/2);return(0,ie.v)(i[0],i[1],i[2],e.spatialReference)}case"mesh":return e.origin}return null}function Wp(e){const t=new S.n;return t.include(Gr),t.include(Hh,e),t.include(S.N,e),t.attributes.add("uv0","vec2"),t.vertex.uniforms.add("lineSize","float").add("pixelToNDC","vec2").add("borderSize","float").add("screenOffset","vec2"),t.varyings.add("coverageSampling","vec4"),t.varyings.add("lineSizes","vec2"),e.multipassGeometryEnabled&&t.varyings.add("depth","float"),t.vertex.code.add(S.t`
    void main(void) {
      ProjectHUDAux projectAux;
      vec4 endPoint = projectPositionHUD(projectAux);

      vec3 vpos = projectAux.posModel;
      if (rejectBySlice(vpos)) {
        gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
        return;
      }
    ${e.occlusionTestEnabled?S.t`
      if (!testVisibilityHUD(endPoint)) {
        gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
        return;
      }`:""}

    ${e.screenSizePerspectiveEnabled?S.t`
      vec4 perspectiveFactor = screenSizePerspectiveScaleFactor(projectAux.absCosAngle, projectAux.distanceToCamera, screenSizePerspectiveAlignment);
      vec2 screenOffsetScaled = applyScreenSizePerspectiveScaleFactorVec2(screenOffset, perspectiveFactor);
        `:S.t`
      vec2 screenOffsetScaled = screenOffset;
        `}
      // Add view dependent polygon offset to get exact same original starting point. This is mostly
      // used to get the correct depth value
      vec3 posView = (view * vec4(position, 1.0)).xyz;
      ${e.multipassGeometryEnabled?"depth = posView.z;":""}

      applyHUDViewDependentPolygonOffset(auxpos1.w, projectAux.absCosAngle, posView);
      vec4 startPoint = proj * vec4(posView, 1.0);
      // Apply screen offset to both start and end point
      vec2 screenOffsetNorm = screenOffsetScaled * 2.0 / viewport.zw;
      startPoint.xy += screenOffsetNorm * startPoint.w;
      endPoint.xy += screenOffsetNorm * endPoint.w;
      // Align start and end to pixel origin
      vec4 startAligned = alignToPixelOrigin(startPoint, viewport.zw);
      vec4 endAligned = alignToPixelOrigin(endPoint, viewport.zw);
    ${e.depthHudEnabled?e.depthHudAlignStartEnabled?S.t`endAligned = vec4(endAligned.xy / endAligned.w * startAligned.w, startAligned.zw);`:S.t`startAligned = vec4(startAligned.xy / startAligned.w * endAligned.w, endAligned.zw);`:""}
      vec4 projectedPosition = mix(startAligned, endAligned, uv0.y);
      // The direction of the line in screen space
      vec2 screenSpaceDirection = normalize(endAligned.xy / endAligned.w - startAligned.xy / startAligned.w);
      vec2 perpendicularScreenSpaceDirection = vec2(screenSpaceDirection.y, -screenSpaceDirection.x);
    ${e.screenSizePerspectiveEnabled?S.t`
      float lineSizeScaled = applyScreenSizePerspectiveScaleFactorFloat(lineSize, perspectiveFactor);
      float borderSizeScaled = applyScreenSizePerspectiveScaleFactorFloat(borderSize, perspectiveFactor);
        `:S.t`
      float lineSizeScaled = lineSize;
      float borderSizeScaled = borderSize;
        `}
      float halfPixelSize = lineSizeScaled * 0.5;
      // Calculate a pixel offset from the edge of the pixel, s.t. we keep the line aligned
      // to pixels if it has a full pixel size. Since pixel aligned biases to the bottom-left,
      // we bias the size to the right (for odd sizes) to balance out the bias. Grow sub-pixel
      // sizes towards the left or right s.t. there is a smooth transition (e.g. from 2 to 3 px).
      float halfWholePixelSize = floor(lineSizeScaled) * 0.5;
      float halfPixelSizeInt = floor(halfWholePixelSize);

      // Sub-pixel offset if we need to grow sub-pixels to the left
      float subpixelOffset = -fract(lineSizeScaled) * float(halfWholePixelSize > 0.0);

      // Pixel offset aligning to whole pixels and adding subpixel offset if needed
      float pixelOffset = -halfPixelSizeInt + subpixelOffset;

      // Compute full ndc offset, adding 1px padding for doing anti-aliasing and the border size
      float padding = 1.0 + borderSizeScaled;
      vec2 ndcOffset = (pixelOffset - padding + uv0.x * (lineSizeScaled + padding + padding)) * pixelToNDC;

      // Offset x/y from the center of the line in screen space
      projectedPosition.xy += perpendicularScreenSpaceDirection * ndcOffset * projectedPosition.w;

      // Compute a coverage varying which we can use in the fragment shader to determine
      // how much a pixel is actually covered by the line (i.e. to anti alias the line).
      // This works by computing two coordinates that can be linearly interpolated and then
      // subtracted to find out how far away from the line edge we are.
      float edgeDirection = (uv0.x * 2.0 - 1.0);

      float halfBorderSize = 0.5 * borderSizeScaled;
      float halfPixelSizeAndBorder = halfPixelSize + halfBorderSize;
      float outerEdgeCoverageSampler = edgeDirection * (halfPixelSizeAndBorder + halfBorderSize + 1.0);

      float isOneSided = float(lineSizeScaled < 2.0 && borderSize < 2.0);

      coverageSampling = vec4(
        // Edge coordinate
        outerEdgeCoverageSampler,

        // Border edge coordinate
        outerEdgeCoverageSampler - halfPixelSizeAndBorder * isOneSided,

        // Line offset
        halfPixelSize - 0.5,

        // Border offset
        halfBorderSize - 0.5 + halfPixelSizeAndBorder * (1.0 - isOneSided)
      );

      lineSizes = vec2(lineSizeScaled, borderSizeScaled);

      gl_Position = projectedPosition;
    }
  `),t.fragment.uniforms.add("color","vec4"),t.fragment.uniforms.add("borderColor","vec4"),e.multipassGeometryEnabled&&(t.fragment.include(Qh,e),t.fragment.uniforms.add("inverseViewport","vec2")),t.fragment.code.add(S.t`
    void main() {
      ${e.multipassGeometryEnabled?"if( geometryDepthTest(gl_FragCoord.xy * inverseViewport, depth) ){ discard; }":""}

      // Mix between line and border coverage offsets depending on whether we need
      // a border (based on the sidedness).
      vec2 coverage = min(1.0 - clamp(abs(coverageSampling.xy) - coverageSampling.zw, 0.0, 1.0), lineSizes);

      // Mix between border and line color based on the line coverage (conceptually the line
      // blends on top of the border background).
      //
      // Anti-alias by blending final result using the full (including optional border) coverage
      // and the color alpha
      float borderAlpha = color.a * borderColor.a * coverage.y;
      float colorAlpha = color.a * coverage.x;

      float finalAlpha = mix(borderAlpha, 1.0, colorAlpha);

    ${e.depthHudEnabled?S.t`
      if (finalAlpha < 0.01) {
        discard;
      }
      `:S.t`
      // Compute the finalRgb, but keep it pre-multiplied (for unpre-multiplied you
      // need to divide by finalAlpha). We avoid the division here by setting the
      // appropriate blending function in the material.
      vec3 finalRgb = mix(borderColor.rgb * borderAlpha, color.rgb, colorAlpha);
      gl_FragColor = vec4(finalRgb, finalAlpha);
      `}
  }
  `),t}var Qp;function Zp(e,t,i){3===i.length?e.setUniform4f(t,i[0],i[1],i[2],1):e.setUniform4fv(t,i)}!function(e){e.bindUniforms=function(e,t,i){Zp(e,"color",t.color),e.setUniform1f("pixelRatio",i),e.setUniform2f("screenOffset",t.screenOffset[0]*i,t.screenOffset[1]*i),null!==t.borderColor?(Zp(e,"borderColor",t.borderColor),e.setUniform1f("borderSize",i)):(e.setUniform4f("borderColor",0,0,0,0),e.setUniform1f("borderSize",0))}}(Qp||(Qp={}));var Yp=Object.freeze({__proto__:null,build:Wp,get LineCallout(){return Qp}});class Xp extends S.c{initializeProgram(e){const t=Xp.shader.get(),i=this.configuration,r=t.build({occlusionTestEnabled:i.occlusionTestEnabled,verticalOffsetEnabled:i.verticalOffset,screenSizePerspectiveEnabled:i.screenSizePerspective,depthHudEnabled:i.depthHudEnabled,depthHudAlignStartEnabled:i.depthHudAlignStartEnabled,screenCenterOffsetUnitsEnabled:i.screenCenterOffsetUnitsEnabled,slicePlaneEnabled:i.slicePlaneEnabled,sliceHighlightDisabled:!1,sliceEnabledForVertexPrograms:!0,viewingMode:e.viewingMode,isDraped:!1,multipassGeometryEnabled:i.multipassGeometryEnabled});return new S.d(e.rctx,r,S.o)}bindPass(e,t){(0,S.h)(this.program,t.camera.projectionMatrix),Qp.bindUniforms(this.program,e,t.camera.pixelRatio||1),(0,S.U)(this.program,e,t),Wh(this.program,t),this.program.setUniform2fv("cameraNearFar",t.camera.nearFar),this.program.setUniform2fv("inverseViewport",t.inverseViewport),Zh(this.program,t),this.program.bindTexture(t.hudVisibilityTexture,"hudVisibilityTexture"),this.program.setUniform1f("cameraGroundRelative",t.camera.aboveGround?1:-1),this.program.setUniform1f("polygonOffset",e.shaderPolygonOffset),(0,S.X)(this.program,t),this.program.setUniform1f("perDistancePixelRatio",Math.tan(t.camera.fovY/2)/(t.camera.fullViewport[2]/2)),this.program.setUniformMatrix4fv("viewNormal",t.camera.viewInverseTransposeMatrix),this.program.setUniform2f("pixelToNDC",2/t.camera.fullViewport[2],2/t.camera.fullViewport[3]);const i=t.camera.pixelRatio||1;this.program.setUniform1f("lineSize",Math.ceil(e.size)*i),(0,S.ai)(e.screenSizePerspective,this.program,"screenSizePerspectiveAlignment")}bindDraw(e){(0,S.a2)(this.program,e),(0,S.a3)(this.program,e.origin,e.camera.viewInverseTransposeMatrix),(0,S.a4)(this.program,this.configuration,e),this.program.rebindTextures()}setPipelineState(e){const t=e?519:513;return this.configuration.depthHudEnabled?(0,V.g)({depthTest:{func:t},depthWrite:V.l}):(0,V.g)({blending:(0,V.e)(1,770,771,771),depthTest:{func:t},colorWrite:V.r})}initializePipeline(){return this.setPipelineState(this.configuration.multipassGeometryEnabled)}}Xp.shader=new S.f(Yp,(()=>i.e(414).then(i.bind(i,20414))));class $p extends S.b{constructor(){super(...arguments),this.occlusionTestEnabled=!0,this.verticalOffset=!1,this.screenSizePerspective=!1,this.depthHudEnabled=!1,this.depthHudAlignStartEnabled=!1,this.screenCenterOffsetUnitsEnabled=0,this.slicePlaneEnabled=!1,this.multipassGeometryEnabled=!1}}(0,r.e)([(0,S.a)()],$p.prototype,"occlusionTestEnabled",void 0),(0,r.e)([(0,S.a)()],$p.prototype,"verticalOffset",void 0),(0,r.e)([(0,S.a)()],$p.prototype,"screenSizePerspective",void 0),(0,r.e)([(0,S.a)()],$p.prototype,"depthHudEnabled",void 0),(0,r.e)([(0,S.a)()],$p.prototype,"depthHudAlignStartEnabled",void 0),(0,r.e)([(0,S.a)({count:2})],$p.prototype,"screenCenterOffsetUnitsEnabled",void 0),(0,r.e)([(0,S.a)()],$p.prototype,"slicePlaneEnabled",void 0),(0,r.e)([(0,S.a)()],$p.prototype,"multipassGeometryEnabled",void 0);class Kp extends S.a6{constructor(e){super(e,em),this.techniqueConfig=new $p,this._uniqueMaterialIdentifier=Kp.uniqueMaterialIdentifier(this.params)}get uniqueMaterialIdentifier(){return this._uniqueMaterialIdentifier}dispose(){}getGLMaterial(e){return 0===e.output?new Jp(e):void 0}getPassParameters(){return this.params}getTechniqueConfig(e,t){return this.techniqueConfig.occlusionTestEnabled=this.params.occlusionTest,this.techniqueConfig.verticalOffset=!!this.params.verticalOffset,this.techniqueConfig.screenSizePerspective=!!this.params.screenSizePerspective,this.techniqueConfig.depthHudEnabled=e,this.techniqueConfig.depthHudAlignStartEnabled=!!this.params.depthHUDAlignStart,this.techniqueConfig.screenCenterOffsetUnitsEnabled="screen"===this.params.centerOffsetUnits?1:0,this.techniqueConfig.slicePlaneEnabled=this.params.slicePlaneEnabled,this.techniqueConfig.multipassGeometryEnabled=!!t&&t.multipassGeometryEnabled,this.techniqueConfig}intersect(){}createBufferWriter(){return new rm}validateParameterValues(e){const t=Kp.uniqueMaterialIdentifier(e);t!==this._uniqueMaterialIdentifier&&(this._uniqueMaterialIdentifier=t)}static uniqueMaterialIdentifier(e){return JSON.stringify({screenOffset:e.screenOffset||[0,0],centerOffsetUnits:e.centerOffsetUnits||"world"})}}class Jp extends S.aj{constructor(e){super(e),this._isRenderSlot=!0,this.updateParameters()}updateParameters(e){this._technique=this._techniqueRep.releaseAndAcquire(Xp,this._material.getTechniqueConfig(!1,e),this._technique),this._depthTechnique=this._techniqueRep.releaseAndAcquire(Xp,this._material.getTechniqueConfig(!0,e),this._depthTechnique)}beginSlot(e){switch(e){case 20:return this._isRenderSlot=!0,!0;case 21:return this._isRenderSlot=!1,!0}return!1}get technique(){return this._isRenderSlot?this._technique:this._depthTechnique}ensureParameters(e){this.updateParameters(e)}bind(e){this.technique.bindPass(this._material.getPassParameters(),e)}}const em={verticalOffset:null,screenSizePerspective:null,screenOffset:[0,0],color:[0,0,0,1],size:1,borderColor:null,occlusionTest:!1,shaderPolygonOffset:1e-5,depthHUDAlignStart:!1,centerOffsetUnits:"world",slicePlaneEnabled:!1,...S.ab},tm=(0,G.A)().vec3f("position").vec3f("normal").vec2f("uv0").vec4f("auxpos1"),im=[(0,oe.t)(0,0),(0,oe.t)(1,0),(0,oe.t)(0,1),(0,oe.t)(1,0),(0,oe.t)(1,1),(0,oe.t)(0,1)];class rm{constructor(){this.vertexBufferLayout=tm}allocate(e){return this.vertexBufferLayout.createBuffer(e)}elementCount(e){return 6*e.indices.get("position").length}write(e,t,i,r){(0,S.ac)(t.indices.get("position"),t.vertexAttributes.get("position").data,e.transformation,i.position,r,6),(0,S.ad)(t.indices.get("normal"),t.vertexAttributes.get("normal").data,e.invTranspTransformation,i.normal,r,6),(0,S.af)(t.indices.get("auxpos1"),t.vertexAttributes.get("auxpos1").data,i.auxpos1,r,6);for(let e=0;e<im.length;++e)i.uv0.setVec(r+e,im[e])}}class sm extends Vp{constructor(e,t){super(e,null,t,lm),this._elevationOptions={supportsOffsetAdjustment:!0,supportsOnTheGround:!1},this.ensureDrapedStatus(!1)}async doLoad(){this._material=new Kp(this.materialParameters),this._context.stage.add(this._material)}destroy(){super.destroy(),this._context.stage.remove(this._material),this._material=null}perInstanceMaterialParameters(e){const t=this.materialParameters;return t.screenOffset=e.screenOffset||[0,0],t.centerOffsetUnits=e.centerOffsetUnits||"world",t}get materialParameters(){const e=this.symbol,t=e.callout,i=(0,u.r)(t.color)?z.o.toUnitRGBA(t.color):[0,0,0,0];i[3]*=this._getLayerOpacity();const r=(0,f.u)(t.size||0);let s=null;if(e.verticalOffset){const{screenLength:t,minWorldLength:i,maxWorldLength:r}=e.verticalOffset;s={screenLength:(0,f.u)(t),minWorldLength:i||0,maxWorldLength:null!=r?r:1/0}}const n=(0,u.r)(t.border)&&(0,u.r)(t.border.color)?z.o.toUnitRGBA(t.border.color):null,a="object"===e.symbolLayers.getItemAt(0).type,o=!a,l=a?0:void 0,c="label-3d"===e.type;return{color:i,size:r,verticalOffset:s,screenSizePerspective:this._context.screenSizePerspectiveEnabled?this._context.sharedResources.screenSizePerspectiveSettings:null,screenOffset:[0,0],centerOffsetUnits:"world",borderColor:n,occlusionTest:o,shaderPolygonOffset:l,depthHUDAlignStart:c,slicePlaneEnabled:this._context.slicePlaneEnabled,renderOccluded:S.ab.renderOccluded}}_defaultElevationInfoNoZ(){return om}createGraphics3DGraphic(e){const t=e.renderingInfo,i=e.graphic,r=this.setGraphicElevationContext(i,new hp,t.elevationOffset||0),s=t.symbol,n="on-the-ground"===this._elevationContext.mode&&("cim"===s.type||!s.symbolLayers.some((e=>"object"===e.type||"text"===e.type)));if("label-3d"!==s.type&&n)return null;const a=bu(i.geometry);return(0,u.t)(a)?null:this._createAs3DShape(a,r,t,i.uid)}layerOpacityChanged(){return(0,u.t)(this._material)||this._material.setParameterValues(this.materialParameters),!0}layerElevationInfoChanged(e,t,i){const r=this._elevationContext.mode,s=Lu(sm.elevationModeChangeTypes,i,r);return s!==Gu.UPDATE||e.forEach((e=>{const i=t(e);(0,u.r)(i)&&this.updateGraphicElevationContext(e.graphic,i)})),s}slicePlaneEnabledChanged(){return(0,u.t)(this._material)||this._material.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled}),!0}physicalBasedRenderingChanged(){return!0}pixelRatioChanged(){return!0}setGraphicElevationContext(e,t,i=0){const r=super.setGraphicElevationContext(e,t);return r.addOffsetRenderUnits(i),r}updateGraphicElevationContext(e,t){this.setGraphicElevationContext(e,t.elevationContext,t.metadata.elevationOffset),t.needsElevationUpdates=Fu(t.elevationContext.mode)}updateGeometry(e,t){return!1}computeComplexity(){return{primitivesPerFeature:2,primitivesPerCoordinate:0,drawCallsPerFeature:0,estimated:!1,memory:Rp.memory}}createVertexData(e){const{translation:t,centerOffset:i}=e;return[["position",t?{size:3,data:[t[0],t[1],t[2]],exclusive:!0}:{size:3,data:[0,0,0],exclusive:!0}],["normal",{size:3,data:[0,0,1],exclusive:!0}],["auxpos1",i?{size:4,data:[i[0],i[1],i[2],i[3]],exclusive:!0}:{size:4,data:[0,0,0,1],exclusive:!0}]]}_getOrCreateMaterial(e){const t=this.perInstanceMaterialParameters(e),i=Kp.uniqueMaterialIdentifier(t);if((0,u.r)(this._material)&&i===this._material.uniqueMaterialIdentifier)return{material:this._material,isUnique:!1};if(e.materialCollection){let r=e.materialCollection.get(i);return(0,u.t)(r)&&(r=new Kp(t),e.materialCollection.add(i,r)),{material:r,isUnique:!1}}return{material:new Kp(t),isUnique:!0}}_createAs3DShape(e,t,i,r){const s=[new S.u(this.createVertexData(i),am,1)],n=this._getOrCreateMaterial(i),a=Np(this._context,e,s,[n.material],null,null,t,this._context.layer.uid,r);if(null===a)return null;const o=Hu,l=new dp(this,a.object,s,n.isUnique?[n.material]:null,null,o,t);return l.metadata={elevationOffset:i.elevationOffset||0},l.alignedSampledElevation=a.sampledElevation,l.needsElevationUpdates=Fu(t.mode),jp(l,e,this._context.elevationProvider),l}}sm.elevationModeChangeTypes={definedChanged:Gu.UPDATE,staysOnTheGround:Gu.UPDATE,onTheGroundChanged:Gu.RECREATE};const nm=new Uint16Array([0]),am=[["position",nm],["normal",nm],["auxpos1",nm]],om={mode:"relative-to-ground",offset:0},lm={ignoreDrivers:!0,renderPriority:0,renderPriorityStep:1},cm=u.n.getLogger("esri.views.3d.layers.graphics.Graphics3DCalloutSymbolLayerFactory");function hm(e,t){if(!(0,L.s)(e))return cm.error("Graphics3DCalloutSymbolLayerFactory#make",`symbol of type '${e.type}' does not support callouts`),null;if(!e.callout)return null;const i=dm[e.callout.type];return i?new i(e,t):(cm.error("Graphics3DCalloutSymbolLayerFactory#make",`unknown or unsupported callout type ${e.callout.type}`),null)}const dm={line:sm};class um{constructor(e,t,i){this.graphic=e,this.renderingInfo=t,this.layer=i}}const pm=new r.h(Array,(e=>(0,se.A)(e,se.H)),null,10,5),mm=(0,b.i)();class fm{constructor(e,t,i,r,s){this._labelGraphics=new Array,this._auxiliaryGraphics=new Array,this._visibilityFlags=function(e,t){const i=new Array(2);for(let e=0;e<i.length;e++)i[e]=new Array(4);return i}(),this._featureExpressionFeature=null,this._optimizedGeometry={geometry:null,hasZ:!1,hasM:!1},this._extent=null,this.isElevationSource=!1,++t.referenced,this.graphics3DSymbol=t,this.graphic=e,this._graphics=i,this._featureExpressionFeature=s?sp(s,e,r):null;for(const e of this._graphics)(0,u.r)(e)&&(this.isElevationSource=this.isElevationSource||e.isElevationSource)}get labelGraphics(){return this._labelGraphics}get extent(){return this._extent}initialize(e,t,i){this._layer=t,this._stage=e,this.forEachSymbolLayerGraphic((r=>{r.initialize(e,t,i),r.setVisibility(this.isVisible())}))}destroy(){this.forEachSymbolLayerGraphic((e=>e.destroy())),this._graphics=null,this._auxiliaryGraphics=null,--this.graphics3DSymbol.referenced,this.graphics3DSymbol=null}get destroyed(){return null==this._graphics}clearLabelGraphics(){this.forEachLabelGraphic((e=>e.destroy())),this._labelGraphics.length=0}addLabelGraphic(e,t,i){this._labelGraphics.push(e),e.initialize(t,i),e.setVisibility(this.isVisible(1))}addAuxiliaryGraphic(e){this._auxiliaryGraphics.push(e),this._layer&&(e.initialize(this._stage,this._layer),e.setVisibility(this.isVisible()))}get isDraped(){let e=!1;return this.forEachSymbolLayerGraphic((t=>{"draped"===t.type&&(e=!0)})),e}isVisible(e=0,t){for(let i=0;i<=e;i++){const e=this._visibilityFlags[i];for(let i=0;i<e.length;++i)if(!1===e[i]&&i!==t)return!1}return!0}hasVisibilityFlag(e,t){return null!=this._visibilityFlags[t][e]}setVisibilityFlag(e,t,i){const r=this.isVisible(i);this._visibilityFlags[i][e]=t;const s=this.isVisible(i);if(r===s)return!1;if(1===i)this.forEachLabelGraphic((e=>e.setVisibility(s)));else{this.forEachSymbolLayerGraphic((e=>e.setVisibility(s)));const e=this.isVisible(1);this.forEachLabelGraphic((t=>t.setVisibility(e)))}return!0}clearVisibilityFlag(e,t=0){return this.setVisibilityFlag(e,void 0,t)}computeExtent(e){if(!this._extent){const t=this.graphic.geometry;if((0,u.t)(t))return!1;this._extent=(0,b.i)(),(0,ie.J)(t,this._extent);const i=t.spatialReference;if(!i.equals(e)&&!(0,_.C)(this._extent,i,this._extent,e))return this._extent=null,!1}return!0}getAsOptimizedGeometry(e,t){return this._optimizedGeometry.geometry&&this._optimizedGeometry.hasZ===e&&this._optimizedGeometry.hasM===t||(this._optimizedGeometry.geometry=this._convertGraphicToOptimizedGeometry(this.graphic,e,t),this._optimizedGeometry.hasZ=e,this._optimizedGeometry.hasM=t),this._optimizedGeometry.geometry}_convertGraphicToOptimizedGeometry(e,t,i){let r=e.geometry;return"mesh"!==r.type&&"extent"!==r.type||(r=A.j.fromExtent("mesh"===r.type?r.extent:r)),(0,ce.X)(r,t,i)}get usedMemory(){let e=(0,le.e)(this.graphic.attributes);return this.forEachSymbolLayerGraphic((t=>{const i=t.graphics3DSymbolLayer.complexity;if((0,u.t)(i))return;const r="draped"===t.type?i.memory.draped:i.memory;e+=r.bytesPerFeature,r.bytesPerCoordinate&&(e+=(0,ie.w)(this.graphic.geometry)*r.bytesPerCoordinate)})),e}computeAttachmentOrigin(){const e={render:{origin:(0,v.n)(),num:0},draped:{origin:(0,N.n)(),num:0}};for(const t of this._graphics)(0,u.t)(t)||t.computeAttachmentOrigin(e);return e.render.num&&(0,v.d)(e.render.origin,e.render.origin,1/e.render.num),e.draped.num&&(0,k.l)(e.draped.origin,e.draped.origin,1/e.draped.num),e}async getProjectedBoundingBox(e,t,i,r,s){return s||(s={boundingBox:null,requiresDrapedElevation:!1,screenSpaceObjects:[]}),s.boundingBox?(0,se.B)(s.boundingBox):s.boundingBox=(0,se.B)(),s.requiresDrapedElevation=!1,await(0,ee.n)(this._graphics,(async n=>{if((0,u.t)(n))return;const a="draped"===n.type?t:e,o=pm.acquire(),l=await n.getProjectedBoundingBox(a,i,s.screenSpaceObjects,r,o);isFinite(l[2])&&isFinite(l[5])||(s.requiresDrapedElevation=!0),l&&(0,se.f)(s.boundingBox,o),pm.release(o)})),(0,se.l)(s.boundingBox)||(0,b.h)((0,se.G)(s.boundingBox,mm))?s:null}needsElevationUpdates(){for(const e of this._graphics)if((0,u.r)(e)&&("object3d"===e.type||"lod-instance"===e.type)&&e.needsElevationUpdates)return!0;for(const e of this._labelGraphics)if(e&&e.needsElevationUpdates)return!0;return!1}alignWithElevation(e,t,i){this.forEachRenderedGraphic((r=>{"object3d"!==r.type&&"lod-instance"!==r.type||r.alignWithElevation(e,t,this._featureExpressionFeature,i)}))}addObjectStateSet(e,t){this.forEachSymbolLayerGraphic((i=>i.addObjectState(e,t)))}removeObjectState(e){this.forEachSymbolLayerGraphic((t=>t.removeObjectState(e)))}forEachGraphicList(e,t){e.forEach((e=>e&&t(e)))}forEachSymbolLayerGraphic(e){this.forEachGraphicList(this._graphics,e),this.forEachGraphicList(this._auxiliaryGraphics,e)}forEachLabelGraphic(e){this.forEachGraphicList(this._labelGraphics,e)}forEachRenderedGraphic(e){this.forEachSymbolLayerGraphic(e),this.forEachLabelGraphic(e)}}function gm(e,t){if(!e||e.symbol)return null;const i=t&&t.renderer;return e&&(0,u.r)(i)&&i.getObservationRenderer?i.getObservationRenderer(e):i}function vm(e,t){const i=gm(e,t),r=function(e,t){if((0,u.r)(e.symbol))return e.symbol;const i=gm(e,t);return(0,u.r)(i)&&"dot-density"!==i.type?i.getSymbol(e,t):null}(e,t);if((0,u.t)(r))return null;const s={renderer:i,symbol:r};if((0,u.t)(i)||!("visualVariables"in i)||!i.visualVariables)return s;const n=(0,ue.getVisualVariableValues)(i,e,t),a=["proportional","proportional","proportional"];for(const{variable:e,value:t}of n)switch(e.type){case"color":s.color=t.toRgba();break;case"size":if("outline"===e.target)s.outlineSize=t;else{const i=e.axis,r=e.useSymbolValue?"symbol-value":t;switch(i){case"width":a[0]=r;break;case"depth":a[1]=r;break;case"height":a[2]=r;break;case"width-and-depth":a[0]=a[1]=r;break;default:a[0]=a[1]=a[2]=r}}break;case"opacity":s.opacity=t;break;case"rotation":switch(e.axis){case"tilt":s.tilt=t;break;case"roll":s.roll=t;break;default:s.heading=t}}return"proportional"===a[0]&&"proportional"===a[1]&&"proportional"===a[2]||(s.size=a),s}async function ym(e,t){const i=gm(e,t),r=await async function(e,t){if((0,u.r)(e.symbol))return e.symbol;const i=gm(e,t);return(0,u.r)(i)&&i.getSymbolAsync(e,{...t,abortOptions:{signal:t.signal}})}(e,t);if(!r)return null;const s={renderer:i,symbol:r};if(!i||!("visualVariables"in i)||!i.visualVariables)return s;const n=(0,ue.getVisualVariableValues)(i,e,t),a=["proportional","proportional","proportional"];for(const{variable:e,value:t}of n)if("color"===e.type)s.color=z.o.toUnitRGBA(t);else if("size"===e.type)if("outline"===e.target)s.outlineSize=t;else{const i=e.axis,r=e.useSymbolValue?"symbol-value":t;"width"===i?a[0]=r:"depth"===i?a[1]=r:"height"===i?a[2]=r:a[0]=a[1]="width-and-depth"===i?r:a[2]=r}else"opacity"===e.type?s.opacity=t:"rotation"===e.type&&"tilt"===e.axis?s.tilt=t:"rotation"===e.type&&"roll"===e.axis?s.roll=t:"rotation"===e.type&&(s.heading=t);return(isFinite(a[0])||isFinite(a[1])||isFinite(a[2]))&&(s.size=a),s}class _m{constructor(e,t){this.vec3=e,this.id=t}}function xm(e,t,i,r){return new _m((0,v.i)(e,t,i),r)}class bm{constructor(e,t){this.index=e,this.renderTargets=t,this.extent=(0,b.i)(),this.resolution=0,this.viewport=(0,b.i)(),this.renderLocalOrigin=xm(0,0,0,"O"),this.pixelRatio=1,this.canvasGeometries={extents:[(0,b.i)(),(0,b.i)(),(0,b.i)()],numViews:0},this.validTargets=null,this.hasDrapedFeatureSource=!1,this.hasDrapedRasterSource=!1,this.hasTargetWithoutRasterImage=!1,this.index=e,this.validTargets=new Array(t.renderTargets.length).fill(!1)}getValidTarget(e){return this.validTargets[e]?this.renderTargets.getTarget(e):null}get needsColorWithoutRasterImage(){return this.hasDrapedRasterSource&&this.hasDrapedFeatureSource&&this.hasTargetWithoutRasterImage}getColorTexture(e){const t=1===e?this.renderTargets.getTarget(0):2===e?this.renderTargets.getTarget(2):this.renderTargets.getTarget(4);return t?t.getTexture():null}getNormalTexture(e){const t=1===e?this.renderTargets.getTarget(3):null;return t?t.getTexture():null}draw(e,t){const i=this.computeRenderTargetValidityBitfield(),r=this.needsColorWithoutRasterImage;for(const i of this.renderTargets.renderTargets)1===i.type&&!1===r?this.validTargets[i.type]=!1:this.validTargets[i.type]=e.drawTarget(this,i,t);return i^this.computeRenderTargetValidityBitfield()?0:1}computeRenderTargetValidityBitfield(){const e=this.validTargets;return+e[0]|+e[1]<<1|+e[2]<<2|+e[3]<<3|+e[4]<<4}setupGeometryViewsCyclical(e){this.setupGeometryViewsDirect();const t=.001*e.range;if(this.extent[0]-t<=e.min){const t=this.canvasGeometries.extents[this.canvasGeometries.numViews++];(0,b.R)(this.extent,e.range,0,t)}if(this.extent[2]+t>=e.max){const t=this.canvasGeometries.extents[this.canvasGeometries.numViews++];(0,b.R)(this.extent,-e.range,0,t)}}setupGeometryViewsDirect(){this.canvasGeometries.numViews=1,(0,b.A)(this.canvasGeometries.extents[0],this.extent),(0,j.r)(this.viewport,0,0,this.resolution,this.resolution)}hasSomeSizedView(){for(let e=0;e<this.canvasGeometries.numViews;e++){const t=this.canvasGeometries.extents[e];if(t[0]!==t[2]&&t[1]!==t[3])return!0}return!1}applyViewport(e){const t=this.viewport;0===this.index?e.setViewport(t[0],t[1],t[2],t[3]):e.setViewport(t[0]+this.resolution,t[1],t[2],t[3])}}class wm{constructor(e,t){this.size=(0,oe.b)(),this._fbo=null,this._fbo=new V.o(e,{colorTarget:0,depthStencilTarget:0},{target:3553,pixelFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9987,hasMipmap:t,maxAnisotropy:8,width:0,height:0})}dispose(){this._fbo=(0,u.z)(this._fbo)}getTexture(){return this._fbo?this._fbo.colorTexture:null}isValid(){return null!==this._fbo}resize(e,t){this.size[0]=e,this.size[1]=t,this._fbo.resize(this.size[0],this.size[1])}bind(e){e.bindFramebuffer(this._fbo)}generateMipMap(){this._fbo.colorTexture.descriptor.hasMipmap&&this._fbo.colorTexture.generateMipmap()}disposeRenderTargetMemory(){var e;null==(e=this._fbo)||e.resize(0,0)}get gpuMemoryUsage(){var e,t;return null!=(e=null==(t=this._fbo)?void 0:t.gpuMemoryUsage)?e:0}}class Cm{constructor(e){this.renderTargets=null;const t=(t,i,r=!0)=>({type:i,fbo:new wm(e,r),renderPass:t,valid:!1,lastUsed:1/0});this.renderTargets=[t(0,0),t(0,1),t(5,2,!1),t(3,3),t(0,4)]}getTarget(e){return this.renderTargets[e].fbo}dispose(){for(const e of this.renderTargets)e.fbo.dispose()}disposeRenderTargetMemory(){for(const e of this.renderTargets)e.fbo.disposeRenderTargetMemory()}validateUsageForTarget(e,t,i){if(e)t.lastUsed=i;else if(i-t.lastUsed>Tm)t.fbo.disposeRenderTargetMemory(),t.lastUsed=1/0;else if(t.lastUsed<1/0)return!0;return!1}get gpuMemoryUsage(){return this.renderTargets.reduce(((e,t)=>e+t.fbo.gpuMemoryUsage),0)}}const Tm=1e3;class Sm{constructor(e){this.technique=e,this.refCount=0,this.refZeroFrame=0}}class Pm{constructor(e){this._context=e,this._perConstructorInstances=new Map,this._frameCounter=0,this._keepAliveFrameCount=1200}get viewingMode(){return this._context.viewingMode}get constructionContext(){return this._context}dispose(){this._perConstructorInstances.forEach((e=>e.forEach((e=>e.technique.dispose())))),this._perConstructorInstances.clear()}acquire(e,t){const i=t.key;let r=this._perConstructorInstances.get(e);r||(r=new Map,this._perConstructorInstances.set(e,r));let s=r.get(i);if(void 0===s){const n=new e(this._context,t,(()=>this.release(n)));s=new Sm(n),r.set(i,s)}return++s.refCount,s.technique}releaseAndAcquire(e,t,i){if((0,u.r)(i)){if(t.key===i.key)return i;i.release()}return this.acquire(e,t)}release(e){if((0,u.t)(e))return;const t=this._perConstructorInstances.get(e.constructor).get(e.key);--t.refCount,0===t.refCount&&(t.refZeroFrame=this._frameCounter)}frameUpdate(){this._frameCounter++,this._perConstructorInstances.forEach(((e,t)=>{e.forEach(((t,i)=>{0===t.refCount&&t.refZeroFrame+this._keepAliveFrameCount<this._frameCounter&&(t.technique.dispose(),e.delete(i))})),0===e.size&&this._perConstructorInstances.delete(t)}))}async hotReload(){const e=new Array;this._perConstructorInstances.forEach(((t,i)=>{e.push((async(e,t)=>{const i=t.shader;i&&(await i.reload(),e.forEach((e=>{e.technique.reload(this._context)})))})(t,i))})),await Promise.all(e)}}const Rm=[{output:0,name:"color"},{output:1,name:"depth"},{output:2,name:"normal"},{output:3,name:"depthShadowMap"},{output:4,name:"highlight"},{output:5,name:"draped"},{output:6,name:"occlusion"},{output:7,name:"alpha"}];function Am(e,t){return e+"_"+Rm.find((e=>e.output===t)).name}const Mm=u.n.getLogger("esri.views.3d.webgl-engine.lib.GLMaterialRep");class Om{constructor(e){this.refCnt=0,this.glMaterial=e}incRefCnt(){++this.refCnt}decRefCnt(){--this.refCnt,(0,S.i)(this.refCnt>=0)}getRefCnt(){return this.refCnt}getGLMaterial(){return this.glMaterial}}class Dm{constructor(e,t,i){this._textureRep=e,this._techniqueRep=t,this.onMaterialChanged=i,this._id2glMaterialRef=new Map}dispose(){this._textureRep.dispose()}acquire(e,t){this.ownMaterial(e);const i=Am(e.id,t);let r=this._id2glMaterialRef.get(i);if(null==r){const s=e.getGLMaterial({material:e,techniqueRep:this._techniqueRep,textureRep:this._textureRep,output:t});return r=new Om(s),r.incRefCnt(),this._id2glMaterialRef.set(i,r),s}return r.incRefCnt(),r.getGLMaterial()}release(e,t){const i=Am(e.id,t),r=this._id2glMaterialRef.get(i);if(r.decRefCnt(),0===r.getRefCnt()){const e=r.getGLMaterial();e&&e.dispose(),this._id2glMaterialRef.delete(i)}}materialChanged(e){for(const t of Rm)if(5!==t.output&&6!==t.output){const i=this._id2glMaterialRef.get(Am(e.id,t.output));if(i&&i.getGLMaterial()){const e=i.getGLMaterial();e.updateParameters&&e.updateParameters()}}this.onMaterialChanged&&this.onMaterialChanged(e)}ownMaterial(e){(0,u.r)(e.materialRepository)&&e.materialRepository!==this&&Mm.error("Material is already owned by a different material repository"),e.materialRepository=this}}const Em=["layerObjectAdded","layerObjectRemoved","layerObjectsAdded","layerObjectsRemoved","shaderTransformationChanged","objectTransformation","visibilityChanged","occlusionChanged","highlightChanged","objectGeometryAdded","objectGeometryRemoved","vertexAttrsUpdated"];class zm{constructor(e,t){this._objectToBoundingSphere=e,this._maximumObjectsPerNode=10,this._maximumDepth=20,this._degenerateObjects=new Set,this._root=new Im,this._objectCount=0,t&&(void 0!==t.maximumObjectsPerNode&&(this._maximumObjectsPerNode=t.maximumObjectsPerNode),void 0!==t.maximumDepth&&(this._maximumDepth=t.maximumDepth))}get bounds(){return this._root.bounds}get halfSize(){return this._root.halfSize}get root(){return this._root.node}get maximumObjectsPerNode(){return this._maximumObjectsPerNode}get maximumDepth(){return this._maximumDepth}get objectCount(){return this._objectCount}destroy(){this._degenerateObjects.clear(),Im.clearPool(),Hm[0]=null,Xm.prune(),rf.prune()}add(e,t=e.length){this._objectCount+=t,this._grow(e,t);const i=Im.acquire();for(let r=0;r<t;r++){const t=e[r];this._isDegenerate(t)?this._degenerateObjects.add(t):(i.init(this._root),this._add(t,i))}Im.release(i)}remove(e,t=null){this._objectCount-=e.length;const i=Im.acquire();for(const r of e){const e=(0,u.r)(t)?t:(0,S.ak)(this._objectToBoundingSphere(r),$m);qm(e[3])?(i.init(this._root),this._remove(r,e,i)):this._degenerateObjects.delete(r)}Im.release(i),this._shrink()}update(e,t){if(!qm(t[3])&&this._isDegenerate(e))return;const i=function(e){return Hm[0]=e,Hm}(e);this.remove(i,t),this.add(i)}forEachAlongRay(e,t,i){const r=(0,S.g)(e,t);this._forEachNode(this._root,(e=>{if(!this._intersectsNode(r,e))return!1;const t=e.node;return t.terminals.forAll((e=>{this._intersectsObject(r,e)&&i(e)})),null!==t.residents&&t.residents.forAll((e=>{this._intersectsObject(r,e)&&i(e)})),!0}))}forEachAlongRayWithVerticalOffset(e,t,i,r){const s=(0,S.g)(e,t);this._forEachNode(this._root,(e=>{if(!this._intersectsNodeWithOffset(s,e,r))return!1;const t=e.node;return t.terminals.forAll((e=>{this._intersectsObjectWithOffset(s,e,r)&&i(e)})),null!==t.residents&&t.residents.forAll((e=>{this._intersectsObjectWithOffset(s,e,r)&&i(e)})),!0}))}forEach(e){this._forEachNode(this._root,(t=>{const i=t.node;return i.terminals.forAll(e),null!==i.residents&&i.residents.forAll(e),!0})),this._degenerateObjects.forEach(e)}forEachDegenerateObject(e){this._degenerateObjects.forEach(e)}findClosest(e,t,i,r=(()=>!0),s=1/0){let n=1/0,a=1/0,o=null;const l=Gm(e,t),c=l=>{if(--s,!r(l))return;const c=this._objectToBoundingSphere(l);if(!Ra(i,c))return;const h=Bm(e,t,(0,S.O)(c)),d=h-c[3],u=h+c[3];d<n&&(n=d,a=u,o=l)};return this._forEachNodeDepthOrdered(this._root,(r=>{if(s<=0||!Ra(i,r.bounds))return!1;if((0,v.d)(Qm,l,r.halfSize),(0,v.u)(Qm,Qm,r.bounds),Bm(e,t,Qm)>a)return!1;const n=r.node;return n.terminals.forAll((e=>c(e))),null!==n.residents&&n.residents.forAll((e=>c(e))),!0}),e,t),o}forEachInDepthRange(e,t,i,r,s,n,a){let o=-1/0,l=1/0;const c={setRange:e=>{1===i?(o=Math.max(o,e.near),l=Math.min(l,e.far)):(o=Math.max(o,-e.far),l=Math.min(l,-e.near))}};c.setRange(r);const h=Bm(t,i,e),d=Gm(t,i),u=Gm(t,-1*i),p=e=>{if(!a(e))return;const r=this._objectToBoundingSphere(e),d=(0,S.O)(r),u=Bm(t,i,d)-h,p=u-r[3],m=u+r[3];p>l||m<o||!Ra(n,r)||s(e,c)};this._forEachNodeDepthOrdered(this._root,(e=>{if(!Ra(n,e.bounds))return!1;if((0,v.d)(Qm,d,e.halfSize),(0,v.u)(Qm,Qm,e.bounds),Bm(t,i,Qm)-h>l)return!1;if((0,v.d)(Qm,u,e.halfSize),(0,v.u)(Qm,Qm,e.bounds),Bm(t,i,Qm)-h<o)return!1;const r=e.node;return r.terminals.forAll((e=>p(e))),null!==r.residents&&r.residents.forAll((e=>p(e))),!0}),t,i)}forEachNode(e){this._forEachNode(this._root,(t=>e(t.node,t.bounds,t.halfSize)))}_intersectsNode(e,t){return Vm(t.bounds,2*-t.halfSize,Zm),Vm(t.bounds,2*t.halfSize,Ym),(0,S.al)(e.origin,e.direction,Zm,Ym)}_intersectsNodeWithOffset(e,t,i){return Vm(t.bounds,2*-t.halfSize,Zm),Vm(t.bounds,2*t.halfSize,Ym),i.applyToMinMax(Zm,Ym),(0,S.al)(e.origin,e.direction,Zm,Ym)}_intersectsObject(e,t){const i=this._objectToBoundingSphere(t);return!(i[3]>0)||(0,S.am)(i,e)}_intersectsObjectWithOffset(e,t,i){const r=this._objectToBoundingSphere(t);return!(r[3]>0)||(0,S.am)(i.applyToBoundingSphere(r),e)}_forEachNode(e,t){let i=Im.acquire().init(e);const r=[i];for(;0!==r.length;){if(i=r.pop(),t(i)&&!i.isLeaf())for(let e=0;e<i.node.children.length;e++)i.node.children[e]&&r.push(Im.acquire().init(i).advance(e));Im.release(i)}}_forEachNodeDepthOrdered(e,t,i,r=1){let s=Im.acquire().init(e);const n=[s];for(function(e,t,i){if(!rf.length)for(let e=0;e<8;++e)rf.push({index:0,distance:0});for(let i=0;i<8;++i){const r=km[i];rf.data[i].index=i,rf.data[i].distance=Bm(e,t,r)}rf.sort(((e,t)=>e.distance-t.distance));for(let e=0;e<8;++e)i[e]=rf.data[e].index}(i,r,sf);0!==n.length;){if(s=n.pop(),t(s)&&!s.isLeaf())for(let e=7;e>=0;--e){const t=sf[e];s.node.children[t]&&n.push(Im.acquire().init(s).advance(t))}Im.release(s)}}_remove(e,t,i){Xm.clear();const r=i.advanceTo(t,((e,t)=>{Xm.push(e.node),Xm.push(t)}))?i.node.terminals:i.node.residents;if(r.removeUnordered(e),0===r.length)for(let e=Xm.length-2;e>=0;e-=2){const t=Xm.data[e],i=Xm.data[e+1];if(!this._purge(t,i))break}}_nodeIsEmpty(e){if(0!==e.terminals.length)return!1;if(null!==e.residents)return 0===e.residents.length;for(let t=0;t<e.children.length;t++)if(e.children[t])return!1;return!0}_purge(e,t){return t>=0&&(e.children[t]=null),!!this._nodeIsEmpty(e)&&(null===e.residents&&(e.residents=new r.f({shrink:!0})),!0)}_add(e,t){t.advanceTo(this._objectToBoundingSphere(e))?t.node.terminals.push(e):(t.node.residents.push(e),t.node.residents.length>this._maximumObjectsPerNode&&t.depth<this._maximumDepth&&this._split(t))}_split(e){const t=e.node.residents;e.node.residents=null;for(let i=0;i<t.length;i++){const r=Im.acquire().init(e);this._add(t.getItemAt(i),r),Im.release(r)}}_grow(e,t){if(0!==t&&(Um(e,t,(e=>this._objectToBoundingSphere(e)),Km),qm(Km[3])&&!this._fitsInsideTree(Km)))if(this._nodeIsEmpty(this._root.node))(0,S.ak)(Km,this._root.bounds),this._root.halfSize=1.25*Km[3];else{const e=this._rootBoundsForRootAsSubNode(Km);this._placingRootViolatesMaxDepth(e)?this._rebuildTree(Km,e):this._growRootAsSubNode(e),Im.release(e)}}_rebuildTree(e,t){(0,v.h)(Jm,t.bounds),Jm[3]=t.halfSize,Um([e,Jm],2,(e=>e),ef);const i=Im.acquire().init(this._root);this._root.initFrom(null,ef,1.25*ef[3]),this._forEachNode(i,(e=>(this.add(e.node.terminals.data,e.node.terminals.length),null!==e.node.residents&&this.add(e.node.residents.data,e.node.residents.length),!0))),Im.release(i)}_placingRootViolatesMaxDepth(e){const t=Math.log(e.halfSize/this._root.halfSize)*Math.LOG2E;let i=0;return this._forEachNode(this._root,(e=>(i=Math.max(i,e.depth),i+t<=this._maximumDepth))),i+t>this._maximumDepth}_rootBoundsForRootAsSubNode(e){const t=e[3],i=e;let r=-1/0;const s=this._root.bounds,n=this._root.halfSize;for(let e=0;e<3;e++){const a=s[e]-n-(i[e]-t),o=i[e]+t-(s[e]+n),l=Math.max(0,Math.ceil(a/(2*n))),c=Math.max(0,Math.ceil(o/(2*n)))+1,h=2**Math.ceil(Math.log(l+c)*Math.LOG2E);r=Math.max(r,h),tf[e].min=l,tf[e].max=c}for(let e=0;e<3;e++){let t=tf[e].min,i=tf[e].max;const a=(r-(t+i))/2;t+=Math.ceil(a),i+=Math.floor(a);const o=s[e]-n-t*n*2;Wm[e]=o+(i+t)*n}return Wm[3]=r*n*jm,Im.acquire().initFrom(null,Wm,r*n,0)}_growRootAsSubNode(e){const t=this._root.node;(0,v.h)(Km,this._root.bounds),Km[3]=this._root.halfSize,this._root.init(e),e.advanceTo(Km,null,!0),e.node.children=t.children,e.node.residents=t.residents,e.node.terminals=t.terminals}_shrink(){for(;;){const e=this._findShrinkIndex();if(-1===e)break;this._root.advance(e),this._root.depth=0}}_findShrinkIndex(){if(0!==this._root.node.terminals.length||this._root.isLeaf())return-1;let e=null;const t=this._root.node.children;let i=0,r=0;for(;r<t.length&&null==e;)i=r++,e=t[i];for(;r<t.length;)if(t[r++])return-1;return i}_isDegenerate(e){return!qm(this._objectToBoundingSphere(e)[3])}_fitsInsideTree(e){const t=this._root.bounds,i=this._root.halfSize;return e[3]<=i&&e[0]>=t[0]-i&&e[0]<=t[0]+i&&e[1]>=t[1]-i&&e[1]<=t[1]+i&&e[2]>=t[2]-i&&e[2]<=t[2]+i}}class Im{constructor(){this.bounds=(0,S._)(),this.halfSize=0,this.initFrom(null,null,0,0)}init(e){return this.initFrom(e.node,e.bounds,e.halfSize,e.depth)}initFrom(e,t,i,r=this.depth){return this.node=(0,u.r)(e)?e:Im.createEmptyNode(),(0,u.r)(t)&&(0,S.ak)(t,this.bounds),this.halfSize=i,this.depth=r,this}advance(e){let t=this.node.children[e];t||(t=Im.createEmptyNode(),this.node.children[e]=t),this.node=t,this.halfSize/=2,this.depth++;const i=km[e];return this.bounds[0]+=i[0]*this.halfSize,this.bounds[1]+=i[1]*this.halfSize,this.bounds[2]+=i[2]*this.halfSize,this.bounds[3]=this.halfSize*jm,this}advanceTo(e,t,i=!1){for(;;){if(this.isTerminalFor(e))return t&&t(this,-1),!0;if(this.isLeaf()){if(!i)return t&&t(this,-1),!1;this.node.residents=null}const r=this._childIndex(e);t&&t(this,r),this.advance(r)}}isLeaf(){return null!=this.node.residents}isTerminalFor(e){return e[3]>this.halfSize/2}_childIndex(e){const t=this.bounds;return(t[0]<e[0]?1:0)+(t[1]<e[1]?2:0)+(t[2]<e[2]?4:0)}static createEmptyNode(){return{children:[null,null,null,null,null,null,null,null],terminals:new r.f({shrink:!0}),residents:new r.f({shrink:!0})}}static acquire(){return Im._pool.acquire()}static release(e){Im._pool.release(e)}static clearPool(){Im._pool.prune()}}function Lm(e,t){e[0]=Math.min(e[0],t[0]-t[3]),e[1]=Math.min(e[1],t[1]-t[3]),e[2]=Math.min(e[2],t[2]-t[3])}function Fm(e,t){e[0]=Math.max(e[0],t[0]+t[3]),e[1]=Math.max(e[1],t[1]+t[3]),e[2]=Math.max(e[2],t[2]+t[3])}function Vm(e,t,i){i[0]=e[0]+t,i[1]=e[1]+t,i[2]=e[2]+t}function Um(e,t,i,r){if(1===t){const t=i(e[0]);(0,S.ak)(t,r)}else{Zm[0]=1/0,Zm[1]=1/0,Zm[2]=1/0,Ym[0]=-1/0,Ym[1]=-1/0,Ym[2]=-1/0;for(let r=0;r<t;r++){const t=i(e[r]);qm(t[3])&&(Lm(Zm,t),Fm(Ym,t))}(0,v.y)(r,Zm,Ym,.5),r[3]=Math.max(Ym[0]-Zm[0],Ym[1]-Zm[1],Ym[2]-Zm[2])/2}}function Gm(e,t){let i=1/0,r=null;for(let s=0;s<8;++s){const n=Bm(e,t,Nm[s]);n<i&&(i=n,r=Nm[s])}return r}function Bm(e,t,i){return t*(e[0]*i[0]+e[1]*i[1]+e[2]*i[2])}function qm(e){return!isNaN(e)&&e!==-1/0&&e!==1/0&&e>0}Im._pool=new r.h(Im);const km=[(0,v.i)(-1,-1,-1),(0,v.i)(1,-1,-1),(0,v.i)(-1,1,-1),(0,v.i)(1,1,-1),(0,v.i)(-1,-1,1),(0,v.i)(1,-1,1),(0,v.i)(-1,1,1),(0,v.i)(1,1,1)],Nm=[(0,v.i)(-1,-1,-1),(0,v.i)(-1,-1,1),(0,v.i)(-1,1,-1),(0,v.i)(-1,1,1),(0,v.i)(1,-1,-1),(0,v.i)(1,-1,1),(0,v.i)(1,1,-1),(0,v.i)(1,1,1)],jm=Math.sqrt(3),Hm=[null],Wm=(0,S._)(),Qm=(0,v.n)(),Zm=(0,v.n)(),Ym=(0,v.n)(),Xm=new r.f,$m=(0,S._)(),Km=(0,S._)(),Jm=(0,S._)(),ef=(0,S._)(),tf=[{min:0,max:0},{min:0,max:0},{min:0,max:0}],rf=new r.f,sf=[0,0,0,0,0,0,0,0];class nf extends S.m{constructor(e,t=""){var i,s,a;super(),this.apiLayerUid=t,this.type=0,this.events=new n.n,this.isSliceable=!1,this._objects=new r.f,this._stageHandles=new R.u,this.apiLayerUid=t,this.isVisible=null==(i=null==e?void 0:e.isVisible)||i,this.isPickable=null==(s=null==e?void 0:e.isPickable)||s,this.updatePolicy=null!=(a=null==e?void 0:e.updatePolicy)?a:0}get objects(){return this._objects}destroy(){this.detachStage(),this._stage=null}attachStage(e){this.detachStage(),this._stage=e;for(const t of Em)this._stageHandles.add(this.events.on(t,(i=>e.handleEvent(t,i))))}detachStage(){this._stageHandles.removeAll(),this.invalidateSpatialQueryAccelerator()}add(e){this._objects.push(e),e.parentLayer=this,this.events.emit("layerObjectAdded",{layer:this,object:e}),(0,u.r)(this._octree)&&this._octree.add([e])}remove(e){this._objects.removeUnordered(e)&&(e.parentLayer=null,this.events.emit("layerObjectRemoved",{layer:this,object:e}),(0,u.r)(this._octree)&&this._octree.remove([e]))}addMany(e){this._objects.pushArray(e);for(const t of e)t.parentLayer=this;this.events.emit("layerObjectsAdded",{layer:this,objects:e}),(0,u.r)(this._octree)&&this._octree.add(e)}removeMany(e){const t=new Array;if(this._objects.removeUnorderedMany(e,e.length,t),0!==t.length){for(const e of t)e.parentLayer=null;this.events.emit("layerObjectsRemoved",{layer:this,objects:t}),(0,u.r)(this._octree)&&this._octree.remove(t)}}sync(){(0,u.r)(this._stage)&&1!==this.updatePolicy&&this._stage.syncLayer(this.id)}notifyObjectBBChanged(e,t){(0,u.r)(this._octree)&&this._octree.update(e,t)}getSpatialQueryAccelerator(){return(0,u.t)(this._octree)&&this._objects.length>50&&this._createOctree(),this._octree}shaderTransformationChanged(){this.invalidateSpatialQueryAccelerator(),this.events.emit("shaderTransformationChanged",this)}invalidateSpatialQueryAccelerator(){this._octree=(0,u.k)(this._octree)}_createOctree(){this._octree=new zm((e=>e.boundingVolumeWorldSpace.bounds)),this._octree.add(this._objects.data,this._objects.length)}}function af(e){return(0,u.r)(e)&&0===e.type}var of;!function(e){e.Default={vvSizeEnabled:!1,vvSizeMinSize:(0,B.t)(1,1,1),vvSizeMaxSize:(0,B.t)(100,100,100),vvSizeOffset:(0,B.t)(0,0,0),vvSizeFactor:(0,B.t)(1,1,1),vvSizeValue:(0,B.t)(1,1,1),vvColorEnabled:!1,vvColorValues:[0,0,0,0,0,0,0,0],vvColorColors:[1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0],vvOpacityEnabled:!1,vvOpacityValues:[0,0,0,0,0,0,0,0],vvOpacityOpacities:[1,1,1,1,1,1,1,1],vvSymbolAnchor:[0,0,0],vvSymbolRotationMatrix:(0,X.e)()}}(of||(of={}));var lf=of;function cf(e,t){e.vertex.uniforms.add("intrinsicWidth","float"),t.vvSize?(e.attributes.add("sizeFeatureAttribute","float"),e.vertex.uniforms.add("vvSizeMinSize","vec3"),e.vertex.uniforms.add("vvSizeMaxSize","vec3"),e.vertex.uniforms.add("vvSizeOffset","vec3"),e.vertex.uniforms.add("vvSizeFactor","vec3"),e.vertex.code.add(S.t`float getSize() {
return intrinsicWidth * clamp(vvSizeOffset + sizeFeatureAttribute * vvSizeFactor, vvSizeMinSize, vvSizeMaxSize).x;
}`)):(e.attributes.add("size","float"),e.vertex.code.add(S.t`float getSize(){
return intrinsicWidth * size;
}`)),t.vvOpacity?(e.attributes.add("opacityFeatureAttribute","float"),e.vertex.constants.add("vvOpacityNumber","int",8),e.vertex.code.add(S.t`uniform float vvOpacityValues[vvOpacityNumber];
uniform float vvOpacityOpacities[vvOpacityNumber];
float interpolateOpacity( float value ){
if (value <= vvOpacityValues[0]) {
return vvOpacityOpacities[0];
}
for (int i = 1; i < vvOpacityNumber; ++i) {
if (vvOpacityValues[i] >= value) {
float f = (value - vvOpacityValues[i-1]) / (vvOpacityValues[i] - vvOpacityValues[i-1]);
return mix(vvOpacityOpacities[i-1], vvOpacityOpacities[i], f);
}
}
return vvOpacityOpacities[vvOpacityNumber - 1];
}
vec4 applyOpacity( vec4 color ){
return vec4(color.xyz, interpolateOpacity(opacityFeatureAttribute));
}`)):e.vertex.code.add(S.t`vec4 applyOpacity( vec4 color ){
return color;
}`),t.vvColor?(e.attributes.add("colorFeatureAttribute","float"),e.vertex.constants.add("vvColorNumber","int",8),e.vertex.code.add(S.t`uniform float vvColorValues[vvColorNumber];
uniform vec4 vvColorColors[vvColorNumber];
vec4 interpolateColor( float value ) {
if (value <= vvColorValues[0]) {
return vvColorColors[0];
}
for (int i = 1; i < vvColorNumber; ++i) {
if (vvColorValues[i] >= value) {
float f = (value - vvColorValues[i-1]) / (vvColorValues[i] - vvColorValues[i-1]);
return mix(vvColorColors[i-1], vvColorColors[i], f);
}
}
return vvColorColors[vvColorNumber - 1];
}
vec4 getColor(){
return applyOpacity(interpolateColor(colorFeatureAttribute));
}`)):(e.attributes.add("color","vec4"),e.vertex.code.add(S.t`vec4 getColor(){
return applyOpacity(color);
}`))}function hf(e,t){e.constants.add("stippleAlphaColorDiscard","float",.001),e.constants.add("stippleAlphaHighlightDiscard","float",.5),t.stippleEnabled?function(e,t){e.vertex.uniforms.add("stipplePatternPixelSizeInv","float"),t.stippleUVMaxEnabled&&e.varyings.add("stipplePatternUvMax","float"),e.varyings.add("stipplePatternUv","float"),e.fragment.uniforms.add("stipplePatternTexture","sampler2D"),t.stippleOffColorEnabled&&e.fragment.uniforms.add("stippleOffColor","vec4"),e.fragment.code.add(S.t`
  float getStippleAlpha() {
    float stipplePatternUvClamped = stipplePatternUv * gl_FragCoord.w;
    ${t.stippleUVMaxEnabled?"stipplePatternUvClamped = clamp(stipplePatternUvClamped, 0.0, stipplePatternUvMax);":""}

    return texture2D(stipplePatternTexture, vec2(mod(stipplePatternUvClamped, 1.0), 0.5)).a;
  }`),t.stippleOffColorEnabled?e.fragment.code.add(S.t`#define discardByStippleAlpha(stippleAlpha, threshold) {}
#define blendStipple(color, stippleAlpha) mix(color, stippleOffColor, stippleAlpha)`):e.fragment.code.add(S.t`#define discardByStippleAlpha(stippleAlpha, threshold) if (stippleAlpha < threshold) { discard; }
#define blendStipple(color, stippleAlpha) vec4(color.rgb, color.a * stippleAlpha)`)}(e,t):function(e){e.fragment.code.add(S.t`float getStippleAlpha() { return 1.0; }
#define discardByStippleAlpha(_stippleAlpha_, _threshold_) {}
#define blendStipple(color, _stippleAlpha_) color`)}(e)}function df(e){const t=new S.n;t.extensions.add("GL_OES_standard_derivatives"),t.include(S.an),t.include(cf,e),t.include(hf,e),1===e.output&&t.include(S.ao,e),t.vertex.uniforms.add("proj","mat4").add("view","mat4").add("cameraNearFar","vec2").add("pixelRatio","float").add("miterLimit","float").add("screenSize","vec2"),t.attributes.add("position","vec3"),t.attributes.add("subdivisionFactor","float"),t.attributes.add("uv0","vec2"),t.attributes.add("auxpos1","vec3"),t.attributes.add("auxpos2","vec3"),t.varyings.add("vColor","vec4"),t.varyings.add("vpos","vec3"),t.varyings.add("linearDepth","float"),e.multipassTerrainEnabled&&t.varyings.add("depth","float");const i=e.falloffEnabled,r=e.innerColorEnabled;return r&&t.varyings.add("vLineDistance","float"),i&&t.varyings.add("vLineDistanceNorm","float"),e.falloffEnabled&&t.fragment.uniforms.add("falloff","float"),e.innerColorEnabled&&(t.fragment.uniforms.add("innerColor","vec4"),t.fragment.uniforms.add("innerWidth","float")),t.vertex.code.add(S.t`#define PERPENDICULAR(v) vec2(v.y, -v.x);
#define ISOUTSIDE (left.x * right.y - left.y * right.x)*uv0.y > 0.0
float interp(float ncp, vec4 a, vec4 b) {
return (-ncp - a.z) / (b.z - a.z);
}
vec2 rotate(vec2 v, float a) {
float s = sin(a);
float c = cos(a);
mat2 m = mat2(c, -s, s, c);
return m * v;
}`),t.vertex.code.add(S.t`vec4 projectAndScale(vec4 pos) {
vec4 posNdc = proj * pos;
posNdc.xy *= screenSize / posNdc.w;
return posNdc;
}`),t.vertex.code.add(S.t`
    void clipAndTransform(inout vec4 pos, inout vec4 prev, inout vec4 next, in bool isStartVertex) {
      float vnp = cameraNearFar[0] * 0.99;

      //current pos behind ncp --> we need to clip
      if(pos.z > -cameraNearFar[0]) {
        if (!isStartVertex) {
          //previous in front of ncp
          if(prev.z < -cameraNearFar[0]) {
            pos = mix(prev, pos, interp(vnp, prev, pos));
            next = pos;
          } else {
            pos = vec4(0.0, 0.0, 0.0, 1.0);
          }
        }
        //next in front of ncp
        if(isStartVertex) {
          if(next.z < -cameraNearFar[0]) {
            pos = mix(pos, next, interp(vnp, pos, next));
            prev = pos;
          } else {
            pos = vec4(0.0, 0.0, 0.0, 1.0);
          }
        }
      } else {
        //current position visible
        //previous behind ncp
        if (prev.z > -cameraNearFar[0]) {
          prev = mix(pos, prev, interp(vnp, pos, prev));
        }
        //next behind ncp
        if (next.z > -cameraNearFar[0]) {
          next = mix(next, pos, interp(vnp, next, pos));
        }
      }

      ${e.multipassTerrainEnabled?"depth = pos.z;":""}
      linearDepth = (-pos.z - cameraNearFar[0]) / (cameraNearFar[1] - cameraNearFar[0]);

      pos = projectAndScale(pos);
      next = projectAndScale(next);
      prev = projectAndScale(prev);
    }
`),t.vertex.code.add(S.t`void main(void) {
float coverage = 1.0;
vpos = position;
if (uv0.y == 0.0) {
gl_Position = vec4(1e038, 1e038, 1e038, 1.0);
}
else {
bool isStartVertex = abs(abs(uv0.y)-3.0) == 1.0;
bool isJoin = abs(uv0.y)-3.0 < 0.0;
float lineWidth = getSize() * pixelRatio;
if (lineWidth < 1.0) {
coverage = lineWidth;
lineWidth = 1.0;
}else{
lineWidth = floor(lineWidth + 0.5);
}
vec4 pos  = view * vec4(position.xyz, 1.0);
vec4 prev = view * vec4(auxpos1.xyz, 1.0);
vec4 next = view * vec4(auxpos2.xyz, 1.0);
clipAndTransform(pos, prev, next, isStartVertex);
vec2 left = (pos.xy - prev.xy);
vec2 right = (next.xy - pos.xy);
float leftLen = length(left);
float rightLen = length(right);`),e.stippleEnabled&&t.vertex.code.add(S.t`vec4 stippleSegmentInfo = mix(vec4(pos.xy, right), vec4(prev.xy, left), uv0.x);
vec2 stippleSegmentOrigin = stippleSegmentInfo.xy;
vec2 stippleSegmentDirection = stippleSegmentInfo.zw;`),t.vertex.code.add(S.t`left = (leftLen > 0.001) ? left/leftLen : vec2(0.0, 0.0);
right = (rightLen > 0.001) ? right/rightLen : vec2(0.0, 0.0);
vec2 capDisplacementDir = vec2(0, 0);
vec2 joinDisplacementDir = vec2(0, 0);
float displacementLen = lineWidth;
if (isJoin) {
bool isOutside = ISOUTSIDE;
joinDisplacementDir = normalize(left + right);
joinDisplacementDir = PERPENDICULAR(joinDisplacementDir);
if (leftLen > 0.001 && rightLen > 0.001) {
float nDotSeg = dot(joinDisplacementDir, left);
displacementLen /= length(nDotSeg * left - joinDisplacementDir);
if (!isOutside) {
displacementLen = min(displacementLen, min(leftLen, rightLen)/abs(nDotSeg));
}
}
if (isOutside && (displacementLen > miterLimit * lineWidth)) {`),e.roundJoins?t.vertex.code.add(S.t`vec2 startDir;
vec2 endDir;
if (leftLen < 0.001) {
startDir = right;
}
else{
startDir = left;
}
startDir = normalize(startDir);
startDir = PERPENDICULAR(startDir);
if (rightLen < 0.001) {
endDir = left;
}
else{
endDir = right;
}
endDir = normalize(endDir);
endDir = PERPENDICULAR(endDir);
float rotationAngle = acos(clamp(dot(startDir, endDir), -1.0, 1.0));
joinDisplacementDir = rotate(startDir, -sign(uv0.y) * subdivisionFactor * rotationAngle);`):t.vertex.code.add(S.t`if (leftLen < 0.001) {
joinDisplacementDir = right;
}
else if (rightLen < 0.001) {
joinDisplacementDir = left;
}
else {
joinDisplacementDir = isStartVertex ? right : left;
}
joinDisplacementDir = normalize(joinDisplacementDir);
joinDisplacementDir = PERPENDICULAR(joinDisplacementDir);`),t.vertex.code.add(S.t`displacementLen = lineWidth;
}
} else {
if (leftLen < 0.001) {
joinDisplacementDir = right;
}
else if (rightLen < 0.001) {
joinDisplacementDir = left;
}
else {
joinDisplacementDir = isStartVertex ? right : left;
}
joinDisplacementDir = normalize(joinDisplacementDir);
joinDisplacementDir = PERPENDICULAR(joinDisplacementDir);
displacementLen = lineWidth;
capDisplacementDir = isStartVertex ? -right : left;`),e.roundCaps?t.vertex.code.add(S.t`float angle = subdivisionFactor*PI*0.5;
joinDisplacementDir *= cos(angle);
capDisplacementDir *= sin(angle);`):t.vertex.code.add(S.t`capDisplacementDir *= subdivisionFactor;`),t.vertex.code.add(S.t`
  }

  // Displacement (in pixels) caused by join/or cap
  vec2 dpos = joinDisplacementDir * sign(uv0.y) * displacementLen + capDisplacementDir * displacementLen;

  ${i||r?S.t`float lineDist = lineWidth * sign(uv0.y) * pos.w;`:""}

  ${r?S.t`vLineDistance = lineDist;`:""}
  ${i?S.t`vLineDistanceNorm = lineDist / lineWidth;`:""}

  pos.xy += dpos;
  `),e.stippleEnabled&&(t.vertex.code.add(S.t`{
vec2 posVec = pos.xy - stippleSegmentOrigin;
float stippleSegmentDirectionLength = length(stippleSegmentDirection);`),e.stippleIntegerRepeatsEnabled&&t.vertex.code.add(S.t`float numberOfPatternRepeats = stippleSegmentDirectionLength * 0.5 * stipplePatternPixelSizeInv;
float roundedNumberOfPatternRepeats = floor(numberOfPatternRepeats);
stipplePatternUvMax = roundedNumberOfPatternRepeats;`),t.vertex.code.add(S.t`
      if (stippleSegmentDirectionLength >= 0.001) {
        // Project the vertex position onto the line segment.
        float projectedLength = dot(stippleSegmentDirection, posVec) / stippleSegmentDirectionLength * 0.5;
     ${e.stippleIntegerRepeatsEnabled?"float wholeNumberOfRepeatsScale = roundedNumberOfPatternRepeats / numberOfPatternRepeats;":"float wholeNumberOfRepeatsScale = 1.0;"}
        stipplePatternUv = projectedLength * wholeNumberOfRepeatsScale * stipplePatternPixelSizeInv * pos.w;
        } else {
          stipplePatternUv = 1.0;
        }
      }
    `)),t.vertex.code.add(S.t`pos.xy = pos.xy / screenSize * pos.w;
vColor = getColor();
vColor.a *= coverage;
gl_Position = pos;
}
}`),e.multipassTerrainEnabled&&(t.fragment.include(S.L),t.include(S.ap,e)),t.include(S.N,e),t.fragment.uniforms.add("intrinsicColor","vec4"),t.fragment.include(S.j),t.fragment.code.add(S.t`
  void main() {
    discardBySlice(vpos);
    ${e.multipassTerrainEnabled?"terrainDepthTest(gl_FragCoord, depth);":""}
    float stippleAlpha = getStippleAlpha();
    discardByStippleAlpha(stippleAlpha, stippleAlphaColorDiscard);

    vec4 color = intrinsicColor * vColor;
  `),e.innerColorEnabled&&(t.fragment.uniforms.add("pixelRatio","float"),t.fragment.code.add(S.t`float distToInner = abs(vLineDistance * gl_FragCoord.w) - innerWidth;
float innerAA = clamp(0.5 - distToInner, 0.0, 1.0);
float innerAlpha = innerColor.a + color.a * (1.0 - innerColor.a);
color = mix(color, vec4(innerColor.rgb, innerAlpha), innerAA);`)),t.fragment.code.add(S.t`vec4 finalColor = blendStipple(color, stippleAlpha);`),e.falloffEnabled&&t.fragment.code.add(S.t`finalColor.a *= pow(max(0.0, 1.0 - abs(vLineDistanceNorm * gl_FragCoord.w)), falloff);`),t.fragment.code.add(S.t`
    if (finalColor.a < ${S.t.float(S.Q)}) {
      discard;
    }

    ${7===e.output?S.t`gl_FragColor = vec4(finalColor.a);`:""}
    ${0===e.output?S.t`gl_FragColor = highlightSlice(finalColor, vpos);`:""}
    ${0===e.output&&e.OITEnabled?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""}
    ${4===e.output?S.t`gl_FragColor = vec4(1.0);`:""}
    ${1===e.output?S.t`outputDepth(linearDepth);`:""}
  }
  `),t}var uf=Object.freeze({__proto__:null,build:df});const pf=new Map([["position",0],["subdivisionFactor",1],["uv0",2],["auxpos1",3],["auxpos2",4],["size",6],["sizeFeatureAttribute",6],["color",5],["colorFeatureAttribute",5],["opacityFeatureAttribute",7]]);class mf extends S.c{constructor(e,t,i){super(e,t,i),this.stippleTextureRepository=e.stippleTextureRepository}initializeProgram(e){const t=mf.shader.get(),i=this.configuration,r=t.build({OITEnabled:0===i.transparencyPassType,output:i.output,slicePlaneEnabled:i.slicePlaneEnabled,sliceHighlightDisabled:!1,sliceEnabledForVertexPrograms:!1,stippleEnabled:i.stippleEnabled,stippleOffColorEnabled:i.stippleOffColorEnabled,stippleUVMaxEnabled:i.stippleIntegerRepeatsEnabled,stippleIntegerRepeatsEnabled:i.stippleIntegerRepeatsEnabled,roundCaps:i.roundCaps,roundJoins:i.roundJoins,vvColor:i.vvColor,vvSize:i.vvSize,vvInstancingEnabled:!0,vvOpacity:i.vvOpacity,falloffEnabled:i.falloffEnabled,innerColorEnabled:i.innerColorEnabled,multipassTerrainEnabled:i.multipassTerrainEnabled,cullAboveGround:i.cullAboveGround});return new S.d(e.rctx,r,pf)}dispose(){super.dispose(),this.stippleTextureRepository.release(this.stipplePattern),this.stipplePattern=null,this.stippleTextureBind=null}bindPass(e,t){if((0,S.h)(this.program,t.camera.projectionMatrix),4===this.configuration.output&&(0,S.a1)(this.program,t),t.multipassTerrainEnabled&&(this.program.setUniform2fv("inverseViewport",t.inverseViewport),(0,S.Y)(this.program,t)),this.program.setUniform1f("intrinsicWidth",e.width),this.program.setUniform4fv("intrinsicColor",e.color),this.program.setUniform1f("miterLimit","miter"!==e.join?0:e.miterLimit),this.program.setUniform2fv("cameraNearFar",t.camera.nearFar),this.program.setUniform1f("pixelRatio",t.camera.pixelRatio),this.program.setUniform2f("screenSize",t.camera.fullViewport[2],t.camera.fullViewport[3]),(0,S.aq)(this.program,e),this.stipplePattern!==e.stipplePattern){const t=e.stipplePattern;this.stippleTextureBind=this.stippleTextureRepository.swap(this.stipplePattern,t),this.stipplePattern=t}if(this.configuration.stippleEnabled){const i=(0,u.r)(this.stippleTextureBind)?this.stippleTextureBind(this.program)*t.camera.pixelRatio:1;if(this.program.setUniform1f("stipplePatternPixelSizeInv",1/i),this.configuration.stippleOffColorEnabled){const t=(0,u.f)(e.stippleOffColor);this.program.setUniform4f("stippleOffColor",t[0],t[1],t[2],t.length>3?t[3]:1)}}this.configuration.falloffEnabled&&this.program.setUniform1f("falloff",e.falloff),this.configuration.innerColorEnabled&&(this.program.setUniform4fv("innerColor",(0,u.q)(e.innerColor,e.color)),this.program.setUniform1f("innerWidth",e.innerWidth*t.camera.pixelRatio))}bindDraw(e){(0,S.a2)(this.program,e),(0,S.a4)(this.program,this.configuration,e),this.program.rebindTextures()}setPipelineState(e,t){const i=this.configuration,r=3===e,s=2===e;return(0,V.g)({blending:0===i.output||7===i.output?r?S.ar:(0,S.a5)(e):null,depthTest:{func:(0,S.as)(e)},depthWrite:r?!i.transparent&&i.writeDepth&&V.l:(0,S.at)(e),colorWrite:V.r,stencilWrite:i.sceneHasOcludees?S.au:null,stencilTest:i.sceneHasOcludees?t?S.av:S.aw:null,polygonOffset:r||s?i.polygonOffset&&ff:S.ax})}initializePipeline(){const e=this.configuration,t=e.polygonOffset&&ff;return e.occluder&&(this._occluderPipelineTransparent=(0,V.g)({blending:S.ar,polygonOffset:t,depthTest:S.ay,depthWrite:null,colorWrite:V.r,stencilWrite:null,stencilTest:S.az}),this._occluderPipelineOpaque=(0,V.g)({blending:S.ar,polygonOffset:t,depthTest:S.ay,depthWrite:null,colorWrite:V.r,stencilWrite:S.aA,stencilTest:S.aB}),this._occluderPipelineMaskWrite=(0,V.g)({blending:null,polygonOffset:t,depthTest:S.aC,depthWrite:null,colorWrite:null,stencilWrite:S.au,stencilTest:S.av})),this._occludeePipelineState=this.setPipelineState(this.configuration.transparencyPassType,!0),this.setPipelineState(this.configuration.transparencyPassType,!1)}get primitiveType(){return 5}getPipelineState(e,t){return t?this._occludeePipelineState:this.configuration.occluder?11===e?this._occluderPipelineTransparent:10===e?this._occluderPipelineOpaque:this._occluderPipelineMaskWrite:this.pipeline}}mf.shader=new S.f(uf,(()=>i.e(4).then(i.bind(i,4))));const ff={factor:0,units:-4};class gf extends S.b{constructor(){super(...arguments),this.output=0,this.occluder=!1,this.slicePlaneEnabled=!1,this.transparent=!1,this.polygonOffset=!1,this.writeDepth=!1,this.stippleEnabled=!1,this.stippleOffColorEnabled=!1,this.stippleIntegerRepeatsEnabled=!1,this.roundCaps=!1,this.roundJoins=!1,this.vvSize=!1,this.vvColor=!1,this.vvOpacity=!1,this.falloffEnabled=!1,this.innerColorEnabled=!1,this.sceneHasOcludees=!1,this.transparencyPassType=3,this.multipassTerrainEnabled=!1,this.cullAboveGround=!1}}(0,r.e)([(0,S.a)({count:8})],gf.prototype,"output",void 0),(0,r.e)([(0,S.a)()],gf.prototype,"occluder",void 0),(0,r.e)([(0,S.a)()],gf.prototype,"slicePlaneEnabled",void 0),(0,r.e)([(0,S.a)()],gf.prototype,"transparent",void 0),(0,r.e)([(0,S.a)()],gf.prototype,"polygonOffset",void 0),(0,r.e)([(0,S.a)()],gf.prototype,"writeDepth",void 0),(0,r.e)([(0,S.a)()],gf.prototype,"stippleEnabled",void 0),(0,r.e)([(0,S.a)()],gf.prototype,"stippleOffColorEnabled",void 0),(0,r.e)([(0,S.a)()],gf.prototype,"stippleIntegerRepeatsEnabled",void 0),(0,r.e)([(0,S.a)()],gf.prototype,"roundCaps",void 0),(0,r.e)([(0,S.a)()],gf.prototype,"roundJoins",void 0),(0,r.e)([(0,S.a)()],gf.prototype,"vvSize",void 0),(0,r.e)([(0,S.a)()],gf.prototype,"vvColor",void 0),(0,r.e)([(0,S.a)()],gf.prototype,"vvOpacity",void 0),(0,r.e)([(0,S.a)()],gf.prototype,"falloffEnabled",void 0),(0,r.e)([(0,S.a)()],gf.prototype,"innerColorEnabled",void 0),(0,r.e)([(0,S.a)()],gf.prototype,"sceneHasOcludees",void 0),(0,r.e)([(0,S.a)({count:4})],gf.prototype,"transparencyPassType",void 0),(0,r.e)([(0,S.a)()],gf.prototype,"multipassTerrainEnabled",void 0),(0,r.e)([(0,S.a)()],gf.prototype,"cullAboveGround",void 0);const vf=u.n.getLogger("esri.views.3d.webgl-engine.materials.RibbonLineMaterial");class yf extends S.a6{constructor(e){super(e,xf),this._vertexAttributeLocations=pf,this.techniqueConfig=new gf,this.layout=this.createLayout()}isClosed(e,t){return Tf(this.params,e,t)}dispose(){}getPassParameters(){return this.params}getTechniqueConfig(e,t){this.techniqueConfig.output=e;const i=(0,u.r)(this.params.stipplePattern);return this.techniqueConfig.stippleEnabled=i,this.techniqueConfig.stippleIntegerRepeatsEnabled=i&&this.params.stippleIntegerRepeats,this.techniqueConfig.stippleOffColorEnabled=i&&(0,u.r)(this.params.stippleOffColor),this.techniqueConfig.slicePlaneEnabled=this.params.slicePlaneEnabled,this.techniqueConfig.sceneHasOcludees=this.params.sceneHasOcludees,this.techniqueConfig.roundJoins="round"===this.params.join,this.techniqueConfig.roundCaps="round"===this.params.cap,this.techniqueConfig.transparent=this.params.transparent,this.techniqueConfig.polygonOffset=this.params.polygonOffset,this.techniqueConfig.writeDepth=this.params.writeDepth,this.techniqueConfig.vvColor=this.params.vvColorEnabled,this.techniqueConfig.vvOpacity=this.params.vvOpacityEnabled,this.techniqueConfig.vvSize=this.params.vvSizeEnabled,this.techniqueConfig.innerColorEnabled=this.params.innerWidth>0&&(0,u.r)(this.params.innerColor),this.techniqueConfig.falloffEnabled=this.params.falloff>0,this.techniqueConfig.occluder=8===this.params.renderOccluded,this.techniqueConfig.transparencyPassType=t?t.transparencyPassType:3,this.techniqueConfig.multipassTerrainEnabled=!!t&&t.multipassTerrainEnabled,this.techniqueConfig.cullAboveGround=!!t&&t.cullAboveGround,this.techniqueConfig}intersect(e,t,i,r,s,n,a,o,l){l?this.intersectDrapedLineGeometry(e,r,n,a):this.intersectLineGeometry(e,t,i,r,this.params.width,a)}intersectDrapedLineGeometry(e,t,i,r){if(!t.options.selectionMode)return;const s=e.vertexAttributes.get("position").data,n=e.vertexAttributes.get("size");let a=this.params.width;if(this.params.vvSizeEnabled){const t=e.vertexAttributes.get("sizeFeatureAttribute").data[0];a*=(0,v.o)(this.params.vvSizeOffset[0]+t*this.params.vvSizeFactor[0],this.params.vvSizeMinSize[0],this.params.vvSizeMaxSize[0])}else n&&(a*=n.data[0]);const o=i[0],l=i[1],c=(a/2+4)*e.screenToWorldRatio;let h=Number.MAX_VALUE;for(let e=0;e<s.length-5;e+=3){const t=s[e],i=s[e+1],r=o-t,n=l-i,a=s[e+3]-t,c=s[e+4]-i,d=(0,v.o)((a*r+c*n)/(a*a+c*c),0,1),u=a*d-r,p=c*d-n,m=u*u+p*p;m<h&&(h=m)}h<c*c&&r()}intersectLineGeometry(e,t,i,r,s,n){if(!r.options.selectionMode||(0,S.C)(t))return;if(!(0,S.aD)(i))return void vf.error("intersection assumes a translation-only matrix");const a=e.vertexAttributes,o=a.get("position").data;let l=s;if(this.params.vvSizeEnabled){const e=a.get("sizeFeatureAttribute").data[0];l*=(0,v.o)(this.params.vvSizeOffset[0]+e*this.params.vvSizeFactor[0],this.params.vvSizeMinSize[0],this.params.vvSizeMaxSize[0])}else a.has("size")&&(l*=a.get("size").data[0]);const c=r.camera,h=Df;(0,k.a)(h,r.point);const d=l*c.pixelRatio/2+4*c.pixelRatio;(0,v.a)(qf[0],h[0]-d,h[1]+d,0),(0,v.a)(qf[1],h[0]+d,h[1]+d,0),(0,v.a)(qf[2],h[0]+d,h[1]-d,0),(0,v.a)(qf[3],h[0]-d,h[1]-d,0);for(let e=0;e<4;e++)if(!c.unprojectFromRenderScreen(qf[e],kf[e]))return;Fe(c.eye,kf[0],kf[1],Nf),Fe(c.eye,kf[1],kf[2],jf),Fe(c.eye,kf[2],kf[3],Hf),Fe(c.eye,kf[3],kf[0],Wf);let u=Number.MAX_VALUE;const p=Cf(this.params,a,e.indices)?o.length-2:o.length-5;for(let e=0;e<p;e+=3){Rf[0]=o[e]+i[12],Rf[1]=o[e+1]+i[13],Rf[2]=o[e+2]+i[14];const t=(e+3)%o.length;if(Af[0]=o[t]+i[12],Af[1]=o[t+1]+i[13],Af[2]=o[t+2]+i[14],it(Nf,Rf)<0&&it(Nf,Af)<0||it(jf,Rf)<0&&it(jf,Af)<0||it(Hf,Rf)<0&&it(Hf,Af)<0||it(Wf,Rf)<0&&it(Wf,Af)<0)continue;if(c.projectToRenderScreen(Rf,Ef),c.projectToRenderScreen(Af,zf),Ef[2]<0&&zf[2]>0){(0,v.c)(Mf,Rf,Af);const e=c.frustum,t=-it(e[4],Rf)/(0,v.z)(Mf,e[4]);(0,v.d)(Mf,Mf,t),(0,v.u)(Rf,Rf,Mf),c.projectToRenderScreen(Rf,Ef)}else if(Ef[2]>0&&zf[2]<0){(0,v.c)(Mf,Af,Rf);const e=c.frustum,t=-it(e[4],Af)/(0,v.z)(Mf,e[4]);(0,v.d)(Mf,Mf,t),(0,v.u)(Af,Af,Mf),c.projectToRenderScreen(Af,zf)}else if(Ef[2]<0&&zf[2]<0)continue;Ef[2]=0,zf[2]=0;const r=(0,w.b)((0,w.g)(Ef,zf,Ff),h);r<u&&(u=r,(0,v.h)(If,Rf),(0,v.h)(Lf,Af))}const m=r.rayBeginPoint,f=r.rayEndPoint;if(u<d*d){let e=Number.MAX_VALUE;if((0,w.k)((0,w.g)(If,Lf,Ff),(0,w.g)(m,f,Vf),Of)){(0,v.c)(Of,Of,m);const t=(0,v.s)(Of);(0,v.d)(Of,Of,1/t),e=t/(0,v.q)(m,f)}n(e,Of)}}computeAttachmentOrigin(e,t){const i=e.vertexAttributes;if(!i)return null;const r=e.indices,s=i.get("position");return(0,w.i)(s,r?r.get("position"):null,r&&Cf(this.params,i,r),t)}createLayout(){const e=(0,G.A)().vec3f("position").f32("subdivisionFactor").vec2f("uv0").vec3f("auxpos1").vec3f("auxpos2");return this.params.vvSizeEnabled?e.f32("sizeFeatureAttribute"):e.f32("size"),this.params.vvColorEnabled?e.f32("colorFeatureAttribute"):e.vec4f("color"),this.params.vvOpacityEnabled&&e.f32("opacityFeatureAttribute"),e}createBufferWriter(){return new bf(this.layout,this.params)}getGLMaterial(e){return 0===e.output||7===e.output||4===e.output||1===e.output?new _f(e):void 0}validateParameterValues(e){"miter"!==e.join&&(e.miterLimit=0),this.requiresTransparent(e)&&(e.transparent=!0)}requiresTransparent(e){return!!((e.color&&e.color[3])<1||e.innerWidth>0&&this.colorRequiresTransparent(e.innerColor)||e.stipplePattern&&this.colorRequiresTransparent(e.stippleOffColor)||e.falloff>0)}colorRequiresTransparent(e){return(0,u.r)(e)&&e[3]<1&&e[3]>0}}class _f extends S.aj{constructor(e){super(e),this.updateParameters()}updateParameters(e){this._technique=this._techniqueRep.releaseAndAcquire(mf,this._material.getTechniqueConfig(this._output,e),this._technique)}beginSlot(e){return this._technique.configuration.occluder?3===e||10===e||11===e:0===this._output||7===this._output?(this.targetSlot=this._technique.configuration.writeDepth?5:8,e===this.targetSlot):3===e}_updateOccludeeState(e){e.hasOccludees!==this._material.params.sceneHasOcludees&&this._material.setParameterValues({sceneHasOcludees:e.hasOccludees})}ensureParameters(e){0!==this._output&&7!==this._output||this._updateOccludeeState(e),this.updateParameters(e)}bind(e){this._technique.bindPass(this._material.getPassParameters(),e)}getPipelineState(e,t){return this._technique.getPipelineState(e,t)}}const xf={width:0,color:[1,1,1,1],join:"miter",cap:"butt",miterLimit:5,writeDepth:!0,polygonOffset:!1,stipplePattern:null,stippleIntegerRepeats:!1,stippleOffColor:null,slicePlaneEnabled:!1,vvFastUpdate:!1,transparent:!1,isClosed:!1,falloff:0,innerWidth:0,innerColor:null,sceneHasOcludees:!1,...S.ab,...lf.Default};class bf{constructor(e,t){switch(this.params=t,this.numJoinSubdivisions=0,this.vertexBufferLayout=e,this.params.join){case"miter":case"bevel":this.numJoinSubdivisions=t.stipplePattern?1:0;break;case"round":this.numJoinSubdivisions=Pf}}isClosed(e){return Cf(this.params,e.vertexAttributes,e.indices)}numCapSubdivisions(e){if(this.isClosed(e))return 0;switch(this.params.cap){case"butt":return 0;case"square":return 1;case"round":return Sf}}allocate(e){return this.vertexBufferLayout.createBuffer(e)}elementCount(e){const t=2*this.numCapSubdivisions(e)+2,i=e.indices.get("position").length/2+1,r=this.isClosed(e);let s=r?2:2*t;const n=r?0:1,a=r?i:i-1;if(e.vertexAttributes.has("subdivisions")){const t=e.vertexAttributes.get("subdivisions").data;for(let e=n;e<a;++e)s+=4+2*t[e]}else s+=(a-n)*(2*this.numJoinSubdivisions+4);return s+=2,s}write(e,t,i,r){const s=Uf,n=Gf,a=Bf,o=t.vertexAttributes.get("position").data,l=t.indices&&t.indices.get("position"),c=this.numCapSubdivisions(t);l&&l.length!==2*(o.length/3-1)&&console.warn("RibbonLineMaterial does not support indices");let h=null;t.vertexAttributes.has("subdivisions")&&(h=t.vertexAttributes.get("subdivisions").data);let d=1,u=0;this.params.vvSizeEnabled?u=t.vertexAttributes.get("sizeFeatureAttribute").data[0]:t.vertexAttributes.has("size")&&(d=t.vertexAttributes.get("size").data[0]);let p=[1,1,1,1],m=0;this.params.vvColorEnabled?m=t.vertexAttributes.get("colorFeatureAttribute").data[0]:t.vertexAttributes.has("color")&&(p=t.vertexAttributes.get("color").data);let f=0;this.params.vvOpacityEnabled&&(f=t.vertexAttributes.get("opacityFeatureAttribute").data[0]);const g=o.length/3,y=e.transformation,_=new Float32Array(i.buffer),x=this.vertexBufferLayout.stride/4;let b=r*x;const w=b,C=(e,t,i,r,s,n,a)=>{if(_[b++]=t[0],_[b++]=t[1],_[b++]=t[2],_[b++]=r,_[b++]=s,_[b++]=n,_[b++]=e[0],_[b++]=e[1],_[b++]=e[2],_[b++]=i[0],_[b++]=i[1],_[b++]=i[2],this.params.vvSizeEnabled?_[b++]=u:_[b++]=d,this.params.vvColorEnabled)_[b++]=m;else{const e=Math.min(4*a,p.length-4);_[b++]=p[e+0],_[b++]=p[e+1],_[b++]=p[e+2],_[b++]=p[e+3]}this.params.vvOpacityEnabled&&(_[b++]=f)};b+=x,(0,v.a)(n,o[0],o[1],o[2]),y&&(0,v.I)(n,n,y);const T=this.isClosed(t);if(T){const e=o.length-3;(0,v.a)(s,o[e],o[e+1],o[e+2]),y&&(0,v.I)(s,s,y)}else{(0,v.h)(s,n),(0,v.a)(a,o[3],o[4],o[5]),y&&(0,v.I)(a,a,y);for(let e=0;e<c;++e){const t=1-e/c;C(s,n,a,t,1,-4,0),C(s,n,a,t,1,4,0)}C(s,n,a,0,0,-4,0),C(s,n,a,0,0,4,0),(0,v.h)(s,n),(0,v.h)(n,a)}const S=T?g:g-1;for(let e=T?0:1;e<S;e++){const t=(e+1)%g*3;(0,v.a)(a,o[t+0],o[t+1],o[t+2]),y&&(0,v.I)(a,a,y),C(s,n,a,0,1,-1,e),C(s,n,a,0,1,1,e);const i=h?h[e]:this.numJoinSubdivisions;for(let t=0;t<i;++t){const r=(t+1)/(i+1);C(s,n,a,r,1,-2,e),C(s,n,a,r,1,2,e)}C(s,n,a,1,0,-2,e),C(s,n,a,1,0,2,e),(0,v.h)(s,n),(0,v.h)(n,a)}if(T)b=wf(_,w+x,_,b,2*x);else{C(s,n,a,0,1,-5,S),C(s,n,a,0,1,5,S);for(let e=0;e<c;++e){const t=(e+1)/c;C(s,n,a,t,1,-5,S),C(s,n,a,t,1,5,S)}}wf(_,w+x,_,w,x),b=wf(_,b-x,_,b,x)}}function wf(e,t,i,r,s){for(let n=0;n<s;n++)i[r++]=e[t++];return r}function Cf(e,t,i){return Tf(e,t.get("position").data,i?i.get("position"):null)}function Tf(e,t,i){return!!e.isClosed&&(i?i.length>2:t.length>6)}const Sf=3,Pf=1,Rf=(0,v.n)(),Af=(0,v.n)(),Mf=(0,v.n)(),Of=(0,v.n)(),Df=(0,v.n)(),Ef=(0,f.x)(),zf=(0,f.x)(),If=(0,v.n)(),Lf=(0,v.n)(),Ff=(0,w.v)(),Vf=(0,w.v)(),Uf=(0,v.n)(),Gf=(0,v.n)(),Bf=(0,v.n)(),qf=[(0,f.x)(),(0,f.x)(),(0,f.x)(),(0,f.x)()],kf=[(0,v.n)(),(0,v.n)(),(0,v.n)(),(0,v.n)()],Nf=De(),jf=De(),Hf=De(),Wf=De();let Qf=0;class Zf{constructor(e){this._originSR=e,this.ROOT_ORIGIN_ID="rg_root_"+Qf++,this._origins=new Map,this._gridSize=125e4,this._objects=new Map}getOrigin(e){const t=this._origins.get(this.ROOT_ORIGIN_ID);if(null==t){if((0,u.r)(Yf))return this._origins.set(this.ROOT_ORIGIN_ID,xm(Yf[0],Yf[1],Yf[2],this.ROOT_ORIGIN_ID)),this.getOrigin(e);const t=xm(e[0]+Math.random()-.5,e[1]+Math.random()-.5,e[2]+Math.random()-.5,this.ROOT_ORIGIN_ID);return this._origins.set(this.ROOT_ORIGIN_ID,t),t}const i=this._gridSize,r=Math.round(e[0]/i),s=Math.round(e[1]/i),n=Math.round(e[2]/i),a=`rg_${r}/${s}/${n}`;let o=this._origins.get(a);const l=.5*i;if((0,v.c)(Xf,e,t.vec3),Xf[0]=Math.abs(Xf[0]),Xf[1]=Math.abs(Xf[1]),Xf[2]=Math.abs(Xf[2]),Xf[0]<l&&Xf[1]<l&&Xf[2]<l){if(o){const t=Math.max(...Xf);if((0,v.c)(Xf,e,o.vec3),Xf[0]=Math.abs(Xf[0]),Xf[1]=Math.abs(Xf[1]),Xf[2]=Math.abs(Xf[2]),Math.max(...Xf)<t)return o}return t}return o||(o=xm(r*i,s*i,n*i,a),this._origins.set(a,o)),o}_drawOriginBox(e,t=[1,1,0,1]){const i=window.view,r=i._stage,s=t.toString();if(!this._objects.has(s)){this._material=new yf({width:2,color:t}),r.add(this._material);const e=new nf({isPickable:!1}),i=new Qs({castShadow:!1});r.add(i),e.add(i),r.add(e),this._objects.set(s,i)}const n=this._objects.get(s),a=[0,1,5,4,0,2,1,7,6,2,0,1,3,7,5,4,6,2,0],o=a.length,l=new Array(3*o),c=new Uint16Array(2*(o-1)),h=.5*this._gridSize;for(let t=0;t<o;t++)l[3*t+0]=e[0]+(1&a[t]?h:-h),l[3*t+1]=e[1]+(2&a[t]?h:-h),l[3*t+2]=e[2]+(4&a[t]?h:-h),t>0&&(c[2*t+0]=t-1,c[2*t+1]=t);(0,_.x)(l,this._originSR,0,l,i.renderSpatialReference,0,o);const d=new S.u([["position",{size:3,data:l,exclusive:!0}]],[["position",c]],2);r.add(d),n.addGeometry(d,this._material,T.a)}get test(){const e=this;return{get gridSize(){return e._gridSize},set gridSize(t){e._gridSize=t}}}}let Yf=null;const Xf=(0,v.n)();class $f{constructor(e){this.rctx=e,this.camera=null,this.lastFrameCamera=new Ia,this.pass=0,this.slot=0,this.highlightDepthTexture=null,this.renderOccludedMask=Jf,this.hasOccludees=!1}resetRenderOccludedMask(){this.renderOccludedMask=Jf}get isHighlightPass(){return 5===this.pass}}class Kf extends $f{constructor(e,t,i,r,s,n){super(e),this.offscreenRenderingHelper=t,this.scenelightingData=i,this.shadowMap=r,this.ssaoHelper=s,this.sliceHelper=n}}const Jf=13;class eg{constructor(){this.adds=new r.f,this.removes=new r.f,this.updates=new r.f({allocator:e=>e||new tg,deallocator:e=>(e.renderGeometry=null,e)})}clear(){this.adds.clear(),this.removes.clear(),this.updates.clear()}prune(){this.adds.prune(),this.removes.prune(),this.updates.prune()}}class tg{}class ig{constructor(){this.adds=new Array,this.removes=new Array,this.updates=new Array}}function rg(e){const t=new Map,i=e=>{let i=t.get(e);return i||(i=new ig,t.set(e,i)),i};return e.adds.forAll((e=>{sg(e)&&i(e.material).adds.push(e)})),e.removes.forAll((e=>{sg(e)&&i(e.material).removes.push(e)})),e.updates.forAll((e=>{sg(e.renderGeometry)&&i(e.renderGeometry.material).updates.push(e)})),t}function sg(e){return e.data.indexCount>=1}class ng{constructor(e){null==e?e=16:e<65536&&(e=(0,v.O)(e)),this._array=new Float32Array(e),this._size=0}resize(e,t){if(this._size=e,this._size>this._array.length){let e=this._array.length||1;for(;e<this._size;)e*=2;const i=new Float32Array(e);return t&&i.set(this._array),this._array=i,!0}const i=2*this._size;if(i<=this._array.length){let e=this._array.length;for(;e>=i;)e=Math.floor(e/2);const r=new Float32Array(e);return t&&r.set(this._array.subarray(0,e)),this._array=r,!0}return!1}append(e){const t=this._size;this.resize(this._size+e.length,!0),this._array.set(e,t)}erase(e,t){for(let i=e;i<t;++i)this._array[i]=0}get array(){return this._array}get size(){return this._size}}function ag(e){e.fragment.uniforms.add("lastFrameColorMap","sampler2D"),e.fragment.uniforms.add("reprojectionMat","mat4"),e.fragment.uniforms.add("rpProjectionMat","mat4"),e.fragment.code.add(S.t`vec2 reprojectionCoordinate(vec3 projectionCoordinate)
{
vec4 zw = rpProjectionMat * vec4(0.0, 0.0, -projectionCoordinate.z, 1.0);
vec4 reprojectedCoord = reprojectionMat * vec4(zw.w * (projectionCoordinate.xy * 2.0 - 1.0), zw.z, zw.w);
reprojectedCoord.xy /= reprojectedCoord.w;
return reprojectedCoord.xy * 0.5 + 0.5;
}`)}function og(e,t){e.fragment.uniforms.add("nearFar","vec2"),e.fragment.uniforms.add("depthMapView","sampler2D"),e.fragment.uniforms.add("ssrViewMat","mat4"),e.fragment.uniforms.add("invResolutionHeight","float"),e.fragment.include(S.L),e.include(ag),e.fragment.code.add(S.t`
  const int maxSteps = ${t.highStepCount?"150;":"75;"}

  vec4 applyProjectionMat(mat4 projectionMat, vec3 x)
  {
    vec4 projectedCoord =  projectionMat * vec4(x, 1.0);
    projectedCoord.xy /= projectedCoord.w;
    projectedCoord.xy = projectedCoord.xy*0.5 + 0.5;
    return projectedCoord;
  }

  vec3 screenSpaceIntersection(vec3 dir, vec3 startPosition, vec3 viewDir, vec3 normal)
  {
    vec3 viewPos = startPosition;
    vec3 viewPosEnd = startPosition;

    // Project the start position to the screen
    vec4 projectedCoordStart = applyProjectionMat(rpProjectionMat, viewPos);
    vec3  Q0 = viewPos / projectedCoordStart.w; // homogeneous camera space
    float k0 = 1.0/ projectedCoordStart.w;

    // advance the position in the direction of the reflection
    viewPos += dir;

    vec4 projectedCoordVanishingPoint = applyProjectionMat(rpProjectionMat, dir);

    // Project the advanced position to the screen
    vec4 projectedCoordEnd = applyProjectionMat(rpProjectionMat, viewPos);
    vec3  Q1 = viewPos / projectedCoordEnd.w; // homogeneous camera space
    float k1 = 1.0/ projectedCoordEnd.w;

    // calculate the reflection direction in the screen space
    vec2 projectedCoordDir = (projectedCoordEnd.xy - projectedCoordStart.xy);
    vec2 projectedCoordDistVanishingPoint = (projectedCoordVanishingPoint.xy - projectedCoordStart.xy);

    float yMod = min(abs(projectedCoordDistVanishingPoint.y), 1.0);

    float projectedCoordDirLength = length(projectedCoordDir);
    float maxSt = float(maxSteps);

    // normalize the projection direction depending on maximum steps
    // this determines how blocky the reflection looks
    vec2 dP = yMod * (projectedCoordDir)/(maxSt * projectedCoordDirLength);

    // Normalize the homogeneous camera space coordinates
    vec3  dQ = yMod * (Q1 - Q0)/(maxSt * projectedCoordDirLength);
    float dk = yMod * (k1 - k0)/(maxSt * projectedCoordDirLength);

    // initialize the variables for ray marching
    vec2 P = projectedCoordStart.xy;
    vec3 Q = Q0;
    float k = k0;
    float rayStartZ = -startPosition.z; // estimated ray start depth value
    float rayEndZ = -startPosition.z;   // estimated ray end depth value
    float prevEstimateZ = -startPosition.z;
    float rayDiffZ = 0.0;
    float dDepth;
    float depth;
    float rayDiffZOld = 0.0;

    // early outs
    if (dot(normal, dir) < 0.0 || dot(-viewDir, normal) < 0.0)
      return vec3(P, 0.0);

    for(int i = 0; i < maxSteps-1; i++)
    {
      depth = -linearDepthFromTexture(depthMapView, P, nearFar); // get linear depth from the depth buffer

      // estimate depth of the marching ray
      rayStartZ = prevEstimateZ;
      dDepth = -rayStartZ - depth;
      rayEndZ = (dQ.z * 0.5 + Q.z)/ ((dk * 0.5 + k));
      rayDiffZ = rayEndZ- rayStartZ;
      prevEstimateZ = rayEndZ;

      if(-rayEndZ > nearFar[1] || -rayEndZ < nearFar[0] || P.y < 0.0  || P.y > 1.0 )
      {
        return vec3(P, 0.);
      }

      // If we detect a hit - return the intersection point, two conditions:
      //  - dDepth > 0.0 - sampled point depth is in front of estimated depth
      //  - if difference between dDepth and rayDiffZOld is not too large
      //  - if difference between dDepth and 0.025/abs(k) is not too large
      //  - if the sampled depth is not behind far plane or in front of near plane

      if((dDepth) < 0.025/abs(k) + abs(rayDiffZ) && dDepth > 0.0 && depth > nearFar[0] && depth < nearFar[1] && abs(P.y - projectedCoordStart.y) > invResolutionHeight)
      {
          return vec3(P, depth);
      }

      // continue with ray marching
      P += dP;
      Q.z += dQ.z;
      k += dk;
      rayDiffZOld = rayDiffZ;
    }
    return vec3(P, 0.0);
  }
  `)}function lg(e,t){t.ssrEnabled&&(e.bindTexture(t.linearDepthTexture,"depthMapView"),e.setUniform2fv("nearFar",t.camera.nearFar),e.setUniformMatrix4fv("ssrViewMat",t.camera.viewMatrix),e.setUniform1f("invResolutionHeight",1/t.camera.height),function(e,t){e.bindTexture(t.lastFrameColorTexture,"lastFrameColorMap"),e.setUniformMatrix4fv("reprojectionMat",t.reprojectionMat),e.setUniformMatrix4fv("rpProjectionMat",t.camera.projectionMatrix)}(e,t))}function cg(e){e.fragment.code.add(S.t`float normals2FoamIntensity(vec3 n, float waveStrength){
float normalizationFactor =  max(0.015, waveStrength);
return max((n.x + n.y)*0.3303545/normalizationFactor + 0.3303545, 0.0);
}`)}function hg(e){e.fragment.code.add(S.t`vec3 foamIntensity2FoamColor(float foamIntensityExternal, float foamPixelIntensity, vec3 skyZenitColor, float dayMod){
return foamIntensityExternal * (0.075 * skyZenitColor * pow(foamPixelIntensity, 4.) +  50.* pow(foamPixelIntensity, 23.0)) * dayMod;
}`)}function dg(e){e.fragment.uniforms.add("texWaveNormal","sampler2D"),e.fragment.uniforms.add("texWavePerturbation","sampler2D"),e.fragment.uniforms.add("waveParams","vec4"),e.fragment.uniforms.add("waveDirection","vec2"),e.include(cg),e.fragment.code.add(S.t`const vec2  FLOW_JUMP = vec2(6.0/25.0, 5.0/24.0);
vec2 textureDenormalized2D(sampler2D _tex, vec2 _uv) {
return 2.0 * texture2D(_tex, _uv).rg - 1.0;
}
float sampleNoiseTexture(vec2 _uv) {
return texture2D(texWavePerturbation, _uv).b;
}
vec3 textureDenormalized3D(sampler2D _tex, vec2 _uv) {
return 2.0 * texture2D(_tex, _uv).rgb - 1.0;
}
float computeProgress(vec2 uv, float time) {
return fract(time);
}
float computeWeight(vec2 uv, float time) {
float progress = computeProgress(uv, time);
return 1.0 - abs(1.0 - 2.0 * progress);
}
vec3 computeUVPerturbedWeigth(sampler2D texFlow, vec2 uv, float time, float phaseOffset) {
float flowStrength = waveParams[2];
float flowOffset = waveParams[3];
vec2 flowVector = textureDenormalized2D(texFlow, uv) * flowStrength;
float progress = computeProgress(uv, time + phaseOffset);
float weight = computeWeight(uv, time + phaseOffset);
vec2 result = uv;
result -= flowVector * (progress + flowOffset);
result += phaseOffset;
result += (time - progress) * FLOW_JUMP;
return vec3(result, weight);
}
const float TIME_NOISE_TEXTURE_REPEAT = 0.3737;
const float TIME_NOISE_STRENGTH = 7.77;
vec3 getWaveLayer(sampler2D _texNormal, sampler2D _dudv, vec2 _uv, vec2 _waveDir, float time) {
float waveStrength = waveParams[0];
vec2 waveMovement = time * -_waveDir;
float timeNoise = sampleNoiseTexture(_uv * TIME_NOISE_TEXTURE_REPEAT) * TIME_NOISE_STRENGTH;
vec3 uv_A = computeUVPerturbedWeigth(_dudv, _uv + waveMovement, time + timeNoise, 0.0);
vec3 uv_B = computeUVPerturbedWeigth(_dudv, _uv + waveMovement, time + timeNoise, 0.5);
vec3 normal_A = textureDenormalized3D(_texNormal, uv_A.xy) * uv_A.z;
vec3 normal_B = textureDenormalized3D(_texNormal, uv_B.xy) * uv_B.z;
vec3 mixNormal = normalize(normal_A + normal_B);
mixNormal.xy *= waveStrength;
mixNormal.z = sqrt(1.0 - dot(mixNormal.xy, mixNormal.xy));
return mixNormal;
}
vec4 getSurfaceNormalAndFoam(vec2 _uv, float _time) {
float waveTextureRepeat = waveParams[1];
vec3 normal = getWaveLayer(texWaveNormal, texWavePerturbation, _uv * waveTextureRepeat, waveDirection, _time);
float foam  = normals2FoamIntensity(normal, waveParams[0]);
return vec4(normal, foam);
}`)}function ug(e,t){1===t.viewingMode?e.vertex.code.add(S.t`vec3 getLocalUp(in vec3 pos, in vec3 origin) {
return normalize(pos + origin);
}`):e.vertex.code.add(S.t`vec3 getLocalUp(in vec3 pos, in vec3 origin) {
return vec3(0.0, 0.0, 1.0);
}`),1===t.viewingMode?e.vertex.code.add(S.t`mat3 getTBNMatrix(in vec3 n) {
vec3 t = normalize(cross(vec3(0.0, 0.0, 1.0), n));
vec3 b = normalize(cross(n, t));
return mat3(t, b, n);
}`):e.vertex.code.add(S.t`mat3 getTBNMatrix(in vec3 n) {
vec3 t = vec3(1.0, 0.0, 0.0);
vec3 b = normalize(cross(n, t));
return mat3(t, b, n);
}`)}function pg(e){e.fragment.code.add(S.t`const float GAMMA = 2.2;
const float INV_GAMMA = 0.4545454545;
vec4 delinearizeGamma(vec4 color) {
return vec4(pow(color.rgb, vec3(INV_GAMMA)), color.w);
}
vec3 linearizeGamma(vec3 color) {
return pow(color, vec3(GAMMA));
}`)}function mg(e,t){e.include(S.aE,t),e.include(pg),e.include(hg),t.ssrEnabled&&e.include(og,t),e.fragment.constants.add("fresnelSky","vec3",[.02,1,15]).add("fresnelMaterial","vec2",[.02,.1]).add("roughness","float",.015).add("foamIntensityExternal","float",1.7).add("ssrIntensity","float",.65).add("ssrHeightFadeStart","float",3e5).add("ssrHeightFadeEnd","float",5e5).add("waterDiffusion","float",.775).add("waterSeeColorMod","float",.8).add("correctionViewingPowerFactor","float",.4).add("skyZenitColor","vec3",[.52,.68,.9]).add("skyColor","vec3",[.67,.79,.9]),e.fragment.code.add(S.t`PBRShadingWater shadingInfo;
vec3 getSkyGradientColor(in float cosTheta, in vec3 horizon, in vec3 zenit) {
float exponent = pow((1.0 - cosTheta), fresnelSky[2]);
return mix(zenit, horizon, exponent);
}`),e.fragment.code.add(S.t`vec3 getSeaColor(in vec3 n, in vec3 v, in vec3 l, vec3 color, in vec3 lightIntensity, in vec3 localUp, in float shadow, float foamIntensity, vec3 positionView) {
float reflectionHit = 0.;
vec3 seaWaterColor = linearizeGamma(color);
vec3 h = normalize(l + v);
shadingInfo.NdotL = clamp(dot(n, l), 0.0, 1.0);
shadingInfo.NdotV = clamp(dot(n, v), 0.001, 1.0);
shadingInfo.VdotN = clamp(dot(v, n), 0.001, 1.0);
shadingInfo.NdotH = clamp(dot(n, h), 0.0, 1.0);
shadingInfo.VdotH = clamp(dot(v, h), 0.0, 1.0);
shadingInfo.LdotH = clamp(dot(l, h), 0.0, 1.0);
float upDotV = max(dot(localUp,v), 0.0);
vec3 skyHorizon = linearizeGamma(skyColor);
vec3 skyZenit = linearizeGamma(skyZenitColor);
vec3 skyColor = getSkyGradientColor(upDotV, skyHorizon, skyZenit );
float upDotL = max(dot(localUp,l),0.0);
float daytimeMod = 0.1 + upDotL * 0.9;
skyColor *= daytimeMod;
float shadowModifier = clamp(shadow, 0.8, 1.0);
vec3 fresnelModifier = fresnelReflection(shadingInfo.VdotN, vec3(fresnelSky[0]), fresnelSky[1]);
vec3 reflSky = fresnelModifier * skyColor * shadowModifier;
vec3 reflSea = seaWaterColor * mix(skyColor, upDotL * lightIntensity * LIGHT_NORMALIZATION, 2.0 / 3.0) * shadowModifier;
vec3 specular = vec3(0.0);
if(upDotV > 0.0 && upDotL > 0.0) {
vec3 specularSun = brdfSpecularWater(shadingInfo, roughness, vec3(fresnelMaterial[0]), fresnelMaterial[1]);
vec3 incidentLight = lightIntensity * LIGHT_NORMALIZATION * shadow;
specular = shadingInfo.NdotL * incidentLight * specularSun;
}
vec3 foam = vec3(0.0);
if(upDotV > 0.0) {
foam = foamIntensity2FoamColor(foamIntensityExternal, foamIntensity, skyZenitColor, daytimeMod);
}`),t.ssrEnabled?e.fragment.code.add(S.t`vec4 viewPosition = vec4(positionView.xyz, 1.0);
vec3 viewDir = normalize(viewPosition.xyz);
vec4 viewNormalVectorCoordinate = ssrViewMat *vec4(n, 0.0);
vec3 viewNormal = normalize(viewNormalVectorCoordinate.xyz);
vec4 viewUp = ssrViewMat *vec4(localUp, 0.0);
float correctionViewingFactor = pow(max(dot(-viewDir, viewUp.xyz), 0.0), correctionViewingPowerFactor);
vec3 viewNormalCorrected = mix(viewUp.xyz, viewNormal, correctionViewingFactor);
vec3 reflected = normalize(reflect(viewDir, viewNormalCorrected));
vec3 hitCoordinate = screenSpaceIntersection( normalize(reflected), viewPosition.xyz, viewDir, viewUp.xyz);
vec3 reflectedColor = vec3(0.0);
if (hitCoordinate.z > 0.0)
{
vec2 reprojectedCoordinate = reprojectionCoordinate(hitCoordinate);
vec2 dCoords = smoothstep(0.3, 0.6, abs(vec2(0.5, 0.5) - hitCoordinate.xy));
float heightMod = smoothstep(ssrHeightFadeEnd, ssrHeightFadeStart, -positionView.z);
reflectionHit = waterDiffusion * clamp(1.0 - (1.3*dCoords.y), 0.0, 1.0) * heightMod;
reflectedColor = linearizeGamma(texture2D(lastFrameColorMap, reprojectedCoordinate).xyz)* reflectionHit * fresnelModifier.y * ssrIntensity;
}
float seeColorMod =  mix(waterSeeColorMod, waterSeeColorMod*0.5, reflectionHit);
return tonemapACES((1. - reflectionHit) * reflSky + reflectedColor + reflSea * seeColorMod + specular + foam);
}`):e.fragment.code.add(S.t`return tonemapACES(reflSky + reflSea * waterSeeColorMod + specular + foam);
}`)}function fg(e){const t=new S.n;return t.include(S.r,{linearDepth:!1}),t.attributes.add("position","vec3"),t.attributes.add("uv0","vec2"),t.vertex.uniforms.add("proj","mat4").add("view","mat4").add("localOrigin","vec3"),t.vertex.uniforms.add("waterColor","vec4"),0!==e.output&&7!==e.output||(t.include(ug,e),t.include(S.aF,e),t.varyings.add("vuv","vec2"),t.varyings.add("vpos","vec3"),t.varyings.add("vnormal","vec3"),t.varyings.add("vtbnMatrix","mat3"),e.multipassTerrainEnabled&&t.varyings.add("depth","float"),t.vertex.code.add(S.t`
      void main(void) {
        if (waterColor.a < ${S.t.float(S.Q)}) {
          // Discard this vertex
          gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
          return;
        }

        vuv = uv0;
        vpos = position;

        vnormal = getLocalUp(vpos, localOrigin);
        vtbnMatrix = getTBNMatrix(vnormal);

        ${e.multipassTerrainEnabled?"depth = (view * vec4(vpos, 1.0)).z;":""}

        gl_Position = transformPosition(proj, view, vpos);
        ${0===e.output?"forwardLinearDepth();":""}
      }
    `)),e.multipassTerrainEnabled&&(t.fragment.include(S.L),t.include(S.ap,e)),7===e.output&&(t.include(S.N,e),t.fragment.uniforms.add("waterColor","vec4"),t.fragment.code.add(S.t`
        void main() {
          discardBySlice(vpos);
          ${e.multipassTerrainEnabled?"terrainDepthTest(gl_FragCoord, depth);":""}

          gl_FragColor = vec4(waterColor.a);
        }
      `)),0===e.output&&(t.include(dg,e),t.include(S.N,e),e.receiveShadows&&t.include(S.aG,e),t.include(mg,e),t.fragment.uniforms.add("waterColor","vec4").add("lightingMainDirection","vec3").add("lightingMainIntensity","vec3").add("camPos","vec3").add("timeElapsed","float").add("view","mat4"),t.fragment.include(S.j),t.fragment.code.add(S.t`
      void main() {
        discardBySlice(vpos);
        ${e.multipassTerrainEnabled?"terrainDepthTest(gl_FragCoord, depth);":""}
        vec3 localUp = vnormal;
        // the created normal is in tangent space
        vec4 tangentNormalFoam = getSurfaceNormalAndFoam(vuv, timeElapsed);

        // we rotate the normal according to the tangent-bitangent-normal-Matrix
        vec3 n = normalize(vtbnMatrix * tangentNormalFoam.xyz);
        vec3 v = -normalize(vpos - camPos);
        float shadow = ${e.receiveShadows?S.t`1.0 - readShadowMap(vpos, linearDepth)`:"1.0"};
        vec4 vPosView = view*vec4(vpos, 1.0);
        vec4 final = vec4(getSeaColor(n, v, lightingMainDirection, waterColor.rgb, lightingMainIntensity, localUp, shadow, tangentNormalFoam.w, vPosView.xyz), waterColor.w);

        // gamma correction
        gl_FragColor = delinearizeGamma(final);
        gl_FragColor = highlightSlice(gl_FragColor, vpos);
        ${e.OITEnabled?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""}
      }
    `)),2===e.output&&(t.include(ug,e),t.include(dg,e),t.include(S.N,e),t.varyings.add("vpos","vec3"),t.varyings.add("vuv","vec2"),t.vertex.code.add(S.t`
        void main(void) {
          if (waterColor.a < ${S.t.float(S.Q)}) {
            // Discard this vertex
            gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
            return;
          }

          vuv = uv0;
          vpos = position;

          gl_Position = transformPosition(proj, view, vpos);
        }
    `),t.fragment.uniforms.add("timeElapsed","float"),t.fragment.code.add(S.t`void main() {
discardBySlice(vpos);
vec4 tangentNormalFoam = getSurfaceNormalAndFoam(vuv, timeElapsed);
tangentNormalFoam.xyz = normalize(tangentNormalFoam.xyz);
gl_FragColor = vec4((tangentNormalFoam.xyz + vec3(1.0)) * 0.5, tangentNormalFoam.w);
}`)),5===e.output&&(t.varyings.add("vpos","vec3"),t.vertex.code.add(S.t`
        void main(void) {
          if (waterColor.a < ${S.t.float(S.Q)}) {
            // Discard this vertex
            gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
            return;
          }

          vpos = position;
          gl_Position = transformPosition(proj, view, vpos);
        }
    `),t.fragment.uniforms.add("waterColor","vec4"),t.fragment.code.add(S.t`void main() {
gl_FragColor = waterColor;
}`)),4===e.output&&(t.include(S.S),t.varyings.add("vpos","vec3"),t.vertex.code.add(S.t`
      void main(void) {
        if (waterColor.a < ${S.t.float(S.Q)}) {
          // Discard this vertex
          gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
          return;
        }

        vpos = position;
        gl_Position = transformPosition(proj, view, vpos);
      }
    `),t.include(S.N,e),t.fragment.code.add(S.t`void main() {
discardBySlice(vpos);
outputHighlight();
}`)),t}var gg=Object.freeze({__proto__:null,build:fg});class vg extends S.c{constructor(e,t,i){super(e,t,i),this._textureRepository=e.waterTextureRepository}initializeProgram(e){const t=vg.shader.get(),i=this.configuration,r=t.build({OITEnabled:0===i.transparencyPassType,output:i.output,viewingMode:e.viewingMode,slicePlaneEnabled:i.slicePlaneEnabled,sliceHighlightDisabled:!1,sliceEnabledForVertexPrograms:!1,receiveShadows:i.receiveShadows,pbrMode:3,useCustomDTRExponentForWater:!0,ssrEnabled:i.useSSR,highStepCount:!0,multipassTerrainEnabled:i.multipassTerrainEnabled,cullAboveGround:i.cullAboveGround});return new S.d(e.rctx,r,S.o)}ensureResource(e){return this._textureRepository.ready||this._textureRepository.updating||this._textureRepository.loadTextures(e),this._textureRepository.ready?2:1}bindPass(e,t){(0,S.h)(this.program,t.camera.projectionMatrix),t.multipassTerrainEnabled&&(this.program.setUniform2fv("cameraNearFar",t.camera.nearFar),this.program.setUniform2fv("inverseViewport",t.inverseViewport),(0,S.Y)(this.program,t)),0===this.configuration.output&&(t.lighting.setUniforms(this.program,!1),lg(this.program,t)),0!==this.configuration.output&&2!==this.configuration.output||(function(e,t){e.setUniform4f("waveParams",t.waveStrength,t.waveTextureRepeat,t.flowStrength,t.flowOffset),e.setUniform2f("waveDirection",t.waveDirection[0]*t.waveVelocity,t.waveDirection[1]*t.waveVelocity)}(this.program,e),this._textureRepository.bind(this.program)),this.program.setUniform4fv("waterColor",e.color),4===this.configuration.output&&(0,S.a1)(this.program,t)}bindDraw(e){(0,S.a2)(this.program,e),this.program.rebindTextures(),0!==this.configuration.output&&7!==this.configuration.output||(0,S.a3)(this.program,e.origin,e.camera.viewInverseTransposeMatrix),0===this.configuration.output&&(0,S.aH)(this.program,e),0!==this.configuration.output&&7!==this.configuration.output&&4!==this.configuration.output||(0,S.a4)(this.program,this.configuration,e)}setPipelineState(e){const t=this.configuration,i=3===e,r=2===e;return(0,V.g)({blending:2!==t.output&&4!==t.output&&t.transparent?i?S.ar:(0,S.a5)(e):null,depthTest:{func:(0,S.as)(e)},depthWrite:i?t.writeDepth&&V.l:(0,S.at)(e),colorWrite:V.r,polygonOffset:i||r?null:(0,S.aI)(t.enableOffset)})}initializePipeline(){return this.setPipelineState(this.configuration.transparencyPassType)}}vg.shader=new S.f(gg,(()=>i.e(3924).then(i.bind(i,53924))));class yg extends S.b{constructor(){super(...arguments),this.output=0,this.receiveShadows=!1,this.slicePlaneEnabled=!1,this.transparent=!1,this.enableOffset=!0,this.writeDepth=!1,this.useSSR=!1,this.isDraped=!1,this.transparencyPassType=3,this.multipassTerrainEnabled=!1,this.cullAboveGround=!1}}(0,r.e)([(0,S.a)({count:8})],yg.prototype,"output",void 0),(0,r.e)([(0,S.a)()],yg.prototype,"receiveShadows",void 0),(0,r.e)([(0,S.a)()],yg.prototype,"slicePlaneEnabled",void 0),(0,r.e)([(0,S.a)()],yg.prototype,"transparent",void 0),(0,r.e)([(0,S.a)()],yg.prototype,"enableOffset",void 0),(0,r.e)([(0,S.a)()],yg.prototype,"writeDepth",void 0),(0,r.e)([(0,S.a)()],yg.prototype,"useSSR",void 0),(0,r.e)([(0,S.a)()],yg.prototype,"isDraped",void 0),(0,r.e)([(0,S.a)({count:4})],yg.prototype,"transparencyPassType",void 0),(0,r.e)([(0,S.a)()],yg.prototype,"multipassTerrainEnabled",void 0),(0,r.e)([(0,S.a)()],yg.prototype,"cullAboveGround",void 0);class _g extends S.aj{constructor(e){super(e),this.updateParameters()}updateParameters(e){this._technique=this._techniqueRep.releaseAndAcquire(vg,this._material.getTechniqueConfig(this._output,e),this._technique)}beginSlot(e){if(2===this._output)return 22===e;if(5===this._output)return null==e;if(4===this._output)return 3===e;let t=3;return this._material.params.transparent&&(t=this._material.params.writeDepth?5:8),e===t}setElapsedTimeUniform(e){const t=.001*this._material.animation.time;e.setUniform1f("timeElapsed",t*this._material.params.animationSpeed)}_updateShadowState(e){e.shadowMappingEnabled!==this._material.params.receiveShadows&&this._material.setParameterValues({receiveShadows:e.shadowMappingEnabled})}_updateSSRState(e){e.ssrEnabled!==this._material.params.ssrEnabled&&this._material.setParameterValues({ssrEnabled:e.ssrEnabled})}ensureResources(e){return this._technique.ensureResource(e)}ensureParameters(e){0===this._output&&(this._updateShadowState(e),this._updateSSRState(e)),this.updateParameters(e)}bind(e){this._technique.bindPass(this._material.params,e),2!==this._output&&0!==this._output||this.setElapsedTimeUniform(this._technique.program)}}class xg{constructor(e,t,i,r,s,n){this.from=e,this.to=t,this.isVisible=i,this.hasHighlights=r,this.hasOccludees=s,this.transformation=n,null!=n&&(this.transformationNormal=(0,T.r)(n),(0,C.h)(this.transformationNormal,this.transformationNormal),(0,C.o)(this.transformationNormal,this.transformationNormal))}}function bg(e,t){const i=e=>({first:e.from,count:e.to-e.from});if(0===e.length)return void e.push(i(t));const r=e[e.length-1];if(function(e,t){return e.first+e.count>=t.from}(r,t)){const e=t.from-r.first+t.to-t.from;r.count=e}else e.push(i(t))}function wg(e){const t=e.capabilities.disjointTimerQuery;return(0,u.t)(t)?null:t.timestampBits()>0?new Cg(t):Sg?null:new Tg(t)}class Cg{constructor(e){this.timer=e,this.start=e.createQuery(),e.createTimestamp(this.start)}stop(e,t=50){this.end=this.timer.createQuery(),this.timer.createTimestamp(this.end),this.checkQueryResult(e,t)}checkQueryResult(e,t){if(!this.timer.resultAvailable(this.end))return void setTimeout((()=>this.checkQueryResult(e,t)),t);if(this.timer.disjoint())return void e(null);const i=this.timer.getResult(this.start),r=this.timer.getResult(this.end);e((r-i)/1e6)}}class Tg{constructor(e){this.timer=e,this.query=e.createQuery(),Sg=!0,this.timer.beginTimeElapsed(this.query)}stop(e,t=50){this.timer.endTimeElapsed(),Sg=!1,this.checkQueryResult(e,t)}checkQueryResult(e,t){const i=this.timer.resultAvailable(this.query),r=this.timer.disjoint();if(!i||r)r?e(null):setTimeout((()=>this.checkQueryResult(e,t)),t);else{const t=this.timer.getResult(this.query);e(t/1e6)}}}let Sg=!1;const Pg=["prepare","shadowmap","lineardepth","normals","ssao","opaque","opaque edges","transparent","transparent edges","hudvisibility","transparent terrain","atmosphere","laserline","occluded","antialiasing","highlights","hudOccluded","hudNotoccluded"];class Rg{constructor(){this.triangles=0,this.drawCalls=0}reset(){this.triangles=0,this.drawCalls=0}}function Ag(e,t,i){(0,u.r)(i)&&(i.drawCalls+=e,i.triangles+=t)}class Mg extends r.E{constructor(){super("total"),this.total=0,this.frameCount=0}}class Og{constructor(){this._startTime=0,this._lastSample=0,this._enableGPUTimer=0,this.totalTime=new Mg,this.gpuTime=new r.E("gpu",9),this.renderPassTimings=Pg.map((e=>new r.E(e))),this.stats=new Rg}enableGPUTimer(){return++this._enableGPUTimer,{remove:(0,d.g)((()=>--this._enableGPUTimer))}}prerender(e){this._startTime=this._lastSample=performance.now(),this._enableGPUTimer&&(this._gpuTimer=wg(e))}advance(e){const t=performance.now();this.renderPassTimings[e].record(t-this._lastSample),this._lastSample=t}postrender(){(0,u.r)(this._gpuTimer)&&(this._gpuTimer.stop((e=>(0,u.r)(e)&&this.gpuTime.record(e)),16),this._gpuTimer=null);const e=performance.now()-this._startTime;this.totalTime.record(e),this.totalTime.total+=e,this.totalTime.frameCount++}}class Dg{constructor(e,t,i){this.type="MergedRenderer",this._dataByOrigin=new Map,this._hasHighlights=!1,this._hasOccludees=!1,this._rctx=e,this._material=i,this._materialRep=t,this._glMaterials=(0,S.aJ)(this._material,this._materialRep),this._bufferWriter=i.createBufferWriter()}dispose(){(0,S.aK)(this._material,this._materialRep),this._dataByOrigin&&(this._dataByOrigin.forEach((e=>{e.vao.dispose(!0),e.vao=null})),this._dataByOrigin.clear(),this._dataByOrigin=null),this._glMaterials&&(this._glMaterials.forEach((e=>{e&&e.dispose()})),this._glMaterials.clear(),this._glMaterials=null)}get isEmpty(){return 0===this._dataByOrigin.size}get hasHighlights(){return this._hasHighlights}get hasOccludees(){return this._hasOccludees}get hasWater(){return!this.isEmpty&&(0,s.g)(this._glMaterials,(e=>e instanceof _g))}get rendersOccluded(){return!this.isEmpty&&1!==this._material.renderOccluded}modify(e){this.updateGeometries(e.updates),this.addAndRemoveGeometries(e.adds,e.removes),this.updateRenderCommands()}addAndRemoveGeometries(e,t){const i=this._bufferWriter,r=i.vertexBufferLayout,s=r.stride/4,n=this._dataByOrigin,a=function(e,t,i,r){const s=new Map,n=t.vertexBufferLayout.stride/4,a=(i,r)=>{const a=i.origin;if((0,u.t)(a))return;const o=e.get(a.id);let l=s.get(a.id);null==l&&(l={optimalCount:null==o?0:o.optimalCount,sparseCount:null==o?0:o.buffer.size,toAdd:[],toRemove:[],origin:a.vec3},s.set(a.id,l));const c=t.elementCount(i.data)*n;r?(l.optimalCount+=c,l.sparseCount+=c,l.toAdd.push(i)):(l.optimalCount-=c,l.toRemove.push(i))};for(const e of i)a(e,!0);for(const e of r)a(e,!1);return s}(n,i,e,t);a.forEach(((e,t)=>{a.delete(t);const i=e.optimalCount,o=e.sparseCount;let l=n.get(t);if(null==l)(0,S.i)(i>0),l=this.createData(r,i,e.origin),n.set(t,l);else if(0===i)return l.vao.dispose(!0),l.vao=null,void n.delete(t);const c=i<e.sparseCount/2,h=c?i:o,d=zg,u=l.buffer.size,p=l.buffer.array,m=l.buffer.resize(h,!1);c||m?this.removeAndRebuild(l,e.toRemove,s,p,d):e.toRemove.length>0?(this.removeByErasing(l,e.toRemove,s,d),e.toAdd.length>0&&(d.end=u)):(d.begin=u,d.end=u);const f=Ig;(0,S.aL)(f,-e.origin[0],-e.origin[1],-e.origin[2]),this.append(l,e.toAdd,s,f,d);const g=l.vao.vertexBuffers.geometry;if(g.byteSize!==l.buffer.array.buffer.byteLength)g.setData(l.buffer.array);else{const{begin:e,end:t}=d;if(e<t){const i=l.buffer.array,r=4,s=e*r,n=t*r;g.setSubData(i,s,s,n)}}l.drawCommandsDirty=!0}))}updateGeometries(e){const t=this._bufferWriter,i=t.vertexBufferLayout.stride/4;for(const r of e){const e=r.updateType,s=r.renderGeometry,n=this._dataByOrigin.get(s.origin.id),a=n&&n.instances.get(s.id);if(!a)return;if(1&e&&(a.isVisible=s.instanceParameters.visible),9&e){const e=s.instanceParameters.visible;a.hasHighlights=!!s.instanceParameters.highlights&&e}if(16&e&&(a.hasOccludees=!!s.instanceParameters.occludees),6&e){const e=n.buffer.array,r=n.vao;(0,S.aM)(s,Lg,Fg),t.write({transformation:Lg,invTranspTransformation:Fg},s.data,t.vertexBufferLayout.createView(e.buffer),a.from),(0,S.i)(a.from+t.elementCount(s.data)===a.to,"material VBO layout has changed"),r.vertexBuffers.geometry.setSubData(e,a.from*i*4,a.from*i*4,a.to*i*4)}n.drawCommandsDirty=!0}}updateRenderCommands(){this._hasHighlights=!1,this._hasOccludees=!1,this._dataByOrigin.forEach((e=>{e.hasHiddenInstances=!1,e.hasHighlights=!1,e.hasOccludees=!1,(0,s.g)(e.instances,(t=>(t.isVisible?(t.hasHighlights&&(this._hasHighlights=!0,e.hasHighlights=!0),t.hasOccludees&&(this._hasOccludees=!0,e.hasOccludees=!0)):e.hasHiddenInstances=!0,e.hasHiddenInstances&&e.hasHighlights&&e.hasOccludees)))})),this._dataByOrigin.forEach((e=>{e.drawCommandsDirty&&((e=>{if(e.drawCommandsDefault=null,e.drawCommandsHighlight=null,e.drawCommandsOccludees=null,e.drawCommandsShadowHighlightRest=null,e.stats={default:0,highlight:0,occludees:0,shadowHighlightRest:0},0===e.instances.size)return;if(!Eg(e)){const t=4*e.buffer.size/(0,V.b)(e.vao.layout.geometry);return e.drawCommandsDefault=[{first:0,count:t}],void(e.stats={default:t,highlight:0,occludees:0,shadowHighlightRest:0})}const t=function(e){return e.sort(((e,t)=>e.from===t.from?e.to>t.to?1:e.to<t.to?-1:0:e.from>t.from?1:e.from<t.from?-1:0))}([...e.instances.values()]);e.drawCommandsDefault=[],e.drawCommandsHighlight=[],e.drawCommandsOccludees=[],e.drawCommandsShadowHighlightRest=[];for(const i of t)i.isVisible&&(i.hasOccludees?bg(e.drawCommandsOccludees,i):bg(e.drawCommandsDefault,i),i.hasHighlights?bg(e.drawCommandsHighlight,i):bg(e.drawCommandsShadowHighlightRest,i));const i=e=>{let t=0;for(const i of e)t+=i.count;return t/3};e.stats={default:i(e.drawCommandsDefault),highlight:i(e.drawCommandsHighlight),occludees:i(e.drawCommandsOccludees),shadowHighlightRest:i(e.drawCommandsShadowHighlightRest)}})(e),e.drawCommandsDirty=!1)}))}updateLogic(e){return this._material.update(e)}render(e,t,i,r){const s=this._rctx,n=this._glMaterials.get(t),a=5===t||7===t,o=6===t,l=!(a||o);if(3===t&&null===e&&(e=22),!n||2!==n.ensureResources(s)||null!=e&&!n.beginSlot(e)||a&&!this._hasHighlights)return!1;n.ensureParameters(i);const c=n.getPipelineState(e,!1);s.setPipelineState(c);const h=n.technique;s.useProgram(h.program),n.bind(i);let d=!1;return this._dataByOrigin.forEach((t=>{if((0,u.t)(t.drawCommandsDefault)&&(0,u.t)(t.drawCommandsHighlight)&&(0,u.t)(t.drawCommandsOccludees)&&(0,u.t)(t.drawCommandsShadowHighlightRest))return;if(a&&!t.hasHighlights)return;i.origin=t.origin,h.bindDraw(i,{},{}),h.ensureAttributeLocations(t.vao),s.bindVAO(t.vao);const p=h.primitiveType,m=a?t.drawCommandsHighlight:o&&Eg(t)?t.drawCommandsShadowHighlightRest:t.drawCommandsDefault;if((0,u.r)(m)){this.renderCommands(s,p,m);const e=a?t.stats.highlight:o&&Eg(t)?t.stats.shadowHighlightRest:t.stats.default;Ag(m.length,e,r),d=!0}if(l){const i=t.drawCommandsOccludees;if((0,u.r)(i)){const a=n.getPipelineState(e,!0);s.setPipelineState(a),this.renderCommands(s,p,i),s.setPipelineState(c),Ag(i.length,t.stats.occludees,r),d=!0}}})),d}renderCommands(e,t,i){for(let r=0;r<i.length;r++)e.drawArrays(t,i[r].first,i[r].count)}createData(e,t,i){return{instances:new Map,vao:new V.f(this._rctx,this._material.vertexAttributeLocations,{geometry:(0,U.t)(e)},{geometry:V.h.createVertex(this._rctx,35044)}),buffer:new ng(t),optimalCount:0,origin:i,hasHiddenInstances:!1,hasHighlights:!1,hasOccludees:!1,drawCommandsDirty:!1,drawCommandsDefault:null,drawCommandsOccludees:null,drawCommandsHighlight:null,drawCommandsShadowHighlightRest:null,stats:{default:0,highlight:0,occludees:0,shadowHighlightRest:0}}}removeAndRebuild(e,t,i,r,s){for(const r of t){const t=r.id,s=e.instances.get(t);e.optimalCount-=(s.to-s.from)*i,e.instances.delete(t)}let n=0;const a=e.buffer.array;s.begin=0,s.end=0;let o=-1,l=-1,c=0;e.instances.forEach((e=>{const t=e.from*i,s=e.to*i,h=s-t;o!==l&&l!==t?(a.set(r.subarray(o,l),c),c+=l-o,o=t):-1===o&&(o=t),l=s,e.from=n/i,n+=h,e.to=n/i})),o!==l&&a.set(r.subarray(o,l),c),s.end=n}removeByErasing(e,t,i,r){r.begin=1/0,r.end=-1/0;let s=-1,n=-1;for(const a of t){const t=a.id,o=e.instances.get(t),l=o.from*i,c=o.to*i;s!==n&&n!==l?(e.buffer.erase(s,n),s=l):-1===s&&(s=l),n=c,e.instances.delete(t),e.optimalCount-=c-l,l<r.begin&&(r.begin=l),c>r.end&&(r.end=c)}s!==n&&e.buffer.erase(s,n)}append(e,t,i,r,s){const n=this._bufferWriter;for(const a of t){const t=(0,u.r)(a.transformation)?(0,C.e)(Lg,r,a.transformation):r;(0,C.h)(Fg,t),(0,C.o)(Fg,Fg);const o=s.end;n.write({transformation:t,invTranspTransformation:Fg},a.data,n.vertexBufferLayout.createView(e.buffer.array.buffer),s.end/i);const l=n.elementCount(a.data)*i,c=o+l;(0,S.i)(null==e.instances.get(a.id));const h=a.instanceParameters.visible,d=!!a.instanceParameters.highlights&&h,p=!!a.instanceParameters.occludees,m=new xg(o/i,c/i,h,d,p);e.instances.set(a.id,m),e.optimalCount+=l,s.end+=l}}get test(){return{material:this._material,glMaterials:this._glMaterials}}}function Eg(e){return e.hasOccludees||e.hasHighlights||e.hasHiddenInstances}const zg={begin:0,end:0},Ig=(0,T.e)(),Lg=(0,T.e)(),Fg=(0,T.e)();let Vg=class extends r.p{constructor(){super(...arguments),this._pending=new Ug,this._changes=new eg,this._materialRenderers=new Map,this._sortedMaterialRenderers=new r.f,this._hasHighlights=!1,this._hasWater=!1}dispose(){this._changes.prune(),this._materialRenderers.forEach((e=>e.dispose())),this._materialRenderers.clear(),this._sortedMaterialRenderers.clear()}get updating(){return!this._pending.empty||this._changes.updates.length>0}get hasHighlights(){return this._hasHighlights}get hasWater(){return this._hasWater}get rendersOccluded(){return(0,s.g)(this._materialRenderers,(e=>e.rendersOccluded))}stopAnimationsAtTime(e){this._sortedMaterialRenderers.forAll((t=>(0,u.x)(t.material.animation,(t=>t.stopAtTime(e)))))}get isEmpty(){return!this.updating&&0===this._materialRenderers.size}commitChanges(){if(!this.updating)return!1;this._processAddsRemoves();const e=rg(this._changes);let t=!1,i=!1,r=!1;return e.forEach(((e,s)=>{let n=this._materialRenderers.get(s);if(!n&&e.adds.length>0&&(n=new Dg(this.rctx,this.materialRepository,s),this._materialRenderers.set(s,n),t=!0,i=!0,r=!0),!n)return;const a=i||n.hasHighlights,o=r||n.hasWater;n.modify(e),i=i||a!==n.hasHighlights,r=r||o!==n.hasWater,n.isEmpty&&(this._materialRenderers.delete(s),n.dispose(),t=!0)})),this._changes.clear(),t&&this.updateSortedMaterialRenderers(),i&&(this._hasHighlights=(0,s.g)(this._materialRenderers,(e=>e.hasHighlights))),r&&(this._hasWater=(0,s.g)(this._materialRenderers,(e=>e.hasWater))),this.notifyChange("updating"),!0}add(e){if(0===e.length)return;const t=this._pending.empty;for(const t of e)this._pending.adds.add(t);t&&this.notifyChange("updating")}remove(e){const t=this._pending.empty;for(const t of e)this._pending.adds.has(t)?(this._pending.removed.add(t),this._pending.adds.delete(t)):this._pending.removed.has(t)||this._pending.removes.add(t);t&&!this._pending.empty&&this.notifyChange("updating")}modify(e,t){const i=0===this._changes.updates.length;for(const i of e){const e=this._changes.updates.pushNew();e.renderGeometry=i,e.updateType=t}i&&this._changes.updates.length>0&&this.notifyChange("updating")}updateLogic(e){let t=!1;return this._sortedMaterialRenderers.forAll((({materialRenderer:i})=>{i.updateLogic&&i.updateLogic(e)&&(t=!0)})),t}render(e,t){for(let i=0;i<this._sortedMaterialRenderers.length;i++){const r=this._sortedMaterialRenderers.data[i];(0,S.aN)(r.material,e)&&r.materialRenderer.render(null,e.pass,t,null)}}updateSortedMaterialRenderers(){this._sortedMaterialRenderers.clear();let e=0;this._materialRenderers.forEach(((t,i)=>{i.insertOrder=e++,this._sortedMaterialRenderers.push({material:i,materialRenderer:t})})),this._sortedMaterialRenderers.sort(((e,t)=>{const i=t.material.renderPriority-e.material.renderPriority;return 0!==i?i:e.material.insertOrder-t.material.insertOrder}))}_processAddsRemoves(){this._changes.adds.clear(),this._changes.removes.clear(),this._changes.adds.pushArray(Array.from(this._pending.adds)),this._changes.removes.pushArray(Array.from(this._pending.removes));for(let e=0;e<this._changes.updates.length;){const t=this._changes.updates.data[e];this._pending.has(t.renderGeometry)?this._changes.updates.removeUnorderedIndex(e):e++}this._pending.clear()}get test(){return{sortedMaterialRenderers:this._sortedMaterialRenderers}}};(0,r.e)([(0,d.y)()],Vg.prototype,"rctx",void 0),(0,r.e)([(0,d.y)()],Vg.prototype,"materialRepository",void 0),(0,r.e)([(0,d.y)()],Vg.prototype,"updating",null),Vg=(0,r.e)([(0,d.n)("esri.views.3d.webgl-engine.lib.SortedRenderGeometryRenderer")],Vg);class Ug{constructor(){this.adds=new Set,this.removes=new Set,this.removed=new Set}get empty(){return 0===this.adds.size&&0===this.removes.size&&0===this.removed.size}has(e){return this.adds.has(e)||this.removes.has(e)||this.removed.has(e)}clear(){this.adds.clear(),this.removes.clear(),this.removed.clear()}}function Gg(e){e.attributes.add("position","vec2"),e.varyings.add("uv","vec2"),e.vertex.code.add(S.t`
    void main(void) {
      gl_Position = vec4(position, 0.0, 1.0);
      uv = position * 0.5 + vec2(0.5);
    }
  `)}function Bg(){const e=new S.n;return e.include(Gg),e.fragment.uniforms.add("tex","sampler2D"),e.fragment.uniforms.add("color","vec4"),e.fragment.code.add(S.t`void main() {
vec4 texColor = texture2D(tex, uv);
gl_FragColor = texColor * color;
}`),e}var qg=Object.freeze({__proto__:null,build:Bg});class kg extends S.c{initializeProgram(e){const t=kg.shader.get().build();return new S.d(e.rctx,t,S.o)}initializePipeline(){return this.configuration.hasAlpha?(0,V.g)({blending:(0,V.e)(770,1,771,771),colorWrite:V.r}):(0,V.g)({colorWrite:V.r})}}kg.shader=new S.f(qg,(()=>i.e(4513).then(i.bind(i,84513))));class Ng extends S.b{constructor(){super(...arguments),this.hasAlpha=!1}}function jg(e,t,i){(i=i||e).length=e.length;for(let r=0;r<e.length;r++)i[r]=e[r]*t[r];return i}function Hg(e,t,i){(i=i||e).length=e.length;for(let r=0;r<e.length;r++)i[r]=e[r]*t;return i}function Wg(e,t,i){(i=i||e).length=e.length;for(let r=0;r<e.length;r++)i[r]=e[r]+t[r];return i}function Qg(e){return(e+1)*(e+1)}function Zg(e,t,i){const r=e[0],s=e[1],n=e[2],a=i||[];return a.length=Qg(t),t>=0&&(a[0]=.28209479177),t>=1&&(a[1]=.4886025119*r,a[2]=.4886025119*n,a[3]=.4886025119*s),t>=2&&(a[4]=1.09254843059*r*s,a[5]=1.09254843059*s*n,a[6]=.31539156525*(3*n*n-1),a[7]=1.09254843059*r*n,a[8]=.54627421529*(r*r-s*s)),a}function Yg(e,t,i,r){(function(e,t){const i=Qg(e),r=t||{r:[],g:[],b:[]};r.r.length=r.g.length=r.b.length=i;for(let e=0;e<i;e++)r.r[e]=r.g[e]=r.b[e]=0})(t,r),(0,v.a)(i.intensity,0,0,0);let s=!1;const n=Xg,a=$g,o=Kg;n.length=0,a.length=0,o.length=0;for(const t of e)t instanceof ms&&!s?((0,v.h)(i.direction,t.direction),i.intensity[0]=t.intensity[0],i.intensity[1]=t.intensity[1],i.intensity[2]=t.intensity[2],i.castShadows=t.castShadows,s=!0):t instanceof ms||t instanceof ps?n.push(t):t instanceof us?a.push(t):t instanceof fs&&o.push(t);(function(e,t){const i=function(e){return(0,v.o)(Math.floor(Math.sqrt(e)-1),0,2)}(t.r.length);for(const r of e)(0,v.E)(tv,r.direction),Zg(tv,i,Jg),jg(Jg,iv),Hg(Jg,r.intensity[0],ev),Wg(t.r,ev),Hg(Jg,r.intensity[1],ev),Wg(t.g,ev),Hg(Jg,r.intensity[2],ev),Wg(t.b,ev)})(n,r),function(e,t){Zg(tv,0,Jg);for(const i of e)t.r[0]+=Jg[0]*iv[0]*i.intensity[0]*4*Math.PI,t.g[0]+=Jg[0]*iv[0]*i.intensity[1]*4*Math.PI,t.b[0]+=Jg[0]*iv[0]*i.intensity[2]*4*Math.PI}(a,r);for(const e of o)Wg(r.r,e.r),Wg(r.g,e.g),Wg(r.b,e.b)}(0,r.e)([(0,S.a)()],Ng.prototype,"hasAlpha",void 0);const Xg=[],$g=[],Kg=[],Jg=[0],ev=[0],tv=(0,v.n)(),iv=[3.141593,2.094395,2.094395,2.094395,.785398,.785398,.785398,.785398,.785398];class rv{constructor(){this._shOrder=2,this._ambientBoost=.4,this._oldSunlight={direction:(0,v.n)(),ambient:{color:(0,v.n)(),intensity:1},diffuse:{color:(0,v.n)(),intensity:1}},this.globalFactor=.5,this.groundLightingFactor=.5,this._sphericalHarmonics=new fs,this._mainLight={intensity:(0,v.n)(),direction:(0,v.i)(1,0,0),castShadows:!1}}get lightingMainDirection(){return this._mainLight.direction}setLightDirectionUniform(e){e.setUniform3fv("lightingMainDirection",this._mainLight.direction)}setUniforms(e,t=!1){const i=t?(1-this.groundLightingFactor)*(1-this.globalFactor):0;e.setUniform1f("lightingFixedFactor",i),e.setUniform1f("lightingGlobalFactor",this.globalFactor),this.setLightDirectionUniform(e),e.setUniform3fv("lightingMainIntensity",this._mainLight.intensity),e.setUniform1f("ambientBoostFactor",this._ambientBoost);const r=this._sphericalHarmonics;0===this._shOrder?e.setUniform3f("lightingAmbientSH0",r.r[0],r.g[0],r.b[0]):1===this._shOrder?(e.setUniform4f("lightingAmbientSH_R",r.r[0],r.r[1],r.r[2],r.r[3]),e.setUniform4f("lightingAmbientSH_G",r.g[0],r.g[1],r.g[2],r.g[3]),e.setUniform4f("lightingAmbientSH_B",r.b[0],r.b[1],r.b[2],r.b[3])):2===this._shOrder&&(e.setUniform3f("lightingAmbientSH0",r.r[0],r.g[0],r.b[0]),e.setUniform4f("lightingAmbientSH_R1",r.r[1],r.r[2],r.r[3],r.r[4]),e.setUniform4f("lightingAmbientSH_G1",r.g[1],r.g[2],r.g[3],r.g[4]),e.setUniform4f("lightingAmbientSH_B1",r.b[1],r.b[2],r.b[3],r.b[4]),e.setUniform4f("lightingAmbientSH_R2",r.r[5],r.r[6],r.r[7],r.r[8]),e.setUniform4f("lightingAmbientSH_G2",r.g[5],r.g[6],r.g[7],r.g[8]),e.setUniform4f("lightingAmbientSH_B2",r.b[5],r.b[6],r.b[7],r.b[8]))}set(e){Yg(e,this._shOrder,this._mainLight,this._sphericalHarmonics),(0,v.h)(this._oldSunlight.direction,this._mainLight.direction);const t=1/Math.PI;this._oldSunlight.ambient.color[0]=.282095*this._sphericalHarmonics.r[0]*t,this._oldSunlight.ambient.color[1]=.282095*this._sphericalHarmonics.g[0]*t,this._oldSunlight.ambient.color[2]=.282095*this._sphericalHarmonics.b[0]*t,(0,v.d)(this._oldSunlight.diffuse.color,this._mainLight.intensity,t),(0,v.h)(sv,this._oldSunlight.diffuse.color),(0,v.d)(sv,sv,this._ambientBoost*this.globalFactor),(0,v.u)(this._oldSunlight.ambient.color,this._oldSunlight.ambient.color,sv)}get old(){return this._oldSunlight}}const sv=(0,v.n)();class nv{constructor(e){this._rctx=e,this.cache=new Map}dispose(){this.cache.forEach((e=>e.texture=(0,u.z)(e.texture))),this.cache.clear()}acquire(e){if((0,u.t)(e))return null;const t=this.patternId(e),i=this.cache.get(t);if(i)return i.refCount++,i.bind;const r=this.patternToTextureData(e,2),s=r.length/2,n={refCount:1,texture:null,bind:e=>((0,u.t)(n.texture)&&(n.texture=new q.r(this._rctx,{width:r.length,height:1,internalFormat:6406,pixelFormat:6406,dataType:5121,wrapMode:33071},r)),e.bindTexture(n.texture,"stipplePatternTexture"),s)};return this.cache.set(t,n),n.bind}release(e){if((0,u.t)(e))return;const t=this.patternId(e),i=this.cache.get(t);i&&(i.refCount--,0===i.refCount&&((0,u.r)(i.texture)&&i.texture.dispose(),this.cache.delete(t)))}swap(e,t){const i=this.acquire(t);return this.release(e),i}patternId(e){return e.join(",")}patternToTextureData(e,t){const i=e.reduce(((e,t)=>e+t))*t,r=new Uint8Array(i);let s=!0,n=0;for(const i of e){for(let e=0;e<i*t;e++)r[n++]=s?255:0;s=!s}return r}}const av=u.n.getLogger("esri.views.3d.webgl-engine.lib.OverlayRenderer");let ov=class extends((0,S.aP)(r.p)){constructor(e){super(e),this._overlays=null,this._overlayRenderTarget=null,this._hasHighlights=!1,this._rendersOccluded=!1,this._hasWater=!1,this._lighting=new rv,this._handles=new R.u,this._layerRenderers=new Map,this._sortedLayerRenderersDirty=!1,this._sortedLayerRenderers=new r.f,this._geometries=new Map,this.globalUnitScale=1,this.longitudeCyclical=null}initialize(){const e=this.view._stage.renderView;this._rctx=e.renderingContext,this._renderContext=new $f(this._rctx);const t=e.waterTextureRepository;this._stippleTextureRepository=new nv(e.renderingContext),this._shaderTechniqueRepository=new Pm({rctx:this._rctx,viewingMode:2,stippleTextureRepository:this._stippleTextureRepository,waterTextureRepository:t}),this._handles.add([(0,p.d)(t,"loadingState",(()=>this.emitContentChanged())),(0,p.d)(this,"spatialReference",(e=>this._localOrigins=new Zf(e)))]),this._materialRepository=new Dm(e.textureRepository,this._shaderTechniqueRepository),this._materialRepository.onMaterialChanged=e=>{(e.renderOccluded&pv)>0!==this._rendersOccluded&&this.updateRendersOccluded(),this.emitContentChanged(),this.notifyChange("updating")},this._lighting.groundLightingFactor=1,this._lighting.globalFactor=0,this._lighting.set([new us((0,v.i)(1,1,1))]),this._bindParameters={slot:null,highlightDepthTexture:(0,S.aQ)(this._rctx),camera:hv,inverseViewport:(0,N.n)(),origin:null,screenToWorldRatio:null,screenToWorldRatioGlobalWM:null,shadowMappingEnabled:!1,slicePlane:null,ssaoEnabled:!1,hasOccludees:!1,linearDepthTexture:null,lastFrameColorTexture:null,reprojectionMat:null,ssrEnabled:!1,lighting:this._lighting,transparencyPassType:3,terrainLinearDepthTexture:null,geometryLinearDepthTexture:null,multipassTerrainEnabled:!1,cullAboveGround:!1,multipassGeometryEnabled:!1,highlightColorTexture:null},this._handles.add(this.view.resourceController.scheduler.registerTask(Jd.STAGE,this))}dispose(){this._handles.destroy(),this._layerRenderers.forEach((e=>e.dispose())),this._layerRenderers.clear(),this._debugTextureTechnique=(0,u.h)(this._debugTextureTechnique),this._debugPatternTexture=(0,u.z)(this._debugPatternTexture),this._bindParameters.highlightDepthTexture=(0,u.z)(this._bindParameters.highlightDepthTexture),this._shaderTechniqueRepository=(0,u.z)(this._shaderTechniqueRepository),this._temporaryFBO=(0,u.z)(this._temporaryFBO),this._quadVAO=(0,u.z)(this._quadVAO),this._overlayRenderTarget=(0,u.z)(this._overlayRenderTarget)}get updating(){return this._sortedLayerRenderersDirty||(0,s.g)(this._layerRenderers,(e=>e.updating))}get hasOverlays(){return(0,u.r)(this._overlays)&&(0,u.r)(this._overlayRenderTarget)}get gpuMemoryUsage(){return(0,u.r)(this._overlayRenderTarget)?this._overlayRenderTarget.gpuMemoryUsage:0}collectUnusedRenderTargetMemory(e){let t=!1;if((0,u.r)(this._overlayRenderTarget))for(const i of this._overlayRenderTarget.renderTargets){const r=this.overlays[0].validTargets[i.type]||!this.overlays[1].validTargets[i.type];t=this._overlayRenderTarget.validateUsageForTarget(r,i,e)||t}return t}get overlays(){return(0,u.q)(this._overlays,[])}ensureDrapeTargets(e){(0,u.r)(this._overlays)&&this._overlays.forEach((t=>{t.hasTargetWithoutRasterImage=(0,r.G)(e,(e=>1===e.drapeTargetType))}))}ensureDrapeSources(e){(0,u.r)(this._overlays)&&this._overlays.forEach((t=>{t.hasDrapedFeatureSource=(0,s.g)(e,((e,t)=>1===t.drapeSourceType)),t.hasDrapedRasterSource=(0,s.g)(e,((e,t)=>0===t.drapeSourceType))}))}ensureOverlays(e,t){(0,u.t)(this._overlays)&&(this._overlayRenderTarget=new Cm(this._rctx),this._overlays=[new bm(0,this._overlayRenderTarget),new bm(1,this._overlayRenderTarget)]),this.ensureDrapeTargets(e),this.ensureDrapeSources(t)}disposeOverlays(){(0,u.r)(this._overlayRenderTarget)&&this._overlayRenderTarget.disposeRenderTargetMemory()}get running(){return this.updating}runTask(e,t=(()=>!0)){let i=!1;for(const[r,s]of this._layerRenderers){if(e.done)break;t(r)&&(s.commitChanges()&&(i=!0,e.madeProgress()),s.isEmpty&&(this._sortedLayerRenderersDirty=!0,this._layerRenderers.delete(r),this._handles.remove(r)))}this._sortedLayerRenderersDirty&&(this.updateSortedLayerRenderers(),i=!0),i&&((0,u.r)(this._overlays)&&0===this._layerRenderers.size&&this.disposeOverlays(),this.notifyChange("updating"),this.emitContentChanged(),this.updateHasHighlights(),this.updateRendersOccluded(),this.updateHasWater())}processSyncLayers(){this.runTask(cu,(e=>1===e.updatePolicy))}addGeometries(e,t,i){for(const t of e)(0,u.t)(t.origin)&&(t.origin=this._localOrigins.getOrigin(t.boundingSphere)),this._geometries.set(t.id,t);this.ensureLayerRenderer(t).add(e),2===i&&this.notifyGraphicGeometryChanged(e,t)}removeGeometries(e,t,i){for(const t of e)this._geometries.delete((0,u.f)(t.id));const r=this._layerRenderers.get(t);r&&(r.remove(e),2===i&&this.notifyGraphicGeometryChanged(e,t))}updateGeometries(e,t,i){const r=this._layerRenderers.get(t);if(r)switch(r.modify(e,i),i){case 4:case 2:return this.notifyGraphicGeometryChanged(e,t);case 1:return this.notifyGraphicVisibilityChanged(e,t)}else av.warn("Attempted to update geometry for nonexistent layer")}notifyGraphicGeometryChanged(e,t){if((0,u.t)(t.notifyGraphicGeometryChanged))return;let i;for(const r of e){const e=r.graphicUid;(0,u.r)(e)&&e!==i&&(t.notifyGraphicGeometryChanged(e),i=e)}}notifyGraphicVisibilityChanged(e,t){if((0,u.t)(t.notifyGraphicVisibilityChanged))return;let i;for(const r of e){const e=r.graphicUid;(0,u.r)(e)&&e!==i&&(t.notifyGraphicVisibilityChanged(e),i=e)}}updateHighlights(e,t){const i=this._layerRenderers.get(t);i?i.modify(e,8):av.warn("Attempted to update highlights for nonexistent layer")}isEmpty(){return 0===this._geometries.size&&!Ih.OVERLAY_DRAW_DEBUG_TEXTURE}get hasHighlights(){return this._hasHighlights}get hasWater(){return this._hasWater}get rendersOccluded(){return this._rendersOccluded}updateLogic(e){let t=!1;return this._layerRenderers.forEach((i=>{i.updateLogic(e)&&(t=!0)})),t}updateLayerOrder(){this._sortedLayerRenderersDirty=!0}drawTarget(e,t,i){const r=e.canvasGeometries;if(0===r.numViews)return!1;const s=e.pixelRatio*i;this._screenToWorldRatio=s*Math.abs(r.extents[0][2]-r.extents[0][0])/Math.abs(e.viewport[2]-e.viewport[0]);const n=t.renderPass;if(this.isEmpty()||5===n&&!this.hasHighlights||3===n&&!this.hasWater)return!1;if(!e.hasSomeSizedView())return!1;const a=t.fbo,o=2*e.resolution,l=e.resolution,c=1===t.type?2:4===t.type?1:0;if(!a.isValid())return!1;a.resize(o,l);const h=this._rctx;if(hv.pixelRatio=s||1,this._renderContext.pass=n,this._bindParameters.screenToWorldRatio=this._screenToWorldRatio,this._bindParameters.screenToWorldRatioGlobalWM=this._screenToWorldRatio*this.globalUnitScale,e.applyViewport(this._rctx),a.bind(h),0===e.index&&(h.setClearColor(0,0,0,0),h.clearSafe(16384)),1===c&&(this._renderContext.renderOccludedMask=pv),Ih.OVERLAY_DRAW_DEBUG_TEXTURE&&1!==c)for(let t=0;t<r.numViews;t++)this.setViewParameters(r.extents[t],e,hv),this.drawDebugTexture(e.resolution,cv[e.index%cv.length]);return this._layerRenderers.size>0&&this._sortedLayerRenderers.forAll((({layerView:t,renderer:i})=>{if(2===c&&(0,u.r)(t)&&0===t.drapeSourceType)return;const s=(0,u.r)(t)&&(0,u.r)(t.fullOpacity)&&t.fullOpacity<1&&0===n;s&&(this.bindTemporaryFramebuffer(this._rctx,o,l),h.clearSafe(16384));for(let t=0;t<r.numViews;t++)this.setViewParameters(r.extents[t],e,hv),i.render(this._renderContext,this._bindParameters);s&&(0,u.r)(this._temporaryFBO)&&(a.bind(h),this.view._stage.renderView.compositingHelper.composite(this._temporaryFBO.getTexture(),2,(0,u.f)((0,u.f)(t).fullOpacity),3,e.index))})),h.bindFramebuffer(null),a.generateMipMap(),this._renderContext.resetRenderOccludedMask(),!0}bindTemporaryFramebuffer(e,t,i){(0,u.t)(this._temporaryFBO)&&(this._temporaryFBO=new wm(e,!1)),this._temporaryFBO.resize(t,i),this._temporaryFBO.bind(e)}async reloadShaders(){await this._shaderTechniqueRepository.hotReload()}intersect(e,t,i){let r=0;this._geometries.forEach((s=>{if(i&&!i(s))return;this.intersectRenderGeometry(s,t,0,e,r);const n=this.longitudeCyclical;n&&(s.boundingSphere[0]-s.boundingSphere[3]<n.min&&this.intersectRenderGeometry(s,t,n.range,e,r),s.boundingSphere[0]+s.boundingSphere[3]>n.max&&this.intersectRenderGeometry(s,t,-n.range,e,r)),r++}))}intersectRenderGeometry(e,t,i,r,s){if(!e.instanceParameters.visible)return;let n=0;(0,u.r)(e.transformation)&&(i+=e.transformation[12],n=e.transformation[13]),dv[0]=t[0]-i,dv[1]=t[1]-n,dv[2]=1,uv[0]=t[0]-i,uv[1]=t[1]-n,uv[2]=0,e.screenToWorldRatio=this._screenToWorldRatio,e.material.intersect(e,null,e.getShaderTransformation(),r,dv,uv,((t,i,n)=>{this.addIntersectionResult(n,e.material.renderPriority,s,r,e.layerUid,e.graphicUid)}),e.calculateShaderTransformation,!0)}addIntersectionResult(e,t,i,r,s,n){const a={type:"external",metadata:{layerUid:s,graphicUid:n}},o=s=>{s.set(a,null,r.results.ground.dist,r.results.ground.normal,r.results.ground.transformation,t,null,null,e,i),s.intersector="OverlayRenderer"};if((null==r.results.min.drapedLayerOrder||t>=r.results.min.drapedLayerOrder)&&(null==r.results.min.dist||r.results.ground.dist<=r.results.min.dist)&&o(r.results.min),0!==r.options.store&&(null==r.results.max.drapedLayerOrder||t<r.results.max.drapedLayerOrder)&&(null==r.results.max.dist||r.results.ground.dist>r.results.max.dist)&&o(r.results.max),2===r.options.store){const e=new Ks(r.ray);o(e),r.results.all.push(e)}}stopAnimationsAtTime(e){this._sortedLayerRenderers.forAll((t=>t.renderer.stopAnimationsAtTime(e)))}ensureLayerRenderer(e){let t=this._layerRenderers.get(e);return t||(t=new Vg({rctx:this._rctx,materialRepository:this._materialRepository}),this._layerRenderers.set(e,t),this._sortedLayerRenderersDirty=!0,"fullOpacity"in e&&this._handles.add(e.watch("fullOpacity",(()=>this.emitContentChanged())),e),this._handles.add((0,p.d)(t,"updating",(()=>this.notifyChange("updating"))),e)),t}updateSortedLayerRenderers(){if(!this._sortedLayerRenderersDirty)return;if(this._sortedLayerRenderersDirty=!1,this._sortedLayerRenderers.clear(),0===this._layerRenderers.size)return;const e=new Set(this._layerRenderers.values());this.view.allLayerViews.forEach((t=>{const i=t,r=this._layerRenderers.get(i);r&&(this._sortedLayerRenderers.push(new lv(i,r)),e.delete(r))})),e.forEach((e=>this._sortedLayerRenderers.push(new lv(null,e))))}setViewParameters(e,t,i){i.viewport=t.viewport,(0,C.E)(i.projectionMatrix,0,e[2]-e[0],0,e[3]-e[1],i.near,i.far),(0,C.r)(i.viewMatrix),(0,C.c)(i.viewMatrix,i.viewMatrix,[-e[0],-e[1],0]),this._renderContext.camera=i,this._bindParameters.camera=i,this._bindParameters.inverseViewport[0]=1/i.fullViewport[2],this._bindParameters.inverseViewport[1]=1/i.fullViewport[3]}emitContentChanged(){this.onContentChanged&&this.onContentChanged()}updateHasWater(){const e=(0,s.g)(this._layerRenderers,(e=>e.hasWater));e!==this._hasWater&&(this._hasWater=e,this.onHasWaterChanged&&this.onHasWaterChanged(e))}updateHasHighlights(){const e=(0,s.g)(this._layerRenderers,(e=>e.hasHighlights));e!==this._hasHighlights&&(this._hasHighlights=e,this.onHasHighlightsChanged&&this.onHasHighlightsChanged(this._hasHighlights))}updateRendersOccluded(){const e=(0,s.g)(this._layerRenderers,(e=>e.rendersOccluded));e!==this._rendersOccluded&&(this._rendersOccluded=e,this.onRendersOccludedChanged&&this.onRendersOccludedChanged(this.rendersOccluded))}drawDebugTexture(e,t){const i=this._rctx;this.ensureDebugPatternResources(e,e);const r=this._debugTextureTechnique.program;i.useProgram(r),i.setPipelineState(this._debugTextureTechnique.pipeline),r.setUniform4f("color",t[0],t[1],t[2],1),r.bindTexture(this._debugPatternTexture,"tex"),i.bindVAO(this._quadVAO),i.drawArrays(5,0,(0,V.a)(this._quadVAO,"geometry"))}ensureDebugPatternResources(e,t){if(this._debugPatternTexture)return;const i=new Uint8Array(e*t*4);let r=0;for(let s=0;s<t;s++)for(let n=0;n<e;n++){const a=Math.floor(n/10),o=Math.floor(s/10);a<2||o<2||10*a>e-20||10*o>t-20?(i[r++]=255,i[r++]=255,i[r++]=255,i[r++]=255):(i[r++]=255,i[r++]=255,i[r++]=255,i[r++]=1&a&&1&o?1&n^1&s?0:255:1&a^1&o?0:128)}this._debugPatternTexture=new q.r(this._rctx,{target:3553,pixelFormat:6408,dataType:5121,samplingMode:9728,width:e,height:t},i);const s=new Ng;s.hasAlpha=!0,this._debugTextureTechnique=this._shaderTechniqueRepository.acquire(kg,s),this._quadVAO=(0,S.l)(this._rctx)}get test(){return{layerRenderers:this._layerRenderers}}};(0,r.e)([(0,S.aO)()],ov.prototype,"_shaderTechniqueRepository",void 0),(0,r.e)([(0,S.aO)()],ov.prototype,"_stippleTextureRepository",void 0),(0,r.e)([(0,d.y)({constructOnly:!0})],ov.prototype,"view",void 0),(0,r.e)([(0,d.y)()],ov.prototype,"globalUnitScale",void 0),(0,r.e)([(0,d.y)()],ov.prototype,"spatialReference",void 0),(0,r.e)([(0,d.y)({type:Boolean,readOnly:!0})],ov.prototype,"updating",null),ov=(0,r.e)([(0,d.n)("esri.views.3d.terrain.OverlayRenderer")],ov);class lv{constructor(e,t){this.layerView=e,this.renderer=t}}const cv=[[1,.5,.5],[.5,.5,1],[.5,1,.5]],hv=new Ia;hv.near=1,hv.far=1e4,hv.relativeElevation=null;const dv=(0,v.n)(),uv=(0,v.n)(),pv=4;function mv(e){const t=[["position",e.indices]],i=[["position",{size:3,data:e.attributeData.position,exclusive:!0}]];return(0,u.r)(e.attributeData.color)&&(i.push(["color",{size:4,data:e.attributeData.color,exclusive:!0}]),t.push(["color",new Uint32Array(e.indices.length)])),(0,u.r)(e.attributeData.uvMapSpace)&&(i.push(["uvMapSpace",{size:4,data:e.attributeData.uvMapSpace,exclusive:!0}]),t.push(["uvMapSpace",e.indices])),(0,u.r)(e.attributeData.boundingRect)&&(i.push(["boundingRect",{size:9,data:e.attributeData.boundingRect,exclusive:!0}]),t.push(["boundingRect",e.indices])),(0,u.r)(e.attributeData.mapPosition)&&(i.push(["mapPos",{size:3,data:e.attributeData.mapPosition,exclusive:!0}]),t.push(["mapPos",e.indices])),new S.u(i,t)}function fv(e){const t=[["position",e.indices],["uv0",e.indices]],i=[["position",{size:3,data:e.attributeData.position,exclusive:!0}],["uv0",{size:2,data:e.attributeData.uv0,exclusive:!0}]];return(0,u.r)(e.attributeData.mapPosition)&&(i.push(["mapPos",{size:3,data:e.attributeData.mapPosition,exclusive:!0}]),t.push(["mapPos",e.indices])),new S.u(i,t)}function gv(e){switch(e.type){case"extent":if(e instanceof A.M)return A.j.fromExtent(e);break;case"polygon":return e}return null}function vv(e,t,i,r){const s=(0,pe.l)(e.rings,e.hasZ,1),n=new Float64Array(s.position.length),a=zu(s.position,e.spatialReference,0,n,0,s.position,0,s.position.length/3,t,i,r),o=null!=a;return{position:s.position,mapPosition:n,polygons:xv(s.polygons,s.position,n),outlines:_v(s.outlines,s.position,n),projectionSuccess:o,sampledElevation:a}}function yv(e,t){const i=(0,pe.l)(e.rings,!1,1),r=(0,_.x)(i.position,e.spatialReference,0,i.position,t,0,i.position.length/3);for(let e=2;e<i.position.length;e+=3)i.position[e]=-2;return{position:i.position,polygons:xv(i.polygons,i.position),outlines:_v(i.outlines,i.position),projectionSuccess:r}}function _v(e,t,i){const r=new Array;for(const{index:s,count:n}of e){if(n<=1)continue;const e=3*s,a=e+3*n;r.push({index:s,count:n,position:t.subarray(e,a),mapPosition:i?i.subarray(e,a):void 0})}return r}function xv(e,t,i){const r=new Array;for(const{index:s,count:n,holeIndices:a,pathLengths:o}of e){if(n<=1)continue;const e=3*s,l=e+3*n,c=a.map((e=>e-s));r.push({index:s,count:n,holeIndices:c,pathLengths:o,position:t.subarray(e,l),mapPosition:i?i.subarray(e,l):void 0})}return r}const bv=["polygon","extent"];function wv(e,t,i,r,s,n,a,o,l,c,h,d,u,p){const m=i.length/3;let f=0,g=2*r.count;(function(e,t,i,r,s,n,a,o,l,c,h,d,u,p,m,f,g,y){(0,v.h)(Lv,g);const _=f>0?1:-1;let x=3*i,b=d,w=3*b,C=d+r,T=3*C;for(let i=0;i<r;++i)y&&(Lv[0]=e[x+0],Lv[1]=e[x+1],Lv[2]=e[x+2],(0,v.j)(Lv,Lv)),o[w+0]=e[x+0],o[w+1]=e[x+1],o[w+2]=e[x+2],l[w+0]=t[x+0],l[w+1]=t[x+1],l[w+2]=t[x+2],c[w+0]=-_*Lv[0],c[w+1]=-_*Lv[1],c[w+2]=-_*Lv[2],h[b]=0,o[T+0]=e[x+0]+f*Lv[0],o[T+1]=e[x+1]+f*Lv[1],o[T+2]=e[x+2]+f*Lv[2],l[T+0]=t[x+0],l[T+1]=t[x+1],l[T+2]=t[x+2],c[T+0]=_*Lv[0],c[T+1]=_*Lv[1],c[T+2]=_*Lv[2],h[C]=f,w+=3,T+=3,x+=3,b+=1,C+=1;x=0,w=0,T=3*m;const S=f<0?Vv:Fv,P=f<0?Fv:Vv;for(let e=0;e<a;++e)p[w+0]=s[x+S[0]],p[w+1]=s[x+S[1]],p[w+2]=s[x+S[2]],u[T+0]=s[x+P[0]]+r,u[T+1]=s[x+P[1]]+r,u[T+2]=s[x+P[2]]+r,w+=3,T+=3,x+=3})(e,t,r.index,r.count,i,0,m,s,n,a,o,l,c,h,g,d,u,p),l+=2*r.count,g=0,Sv(s,n,o,a,f,r.pathLengths[0],r.count,l,c,g,d),l+=4*r.pathLengths[0],g+=2*r.pathLengths[0],f+=r.pathLengths[0];for(let e=1;e<r.pathLengths.length;++e)Sv(s,n,o,a,f,r.pathLengths[e],r.count,l,c,g,d),l+=4*r.pathLengths[e],g+=2*r.pathLengths[e],f+=r.pathLengths[e]}function Cv(e,t,i,r,s,n,a){r[n]=r[a],a*=3,e[0+(n*=3)]=e[a+0],e[n+1]=e[a+1],e[n+2]=e[a+2],t[n+0]=t[a+0],t[n+1]=t[a+1],t[n+2]=t[a+2],i[n+0]=s[0],i[n+1]=s[1],i[n+2]=s[2]}const Tv=(0,v.n)();function Sv(e,t,i,r,s,n,a,o,l,c,h){let d=s,u=s+1,p=s+a,m=s+a+1,f=o,g=o+1,v=o+2*n,y=o+2*n+1;h<0&&(d=s+a+1,m=s),c*=3;for(let o=0;o<n;++o)o===n-1&&(h>0?(u=s,m=s+a):(u=s,d=s+a)),Dv(e,d,u,p,Tv),Cv(e,t,r,i,Tv,f,d),Cv(e,t,r,i,Tv,g,u),Cv(e,t,r,i,Tv,v,p),Cv(e,t,r,i,Tv,y,m),l[c++]=f,l[c++]=v,l[c++]=y,l[c++]=f,l[c++]=y,l[c++]=g,d++,u++,p++,m++,f+=2,g+=2,v+=2,y+=2}const Pv=(0,v.n)(),Rv=(0,v.n)(),Av=(0,v.n)(),Mv=(0,v.n)(),Ov=(0,v.n)();function Dv(e,t,i,r,s){t*=3,i*=3,r*=3,(0,v.a)(Pv,e[t++],e[t++],e[t++]),(0,v.a)(Rv,e[i++],e[i++],e[i++]),(0,v.a)(Av,e[r++],e[r++],e[r++]),(0,v.c)(Mv,Rv,Pv),(0,v.c)(Ov,Av,Pv),(0,v._)(s,Ov,Mv),(0,v.j)(s,s)}const Ev=(0,v.n)();function zv(e,t,i,r){const s=e.stageObject,n=s.geometryRecords,a=n.length,o="absolute-height"!==t.mode;let l=0;const c=s.transformation,h=(0,C.h)((0,T.e)(),c);for(let e=0;e<a;e+=2){const a=n[e].geometry,d=a.getMutableAttribute("position").data,u=a.vertexAttributes.get("size").data,p=a.vertexAttributes.get("mapPos").data,m=new Nt(p),f=d.length/3;let g=0,y=!1,_=0;const x=i.spatialReference;for(let e=0;e<f;e++){Ev[0]=d[g],Ev[1]=d[g+1],Ev[2]=d[g+2];const e=Iu(m,i,t,r,o?Gv:null);o&&(_+=Gv.sampledElevation),Ih.DISABLE_ELEVATION_ALIGNERS_ITERATIVE_UPDATES?((0,v.a)(Iv,m.array[m.offset+0],m.array[m.offset+1],e+u[g/3]),r.toRenderCoords(Iv,x,Iv),(0,v.I)(Iv,Iv,h)):((0,v.a)(Iv,d[g+0],d[g+1],d[g+2]),(0,v.I)(Iv,Iv,c),r.setAltitude(Iv,e+u[g/3]),(0,v.I)(Iv,Iv,h)),d[g]=Iv[0],d[g+1]=Iv[1],d[g+2]=Iv[2];const s=Uv/r.unitInMeters;(Math.abs(Ev[0]-d[g])>=s||Math.abs(Ev[1]-d[g+1])>=s||Math.abs(Ev[2]-d[g+2])>=s)&&(y=!0),m.offset+=3,g+=3}y&&(a.invalidateBoundingInfo(),s.geometryVertexAttrsUpdated(e),n[e+1].geometry.invalidateBoundingInfo(),s.geometryVertexAttrsUpdated(e+1)),l+=_/f}return l/a}const Iv=(0,v.n)(),Lv=(0,v.n)(),Fv=[0,2,1],Vv=[0,1,2],Uv=.01,Gv={verticalDistanceToGround:0,sampledElevation:0},Bv=1.2,qv=w._,kv=w.d;class Nv{constructor(e,t,i){this.graphics3DSymbolLayer=e,this.renderGeometries=t,this.boundingBox=i,this.type="draped",this.stage=null,this._visible=!1,this._addedToStage=!1,this._layerView=null,this.isElevationSource=!1}initialize(e,t,i){this.stage=e,this._layerView=i,this._overlayRenderer=this._layerView.view.basemapTerrain.overlayManager.renderer}setVisibility(e){if(null!=this.stage&&this._visible!==e){if(this._visible=e,e&&!this._addedToStage)return this._addedToStage=!0,void this._overlayRenderer.addGeometries(this.renderGeometries,this._layerView,1);if(e||this._addedToStage){for(const e of this.renderGeometries)e.instanceParameters.visible=this._visible;this._overlayRenderer.updateGeometries(this.renderGeometries,this._layerView,1)}}}destroy(){this.stage&&this._addedToStage&&this._overlayRenderer.removeGeometries(this.renderGeometries,this._layerView,4),this._addedToStage=!1,this._visible=!1,this.stage=null}getCenterObjectSpace(e=(0,v.n)()){return(0,v.a)(e,0,0,0)}getBoundingBoxObjectSpace(e=(0,se.a)()){return(0,se.B)(e)}addObjectState(e,t){0===e&&(this.renderGeometries.forEach((e=>{const i=e.addHighlight();t.addRenderGeometry(e,i,this)})),this._addedToStage&&this._overlayRenderer.updateHighlights(this.renderGeometries,this._layerView))}removeObjectState(e){this.renderGeometries.forEach((t=>{e.removeRenderGeometry(t)}))}removeRenderGeometryObjectState(e,t){e.removeHighlight(t),this._addedToStage&&this._overlayRenderer.updateHighlights(this.renderGeometries,this._layerView)}computeAttachmentOrigin(e){for(const t of this.renderGeometries)t.computeAttachmentOrigin(Wv)&&(e.draped.origin[0]+=Wv[0],e.draped.origin[1]+=Wv[1],e.draped.num++)}async getProjectedBoundingBox(e,t,i,r,s){(0,se.B)(s);for(let t=0;t<this.renderGeometries.length;t++){const r=this.renderGeometries[t];this._getRenderGeometryProjectedBoundingRect(r,e,jv,i),(0,se.c)(s,jv)}if(t){let e;(0,se.p)(s,Wv);const i=Du(s,t);try{e=await t.service.queryElevation(Wv[0],Wv[1],r,i,"ground")}catch(e){}(0,u.r)(e)&&(s[2]=Math.min(s[2],e),s[5]=Math.max(s[5],e))}return s}_getRenderGeometryProjectedBoundingRect(e,t,i,r){if(this.boundingBox)(0,se.A)(Hv,this.boundingBox);else{const t=e.boundingSphere,i=t[3];Hv[0]=t[0]-i,Hv[1]=t[1]-i,Hv[2]=t[2]-i,Hv[3]=t[0]+i,Hv[4]=t[1]+i,Hv[5]=t[2]+i}return t(Hv,0,2),this.calculateRelativeScreenBounds&&r.push({location:(0,se.p)(Hv),screenSpaceBoundingRect:this.calculateRelativeScreenBounds()}),(0,se.G)(Hv,i)}}const jv=(0,b.i)(),Hv=(0,se.a)(),Wv=(0,v.n)();function Qv(e,t,i){i&&(t/=Math.SQRT2);const r=new Uint8Array(4*e*e);for(let s=0;s<e;s++)for(let n=0;n<e;n++){let a=n-.5*e+.25,o=.5*e-s-.75;const l=s*e+n;if(i){const e=(a+o)/Math.SQRT2;o=(o-a)/Math.SQRT2,a=e}let c=Math.max(Math.abs(a),Math.abs(o))-.5*t;c=c/e+.5,(0,S.aS)(c,r,4*l)}return r}function Zv(e,t,i){i&&(t*=Math.SQRT2);const r=.5*t,s=new Uint8Array(4*e*e);for(let t=0;t<e;t++)for(let n=0;n<e;n++){let a=n-.5*e,o=.5*e-t-1;const l=t*e+n;if(i){const e=(a+o)/Math.SQRT2;o=(o-a)/Math.SQRT2,a=e}let c;a=Math.abs(a),o=Math.abs(o),c=a>o?a>r?Math.sqrt((a-r)*(a-r)+o*o):o:o>r?Math.sqrt(a*a+(o-r)*(o-r)):a,c=c/e+.5,(0,S.aS)(c,s,4*l)}return s}function Yv(e){return null!=e}function Xv(e){return"number"==typeof e}function $v(e){return"string"==typeof e}function Kv(e,t){e&&e.push(t)}function Jv(e,t,i,r,s){const n=e.minSize,a=e.maxSize;if(e.expression)return Kv(s,"Could not convert size info: expression not supported"),!1;if(e.useSymbolValue){const e=r.symbolSize[i];return t.minSize[i]=e,t.maxSize[i]=e,t.offset[i]=t.minSize[i],t.factor[i]=0,t.type[i]=1,!0}if(Yv(e.field))return Yv(e.stops)?2===e.stops.length&&Xv(e.stops[0].size)&&Xv(e.stops[1].size)?(ey(e.stops[0].size,e.stops[1].size,e.stops[0].value,e.stops[1].value,t,i),t.type[i]=1,!0):(Kv(s,"Could not convert size info: stops only supported with 2 elements"),!1):Xv(n)&&Xv(a)&&Yv(e.minDataValue)&&Yv(e.maxDataValue)?(ey(n,a,e.minDataValue,e.maxDataValue,t,i),t.type[i]=1,!0):null!=ge.m[e.valueUnit]?(t.minSize[i]=-1/0,t.maxSize[i]=1/0,t.offset[i]=0,t.factor[i]=1/ge.m[e.valueUnit],t.type[i]=1,!0):"unknown"===e.valueUnit?(Kv(s,"Could not convert size info: proportional size not supported"),!1):(Kv(s,"Could not convert size info: scale-dependent size not supported"),!1);if(!Yv(e.field)){if(e.stops&&e.stops[0]&&Xv(e.stops[0].size))return t.minSize[i]=e.stops[0].size,t.maxSize[i]=e.stops[0].size,t.offset[i]=t.minSize[i],t.factor[i]=0,t.type[i]=1,!0;if(Xv(n))return t.minSize[i]=n,t.maxSize[i]=n,t.offset[i]=n,t.factor[i]=0,t.type[i]=1,!0}return Kv(s,"Could not convert size info: unsupported variant of sizeInfo"),!1}function ey(e,t,i,r,s,n){const a=Math.abs(r-i)>0?(t-e)/(r-i):0;s.minSize[n]=a>0?e:t,s.maxSize[n]=a>0?t:e,s.offset[n]=e-i*a,s.factor[n]=a}function ty(e,t,i){e[4*t+0]=i.r/255,e[4*t+1]=i.g/255,e[4*t+2]=i.b/255,e[4*t+3]=i.a}function iy(e,t,i){const r=2===i&&"arithmetic"===e.rotationType;t.offset[i]=r?90:0,t.factor[i]=r?-1:1,t.type[i]=1}function ry(e,t,i){if(!e)return null;const r=!t.supportedTypes||!!t.supportedTypes.size,s=!t.supportedTypes||!!t.supportedTypes.color,n=!t.supportedTypes||!!t.supportedTypes.rotation,a=!!t.supportedTypes&&!!t.supportedTypes.opacity,o=e.reduce(((e,o)=>{if(!e)return e;if(o.valueExpression)return Kv(i,"Could not convert visual variables: arcade expressions not supported"),null;switch(o.type){case"size":return r?function(e,t,i,r){if(e.normalizationField||e.valueRepresentation)return Kv(r,"Could not convert size info: unsupported property"),null;if(!function(e){return null==e||$v(e)}(e.field))return Kv(r,"Could not convert size info: field is not a string"),null;if(t.size){if(e.field)if(t.size.field){if(e.field!==t.size.field)return Kv(r,"Could not convert size info: multiple fields in use"),null}else t.size.field=e.field}else t.size={field:e.field,minSize:[0,0,0],maxSize:[0,0,0],offset:[0,0,0],factor:[0,0,0],type:[0,0,0]};let s;switch(e.axis){case"width":return s=Jv(e,t.size,0,i,r),s?t:null;case"height":return s=Jv(e,t.size,2,i,r),s?t:null;case"depth":return s=Jv(e,t.size,1,i,r),s?t:null;case"width-and-depth":return s=Jv(e,t.size,0,i,r),s&&Jv(e,t.size,1,i,r),s?t:null;case null:case void 0:case"all":return s=Jv(e,t.size,0,i,r),s=s&&Jv(e,t.size,1,i,r),s=s&&Jv(e,t.size,2,i,r),s?t:null;default:return Kv(r,`Could not convert size info: unknown axis "${e.axis}""`),null}}(o,e,t,i):e;case"color":return s?function(e,t,i){if(e.normalizationField)return Kv(i,"Could not convert color info: unsupported property"),null;if($v(e.field)){if(!e.stops)return Kv(i,"Could not convert color info: missing stops or colors"),null;{if(e.stops.length>8)return Kv(i,"Could not convert color info: too many color stops"),null;t.color={field:e.field,values:[0,0,0,0,0,0,0,0],colors:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]};const r=e.stops;for(let e=0;e<8;++e){const i=r[Math.min(e,r.length-1)];t.color.values[e]=i.value,ty(t.color.colors,e,i.color)}}}else{if(!(e.stops&&e.stops.length>=0))return Kv(i,"Could not convert color info: no field and no colors/stops"),null;{const i=e.stops&&e.stops.length>=0&&e.stops[0].color;t.color={field:null,values:[0,0,0,0,0,0,0,0],colors:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]};for(let e=0;e<8;e++)t.color.values[e]=1/0,ty(t.color.colors,e,i)}}return t}(o,e,i):e;case"opacity":return a?function(e,t,i){if(e.normalizationField)return Kv(i,"Could not convert opacity info: unsupported property"),null;if($v(e.field)){if(!e.stops)return Kv(i,"Could not convert opacity info: missing stops or opacities"),null;{if(e.stops.length>8)return Kv(i,"Could not convert opacity info: too many opacity stops"),null;t.opacity={field:e.field,values:[0,0,0,0,0,0,0,0],opacityValues:[0,0,0,0,0,0,0,0]};const r=e.stops;for(let e=0;e<8;++e){const i=r[Math.min(e,r.length-1)];t.opacity.values[e]=i.value,t.opacity.opacityValues[e]=i.opacity}}}else{if(!(e.stops&&e.stops.length>=0))return Kv(i,"Could not convert opacity info: no field and no opacities/stops"),null;{const i=e.stops&&e.stops.length>=0&&e.stops[0].opacity;t.opacity={field:null,values:[0,0,0,0,0,0,0,0],opacityValues:[0,0,0,0,0,0,0,0]};for(let e=0;e<8;e++)t.opacity.values[e]=1/0,t.opacity.opacityValues[e]=i}}return t}(o,e,i):null;case"rotation":return n?function(e,t,i){if(!$v(e.field))return Kv(i,"Could not convert rotation info: field is not a string"),null;if(t.rotation){if(e.field)if(t.rotation.field){if(e.field!==t.rotation.field)return Kv(i,"Could not convert rotation info: multiple fields in use"),null}else t.rotation.field=e.field}else t.rotation={field:e.field,offset:[0,0,0],factor:[1,1,1],type:[0,0,0]};switch(e.axis){case"tilt":return iy(e,t.rotation,0),t;case"roll":return iy(e,t.rotation,1),t;case null:case void 0:case"heading":return iy(e,t.rotation,2),t;default:return Kv(i,`Could not convert rotation info: unknown axis "${e.axis}""`),null}}(o,e,i):e;default:return null}}),{size:null,color:null,opacity:null,rotation:null});return!(e.length>0&&o)||o.size||o.color||o.opacity||o.rotation?o&&o.size&&!function(e,t,i){for(let i=0;i<3;++i){let r=t.unitInMeters;1===e.type[i]&&(r*=t.modelSize[i],e.type[i]=2),e.minSize[i]=e.minSize[i]/r,e.maxSize[i]=e.maxSize[i]/r,e.offset[i]=e.offset[i]/r,e.factor[i]=e.factor[i]/r}let r;if(0!==e.type[0])r=0;else if(0!==e.type[1])r=1;else{if(0===e.type[2])return Kv(i,"No size axis contains a valid size or scale"),!1;r=2}for(let t=0;t<3;++t)0===e.type[t]&&(e.minSize[t]=e.minSize[r],e.maxSize[t]=e.maxSize[r],e.offset[t]=e.offset[r],e.factor[t]=e.factor[r],e.type[t]=e.type[r]);return!0}(o.size,t,i)?null:o:null}function sy(e){return e&&null!=e.size}function ny(e,t){if(!e)return{enabled:!1};if(Ih.DISABLE_FAST_UPDATES)return{enabled:!1};const i=ry(e.visualVariables,t);return i?{enabled:!0,visualVariables:i,materialParameters:ly(i,t),requiresShaderTransformation:sy(i)}:{enabled:!1}}function ay(e,t,i){if(!t||!e.enabled)return!1;const r=e.visualVariables,s=ry(t.visualVariables,i);return!!s&&!!(oy(r.size,s.size,"size")&&oy(r.color,s.color,"color")&&oy(r.rotation,s.rotation,"rotation")&&oy(r.opacity,s.opacity,"opacity"))&&(e.visualVariables=s,e.materialParameters=ly(s,i),e.requiresShaderTransformation=sy(s),!0)}function oy(e,t,i){if(!!e!=!!t)return!1;if(e&&e.field!==t.field)return!1;if(e&&"rotation"===i){const i=e,r=t;for(let e=0;e<3;e++)if(i.type[e]!==r.type[e]||i.offset[e]!==r.offset[e]||i.factor[e]!==r.factor[e])return!1}return!0}function ly(e,t){const i={vvSizeEnabled:!1,vvSizeMinSize:null,vvSizeMaxSize:null,vvSizeOffset:null,vvSizeFactor:null,vvSizeValue:null,vvColorEnabled:!1,vvColorValues:null,vvColorColors:null,vvOpacityEnabled:!1,vvOpacityValues:null,vvOpacityOpacities:null,vvSymbolAnchor:null,vvSymbolRotationMatrix:null},r=sy(e);return e&&e.size?(i.vvSizeEnabled=!0,i.vvSizeMinSize=e.size.minSize,i.vvSizeMaxSize=e.size.maxSize,i.vvSizeOffset=e.size.offset,i.vvSizeFactor=e.size.factor):e&&r&&(i.vvSizeValue=t.transformation.scale),e&&r&&(i.vvSymbolAnchor=t.transformation.anchor,i.vvSymbolRotationMatrix=(0,X.e)(),(0,C.r)(hy),function(e,t,i,r=(0,T.e)()){const s=e||0,n=t||0,a=i||0;0!==s&&(0,C.m)(r,r,-s/180*Math.PI),0!==n&&(0,C.b)(r,r,n/180*Math.PI),0!==a&&(0,C.l)(r,r,a/180*Math.PI)}(t.transformation.rotation[2],t.transformation.rotation[0],t.transformation.rotation[1],hy),(0,Y.a)(i.vvSymbolRotationMatrix,hy)),e&&e.color&&(i.vvColorEnabled=!0,i.vvColorValues=e.color.values,i.vvColorColors=e.color.colors),e&&e.opacity&&(i.vvOpacityEnabled=!0,i.vvOpacityValues=e.opacity.values,i.vvOpacityOpacities=e.opacity.opacityValues),i}var cy;!function(e){const t=(0,T.e)(),i=(0,v.n)();e.evaluateModelTransform=function(e,r,s){if(!e.vvSizeEnabled)return s;(0,C.n)(t,s);const n=e.vvSymbolRotationMatrix;(0,C.s)(hy,n[0],n[1],n[2],0,n[3],n[4],n[5],0,n[6],n[7],n[8],0,0,0,0,1),(0,C.e)(t,t,hy);for(let t=0;t<3;++t){const s=e.vvSizeOffset[t]+r[0]*e.vvSizeFactor[t];i[t]=(0,v.o)(s,e.vvSizeMinSize[t],e.vvSizeMaxSize[t])}return(0,C.i)(t,t,i),(0,C.c)(t,t,e.vvSymbolAnchor),t},e.evaluateModelTransformScale=function(e,t,i){if(!t.vvSizeEnabled)return(0,v.a)(e,1,1,1);for(let r=0;r<3;++r){const s=t.vvSizeOffset[r]+i[0]*t.vvSizeFactor[r];e[r]=(0,v.o)(s,t.vvSizeMinSize[r],t.vvSizeMaxSize[r])}return e}}(cy||(cy={}));const hy=(0,T.e)(),dy=cy.evaluateModelTransform,uy=cy.evaluateModelTransformScale;class py{constructor(e,t,i=null,r=null,s=(0,Q.e)(),n=null,a=null,o=!1){this.data=e,this.material=t,this.layerUid=i,this.graphicUid=r,this.id=s,this.boundingInfo=n,this.calculateShaderTransformation=a,this.castShadow=o,this.boundingSphere=(0,w.n)(),this.instanceParameters={highlights:null,occludees:null,visible:!0},this._transformation=(0,T.e)(),this._shaderTransformationDirty=!0}get transformation(){return this._transformation}updateTransformation(e){e(this._transformation),this._shaderTransformationDirty=!0,this.computeBoundingSphere(this._transformation,this.boundingSphere)}shaderTransformationChanged(){this._shaderTransformationDirty=!0}computeBoundingSphere(e,t,i=(0,s.H)(e)){(0,u.t)(this.boundingInfo)||((0,v.I)(t,this.boundingInfo.getCenter(),e),t[3]=this.boundingInfo.getBSRadius()*i)}get hasShaderTransformation(){return(0,u.r)(this.calculateShaderTransformation)}get primitiveType(){return this.data.primitiveType}getShaderTransformation(){return(0,u.t)(this.calculateShaderTransformation)?(0,u.q)(this.transformation,T.a):(this._shaderTransformationDirty&&(this._shaderTransformation||(this._shaderTransformation=(0,T.e)()),(0,C.n)(this._shaderTransformation,this.calculateShaderTransformation((0,u.q)(this.transformation,T.a))),this._shaderTransformationDirty=!1),this._shaderTransformation)}computeAttachmentOrigin(e){if(this.material.computeAttachmentOrigin)return!!this.material.computeAttachmentOrigin(this,e)&&((0,u.r)(this._transformation)&&(0,v.I)(e,e,this._transformation),!0);const t=this.indices.get("position"),i=this.vertexAttributes.get("position");return!!(0,w.u)(i,t,e)&&((0,u.r)(this._transformation)&&(0,v.I)(e,e,this._transformation),!0)}get indices(){return this.data.indices}get vertexAttributes(){return this.data.vertexAttributes}addHighlight(){const e=new Ws(0),t=this.instanceParameters;return t.highlights=(0,S.p)(t.highlights,e),e}removeHighlight(e){const t=this.instanceParameters;t.highlights=(0,S.q)(t.highlights,e)}}const my=(0,T.e)(),fy=(0,v.i)(0,0,1),gy=[.25,.25,.75,.75];class vy extends Vp{constructor(e,t,i,r){super(e,t,i,r),this._cimLayers=null,this._cimSymbolMaterials=new Map,this._cimSymbolTextures=new Map,this._cimMaterialParametersInfo=null,this._cimRequiredFields=null,this._cimScaleFactorOrFunction=null,this._size=null,this._symbolTextureRatio=1,this._outlineSize=0,this._texture=null,this._releaseTexture=null,this._elevationOptions={supportsOffsetAdjustment:!0,supportsOnTheGround:!0}}getCachedSize(){return{size:this._getIconSize()}}async doLoad(e){this._validateOrThrow();const t=this._prepareMaterialParameters(),i=this._getPrimitive();if((0,u.r)(i))this._prepareResourcesPrimitive(t,i);else{const i=(0,me.d)(this.symbol,this.symbolLayer),r=(0,n.V)(i);r&&"application/json"===r.mediaType?await this._prepareResourcesCIM(t,JSON.parse(r.data),e):await this._prepareResourcesHref(t,i,e)}}_validateOrThrow(){if(this._drivenProperties.size)return;const e=Mu(this._getIconSize());if(e)throw new h.s("graphics3diconsymbollayer:invalid-size",e)}_getIconSize(){const e=this.symbolLayer,t=Math.round(null!=e.size?(0,f.u)(e.size):16);return this._drivenProperties.size?Math.max(t,64):t}_generateTextureCIM(e){const t=this._getGraphicHash(e);let i=""===t?null:this._cimSymbolTextures.get(t);if(!i){const r={scaleFactor:this._cimScaleFactorOrFunction},s=this._context.sharedResources.cimSymbolRasterizer.rasterizeCIMSymbol(this._cimLayers,e,"esriGeometryPoint",r,null,null);this._cimMaterialParametersInfo.anchorPos=this._getAnchorPos("relative",s.anchorPosition);const n={width:s.imageData.width,height:s.imageData.height,powerOfTwoResizeMode:2};i=new S.aT(s.imageData,n),this._cimSymbolTextures.set(t,i),this._context.stage.add(i)}return i}_computeSize(e,t){const i=e.width/e.height;return i>1?[t,Math.round(t/i)]:[Math.round(t*i),t]}_prepareMaterialParameters(){const e={anchorPos:this._getAnchorPos(this.symbolLayer.anchor,this.symbolLayer.anchorPosition)},t=this.symbol;if(function(e){return e&&"point-3d"===e.type&&e.hasVisibleVerticalOffset()}(t)){const{screenLength:i,minWorldLength:r,maxWorldLength:s}=t.verticalOffset;e.verticalOffset={screenLength:(0,f.u)(i),minWorldLength:r||0,maxWorldLength:null!=s?s:1/0}}return this._context.screenSizePerspectiveEnabled&&(e.screenSizePerspective=this._context.sharedResources.screenSizePerspectiveSettings),e.occlusionTest=!0,e.slicePlaneEnabled=this._context.slicePlaneEnabled,e}_prepareResourcesPrimitive(e,t){const i=this._getOutlineSize();if(yy(t)&&0===i)throw new Error("Nothing to render");this._outlineSize=i,e.color=this._getFillColor(),e.outlineColor=this._getOutlineColor(),e.outlineSize=this._outlineSize;const r=this._context.sharedResources.textures.fromData(t,(()=>function(e){let t;const i=128;switch(e){case"circle":t=function(e,t){const i=128,r=new Uint8Array(65536);for(let e=0;e<i;e++)for(let t=0;t<i;t++){const s=t+i*e,n=t-63.5,a=e-63.5;let o=Math.sqrt(n*n+a*a)-32;o=o/128+.5,(0,S.aS)(o,r,4*s)}return r}();break;case"square":t=Qv(128,64,!1);break;case"kite":t=Qv(128,64,!0);break;case"cross":t=Zv(128,64,!1);break;case"x":t=Zv(128,64,!0);break;case"triangle":t=function(e,t){const i=new Uint8Array(65536),r=Math.sqrt(1.25);for(let t=0;t<e;t++)for(let s=0;s<e;s++){const n=t*e+s,a=(s-32)/64,o=(t-32+.75)/64,l=-(1*a+-.5*o)/r,c=(1*(a-1)+-.5*-o)/r,h=-o,d=Math.max(l,c,h);(0,S.aS)(64*d/e+.5,i,4*n)}return i}(i)}return new S.aT(t,{mipmap:!1,wrap:{s:33071,t:33071},width:128,height:128,components:4,noUnpackFlip:!0})}(t)));this._texture=r.texture,this._releaseTexture=()=>this._context.sharedResources.textures.release(r.uid),e.textureIsSignedDistanceField=!0,e.distanceFieldBoundingBox=gy,e.textureId=this._texture.id;const s=this._getIconSize();this._size=[s,s],this._symbolTextureRatio=2,this._createMaterialAndAddToStage(e,this._context.stage)}async _prepareResourcesHref(e,t,i){if(!(0,u.c)("esri-canvas-svg-support")&&(0,n.w)(t))throw new h.s("graphics3diconsymbollayer:unsupported-image-format","IconSymbol3DLayer failed to load (SVG symbols are not supported in IE11)");this._outlineSize=this._getOutlineSize(),e.color=this._getFillColor(),e.outlineColor=this._getOutlineColor(),e.outlineSize=this._outlineSize,e.textureIsSignedDistanceField=!1;const r=this._getIconSize(),s=r*this._context.layerView.view.pixelRatio,a=await(0,ee.a)(this._context.sharedResources.textures.fromUrl(t,s,{signal:i}));if(!1===a.ok)throw(0,h.w)(a.error),new h.s("graphics3diconsymbollayer:request-failed",`Failed to load (Request for icon resource failed: ${t})`);const{uid:o,texture:l}=a.value;this._releaseTexture=()=>this._context.sharedResources.textures.release(o);const c=l.params;this._size=this._computeSize(c,r),e.textureId=l.id,this._createMaterialAndAddToStage(e,this._context.stage)}async _prepareResourcesCIM(e,t,r){const s=new L.d({data:t});if(!this._context.sharedResources.cimSymbolRasterizer){const e=(await Promise.all([i.e(9351),i.e(5879)]).then(i.bind(i,5879))).CIMSymbolRasterizer;(0,h.a)(r),this._context.sharedResources.cimSymbolRasterizer||(this._context.sharedResources.cimSymbolRasterizer=new e(this._context.renderCoordsHelper.spatialReference,!0))}const n=this._context.layer.fields?this._context.layer.fields.map((e=>e.toJSON())):null;let a,o;if(this._cimLayers=await this._context.sharedResources.cimSymbolRasterizer.analyzeCIMSymbol(s,n,this._context.renderer&&"dictionary"===this._context.renderer.type?this._context.renderer.fieldMap:null,"esriGeometryPoint",{signal:r}),this._context.renderer&&"dictionary"===this._context.renderer.type&&this._context.renderer.scaleExpression){const e=this._context.renderer;if(isNaN(e.scaleExpression)){const t=e.scaleExpression,i=await(0,ae.j)(t,this._context.layer.spatialReference,n);o=(e,t,r)=>{const s=(0,fe.s)(i,e,{$view:r},"esriGeometryPoint",t);return null!==s?s:1}}else a=Number(e.scaleExpression)}this._cimScaleFactorOrFunction=a||o||1;const l=this._context.renderer?await this._context.renderer.getRequiredFields(this._context.layer.fieldsIndex):[];(0,h.a)(r);const c=this._context.layer.fieldsIndex;this._cimRequiredFields=l.map((e=>c.get(e).name)),this._cimMaterialParametersInfo=e,this._cimMaterialParametersInfo.color=this._getFillColor(),this._cimMaterialParametersInfo.outlineColor=[0,0,0,0],this._cimMaterialParametersInfo.outlineSize=0,this._cimMaterialParametersInfo.textureIsSignedDistanceField=!1}_getPrimitive(){return this.symbolLayer.resource&&this.symbolLayer.resource.href?null:this.symbolLayer.resource&&this.symbolLayer.resource.primitive||L.t}_getOutlineSize(){let e=0;const t=this.symbolLayer;return(0,u.r)(t.outline)&&null!=t.outline.size?Math.max((0,f.u)(t.outline.size),0):(e=yy(this._getPrimitive())?1.5:0,Math.max(e,0))}_getOutlineColor(){const e=this._getLayerOpacity(),t=this.symbolLayer,i=(0,u.g)(t,"outline","color");if((0,u.r)(i)){const t=z.o.toUnitRGB(i),r=i.a*e;return[t[0],t[1],t[2],r]}return[0,0,0,0]}_getFillColor(){if(yy(this._getPrimitive()))return qv;const e=(0,u.t)(this._getPrimitive()),t=(0,u.g)(this.symbolLayer,"material","color");return this._getCombinedOpacityAndColor(t,{hasIntrinsicColor:e})}_getAnchorPos(e,t){return"relative"===e?(0,N.t)((t.x||0)+.5,.5-(t.y||0)):e in Eu?Eu[e]:Eu.center}_createMaterialAndAddToStage(e,t){if(this._cimLayers?this._fastUpdates={enabled:!1}:this._fastUpdates=ny(this._context.renderer,this._fastVisualVariableConvertOptions()),this._fastUpdates.enabled&&Object.assign(e,this._fastUpdates.materialParameters),this._cimLayers){let i=this._cimSymbolMaterials.get(e.textureId);return i||(i=new nd(e),this._cimSymbolMaterials.set(e.textureId,i),t.add(i)),i}return this._material=new nd(e),t.add(this._material),this._material}_setDrapingDependentMaterialParameters(){this.draped&&(this._forEachMaterial((e=>{e.setParameterValues({verticalOffset:null,screenSizePerspective:null,occlusionTest:!1,slicePlaneEnabled:!1,shaderPolygonOffset:0,isDraped:this.draped})})),this.layerOpacityChanged())}destroy(){super.destroy(),this._forEachMaterial((e=>this._context.stage.remove(e))),this._material=null,this._cimSymbolMaterials.clear(),this._cimSymbolTextures.forEach((e=>this._context.stage.remove(e))),this._cimSymbolTextures.clear(),this._releaseTexture&&(this._releaseTexture(),this._releaseTexture=null)}_getScaleFactor(e,t){if(this._drivenProperties.size&&e.size){for(let t=0;t<3;t++){const i=e.size[t];i&&"symbol-value"!==i&&"proportional"!==i&&(e.size[t]=(0,f.u)(i))}if("symbol-value"===e.size[0])return 1;if(isFinite(+e.size[0]))return+e.size[0]/t;if(isFinite(+e.size[2]))return+e.size[2]/t}return 1}createGraphics3DGraphic(e){const t=e.graphic;if(!this._validateGeometry(t.geometry))return null;let i,r;if(this._cimLayers){if(!this._cimLayers.length)return null;const e=this._generateTextureCIM(t),s={textureId:e.id,...this._cimMaterialParametersInfo};r=this._createMaterialAndAddToStage(s,this._context.stage),i=[e.params.width,e.params.height]}else i=this._size,r=(0,u.f)(this._material);const s=Hp(t.geometry);if((0,u.t)(s))return this.logger.warn(`unsupported geometry type for icon symbol: ${t.geometry.type}`),null;const n=e.renderingInfo,a=this._getVertexOpacityAndColor(n);let o=1;if(!this._fastUpdates.enabled||!this._fastUpdates.visualVariables.size){const e=i[0]>i[1]?i[0]:i[1];o=this._getScaleFactor(n,e)}o*=this._symbolTextureRatio;const l=[i[0]*o,i[1]*o],c=this.setGraphicElevationContext(t,new hp);return this.ensureDrapedStatus("on-the-ground"===c.mode)&&this._setDrapingDependentMaterialParameters(),this.draped?this._createAsOverlay(t,s,r,a,l,e.layer.uid):this._createAs3DShape(t,s,r,a,l,c,t.uid)}layerOpacityChanged(){const e=this._getFillColor(),t=this._getOutlineColor();return this._forEachMaterial((i=>{i.setParameterValues({color:e}),i.setParameterValues({outlineColor:t})})),!0}layerElevationInfoChanged(e,t,i){const r=this._elevationContext.mode,s=Lu(vy.elevationModeChangeTypes,i,r);if(s!==Gu.UPDATE)return s;const n=Fu(r)||"absolute-height"===r;return this.updateGraphics3DGraphicElevationInfo(e,t,(()=>n))}slicePlaneEnabledChanged(){return this.draped||this._forEachMaterial((e=>{e.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled})})),!0}physicalBasedRenderingChanged(){return!0}pixelRatioChanged(){return!!this._getPrimitive()}applyRendererDiff(e,t){for(const i in e.diff)switch(i){case"visualVariables":if(!ay(this._fastUpdates,t,this._fastVisualVariableConvertOptions()))return!1;(0,u.r)(this._material)&&this._material.setParameterValues(this._fastUpdates.materialParameters);break;default:return!1}return!0}_defaultElevationInfoNoZ(){return _y}_createAs3DShape(e,t,i,r,s,n,a){const o=this.getFastUpdateAttrValues(e),l=o?e=>dy(this._fastUpdates.materialParameters,o,e):null,c=[lr.createPointGeometry(fy,null,r,s,xy,null,o)],h=Np(this._context,t,c,[i],null,null,n,this._context.layer.uid,a,l);if(null===h)return null;const d=Hu,u=new dp(this,h.object,c,null,null,d,n);return u.alignedSampledElevation=h.sampledElevation,u.needsElevationUpdates=Fu(n.mode)||"absolute-height"===n.mode,u.getScreenSize=this._createScreenSizeGetter(s,l),u.calculateRelativeScreenBounds=e=>i.calculateRelativeScreenBounds(u.getScreenSize(),1,e),jp(u,t,this._context.elevationProvider),u}_createAsOverlay(e,t,i,r,s,n){i.renderPriority=this._renderPriority;const a=(0,w.n)();(0,_.R)(t,a,this._context.overlaySR),a[2]=-2;const o=this._context.clippingExtent;if((0,u.r)(o)&&!(0,se.E)(o,a))return null;const l=this.getFastUpdateAttrValues(e),c=l?e=>dy(this._fastUpdates.materialParameters,l,e):null,h=lr.createPointGeometry(fy,a,r,s,null,null,l),d=new py(h,i,n,e.uid);a[3]=0,(0,j.a)(d.boundingSphere,a),d.calculateShaderTransformation=c;const p=new Nv(this,[d],null);return p.getScreenSize=this._createScreenSizeGetter(s,c),p.calculateRelativeScreenBounds=e=>i.calculateRelativeScreenBounds(p.getScreenSize(),1,e),p}_createScreenSizeGetter(e,t){const i=this._outlineSize+2;if(this._fastUpdates.enabled){const r=e[0]/this._symbolTextureRatio,s=e[1]/this._symbolTextureRatio;return(e=(0,N.n)())=>{const n=t(my);return e[0]=n[0]*r+i,e[1]=n[5]*s+i,e}}{const t=e[0]/this._symbolTextureRatio+i,r=e[1]/this._symbolTextureRatio+i;return(e=(0,N.n)())=>(e[0]=t,e[1]=r,e)}}_fastVisualVariableConvertOptions(){const e=this._size[0]>this._size[1]?this._size[0]:this._size[1],t=(0,v.i)(e,e,e),i=(0,f.e)(1),r=e*i;return{modelSize:t,symbolSize:(0,v.i)(r,r,r),unitInMeters:i,transformation:{anchor:v.G,scale:v.l,rotation:v.G}}}_getGraphicHash(e){let t="";for(const i of this._cimRequiredFields)t+=i+e.attributes[i];return t}_forEachMaterial(e){(0,u.r)(this._material)&&e(this._material),this._cimSymbolMaterials.forEach(e)}}function yy(e){return!!(0,u.r)(e)&&("cross"===e||"x"===e)}vy.PRIMITIVE_SIZE=[64,64],vy.elevationModeChangeTypes={definedChanged:Gu.UPDATE,staysOnTheGround:Gu.NONE,onTheGroundChanged:Gu.RECREATE};const _y={mode:"relative-to-ground",offset:0},xy=(0,w.a)(0,0,0,1);function by(e){const t=[],i=[];!function(e,t,i){const{attributeData:{position:r},removeDuplicateStartEnd:s}=e,n=function(e){const t=e.length;return e[0]===e[t-3]&&e[1]===e[t-2]&&e[2]===e[t-1]}(r)&&1===s,a=r.length/3-(n?1:0),o=new Uint32Array(2*(a-1)),l=n?(0,u.F)(r,0,r.length-3):r;let c=0;for(let e=0;e<a-1;e++)o[c++]=e,o[c++]=e+1;t.push(["position",{size:3,data:l,exclusive:n}]),i.push(["position",o])}(e,i,t);const r=i[0][1].data,s=t[0][1].length,n=new Uint16Array(s);return function(e,t,i){const r=e.attributeData.mapPosition;(0,u.t)(r)||(i.push(["mapPos",i[0][1]]),t.push(["mapPos",{size:3,data:r}]))}(e,i,t),function(e,t,i,r){if((0,u.r)(e.attributeData.colorFeature))return;const s=e.attributeData.color;t.push(["color",{size:4,data:(0,u.q)(s,kv)}]),i.push(["color",r])}(e,i,t,n),function(e,t,i,r){if((0,u.r)(e.attributeData.sizeFeature))return;const s=e.attributeData.size;t.push(["size",{size:1,data:[(0,u.q)(s,1)]}]),i.push(["size",r])}(e,i,t,n),function(e,t,i,r){const s=e.attributeData.colorFeature;(0,u.t)(s)||(t.push(["colorFeatureAttribute",{size:1,data:new Float32Array([s])}]),i.push(["color",r]))}(e,i,t,n),function(e,t,i,r){const s=e.attributeData.sizeFeature;(0,u.t)(s)||(t.push(["sizeFeatureAttribute",{size:1,data:new Float32Array([s])}]),i.push(["sizeFeatureAttribute",r]))}(e,i,t,n),function(e,t,i,r){const s=e.attributeData.opacityFeature;(0,u.t)(s)||(t.push(["opacityFeatureAttribute",{size:1,data:new Float32Array([s])}]),i.push(["opacityFeatureAttribute",r]))}(e,i,t,n),function(e,t,i,r){if("round"!==e.join)return;const s=r.length/3,n=new Float32Array(s),a=Ty,o=Sy;(0,v.a)(a,0,0,0);const l=(0,u.q)(e.uniformSize,1);for(let e=-1;e<s;++e){const t=e<0?s+e:e,i=(e+1)%s;if((0,v.a)(o,r[3*i+0]-r[3*t+0],r[3*i+1]-r[3*t+1],r[3*i+2]-r[3*t+2]),(0,v.j)(o,o),e>=0){const t=(Math.PI-(0,v.x)((0,v.z)(a,o)))*Py*1*Cy(l);n[e]=Math.max(Math.floor(t),0)}(0,v.d)(a,o,-1)}t.push(["subdivisions",{size:1,data:n}]),i.push(["subdivisions",i[0][1]])}(e,i,t,r),new S.u(i,t,2)}function wy(e,t,i){const r=new Array;for(const{index:s,count:n}of e){if(n<=1)continue;const e=3*s,a=e+3*n;r.push({position:t.subarray(e,a),mapPosition:i?i.subarray(e,a):void 0})}return r}function Cy(e){return 1.863798+-2.0062872/(1+e/18.2313)**.8856294}const Ty=(0,v.n)(),Sy=(0,v.n)(),Py=4/Math.PI;function Ry(e){return(0,u.t)(e)?e:e.slice()}function Ay(e){return[e,e]}const My=["polyline","polygon","extent"];class Oy extends Vp{constructor(e,t,i,r){super(e,t,i,r),this._uniformSize=1}async doLoad(){if(this._vvConvertOptions={modelSize:[1,1,1],symbolSize:[1,1,1],unitInMeters:1,transformation:{anchor:[0,0,0],scale:[1,1,1],rotation:[0,0,0]},supportedTypes:{size:!0,color:!0,opacity:!0,rotation:!1}},this._context.renderer&&this._context.renderer.visualVariables&&this._context.renderer.visualVariables.length>0?this._fastUpdates=ny(this._context.renderer,this._vvConvertOptions):this._fastUpdates={enabled:!1},!this._drivenProperties.size){const e=null!=this.symbolLayer.size?this.symbolLayer.size:(0,f.e)(1);if(e<0)throw new h.s("graphics3dlinesymbollayer:invalid-size","Symbol sizes may not be negative values");this._uniformSize=e}}getMaterialParameters(e){const t=(0,u.g)(this.symbolLayer,"material","color"),i=this._getCombinedOpacityAndColor(t),r=i[3],s={width:1,color:i,polygonOffset:!0,join:this.symbolLayer.join||"miter",cap:this.symbolLayer.cap||"butt",transparent:r<1||this.needsDrivenTransparentPass,slicePlaneEnabled:this._context.slicePlaneEnabled,isClosed:e,stipplePattern:this.symbolLayer.stipplePattern?Ry(this.symbolLayer.stipplePattern.map(f.u)):null,stippleOffColor:this.symbolLayer.stippleOffColor?z.o.toUnitRGBA(this.symbolLayer.stippleOffColor):null,stippleIntegerRepeats:!0};if(this._drivenProperties.size)this._fastUpdates.enabled&&this._fastUpdates.visualVariables.size&&(s.width=(0,f.u)(1));else{const e=null!=this.symbolLayer.size?this.symbolLayer.size:(0,f.e)(1);s.width=(0,f.u)(e)}return this._fastUpdates&&this._fastUpdates.visualVariables?{...s,...this._fastUpdates.materialParameters}:s}get lineMaterial(){return(0,u.t)(this._lineMaterial)&&(this._lineMaterial=new yf(this.getMaterialParameters(!1)),this._context.stage.add(this._lineMaterial)),this._lineMaterial}get ringMaterial(){return(0,u.t)(this._ringMaterial)&&(this._ringMaterial=new yf(this.getMaterialParameters(!0)),this._context.stage.add(this._ringMaterial)),this._ringMaterial}destroy(){super.destroy(),this._context.stage.remove(this._lineMaterial),this._lineMaterial=null,this._context.stage.remove(this._ringMaterial),this._ringMaterial=null}getDrivenSize(e){return this._drivenProperties.size&&e.size?(0,f.u)(function(e){for(let t=0;t<3;t++){const i=e[t];if("number"==typeof i)return isFinite(i)?i:0}return 0}(e.size)):1}getSizeFeatureAttributeData(e){return this._fastUpdates.enabled&&this._fastUpdates.visualVariables.size?Up(this._fastUpdates.visualVariables.size.field,e):null}getDrivenColor(e){const t=(0,w.a)(1,1,1,1);return this._drivenProperties.color&&e.color&&(t[0]=e.color[0],t[1]=e.color[1],t[2]=e.color[2],e.color.length>0&&(t[3]=e.color[3])),this._drivenProperties.opacity&&e.opacity&&(t[3]=e.opacity),t}getColorFeatureAttributeData(e){return this._fastUpdates.enabled&&this._fastUpdates.visualVariables.color?Up(this._fastUpdates.visualVariables.color.field,e):null}getOpacityFeatureAttributeData(e){return this._fastUpdates.enabled&&this._fastUpdates.visualVariables.opacity?Up(this._fastUpdates.visualVariables.opacity.field,e):null}createGraphics3DGraphic(e){const t=e.graphic;if(!this._validateGeometry(t.geometry,My,this.symbolLayer.type))return null;const i=this.setGraphicElevationContext(t,new hp);return this.ensureDrapedStatus("on-the-ground"===i.mode),this.draped?this._createAsOverlay(e,this._context.layer.uid):this._createAs3DShape(e,i,t.uid)}applyRendererDiff(e,t){for(const i in e.diff)switch(i){case"visualVariables":if(!ay(this._fastUpdates,t,this._vvConvertOptions))return!1;(0,u.r)(this._lineMaterial)&&this._lineMaterial.setParameterValues(this._fastUpdates.materialParameters),(0,u.r)(this._ringMaterial)&&this._ringMaterial.setParameterValues(this._fastUpdates.materialParameters);break;default:return!1}return!0}layerOpacityChanged(){return(0,u.r)(this._lineMaterial)&&this.updateMaterialLayerOpacity(this._lineMaterial),(0,u.r)(this._ringMaterial)&&this.updateMaterialLayerOpacity(this._ringMaterial),!0}updateMaterialLayerOpacity(e){const t=e.params.color,i=(0,u.g)(this.symbolLayer,"material","color"),r=this._getCombinedOpacity(i),s=r<1||this.needsDrivenTransparentPass,n=[t[0],t[1],t[2],r];e.setParameterValues({color:n,transparent:s})}layerElevationInfoChanged(e,t,i){const r=this._elevationContext.mode,s=Lu(Oy.elevationModeChangeTypes,i,r);if(s!==Gu.UPDATE)return s;const n=Fu(r);return this.updateGraphics3DGraphicElevationInfo(e,t,(()=>n))}slicePlaneEnabledChanged(){return(0,u.r)(this._lineMaterial)&&this._lineMaterial.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled}),(0,u.r)(this._ringMaterial)&&this._ringMaterial.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled}),!0}physicalBasedRenderingChanged(){return!0}pixelRatioChanged(){return!0}_getGeometryAsPolygonOrPolyline(e){switch(e.type){case"extent":if(e instanceof A.M)return A.j.fromExtent(e);break;case"polygon":case"polyline":return e}return null}_createAs3DShape(e,t,i){const r=e.graphic,s=this._getGeometryAsPolygonOrPolyline(r.geometry),n="polygon"===s.type?s.rings:s.paths,a=new Array,o=new Array,l=new Array,c=(0,se.a)(),h=function(e,t,i,r){const s="polygon"===e.type?1:0,n="polygon"===e.type?e.rings:e.paths,{position:a,outlines:o}=(0,pe.l)(n,e.hasZ,s),l=new Float64Array(a.length),c=zu(a,e.spatialReference,0,l,0,a,0,a.length/3,t,i,r),h=null!=c;return{lines:h?wy(o,a,l):[],projectionSuccess:h,sampledElevation:c}}(s,this._context.elevationProvider,this._context.renderCoordsHelper,t),d="polygon"===s.type?"rings":"paths";this._logGeometryCreationWarnings(h,n,d,"LineSymbol3DLayer");for(let t=0;t<h.lines.length;t++){const{position:i,mapPosition:r}=h.lines[t];if((0,u.r)(this._context.clippingExtent)&&((0,se.B)(c),(0,se.M)(c,r),!(0,se.R)(c,this._context.clippingExtent)))continue;const n=this._createGeometry(e,i,r,s.type);a.push(n),o.push("polygon"===s.type?this.ringMaterial:this.lineMaterial),l.push(T.a)}if(0===a.length)return null;const p=new Qs({geometries:a,materials:o,transformations:l,castShadow:!1,metadata:{layerUid:this._context.layer.uid,graphicUid:i}}),m=new dp(this,p,a,null,null,ju,t);return m.alignedSampledElevation=h.sampledElevation,m.needsElevationUpdates=Fu(t.mode),m}_createGeometry(e,t,i,r){const s="polygon"===r?1:0,n=this._fastUpdates.enabled&&this._fastUpdates.visualVariables.color,a=this._fastUpdates.enabled&&this._fastUpdates.visualVariables.size;return by({removeDuplicateStartEnd:s,uniformSize:this._uniformSize,attributeData:{position:t,mapPosition:i,size:a?null:this.getDrivenSize(e.renderingInfo),color:n?null:this.getDrivenColor(e.renderingInfo),sizeFeature:this.getSizeFeatureAttributeData(e.graphic),colorFeature:this.getColorFeatureAttributeData(e.graphic),opacityFeature:this.getOpacityFeatureAttributeData(e.graphic)}})}_createAsOverlay(e,t){const i=e.graphic,r=this._getGeometryAsPolygonOrPolyline(i.geometry),s="polygon"===r.type?r.rings:r.paths,n="polygon"===r.type?this.ringMaterial:this.lineMaterial;n.renderPriority=this._renderPriority;const a=new Array,o=(0,se.a)(),l=(0,se.B)(),c=function(e,t){const i="polygon"===e.type?1:0,r="polygon"===e.type?e.rings:e.paths,{position:s,outlines:n}=(0,pe.l)(r,!1,i),a=(0,_.x)(s,e.spatialReference,0,s,t,0,s.length/3);for(let e=2;e<s.length;e+=3)s[e]=-2;return{lines:a?wy(n,s):[],projectionSuccess:a}}(r,this._context.overlaySR),h="polygon"===r.type?"rings":"paths";this._logGeometryCreationWarnings(c,s,h,"LineSymbol3DLayer");for(const s of c.lines){if((0,se.B)(o),(0,se.M)(o,s.position),!(0,se.R)(o,this._context.clippingExtent))continue;(0,se.f)(l,o);const c=this._createGeometry(e,s.position,null,r.type),h=new py(c,n,t,i.uid);(0,j.r)(h.boundingSphere,.5*(o[0]+o[3]),.5*(o[1]+o[4]),0,.5*Math.sqrt((o[3]-o[0])*(o[3]-o[0])+(o[4]-o[1])*(o[4]-o[1]))),a.push(h)}return new Nv(this,a,l)}}function Dy(e){switch(e){case"multiply":return 1;case"ignore":return 2;case"replace":return 3;case"tint":return 4;default:return 1}}function Ey(e,t,i){if((0,u.t)(e)||2===t)return i[0]=255,i[1]=255,i[2]=255,void(i[3]=255);const r=(0,v.o)(Math.round(e[3]*Iy),0,Iy),s=0===r||4===t?0:3===t?Ly:Fy;i[0]=(0,v.o)(Math.round(e[0]*zy),0,zy),i[1]=(0,v.o)(Math.round(e[1]*zy),0,zy),i[2]=(0,v.o)(Math.round(e[2]*zy),0,zy),i[3]=r+s}Oy.elevationModeChangeTypes={definedChanged:Gu.RECREATE,staysOnTheGround:Gu.NONE,onTheGroundChanged:Gu.RECREATE};const zy=255,Iy=85,Ly=Iy,Fy=2*Iy,Vy=(0,G.A)().vec3f("position"),Uy=(0,G.A)().vec3f("position").vec2f("uv0"),Gy=(0,G.A)().vec3f("position").vec4u8("color");class By{constructor(e){this.vertexBufferLayout=e}allocate(e){return this.vertexBufferLayout.createBuffer(e)}elementCount(e){return e.indices.get("position").length}write(e,t,i,r){(0,S.aU)(t,this.vertexBufferLayout,e.transformation,e.invTranspTransformation,i,r)}}function qy(e){const t=new S.n;return t.include(S.r,{linearDepth:!1}),t.include(S.aV,e),t.include(hf,e),t.vertex.uniforms.add("proj","mat4").add("view","mat4"),t.attributes.add("position","vec3"),t.varyings.add("vpos","vec3"),t.vertex.code.add(S.t`void main(void) {
vpos = position;
forwardNormalizedVertexColor();
gl_Position = transformPosition(proj, view, vpos);`),e.stippleEnabled&&(t.attributes.add("auxpos1","vec3"),t.vertex.uniforms.add("ndcToPixel","vec2"),t.vertex.code.add(S.t`
    vec4 vpos2 = transformPosition(proj, view, auxpos1);
    float lineSegmentPixelSize = length((vpos2.xy / vpos2.w - gl_Position.xy / gl_Position.w) * ndcToPixel);

    stipplePatternUv = lineSegmentPixelSize * stipplePatternPixelSizeInv;
    ${e.stippleIntegerRepeatsEnabled?"stipplePatternUv = floor(stipplePatternUv + 0.5);":""}

    // Cancel out perspective correct interpolation because we want this length the really represent
    // the screen distance
    stipplePatternUv *= gl_Position.w;
    `)),t.vertex.code.add(S.t`}`),4===e.output&&t.include(S.S),t.include(S.N,e),t.fragment.uniforms.add("constantColor","vec4").add("alphaCoverage","float"),t.fragment.code.add(S.t`
  void main() {
    discardBySlice(vpos);

    vec4 color = ${e.attributeColor?"vColor":"constantColor"};

    float stippleAlpha = getStippleAlpha();
    discardByStippleAlpha(stippleAlpha, stippleAlphaColorDiscard);

    vec4 finalColor = blendStipple(vec4(color.rgb, color.a * alphaCoverage), stippleAlpha);

    if (finalColor.a < ${S.t.float(S.Q)}) {
      discard;
    }

    ${0===e.output?S.t`gl_FragColor = highlightSlice(finalColor, vpos);`:""}
    ${4===e.output?S.t`outputHighlight();`:""}
  }
  `),t}var ky=Object.freeze({__proto__:null,build:qy});class Ny extends S.c{constructor(e,t,i){super(e,t,i),this.stipplePattern=null,this.stippleTextureBind=null,this.stippleTextureRepository=e.stippleTextureRepository}initializeProgram(e){const t=Ny.shader.get(),i=this.configuration,r=t.build({output:i.output,attributeColor:i.vertexColors,slicePlaneEnabled:i.slicePlaneEnabled,sliceHighlightDisabled:!1,sliceEnabledForVertexPrograms:!1,stippleEnabled:i.stippleEnabled,stippleOffColorEnabled:i.stippleOffColorEnabled,stippleUVMaxEnabled:!1,stippleIntegerRepeatsEnabled:i.stippleIntegerRepeatsEnabled});return new S.d(e.rctx,r,S.o)}dispose(){super.dispose(),this.stippleTextureRepository.release(this.stipplePattern),this.stipplePattern=null,this.stippleTextureBind=null}bindPass(e,t){if((0,S.h)(this.program,t.camera.projectionMatrix),this.stipplePattern!==e.stipplePattern){const t=e.stipplePattern;this.stippleTextureBind=this.stippleTextureRepository.swap(this.stipplePattern,t),this.stipplePattern=t}if(this.configuration.stippleEnabled){const e=(0,u.r)(this.stippleTextureBind)?this.stippleTextureBind(this.program)*t.camera.pixelRatio:1;this.program.setUniform1i("stipplePatternTexture",0),this.program.setUniform1f("stipplePatternPixelSizeInv",1/e),this.program.setUniform2f("ndcToPixel",t.camera.fullViewport[2]/2,t.camera.fullViewport[3]/2)}if(this.program.setUniform4fv("constantColor",e.color),this.program.setUniform1f("alphaCoverage",Math.min(1,e.width*t.camera.pixelRatio)),this.configuration.stippleOffColorEnabled){const t=(0,u.f)(e.stippleOffColor);this.program.setUniform4f("stippleOffColor",t[0],t[1],t[2],t.length>3?t[3]:1)}4===this.configuration.output&&(0,S.a1)(this.program,t)}bindDraw(e){(0,S.a2)(this.program,e),(0,S.a4)(this.program,this.configuration,e),this.program.rebindTextures()}initializePipeline(){const e=this.configuration,t=(0,V.e)(770,1,771,771),i=(t,i=null,r=null)=>(0,V.g)({blending:i,depthTest:S.aC,depthWrite:r,colorWrite:V.r,stencilWrite:e.sceneHasOcludees?S.au:null,stencilTest:e.sceneHasOcludees?t?S.av:S.aw:null});return 0===e.output?(this._occludeePipelineState=i(!0,e.transparent||e.stippleEnabled?t:null,V.l),i(!1,e.transparent||e.stippleEnabled?t:null,V.l)):i(!1)}get primitiveType(){return 1}getPipelineState(e){return e?this._occludeePipelineState:this.pipeline}}Ny.shader=new S.f(ky,(()=>i.e(1588).then(i.bind(i,71588))));class jy extends S.b{constructor(){super(...arguments),this.output=0,this.slicePlaneEnabled=!1,this.vertexColors=!1,this.transparent=!1,this.stippleEnabled=!1,this.stippleOffColorEnabled=!1,this.stippleIntegerRepeatsEnabled=!1,this.sceneHasOcludees=!1}}(0,r.e)([(0,S.a)({count:8})],jy.prototype,"output",void 0),(0,r.e)([(0,S.a)()],jy.prototype,"slicePlaneEnabled",void 0),(0,r.e)([(0,S.a)()],jy.prototype,"vertexColors",void 0),(0,r.e)([(0,S.a)()],jy.prototype,"transparent",void 0),(0,r.e)([(0,S.a)()],jy.prototype,"stippleEnabled",void 0),(0,r.e)([(0,S.a)()],jy.prototype,"stippleOffColorEnabled",void 0),(0,r.e)([(0,S.a)()],jy.prototype,"stippleIntegerRepeatsEnabled",void 0),(0,r.e)([(0,S.a)()],jy.prototype,"sceneHasOcludees",void 0);const Hy=u.n.getLogger("esri.views.3d.webgl-engine.materials.NativeLineMaterial");class Wy extends S.a6{constructor(e){super(e,Yy),this.techniqueConfig=new jy}getTechniqueConfig(e){this.techniqueConfig.output=e,this.techniqueConfig.slicePlaneEnabled=this.params.slicePlaneEnabled,this.techniqueConfig.vertexColors=this.params.vertexColors,this.techniqueConfig.transparent=this.params.color[3]<1||this.params.width<1;const t=(0,u.r)(this.params.stipplePattern);return this.techniqueConfig.stippleEnabled=t,this.techniqueConfig.stippleOffColorEnabled=t&&(0,u.r)(this.params.stippleOffColor),this.techniqueConfig.stippleIntegerRepeatsEnabled=t&&this.params.stippleIntegerRepeats,this.techniqueConfig.sceneHasOcludees=this.params.sceneHasOcludees,this.techniqueConfig}getPassParameters(){return this.params}intersect(e,t,i,r,s,n,a,o,l){l?(0,S.aW)(e,r,n,1,a):this.intersectLineGeometry(e,t,i,r,a)}intersectLineGeometry(e,t,i,r,s){if(!r.options.selectionMode||(0,S.C)(t))return;if(!(0,S.aD)(i))return void Hy.error("intersection assumes a translation-only matrix");const n=e.vertexAttributes.get("position").data,a=r.camera,o=a_;(0,k.a)(o,r.point),(0,v.a)(o_[0],o[0]-2,o[1]+2,0),(0,v.a)(o_[1],o[0]+2,o[1]+2,0),(0,v.a)(o_[2],o[0]+2,o[1]-2,0),(0,v.a)(o_[3],o[0]-2,o[1]-2,0);for(let e=0;e<4;e++)if(!a.unprojectFromRenderScreen(o_[e],l_[e]))return;Fe(a.eye,l_[0],l_[1],c_),Fe(a.eye,l_[1],l_[2],h_),Fe(a.eye,l_[2],l_[3],d_),Fe(a.eye,l_[3],l_[0],u_);let l=Number.MAX_VALUE;for(let e=0;e<n.length-5;e+=3){if(Xy[0]=n[e]+i[12],Xy[1]=n[e+1]+i[13],Xy[2]=n[e+2]+i[14],$y[0]=n[e+3]+i[12],$y[1]=n[e+4]+i[13],$y[2]=n[e+5]+i[14],it(c_,Xy)<0&&it(c_,$y)<0||it(h_,Xy)<0&&it(h_,$y)<0||it(d_,Xy)<0&&it(d_,$y)<0||it(u_,Xy)<0&&it(u_,$y)<0)continue;if(a.projectToRenderScreen(Xy,e_),a.projectToRenderScreen($y,t_),e_[2]<0&&t_[2]>0){(0,v.c)(Ky,Xy,$y);const e=a.frustum,t=-it(e[4],Xy)/(0,v.z)(Ky,e[4]);(0,v.d)(Ky,Ky,t),(0,v.u)(Xy,Xy,Ky),a.projectToRenderScreen(Xy,e_)}else if(e_[2]>0&&t_[2]<0){(0,v.c)(Ky,$y,Xy);const e=a.frustum,t=-it(e[4],$y)/(0,v.z)(Ky,e[4]);(0,v.d)(Ky,Ky,t),(0,v.u)($y,$y,Ky),a.projectToRenderScreen($y,t_)}else if(e_[2]<0&&t_[2]<0)continue;e_[2]=0,t_[2]=0;const t=(0,w.b)((0,w.g)(e_,t_,s_),o);t<l&&(l=t,(0,v.h)(i_,Xy),(0,v.h)(r_,$y))}const c=r.rayBeginPoint,h=r.rayEndPoint;if(l<4){let e=Number.MAX_VALUE;if((0,w.k)((0,w.g)(i_,r_,s_),(0,w.g)(c,h,n_),Jy)){(0,v.c)(Jy,Jy,c);const t=(0,v.s)(Jy);(0,v.d)(Jy,Jy,1/t),e=t/(0,v.q)(c,h)}s(e,Jy)}}computeAttachmentOrigin(e,t){const i=e.vertexAttributes;if(!i)return!1;const r=i.get("position");return(0,w.i)(r,null,!1,t)}createBufferWriter(){const e=this.params.vertexColors?Gy:Vy;return(0,u.t)(this.params.stipplePattern)?new By(e):new Zy(e.clone().vec3f("auxpos1"))}getGLMaterial(e){return 0===e.output||4===e.output?new Qy(e):void 0}}class Qy extends S.aj{constructor(e){super(e),this.updateParameters()}updateParameters(){this._technique=this._techniqueRep.releaseAndAcquire(Ny,this._material.getTechniqueConfig(this._output),this._technique)}beginSlot(e){return 3===e}_updateOccludeeState(e){e.hasOccludees!==this._material.params.sceneHasOcludees&&(this._material.setParameterValues({sceneHasOcludees:e.hasOccludees}),this.updateParameters())}ensureParameters(e){0===this._output&&this._updateOccludeeState(e)}bind(e){this._technique.bindPass(this._material.getPassParameters(),e)}getPipelineState(e,t){return this._technique.getPipelineState(t)}}class Zy{constructor(e){this.vertexBufferLayout=e}allocate(e){return this.vertexBufferLayout.createBuffer(e)}elementCount(e){return e.indices.get("position").length}write(e,t,i,r){(0,S.aU)(t,this.vertexBufferLayout,e.transformation,e.invTranspTransformation,i,r),this.writeAuxpos1(e,t,i,r)}writeAuxpos1(e,t,i,r){const s=i.getField("auxpos1",de.i),n=t.indices.get("position"),a=t.vertexAttributes.get("position").data,o=e.transformation,l=s.typedBufferStride,c=s.typedBuffer;r*=l;for(let e=0;e<n.length;e+=2){const t=3*n[e],i=a[t],s=a[t+1],h=a[t+2],d=o[0]*i+o[4]*s+o[8]*h+o[12],u=o[1]*i+o[5]*s+o[9]*h+o[13],p=o[2]*i+o[6]*s+o[10]*h+o[14];for(let e=0;e<2;++e)c[r]=d,c[r+1]=u,c[r+2]=p,r+=l}}}const Yy={color:[1,1,1,1],vertexColors:!1,slicePlaneEnabled:!1,width:1,stipplePattern:null,stippleIntegerRepeats:!1,stippleOffColor:null,sceneHasOcludees:!1,...S.ab},Xy=(0,v.n)(),$y=(0,v.n)(),Ky=(0,v.n)(),Jy=(0,v.n)(),e_=(0,f.x)(),t_=(0,f.x)(),i_=(0,v.n)(),r_=(0,v.n)(),s_=(0,w.v)(),n_=(0,w.v)(),a_=(0,v.n)(),o_=[(0,f.x)(),(0,f.x)(),(0,f.x)(),(0,f.x)()],l_=[(0,v.n)(),(0,v.n)(),(0,v.n)(),(0,v.n)()],c_=De(),h_=De(),d_=De(),u_=De(),p_=["mesh"],m_=(0,v.n)(),f_=(0,v.n)(),g_=(0,v.n)(),v_=(0,v.n)(),y_=(0,v.n)(),__=(0,T.e)(),x_=(0,X.e)(),b_=(0,se.a)(),w_=[new pe.f];class C_{constructor(e,t,i,r){this.graphics3DSymbolLayer=e,this.instanceIndex=t,this.elevationAligner=i,this.elevationContext=r,this.type="lod-instance",this.alignedSampledElevation=0,this.isElevationSource=!1,this.needsElevationUpdates=!1}initialize(){}setVisibility(e){const t=this.lodRenderer.instanceData;e!==t.getVisible(this.instanceIndex)&&t.setVisible(this.instanceIndex,e)}destroy(){null!=this.instanceIndex&&(this.lodRenderer.instanceData.removeInstance(this.instanceIndex),this.graphics3DSymbolLayer.notifyDestroyGraphicLayer(this))}alignWithElevation(e,t,i){if(this.elevationAligner){np(this.elevationContext.featureExpressionInfoContext,i);const r=this.elevationAligner(this,this.elevationContext,e,t);null!=r&&(this.alignedSampledElevation=r)}}getCenterObjectSpace(e=(0,v.n)()){return this.lodRenderer.instanceData.getCombinedLocalTransform(this.instanceIndex,A_),(0,v.I)(e,this.lodRenderer.baseBoundingSphere.center,A_)}getBoundingBoxObjectSpace(e=(0,se.a)()){this.lodRenderer.instanceData.getCombinedLocalTransform(this.instanceIndex,A_);const t=this.lodRenderer.baseBoundingBox;(0,se.B)(e);for(let i=0;i<8;++i)(0,v.a)(S_,0==(1&i)?t[0]:t[3],0==(2&i)?t[1]:t[4],0==(4&i)?t[2]:t[5]),(0,v.I)(S_,S_,A_),(0,se.h)(e,S_);return e}computeAttachmentOrigin(e){this.lodRenderer.instanceData.getGlobalTransform(this.instanceIndex,A_),e.render.origin[0]+=A_[12],e.render.origin[1]+=A_[13],e.render.origin[2]+=A_[14],e.render.num++}async getProjectedBoundingBox(e,t,i,r,s){const n=this.getBoundingBoxObjectSpace(s),a=R_,o=(0,se.S)(n)?1:a.length;this.lodRenderer.instanceData.getGlobalTransform(this.instanceIndex,A_);for(let e=0;e<o;e++){const t=a[e];S_[0]=n[t[0]],S_[1]=n[t[1]],S_[2]=n[t[2]],(0,v.I)(S_,S_,A_),T_[3*e+0]=S_[0],T_[3*e+1]=S_[1],T_[3*e+2]=S_[2]}if(!e(T_,0,o))return null;(0,se.B)(n);let l=null;this.calculateRelativeScreenBounds&&(l=this.calculateRelativeScreenBounds());for(let e=0;e<3*o;e+=3){for(let t=0;t<3;t++)n[t]=Math.min(n[t],T_[e+t]),n[t+3]=Math.max(n[t+3],T_[e+t]);l&&i.push({location:T_.slice(e,e+3),screenSpaceBoundingRect:l})}if(t&&((0,se.p)(n,P_),"absolute-height"!==this.elevationContext.mode)){let e;const i=Du(n,t);try{e=await t.service.queryElevation(P_[0],P_[1],r,i,"ground")}catch(e){}(0,u.r)(e)&&(0,se.V)(n,0,0,-this.alignedSampledElevation+e)}return n}addObjectState(e,t){if(0===e){const i=new Ws(e);this.addHighlightId(i),t.addExternal((e=>{this.removeHighlightId(e)}),i)}}removeObjectState(e){this.highlights&&this.highlights.forEach((t=>e.remove(t)))}addHighlightId(e){this.highlights=this.highlights||new Set,this.highlights.add(e),this.lodRenderer.instanceData.setHighlight(this.instanceIndex,!0)}removeHighlightId(e){this.highlights&&(this.highlights.delete(e),this.lodRenderer.instanceData.setHighlight(this.instanceIndex,this.highlights.size>0),0===this.highlights.size&&(this.highlights=null))}get lodRenderer(){return this.graphics3DSymbolLayer.lodRenderer}}const T_=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],S_=(0,v.n)(),P_=(0,v.n)(),R_=[[0,1,2],[3,1,2],[0,4,2],[3,4,2],[0,1,5],[3,1,5],[0,4,5],[3,4,5]],A_=(0,T.e)();const M_=.05;var O_;!function(e){e[e.ALLOCATED=1]="ALLOCATED",e[e.DEFAULT_ACTIVE=2]="DEFAULT_ACTIVE",e[e.VISIBLE=4]="VISIBLE",e[e.HIGHLIGHT=8]="HIGHLIGHT",e[e.HIGHLIGHT_ACTIVE=16]="HIGHLIGHT_ACTIVE",e[e.REMOVE=32]="REMOVE",e[e.TRANSFORM_CHANGED=64]="TRANSFORM_CHANGED",e[e.ACTIVE=18]="ACTIVE"}(O_||(O_={}));class D_{constructor(e){this.localTransform=e.getField("localTransform",de.b),this.globalTransform=e.getField("globalTransform",de.b),this.modelOrigin=e.getField("modelOrigin",de.T),this.model=e.getField("model",de.l),this.modelNormal=e.getField("modelNormal",de.l),this.modelScaleFactors=e.getField("modelScaleFactors",de.u),this.boundingSphere=e.getField("boundingSphere",de.h),this.color=e.getField("color",de.c),this.featureAttribute=e.getField("featureAttribute",de.c),this.state=e.getField("state",de.d),this.lodLevel=e.getField("lodLevel",de.d)}}class E_ extends n.n{constructor(e,t){super(),this._capacity=0,this._size=0,this._next=0,this._layout=function(e){let t=(0,G.A)().mat4f64("localTransform").mat4f64("globalTransform").vec4f64("boundingSphere").vec3f64("modelOrigin").mat3f("model").mat3f("modelNormal").vec2f("modelScaleFactors");return e.indexOf("color")>=0&&(t=t.vec4f("color")),e.indexOf("featureAttribute")>=0&&(t=t.vec4f("featureAttribute")),t=t.u8("state").u8("lodLevel").alignTo(8),t}(e),this._shaderTransformation=t}get capacity(){return this._capacity}get size(){return this._size}get buffer(){return this._buffer.buffer}get view(){return this._view}addInstance(){this._size+1>this._capacity&&this.grow();const e=this.findSlot();return this._view.state.set(e,O_.ALLOCATED),this._size++,this.emit("instance-added",{index:e}),e}removeInstance(e){const t=this._view.state;(0,S.i)(e>=0&&e<this._capacity&&t.get(e)&O_.ALLOCATED,"invalid instance handle"),this.getStateFlag(e,O_.ACTIVE)?this.setStateFlags(e,O_.REMOVE):this.freeInstance(e),this.emit("instance-removed",{index:e})}freeInstance(e){const t=this._view.state;(0,S.i)(e>=0&&e<this._capacity&&t.get(e)&O_.ALLOCATED,"invalid instance handle"),t.set(e,0),this._size--}setLocalTransform(e,t,i=!0){this._view.localTransform.setMat(e,t),i&&this.updateModelTransform(e)}getLocalTransform(e,t){this._view.localTransform.getMat(e,t)}setGlobalTransform(e,t,i=!0){this._view.globalTransform.setMat(e,t),i&&this.updateModelTransform(e)}getGlobalTransform(e,t){this._view.globalTransform.getMat(e,t)}updateModelTransform(e){const t=this._view,i=L_,r=F_;t.localTransform.getMat(e,V_),t.globalTransform.getMat(e,U_);const n=(0,C.e)(U_,U_,V_);(0,v.a)(i,n[12],n[13],n[14]),t.modelOrigin.setVec(e,i),(0,Y.a)(r,n),t.model.setMat(e,r);const a=(0,s.U)(L_,n);a.sort(),t.modelScaleFactors.set(e,0,a[1]),t.modelScaleFactors.set(e,1,a[2]),(0,Y.u)(r,r),(0,Y.o)(r,r),t.modelNormal.setMat(e,r),this.setStateFlags(e,O_.TRANSFORM_CHANGED),this.emit("instance-transform-changed",{index:e})}getModelTransform(e,t){const i=this._view;i.model.getMat(e,F_),i.modelOrigin.getVec(e,L_),t[0]=F_[0],t[1]=F_[1],t[2]=F_[2],t[3]=0,t[4]=F_[3],t[5]=F_[4],t[6]=F_[5],t[7]=0,t[8]=F_[6],t[9]=F_[7],t[10]=F_[8],t[11]=0,t[12]=L_[0],t[13]=L_[1],t[14]=L_[2],t[15]=1}applyShaderTransformation(e,t){this._shaderTransformation&&this._shaderTransformation.applyTransform(this,e,t)}getCombinedModelTransform(e,t){return this.getModelTransform(e,t),this._shaderTransformation&&this._shaderTransformation.applyTransform(this,e,t),t}getCombinedLocalTransform(e,t){return this._view.localTransform.getMat(e,t),this._shaderTransformation&&this._shaderTransformation.applyTransform(this,e,t),t}getCombinedMaxScaleFactor(e){let t=this._view.modelScaleFactors.get(e,1);if(this._shaderTransformation){const i=this._shaderTransformation.scaleFactor(L_,this,e);t*=Math.max(i[0],i[1],i[2])}return t}getCombinedMedianScaleFactor(e){let t=this._view.modelScaleFactors.get(e,0);if(this._shaderTransformation){const i=this._shaderTransformation.scaleFactor(L_,this,e);i.sort(),t*=i[1]}return t}getModel(e,t){this._view.model.getMat(e,t)}setFeatureAttribute(e,t){this._view.featureAttribute.setVec(e,t)}getFeatureAttribute(e,t){this._view.featureAttribute.getVec(e,t)}setColor(e,t){this._view.color.setVec(e,t)}getColor(e,t){this._view.color.getVec(e,t)}setVisible(e,t){t!==this.getVisible(e)&&(this.setStateFlag(e,O_.VISIBLE,t),this.emit("instance-visibility-changed",{index:e}))}getVisible(e){return this.getStateFlag(e,O_.VISIBLE)}setHighlight(e,t){t!==this.getHighlight(e)&&(this.setStateFlag(e,O_.HIGHLIGHT,t),this.emit("instance-highlight-changed",{index:e}))}getHighlight(e){return this.getStateFlag(e,O_.HIGHLIGHT)}getState(e){return this._view.state.get(e)}getLodLevel(e){return this._view.lodLevel.get(e)}countFlags(e){let t=0;for(let i=0;i<this._capacity;++i)this.getState(i)&e&&++t;return t}setStateFlags(e,t){const i=this._view.state;t=i.get(e)|t,i.set(e,t)}clearStateFlags(e,t){const i=this._view.state;t=i.get(e)&~t,i.set(e,t)}setStateFlag(e,t,i){i?this.setStateFlags(e,t):this.clearStateFlags(e,t)}getStateFlag(e,t){return!!(this._view.state.get(e)&t)}grow(){const e=Math.max(z_,Math.floor(this._capacity*I_)),t=this._layout.createBuffer(e);if(this._buffer){const e=new Uint8Array(this._buffer.buffer);new Uint8Array(t.buffer).set(e)}this._capacity=e,this._buffer=t,this._view=new D_(this._buffer)}findSlot(){const e=this._view.state;let t=this._next;for(;e.get(t)&O_.ALLOCATED;)t=(t+1)%this._capacity;return this._next=(t+1)%this._capacity,t}}const z_=1024,I_=2,L_=(0,v.n)(),F_=(0,X.e)(),V_=(0,T.e)(),U_=(0,T.e)();class G_ extends zm{constructor(e,t){super((e=>(0,S.aX)(this._instanceData.view.boundingSphere.getVec(e,this._tmpSphere))),{maximumDepth:25}),this._tmpSphere=(0,S._)(),this._tmpMat4=(0,T.e)(),this._instanceData=e,this._boundingSphere=t}addInstance(e){const t=this._instanceData.view.boundingSphere,i=this._instanceData.getCombinedModelTransform(e,this._tmpMat4);(0,v.I)(this._tmpSphere,this._boundingSphere.center,i),this._tmpSphere[3]=this._boundingSphere.radius*(0,s.H)(i),t.setVec(e,this._tmpSphere),this.add([e])}removeInstance(e){this.remove([e])}}class B_{constructor(e,t){this.thresholdScale=1,this._camera=new Ia,this._worldSpaceRadius=e,this._thresholds=t.map((e=>e))}updateCamera(e){this._camera.copyFrom(e)}selectLevel(e,t){const i=this._camera.computeScreenPixelSizeAt(e),r=this._worldSpaceRadius*t/i,s=this._thresholds;let n=-1;for(let e=0;e<s.length;++e)r>=s[e]*this.thresholdScale&&(n=e);return n}}class q_{constructor(e,t){const i=e.renderContext.rctx,r=t.geometry,s=t.material;this.materialRep=e.materialRep,s.setParameterValues({instancedDoublePrecision:!0});const n=s.createBufferWriter(),a=n.vertexBufferLayout,o=n.elementCount(r),l=n.allocate(o);n.write({},r,l,0),this.geometry=r,this.material=s,this.glMaterials=(0,S.aJ)(s,this.materialRep),this.vertexBufferLayout=a,this.vbo=V.h.createVertex(i,35044,l.buffer),this.vao=new V.f(i,S.o,{geometry:(0,U.t)(a)},{geometry:this.vbo}),this.vertexCount=o}destroy(){(0,S.aK)(this.material,this.materialRep),this.vbo.dispose(),this.vao.dispose()}get boundingInfo(){return this.geometry.boundingInfo}get triangleCount(){return this.vertexCount/3}intersect(e,t,i,r,s,n){const a=this.geometry.id,o=s.toString();this.material.intersect(this.geometry,null,e.transform.transform,e,i,r,((i,r,l,c)=>{if(i>=0){if(null!=t&&!t(e.rayBeginPoint,e.rayEndPoint,i))return;const h={type:"external",metadata:{layerUid:n.layerUid,graphicUid:n.graphicUid(s)}};if((null==e.results.min.drapedLayerOrder||c>=e.results.min.drapedLayerOrder)&&(null==e.results.min.dist||i<e.results.min.dist)&&(e.results.min.set(h,o,i,r,e.transform.transform,c,null,a,l),e.results.min.intersector="LodRenderer"),0!==e.options.store&&(null==e.results.max.drapedLayerOrder||c>=e.results.max.drapedLayerOrder)&&(null==e.results.max.dist||i>e.results.max.dist)&&(e.results.max.set(h,o,i,r,e.transform.transform,c,null,a,l),e.results.min.intersector="LodRenderer"),2===e.options.store){const t=new Ks(e.results.min.ray);t.set(h,o,i,r,e.transform.transform,c,null,a,l),t.intersector="LodRenderer",e.results.all.push(t)}}}))}}class k_{constructor(e,t){this.minScreenSpaceRadius=e,this.components=t}static async create(e,t,i){const r=await Promise.all(t.components.map((t=>e.schedule((()=>new q_(e,t)),i))));return new k_(t.minScreenSpaceRadius,r)}destroy(){this.components.forEach((e=>{e.destroy()}))}intersect(e,t,i,r,s,n){this.components.forEach((a=>{a.intersect(e,t,i,r,s,n)}))}get boundingBox(){if(!this._boundingBox){const e=(0,se.B)();this.components.forEach((t=>{(0,u.r)(t.boundingInfo)&&((0,se.h)(e,t.boundingInfo.bbMin),(0,se.h)(e,t.boundingInfo.bbMax))})),this._boundingBox=e}return this._boundingBox}get boundingSphere(){if(!this._boundingSphere){const e=this.boundingBox,t=(0,v.n)();(0,se.p)(e,t),this._boundingSphere={center:t,radius:.5*(0,se.g)(e)}}return this._boundingSphere}get triangleCount(){return this.components.reduce(((e,t)=>e+t.triangleCount),0)}}class N_{constructor(e,t,i){this._elementSize=t,this._buffer=V.h.createVertex(e,35044),this.resize(i)}destroy(){this._buffer.dispose()}get elementSize(){return this._elementSize}get capacity(){return this._capacity}get array(){return this._array}get buffer(){return this._buffer}get memoryUsage(){return{cpu:this._capacity*this._elementSize,gpu:this._capacity*this._elementSize}}copyRange(e,t,i,r=0){const s=new Uint8Array(this.array,e*this.elementSize,(t-e)*this.elementSize);new Uint8Array(i.array,r*this.elementSize).set(s)}transferAll(){this._buffer.setData(this._array)}transferRange(e,t){const i=e*this._elementSize,r=t*this._elementSize;this._buffer.setSubData(this._array,i,i,r)}resize(e){const t=e*this._elementSize,i=new ArrayBuffer(t);this._array&&(e>=this._capacity?new Uint8Array(i).set(new Uint8Array(this._array)):new Uint8Array(i).set(new Uint8Array(this._array).subarray(0,e*this._elementSize))),this._array=i,this._buffer.setData(t),this._capacity=e}}class j_{constructor(e){this.modelOriginHi=e.getField("modelOriginHi",de.i),this.modelOriginLo=e.getField("modelOriginLo",de.i),this.model=e.getField("model",de.l),this.modelNormal=e.getField("modelNormal",de.l),this.color=e.getField("instanceColor",de.c),this.featureAttribute=e.getField("instanceFeatureAttribute",de.c)}}class H_{constructor(e,t){this._headIndex=0,this._tailIndex=0,this._captureFirstIndex=!0,this._updating=!1,this._prevHeadIndex=0,this._resized=!1,this._rctx=e,this._instanceBufferLayout=t,this._elementSize=t.stride,this._capacity=1}destroy(){this._buffer&&this._buffer.destroy()}get buffer(){return this._buffer.buffer}get view(){return this._view}get capacity(){return this._capacity}get size(){const e=this._headIndex,t=this._tailIndex;return e>=t?e-t:e+this._capacity-t}get isEmpty(){return this._headIndex===this._tailIndex}get isFull(){return this._tailIndex===(this._headIndex+1)%this._capacity}get headIndex(){return this._headIndex}get tailIndex(){return this._tailIndex}get firstIndex(){return this._firstIndex}get memoryUsage(){return this._buffer?this._buffer.memoryUsage:{cpu:0,gpu:0}}reset(){this._headIndex=0,this._tailIndex=0,this._firstIndex=null}startUpdateCylce(){this._captureFirstIndex=!0}beginUpdate(){(0,S.i)(!this._updating,"already updating"),this._updating=!0,this._prevHeadIndex=this._headIndex}endUpdate(){(0,S.i)(this._updating,"not updating"),this.size<Z_*this.capacity&&this.shrink(),this._resized?(this._buffer.transferAll(),this._resized=!1):this.transferRange(this._prevHeadIndex,this._headIndex),this._updating=!1}allocateHead(){(0,S.i)(this._updating,"not updating"),this.isFull&&this.grow();const e=this.headIndex;return this._captureFirstIndex&&(this._firstIndex=e,this._captureFirstIndex=!1),this.incrementHead(),(0,S.i)(this._headIndex!==this._tailIndex,"invalid pointers"),e}freeTail(){(0,S.i)(this._updating,"not updating"),(0,S.i)(this.size>0,"invalid size");const e=this._tailIndex===this._firstIndex;this.incrementTail(),e&&(this._firstIndex=this._tailIndex)}grow(){const e=Math.max(W_,Math.floor(this._capacity*Q_));this.resize(e)}shrink(){const e=Math.max(W_,Math.floor(this._capacity*Y_));this.resize(e)}resize(e){if((0,S.i)(this._updating,"not updating"),e===this._capacity)return;const t=new N_(this._rctx,this._elementSize,e);if(this._buffer){this._firstIndex&&(this._firstIndex=(this._firstIndex+this._capacity-this._tailIndex)%this._capacity);const e=this.size,i=this.compactInstances(t);(0,S.i)(i===e,"invalid compaction"),this._buffer.destroy(),this._tailIndex=0,this._headIndex=i,this._prevHeadIndex=0}this._resized=!0,this._capacity=e,this._buffer=t,this._view=new j_(this._instanceBufferLayout.createView(this._buffer.array))}compactInstances(e){const t=this._headIndex,i=this._tailIndex;return i<t?(this._buffer.copyRange(i,t,e),t-i):i>t?(this._buffer.copyRange(i,this._capacity,e),t>0&&this._buffer.copyRange(0,t,e,this._capacity-i),t+(this._capacity-i)):0}incrementHead(e=1){this._headIndex=(this._headIndex+e)%this._capacity}incrementTail(e=1){this._tailIndex=(this._tailIndex+e)%this._capacity}transferRange(e,t){e<t?this._buffer.transferRange(e,t):e>t&&(t>0&&this._buffer.transferRange(0,t),this._buffer.transferRange(e,this._capacity))}}const W_=1024,Q_=2,Z_=.3,Y_=.5;class X_{constructor(e,t,i,r){this.type="Lod",this.isGround=!1,this._inverseViewport=(0,N.n)(),this._levels=[],this._defaultRenderInstanceData=[],this._highlightRenderInstanceData=[],this._instanceIndex=0,this._slicePlane=!1,this._enableLevelSelection=!0,this._lastCamera=new Ia,this._updateCyclesWithStaticCamera=-1,this._needFullCycle=!1,this.canRender=!0,this._symbol=e,this._optionalFields=t,this._metadata=i,this._instanceBufferLayout=S.aR.getInstanceBufferLayout({instancedDoublePrecision:!0,instanced:t}),this._glInstanceBufferLayout=(0,U.t)(this._instanceBufferLayout,1),this._instanceData=new E_(this._optionalFields,r),this._instanceData.on("instance-added",(()=>{this.requestUpdateCycle()})),this._instanceData.on("instance-removed",(()=>{this.requestUpdateCycle()})),this._instanceData.on("instance-transform-changed",(e=>{this.requestUpdateCycle(),this._metadata.notifyGraphicGeometryChanged(e.index)})),this._instanceData.on("instance-visibility-changed",(e=>{this.requestUpdateCycle(!0),this._metadata.notifyGraphicVisibilityChanged(e.index)})),this._instanceData.on("instance-highlight-changed",(()=>{this.requestUpdateCycle(!0)})),this._enableLevelSelection=this._symbol.levels.length>1}get levels(){return this._levels}get baseBoundingBox(){return this._levels[this._levels.length-1].boundingBox}get baseBoundingSphere(){return this._levels[this._levels.length-1].boundingSphere}get baseMaterial(){return this._levels[this._levels.length-1].components[0].material}get slicePlane(){return this._slicePlane}set slicePlane(e){this._slicePlane=e}get intersectionHandlerId(){return this._metadata.layerUid}get instanceData(){return this._instanceData}get memoryUsage(){const e={cpu:0,gpu:0};return this._defaultRenderInstanceData.forEach((t=>{const i=t.memoryUsage;e.cpu+=i.cpu,e.gpu+=i.gpu})),this._highlightRenderInstanceData.forEach((t=>{const i=t.memoryUsage;e.cpu+=i.cpu,e.gpu+=i.gpu})),e}get renderStats(){const e=this._instanceData.size,t=[];return this._levels.forEach(((e,i)=>{const r=this._defaultRenderInstanceData[i],s=this._highlightRenderInstanceData[i],n=r.size+s.size,a=e.triangleCount;t.push({renderedInstances:n,renderedTriangles:n*a,trianglesPerInstance:a})})),{totalInstances:e,renderedInstances:t.reduce(((e,t)=>e+t.renderedInstances),0),renderedTriangles:t.reduce(((e,t)=>e+t.renderedTriangles),0),levels:t}}async initializeRenderContext(e,t){this._context=e;const i=e.renderContext.rctx;this._levels=await(0,h.c)(this._symbol.levels.map((r=>(this._defaultRenderInstanceData.push(new H_(i,this._instanceBufferLayout)),this._highlightRenderInstanceData.push(new H_(i,this._instanceBufferLayout)),k_.create(e,r,t))))),this._levelSelector=function(e){const t=e.baseBoundingSphere.radius,i=e.levels.map((e=>e.minScreenSpaceRadius));return new B_(t,i)}(this)}uninitializeRenderContext(){this.invalidateOctree(),this._levels.forEach((e=>e.destroy())),this._defaultRenderInstanceData.forEach((e=>e.destroy())),this._highlightRenderInstanceData.forEach((e=>e.destroy()))}get slots(){return[4,6]}get needsHighlight(){return this._highlightRenderInstanceData.reduce(((e,t)=>e+t.size),0)>0}prepareRender(e,t){if(Ih.LOD_INSTANCE_RENDERER_DISABLE_UPDATES)return;if(this._enableLevelSelection){const e=t.equals(this._lastCamera);this._lastCamera.copyFrom(t),e||this.requestUpdateCycle()}const i=this._needFullCycle?this._instanceData.size:2e3;this._needFullCycle=!1,this.updateInstances(t,i),this.needsUpdates&&this._context.requestRender()}render(e){const t=e.rctx,i=4===e.slot?3:6===e.slot?5:null;if(!i)return;if(!this.baseMaterial.isVisible()||!this.baseMaterial.isVisibleInPass(e.pass))return!1;const r=e.camera;this._inverseViewport[0]=1/r.fullViewport[2],this._inverseViewport[1]=1/r.fullViewport[3];const s={slot:i,origin:[0,0,0],camera:r,inverseViewport:this._inverseViewport,shadowMap:e.shadowMap,shadowMappingEnabled:e.shadowMap.enabled,ssaoHelper:e.ssaoHelper,ssaoEnabled:e.ssaoHelper.enabled,screenToWorldRatio:null,screenToWorldRatioGlobalWM:null,slicePlane:e.sliceHelper&&e.sliceHelper.plane,hudVisibilityTexture:e.offscreenRenderingHelper?e.offscreenRenderingHelper.hudVisibilityTexture:null,highlightDepthTexture:e.offscreenRenderingHelper?e.offscreenRenderingHelper.depthTexture:null,hasOccludees:!1,linearDepthTexture:null,lastFrameColorTexture:null,reprojectionMat:null,ssrEnabled:!1,lighting:e.scenelightingData,transparencyPassType:e.transparencyPassType,terrainLinearDepthTexture:e.multipassTerrainParams.terrainLinearDepthTexture,geometryLinearDepthTexture:e.multipassGeometryParams.geometryLinearDepthTexture,multipassTerrainEnabled:e.multipassTerrainParams.multipassTerrainEnabled,cullAboveGround:e.multipassTerrainParams.cullAboveGround,multipassGeometryEnabled:e.multipassGeometryParams.multipassGeometryEnabled,highlightColorTexture:null};t.bindVAO();const n=5!==e.pass&&7!==e.pass,a=6!==e.pass;return n&&this._renderComponents(e,i,s,this._defaultRenderInstanceData),a&&this._renderComponents(e,i,s,this._highlightRenderInstanceData),!0}intersect(e,t,i,r){if(!this.baseMaterial.isVisible())return;const s=(0,v.n)();(0,v.c)(s,r,i);const n=s=>{this._instanceData.getCombinedModelTransform(s,ex),e.transform.set(ex),(0,v.I)(tx,i,e.transform.inverse),(0,v.I)(ix,r,e.transform.inverse);const n=this._instanceData.getState(s),a=this._instanceData.getLodLevel(s);(0,S.i)(n&O_.ACTIVE,"invalid instance state"),(0,S.i)(a>=0&&a<this._levels.length,"invaid lod level"),this._levels[a].intersect(e,t,tx,ix,s,this._metadata)};this.baseMaterial.params.verticalOffset?this.octree.forEach(n):this.octree.forEachAlongRay(i,s,n)}queryDepthRange(e){return this.queryDepthRangeOctree(e)}notifyShaderTransformationChanged(){this.invalidateOctree()}requestUpdateCycle(e=!1){this._updateCyclesWithStaticCamera=-1,e&&(this._needFullCycle=!0),this.needsUpdates&&this._context.requestRender()}get needsUpdates(){return this._instanceData.size>0&&this._updateCyclesWithStaticCamera<1}get octree(){return this._octree||(this._octree=this.buildOctree()),this._octree}invalidateOctree(){this._octree&&(this._octree.destroy(),this._octree=null)}buildOctree(){const e=new G_(this._instanceData,this.baseBoundingSphere),t=this._instanceData,i=t.view?t.view.state:null;for(let t=0;t<this._instanceData.capacity;++t)i.get(t)&O_.ACTIVE&&e.addInstance(t);return e}queryDepthRangeOctree(e){const t=e.eye,i=e.viewForward,r=this.octree.findClosest(i,1,e.frustum),s=this.octree.findClosest(i,-1,e.frustum);if(null!=r&&null!=s){this._instanceData.view.boundingSphere.getVec(r,J_),(0,v.c)(J_,J_,t);const n=(0,v.z)(J_,i)-J_[3];this._instanceData.view.boundingSphere.getVec(s,J_),(0,v.c)(J_,J_,t);const a=(0,v.z)(J_,i)+J_[3];return{near:Math.max(e.near,n),far:Math.min(e.far,a)}}return{near:1/0,far:-1/0}}startUpdateCycle(){this._updateCyclesWithStaticCamera++,this._defaultRenderInstanceData.forEach((e=>{e.startUpdateCylce()})),this._highlightRenderInstanceData.forEach((e=>{e.startUpdateCylce()})),this.needsUpdates&&this._context.requestRender()}updateInstances(e,t){const i=this._enableLevelSelection,r=this._levelSelector;r.updateCamera(e),this._defaultRenderInstanceData.forEach((e=>{e.beginUpdate()})),this._highlightRenderInstanceData.forEach((e=>{e.beginUpdate()}));const s=this._instanceData,n=this._instanceData.view,a=s.size,o=s.capacity;let l=this._instanceIndex;t=Math.min(a,t);for(let e=0;e<t;++e){0===l&&this.startUpdateCycle();const e=n.state.get(l);let a=0;if(!(e&O_.ALLOCATED)){l=(l+1)%o,t++;continue}const c=n.lodLevel.get(l);if(e&O_.DEFAULT_ACTIVE&&this._defaultRenderInstanceData[c].freeTail(),e&O_.HIGHLIGHT_ACTIVE&&this._highlightRenderInstanceData[c].freeTail(),e&O_.REMOVE)s.freeInstance(l);else if(e&O_.VISIBLE){let t=0;i&&(n.modelOrigin.getVec(l,K_),t=r.selectLevel(K_,s.getCombinedMedianScaleFactor(l))),a=e&~(O_.ACTIVE|O_.TRANSFORM_CHANGED),t>=0&&(e&O_.HIGHLIGHT?($_(this._highlightRenderInstanceData[t],n,l),a|=O_.HIGHLIGHT_ACTIVE):($_(this._defaultRenderInstanceData[t],n,l),a|=O_.DEFAULT_ACTIVE)),n.state.set(l,a),n.lodLevel.set(l,t)}else a=e&~(O_.ACTIVE|O_.TRANSFORM_CHANGED),n.state.set(l,a);if(this._octree){const t=!!(e&O_.ACTIVE),i=!!(a&O_.ACTIVE);!t&&i?this._octree.addInstance(l):t&&!i?this._octree.removeInstance(l):t&&i&&e&O_.TRANSFORM_CHANGED&&(this._octree.removeInstance(l),this._octree.addInstance(l))}l=(l+1)%o}this._instanceIndex=l,this._defaultRenderInstanceData.forEach((e=>{e.endUpdate()})),this._highlightRenderInstanceData.forEach((e=>{e.endUpdate()}))}_renderComponents(e,t,i,r){this.levels.forEach(((s,n)=>{s.components.forEach((s=>{this._renderComponent(e,t,i,r[n],s,n)}))}))}_renderComponent(e,t,i,r,s,n){const a=s.glMaterials.get(e.pass);if(!a||!a.beginSlot(t)||0===r.size)return;const o=e.rctx,l=o.capabilities.instancing;a.ensureParameters(i);const c=a.technique,h=c.program,d=a.getPipelineState(t);o.setPipelineState(d),o.useProgram(h),a.bind(i),o.bindVAO(s.vao),c.ensureAttributeLocations(s.vao),e.isHighlightPass&&(0,S.a1)(h,i),c.bindDraw(i,{},{}),Ih.LOD_INSTANCE_RENDERER_COLORIZE_BY_LEVEL&&0===e.pass&&(h.setUniform4fv("externalColor",rx[Math.min(n,rx.length-1)]),h.setUniform1i("colorMixMode",S.aY.replace));const u=r.capacity,p=r.headIndex,m=r.tailIndex,f=r.firstIndex,g=this._glInstanceBufferLayout,v=(e,t)=>{(0,V.c)(o,S.o,r.buffer,g,e),l.drawArraysInstanced(c.primitiveType,0,s.vertexCount,t-e),(0,V.s)(o,S.o,r.buffer,g)};s.material.params.transparent&&null!=f?p>m?((0,S.i)(f>=m&&f<=p,"invalid firstIndex"),v(f,p),v(m,f)):p<m&&(f<=p?((0,S.i)(f>=0&&f<=p,"invalid firstIndex"),v(f,p),v(m,u),v(0,f)):((0,S.i)(f>=m&&f<=u,"invalid firstIndex"),v(f,u),v(0,p),v(m,f))):p>m?v(m,p):p<m&&(v(0,p),v(m,u)),o.bindVAO(null)}}function $_(e,t,i){const r=e.allocateHead();!function(e,t,i,r){(0,S.aZ)(e.modelOrigin,t,i.modelOriginHi,i.modelOriginLo,r),i.model.copyFrom(r,e.model,t),i.modelNormal.copyFrom(r,e.modelNormal,t),e.color&&i.color&&i.color.copyFrom(r,e.color,t),e.featureAttribute&&i.featureAttribute&&i.featureAttribute.copyFrom(r,e.featureAttribute,t)}(t,i,e.view,r)}const K_=(0,v.n)(),J_=(0,w.n)(),ex=(0,T.e)(),tx=(0,v.n)(),ix=(0,v.n)(),rx=[[1,0,1,1],[0,0,1,1],[0,1,0,1],[1,1,0,1],[1,0,0,1]],sx=(0,v.n)(),nx=(0,T.e)(),ax=(0,T.e)(),ox=(0,w.n)(),lx={verticalDistanceToGround:0,sampledElevation:0};function cx(e,t,i,r,s){return e[0]=t,e[1]=i,e[2]=r,e[3]=s,e}function hx(e,t,i){const r=t[0],s=t[1],n=t[2],a=t[3],o=i[0],l=i[1],c=i[2],h=i[3];return e[0]=r*o+n*l,e[1]=s*o+a*l,e[2]=r*c+n*h,e[3]=s*c+a*h,e}function dx(e,t,i){return e[0]=t[0]-i[0],e[1]=t[1]-i[1],e[2]=t[2]-i[2],e[3]=t[3]-i[3],e}const ux=hx,px=dx;Object.freeze({__proto__:null,copy:function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e},identity:function(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=1,e},set:cx,transpose:function(e,t){if(e===t){const i=t[1];e[1]=t[2],e[2]=i}else e[0]=t[0],e[1]=t[2],e[2]=t[1],e[3]=t[3];return e},invert:function(e,t){const i=t[0],r=t[1],s=t[2],n=t[3];let a=i*n-s*r;return a?(a=1/a,e[0]=n*a,e[1]=-r*a,e[2]=-s*a,e[3]=i*a,e):null},adjoint:function(e,t){const i=t[0];return e[0]=t[3],e[1]=-t[1],e[2]=-t[2],e[3]=i,e},determinant:function(e){return e[0]*e[3]-e[2]*e[1]},multiply:hx,rotate:function(e,t,i){const r=t[0],s=t[1],n=t[2],a=t[3],o=Math.sin(i),l=Math.cos(i);return e[0]=r*l+n*o,e[1]=s*l+a*o,e[2]=r*-o+n*l,e[3]=s*-o+a*l,e},scale:function(e,t,i){const r=t[0],s=t[1],n=t[2],a=t[3],o=i[0],l=i[1];return e[0]=r*o,e[1]=s*o,e[2]=n*l,e[3]=a*l,e},fromRotation:function(e,t){const i=Math.sin(t),r=Math.cos(t);return e[0]=r,e[1]=i,e[2]=-i,e[3]=r,e},fromScaling:function(e,t){return e[0]=t[0],e[1]=0,e[2]=0,e[3]=t[1],e},str:function(e){return"mat2("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+")"},frob:function(e){return Math.sqrt(e[0]**2+e[1]**2+e[2]**2+e[3]**2)},LDU:function(e,t,i,r){return e[2]=r[2]/r[0],i[0]=r[0],i[1]=r[1],i[3]=r[3]-e[2]*i[1],[e,t,i]},add:function(e,t,i){return e[0]=t[0]+i[0],e[1]=t[1]+i[1],e[2]=t[2]+i[2],e[3]=t[3]+i[3],e},subtract:dx,exactEquals:function(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]},equals:function(e,t){const i=e[0],r=e[1],s=e[2],n=e[3],a=t[0],o=t[1],l=t[2],c=t[3];return Math.abs(i-a)<=v.f*Math.max(1,Math.abs(i),Math.abs(a))&&Math.abs(r-o)<=v.f*Math.max(1,Math.abs(r),Math.abs(o))&&Math.abs(s-l)<=v.f*Math.max(1,Math.abs(s),Math.abs(l))&&Math.abs(n-c)<=v.f*Math.max(1,Math.abs(n),Math.abs(c))},multiplyScalar:function(e,t,i){return e[0]=t[0]*i,e[1]=t[1]*i,e[2]=t[2]*i,e[3]=t[3]*i,e},multiplyScalarAndAdd:function(e,t,i,r){return e[0]=t[0]+i[0]*r,e[1]=t[1]+i[1]*r,e[2]=t[2]+i[2]*r,e[3]=t[3]+i[3]*r,e},mul:ux,sub:px});class mx extends S.u{constructor(e,t,i,r,s,n){super(e,t),this.path=i,this.geometrySR=r,this.upVectorAlignment=s,this.stencilWidth=n}}function fx(e){return"upVectorAlignment"in e}function gx(){return{up:(0,v.n)(),right:(0,v.n)()}}function vx(e,t,i){(0,v.I)(e.up,t.up,i),(0,v.I)(e.right,t.right,i)}function yx(e,t,i){(0,k.r)(e,(0,v.z)(i,t.right),(0,v.z)(i,t.up))}Object.freeze({__proto__:null,create:function(){return[1,0,0,1]},clone:function(e){return[e[0],e[1],e[2],e[3]]},fromValues:function(e,t,i,r){return[e,t,i,r]},createView:function(e,t){return new Float64Array(e,t,4)}});class _x{constructor(){this.pos=(0,v.n)(),this.posES=(0,v.n)(),this.posGS=(0,v.n)(),this.vRight=(0,v.n)(),this.vLeft=(0,v.n)(),this.frame=gx(),this.rotationFrame=gx(),this.rotationRight=(0,N.n)(),this.rotationAngle=0,this.miterStretch=[1,0,0,1]}setFrameFromUpVector(e){(0,v.h)(this.frame.up,e),(0,v.u)(Ux,this.vLeft,this.vRight),(0,v.j)(Ux,Ux),(0,v.d)(Vx,this.frame.up,(0,v.z)(Ux,this.frame.up)),(0,v.c)(qx,Ux,Vx),(0,v.j)(qx,qx),(0,v._)(this.frame.right,qx,this.frame.up)}computeRotationAxisAndAngleFromUpVector(){(0,v.h)(this.rotationFrame.up,this.frame.up),(0,v.h)(this.rotationFrame.right,this.frame.right),(0,k.r)(this.rotationRight,1,0),(0,v.d)(Vx,this.frame.up,(0,v.z)(this.frame.up,this.vLeft)),(0,v.c)(Vx,this.vLeft,Vx),(0,v.E)(Vx,Vx),(0,v.j)(Vx,Vx),(0,v.d)(Ux,this.frame.up,(0,v.z)(this.frame.up,this.vRight)),(0,v.c)(Ux,this.vRight,Ux),(0,v.j)(Ux,Ux),(0,v._)(Gx,this.rotationFrame.up,this.vLeft);const e=(0,v.e)((0,v.z)(Gx,this.vRight));if(this.rotationAngle=e*(Math.PI-(0,v.x)((0,v.z)(Vx,Ux))),Math.abs(this.rotationAngle)>0){const e=(0,v.Q)(Math.cos(.5*this.rotationAngle));cx(this.miterStretch,e-1+1,0,0,1)}const t=Math.PI-this.rotationAngle;this.maxStretchDistance=Math.abs(Math.min(this.vLeftLength,this.vRightLength)/Math.cos(.5*t))}}class xx{constructor(){this.vertices=[],this.vertexIndices=[],this.vertexNormals=[],this.poles=[],this.poleIndices=[],this.uvs=null,this.uvIndices=null}addVertex(e,t){return this.vertices.push((0,N.r)(e)),this.vertexNormals.push((0,N.r)(t)),this.vertices.length-1}addUV(e){return this.uvs||(this.uvs=[],this.uvIndices=[]),this.uvs.push(e),this.uvs.length-1}addPole(e,t=null){return this.poles.push({position:(0,N.r)(e),normal:t?(0,N.r)(t):null}),this.poles.length-1}addSegment(e,t=null,i=null){this.vertexIndices.push(e.v0),this.vertexIndices.push(e.v1),t&&(this.uvIndices.push(t.v0),this.uvIndices.push(t.v1)),i&&(this.poleIndices.push(i.v0),this.poleIndices.push(i.v1))}get numSegments(){return this.vertexIndices.length/2}hasUV(){return null!=this.uvs}translate(e,t){for(const i of this.vertices)i[0]+=e,i[1]+=t;for(const i of this.poles)i.position[0]+=e,i.position[1]+=t}static circle(e=20){const t=new xx,i={v0:0,v1:0};t.addPole((0,N.t)(0,0));for(let i=0;i<e;++i){const r=2*i*Math.PI/e,s=Math.cos(r),n=Math.sin(r),a=(0,N.t)(.5*s,.5*n),o=(0,N.t)(s,n);t.addVertex(a,o),t.addUV(i/e)}t.addUV(1);for(let r=0;r<e-1;++r){const e={v0:r,v1:r+1},s=e;t.addSegment(e,s,i)}const r={v0:e-1,v1:0},s={v0:e-1,v1:e};return t.addSegment(r,s,i),t}static rect(){const e=new xx,t=(0,N.t)(-.5,-.5),i=(0,N.t)(.5,-.5),r=(0,N.t)(.5,.5),s=(0,N.t)(-.5,.5),n=(0,N.t)(0,-1),a=(0,N.t)(1,0),o=(0,N.t)(0,1),l=(0,N.t)(-1,0);e.addUV(0),e.addUV(1),e.addPole((0,N.t)(0,.5),o),e.addPole((0,N.t)(0,.5)),e.addPole((0,N.t)(0,-.5)),e.addPole((0,N.t)(0,-.5),n);const c={v0:0,v1:1};return e.addVertex(t,n),e.addVertex(i,n),e.addSegment({v0:0,v1:1},c,{v0:3,v1:3}),e.addVertex(i,a),e.addVertex(r,a),e.addSegment({v0:2,v1:3},c,{v0:2,v1:1}),e.addVertex(r,o),e.addVertex(s,o),e.addSegment({v0:4,v1:5},c,{v0:0,v1:0}),e.addVertex(s,l),e.addVertex(t,l),e.addSegment({v0:6,v1:7},c,{v0:1,v1:2}),e}}class bx{constructor(e){this.vertices=[],this.offset=(0,v.n)(),this.xform=(0,T.e)(),this.vertices=e;const t=Math.floor((e.length-1)/2);(0,v.h)(this.offset,this.vertices[t].pos);for(const e of this.vertices)(0,v.c)(e.pos,e.pos,this.offset);(0,C.c)(this.xform,this.xform,this.offset),this.updatePathVertexInformation()}updatePathVertexInformation(){const e=this.vertices.length;let t=this.vertices[0];t.index=0,(0,v.a)(t.vLeft,0,0,0),t.vLeftLength=0,(0,v.c)(t.vRight,this.vertices[1].pos,t.pos),t.vRightLength=(0,v.s)(t.vRight),(0,v.j)(t.vRight,t.vRight);let i=t;for(let r=1;r<e;++r)t=this.vertices[r],t.index=r,(0,v.h)(t.vLeft,i.vRight),t.vLeftLength=i.vRightLength,r<e-1?((0,v.c)(t.vRight,this.vertices[r+1].pos,t.pos),t.vRightLength=(0,v.s)(t.vRight),(0,v.j)(t.vRight,t.vRight)):((0,v.h)(t.vRight,t.vLeft),t.vRightLength=t.vLeftLength),i=t}}class wx{numProfilesPerJoin(){return 1}extrude(e,t,i){for(let r=0;r<t.vertices.length;++r)i(e.index,e.frame,t.vertices[r],t.vertexNormals[r],!1)}}class Cx{constructor(e=.8*Math.PI,t=1){this.cutoffAngle=e,this.numBendSubdivisions=t}numProfilesPerJoin(){return this.numBendSubdivisions+1}extrude(e,t,i){const r=kx;if(Math.abs(e.rotationAngle)>=this.cutoffAngle)for(let s=0;s<this.numBendSubdivisions+1;++s){(0,C.r)(Nx),(0,C.f)(Nx,Nx,.5*-e.rotationAngle+s*e.rotationAngle/this.numBendSubdivisions,e.rotationFrame.up),vx(r,e.frame,Nx);for(let s=0;s<t.vertices.length;++s)(0,k._)(t.vertices[s],e.rotationRight)*e.rotationAngle>=0?i(e.index,r,t.vertices[s],t.vertexNormals[s],!1):((0,k.A)(Ix,t.vertices[s],e.miterStretch),i(e.index,e.frame,Ix,t.vertexNormals[s],!0))}else for(let r=0;r<this.numBendSubdivisions+1;++r)for(let r=0;r<t.vertices.length;++r){const s=(0,k._)(t.vertices[r],e.rotationRight)*e.rotationAngle>=0;(0,k.A)(Ix,t.vertices[r],e.miterStretch),i(e.index,e.frame,Ix,t.vertexNormals[r],!s)}}}const Tx={generateUV:!1};class Sx{rebuildConnectingProfileGeometry(e,t,i){for(let r=0;r<t.vertices.length;++r)i(e.index,e.frame,t.vertices[r],t.vertexNormals[r],0,0)}}class Px extends Sx{constructor(){super()}getNumVertices(){return 0}getNumIndices(){return 0}rebuildCapGeometry(){}buildTopology(){}}class Rx extends Sx{constructor(e,t=0,i=!1){super(),this.profile=e,this.profilePlaneOffset=t,this.flip=i}getNumVertices(){return this.profile.vertices.length}getNumIndices(){return 3*this.profile.numSegments}rebuildConnectingProfileGeometry(e,t,i){for(let r=0;r<t.vertices.length;++r)i(e.index,e.frame,t.vertices[r],t.vertexNormals[r],this.profilePlaneOffset,0)}rebuildCapGeometry(e,t){const i=Lx;(0,k.r)(i,0,0);const r=this.flip?1:-1;for(let s=0;s<this.profile.vertices.length;++s)t(e.index,e.frame,this.profile.vertices[s],i,this.profilePlaneOffset,r)}buildTopology(e,t){const i=this.vertexBufferStart+this.profile.vertexIndices[0];for(let e=1;e<this.profile.numSegments;++e){const r=this.profile.vertexIndices[2*e+0],s=this.profile.vertexIndices[2*e+1],n=this.vertexBufferStart+r,a=this.vertexBufferStart+s;this.flip?t(a,n,i):t(i,n,a)}}}class Ax extends Sx{constructor(e){super(),this.flip=!1,this.sign=0,this.breakNormals=!1,this.numSegments=3,this.profile=e.profile,this.flip=e.flip,this.sign=this.flip?1:-1,this.breakNormals=e.breakNormals,this.numSegments=e.subdivisions}getNumVertices(){let e=0;return e=this.profile.vertices.length*(this.numSegments-1),this.breakNormals&&(e+=this.profile.vertices.length),e+=this.profile.poles.length,e}getNumIndices(){let e=0;e+=2*this.profile.numSegments*(this.numSegments-1);for(let t=0;t<this.profile.numSegments;++t){const i=this.profile.vertexIndices[2*t+0],r=this.profile.vertexIndices[2*t+1];this.profile.poleIndices[i]===this.profile.poleIndices[r]?e+=1:e+=2}return 3*e}rebuildCapGeometry(e,t){const i=e.frame,r=.5*this.sign,s=Ix,n=Lx;(0,k.r)(n,0,0);for(let s=0;s<this.profile.poles.length;++s){const a=this.profile.poles[s];a.normal?t(e.index,i,a.position,a.normal,r,0):t(e.index,i,a.position,n,r,this.sign)}if(this.breakNormals)for(let r=0;r<this.profile.vertices.length;++r)t(e.index,i,this.profile.vertices[r],this.profile.vertexNormals[r],0,0);for(let a=0;a<this.numSegments-1;++a){const o=(1-(a+1)/this.numSegments)*Math.PI*.5,l=Math.sin(o),c=Math.cos(o);for(let a=0;a<this.profile.vertices.length;++a){const o=this.profile.poles[this.profile.poleIndices[a]];(0,k.o)(s,this.profile.vertices[a],o.position),(0,k.l)(s,s,l),o.normal?((0,k.s)(s,s,o.position),t(e.index,i,s,o.normal,r*c,0)):((0,k.g)(n,s),(0,k.l)(n,n,l),(0,k.s)(s,s,o.position),t(e.index,i,s,n,r*c,this.sign*c))}}}buildTopology(e,t){const i=this.breakNormals?this.vertexBufferStart+this.profile.poles.length:this.firstProfileVertexIndex,r=this.breakNormals?this.vertexBufferStart+this.profile.poles.length+this.profile.vertices.length:this.vertexBufferStart+this.profile.poles.length;for(let e=0;e<this.profile.numSegments;++e){const s=this.profile.vertexIndices[2*e+0],n=this.profile.vertexIndices[2*e+1],a=this.vertexBufferStart+this.profile.poleIndices[s],o=this.vertexBufferStart+this.profile.poleIndices[n];let l=i+s,c=i+n;for(let e=0;e<this.numSegments-1;++e){const i=r+e*this.profile.vertices.length+s,a=r+e*this.profile.vertices.length+n;this.flip?(t(i,c,l),t(c,i,a)):(t(l,c,i),t(a,i,c)),l=i,c=a}this.flip?(t(a,c,l),a!==o&&t(a,o,c)):(t(l,c,a),a!==o&&t(c,o,a))}}}class Mx{constructor(e,t,i,r,s,n=Tx){this.options=n,this._extrusionVertexCount=0,this._triangleCount=0,this.numExtrusionProfiles=0,this.numVerticesTotal=0,this.numNormalsTotal=0,this.numUVTotal=0,this.profile=t,this.path=e,this.extruder=i,this.startCap=r,this.endCap=s;const a=this.path.vertices.length-2;this.numExtrusionProfiles=i.numProfilesPerJoin()*a+2,this.numVerticesTotal=t.vertices.length*this.numExtrusionProfiles,this.numNormalsTotal=this.numVerticesTotal,this.startCap.vertexBufferStart=this.numVerticesTotal;const o=this.startCap.getNumVertices();this.numVerticesTotal+=o,this.numNormalsTotal+=o,this.endCap.vertexBufferStart=this.numVerticesTotal;const l=this.endCap.getNumVertices();this.numVerticesTotal+=l,this.numNormalsTotal+=l,this.pathVertexData=new Float32Array(1*this.numVerticesTotal),this.profileRightAxisData=new Float32Array(4*this.numVerticesTotal),this.profileUpAxisData=new Float32Array(4*this.numVerticesTotal),this.profileVertexAndNormalData=new Float32Array(4*this.numVerticesTotal),this.profile.hasUV()&&this.options.generateUV&&(this.numUVTotal=this.profile.uvs.length,this.uvData=new Float32Array(2*this.numUVTotal)),this.originData=new Float32Array(3*this.path.vertices.length),this.rebuildGeometry(),this.buildTopology()}emitVertex(e,t,i,r,s){if(this.profileRightAxisData[4*this._extrusionVertexCount+0]=t.right[0],this.profileRightAxisData[4*this._extrusionVertexCount+1]=t.right[1],this.profileRightAxisData[4*this._extrusionVertexCount+2]=t.right[2],this.profileUpAxisData[4*this._extrusionVertexCount+0]=t.up[0],this.profileUpAxisData[4*this._extrusionVertexCount+1]=t.up[1],this.profileUpAxisData[4*this._extrusionVertexCount+2]=t.up[2],this.profileVertexAndNormalData[4*this._extrusionVertexCount+0]=i[0],this.profileVertexAndNormalData[4*this._extrusionVertexCount+1]=i[1],this.profileVertexAndNormalData[4*this._extrusionVertexCount+2]=r[0],this.profileVertexAndNormalData[4*this._extrusionVertexCount+3]=r[1],this.pathVertexData[this._extrusionVertexCount]=e,s){const t=this.path.vertices[e];this.profileRightAxisData[4*this._extrusionVertexCount+3]=t.rotationRight[0]*t.maxStretchDistance,this.profileUpAxisData[4*this._extrusionVertexCount+3]=t.rotationRight[1]*t.maxStretchDistance}else this.profileRightAxisData[4*this._extrusionVertexCount+3]=0,this.profileUpAxisData[4*this._extrusionVertexCount+3]=0;++this._extrusionVertexCount}emitCapVertex(e,t,i,r,s,n){this.profileRightAxisData[4*this._extrusionVertexCount+0]=t.right[0],this.profileRightAxisData[4*this._extrusionVertexCount+1]=t.right[1],this.profileRightAxisData[4*this._extrusionVertexCount+2]=t.right[2],this.profileUpAxisData[4*this._extrusionVertexCount+0]=t.up[0],this.profileUpAxisData[4*this._extrusionVertexCount+1]=t.up[1],this.profileUpAxisData[4*this._extrusionVertexCount+2]=t.up[2],this.profileVertexAndNormalData[4*this._extrusionVertexCount+0]=i[0],this.profileVertexAndNormalData[4*this._extrusionVertexCount+1]=i[1],this.profileVertexAndNormalData[4*this._extrusionVertexCount+2]=r[0],this.profileVertexAndNormalData[4*this._extrusionVertexCount+3]=r[1],this.pathVertexData[this._extrusionVertexCount]=e,this.profileRightAxisData[4*this._extrusionVertexCount+3]=s,this.profileUpAxisData[4*this._extrusionVertexCount+3]=n,++this._extrusionVertexCount}emitTriangle(e,t,i){this.vertexIndices[3*this._triangleCount+0]=e,this.vertexIndices[3*this._triangleCount+1]=t,this.vertexIndices[3*this._triangleCount+2]=i,this.pathVertexIndices[3*this._triangleCount+0]=this.pathVertexData[e],this.pathVertexIndices[3*this._triangleCount+1]=this.pathVertexData[t],this.pathVertexIndices[3*this._triangleCount+2]=this.pathVertexData[i],this.normalIndices[3*this._triangleCount+0]=e,this.normalIndices[3*this._triangleCount+1]=t,this.normalIndices[3*this._triangleCount+2]=i,++this._triangleCount}rebuildGeometry(){const e=(e,t,i,r,s)=>this.emitVertex(e,t,i,r,s),t=(e,t,i,r,s,n)=>this.emitCapVertex(e,t,i,r,s,n);this._extrusionVertexCount=0;for(const e of this.path.vertices)this.originData[3*e.index+0]=e.pos[0],this.originData[3*e.index+1]=e.pos[1],this.originData[3*e.index+2]=e.pos[2];this.startCap.rebuildConnectingProfileGeometry(this.path.vertices[0],this.profile,t);for(let t=1;t<this.path.vertices.length-1;++t)this.extruder.extrude(this.path.vertices[t],this.profile,e);if(this.endCap.rebuildConnectingProfileGeometry(this.path.vertices[this.path.vertices.length-1],this.profile,t),this.startCap.rebuildCapGeometry(this.path.vertices[0],t),this.endCap.rebuildCapGeometry(this.path.vertices[this.path.vertices.length-1],t),this.profile.hasUV()&&this.options.generateUV)for(let e=0;e<this.profile.uvs.length;++e)this.uvData[2*e+0]=this.profile.uvs[e],this.uvData[2*e+1]=0}buildTopology(){const e=(e,t,i)=>this.emitTriangle(e,t,i);this._triangleCount=0;const t=this.profile.vertices.length,i=this.profile.numSegments,r=this.numExtrusionProfiles-1;let s=i*r*2*3;this.startCap.indexBufferStart=s,this.startCap.firstProfileVertexIndex=0,s+=this.startCap.getNumIndices(),this.endCap.indexBufferStart=s,this.endCap.firstProfileVertexIndex=t*(this.numExtrusionProfiles-1),s+=this.endCap.getNumIndices(),this.vertexIndices=new Uint32Array(s),this.normalIndices=new Uint32Array(s),this.pathVertexIndices=new Uint32Array(s),this.profile.hasUV()&&this.options.generateUV&&(this.uvIndices=new Uint32Array(s));for(let s=0;s<i;++s){const i=this.profile.vertexIndices[2*s],n=this.profile.vertexIndices[2*s+1];for(let s=0;s<r;++s){const r=s*t+i,a=(s+1)*t+n,o=s*t+n;e(r,(s+1)*t+i,a),e(r,a,o)}}this.startCap.buildTopology(this.path.vertices[0],e),this.endCap.buildTopology(this.path.vertices[this.path.vertices.length-1],e)}onPathChanged(){this.rebuildGeometry()}}class Ox{constructor(e){this.builder=e}get xform(){return this.builder.path.xform}onPathChanged(){this.builder.onPathChanged()}}class Dx extends Ox{constructor(e){super(e),this.vertexAttributePosition=null,this.vertexAttributeNormal=null,this.vertexAttributeColor=null,this.vertexAttributePosition=new Float32Array(3*this.builder.numVerticesTotal),this.vertexAttributeNormal=new Float32Array(3*this.builder.numNormalsTotal),this.vertexAttributeColor=new Uint8Array(4),this.vertexAttributeColor[0]=255,this.vertexAttributeColor[1]=255,this.vertexAttributeColor[2]=255,this.vertexAttributeColor[3]=255}bakeVertexColors(e){this.vertexAttributeColor[0]=255*e[0],this.vertexAttributeColor[1]=255*e[1],this.vertexAttributeColor[2]=255*e[2],this.vertexAttributeColor[3]=255*(e.length>3?e[3]:1)}bake(e){this.size=e;for(let t=0;t<this.builder.numVerticesTotal;++t){let i=this.builder.pathVertexData[t];const r=0===i||i===this.builder.path.vertices.length-1;i*=3;const s=zx;(0,v.a)(s,this.builder.originData[i++],this.builder.originData[i++],this.builder.originData[i]);const n=4*t,a=Vx,o=Ix,l=Ux,c=Gx,h=Bx;let d=0,u=0;if((0,v.a)(c,this.builder.profileRightAxisData[n],this.builder.profileRightAxisData[n+1],this.builder.profileRightAxisData[n+2]),(0,v.a)(h,this.builder.profileUpAxisData[n],this.builder.profileUpAxisData[n+1],this.builder.profileUpAxisData[n+2]),(0,k.r)(o,this.builder.profileVertexAndNormalData[n]*e[0],this.builder.profileVertexAndNormalData[n+1]*e[1]),r)(0,v._)(l,h,c),d=this.builder.profileRightAxisData[n+3]*e[0],u=this.builder.profileUpAxisData[n+3];else{const e=Lx,t=Fx;(0,k.r)(e,this.builder.profileRightAxisData[n+3],this.builder.profileUpAxisData[n+3]);const i=(0,k.b)(e);(0,k.g)(e,e);const r=(0,k._)(o,e);if(Math.abs(r)>i){(0,k.r)(t,-e[1],e[0]);const s=(0,k._)(o,t);(0,k.l)(e,e,i*(0,v.e)(r)),(0,k.l)(t,t,s),(0,k.s)(o,e,t)}(0,v.a)(l,0,0,0)}(0,v.a)(a,c[0]*o[0]+h[0]*o[1],c[1]*o[0]+h[1]*o[1],c[2]*o[0]+h[2]*o[1]),this.vertexAttributePosition[3*t+0]=s[0]+a[0]+l[0]*d,this.vertexAttributePosition[3*t+1]=s[1]+a[1]+l[1]*d,this.vertexAttributePosition[3*t+2]=s[2]+a[2]+l[2]*d;const p=Ix;(0,k.r)(p,this.builder.profileVertexAndNormalData[n+2],this.builder.profileVertexAndNormalData[n+3]),this.vertexAttributeNormal[3*t+0]=c[0]*p[0]+h[0]*p[1]+l[0]*u,this.vertexAttributeNormal[3*t+1]=c[1]*p[0]+h[1]*p[1]+l[1]*u,this.vertexAttributeNormal[3*t+2]=c[2]*p[0]+h[2]*p[1]+l[2]*u}}createGeometryData(){const e=[["position",this.builder.vertexIndices],["normal",this.builder.normalIndices]],t=[["position",{size:3,data:this.vertexAttributePosition,exclusive:!0}],["normal",{size:3,data:this.vertexAttributeNormal,exclusive:!0}]];if(this.vertexAttributeColor){const i=this.builder.vertexIndices.length;e.push(["color",new Uint32Array(i)]),t.push(["color",{size:4,data:this.vertexAttributeColor}])}return{vertexAttributes:t,indices:e}}onPathChanged(){super.onPathChanged(),this.bake(this.size)}intersect(e,t,i){const r=this.builder.vertexIndices,s={size:3,data:this.vertexAttributePosition},n=r.length/3;(0,S.a$)(e,t,0,n,r,s,void 0,void 0,i)}}class Ex extends Ox{constructor(e,t,i,r){super(e),this.sizeAttributeValue=t,this.colorAttributeValue=i,this.opacityAttributeValue=r,this.vvData=null,this.baked=new Dx(e),this.vvData=new Float32Array(4*this.builder.path.vertices.length);for(let e=0;e<this.builder.path.vertices.length;++e){this.vvData[4*e+0]=t,this.vvData[4*e+1]=i,this.vvData[4*e+2]=r;const s=0===e||e===this.builder.path.vertices.length-1;this.vvData[4*e+3]=s?1:0}}createGeometryData(){return{vertexAttributes:[["position",{size:3,data:this.builder.originData,exclusive:!0}],["profileRight",{size:4,data:this.builder.profileRightAxisData,exclusive:!0}],["profileUp",{size:4,data:this.builder.profileUpAxisData,exclusive:!0}],["profileVertexAndNormal",{size:4,data:this.builder.profileVertexAndNormalData,exclusive:!0}],["featureValue",{size:4,data:this.vvData,exclusive:!0}]],indices:[["position",this.builder.pathVertexIndices],["profileRight",this.builder.vertexIndices],["profileUp",this.builder.vertexIndices],["profileVertexAndNormal",this.builder.vertexIndices],["featureValue",this.builder.pathVertexIndices]]}}}const zx=(0,v.n)(),Ix=(0,N.n)(),Lx=(0,N.n)(),Fx=(0,N.n)(),Vx=(0,v.n)(),Ux=(0,v.n)(),Gx=(0,v.n)(),Bx=(0,v.n)(),qx=(0,v.n)(),kx=gx(),Nx=(0,T.e)();function jx(e,t){e.attributes.add("featureValue","vec4"),e.vertex.code.add(S.t`bool isCapVertex() {
return featureValue.w == 1.0;
}`),e.vertex.uniforms.add("size","vec3"),t.vvSize?(e.vertex.uniforms.add("vvSizeMinSize","vec3"),e.vertex.uniforms.add("vvSizeMaxSize","vec3"),e.vertex.uniforms.add("vvSizeOffset","vec3"),e.vertex.uniforms.add("vvSizeFactor","vec3"),e.vertex.code.add(S.t`vec2 getSize() {
return size.xy*clamp(vvSizeOffset + featureValue.x * vvSizeFactor, vvSizeMinSize, vvSizeMaxSize).xz;
}`)):e.vertex.code.add(S.t`vec2 getSize(){
return size.xy;
}`),t.vvOpacity?(e.vertex.constants.add("vvOpacityNumber","int",8),e.vertex.code.add(S.t`uniform float vvOpacityValues[vvOpacityNumber];
uniform float vvOpacityOpacities[vvOpacityNumber];
vec4 applyOpacity(vec4 color) {
float value = featureValue.z;
if (value <= vvOpacityValues[0]) {
return vec4( color.xyz, vvOpacityOpacities[0]);
}
for (int i = 1; i < vvOpacityNumber; ++i) {
if (vvOpacityValues[i] >= value) {
float f = (value - vvOpacityValues[i-1]) / (vvOpacityValues[i] - vvOpacityValues[i-1]);
return vec4( color.xyz, mix(vvOpacityOpacities[i-1], vvOpacityOpacities[i], f));
}
}
return vec4( color.xyz, vvOpacityOpacities[vvOpacityNumber - 1]);
}`)):e.vertex.code.add(S.t`vec4 applyOpacity(vec4 color){
return color;
}`),t.vvColor?(e.vertex.constants.add("vvColorNumber","int",8),e.vertex.code.add(S.t`uniform float vvColorValues[vvColorNumber];
uniform vec4 vvColorColors[vvColorNumber];
vec4 getColor() {
float value = featureValue.y;
if (value <= vvColorValues[0]) {
return applyOpacity(vvColorColors[0]);
}
for (int i = 1; i < vvColorNumber; ++i) {
if (vvColorValues[i] >= value) {
float f = (value - vvColorValues[i-1]) / (vvColorValues[i] - vvColorValues[i-1]);
return applyOpacity(mix(vvColorColors[i-1], vvColorColors[i], f));
}
}
return applyOpacity(vvColorColors[vvColorNumber - 1]);
}`)):e.vertex.code.add(S.t`vec4 getColor(){
return applyOpacity(vec4(1, 1, 1, 1));
}`),e.include(S.b0),e.attributes.add("profileRight","vec4"),e.attributes.add("profileUp","vec4"),e.attributes.add("profileVertexAndNormal","vec4"),e.vertex.code.add(S.t`vec3 calculateVPos() {
vec2 size = getSize();
vec3 origin = position;
vec3 right = profileRight.xyz;
vec3 up = profileUp.xyz;
vec3 forward = cross(up, right);
vec2 profileVertex = profileVertexAndNormal.xy * size;
vec2 profileNormal = profileVertexAndNormal.zw;
float positionOffsetAlongProfilePlaneNormal = 0.0;
float normalOffsetAlongProfilePlaneNormal = 0.0;`),e.vertex.code.add(S.t`if(!isCapVertex()) {
vec2 rotationRight = vec2(profileRight.w, profileUp.w);
float maxDistance = length(rotationRight);`),e.vertex.code.add(S.t`rotationRight = maxDistance > 0.0 ? normalize(rotationRight) : vec2(0, 0);
float rx = dot(profileVertex, rotationRight);
if (abs(rx) > maxDistance) {
vec2 rotationUp = vec2(-rotationRight.y, rotationRight.x);
float ry = dot(profileVertex, rotationUp);
profileVertex = rotationRight * maxDistance * sign(rx) + rotationUp * ry;
}
}else{
positionOffsetAlongProfilePlaneNormal = profileRight.w * size[0];
normalOffsetAlongProfilePlaneNormal = profileUp.w;
}
vec3 offset = right * profileVertex.x + up * profileVertex.y + forward * positionOffsetAlongProfilePlaneNormal;
return origin + offset;
}`),e.vertex.code.add(S.t`vec3 localNormal() {
vec3 right = profileRight.xyz;
vec3 up = profileUp.xyz;
vec3 forward = cross(up, right);
vec2 profileNormal = profileVertexAndNormal.zw;
vec3 normal = right * profileNormal.x + up * profileNormal.y;
if(isCapVertex()) {
normal += forward * profileUp.w;
}
return normal;
}`)}function Hx(e){const t=new S.n;return t.vertex.uniforms.add("proj","mat4").add("view","mat4").add("camPos","vec3").add("localOrigin","vec3"),t.varyings.add("vpos","vec3"),t.include(jx,e),0!==e.output&&7!==e.output||(t.include(S.r,{linearDepth:!1}),e.receiveShadows&&t.include(S.aG,e),t.include(S.aF,e),t.varyings.add("vnormal","vec3"),t.varyings.add("vcolor","vec4"),e.multipassTerrainEnabled&&t.varyings.add("depth","float"),t.vertex.code.add(S.t`
      void main() {
        vpos = calculateVPos();
        vnormal = normalize(localNormal());

        ${e.multipassTerrainEnabled?"depth = (view * vec4(vpos, 1.0)).z;":""}
        gl_Position = transformPosition(proj, view, vpos);

        ${0===e.output?"forwardLinearDepth();":""}

        vcolor = getColor();
      }
    `)),e.multipassTerrainEnabled&&(t.fragment.include(S.L),t.include(S.ap,e)),7===e.output&&(t.include(S.N,e),t.fragment.uniforms.add("camPos","vec3"),t.fragment.uniforms.add("localOrigin","vec3"),t.fragment.uniforms.add("opacity","float"),t.fragment.code.add(S.t`
      void main() {
        discardBySlice(vpos);
        ${e.multipassTerrainEnabled?"terrainDepthTest(gl_FragCoord, depth);":""}
        float combinedOpacity = vcolor.a * opacity;
        gl_FragColor = vec4(combinedOpacity);
      }
    `)),0===e.output&&(t.include(S.N,e),t.include(S.b1,e),t.include(S.b2,e),e.receiveShadows&&t.include(S.aG,e),t.include(S.b3,e),t.fragment.uniforms.add("camPos","vec3").add("localOrigin","vec3").add("ambient","vec3").add("diffuse","vec3").add("specular","vec3").add("opacity","float"),t.fragment.include(S.j),t.fragment.code.add(S.t`
      void main() {
        discardBySlice(vpos);
        ${e.multipassTerrainEnabled?"terrainDepthTest(gl_FragCoord, depth);":""}

        shadingParams.viewDirection = normalize(vpos - camPos);
        shadingParams.normalView = vnormal;
        vec3 normal = shadingNormal(shadingParams);
        float ssao = evaluateAmbientOcclusionInverse();

        float additionalAmbientScale = additionalDirectedAmbientLight(vpos + localOrigin);
        vec3 additionalLight = ssao * lightingMainIntensity * additionalAmbientScale * ambientBoostFactor * lightingGlobalFactor;
        ${e.receiveShadows?"float shadow = readShadowMap(vpos, linearDepth);":1===e.viewingMode?"float shadow = lightingGlobalFactor * (1.0 - additionalAmbientScale);":"float shadow = 0.0;"}
        vec3 albedo = vcolor.rgb * max(ambient, diffuse); // combine the old material parameters into a single one
        float combinedOpacity = vcolor.a * opacity;
        albedo += 0.25 * specular; // don't completely ignore specular for now

        vec3 shadedColor = evaluateSceneLighting(normal, albedo, shadow, 1.0 - ssao, additionalLight);
        gl_FragColor = vec4(shadedColor, combinedOpacity);
        gl_FragColor = highlightSlice(gl_FragColor, vpos);
        ${e.OITEnabled?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""}
      }
    `)),1!==e.output&&3!==e.output||(t.include(S.r,{linearDepth:!0}),t.vertex.uniforms.add("nearFar","vec2"),t.varyings.add("depth","float"),t.vertex.code.add(S.t`void main() {
vpos = calculateVPos();
gl_Position = transformPositionWithDepth(proj, view, vpos, nearFar, depth);
}`),t.include(S.N,e),t.include(S.ao,e),t.fragment.uniforms.add("timeElapsed","float"),t.fragment.code.add(S.t`void main() {
discardBySlice(vpos);
outputDepth(depth);
}`)),2===e.output&&(t.include(S.r,{linearDepth:!1}),t.include(ug,e),t.vertex.uniforms.add("viewNormal","mat4"),t.varyings.add("vnormal","vec3"),t.vertex.code.add(S.t`void main(void) {
vpos = calculateVPos();
vnormal = normalize((viewNormal * vec4(localNormal(), 1.0)).xyz);
gl_Position = transformPosition(proj, view, vpos);
}`),t.include(S.N,e),t.fragment.uniforms.add("waterColor","vec4"),t.fragment.code.add(S.t`void main() {
discardBySlice(vpos);
vec3 normal = normalize(vnormal);
if (gl_FrontFacing == false) normal = -normal;
gl_FragColor = vec4(vec3(0.5) + 0.5 * normal, 1.0);
}`)),4===e.output&&(t.include(S.r,{linearDepth:!1}),t.include(ug,e),t.vertex.uniforms.add("viewNormal","mat4"),t.varyings.add("vnormal","vec3"),t.vertex.code.add(S.t`void main(void) {
vpos = calculateVPos();
gl_Position = transformPosition(proj, view, vpos);
}`),t.include(S.N,e),t.include(S.S),t.fragment.code.add(S.t`void main() {
discardBySlice(vpos);
outputHighlight();
}`)),t}var Wx=Object.freeze({__proto__:null,build:Hx});const Qx=new Map([["position",0],["profileRight",1],["profileUp",2],["profileVertexAndNormal",3],["featureValue",4]]);class Zx extends S.c{initializeProgram(e){const t=Zx.shader.get(),i=this.configuration,r=t.build({OITEnabled:0===i.transparencyPassType,output:i.output,viewingMode:e.viewingMode,slicePlaneEnabled:i.slicePlaneEnabled,sliceHighlightDisabled:!1,sliceEnabledForVertexPrograms:!1,receiveShadows:i.receiveShadows,vvSize:i.vvSize,vvColor:i.vvColor,vvInstancingEnabled:!0,vvOpacity:i.vvOpacity,pbrMode:0,useCustomDTRExponentForWater:!1,receiveAmbientOcclusion:i.receiveSSAO,doubleSidedMode:i.doubleSidedMode,multipassTerrainEnabled:i.multipassTerrainEnabled,cullAboveGround:i.cullAboveGround});return new S.d(e.rctx,r,Qx)}bindPass(e,t){var i,r;(0,S.h)(this.program,t.camera.projectionMatrix),this.program.setUniform3fv("size",e.size),t.multipassTerrainEnabled&&(this.program.setUniform2fv("cameraNearFar",t.camera.nearFar),this.program.setUniform2fv("inverseViewport",t.inverseViewport),(0,S.Y)(this.program,t)),0!==this.configuration.output&&7!==this.configuration.output||this.program.setUniform1f("opacity",e.opacity),0===this.configuration.output?(t.lighting.setUniforms(this.program,!1),this.program.setUniform3fv("ambient",e.ambient),this.program.setUniform3fv("diffuse",e.diffuse),this.program.setUniform3fv("specular",e.specular),this.program.setUniform1f("opacity",e.opacity)):1!==this.configuration.output&&3!==this.configuration.output||(0,S.b4)(this.program,t.camera.nearFar),function(e,t){t.vvSizeEnabled&&(e.setUniform3fv("vvSizeMinSize",t.vvSizeMinSize),e.setUniform3fv("vvSizeMaxSize",t.vvSizeMaxSize),e.setUniform3fv("vvSizeOffset",t.vvSizeOffset),e.setUniform3fv("vvSizeFactor",t.vvSizeFactor)),t.vvColorEnabled&&(e.setUniform1fv("vvColorValues",t.vvColorValues),e.setUniform4fv("vvColorColors",t.vvColorColors)),t.vvOpacityEnabled&&(e.setUniform1fv("vvOpacityValues",t.vvOpacityValues),e.setUniform1fv("vvOpacityOpacities",t.vvOpacityOpacities))}(this.program,e),null==(i=t.shadowMap)||i.bind(this.program),null==(r=t.ssaoHelper)||r.bind(this.program)}bindDraw(e){(0,S.a2)(this.program,e),(0,S.a4)(this.program,this.configuration,e),this.program.rebindTextures(),0!==this.configuration.output&&7!==this.configuration.output||(0,S.a3)(this.program,e.origin,e.camera.viewInverseTransposeMatrix),0===this.configuration.output&&(0,S.b5)(this.program,e),2===this.configuration.output&&S.b6.bindUniforms(this.program,e.camera.viewInverseTransposeMatrix)}setPipelineState(e){const t=this.configuration,i=3===e,r=2===e;return(0,V.g)({blending:0!==t.output&&7!==t.output||!t.transparent?null:i?S.ar:(0,S.a5)(e),culling:(e=>!e.slicePlaneEnabled&&!(e.transparent||0===e.doubleSidedMode))(t)&&V.n,depthTest:{func:(0,S.as)(e)},depthWrite:i||r?V.l:null,colorWrite:V.r,stencilWrite:t.sceneHasOcludees?S.au:null,stencilTest:t.sceneHasOcludees?S.aw:null,polygonOffset:i||r?null:S.ax})}initializePipeline(){return this.setPipelineState(this.configuration.transparencyPassType)}}Zx.shader=new S.f(Wx,(()=>i.e(4763).then(i.bind(i,84763))));class Yx extends S.b{constructor(){super(...arguments),this.output=0,this.doubleSidedMode=0,this.receiveShadows=!1,this.receiveSSAO=!1,this.vvSize=!1,this.vvColor=!1,this.vvOpacity=!1,this.slicePlaneEnabled=!1,this.transparent=!1,this.sceneHasOcludees=!1,this.transparencyPassType=3,this.multipassTerrainEnabled=!1,this.cullAboveGround=!1}}(0,r.e)([(0,S.a)({count:8})],Yx.prototype,"output",void 0),(0,r.e)([(0,S.a)({count:3})],Yx.prototype,"doubleSidedMode",void 0),(0,r.e)([(0,S.a)()],Yx.prototype,"receiveShadows",void 0),(0,r.e)([(0,S.a)()],Yx.prototype,"receiveSSAO",void 0),(0,r.e)([(0,S.a)()],Yx.prototype,"vvSize",void 0),(0,r.e)([(0,S.a)()],Yx.prototype,"vvColor",void 0),(0,r.e)([(0,S.a)()],Yx.prototype,"vvOpacity",void 0),(0,r.e)([(0,S.a)()],Yx.prototype,"slicePlaneEnabled",void 0),(0,r.e)([(0,S.a)()],Yx.prototype,"transparent",void 0),(0,r.e)([(0,S.a)()],Yx.prototype,"sceneHasOcludees",void 0),(0,r.e)([(0,S.a)({count:4})],Yx.prototype,"transparencyPassType",void 0),(0,r.e)([(0,S.a)()],Yx.prototype,"multipassTerrainEnabled",void 0),(0,r.e)([(0,S.a)()],Yx.prototype,"cullAboveGround",void 0);const Xx=S.i;class $x extends S.a6{constructor(e){super(e,Jx),this.supportsEdges=!0,this._vertexAttributeLocations=Qx,this.techniqueConfig=new Yx,this.vertexBufferLayout=$x.getVertexBufferLayout(this.params)}getTechniqueConfig(e,t){return this.techniqueConfig.output=e,this.techniqueConfig.vvSize=this.params.vvSizeEnabled,this.techniqueConfig.vvColor=this.params.vvColorEnabled,this.techniqueConfig.vvOpacity=this.params.vvOpacityEnabled,this.techniqueConfig.slicePlaneEnabled=this.params.slicePlaneEnabled,this.techniqueConfig.transparent=this.params.transparent,this.techniqueConfig.sceneHasOcludees=this.params.sceneHasOcludees,0!==e&&7!==e||(this.techniqueConfig.doubleSidedMode=this.params.doubleSided&&"normal"===this.params.doubleSidedType?1:this.params.doubleSided&&"winding-order"===this.params.doubleSidedType?2:0,this.techniqueConfig.receiveShadows=this.params.receiveShadows,this.techniqueConfig.receiveSSAO=!(!t||!t.ssaoEnabled)&&this.params.receiveSSAO),this.techniqueConfig.transparencyPassType=t?t.transparencyPassType:3,this.techniqueConfig.multipassTerrainEnabled=!!t&&t.multipassTerrainEnabled,this.techniqueConfig.cullAboveGround=!!t&&t.cullAboveGround,this.techniqueConfig}getPassParameters(){return this.params}isVisibleInPass(e){return 4!==e&&6!==e&&7!==e||this.params.castShadows}isVisible(){const e=this.params;return!!super.isVisible()&&e.opacity>0}intersect(e,t,i,r,s,n,a){const o=e;if(!fx(o))return;const l=o.path,c=[this.params.size[0],this.params.size[1]];if(this.params.vvSizeEnabled){const e=this.params.vvSizeOffset,t=this.params.vvSizeFactor,i=this.params.vvSizeMinSize,r=this.params.vvSizeMaxSize,s=l.sizeAttributeValue;c[0]*=(0,v.o)(e[0]+s*t[0],i[0],r[0]),c[1]*=(0,v.o)(e[2]+s*t[2],i[2],r[2])}const h=Math.max(c[0],c[1]),d=e.boundingInfo;if((0,u.t)(d))return void this._intersectTriangles(l,c,s,n,a);const p=(0,se.u)(d.bbMin[0]-h,d.bbMin[1]-h,d.bbMin[2]-h,d.bbMax[0]+h,d.bbMax[1]+h,d.bbMax[2]+h),m=[n[0]-s[0],n[1]-s[1],n[2]-s[2]],f=Math.sqrt(m[0]*m[0]+m[1]*m[1]+m[2]*m[2]),g=[f/m[0],f/m[1],f/m[2]];(0,S.b7)(p,s,g,r.tolerance)&&this._intersectTriangles(l,c,s,n,a)}_intersectTriangles(e,t,i,r,s){e.baked.size&&e.baked.size[0]===t[0]&&e.baked.size[1]===t[1]||e.baked.bake(t),e.baked.intersect(i,r,s)}computeAttachmentOrigin(e,t){const i=e.vertexAttributes;if(!i)return null;const r=i.get("position");return(0,w.i)(r,null,!1,t)}createBufferWriter(){return new eb(this.vertexBufferLayout)}getGLMaterial(e){if(0===e.output||7===e.output||1===e.output||2===e.output||4===e.output||3===e.output&&this.params.castShadows)return new Kx(e)}static getVertexBufferLayout(e){let t=(0,G.A)().vec3f("position").vec4f("profileRight").vec4f("profileUp").vec4f("profileVertexAndNormal");return(e.vvColorEnabled||e.vvSizeEnabled||e.vvOpacityEnabled)&&(t=t.vec4f("featureValue")),t}}class Kx extends S.aj{constructor(e){super(e),this.updateParameters()}updateParameters(e){this._technique=this._techniqueRep.releaseAndAcquire(Zx,this._material.getTechniqueConfig(this._output,e),this._technique)}beginSlot(e){return e===(this._technique.configuration.transparent?5:3)}_updateOccludeeState(e){e.hasOccludees!==this._material.params.sceneHasOcludees&&this._material.setParameterValues({sceneHasOcludees:e.hasOccludees})}_updateShadowState(e){e.shadowMappingEnabled!==this._technique.configuration.receiveShadows&&this._material.setParameterValues({receiveShadows:e.shadowMappingEnabled})}ensureParameters(e){0!==this._output&&7!==this._output||(this._updateShadowState(e),this._updateOccludeeState(e)),this.updateParameters(e)}bind(e){this._technique.bindPass(this._material.getPassParameters(),e)}}const Jx={size:[1,1,1],ambient:[.2,.2,.2],diffuse:[.8,.8,.8],specular:[0,0,0],opacity:1,doubleSided:!1,doubleSidedType:"normal",receiveSSAO:!0,receiveShadows:!1,castShadows:!0,slicePlaneEnabled:!1,transparent:!1,sceneHasOcludees:!1,...lf.Default,...S.ab};class eb{constructor(e){this.vertexBufferLayout=e}allocate(e){return this.vertexBufferLayout.createBuffer(e)}elementCount(e){return e.indices.get("position").length}write(e,t,i,r){const s=e=>{if(t.vertexAttributes.has(e)){const s=t.vertexAttributes.get(e),n=t.indices.get(e);Xx(4===s.size);const a=i.getField(e,de.c);if(!a)throw new Error("unable to acquire view for "+e);(0,S.af)(n,s.data,a,r)}};s("profileRight"),s("profileUp"),s("profileVertexAndNormal"),this.vertexBufferLayout.hasField("featureValue")&&s("featureValue"),(0,S.aU)(t,this.vertexBufferLayout,e.transformation,e.invTranspTransformation,i,r)}}const tb=["polyline"];function ib(e,t,i){switch(t){case"world":for(const t of e.vertices)(0,v.u)(ob,t.pos,e.offset),i.worldUpAtPosition(ob,ab),t.setFrameFromUpVector(ab),t.computeRotationAxisAndAngleFromUpVector();break;case"path":(0,v.u)(ob,e.vertices[0].pos,e.offset),i.worldUpAtPosition(ob,ab),function(e,t){let i=null;const r=e.vertices.length,s=.99619469809,n=(0,v.n)(),a=(0,v.n)(),o=(0,v.n)(),l=(0,v.n)(),c=(0,v.n)(),h=(0,v.n)(),d=De();let u=e.vertices[0];(0,v.h)(a,t),(0,v.a)(n,0,1,0),lr.makeOrthoBasisDirUpFallback(u.vRight,a,n,n,o,a,s),(0,v.h)(u.frame.up,a),(0,v.h)(u.frame.right,o),i=u;for(let t=1;t<r;++t){u=e.vertices[t],(0,v.u)(c,u.vLeft,u.vRight);let r=(0,v.s)(c);r>0?(r=1/Math.sqrt(r),c[0]=c[0]*r,c[1]=c[1]*r,c[2]=c[2]*r):(c[0]=u.vRight[0],c[1]=u.vRight[1],c[2]=u.vRight[2]),(0,v.u)(h,i.pos,i.frame.up),Le(u.pos,c,d),Qe(d,(0,S.g)(h,u.vLeft),l)?((0,v.c)(l,l,u.pos),(0,v.j)(a,l),(0,v._)(o,c,a),(0,v.j)(o,o)):lr.makeOrthoBasisDirUpFallback(c,i.frame.up,i.frame.right,n,o,a,s),(0,v.h)(u.frame.up,a),(0,v.h)(u.frame.right,o),i=u}}(e,ab);for(const t of e.vertices){const e=(0,v.e)((0,v.z)(t.frame.right,t.vRight));(0,v._)(t.rotationFrame.up,t.vRight,t.vLeft),(0,v.d)(t.rotationFrame.up,t.rotationFrame.up,e),(0,v.j)(t.rotationFrame.up,t.rotationFrame.up);const i=(0,v.z)(t.rotationFrame.up,t.frame.up),r=(0,v.z)(t.rotationFrame.up,t.frame.right);if((0,v.d)(ob,t.frame.up,-r),(0,v.d)(lb,t.frame.right,i),(0,v.u)(ob,ob,lb),(0,v.j)(t.rotationFrame.right,ob),yx(t.rotationRight,t.frame,t.rotationFrame.right),(0,v.E)(ob,t.vLeft),t.rotationAngle=-e*(Math.PI-(0,v.x)((0,v.z)(ob,t.vRight))),Math.abs(t.rotationAngle)>0){const e=(0,v.Q)(Math.cos(.5*t.rotationAngle));cx(t.miterStretch,1+(e-1)*t.rotationRight[0]*t.rotationRight[0],(e-1)*t.rotationRight[0]*t.rotationRight[1],(e-1)*t.rotationRight[0]*t.rotationRight[1],1+(e-1)*t.rotationRight[1]*t.rotationRight[1])}const s=Math.PI-t.rotationAngle;t.maxStretchDistance=Math.abs(Math.min(t.vLeftLength,t.vRightLength)*(0,v.Q)(Math.cos(.5*s)))}}}function rb(e,t,i){switch(e){case"symbol-value":return i;case"proportional":return t;default:return e}}function sb(e,t,i,r){let s=0;for(const n of e.vertices){const a=Iu(n.posES,i,t,r,cb);s+=cb.sampledElevation,(0,v.u)(ab,n.pos,e.offset),r.setAltitude(ab,a),(0,v.c)(n.pos,ab,e.offset)}return e.updatePathVertexInformation(),s/e.vertices.length}function nb(e,t,i,r){const s=e.stageObject,n=s.geometryRecords,a=n.length;let o=0;r.spatialReference;for(let e=0;e<a;e++){const a=n[e].geometry;if(!fx(a))continue;const l=a.path,c=l.builder.path;a.geometrySR,o+=sb(c,t,i,r),"world"!==a.upVectorAlignment&&ib(c,a.upVectorAlignment,r),l.onPathChanged(),a.invalidateBoundingInfo(),s.geometryVertexAttrsUpdated(e)}return o/a}const ab=(0,v.n)(),ob=(0,B.n)(),lb=(0,B.n)(),cb={verticalDistanceToGround:0,sampledElevation:0};function hb(e,t,i,r,s=1){(0,v.a)(mb,1,0,0),(0,v.a)(fb,0,1,0),(0,v.a)(gb,0,0,1),function(e,t){(0,v.a)(Rb,0,0,0);for(let e=0;e<t.count-1;e++)t.getVec(e,ub),(0,v.u)(Rb,Rb,ub);(0,v.d)(e,Rb,1/(t.count-1))}(db,t),function(e,t){const i=e.count-1;return Ve(e,t,0,Math.floor(i/3),Math.floor(i*(2/3)))}(t,pb)&&function(e,t,i,r,s,n){(0,u.r)(s)?(s.basisMatrixAtPosition(n,Cb),(0,v.a)(Tb,Cb[0],Cb[1],Cb[2]),(0,v.a)(Sb,Cb[4],Cb[5],Cb[6]),(0,v.a)(Pb,Cb[8],Cb[9],Cb[10])):((0,v.a)(Tb,1,0,0),(0,v.a)(Sb,0,1,0),(0,v.a)(Pb,0,0,1));const a=e;(0,v.z)(a,Pb)<0&&(0,v.d)(a,a,-1),(0,v.h)(r,a);const o=(0,v.z)(a,Sb),l=(0,v.z)(a,Tb);Math.abs(o)<Math.abs(l)?((0,v.R)(t,Tb,a,-l),(0,v.j)(t,t),(0,v._)(i,t,a),(0,v.j)(i,i),(0,v.d)(i,i,-1)):((0,v.R)(i,Sb,a,-o),(0,v.j)(i,i),(0,v._)(t,i,a),(0,v.j)(t,t))}(pb,mb,fb,gb,i,db),(0,k.r)(vb,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY),(0,k.r)(yb,Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY);for(let e=0;e<t.count;e++){t.getVec(e,ub);const i=(0,v.z)(mb,ub),r=(0,v.z)(fb,ub);vb[0]=Math.min(vb[0],i),vb[1]=Math.min(vb[1],r),yb[0]=Math.max(yb[0],i),yb[1]=Math.max(yb[1],r)}const n=(0,v.z)(gb,db);Ab(xb,vb[0],vb[1],n,mb,fb,gb),Ab(bb,yb[0],vb[1],n,mb,fb,gb),Ab(wb,vb[0],yb[1],n,mb,fb,gb),(0,v.c)(bb,bb,xb),(0,v.d)(bb,bb,.5),(0,v.c)(wb,wb,xb),(0,v.d)(wb,wb,.5),(0,v.u)(xb,xb,bb),(0,v.u)(xb,xb,wb);const a=vb[0]%s,o=vb[1]%s;_b[0]=vb[0]-a,_b[1]=vb[1]-o;for(let i=0;i<t.count;i++){t.getVec(i,ub),e.setValues(i,((0,v.z)(mb,ub)-_b[0])/s,((0,v.z)(fb,ub)-_b[1])/s,_b[0]/s,_b[1]/s);for(let e=0;e<3;e++)r.set(i,e,xb[e]),r.set(i,e+3,bb[e]),r.set(i,e+6,wb[e])}}const db=(0,v.n)(),ub=(0,v.n)(),pb=De(),mb=(0,v.n)(),fb=(0,v.n)(),gb=(0,v.n)(),vb=(0,N.n)(),yb=(0,N.n)(),_b=(0,N.n)(),xb=(0,v.n)(),bb=(0,v.n)(),wb=(0,v.n)(),Cb=(0,T.e)(),Tb=(0,v.n)(),Sb=(0,v.n)(),Pb=(0,v.n)(),Rb=(0,v.n)();function Ab(e,t,i,r,s,n,a){(0,v.a)(e,t*s[0]+i*n[0]+r*a[0],t*s[1]+i*n[1]+r*a[1],t*s[2]+i*n[2]+r*a[2])}function Mb(e){const t=new S.n,i=1===e.output;return t.include(S.r,{linearDepth:i}),t.include(S.aV,e),t.vertex.uniforms.add("proj","mat4").add("view","mat4"),t.attributes.add("position","vec3"),t.varyings.add("vpos","vec3"),e.multipassTerrainEnabled&&t.varyings.add("depth","float"),i&&(t.include(S.ao,e),t.vertex.uniforms.add("cameraNearFar","vec2"),t.varyings.add("linearDepth","float")),t.vertex.code.add(S.t`
    void main(void) {
      vpos = position;
      forwardNormalizedVertexColor();
      ${e.multipassTerrainEnabled?"depth = (view * vec4(vpos, 1.0)).z;":""}
      gl_Position = ${i?S.t`transformPositionWithDepth(proj, view, vpos, cameraNearFar, linearDepth);`:S.t`transformPosition(proj, view, vpos);`}
    }
  `),t.include(S.N,e),t.fragment.include(S.j),e.multipassTerrainEnabled&&(t.fragment.include(S.L),t.include(S.ap,e)),t.fragment.uniforms.add("eColor","vec4"),4===e.output&&t.include(S.S),t.fragment.code.add(S.t`
  void main() {
    discardBySlice(vpos);
    ${e.multipassTerrainEnabled?"terrainDepthTest(gl_FragCoord, depth);":""}
    vec4 color = ${e.attributeColor?"vColor * eColor;":"eColor;"}

    if (color.a < ${S.t.float(S.Q)}) {
      discard;
    }

    ${7===e.output?S.t`gl_FragColor = vec4(color.a);`:""}

    ${0===e.output?S.t`gl_FragColor = highlightSlice(color, vpos); ${e.OITEnabled?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""}`:""}
    ${4===e.output?S.t`outputHighlight();`:""};
    ${1===e.output?S.t`outputDepth(linearDepth);`:""};
  }
  `),t}var Ob=Object.freeze({__proto__:null,build:Mb});class Db extends S.c{initializeProgram(e){const t=Db.shader.get(),i=this.configuration,r=t.build({output:i.output,OITEnabled:0===i.transparencyPassType,attributeColor:i.vertexColors,slicePlaneEnabled:i.slicePlaneEnabled,sliceHighlightDisabled:!1,sliceEnabledForVertexPrograms:!1,multipassTerrainEnabled:i.multipassTerrainEnabled,cullAboveGround:i.cullAboveGround});return new S.d(e.rctx,r,S.o)}bindPass(e,t){(0,S.h)(this.program,t.camera.projectionMatrix),this.program.setUniform4fv("eColor",e.color),4===this.configuration.output&&(0,S.a1)(this.program,t),(1===this.configuration.output||t.multipassTerrainEnabled)&&this.program.setUniform2fv("cameraNearFar",t.camera.nearFar),t.multipassTerrainEnabled&&(this.program.setUniform2fv("inverseViewport",t.inverseViewport),(0,S.Y)(this.program,t))}bindDraw(e){(0,S.a2)(this.program,e),this.program.rebindTextures(),(0,S.a4)(this.program,this.configuration,e)}setPipelineState(e,t){const i=this.configuration,r=3===e,s=2===e;return(0,V.g)({blending:0!==i.output&&7!==i.output||!i.transparent?null:r?S.ar:(0,S.a5)(e),culling:(0,V.d)(i.cullFace),depthTest:{func:(0,S.as)(e)},depthWrite:r||s?i.writeDepth&&V.l:null,colorWrite:V.r,stencilWrite:i.sceneHasOcludees?S.au:null,stencilTest:i.sceneHasOcludees?t?S.av:S.aw:null,polygonOffset:r||s?i.polygonOffset&&Eb:(0,S.aI)(i.enableOffset)})}initializePipeline(){return this._occludeePipelineState=this.setPipelineState(this.configuration.transparencyPassType,!0),this.setPipelineState(this.configuration.transparencyPassType,!1)}getPipelineState(e){return e?this._occludeePipelineState:this.pipeline}}Db.shader=new S.f(Ob,(()=>i.e(4962).then(i.bind(i,94962))));const Eb={factor:1,units:1};class zb extends S.b{constructor(){super(...arguments),this.output=0,this.cullFace=0,this.slicePlaneEnabled=!1,this.vertexColors=!1,this.transparent=!1,this.polygonOffset=!1,this.enableOffset=!0,this.writeDepth=!0,this.sceneHasOcludees=!1,this.transparencyPassType=3,this.multipassTerrainEnabled=!1,this.cullAboveGround=!1}}(0,r.e)([(0,S.a)({count:8})],zb.prototype,"output",void 0),(0,r.e)([(0,S.a)({count:3})],zb.prototype,"cullFace",void 0),(0,r.e)([(0,S.a)()],zb.prototype,"slicePlaneEnabled",void 0),(0,r.e)([(0,S.a)()],zb.prototype,"vertexColors",void 0),(0,r.e)([(0,S.a)()],zb.prototype,"transparent",void 0),(0,r.e)([(0,S.a)()],zb.prototype,"polygonOffset",void 0),(0,r.e)([(0,S.a)()],zb.prototype,"enableOffset",void 0),(0,r.e)([(0,S.a)()],zb.prototype,"writeDepth",void 0),(0,r.e)([(0,S.a)()],zb.prototype,"sceneHasOcludees",void 0),(0,r.e)([(0,S.a)({count:4})],zb.prototype,"transparencyPassType",void 0),(0,r.e)([(0,S.a)()],zb.prototype,"multipassTerrainEnabled",void 0),(0,r.e)([(0,S.a)()],zb.prototype,"cullAboveGround",void 0);class Ib extends S.a6{constructor(e){super(e,Fb),this.supportsEdges=!0,this.techniqueConfig=new zb}getTechniqueConfig(e,t){return this.techniqueConfig.output=e,this.techniqueConfig.cullFace=this.params.cullFace,this.techniqueConfig.vertexColors=this.params.vertexColors,this.techniqueConfig.slicePlaneEnabled=this.params.slicePlaneEnabled,this.techniqueConfig.transparent=this.params.transparent,this.techniqueConfig.polygonOffset=this.params.polygonOffset,this.techniqueConfig.writeDepth=this.params.writeDepth,this.techniqueConfig.sceneHasOcludees=this.params.sceneHasOcludees,this.techniqueConfig.transparencyPassType=t?t.transparencyPassType:3,this.techniqueConfig.enableOffset=!t||t.camera.relativeElevation<S.b8,this.techniqueConfig.multipassTerrainEnabled=!!t&&t.multipassTerrainEnabled,this.techniqueConfig.cullAboveGround=!!t&&t.cullAboveGround,this.techniqueConfig}getPassParameters(){return this.params}intersect(e,t,i,r,s,n,a){(0,S.b9)(e,t,r,s,n,void 0,a)}getGLMaterial(e){return 0===e.output||7===e.output||4===e.output||1===e.output&&this.params.writeLinearDepth?new Lb(e):void 0}createBufferWriter(){return new By(Gy)}}class Lb extends S.aj{constructor(e){super(e),this.updateParameters()}updateParameters(e){this._technique=this._techniqueRep.releaseAndAcquire(Db,this._material.getTechniqueConfig(this._output,e),this._technique)}beginSlot(e){return 4===this._output?3===e:e===(this._technique.configuration.transparent?this._technique.configuration.writeDepth?5:8:3)}_updateOccludeeState(e){e.hasOccludees!==this._material.params.sceneHasOcludees&&this._material.setParameterValues({sceneHasOcludees:e.hasOccludees})}ensureParameters(e){0!==this._output&&7!==this._output||this._updateOccludeeState(e),this.updateParameters(e)}bind(e){this._technique.bindPass(this._material.getPassParameters(),e)}getPipelineState(e,t){return this._technique.getPipelineState(t)}}const Fb={color:[1,1,1,1],transparent:!1,writeDepth:!0,writeLinearDepth:!1,vertexColors:!1,polygonOffset:!1,slicePlaneEnabled:!1,cullFace:0,sceneHasOcludees:!1,...S.ab},Vb=.70710678118,Ub=Vb;function Gb(e){const t=new S.n;e.draped||t.extensions.add("GL_OES_standard_derivatives");const i=1===e.output;t.include(S.r,{linearDepth:i}),t.include(S.aV,e),t.vertex.uniforms.add("proj","mat4"),t.vertex.uniforms.add("view","mat4"),i&&(t.include(S.ao,e),t.vertex.uniforms.add("cameraNearFar","vec2"),t.varyings.add("linearDepth","float")),e.draped?t.vertex.uniforms.add("worldToScreenRatio","float"):(t.vertex.uniforms.add("worldToScreenPerDistanceRatio","float"),t.vertex.uniforms.add("camPos","vec3"),t.attributes.add("boundingRect","mat3")),t.attributes.add("position","vec3"),t.attributes.add("uvMapSpace","vec4"),t.varyings.add("vpos","vec3"),t.varyings.add("vuv","vec2"),e.multipassTerrainEnabled&&t.varyings.add("depth","float");const r=3===e.style||4===e.style||5===e.style;return r&&t.vertex.code.add(S.t`
      const mat2 rotate45 = mat2(${S.t.float(Vb)}, ${S.t.float(-Ub)},
                                 ${S.t.float(Ub)}, ${S.t.float(Vb)});
    `),e.draped||(t.vertex.code.add(S.t`vec3 projectPointToLineSegment(vec3 center, vec3 halfVector, vec3 point) {
float projectedLength = dot(halfVector, point - center) / dot(halfVector, halfVector);
return center + halfVector * clamp(projectedLength, -1.0, 1.0);
}`),t.vertex.code.add(S.t`vec3 intersectRayPlane(vec3 rayDir, vec3 rayOrigin, vec3 planeNormal, vec3 planePoint) {
float d = dot(planeNormal, planePoint);
float t = (d - dot(planeNormal, rayOrigin)) / dot(planeNormal, rayDir);
return rayOrigin + t * rayDir;
}`),t.vertex.code.add(S.t`
      float boundingRectDistanceToCamera() {
        vec3 center = vec3(boundingRect[0][0], boundingRect[0][1], boundingRect[0][2]);
        vec3 halfU = vec3(boundingRect[1][0], boundingRect[1][1], boundingRect[1][2]);
        vec3 halfV = vec3(boundingRect[2][0], boundingRect[2][1], boundingRect[2][2]);
        vec3 n = normalize(cross(halfU, halfV));

        vec3 viewDir = - vec3(view[0][2], view[1][2], view[2][2]);

        float viewAngle = dot(viewDir, n);
        float minViewAngle = ${S.t.float(.08715574274)};

        if (abs(viewAngle) < minViewAngle) {
          // view direction is (almost) parallel to plane -> clamp it to min angle
          float normalComponent = sign(viewAngle) * minViewAngle - viewAngle;
          viewDir = normalize(viewDir + normalComponent * n);
        }

        // intersect view direction with infinite plane that contains bounding rect
        vec3 planeProjected = intersectRayPlane(viewDir, camPos, n, center);

        // clip to bounds by projecting to u and v line segments individually
        vec3 uProjected = projectPointToLineSegment(center, halfU, planeProjected);
        vec3 vProjected = projectPointToLineSegment(center, halfV, planeProjected);

        // use to calculate the closest point to camera on bounding rect
        vec3 closestPoint = uProjected + vProjected - center;

        return length(closestPoint - camPos);
      }
    `)),t.vertex.code.add(S.t`
    vec2 scaledUV() {
      vec2 uv = uvMapSpace.xy ${r?" * rotate45":""};
      vec2 uvCellOrigin = uvMapSpace.zw ${r?" * rotate45":""};

      ${e.draped?S.t`
            float ratio = worldToScreenRatio;
          `:S.t`
            float distanceToCamera = boundingRectDistanceToCamera();
            float ratio = worldToScreenPerDistanceRatio / distanceToCamera;

            // Logarithmically discretize ratio to avoid jittering
            float step = 0.1;
            ratio = log(ratio);
            ratio = ceil(ratio / step) * step;
            ratio = exp(ratio);
          `}

      vec2 uvOffset = mod(uvCellOrigin * ratio, ${S.t.float(e.patternSpacing)});
      return uvOffset + (uv * ratio);
    }
  `),t.vertex.code.add(S.t`
    void main(void) {
      vuv = scaledUV();
      vpos = position;
      ${e.multipassTerrainEnabled?"depth = (view * vec4(vpos, 1.0)).z;":""}
      forwardNormalizedVertexColor();
      gl_Position = ${i?S.t`transformPositionWithDepth(proj, view, vpos, cameraNearFar, linearDepth);`:S.t`transformPosition(proj, view, vpos);`}
    }
  `),t.include(S.N,e),t.fragment.include(S.j),t.fragment.uniforms.add("matColor","vec4"),e.draped&&t.fragment.uniforms.add("texelSize","float"),4===e.output&&t.include(S.S),e.multipassTerrainEnabled&&(t.fragment.include(S.L),t.include(S.ap,e)),4!==e.output&&(t.fragment.code.add(S.t`
      const float lineWidth = ${S.t.float(e.lineWidth)};
      const float spacing = ${S.t.float(e.patternSpacing)};
      const float spacingINV = ${S.t.float(1/e.patternSpacing)};

      float coverage(float p, float txlSize) {
        p = mod(p, spacing);

        float halfTxlSize = txlSize / 2.0;

        float start = p - halfTxlSize;
        float end = p + halfTxlSize;

        float coverage = (ceil(end * spacingINV) - floor(start * spacingINV)) * lineWidth;
        coverage -= min(lineWidth, mod(start, spacing));
        coverage -= max(lineWidth - mod(end, spacing), 0.0);

        return coverage / txlSize;
      }
    `),e.draped||t.fragment.code.add(S.t`const int maxSamples = 5;
float sample(float p) {
vec2 dxdy = abs(vec2(dFdx(p), dFdy(p)));
float fwidth = dxdy.x + dxdy.y;
ivec2 samples = 1 + ivec2(clamp(dxdy, 0.0, float(maxSamples - 1)));
vec2 invSamples = 1.0 / vec2(samples);
float accumulator = 0.0;
for (int j = 0; j < maxSamples; j++) {
if(j >= samples.y) {
break;
}
for (int i = 0; i < maxSamples; i++) {
if(i >= samples.x) {
break;
}
vec2 step = vec2(i,j) * invSamples - 0.5;
accumulator += coverage(p + step.x * dxdy.x + step.y * dxdy.y, fwidth);
}
}
accumulator /= float(samples.x * samples.y);
return accumulator;
}`)),t.fragment.code.add(S.t`
    void main() {
      discardBySlice(vpos);
      ${e.multipassTerrainEnabled?"terrainDepthTest(gl_FragCoord, depth);":""}
      vec4 color = ${e.attributeColor?"vColor * matColor;":"matColor;"}
      color = highlightSlice(color, vpos);

      ${4!==e.output?S.t`color.a *= ${function(e){function t(t){return e.draped?S.t`coverage(vuv.${t}, texelSize)`:S.t`sample(vuv.${t})`}switch(e.style){case 3:case 0:return t("y");case 4:case 1:return t("x");case 5:case 2:return S.t`
        1.0 - (1.0 - ${t("x")}) * (1.0 - ${t("y")})
      `;default:return"0.0"}}(e)};`:""}

      if (color.a < ${S.t.float(S.Q)}) {
        discard;
      }

      ${7===e.output?S.t`gl_FragColor = vec4(color.a);`:""}

      ${0===e.output?S.t`gl_FragColor = color; ${e.OITEnabled?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""}`:""}
      ${4===e.output?S.t`outputHighlight();`:""}
      ${1===e.output?S.t`outputDepth(linearDepth);`:""};
    }
  `),t}var Bb=Object.freeze({__proto__:null,build:Gb});class qb extends S.c{initializeProgram(e){const t=qb.shader.get(),i=this.configuration,r=t.build({output:i.output,attributeColor:i.vertexColors,slicePlaneEnabled:i.slicePlaneEnabled,sliceHighlightDisabled:!1,sliceEnabledForVertexPrograms:!1,style:i.style,patternSpacing:i.patternSpacing,lineWidth:i.lineWidth,draped:i.draped,OITEnabled:0===i.transparencyPassType,multipassTerrainEnabled:i.multipassTerrainEnabled,cullAboveGround:i.cullAboveGround});return new S.d(e.rctx,r,jb)}bindPass(e,t){(0,S.h)(this.program,t.camera.projectionMatrix),this.program.setUniform4fv("matColor",e.color),this.configuration.draped?(this.program.setUniform1f("worldToScreenRatio",1/t.screenToWorldRatioGlobalWM),this.program.setUniform1f("texelSize",1/t.camera.pixelRatio)):this.program.setUniform1f("worldToScreenPerDistanceRatio",1/t.camera.perScreenPixelRatio),4===this.configuration.output&&(0,S.a1)(this.program,t),(1===this.configuration.output||t.multipassTerrainEnabled)&&this.program.setUniform2fv("cameraNearFar",t.camera.nearFar),t.multipassTerrainEnabled&&(this.program.setUniform2fv("inverseViewport",t.inverseViewport),(0,S.Y)(this.program,t))}bindDraw(e){(0,S.a2)(this.program,e),(0,S.a3)(this.program,e.origin,e.camera.viewInverseTransposeMatrix),(0,S.a4)(this.program,this.configuration,e),this.program.rebindTextures()}setPipelineState(e,t){const i=this.configuration,r=3===e,s=2===e;return(0,V.g)({blending:0===i.output||7===i.output?i.transparent&&r?S.ar:(0,S.a5)(e):null,culling:(0,V.d)(i.cullFace),depthTest:{func:(0,S.as)(e)},depthWrite:r?i.writeDepth&&V.l:(0,S.at)(e),colorWrite:V.r,stencilWrite:i.sceneHasOcludees?S.au:null,stencilTest:i.sceneHasOcludees?t?S.av:S.aw:null,polygonOffset:r||s?i.polygonOffset&&kb:(0,S.aI)(i.enableOffset)})}initializePipeline(){return this._occludeePipelineState=this.setPipelineState(this.configuration.transparencyPassType,!0),this.setPipelineState(this.configuration.transparencyPassType,!1)}getPipelineState(e){return e?this._occludeePipelineState:this.pipeline}}qb.shader=new S.f(Bb,(()=>i.e(6349).then(i.bind(i,56349))));const kb={factor:1,units:1};class Nb extends S.b{constructor(){super(...arguments),this.output=0,this.cullFace=0,this.slicePlaneEnabled=!1,this.vertexColors=!1,this.transparent=!0,this.polygonOffset=!1,this.writeDepth=!0,this.sceneHasOcludees=!1,this.enableOffset=!0,this.transparencyPassType=3,this.multipassTerrainEnabled=!1,this.cullAboveGround=!1}}(0,r.e)([(0,S.a)({count:8})],Nb.prototype,"output",void 0),(0,r.e)([(0,S.a)({count:3})],Nb.prototype,"cullFace",void 0),(0,r.e)([(0,S.a)()],Nb.prototype,"slicePlaneEnabled",void 0),(0,r.e)([(0,S.a)()],Nb.prototype,"vertexColors",void 0),(0,r.e)([(0,S.a)()],Nb.prototype,"transparent",void 0),(0,r.e)([(0,S.a)()],Nb.prototype,"polygonOffset",void 0),(0,r.e)([(0,S.a)()],Nb.prototype,"writeDepth",void 0),(0,r.e)([(0,S.a)()],Nb.prototype,"sceneHasOcludees",void 0),(0,r.e)([(0,S.a)({count:6})],Nb.prototype,"style",void 0),(0,r.e)([(0,S.a)()],Nb.prototype,"patternSpacing",void 0),(0,r.e)([(0,S.a)()],Nb.prototype,"lineWidth",void 0),(0,r.e)([(0,S.a)()],Nb.prototype,"enableOffset",void 0),(0,r.e)([(0,S.a)()],Nb.prototype,"draped",void 0),(0,r.e)([(0,S.a)({count:4})],Nb.prototype,"transparencyPassType",void 0),(0,r.e)([(0,S.a)()],Nb.prototype,"multipassTerrainEnabled",void 0),(0,r.e)([(0,S.a)()],Nb.prototype,"cullAboveGround",void 0);const jb=new Map([["position",0],["color",3],["uvMapSpace",4],["boundingRect",5]]);class Hb extends S.a6{constructor(e){super(e,Zb),this.supportsEdges=!0,this._vertexAttributeLocations=jb,this.techniqueConfig=new Nb}getTechniqueConfig(e,t){return this.techniqueConfig.output=e,this.techniqueConfig.cullFace=this.params.cullFace,this.techniqueConfig.vertexColors=this.params.vertexColors,this.techniqueConfig.slicePlaneEnabled=this.params.slicePlaneEnabled,this.techniqueConfig.polygonOffset=this.params.polygonOffset,this.techniqueConfig.writeDepth=this.params.writeDepth,this.techniqueConfig.style=this.params.style,this.techniqueConfig.patternSpacing=this.params.patternSpacing,this.techniqueConfig.lineWidth=this.params.lineWidth,this.techniqueConfig.draped=this.params.draped,this.techniqueConfig.transparencyPassType=t?t.transparencyPassType:3,this.techniqueConfig.enableOffset=!t||t.camera.relativeElevation<S.b8,this.techniqueConfig.multipassTerrainEnabled=!!t&&t.multipassTerrainEnabled,this.techniqueConfig.cullAboveGround=!!t&&t.cullAboveGround,this.techniqueConfig}getPassParameters(){return this.params}intersect(e,t,i,r,s,n,a){(0,S.b9)(e,t,r,s,n,void 0,a)}getGLMaterial(e){return 0===e.output||7===e.output||4===e.output||1===e.output&&this.params.writeLinearDepth?new Wb(e):void 0}createBufferWriter(){const e=(0,G.A)().vec3f("position").vec4u8("color").vec4f("uvMapSpace");return this.params.draped||e.mat3f("boundingRect"),new Qb(e)}}class Wb extends S.aj{constructor(e){super(e),this.updateParameters()}updateParameters(e){this._technique=this._techniqueRep.releaseAndAcquire(qb,this._material.getTechniqueConfig(this._output,e),this._technique)}beginSlot(e){return 4===this._output?3===e:e===(this._technique.configuration.transparent?this._technique.configuration.writeDepth?5:8:3)}_updateOccludeeState(e){e.hasOccludees!==this._material.params.sceneHasOcludees&&this._material.setParameterValues({sceneHasOcludees:e.hasOccludees})}ensureParameters(e){0!==this._output&&7!==this._output||this._updateOccludeeState(e),this.updateParameters(e)}bind(e){this._technique.bindPass(this._material.getPassParameters(),e)}getPipelineState(e,t){return this._technique.getPipelineState(t)}}class Qb extends By{write(e,t,i,r){for(const s of this.vertexBufferLayout.fieldNames){const n=t.vertexAttributes.get(s),a=t.indices.get(s);if(n&&a)switch(s){case"position":{(0,S.i)(3===n.size);const t=i.getField(s,de.i);t&&(0,S.ac)(a,n.data,e.transformation,t,r);break}case"color":{(0,S.i)(3===n.size||4===n.size);const e=i.getField(s,de.x);e&&(0,S.ae)(a,n.data,n.size,e,r);break}case"uvMapSpace":{(0,S.i)(4===n.size);const e=i.getField(s,de.c);e&&(0,S.af)(a,n.data,e,r);break}case"boundingRect":{(0,S.i)(9===n.size);const t=i.getField(s,de.l);t&&this.writeBoundingRect(a,n.data,e.transformation,t,r);break}}}}writeBoundingRect(e,t,i,r,s){const n=i,a=r.typedBuffer,o=r.typedBufferStride,l=e.length;s*=o;for(let i=0;i<l;++i){const r=9*e[i],l=t[r],c=t[r+1],h=t[r+2];a[s]=n[0]*l+n[4]*c+n[8]*h+n[12],a[s+1]=n[1]*l+n[5]*c+n[9]*h+n[13],a[s+2]=n[2]*l+n[6]*c+n[10]*h+n[14];for(let e=3;e<9;++e)a[s+e]=t[r+e];s+=o}}}const Zb={color:[1,1,1,1],writeDepth:!0,writeLinearDepth:!1,vertexColors:!1,polygonOffset:!1,slicePlaneEnabled:!1,cullFace:0,sceneHasOcludees:!1,style:2,patternSpacing:10,lineWidth:1,draped:!0,...S.ab};function Yb(e,t){if(function(e){return e.material instanceof Hb&&!e.material.params.draped}(e)){const i=e.geometry.vertexAttributes,r=i.get("position").data,s=i.get("uvMapSpace").data,n=i.get("boundingRect").data;hb(de.c.fromTypedArray(s),de.T.fromTypedArray(r),t,de.a.fromTypedArray(n))}}function Xb(e,t,i,r){const s=ju(e,t,i,r),n=e.stageObject.geometryRecords;for(let e=0;e<n.length;e++)Yb(n[e],r);return s}const $b=["polyline","polygon","extent"];class Kb extends Vp{constructor(e,t,i,r){super(e,t,i,r),this._needsUV=!1,this._hasOutline=!1}async doLoad(){}ensureMaterials(){this.ensureFillMaterial(),this.ensureOutlineMaterial()}ensureFillMaterial(){if((0,u.r)(this._material))return;const e=(0,u.g)(this.symbolLayer,"material","color"),t=this._getCombinedOpacityAndColor(e);this._material=function(e,t,i){return function(e,t,i){return(0,u.r)(e)?"none"===e.style||"solid"===e.style?("none"===e.style&&(t.color=(0,w.a)(0,0,0,0),t.transparent=!0),new Ib(t)):(t.style=function(e){switch(e){case"horizontal":return 0;case"vertical":return 1;case"cross":return 2;case"forward-diagonal":return 3;case"backward-diagonal":return 4;case"diagonal-cross":return 5;default:return}}(e.style),t.draped=i.isDraped,new Hb(t)):new Ib(t)}(function(e){return e&&e.pattern||null}(e),t,i)}(this.symbolLayer,{color:t,transparent:t[3]<1||this.needsDrivenTransparentPass,polygonOffset:!1,vertexColors:!0,writeLinearDepth:!0,slicePlaneEnabled:this._context.slicePlaneEnabled},{isDraped:this.draped}),this._needsUV=this._material instanceof Hb,this._context.stage.add(this._material)}ensureOutlineMaterial(){const e=this.symbolLayer.outline;!(0,u.r)(this._outlineMaterial)&&this._isValidOutline(e)&&(this._hasOutline=!0,this._outlineMaterial=(t=>{const i=e.stipplePattern?Ry(e.stipplePattern.map(f.u)):null,r=e.stippleOffColor?z.o.toUnitRGBA(e.stippleOffColor):null;return t>1.5?new yf({width:t,color:this._getOutlineColor(),polygonOffset:!0,slicePlaneEnabled:this._context.slicePlaneEnabled,isClosed:!0,stipplePattern:i,stippleIntegerRepeats:!0,stippleOffColor:r}):new Wy({color:this._getOutlineColor(),slicePlaneEnabled:this._context.slicePlaneEnabled,width:t,stipplePattern:i,stippleIntegerRepeats:!0,stippleOffColor:r})})((0,f.u)(e.size)),this._context.stage.add(this._outlineMaterial))}_isValidOutline(e){return(0,u.r)(e)&&e.size&&e.size>0&&(0,u.r)(e.color)}destroy(){super.destroy(),this._context.stage.remove(this._material),this._material=null,this._context.stage.remove(this._outlineMaterial),this._outlineMaterial=null}createGraphics3DGraphic(e){const t=e.graphic;if(!this._validateGeometry(t.geometry,$b,this.symbolLayer.type))return null;const i=this._getVertexOpacityAndColor(e.renderingInfo,255),r=this.setGraphicElevationContext(t,new hp);return this.ensureDrapedStatus("on-the-ground"===r.mode),this.ensureMaterials(),this.draped?this._createAsOverlay(t,i):this._createAs3DShape(t,i,r)}layerOpacityChanged(){if((0,u.r)(this._material)){const e=this._material.params.color,t=(0,u.g)(this.symbolLayer,"material","color"),i=this._getCombinedOpacity(t);this._material.setParameterValues({color:[e[0],e[1],e[2],i],transparent:i<1||this.needsDrivenTransparentPass})}if((0,u.r)(this._outlineMaterial)){const e=this._outlineMaterial.params.color;this._outlineMaterial.setParameterValues({color:[e[0],e[1],e[2],this._getOutlineOpacity()]})}return!0}layerElevationInfoChanged(e,t,i){const r=this._elevationContext.mode,s=Lu(Kb.elevationModeChangeTypes,i,r);if(s!==Gu.UPDATE)return s;const n=Fu(r);return this.updateGraphics3DGraphicElevationInfo(e,t,(()=>n))}slicePlaneEnabledChanged(){if((0,u.r)(this._material)&&this._material.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled}),(0,u.r)(this._outlineMaterial)){const e={slicePlaneEnabled:this._context.slicePlaneEnabled};this._outlineMaterial.setParameterValues(e)}return!0}physicalBasedRenderingChanged(){return!0}pixelRatioChanged(){return!0}_createAs3DShape(e,t,i){const r=gv(e.geometry);if((0,u.t)(r))return null;ew.renderData=vv(r,this._context.elevationProvider,this._context.renderCoordsHelper,i),ew.color=t;const s=ew.renderData.position.length/3;if(this._needsUV&&(ew.uvMapSpace=new Float32Array(4*s),ew.boundingRect=new Float64Array(9*s)),ew.outNum=0,ew.outGeometries=[],ew.outTransforms=[],ew.outMaterials=[],this._createAs3DShapeFill(ew),this._hasOutline&&this._createAs3DShapeOutline(ew),this._logGeometryCreationWarnings(ew.renderData,r.rings,"rings","FillSymbol3DLayer"),0===ew.outNum)return null;this._needsUV&&hb(de.c.fromTypedArray(ew.uvMapSpace),de.T.fromTypedArray(ew.renderData.position),this._context.renderCoordsHelper,de.a.fromTypedArray(ew.boundingRect));const n=new Qs({geometries:ew.outGeometries,materials:ew.outMaterials,transformations:ew.outTransforms,castShadow:!1,metadata:{layerUid:this._context.layer.uid,graphicUid:e.uid}}),a=Xb,o=new dp(this,n,ew.outGeometries,null,null,a,i);return o.alignedSampledElevation=ew.renderData.sampledElevation,o.needsElevationUpdates=Fu(i.mode),o}_createAs3DShapeFill(e){const t=e.renderData.polygons;for(const{position:i,mapPosition:r,holeIndices:s,index:n,count:a}of t){if((0,u.r)(this._context.clippingExtent)&&((0,se.B)(Jb),(0,se.M)(Jb,r),!(0,se.R)(Jb,this._context.clippingExtent)))continue;const t=(0,he.r)(r,s,3);if(0===t.length)continue;const o=mv({indices:new Uint32Array(t),attributeData:{position:i,color:e.color,mapPosition:r,uvMapSpace:this._needsUV?new Float32Array(e.uvMapSpace.buffer,4*n*e.uvMapSpace.BYTES_PER_ELEMENT,4*a):null,boundingRect:this._needsUV?new Float64Array(e.boundingRect.buffer,9*n*e.boundingRect.BYTES_PER_ELEMENT,9*a):null}});e.outGeometries.push(o),e.outMaterials.push((0,u.f)(this._material)),e.outTransforms.push(T.a),e.outNum++}}_createAs3DShapeOutline(e){if(!this._hasOutline)return;const t=e.renderData.outlines,i=this._outlineMaterial instanceof Wy;for(let r=0;r<t.length;++r){const{mapPosition:s,position:n}=t[r];if((0,u.r)(this._context.clippingExtent)&&((0,se.B)(Jb),(0,se.M)(Jb,s),!(0,se.R)(Jb,this._context.clippingExtent)))continue;const a=by({removeDuplicateStartEnd:i?0:1,attributeData:{position:n,mapPosition:s}}),o=a.vertexAttributes.get("position");o.data===n&&(o.data=new Float64Array(n)),e.outGeometries.push(a),e.outMaterials.push((0,u.f)(this._outlineMaterial)),e.outTransforms.push(T.a),e.outNum++}}_createAsOverlay(e,t){const i=gv(e.geometry);if((0,u.t)(i))return null;(0,u.f)(this._material).renderPriority=this._renderPriority+this._renderPriorityStep/2,(0,u.r)(this._outlineMaterial)&&(this._outlineMaterial.renderPriority=this._renderPriority),tw.renderData=yv(i,this._context.overlaySR),tw.color=t;const r=tw.renderData.position.length/3;return this._needsUV&&(tw.uvMapSpace=new Float32Array(4*r)),tw.outNum=0,tw.outGeometries=[],tw.outBoundingBox=(0,se.B)(),tw.layerUid=this._context.layer.uid,tw.graphicsUid=e.uid,this._createAsOverlayFill(tw),this._hasOutline&&this._createAsOverlayOutline(tw),this._logGeometryCreationWarnings(tw.renderData,i.rings,"rings","FillSymbol3DLayer"),0===tw.outNum?null:(this._needsUV&&function(e,t,i,r=1){if(i.isGeographic){const e=new Float64Array(t.typedBuffer.length),r=3*t.count;for(let s=0;s<r;s+=3)(0,_.G)(t.typedBuffer,s,e,s,(0,x.p)(i));t=de.T.fromTypedArray(e)}(0,k.r)(vb,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY);for(let e=0;e<t.count;e++)t.getVec(e,ub),vb[0]=Math.min(vb[0],ub[0]),vb[1]=Math.min(vb[1],ub[1]);const s=vb[0]%r,n=vb[1]%r;_b[0]=vb[0]-s,_b[1]=vb[1]-n;for(let i=0;i<t.count;i++)t.getVec(i,ub),e.setValues(i,(ub[0]-_b[0])/r,(ub[1]-_b[1])/r,_b[0]/r,_b[1]/r)}(de.c.fromTypedArray(tw.uvMapSpace),de.T.fromTypedArray(tw.renderData.position),this._context.overlaySR),tw.outNum>0?new Nv(this,tw.outGeometries,tw.outBoundingBox):null)}_createAsOverlayFill(e){const t=e.renderData.polygons;for(const{position:i,holeIndices:r,index:s,count:n}of t){if((0,se.B)(Jb),(0,se.M)(Jb,i),!(0,se.R)(Jb,this._context.clippingExtent))continue;const t=(0,he.r)(i,r,3);if(0===t.length)continue;(0,se.f)(e.outBoundingBox,Jb);const a=mv({indices:new Uint32Array(t),attributeData:{position:i,color:e.color,uvMapSpace:this._needsUV?new Float32Array(e.uvMapSpace.buffer,4*s*e.uvMapSpace.BYTES_PER_ELEMENT,4*n):null}}),o=new py(a,(0,u.f)(this._material),e.layerUid,e.graphicsUid),l=Jb;(0,j.r)(o.boundingSphere,.5*(l[0]+l[3]),.5*(l[1]+l[4]),0,.5*Math.sqrt((l[3]-l[0])*(l[3]-l[0])+(l[4]-l[1])*(l[4]-l[1]))),e.outGeometries.push(o),e.outNum++}}_createAsOverlayOutline(e){if(!this._hasOutline)return;const t=e.renderData.outlines;for(let i=0;i<t.length;++i){const{position:r}=t[i];if((0,se.B)(Jb),(0,se.M)(Jb,r),!(0,se.R)(Jb,this._context.clippingExtent))continue;(0,se.f)(e.outBoundingBox,Jb);const s=by({removeDuplicateStartEnd:this._outlineMaterial instanceof Wy?0:1,attributeData:{position:r}}),n=new py(s,(0,u.f)(this._outlineMaterial),e.layerUid,e.graphicsUid),a=Jb;(0,j.r)(n.boundingSphere,.5*(a[0]+a[3]),.5*(a[1]+a[4]),0,.5*Math.sqrt((a[3]-a[0])*(a[3]-a[0])+(a[4]-a[1])*(a[4]-a[1]))),e.outGeometries.push(n),e.outNum++}}_getOutlineOpacity(){const e=(0,u.g)(this.symbolLayer,"outline","color");return(this.draped?1:this._getLayerOpacity())*((0,u.r)(e)?e.a:0)}_getOutlineColor(){const e=(0,u.g)(this.symbolLayer,"outline","color"),t=this._getOutlineOpacity();return Pu((0,u.r)(e)?z.o.toUnitRGB(e):null,t)}get test(){return{createAsOverlay:(e,t)=>this._createAsOverlay(e,t),createAs3DShape:(e,t,i)=>this._createAs3DShape(e,t,i)}}}Kb.elevationModeChangeTypes={definedChanged:Gu.RECREATE,staysOnTheGround:Gu.NONE,onTheGroundChanged:Gu.RECREATE};const Jb=(0,se.a)(),ew={renderData:null,color:null,uvMapSpace:null,boundingRect:null,outNum:0,outBoundingBox:null,outGeometries:null,outMaterials:null,outTransforms:null},tw={renderData:null,color:null,uvMapSpace:null,outNum:0,outBoundingBox:null,outGeometries:null,outMaterials:null,outTransforms:null};class iw{constructor(e){this.definition=e,this.key=JSON.stringify(e),this.haloSize=Math.round(e.halo.size),this.fillStyle=this.colorToRGBA(e.color),this.haloStyle=this.colorToRGB(e.halo.color)}colorToRGB(e){return`rgb(${e.slice(0,3).map((e=>Math.floor(255*e))).toString()})`}colorToRGBA(e){return`rgba(${e.slice(0,3).map((e=>Math.floor(255*e))).toString()},${e[3]})`}static fromSymbol(e,t=1){const i=(0,u.g)(e,"material","color"),r=(0,u.r)(i)?z.o.toUnitRGBA(i):w._,s=e.halo,n=null!=e.size?(0,f.u)(e.size):12,a={family:e.font&&e.font.family?e.font.family:"sans-serif",weight:e.font&&e.font.weight?e.font.weight:"normal",style:e.font&&e.font.style?e.font.style:"normal"},o=(0,u.r)(s)&&(0,u.r)(s.color)&&s.size>0?{size:(0,f.u)(s.size),color:z.o.toUnitRGBA(s.color)}:{size:0,color:w._};return new iw({size:n,color:r,font:a,halo:o,pixelRatio:t})}}class rw{constructor(e,t,i=2048){this.text=e,this._parameters=t,this.maxSize=i,this._lineWidths=new Array,this._renderPixelRatio=null,this._displayWidth=null,this.key=`${this._parameters.key}--${e}`,this._lines=e.split(/\r?\n/),this._lineHeight=this.computeLineHeight()}get displayWidth(){return this._ensureTextWidth()}get displayHeight(){return this._lineHeight*this._lines.length}get renderedWidth(){return Math.round(this.displayWidth*this.renderPixelRatio)}get renderedHeight(){return Math.round(this.displayHeight*this.renderPixelRatio)}get renderedLineHeight(){return Math.round(this._lineHeight*this.renderPixelRatio)}get renderedFontSize(){return this._parameters.definition.size*this.renderPixelRatio}get renderedHaloSize(){return this._parameters.haloSize*this.renderPixelRatio}get renderPixelRatio(){if((0,u.t)(this._renderPixelRatio)){const e=this._parameters.definition.pixelRatio;this.maxSize>0?this._renderPixelRatio=Math.min(e,Math.min(this.maxSize/(this.displayWidth*e),this.maxSize/(this.displayHeight*e))):this._renderPixelRatio=e}return this._renderPixelRatio}getLineXOffset(e){return Math.round((this.renderedWidth-this._lineWidths[e]*this.renderPixelRatio)/2)}render(e,t=0,i=0){const r=this.renderedLineHeight,s=this.renderedHaloSize,n=function(e,t){return"center"===e?.5*t:"right"===e?t:0}(e.textAlign,this.renderedWidth)+s,a=s+sw;e.save(),s>0&&this.renderHalo(e,n,a,t,i),this.setFontProperties(e,this.renderedFontSize),i+=a,t+=n;for(let s=0;s<this._lines.length;++s){e.globalCompositeOperation="destination-out",e.fillStyle="rgb(0, 0, 0)";const n=this._lines[s],a=this.getLineXOffset(s);e.fillText(n,t+a,i),e.globalCompositeOperation="source-over",e.fillStyle=this._parameters.fillStyle,e.fillText(n,t+this.getLineXOffset(s),i),i+=r}e.restore()}renderHalo(e,t,i,r,s){const n=this.renderedWidth,a=this.renderedHeight,o=aw(ow,Math.max(n,lw),Math.max(a,lw)),l=o.getContext("2d");l.clearRect(0,0,n,a),this.setFontProperties(l,this.renderedFontSize),l.fillStyle=this._parameters.haloStyle,l.strokeStyle=this._parameters.haloStyle;const c=this.renderedHaloSize<3;l.lineJoin=c?"miter":"round",c?this.renderHaloEmulated(l,t,i):this.renderHaloNative(l,t,i),e.globalAlpha=this._parameters.definition.halo.color[3],e.drawImage(o,0,0,n,a,r,s,n,a),e.globalAlpha=1}renderHaloEmulated(e,t,i){const r=this.renderedLineHeight,s=this.renderedHaloSize;for(let n=0;n<this._lines.length;++n){const a=this._lines[n],o=this.getLineXOffset(n);for(const[r,n]of nw)e.fillText(a,t+o+s*r,i+s*n);i+=r}}renderHaloNative(e,t,i){const r=this.renderedLineHeight,s=this.renderedHaloSize;for(let n=0;n<this._lines.length;++n){const a=2*s,o=this._lines[n],l=this.getLineXOffset(n),c=5,h=.1;for(let r=0;r<c;r++){const s=1-(c-1)*h+r*h;e.lineWidth=s*a,e.strokeText(o,t+l,i)}i+=r}}setFontProperties(e,t){const i=this._parameters.definition.font,r=`${i.style} ${i.weight} ${t}px ${i.family}, sans-serif`;e.font=r,e.textAlign="left",e.textBaseline="top"}_ensureTextWidth(){if((0,u.r)(this._displayWidth))return this._displayWidth;const e=aw(ow,lw,lw).getContext("2d");this.setFontProperties(e,this._parameters.definition.size);let t=0,i=2*this._parameters.haloSize;this._lineWidths.length=0;const r=this._parameters.definition.font;("italic"===r.style||"oblique"===r.style||"string"==typeof r.weight&&("bold"===r.weight||"bolder"===r.weight)||"number"==typeof r.weight&&r.weight>600)&&(i+=.3*e.measureText("A").width);for(const r of this._lines){const s=Math.round(e.measureText(r).width+i);this._lineWidths.push(s),t=Math.max(t,s)}return this._displayWidth=t,this._displayWidth}computeLineHeight(){const e=1.275*this._parameters.definition.size;return Math.ceil(e+2*this._parameters.haloSize)+sw}}const sw=1,nw=[];{const e=16;for(let t=0;t<360;t+=360/e)nw.push([Math.cos(Math.PI*t/180),Math.sin(Math.PI*t/180)])}function aw(e,t,i){return e.canvas||(e.canvas=document.createElement("canvas")),e.canvas.width=t,e.canvas.height=i,e.canvas}const ow={canvas:null},lw=512;class cw extends S.m{constructor(e,t,i){super(),this.type=4,this._glTexture=null,this.events=new n.n,this._requiresPowerOfTwo=!(0,q.n)(e.gl),this._renderer=new rw(t,i)}get width(){return this._renderer.renderedWidth}get height(){return this._renderer.renderedHeight}get textureWidth(){const e=this.width;return this._requiresPowerOfTwo?(0,v.O)(e):e}get textureHeight(){const e=this.height;return this._requiresPowerOfTwo?(0,v.O)(e):e}get displayWidth(){return this._renderer.displayWidth}get displayHeight(){return this._renderer.displayHeight}get texcoordScale(){return[this._renderer.renderedWidth/this.textureWidth,this._renderer.renderedHeight/this.textureHeight]}get requiresFrameUpdates(){return!1}createDescriptor(e){return{target:3553,pixelFormat:6408,dataType:5121,wrapMode:33071,flipped:!0,samplingMode:9987,hasMipmap:!0,preMultiplyAlpha:!0,maxAnisotropy:e.parameters.maxMaxAnisotropy}}load(e){if((0,u.r)(this._glTexture))return this._glTexture;const t=aw(hw,this.textureWidth,this.textureHeight),i=t.getContext("2d");return i.save(),this._renderer.render(i,0,this.textureHeight-this._renderer.renderedHeight),this._glTexture=new q.r(e,this.createDescriptor(e),t),i.restore(),this._glTexture}unload(){(0,u.r)(this._glTexture)&&(this._glTexture.dispose(),this._glTexture=null),this.events.emit("unloaded")}}const hw={canvas:null},dw=[0,0,1];function uw(e,t,i){e&&e.forEach((e=>{const r=t(e);(0,u.r)(r)&&i(r,e.graphic)}))}const pw={mode:"relative-to-ground",offset:0},mw={text:null,translation:[0,0,0],elevationOffset:0,centerOffset:[0,0,0,1],screenOffset:[0,0],anchor:"center",verticalOffset:null,centerOffsetUnits:null,debugDrawBorder:!1,displayWidth:0,displayHeight:0};class fw{constructor(e=!0){this.enabled=e,this._time=0}get time(){return(0,u.r)(this._forcedTime)?this._forcedTime:(0,r.w)(this._time)}advance(e){return this.enabled&&(this._time+=e),(0,u.t)(this._forcedTime)&&this.enabled&&0!==e}stopAtTime(e){this._forcedTime=e}}const gw={waveStrength:.06,waveTextureRepeat:32,waveDirection:(0,N.t)(1,0),waveVelocity:.05,flowStrength:.015,flowOffset:-.5,animationSpeed:.35,color:[0,0,0,0],transparent:!0,writeDepth:!0,slicePlaneEnabled:!1,isDraped:!1,receiveShadows:!0,ssrEnabled:!1,...S.ab},vw={"calm-small":{waveStrength:.005,perturbationStrength:.02,textureRepeat:12,waveVelocity:.01},"rippled-small":{waveStrength:.02,perturbationStrength:.09,textureRepeat:32,waveVelocity:.07},"slight-small":{waveStrength:.05,perturbationStrength:.07,textureRepeat:28,waveVelocity:.1},"moderate-small":{waveStrength:.075,perturbationStrength:.07,textureRepeat:24,waveVelocity:.1},"calm-medium":{waveStrength:.003125,perturbationStrength:.01,textureRepeat:8,waveVelocity:.02},"rippled-medium":{waveStrength:.035,perturbationStrength:.015,textureRepeat:12,waveVelocity:.07},"slight-medium":{waveStrength:.06,perturbationStrength:.015,textureRepeat:8,waveVelocity:.12},"moderate-medium":{waveStrength:.09,perturbationStrength:.03,textureRepeat:4,waveVelocity:.12},"calm-large":{waveStrength:.01,perturbationStrength:0,textureRepeat:4,waveVelocity:.05},"rippled-large":{waveStrength:.025,perturbationStrength:.01,textureRepeat:8,waveVelocity:.11},"slight-large":{waveStrength:.06,perturbationStrength:.02,textureRepeat:3,waveVelocity:.13},"moderate-large":{waveStrength:.14,perturbationStrength:.03,textureRepeat:2,waveVelocity:.15}};class yw extends S.a6{constructor(e){super(e,gw),this.animation=new fw,this.techniqueConfig=new yg}getTechniqueConfig(e,t){return this.techniqueConfig.output=e,this.techniqueConfig.writeDepth=this.params.writeDepth,this.techniqueConfig.receiveShadows=this.params.receiveShadows,this.techniqueConfig.slicePlaneEnabled=this.params.slicePlaneEnabled,this.techniqueConfig.transparent=this.params.transparent,this.techniqueConfig.useSSR=this.params.ssrEnabled,this.techniqueConfig.isDraped=this.params.isDraped,this.techniqueConfig.transparencyPassType=t?t.transparencyPassType:3,this.techniqueConfig.enableOffset=!t||t.camera.relativeElevation<S.b8,this.techniqueConfig.multipassTerrainEnabled=!!t&&t.multipassTerrainEnabled,this.techniqueConfig.cullAboveGround=!!t&&t.cullAboveGround,this.techniqueConfig}update(e){const t=Math.min(e.camera.relativeElevation,e.camera.distance);this.animation.enabled=Math.sqrt(this.params.waveTextureRepeat/this.params.waveStrength)*t<_w;const i=this.animation.advance(e.dt);return this.animation.enabled&&i}intersect(e,t,i,r,s,n,a){(0,S.b9)(e,t,r,s,n,void 0,a)}getGLMaterial(e){if(0===e.output&&this.params.isDraped){const t=e;return t.output=5,new _g(t)}switch(e.output){case 0:case 2:case 4:case 7:return new _g(e)}}createBufferWriter(){return new By(Uy)}}const _w=35e3,xw=["polyline","polygon","extent"];class bw extends Vp{constructor(e,t,i,r){super(e,t,i,r)}async doLoad(){}destroy(){super.destroy(),this._context.stage.remove(this._material),this._material=null}createGraphics3DGraphic(e){const t=e.graphic;if(!this._validateGeometry(t.geometry,xw,this.symbolLayer.type))return null;const i=this.setGraphicElevationContext(t,new hp);return this.ensureDrapedStatus("on-the-ground"===i.mode),this.ensureMaterial(),this.draped?this._createAsOverlay(t):this._createAs3DShape(t,i,t.uid)}ensureMaterial(){if((0,u.r)(this._material))return;const e={...gw},t=this.symbolLayer.color;(0,u.r)(t)&&(e.color=z.o.toUnitRGBA(t));const i=this._getCombinedOpacity(t,{hasIntrinsicColor:!0});e.color=[e.color[0],e.color[1],e.color[2],i],e.transparent=i<1||this.needsDrivenTransparentPass,e.waveDirection=(0,u.r)(this.symbolLayer.waveDirection)?bw.headingVectorFromAngle(this.symbolLayer.waveDirection):(0,N.t)(0,0);const r=this.symbolLayer.waveStrength+"-"+this.symbolLayer.waterbodySize,s=vw[r];e.waveStrength=s.waveStrength,e.waveTextureRepeat=s.textureRepeat,e.waveVelocity=s.waveVelocity,e.flowStrength=s.perturbationStrength,e.slicePlaneEnabled=this._context.slicePlaneEnabled,e.isDraped=this.draped,this._material=new yw(e),this._context.stage.add(this._material)}layerOpacityChanged(){if((0,u.t)(this._material))return!0;const e=this._material.params.color,t=this._getCombinedOpacity(this.symbolLayer.color,{hasIntrinsicColor:!0}),i=t<1||this.needsDrivenTransparentPass;return this._material.setParameterValues({color:[e[0],e[1],e[2],t],transparent:i}),!0}layerElevationInfoChanged(e,t,i){const r=this._elevationContext.mode,s=Lu(bw.elevationModeChangeTypes,i,r);if(s!==Gu.UPDATE)return s;const n=Fu(r);return this.updateGraphics3DGraphicElevationInfo(e,t,(()=>n))}slicePlaneEnabledChanged(){return(0,u.r)(this._material)&&this._material.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled}),!0}physicalBasedRenderingChanged(){return!0}pixelRatioChanged(){return!0}_createAs3DShape(e,t,i){const r=gv(e.geometry);if((0,u.t)(r))return null;Pw.renderData=vv(r,this._context.elevationProvider,this._context.renderCoordsHelper,t);const s=Pw.renderData.position.length/3;if(Pw.uvCoords=new Float64Array(2*s),Pw.outNum=0,Pw.outGeometries=[],Pw.outTransforms=[],Pw.outMaterials=[],this._create3DShapeGeometries(Pw),this._logGeometryCreationWarnings(Pw.renderData,r.rings,"rings","WaterSymbol3DLayer"),0===Pw.outNum)return null;this._createUVCoordsFromVertices(Pw.uvCoords,Pw.renderData.mapPosition,s,this._context.elevationProvider.spatialReference);const n=new Qs({geometries:Pw.outGeometries,materials:Pw.outMaterials,transformations:Pw.outTransforms,castShadow:!1,metadata:{layerUid:this._context.layer.uid,graphicUid:i}}),a=ju,o=new dp(this,n,Pw.outGeometries,null,null,a,t);return o.alignedSampledElevation=Pw.renderData.sampledElevation,o.needsElevationUpdates=Fu(t.mode),o}_createUVCoordsFromVertices(e,t,i,r){const s=(0,x.G)(r);(0,b.B)(Cw);for(let e=0;e<i;e++)(0,k.r)(Tw,t[3*e+0],t[3*e+1]),(0,b.f)(Cw,Tw);(0,j.l)(Cw,Cw,s);const n=Cw[0]%bw.unitSizeOfTexture,a=Cw[1]%bw.unitSizeOfTexture;ww[0]=Cw[0]-n,ww[1]=Cw[1]-a;for(let r=0;r<i;r++)e[2*r+0]=(t[3*r+0]*s-ww[0])/bw.unitSizeOfTexture,e[2*r+1]=(t[3*r+1]*s-ww[1])/bw.unitSizeOfTexture}_create3DShapeGeometries(e){const t=e.renderData.polygons,i=e.uvCoords;for(const{count:r,index:s,position:n,mapPosition:a,holeIndices:o}of t){if((0,u.r)(this._context.clippingExtent)&&((0,se.B)(Sw),(0,se.M)(Sw,a),!(0,se.R)(Sw,this._context.clippingExtent)))continue;const t=(0,he.r)(a,o,3);if(0===t.length)continue;const l=fv({indices:new Uint32Array(t),attributeData:{position:n,uv0:new Float64Array(i.buffer,2*s*i.BYTES_PER_ELEMENT,2*r),mapPosition:a}});e.outGeometries.push(l),e.outMaterials.push((0,u.f)(this._material)),e.outTransforms.push(T.a),e.outNum++}}_createAsOverlay(e){const t=gv(e.geometry);if((0,u.t)(t))return null;(0,u.f)(this._material).renderPriority=this._renderPriority,Rw.renderData=yv(t,this._context.overlaySR);const i=Rw.renderData.position.length/3;return Rw.uvCoords=new Float64Array(2*i),Rw.outNum=0,Rw.outGeometries=[],Rw.outBoundingBox=(0,se.B)(),Rw.layerUid=this._context.layer.uid,Rw.graphicsUid=e.uid,this._createAsOverlayWater(Rw),this._logGeometryCreationWarnings(Rw.renderData,t.rings,"rings","WaterSymbol3DLayer"),0===Rw.outNum?null:(this._createUVCoordsFromVertices(Rw.uvCoords,Rw.renderData.position,i,this._context.overlaySR),Rw.outNum>0?new Nv(this,Rw.outGeometries,Rw.outBoundingBox):null)}_createAsOverlayWater(e){const t=e.uvCoords,i=e.renderData.polygons;for(const{position:r,holeIndices:s,index:n,count:a}of i){if((0,se.B)(Sw),(0,se.M)(Sw,r),!(0,se.R)(Sw,this._context.clippingExtent))continue;(0,se.f)(e.outBoundingBox,Sw);const i=(0,he.r)(r,s,3);if(0===i.length)continue;const o=fv({indices:new Uint32Array(i),attributeData:{position:r,uv0:new Float64Array(t.buffer,2*n*t.BYTES_PER_ELEMENT,2*a)}}),l=new py(o,(0,u.f)(this._material),e.layerUid,e.graphicsUid),c=Sw;(0,j.r)(l.boundingSphere,.5*(c[0]+c[3]),.5*(c[1]+c[4]),0,.5*Math.sqrt((c[3]-c[0])*(c[3]-c[0])+(c[4]-c[1])*(c[4]-c[1]))),e.outGeometries.push(l),e.outNum++}}static headingVectorFromAngle(e){const t=(0,N.n)(),i=(0,v.r)(e);return t[0]=Math.sin(i),t[1]=Math.cos(i),t}get test(){return{create3DShape:e=>this._createAs3DShape(e.graphic,e.elevationContext,e.graphicUid),ensureMaterial:()=>this.ensureMaterial()}}}bw.unitSizeOfTexture=100,bw.elevationModeChangeTypes={definedChanged:Gu.RECREATE,staysOnTheGround:Gu.NONE,onTheGroundChanged:Gu.RECREATE};const ww=(0,N.n)(),Cw=(0,b.i)(),Tw=(0,N.n)(),Sw=(0,se.a)(),Pw={renderData:null,uvCoords:null,outNum:0,outBoundingBox:null,outGeometries:null,outMaterials:null,outTransforms:null},Rw={renderData:null,uvCoords:null,outNum:0,outBoundingBox:null,outGeometries:null,outMaterials:null,outTransforms:null},Aw=u.n.getLogger("esri.views.3d.layers.graphics.Graphics3DSymbolLayerFactory");function Mw(e,t,i,r){const s=Dw[e.type]&&Dw[e.type][t.type]||Ow[t.type];return s?new s(e,t,i,r):(Aw.error("GraphicsLayerFactory#make",`unknown symbol type ${t.type}`),null)}const Ow={icon:vy,object:class extends Vp{constructor(e,t,i,r){super(e,t,i,r),this._resources=null,this._optionalFields=new Array,this._instanceIndexToGraphicUid=new Map,this.hasLoadedPBRTextures=!1,this.ensureDrapedStatus(!1),this.hasLoadedPBRTextures=i.physicalBasedRenderingEnabled}getCachedSize(){const[e,t,i]=(0,u.r)(this._resources)?this._resources.symbolSize:[1,1,1];return{width:e,depth:t,height:i}}async doLoad(e){if(!this._drivenProperties.size&&Mu(this.symbolLayer))throw new Error;const t=this.symbolLayer;if(this.isPrimitive){const i=t.resource?t.resource.primitive:L.r;this._resources=await this._createResourcesForPrimitive(i,e)}else this._resources=await this._createResourcesForUrl(t.resource.href,e);this.layerOpacityChanged(),this.slicePlaneEnabledChanged(),this.physicalBasedRenderingChanged(),this.complexity=this.computeComplexity()}get extentPadding(){return(0,u.r)(this._resources)?this._resources.extentPadding:0}get isPrimitive(){return!(this.symbolLayer.resource&&this.symbolLayer.resource.href)}get lodRenderer(){return(0,u.g)(this._resources,"lodRenderer")}setMaterialTransparencyParams(e,t=(0,u.g)(this.symbolLayer,"material","color")){const i=this._getCombinedOpacity(t),r=i<1||this.needsDrivenTransparentPass;return e.transparent=r,e.opacity=i,e.cullFace=r?0:2,e}async _createResourcesForPrimitive(e,t){if(!function(e){switch(e){case"sphere":case"cube":case"diamond":case"cylinder":case"cone":case"inverted-cone":case"tetrahedron":return!0}return!1}(e))throw new Error(`Unknown object symbol primitive: ${e}`);const i=this.symbolLayer,r=(0,se.a)((0,ye.s)(e)),s=(0,v.M)((0,se.F)(r)),n=(0,v.M)((0,ye.t)(s,i)),a=(0,v.s)(n),o={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0,instanced:["transformation"],ambient:v.l,diffuse:v.l,slicePlaneEnabled:this._context.slicePlaneEnabled,sliceHighlightDisabled:!0,castShadows:this.symbolLayer.castShadows,offsetTransparentBackfaces:!this.symbolLayer.isPrimitive},l=o.usePBR;this.setMaterialTransparencyParams(o);const c=this.symbol;if("point-3d"===c.type&&c.verticalOffset){const{screenLength:e,minWorldLength:t,maxWorldLength:i}=c.verticalOffset;o.verticalOffset={screenLength:(0,f.u)(e),minWorldLength:t||0,maxWorldLength:null!=i?i:1/0},o.castShadows=!1}if(this._context.screenSizePerspectiveEnabled&&(o.screenSizePerspective=this._context.sharedResources.screenSizePerspectiveSettings),this._drivenProperties.color)o.externalColor=w.d;else{const e=(0,u.r)(i.material)&&i.material.color,t=(0,u.r)(e)?z.o.toUnitRGBA(e):w.d;o.externalColor=t}this._fastUpdates=ny(this._context.renderer,this._fastVisualVariableConvertOptions(r,n,s,u.G)),this._fastUpdates.enabled?(Object.assign(o,this._fastUpdates.materialParameters),o.instanced.push("featureAttribute"),this._optionalFields.push("featureAttribute")):this._hasPerInstanceColor()&&(o.instanced.push("color"),this._optionalFields.push("color"));const h=yp(e,new S.aR(o));if(!h)throw new Error(`Unknown object symbol primitive: ${e}`);const d=Sp(h).map((e=>({opacity:1,transparent:e.params.transparent}))),p=this._createStageResources(h,l);return{lodResources:h,lodRenderer:await this._createLodRenderer(h,t),stageResources:p,symbolSize:n,extentPadding:a,isEsriSymbolResource:!1,isWosr:!1,originalMaterialParameters:d,physicalBasedRenderingEnabled:l,resourceBoundingBox:r,resourceSize:s,dispose:u.G,pivotOffset:u.G}}async _createResourcesForUrl(e,t){const i=["transformation"],r={materialParamsMixin:{instanced:i,slicePlaneEnabled:this._context.slicePlaneEnabled,castShadows:this.symbolLayer.castShadows},streamDataRequester:this._context.streamDataRequester,cache:this._context.sharedResources.objectResourceCache};this._fastUpdates=ny(this._context.renderer,this._fastVisualVariableConvertOptions(u.G,u.G,u.G,u.G)),this._fastUpdates.enabled?(Object.assign(r.materialParamsMixin,this._fastUpdates.materialParameters),i.push("featureAttribute"),this._optionalFields.push("featureAttribute")):this._hasPerInstanceColor()&&(i.push("color"),this._optionalFields.push("color"));const s=this.symbol;if("point-3d"===s.type&&s.verticalOffset){const{screenLength:e,minWorldLength:t,maxWorldLength:i}=s.verticalOffset;r.materialParamsMixin.verticalOffset={screenLength:(0,f.u)(e),minWorldLength:t||0,maxWorldLength:null!=i?i:1/0},r.materialParamsMixin.castShadows=!1}r.signal=t,r.usePBR=this._context.physicalBasedRenderingEnabled;const n=r.usePBR,a=await(0,S.a_)(e,r),o=a.isEsriSymbolResource,l=a.isWosr,c=a.remove,h=function(e){return{levels:e.map((e=>function(e){const t=[];return e.stageResources.geometries.forEach(((i,r)=>{const s=e.stageResources.materials[r],n=e.stageResources.textures;t.push({material:s,geometry:i,textures:n})})),{components:t,minScreenSpaceRadius:e.lodThreshold,pivotOffset:e.pivotOffset}}(e)))}}(a.lods);(function(e){e.levels.forEach((e=>{e.minScreenSpaceRadius||(e.minScreenSpaceRadius=function(e,t=M_){const i=function(e){return Pp(e).reduce(((e,t)=>e+t.indexCount/3),0)}(e);return Math.sqrt(i/(t*Math.PI))}(e))}))})(h),h.levels.sort(((e,t)=>e.minScreenSpaceRadius-t.minScreenSpaceRadius)),h.levels[0].minScreenSpaceRadius=Math.min(2,h.levels[0].minScreenSpaceRadius);const d=this._context,p=this.symbolLayer.material,m=this._getExternalColorParameters(p),g=(0,u.g)(this.symbolLayer,"material","color"),y=this._getCombinedOpacity(g,{hasIntrinsicColor:!0}),_=this.needsDrivenTransparentPass,x=Sp(h),b=Sp(h).map((e=>({opacity:e.params.opacity||1,transparent:e.params.transparent})));x.forEach((e=>{const t=e.params;e.setParameterValues(m);const i=t.opacity*y,r=i<1||_||t.transparent;e.setParameterValues({opacity:i,transparent:r}),d.screenSizePerspectiveEnabled&&e.setParameterValues({screenSizePerspective:d.sharedResources.screenSizePerspectiveSettings})}));const w=a.referenceBoundingBox,C=(0,v.M)((0,se.F)(w)),T=(0,v.M)(h.levels[0].pivotOffset),P=(0,v.M)((0,ye.t)(C,this.symbolLayer)),R=(0,v.s)(P);ay(this._fastUpdates,this._context.renderer,this._fastVisualVariableConvertOptions(w,P,C,T))&&x.forEach((e=>e.setParameterValues(this._fastUpdates.materialParameters)));const A=this._createStageResources(h,n);return{lodResources:h,lodRenderer:await this._createLodRenderer(h,t),stageResources:A,symbolSize:P,extentPadding:R,isEsriSymbolResource:o,isWosr:l,originalMaterialParameters:b,physicalBasedRenderingEnabled:n,resourceBoundingBox:w,resourceSize:C,dispose:c,pivotOffset:T}}_createStageResources(e,t){const i=this._context.stage,s=Sp(e);t!==this._context.physicalBasedRenderingEnabled&&this.physicalBasedRenderingChanged(),i.addMany(s);const n=function(e){const t=[];return e.levels.forEach((e=>{e.components.forEach((e=>{e.textures&&t.push(...e.textures)}))})),(0,r.F)(t)}(e);i.addMany(n);const a=function(e){const t=[];return e.levels.forEach((e=>{e.components.forEach((e=>{t.push(e.geometry)}))})),(0,r.F)(t)}(e);return i.addMany(a),{materials:s,textures:n,geometries:a}}async _createLodRenderer(e,t){const i=this._context.stage,r={layerUid:this._context.layer.uid,graphicUid:e=>this._instanceIndexToGraphicUid.get(e),notifyGraphicGeometryChanged:e=>this._context.notifyGraphicGeometryChanged(this._instanceIndexToGraphicUid.get(e)),notifyGraphicVisibilityChanged:e=>this._context.notifyGraphicVisibilityChanged(this._instanceIndexToGraphicUid.get(e))},s=this._fastUpdates.enabled?{applyTransform:(e,t,i)=>{e.getFeatureAttribute(t,ox),(0,C.n)(i,dy(this._fastUpdates.materialParameters,ox,i))},scaleFactor:(e,t,i)=>(t.getFeatureAttribute(i,ox),uy(e,this._fastUpdates.materialParameters,ox))}:null,n=new X_(e,this._optionalFields,r,s);return n.slicePlane=this._context.slicePlaneEnabled,await i.addRenderPlugin(n.slots,n,t),n}_getExternalColorParameters(e){const t={};return this._drivenProperties.color?t.externalColor=w.d:(0,u.r)(e)&&(0,u.r)(e.color)?t.externalColor=z.o.toUnitRGBA(e.color):(t.externalColor=w.d,t.colorMixMode="ignore"),t}destroy(){super.destroy();const e=this._context.stage;if((0,u.r)(this._resources)){e.removeRenderPlugin(this._resources.lodRenderer);const t=this._resources.stageResources;e.removeMany(t.materials),e.removeMany(t.textures),e.removeMany(t.geometries),(0,u.r)(this._resources.dispose)&&this._resources.dispose()}this._resources=null}createGraphics3DGraphic(e){const t=e.graphic;if(!this._validateGeometry(t.geometry))return null;const i=Hp(t.geometry);if((0,u.t)(i))return this.logger.warn(`unsupported geometry type for icon symbol: ${t.geometry.type}`),null;const r=this.setGraphicElevationContext(t,new hp),s=e.renderingInfo;return this._createAs3DShape(t,i,s,r,t.uid)}notifyDestroyGraphicLayer(e){this._instanceIndexToGraphicUid.delete(e.instanceIndex)}graphicLayerToGraphicId(){return 0}layerOpacityChanged(){if((0,u.t)(this._resources))return!0;const e=this._drivenProperties.opacity,t=!this.isPrimitive,i=this._resources.stageResources.materials,r=this._resources.originalMaterialParameters;for(let s=0;s<i.length;s++){const n=i[s],a=(0,u.g)(this.symbolLayer,"material","color"),o=r[s],l=this._getCombinedOpacity(a,{hasIntrinsicColor:t})*o.opacity,c=l<1||e||o.transparent;n.setParameterValues({opacity:l,transparent:c}),this.isPrimitive&&n.setParameterValues({cullFace:c?0:2})}return!0}layerElevationInfoChanged(e,t){return this.updateGraphics3DGraphicElevationInfo(e,t,Vu)}slicePlaneEnabledChanged(){if((0,u.t)(this._resources))return!0;this._resources.lodRenderer.slicePlane=this._context.slicePlaneEnabled;for(const e of this._resources.stageResources.materials)e.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled});return!0}physicalBasedRenderingChanged(){if((0,u.t)(this._resources))return!0;const{stageResources:e,isWosr:t}=this._resources;for(const i of e.materials)this.isPrimitive?i.setParameterValues({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}):t||i.setParameterValues({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!1});return!1!==this.hasLoadedPBRTextures||!0!==this._context.physicalBasedRenderingEnabled||(this.hasLoadedPBRTextures=!0,!1)}pixelRatioChanged(){return!0}applyRendererDiff(e,t){if((0,u.t)(this._resources))return!0;const{stageResources:{materials:i},lodRenderer:r,resourceBoundingBox:s,symbolSize:n,resourceSize:a,pivotOffset:o}=this._resources;for(const l in e.diff)switch(l){case"visualVariables":if(!ay(this._fastUpdates,t,this._fastVisualVariableConvertOptions(s,n,a,o)))return!1;for(const e of i)e.setParameterValues(this._fastUpdates.materialParameters);r.notifyShaderTransformationChanged();break;default:return!1}return!0}computeComplexity(){return(0,u.t)(this._resources)?super.computeComplexity():{primitivesPerFeature:Pp(this._resources.lodResources.levels[0]).reduce(((e,t)=>e+t.indices.get("position").length),0)/3,primitivesPerCoordinate:0,drawCallsPerFeature:0,estimated:!1,memory:zp(this.symbol,this.symbolLayer)}}hasLodRenderer(){return(0,u.r)(this._resources)}_createAs3DShape(e,t,i,r,s){if(!this.hasLodRenderer()||(0,u.t)(this._resources))return null;const n=this.getFastUpdateAttrValues(e),a=!this._fastUpdates.enabled&&this._hasPerInstanceColor()?Pu(i.color,i.opacity):null,o=this._context.clippingExtent;if((0,_.R)(t,sx,this._context.elevationProvider.spatialReference),(0,u.r)(o)&&!(0,se.E)(o,sx))return null;const l=this._requiresTerrainElevation(r),c=this._computeGlobalTransform(t,r,ax,l?lx:null),h=this._computeLocalTransform(this._resources,this.symbolLayer,i,nx),d=this._resources.lodRenderer.instanceData,p=d.addInstance();this._instanceIndexToGraphicUid.set(p,s),d.setLocalTransform(p,h,!1),d.setGlobalTransform(p,c),n&&d.setFeatureAttribute(p,n),a&&d.setColor(p,a);const m=new C_(this,p,Qu,r);return l&&(m.alignedSampledElevation=lx.sampledElevation),m.needsElevationUpdates=Vu(r.mode),jp(m,t,this._context.elevationProvider),m}_computeGlobalTransform(e,t,i,r){const s=Iu(e,this._context.elevationProvider,t,this._context.renderCoordsHelper,r);return sx[0]=e.x,sx[1]=e.y,sx[2]=s,(0,_.S)(e.spatialReference,sx,i,this._context.renderCoordsHelper.spatialReference),i}_computeLocalTransform(e,t,i,r){return(0,C.r)(r),this._applyObjectRotation(i,!1,r),this._applyObjectRotation(t,!0,r),this._applyObjectScale(e,i,r),this._applyAnchor(e,t,r),r}_applyObjectScale(e,t,i){if(this._fastUpdates.enabled&&this._fastUpdates.requiresShaderTransformation)return;const r=Au(this._drivenProperties.size&&t.size?t.size:e.symbolSize,e.symbolSize,e.resourceSize,this._context.renderCoordsHelper.unitInMeters);1===r[0]&&1===r[1]&&1===r[2]||(0,C.i)(i,i,r)}prepareSymbolLayerPatch(e){if("partial"!==e.diff.type)return;const t=e.diff.diff;this._preparePatchTransform(e,t),this._preparePatchColor(e,t)}updateGeometry(e,t){if((0,u.t)(this._resources))return!0;const i=t&&Hp(t);if((0,u.t)(i))return!1;const r=this.getGeometryElevationMode(t);if(e.elevationContext.mode!==r)return!1;const s=this._requiresTerrainElevation(e.elevationContext);return this._computeGlobalTransform(i,e.elevationContext,ax,s?lx:null),s&&(e.alignedSampledElevation=lx.sampledElevation),this._resources.lodRenderer.instanceData.setGlobalTransform(e.instanceIndex,ax,!0),jp(e,i,this._context.elevationProvider),!0}_preparePatchTransform(e,t){if(!(t.heading||t.tilt||t.roll||t.width||t.height||t.depth||t.anchor||t.anchorPosition))return;if((0,u.t)(this._resources))return;const i=(e,t,i)=>(0,u.q)(null!=e&&"complete"===e.type?e.newValue:t,i),r=i(t.heading,this.symbolLayer.heading,0),s=i(t.tilt,this.symbolLayer.tilt,0),n=i(t.roll,this.symbolLayer.roll,0),a=i(t.width,this.symbolLayer.width,void 0),o=i(t.height,this.symbolLayer.height,void 0),l=i(t.depth,this.symbolLayer.depth,void 0),c=i(t.anchor,this.symbolLayer.anchor,void 0),h=i(t.anchorPosition,this.symbolLayer.anchorPosition,void 0);delete t.heading,delete t.tilt,delete t.roll,delete t.width,delete t.height,delete t.depth,delete t.anchor,delete t.anchorPosition;const d={heading:r,tilt:s,roll:n,anchor:c,anchorPosition:h},p=this._resources;1===this.loadStatus&&e.symbolLayerStatePatches.push((()=>{p.symbolSize=(0,v.M)((0,ye.t)(p.resourceSize,{width:a,height:o,depth:l,isPrimitive:this.symbolLayer.isPrimitive}))})),e.graphics3DGraphicPatches.push(((e,t)=>{const i=this._computeLocalTransform(p,d,t,nx),r=e.instanceIndex;p.lodRenderer.instanceData.setLocalTransform(r,i,!0)}))}_preparePatchColor(e,t){if(!t.material||"partial"!==t.material.type)return;const i=t.material.diff;if(!i.color||"complete"!==i.color.type||null==i.color.newValue||null==i.color.oldValue)return;const r=i.color.newValue,s=(0,u.r)(r)?z.o.toUnitRGBA(r):w.d;delete i.color;const n=this._resources;(0,u.t)(n)||e.graphics3DGraphicPatches.push((e=>{let t;this._hasPerInstanceColor()?(n.lodRenderer.instanceData.setColor(e.instanceIndex,s),t=this.setMaterialTransparencyParams({},r)):t=this.setMaterialTransparencyParams({externalColor:s},r);for(const e of n.stageResources.materials)e.setParameterValues(t)}))}_requiresTerrainElevation(e){return"absolute-height"!==e.mode}_applyObjectRotation(e,t,i){if(!(this._fastUpdates.enabled&&this._fastUpdates.requiresShaderTransformation&&t))return function(e,t,i,r=(0,T.e)()){const s=e||0,n=t||0,a=i||0;return 0!==s&&(0,C.m)(r,r,-s/180*Math.PI),0!==n&&(0,C.b)(r,r,n/180*Math.PI),0!==a&&(0,C.l)(r,r,a/180*Math.PI),r}(e.heading,e.tilt,e.roll,i)}_computeAnchor(e,t,i){const r=(0,v.n)();switch(i.anchor){case"center":(0,v.h)(r,(0,se.p)(e)),(0,v.E)(r,r);break;case"top":{const t=(0,se.p)(e);(0,v.a)(r,-t[0],-t[1],-e[5]);break}case"bottom":{const t=(0,se.p)(e);(0,v.a)(r,-t[0],-t[1],-e[2]);break}case"relative":{const t=(0,se.p)(e),s=(0,se.F)(e),n=i.anchorPosition,a=n?(0,v.i)(n.x,n.y,n.z):v.G;(0,v.P)(r,s,a),(0,v.u)(r,r,t),(0,v.E)(r,r);break}case"origin":default:(0,u.r)(t)?(0,v.E)(r,t):(0,v.h)(r,v.G)}return r}_applyAnchor(e,t,i){if(this._fastUpdates.enabled&&this._fastUpdates.requiresShaderTransformation)return;const r=this._computeAnchor(e.resourceBoundingBox,e.pivotOffset,t);r&&(0,C.c)(i,i,r)}_hasPerInstanceColor(){return this._drivenProperties.color||this._drivenProperties.opacity}_fastVisualVariableConvertOptions(e,t,i,r){const s=(0,u.r)(e)?(0,v.M)((0,se.F)(e)):v.l,n=(0,u.r)(e)?this._computeAnchor(e,r,this.symbolLayer):v.G,a=this._context.renderCoordsHelper.unitInMeters,o=Au((0,u.r)(t)?t:void 0,t,i,a),l=(0,v.i)(this.symbolLayer.tilt||0,this.symbolLayer.roll||0,this.symbolLayer.heading||0);return{modelSize:s,symbolSize:(0,u.r)(t)?t:v.l,unitInMeters:a,transformation:{anchor:n,scale:o,rotation:l}}}},line:Oy,path:class extends Vp{constructor(e,t,i,r){super(e,t,i,r),this._intrinsicSize=(0,N.t)(1,1),this.upVectorAlignment="path",this.stencilWidth=.1,this.ensureDrapedStatus(!1)}async doLoad(){const e=(0,u.r)(this.symbolLayer.width)?this.symbolLayer.width:(0,u.r)(this.symbolLayer.height)?this.symbolLayer.height:this.symbolLayer.size,t=(0,u.r)(this.symbolLayer.height)?this.symbolLayer.height:e;this._vvConvertOptions={modelSize:[1,1,1],symbolSize:[e,1,t],unitInMeters:this._context.renderCoordsHelper.unitInMeters,transformation:{anchor:[0,0,0],scale:[1,1,1],rotation:[0,0,0]},supportedTypes:{size:!0,color:!0,opacity:!0,rotation:!1}},this._context.renderer&&this._context.renderer.visualVariables&&this._context.renderer.visualVariables.length>0?this._fastUpdates=ny(this._context.renderer,this._vvConvertOptions):this._fastUpdates={enabled:!1};const i=this.symbolLayer.anchor||"center";this.upVectorAlignment="path","heading"===this.symbolLayer.profileRotation&&(this.upVectorAlignment="world");const r=this.symbolLayer.profile||"circle";switch(r){case"circle":default:this._profile=xx.circle(10);break;case"quad":this._profile=xx.rect()}let s=[0,0];switch("center"!==i&&(s={left:[.5,0],right:[-.5,0],top:[0,-.5],bottom:[0,.5]}[i],this._profile.translate(s[0],s[1])),this.symbolLayer.join||"simple"){case"round":this._extruder=new Cx(0,3);break;case"bevel":this._extruder=new Cx(0,1);break;case"miter":this._extruder=new Cx(.8*Math.PI,1);break;case"simple":default:this._extruder=new wx}const n=this.symbolLayer.cap||"butt";switch(n){case"none":this._startCap=new Px,this._endCap=new Px;break;case"butt":default:this._startCap=new Rx(this._profile,0),this._endCap=new Rx(this._profile,0,!0);break;case"square":this._startCap=new Rx(this._profile,-.5),this._endCap=new Rx(this._profile,.5,!0);break;case"round":{const e="quad"===r;this._startCap=new Ax({profile:this._profile,flip:!1,breakNormals:e,subdivisions:3}),this._endCap=new Ax({profile:this._profile,flip:!0,breakNormals:e,subdivisions:3});break}}const a=(0,u.g)(this.symbolLayer,"material","color"),o=this._getCombinedOpacityAndColor(a),l=(0,v.M)(o),c=o[3],d=c<1||this.needsDrivenTransparentPass,p={diffuse:l,ambient:l,opacity:c,transparent:d,vertexColors:!1,slicePlaneEnabled:this._context.slicePlaneEnabled,castShadows:this.symbolLayer.castShadows,cullFace:d||"none"===n?0:2,offsetTransparentBackfaces:!0};if(!this._drivenProperties.size&&((0,k.r)(this._intrinsicSize,e,t),!Ou(this._intrinsicSize[0])||!Ou(this._intrinsicSize[1])))throw new h.s("graphics3dpathsymbollayer:invalid-size","Symbol sizes may not be negative values");this._fastUpdates.enabled&&this._fastUpdates.visualVariables.size||(0,k.l)(this._intrinsicSize,this._intrinsicSize,1/this._context.renderCoordsHelper.unitInMeters),this._fastUpdates.enabled?(Object.assign(p,this._fastUpdates.materialParameters,{size:[this._intrinsicSize[0],this._intrinsicSize[1],0]}),this._material=new $x(p)):(p.vertexColors=this._drivenProperties.color||this._drivenProperties.opacity,this._material=new S.aR(p)),this._material.setParameterValues({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}),this._context.stage.add(this._material)}destroy(){super.destroy(),this._context.stage.remove(this._material),this._material=null}createGraphics3DGraphic(e){const t=e.graphic;if(!this._validateGeometry(t.geometry,tb,this.symbolLayer.type))return null;const i=this.setGraphicElevationContext(t,new hp),r=e.renderingInfo;return this._createAs3DShape(t,r,i,t.uid)}layerOpacityChanged(){const e=(0,u.g)(this.symbolLayer,"material","color"),t=this._getCombinedOpacity(e),i=t<1||this.needsDrivenTransparentPass;return this._material.setParameterValues({opacity:t,transparent:i}),!0}layerElevationInfoChanged(e,t){return this.updateGraphics3DGraphicElevationInfo(e,t,Vu)}slicePlaneEnabledChanged(){return this._material.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled}),!0}physicalBasedRenderingChanged(){return this._material.setParameterValues({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}),!0}pixelRatioChanged(){return!0}applyRendererDiff(e,t){for(const i in e.diff)switch(i){case"visualVariables":if(!ay(this._fastUpdates,t,this._vvConvertOptions))return!1;this._material.setParameterValues(this._fastUpdates.materialParameters);break;default:return!1}return!0}getVertexData(e){let t=0;const i=e.paths,r=[],s=e.spatialReference,n=this._context.elevationProvider.spatialReference,a=this._context.renderCoordsHelper.spatialReference;for(const e of i)t+=e.length;const o=new Float64Array(3*t),l=new Float64Array(3*t),c=new Float64Array(3*t);let h=0;for(const t of i){r.push({index:h,numVertices:t.length});for(const i of t)o[h++]=i[0],o[h++]=i[1],o[h++]=e.hasZ?i[2]:0}let d=!0;return s.equals(n)?this._copyVertices(o,0,l,0,t):d=(0,_.x)(o,s,0,l,n,0,t),n.equals(a)?this._copyVertices(l,0,c,0,t):(0,_.x)(l,n,0,c,a,0,t),{pathVertexDataInfos:r,vertexDataGS:o,vertexDataES:l,vertexDataRS:c,projectionSuccess:d,terrainElevation:0}}_copyVertices(e,t,i,r,s){t*=3,r*=3;for(let n=0;n<s;++n)i[r++]=e[t++],i[r++]=e[t++],i[r++]=e[t++]}_createAs3DShape(e,t,i,r){const s=e.geometry,n=new Array,a=new Array,o=new Array,l=s.spatialReference,c=(0,se.a)(),h=this._context.renderCoordsHelper,d=this.getVertexData(s);if(!d.projectionSuccess)return this.logger.warn("PathSymbol3DLayer geometry failed to be created (failed to project geometry to view spatial reference)"),null;if(d.pathVertexDataInfos.length>0){for(let r=0;r<d.pathVertexDataInfos.length;++r){const s=d.pathVertexDataInfos[r],p=s.index,m=s.numVertices;if(m<2)continue;if((0,u.r)(this._context.clippingExtent)&&((0,se.B)(c),(0,se.M)(c,d.vertexDataES,3*p,m),!(0,se.R)(c,this._context.clippingExtent)))continue;const f=[];for(let e=p;e<p+3*m;){const t=e++,r=e++,s=e++,n=new _x;(0,v.a)(n.posGS,d.vertexDataGS[t],d.vertexDataGS[r],d.vertexDataGS[s]),(0,v.a)(n.posES,d.vertexDataES[t],d.vertexDataES[r],d.vertexDataES[s]);const a=Iu(n.posES,this._context.elevationProvider,i,h,null);(0,v.a)(ab,d.vertexDataRS[t],d.vertexDataRS[r],d.vertexDataRS[s]),h.setAltitude(ab,a),(0,v.a)(n.pos,ab[0],ab[1],ab[2]),f.push(n)}const g=new bx(f);ib(g,this.upVectorAlignment,this._context.renderCoordsHelper);const y=new Mx(g,this._profile,this._extruder,this._startCap,this._endCap);let _=null;if(this._fastUpdates.enabled){const t=this._fastUpdates.visualVariables,i=t.size?Up(t.size.field,e):0,r=t.color?Up(t.color.field,e):0,s=t.opacity?Up(t.opacity.field,e):0;_=new Ex(y,i,r,s)}else{const e=[this._intrinsicSize[0],this._intrinsicSize[1]];this._drivenProperties.size&&(e[0]*=rb(t.size[0],"symbol-value"===t.size[2]?this.symbolLayer.height||0:t.size[2],this.symbolLayer.width||0),e[1]*=rb(t.size[2],"symbol-value"===t.size[0]?this.symbolLayer.width||0:t.size[0],this.symbolLayer.height||0));let i=null;this._drivenProperties.color&&(i=t.color),this._drivenProperties.opacity&&null!=t.opacity&&(i=i?[i[0],i[1],i[2],t.opacity]:[1,1,1,t.opacity]);const r=new Dx(y);r.bake(e),i&&r.bakeVertexColors(i),_=r}const{vertexAttributes:x,indices:b}=_.createGeometryData(),w=new mx(x,b,_,l,this.upVectorAlignment,this.stencilWidth);n.push(w),a.push(this._material),o.push(_.xform)}if(n.length>0){const e={layerUid:this._context.layer.uid,graphicUid:r},t=new Qs({geometries:n,materials:a,transformations:o,metadata:e}),s=new dp(this,t,n,null,null,nb,i);return s.alignedSampledElevation=d.terrainElevation,s.needsElevationUpdates=Vu(i.mode),s}}else 0!==s.paths.length&&s.paths.some((e=>e.length>0))||this.logger.warn("PathSymbol3DLayer geometry failed to be created (no paths were defined)");return null}},fill:Kb,extrude:class extends Vp{constructor(e,t,i,r){super(e,t,i,r),this.ensureDrapedStatus(!1)}async doLoad(){if(!this._drivenProperties.size){const e=Mu(this._getSymbolSize());if(e)throw new h.s("graphics3dextrudesymbollayer:invalid-size",e)}const e=(0,u.g)(this.symbolLayer,"material","color"),t=this._getCombinedOpacityAndColor(e),i=(0,v.M)(t),r=t[3],s=r<1||this.needsDrivenTransparentPass,n={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0,diffuse:i,ambient:i,opacity:r,transparent:s,cullFace:s?0:2,vertexColors:!0,slicePlaneEnabled:this._context.slicePlaneEnabled,castShadows:this.symbolLayer.castShadows,offsetTransparentBackfaces:!0};this._material=new S.aR(n),this._bottomMaterial=new S.aR({...n,cullFace:2}),this._context.stage.add(this._material),this._context.stage.add(this._bottomMaterial)}destroy(){super.destroy(),this._material&&(this._context.stage.remove(this._material),this._context.stage.remove(this._bottomMaterial))}createGraphics3DGraphic(e){const t=e.graphic;if(!this._validateGeometry(t.geometry,bv,this.symbolLayer.type))return null;const i=this._getVertexOpacityAndColor(e.renderingInfo,255),r=this.setGraphicElevationContext(t,new hp);return this._createAs3DShape(t,e.renderingInfo,i,r,t.uid)}layerOpacityChanged(e,t){const i=(0,u.g)(this.symbolLayer,"material","color"),r=this._getCombinedOpacity(i),s=r<1||this.needsDrivenTransparentPass;this._material.setParameterValues({opacity:r,transparent:s}),this._bottomMaterial.setParameterValues({opacity:r,transparent:s});const n=this._getLayerOpacity();return e.forEach((e=>{const i=t(e);(0,u.r)(i)&&i.layerOpacityChanged(n,this._context.isAsync)})),!0}layerElevationInfoChanged(e,t){return this.updateGraphics3DGraphicElevationInfo(e,t,Vu)}slicePlaneEnabledChanged(e,t){return this._material.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled}),this._bottomMaterial.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled}),e.forEach((e=>{const i=t(e);(0,u.r)(i)&&i.slicePlaneEnabledChanged(this._context.slicePlaneEnabled,this._context.isAsync)})),!0}physicalBasedRenderingChanged(){return this._material.setParameterValues({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}),this._bottomMaterial.setParameterValues({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}),!0}pixelRatioChanged(){return!0}_getExtrusionSize(e){let t;var i;return t=e.size&&this._drivenProperties.size?null!=(i=function(e,t=0){const i=e[t];return"number"==typeof i&&isFinite(i)?i:null}(e.size,2))?i:0:this._getSymbolSize(),t/=this._context.renderCoordsHelper.unitInMeters,t}_getSymbolSize(){var e;return null!=(e=this.symbolLayer.size)?e:1}_createAs3DShape(e,t,i,r,s){const n=gv(e.geometry);if((0,u.t)(n))return null;const a=vv(n,this._context.elevationProvider,this._context.renderCoordsHelper,r);if(this._logGeometryCreationWarnings(a,n.rings,"rings","ExtrudeSymbol3DLayer"),0===n.rings.length||!n.rings.some((e=>e.length>0)))return null;const o=bu(n);if((0,u.t)(o))return null;const l=new Array,c=new Array,h=new Array,d=(0,se.a)(),p=(0,T.e)(),m=(0,v.n)(),f=1===this._context.renderCoordsHelper.viewingMode;f||this._context.renderCoordsHelper.worldUpAtPosition(null,m),(0,_.S)(n.spatialReference,[o.x,o.y,0],p,this._context.renderCoordsHelper.spatialReference);const g=(0,T.e)();(0,C.h)(g,p);const y=(0,X.e)();(0,Y.j)(y,g);const{polygons:x,mapPosition:b,position:w}=a,S=w.length/3,P=new Float64Array(3*S*6),R=new Float64Array(3*S*6),A=new Float64Array(3*S*6),M=new Float64Array(1*S*6);let O=0;for(let e=0;e<x.length;++e){const r=x[e],s=r.count;if(this._context.clippingExtent&&((0,se.B)(d),(0,se.M)(d,r.mapPosition),!(0,se.R)(d,this._context.clippingExtent)))continue;const n=(0,he.r)(r.mapPosition,r.holeIndices,3);if(0===n.length)continue;const a=3*s*2+n.length,o=new Uint32Array(a),u=new Uint32Array(n.length),p=6*s,v=3*P.BYTES_PER_ELEMENT,_=new de.T(P.buffer,O*v,v,(O+p)*v),C=3*R.BYTES_PER_ELEMENT,S=new de.T(R.buffer,O*C,C,(O+p)*C),D=new Float64Array(A.buffer,3*O*A.BYTES_PER_ELEMENT,3*p),E=new Float64Array(M.buffer,1*O*M.BYTES_PER_ELEMENT,1*p),z=this._getExtrusionSize(t);wv(w,b,n,r,_.typedBuffer,D,S.typedBuffer,E,0,o,u,z,m,f),(0,T.b)(_,_,g),(0,T.f)(S,S,y),O+=6*s;const I=this._createExtrudeGeometry(o,o.length-u.length,{positions:_.typedBuffer,elevation:D,normals:S.typedBuffer,heights:E},i);l.push(I),c.push(this._material),h.push(T.a);const L=this._createExtrudeGeometry(u,0,{positions:_.typedBuffer,elevation:D,normals:S.typedBuffer,heights:E},i);l.push(L),c.push(this._bottomMaterial),h.push(T.a)}if(0===l.length)return null;const D=new Qs({geometries:l,materials:c,transformations:h,metadata:{layerUid:this._context.layer.uid,graphicUid:s,isElevationSource:!0}});D.transformation=p;const E=zv,z=xp(this.symbolLayer,{opacity:this._getLayerOpacity()}),I=(0,u.r)(z)?{baseMaterial:this._material,edgeMaterials:[z],properties:{mergeGeometries:!0,slicePlaneEnabled:this._context.slicePlaneEnabled}}:null,L=new dp(this,D,l,null,null,E,r,I);return L.alignedSampledElevation=a.sampledElevation,L.needsElevationUpdates=Vu(r.mode),L}_createExtrudeGeometry(e,t,i,r){const s=new Uint32Array(e.length),n=[["position",{size:3,data:i.positions,exclusive:!0}],["normal",{size:3,data:i.normals,exclusive:!0}],["color",{size:4,data:r,exclusive:!0}],["size",{size:1,data:i.heights,exclusive:!0}]],a=[["position",e],["normal",e],["color",s]];return i.elevation&&(n.push(["mapPos",{size:3,data:i.elevation}]),a.push(["mapPos",e])),new S.u(n,a,0,t)}},text:class extends Vp{constructor(e,t,i,r){super(e,t,i,r),this._elevationOptions={supportsOffsetAdjustment:!0,supportsOnTheGround:!1},this.ensureDrapedStatus(!1)}async doLoad(){if(!this._drivenProperties.size){const e=Mu(this.symbolLayer.size);if(e)throw new h.s("graphics3dtextsymbollayer:invalid-size",e)}this._createTextRenderParameters()}_createTextRenderParameters(){const e=this._context.layerView.view.pixelRatio;this._textRenderParameters=iw.fromSymbol(this.symbolLayer,e)}destroy(){super.destroy()}createGraphics3DGraphic(e){const t=e.graphic,i=Hp(t.geometry);if((0,u.t)(i))return this.logger.warn(`unsupported geometry type for text symbol: ${t.geometry.type}`),null;const r=this.symbolLayer.text;if(!r)return null;const s=(0,L.s)(this.symbol)&&this.symbol.hasVisibleVerticalOffset()?this.symbol:null;return this._createAs3DShape(t,i,r,s)}createLabel(e,t,i,r){const s=e.graphic,n=Hp(s.geometry);if((0,u.t)(n))return this.logger.warn(`unsupported geometry type for label: ${s.geometry.type}`),null;const a=t.text;return!a||/^\s+$/.test(a)?null:this._createAs3DShape(s,n,a,t,t,i,r)}setGraphicElevationContext(e,t,i=0){const r=super.setGraphicElevationContext(e,t);return r.addOffsetRenderUnits(i),r}layerOpacityChanged(){return this.logger.warn("layer opacity change not yet implemented in Graphics3DTextSymbolLayer"),!1}layerElevationInfoChanged(e,t){return uw(e,t,((e,t)=>{this.updateGraphicElevationContext(t,e)})),Gu.UPDATE}slicePlaneEnabledChanged(e,t){return uw(e,t,(e=>{for(const t of e.stageObject.geometryRecords)t.material.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled})})),!0}physicalBasedRenderingChanged(){return!0}pixelRatioChanged(){return!1}updateGraphicElevationContext(e,t){this.setGraphicElevationContext(e,t.elevationContext,t.metadata.elevationOffset),t.needsElevationUpdates=Fu(t.elevationContext.mode)||"absolute-height"===t.elevationContext.mode}_defaultElevationInfoNoZ(){return pw}_createAs3DShape(e,t,i,r,s=mw,n,a){const o=this.setGraphicElevationContext(e,new hp,s.elevationOffset),l="polyline"===(0,u.g)(e.geometry,"type"),c=e.uid,h=this._context.stage.renderView.renderingContext,d=s.anchor in Eu?s.anchor:"center",p=Eu[d],m=(0,u.t)(a)?new cw(h,i,this._textRenderParameters):null,g={occlusionTest:!0,screenOffset:s.screenOffset,anchorPos:p,polygonOffset:!0,color:[1,1,1,1],centerOffsetUnits:s.centerOffsetUnits,debugDrawBorder:s.debugDrawBorder,drawInSecondSlot:!0};if((0,u.r)(m)&&(g.textureId=m.id,g.texCoordScale=m.texcoordScale),(0,u.r)(a)&&(g.textureId=a.id),(0,u.r)(r)&&(0,u.r)(r.verticalOffset)){const{screenLength:e,minWorldLength:t,maxWorldLength:i}=r.verticalOffset;g.verticalOffset={screenLength:(0,f.u)(e),minWorldLength:t||0,maxWorldLength:null!=i?i:1/0}}if(this._context.screenSizePerspectiveEnabled){const{screenSizePerspectiveSettings:e,screenSizePerspectiveSettingsLabels:t}=this._context.sharedResources;g.screenSizePerspective=t.overridePadding(this._textRenderParameters.haloSize),g.screenSizePerspectiveAlignment=e}let v;if(l&&(g.shaderPolygonOffset=1e-4),g.slicePlaneEnabled=this._context.slicePlaneEnabled,(0,u.r)(n)){const e=JSON.stringify(g);v=n.get(e),(0,u.t)(v)&&(v=new nd(g),n.add(e,v))}else v=new nd(g);const y=[v],_=s.translation,x=(0,u.r)(m)?[m.displayWidth,m.displayHeight]:[0,0],b=s.centerOffset,w=dw,C=[lr.createPointGeometry(w,_,null,x,b,[0,0],null)],T=this._context.layer.uid,S=Np(this._context,t,C,y,null,null,o,T,c);if(null===S)return null;const P=Hu,R=new dp(this,S.object,C,(0,u.t)(n)?y:null,(0,u.r)(m)?[m]:null,P,o);R.alignedSampledElevation=S.sampledElevation,R.needsElevationUpdates=Fu(o.mode)||"absolute-height"===o.mode;const{displayWidth:A,displayHeight:M}=(0,u.r)(m)?m:s;R.getScreenSize=(e=(0,N.n)())=>(e[0]=A,e[1]=M,e);const O={labelText:i,elevationOffset:s.elevationOffset};return R.metadata=O,jp(R,t,this._context.elevationProvider),R}},water:bw},Dw={"mesh-3d":{fill:class extends Vp{constructor(e,t,i,r){super(e,t,i,r),this._materials=new Map,this._textures=new Map,this.ensureDrapedStatus(!1)}async doLoad(){Ih.DRAW_MESH_GEOMETRY_NORMALS&&(this._debugVertexNormalMaterial=new Wy({color:[1,0,1,1]}),this._debugFaceNormalMaterial=new Wy({color:[0,1,1,1]}))}destroy(){super.destroy(),this._context.stage.removeMany(Array.from(this._materials.values(),(e=>e.material))),this._context.stage.removeMany(Array.from(this._textures.values())),this._materials.clear(),this._textures.clear()}createGraphics3DGraphic(e){const t=e.graphic;if(!this._validateGeometry(t.geometry,p_,"fill on mesh-3d"))return null;const i=this.setGraphicElevationContext(t,new hp),r=e.renderingInfo;return this._createAs3DShape(t,r,i,t.uid)}layerOpacityChanged(e,t){const i=this._getLayerOpacity();return this._materials.forEach((e=>{e.material.setParameterValues({layerOpacity:i});const t=e.material.params;this._setMaterialTransparentParameter(t,e),e.material.setParameterValues({transparent:t.transparent})})),e.forEach((e=>{const r=t(e);(0,u.r)(r)&&r.layerOpacityChanged(i,this._context.isAsync)})),!0}layerElevationInfoChanged(e,t){return this.updateGraphics3DGraphicElevationInfo(e,t,Vu)}slicePlaneEnabledChanged(e,t){return this._materials.forEach((e=>{e.material.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled})})),e.forEach((e=>{const i=t(e);(0,u.r)(i)&&i.slicePlaneEnabledChanged(this._context.slicePlaneEnabled,this._context.isAsync)})),!0}physicalBasedRenderingChanged(){const e=this._usePBR();return this._materials.forEach((t=>t.material.setParameterValues({usePBR:e}))),!0}pixelRatioChanged(){return!0}_requiresSymbolVertexColors(){return this._drivenProperties.color||this._drivenProperties.opacity}_colorOrTextureUid(e){return(0,u.t)(e)?"-":e instanceof z.o?e.toHex():e.contentHash}_materialPropertiesDefault(e,t){const i=this._requiresSymbolVertexColors(),r=!!e.vertexAttributes.color,s=!!e.vertexAttributes.tangent;return{hasSymbolVertexColors:i,hasVertexColors:r,hasVertexTangents:s,uid:`vc:${r},vt:${s},vct${t},svc:${i}`}}_materialProperties(e,t,i){const r=this._materialPropertiesDefault(e,i);if(!t.material)return r;const{color:s,colorTexture:n,normalTexture:a,doubleSided:o,alphaCutoff:l,alphaMode:c}=t.material,h=this._colorOrTextureUid(s),d=this._colorOrTextureUid(n),u=this._colorOrTextureUid(a);if(r.color=s,r.colorTexture=n,r.normalTexture=a,r.uid=`${r.uid},cmuid:${h},ctmuid:${d},ntmuid:${u},ds:${o},ac:${l},am:${c}`,t.material instanceof pe.c){const{metallic:e,roughness:i,metallicRoughnessTexture:s,emissiveColor:n,emissiveTexture:a,occlusionTexture:o}=t.material,l=this._colorOrTextureUid(s),c=this._colorOrTextureUid(n),h=this._colorOrTextureUid(a),d=this._colorOrTextureUid(o);r.metallic=e,r.roughness=i,r.metallicRoughnessTexture=s,r.emissiveColor=n,r.emissiveTexture=a,r.occlusionTexture=o,r.uid=`${r.uid},mrm:${e},mrr:${i},mrt:${l},emuid:${c},etmuid:${h},otmuid:${d}`}return r}_setInternalColorValueParameters(e,t){t.diffuse=z.o.toUnitRGB(e),t.opacity=e.a}_getLoadableTextureResource(e){return e.data?e.data:e.url}_getInternalTextureId(e){const t=this._getLoadableTextureResource(e);if(!t)return;const i=e.contentHash;let r=this._textures.get(i);return r||(r=new S.aT(t,{mipmap:!0,wrap:this._castTextureWrap(e.wrap),noUnpackFlip:!0,preMultiplyAlpha:!0}),this._textures.set(i,r),this._context.stage.add(r)),r.id}_castTextureWrap(e="repeat"){if("string"==typeof e){const t=this._castTextureWrapIndividual(e);return{s:t,t}}return{s:this._castTextureWrapIndividual(e.horizontal),t:this._castTextureWrapIndividual(e.vertical)}}_castTextureWrapIndividual(e){switch(e){case"clamp":return 33071;case"mirror":return 33648;case"repeat":default:return 10497}}_setInternalMaterialParameters(e,t){(0,u.r)(e.color)&&this._setInternalColorValueParameters(e.color,t),(0,u.r)(e.colorTexture)&&(t.textureId=this._getInternalTextureId(e.colorTexture)),(0,u.r)(e.normalTexture)&&(t.normalTextureId=this._getInternalTextureId(e.normalTexture)),(0,u.r)(e.emissiveColor)&&(t.emissiveFactor=z.o.toUnitRGB(e.emissiveColor)),(0,u.r)(e.emissiveTexture)&&(t.emissiveTextureId=this._getInternalTextureId(e.emissiveTexture)),(0,u.r)(e.occlusionTexture)&&(t.occlusionTextureId=this._getInternalTextureId(e.occlusionTexture)),(0,u.r)(e.metallicRoughnessTexture)&&(t.metallicRoughnessTextureId=this._getInternalTextureId(e.metallicRoughnessTexture))}_setExternalMaterialParameters(e){const t=this._drivenProperties.color;let i=(0,u.r)(this.symbolLayer.material)?this.symbolLayer.material.colorMixMode:null;if(t)e.externalColor=w.d;else{const t=(0,u.r)(this.symbolLayer.material)?this.symbolLayer.material.color:null;(0,u.r)(t)?e.externalColor=z.o.toUnitRGBA(t):(i=null,e.externalColor=w.d)}i&&(e.colorMixMode=i),e.castShadows=!!this.symbolLayer.castShadows}_hasTransparentVertexColors(e){const t=e.vertexAttributes.color;if((0,u.t)(t))return!1;for(let e=3;e<t.length;e+=4)if(255!==t[e])return!0;return!1}_getOrCreateMaterial(e,t){const i=t.material&&t.material.color,r=t.material&&t.material.colorTexture,s=t.material&&"blend"===t.material.alphaMode,n=!(t.material&&"opaque"===t.material.alphaMode)&&(this._hasTransparentVertexColors(e)||(0,u.r)(i)&&i.a<1||(0,u.r)(r)&&r.transparent||s),a=this._materialProperties(e,t,n),o=this._materials.get(a.uid);if(o)return o.material;const l={material:null,isComponentTransparent:n,alphaMode:t.material?t.material.alphaMode:"opaque"},c=null==a.metallicRoughnessTexture&&null==a.metallic&&null==a.roughness,h={usePBR:this._usePBR(),isSchematic:c,vertexColors:a.hasVertexColors,symbolColors:a.hasSymbolVertexColors,vertexTangents:a.hasVertexTangents,ambient:v.G,diffuse:v.l,opacity:1,doubleSided:!0,doubleSidedType:"winding-order",cullFace:0,textureAlphaPremultiplied:!0,layerOpacity:this._getLayerOpacity(),slicePlaneEnabled:this._context.slicePlaneEnabled,initTextureTransparent:!0};c||(h.mrrFactors=[null!=a.metallic?a.metallic:1,null!=a.roughness?a.roughness:1,.5]),t.material&&(h.doubleSided=t.material.doubleSided,h.cullFace=t.material.doubleSided?0:2,h.textureAlphaCutoff=t.material.alphaCutoff),this._setInternalMaterialParameters(a,h),this._setExternalMaterialParameters(h),this._setMaterialTransparentParameter(h,l);const d=new S.aR(h);return l.material=d,this._materials.set(a.uid,l),this._context.stage.add(d),d}_usePBR(){return this._context.physicalBasedRenderingEnabled}_setMaterialTransparentParameter(e,t){e.transparent=this.needsDrivenTransparentPass||t.isComponentTransparent||e.layerOpacity<1||e.opacity<1||e.externalColor&&e.externalColor[3]<1,"auto"===t.alphaMode?e.textureAlphaMode=e.transparent?3:1:e.textureAlphaMode="opaque"===t.alphaMode?1:"mask"===t.alphaMode?2:0}_addDebugNormals(e,t,i,r){const s=t.length,n=e.spatialReference.isGeographic?20015077/180:1,a=.1*Math.max(e.extent.width*n,e.extent.height*n,e.extent.zmax-e.extent.zmin),o=[],l=[],c=[],h=[];for(let e=0;e<s;e++){const i=t[e],r=i.vertexAttributes.get("position"),s=i.vertexAttributes.get("normal"),n=i.indices.get("position"),d=i.indices.get("normal"),u=r.data,p=s.data;for(let e=0;e<n.length;e++){const t=3*n[e],i=3*d[e];for(let e=0;e<3;e++)o.push(u[t+e]);for(let e=0;e<3;e++)o.push(u[t+e]+p[i+e]*a);if(l.push(l.length),l.push(l.length),e%3==0){this._calculateFaceNormal(u,n,e,y_),this._getFaceVertices(u,n,e,f_,g_,v_),(0,v.u)(f_,f_,g_),(0,v.u)(f_,f_,v_),(0,v.d)(f_,f_,1/3);for(let e=0;e<3;e++)c.push(f_[e]);for(let e=0;e<3;e++)c.push(f_[e]+y_[e]*a);h.push(h.length),h.push(h.length)}}}const d=new S.u([["position",{data:o,size:3,exclusive:!0}]],[["position",new Uint32Array(l)]],2);t.push(d),i.push(this._debugVertexNormalMaterial),r.push((0,T.r)(r[0]));const u=new S.u([["position",{data:c,size:3,exclusive:!0}]],[["position",new Uint32Array(h)]],2);t.push(u),i.push(this._debugFaceNormalMaterial),r.push((0,T.r)(r[0]))}_createAs3DShape(e,t,i,r){const s=e.geometry;if("mesh"!==s.type)return null;const n=this._createGeometryInfo(s,t);if(!n)return null;const{geometries:a,materials:o,transformations:l,objectTransformation:c}=n;Ih.DRAW_MESH_GEOMETRY_NORMALS&&this._addDebugNormals(s,a,o,l);const h=new Qs({geometries:a,materials:o,transformations:l,metadata:{layerUid:this._context.layer.uid,graphicUid:r}});h.transformation=c;const d=Hu,p=this._createEdgeMaterial(),m=(0,u.r)(p)?{baseMaterial:o[0],edgeMaterials:[p],properties:{mergeGeometries:!0,slicePlaneEnabled:this._context.slicePlaneEnabled}}:null,f=new dp(this,h,a,null,null,d,i,m);return f.needsElevationUpdates=Vu(i.mode),f.useObjectOriginAsAttachmentOrigin=!0,f.elevationContext.centerPointInElevationSR=this.getCenterPointInElevationSR(h),f.alignedSampledElevation=d(f,f.elevationContext,this._context.elevationProvider,this._context.renderCoordsHelper),f}getCenterPointInElevationSR(e){const t=(0,ie.v)(0,0,0,this._context.elevationProvider.spatialReference);return(0,_.M)([e.transformation[12],e.transformation[13],e.transformation[14]],this._context.renderCoordsHelper.spatialReference,t),t}_createComponentNormals(e,t,i,r){switch(i.shading||"flat"){case"source":return this._createComponentNormalsSource(e,t,i,r);case"flat":return this._createComponentNormalsFlat(e,r);case"smooth":return this._createComponentNormalsSmooth(e,r);default:return}}_createComponentNormalsSource(e,t,i,r){if((0,u.t)(t))return this._createComponentNormalsFlat(e,r);let s=!1;if(!i.trustSourceNormals)for(let i=0;i<r.length;i+=3){this._calculateFaceNormal(e,r,i,y_);for(let e=0;e<3;e++){const n=3*r[i+e];f_[0]=t[n+0],f_[1]=t[n+1],f_[2]=t[n+2],(0,v.z)(y_,f_)<0&&(t[n+0]=-t[n+0],t[n+1]=-t[n+1],t[n+2]=-t[n+2],s=!0)}}return{normals:t,indices:r,didFlipNormals:s}}_createComponentNormalsFlat(e,t){const i=new Float32Array(t.length),r=new Uint32Array(3*t.length);for(let s=0;s<t.length;s+=3){const n=this._calculateFaceNormal(e,t,s,y_);for(let e=0;e<3;e++)i[s+e]=n[e],r[s+e]=s/3}return{normals:i,indices:r,didFlipNormals:!1}}_createComponentNormalsSmooth(e,t){const i={};for(let r=0;r<t.length;r+=3){const s=this._calculateFaceNormal(e,t,r,y_);for(let e=0;e<3;e++){const n=t[r+e];let a=i[n];a||(a={normal:(0,v.n)(),count:0},i[n]=a),(0,v.u)(a.normal,a.normal,s),a.count++}}const r=new Float32Array(3*t.length),s=new Uint32Array(3*t.length);for(let e=0;e<t.length;e++){const n=i[t[e]];1!==n.count&&((0,v.j)(n.normal,n.normal),n.count=1);for(let t=0;t<3;t++)r[3*e+t]=n.normal[t];s[e]=e}return{normals:r,indices:s,didFlipNormals:!1}}_getFaceVertices(e,t,i,r,s,n){const a=3*t[i+0],o=3*t[i+1],l=3*t[i+2];r[0]=e[a+0],r[1]=e[a+1],r[2]=e[a+2],s[0]=e[o+0],s[1]=e[o+1],s[2]=e[o+2],n[0]=e[l+0],n[1]=e[l+1],n[2]=e[l+2]}_calculateFaceNormal(e,t,i,r){return this._getFaceVertices(e,t,i,f_,g_,v_),(0,v.c)(g_,g_,f_),(0,v.c)(v_,v_,f_),(0,v._)(f_,g_,v_),(0,v.j)(r,f_),r}_getOrCreateComponents(e){return e.components?e.components:w_}_createPositionBuffer(e,t){let i=e.vertexAttributes.position;const r=1===t.reprojection?t.transformBeforeProject:null;if((0,u.r)(r)&&(i=(0,ve.V)(i,new Float64Array(i.length),r)),0===t.reprojection)return t.needsBufferCopy?new Float64Array(i):i;const s=(0,u.r)(r)?i:new Float64Array(i.length);return(0,_.x)(i,e.spatialReference,0,s,this._context.renderCoordsHelper.spatialReference,0,i.length/3),s}_createNormalBuffer(e,t,i){let r=e.vertexAttributes.normal;if((0,u.t)(r))return null;const s=1===i.reprojection?i.transformBeforeProject:null;if((0,u.r)(s)&&(r=(0,ve.k)(r,new Float32Array(r.length),s)),"local"===this._context.layerView.view.viewingMode||0===i.reprojection)return i.needsBufferCopy&&e.vertexAttributes.normal===r?new Float32Array(r):r;const n=e.vertexAttributes.position,a=(0,u.r)(s)?r:new Float32Array(r.length);return(0,ve.F)(r,n,t,e.spatialReference,a)}_createTangentBuffer(e,t,i){let r=e.vertexAttributes.tangent;if((0,u.t)(r))return null;const s=1===i.reprojection?i.transformBeforeProject:null;if((0,u.r)(s)&&(r=(0,ve.L)(r,new Float32Array(r.length),s)),"local"===this._context.layerView.view.viewingMode||0===i.reprojection)return i.needsBufferCopy&&e.vertexAttributes.normal===r?new Float32Array(r):r;const n=e.vertexAttributes.position,a=(0,u.r)(s)?r:new Float32Array(r.length);return(0,ve.B)(r,n,t,e.spatialReference,a)}_createColorBuffer(e){return e.vertexAttributes.color}_createSymbolColorBuffer(e){if(this._requiresSymbolVertexColors()){const t=this._getVertexOpacityAndColor(e),i=Dy((0,u.g)(this.symbolLayer,"material","colorMixMode")),r=new Uint8Array(4);return Ey(t,i,r),r}return null}_createBuffers(e,t){const i=e.vertexAttributes&&e.vertexAttributes.position;if(!i)return this.logger.warn("Mesh geometry must contain position vertex attributes"),null;const r=e.vertexAttributes.normal,s=e.vertexAttributes.uv,n=e.vertexAttributes.tangent;if((0,u.r)(r)&&r.length!==i.length)return this.logger.warn("Mesh normal vertex buffer must contain the same number of elements as the position buffer"),null;if((0,u.r)(n)&&n.length/4!=i.length/3)return this.logger.warn("Mesh tangent vertex buffer must contain the same number of elements as the position buffer"),null;if((0,u.r)(s)&&s.length/2!=i.length/3)return this.logger.warn("Mesh uv vertex buffer must contain the same number of elements as the position buffer"),null;const a=this._computeReprojectionInfo(e),o=this._createPositionBuffer(e,a),l=this._createColorBuffer(e),c=this._createSymbolColorBuffer(t),h=this._createNormalBuffer(e,o,a),d=this._createTangentBuffer(e,o,a);return{positionBuffer:o,normalBuffer:h,tangentBuffer:d,uvBuffer:s,colorBuffer:l,symbolColorBuffer:c,objectTransformation:0===a.reprojection&&(0,u.r)(a.objectTransformation)?a.objectTransformation:this._transformOriginLocal(e,o,h,d),geometryTransformation:0===a.reprojection&&(0,u.r)(a.geometryTransformation)?a.geometryTransformation:(0,T.e)()}}_computeReprojectionInfo(e){const t=(0,u.r)(e.transform)&&e.transform.geographic||2===this._context.renderCoordsHelper.viewingMode?0:1;let i=null;if((0,u.r)(e.transform)){if(0===t){const i=(0,T.e)();return(0,_.S)(e.spatialReference,e.transform.origin,i,this._context.renderCoordsHelper.spatialReference),{reprojection:t,objectTransformation:i,geometryTransformation:(0,T.r)(e.transform.localMatrix),needsBufferCopy:!1}}return i=(0,C.x)((0,T.e)(),e.transform.origin),(0,C.e)(i,i,e.transform.localMatrix),{reprojection:t,transformBeforeProject:i,needsBufferCopy:!0}}return{reprojection:t,needsBufferCopy:!0}}_transformOriginLocal(e,t,i,r){const s=this._context.renderCoordsHelper.spatialReference,n=e.anchor;m_[0]=n.x,m_[1]=n.y,m_[2]=n.z;const a=(0,T.e)();(0,_.S)(e.spatialReference,m_,a,s);const o=de.T.fromTypedArray(t);if((0,C.h)(__,a),(0,T.b)(o,o,__),(0,u.r)(i)||(0,u.r)(r)){if((0,Y.a)(x_,a),(0,Y.o)(x_,x_),(0,u.r)(i)){const e=de.i.fromTypedArray(i);(0,T.f)(e,e,x_)}if((0,u.r)(r)){const e=de.i.fromTypedArray(r,4*r.BYTES_PER_ELEMENT);(0,T.f)(e,e,x_)}}return a}_validateFaces(e,t){const i=e.vertexAttributes.position.length/3,r=t.faces;if(r){let e=-1;for(let t=0;t<r.length;t++){const i=r[t];i>e&&(e=i)}if(i<=e)return this.logger.warn(`Vertex index ${e} is out of bounds of the mesh position buffer`),!1}else if(i%3!=0)return this.logger.warn("Mesh position buffer length must be a multiple of 9 if no component faces are defined (3 values per vertex * 3 vertices per triangle)"),!1;return!0}_getOrCreateFaces(e,t){return t.faces?t.faces:(0,w.l)(e.vertexAttributes.position.length/3)}_isOutsideClippingArea(e){if(!this._context.clippingExtent)return!1;const t=e.vertexAttributes&&e.vertexAttributes.position;if(!t)return!1;const i=this._context.elevationProvider.spatialReference;let r;const s=t.length/3;return e.spatialReference.equals(i)?r=t:(r=new Float64Array(t.length),(0,_.x)(e.vertexAttributes.position,e.spatialReference,0,r,i,0,s)),(0,se.B)(b_),(0,se.M)(b_,r,0,s),!(0,se.R)(b_,this._context.clippingExtent)}_createGeometryInfo(e,t){if(!(0,_.n)(e.spatialReference,this._context.layerView.view.spatialReference))return this.logger.warn("Geometry spatial reference is not compatible with the view"),null;if(this._isOutsideClippingArea(e))return null;const i=this._createBuffers(e,t);if((0,u.t)(i))return null;const{positionBuffer:r,uvBuffer:s,colorBuffer:n,symbolColorBuffer:a,normalBuffer:o,tangentBuffer:l,objectTransformation:c,geometryTransformation:h}=i,d=this._getOrCreateComponents(e),p=[],m=[],f=[];let g=!1;for(const t of d){if(!this._validateFaces(e,t))return null;const i=this._getOrCreateFaces(e,t);if(0===i.length)continue;const c=this._createComponentNormals(r,o,t,i);c.didFlipNormals&&(g=!0);const d=[["position",{size:3,data:r,exclusive:!0}],["normal",{size:3,data:c.normals,exclusive:!0}]],v=[["position",i],["normal",c.indices]];(0,u.r)(n)&&(d.push(["color",{size:4,data:n,exclusive:!0}]),v.push(["color",i])),(0,u.r)(a)&&(d.push(["symbolColor",{size:4,data:a,exclusive:!0}]),v.push(["symbolColor",new Uint16Array(i.length)])),(0,u.r)(s)&&(d.push(["uv0",{size:2,data:s,exclusive:!0}]),v.push(["uv0",i])),(0,u.r)(l)&&(d.push(["tangent",{size:4,data:l,exclusive:!0}]),v.push(["tangent",i]));const y=new S.u(d,v);p.push(y),m.push(h),f.push(this._getOrCreateMaterial(e,t))}return g&&this.logger.warn("Normals have been automatically flipped to be consistent with the counter clock wise face winding order. It is better to generate mesh geometries that have consistent normals."),{geometries:p,transformations:m,materials:f,objectTransformation:c}}_createEdgeMaterial(){const e={opacity:this._getLayerOpacity()};return xp(this.symbolLayer,e)}}}};class Ew extends vp{constructor(e,t,i){super(t.schedule),this._symbol=e,this._context=t,this._backgroundLayers=i,this._destroyed=!1,this.symbolLayers=[],this.referenced=0,this._extentPadding=0}set symbol(e){if(this._symbol=e,this.symbolLayers)for(let t=0;t<e.symbolLayers.length;t++){const i=this.symbolLayers[t];(0,u.t)(i)||(i.symbol=e,i.symbolLayer=e.symbolLayers.items[t])}}get symbol(){return this._symbol}async doLoad(e){let t=this._symbol.symbolLayers;this._extentPadding=0,this._backgroundLayers&&(t=this._backgroundLayers.concat(t));const i=t.length;for(;this.symbolLayers.length<t.length;)this.symbolLayers.push(null);this.symbolLayers.length=t.length;const r=[];for(let s=0;s<i;s++){const n=t.getItemAt(s);if(!1===n.enabled)continue;zw.renderPriority=1-(1+s)/i,zw.renderPriorityStep=1/i,zw.ignoreDrivers=n._ignoreDrivers;const a=Mw(this.symbol,n,this._context,zw);r.push((0,h.P)(e,(()=>{this.symbolLayers[s]=null,a.destroy()}))),this.symbolLayers[s]=a}await(0,ee.n)(this.symbolLayers,(async(e,t)=>{if((0,u.r)(e))try{await e.load(),this._extentPadding+=Math.max(this._extentPadding,e.extentPadding)}catch{this.symbolLayers[t]=null}}));for(const e of r)null==e||e.remove();if(r.length=0,(0,h.a)(e),this.symbolLayers.length&&!this.symbolLayers.some((e=>!!e)))throw new Error}getSymbolLayerSize(e){const t=this.symbolLayers[e];return(0,u.r)(t)?t.getCachedSize():null}get extentPadding(){return this._extentPadding}createGraphics3DGraphic(e,t){const i=e.graphic,r=new Array(this.symbolLayers.length);for(let t=0;t<this.symbolLayers.length;t++){const i=this.symbolLayers[t];r[t]=(0,u.r)(i)?i.createGraphics3DGraphic(e):null}const s=this._context.arcade||this._context.featureExpressionInfoContext&&this._context.featureExpressionInfoContext.arcade&&this._context.featureExpressionInfoContext.arcade.modules||null;return new fm(i,t||this,r,e.layer,s)}get complexity(){return Mp(this.symbolLayers.map((e=>(0,u.g)(e,"complexity"))))}globalPropertyChanged(e,t){const i=this.symbolLayers.length;for(let r=0;r<i;r++){const i=this.symbolLayers[r],s=e=>{const t=e._graphics[r];return t instanceof dp?t:null};if((0,u.r)(i)&&!i.globalPropertyChanged(e,t,s))return!1}return!0}applyRendererDiff(e,t){return 1===this.loadStatus&&this.symbolLayers.reduce(((i,r)=>i&&((0,u.t)(r)||r.applyRendererDiff(e,t))),!0)}prepareSymbolPatch(e){if(2===this.loadStatus)return;if("partial"!==e.diff.type)return;const t=e.diff.diff;if(!t.symbolLayers||"partial"!==t.symbolLayers.type)return;const i=t.symbolLayers.diff;this.symbolLayers.forEach(((t,r)=>{if((0,u.t)(t))return;const s=i[r];if(s){const i={diff:s,graphics3DGraphicPatches:[],symbolLayerStatePatches:[]};t.prepareSymbolLayerPatch(i),e.symbolStatePatches.push(...i.symbolLayerStatePatches),i.graphics3DGraphicPatches.length&&e.graphics3DGraphicPatches.push(((e,t)=>{const s=e._graphics[r];(0,u.r)(s)&&i.graphics3DGraphicPatches.forEach((e=>e(s,t)))}))}}))}updateGeometry(e,t){for(let i=0;i<this.symbolLayers.length;i++){const r=this.symbolLayers[i];if((0,u.t)(r))continue;const s=e._graphics[i];if((0,u.t)(s)||!r.updateGeometry(s,t))return!1}return!0}onRemoveGraphic(e){for(let t=0;t<this.symbolLayers.length;t++){const i=this.symbolLayers[t];if((0,u.t)(i))continue;const r=e._graphics[t];(0,u.r)(r)&&i.onRemoveGraphic(r)}}getFastUpdateStatus(){let e=0,t=0,i=0;return this.symbolLayers.forEach((r=>{(0,u.t)(r)||(0===r.loadStatus?e++:r.isFastUpdatesEnabled()?i++:t++)})),{loading:e,slow:t,fast:i}}destroy(){if(this.destroyed)console.error("Graphics3DSymbol.destroy called when already destroyed!");else{this.abortLoad();for(const e of this.symbolLayers)(0,u.r)(e)&&e.destroy();this.symbolLayers.length=0,this._destroyed=!0}}get destroyed(){return this._destroyed}}const zw={renderPriority:0,renderPriorityStep:1,ignoreDrivers:!1};class Iw extends vp{constructor(e,t,i){super(t),this.symbol=e,this.convert=i,this.graphics3DSymbol=null,this.referenced=0}getSymbolLayerSize(e){return(0,u.r)(this.graphics3DSymbol)?this.graphics3DSymbol.getSymbolLayerSize(e):null}get extentPadding(){return(0,u.r)(this.graphics3DSymbol)?this.graphics3DSymbol.extentPadding:0}async doLoad(e){const t=await this.symbol.fetchSymbol({signal:e});t.id=this.symbol.id,this.graphics3DSymbol=this.convert(t),await this.graphics3DSymbol.load()}createGraphics3DGraphic(e){return(0,u.r)(this.graphics3DSymbol)?this.graphics3DSymbol.createGraphics3DGraphic(e,this):null}get complexity(){return(0,u.r)(this.graphics3DSymbol)?this.graphics3DSymbol.complexity:Rp}globalPropertyChanged(e,t){return!!(0,u.r)(this.graphics3DSymbol)&&this.graphics3DSymbol.globalPropertyChanged(e,t)}applyRendererDiff(e,t){return!!(0,u.r)(this.graphics3DSymbol)&&this.graphics3DSymbol.applyRendererDiff(e,t)}prepareSymbolPatch(e){(0,u.r)(this.graphics3DSymbol)&&this.graphics3DSymbol.prepareSymbolPatch(e)}updateGeometry(e,t){return!!(0,u.r)(this.graphics3DSymbol)&&this.graphics3DSymbol.updateGeometry(e,t)}onRemoveGraphic(){}getFastUpdateStatus(){return(0,u.r)(this.graphics3DSymbol)?this.graphics3DSymbol.getFastUpdateStatus():{loading:1,fast:0,slow:0}}destroy(){(0,u.r)(this.graphics3DSymbol)&&this.graphics3DSymbol.destroy(),this.graphics3DSymbol=void 0,this.abortLoad()}get destroyed(){return void 0===this.graphics3DSymbol}}function Lw(e){return e instanceof Iw?e.graphics3DSymbol:e instanceof Ew?e:null}const Fw=u.n.getLogger("esri.views.3d.layers.graphics.labelPlacement");function Vw(e){const t=function(e){const t=e.labelClass.labelPlacement,{labelSymbol:i,graphics3DGraphic:r}=e,s=Lw(r.graphics3DSymbol),n=(0,u.r)(s)?s.symbol:null,a=Nw[t]||Bw(e);return"point-3d"===n.type&&n.supportsCallout()&&n.hasVisibleVerticalOffset()&&!r.isDraped?{placement:null,hasLabelVerticalOffset:!1,verticalOffset:kw(n.verticalOffset),anchor:null,normalizedOffset:null}:!i||!i.hasVisibleVerticalOffset()||"point-3d"===n.type&&n.supportsCallout()&&n.verticalOffset&&!r.isDraped?{placement:null,verticalOffset:null,anchor:null,normalizedOffset:null,hasLabelVerticalOffset:!1}:function(e){switch(e){case"above-center":return!0;default:return!1}}(a.placement)?{placement:"above-center",verticalOffset:kw(i.verticalOffset),anchor:"bottom",normalizedOffset:[0,a.normalizedOffset[1],0],hasLabelVerticalOffset:!0}:(Fw.errorOncePerTick("Callouts and vertical offset on labels are currently only supported with 'above-center' label placement (not with "+t+" placement)"),null)}(e);if((0,u.t)(t))return null;const i=function(e,t){if(t.anchor)return t;const i=e.labelClass.labelPlacement,r=Nw[i],s=r||Bw(e);return i&&!r&&Fw.warnOncePerTick(`the requested label placement '${i}' is not currently supported in SceneView`),function(e,t){const i=t.graphics3DGraphic.graphic.geometry;if((0,u.t)(i))return null;if((0,u.r)(t.disablePlacement))return t.labelClass.labelPlacement?(Fw.warnOncePerTick(Gw(e.placement,t.disablePlacement.logEntityDescription)),Bw(t)):e;const r=i.type;switch(r){case"polyline":case"polygon":case"extent":case"multipoint":if(t.labelClass.labelPlacement)return Fw.warnOncePerTick(Gw(e.placement,`'${r}' geometries`)),Bw(t);break;case"point":case"mesh":return e}return e}(s,e)}(e,t);if((0,u.t)(i))return null;const r=i.anchor,s=!!t.hasLabelVerticalOffset;return function(e,t,i){const r=i.graphics3DGraphic.graphic.geometry;if((0,u.t)(r))return null;switch(r.type){case"point":!function(e,t,i){const r=Uw(i);if((0,u.t)(r))return;const s=i.graphics3DGraphic._graphics[0];switch((0,u.r)(s)?s.getCenterObjectSpace(e.translation):(0,v.a)(e.translation,0,0,0),r.type){case"icon":case"text":!function(e,t,i,r){const{graphics3DGraphic:s}=i,n=(0,u.r)(r)?r.getScreenSize():null;if(!s.isDraped&&(0,u.r)(n)){const r=function(e,t=Ww){const{graphics3DGraphic:i}=e,r=i._graphics[0],s=(0,u.r)(r)?r.stageObject.geometryRecords[0].material:null;if(s&&s instanceof nd){const e=s.params.anchorPos;t[0]=2*(e[0]-.5),t[1]=2*(e[1]-.5)}else t[0]=0,t[1]=0;return t}(i);Hw[0]=n[0]/2*(t.normalizedOffset[0]-r[0]),Hw[1]=n[1]/2*(t.normalizedOffset[1]-r[1]),e.screenOffset[0]=Hw[0],e.hasLabelVerticalOffset?(e.centerOffset[1]=Hw[1],e.centerOffsetUnits="screen"):e.screenOffset[1]=Hw[1]}else e.hasLabelVerticalOffset||"center"===e.anchor||(Nw[i.labelClass.labelPlacement]&&Fw.warnOncePerTick(`the requested placement '${t.placement}' is currently unsupported for draped graphics`),e.anchor="center")}(e,t,i,s);break;case"object":qw(e,t,s)}}(e,t,i);break;case"polygon":!function(e,t,i){const r=Uw(i);if(!(0,u.t)(r))switch(r.type){case"extrude":{const r=i.graphics3DGraphic._graphics[0];(0,u.r)(r)?(r.getBoundingBoxObjectSpace(Qw),(0,se.p)(Qw,e.translation),e.translation[2]=(0,se.N)(Qw)/2):(0,v.a)(e.translation,0,0,0),qw(e,t,r);break}}}(e,t,i);break;case"mesh":qw(e,t,i.graphics3DGraphic._graphics[0])}return e}({anchor:r,verticalOffset:t.verticalOffset,screenOffset:(0,N.n)(),centerOffset:(0,w.a)(0,0,0,-1),centerOffsetUnits:"world",translation:(0,v.n)(),elevationOffset:0,hasLabelVerticalOffset:s},i,e)}function Uw(e){const t=Lw(e.graphics3DGraphic.graphics3DSymbol);return(0,u.r)(t)?t.symbol.symbolLayers.getItemAt(0):null}function Gw(e,t){return`the requested label placement '${e}' is currently unsupported for ${t} in SceneView`}function Bw(e){const t=e.graphics3DGraphic.graphic.geometry;if((0,u.t)(t))return null;switch(t.type){case"polyline":case"extent":case"multipoint":return{placement:"center-center",normalizedOffset:null,anchor:"center"};case"polygon":{const t=Uw(e);return(0,u.r)(t)&&"extrude"===t.type?Nw["above-center"]:{placement:"center-center",normalizedOffset:null,anchor:"center"}}case"point":case"mesh":return Nw["above-center"];default:return}}function qw(e,t,i){const r=(0,u.r)(i)?i.getBoundingBoxObjectSpace(Qw):Qw,s=(0,v.i)(r[3]-r[0],r[4]-r[1],r[5]-r[2]),n=Math.sqrt(s[0]*s[0]+s[1]*s[1]);e.centerOffset[0]=n/2*t.normalizedOffset[0];const a=e.translation[2],o=s[2]/2*t.normalizedOffset[1];e.translation[2]=0,e.elevationOffset=a+o;const l=(0,v.s)(s);e.centerOffset[2]=l/2*t.normalizedOffset[2]}function kw(e){const{screenLength:t,minWorldLength:i,maxWorldLength:r}=e;return{screenLength:t,minWorldLength:i,maxWorldLength:r}}const Nw={"above-center":{placement:"above-center",normalizedOffset:[0,1,0],anchor:"bottom"},"above-left":{placement:"above-left",normalizedOffset:[-1,1,0],anchor:"bottom-right"},"above-right":{placement:"above-right",normalizedOffset:[1,1,0],anchor:"bottom-left"},"below-center":{placement:"below-center",normalizedOffset:[0,-1,2],anchor:"top"},"below-left":{placement:"below-left",normalizedOffset:[-1,-1,0],anchor:"top-right"},"below-right":{placement:"below-right",normalizedOffset:[1,-1,0],anchor:"top-left"},"center-center":{placement:"center-center",normalizedOffset:[0,0,1],anchor:"center"},"center-left":{placement:"center-left",normalizedOffset:[-1,0,0],anchor:"right"},"center-right":{placement:"center-right",normalizedOffset:[1,0,0],anchor:"left"}},jw={"above-center":["default","esriServerPointLabelPlacementAboveCenter"],"above-left":["esriServerPointLabelPlacementAboveLeft"],"above-right":["esriServerPointLabelPlacementAboveRight"],"below-center":["esriServerPointLabelPlacementBelowCenter"],"below-left":["esriServerPointLabelPlacementBelowLeft"],"below-right":["esriServerPointLabelPlacementBelowRight"],"center-center":["esriServerPointLabelPlacementCenterCenter"],"center-left":["esriServerPointLabelPlacementCenterLeft"],"center-right":["esriServerPointLabelPlacementCenterRight"]};for(const e in jw){const t=jw[e],i=Nw[e];t.forEach((e=>{Nw[e]=i}))}Object.freeze&&(Object.freeze(Nw),Object.keys(Nw).forEach((function(e){Object.freeze(Nw[e]),Object.freeze(Nw[e].normalizedOffset)})));const Hw=[0,0],Ww=[0,0],Qw=(0,se.a)();class Zw{constructor(e){this._stage=e,this._materials=new Map}get(e){return this._materials.get(e)}add(e,t){this._materials.set(e,t),this._stage.add(t)}dispose(){this._stage.removeMany(Array.from(this._materials.values())),this._materials.clear()}}var Yw;const Xw=4096;let $w=Yw=class extends r.p{constructor(e){super(e),this.type=4,this.id=(0,Q.e)(),this.events=new n.n,this.glTexture=null,this.needsClear=!1,this.elementsToAddOrUpdate=new Map,this.elementsToRemove=new Map,this.elementsToRender=new Map,this.elements=new Map,this.stageObjects=new Map,this.updating=!1}initialize(){this.stage=this.view._stage,this.canvas=this.create2DCanvas(),this.ctx=this.canvas.getContext("2d"),this.stage.add(this);const e=this.computeAtlasResolution(this.view.width,this.view.height);this.createAtlasRegion(e),this.update2DCanvasSize(),this.resetAtlasCursor()}unload(){(0,u.r)(this.glTexture)&&(this.glTexture.dispose(),this.glTexture=null),this.events.emit("unloaded")}get width(){return this.atlas.size.width}get height(){return this.atlas.size.height}get requiresFrameUpdates(){return!1}createDescriptor(e){return{target:3553,pixelFormat:6408,dataType:5121,wrapMode:33071,flipped:!0,samplingMode:9987,hasMipmap:!0,preMultiplyAlpha:!0,maxAnisotropy:e.parameters.maxMaxAnisotropy}}load(e){if((0,u.r)(this.glTexture))return this.glTexture;this.glTexture=new q.r(e,this.createDescriptor(e),this.canvas);const t=this.view.resourceController.scheduler;return this.frameWorker=t.registerTask(Jd.TEXT_TEXTURE_ATLAS,this),this.setDirty(),this.glTexture}dispose(){this.elements=null,this.elementsToAddOrUpdate=null,this.elementsToRemove=null,this.elementsToRender=null,this.frameWorker=(0,u.a)(this.frameWorker),this.glTexture&&(this.stage.remove(this),this.glTexture=null),this.canvas.width=0,this.canvas.height=0,this.canvas=null,this.ctx=null}create2DCanvas(){const e=document.createElement("canvas");return e.setAttribute("id","canvas2d"),e.setAttribute("style","display:none"),e.setAttribute("width",512..toString()),e.setAttribute("height",512..toString()),e}update2DCanvasSize(){this.canvas.setAttribute("width",this.atlas.size.width.toString()),this.canvas.setAttribute("height",this.atlas.size.height.toString())}createAtlasRegion(e=512){this.atlas={size:{width:e,height:e},cursor:{x:0,y:0},lineHeight:0}}computeAtlasResolution(e,t){let i=Math.max(e,t);return i+=256,i=(0,v.O)(i),i=Math.min(i,Xw),i}resizeAtlas(e,t){t=t||e;const i=this.atlas;i.size.width=e,i.size.height=t,(0,u.r)(this.glTexture)&&this.glTexture.resize(e,t),this.update2DCanvasSize()}resetAtlasCursor(){const e=this.atlas;e.cursor.x=Kw,e.cursor.y=Kw+Jw,e.lineHeight=0,this.needsClear=!0}getAtlasUsage(){const e=this.atlas;return(e.cursor.x+e.cursor.y*e.size.width)/(e.size.width*e.size.height)}getExpectedAtlasUsage(){const e=this.elementsToRemove.size,t=this.elementsToAddOrUpdate.size,i=this.elements.size;return this.getAtlasUsage()/i*(i+t-e)}addAtlasElement(e,t,i,r){const s=this.atlas,{renderedWidth:n,renderedHeight:a,displayWidth:o,displayHeight:l}=e.textRenderer;e.placement.offset.x=s.cursor.x,e.placement.offset.y=s.cursor.y,e.placement.size.width=n,e.placement.size.height=a,e.placement.size.displayWidth=o,e.placement.size.displayHeight=l,e.placement.uvMinMax=[e.placement.offset.x/s.size.width,1-(e.placement.offset.y+a)/s.size.height,(e.placement.offset.x+n)/s.size.width,1-e.placement.offset.y/s.size.height],s.cursor.x+=i,s.lineHeight=Math.max(s.lineHeight,r),this.elements.set(t,e)}removeAtlasElement(e){if(e&&this.elements.has(e.textId)){const t=e.placement.offset,i=e.placement.size;this.ctx.clearRect(t.x,t.y,i.width,i.height),this.elements.delete(e.textId)}}ensureStageObjects(e){const t=this.stageObjects.get(e);if(t)return t;const i=new Set;return this.stageObjects.set(e,i),i}addStageObject(e,t){this.ensureStageObjects(e).add(t)}removeStageObject(e,t){const i=this.stageObjects.get(e);i&&i.delete(t)&&(t.geometries[0].vertexAttributes.get("size").data=[0,0],t.geometryVertexAttrsUpdated(0))}_processAddition(e,t){const i=this.atlas,r=e.textId,s=e.textRenderer.renderedWidth,n=e.textRenderer.renderedHeight,a=s+Kw,o=n+Kw+Jw;if(i.cursor.x+a<i.size.width&&i.cursor.y+o<i.size.height)this.addAtlasElement(e,r,a,o),this.elementsToRender.set(r,e),this.elementsToAddOrUpdate.delete(r);else{if(!(i.cursor.y+o+i.lineHeight<i.size.height)){const e=this.getExpectedAtlasUsage(),r=e>.85&&i.size.width<Xw;return r&&this.resizeAtlas(2*i.size.width,2*i.size.height),!t||!r&&e>.95&&i.size.width===Xw?(this.processRemovals(),0):(this.repack(),1)}i.cursor.x=Kw,i.cursor.y+=i.lineHeight,i.lineHeight=0,this.addAtlasElement(e,r,a,o),this.elementsToRender.set(r,e),this.elementsToAddOrUpdate.delete(r)}return 0}processRemovals(){this.elementsToRemove.forEach(((e,t)=>{const i=this.stageObjects.get(t);i&&0!==i.size||this.removeAtlasElement(e),i&&0===i.size&&this.stageObjects.delete(t)})),this.elementsToRemove.clear()}repack(){this.processRemovals(),this.elements.forEach(((e,t)=>{e.rendered=!1,this.elementsToAddOrUpdate.set(t,e)})),this.elements.clear(),this.resetAtlasCursor(),this.elementsToRender.clear()}processRenderingRequest(e){this.ctx.clearRect(e.placement.offset.x,e.placement.offset.y,e.placement.size.width,e.placement.size.height),e.textRenderer.render(this.ctx,e.placement.offset.x,e.placement.offset.y);const t=this.stageObjects.get(e.textId);t&&t.forEach((t=>{t.geometries[0].vertexAttributes.get("uv0").data=new Float32Array(e.placement.uvMinMax),t.geometries[0].vertexAttributes.get("size").data=[e.placement.size.displayWidth,e.placement.size.displayHeight],t.geometryVertexAttrsUpdated(0)})),e.rendered=!0}get running(){return this.updating}runTask(e,t=!0){if(!this.glTexture)return;let i=!1;if((0,s.g)(this.elementsToAddOrUpdate,((e,r)=>{const s=this.elements.get(r);if(s&&s.rendered){const e=this.stageObjects.get(r);return e&&e.forEach((e=>{const t=e.geometries[0].vertexAttributes,i=this.elements.get(r);t.get("uv0").data=new Float32Array(i.placement.uvMinMax),t.get("size").data=new Float32Array([i.placement.size.displayWidth,i.placement.size.displayHeight]),e.geometryVertexAttrsUpdated(0)})),this.elementsToAddOrUpdate.delete(r),!1}return 1===this._processAddition(this.elementsToAddOrUpdate.get(r),t)&&(i=!0,!0)})),i)return void this.runTask(cu,!1);let r=!1;this.elementsToRender.size>0&&this.needsClear&&(this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.needsClear=!1),(0,s.g)(this.elementsToRender,((t,i)=>(this.processRenderingRequest(t),this.elementsToRender.delete(i),r=!0,e.madeProgress(),e.done))),r&&(0,u.r)(this.glTexture)&&this.glTexture.setData(this.canvas),this.updating=this.elementsToRender.size>0,!this.updating&&Yw.test.orderedRepackingEnabled&&this.repackOrdered()}addTextTexture(e,t){const i=e.key;this.elementsToAddOrUpdate.has(i)||this.elementsToAddOrUpdate.set(i,{textId:i,placement:{offset:{x:0,y:0},size:{width:0,height:0,displayWidth:0,displayHeight:0},uvMinMax:[]},textRenderer:e,rendered:!1}),this.addStageObject(i,t),this.elementsToRemove.delete(i),this.setDirty()}removeTextTexture(e,t){const i=e.key;this.elementsToRemove.set(i,this.elements.get(i)),this.removeStageObject(i,t)}setDirty(){this.updating=!0}repackOrdered(){if(0===this.elements.size)return;const e=[];this.elements.forEach(((t,i)=>e.push({element:t,key:i})));let t=!0;for(let i=0;i<e.length-1;i++)if(e[i].key.localeCompare(e[i+1].key)>0){t=!1;break}if(!t||this.elementsToRemove.size){e.sort(((e,t)=>e.key.localeCompare(t.key))),this.elements.clear();for(const{element:t,key:i}of e)this.elements.set(i,t);this.repack(),this.setDirty()}}get test(){const{elements:e,stageObjects:t,elementsToRemove:i,atlas:r}=this,s=this;return{elements:e,stageObjects:t,elementsToRemove:i,atlas:r,resizeAtlas:(e,t)=>s.resizeAtlas(e,t),run:(e,t)=>s.runTask(e,t)}}};$w.test={orderedRepackingEnabled:!1},(0,r.e)([(0,d.y)({constructOnly:!0})],$w.prototype,"view",void 0),(0,r.e)([(0,d.y)({type:Boolean})],$w.prototype,"updating",void 0),$w=Yw=(0,r.e)([(0,d.n)("esri.views.3d.webgl-engine.lib.TextTextureAtlas")],$w);const Kw=2,Jw=2;var eC=$w;const tC=u.n.getLogger("esri.views.3d.layers.graphics.Labeler");let iC=class extends r.p{constructor(){super(...arguments),this._dirty=!1,this._labels=new Map,this._labelsToAdd=new Map,this._labelsToRemove=new Map,this._labelingContexts=new Array}setup(){this.dispose(),this._handles=new R.u,this._handles.add([this.view.watch("state.camera",(()=>this.setDirty())),this.view.watch("pixelRatio",(()=>this._resetAllLabels())),this.view.resourceController.scheduler.registerTask(Jd.LABELER,this)]),this._textTextureAtlas=new eC({view:this.view}),this._hudMaterialCollection=new Zw(this.view._stage),this._calloutMaterialCollection=new Zw(this.view._stage)}dispose(){this._handles=(0,u.k)(this._handles),this._textTextureAtlas=(0,u.z)(this._textTextureAtlas),this._hudMaterialCollection=(0,u.z)(this._hudMaterialCollection),this._calloutMaterialCollection=(0,u.z)(this._calloutMaterialCollection),this._labelingContexts.length=0,this._labels.clear(),this._labelsToAdd.clear(),this._labelsToRemove.clear()}_activateLabelingContext(e){e.labels.forEach(((e,t)=>{this._labels.set(t,e),e.graphics3DGraphic.setVisibilityFlag(0,!0,1)})),e.active=!0}_deactivateLabelingContext(e){e.labels.forEach(((e,t)=>{e.graphics3DGraphic.setVisibilityFlag(0,!1,1),this.setLabelGraphicVisibility(e.graphics3DGraphic,!1),this._labels.delete(t)})),e.active=!1}_addLabelTextureToAtlas(e){for(const t of e.graphics3DGraphic.labelGraphics){if(!t._labelClass)continue;const i=e.textRenderers[t._labelIndex];i&&this._textTextureAtlas.addTextTexture(i,t.stageObject)}e.rendered=!0}_removeLabelTextureFromAtlas(e){for(const t of e.graphics3DGraphic.labelGraphics){if(!t._labelClass)continue;const i=e.textRenderers[t._labelIndex];i&&this._textTextureAtlas.removeTextTexture(i,t.stageObject)}e.rendered=!1}get running(){var e;return!!this.view.ready&&(this._dirty||(null==(e=this._textTextureAtlas)?void 0:e.updating)||this.deconflictor.running)}runTask(e){this._updateLabels(e),!this._dirty&&this.deconflictor.running&&this.deconflictor.runTask(e)}_updateLabels(e){if(this._dirty){this._dirty=!1;for(const t of this._labelingContexts)if(rC(t)){if(!nC(t)){if(aC(t)){this._deactivateLabelingContext(t);continue}if(this._createLabelClassContext(t),sC(t)){this._dirty=!0;continue}if(!nC(t))continue}(0,s.g)(t.labelsToInitialize,((i,r)=>(this._ensureGraphics3DResources(i)&&(this._labels.set(r,i),this.deconflictor.setDirty(),e.madeProgress()),(i.visible&&i.hasTextTextureResources||!i.visible&&i.hasGraphics3DResources)&&(t.labelsToInitialize.delete(r),e.madeProgress()),e.done)))&&(this._dirty=!0)}this._labelsToRemove.forEach((e=>this._removeLabelTextureFromAtlas(e))),this._labelsToAdd.forEach((e=>this._addLabelTextureToAtlas(e))),this._labelsToRemove.clear(),this._labelsToAdd.clear(),this._dirty||this.notifyChange("updating")}}async _createLabelClassContextAsync(e){const t=e.labelClassAbortController.signal;await e.layer.when(),(0,h.a)(t),e.scaleVisibility&&e.scaleVisibility.updateScaleRangeActive();const i=e.graphics3DCore,r=i.layer,s=r.labelingInfo&&r.labelingInfo.filter((e=>!!e.symbol));if(!s||0===s.length)return;const n=new Array(s.length);let a=!1;await(0,ee.n)(s,(async(r,s)=>{const o=r.symbol,l=Lw(i.getOrCreateGraphics3DSymbol(o));if((0,u.t)(l))return void tC.error("Failed to create Graphics3DSymbol for label");await l.load(),(0,h.a)(t);let c=null;(0,L.s)(o)&&o.hasVisibleCallout()&&(c=hm(o,i.symbolCreationContext),await c.load(),(0,h.a)(t));const d=await(0,ee.a)((0,re.createLabelFunction)(r,e.layer.fieldsIndex,this.view.spatialReference));(0,h.a)(t),!0===d.ok?n[s]={labelClass:r,labelFunction:d.value,graphics3DSymbol:l,graphics3DCalloutSymbolLayer:c,calloutSymbolLayerIndex:0,textRenderParameters:this._createTextRenderParameters(l.symbol)}:(tC.error(`Label expression failed to evaluate: ${d.error}`),a=!0)})),(0,h.a)(t),a||(e.labelClassContexts=n)}async _createLabelClassContext(e){return e.labelClassPromise||(e.labelClassPromise=this._createLabelClassContextAsync(e).catch((t=>{if((0,h.g)(t))throw t;e.labelClassContexts=null})).then((()=>{e.labelClassAbortController=null,this.notifyChange("updating")})).catch((()=>{})),this.notifyChange("updating")),e.labelClassPromise}_createTextRenderParameters(e){const t=e.symbolLayers.getItemAt(0);return t&&"text"===t.type?iw.fromSymbol(t,this.view.pixelRatio):null}_destroyLabelClassContext(e){for(const t of e.labelClassContexts)--t.graphics3DSymbol.referenced,t.graphics3DSymbol=null;const t=e.labelClassAbortController;e.labelClassAbortController=(0,h.h)(),t&&t.abort(),e.labelClassContexts=[],e.labelClassPromise=null,this.notifyChange("updating")}_createTextSymbolGraphic(e,t,i,r,s){const n={text:e.text,centerOffset:i.centerOffset,translation:i.translation,elevationOffset:i.elevationOffset,screenOffset:i.screenOffset,anchor:i.anchor,centerOffsetUnits:i.centerOffsetUnits,verticalOffset:i.verticalOffset,debugDrawBorder:Ih.LABELS_SHOW_BORDER,displayWidth:e.displayWidth,displayHeight:e.displayHeight};return oC.graphic=t,oC.renderingInfo=null,oC.layer=r,s.createLabel(oC,n,this._hudMaterialCollection,this._textTextureAtlas)}_createLineCalloutGraphic(e,t,i,r,s){const n={symbol:t,translation:r.translation,elevationOffset:r.elevationOffset,screenOffset:r.screenOffset,centerOffset:r.centerOffset,centerOffsetUnits:r.centerOffsetUnits,materialCollection:this._calloutMaterialCollection};return oC.graphic=e,oC.renderingInfo=n,oC.layer=s,i.createGraphics3DGraphic(oC)}_ensureGraphics3DResources(e){if(e.hasGraphics3DResources)return!1;const t=e.graphics3DGraphic;if(t.destroyed)return!1;this._ensureTextTextureResources(e);const i=e.labelingContext,r=i.labelClassContexts;if(!r||0===r.length||!i.emptySymbolLabelSupported&&0===t._graphics.length)return!1;let s=!1;const n=t.graphic,a=i.layer,o=qt(i.layer),l=this.view._stage;for(let c=0;c<r.length;c++){const h=e.textRenderers[c];if(!h)continue;const d=r[c],p=d.graphics3DSymbol;let m=null;p.symbol&&"label-3d"===p.symbol.type&&(m=p.symbol);const f=p.symbolLayers[0];if(!f)continue;const g=d.labelClass,v=Vw({graphics3DGraphic:t,labelSymbol:m,labelClass:g,disablePlacement:i.disablePlacement});if((0,u.t)(v))continue;f.setElevationInfoOverride(i.elevationInfoOverride);const y=this._createTextSymbolGraphic(h,n,v,a,f);if(!y)return!1;y._labelClass=g,y._labelIndex=c,t.addLabelGraphic(y,l,i.stageLayer),t.setVisibilityFlag(0,o,1),t.clearVisibilityFlag(1,1),t.setVisibilityFlag(3,!1,1),s=!0;const _=d.graphics3DCalloutSymbolLayer;if(_&&v.hasLabelVerticalOffset){_.setElevationInfoOverride(i.elevationInfoOverride);const e=this._createLineCalloutGraphic(n,m,_,v,a);e&&(d.calloutSymbolLayerIndex=t.labelGraphics.length,t.addLabelGraphic(e,l,i.stageLayer))}break}return i.scaleVisibility&&s&&i.scaleVisibility.updateGraphicLabelScaleVisibility(t),e.hasGraphics3DResources=!0,!0}_destroyGraphics3DResources(e){const t=e.labelingContext.labelClassContexts;for(const i of e.graphics3DGraphic.labelGraphics){if(null==i._labelClass)continue;const e=t[i._labelIndex].graphics3DSymbol.symbolLayers[0];null!=e&&e.onRemoveGraphic(i)}e.graphics3DGraphic.clearLabelGraphics(),e.hasGraphics3DResources=!1}_ensureTextTextureResources(e){if(e.hasTextTextureResources)return;const t=e.labelingContext,i=t.labelClassContexts;if(!i||0===i.length)return;const r=e.graphics3DGraphic.graphic;for(let s=0;s<i.length;s++){const n=i[s];if(e.textRenderers[s]=null,!n.textRenderParameters)continue;const a=n.labelFunction;let o;if("arcade"===a.type)try{const e=a.needsHydrationToEvaluate()?gu(r,t.layer):r;o=a.evaluate(e)}catch(e){o=null}else o=a.evaluate(r);(0,u.t)(o)||""===o||/^\s+$/.test(o)||(e.textRenderers[s]=new rw(o,n.textRenderParameters))}e.hasTextTextureResources=!0}_destroyTextTextureResources(e){e.textRenderers=[],e.hasTextTextureResources=!1}_addGraphic(e,t){const i={hasGraphics3DResources:!1,hasTextTextureResources:!1,visible:!1,rendered:!1,labelingContext:e,graphics3DGraphic:t,textRenderers:[]},r=t.graphic.uid;e.labels.set(r,i),e.labelsToInitialize.set(r,i),this.setDirty(),this.deconflictor.setDirty()}_removeGraphic(e,t){const i=t.graphic.uid,r=e.labels.get(i);r&&(this._destroyGraphic(r,i),e.labels.delete(i),e.labelsToInitialize.delete(i),this.setDirty(),this.deconflictor.setDirty())}_destroyGraphic(e,t){this._labels.has(t)&&(this._labels.delete(t),this._labelsToAdd.delete(t),this._labelsToRemove.delete(t)),e.hasTextTextureResources&&(this._removeLabelTextureFromAtlas(e),this._destroyTextTextureResources(e)),e.hasGraphics3DResources&&this._destroyGraphics3DResources(e)}async _labelingInfoChange(e,t){if(!t)return this._visibilityInfoChange(e),this._resetLabels(e),this._createLabelClassContext(e);for(const i of t){const t=e.labels.get(i);t&&(this._removeGraphic(e,t.graphics3DGraphic),this._addGraphic(e,t.graphics3DGraphic))}}_globalPropertyChanged(e,t){for(const i of t.labelClassContexts){const r=new Map;t.labels.forEach((e=>{const t=e.graphics3DGraphic;r.set(t.graphic.uid,t)}));const s=e=>e.labelGraphics[0];if((0,u.f)(i.graphics3DSymbol.symbolLayers[0]).globalPropertyChanged(e,r,s),i.graphics3DCalloutSymbolLayer){const t=e=>e.labelGraphics[i.calloutSymbolLayerIndex];i.graphics3DCalloutSymbolLayer.globalPropertyChanged(e,r,t)}}}_visibilityInfoChange(e){const t=e.layer.labelsVisible;t&&!e.active&&this._activateLabelingContext(e),!t&&e.active&&this._deactivateLabelingContext(e),this.setDirty()}_resetAllLabels(){for(const e of this._labelingContexts)this._resetLabels(e)}_resetLabels(e){e.labels.forEach(((t,i)=>{this._destroyGraphic(t,i),t.visible=!1,t.rendered=!1,e.labelsToInitialize.set(i,t)})),this._destroyLabelClassContext(e),this.setDirty(),this.deconflictor.setDirty()}_findLabelingContext(e){for(const t of this._labelingContexts)if(t.graphics3DCore===e)return t;return null}addGraphicsOwner(e,t,i){const r=i&&i.emptySymbolLabelSupported||!1,s=i&&i.elevationInfoOverride||null,n=i&&i.disablePlacement||null;if(this._findLabelingContext(e))return;const a=e.layer,o={graphics3DCore:e,layer:a,scaleVisibility:t,emptySymbolLabelSupported:r,elevationInfoOverride:s,disablePlacement:n,active:a.labelsVisible,labelClassPromise:null,labelClassAbortController:(0,h.h)(),labelClassContexts:[],labels:new Map,labelsToInitialize:new Map,stageLayer:new nf({isPickable:!0},a.uid)};return this.view._stage.add(o.stageLayer),this._labelingContexts.push(o),this.setDirty(),{addGraphic:e=>this._addGraphic(o,e),removeGraphic:e=>this._removeGraphic(o,e),featureReductionChange:()=>{},layerLabelsEnabled:()=>qt(o.layer),labelingInfoChange:e=>this._labelingInfoChange(o,e),elevationInfoChange:()=>this._globalPropertyChanged("elevationInfo",o),slicePlaneEnabledChange:()=>this._globalPropertyChanged("slicePlaneEnabled",o),visibilityInfoChange:()=>this._visibilityInfoChange(o),reset:()=>this._resetLabels(o),clear:()=>{}}}removeGraphicsOwner(e){const t=this._findLabelingContext(e);if(!t)return;const i=this._labelingContexts.indexOf(t);this._labelingContexts.splice(i,1),t.labels.forEach((e=>this._removeGraphic(t,e.graphics3DGraphic))),this.view._stage.remove(t.stageLayer),t.stageLayer=null,this.setDirty()}setLabelGraphicVisibility(e,t){const i=e.graphic.uid,r=this._labels.get(i);r&&r.visible!==t&&(t&&!r.rendered?(this._labelsToAdd.set(i,r),this._labelsToRemove.delete(i),r.hasTextTextureResources||r.labelingContext.labelsToInitialize.set(i,r)):!t&&r.rendered&&(this._labelsToRemove.set(i,r),this._labelsToAdd.delete(i)),r.visible=t,this.setDirty())}setDirty(){!this._dirty&&this._labelingContexts.length>0&&(this._dirty=!0,this.notifyChange("updating"))}get updating(){var e;return this._dirty||(null==(e=this._textTextureAtlas)?void 0:e.updating)||this.deconflictor.updating||this._labelingContexts.some((e=>sC(e)))}get updatingProgress(){if(!this.updating||!this._textTextureAtlas)return 1;const e=this._labelingContexts.length>0?this._labelingContexts.reduce(((e,t)=>e+(sC(t)?0:1)),0)/this._labelingContexts.length:1;return(this._dirty?0:.3)+(this._textTextureAtlas.updating?0:.1)+.1*e+.5*this.deconflictor.updatingProgress}get test(){return{textTextureAtlas:this._textTextureAtlas,resetAllLabels:()=>this._resetAllLabels()}}};function rC(e){return e.active&&qt(e.layer)}function sC(e){return e.labelClassPromise&&!!e.labelClassAbortController}function nC(e){return e.labelClassContexts&&e.labelClassContexts.length}function aC(e){return null===e.labelClassContexts}(0,r.e)([(0,d.y)({constructOnly:!0})],iC.prototype,"view",void 0),(0,r.e)([(0,d.y)({constructOnly:!0})],iC.prototype,"deconflictor",void 0),(0,r.e)([(0,d.y)()],iC.prototype,"_textTextureAtlas",void 0),(0,r.e)([(0,d.y)({type:Boolean,readOnly:!0})],iC.prototype,"updating",null),iC=(0,r.e)([(0,d.n)("esri.views.3d.layers.graphics.Labeler")],iC);const oC=new um(null,null,null);class lC{constructor(){this.gltfCache=new Map,this.wosrCache=new Map,this.evictHandles=new R.u}loadGLTF(e,t,i){const r=i?`gltfPBR:${e}`:`gltf:${e}`;return this.fromCache(this.gltfCache,r,(t=>(0,w.j)(new w.m(t.streamDataRequester),e,t,i)),t)}loadWOSR(e,t){const i=`wosr:${e}:${t.disableTextures}`;return this.fromCache(this.wosrCache,i,(t=>(0,S.ba)(e,t)),t)}destroy(){this.evictHandles.destroy(),this.gltfCache.clear(),this.wosrCache.clear()}get size(){return this.wosrCache.size+this.gltfCache.size}fromCache(e,t,i,r){return new Promise(((s,n)=>{if((0,h.b)(r))return void n((0,h.m)());const a=(0,h.v)(r,(()=>{this.remove(e,t),n((0,h.m)())})),o=e.get(t);if(o)return this.evictHandles.remove(t),o.refCount++,void o.item.then(s,n);const l=(0,h.h)(),c={...r,signal:l.signal},d={refCount:1,abortController:l,item:i(c).then((i=>(d.abortController=null,i.remove=()=>this.remove(e,t),i)))};e.set(t,d),d.item.then((e=>{(0,u.r)(a)&&a.remove(),s(e)}),(e=>{(0,u.r)(a)&&a.remove(),n(e)}))}))}remove(e,t){const i=e.get(t);i&&(i.refCount--,0===i.refCount&&this.evictHandles.add((0,d.G)((()=>{e.delete(t),(0,u.r)(i.abortController)&&i.abortController.abort()}),cC),t))}}let cC=1e4;class hC{constructor(e,t,i,r=null){this.lij=[0,0,0],this.extent=(0,b.i)(),this.resolution=0,this.loadPriority=0,this.measures={visibility:2,screenRect:(0,b.i)(),distance:0,shouldSplit:!1},this.used=!1,r&&this.acquire(e,t,i,r)}acquire(e,t,i,r){this.tilingScheme=r,this.id=hC.id(e,t,i),this.lij[0]=e,this.lij[1]=t,this.lij[2]=i,r.getExtent(e,t,i,this.extent),this.resolution=r.resolutionAtLevel(e)}release(){this.tilingScheme=null}getChildren(e){const t=this.lij[0]+1,i=2*this.lij[1],r=2*this.lij[2];return e?(e[0].acquire(t,i,r,this.tilingScheme),e[1].acquire(t,i+1,r,this.tilingScheme),e[2].acquire(t,i,r+1,this.tilingScheme),e[3].acquire(t,i+1,r+1,this.tilingScheme),e):[new hC(t,i,r,this.tilingScheme),new hC(t,i+1,r,this.tilingScheme),new hC(t,i,r+1,this.tilingScheme),new hC(t,i+1,r+1,this.tilingScheme)]}copyMeasurementsFrom(e){this.measures.visibility=e.measures.visibility,this.measures.shouldSplit=e.measures.shouldSplit,this.measures.distance=e.measures.distance,(0,b.A)(e.measures.screenRect,this.measures.screenRect)}static id(e,t,i){return`${e}/${t}/${i}`}}class dC{constructor(e){this.renderCoordsHelper=e,this.frustum=wa(),this._points=Ca(),this.lines=new Array(12),this._origin=(0,v.n)(),this._direction=(0,v.n)(),this._altitude=null;for(let e=0;e<12;e++)this.lines[e]={origin:null,direction:(0,v.n)(),endpoint:null}}get planes(){return this.frustum}get points(){return this._points}get mutablePoints(){return this._points}get direction(){return this._direction}update(e){Sa(e.viewMatrix,e.projectionMatrix,this.frustum,this._points),(0,v.h)(this._origin,e.eye),(0,v.h)(this._direction,e.viewForward),this._altitude=this.renderCoordsHelper.getAltitude(this._origin),this.updateLines()}updatePoints(e){for(let t=0;t<this._points.length;t++)(0,v.h)(this._points[t],e[t]);Pa(this.frustum,this._points),this.updateLines()}get altitude(){return this._altitude}intersectsSphere(e){return Ra(this.frustum,e)}intersectsRay(e){return function(e,t){return Ma(e,function(e,t=ba()){return(0,S.y)(e,t.ray),t.c0=0,t.c1=Number.MAX_VALUE,t}(t,Da.get()))}(this.frustum,e)}intersectsLineSegment(e,t){return function(e,t,i){return Ma(e,function(e,t,i=ba()){const r=(0,v.s)(e.vector);return(0,S.D)(e.origin,t,i.ray),i.c0=0,i.c1=r,i}(t,i,Da.get()))}(this.frustum,e,t)}intersectsPoint(e){return Aa(this.frustum,e)}updateLines(){const e=this._points;for(let t=0;t<4;t++){const i=t+4;uC(this.lines[t],e[t],e[i]),uC(this.lines[t+4],e[t],3===t?e[0]:e[t+1]),uC(this.lines[t+8],e[i],3===t?e[4]:e[i+1])}}}function uC(e,t,i){e.origin=t,e.endpoint=i,(0,v.H)(e.direction,t,i)}dC.planePointIndices={bottom:[5,1,0,4],near:[0,1,2,3],far:[5,4,7,6],right:[1,5,6,2],left:[4,0,3,7],top:[7,3,2,6]},dC.nearFarLineIndices=[[0,4],[1,5],[2,6],[3,7]];const pC=.5*Math.PI,mC=pC/Math.PI*180;class fC{constructor(e){this.renderCoordsHelper=e.renderCoordsHelper,this.extent=new Array(4),this.planes=new Array(6),this.maxSpan=0,this.center={origin:(0,v.n)(),direction:(0,v.n)()};for(let e=0;e<4;e++)this.extent[e]={origin:(0,v.n)(),direction:(0,v.n)(),cap:{next:null,direction:(0,v.n)()}},this.planes[e]=De();this.planes[4]=De(),this.planes[5]=De(),this.planesWithoutFar=this.planes.slice(0,5)}update(e,t,i,r=!0){const s=this.extent;this.toRenderBoundingExtent(e,t,i),(0,v.u)(this.center.origin,s[0].origin,s[2].origin),(0,v.d)(this.center.origin,this.center.origin,.5),this.renderCoordsHelper.worldUpAtPosition(this.center.origin,this.center.direction),r||(0,v.d)(this.center.direction,this.center.direction,-1);for(let e=0;e<4;e++){const t=s[e];this.renderCoordsHelper.worldUpAtPosition(t.origin,t.direction);const i=s[3===e?0:e+1];t.cap.next=i.origin,(0,v.H)(t.cap.direction,t.origin,i.origin),We(t.direction,t.cap.direction,t.origin,this.planes[e]),r||(0,v.d)(t.direction,t.direction,-1)}We(s[0].cap.direction,s[1].cap.direction,s[0].origin,this.planes[4]),r?He(this.planes[4],this.planes[5]):(Ee(this.planes[4],this.planes[5]),He(this.planes[4],this.planes[4])),this.maxSpan=Math.max(Math.abs(e[0]-e[2]),Math.abs(e[1]-e[3])),this.maxSpanSpatialReference=t,this.minGlobalAltitude=.9*(0,x.p)(this.maxSpanSpatialReference).radius}isVisibleInFrustum(e,t,i=!1){if(null==e)return!1;if(1===this.renderCoordsHelper.viewingMode){const i=this.maxSpanSpatialReference.isGeographic?mC:pC*t;if(this.maxSpan>i)return!0;if(e.altitude>=this.minGlobalAltitude)return this.isVisibleInFrustumGlobal(e)}if(0===this.maxSpan){const t=this.extent[0];return!(i||!e.intersectsRay((0,S.g)(t.origin,t.direction)))}for(let t=0;t<this.extent.length;t++){const r=this.extent[t];if(!i&&e.intersectsRay((0,S.g)(r.origin,r.direction)))return!0;if(e.intersectsLineSegment((0,w.g)(r.origin,r.cap.next,bC),r.cap.direction))return!0}const r=i?this.planes:this.planesWithoutFar;for(let t=0;t<e.lines.length;t++){const i=e.lines[t];if(Rs(r,i.origin,i.endpoint,i.direction))return!0}return!1}toRenderBoundingExtentGlobal(e,t,i){(0,b.y)(e,vC),vC[2]=i,(0,_.S)(t,vC,yC,this.renderCoordsHelper.spatialReference),(0,C.h)(_C,yC),(0,se.B)(xC);for(const{x0:r,x1:s,y0:n,y1:a}of gC)for(let o=0;o<5;o++){const l=o/4;vC[0]=(0,v.C)(e[r],e[s],l),vC[1]=(0,v.C)(e[n],e[a],l),vC[2]=i,(0,_.w)(vC,t,vC,this.renderCoordsHelper.spatialReference),(0,v.I)(vC,vC,_C),(0,se.h)(xC,vC)}(0,v.a)(this.extent[0].origin,xC[0],xC[1],xC[2]),(0,v.a)(this.extent[1].origin,xC[3],xC[1],xC[2]),(0,v.a)(this.extent[2].origin,xC[3],xC[4],xC[2]),(0,v.a)(this.extent[3].origin,xC[0],xC[4],xC[2]);for(let e=0;e<4;++e)(0,v.I)(this.extent[e].origin,this.extent[e].origin,yC)}toRenderBoundingExtentLocal(e,t){(0,v.a)(this.extent[0].origin,e[0],e[1],t),(0,v.a)(this.extent[1].origin,e[2],e[1],t),(0,v.a)(this.extent[2].origin,e[2],e[3],t),(0,v.a)(this.extent[3].origin,e[0],e[3],t)}toRenderBoundingExtent(e,t,i){switch(this.renderCoordsHelper.viewingMode){case 1:this.toRenderBoundingExtentGlobal(e,t,i);break;case 2:this.toRenderBoundingExtentLocal(e,i);break;default:(0,Z.n)(this.renderCoordsHelper.viewingMode)}}isVisibleInFrustumGlobal(e){if((0,v.z)(this.center.direction,e.direction)<0)return!0;for(let t=0;t<4;t++){const i=this.extent[t];if((0,v.z)(i.direction,e.direction)<0)return!0}return!1}}const gC=[{x0:0,y0:1,x1:2,y1:1},{x0:0,y0:3,x1:2,y1:3},{x0:0,y0:1,x1:0,y1:3},{x0:2,y0:1,x1:2,y1:3}],vC=(0,v.n)(),yC=(0,T.e)(),_C=(0,T.e)(),xC=(0,se.a)(),bC=(0,w.v)();class wC{constructor(e){this.renderCoordsHelper=e,this.surfaceElevation=0,this.cache=new Map,this.frustum=new dC(e),this.extendedFrustum=new dC(e),this.intersector=new fC({renderCoordsHelper:e}),this.renderCoordsHelper=e}begin(e,t){this.surfaceElevation=t,this.aboveGround=this.renderCoordsHelper.getAltitude(e.eye)>t,this.frustum.update(e),this.shortenFrustumFarPlane(this.frustum),this.updateExtendedFrustum(e)}end(){this.cache.clear()}calculate(e){if(this.allTilesInvisible)return 0;const t=1===this.renderCoordsHelper.viewingMode&&e.lij[0]>=CC&&e.lij[0]<TC,i=this.getOrCalculateSingleTileVisibility(e,!t);return 0!==i&&t?this.calculateAggregatedChildrenVisibility(e):i}shortenFrustumFarPlane(e){const t=dC.nearFarLineIndices,i=e.mutablePoints;for(const e of t){const[t,r]=e,s=i[t],n=i[r];(0,v.c)(AC,n,s),(0,v.d)(AC,AC,PC),(0,v.u)(i[r],s,AC)}e.updatePoints(i)}calculateAggregatedChildrenVisibility(e){let t=0;const i=this.cache.get(e.id);if(null!=i)return i;const r=DC.acquire();e.getChildren(r);for(const e of r){const i=this.calculate(e);if(0!==i&&(t=i,2===i))break}return DC.release(r),this.cache.set(e.id,t),t}getOrCalculateSingleTileVisibility(e,t){const i=this.cache.get(e.id);if(null!=i)return i;const r=this.calculateSingleTileVisibility(e);return t&&this.cache.set(e.id,r),r}calculateSingleTileVisibility(e){return!this.aboveGround&&1===this.renderCoordsHelper.viewingMode&&e.lij[0]<SC?0===this.calculateSingleTileVisibilitySided(e,!1)?this.calculateSingleTileVisibilitySided(e,!0):void 0:this.calculateSingleTileVisibilitySided(e,this.aboveGround)}calculateSingleTileVisibilitySided(e,t){this.intersector.update(e.extent,e.tilingScheme.spatialReference,this.surfaceElevation,t);const i=(0,x.p)(e.tilingScheme.spatialReference).radius;return this.intersector.isVisibleInFrustum(this.extendedFrustum,i)?this.intersector.isVisibleInFrustum(this.frustum,i,!0)?2:1:0}updateExtendedFrustum(e){this.extendedFrustum.update(e),this.shortenFrustumFarPlane(this.extendedFrustum);const t=this.renderCoordsHelper.worldUpAtPosition(e.eye,AC);this.aboveGround||(0,v.E)(t,t);const i=(0,v.x)(-(0,v.z)(t,e.viewForward));if(this.allTilesInvisible=i>(Math.PI+e.fovY)/2,this.allTilesInvisible)return;if(this.hasExtendedFrustum=i>e.fovY/2,!this.hasExtendedFrustum)return;const r=this.extendedFrustumParameters(),s=this.extendedFrustum.mutablePoints;for(let e=0;e<4;e++){const t=r.pointIndices[e],i=s[t],n=this.renderCoordsHelper.getAltitude(i);if(r.needsAltitudeAdjustment(n)){switch(this.renderCoordsHelper.worldUpAtPosition(i,AC),t){case 4:case 7:case 0:case 3:tt(this.extendedFrustum.planes[0],AC,AC);break;case 5:case 6:case 1:case 2:tt(this.extendedFrustum.planes[1],AC,AC)}(0,v.d)(AC,AC,r.direction),this.renderCoordsHelper.intersectInfiniteManifold((0,S.g)(i,AC),r.zWithMargin,i)}}if(this.extendedFrustum.updatePoints(s),Fe(s[0],s[1],s[2],MC),Fe(s[1],s[2],s[3],OC),(0,v.z)(MC,OC)<0){const e=this.extendedFrustum.mutablePoints;this.aboveGround?[e[0],e[1]]=[e[1],e[0]]:[e[3],e[2]]=[e[2],e[3]],this.extendedFrustum.updatePoints(e)}}extendedFrustumParameters(){return this.aboveGround?this.extendedFrustumParametersAboveSurface():this.extendedFrustumParametersBelowSurface()}extendedFrustumParametersAboveSurface(){const e=this.surfaceElevation-RC;return{zWithMargin:e,pointIndices:dC.planePointIndices.bottom,direction:-1,needsAltitudeAdjustment:t=>t>e}}extendedFrustumParametersBelowSurface(){const e=this.surfaceElevation+RC;return{zWithMargin:e,pointIndices:dC.planePointIndices.top,direction:1,needsAltitudeAdjustment:t=>t<e}}}const CC=2,TC=6,SC=12,PC=.95,RC=1,AC=(0,v.n)(),MC=De(),OC=De(),DC=new r.h(Array,(e=>{4!==e.length&&(e[0]=new hC,e[1]=new hC,e[2]=new hC,e[3]=new hC)}),(e=>{e[0].release(),e[1].release(),e[2].release(),e[3].release()}));class EC{constructor(e){this.camera=new Ia,this.focusOnMap=[0,0],this.screenRect=(0,b.i)(),this.tileSize=e.tileSize,this.renderCoordsHelper=e.renderCoordsHelper,this.tilingScheme=e.tilingScheme,this.visibility=new wC(e.renderCoordsHelper)}begin(e,t,i){this.camera.copyFrom(e),this.surfaceElevation=i,this.focusOnMap[0]=t.x,this.focusOnMap[1]=t.y,(0,b.u)(0,0,e.fullWidth,e.fullHeight,this.screenRect),this.visibility.begin(this.camera,i)}end(){this.visibility.end()}updateTile(e){e.measures.visibility=this.visibility.calculate(e),e.measures.distance=(0,b.k)(e.extent,this.focusOnMap),0!==e.measures.visibility&&this.updateScreenMeasure(e)}updateScreenMeasure(e){const t=LC,i=1<<t,r=e.measures.screenRect;(0,b.B)(r);let s=0;const n=e.lij[0]+t,a=e.lij[1]<<t,o=e.lij[2]<<t,l=this.tileSizeWithBias(e),c=l*l;for(let t=0;t<i;t++)for(let l=0;l<i;l++)if(s+=this.computeScreenArea(e,n,a+t,o+l,r),s>c)return void(e.measures.shouldSplit=!0);e.measures.shouldSplit=!1}tileSizeWithBias(e){return 1===e.measures.visibility?this.tileSize*FC:this.tileSize}computeScreenArea(e,t,i,r,s){const n=1===e.measures.visibility;this.projectToScreen(t,i,r,n,VC),(0,b.B)(zC);for(let e=0;e<4;e++)(0,b.f)(zC,VC[e]);return(0,b.c)(s,zC),(0,b.w)(zC,this.screenRect,IC),(0,w.o)(VC[0],VC[1],VC[2])+(0,w.o)(VC[0],VC[2],VC[3])}projectToScreen(e,t,i,r,s){this.tilingScheme.ensureMaxLod(e),this.tilingScheme.getExtent(e,t,i,UC),this.toRenderCoords(UC,0,3,BC[0]),this.toRenderCoords(UC,2,3,BC[1]),this.toRenderCoords(UC,2,1,BC[2]),this.toRenderCoords(UC,0,1,BC[3]),r&&(this.projectToPlane(BC,this.camera.frustum[4]),this.projectToPlane(BC,this.camera.frustum[3]),this.projectToPlane(BC,this.camera.frustum[2]));for(let e=0;e<4;e++)this.camera.projectToRenderScreen(BC[e],kC),this.camera.renderToScreen(kC,s[e])}projectToPlane(e,t){for(let i=0;i<4;i++)qC[i]=it(t,e[i]);const i=Math.max(qC[0],qC[1],qC[2],qC[3]);if(i>0){const r=(0,v.d)(GC,t,-i);for(let t=0;t<4;t++)(0,v.u)(e[t],e[t],r)}}toRenderCoords(e,t,i,r){return GC[0]=e[t],GC[1]=e[i],GC[2]=this.surfaceElevation,this.renderCoordsHelper.toRenderCoords(GC,this.tilingScheme.spatialReference,r),r}}const zC=(0,b.i)(),IC=(0,b.i)(),LC=2,FC=5,VC=[(0,f.i)(),(0,f.i)(),(0,f.i)(),(0,f.i)()],UC=(0,b.i)(),GC=(0,v.n)(),BC=[(0,v.n)(),(0,v.n)(),(0,v.n)(),(0,v.n)()],qC=[0,0,0,0],kC=(0,f.x)();function NC(e,t,i){if(null==e||(0,u.t)(i))return!1;let r=!0;return HC[0]=null!=e.xmin?e.xmin:0,HC[1]=null!=e.ymin?e.ymin:0,HC[2]=null!=e.zmin?e.zmin:0,r=r&&(0,_.x)(HC,e.spatialReference,0,t,i,0,1),HC[0]=null!=e.xmax?e.xmax:0,HC[1]=null!=e.ymax?e.ymax:0,HC[2]=null!=e.zmax?e.zmax:0,r=r&&(0,_.x)(HC,e.spatialReference,0,t,i,3,1),null==e.xmin&&(t[0]=-1/0),null==e.ymin&&(t[1]=-1/0),null==e.zmin&&(t[2]=-1/0),null==e.xmax&&(t[3]=1/0),null==e.ymax&&(t[4]=1/0),null==e.zmax&&(t[5]=1/0),r}function jC(e,t,i){if(null==e)return!1;let r=!0;return HC[0]=null!=e.xmin?e.xmin:0,HC[1]=null!=e.ymin?e.ymin:0,HC[2]=null!=e.zmin?e.zmin:0,r=r&&(0,_.x)(HC,e.spatialReference,0,HC,i,0,1),t[0]=HC[0],t[1]=HC[1],HC[0]=null!=e.xmax?e.xmax:0,HC[1]=null!=e.ymax?e.ymax:0,HC[2]=null!=e.zmax?e.zmax:0,r=r&&(0,_.x)(HC,e.spatialReference,0,HC,i,0,1),t[2]=HC[0],t[3]=HC[1],null==e.xmin&&(t[0]=-1/0),null==e.ymin&&(t[1]=-1/0),null==e.xmax&&(t[2]=1/0),null==e.ymax&&(t[3]=1/0),r}const HC=(0,v.n)(),WC=u.n.getLogger("esri.views.3d.layers.support.FeatureTileTree3D");let QC=class extends r.p{constructor(e){super(e),this.tiles=new l.L,this.tileSize=512,this._idToTile=new Map,this._handles=new R.u,this._clients=new Set,this._dirty=!1,this._newTiles=new r.f}get tilingScheme(){const e=this.tilingSchemeOwner.tilingScheme;return e?e.clone():null}set filterExtent(e){if(e&&!e.spatialReference.equals(this.viewState.spatialReference))return void WC.error("#extent","extent spatial reference needs to be in the same spatial reference as the view");const t=this._get("filterExtent");if(t===e||t&&e&&t.equals(e))return;const i=e?e.clone():null;this._set("filterExtent",i),this._setDirty()}get filterExtentRect(){if(!this.filterExtent||!this.tilingScheme)return null;const e=(0,b.i)();return jC(this.filterExtent,e,this.tilingScheme.spatialReference),e}get rootTileIds(){return this.filterExtentRect?this.tilingScheme.rootTilesInExtent(this.filterExtentRect):[[0,0,0]]}set suspended(e){e!==this._get("suspended")&&(this._set("suspended",e),this._setDirty())}get updating(){return this._dirty||!!this._pendingTiles}initialize(){this._handles.add(this.watch(["tilingScheme","tileSize"],(()=>this._reset()),!0)),this._handles.add((0,p.d)(this,["tileSize","cameraOnSurface.location","tilingScheme","viewState.contentCamera","focus.location"],(()=>this._setDirty()),!0)),this.scheduler&&(this._frameWorker=this.scheduler.registerTask(Jd.FEATURE_TILE_TREE,this))}destroy(){this._frameWorker=(0,u.a)(this._frameWorker),this._handles=(0,u.k)(this._handles)}addClient(){const e=ZC++;return this._clients.add(e),1===this._clients.size&&this._setDirty(),{remove:()=>this._removeClient(e)}}_removeClient(e){this._clients.delete(e),this._hasClients||this._clear()}get _hasClients(){return this._clients.size>0}_setDirty(){!this._hasClients||this.suspended||this._dirty||(this._frameWorker?(this._dirty=!0,this.notifyChange("updating")):this.runTask(cu))}_clear(){this.tiles.removeAll(),this._idToTile.clear(),this._reset(),this._dirty=!1,this.notifyChange("updating")}get running(){return this.updating}runTask(e){this._dirty=!1,this._pendingTiles||(this._startUpdate(),(0,u.r)(this._frameWorker)&&(this._frameWorker.priority=Jd.FEATURE_TILE_TREE_ACTIVE)),this._subdivideTilesForView(e),!this._pendingTiles&&(0,u.r)(this._frameWorker)&&(this._frameWorker.priority=Jd.FEATURE_TILE_TREE),this.notifyChange("updating")}_startUpdate(){if(this.suspended)return;if(!this.tilingScheme)return void this._clear();this._tileMeasurements||(this._tileMeasurements=new EC({renderCoordsHelper:this.renderCoordsHelper,tilingScheme:this.tilingScheme,tileSize:this.tileSize}));const e=this.viewState.contentCamera;this._tileMeasurements.begin(e,this.focus.location,this.cameraOnSurface.location.z),this._pendingTiles=this._getRootTiles()}_reset(){this._newTiles.clear(),this._tileMeasurements=null,this._pendingTiles=null,this._setDirty()}_getRootTiles(){return this.rootTileIds.map((e=>new hC(e[0],e[1],e[2],this.tilingScheme)))}_purgeHorizonTiles(e){e.sort(((e,t)=>{const i=e.measures.screenRect,r=t.measures.screenRect;return i[1]+i[3]-(r[1]+r[3])})),(0,b.B)(YC);for(let t=0;t<e.length;t++)if((0,b.c)(YC,e.data[t].measures.screenRect),(0,b.M)(YC)>XC)return e.data.slice(t,e.length);return[]}_subdivideTilesForView(e){if(this._pendingTiles){for(;this._pendingTiles.length>0&&!e.done;){const t=this._pendingTiles.pop();e.madeProgress(),this.filterExtentRect&&!(0,b.F)(this.filterExtentRect,t.extent)||(this._tileMeasurements.updateTile(t),0!==t.measures.visibility&&(t.measures.shouldSplit?(this.tilingScheme.ensureMaxLod(t.lij[0]+1),this._pendingTiles.push(...t.getChildren())):this._newTiles.push(t)))}0===this._pendingTiles.length&&(this._updateTiles(this._purgeHorizonTiles(this._newTiles)),this._newTiles.clear(),this._tileMeasurements.end(),this._pendingTiles=null)}}_updateTiles(e){for(const e of this.tiles.items)e.used=!1;const t=e.filter((e=>{const t=this._idToTile.get(e.id);return t?(t.copyMeasurementsFrom(e),t.used=!0):this._idToTile.set(e.id,e),!t})),i=this.tiles.items.filter((e=>!e.used&&(this._idToTile.delete(e.id),!0)));this.tiles.removeMany(i),this.tiles.addMany(t),this.sortTiles()}sortTiles(){this.viewState.fixedContentCamera||this.tiles.sort(((e,t)=>e.measures.visibility!==t.measures.visibility?2===e.measures.visibility?-1:1:e.measures.distance-t.measures.distance)),this.tiles.forEach(((e,t)=>e.loadPriority=t))}};(0,r.e)([(0,d.y)({constructOnly:!0})],QC.prototype,"scheduler",void 0),(0,r.e)([(0,d.y)({constructOnly:!0})],QC.prototype,"renderCoordsHelper",void 0),(0,r.e)([(0,d.y)({constructOnly:!0})],QC.prototype,"tilingSchemeOwner",void 0),(0,r.e)([(0,d.y)({constructOnly:!0})],QC.prototype,"cameraOnSurface",void 0),(0,r.e)([(0,d.y)({constructOnly:!0})],QC.prototype,"focus",void 0),(0,r.e)([(0,d.y)({constructOnly:!0})],QC.prototype,"viewState",void 0),(0,r.e)([(0,d.y)({constructOnly:!0})],QC.prototype,"terrain",void 0),(0,r.e)([(0,d.y)()],QC.prototype,"tiles",void 0),(0,r.e)([(0,d.y)()],QC.prototype,"tileSize",void 0),(0,r.e)([(0,d.y)({readOnly:!0})],QC.prototype,"tilingScheme",null),(0,r.e)([(0,d.y)()],QC.prototype,"filterExtent",null),(0,r.e)([(0,d.y)({readOnly:!0})],QC.prototype,"filterExtentRect",null),(0,r.e)([(0,d.y)({readOnly:!0})],QC.prototype,"rootTileIds",null),(0,r.e)([(0,d.y)({value:!1})],QC.prototype,"suspended",null),(0,r.e)([(0,d.y)({readOnly:!0})],QC.prototype,"updating",null),QC=(0,r.e)([(0,d.n)("esri.views.3d.layers.support.FeatureTileTree3D")],QC);let ZC=0;const YC=(0,b.i)(),XC=10;var $C=QC;class KC{constructor(e,t){this.owner=t,this.properties={},this.afterDispatchHandle=null;for(const t in e){const i=e[t],s=new r.H(i,null,null,2,2);this.properties[t]={pool:s,acquired:[]}}this.afterDispatchHandle=(0,r.I)((()=>this.release()))}destroy(){this.afterDispatchHandle&&(this.afterDispatchHandle.remove(),this.afterDispatchHandle=null);for(const e in this.properties){const t=this.properties[e];for(const e of t.acquired)(0,r.S)(e)||t.pool.release(e);t.pool.destroy(),t.pool=null,t.acquired=null}this.properties=null,this.owner=null}get(e){const t=this.owner._get(e),i=this.properties[e];let r=i.pool.acquire();for(i.acquired.push(r);r===t;)i.acquired.push(r),r=i.pool.acquire();return r}release(){for(const e in this.properties){const t=this.properties[e];let i=0;for(const e of t.acquired)(0,r.S)(e)?t.acquired[i++]=e:t.pool.release(e);t.acquired.length=i}}}let JC=class extends r.p{constructor(){super(...arguments),this._propertiesPool=new KC({camera:Ia},this),this._lastSeenCameraProjectionValues=new Ia,this.events=new n.n,this.viewingMode=1,this._cameraChanged=!1,this.updateQueue=new Array,this.processingUpdates=!1}init(e,t){this._set("viewingMode",e),this._set("spatialReference",t),this._set("constraints",new mi({mode:this.viewingMode}))}exit(){this.cameraController=null,this._propertiesPool.destroy(),this._propertiesPool=new KC({camera:Ia},this)}createInitialCamera(){if(1===this.viewingMode){const e=(0,x.p)(this.spatialReference).radius;this.camera=new Ia((0,v.i)(4*e,0,0),(0,v.i)(e,0,0),(0,v.i)(0,0,1))}else this.camera=new Ia((0,v.i)(0,0,100),(0,v.i)(0,0,0),(0,v.i)(0,1,0))}get animation(){return this.cameraController instanceof co&&(0,u.r)(this.cameraController.viewAnimation)?this.cameraController.viewAnimation:null}get camera(){return this._get("camera")}set camera(e){e!==tT&&tT.copyFrom(e),tT.computeUp(this.viewingMode),iT.camera=tT,this.events.emit("before-camera-change",iT);const t=this._get("camera");if(this.cameraProjectionChanged(this._lastSeenCameraProjectionValues,tT)&&(this._lastSeenCameraProjectionValues.copyFrom(tT),rT.camera=this._lastSeenCameraProjectionValues,this.events.emit("camera-projection-changed",rT)),(!t||!t.equals(tT))&&(this._set("camera",this._propertiesPool.get("camera").copyFrom(tT)),this._cameraChanged=!t||!t.almostEquals(tT),this._cameraChanged)){const e=(0,r.I)((()=>{this._cameraChanged=!1,e.remove()}))}}get contentCamera(){return(0,u.r)(this._contentCamera)?this._contentCamera:this.camera}set contentCamera(e){this._contentCamera=(0,u.r)(e)?e.clone():null}get fixedContentCamera(){return!!(0,u.r)(this._contentCamera)}get isGlobal(){return 1===this.viewingMode}get isLocal(){return 2===this.viewingMode}get navigating(){return!(!this.cameraController||!this.cameraController.isInteractive)}get stationary(){return!this._cameraChanged&&!this.navigating}get cameraController(){return this._get("cameraController")}set cameraController(e){this.stopActiveCameraController()?(e&&(e.watch("state",(t=>{t!==oo.Finished&&t!==oo.Stopped||(this._set("cameraController",null),this.updateCamera((t=>e.onControllerEnd(t))))}),!0),e.onControllerStart(this.camera)),this._set("cameraController",e)):e&&(e.state=oo.Rejected)}switchCameraController(e){return this.cameraController=e,e.state!==oo.Rejected}stopActiveCameraController(){return!(this.cameraController&&!this.cameraController.stopController())}updateCamera(e){this.updateQueue.push(e),this.processUpdateQueue()}processUpdateQueue(){if(0===this.updateQueue.length||this.processingUpdates)return;this.processingUpdates=!0;const e=this.updateQueue.shift();tT.copyFrom(this._get("camera")),e(tT),this.camera=tT,this.processingUpdates=!1,this.processUpdateQueue()}cameraProjectionChanged(e,t){return e.fov!==t.fov||e.fullViewport[0]!==t.fullViewport[0]||e.fullViewport[1]!==t.fullViewport[1]||e.fullViewport[2]!==t.fullViewport[2]||e.fullViewport[3]!==t.fullViewport[3]||e.padding[0]!==t.padding[0]||e.padding[1]!==t.padding[1]||e.padding[2]!==t.padding[2]||e.padding[3]!==t.padding[3]}};(0,r.e)([(0,d.y)({readOnly:!0,type:s.n})],JC.prototype,"animation",null),(0,r.e)([(0,d.y)({type:Ia})],JC.prototype,"camera",null),(0,r.e)([(0,d.y)({})],JC.prototype,"_contentCamera",void 0),(0,r.e)([(0,d.y)({type:Ia})],JC.prototype,"contentCamera",null),(0,r.e)([(0,d.y)({readOnly:!0})],JC.prototype,"fixedContentCamera",null),(0,r.e)([(0,d.y)({readOnly:!0})],JC.prototype,"constraints",void 0),(0,r.e)([(0,d.y)({readOnly:!0})],JC.prototype,"events",void 0),(0,r.e)([(0,d.y)({readOnly:!0})],JC.prototype,"isGlobal",null),(0,r.e)([(0,d.y)({readOnly:!0})],JC.prototype,"isLocal",null),(0,r.e)([(0,d.y)({readOnly:!0})],JC.prototype,"viewingMode",void 0),(0,r.e)([(0,d.y)({readOnly:!0})],JC.prototype,"spatialReference",void 0),(0,r.e)([(0,d.y)({readOnly:!0})],JC.prototype,"navigating",null),(0,r.e)([(0,d.y)({readOnly:!0})],JC.prototype,"stationary",null),(0,r.e)([(0,d.y)()],JC.prototype,"_cameraChanged",void 0),(0,r.e)([(0,d.y)()],JC.prototype,"cameraController",null),JC=(0,r.e)([(0,d.n)("esri.views.3d.state.ViewState")],JC);var eT=JC;const tT=new Ia,iT={camera:null},rT={camera:null};class sT{constructor(e,t){this.elevationProvider=e,this._referenceEllipsoid=(0,x.p)(t),this.unitInMeters=(0,x.G)(t,this._referenceEllipsoid.metersPerDegree)}compute(e,t,i,r,s){s||(s={near:0,far:0});let n=e[2]*this.unitInMeters;const a=n,o=n-r,l=this.elevationProvider?this.elevationProvider.elevationBounds:null;l&&(n=o>=0?a-this.unitInMeters*l.min:this.unitInMeters*l.max-a);const c={x:i.xmax-i.xmin,y:i.ymax-i.ymin,z:4*Math.max(i.xmax-i.xmin,i.ymax-i.ymin)},h=Math.max(c.x,c.y,c.z);(0,v.c)(uT,t,e),dT[0]=uT[0]>0?i.xmax:i.xmin,dT[1]=uT[1]>0?i.ymax:i.ymin,dT[2]=uT[2]>0?h/2:-h/2,(0,v.c)(dT,dT,e),(0,v.j)(uT,uT);const d=1.1*(0,v.z)(dT,uT)*this.unitInMeters,u=Math.sqrt(n*(n+2*this._referenceEllipsoid.radius)),p=Math.max(i.xmax-i.xmin,i.ymax-i.ymin),m=p*cT*this.unitInMeters,f=p*hT*this.unitInMeters;let g=(0,v.o)((n-f)/(m-f),0,1);g*=g*g;let y=(0,v.C)(u,d,g);return y*=Math.max(Math.log(Math.abs(o)),1),y=Math.min(y,Math.max(34064e4,h)),y/=this.unitInMeters,aT(y,oT,this.unitInMeters,s)}}class nT{constructor(e){this._referenceEllipsoid=(0,x.p)(e)}compute(e,t,i,r,s){s||(s={near:0,far:0});const n=(0,v.s)(e)-this._referenceEllipsoid.radius,a=this._referenceEllipsoid.radius+Math.min(0,r),o=Math.abs(n-r),l=Math.max(o,Math.abs(n));return aT(1.2*Math.sqrt(l*(l+2*a)),(0,v.o)(2e4-(Math.log(l)-7.983)/9.011*19e3,1e3,2e4),1,s)}}function aT(e,t,i,r){const s=lT/i;return e/t>s?(r.far=e,r.near=r.far/t):(r.near=s,r.far=r.near*t),r}const oT=2e4,lT=2,cT=.001,hT=1e-4,dT=(0,v.n)(),uT=(0,v.n)();let pT=class extends r.p{constructor(e){super(e),this.handles=new R.u}initialize(){this.handles.add(this.view.basemapTerrain.on("elevation-change",(e=>this.handleElevationChangeEvent(e))))}destroy(){this.handles&&(this.handles.destroy(),this.handles=null)}handleElevationChangeEvent(e){if(this.view.state.cameraController)return;const t=this.view.state.camera;nn(this.view,t,e.extent,e.spatialReference)&&this.applyToCurrentCamera()}applyToCurrentCamera(){this.view.state.updateCamera((e=>{mn(this.view,e,1)}))}};(0,r.e)([(0,d.y)({constructOnly:!0})],pT.prototype,"view",void 0),pT=(0,r.e)([(0,d.n)("esri.views.3d.state.ElevationCollisionConstraint")],pT);var mT=pT;let fT=class extends r.p{constructor(e){super(e),this._handles=new R.u,this.nearFarHeuristic=function(e,t,i){return 1===e?new nT(i):new sT(t,i)}(e.view.state.viewingMode,e.view.basemapTerrain,e.view.renderCoordsHelper.spatialReference)}initialize(){this._handles.add([this.view.watch(["constraints.clipDistance.near","constraints.clipDistance.far"],(()=>this._clipDistanceNearFarChanged())),this.view.watch("constraints.clipDistance.mode",(()=>this._updateNearFar())),this.view.state.events.on("before-camera-change",(e=>this._updateCameraNearFar(e.camera))),this.view.watch("dataExtent",(()=>this._updateNearFar()),!0),this.view.watch(["constraints.altitude.min","constraints.altitude.max"],(()=>this._updateAltitude()),!0),this.view.watch("constraints.tilt.max",(()=>this._updateTiltMax()),!0),this.view.watch("constraints.tilt.mode",(()=>this._updateTilt()),!0),this.view.watch("state.camera",(()=>this._updateTiltAutoMax()),!0),this.view.watch(["map.ground.navigationConstraint.type","constraints.collision.enabled"],(()=>this._updateCollision()),!0)]),this.view.state.isLocal&&this._handles.add((0,p.d)(this.view,"dataExtent",(e=>this._updateLocalSurfaceDistance(e)))),this._updateNearFar(),2!==this.view.state.viewingMode&&this._updateAltitude(),this._updateTilt(),this._updateCollision(),this._set("surfaceCollisionConstraint",new mT({view:this.view}))}destroy(){this._handles=(0,u.k)(this._handles),this.surfaceCollisionConstraint&&(this.surfaceCollisionConstraint.destroy(),this._set("surfaceCollisionConstraint",null))}_clipDistanceNearFarChanged(){const e=this.view.constraints&&this.view.constraints.clipDistance;e&&"auto"!==e.mode&&this.view.state.updateCamera((t=>(this._updateCameraNearFarManual(t,e),!0)))}_updateNearFar(){this.view.state.updateCamera((e=>(this._updateCameraNearFar(e),!0)))}_updateCameraNearFar(e){const t=this.view.constraints&&this.view.constraints.clipDistance;"manual"===(t?t.mode:"auto")?this._updateCameraNearFarManual(e,t):this._updateCameraNearFarAuto(e,t)}_updateCameraNearFarAuto(e,t){this.nearFarHeuristic.compute(e.eye,e.center,this.view.dataExtent,an(this.view,e.eye),e),t&&t.autoUpdate(e.near,e.far)}_updateCameraNearFarManual(e,t){t&&(e.near=t.near,e.far=t.far)}_updateCollision(){var e,t,i;const r=null==(e=this.view.map)||null==(t=e.ground)||null==(i=t.navigationConstraint)?void 0:i.type,s=!r||"stay-above"===r,n=this.view.state.constraints.collision;if(s!==n.enabled){n.enabled=s,s&&this._reapplyConstraints(8);const e=this.view.constraints&&this.view.constraints.tilt;e&&"auto"!==e.mode||this._updateTiltAuto()}}_updateAltitude(){const e=this.view.constraints&&this.view.constraints.altitude;e&&2!==this.view.state.viewingMode?this.view.state.constraints.altitude={min:e.min,max:e.max}:this.view.state.constraints.altitude=null,this._reapplyConstraints()}_updateTiltMax(){const e=this.view.constraints&&this.view.constraints.tilt;e&&"auto"!==e.mode&&(this._updateTiltManual(e),this._reapplyConstraints())}_updateTilt(){const e=this.view.constraints&&this.view.constraints.tilt;"manual"===(e?e.mode:"auto")?this._updateTiltManual(e):this._updateTiltAuto(),this._reapplyConstraints()}_updateTiltManual(e){const t=this.view.state.constraints;t.tilt=t.createConstantMaxTilt((0,v.g)(e.max))}_updateTiltAuto(){const e=this.view.state.constraints;e.tilt=e.createDefaultTilt(),this._updateTiltAutoMax()}_updateTiltAutoMax(){const e=this.view.constraints&&this.view.constraints.tilt;if(!e||"auto"!==e.mode)return;const t=this.view.state.constraints;if(t.tilt){const i=t.tilt(this.view.state.camera.distance).max;e.autoUpdate((0,v.N)(i))}}_updateLocalSurfaceDistance(e){let t=Math.max(e.width,e.height);if(t<=0)return;e.hasZ&&(t=Math.max(t,e.zmax-e.zmin));const i=this.view.state,r=3*t/Math.atan(i.camera.fov/2);r!==i.constraints.distance&&(i.constraints.distance=r)}_reapplyConstraints(e=15){this.view.state.updateCamera((t=>oa(this.view,t,{selection:e,interactionType:0,interactionFactor:null,interactionStartCamera:null,interactionDirection:null,tiltMode:0})))}};(0,r.e)([(0,d.y)({constructOnly:!0})],fT.prototype,"view",void 0),(0,r.e)([(0,d.y)({readOnly:!0})],fT.prototype,"surfaceCollisionConstraint",void 0),fT=(0,r.e)([(0,d.n)("esri.views.3d.state.ConstraintsManager")],fT);var gT=fT;let vT=class extends lo{constructor(e){super(e),this.handles=new R.u}set desiredCamera(e){this._set("desiredCamera",e.clone())}get canStop(){return!0}get constraintEnabled(){return this.view.state.constraints.collision.enabled}onControllerStart(){this.state=oo.Running,this.handles.add(this.view.basemapTerrain.on("elevation-change",(e=>this.handleElevationChangeEvent(e)))),this.applyCorrection()}onControllerEnd(){this.handles.removeAll()}stepController(){}handleElevationChangeEvent(e){nn(this.view,this.desiredCamera,e.extent,e.spatialReference)&&this.applyCorrection()}applyCorrection(){this.view.state.updateCamera((e=>{e.copyViewFrom(this.desiredCamera),mn(this.view,e,1)||this.constraintEnabled||(this.state=oo.Stopped)}))}};function yT(e){return 360-s.V.normalize(e)}function _T(e){return s.V.normalize(360-e)}function xT(e){return(0,u.r)(e)&&e.resolver&&e.resolver.reject(),null}function bT(e,t,i,r=null){if(!t)return xT(r);const s=e.spatialReference||O.k.WGS84;if((0,u.r)(t.camera)){const e=t.get("camera.position.spatialReference");if(!(0,g.x)(e,s))return xT(r);const i=t.camera.clone();return e.equals(s)||(i.position=(0,g.g)(i.position,s)),function(e,t){return(0,u.r)(e)&&e.resolver&&e.resolver.resolve(t),t}(r,i)}if((0,u.t)(t.targetGeometry))return xT(r);const n=t.get("targetGeometry.spatialReference");if(n&&!(0,g.x)(n,s))return xT(r);const a=Tc(e,e.state.camera);let o=1;if(null!=t.rotation&&(a.heading=yT(t.rotation),o=0),null!=i&&(a.tilt=i),"point"===t.targetGeometry.type){const i=t.targetGeometry;let s;const n=t.targetGeometry.clone();return s=null!=t.scale?Sc(e,t.scale,i.latitude):e.state.camera.distance,Ac(e,n,s,a,o,r)}return Ec(e,t.targetGeometry.extent,a.heading,a.tilt,o,r)}async function wT(e,t,i){const r=function(e,t){if(!t||!e.spatialReference)return null;const i={target:null};if("declaredClass"in t||Array.isArray(t))i.target=t;else{for(const e in t)i[e]=t[e];t.center&&!i.target&&(i.target=t.center)}return i}(e,t);if(!r)throw new h.s("viewpointutils-create:no-target","Missing target for creating viewpoint");const n=new s.R({fov:e.camera.fov}),a=new s.u({camera:n});if(r.target instanceof s.u)return OT(await async function(e,t,i,r,s){if((0,u.r)(t.camera))return AT(e,t.camera,s);s.scale=t.scale,s.rotation=t.rotation,s.targetGeometry=(0,u.r)(t.targetGeometry)?t.targetGeometry.clone():null,s.camera=null,null!=i.heading?s.rotation=_T(i.heading):null!=i.rotation&&(s.rotation=i.rotation);const n=CT(e,i);null!=n&&(s.scale=n);const a=new Bc(r);return bT(e,s,i.tilt,a),s.camera=await a.resolver.promise,s}(e,r.target,r,i,a));if(r.target instanceof s.R)return OT(AT(e,r.target,a));const o=null!=r.scale||null!=r.zoom;if(r.target instanceof A.M){const t=r.target.xmin===r.target.xmax||r.target.ymin===r.target.ymax;return OT(o||t?await MT(e,r,r.target.center,n,i,a):await async function(e,t,i,r,s,n){n.targetGeometry=i.clone();Tc(e,on(e),r);const a=TT(r,t)?0:1,o=new Bc(s);return Ec(e,i,r.heading,r.tilt,a,o),n.camera=await o.resolver.promise,n}(e,r,r.target,n,i,a))}const l={boundingBox:(0,se.B)(),hasZ:!1,screenSpaceObjects:[]},c=o?function(e,t){return function(e,t){return e.spatialReference?(0,P.i)(t,e.spatialReference):void 0}(e,CT(e,t))}(e,r):void 0;if(await RT(e,r.target,c,l),isFinite(l.boundingBox[0])){let t;if((0,se.p)(l.boundingBox,DT),BT.x=DT[0],BT.y=DT[1],BT.z=DT[2],BT.spatialReference=e.spatialReference,isFinite(BT.z)&&l.hasZ?t=(0,se.S)(l.boundingBox):(BT.z=void 0,t=(0,b.D)((0,se.G)(l.boundingBox,LT))),o||t)return OT(await MT(e,r,BT,n,i,a));const s=function(e,t){if(!t.length)return.66;let i=Number.NEGATIVE_INFINITY;for(let e=0;e<t.length;e++){const r=t[e].screenSpaceBoundingRect;i=Math.max(i,Math.abs(r[0]),Math.abs(r[1]),Math.abs(r[2]),Math.abs(r[3]))}return.66-i/Math.min(e.width,e.height)*2}(e,l.screenSpaceObjects);return OT(await async function(e,t,i,r,s,n,a,o){o.targetGeometry=i.clone();const l=on(e),c=function(e,t,i,r,s){let n=0;i.hasZ?n=i.z:e.basemapTerrain&&(n=(0,u.f)(Ht(e.elevationProvider,i))),(0,v.a)(DT,i.x,i.y,n),(0,_.S)(e.spatialReference,DT,ET,e.renderSpatialReference),(0,Y.a)(zT,ET),(0,Y.o)(zT,zT),(0,se.B)(IT);const a=[[0,1,2],[3,1,2],[0,4,2],[3,4,2],[0,1,5],[3,1,5],[0,4,5],[3,4,5]];for(let t=0;t<a.length;t++){const i=a[t];let s=r[i[2]];isFinite(s)||(s=n),(0,v.a)(DT,r[i[0]],r[i[1]],s),(0,_.w)(DT,e.spatialReference,DT,e.renderSpatialReference),(0,se.h)(IT,(0,v.L)(DT,DT,zT))}const o=(0,se.I)(IT),l=(0,se.N)(IT),c=(0,se.y)(IT),h=1/Math.tan(t.fovX/2),d=1/Math.tan(t.fovY/2),p=.5*Math.sqrt(o*o+c*c)*Math.max(d,h)+.5*l,m=.5*l*d+.5*Math.max(o,c);return Math.max(p,m)/s}(e,l,i,r,s);Tc(e,l,n);const h=TT(n,t)?0:1;o.scale=Pc(e,c,o.targetGeometry.latitude);const d=new Bc(a);return Rc(e,o.targetGeometry,o.scale,n,h,d),o.camera=await d.resolver.promise,o}(e,r,BT,l.boundingBox,s,n,i,a))}return r.position?OT(function(e,t,i,r){const s=on(e);return(0,v.h)(FT,s.viewForward),Mc(e,s.eye,FT,s.up,GT),i.position=new g.b(t.position),i.heading=null!=t.heading?t.heading:GT.heading,i.tilt=null!=t.tilt?t.tilt:GT.tilt,ST(e,null,i,r)}(e,r,n,a)):OT(await async function(e,t,i,r,s){const n=on(e);return MT(e,t,(0,_.d)(n.center,e.renderSpatialReference,e.spatialReference),i,r,s)}(e,r,n,i,a))}function CT(e,t){return null==t.scale&&null!=t.zoom?Uc(e,t.zoom):t.scale}function TT(e,t){let i=!1;return null!=t.heading?(e.heading=t.heading,i=!0):null!=t.rotation&&(e.heading=yT(t.rotation),i=!0),null!=t.tilt&&(e.tilt=t.tilt,i=!0),null!=t.fov&&(e.fov=t.fov),i}function ST(e,t,i,r){const s=e.spatialReference||O.k.WGS84;return t=(0,u.r)(t)?t:wc(e,i),(0,u.t)(t)||(r.targetGeometry=(0,_.d)(t.center,e.renderSpatialReference,s),r.scale=Gc(e,t),r.rotation=_T(i.heading),r.camera=i),r}function PT(e,t,i){if(!t)return;if(!(0,g.x)(t.spatialReference,e.spatialReference))throw new h.s("viewpointutils:incompatible-spatialreference",`Spatial reference (${t.spatialReference?t.spatialReference.wkid:"unknown"}) is incompatible with the view (${e.spatialReference.wkid})`,{geometry:t});const r=[];if(!t.hasZ&&e.basemapTerrain){let i;switch(t.type){case"point":i=t;break;case"multipoint":case"polyline":i=t.extent.center;break;case"mesh":i=t.origin;break;case"extent":i=t.center;break;case"polygon":i=t.centroid}i&&(0,g.x)(i,e.basemapTerrain.spatialReference)?DT[2]=(0,u.q)(Ht(e.elevationProvider,i),0):DT[2]=0}(0,qT[t.type])(t,(e=>{r.push(e[0],e[1],e[2])}),DT);const s=r.length/3;if(0===s)return;const n=new Array(r.length);if((0,_.x)(r,t.spatialReference,0,n,e.spatialReference,0,s)){t.hasZ&&(i.hasZ=!0);for(let e=0;e<n.length;e+=3)t.hasZ?(DT[0]=n[e+0],DT[1]=n[e+1],DT[2]=n[e+2]):(DT[0]=n[e+0],DT[1]=n[e+1]),(0,se.h)(i.boundingBox,DT)}}async function RT(e,t,i,r){if(Array.isArray(t)&&2===t.length){const i=t[0],s=t[1];if("number"==typeof i&&"number"==typeof s)return BT.x=i,BT.y=s,BT.z=void 0,BT.spatialReference=e.spatialReference.isGeographic?e.spatialReference:O.k.WGS84,void PT(e,BT,r)}t&&"function"==typeof t.map?await(0,h.A)(t.map((t=>RT(e,t,i,r)))):t instanceof g.p?PT(e,t,r):t instanceof a.h&&await async function(e,t,i,r){const s=await(0,ee.a)(e.whenViewForGraphic(t));if(!1===s.ok||(0,u.t)(s.value)||!("whenGraphicBounds"in s.value))return void PT(e,t.geometry,r);const n=s.value,a=await(0,ee.a)(n.whenGraphicBounds(t,{minDemResolution:i}));if(!1===a.ok)return void PT(e,t.geometry,r);const{screenSpaceObjects:o,boundingBox:l}=a.value;(0,se.f)(r.boundingBox,l),o&&o.forEach((e=>{r.screenSpaceObjects.push(e)})),isFinite(l[2])&&(r.hasZ=!0)}(e,t,i,r)}function AT(e,t,i){const r=e.spatialReference,s=t.position.spatialReference;return(0,g.x)(s,r)?((t=t.clone()).fov=e.camera.fov,s.equals(r)||(t.position=(0,g.g)(t.position,r)),ST(e,null,t,i)):null}async function MT(e,t,i,r,s,n){if((0,u.t)(i))throw new h.s("createfromcenter","invalid point");n.targetGeometry=i.clone();const a=on(e);if(t.position)return function(e,t,i,r,s,n){const a=e.renderSpatialReference;return(0,_.R)(i.position,VT,a),(0,_.R)(t,UT,a),n.targetGeometry=new g.b(t),s.position=new g.b(i.position),(0,v.c)(FT,UT,VT),Mc(e,VT,FT,r.up,s),n.scale=Pc(e,(0,v.q)(VT,UT),n.targetGeometry.latitude),n.rotation=_T(s.heading),n.camera=s,n}(e,n.targetGeometry,t,a,r,n);if(t.zoomFactor){const r=a.distance/t.zoomFactor,s=(0,v.d)(DT,a.viewForward,-r);a.eye=(0,v.u)(DT,a.center,s),n.scale=Pc(e,r,i.latitude)}Tc(e,a,r);const o=TT(r,t)?0:1;if(!t.zoomFactor){n.scale=CT(e,t),null==n.scale&&((0,_.R)(i,DT,e.renderSpatialReference),Aa(a.frustum,DT)?n.scale=Pc(e,(0,v.q)(a.eye,DT),i.latitude):n.scale=Gc(e,a));const l=new Bc(s);Rc(e,n.targetGeometry,n.scale,r,o,l),n.camera=await l.resolver.promise}return n}function OT(e){return e&&(0,u.r)(e.camera)&&(e.rotation=_T(e.camera.heading)),e}(0,r.e)([(0,d.y)({constructOnly:!0})],vT.prototype,"view",void 0),(0,r.e)([(0,d.y)({constructOnly:!0})],vT.prototype,"desiredCamera",null),vT=(0,r.e)([(0,d.n)("esri.views.3d.state.controllers.SurfaceCollisionCorrectionController")],vT);const DT=(0,v.n)(),ET=(0,T.e)(),zT=(0,X.e)(),IT=(0,se.a)(),LT=(0,b.i)(),FT=(0,v.n)(),VT=(0,v.n)(),UT=(0,v.n)(),GT={heading:0,tilt:0},BT=new g.b,qT={point(e,t,i){i[0]=e.x,i[1]=e.y,e.hasZ&&(i[2]=e.z),t(i)},polygon(e,t,i){const r=e.hasZ;for(let s=0;s<e.rings.length;s++){const n=e.rings[s];for(let e=0;e<n.length;e++)i[0]=n[e][0],i[1]=n[e][1],r&&(i[2]=n[e][2]),t(i)}},polyline(e,t,i){const r=e.hasZ;for(let s=0;s<e.paths.length;s++){const n=e.paths[s];for(let e=0;e<n.length;e++)i[0]=n[e][0],i[1]=n[e][1],r&&(i[2]=n[e][2]),t(i)}},multipoint(e,t,i){const r=e.points,s=e.hasZ;for(let e=0;e<r.length;e++)i[0]=r[e][0],i[1]=r[e][1],s&&(i[2]=r[e][2]),t(i)},extent(e,t,i){e.hasZ?(t((0,v.a)(i,e.xmin,e.ymin,e.zmin)),t((0,v.a)(i,e.xmax,e.ymin,e.zmin)),t((0,v.a)(i,e.xmin,e.ymax,e.zmin)),t((0,v.a)(i,e.xmax,e.ymax,e.zmin)),t((0,v.a)(i,e.xmin,e.ymin,e.zmax)),t((0,v.a)(i,e.xmax,e.ymin,e.zmax)),t((0,v.a)(i,e.xmin,e.ymax,e.zmax)),t((0,v.a)(i,e.xmax,e.ymax,e.zmax))):(t((0,v.a)(i,e.xmin,e.ymin,i[2])),t((0,v.a)(i,e.xmax,e.ymin,i[2])),t((0,v.a)(i,e.xmin,e.ymax,i[2])),t((0,v.a)(i,e.xmax,e.ymax,i[2])))},mesh(e,t,i){const r=e.vertexAttributes&&e.vertexAttributes.position;if(r)for(let e=0;e<r.length;e+=3)t((0,v.a)(i,r[e+0],r[e+1],r[e+2]))}};class kT{constructor(e,t,i){this.target=e,this.options=t,this.view=i,this.state="pending",this.abortController=null,this.animationController=null,this.promise=new Promise(((e,t)=>{this.resolveCallback=e,this.rejectCallback=t;const i=(0,h.h)();(0,u.r)(this.options.signal)&&(0,h.v)(this.options.signal,(()=>{this.abort()})),this.abortController=i,this.waitForReady()}))}then(e,t){return this.promise.then(e,t)}catch(e){return this.promise.catch(e)}resolve(e){return this.state="finished",this.resolveCallback(e)}reject(e){return this.state="finished",this.rejectCallback(e)}abort(e=!1){switch(this.state){case"pending":case"wait-for-ready":case"wait-for-viewpoint":this.reject((0,h.m)());break;case"wait-for-animation-finish":!e&&(0,u.r)(this.animationController)&&this.view.state.cameraController===this.animationController&&this.animationController.active&&this.animationController.stopController(),this.reject((0,h.m)())}}waitForReady(){this.state="wait-for-ready",this.view.ready?this.createViewPoint():(0,p.j)(this.view,"ready",this.abortController.signal).then((()=>{this.createViewPoint()}),(e=>{this.reject(e)}))}createViewPoint(){"finished"!==this.state&&(this.state="wait-for-viewpoint",this.animationController=this.options.animate?this.getAnimationController():null,wT(this.view,this.target,this.abortController.signal).then((e=>{if("finished"===this.state)return;const t=this.getCameraFromViewpoint(e);if(!(0,u.t)(t))if(this.options.animate){if((0,u.t)(this.animationController))return;this.startAnimation(t,this.animationController)}else this.view.stateManager.setStateCamera(t.camera,{applyConstraints:!t.isFullySpecified,positionAndOrientationOnly:!0,doNotCancelGoToOperation:!0}),this.resolve()}),(e=>{this.reject(e)})))}getCameraFromViewpoint(e){const t=!!(this.target instanceof s.u&&this.target.camera||this.target instanceof s.R),i=e.camera;if((0,u.t)(i))return null;if(!this.view.stateManager.isCompatible(i)){const e=i.position,t=e&&e.spatialReference,r=t?t.wkid:"none",s=this.view.spatialReference.wkid;return this.reject(new h.s("GotoAnimation:incompatible-spatialreference",`Resulting camera has an incompatible spatial reference (camera: ${r}, view: ${s})`,{camera:i})),null}const r=wc(this.view,i);return(0,u.t)(r)?(this.reject(new h.s("GotoAnimation:invalid-camera","Resulting camera is invalid")),null):{viewpoint:e,camera:r,isFullySpecified:t}}startAnimation(e,t){this.state="wait-for-animation-finish";const i=t.viewAnimation;if((0,u.t)(i))return void this.reject(new h.s("GotoAnimation:missing-animation","Unreachable code in view.stateManager"));if(i.update(e.viewpoint,"running"),!t.active||(0,u.t)(t.viewAnimation)||t.viewAnimation.target!==e.viewpoint||this.view.state.cameraController!==t)return this.abort();let r;e.isFullySpecified?(r=new vT({view:this.view,desiredCamera:e.camera}),mn(this.view,e.camera,1)):oa(this.view,e.camera),t.begin(e.camera,this.options);const s=e=>{if(!(0,u.t)(this.view.state))switch(t.state){case oo.Finished:switch(this.state){case"pending":case"wait-for-ready":case"wait-for-viewpoint":case"wait-for-animation-finish":this.resolve()}break;case oo.Ready:case oo.Rejected:case oo.Running:case oo.Stopped:switch(this.state){case"pending":case"wait-for-ready":case"wait-for-viewpoint":case"wait-for-animation-finish":this.reject(e)}}};i.when((()=>{const i=this.view.state.cameraController;r&&(i&&i.active?i instanceof ho&&(0,u.r)(i.viewAnimation)&&i.viewAnimation.target===e.viewpoint&&(this.view.state.cameraController=r):(0,u.r)(t.viewAnimation)&&t.viewAnimation.target===e.viewpoint&&"finished"===t.state&&(this.view.state.cameraController=r))}),(e=>s(e))),t.asyncResult={resolve:()=>s(),reject:e=>s(e)}}getAnimationController(){let e,t=null;const i=this.view.state.cameraController;return i instanceof ho&&(i.updateStateFromViewAnimation(),i.active&&(e=i,t=e.viewAnimation)),null!=e||(e=new ho({view:this.view,mode:"animation"}),t=e.viewAnimation,this.view.state.switchCameraController(e))?e:((0,u.r)(t)&&t.stop(),this.reject(new h.s("GotoAnimation:goto-cannot-interrupt","Cannot start an animation while interacting")),null)}}const NT=u.n.getLogger("esri.views.3d.state.ViewStateManager");let jT=class extends r.p{constructor(e){super(e),this.propertiesPool=new KC({frustum:dC},this),this.handles=new R.u,this.cameraSetByUser=!1,this.gotoOperation=null,this.ready=!1,this.updateDevicePixelRatio=null,this.test={contentCameraResetState:new Map}}get camera(){const e=this._get("camera");if(!this.ready)return e;const t=Tc(this.view,this.view.state.camera);return t&&e&&t.equals(e)?e:t}set camera(e){this.updatePropertyBeforeReady("camera",e)||this.setStateCamera(wc(this.view,e),{applyConstraints:!1})||NT.error("#camera=","Invalid camera",e)}get contentCamera(){const e=this._get("contentCamera");if(!this.ready)return e;const t=Tc(this.view,this.view.state.contentCamera);return t&&e&&t.equals(e)?e:t}set contentCamera(e){if(this.updatePropertyBeforeReady("contentCamera",e))return;const t=wc(this.view,e);(0,u.t)(t)?this.view.state.contentCamera=null:(this.updateElevation(t),this.view.state.contentCamera=t)}installContentCameraReset(e){if(this.handles.remove("contentCameraReset"),this.test.contentCameraResetState.clear(),!this.view.state.fixedContentCamera)return!1;const t=this.zoom,i=this.view.state.camera.distance**2,r=(0,v.M)(this.view.state.camera.center),s=e.sticky?this.contentCamera.clone():null;return this.handles.add([this.watch("contentCamera",(()=>{e.sticky||(this.handles.remove("contentCameraReset"),this.test.contentCameraResetState.clear())})),this.watch("zoom",(e=>{this.test.contentCameraResetState.set("view.zoom",Math.abs(e-t)/2),Math.abs(e-t)>2?this.contentCamera=null:this.view.state.fixedContentCamera||(this.contentCamera=s)})),this.view.state.watch("camera",(e=>{const t=(0,v.D)(r,e.center);this.test.contentCameraResetState.set("camera.center",t/i),t>i?this.contentCamera=null:this.view.state.fixedContentCamera||(this.contentCamera=s)}))],"contentCameraReset"),!0}get center(){return this.ready?this.view.pointsOfInterest.centerOnContent.location:this._get("center")}set center(e){this.updatePropertyBeforeReady("center",e)||(e?this.isCompatible(e)?this.setStateCamera(this.centerToCamera(e),{applyConstraints:!0})?this.view.pointsOfInterest.centerOnContent.runTask():NT.error("#center=","Invalid center",e):NT.error("#center=","Center has an incompatible spatial reference (center: "+(e.spatialReference?e.spatialReference.wkid:"none")+", view: "+this.view.spatialReference.wkid+")",e):NT.error("#center=","Center may not be null or undefined"))}get extent(){if(!this.ready)return this._get("extent");const e=this.view,t=function(e,t,i){const r=e.renderSpatialReference,s=(0,_.d)(i,r,xc(e));if((0,u.t)(s))return null;const n=Math.tan(t.fovX/2),a=Math.tan(t.fovY/2),o=(0,v.S)(t.eye,i),l=2*o*n*1,c=2*o*a*1;return"global"===e.viewingMode?hc(e,s,l,c):Jl(e,s,l,c)}(e,e.state.camera,e.pointsOfInterest.centerOnContent.renderLocation);return(0,u.r)(t)?t:this._get("extent")}set extent(e){this.updatePropertyBeforeReady("extent",e)||(e?this.isCompatible(e)?this.setStateCamera(this.extentToCamera(e),{applyConstraints:!0})||NT.error("#extent=","Invalid extent",e):NT.error("#extent=","Extent has an incompatible spatial reference (extent: "+(e.spatialReference?e.spatialReference.wkid:"none")+", view: "+this.view.spatialReference.wkid+")",e):NT.error("#extent=","Extent may not be null or undefined"))}get frustum(){const e=this.propertiesPool.get("frustum");return e.renderCoordsHelper=this.view.renderCoordsHelper,e.update(this.view.state.camera),e}get hasInitialView(){return!!this.view.get("map.initialViewProperties.viewpoint")}get scale(){if(this.ready){const e=this.view.pointsOfInterest.centerOnContent;return Pc(this.view,e.distance,e.location.latitude)}return this._get("scale")}set scale(e){this.updatePropertyBeforeReady("scale",e)||this.setStateCamera(this.scaleToCamera(e),{applyConstraints:!0})||NT.error("#scale=","Invalid scale",e)}get padding(){if(!this.ready)return this._get("padding");const e=this.view.state.camera,t=e.padding,i=e.pixelRatio,r=this._get("padding"),s=Math.round(t[0]/i),n=Math.round(t[1]/i),a=Math.round(t[2]/i),o=Math.round(t[3]/i);return null!=r&&r.top===s&&r.right===n&&r.bottom===a&&r.left===o?r:{top:s,right:n,bottom:a,left:o}}set padding(e){this.updatePropertyBeforeReady("padding",e)||(this.paddingToArray(e,this.view.state.camera.pixelRatio,$T),this.view.state.updateCamera((e=>e.padding=$T)))}paddingToArray(e,t,i){e?(0,j.r)(i,e.top||0,e.right||0,e.bottom||0,e.left||0):(0,j.r)(i,0,0,0,0);for(let e=0;e<4;e++)i[e]=Math.round(i[e]*t)}get screenCenter(){const e=this.padding;return(0,f.c)((this.view.width-(e.left+e.right))/2+e.left,(this.view.height-(e.top+e.bottom))/2+e.top)}get viewpoint(){return this.ready?function(e,t,i=null){return(0,u.t)(i)&&(i=new s.u),ST(e,null,t.clone(),i)}(this.view,this.camera):this._get("viewpoint")}set viewpoint(e){if(!this.updatePropertyBeforeReady("viewpoint",e))if(e)if(this.isCompatible(e))this.setStateCamera(this.viewpointToCamera(e),{applyConstraints:!e.camera})||NT.error("#viewpoint=","Invalid viewpoint",e);else{const t=(0,u.r)(e.camera)?e.camera.position:e.targetGeometry,i=(0,u.r)(t)&&t.spatialReference;NT.error("#viewpoint=","Viewpoint has an incompatible spatial reference (viewpoint: "+(i?i.wkid:"none")+", view: "+this.view.spatialReference.wkid+")",e)}else NT.error("#viewpoint=","Viewpoint may not be null or undefined")}get zoom(){return this.ready?Vc(this.view,this.scale):this._get("zoom")}set zoom(e){this.updatePropertyBeforeReady("zoom",e)||this.setStateCamera(this.zoomToCamera(e),{applyConstraints:!0})||NT.error("#zoom=","Invalid zoom",e)}initialize(){this.handles.add([(0,p.C)(this.view,"state.events","before-camera-change",(e=>this.updateElevation(e.camera)))]),(0,p.g)(this.view.state,"camera",(e=>this.updateElevation(e)),!0),this.handles.add((0,r.A)({prepare:()=>this.prepareFrame()})),this.handles.add(this.view.state.watch("cameraController",(()=>{this.cameraSetByUser=!0,this.handles.remove(KT)}))),this.handles.add((0,p.C)(this.view,"state.events","camera-projection-changed",(()=>this.notifyChange("scale"))))}destroy(){this.deinit(),this.handles&&(this.handles.destroy(),this.handles=null),this.propertiesPool&&(this.propertiesPool.destroy(),this.propertiesPool=null)}init(){this.constraintsManager=new gT({view:this.view}),this.prepareFrame();const e=this.getInitialProperties();this.cameraSetByUser=!1,this._set("ready",!0);for(const t of e)this.set(t.name,t.value);if(!this.cameraSetByUser){const e=this.view.get("map.initialViewProperties.viewpoint")||this.view.initialExtent;e&&this.isCompatible(e)?this.setInitialView(e):2===this.view.state.viewingMode&&this.handles.add((0,p.j)(this.view.basemapTerrain,"ready",(()=>{this.handles.remove(KT),this.setInitialView(this.view.groundExtent)})),KT)}}deinit(){this.cancelGoToOperation(),this.ready&&(this._override("padding",this.padding),this._set("ready",!1),this._clearOverride("hasInitialView"),this.cameraSetByUser=!1,this.handles.remove(KT),this.constraintsManager&&(this.constraintsManager.destroy(),this.constraintsManager=null))}async goTo(e,t){const i={animate:!0,...t};return(0,u.r)(this.gotoOperation)&&this.gotoOperation.abort(i.animate),this.gotoOperation=new kT(e,i,this.view),this.view.resourceController.scheduler.stopFrame(),this.gotoOperation}debugSetCameraOnContent(){this.setStateCamera(on(this.view),{applyConstraints:!1})}step(e){const t=this.view.state,i=t&&this.view.state.cameraController;i&&(t.updateCamera((t=>{i.stepController(e,t)})),i.steppingFinished&&i.finishController())}cancelGoToOperation(){(0,u.r)(this.gotoOperation)&&(this.gotoOperation.abort(),this.gotoOperation=null)}getInitialProperties(){const e=new Set,t=[];for(const{propertyName:i,overrides:r}of QT){const s=e.has(i),n=this._isOverridden(i);!s&&n&&t.push({name:i,value:this._get(i)}),this._clearOverride(i),(s||n)&&r.forEach((t=>e.add(t)))}return t}setInitialView(e){if(!e||this.cameraSetByUser)return;if(e instanceof s.R)return void this.setStateCamera(wc(this.view,e),{applyConstraints:!1});if(e instanceof s.u){if(e.targetGeometry instanceof A.M){const t=Ec(this.view,e.targetGeometry,0,.5,0);return void((0,u.r)(t)&&this.setStateCamera(wc(this.view,t),{applyConstraints:!0}))}const t={applyConstraints:!e.camera},i=this.viewpointToCamera(e);return void this.setStateCamera(i,t)}const t=Ec(this.view,e,0,.5,0);(0,u.r)(t)&&this.setStateCamera(wc(this.view,t),{applyConstraints:!0})}updatePropertyBeforeReady(e,t){return!this.ready&&(this._override(e,t),t&&-1!==WT.indexOf(e)&&this._override("hasInitialView",!0),!0)}isCompatible(e){return!(0,u.t)(e)&&(e instanceof s.u?e.camera?this.isCompatible(e.camera):this.isCompatible(e.targetGeometry):e instanceof s.R?this.isCompatible(e.position):e.spatialReference&&(0,g.x)(e.spatialReference,this.view.spatialReference))}getPreservingHeadingTilt(e=ZT){return this.cameraSetByUser?(e.heading=this.camera.heading,e.tilt=this.camera.tilt):(e.heading=0,e.tilt=.5),e}centerPointAtDistanceToCamera(e,t,i=XT){const{heading:r,tilt:s}=this.getPreservingHeadingTilt(),n=Oc(this.view,r,s,e,t,1);return(0,u.t)(n)?null:(i.copyFrom(this.view.state.camera),i.eye=n.eye,i.center=n.center,i.up=n.up,i)}centerToCamera(e){const t=this.view.pointsOfInterest.centerOnContent;t.runTask();const i=t.distance;return this.centerPointAtDistanceToCamera(e,i)}extentToCamera(e){const{heading:t,tilt:i}=this.getPreservingHeadingTilt(),r=Ec(this.view,e,t,i,1,YT);return(0,u.r)(r)?wc(this.view,r):null}scaleToCamera(e){if(null==e)return null;const t=this.view.pointsOfInterest.centerOnContent;t.runTask();const i=t.renderLocation,r=t.location.latitude,s=Sc(this.view,e,r);return this.centerPointAtDistanceToCamera(i,s)}zoomToCamera(e){return this.scaleToCamera(Uc(this.view,e))}viewpointToCamera(e){return wc(this.view,bT(this.view,e))}setStateCamera(e,t){return!((0,u.t)(e)||!this.view.state.stopActiveCameraController()||(this.cameraSetByUser=!0,t.doNotCancelGoToOperation||this.cancelGoToOperation(),this.view.state.updateCamera((i=>{t.positionAndOrientationOnly?(i.eye=e.eye,i.center=e.center,i.up=e.up):i.copyFrom(e),t.applyConstraints&&oa(this.view,i)})),t.applyConstraints||(this.view.state.cameraController=new vT({view:this.view,desiredCamera:e})),0))}prepareFrame(){const{container:e,canvas:t}=this.view;if(!e||!t)return;(0,u.r)(this.updateDevicePixelRatio)&&this.updateDevicePixelRatio();const i=this.view.pixelRatio,r=Math.round(e.clientWidth*i),s=Math.round(e.clientHeight*i);if(0!==r&&0!==s&&(t.width===r&&t.height===s||(t.width=r,t.height=s),this.view.state)){const e=this.view.state.camera;e.fullWidth===r&&e.fullHeight===s&&e.pixelRatio===i||(XT.copyFrom(e),XT.pixelRatio!==i&&(this.paddingToArray(this.padding,i,$T),XT.padding=$T),XT.fullWidth=r,XT.fullHeight=s,XT.pixelRatio=i,this.view.state.camera=XT)}}updateElevation(e){const t=this.view.basemapTerrain&&this.view.basemapTerrain.spatialReference,i=this.view.renderCoordsHelper.getAltitude(e.eye),r=t?an(this.view,e.eye):0;e.relativeElevation=i-r}};(0,r.e)([(0,d.y)({type:s.R,dependsOn:["view.state.camera","ready"]})],jT.prototype,"camera",null),(0,r.e)([(0,d.y)({type:s.R,dependsOn:["view.state.contentCamera","ready"]})],jT.prototype,"contentCamera",null),(0,r.e)([(0,d.y)({type:g.b})],jT.prototype,"center",null),(0,r.e)([(0,d.y)({type:A.M})],jT.prototype,"extent",null),(0,r.e)([(0,d.y)({readOnly:!0})],jT.prototype,"frustum",null),(0,r.e)([(0,d.y)({readOnly:!0})],jT.prototype,"hasInitialView",null),(0,r.e)([(0,d.y)({readOnly:!0,type:Boolean})],jT.prototype,"ready",void 0),(0,r.e)([(0,d.y)({type:Number})],jT.prototype,"scale",null),(0,r.e)([(0,d.y)()],jT.prototype,"padding",null),(0,r.e)([(0,d.y)({readOnly:!0})],jT.prototype,"screenCenter",null),(0,r.e)([(0,d.y)({constructOnly:!0})],jT.prototype,"view",void 0),(0,r.e)([(0,d.y)({type:s.u})],jT.prototype,"viewpoint",null),(0,r.e)([(0,d.y)({type:Number})],jT.prototype,"zoom",null),(0,r.e)([(0,d.y)({constructOnly:!0})],jT.prototype,"updateDevicePixelRatio",void 0),jT=(0,r.e)([(0,d.n)("esri.views.3d.state.ViewStateManager")],jT);var HT=jT;const WT=["camera","viewpoint","extent","scale","center","zoom"],QT=[{propertyName:"camera",overrides:["viewpoint"]},{propertyName:"viewpoint",overrides:["extent"]},{propertyName:"extent",overrides:["center","scale"]},{propertyName:"center",overrides:[]},{propertyName:"scale",overrides:["zoom"]},{propertyName:"zoom",overrides:[]},{propertyName:"padding",overrides:[]}],ZT={heading:0,tilt:0},YT=new s.R,XT=new Ia,$T=(0,w.n)(),KT="pending-initial-view";class JT{constructor(e,t,i){this.viewingMode=e,this.layerProvider=t,this.view=i,this.externalIntersectionHandlers=new r.f,this.tolerance=sn.DEFAULT_TOLERANCE,this.tmpRay=(0,S.x)(),this.validateHUDIntersector=new sn(this.viewingMode),this.validateHUDIntersector.options.hud=!1}intersectScreen(e,t){return this.intersectRay(this.getPickRay(e,this.tmpRay),iS(this.viewingMode),t)}intersectScreenFreePointFallback(e,t){return this.intersectRayFreePointFallback(this.getPickRay(e,this.tmpRay),t)}intersectRayFreePointFallback(e,t){return this.intersectRay(e,iS(this.viewingMode),t)||this.intersectRayFreePointLocal(e,t)}intersectRay(e,t,i,r){return t.options.selectionMode=!1,t.options.store=0,this.computeIntersection(e,t,r),!!t.results.min&&t.results.min.getIntersectionPoint(i)}getCenterRayWithSubpixelOffset(e,t,i=.5,r=.5){return e.getRenderCenter(aS,i,r),aS[0]+=.0466,aS[1]-=.0123,Ao(e,aS,t)}intersectIntersectorScreen(e,t,i){this.computeIntersection(this.getPickRay(e,this.tmpRay),t,i)}intersectToolIntersectorScreen(e,t,i){const r=this.getPickRay(e,this.tmpRay);this.intersectToolIntersectorRay(r,t,i)}intersectToolIntersectorRay(e,t,i){t.options.selectionMode=!0,this.computeIntersection(e,t,i);const r=t.results.min;this.view.basemapTerrain&&this.view.basemapTerrain.opaque||r.hasIntersectionPoint&&"TerrainRenderer"!==r.intersector||(t.options.selectionMode=!1,this.computeIntersection(e,t,i))}setTolerance(e=sn.DEFAULT_TOLERANCE){this.tolerance=e}addIntersectionHandler(e){this.externalIntersectionHandlers.push(e),this.externalIntersectionHandlers.sort(((e,t)=>"Terrain"===e.type?1:"Terrain"===t.type?-1:0))}removeIntersectionHandler(e){this.externalIntersectionHandlers.removeUnordered(e),this.externalIntersectionHandlers.sort(((e,t)=>"Terrain"===e.type?1:"Terrain"===t.type?-1:0))}getPickRay(e,t=(0,S.x)()){return Po(this.view.state.camera,e,t)}intersectRayFreePointLocal(e,t){if(2!==this.viewingMode||(0,u.t)(e))return!1;const i=this.view.dataExtent,r={x:i.xmax-i.xmin,y:i.ymax-i.ymin,z:8*Math.max(i.xmax-i.xmin,i.ymax-i.ymin)},s=Math.max(r.x,r.y,r.z);if(0===s)return(0,v.u)(t,e.origin,(0,v.j)(w.c.get(),e.direction)),!0;const n=this.view.state.camera,a=Math.max(0,i.xmin-n.eye[0],n.eye[0]-i.xmax),o=Math.max(0,i.ymin-n.eye[1],n.eye[1]-i.ymax),l=Math.sqrt(a*a+o*o),c=Math.abs(n.relativeElevation)+Number.MIN_VALUE,h=Math.max(0,Math.log(s/c))**2;let d=s/Math.max(1,h);d=Math.max(d,Math.min(l,s));const p=(0,v.d)(w.c.get(),e.direction,d/(0,v.s)(e.direction));return(0,v.u)(t,e.origin,p),!0}intersectElevationFromScreen(e,t,i=0,r=null){return this.intersectElevation(this.getPickRay(e,this.tmpRay),t,i,r)}intersectElevation(e,t,i=0,r=null){if((0,u.t)(e))return null;const s=(0,u.r)(t)?t.mode:"absolute-height",n=(0,u.r)(t)?(0,u.q)(t.offset,0):0,a="on-the-ground"!==s?n+i:0,o=a/this.view.renderCoordsHelper.unitInMeters;if("absolute-height"===s){if(this.view.renderCoordsHelper.intersectInfiniteManifold(e,a,nS)){const e=this.view.computeMapPointFromVec3d(nS);return e.z-=n,e}return null}const l=this.view.state.camera,c=(0,f.p)(w.c.get());l.projectToRenderScreen(e.origin,c);const h=this.prepareFilters(null,rS),d=this.view.slicePlane,p=(0,u.r)(d)?Xs(d):null,m=new sn(this.viewingMode);m.options.store=0,m.options.verticalOffset=o;const g=e.origin,y=(0,v.u)(w.c.get(),g,e.direction);m.reset(g,y),m.point=c,m.camera=l,m.filterPredicate=null;const _=(0,u.r)(r)?"type"in r&&"graphics"===r.type?e=>e.metadata.layerUid!==r.uid:e=>e.metadata.graphicUid!==r.uid:null;switch(s){case"relative-to-scene":{const e=e=>((0,u.t)(_)||_(e))&&e.metadata&&e.metadata.isElevationSource;m.intersect(h.layers,c,l,this.tolerance,null,e),this.externalIntersectionHandlers.forAll((e=>{if("I3S"===e.type||"Terrain"===e.type){const t=e.slicePlane?p:null;e.intersect(m,t,m.rayBeginPoint,m.rayEndPoint,c)}}))}break;case"on-the-ground":case"relative-to-ground":this.externalIntersectionHandlers.forAll((e=>{if(e.isGround){const t=e.slicePlane?p:null;e.intersect(m,t,m.rayBeginPoint,m.rayEndPoint,c)}}))}if(m.results.min.getIntersectionPoint(nS)){const e=this.view.computeMapPointFromVec3d(nS);return e.z=i,e}return null}computeIntersection(e,t,i){if((0,u.t)(e))return;const r=this.view.state.camera,s=(0,f.p)(w.c.get());r.projectToRenderScreen(e.origin,s);const n=this.prepareFilters(i,rS);t.options.selectOpaqueTerrainOnly=!i||!("include"in i||"exclude"in i);const a=e.origin,o=(0,v.u)(w.c.get(),e.origin,e.direction);t.reset(a,o),t.intersect(n.layers,s,r,this.tolerance);const l=this.view.slicePlane,c=(0,u.r)(l)?Xs(l):null;t.intersect(n.sliceableLayers,s,r,this.tolerance,c);const h=i&&(i.requiresGroundFeedback||i.enableDraped);this.externalIntersectionHandlers.forAll((e=>{if(t.options.isFiltered=!n.filterLayerUid(e.intersectionHandlerId),e.isGround&&h||!t.options.isFiltered){const i=e.slicePlane?c:null;e.intersect(t,i,a,o,s)}}));const d=w.c.get();if(i&&i.enableDraped&&t.results.ground.getIntersectionPoint(d)){const e=this.view.basemapTerrain.overlayManager.renderer,i=this.view.renderCoordsHelper.spatialReference,r=w.c.get();this.view.renderCoordsHelper.fromRenderCoords(d,r,this.view.spatialReference),r[2]=(0,u.q)(this.view.elevationProvider.getElevation(d[0],d[1],d[2],i,"ground"),0),e.intersect(t,r,n.filterRenderGeometry)}t.sortResults();const p=t.results.hud;if(p.hasIntersectionPoint){const e=(0,f.p)(w.c.get()),i=w.c.get(),s=w.c.get();this.unprojectHUDResultRay(p.center,e,i,s);const a=(0,v.q)(p.center,i)/(0,v.q)(i,s)*.99;this.validateHUDIntersector.reset(i,s),this.validateHUDIntersector.intersect(n.layers,e,r,this.tolerance),this.validateHUDIntersector.intersect(n.sliceableLayers,e,r,this.tolerance,c),this.externalIntersectionHandlers.forAll((t=>{if(!n.filterLayerUid(t.intersectionHandlerId))return;const r=t.slicePlane?c:null;t.intersect(this.validateHUDIntersector,r,i,s,e)}));const o=this.validateHUDIntersector.results.min;(null==o.dist||a<=o.dist)&&(t.results.min.copyFrom(p),t.results.all.splice(0,0,p))}}prepareFilters(e,t){const i=[],r=[];return this.layerProvider.forEachLayer((e=>{e.isPickable&&(e.isSliceable?r:i).push(e)})),t.include=e&&e.include,t.exclude=e&&e.exclude,t.layers.length=0,t.sliceableLayers.length=0,eS(i,t.filterLayer,t.layers),eS(r,t.filterLayer,t.sliceableLayers),t}unprojectHUDResultRay(e,t,i,r){const s=this.view.state.camera;s.projectToRenderScreen(e,t);const n=(0,f.p)(w.c.get());n[0]=t[0],n[1]=t[1],n[2]=0,s.unprojectFromRenderScreen(n,i),n[2]=1,s.unprojectFromRenderScreen(n,r)}}function eS(e,t,i){for(const r of e)t&&!t(r)||i.push(r);return i}let tS;function iS(e){return tS||(tS=new sn(e)),tS.viewingMode=e,tS}const rS={include:null,exclude:null,layers:[],sliceableLayers:[],filterLayer:e=>rS.filterLayerUid(e.apiLayerUid),filterLayerUid(e){const{include:t,exclude:i}=rS;return(0,u.t)(e)?null==t&&null==i:(null==t||t.has(e))&&(null==i||!i.has(e))},filterRenderGeometry:e=>rS.filterLayerUid(e.layerUid)};function sS(e){return"object"==typeof e&&"intersect"in e}const nS=(0,v.n)(),aS=(0,f.s)();class oS{constructor(e,t){this.spatialReference=e,this.view=t}getElevation(e,t,i){return this.view.elevationProvider.getElevation(e,t,0,this.spatialReference,i)}async queryElevation(e,t,i,r,s){return this.view.elevationProvider.queryElevation(e,t,0,this.spatialReference,s,i,r)}}class lS{constructor(e,t,i,r){this.spatialReference=t,this._getElevationQueryProvider=i,this._queries=new Array,this._queryOptions={...r,ignoreInvisibleLayers:!0},this._frameTask=e.registerTask(Jd.ELEVATION_QUERY,this)}destroy(){this._frameTask.remove()}queryElevation(e,t,i,s=0){return new Promise(((n,a)=>{const o={x:e,y:t,minDemResolution:s,result:{resolve:n,reject:a},signal:i};this._queries.push(o),(0,h.v)(i,(()=>{(0,r.C)(this._queries,o),a((0,h.m)())}))}))}get running(){return this._queries.length>0}runTask(){const e=this._queries;this._queries=[];const t=this._getElevationQueryProvider();if(!t)return void e.forEach((e=>e.result.reject()));const i=e.map((e=>[e.x,e.y])),r=e.reduce(((e,t)=>Math.min(e,t.minDemResolution)),1/0),s=new A.u({points:i,spatialReference:this.spatialReference}),n=e.length>1&&e.some((e=>!!e.signal))?(0,h.h)():null,a=(0,u.r)(n)?n.signal:e[0].signal;if((0,u.r)(n)){let t=0;e.forEach((i=>(0,h.v)(i.signal,(()=>{t++,i.result.reject((0,h.m)()),t===e.length&&n.abort()}))))}const o={...this._queryOptions,minDemResolution:r,signal:a};t.queryElevation(s,o).then((t=>{e.forEach(((e,i)=>{(0,u.r)(e.signal)&&e.signal.aborted?e.result.reject((0,h.m)()):e.result.resolve(t.geometry.points[i][2])}))})).catch((t=>{e.forEach((e=>e.result.reject(t)))}))}get test(){const e=this;return{update:()=>e._queries.length>0&&e.runTask()}}}let cS=class extends(n.n.EventedMixin(r.p)){constructor(e){super(e),this.im=new Array,this.ground=new Array,this.scene=new Array,this.handles=new Map}destroy(){this._elevationQuery=(0,u.k)(this._elevationQuery)}get elevationQuery(){return(0,u.t)(this._elevationQuery)&&(this._elevationQuery=new lS(this.view.resourceController.scheduler,this.view.spatialReference,(()=>this.view.map&&this.view.map.ground),{maximumAutoTileRequests:4})),this._elevationQuery}getElevation(e,t,i,r,s){let n=null;return n=hS(n,this.im,e,t,i,r,s),(0,u.t)(n)&&(n=hS(n,this.ground,e,t,i,r,s)),"scene"===s&&(n=hS(n,this.scene,e,t,i,r,s)),n}queryElevation(e,t,i,r,s,n=null,a=0){const o=(0,h.D)();return this.elevationQuery.queryElevation(e,t,n,a).then((n=>{"scene"===s&&(n=hS(n,this.scene,e,t,i,r,s)),o.resolve(n)})).catch((n=>{(0,h.g)(n)?o.reject(n):o.resolve(this.getElevation(e,t,i,r,s))})),o.promise}register(e,t){this.handles.set(t,t.on("elevation-change",(e=>this.emit("elevation-change",e)))),this[e].push(t)}unregister(e){this.handles.has(e)&&(this.handles.get(e).remove(),this.handles.delete(e));for(const t of[this.im,this.ground,this.scene]){const i=t.indexOf(e);i>-1&&t.splice(i,1)}}};function hS(e,t,i,r,s,n,a){for(const o of t){const t=o.getElevation(i,r,s,n,a);(0,u.r)(t)&&(e=(0,u.r)(e)?Math.max(t,e):t)}return e}(0,r.e)([(0,d.y)({constructOnly:!0})],cS.prototype,"view",void 0),(0,r.e)([(0,d.y)({readOnly:!0,aliasOf:"view.basemapTerrain.spatialReference"})],cS.prototype,"spatialReference",void 0),cS=(0,r.e)([(0,d.n)("esri.views.3d.support.CombinedElevationProvider")],cS);class dS{static isValidProfile(e){return e in dS.profiles}static getDefaultProfile(){return(0,u.c)("trident")||(0,u.c)("esri-iPhone")?"low":"medium"}static apply(e,t){const i=dS.profiles[e];t.graphics3D.maxTotalNumberOfFeatures=i.graphics3D.maxTotalNumberOfFeatures,t.graphics3D.maxTotalNumberOfPrimitives=i.graphics3D.maxTotalNumberOfPrimitives,t.graphics3D.polygonLodFactor=i.graphics3D.polygonLodFactor,t.graphics3D.polylineLodFactor=i.graphics3D.polylineLodFactor;{const e=t.sceneService["3dObject"],r=i.sceneService["3dObject"];e.lodFactor=r.lodFactor,e.lodCrossfadeinDuration=r.lodCrossfadeinDuration,e.lodCrossfadeoutDuration=r.lodCrossfadeoutDuration,e.lodCrossfadeUncoveredDuration=r.lodCrossfadeUncoveredDuration}t.sceneService.point.lodFactor=i.sceneService.point.lodFactor,t.sceneService.integratedMesh.lodFactor=i.sceneService.integratedMesh.lodFactor,t.sceneService.pointCloud.lodFactor=i.sceneService.pointCloud.lodFactor,t.sceneService.uncompressedTextureDownsamplingEnabled=i.sceneService.uncompressedTextureDownsamplingEnabled,t.tiledSurface.lodBias=i.tiledSurface.lodBias,t.tiledSurface.angledSplitBias=i.tiledSurface.angledSplitBias,t.tiledSurface.reduceTileLevelDifferences=i.tiledSurface.reduceTileLevelDifferences,t.tiledSurface.textureFadeDuration=i.tiledSurface.textureFadeDuration,t.antialiasingEnabled=i.antialiasingEnabled,t.physicallyBasedRenderingEnabled=i.physicalBasedRenderingEnabled,t.highQualityTransparency=i.highQualityTransparency,t.memoryLimit=i.memoryLimit,t.additionalCacheMemory=i.additionalCacheMemory,t.frameRate=i.frameRate,t.maximumRenderResolution=i.maximumRenderResolution,t.maximumPixelRatio=i.maximumPixelRatio}}function uS(){const e=!!(0,u.c)("esri-mobile");return{low:{graphics3D:{maxTotalNumberOfFeatures:25e3,maxTotalNumberOfPrimitives:85e4,polygonLodFactor:.5,polylineLodFactor:1},sceneService:{"3dObject":{lodFactor:.2,lodCrossfadeinDuration:0,lodCrossfadeoutDuration:0,lodCrossfadeUncoveredDuration:0},point:{lodFactor:1},integratedMesh:{lodFactor:.6},pointCloud:{lodFactor:.5},uncompressedTextureDownsamplingEnabled:!0},tiledSurface:{lodBias:-1,angledSplitBias:.5,reduceTileLevelDifferences:!1,textureFadeDuration:0},antialiasingEnabled:!1,physicalBasedRenderingEnabled:!1,highQualityTransparency:!1,memoryLimit:200,additionalCacheMemory:0,frameRate:0,maximumRenderResolution:null,maximumPixelRatio:1},medium:{graphics3D:{maxTotalNumberOfFeatures:5e4,maxTotalNumberOfPrimitives:17e5,polygonLodFactor:e?.8:1,polylineLodFactor:e?1.2:1.5},sceneService:{"3dObject":{lodFactor:1,lodCrossfadeinDuration:0,lodCrossfadeoutDuration:0,lodCrossfadeUncoveredDuration:400},point:{lodFactor:1},integratedMesh:{lodFactor:1},pointCloud:{lodFactor:1},uncompressedTextureDownsamplingEnabled:e},tiledSurface:{lodBias:0,angledSplitBias:1,reduceTileLevelDifferences:!(0,u.c)("disable-feature:reduce-map-tile-levels"),textureFadeDuration:400},antialiasingEnabled:!0,physicalBasedRenderingEnabled:!0,highQualityTransparency:!0,memoryLimit:e?600:750,additionalCacheMemory:e?0:150,frameRate:0,maximumRenderResolution:null,maximumPixelRatio:1},high:{graphics3D:{maxTotalNumberOfFeatures:5e4,maxTotalNumberOfPrimitives:17e5,polygonLodFactor:e?1.2:2,polylineLodFactor:e?1.2:2},sceneService:{"3dObject":{lodFactor:1,lodCrossfadeinDuration:0,lodCrossfadeoutDuration:0,lodCrossfadeUncoveredDuration:400},point:{lodFactor:1},integratedMesh:{lodFactor:1},pointCloud:{lodFactor:1},uncompressedTextureDownsamplingEnabled:!1},tiledSurface:{lodBias:0,angledSplitBias:1,reduceTileLevelDifferences:!(0,u.c)("disable-feature:reduce-map-tile-levels"),textureFadeDuration:400},antialiasingEnabled:!0,physicalBasedRenderingEnabled:!0,highQualityTransparency:!0,memoryLimit:e?900:1500,additionalCacheMemory:0,frameRate:0,maximumRenderResolution:e?null:4096,maximumPixelRatio:e?1:null}}}dS.debug={reset(){const e=uS();for(const t in e)dS.profiles[t]=e[t]}},function(e){e.profiles=uS()}(dS||(dS={}));var pS=dS;let mS=class extends r.p{constructor(){super(...arguments),this.color=new z.o([0,255,255]),this.haloColor=null,this.haloOpacity=1,this.fillOpacity=.25,this.shadowOpacity=.4,this.shadowColor=new z.o([0,0,0]),this.shadowDifference=.2}static toEngineOptions(e){const t=z.o.toUnitRGBA(e.color),i=(0,u.r)(e.haloColor)?z.o.toUnitRGBA(e.haloColor):t,r=z.o.toUnitRGBA(e.shadowColor);return{color:(0,_e.t)(t[0],t[1],t[2],t[3]),haloColor:(0,_e.t)(i[0],i[1],i[2],i[3]),haloOpacity:e.haloOpacity,haloOpacityOccluded:.25*e.haloOpacity,fillOpacity:e.fillOpacity,fillOpacityOccluded:.25*e.fillOpacity,shadowOpacity:e.shadowOpacity,shadowColor:(0,_e.t)(r[0],r[1],r[2],r[3]),occludedShadowOpacity:e.shadowOpacity*(1-e.shadowDifference)}}};(0,r.e)([(0,d.y)({type:z.o})],mS.prototype,"color",void 0),(0,r.e)([(0,d.y)({type:z.o})],mS.prototype,"haloColor",void 0),(0,r.e)([(0,d.y)()],mS.prototype,"haloOpacity",void 0),(0,r.e)([(0,d.y)()],mS.prototype,"fillOpacity",void 0),(0,r.e)([(0,d.y)()],mS.prototype,"shadowOpacity",void 0),(0,r.e)([(0,d.y)({type:z.o})],mS.prototype,"shadowColor",void 0),(0,r.e)([(0,d.y)()],mS.prototype,"shadowDifference",void 0),mS=(0,r.e)([(0,d.n)("esri.views.3d.support.HighlightOptions")],mS);var fS=mS;class gS{constructor(e,t,i=null){this.spatialReference=t,this.unitInMeters=(0,x.G)(this.spatialReference,(0,x.p)(this.spatialReference).metersPerDegree),this._geometryServicePromise=(0,ee.a)(this.loadGeometryService(e,i))}async loadGeometryService(e,t){if(t)return t;try{return await(0,xe.create)(e&&e.get("portalItem"))}catch{throw new h.s("mapcoordshelper:missing-geometry-service","Must specify geometryService in esri/config")}}async awaitGeometryService(){const e=await this._geometryServicePromise;if(!0===e.ok)return e.value;throw e.error}async toGeographic(e){const t=await this.awaitGeometryService();let i,r=!0;Array.isArray(e[0])&&"number"!=typeof e[0]?i=e:(i=[e],r=!1);const s=i.map((e=>e instanceof g.b?e:new g.b(e,this.spatialReference))),n=new be.a({geometries:s,outSpatialReference:O.k.WGS84}),a=(await t.project(n)).map((e=>"point"===e.type?[e.x,e.y]:void 0));return r?a:a[0]}}let vS=class extends r.p{constructor(){super(...arguments),this.minTotalNumberOfFeatures=2e3,this.maxTotalNumberOfFeatures=5e4,this.maxTotalNumberOfPrimitives=17e5,this.polygonLodFactor=1,this.polylineLodFactor=1}};(0,r.e)([(0,d.y)()],vS.prototype,"minTotalNumberOfFeatures",void 0),(0,r.e)([(0,d.y)()],vS.prototype,"maxTotalNumberOfFeatures",void 0),(0,r.e)([(0,d.y)()],vS.prototype,"maxTotalNumberOfPrimitives",void 0),(0,r.e)([(0,d.y)()],vS.prototype,"polygonLodFactor",void 0),(0,r.e)([(0,d.y)()],vS.prototype,"polylineLodFactor",void 0),vS=(0,r.e)([(0,d.n)("esri.views.3d.support.QualitySettings.Graphics3DSettings")],vS);let yS=class extends r.p{constructor(){super(...arguments),this.lodFactor=1}};(0,r.e)([(0,d.y)()],yS.prototype,"lodFactor",void 0),yS=(0,r.e)([(0,d.n)("esri.views.3d.support.QualitySettings.LoDFactorSettings")],yS);let _S=class extends yS{constructor(){super(...arguments),this.lodCrossfadeinDuration=0,this.lodCrossfadeoutDuration=0,this.lodCrossfadeUncoveredDuration=0}};_S=(0,r.e)([(0,d.n)("esri.views.3d.support.QualitySettings.LoDFactor3DObjectSettings")],_S);let xS=class extends r.p{constructor(){super(...arguments),this["3dObject"]=new _S,this.point=new yS,this.integratedMesh=new yS,this.pointCloud=new yS,this.uncompressedTextureDownsamplingEnabled=!1}};(0,r.e)([(0,d.y)({type:_S})],xS.prototype,"3dObject",void 0),(0,r.e)([(0,d.y)({type:yS})],xS.prototype,"point",void 0),(0,r.e)([(0,d.y)({type:yS})],xS.prototype,"integratedMesh",void 0),(0,r.e)([(0,d.y)({type:yS})],xS.prototype,"pointCloud",void 0),(0,r.e)([(0,d.y)()],xS.prototype,"uncompressedTextureDownsamplingEnabled",void 0),xS=(0,r.e)([(0,d.n)("esri.views.3d.support.QualitySettings.SceneServiceSettings")],xS);let bS=class extends r.p{constructor(){super(...arguments),this.lodBias=0,this.angledSplitBias=1,this.reduceTileLevelDifferences=!0,this.textureFadeDuration=500}};(0,r.e)([(0,d.y)()],bS.prototype,"lodBias",void 0),(0,r.e)([(0,d.y)()],bS.prototype,"angledSplitBias",void 0),(0,r.e)([(0,d.y)()],bS.prototype,"reduceTileLevelDifferences",void 0),(0,r.e)([(0,d.y)()],bS.prototype,"textureFadeDuration",void 0),bS=(0,r.e)([(0,d.n)("esri.views.3d.support.QualitySettings.TiledSurfaceSettings")],bS);let wS=class extends r.p{constructor(){super(...arguments),this.graphics3D=new vS,this.sceneService=new xS,this.tiledSurface=new bS,this.antialiasingEnabled=!0,this.physicallyBasedRenderingEnabled=!1,this.highQualityTransparency=!0}};(0,r.e)([(0,d.y)({type:vS})],wS.prototype,"graphics3D",void 0),(0,r.e)([(0,d.y)({type:xS})],wS.prototype,"sceneService",void 0),(0,r.e)([(0,d.y)({type:bS})],wS.prototype,"tiledSurface",void 0),(0,r.e)([(0,d.y)()],wS.prototype,"antialiasingEnabled",void 0),(0,r.e)([(0,d.y)()],wS.prototype,"physicallyBasedRenderingEnabled",void 0),(0,r.e)([(0,d.y)()],wS.prototype,"highQualityTransparency",void 0),(0,r.e)([(0,d.y)()],wS.prototype,"memoryLimit",void 0),(0,r.e)([(0,d.y)()],wS.prototype,"additionalCacheMemory",void 0),(0,r.e)([(0,d.y)()],wS.prototype,"frameRate",void 0),(0,r.e)([(0,d.y)()],wS.prototype,"maximumRenderResolution",void 0),(0,r.e)([(0,d.y)()],wS.prototype,"maximumPixelRatio",void 0),wS=(0,r.e)([(0,d.n)("esri.views.3d.support.QualitySettings.QualitySettings")],wS);var CS=wS;class TS{constructor(e,t,i,r){this.viewingMode=e,this.spatialReference=t,this.unitInMeters=i,this.coordinateSystem=r,this._coordinateSystem=function(e){const{value:t,operations:i}=e;return{operations:i,value:i.create(t)}}(r)}set extent(e){e&&function(e,t,i){e.operations.setExtent(e.value,t,i.value)}(this.coordinateSystem,e,this.coordinateSystem)}getAltitude(e){return function(e,t){return e.operations.altitudeAt(e.value,t)}(this.coordinateSystem,e)}setAltitude(e,t,i=e){return xo(this.coordinateSystem,i,t,e)}setAltitudeOfTransformation(e,t){!function(e,t,i,r){t!==r&&(0,C.n)(r,t),(0,v.a)(wo,r[12],r[13],r[14]),xo(e,wo,i,wo),r[12]=wo[0],r[13]=wo[1],r[14]=wo[2]}(this.coordinateSystem,t,e,t)}worldUpAtPosition(e,t){return function(e,t,i){return e.operations.axisAt(e.value,t,2,i)}(this.coordinateSystem,e,t)}worldBasisAtPosition(e,t,i){return function(e,t,i,r){return e.operations.axisAt(e.value,t,i,r)}(this.coordinateSystem,e,t,i)}basisMatrixAtPosition(e,t){const i=this.worldBasisAtPosition(e,0,w.c.get()),r=this.worldBasisAtPosition(e,1,w.c.get()),s=this.worldBasisAtPosition(e,2,w.c.get());return(0,C.s)(t,i[0],i[1],i[2],0,r[0],r[1],r[2],0,s[0],s[1],s[2],0,0,0,0,1),t}intersectManifoldClosestSilhouette(e,t,i){return bo(this.coordinateSystem,t,this._coordinateSystem),function(e,t,i){e.operations.intersectRayClosestSilhouette(e.value,t,i)}(this._coordinateSystem,e,i),i}intersectManifold(e,t,i){bo(this.coordinateSystem,t,this._coordinateSystem);const r=w.c.get();return function(e,t,i){return e.operations.intersectRay(e.value,t,i)}(this._coordinateSystem,e,r)?(0,v.h)(i,r):null}intersectInfiniteManifold(e,t,i){if(1===this.viewingMode)return this.intersectManifold(e,t,i);bo(this.coordinateSystem,t,this._coordinateSystem);const r=this._coordinateSystem.value,s=w.c.get();return Qe(r.plane,e,s)?(0,v.h)(i,s):null}toRenderCoords(e,t,i){return kt(e)?(0,_.R)(e,t,this.spatialReference):(0,_.w)(e,t,i,this.spatialReference)}fromRenderCoords(e,t,i=null){return kt(t)?((0,u.r)(i)&&(t.spatialReference=i),(0,_.M)(e,this.spatialReference,t)):t instanceof O.k?(0,_.d)(e,this.spatialReference,t):(0,_.w)(e,this.spatialReference,t,i)?t:null}static create(e,t){switch(e){case 2:return new TS(2,t,(0,x.G)(t),yo(Ut,dt([0,0,0],[_o,0,0],[0,_o,0])));case 1:return new TS(1,t,1,function(e){return yo(S.Z,(0,S.T)(0,0,0,(0,x.p)(e).radius))}(t))}}}const SS=(()=>{const e=new Array;return e[0]=10,e[1]=10,e[2]=10,e[3]=10,e[4]=5,e})(),PS=30;function RS(e){return"function"==typeof e.getUsedMemory}const AS=u.n.getLogger("esri.views.3d.support.MemoryController");class MS{constructor(e){this._view=e,this.events=new n.n,this.minQuality=.1,this._maxMemory=500,this._additionalCacheMemory=100,this._quality=1,this._stableQuality=0,this._downscaleMemoryUsed=0,this._canFastRecover=!1,this._memoryUsed=0,this._memoryPredicted=0,this._cacheStorage=new we.i,this._numQualityChanges=0,this._updating=!1}destroy(){this.events=null,this._cacheStorage.destroy()}getMemCache(e,t){return new we.s(e,this._cacheStorage,t)}set maxMemory(e){null!=e&&e>0&&(this._stableQuality=0,this._canFastRecover=!1,this._maxMemory<e&&this._updateQuality(1),this._maxMemory=e)}get maxMemory(){return this._maxMemory}set additionalCacheMemory(e){null!=e&&e>=0&&(this._additionalCacheMemory=e)}disableMemCache(){this._additionalCacheMemory=-4096}get memoryFactor(){return this._quality}get updating(){return this._updating}get usedMemory(){return this._memoryUsed}resetStableQuality(){this._stableQuality=0}update(){if(this._updateMemory(),this._memoryPredicted<=0&&!this._updating)return;let e=this._layersUpdating();if(this._memoryPredicted<.6&&this._canFastRecover)this._downscaleMemoryUsed=0,this._stableQuality=0,this._canFastRecover=!1,this._updateQuality(1);else if(e)(this._memoryPredicted>1.1||this._memoryUsed>1)&&(this._stableQuality>0?(this._downscaleMemoryUsed=0,this._updateQuality(this._stableQuality)):this._quality>this.minQuality&&this._downscaleMemoryUsed<this._memoryUsed&&(this._updateQuality(this._quality/1.3),this._downscaleMemoryUsed=this._memoryUsed,this._canFastRecover=!1));else if(this._downscaleMemoryUsed=0,this._memoryUsed>1)this._stableQuality=0,this._canFastRecover=!1,e=this._updateQuality(this._quality/1.3),this._downscaleMemoryUsed=this._memoryPredicted;else if(this._stableQuality!==this._quality)if(this._memoryUsed<.75&&this._quality<1){this._stableQuality=this._quality;const t=.05;e=this._updateQuality(this._quality+t)}else this._quality<1&&(this._canFastRecover=!0);this.updating!==e&&(this._updating=e,this.events.emit("updating-changed",this.updating))}_updateQuality(e){return(e=Math.min(Math.max(e,this.minQuality),1))!==this._quality&&(this._quality=e,this.events.emit("quality-changed",this._quality),++this._numQualityChanges,!0)}_layersUpdating(){return this._view.allLayerViews.some((e=>!!e.updating))}_updateMemory(){let e=0,t=0;this._view.basemapTerrain&&this._view.basemapTerrain.getUsedMemory&&(e+=this._view.basemapTerrain.getUsedMemory());const i=this._view._stage&&this._view._stage.renderView&&this._view._stage.renderView.edgeView;(0,u.r)(i)&&(e+=i.usedMemory),this._view.allLayerViews&&this._view.allLayerViews.forEach((i=>{if(RS(i)){const r=i.ignoresMemoryFactor()?this._quality:1;e+=i.getUsedMemory()*r,t+=i.getUnloadedMemory()*r}}));const r=null==this._warnMemoryUsage||Math.round(10*e)!==Math.round(10*this._warnMemoryUsage),s=1048576*this._maxMemory;if(e>s&&r){this._warnMemoryUsage=e;const i=e=>(e/1048576).toLocaleString(void 0,{maximumFractionDigits:1})+" MB",r=Math.round(100*this._quality);AS.warn(`Memory Limit exceeded! Limit: ${i(s)} Current: ${i(e)} Projected: ${i(e+t)} Quality: ${r}%`)}this._memoryUsed=e/s,this._memoryPredicted=(e+t)/s;const n=s-e;this._cacheStorage.maxSize=Math.max(0,n+1048576*this._additionalCacheMemory),this.events.emit("memory-used",this._memoryUsed)}get test(){const e=this;return{cacheStorage:this._cacheStorage,resetQualityChanges:()=>{const t=e._numQualityChanges;return e._numQualityChanges=0,t}}}}class OS{constructor(e){this.typeWorkerQuota=e,this.tasks=new Array,this.numWorkers=0,this.statistics=new DS}}class DS{constructor(){this.requests=0,this.size=0,this.duration=0,this.speed=0}}class ES{constructor(e,t,i,r){this._workerFunc=e,this._callbackFunc=t,this._maxTotalNumWorkers=i,this._totalNumWorkers=0,this._clients=r.map((e=>new OS(e)))}hasQuota(e){const t=this._clients[e];return!!t&&(this._totalNumWorkers<this._maxTotalNumWorkers||t.numWorkers+t.tasks.length<t.typeWorkerQuota)}push(e){const t=this._clients[e.client];t&&(this._totalNumWorkers<this._maxTotalNumWorkers?(t.numWorkers++,this._totalNumWorkers++,this._workerFunc(e,((e,t)=>this._taskCallback(e,t)))):t.tasks.push(e))}cancel(e){this._taskFinished(e),e._cancelled=!0}destroy(){this._clients.length=0}_taskFinished(e){const t=this._clients[e.client];this._totalNumWorkers--,t.numWorkers--,t.statistics.requests++,t.statistics.size+=e.size||0,t.statistics.duration+=e.duration||0,t.statistics.speed=t.statistics.duration>0?t.statistics.size/t.statistics.duration:0,(0,S.i)(t.numWorkers>=0),this._next()}_next(){for(const e of this._clients)if(e&&e.numWorkers<e.typeWorkerQuota&&this._processQueue(e))return;for(const e of this._clients)if(e&&this._processQueue(e))return}_processQueue(e){for(;e.tasks.length>0;)if(this._workerFunc(e.tasks.shift(),((e,t)=>this._taskCallback(e,t))))return e.numWorkers++,this._totalNumWorkers++,!0;return!1}_taskCallback(e,t){e._cancelled||(this._callbackFunc(e,t),this._taskFinished(e))}getStatsForType(e){const t=this._clients[e];return t?{quota:t.typeWorkerQuota,workers:t.numWorkers,queueSize:t.tasks.length,requestStats:t.statistics}:null}get test(){const e=this;return{set workerFunc(t){e._workerFunc=t}}}}class zS extends class{constructor(e){this.client=e,this._cancelled=!1,this.size=0,this.duration=0}}{constructor(e,t,i,r,s){super(r),this.url=e,this.options=t,this.docType=i,this.key=s,this.result=null,this.status=1,this.request=null,this.abortController=null,this.resolvers=new Array,this.startTime=0}}let IS=class extends r.p{constructor(){super(...arguments),this.tasks=new Map,this.onLoadQueue=new Array,this.doneQueue=new Array,this.updating=!1}setup(e,t,i){this.loadQueue=new ES(((e,t)=>this.startLoading(e,t)),((e,t)=>this.doneLoadingCallback(e,t)),e,t),i&&(this.taskHandle=i.registerTask(Jd.STREAM_DATA_LOADER,this))}destroy(){this.taskHandle=(0,u.a)(this.taskHandle),this.tasks.forEach((e=>{e.abortController&&e.abortController.abort()})),this.loadQueue.destroy(),this.loadQueue=null,this.onLoadQueue=null,this.doneQueue=null,this.tasks=null}hasDownloadSlots(e){return this.loadQueue.hasQuota(e)}request(e,t,i,r={}){const s=(0,h.D)();s.__signal=(0,u.r)(r)?r.signal:null;const n=this.createOrUpdateTask(e,t,i,r,s);return(0,h.v)(r,(()=>this.cancelRequest(n,s))),s.promise}createTask(e,t,i,r,s,n){const a=new zS(e,t,i,r,s);return this.updateTask(a,n),this.tasks.set(s,a),1===this.tasks.size&&this._set("updating",!0),this.loadQueue.push(a),a}cancelRequest(e,t){(0,r.v)(e.resolvers,t),t.reject((0,h.m)()),0===e.resolvers.length&&(2===e.status&&(e.status=4,this.loadQueue.cancel(e),e.abortController.abort(),e.request=null,e.abortController=null),e.status=4,this.tasks.delete(e.key),0===this.tasks.size&&this._set("updating",!1))}taskKey(e,t,i){return`${e}:${t}:${i}`}updateTask(e,t){e.resolvers.push(t)}createOrUpdateTask(e,t,i,r,s){const n=(0,u.r)(r)&&r.uid||e,a=this.taskKey(n,t,i),o=this.tasks.get(a);return o?(this.updateTask(o,s),o):this.createTask(e,r,t,i,a,s)}doneLoadingCallback(e,t){this.loadQueue&&((0,S.i)(2===e.status),e.status=3,this.taskHandle?this.doneQueue.push({task:e,err:t}):this.doneLoading(e,t))}get running(){return this.doneQueue.length>0||this.onLoadQueue.length>0}runTask(e){for(;!e.done&&this.onLoadQueue.length>0;){const t=this.onLoadQueue.shift();(0,h.a)(t.task.abortController),t.task.abortController=null,t.callback(t.task),e.madeProgress()}for(;!e.done&&this.doneQueue.length>0;){const t=this.doneQueue.shift();3!==t.task.status&&(t.err=t.err||(0,h.m)()),this.doneLoading(t.task,t.err),e.madeProgress()}}doneLoading(e,t){let i=e.result instanceof HTMLImageElement?0:e.resolvers.length;for(const r of e.resolvers)if(t)(0,h.g)(t)?r.reject(t):r.reject(new h.s("stream-data-loader:request-error",`Failed to request resource at '${e.url}'. ${t}`,{url:e.url,error:t}));else{--i;const t=i<=0?e.result:(0,u.y)(e.result);r.resolve(t)}this.tasks.delete(e.key),0===this.tasks.size&&this._set("updating",!1)}startLoading(e,t){if(4===e.status)return!1;let i,r;switch(e.startTime=performance.now(),e.status=2,e.docType){case"binary":r="array-buffer",i=0;break;case"image":r="image";break;case"image+type":r="array-buffer";break;default:r="json"}e.abortController=(0,h.h)();const s=e.abortController.signal;e.request=(0,n.L)(e.url,{...e.options,responseType:r,timeout:i,signal:s});let a=()=>{};const o=i=>{e.duration=performance.now()-e.startTime,e.size=i instanceof ArrayBuffer?i.byteLength:e.size||0,e.result=i,this.taskHandle?this.onLoadQueue.push({callback:t,task:e}):(e.abortController=null,t(e))},l=i=>{2===e.status&&t(e,i),a()};return"image+type"!==e.docType?(e.request.then((e=>o(e.data)),l),!0):(e.request.then((t=>{const c=t.data,h=function(e){if(e.byteLength<2)return"unknown";const t=new Uint8Array(e,0,e.byteLength);return 137===t[0]&&80===t[1]?"image/png":71===t[0]&&73===t[1]?"image/gif":66===t[0]&&77===t[1]?"image/bmp":255===t[0]&&216===t[1]?"image/jpeg":"unknown"}(c);if(r="image",e.size=c.byteLength,"unknown"===h)return e.request=(0,n.L)(e.url,{responseType:r,timeout:i,signal:s}),void e.request.then((e=>o(e.data)),l);const d=new Blob([c],{type:h}),u=window.URL.createObjectURL(d);a=()=>window.URL.revokeObjectURL(u),e.request=(0,n.L)(u,{responseType:r,timeout:i,signal:s}),e.request.then((e=>o(new LS(e.data,h,a))),l)}),l),!0)}get test(){return{loadQueue:this.loadQueue}}};(0,r.e)([(0,d.y)({readOnly:!0})],IS.prototype,"updating",void 0),IS=(0,r.e)([(0,d.n)("esri.views.3d.support.StreamDataLoader")],IS);class LS{constructor(e,t,i){this.image=e,this.type=t,this.release=i}get isOpaque(){return"image/jpeg"===this.type}}var FS=IS;let VS=class extends r.p{constructor(){super(...arguments),this.updating=!1}};var US;(0,r.e)([(0,d.y)({readOnly:!0})],VS.prototype,"updating",void 0),VS=(0,r.e)([(0,d.n)("esri.views.3d.support.ResourceController")],VS),function(e){let t=class extends VS{constructor(){super(...arguments),this._scheduler=null,this._memoryController=null,this._streamDataLoader=null,this._cameraChangeTime=0,this._handles=new R.u,this._frameTask=null,this._scheduleTask=hu}initialize(){this._cameraChangeTime=this.now(),this._scheduler=function(e){return new ou.Scheduler({nowFunc:e})}(this.now),this._memoryController=function(e){return new MS(e)}(this.view),this._streamDataLoader=new FS,this._streamDataLoader.setup(PS,SS,this._scheduler),this._handles.add([this.view.watch("state.camera",((e,t)=>this._cameraChangedHandler(e,t)),!0),this.view.watch("stationary",(()=>this._stationaryChangedHandler())),this._memoryController.events.on("updating-changed",(()=>this.notifyChange("updating")))]),this._frameTask=(0,r.A)({update:e=>this.frame(e)}),this._scheduleTask=this._scheduler.registerTask(Jd.RESOURCE_CONTROLLER)}destroy(){this._handles=(0,u.k)(this._handles),this._scheduleTask.remove(),this._frameTask=(0,u.a)(this._frameTask),this._streamDataLoader=(0,u.k)(this._streamDataLoader),this._memoryController=(0,u.k)(this._memoryController),this._scheduler=(0,u.k)(this._scheduler)}get updating(){var e,t;return!!(null!=(e=this._memoryController)&&e.updating||null!=(t=this._streamDataLoader)&&t.updating)}get scheduler(){return this._scheduler}get memoryController(){return this._memoryController}schedule(e,t,i){return this._scheduleTask.schedule(e,t,i)}createStreamDataRequester(e){const t=this._streamDataLoader;return{request:(i,r,s)=>t.request(i,r,e,s),get busy(){return!t.hasDownloadSlots(e)}}}frame(e){this.view.suspended||this.view.stateManager&&(this.view.stateManager.step((0,r.J)(e.deltaTime)),!this._scheduler)||(this._scheduler.state=this.state,this._scheduler.updateBudget(e)?(this._memoryController.update(),this._scheduler.frame()):this._memoryController.updating&&this._memoryController.update())}_cameraChangedHandler(e,t){e&&t&&e.almostEquals(t)||(this._cameraChangeTime=this._scheduler.now,this._scheduler.state=this.state)}_stationaryChangedHandler(){this.memoryController.resetStableQuality()}get state(){const e=this.view;return e.animation?0:e.interacting||this._scheduler.now-this._cameraChangeTime<=i?1:2}get test(){return{getQueueStats:e=>this._streamDataLoader.test.loadQueue.getStatsForType(e),state:this.state}}};(0,r.e)([(0,d.y)({constructOnly:!0})],t.prototype,"view",void 0),(0,r.e)([(0,d.y)({constructOnly:!0})],t.prototype,"now",void 0),(0,r.e)([(0,d.y)()],t.prototype,"_scheduler",void 0),(0,r.e)([(0,d.y)()],t.prototype,"_memoryController",void 0),(0,r.e)([(0,d.y)()],t.prototype,"_streamDataLoader",void 0),(0,r.e)([(0,d.y)({readOnly:!0})],t.prototype,"updating",null),t=(0,r.e)([(0,d.n)("esri.views.3d.support.ResourceController")],t),e.ResourceController=t;const i=300}(US||(US={}));const GS={bandCount:3,outMin:0,outMax:1,minCutOff:[0,0,0],maxCutOff:[255,255,255],factor:[1/255,1/255,1/255],useGamma:!1,gamma:[1,1,1],gammaCorrection:[1,1,1],colormap:null,colormapOffset:null,type:"stretch"};class BS{constructor(e,t,i=null,r=null){this._memoryUsed=null,this._source=null,this._symbolizerParameters=null,this._bandIds=null,this._interpolation=null,this._dirty=!1,this._transformGrid=null,this.isRendereredSource=!1,this.symbolizerRenderer=null,this.rawPixelData=null,this.lij=null,this.scale=1,this.offset=[0,0],this.opacity=1,this.lij=e,this.source=t,this.width=i||t.width,this.height=r||t.height}get source(){return this._source}set source(e){this._source=e,this._rasterTexture&&(this._rasterTexture.dispose(),this._rasterTexture=null,this._memoryUsed=null)}get symbolizerParameters(){return this.isRendereredSource?{...GS,maxCutOff:[1,1,1],factor:[1,1,1]}:this._symbolizerParameters||GS}set symbolizerParameters(e){this._symbolizerParameters=e}get bandIds(){return this._bandIds}set bandIds(e){(0,u.r)(e)&&e.length>0?this._bandIds&&e.every(((e,t)=>!!this._bandIds[t]&&e===this._bandIds[t]))||(this._bandIds=e,this._dirty=!0):this._bandIds=null}get interpolation(){return this._interpolation}set interpolation(e){this._interpolation=e,this._rasterTexture&&this._rasterTexture.setSamplingMode("bilinear"===e?9729:9728)}get transformGrid(){return this._transformGrid}set transformGrid(e){this._transformGrid=e,this._transformGridTexture&&(this._transformGridTexture.dispose(),this._transformGridTexture=null,this._memoryUsed=null)}bind(e){return!!(this.source&&this.source.pixels&&this.source.pixels.length>0)&&(this._rasterTexture&&!this._dirty||this._updateRasterTexture(e,this.bandIds),this._rasterTexture&&(this._updateColormapTexture(e),this.transformGrid&&!this._transformGridTexture&&(this._transformGridTexture=(0,_e.i)(e,this.transformGrid))),!0)}getUniforms(){const e=(0,_e.u)(this.scale,this.offset),{symbolizerParameters:t,transformGrid:i,width:r,height:s,opacity:n}=this;return{basic:e,common:(0,_e.o)(i,[r,s],[this.source.width,this.source.height],n),colormap:t.colormap?(0,_e.s)(t.colormap,t.colormapOffset):null,stretch:"stretch"===this.symbolizerParameters.type?(0,_e.l)(this.symbolizerParameters):null,hillshade:"hillshade"===this.symbolizerParameters.type?(0,_e.f)(this.symbolizerParameters):null}}getTextures(){const e=new Array,t=[];return this._rasterTexture&&(t.push(this._rasterTexture),e.push("u_image"),this._transformGridTexture&&(t.push(this._transformGridTexture),e.push("u_transformGrid")),this._colormapTexture&&(t.push(this._colormapTexture),e.push("u_colormap"))),{names:e,textures:t}}get memoryUsage(){if((0,u.t)(this._memoryUsed)){const e=this.getTextures();if(null==e)return 0;this._memoryUsed=e.textures.map((e=>e.descriptor.width*e.descriptor.height*4)).reduce(((e,t)=>e+t),0)}return this._memoryUsed}release(){return this._rasterTexture=(0,u.z)(this._rasterTexture),this._transformGridTexture=(0,u.z)(this._transformGridTexture),this._colormapTexture=(0,u.z)(this._colormapTexture),this.source=null,this.transformGrid=null,this.rawPixelData=null,!0}_updateRasterTexture(e,t){const i=this.source?this.source.extractBands(t):null;if(!(i&&i.pixels&&i.pixels.length>0))return void(this._rasterTexture&&(this._rasterTexture.dispose(),this._rasterTexture=null));const r=(0,u.t)(t)&&(0,u.t)(this.bandIds)||(0,u.r)(t)&&(0,u.r)(this.bandIds)&&t.join("")===this.bandIds.join("");if(this._rasterTexture){if(r)return;this._rasterTexture.dispose(),this._rasterTexture=null}this._rasterTexture=(0,_e.n)(e,i,this.interpolation||"nearest",this.isRendereredSource)}_updateColormapTexture(e){const t=this._colormap,i=this.symbolizerParameters.colormap;return i?t?i.length!==t.length||i.some(((e,i)=>e!==t[i]))?(this._colormapTexture&&(this._colormapTexture.dispose(),this._colormapTexture=null),this._colormapTexture=(0,_e.r)(e,i),void(this._colormap=i)):void 0:(this._colormapTexture=(0,_e.r)(e,i),void(this._colormap=i)):(this._colormapTexture&&(this._colormapTexture.dispose(),this._colormapTexture=null),void(this._colormap=null))}}const qS=(0,v.n)(),kS=(0,v.n)(),NS=(0,v.n)(),jS=(0,v.n)();function HS(e,t,i,r){(0,v.h)(qS,i),qS[r]=t[r];const s=(0,v.c)(qS,qS,t),n=(0,v.c)(kS,e,t),a=(0,v.z)(n,s),o=(0,v.z)(s,s);let l;l=a<=0?t:o<=a?i:(0,v.u)(qS,t,(0,v.d)(s,s,a/o));const c=(0,v.c)(qS,e,l);return Math.PI/2-Math.atan(c[2]/Math.sqrt(c[0]*c[0]+c[1]*c[1]))}var WS=Object.freeze({__proto__:null,isInsideExtent:function(e,t,i=0){const r=e.extent;if(0===i)return(0,b.g)(r,t);const s=Math.min(r[2]-r[0],r[3]-r[1]);return(0,b.j)(r,t,i*s)},tiltToExtentEdge:function(e,t,i){const r=e.extent;NS[0]=r[0],NS[1]=r[1],NS[2]=i,jS[0]=r[2],jS[1]=r[3],jS[2]=i;let s=1/0,n=1/0;return t[0]<NS[0]?s=HS(t,NS,jS,0):t[0]>jS[0]&&(s=HS(t,jS,NS,0)),t[1]<NS[1]?n=HS(t,NS,jS,1):t[1]>jS[1]&&(n=HS(t,jS,NS,1)),Math.min(s,n)},checkIfTileInfoSupportedForViewSR:function(e,t,i){if(e.spatialReference.isGeographic)return new h.s("tilingscheme:local-gcs-not-supported","Geographic coordinate systems are not supported in local scenes");return Wt.checkUnsupported(e)||function(e,t){const i=e.lods,r=i[0].resolution*2**i[0].level,s=[r*e.size[0],r*e.size[1]],n=[e.origin.x,e.origin.y],a=(0,b.a)(t),o=(0,b.i)();Wt.computeRowColExtent(a,s,n,o);const l=(o[2]-o[0])*(o[3]-o[1]);if(l>64){const t=i[0].scale*2**i[0].level;let s=Math.max((a[3]-a[1])/e.size[1],(a[2]-a[0])/e.size[0])*t/r;const n=Math.floor(Math.log(s)/Math.log(10));return s=Math.ceil(s/10**n)*10**n,new h.s("tilingscheme:too-many-root-tiles","Scale of level 0 of the tiling scheme (1:"+Math.floor(t).toLocaleString()+") is too large for the layer's extent. Suggested scale: 1:"+s.toLocaleString()+".",{level0Scale:t,suggestedLevel0Scale:s,requiredNumRootTiles:l,allowedNumRootTiles:64})}return null}(e,i)||(t&&!e.spatialReference.equals(t)?new h.s("tilingscheme:spatial-reference-mismatch","The tiling scheme does not match the spatial reference of the local scene"):null)}}),QS=Object.freeze({__proto__:null,isInsideExtent:function(){return!0},tiltToExtentEdge:function(){return 0},checkIfTileInfoSupportedForViewSR:function(e,t){const i=e.lods.length-1,r=e.spatialReference,s=(0,_.Z)(r)||(0,O.a)(r)||(0,O.P)(r);if(r.isWebMercator){if(!Wt.makeWebMercatorAuxiliarySphere(i).compatibleWith(e))return new h.s("tilingscheme:incompatible-global-web-mercator","The tiling scheme is not compatible with the ArcGIS Online Web Mercator tiling scheme")}else{if(!s)return new h.s("tilingscheme:global-unsupported-spatial-reference","The tiling scheme spatial reference is not supported in global scenes");if(!Wt.makeGCSWithTileSize(e.spatialReference,e.size[0],i).compatibleWith(e))return e.spatialReference.isWGS84?new h.s("tilingscheme:incompatible-global-wgs84","The tiling scheme is not compatible with the ArcGIS Online WGS84 tiling scheme"):new h.s("tilingscheme:incompatible-global","The tiling scheme is not compatible with the ArcGIS Online tiling scheme")}if(t&&!e.spatialReference.equals(t))return new h.s("tilingscheme:spatial-reference-mismatch","The tiling scheme does not match the spatial reference of the global scene")}});class ZS{constructor(e){this._texture=e,this._refCount=1}retain(){++this._refCount}release(){--this._refCount,0===this._refCount&&this._texture.dispose()}get texture(){return this._texture}generateMipmap(){this._texture.generateMipmap()}get descriptor(){return this._texture.descriptor}}const YS={1:QS,2:WS};function XS(e,t){e||console.warn("Terrain: "+t)}const $S=80/180*Math.PI,KS=110/180*Math.PI;function JS(e){return iP(e)?{fullExtent:e.fullExtent,minScale:e.layer.minScale,maxScale:e.layer.maxScale,tilemapCache:null}:e.layer}function eP(e){return"vector-tile"===(null==e?void 0:e.type)}function tP(e){return"imagery-tile"===(null==e?void 0:e.type)||"wcs"===(null==e?void 0:e.type)}function iP(e){return"imagery-tile-3d"===(null==e?void 0:e.type)}function rP(e){return"tile-3d"===(null==e?void 0:e.type)}function sP(e){return"vector-tile-3d"===(null==e?void 0:e.type)}function nP(e){return"elevation-3d"===(null==e?void 0:e.type)}function aP(e){return e&&(rP(e)||iP(e)||nP(e)||sP(e)||function(e){return"wmts-3d"===(null==e?void 0:e.type)}(e))}function oP(e){var t;return(null==e||null==(t=e.sourceLayerInfo)?void 0:t.data)instanceof BS}function lP(e){var t;return(null==e||null==(t=e.sourceLayerInfo)?void 0:t.data)instanceof Ce.d}function cP(e){return(0,u.r)(e)&&"release"in e&&e.release(),null}function hP(e){return e.fetchTile&&!1!==e.hasOverriddenFetchTile}function dP(e,t,i,r){return YS[r].checkIfTileInfoSupportedForViewSR(e,i,t)}function uP(e,t,i){let r,s;if("wmts"===e.type){const n=e.activeLayer;if(n){const e=n.tileMatrixSet;if(e)r=e.tileInfo,s=e.fullExtent;else{const e=n.tileMatrixSets;if(e){const r=e.find((e=>null==dP(e.tileInfo,e.fullExtent,t,i)));if(r)return{tileInfo:r.tileInfo,fullExtent:r.fullExtent}}}}}else s=tP(e)?e.getCompatibleFullExtent(t):e.fullExtent,r=eP(e)&&!pP.force512VTL?e.compatibleTileInfo256:tP(e)?e.getCompatibleTileInfo(t,s,2===i):e.tileInfo;return r&&s&&null==dP(r,s,t,i)?{tileInfo:r,fullExtent:s}:{tileInfo:null,fullExtent:null}}const pP={force512VTL:!1};class mP{constructor(e,t){if(this.layer=null,this.memory=0,this.displayedNumberOfFeatures=0,this.maximumNumberOfFeatures=null,this.totalNumberOfFeatures=null,this.layer=e.layer,this.memory=aP(e)?t.basemapTerrain.getUsedMemoryForLayerView(e):e.getUsedMemory(),function(e){return"performanceInfo"in e}(e)){const t=e.performanceInfo;this.displayedNumberOfFeatures=t.displayedNumberOfFeatures,this.maximumNumberOfFeatures=t.maximumNumberOfFeatures,this.totalNumberOfFeatures=t.totalNumberOfFeatures}}}class fP{constructor(e){this.totalMemory=0,this.usedMemory=0,this.quality=1,this.load=0,this.terrainMemory=0,this.edgesMemory=0,this.layerPerformanceInfos=new Array;const t=e.resourceController.memoryController;this.totalMemory=1048576*t.maxMemory,this.usedMemory=Math.round(t.usedMemory*this.totalMemory),this.quality=t.memoryFactor,this.load=e.resourceController.scheduler.load,this.terrainMemory=e.basemapTerrain?e.basemapTerrain.getUsedMemory():0;const i=e._stage&&e._stage.renderView&&e._stage.renderView.edgeView;this.edgesMemory=(0,u.r)(i)?i.usedMemory:0,e.allLayerViews.items.forEach((t=>{(RS(t)||aP(t))&&this.layerPerformanceInfos.push(new mP(t,e))})),this.layerPerformanceInfos.sort(((e,t)=>t.memory-e.memory))}}class gP{constructor(e,t,i,r){this._streamDataRequester=e,this._stage=t,this._textureOptions=i,this._textureRequests=new Map,this._frameTask=(0,u.r)(r)?r.registerTask(Jd.TEXTURE_UNLOAD):hu}destroy(){this._frameTask.remove(),this._textureRequests.forEach((e=>this.releaseTextureRequest(e))),this._textureRequests.clear()}async fromUrl(e,t,i){(0,h.a)(i);const r=(0,u.r)(i)&&i.signal,s=this.makeUid(e,t);let n=this._textureRequests.get(s);if(!n){const i=(0,h.h)(),r=this._streamDataRequester.request(e,"image",{uid:s,signal:i.signal});n={referenceCount:0,texture:null,textureAsync:null,abortController:i},this._textureRequests.set(s,n),n.textureAsync=r.then((i=>{const r=this.createTexture(e,i,t);return n.texture=r,n.abortController=null,this.addToStage(r),{uid:s,texture:r}}),(e=>{throw n.abortController=null,e}))}return n.referenceCount++,new Promise(((e,t)=>{(0,h.v)(r,(()=>{t((0,h.m)())})),n.textureAsync.then(e,t)})).catch((e=>{throw this.release(s),e}))}fromData(e,t){const i=this.makeUid(e);let r=this._textureRequests.get(i);return r||(r={referenceCount:0,texture:t(),textureAsync:null,abortController:null},this.addToStage(r.texture),this._textureRequests.set(i,r)),r.referenceCount++,{uid:i,texture:r.texture}}release(e){if(!this._textureRequests)return;const t=this._textureRequests.get(e);t?(t.referenceCount<1&&console.warn("TextureCollection: reference count is < 1 for "+e),t.referenceCount--,t.referenceCount<1&&this._frameTask.schedule((()=>this.releaseNow(e)))):console.warn(`TextureCollection: texture doesn't exist: '${e}'`)}get test(){return{textureRequests:this._textureRequests}}releaseNow(e){if(!this._textureRequests)return;const t=this._textureRequests.get(e);!t||t.referenceCount>0||(this.releaseTextureRequest(t),this._textureRequests.delete(e))}releaseTextureRequest(e){e.texture?this.removeFromStage(e.texture):e.abortController&&(e.abortController.abort(),e.abortController=null)}createTexture(e,t,i){const r={...this._textureOptions,powerOfTwoResizeMode:2};if((0,n.w)(e)){if(i||0===t.width&&0===t.height){const e=t.width?t.height/t.width:1;i=i||64,e>1?(t.width=Math.round(i/e),t.height=i):(t.width=i,t.height=Math.round(i*e))}this._stage.renderView&&(0,S.bb)(this._stage.renderView.renderingContext).svgAlwaysPremultipliesAlpha&&(r.preMultiplyAlpha=!1)}return r.width=t.width,r.height=t.height,new S.aT(t,r)}addToStage(e){this._stage.add(e)}removeFromStage(e){this._stage.remove(e)}makeUid(e,t){return null!=t?`${e}.${t}px`:e}}class vP{constructor(e){this.textures=null,this.streamDataRequester=null,this.graphicsOwners=[],this.screenSizePerspectiveHandles=null,this.cimSymbolRasterizer=null,this.viewState=e.viewState,this.view=e.view,this.pointsOfInterest=e.pointsOfInterest,this.objectResourceCache=e.objectResourceCache,this.streamDataRequester=e.resourceController.createStreamDataRequester(4),this.textures=new gP(this.streamDataRequester,e.view._stage,{preMultiplyAlpha:!0,wrap:{s:33071,t:33071}},e.resourceController.scheduler);const t=(0,x.p)(this.view.spatialReference).radius;this.screenSizePerspectiveSettings=(0,S.bc)(e.viewingMode,t),this.screenSizePerspectiveSettingsLabels=(0,S.bd)(e.viewingMode,t)}destroy(){this.textures.destroy(),this.textures=null,this.streamDataRequester=null}addGraphicsOwner(e){if(!e)return{remove(){}};this.graphicsOwners.push(e);const t="layer"in e?e.watch("layer.screenSizePerspectiveEnabled",(()=>this.updateScreenSizePerspectiveEnabled())):null;return this.updateScreenSizePerspectiveEnabled(),{remove:()=>{t&&(t.remove(),(0,r.v)(this.graphicsOwners,e),this.updateScreenSizePerspectiveEnabled())}}}updateScreenSizePerspectiveEnabled(){const e=this.graphicsOwners.some((e=>!0===e.get("layer.screenSizePerspectiveEnabled")));if(e&&!this.screenSizePerspectiveHandles){this.screenSizePerspectiveHandles=new R.u;const e=()=>this.updateScreenSizePerspectiveSettings();this.screenSizePerspectiveHandles.add([this.pointsOfInterest.centerOnSurfaceInfrequent.watch("distance",e,!0),this.viewState.events.on("camera-projection-changed",e)]),this.updateScreenSizePerspectiveSettings()}else!e&&this.screenSizePerspectiveHandles&&(this.screenSizePerspectiveHandles.destroy(),this.screenSizePerspectiveHandles=null)}updateScreenSizePerspectiveSettings(){const e=this.pointsOfInterest;yP.distance=e.centerOnSurfaceInfrequent.distance,yP.fovY=this.viewState.camera.fovY,this.screenSizePerspectiveSettings.update(yP),this.screenSizePerspectiveSettingsLabels.update(yP),this.view._stage.renderView.setNeedsRender()}}const yP={distance:0,fovY:0};class _P{constructor(e,t,i=""){this.graphics=e,this._symbol=new L.k({symbolLayers:[new L.u({material:{color:t},outline:{color:[255,255,255],size:1},resource:{primitive:"circle"}}),new L.v({text:i,halo:{color:"white",size:1/.75},material:{color:t},size:12})]})}showPoint(e,t){if((0,u.t)(t))return;this.remove();const i=new g.b({x:e[0],y:e[1],z:e[2],spatialReference:t});this._graphic=new a.h({geometry:i,symbol:this._symbol}),this.graphics.add(this._graphic)}remove(){(0,u.r)(this._graphic)&&(this.graphics.remove(this._graphic),this._graphic=null)}}let xP=class extends r.p{constructor(e){super(e),this.handles=new R.u}destroy(){this.handles.destroy()}};(0,r.e)([(0,d.y)({constructOnly:!0})],xP.prototype,"renderCoordsHelper",void 0),(0,r.e)([(0,d.y)({constructOnly:!0})],xP.prototype,"surface",void 0),(0,r.e)([(0,d.y)({constructOnly:!0})],xP.prototype,"state",void 0),xP=(0,r.e)([(0,d.n)("esri.views.3d.support.PointOfInterest")],xP);const bP=Array;let wP=class extends xP{constructor(e){super(e),this._dirty=!1,this._propertiesPool=new KC({location:g.b,renderLocation:bP},this),this._estimatedSurfaceAltitude=0,this._pendingElevationQueryController=null,this.cameraName="camera",this.renderLocation=(0,v.n)(),this.tmpPoint=new g.b}initialize(){if(this.scheduler&&this.handles.add(this.scheduler.registerTask(this.task,this)),this.runTask(),this.map){const e=()=>this._setDirty();this.handles.add((0,p.C)(this.map,"ground.layers","change",e,e,e))}this._updateRenderLocation()}destroy(){this._cancelPendingRequest(),this._propertiesPool.destroy(),this._propertiesPool=null}get _camera(){return this.state[this.cameraName]}get location(){const e=this._propertiesPool.get("location");return this.renderCoordsHelper.fromRenderCoords(this.renderLocation,e,this.state.spatialReference),e}get scale(){const e=this._camera,t=(0,v.q)(e.eye,this.renderLocation);return Pc({renderCoordsHelper:this.renderCoordsHelper,state:{camera:e}},t,0)}get updating(){return this._dirty||null!=this._pendingElevationQueryController}updateRenderLocation(){this._setDirty(),this._updateRenderLocation()}_setDirty(){this._dirty||(this._dirty=!0,this.notifyChange("updating"))}_cancelPendingRequest(){const e=this._pendingElevationQueryController;e&&(this._pendingElevationQueryController=null,e.abort(),this.notifyChange("updating"))}get running(){return!this._pendingElevationQueryController&&this._dirty}runTask(){if(this._cancelPendingRequest(),this._dirty=!1,this.notifyChange("updating"),!this.map||!this.map.ground)return void this._updateSurfaceAltitude(0);this.renderCoordsHelper.fromRenderCoords(this._camera.eye,this.tmpPoint,this.state.spatialReference);let e=(0,h.h)();this.map.ground.queryElevation(this.tmpPoint,{signal:e.signal,cache:this.cache}).then((e=>this._updateSurfaceAltitude(e.geometry.z))).catch((e=>{(0,h.g)(e)||this._updateSurfaceAltitude(0)})).catch((()=>{})).then((()=>{this._pendingElevationQueryController===e&&(this._pendingElevationQueryController=null,this.notifyChange("updating")),e=null})),this._pendingElevationQueryController=e}_updateSurfaceAltitude(e){this._estimatedSurfaceAltitude!==e&&(this._estimatedSurfaceAltitude=e,this._updateRenderLocation())}_updateRenderLocation(){this.renderCoordsHelper.setAltitude(CP,this._estimatedSurfaceAltitude,this._camera.eye),(0,v.F)(this._get("renderLocation"),CP)||this._set("renderLocation",(0,v.h)(this._propertiesPool.get("renderLocation"),CP))}};(0,r.e)([(0,d.y)({constructOnly:!0})],wP.prototype,"scheduler",void 0),(0,r.e)([(0,d.y)({constructOnly:!0})],wP.prototype,"cache",void 0),(0,r.e)([(0,d.y)({constructOnly:!0})],wP.prototype,"task",void 0),(0,r.e)([(0,d.y)({constructOnly:!0})],wP.prototype,"cameraName",void 0),(0,r.e)([(0,d.y)({readOnly:!0})],wP.prototype,"location",null),(0,r.e)([(0,d.y)({constructOnly:!0})],wP.prototype,"map",void 0),(0,r.e)([(0,d.y)({readOnly:!0})],wP.prototype,"renderLocation",void 0),(0,r.e)([(0,d.y)({readOnly:!0})],wP.prototype,"scale",null),(0,r.e)([(0,d.y)({readOnly:!0})],wP.prototype,"updating",null),wP=(0,r.e)([(0,d.n)("esri.views.3d.support.CameraOnSurface")],wP);const CP=(0,v.n)();var TP=wP;const SP=Array;let PP=class extends xP{constructor(e){super(e),this._propertiesPool=new KC({location:g.b,renderLocation:SP},this),this._currentSurfaceAltitude=0,this._latestSurfaceAltitude=0,this.distance=0,this.renderLocation=(0,v.n)(),this.updating=!1}initialize(){this._frameWorker=this.scheduler.registerTask(this.task,this),this.runTask()}destroy(){this._frameWorker&&(this._frameWorker.remove(),this._frameWorker=null),this._propertiesPool.destroy(),this._propertiesPool=null}get location(){const e=this._propertiesPool.get("location");return this.renderCoordsHelper.fromRenderCoords(this.renderLocation,e,this.state.spatialReference),e}updateRenderLocation(){this.updating=!0,this._updateRenderLocation()}get estimatedSurfaceAltitude(){return this._latestSurfaceAltitude}get running(){return this.updating}runTask(){this._latestSurfaceAltitude=this.estimateSurfaceAltitudeAtCenter(),this._updateRenderLocation(),this.updating=!1}_updateRenderLocation(){const e=AP;let t=this.calculateSurfaceIntersection(this._currentSurfaceAltitude,e);const i=this._currentSurfaceAltitude!==this._latestSurfaceAltitude;!t&&i&&(t=this.calculateSurfaceIntersection(this._latestSurfaceAltitude,e),t&&(this._currentSurfaceAltitude=this._latestSurfaceAltitude));const r=MP;if(t&&this.latestSurfaceAltitudeChangesDistanceSignificantly(e,r)&&((0,v.h)(e,r),this._currentSurfaceAltitude=this._latestSurfaceAltitude),t)this.distance=(0,v.q)(this.state.camera.eye,e);else{const t=this.state.camera;(0,v.d)(e,t.viewForward,this._get("distance")),(0,v.u)(e,e,t.eye)}(0,v.F)(this._get("renderLocation"),e)||this._set("renderLocation",(0,v.h)(this._propertiesPool.get("renderLocation"),e))}calculateSurfaceIntersection(e,t){const i=this.state.camera;if(!this.renderCoordsHelper.intersectManifold(i.ray,e,t))return!1;if(this.state.isGlobal){const r=(0,x.p)(this.renderCoordsHelper.spatialReference).radius,s=r+e,n=(0,v.m)(i.eye),a=n<s*s,o=(0,v.q)(i.eye,t);if(a&&o>r/4){const e=s-Math.sqrt(n);return(0,v.d)(t,i.viewForward,e),(0,v.u)(t,t,i.eye),!0}}else{const e=this.surface.ready&&this.surface.extent;e&&(t[0]=(0,v.o)(t[0],e[0],e[2]),t[1]=(0,v.o)(t[1],e[1],e[3]))}return!0}latestSurfaceAltitudeChangesDistanceSignificantly(e,t){if(this._latestSurfaceAltitude===this._currentSurfaceAltitude||null==e)return!1;if(this.calculateSurfaceIntersection(this._latestSurfaceAltitude,t)){if(Ih.TESTS_DISABLE_UPDATE_THRESHOLDS)return!0;const i=this.state.camera.eye,r=(0,v.q)(i,e),s=(0,v.q)(i,t);if(Math.abs(s-r)/r>RP)return!0}return!1}};(0,r.e)([(0,d.y)({constructOnly:!0})],PP.prototype,"scheduler",void 0),(0,r.e)([(0,d.y)({constructOnly:!0})],PP.prototype,"task",void 0),(0,r.e)([(0,d.y)()],PP.prototype,"distance",void 0),(0,r.e)([(0,d.y)({constructOnly:!0})],PP.prototype,"estimateSurfaceAltitudeAtCenter",void 0),(0,r.e)([(0,d.y)({readOnly:!0})],PP.prototype,"location",null),(0,r.e)([(0,d.y)({readOnly:!0})],PP.prototype,"renderLocation",void 0),(0,r.e)([(0,d.y)()],PP.prototype,"updating",void 0),PP=(0,r.e)([(0,d.n)("esri.views.3d.support.CenterOnSurface")],PP);const RP=.05,AP=(0,v.n)(),MP=(0,v.n)();var OP=PP;class DP{constructor(e){this.handles=new R.u,this.events=new n.n,this.contentLayerViews=e.contentLayerViews,this.handles.add(this.contentLayerViews.on("change",(e=>this.layerViewsChanged(e)))),this.layerViewsChanged({added:this.contentLayerViews.toArray(),removed:[],moved:[],target:this.contentLayerViews})}destroy(){this.handles&&(this.handles.destroy(),this.handles=null)}layerViewsChanged(e){e.added.forEach((e=>{"esri.views.3d.layers.SceneLayerView3D"===e.declaredClass&&this.handles.add(e.on("visible-geometry-changed",(()=>this.contentChanged())),e.uid)})),e.removed.forEach((e=>this.handles.remove(e.uid)))}contentChanged(){this.events.emit("request-update",EP)}}const EP={},zP=Array;let IP=class extends xP{constructor(e){super(e),this._propertiesPool=new KC({location:g.b,renderLocation:zP},this),this._dirty=!0,this.renderLocation=this._propertiesPool.get("renderLocation")}initialize(){this.handles.add([this.centerOnSurface.watch("renderLocation",(()=>this.updateRenderLocation())),this.state.watch("camera",(()=>this.updateRenderLocation()))]),this.scheduler&&this.handles.add(this.scheduler.registerTask(Jd.POINT_OF_INTEREST_FREQUENT,this))}destroy(){this._propertiesPool.destroy(),this._propertiesPool=null}get updating(){return this._dirty||this.centerOnSurface.updating}get location(){const e=this._propertiesPool.get("location");return this.renderCoordsHelper.fromRenderCoords(this.renderLocation,e,this.state.spatialReference),e}get running(){return this._dirty}runTask(){const e=this._get("renderLocation"),t=this.centerOnSurface.renderLocation,i=this.renderCoordsHelper,r=this.state.camera;this._dirty=!1,i.worldUpAtPosition(t,LP);const s=Math.max(0,(Math.acos((0,v.z)(LP,r.viewForward))-.5*Math.PI)*(r.aboveGround?1:-1));if(Number.isNaN(s)){if(!e||!(0,v.T)(e,t)){const e=this._propertiesPool.get("renderLocation");(0,v.h)(e,t),this._set("renderLocation",e)}return}const n=1-(0,v.o)(s/(.5*Math.PI),0,1),a=n*n*n;this._calculateScreenHorizontalEdgeOnSurface(VP);const o=this._propertiesPool.get("renderLocation");(0,v.y)(o,t,VP,a),e&&(0,v.T)(e,o)||this._set("renderLocation",o)}_calculateScreenHorizontalEdgeOnSurface(e){const t=this.state.camera,i=t.getRenderCenter((0,f.x)());if(i[1]=t.aboveGround?t.padding[2]:t.fullHeight-t.padding[0],this.estimateSurfaceIntersectionAtRenderPoint(i,e))return e;const r=this.renderCoordsHelper.getAltitude(this.centerOnSurface.renderLocation);if(t.unprojectFromRenderScreen(i,FP)){(0,v.c)(FP,FP,t.eye);const i=(0,v.j)(FP,FP);if(this.renderCoordsHelper.intersectManifold((0,S.g)(t.eye,i),r,e))return e}return this.renderCoordsHelper.setAltitude(e,r,t.eye)}updateRenderLocation(){this._dirty=!0}};(0,r.e)([(0,d.y)()],IP.prototype,"_dirty",void 0),(0,r.e)([(0,d.y)({constructOnly:!0})],IP.prototype,"scheduler",void 0),(0,r.e)([(0,d.y)({constructOnly:!0})],IP.prototype,"centerOnSurface",void 0),(0,r.e)([(0,d.y)({constructOnly:!0})],IP.prototype,"estimateSurfaceIntersectionAtRenderPoint",void 0),(0,r.e)([(0,d.y)({readOnly:!0})],IP.prototype,"updating",null),(0,r.e)([(0,d.y)({readOnly:!0})],IP.prototype,"location",null),(0,r.e)([(0,d.y)({readOnly:!0})],IP.prototype,"renderLocation",void 0),IP=(0,r.e)([(0,d.n)("esri.views.3d.support.CenterOnSurface")],IP);const LP=(0,v.n)(),FP=(0,v.n)(),VP=(0,v.n)();var UP=IP;let GP=class extends r.p{constructor(e){super(e),this.location=null,this._updateController=null,this._handles=new R.u}get renderLocation(){if(!this.location)return null;const e=(0,v.n)();return this.view.renderCoordsHelper.toRenderCoords(this.location,e),e}initialize(){this.view.state.isLocal&&(this._handles.add([this.watch(["surfaceView.spatialReference","surfaceView.extent"],(()=>this._update())),(0,p.C)(this,"surface.layers","change",(()=>this._update()))]),this._update())}destroy(){this._handles.destroy()}_update(){if(this._updateController&&(this._updateController.abort(),this._updateController=null),!this.surfaceView||!this.surfaceView.extent||!this.surfaceView.spatialReference)return void this._set("location",null);const e=(0,b.y)(this.surfaceView.extent),t=new g.b({x:e[0],y:e[1],z:0,spatialReference:this.surfaceView.spatialReference});this.surface&&this.surface.layers.length>0?(this._set("location",null),this._updateController=(0,h.h)(),this.surface.queryElevation(t,{noDataValue:0,signal:this._updateController.signal,cache:this.cache}).then((e=>{this._updateController=null,this._set("location",e.geometry)})).catch((e=>{(0,h.g)(e)||e&&"elevation-query:invalid-layer"===e.name||console.error("StableSurfaceCenter failed to update: ",e)}))):this._set("location",t)}};(0,r.e)([(0,d.y)({constructOnly:!0})],GP.prototype,"view",void 0),(0,r.e)([(0,d.y)({constructOnly:!0})],GP.prototype,"cache",void 0),(0,r.e)([(0,d.y)({readOnly:!0,aliasOf:"view.map.ground"})],GP.prototype,"surface",void 0),(0,r.e)([(0,d.y)({readOnly:!0,aliasOf:"view.basemapTerrain"})],GP.prototype,"surfaceView",void 0),(0,r.e)([(0,d.y)({readOnly:!0})],GP.prototype,"location",void 0),(0,r.e)([(0,d.y)({readOnly:!0})],GP.prototype,"renderLocation",null),GP=(0,r.e)([(0,d.n)("esri.views.3d.terrain.StableSurfaceCenter")],GP);let BP=class extends r.p{constructor(){super(...arguments),this.handles=new R.u,this._tileGeometryUpdateExtent=(0,b.B)(),this._tileGeometryUpdateSpatialReference=null,this.events=new n.n,this.updating=!1}initialize(){this.handles.add([this.surface.on("elevation-change",(e=>this._tileGeometryChanged(e))),this.scheduler.registerTask(Jd.SURFACE_GEOMETRY_UPDATES,this)])}destroy(){this.handles&&(this.handles.destroy(),this.handles=null)}get running(){return this.updating}runTask(){this.updating&&(this._centerIntersectsExtent(this._tileGeometryUpdateExtent,this._tileGeometryUpdateSpatialReference)&&this.events.emit("request-update",qP),(0,b.B)(this._tileGeometryUpdateExtent),this._set("updating",!1))}_tileGeometryChanged(e){this._tileGeometryUpdateSpatialReference=e.spatialReference,(0,b.c)(this._tileGeometryUpdateExtent,e.tile.extent),this._set("updating",!0)}_furthestCenterOnSurface(){let e=this.centerOnSurfaces[0];for(let t=1;t<this.centerOnSurfaces.length;t++){const i=this.centerOnSurfaces[t];i.distance>e.distance&&(e=i)}return e}_centerIntersectsExtent(e,t){const i=this.state.camera.eye,r=jP,s=this._furthestCenterOnSurface();return this.renderCoordsHelper.fromRenderCoords(i,kP,t),this.renderCoordsHelper.fromRenderCoords(s.renderLocation,NP,t),kP[0]<NP[0]?(r[0]=kP[0],r[2]=NP[0]):(r[0]=NP[0],r[2]=kP[0]),kP[1]<NP[1]?(r[1]=kP[1],r[3]=NP[1]):(r[1]=NP[1],r[3]=kP[1]),(0,b.F)(r,e)}};(0,r.e)([(0,d.y)({constructOnly:!0})],BP.prototype,"state",void 0),(0,r.e)([(0,d.y)({constructOnly:!0})],BP.prototype,"centerOnSurfaces",void 0),(0,r.e)([(0,d.y)({constructOnly:!0})],BP.prototype,"renderCoordsHelper",void 0),(0,r.e)([(0,d.y)({constructOnly:!0})],BP.prototype,"scheduler",void 0),(0,r.e)([(0,d.y)({constructOnly:!0})],BP.prototype,"surface",void 0),(0,r.e)([(0,d.y)({readOnly:!0})],BP.prototype,"updating",void 0),BP=(0,r.e)([(0,d.n)("esri.views.3d.support.SurfaceGeometryUpdates")],BP);const qP={},kP=(0,v.n)(),NP=(0,v.n)(),jP=(0,b.B)();var HP=BP;let WP=class extends r.p{constructor(e){super(e),this._handles=new R.u,this._tmpRay=(0,S.x)(),this._centerRayDirty=!0,this._surfaceAltitudeAtCenter=0,this._surfaceAltitudeAtCenterDirty=!0,this._contentAltitudeAtCenter=0,this._contentAltitudeAtCenterDirty=!0,this._propertiesPool=new KC({renderPointOfView:QP},this),this.renderPointOfView=(0,v.n)(),this._pois=new Array,this._debugCenters=new Map}initialize(){var e;const{state:t,basemapTerrain:i,renderCoordsHelper:r,map:s}=this.view;this._surfaceIntersector=new sn(t.viewingMode),t.isGlobal?this._surfaceIntersector.options.backfacesTerrain=!1:this._surfaceIntersector.options.backfacesTerrain=!0,this._surfaceIntersector.options.invisibleTerrain=!1,this._surfaceIntersector.options.store=0,this._contentIntersector=new sn(t.viewingMode);const n=()=>this._estimateSurfaceAltitudeAtCenter(),a=this.view.resourceController.scheduler,o=(0,u.f)(null==(e=this.view.basemapTerrain)?void 0:e.elevationQueryCache),l={state:t,scheduler:a,surface:i,renderCoordsHelper:r};this._set("centerOnSurfaceInfrequent",new OP({...l,task:Jd.POINT_OF_INTEREST_INFREQUENT,estimateSurfaceAltitudeAtCenter:n})),this._set("centerOnSurfaceFrequent",new OP({...l,task:Jd.POINT_OF_INTEREST_FREQUENT,estimateSurfaceAltitudeAtCenter:n})),this._set("centerOnContent",new OP({...l,task:Jd.POINT_OF_INTEREST_FREQUENT,estimateSurfaceAltitudeAtCenter:()=>this._estimateContentAltitudeAtCenter()})),this._set("cameraOnSurface",new TP({...l,cache:o,task:Jd.POINT_OF_INTEREST_INFREQUENT,map:s})),this._set("contentCameraOnSurface",new TP({...l,cache:o,task:Jd.POINT_OF_INTEREST_INFREQUENT,map:s,cameraName:"contentCamera"})),this._set("surfaceGeometryUpdates",new HP({...l,centerOnSurfaces:[this.centerOnSurfaceFrequent,this.centerOnContent,this.centerOnSurfaceInfrequent]})),this._set("contentGeometryUpdates",new DP({contentLayerViews:this.view.allLayerViews,renderCoordsHelper:r})),this._set("surfaceOrigin",new GP({cache:o,view:this.view})),this._set("focus",new UP({state:t,scheduler:a,surface:i,renderCoordsHelper:r,centerOnSurface:this.centerOnSurfaceFrequent,estimateSurfaceIntersectionAtRenderPoint:(e,t)=>this._estimateSurfaceIntersectionAtRenderPoint(e,t)})),this._pois.push(this.centerOnContent,this.centerOnSurfaceFrequent,this.centerOnSurfaceInfrequent,this.cameraOnSurface,this.contentCameraOnSurface,this.focus);const c=this.view.graphics;this._debugCenters.set(this.centerOnContent,new _P(c,"red","CenterOnContent")),this._debugCenters.set(this.centerOnSurfaceFrequent,new _P(c,"red","CenterOnSurface")),this._debugCenters.set(this.cameraOnSurface,new _P(c,"blue","CameraOnSurface")),this._debugCenters.set(this.contentCameraOnSurface,new _P(c,"blue","CameraOfInterestOnSurface")),this._debugCenters.set(this.focus,new _P(c,"green","Focus")),this._handles.add([t.watch("camera",(e=>this._cameraChanged(e)),!0),i.watch("extent",(()=>this._updateCenterPointsOfInterest())),(0,p.O)(i,"updating",(()=>this._updateCenterPointsOfInterest()),!0),this.surfaceGeometryUpdates.events.on("request-update",(()=>this._updateCenterPointsOfInterest())),this.contentGeometryUpdates.events.on("request-update",(()=>this._updateCenterOnContent())),(0,p.d)(Ih,"SHOW_POI",(e=>this._setDebug(e)))]),this._cameraChanged(this.view.state.camera);for(const e of this._pois)e.runTask()}destroy(){this._setDebug(!1),this._handles.destroy(),this._propertiesPool.destroy();for(const e of this._pois)e.destroy();this.surfaceOrigin.destroy()}get updating(){var e;return!!(null!=(e=this.surfaceGeometryUpdates)&&e.updating||this._pois.some((e=>e.updating)))}get centerRay(){return this._centerRayDirty&&(this._centerRay=this.view.sceneIntersectionHelper.getCenterRayWithSubpixelOffset(this.view.state.camera,this._tmpRay),this._centerRayDirty=!1),this._centerRay}_estimateContentAltitudeAtCenter(){if(!this._contentAltitudeAtCenterDirty)return this._contentAltitudeAtCenter;this._contentAltitudeAtCenterDirty=!1;const e=this.centerRay;return(0,u.t)(e)||(this.view.sceneIntersectionHelper.intersectRay(e,this._contentIntersector,ZP,XP)?this._contentAltitudeAtCenter=this.view.renderCoordsHelper.getAltitude(ZP):this._contentAltitudeAtCenter=this._estimateSurfaceAltitudeAtCenter()),this._contentAltitudeAtCenter}_estimateSurfaceAltitudeAtCenter(){if(!this.view.basemapTerrain)return 0;if(!this._surfaceAltitudeAtCenterDirty)return this._surfaceAltitudeAtCenter;this._surfaceAltitudeAtCenterDirty=!1;const e=this.centerRay;if((0,u.t)(e))return this._surfaceAltitudeAtCenter;const t=e.origin,i=(0,v.u)(ZP,e.origin,e.direction);return this._surfaceIntersector.resetWithRay(e),this._surfaceIntersector.camera=this.view.state.camera,this.view.basemapTerrain.intersect(this._surfaceIntersector,null,t,i),this._surfaceIntersector.results.min.getIntersectionPoint(ZP)&&(this._surfaceAltitudeAtCenter=this.view.renderCoordsHelper.getAltitude(ZP)),this._surfaceAltitudeAtCenter}_estimateSurfaceIntersectionAtRenderPoint(e,t){const i=Ao(this.view.state.camera,e,YP);if((0,u.t)(i))return null;const r=i.origin,s=(0,v.u)(ZP,i.origin,i.direction);return this._surfaceIntersector.resetWithRay(i),this._surfaceIntersector.camera=this.view.state.camera,this.view.basemapTerrain.intersect(this._surfaceIntersector,null,r,s),this._surfaceIntersector.results.min.getIntersectionPoint(t)?t:null}_cameraChanged(e){this._updateCenterPointsOfInterest();const t=e.eye;(0,v.F)(this.renderPointOfView,t)||this._set("renderPointOfView",(0,v.h)(this._propertiesPool.get("renderPointOfView"),t))}_updateCenterPointsOfInterest(){this._centerRayDirty=!0,this._surfaceAltitudeAtCenterDirty=!0,this._contentAltitudeAtCenterDirty=!0;for(const e of this._pois)e.updateRenderLocation()}_updateCenterOnContent(){this._contentAltitudeAtCenterDirty=!0,this.centerOnContent.updateRenderLocation()}_setDebug(e){if(!e)return this._debugCenters.forEach((e=>e.remove())),void this._handles.remove("debug");for(const e of this._pois)this._handles.add((0,p.d)(e,"renderLocation",(t=>this._debugCenters.get(e).showPoint(t,e.renderCoordsHelper.spatialReference))),"debug")}get test(){return{update:()=>{this.surfaceGeometryUpdates.runTask();for(const e of this._pois)e.runTask()},surfaceGeometryUpdates:this.surfaceGeometryUpdates}}};(0,r.e)([(0,d.y)({readOnly:!0})],WP.prototype,"centerOnContent",void 0),(0,r.e)([(0,d.y)({readOnly:!0})],WP.prototype,"centerOnSurfaceFrequent",void 0),(0,r.e)([(0,d.y)({readOnly:!0})],WP.prototype,"centerOnSurfaceInfrequent",void 0),(0,r.e)([(0,d.y)({readOnly:!0})],WP.prototype,"cameraOnSurface",void 0),(0,r.e)([(0,d.y)({readOnly:!0})],WP.prototype,"contentCameraOnSurface",void 0),(0,r.e)([(0,d.y)({readOnly:!0})],WP.prototype,"focus",void 0),(0,r.e)([(0,d.y)({readOnly:!0})],WP.prototype,"renderPointOfView",void 0),(0,r.e)([(0,d.y)({readOnly:!0})],WP.prototype,"surfaceOrigin",void 0),(0,r.e)([(0,d.y)({readOnly:!0})],WP.prototype,"contentGeometryUpdates",void 0),(0,r.e)([(0,d.y)({readOnly:!0})],WP.prototype,"surfaceGeometryUpdates",void 0),(0,r.e)([(0,d.y)({constructOnly:!0})],WP.prototype,"view",void 0),(0,r.e)([(0,d.y)({readOnly:!0})],WP.prototype,"updating",null),WP=(0,r.e)([(0,d.n)("esri.views.3d.support.PointsOfInterest")],WP);const QP=Array,ZP=(0,v.n)(),YP=(0,S.x)(),XP={exclude:new Set([S.be])};var $P=WP;class KP{constructor(e){this.store=e}destroy(){this.store.destroy()}get(e){return this.store.get(e)}put(e,t){this.store.put(e,t,t.values.byteLength+256)}}const JP=e=>{let t=class extends e{constructor(){super(...arguments),this.slicePlaneEnabled=!1,this.supportsHeightUnitConversion=!1}postscript(e){super.postscript(e),(0,s.X)(this.layer)&&this.addResolvingPromise(this._validateHeightModelInfo())}async _validateHeightModelInfo(){const e=(0,p.$)(this.view.defaultsFromMap,"isHeightModelInfoSearching");this.handles.add(e),await e;const t=(0,s.Y)(this.layer,this.view.heightModelInfo,this.supportsHeightUnitConversion);if(t)throw t}};return(0,r.e)([(0,d.y)()],t.prototype,"view",void 0),(0,r.e)([(0,d.y)()],t.prototype,"slicePlaneEnabled",void 0),t=(0,r.e)([(0,d.n)("esri.views.3d.layers.LayerView3D")],t),t},eR={value:.5,readOnly:!0},tR={readOnly:!0,value:.5,get(){return this.updating?this.updatingProgressValue:1}},iR=e=>{let t=class extends e{get imageFormatIsOpaque(){return!1}get isOpaque(){return this.fullOpacity>=1&&this.imageFormatIsOpaque}get dataLevelRange(){const e=this.tileInfo.lods,t=e[0].scale,i=e[e.length-1].scale;return this.levelRangeFromScaleRange(t,i)}get displayLevelRange(){const e=this.tileInfo.lods,t=this.layer.minScale||e[0].scale,i=this.layer.maxScale||e[e.length-1].scale,r=this.levelRangeFromScaleRange(t,i);return this.layer.maxScale&&r.maxLevel++,r}getTileUrl(e,t,i){return this.layer.getTileUrl(e,t,i)}_addTilingSchemeMatchPromise(){const e=this._getTileInfoSupportError(this.tileInfo,this.layer.fullExtent);if(e)this.addResolvingPromise(Promise.reject(e));else{const e=(0,p.x)(this.view,"basemapTerrain.tilingSchemeLocked").then((()=>{const e=this.view.basemapTerrain.tilingScheme,t=this._getTileInfoCompatibilityError(this.tileInfo,e);if(t)throw t}));this.addResolvingPromise(e)}}_getTileInfoSupportError(e,t){const i=dP(e,t,this.view.spatialReference,this.view.state.viewingMode);if(i){const e={layer:this.layer,error:i};let t;switch(i.name){case"tilingscheme:local-gcs-not-supported":t=new h.s("layerview:local-gcs-not-supported","Geographic coordinate systems are not supported in local scenes",e);break;case"tilingscheme:spatial-reference-mismatch":case"tilingscheme:global-unsupported-spatial-reference":t=new h.s("layerview:spatial-reference-incompatible","The spatial reference of this layer does not meet the requirements of the view",e);break;default:t=new h.s("layerview:tiling-scheme-unsupported","The tiling scheme of this layer is not supported by SceneView",e)}return t}return null}_getTileInfoCompatibilityError(e,t){return t.compatibleWith(e)?null:new h.s("layerview:tiling-scheme-incompatible","The tiling scheme of this layer is incompatible with the tiling scheme of the surface")}levelRangeFromScaleRange(e,t){const i={minLevel:0,maxLevel:1/0},r=this.view&&this.view.basemapTerrain&&this.view.basemapTerrain.tilingScheme;if(!r)return i;const s=r.levels[0],n=e=>{const t=Math.log(s.scale/e)/Math.LN2;return.5-Math.abs(.5-t%1)<1e-9?Math.round(t):Math.ceil(t)};return null!=e&&e>0&&(i.minLevel=Math.max(0,n(e))),null!=t&&t>0&&(i.maxLevel=Math.max(0,n(t))),i}isUpdating(){return!!(this.view&&this.view.basemapTerrain&&this.view.basemapTerrain.updating)}};return(0,r.e)([(0,d.y)({readOnly:!0})],t.prototype,"imageFormatIsOpaque",null),(0,r.e)([(0,d.y)({readOnly:!0})],t.prototype,"updating",void 0),(0,r.e)([(0,d.y)(tR)],t.prototype,"updatingProgress",void 0),(0,r.e)([(0,d.y)(eR)],t.prototype,"updatingProgressValue",void 0),(0,r.e)([(0,d.y)({readOnly:!0})],t.prototype,"fullExtent",void 0),(0,r.e)([(0,d.y)({readOnly:!0})],t.prototype,"isOpaque",null),(0,r.e)([(0,d.y)({readOnly:!0})],t.prototype,"dataLevelRange",null),(0,r.e)([(0,d.y)({readOnly:!0})],t.prototype,"displayLevelRange",null),(0,r.e)([(0,d.y)()],t.prototype,"layer",void 0),(0,r.e)([(0,d.y)({readOnly:!0})],t.prototype,"tileInfo",void 0),t=(0,r.e)([(0,d.n)("esri.views.3d.layers.TiledLayerView3D")],t),t};let rR=class extends(iR(JP(Re.d))){constructor(){super(...arguments),this.type="elevation-3d"}initialize(){const e=this.get("view.map.allLayers"),t=e&&e.includes(this.layer),i=this.get("view.map.ground.layers"),r=i&&i.includes(this.layer);if(t&&!r){const e=new h.s("layerview:elevation-layer-only","3D elevation layer '"+this.layer.id+"' can only be added in the map ground");this.addResolvingPromise(Promise.reject(e))}this._addTilingSchemeMatchPromise()}};(0,r.e)([(0,d.y)({readOnly:!0,aliasOf:"layer.fullExtent"})],rR.prototype,"fullExtent",void 0),(0,r.e)([(0,d.y)()],rR.prototype,"layer",void 0),(0,r.e)([(0,d.y)({readOnly:!0,aliasOf:"layer.tileInfo"})],rR.prototype,"tileInfo",void 0),rR=(0,r.e)([(0,d.n)("esri.views.3d.layers.ElevationLayerView3D")],rR);var sR=rR,nR=Object.freeze({__proto__:null,default:sR});class aR{constructor(e=0,t=0){this.min=e,this.max=t,this.level=0,this.hasNoDataValues=!1}copyFrom(e){this.min=e.min,this.max=e.max,this.level=e.level,this.hasNoDataValues=e.hasNoDataValues}}class oR{constructor(e,t,i){this.samplerData=null,this.level=e[0],this.i=e[1],this.j=e[2],this.extent=t;const r=i.noDataValue,s=i.values;let n=1/0,a=-1/0,o=!0,l=!1;for(let e=0;e<s.length;e++){const t=s[e];t!==r?(n=t<n?t:n,a=t>a?t:a,o=!1):l=!0}o&&(n=0,a=0),a=a>-3e38?a:0,this.samplerData={pixelData:i.values,width:i.width,height:i.height,noDataValue:r,safeWidth:.99999999*(i.width-1),dx:(i.width-1)/(t[2]-t[0]),dy:(i.width-1)/(t[3]-t[1]),x0:t[0],y1:t[3]},this.bounds=[n,a],this.hasNoDataValues=l}release(){this.samplerData=null,this.bounds=null}computeMinMaxValue(e,t,i,r){r.min=1/0,r.max=-1/0,r.hasNoDataValues=!1;const n=e-this.level;if(n<=0)return r;const a=2**n;if(Math.floor(t/a)!==this.i||Math.floor(i/a)!==this.j)return r;let o=1/0,l=-1/0;const c=this.samplerData.width,h=this.samplerData.pixelData,d=.5*Yt;let u=(c-1)/a,p=(i-this.j*a)*u,m=(t-this.i*a)*u;if(u<1){const e=Math.floor(p),t=Math.floor(m),i=e+t*c,n=h[i],a=h[i+1],o=h[i+c],l=h[i+c+1];if(n+a+o+l<d){const i=p-e,c=m-t,h=(0,s.$)(n,a,o,l,i,c),d=(0,s.$)(n,a,o,l,i+u,c),f=(0,s.$)(n,a,o,l,i,c+u),g=(0,s.$)(n,a,o,l,i+u,c+u);return r.min=Math.min(h,d,f,g),r.max=Math.max(h,d,f,g),r}p=e,m=t,u=1}else p=Math.floor(p),m=Math.floor(m),u=Math.ceil(u);for(let e=p;e<=p+u;e++)for(let t=m;t<=m+u;t++){const i=h[e+t*c];i<d?(o=Math.min(o,i),l=Math.max(l,i)):r.hasNoDataValues=!0}return r.min=o,r.max=l,r}static sample(e,t,i){for(const r of i){if(!r)continue;const i=r.safeWidth,s=r.width,n=r.pixelData;let a=(0,v.o)(r.dy*(r.y1-t),0,i),o=(0,v.o)(r.dx*(e-r.x0),0,i);const l=Math.floor(a),c=Math.floor(o),h=l*s+c,d=h+s,u=n[h],p=n[d],m=n[h+1],f=n[d+1];if(u+p+m+f<.5*Yt){a-=l,o-=c;const e=u+(m-u)*o;return e+(p+(f-p)*o-e)*a}}return null}}const lR=(0,r.w)(40),cR=(0,r.w)(50);function hR(){var e;const t=null==(e=u.e.require)?void 0:e.modules;if(t){const e=Object.keys(t);for(const i of e)-1!==i.search(".glsl")&&delete t[i]}}const dR=[[-.1,-2,3.9,2],[-.1,-3.9,3.9,.1],[-2,-3.9,2,.1],[-3.9,-3.9,.1,.1],[-3.9,-2,.1,2],[-3.9,-.1,.1,3.9],[-2,-.1,2,3.9],[-.1,-.1,3.9,3.9]];let uR,pR=class extends r.p{constructor(e){super(e),this._handles=new R.u,this._spatialReference=null,this._renderSR=null,this._overlaySREqualsRenderSR=!0,this._drapeSources=new Map,this._drapeTargets=new Set,this._renderedAltitude=0,this._displayOpacity=0,this._displayOpacityTime=-1,this._placementDirty=!1,this._drawTexturesDirty=!1,this._drawTexturesAnimateDirty=!1,this._layerViewsDirty=!0,this._hasUnusedRenderTargets=!1,this._longitudeCyclical=null,this._latestOriginId=0,this._maxResolution=(0,u.c)("esri-mobile")?2048:4096,this._animationTimeLast=0}get running(){return(this._placementDirty||this._layerViewsDirty)&&(this._drapeSources.size>0||this.view.graphics.length>0||Ih.OVERLAY_DRAW_DEBUG_TEXTURE)&&!!this._spatialReference&&!this.suspended&&this.surface.ready}get _isSpherical(){return this.view.state.isGlobal}get view(){return this.surface.view}get updating(){return this.running||this.renderer.updating}get hasHighlights(){return this.renderer.hasHighlights}get rendersOccluded(){return this.renderer.rendersOccluded}initialize(){const e=this.view,t=e.state.isGlobal&&(0,u.r)(this._spatialReference)?(0,x.G)(this._spatialReference):1;this.renderer=new ov({view:e,globalUnitScale:t,spatialReference:this._spatialReference}),this.renderer.onHasHighlightsChanged=()=>{this._setDrawTexturesDirty(),this.notifyChange("hasHighlights")},this.renderer.onRendersOccludedChanged=()=>{this._setDrawTexturesDirty(),this.notifyChange("rendersOccluded")},this.renderer.onContentChanged=()=>this._setDrawTexturesDirty(),this.renderer.onHasWaterChanged=t=>{var i;return null==(i=e._stage)?void 0:i.renderView.setRenderParameters({hasOverlayWater:t})},this.groundIntersector=new sn(this.view.state.viewingMode),this.groundIntersector.options.backfacesTerrain=!0,this.groundIntersector.options.invisibleTerrain=!0,this.groundIntersector.options.hud=!1,this._handles.add([e.watch(["pointsOfInterest.renderPointOfView","pointsOfInterest.centerOnSurfaceFrequent.location","pixelRatio"],(()=>this.setOverlayPlacementDirty())),this.surface.on("elevation-change",(()=>this.setOverlayPlacementDirty())),e.allLayerViews.on("after-changes",(()=>this._layerViewsDirty=!0)),e.on("resize",(()=>this.setOverlayPlacementDirty())),(0,r.A)({preRender:e=>{this.renderer.processSyncLayers(),this._updateLayerViews(),this.renderer.hasOverlays&&(this._dispatchRendererUpdate(e),this._drawOverlayTextures(this.renderer.overlays)),this._hasUnusedRenderTargets&&this._collectUnusedRenderTargetMemory()}}),e.resourceController.scheduler.registerTask(Jd.OVERLAY_MANAGER,this),e._stage.renderView.events.on("force-camera-for-screenshot",(e=>{this._updateOverlays(e),this.renderer.hasOverlays&&this._drawOverlayTextures(this.renderer.overlays)}))]),this._updateLayerViews()}destroy(){this._drapeSources.forEach(((e,t)=>this.unregisterDrapeSource(t))),this._drapeTargets.forEach((e=>this._unregisterDrapeTarget(e))),this.renderer.dispose(),this._handles&&(this._handles.destroy(),this._handles=null),(0,u.r)(uR)&&(uR.remove(),uR=null)}get hasOverlays(){return this.renderer.hasOverlays}setSpatialReference(e){this._spatialReference=e,this.renderer.spatialReference=e,this._longitudeCyclical=null;const t=this.view.renderSpatialReference;(0,u.r)(e)&&(0,u.r)(t)?(this._renderSR=t,this._overlaySREqualsRenderSR=e.equals(this._renderSR),this._isSpherical&&(this._longitudeCyclical=e.isWebMercator?new s.Q(-20037508.342787,20037508.342787):new s.Q(-180,180),this.renderer.longitudeCyclical=this._longitudeCyclical),this.renderer&&(this.renderer.globalUnitScale=this._isSpherical&&(0,u.r)(this._spatialReference)?(0,x.G)(this._spatialReference):1)):this.renderer.disposeOverlays()}getGpuMemoryUsage(){return this.renderer.gpuMemoryUsage}_updateLayerViews(){if(!this._layerViewsDirty)return;const e=new Set;for(const t of this.view.allLayerViews.items)e.add(t.uid),"drapeSourceType"in t&&!this._drapeSources.has(t)&&this._registerDrapeSource(t,0),"drapeTargetType"in t&&!this._drapeTargets.has(t)&&this._registerDrapeTarget(t);this._drapeSources.forEach(((t,i)=>{0!==t||e.has(i.uid)||this.unregisterDrapeSource(i)})),this._drapeTargets.forEach((t=>{e.has(t.uid)||this._unregisterDrapeTarget(t)})),this.renderer.updateLayerOrder(),this._setDrawTexturesDirty(),this._layerViewsDirty=!1}registerDrapeSource(e){this._registerDrapeSource(e,1)}_registerDrapeSource(e,t){this._drapeSources.set(e,t),this.renderer.ensureOverlays(this._drapeTargets,this._drapeSources),this.renderer.overlays.forEach((t=>{this._updateDrapeSource(e,t)})),this._setOverlayContentDirty(),this.notifyChange("running")}_updateDrapeSource(e,t){(0,u.r)(e.setDrapingExtent)&&(0,u.r)(this._spatialReference)&&e.setDrapingExtent(t,this._spatialReference)}unregisterDrapeSource(e){this._drapeSources.has(e)&&(this._drapeSources.delete(e),this.renderer.ensureDrapeSources(this._drapeSources),this._setOverlayContentDirty(),this.notifyChange("running"))}_registerDrapeTarget(e){this._drapeTargets.add(e),this._updateDrapeTarget(e),this.renderer.ensureOverlays(this._drapeTargets,this._drapeSources)}_updateDrapeTarget(e){this.renderer.overlays.forEach((t=>e.setDrapingTextures(t)))}_unregisterDrapeTarget(e){this._drapeTargets.delete(e),this.renderer.ensureDrapeTargets(this._drapeTargets)}_setOverlayContentDirty(){this.setOverlayPlacementDirty(),this._setDrawTexturesDirty()}setOverlayPlacementDirty(){this._placementDirty=!0}runTask(){this._updateOverlays(this.view.state.camera)}_updateOverlays(e){if(!this._spatialReference)return;this._updateLayerViews();const t=function(e,t,i){return Math.min((0,v.O)(Math.max(e,t)+256),i)}(e.fullWidth,e.fullHeight,this._maxResolution);this._computeOverlayExtents(e,t,gR);const i=(0,b.x)(gR.inner)/(0,b.x)(gR.outer);this.renderer.ensureOverlays(this._drapeTargets,this._drapeSources);const r=this._updateOverlay(0,gR.inner,t,1),s=this._updateOverlay(1,gR.outer,t,i);(r||s)&&(this.surface.updateTileOverlayParams(),this._setDrawTexturesDirty()),this._placementDirty=!1,this.surface.updateOverlayOpacity()}_updateOverlay(e,t,i,r){if(0===this.renderer.overlays.length)return!1;const s=this.renderer.overlays[e];if(!function(e,t){const i=Ih.TESTS_DISABLE_UPDATE_THRESHOLDS?0:1e-5*Math.max(e[2]-e[0],e[3]-e[1],t[2]-t[0],t[3]-t[1]);for(let r=0;r<4;r++)if(Math.abs(t[r]-e[r])>i)return!0;return!1}(t,s.extent)&&i===s.resolution&&s.pixelRatio===r)return!1;(0,b.A)(s.extent,t),s.resolution=i,s.pixelRatio=r;const n=(0,b.y)(s.extent);return s.renderLocalOrigin=xm(n[0],n[1],0,"OV_"+this._latestOriginId++),this._drapeSources.forEach(((e,t)=>this._updateDrapeSource(t,s))),!0}computeOpacity(e){if(!this.renderer.hasOverlays)return this._displayOpacity=0,this._displayOpacityTime=-1,1;if(3.5*e<this._renderedAltitude){const t=(e-this._renderedAltitude/10)/(this._renderedAltitude/3.5-this._renderedAltitude/10);this._displayOpacity=Math.sqrt((0,v.o)(t,0,1)),this._displayOpacityTime=performance.now()}else if(1!==this._displayOpacity){const e=performance.now();this._displayOpacityTime=this._displayOpacityTime>0?this._displayOpacityTime:e;const t=e-this._displayOpacityTime,i=this.surface.textureFadeDuration;if(t<i)return this._displayOpacity+(1-this._displayOpacity)*(t/i);this._displayOpacity=1,this._displayOpacityTime=-1}return this._displayOpacity}setTileParameters(e){const t=e.renderData.overlay;if(this.renderer.overlays.length>0){const i=this.renderer.overlays[0],r=this.renderer.overlays[1],s=(0,b.w)(e.extent,e.surface.extent,vR);this._rectInsideRect(s,i.extent)||this._rectanglesOverlap(s,i.extent)||this._rectanglesOverlap(s,r.extent)?(this._setTileOverlayData(s,0,t),this._setTileOverlayData(s,1,t)):(this._clearTileOverlayData(0,t),this._clearTileOverlayData(1,t))}else this._clearTileOverlayData(0,t),this._clearTileOverlayData(1,t)}overlayPixelSizeInMapUnits(e){if(0===this.renderer.overlays.length)return 0;const t=this.renderer.overlays[0],i=this.renderer.overlays[1],r=this._pointIsInExtent(e,t.extent)?t:i;return(r.extent[2]-r.extent[0])/r.resolution}_setTileOverlayData(e,t,i){if(0===this.renderer.overlays.length)return;const r=this.renderer.overlays[t].extent;i.setScale(t,(e[2]-e[0])/(r[2]-r[0]),(e[3]-e[1])/(r[3]-r[1]));let s=e[0];if(this._longitudeCyclical){s=this._longitudeCyclical.minimalMonotonic(r[0],s);const t=this._longitudeCyclical.minimalMonotonic(r[0],e[2]);s>t&&(s=t-(e[2]-e[0]))}i.setOffset(t,(s-r[0])/(r[2]-r[0]),(e[1]-r[1])/(r[3]-r[1]))}_clearTileOverlayData(e,t){t.setScale(e,-1,-1),t.setOffset(e,-1,-1)}async reloadShaders(){hR(),await this.renderer.reloadShaders(),this.runTask()}stopAnimationsAtTime(e){this.renderer.stopAnimationsAtTime(e),this._drawTexturesAnimateDirty=!0}_dispatchRendererUpdate(e){const t=(0,r.w)(e.time-this._animationTimeLast);t<cR||(this._animationTimeLast=e.time,this.renderer.updateLogic({dt:t,camera:this.view.state.camera})&&(this._drawTexturesAnimateDirty=!0))}_setDrawTexturesDirty(){this.renderer.hasOverlays?this._drawTexturesDirty=!0:this.setOverlayPlacementDirty()}_intersectGroundFromView(e,t,i,r){const s=this.view.sceneIntersectionHelper.getCenterRayWithSubpixelOffset(e,_R,t,i);if((0,u.t)(s))return!1;const n=s.origin,a=(0,v.u)(fR,s.origin,s.direction);return this.groundIntersector.reset(n,a),this.groundIntersector.intersect([],null,e),this.view.basemapTerrain.intersect(this.groundIntersector,null,n,a),this.groundIntersector.results.min.getIntersectionPoint(r)}_findHorizonBasedPointOfInterest(e,t){let i=.5;const r=.55,n=this.view.renderCoordsHelper.getAltitude(e.eye),a=this.view.pointsOfInterest.centerOnSurfaceFrequent,o=1e-5,l=(0,v.o)(a.estimatedSurfaceAltitude,e.aboveGround?-1/0:n+o,e.aboveGround?n-o:1/0),c=e.aboveGround;if("global"===this.view.viewingMode){const t=fR;(0,S.F)((0,S.E)((0,x.p)(this.view.spatialReference).radius+l),(0,S.g)(e.eye,e.viewForward),t),(0,v.c)(t,t,e.eye);const n=s.M.normalize((0,S.bf)(e.viewForward,t,e.viewRight))/e.fovY+.5,a=n<=0||n>=1?.5:r;i=c?a*n:n+a*(1-n)}else{const t=.5*Math.PI-Math.acos(-e.viewForward[2]),s=Math.tan(t),n=(0,w.a)(0,s,1,0),a=(0,j.y)(n,n,e.projectionMatrix)[1],o=(0,v.o)(.5+.5*a,0,1);i=1===o||0===o?.5:c?o*r:1-(1-o)*r}return!!this._intersectGroundFromView(e,.5,i,t)&&(0,v.X)(t,e.eye)<a.distance*a.distance}_computeOverlayExtents(e,t,i){const r=this.surface.extent,s=this.view.pointsOfInterest.centerOnSurfaceFrequent.renderLocation,n=(0,v.n)();this._findHorizonBasedPointOfInterest(e,n)||(0,v.h)(n,s),this._renderedAltitude=this.view.renderCoordsHelper.getAltitude(e.eye);const a=(0,v.q)(e.eye,n),o=vn(this.view.renderCoordsHelper,s,e.eye),l=Math.PI/2-Math.abs(o-Math.PI/2);Ih.OVERLAY_SHOW_CENTER?((0,u.t)(uR)&&(uR=new _P(this.view.graphics,"red")),uR.showPoint(n,this._renderSR)):(0,u.r)(uR)&&uR.remove(),this._overlaySREqualsRenderSR||(0,_.w)(n,this._renderSR,n,this._spatialReference);let c=t*e.perRenderPixelRatio*a/2,h=!1,d=1/0;this._isSpherical&&(0,u.r)(this._spatialReference)&&(this._spatialReference.isWebMercator?(c/=Math.cos((0,g.f)(n[1])),d=this.surface.extent[3]):(h=!0,c/=(0,x.p)(this._spatialReference).metersPerDegree,d=90),c>=d&&(c=d,n[1]=0,this._spatialReference.isWebMercator&&(n[0]=0)));let p=1;h&&(p=1/Math.max(.2,Math.cos(Math.abs((0,v.g)(n[1])))),c*p>180&&(p=180/c));const m=Math.log(2)/12;c=Math.exp(Math.round(Math.log(c)/m)*m);const f=c*p,y=.5*t/(32*f),w=.5*t/(32*c);n[0]=Math.round(n[0]*y)/y,n[1]=Math.round(n[1]*w)/w;const C=i.inner;C[0]=n[0]-f,C[1]=n[1]-c,C[2]=n[0]+f,C[3]=n[1]+c,this._isSpherical&&this._shiftExtentToFitBounds(C,1/0,d);const T=i.outer;if((0,b.A)(T,C),6*f>r[2]-r[0])(0,b.A)(T,r);else if(l<=.25*Math.PI)T[0]-=f,T[1]-=c,T[2]+=f,T[3]+=c;else{(0,_.w)(e.eye,this._renderSR,fR,this._spatialReference),(0,k.o)(mR,n,fR);let t=-Math.atan2(mR[1],mR[0])+.125*Math.PI;t<0&&(t+=2*Math.PI);const i=Math.floor(t/(.25*Math.PI));(0,j.l)(mR,dR[i],2*c),mR[0]*=p,mR[2]*=p,(0,j.s)(T,T,mR)}if(this._isSpherical&&(T[0]=this._longitudeCyclical.clamp(T[0]),T[2]=this._longitudeCyclical.clamp(T[2]),T[1]=Math.max(T[1],-d),T[3]=Math.min(T[3],d)),!this._isSpherical&&r){const e=(0,b.w)(C,r,vR),t=(0,b.w)(T,r,yR);(0,b.q)(e,t)&&(T[2]=T[0],T[3]=T[1])}}_drawOverlayTextures(e){if(0===e.length||!this._drawTexturesDirty&&!this._drawTexturesAnimateDirty)return;const t=this._drawOverlay(e[0]),i=this._drawOverlay(e[1]);0!==t&&0!==i||this.surface.updateTileOverlayParams(),this._collectUnusedRenderTargetMemory(),this._drapeTargets.forEach((e=>this._updateDrapeTarget(e))),this._drawTexturesAnimateDirty=!1,this._drawTexturesDirty?(this._drawTexturesDirty=!1,this.surface.requestRender(),this.surface.requestUpdate()):this.surface.requestRender(0)}_drawOverlay(e){return this._longitudeCyclical?e.setupGeometryViewsCyclical(this._longitudeCyclical):e.setupGeometryViewsDirect(),e.draw(this.renderer,this.view.state.camera.pixelRatio)}_collectUnusedRenderTargetMemory(){if(this._hasUnusedRenderTargets=!1,this.renderer.hasOverlays){const e=performance.now();this._hasUnusedRenderTargets=this.renderer.collectUnusedRenderTargetMemory(e)}}_rectanglesOverlap(e,t){return this._longitudeCyclical?(this._longitudeCyclical.contains(t[0],t[2],e[0])||this._longitudeCyclical.contains(t[0],t[2],e[2])||this._longitudeCyclical.contains(e[0],e[2],t[0]))&&!(e[1]>t[3]||e[3]<t[1]):(0,b.F)(e,t)}_rectInsideRect(e,t){return this._longitudeCyclical?this._longitudeCyclical.contains(t[0],t[2],e[0])&&this._longitudeCyclical.contains(t[0],t[2],e[2])&&e[1]>t[1]&&e[3]<t[3]:(0,b.q)(t,e)}_pointIsInExtent(e,t){if(this._longitudeCyclical)return this._longitudeCyclical.contains(t[0],t[2],e.x)&&e.y>=t[1]&&e.y<=t[3];const i=e.x,r=e.y;return i>t[0]&&i<t[2]&&r>t[1]&&r<t[3]}_shiftExtentToFitBounds(e,t,i){let r=0,s=0;e[0]<-t?r=e[0]+t:e[2]>t&&(r=t-e[2]),e[1]<-i?s=e[1]+i:e[3]>i&&(s=i-e[3]),(0,b.R)(e,r,s)}get test(){return{renderer:this.renderer,update:()=>this.runTask()}}};(0,r.e)([(0,d.y)()],pR.prototype,"_spatialReference",void 0),(0,r.e)([(0,d.y)({readOnly:!0})],pR.prototype,"running",null),(0,r.e)([(0,d.y)()],pR.prototype,"_placementDirty",void 0),(0,r.e)([(0,d.y)()],pR.prototype,"_layerViewsDirty",void 0),(0,r.e)([(0,d.y)()],pR.prototype,"renderer",void 0),(0,r.e)([(0,d.y)({constructOnly:!0})],pR.prototype,"surface",void 0),(0,r.e)([(0,d.y)({readOnly:!0,aliasOf:"surface.suspended"})],pR.prototype,"suspended",void 0),(0,r.e)([(0,d.y)({readOnly:!0})],pR.prototype,"updating",null),(0,r.e)([(0,d.y)({type:Boolean})],pR.prototype,"hasHighlights",null),(0,r.e)([(0,d.y)({type:Boolean})],pR.prototype,"rendersOccluded",null),pR=(0,r.e)([(0,d.n)("esri.views.3d.terrain.OverlayManager")],pR);const mR=(0,w.n)(),fR=(0,v.n)(),gR={inner:(0,b.i)(),outer:(0,b.i)()},vR=(0,b.i)(),yR=(0,b.i)(),_R=(0,S.x)();class xR{constructor(e,t){this._factoryCallback=e,this._lengthCallback=t,this._pool=new Map}acquire(e){if(!xR.test.disabled){const t=this._pool.get(e);if(t&&0!==t.length)return t.pop()}try{return this._factoryCallback(e)}catch(t){const i=window.performance&&window.performance.memory;let r="";throw i&&(r=`\n  totalJSHeapSize: ${i.totalJSHeapSize}, usedJSHeapSize: ${i.usedJSHeapSize}, jsHeapSizeLimit: ${i.jsHeapSizeLimit}`),console.log("Array allocation of size "+e+" failed: "+t+r),t}}release(e){if(xR.test.disabled)return;const t=this._lengthCallback(e);let i=this._pool.get(t);i||(i=new r.f({shrink:!0}),this._pool.set(t,i)),i.push(e)}clear(){this._pool.clear()}get test(){return{size:this._pool.size}}}xR.test={disabled:!1};const bR=(0,G.A)().vec3f("position").vec2f("uv0"),wR=new xR((e=>bR.createBuffer(e)),(e=>e.count));class CR{constructor(){this.indices=null,this.vertexAttributes=null,this.boundingBox=(0,se.B)(),this.numSurfaceIndices=0,this.numSkirtIndices=0,this.numWithoutSkirtIndices=0,this.numVertsPerRow=0,this.skirtLength=0,this.uvOffsetAndScale=(0,w.n)()}}class TR{constructor(e,t,i){this.values=e,this.numSurfaceIndices=t,this.numSkirtIndices=i}}const SR=new Map;function PR(e,t,i,r){const s=(2&i)>0,n=t+(r?1024:0)+(s?2048:0);let a=SR.get(n);a||(a=function(e,t,i){const r=e-1,s=e-1,n=e*e,a=2*r+2*s;let o=r*s*2*3,l=6*a,c=6*(2*r+s-1);i&&(o*=2,l*=2,c*=2);const h=n+a>65536?new Uint32Array(o+l):new Uint16Array(o+l);let d,u,p,m,f=0,g=0,v=o,y=0;for(let e=0;e<=s;e++){t&&(y=0===e?c:e===s?-c:0),v+=y;for(let t=0;t<=r;t++){const a=MR(t,e,r,s);if(a>-1){const o=OR(t,e,r,s);0!==o&&(d=f,u=n+a,p=n+(0===t&&1===e?0:a+1),m=f+o,i?(h[v+0]=d,h[v+1]=u,h[v+2]=u,h[v+3]=p,h[v+4]=p,h[v+5]=d,h[v+6]=p,h[v+7]=m,h[v+8]=m,h[v+9]=d,h[v+10]=d,h[v+11]=p,v+=12):(h[v+0]=d,h[v+1]=u,h[v+2]=p,h[v+3]=p,h[v+4]=m,h[v+5]=d,v+=6))}++f,t<r&&e<s&&(d=e*(r+1)+t,u=d+1,p=u+(r+1),m=p-1,i?(h[g+0]=d,h[g+1]=u,h[g+2]=u,h[g+3]=p,h[g+4]=p,h[g+5]=d,h[g+6]=p,h[g+7]=m,h[g+8]=m,h[g+9]=d,h[g+10]=d,h[g+11]=p,g+=12):(h[g+0]=d,h[g+1]=u,h[g+2]=p,h[g+3]=p,h[g+4]=m,h[g+5]=d,g+=6))}v-=y}return new TR(h,o,l)}(t,s,r),SR.set(n,a)),e.indices=a.values,e.numSurfaceIndices=a.numSurfaceIndices,e.numSkirtIndices=a.numSkirtIndices,e.numWithoutSkirtIndices=e.numSurfaceIndices+(i?6*(t-1)*(r?2:1):0)}function RR(e,t,i,r){e<r[0]&&(r[0]=e),e>r[3]&&(r[3]=e),t<r[1]&&(r[1]=t),t>r[4]&&(r[4]=t),i<r[2]&&(r[2]=i),i>r[5]&&(r[5]=i)}function AR(e,t){const i=t>e?1:0;return 2+4*i+(1-2*i)*(e+t)}function MR(e,t,i,r){return 0===t?e:e===i?i+t:t===r?i+r+(i-e):0===e&&t>0?2*i+r+(r-t):-1}function OR(e,t,i,r){return 0===t&&e!==i?1:e===i&&t!==r?i+1:t===r&&0!==e?-1:0===e&&0!==t?-(i+1):0}const DR=new Array(513),ER=new Array(513),zR=new Array(513),IR=new Array(513),LR=(0,v.n)(),FR=(0,v.n)();class VR{constructor(){this._queue=new r.f,this._last=null,this.remove=()=>{}}get done(){return 0===this._queue.length&&(!this._last||this._last.isLeaf)}resetOne(e){this._queue.clear(),this._queue.push(e),this._last=null}reset(e=null){this._queue.clear(),(0,u.r)(e)&&this._queue.pushArray(e),this._last=null}skipSubtree(){this._last=null}next(){return this._last&&!this._last.isLeaf&&this._queue.pushArray(this._last.children),this._last=this._queue.pop(),this._last}}class UR{constructor(){this.q=new r.f}get done(){return 0===this.q.length}reset(e){if(this.q.clear(),e){this.q.pushArray(e);for(let e=0;e<this.q.length;++e){const t=this.q.data[e];t.isLeaf||this.q.pushArray(t.children)}}}next(){return this.q.pop()}}function GR(e){return(0,u.r)(e)?e.lij.toString():"null"}function BR(e,t,i){if((0,u.t)(t))return!1;const r=t.fullExtent,s=e.extent;if(i){if(s[0]<r.xmin||s[1]<r.ymin||s[2]>r.xmax||s[3]>r.ymax)return!1}else if(r.xmin>s[2]||r.ymin>s[3]||r.xmax<s[0]||r.ymax<s[1])return!1;const n=e.surface.tilingScheme.levels[e.lij[0]].scale;return!(t.minScale>0&&n>1.00000001*t.minScale||t.maxScale>0&&n<.99999999*t.maxScale)}function qR(e,t){t.sort(((t,i)=>kR(t,i,e)))}function kR(e,t,i){const r=e.screenDepth,s=t.screenDepth;return r<s?-i:r>s?i:0}function NR(e,t){if(!e||!t||e[0]===t[0])return!1;const i=e[0]<t[0],r=i?e:t,s=i?t:e,n=1<<s[0]-r[0];return Math.floor(s[1]/n)===r[1]&&Math.floor(s[2]/n)===r[2]}class jR{get updating(){return!!this._tileRequested}init(e,t,i,r){this.tile=e,this._layerIdx=t,this._layerClass=i,this._suspended=r,this._tileLayerInfo=e.getLayerInfo(t,i),this._tileRequested=null;const s=this._findAncestorWithData();this._setUpsampleTile(s)}startLoading(){return this._requestNext()}dispose(){this._tileRequested&&(this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null),this.tile=null,this._tileLayerInfo=null}setSuspension(e){e!==this._suspended&&(this._suspended=e,e?this._tileRequested&&(this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null):this._tileLayerInfo.data||this.update())}update(){const e=this._findAncestorWithData();return this._setUpsampleTile(e),this._requestNext()}dataArrived(e){this._setUpsampleTile(e),this._tileRequested=null,e===this.tile?this.tile.updateRenderData(this._layerClass):this._requestNext()}dataMissing(){this._tileRequested=null,this._tileLayerInfo.data=null,this._requestNext()}_agentDone(){this.tile.agentDone(this._layerIdx,this._layerClass),this.dispose()}_requestNext(){if(this._suspended)return!0;const e=this._findNextDownload();if(this._tileRequested){if(e===this._tileRequested)return!0;this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null}return(0,u.r)(e)?e.requestLayerData(this._layerIdx,this._layerClass,this)&&(this._tileRequested=e):this._agentDone(),!!this._tileRequested}_findNextDownload(){const e=this._layerIdx,t=this._layerClass,i=this.tile.surface.layerViewByIndex(e,t),r=JS(i),{minLevel:s,maxLevel:n}=i.dataLevelRange,a=this._desiredMinLevelDelta,o=this._progressiveLevelModulo+a,l=this._scaleRangeEnabled?BR:()=>!0;let c=this.tile;const h=c.level;let d;const p=this._tileLayerInfo.upsampleInfo,m=p?p.tile.level:-1,f=(0,u.g)(r,"tilemapCache");for(;c&&l(c,r,!1)&&c.level>=s;){const i=c.level,r=h-i,l=c.layerInfo[t][e];if(l.data&&r>=a){i>m&&this._setUpsampleTile(c),l.dataInvalidated&&(d=c);break}if(((0,u.t)(f)||"unavailable"!==f.getAvailability(c.lij[0],c.lij[1],c.lij[2]))&&i<=n&&!l.data&&!l.dataMissing&&(((0,u.t)(d)||c.level===s||i%4==0||h-d.level<a)&&(d=c),r>=o))break;c=c.parent}return(0,u.r)(d)&&h-d.level<a&&this._tileLayerInfo.upsampleInfo&&(d=null),d}_findAncestorWithData(){const e=this.tile.vlevel,t=this._desiredMinLevelDelta;let i;for(let r=this.tile;r;r=r.parent)if(r.hasLayerData(this._layerIdx,this._layerClass)){if(e-r.level>=t)return r;i=r}return i}_setUpsampleTile(e){this._tileLayerInfo.setUpsampleInfo(this.tile,e),this.tile.updateRenderData(this._layerClass)}get test(){return{findNextDownload:()=>this._findNextDownload(),tileLayerInfo:this._tileLayerInfo}}}const HR=new Error("Abstract method called on TileAgent"),WR=new class extends jR{get _desiredMinLevelDelta(){throw HR}get _progressiveLevelModulo(){throw HR}dispose(){}};class QR extends jR{constructor(){super(...arguments),this._scaleRangeEnabled=!1}get _desiredMinLevelDelta(){return 4-(this.tile.vlevel-this.tile.level)}get _progressiveLevelModulo(){return 0}}class ZR extends jR{constructor(){super(),this._scaleRangeEnabled=!0}get _desiredMinLevelDelta(){return 0}get _progressiveLevelModulo(){return 4}}class YR{constructor(){this.waitingAgents=new r.f,this._upsampleInfo=null,this.loadingAgent=null,this.requestPromise=null,this.requestAbort=null,this.pendingUpdates=0}static acquire(e){const t=XR.acquire();return t._init(e),t}release(){this.dispose(),$R.delete(this),XR.release(this)}dispose(){this.loadingAgent=(0,u.z)(this.loadingAgent),this.abortRequest(),this._unsetUpsampleInfo(),this.pendingUpdates=0,this._data=cP(this._data)}static prune(){XR.prune(0)}_init(e){this.waitingAgents.clear(),this._data=cP(this._data),this.dataMissing=!1,this.dataInvalidated=!1,this._unsetUpsampleInfo(),this.abortRequest(),this.loadingAgent=null,this.pendingUpdates=0,this._pool=e,this.elevationBounds=null}invalidateSourceData(){this.dataInvalidated=!0,this.dataMissing=!1,this._unsetUpsampleInfo()}abortRequest(){this.requestAbort=(0,u.B)(this.requestAbort),this.requestPromise=null}get upsampleInfo(){return this._upsampleInfo}_unsetUpsampleInfo(){this._upsampleInfo&&(this._upsampleInfo.tile.unrefMapData(),this._pool.release(this._upsampleInfo),this._upsampleInfo=null)}setUpsampleInfo(e,t){if(e===t||(0,u.t)(t))this._unsetUpsampleInfo();else{if(null==this._upsampleInfo)this._upsampleInfo=this._pool.acquire();else{if(this._upsampleInfo.tile===t)return;this._upsampleInfo.tile.unrefMapData()}t.refMapData(),function(e,t,i){let r=1,s=0,n=0;for(;e!==t;)if(r*=.5,s*=.5,n*=.5,1&e.lij[2]&&(s+=.5),0==(1&e.lij[1])&&(n+=.5),null==(e=e.parent))throw new Error("tile was not a descendant of upsampleTile");i.init(t,s,n,r)}(e,t,this._upsampleInfo)}}get data(){return this._data}set data(e){cP(this._data),this._data=e}}const XR=new r.h(YR,null,(()=>{})),$R=new Map,KR=(0,v.n)(),JR=(0,v.n)(),eA=(0,v.n)(),tA=(0,w.n)();class iA{constructor(){this.fovX=0,this.fovY=0,this.relativeWidthLimit=0,this.relativeHeightLimit=0,this.maxLod=0,this.angledSplitBias=0,this.aboveGround=!0}}class rA{constructor(e){this._numSubdivisionAtLevel=e,this.lij=[0,0,0],this._children=[null,null,null,null],this._dirty=!0,this._previouslyRendered=!1,this.extent=(0,b.i)(),this._elevationBounds=(0,N.n)(),this.layerInfo=[[],[]],this.extentInRadians=(0,b.i)(),this.centerAtSeaLevel=(0,v.n)(),this._center=[(0,v.n)(),(0,S._)(),(0,v.n)()],this.up=(0,v.U)(),this._isWithinClippingArea=!0,this._intersectsClippingArea=!0,this._maxTesselation=0,this._usedMemory=cA,this._mapTileMemory=0,this._mapDataRefCount=0,this._screenDepth=0,this.renderOrder=0,this._edgeLen=0,this._edgeLen2=0,this._curvatureHeight=0}static prune(){aA.prune(0),oA.prune(0),YR.prune()}get usedMemory(){return this._usedMemory===cA&&this._updateMemoryUsed(),this._usedMemory+(this.isCached?0:this.mapTileMemory)}get cachedMemory(){return this.isCached?this.mapTileMemory:0}get mapTileMemory(){this._usedMemory===cA&&this._updateMemoryUsed();let e=this._mapTileMemory;for(const{data:t}of this.layerInfo[1])t instanceof Ce.d&&(e+=t.memoryUsage);return e}get isCached(){return!this.shouldLoad&&this._mapDataRefCount<=0}get maxTesselation(){return this._maxTesselation}get numSubdivisionsAtLevel(){return this._numSubdivisionAtLevel}get isWithinClippingArea(){return this._isWithinClippingArea}get intersectsClippingArea(){return this._intersectsClippingArea}get clippingArea(){return this._clippingArea}get parent(){return this._parent}get children(){return this._children}get surface(){return this._surface}get elevationBounds(){return this._elevationBounds}get level(){return this.lij[0]}get edgeLen(){return this._edgeLen}get radius(){return this._center[1][3]}get screenDepth(){return this._screenDepth}get visible(){if(this._dirty){this._dirty=!1;const e=this._isVisible(this.surface.frustum);e!==this._visible&&(this._visible=e,this._surface.emit("tiles-visibility-changed"),this._surface.renderer.setNeedsRender()),this.updateAgentSuspension()}return this._visible}get loadable(){return this.visible||this._surface.view.state.fixedContentCamera}get rendered(){const e=!!this.renderData;return e!==this._previouslyRendered&&(this._surface.emit("tiles-visibility-changed"),this._previouslyRendered=e,this._surface.renderer.setNeedsRender()),e}get shouldLoad(){if(!this.loadable)return!1;if(1===this._surface.lodSnapping){const e=this.level-this._surface.snapLevel;if(0===e)return!0;if(1===e)return!1}return this.isLeaf}init(e,t,i){this.lij[0]=e[0],this.lij[1]=e[1],this.lij[2]=e[2],this.ellipsoid=(0,x.p)(i.tilingScheme.spatialReference),i.tilingScheme.getExtent(e[0],e[1],e[2],this.extent),i.tilingScheme.convertExtentToRadians(this.extent,this.extentInRadians),this._isWithinClippingArea=!0,this._intersectsClippingArea=!0,this._clippingArea=null,this._mapDataRefCount=0,i.upsampleMapCache.pop(GR(this)),this._edgeLen=0,this._edgeLen2=0,this._center[1][3]=0,this.vlevel=e?e[0]:0,t&&t.elevationBounds?(0,k.a)(this._elevationBounds,t.elevationBounds):(0,k.r)(this._elevationBounds,0,0),this._pendingUpdates=0,this.renderData=null,this._screenDepth=0,this._visible=!1,this._previouslyRendered=!1,this._parent=t,this.unsetChildren(),this._surface=i,this.updateVisibility();for(const e of Zt){const t=i.numLayers(e),r=this.layerInfo[e];for(const e of r)e.release();r.length=t;for(let i=0;i<t;i++)r[i]=YR.acquire(this._surface.upsampleInfoPool),0===e&&this.findElevationBoundsForLayer(i,-1)}this.computeElevationBounds(),this._maxTesselation=Math.min(i.tilingScheme.pixelSize,512)}release(){XS(!this.renderData,"tile.renderData was not unloaded"),this._surface.upsampleMapCache.pop(GR(this));for(const e of Zt){for(const t of this.layerInfo[e])t.release();this.layerInfo[e].length=0}this._parent=null,this._surface=null,this._usedMemory=cA}refMapData(){++this._mapDataRefCount,this.isCached||this._surface.upsampleMapCache.pop(GR(this))}unrefMapData(){if(--this._mapDataRefCount,this.isCached){const e=this.cachedMemory;e>0&&(this._surface.upsampleMapCache.put(GR(this),this,e),this.setMemoryDirty())}}setMemoryDirty(){this._usedMemory=cA}get cpuImageMemorySize(){const e=this._surface.tilingScheme.pixelSize;return e*e*4}_updateMemoryUsed(){this._usedMemory=0,this._mapTileMemory=0;const e=this.cpuImageMemorySize;for(const{data:t}of this.layerInfo[1])t instanceof ZS?this._mapTileMemory+=(0,V.j)(t.texture):t instanceof HTMLImageElement||t instanceof LS?this._mapTileMemory+=e:t instanceof BS&&(this._mapTileMemory+=t.memoryUsage);for(const t of this.layerInfo[0])this._usedMemory+=t.data?e:0;this.renderData&&(this._usedMemory+=this.renderData.estimatedGeometryMemoryUsage,this._mapTileMemory+=(0,V.j)(this.renderData.textureDescriptor)),this.isCached&&this._surface.upsampleMapCache.updateSize(GR(this),this,this.cachedMemory)}getUsedMemoryForLayer(e,t){const i=this.layerInfo[e][t];if(!i||!i.data)return 0;if(1!==e||this.isCached){if(0===e)return this.cpuImageMemorySize}else{const e=i.data;if(e instanceof ZS)return(0,V.j)(e.texture);if(e instanceof HTMLImageElement||e instanceof LS)return this.cpuImageMemorySize;if(e instanceof Ce.d||e instanceof BS)return e.memoryUsage}return 0}updateScreenDepth(e){(0,v.h)(tA,this._center[1]),tA[3]=1,(0,j.y)(tA,tA,e),this._screenDepth=tA[2]<0?0:tA[2]/tA[3]}shouldSplit(e,t,i){if((0,u.r)(e.frustum)&&!this._isVisible(e.frustum))return 0;const r=this.level;(0,v.c)(KR,this._center[1],t);let s=(0,v.m)(KR),n=1;(0,v.c)(JR,this._center[0],t);const a=(0,v.m)(JR);a<s&&(s=a,n=0),(0,v.c)(JR,this._center[2],t);const o=(0,v.m)(JR);if(o<s&&(s=o,n=2),this._edgeLen2>s&&r<e.maxLod)return 2;const l=Math.sqrt(s),c=e.fovX*l*2,h=this._edgeLen/c,d=()=>{const t=r+Math.ceil(-(0,v.V)(e.relativeWidthLimit/h));return t!==this.vlevel?(this.vlevel=t,4):1};if(1===i&&1==this._surface.snapLevel-r)return r>=e.maxLod?d():2;const p=(0,v.z)(this.up,KR),m=this._elevationBounds[1]-this._elevationBounds[0],f=m/this.edgeLen;if(e.aboveGround&&p>0&&f<.001&&p/l-Math.sin(this._curvatureHeight/(this.edgeLen*Math.SQRT1_2)*Math.PI)-f>0)return 0;if(h<e.relativeWidthLimit)return this.vlevel!==this.level?(this.vlevel=this.level,4):0;if(r>=e.maxLod)return d();if(r>6){(0,v.c)(JR,this._center[n],t),(0,v.d)(eA,this.up,p),(0,v.c)(eA,eA,JR);const i=(0,v.m)(eA);if(i>this.radius*this.radius){(0,v.d)(eA,eA,this.radius/Math.sqrt(i)),(0,v.u)(eA,eA,this._center[n]),(0,v.c)(eA,t,eA);const r=Math.min(1,(Math.abs((0,v.z)(eA,this.up))+.5*m+this._curvatureHeight)/(0,v.s)(eA)),s=.1/e.angledSplitBias,a=e.fovY*l*2;if(r*(this._edgeLen/a)<s*e.relativeHeightLimit)return 0}}return 2}setChildren(e,t,i,r){XS(!!(e&&t&&i&&r),"Null child passed"),this._children[0]=e,this._children[1]=t,this._children[2]=i,this._children[3]=r}unsetChildren(){this._children[0]=null,this._children[1]=null,this._children[2]=null,this._children[3]=null}load(e){this.refMapData();for(const e of Zt)this._createOrUpdateAgents(0,e);e.loadTile(this)}unload(e){e.unloadTile(this);for(const e of Zt){const t=this.layerInfo[e];for(const e of t)e.loadingAgent&&e.loadingAgent!==WR&&(nA(e.loadingAgent),e.loadingAgent=null),e.pendingUpdates=0}this.resetPendingUpdate(32),this.resetPendingUpdate(64),this.unrefMapData()}unloadMapData(){const e=this.layerInfo[1];for(const t of e)t.loadingAgent&&t.loadingAgent!==WR&&(nA(t.loadingAgent),t.loadingAgent=null),t.pendingUpdates=0;this.renderData&&this.renderData.releaseTexture(),this.setMemoryDirty()}updateClippingStatus(e){if((0,b.G)(e,this._clippingArea))return!1;const t=this._intersectsClippingArea,i=this._isWithinClippingArea;(0,u.r)(e)?(this._intersectsClippingArea=this.intersectsExtent(e),this._isWithinClippingArea=this._isWithinExtent(e)):(this._intersectsClippingArea=!0,this._isWithinClippingArea=!0),this._clippingArea=e,this.updateVisibility();const r=i&&this._isWithinClippingArea,s=!(i||t||this._isWithinClippingArea||this._intersectsClippingArea);return!this.renderData||r||s||this.setPendingUpdate(32),!0}updateVisibility(){this._dirty=!0,this._surface.setTileTreeDirty()}getLayerInfo(e,t){return this.layerInfo[t][e]}hasLayerData(e,t){const i=this.layerInfo[t][e];return!(!i||!i.data||i.dataInvalidated)}get updating(){if(this.hasPendingUpdates)return!0;for(const e of Zt){const t=this.layerInfo[e];for(const e of t)if(e.loadingAgent&&e.loadingAgent!==WR&&e.loadingAgent.updating)return!0}return!1}isSuspended(e){return!!this.hasPendingUpdate(2)||0!==e&&!this.loadable}get hasPendingUpdates(){return 0!==this._pendingUpdates}hasPendingUpdate(e){return(this._pendingUpdates&e)===e}setPendingUpdate(e){this._pendingUpdates|=e,2===e||8===e?this._surface.setTileTreeDirty():this._surface.requestUpdate()}resetPendingUpdate(e){return!!this.hasPendingUpdate(e)&&(this._pendingUpdates&=~e,!0)}requestLayerData(e,t,i){const r=this.layerInfo[t][e];if(r.waitingAgents.has(i))return console.warn("agent already requested this piece of map data (tile %s, agent tile %s, layer: %d/%d)",this.lij.toString(),i.tile.lij.toString(),t,e),!0;if(r.waitingAgents.push(i),r.data&&!r.dataInvalidated)return console.warn("agent requested existing data (tile %s, agent tile %s, layer: %d/%d)",this.lij.toString(),i.tile.lij.toString(),t,e),i.dataArrived(this),!0;if(r.requestPromise)return!0;(0,u.B)(r.requestAbort),r.requestAbort=(0,h.h)();const s=this._surface.requestTileData(this,e,t,r.requestAbort);if(!s)return r.requestAbort=null,!1;const n=()=>{r.requestPromise===s&&(r.requestPromise=null,r.requestAbort=null)};return r.requestPromise=s,s.then(n,n),!0}get isLeaf(){return null==this._children[0]}hasLij(e){return this.lij[0]===e[0]&&this.lij[1]===e[1]&&this.lij[2]===e[2]}findByLij(e){return this.hasLij(e)?this:this.isLeaf?null:this._children[0].findByLij(e)||this._children[1].findByLij(e)||this._children[2].findByLij(e)||this._children[3].findByLij(e)||null}distanceToSquared(e){return(0,v.m)((0,v.c)(eA,this._center[1],e))}containsPoint(e){const t=this.extent;return e[0]>=t[0]&&e[1]>=t[1]&&e[0]<=t[2]&&e[1]<=t[3]}unrequestLayerData(e,t,i){const r=this.layerInfo[t][e],s=r.waitingAgents;XS(null!=s.removeUnordered(i),"agent has not requested this piece of map data"),s.length<1&&(r.abortRequest(),this._updateMemoryUsed())}dataArrived(e,t,i){const r=this.layerInfo[t][e];r.data=i,r.dataInvalidated=!1,r.waitingAgents.forAll((e=>e.dataArrived(this))),r.waitingAgents.clear(),this._updateMemoryUsed()}dataMissing(e,t,i){i.notInTilemap||console.error(`Tile ${this.lij.toString()} layer ${t}/${e} error ${i}`);const r=this.layerInfo[t][e];r.dataMissing=!0,r.waitingAgents.forAll((e=>e.dataMissing())),r.waitingAgents.clear(),this._updateMemoryUsed()}updateRenderData(e){switch(e){case 1:return this.updateTexture();case 0:return this.updateGeometry()}}updateTexture(){this.renderData&&this.setPendingUpdate(64)}updateGeometry(){this.setPendingUpdate(32);for(const e of this.layerInfo[0])e.pendingUpdates|=32}invalidateLayerData(e,t){this.layerInfo[t][e].invalidateSourceData(),this.restartAgents(t)}computeElevationBounds(){(0,k.r)(this._elevationBounds,Number.MAX_VALUE,-Number.MAX_VALUE);const e=this.layerInfo[0];let t=!0;for(const i of e)(0,u.r)(i.elevationBounds)&&(this._elevationBounds[0]=Math.min(this._elevationBounds[0],i.elevationBounds.min),this._elevationBounds[1]=Math.max(this._elevationBounds[1],i.elevationBounds.max),i.elevationBounds.hasNoDataValues||(t=!1));t&&(this._elevationBounds[0]=Math.min(this._elevationBounds[0],0),this._elevationBounds[1]=Math.max(this._elevationBounds[1],0)),this.updateRadiusAndCenter(),this._surface.setTileTreeDirty()}_updateCenter(){const e=.5*(this._elevationBounds[0]+this._elevationBounds[1]);(0,v.d)(eA,this.up,e),(0,v.u)(this._center[1],this.centerAtSeaLevel,eA),(0,v.d)(eA,this.up,this._elevationBounds[0]),(0,v.u)(this._center[0],this.centerAtSeaLevel,eA),(0,v.d)(eA,this.up,this._elevationBounds[1]),(0,v.u)(this._center[2],this.centerAtSeaLevel,eA)}findElevationBoundsForLayer(e,t){const i=this.layerInfo[0][e];if((0,u.r)(i.elevationBounds)&&i.elevationBounds.level>=t)return;if(!BR(this,JS(this._surface.layerViewByIndex(e,0)),!1))return;const r=lA;let s=!1;if(i.data){const e=i.data;r.min=e.bounds[0],r.max=e.bounds[1],r.hasNoDataValues=e.hasNoDataValues,r.level=this.lij[0],s=!0}else{let t,i,n=0;for(let r=this._parent;r&&(!i||n<4)&&(n=this.vlevel-r.level,t=i||t,i=r.layerInfo[0][e].data,!(!i&&t&&n>=4));r=r.parent);i=i||t,i&&(i.computeMinMaxValue(this.lij[0],this.lij[1],this.lij[2],r),r.min!==1/0&&(r.level=i.level,s=!0))}s&&((0,u.t)(i.elevationBounds)&&(i.elevationBounds=new aR),i.elevationBounds.copyFrom(r))}modifyLayers(e,t,i){const r=this.layerInfo[i];for(const e of r)e.loadingAgent&&e.loadingAgent!==WR&&(nA(e.loadingAgent),e.loadingAgent=null),e.waitingAgents.clear();for(let t=0;t<r.length;++t)void 0===e[t]&&r[t].release();const s=new Array(...r),n=t.length;r.length=n;for(let e=0;e<n;e++){const i=t[e];r[e]=i>-1?s[i]:YR.acquire(this._surface.upsampleInfoPool)}this._updateMemoryUsed()}restartAgents(e){this.renderData&&(this._createOrUpdateAgents(0,e),this.updateRenderData(e))}updateAgents(e){if(this.renderData){const t=this.layerInfo[e];for(const e of t)e.loadingAgent===WR&&(e.loadingAgent=null);this._createOrUpdateAgents(0,e)}}updateAgentSuspension(){for(const e of Zt){const t=this.isSuspended(e);for(const i of this.layerInfo[e])i.loadingAgent&&i.loadingAgent!==WR&&(i.loadingAgent.setSuspension(t),i.loadingAgent===WR&&this.updateRenderData(e))}}removeLayerAgent(e,t){const i=this.layerInfo[t][e];i.loadingAgent&&i.loadingAgent!==WR&&i.loadingAgent.dispose(),i.loadingAgent=null}agentDone(e,t){const i=this.layerInfo[t][e];i.loadingAgent=WR,i.data||i.upsampleInfo||this._createOrUpdateAgents(e+1,t)}_createOrUpdateAgents(e,t){const i=this.isSuspended(t),r=this.layerInfo[t];for(let s=e;s<r.length;++s){const e=r[s];let n=!1;const a=this._surface.layerViewByIndex(s,t),o=JS(a);if(e.loadingAgent?BR(this,o,!1)?(e.loadingAgent!==WR&&e.loadingAgent.setSuspension(i),e.loadingAgent!==WR&&(n=e.loadingAgent.update())):e.dispose():BR(this,o,!1)&&(e.loadingAgent=sA(this,s,t,i),n=e.loadingAgent.startLoading(),n?e.loadingAgent===WR&&this.setPendingUpdate(32):(nA(e.loadingAgent),e.loadingAgent=WR)),e.loadingAgent===WR&&this.updateRenderData(t),n&&a.isOpaque)return}}_isWithinExtent(e){const t=this.extent;return t[0]>=e[0]&&e[2]>=t[2]&&t[1]>=e[1]&&e[3]>=t[3]}intersectsExtent(e){const t=this.extent;return t[2]>=e[0]&&e[2]>=t[0]&&t[3]>=e[1]&&e[3]>=t[1]}get test(){return{cachedMemory:this.cachedMemory}}}function sA(e,t,i,r){const s=0===i?oA.acquire():aA.acquire();return s.init(e,t,i,r),s}function nA(e){e.dispose(),e instanceof QR?oA.release(e):e instanceof ZR&&aA.release(e)}const aA=new r.h(ZR),oA=new r.h(QR),lA=new aR,cA=-1;class hA extends rA{constructor(e,t,i){super(hA.NumSubdivisionsAtLevel),void 0!==e&&this.init(e,t,i)}init(e,t,i){super.init(e,t,i),this._edgeLen=this.extent[2]-this.extent[0],this._edgeLen2=this._edgeLen*this._edgeLen,this.centerAtSeaLevel[0]=(0,v.C)(this.extent[0],this.extent[2],.5),this.centerAtSeaLevel[1]=(0,v.C)(this.extent[1],this.extent[3],.5),this.centerAtSeaLevel[2]=0,this.updateRadiusAndCenter()}updateRadiusAndCenter(){this._updateCenter();const e=(this.extent[2]-this.extent[0])*Math.SQRT1_2,t=.5*(this.elevationBounds[0]-this.elevationBounds[1]);this._center[1][3]=Math.sqrt(e*e+t*t)}_isVisible(e){return this.intersectsClippingArea&&function(e,t){for(let i=0;i<6;i++)if(Je(e[i],t))return!1;return!0}(e,(0,se.v)(this.extent[0],this.extent[1],this.elevationBounds[0],this.extent[2],this.extent[3],this.elevationBounds[1]))}createGeometry(e,t){(function(e,t,i,r){const s=t[0],n=t[1],a=t[2]-s,o=t[3]-n,l=e.clippingArea,c=(0,u.r)(l)?Math.max(0,(l[0]-t[0])/a):0,h=(0,u.r)(l)?Math.max(0,(l[1]-t[1])/o):0,d=(0,u.r)(l)?Math.min(1,(l[2]-t[0])/a):1,p=(0,u.r)(l)?Math.min(1,(l[3]-t[1])/o):1,m=d>c?1/(d-c):1,f=p>h?1/(p-h):1,g=-c*m,v=-h*f,y=.1*a,_=e.numVertsPerRow-1,x=e.numVertsPerRow-1,b=e.numVertsPerRow*e.numVertsPerRow,w=2*_+2*x,C=wR.acquire(b+w),T=C.position.typedBuffer,S=C.uv0.typedBuffer,P=r.geometryInfo.boundingBox;(0,se.B)(P);let R=0;for(let t=0;t<=x;t++){const r=t/x;let c=v+r*f,h=n+r*o;(0,u.r)(l)&&(h<l[1]?(h=l[1],c=0):h>l[3]&&(h=l[3],c=1));for(let r=0;r<=_;r++){const n=r/_;let o=g+n*m,d=s+n*a;(0,u.r)(l)&&(d<l[0]?(d=l[0],o=0):d>l[2]&&(d=l[2],o=1));const p=e.samplerData&&oR.sample(d,h,e.samplerData)||0,f=d-i[0],v=h-i[1],x=p-i[2];RR(f,v,x,P);const w=5*R;T[w+0]=f,T[w+1]=v,T[w+2]=x,S[w+0]=o,S[w+1]=c;const C=MR(r,t,_,_);if(C>-1){const e=5*(b+C);T[e+0]=f,T[e+1]=v,T[e+2]=x,S[e+0]=AR(o,c),S[e+1]=y}++R}}r.geometryInfo.numVertsPerRow=e.numVertsPerRow,r.geometryInfo.vertexAttributes=C,r.geometryInfo.skirtLength=y,(0,j.r)(r.geometryInfo.uvOffsetAndScale,c,h,d-c,p-h),PR(r.geometryInfo,e.numVertsPerRow,0,e.wireframe)})(e,this.extent,t,this.renderData),this.setMemoryDirty()}}hA.NumSubdivisionsAtLevel=[2,2,2,2,2,2,2,2];class dA extends rA{constructor(e,t,i){super(uA),this.obb=new Array(8),this.isWebMercator=!1;for(let e=0;e<8;e++)this.obb[e]=(0,v.n)();void 0!==e&&this.init(e,t,i)}init(e,t,i){super.init(e,t,i),this.isWebMercator=i.tilingScheme.spatialReference.isWebMercator;const r=this.ellipsoid.radius,s=this.extentInRadians[0],n=this.extentInRadians[1],a=this.extentInRadians[2],o=this.extentInRadians[3],l=e[0],c=(0,v.C)(n,o,.5),h=(0,v.C)(s,a,.5),d=0===l?0:Math.min(Math.abs(n),Math.abs(o));this._edgeLen=(a-s)*Math.cos(d)*r,this._edgeLen2=this._edgeLen*this._edgeLen,this._curvatureHeight=r-Math.sqrt(r*r-this._edgeLen2/4),(0,_._)(this.centerAtSeaLevel,h,c,this.ellipsoid.radius,0);const u=(0,v.M)(this.centerAtSeaLevel);(0,v.j)(u,u),this.up=u,this._updateOBB(),this.updateRadiusAndCenter()}updateRadiusAndCenter(){if(0===this.lij[0])(0,v.a)(this._center[1],0,0,0),(0,v.a)(this._center[0],0,0,0),(0,v.a)(this._center[2],0,0,0),this.ellipsoid||(this.ellipsoid=(0,x.p)(this.surface.tilingScheme.spatialReference)),this._center[1][3]=this.ellipsoid.radius+this.elevationBounds[1];else{this._updateCenter();const e=Math.max((0,v.D)(this._center[1],this.obb[0]),(0,v.D)(this._center[1],this.obb[1]));this._center[1][3]=Math.sqrt(e)}}_isVisible(e){if(!this.intersectsClippingArea)return!1;if(this.lij[0]<10)return Ra(e,this._center[1]);const t=this.obb;for(let i=0;i<6;i++){let r,s=e[i];for(4===i&&(s=Ee(s,pA),pA[3]-=this.surface.view.state.camera.near),r=0;r<8&&!Ke(s,t[r]);r++);if(8===r)return!1}return!0}computeElevationBounds(){super.computeElevationBounds(),this._updateOBB()}createGeometry(e,t){const i=this._isPole(this.lij[1],this.lij[0]);(function(e,t,i,r,s,n,a,o){const l=s[0],c=s[1],h=s[2],d=s[3],u=.1*a.radius*(d-c),p=e.numVertsPerRow-1,m=e.numVertsPerRow-1,f=e.numVertsPerRow*e.numVertsPerRow,g=2*p+2*m,y=wR.acquire(f+g),_=y.position.typedBuffer,x=y.uv0.typedBuffer,b=r.geometryInfo.boundingBox;(0,se.B)(b);const w=t[2]-t[0],C=t[3]-t[1],T=h-l,S=i[0],P=i[1],R=i[2];for(let e=0;e<=p;e++){const i=e/p,r=l+i*T;DR[e]=Math.sin(r),ER[e]=Math.cos(r),zR[e]=i,IR[e]=t[0]+i*w}const A=n&&!!(1&o),M=n&&!!(2&o);let O=0;for(let i=0;i<=m;i++){let r=i/m;const s=(0,v.C)(c,d,r),o=Math.cos(s),l=Math.sin(s);let h;n?(h=a.halfSemiMajorAxis*Math.log((1+l)/(1-l)),r=(h-t[1])/C):h=180*s/Math.PI;for(let t=0;t<=p;t++){const s=zR[t],n=DR[t],c=ER[t];let d=a.radius;e.samplerData&&(d+=oR.sample(IR[t],h,e.samplerData)||0);const g=c*o*d-S,v=n*o*d-P,y=l*d-R;RR(g,v,y,b);const w=5*O;_[w+0]=g,_[w+1]=v,_[w+2]=y,x[w+0]=s,x[w+1]=r;const C=MR(t,i,p,m);if(C>-1){const e=5*(f+C),t=A&&0===i?-1:M&&i===m?1:0,n=0===t?g:-S,o=0===t?v:-P,l=0===t?y:a.radius*t-R;_[e+0]=n,_[e+1]=o,_[e+2]=l,x[e+0]=0===t?AR(s,r):s,x[e+1]=0===t?u:r,0!==t&&RR(n,o,l,b)}++O}}r.geometryInfo.numVertsPerRow=e.numVertsPerRow,r.geometryInfo.vertexAttributes=y,r.geometryInfo.skirtLength=u,(0,j.r)(r.geometryInfo.uvOffsetAndScale,0,0,1,1),PR(r.geometryInfo,e.numVertsPerRow,n?o:0,e.wireframe)})(e,this.extent,t,this.renderData,this.extentInRadians,this.isWebMercator,this.ellipsoid,i),this.setMemoryDirty()}_updateOBB(){const e=this.extentInRadians,t=this.obb;for(let i=0;i<2;i++){const r=this.elevationBounds[i];let s=4*i;(0,_._)(t[s++],e[0],e[1],this.ellipsoid.radius,r),(0,_._)(t[s++],e[0],e[3],this.ellipsoid.radius,r),(0,_._)(t[s++],e[2],e[3],this.ellipsoid.radius,r),(0,_._)(t[s++],e[2],e[1],this.ellipsoid.radius,r)}if(this.isWebMercator){const e=this._isPole(this.lij[1],this.lij[0]);2===e?((0,v.a)(t[1],0,0,this.ellipsoid.radius),(0,v.a)(t[2],0,0,this.ellipsoid.radius),(0,v.a)(t[5],0,0,this.ellipsoid.radius),(0,v.a)(t[6],0,0,this.ellipsoid.radius)):1===e&&((0,v.a)(t[0],0,0,-this.ellipsoid.radius),(0,v.a)(t[3],0,0,-this.ellipsoid.radius),(0,v.a)(t[4],0,0,-this.ellipsoid.radius),(0,v.a)(t[7],0,0,-this.ellipsoid.radius))}}_isPole(e,t){let i=0;return e===(1<<t)-1&&(i+=1),0===e&&(i+=2),i}}const uA=[128,64,32,16,16,8,8,4],pA=De();let mA=class extends r.p{constructor(e){super(e),this._handles=new R.u}initialize(){this._handles.add([this.layerViews.on("change",(()=>this.notifyChange("stencilEnabledExtents")))])}destroy(){this._handles.destroy(),this._handles=null}get layerViewsExtent(){return this._computeLayerViewsExtent()}get tiledLayersExtent(){return this._computeTiledLayersExtent()}get stencilEnabledExtents(){return this._computeStencilEnabledExtents()}set spatialReference(e){this.tilingScheme||this._set("spatialReference",e)}set tilingScheme(e){this._set("tilingScheme",e),this._set("spatialReference",e.spatialReference)}_computeStencilEnabledExtents(){const e=[];return this.layerViews.forEach((t=>{const i=t.layer;if("IntegratedMeshLayer"===i.operationalLayerType&&null!=this.spatialReference){const t=vA(i.fullExtent,this.spatialReference);null!=t&&e.push((0,b.a)(t))}})),e}};(0,r.e)([(0,d.y)({readOnly:!0,dependsOn:[]})],mA.prototype,"layerViewsExtent",null),(0,r.e)([(0,d.y)({readOnly:!0,dependsOn:["spatialReference","tilingScheme"]})],mA.prototype,"tiledLayersExtent",null),(0,r.e)([(0,d.y)({readOnly:!0,dependsOn:["spatialReference"]})],mA.prototype,"stencilEnabledExtents",null),(0,r.e)([(0,d.y)()],mA.prototype,"spatialReference",null),(0,r.e)([(0,d.y)()],mA.prototype,"tilingScheme",null),(0,r.e)([(0,d.y)()],mA.prototype,"defaultTiledLayersExtent",void 0),(0,r.e)([(0,d.y)({constructOnly:!0})],mA.prototype,"layers",void 0),(0,r.e)([(0,d.y)({constructOnly:!0})],mA.prototype,"layerViews",void 0),mA=(0,r.e)([(0,d.n)("esri.views.3d.terrain.SurfaceExtentHelperBase")],mA);let fA=class extends mA{_computeLayerViewsExtent(){return this._getGlobalExtent()}_computeTiledLayersExtent(){return this._getGlobalExtent()}_getGlobalExtent(){return this.spatialReference.isWebMercator?Xt:$t}};(0,r.e)([(0,d.y)({dependsOn:["spatialReference"]})],fA.prototype,"layerViewsExtent",void 0),fA=(0,r.e)([(0,d.n)("esri.views.3d.terrain.SurfaceExtentHelperGlobal")],fA);let gA=class extends mA{initialize(){this._handles.add([this.layers.on("change",(e=>this._handleLayersChanged(e))),this.layerViews.on("change",(()=>this.notifyChange("layerViewsExtent")))])}_handleLayersChanged(e){for(const t of e.removed)this._handles.remove(t.uid);for(const t of e.added)this._handles.add((0,p.d)(t,"loaded",(()=>this.notifyChange("tiledLayersExtent"))),t.uid)}_computeLayerViewsExtent(){const e=(0,b.B)(),t=this.spatialReference;this.layerViews.forEach((i=>{const r=i.layer;if(i.isResolved()&&("graphics"!==r.type||!r.internal)){const r=vA("fullExtentInLocalViewSpatialReference"in i&&i.fullExtentInLocalViewSpatialReference||i.layer.fullExtent,t);r&&(0,b.c)(e,r)}}));const i=(0,b.h)(e)?e:null,r=this._get("layerViewsExtent");return(0,b.G)(i,r)?r:i}_computeTiledLayersExtent(){const e=this.tilingScheme;if(!e)return null;const t=this.spatialReference,i=(0,b.B)();this.layers.forEach((function(r){if(r.loaded&&Gt(r)){const{tileInfo:s,fullExtent:n}=uP(r,t,2);(s&&tP(r)&&n||s&&e.compatibleWith(s)&&n&&n.spatialReference.equals(t))&&(0,b.c)(i,n)}})),this.defaultTiledLayersExtent&&(0,b.c)(i,this.defaultTiledLayersExtent);const r=(0,b.h)(i)?i:null,s=this._get("tiledLayersExtent");return(0,b.G)(r,s)?s:r}};function vA(e,t){return e&&!e.spatialReference.equals(t)&&(e=(0,g.x)(e.spatialReference,t)?(0,g.g)(e,t):null),e}gA=(0,r.e)([(0,d.n)("esri.views.3d.terrain.SurfaceExtentHelperLocal")],gA);let yA=class extends r.p{constructor(e){super(e),this._handles=new R.u}initialize(){this._handles.add(this.layers.on("change",(()=>this._update()))),this._handles.add(this.extentHelper.watch("layerViewsExtent",(()=>this._setAdHocTilingScheme()))),this._update(),this.tilingSchemeLocked||this._setAdHocTilingScheme()}destroy(){this._handles.destroy(),this._handles=null,this._waitTask=null}_update(){if(this._waitTask=null,this.tilingSchemeLocked)return;let e;if(this._set("tilingSchemeDone",!1),this.layers.some((t=>!(!Gt(t)||t.isRejected()||t.isFulfilled()&&!function(e,t,i){return!!uP(e,t,i).tileInfo}(t,this.viewSpatialReference,this.viewingMode)||(e=t,eP(t)||tP(t))))),e)if(e.isResolved()){const t=e,{tileInfo:i}=uP(t,this.viewSpatialReference,this.viewingMode),r=new Wt(i);this._set("tilingSchemeDone",!0),this._lockTilingScheme(r)}else this._updateWhen(e);else this._set("tilingSchemeDone",!0)}_updateWhen(e){const t=e.when().catch((e=>e)).then((()=>{t!==this._waitTask||this.destroyed||this._update()}));this._waitTask=t}_lockTilingScheme(e){if(1===this.viewingMode){const t=e.levels.length-1;e.spatialReference.isWebMercator?e=Wt.makeWebMercatorAuxiliarySphere(t):(0,_.Z)(e.spatialReference)&&(e=Wt.makeGCSWithTileSize(e.spatialReference,e.pixelSize,t))}this.tilingSchemeLocked=!0,this.tilingScheme=e,this.extentHelper.tilingScheme=this.tilingScheme,this._updateTiledLayerExtent(),this._handles.removeAll(),this._handles.add(this.extentHelper.watch("tiledLayersExtent",(()=>this._updateTiledLayerExtent())))}_updateTiledLayerExtent(){this.extent=this.extentHelper.tiledLayersExtent}_setAdHocTilingScheme(){if(1===this.viewingMode){const e=this.extentHelper.spatialReference,t=(0,_.Z)(e)||(0,O.a)(e)||(0,O.P)(e);e.isWebMercator?this.tilingScheme=Wt.WebMercatorAuxiliarySphere:t&&(this.tilingScheme=Wt.makeGCSWithTileSize(e,256)),this.extent=this.extentHelper.layerViewsExtent}else{const e=this.extentHelper.layerViewsExtent;e&&(this.tilingScheme=Wt.fromExtent(e,this.extentHelper.spatialReference),this.extent=e)}}};(0,r.e)([(0,d.y)()],yA.prototype,"tilingScheme",void 0),(0,r.e)([(0,d.y)()],yA.prototype,"extent",void 0),(0,r.e)([(0,d.y)({value:!1})],yA.prototype,"tilingSchemeLocked",void 0),(0,r.e)([(0,d.y)({readOnly:!0,value:!1})],yA.prototype,"tilingSchemeDone",void 0),(0,r.e)([(0,d.y)({constructOnly:!0})],yA.prototype,"viewSpatialReference",void 0),(0,r.e)([(0,d.y)({constructOnly:!0})],yA.prototype,"layers",void 0),(0,r.e)([(0,d.y)({constructOnly:!0})],yA.prototype,"extentHelper",void 0),(0,r.e)([(0,d.y)({constructOnly:!0})],yA.prototype,"viewingMode",void 0),yA=(0,r.e)([(0,d.n)("esri.views.3d.terrain.SurfaceTilingSchemeLogic")],yA);class _A{constructor(e){this._getFadeDuration=e,this._fadeStart=0,this._delayedTime=0}clear(){this._current=(0,u.k)(this._current),this._next=(0,u.k)(this._next),this._waiting=(0,u.k)(this._waiting),this._delayed=(0,u.k)(this._delayed)}get current(){if((0,u.t)(this._current))return null;if(!this._isFading){const e=this._delayed||this._waiting||this._next||this._current;e!==this._current&&(this._current=null,this.clear(),this._current=e)}let e=0;if((0,u.r)(this._delayed)&&(e=performance.now(),e>=this._delayedTime&&(this._push(this._delayed,0),this._delayed=null)),(0,u.r)(this._next)){e=e||performance.now();const t=this._fadeDuration;e-this._fadeStart>=t&&((0,u.k)(this._current),this._current=this._next,this._next=this._waiting,this._waiting=null,this._fadeStart=this._alignFadeStart(e))}return this._current}get next(){return this._next}get fadeFactor(){if((0,u.t)(this._next))return 1;const e=Math.max(0,performance.now()-this._fadeStart),t=this._fadeDuration;return e>t?0:1-e/t}get isFading(){return(0,u.r)(this._next)||(0,u.r)(this._delayed)}push(e,t,i,r,s=0){this._delayed=(0,u.k)(this._delayed);const n=(0,u.r)(e)?new xA(e,t,i,r):null;this._push(n,s)}_push(e,t){if(this._isFading||this.clear(),(0,u.t)(this._current))return void(this._current=e);const i=performance.now();return 0!==t?(this._delayed=e,void(this._delayedTime=i+t)):(0,u.t)(this._next)?(this._next=e,void(this._fadeStart=this._alignFadeStart(i))):void((0,u.t)(e)||((0,u.k)(this._waiting),this._waiting=e))}get _fadeDuration(){return(0,u.t)(this._waiting)?this._getFadeDuration():.5*this._getFadeDuration()}_alignFadeStart(e){const t=this._getFadeDuration();return e+t-e%t}get _isFading(){return this._getFadeDuration()>0}}class xA{constructor(e,t,i,r){this.texture=e,e.retain(),this.offsetAndScale=(0,w.a)(t,i,r,r)}destroy(){this.texture.release()}}class bA{constructor(){this._scales=[-1,-1,-1,-1],this._offsets=[-1,-1,-1,-1]}clear(){this._scales[0]=this._scales[1]=this._scales[2]=this._scales[3]=-1,this._offsets[0]=this._offsets[1]=this._offsets[2]=this._offsets[3]=-1}setScale(e,t,i){this._scales[2*e]=t,this._scales[2*e+1]=i}setOffset(e,t,i){this._offsets[2*e]=t,this._offsets[2*e+1]=i}get scales(){return this._scales}get offsets(){return this._offsets}}class wA{constructor(){this.geometryInfo=new CR,this._textureRef=new _A((()=>this.tile.surface.textureFadeDuration)),this.overlay=new bA}init(e){this.tile=e,this.clear();const t=this.geometryInfo;t.indices=null,t.vertexAttributes=null,(0,se.B)(t.boundingBox),t.numSurfaceIndices=0,t.numSkirtIndices=0,t.numWithoutSkirtIndices=0,t.numVertsPerRow=0,this.geometryState={numVertsPerRow:0,samplerData:null,clippingArea:null,wireframe:!1},this.opacity=1,this.localOrigin=null,this.overlay.clear()}clear(){this.releaseGeometry(),this.releaseTexture(),this._textureRef.clear()}updateGeometry(e,t){return!!this._updateGeometryState(t)&&(this._releaseGeometry(),this._createGeometry(e),!0)}releaseGeometry(){return!!this._releaseGeometry()&&(this.geometryState={numVertsPerRow:0,samplerData:null,clippingArea:null,wireframe:!1},!0)}ensureTexture(e,t){return(0,u.r)(this._texture)&&this._texture.descriptor.width!==e&&this.releaseTexture(),(0,u.t)(this._texture)&&(this._texture=t(),this.tile.setMemoryDirty()),this._texture}releaseTexture(){(0,u.r)(this._texture)&&(this._texture.release(),this._texture=null,this.tile.setMemoryDirty())}_updateGeometryState(e){const t=this._getElevationInfo(),i=this.tile.level;let s=i<8?this.tile.numSubdivisionsAtLevel[i]+1:2;if(t.samplerData){const e=this.tile.vlevel-i,r=Math.max(i-t.maxTileLevel,4-e),n=this.tile.maxTesselation;s=(0,v.o)(1+(n>>r),2,n+1)}let n=this.tile.clippingArea;this.tile.intersectsClippingArea&&!this.tile.isWithinClippingArea||(n=null);const a=this.geometryState;let o=!1;return a.numVertsPerRow!==s&&(a.numVertsPerRow=s,o=!0),t.changed&&(a.samplerData=t.samplerData,o=!0),(0,r.K)(a.clippingArea,n)||(a.clippingArea=n,o=!0),a.wireframe!==e&&(a.wireframe=e,o=!0),o}_createGeometry(e){this.tile.createGeometry(this.geometryState,this.localOrigin);const t=this.geometryInfo.vertexAttributes,i=this.geometryInfo.indices,r=e.gl;this._vao=new V.f(e,S.o,{geometry:(0,U.t)(t.layout)},{geometry:V.h.createVertex(e,r.STATIC_DRAW,t.buffer)},V.h.createIndex(e,r.STATIC_DRAW,i))}_releaseGeometry(){return!!this._vao&&(this._vao.dispose(),this._vao=null,function(e){wR.release(e.vertexAttributes),e.vertexAttributes=null,e.indices=null}(this.geometryInfo),!0)}get vao(){return this._vao}setTextureReference(e,t,i,r,s=0){e!==this._texture&&this.releaseTexture(),this._textureRef.push(e,t,i,r,s)}get textureReference(){return this._textureRef.current}get nextTextureReference(){return this._textureRef.next}get textureFadeFactor(){return this._textureRef.fadeFactor}get textureIsFading(){return this._textureRef.isFading}_getElevationInfo(){const e=this.geometryState.samplerData,t=this.tile.layerInfo[0],i=t.length;let r=new Array(i),s=0,n=0,a=!1;for(let o=0;o<i;o++){const i=t[o];if(i.upsampleInfo){const t=i.upsampleInfo.tile,l=t.layerInfo[0][o].data,c=l&&l.samplerData;e&&e[s]===c||(a=!0),r[s++]=c,n=Math.max(n,t.lij[0])}else if(i.data){const t=this.tile.surface.layerViewByIndex(o,0);if(BR(this.tile,t.layer,!1)){const t=i.data;e&&e[s]===t.samplerData||(a=!0),r[s++]=t.samplerData,n=this.tile.lij[0]}}}return e&&e.length!==s&&(a=!0),s>0?r.length=s:r=null,{changed:a,samplerData:r,maxTileLevel:n}}get estimatedGeometryMemoryUsage(){return this.geometryInfo.indices.byteLength+this.geometryInfo.vertexAttributes.byteLength}get textureDescriptor(){return(0,u.r)(this._texture)?this._texture.descriptor:null}get test(){return{hasTexture:null!=this._texture}}}class CA{constructor(){this._renderParams={context:null,drawPhase:1,state:new s.W({viewpoint:new s.u({targetGeometry:new g.b(0,0),scale:1,rotation:0}),size:[256,256]}),stationary:!0,pixelRatio:1,displayLevel:-1,requiredLevel:-1,globalOpacity:1,renderPass:"background",styleLayer:null,styleLayerUID:-1,painter:null,glyphMosaic:null,spriteMosaic:null,driverTestResult:null,profiler:null,renderingOptions:null,deltaTime:-1,timeline:null,time:0,hasClipping:!1,blendMode:null,dataUploadCounter:0,effects:null,inFadeTransition:!1,requireFBO:!1}}dispose(){this._renderParams=null}render(e,t,i,r,s,n,a,o,l,c){const h=n.adjustLevel(t[0]),d=this._renderParams;d.context=e,d.painter=r,d.glyphMosaic=r.glyphMosaic,d.spriteMosaic=r.spriteMosaic,d.pixelRatio=c,d.displayLevel=h,d.requiredLevel=h;const u=n.getScale(t[0]),[p,m]=n.getShift(t,a*u),f=.125*a*u/l,g=i.transforms.dvs;g[0]=f,g[4]=-f,g[6]=-1-p-o[0]*a*2,g[7]=1+m+(1-o[1])*a*2-2,d.state.size[0]=l,d.state.size[1]=l,i.stage||i.attachWithContext(e),i.triangleCount=0,r.drawTile(d,i,s)}}function TA(){const e=new S.n;return e.attributes.add("position","vec2"),e.attributes.add("uv0","vec2"),e.vertex.uniforms.add("scale","float"),e.vertex.uniforms.add("offset","vec2"),e.varyings.add("uv","vec2"),e.vertex.code.add(S.t`void main(void) {
gl_Position = vec4(position, 0.0, 1.0);
uv = uv0 * scale + offset;
}`),e.fragment.uniforms.add("tex","sampler2D"),e.fragment.uniforms.add("opacity","float"),e.fragment.code.add(S.t`void main() {
vec4 color = texture2D(tex, uv);
gl_FragColor = vec4(color.xyz, 1.0) * color.a * opacity;
}`),e}var SA=Object.freeze({__proto__:null,build:TA});class PA extends S.c{initializeProgram(e){const t=PA.shader.get().build();return new S.d(e.rctx,t,S.o)}initializePipeline(){const e=2===this.configuration.mode?(0,V.t)(1,771):1===this.configuration.mode?(0,V.t)(0,770):null;return(0,V.g)({blending:e,colorWrite:V.r})}}PA.shader=new S.f(SA,(()=>i.e(4385).then(i.bind(i,64385))));class RA extends S.b{constructor(){super(...arguments),this.mode=0}}function AA(e){e.attributes.add("position","vec2"),e.attributes.add("uv0","vec2"),e.vertex.uniforms.add("u_scale","float"),e.vertex.uniforms.add("u_offset","vec2"),e.varyings.add("v_texcoord","vec2"),e.vertex.code.add(S.t`void main(void) {
v_texcoord = uv0 * u_scale + u_offset;
gl_Position = vec4(position, 0.0, 1.0);
}`)}function MA(e){e.fragment.uniforms.add("u_colormap","sampler2D"),e.fragment.uniforms.add("u_colormapOffset","float"),e.fragment.uniforms.add("u_colormapMaxIndex","float"),e.fragment.code.add(S.t`vec4 colormap(vec4 currentPixel, bool isFloat) {
float clrIndex = isFloat ? currentPixel.r - u_colormapOffset : currentPixel.r * 255.0 - u_colormapOffset;
vec4 result;
if (currentPixel.a == 0.0 || clrIndex > u_colormapMaxIndex) {
result = vec4(0.0, 0.0, 0.0, 0.0);
} else {
vec2 clrPosition = vec2((clrIndex + 0.5) / (u_colormapMaxIndex + 1.0), 0.0);
vec4 color = texture2D(u_colormap, clrPosition);
result = vec4(color.rgb, 1.0) * color.a * u_opacity;
}
return result;
}`)}function OA(e){e.fragment.uniforms.add("u_transformGrid","sampler2D"),e.fragment.uniforms.add("u_transformSpacing","vec2"),e.fragment.uniforms.add("u_transformGridSize","vec2"),e.fragment.uniforms.add("u_targetImageSize","vec2"),e.fragment.code.add(S.t`vec2 projectPixelLocation(vec2 coords) {
vec2 index_image = floor(coords * u_targetImageSize);
vec2 oneTransformPixel = vec2(0.25 / u_transformGridSize.s, 1.0 / u_transformGridSize.t);
vec2 index_transform = floor(index_image / u_transformSpacing) / u_transformGridSize;
vec2 pos = fract((index_image + vec2(0.5, 0.5)) / u_transformSpacing);
vec2 srcLocation;
vec2 transform_location = index_transform + oneTransformPixel * 0.5;
if (pos.s <= pos.t) {
vec4 ll_abc = texture2D(u_transformGrid, vec2(transform_location.s, transform_location.t));
vec4 ll_def = texture2D(u_transformGrid, vec2(transform_location.s + oneTransformPixel.s, transform_location.t));
srcLocation.s = dot(ll_abc.rgb, vec3(pos, 1.0));
srcLocation.t = dot(ll_def.rgb, vec3(pos, 1.0));
} else {
vec4 ur_abc = texture2D(u_transformGrid, vec2(transform_location.s + 2.0 * oneTransformPixel.s, transform_location.t));
vec4 ur_def = texture2D(u_transformGrid, vec2(transform_location.s + 3.0 * oneTransformPixel.s, transform_location.t));
srcLocation.s = dot(ur_abc.rgb, vec3(pos, 1.0));
srcLocation.t = dot(ur_def.rgb, vec3(pos, 1.0));
}
return srcLocation;;
}`)}function DA(e){e.include(OA),e.fragment.uniforms.add("u_image","sampler2D"),e.fragment.uniforms.add("u_isFloatTexture","bool"),e.fragment.uniforms.add("u_flipY","bool"),e.fragment.uniforms.add("u_applyTransform","bool"),e.fragment.uniforms.add("u_opacity","float"),e.fragment.code.add(S.t`vec2 getPixelLocation(vec2 coords) {
vec2 targetLocation = u_flipY ? vec2(coords.s, 1.0 - coords.t) : coords;
if (!u_applyTransform) {
return targetLocation;
}
return projectPixelLocation(targetLocation);
}
bool isOutside(vec2 coords){
if (coords.t>1.00001 ||coords.t<-0.00001 || coords.s>1.00001 ||coords.s<-0.00001) {
return true;
} else {
return false;
}
}
vec4 getPixel(vec2 pixelLocation) {
return texture2D(u_image, pixelLocation);
}`)}function EA(e){const t=new S.n;return t.include(AA),t.include(DA),t.include(MA),0===e.output?function(e,t){e.fragment.uniforms.add("u_bandCount","int"),e.fragment.uniforms.add("u_minCutOff","float",3),e.fragment.uniforms.add("u_maxCutOff","float",3),e.fragment.uniforms.add("u_factor","float",3),e.fragment.uniforms.add("u_minOutput","float"),e.fragment.uniforms.add("u_maxOutput","float"),e.fragment.uniforms.add("u_useGamma","bool"),e.fragment.uniforms.add("u_gamma","float",3),e.fragment.uniforms.add("u_gammaCorrection","float",3),e.fragment.code.add(S.t`float stretchOneValue(float val, float minCutOff, float maxCutOff, float minOutput, float maxOutput, float factor, bool useGamma, float gamma, float gammaCorrection) {
if (val >= maxCutOff) {
return maxOutput;
} else if (val <= minCutOff) {
return minOutput;
}
float stretchedVal;
if (useGamma) {
float tempf = 1.0;
float outRange = maxOutput - minOutput;
float relativeVal = (val - minCutOff) / (maxCutOff - minCutOff);
if (gamma > 1.0) {
tempf -= pow(1.0 / outRange, relativeVal * gammaCorrection);
}
stretchedVal = (tempf * outRange * pow(relativeVal, 1.0 / gamma) + minOutput) / 255.0;
} else {
stretchedVal = minOutput + (val - minCutOff) * factor;
}
return stretchedVal;
}`);const i=t?S.t`gl_FragColor = colormap(vec4(grayVal, grayVal, grayVal, currentPixel.a), !u_useGamma);`:S.t`gl_FragColor = vec4(grayVal, grayVal, grayVal, 1.0) * currentPixel.a * u_opacity;`;e.fragment.code.add(S.t`
      void main() {
        vec2 pixelLocation = getPixelLocation(v_texcoord);
        if (isOutside(pixelLocation)) {
          gl_FragColor = vec4(0.0, 0.0, 0.0, 0.0);
          return;
        }

        vec4 currentPixel = getPixel(pixelLocation);
        if (currentPixel.a == 0.0) {
          gl_FragColor = vec4(0.0, 0.0, 0.0, 0.0);
          return;
        }

        if (u_bandCount == 1) {
          float grayVal = stretchOneValue(currentPixel.r, u_minCutOff[0], u_maxCutOff[0], u_minOutput, u_maxOutput, u_factor[0], u_useGamma, u_gamma[0], u_gammaCorrection[0]);
          ${i}
        } else {
          float redVal = stretchOneValue(currentPixel.r, u_minCutOff[0], u_maxCutOff[0], u_minOutput, u_maxOutput, u_factor[0], u_useGamma, u_gamma[0], u_gammaCorrection[0]);
          float greenVal = stretchOneValue(currentPixel.g, u_minCutOff[1], u_maxCutOff[1], u_minOutput, u_maxOutput, u_factor[1], u_useGamma, u_gamma[1], u_gammaCorrection[1]);
          float blueVal = stretchOneValue(currentPixel.b, u_minCutOff[2], u_maxCutOff[2], u_minOutput, u_maxOutput, u_factor[2], u_useGamma, u_gamma[2], u_gammaCorrection[2]);
          gl_FragColor = vec4(redVal, greenVal, blueVal, 1.0) * currentPixel.a * u_opacity;
        }
      }
    `)}(t,e.applyColormap):1===e.output?function(e){e.fragment.code.add(S.t`void main() {
vec2 pixelLocation = getPixelLocation(v_texcoord);
if (isOutside(pixelLocation)) {
gl_FragColor = vec4(0.0, 0.0, 0.0, 0.0);
return;
}
vec4 currentPixel = getPixel(pixelLocation);
gl_FragColor = colormap(currentPixel, true);
}`)}(t):2===e.output&&function(e,t){e.fragment.uniforms.add("u_hillshadeType","int"),e.fragment.uniforms.add("u_sinZcosAs","float",6),e.fragment.uniforms.add("u_sinZsinAs","float",6),e.fragment.uniforms.add("u_cosZs","float",6),e.fragment.uniforms.add("u_weights","float",6),e.fragment.uniforms.add("u_factor","vec2"),e.fragment.uniforms.add("u_applyColormap","bool"),e.fragment.uniforms.add("u_minValue","float"),e.fragment.uniforms.add("u_maxValue","float"),e.fragment.uniforms.add("u_srcImageSize","vec2"),e.fragment.include(S.j),e.fragment.code.add(S.t`vec4 overlay(float val, float minValue, float maxValue, float hillshade, float alpha) {
val = clamp((val - minValue) / (maxValue - minValue), 0.0, 1.0);
vec4 rgb = colormap(vec4(val, val, val, 1.0), false);
vec3 hsv = rgb2hsv(rgb.xyz);
hsv.z = hillshade;
return vec4(hsv2rgb(hsv) * alpha, alpha);
}`),e.fragment.code.add(S.t`float getNeighborHoodAlpha(float a, float b, float c, float d, float e, float f, float g, float h, float i){
if (a == 0.0 || a == 0.0 || a==0.0 || a == 0.0 || a == 0.0 || a==0.0 || a == 0.0 || a == 0.0 || a==0.0) {
return 0.0;
}  else {
return e;
}
}`);const i=t?S.t`gl_FragColor = overlay(ve.r, u_minValue, u_maxValue, hillshade, alpha);`:S.t`hillshade *= alpha;
gl_FragColor = vec4(hillshade, hillshade, hillshade, alpha);`;e.fragment.code.add(S.t`
    void main() {
      vec2 pixelLocation = getPixelLocation(v_texcoord);
      if (isOutside(pixelLocation)) {
        gl_FragColor = vec4(0.0, 0.0, 0.0, 0.0);
        return;
      }

      vec4 currentPixel = getPixel(pixelLocation);
      if (currentPixel.a == 0.0) {
        gl_FragColor = vec4(0.0, 0.0, 0.0, 0.0);
        return;
      }

      //mirror edge pixels
      vec2 axy = vec2(-1.0, -1.0);
      vec2 bxy = vec2(0.0, -1.0);
      vec2 cxy = vec2(1.0, -1.0);
      vec2 dxy = vec2(-1.0, 0.0);
      vec2 fxy = vec2(1.0, 0.0);
      vec2 gxy = vec2(-1.0, 1.0);
      vec2 hxy = vec2(0.0, 1.0);
      vec2 ixy = vec2(1.0, 1.0);
      vec2 onePixel = 1.0 / u_srcImageSize;
      if (pixelLocation.s < onePixel.s) {
        axy[0] = 1.0;
        dxy[0] = 1.0;
        gxy[0] = 1.0;
      }
      if (pixelLocation.t < onePixel.t) {
        axy[1] = 1.0;
        bxy[1] = 1.0;
        cxy[1] = 1.0;
      }
      if (pixelLocation.s > 1.0 - onePixel.s) {
        cxy[0] = -1.0;
        fxy[0] = -1.0;
        ixy[0] = -1.0;
      }
      if (pixelLocation.t > 1.0 - onePixel.t) {
        gxy[1] = -1.0;
        hxy[1] = -1.0;
        ixy[1] = -1.0;
      }

      // calculate hillshade
      vec4 va = texture2D(u_image, pixelLocation + onePixel * axy);
      vec4 vb = texture2D(u_image, pixelLocation + onePixel * bxy);
      vec4 vc = texture2D(u_image, pixelLocation + onePixel * cxy);
      vec4 vd = texture2D(u_image, pixelLocation + onePixel * dxy);
      vec4 ve = texture2D(u_image, pixelLocation);
      vec4 vf = texture2D(u_image, pixelLocation + onePixel * fxy);
      vec4 vg = texture2D(u_image, pixelLocation + onePixel * gxy);
      vec4 vh = texture2D(u_image, pixelLocation + onePixel * hxy);
      vec4 vi = texture2D(u_image, pixelLocation + onePixel * ixy);

      // calculate the rate of z change along the x, y, and diagonal direction
      float dzx = (vc + 2.0 * vf + vi - va - 2.0 * vd - vg).r * u_factor.s;
      float dzy = (vg + 2.0 * vh + vi - va - 2.0 * vb - vc).r * u_factor.t;
      float dzd = sqrt(1.0 + dzx * dzx + dzy * dzy);
      float hillshade = 0.0;

      // traditional single light source
      if (u_hillshadeType == 0){
        float cosDelta = u_sinZsinAs[0] * dzy - u_sinZcosAs[0] * dzx;
        float z = (u_cosZs[0] + cosDelta) / dzd;
        if (z < 0.0)  z = 0.0;
        hillshade = z;
      } else {
        // multi-directional with 6 light sources
        for (int k = 0; k < 6; k++) {
        float cosDelta = u_sinZsinAs[k] * dzy - u_sinZcosAs[k] * dzx;
        float z = (u_cosZs[k] + cosDelta) / dzd;
        if (z < 0.0) z = 0.0;
        hillshade = hillshade + z * u_weights[k];
        if (k == 5) break;
        }
      }

      // set color
      float alpha = getNeighborHoodAlpha(va.a, vb.a, vc.a, vd.a, ve.a, vf.a, vg.a, vh.a, vi.a);
      alpha *= u_opacity;
      ${i}
    }
  `)}(t,e.applyColormap),t}(0,r.e)([(0,S.a)({count:3})],RA.prototype,"mode",void 0);var zA=Object.freeze({__proto__:null,build:EA});class IA extends S.c{get uniformLocationInfos(){return this._uniformLocationInfos||(this._uniformLocationInfos=(0,_e.m)(this._context,this.program)),this._uniformLocationInfos}initializeProgram(e){const t=IA.shader.get(),i=this.configuration,r=t.build({output:i.colorizerType,applyColormap:i.applyColormap});return this._context=e.rctx,new S.d(e.rctx,r,S.o)}initializePipeline(){const e=2===this.configuration.mode?(0,V.t)(1,771):1===this.configuration.mode?(0,V.t)(0,770):null;return(0,V.g)({blending:e,colorWrite:V.r})}bindPass(e){(0,_e.c)(this.program,this.uniformLocationInfos,e.basic),(0,_e.c)(this.program,this.uniformLocationInfos,e.common),(0,u.r)(e.colormap)&&(0,_e.c)(this.program,this.uniformLocationInfos,e.colormap),0===this.configuration.colorizerType&&(0,u.r)(e.stretch)?(0,_e.c)(this.program,this.uniformLocationInfos,e.stretch):2===this.configuration.colorizerType&&(0,u.r)(e.hillshade)&&(0,_e.c)(this.program,this.uniformLocationInfos,e.hillshade)}}IA.shader=new S.f(zA,(()=>i.e(3667).then(i.bind(i,33667))));class LA extends S.b{constructor(){super(...arguments),this.mode=2,this.colorizerType=0,this.applyColormap=!0}}(0,r.e)([(0,S.a)({count:3})],LA.prototype,"mode",void 0),(0,r.e)([(0,S.a)({count:3})],LA.prototype,"colorizerType",void 0),(0,r.e)([(0,S.a)()],LA.prototype,"applyColormap",void 0);class FA{constructor(e){this.renderingContext=e,this._pools=new Map}acquire(e){return this.getPool(e).acquire()}release(e){this.getPool(e.width).release(e)}clear(){this._pools.forEach((e=>e.destroy())),this._pools.clear()}getPool(e){let t=this._pools.get(e);if(!t){const i=V.o.bind(V.o,this.renderingContext,{colorTarget:0,depthStencilTarget:1,width:e,height:e});t=new r.h(i),this._pools.set(e,t)}return t}}class VA{constructor(e,t,i){this._rctx=e,this.tileSize=t,this._backgroundIsGrid=!1,this._backgroundTexture=null,this._backgroundColor=null,this._blackTex=null,this._vectorTileHelper=new CA,this._maxAnisotropy=this._rctx.parameters.maxMaxAnisotropy,this._vaoQuad=(0,S.l)(this._rctx,S.bh);const r=new RA;r.mode=2,this._blendLayersTechnique=i.acquire(PA,r),r.mode=1,this._applyOpacityTechnique=i.acquire(PA,r),this._techniqueRep=i,this._blackTex=new ZS((0,S.bi)(this._rctx,[0,0,0,1])),this._fboPool=new FA(this._rctx)}dispose(){this._fboPool&&(this._fboPool.clear(),this._fboPool=null),this._vaoQuad=(0,u.z)(this._vaoQuad),this._backgroundTexture=(0,u.h)(this._backgroundTexture),this._blackTex=(0,u.h)(this._blackTex),this._blendLayersTechnique=(0,u.z)(this._blendLayersTechnique),this._applyOpacityTechnique=(0,u.z)(this._applyOpacityTechnique),this._vectorTileHelper=(0,u.z)(this._vectorTileHelper)}updateTileTexture(e){const t=e.layerInfo[1];for(const e of t)e.pendingUpdates&=-65;if(!e.renderData)return;const i=e.surface,r=i.baseOpacity;let s=0,n=0,a=this.tileSize,o=!1;const l=i.view.pixelRatio;let c=t.length,h=0;for(;h<t.length&&!o;h++){const d=i.layerViewByIndex(h,1),p=d.fullOpacity;if(GA[h]=p,Bt(d.layer)&&c>=t.length&&(c=h),0===p)continue;++n;const m=UA(e,h,BA);m&&(sP(d)?a=Math.max(a,this.tileSize*l):1===r&&1===p&&(d.isOpaque||this._dataToTexture(m)&&(0,u.r)(m.sourceLayerInfo.data)&&m.sourceLayerInfo.data.descriptor.isOpaque)&&(o=!0),++s)}this._cleanupFBOPool(l,t.length),a=function(e){const t=(0,v.O)(e),i=t*t,r=e*e;if(i===r)return e;const s=t/2;return i-r<r-s*s?t:s}(a);const d=a/this.tileSize,p=h-1;if(0===s){let t=0;return(e.surface.view.layerViewManager.updating||n>0)&&(t=5e3),this._backgroundTexture&&(0,u.t)(e.renderData.textureReference)&&(t=0),void this._useBackgroundTexture(e,t)}1===s&&(o||this._backgroundIsGrid||(0,u.r)(this._backgroundColor))&&this._useLayerTexture(e,p,c,GA[p])||this._composeMapLayers(e,p,c,o,GA,a,d)}setBackground(e,t){(0,u.h)(this._backgroundTexture),this._backgroundIsGrid=t,e instanceof HTMLImageElement?(this._backgroundTexture=this._buildTexture(e),this._backgroundColor=null):(this._backgroundTexture=new ZS((0,S.bi)(this._rctx,e)),this._backgroundColor=(0,w.a)(e[0]||0,e[1]||0,e[2]||0,e[3]||0))}get backgroundIsGrid(){return this._backgroundIsGrid}get backgroundColor(){return this._backgroundColor}_buildTexture(e,t=9987){if((0,u.t)(e))return null;const i={target:3553,pixelFormat:6408,dataType:5121,wrapMode:33071,samplingMode:t,maxAnisotropy:this._maxAnisotropy,flipped:!0,hasMipmap:!0},r=this._rctx;let s;if("number"==typeof e)i.width=i.height=e,s=new ZS(new q.r(r,i));else if(e instanceof LS)i.isOpaque=e.isOpaque,s=new ZS(new q.r(r,i,e.image)),e.release();else try{s=new ZS(new q.r(r,i,e))}catch(e){s=new ZS((0,S.bj)(r)),console.warn("TileRenderer: failed to execute 'texImage2D', cross-origin image may not be loaded.")}const n=r.bindTexture(s.texture,q.r.TEXTURE_UNIT_FOR_UPDATES);return s.generateMipmap(),r.bindTexture(n,q.r.TEXTURE_UNIT_FOR_UPDATES),s}_drawQuad(e){this._rctx.bindVAO(this._vaoQuad),e.assertCompatibleVertexAttributeLocations(this._vaoQuad),this._rctx.drawArrays(5,0,(0,V.a)(this._vaoQuad,"geometry"))}_drawRasterData(e,t,i,r,s=1){if((0,u.t)(t))return;const n=this._rctx,a=e.program;n.setPipelineState(e.pipeline),n.useProgram(a),a.bindTexture(t,"tex"),a.setUniform1f("scale",i),a.setUniform2f("offset",r[0],r[1]),a.setUniform1f("opacity",s),this._drawQuad(a)}hasNearestInterpolation(e){const t=e.sourceLayerInfo.data;return!((0,u.t)(t)||!t.source)&&"nearest"===t.interpolation}_drawImageryTileData(e,t=1){const i=e.sourceLayerInfo.data;if((0,u.t)(i)||!i.source)return;e.tile.surface.layerViewByIndex(e.layerIndex,1).ensureSymbolizerParameters(i);const r=this._getRasterColorizerTechnique(i.symbolizerParameters.type,!!i.symbolizerParameters.colormap),s=this._rctx,n=r.program;if(s.setPipelineState(r.pipeline),s.useProgram(n),!i.bind(s))return;i.opacity=t,i.scale=e.scale,i.offset=e.offset;const{names:a,textures:o}=i.getTextures();a.forEach(((e,t)=>n.bindTexture(o[t],e))),r.bindPass(i.getUniforms()),this._drawQuad(n),s.bindVAO()}_getRasterColorizerTechnique(e,t){const i=["stretch","lut","hillshade"].indexOf(e);return this._rasterColorizerConfig||(this._rasterColorizerConfig=new LA,this._rctx.gl.getExtension("WEBGL_color_buffer_float"),this._rctx.gl.getExtension("OES_texture_float")),this._rasterColorizerConfig.colorizerType=i,this._rasterColorizerConfig.applyColormap=t,this._rasterColorizerTechnique=this._techniqueRep.releaseAndAcquire(IA,this._rasterColorizerConfig,this._rasterColorizerTechnique),this._rasterColorizerTechnique}_drawVectorData(e,t,i,r,s,n,a){const o=t.sourceLayerInfo.data;if((0,u.t)(o))return a;const l=this._rctx,c=t.tile.surface.layerViewByIndex(t.layerIndex,1);let h;return l.setPipelineState(e.pipeline),r<1?(h=this._fboPool.acquire(s),l.bindFramebuffer(h),l.setClearColor(1,1,1,0),l.clearSafe(16640)):a&&l.clearSafe(256),this._vectorTileHelper.render(l,t.sourceLod,o,c.painter,c.layer.styleRepository,c.schemaHelper,Math.round(1/t.scale),t.offset,this.tileSize,i),!(0,u.r)(h)||(l.bindFramebuffer(n),this._drawRasterData(e,h.colorTexture,1,[0,0],r),this._fboPool.release(h),a)}_useBackgroundTexture(e,t){e.renderData.opacity=e.surface.baseOpacity,e.renderData.compositeBackgroundInShader=!1,e.renderData.layerOpacity=1,e.renderData.baseOpacity=1,e.renderData.setTextureReference(this._backgroundTexture,0,0,1,t)}_useLayerTexture(e,t,i,r){const s=t<i;e.renderData.opacity=s?1:e.surface.baseOpacity,e.renderData.compositeBackgroundInShader=!0,e.renderData.layerOpacity=r,e.renderData.baseOpacity=s?e.surface.baseOpacity:1;const n=UA(e,t,BA);if(this._dataToTexture(n)){const t=n.offset;return e.renderData.setTextureReference(n.sourceLayerInfo.data,t[0],t[1],n.scale),!0}return!1}_composeMapLayers(e,t,i,r,s,n,a){const o=this._rctx,l=this._fboPool.acquire(n);o.bindFramebuffer(l),o.setViewport(0,0,n,n),o.setClearColor(0,0,0,0),o.setClearDepth(1),o.clearSafe(16640);let c=!1;!r&&(0,u.r)(this._backgroundTexture)&&this._drawRasterData(this._blendLayersTechnique,this._backgroundTexture.texture,1,N.f);const h=e.surface.baseOpacity;let d=!1,p=9987;for(let r=t;r>=0;r--){const t=UA(e,r,BA);t&&(r<i&&h<1&&!d&&(this._drawRasterData(this._applyOpacityTechnique,this._blackTex.texture,1,N.f,h),d=!0),0!==s[r]&&(lP(t)?c=this._drawVectorData(this._blendLayersTechnique,t,a,s[r],n,l,c):oP(t)?(this._drawImageryTileData(t,s[r]),this.hasNearestInterpolation(t)&&(p=9728)):this._dataToTexture(t)&&(0,u.r)(t.sourceLayerInfo.data)&&this._drawRasterData(this._blendLayersTechnique,t.sourceLayerInfo.data.texture,t.scale,t.offset,s[r])))}const m=e.renderData.ensureTexture(n,(()=>this._buildTexture(n,p))),f=o.bindTexture(m.texture,q.r.TEXTURE_UNIT_FOR_UPDATES),g=m.descriptor;o.gl.copyTexImage2D(o.gl.TEXTURE_2D,0,g.pixelFormat,0,0,g.width,g.height,0),m.generateMipmap(),o.bindTexture(f,q.r.TEXTURE_UNIT_FOR_UPDATES),o.bindFramebuffer(null),this._fboPool.release(l),e.renderData.opacity=d?1:h,e.renderData.compositeBackgroundInShader=!1,e.renderData.layerOpacity=1,e.renderData.baseOpacity=1,e.renderData.setTextureReference(m,0,0,1)}_dataToTexture(e){return function(e){var t;const i=null==e||null==(t=e.sourceLayerInfo)?void 0:t.data;return i instanceof HTMLImageElement||i instanceof LS||i instanceof HTMLCanvasElement||i instanceof ImageData}(e)&&this._rasterDataToTexture(e),function(e){var t;return(null==e||null==(t=e.sourceLayerInfo)?void 0:t.data)instanceof ZS}(e)}_rasterDataToTexture(e){const t=e.sourceLayerInfo;t.data=this._buildTexture(t.data),e.tile.setMemoryDirty()}_cleanupFBOPool(e,t){e===this._lastPixelRatio&&t===this._lastNumLayers||(this._fboPool.clear(),this._lastPixelRatio=e,this._lastNumLayers=t)}get test(){return{backgroundTexture:this._backgroundTexture}}}function UA(e,t,i){i.layerIndex=t;const r=e.layerInfo[1][t];if(r.data)return(0,k.r)(i.offset,0,0),i.tile=e,i.scale=1,i.sourceLod=e.lij,i.sourceLayerInfo=r,i;const s=r.upsampleInfo;if(s){const e=s.tile.layerInfo[1][t];return i.tile=s.tile,(0,k.a)(i.offset,s.offset),i.scale=s.scale,i.sourceLod=s.tile.lij,i.sourceLayerInfo=e,i}return null}const GA=new Array,BA={tile:null,sourceLayerInfo:null,sourceLod:null,offset:[0,0],scale:1,layerIndex:0};function qA(e,t){e.varyings.add("tbnTangent","vec3"),e.varyings.add("tbnBiTangent","vec3"),1===t.viewingMode?e.vertex.code.add(S.t`void forwardVertexTangent(vec3 n) {
tbnTangent = normalize(cross(vec3(0.0, 0.0, 1.0), n));
tbnBiTangent = normalize(cross(n, tbnTangent));
}`):e.vertex.code.add(S.t`void forwardVertexTangent(vec3 n) {
tbnTangent = vec3(1.0, 0.0, 0.0);
tbnBiTangent = normalize(cross(n, tbnTangent));
}`),e.fragment.code.add(S.t`mat3 getTBNMatrix(vec3 n) {
return mat3(tbnTangent, tbnBiTangent, n);
}`)}function kA(e,t){e.extensions.add("GL_OES_standard_derivatives"),3!==t.pbrMode&&4!==t.pbrMode||e.include(mg,t),e.vertex.uniforms.add("overlayTexOffset","vec4"),e.vertex.uniforms.add("overlayTexScale","vec4"),e.varyings.add("vtcOverlay","vec4"),e.vertex.code.add(S.t`void setOverlayVTC(in vec2 uv) {
vtcOverlay = vec4(uv, uv) * overlayTexScale + overlayTexOffset;
}`),e.fragment.uniforms.add("ovColorTex","sampler2D"),e.fragment.uniforms.add("overlayOpacity","float"),e.fragment.code.add(S.t`bool isValid(vec2 uv, vec2 dxdy) {
return (uv.x >= 0.0 + dxdy.x) && (uv.x <= 1.0 - dxdy.x) && (uv.y >= 0.0 + dxdy.y) && (uv.y <= 1.0 - dxdy.y);
}
vec4 getOverlayColor(sampler2D ov0Tex, vec4 texCoords) {
vec4 color0 = texture2D(ov0Tex, vec2(texCoords.x * 0.5, texCoords.y));
vec4 color1 = texture2D(ov0Tex, vec2(texCoords.z * 0.5 + 0.5, texCoords.w));
bool isValid0 = isValid(texCoords.xy, fwidth(texCoords.xy));
bool isValid1 = isValid(texCoords.zw, vec2(0.0, 0.0));
return mix(color1 * float(isValid1), color0, float(isValid0));
}`),e.fragment.code.add(S.t`vec4 getCombinedOverlayColor() {
return overlayOpacity * getOverlayColor(ovColorTex, vtcOverlay);
}`),3!==t.pbrMode&&4!==t.pbrMode||(e.include(S.bk),e.fragment.code.add(S.t`vec4 getOverlayWaterColor(vec4 maskInput, vec4 colorInput, vec3 vposEyeDir,
float shadow, vec3 localUp, mat3 tbn, vec3 position) {
vec3 n = normalize(tbn *  (2.0 * maskInput.rgb - vec3(1.0)));
vec3 v = vposEyeDir;
vec3 final = getSeaColor(n, v, lightingMainDirection, colorInput.rgb, lightingMainIntensity, localUp, 1.0 - shadow, maskInput.w, position);
return vec4(final, colorInput.w);
}`))}function NA(e){e.vertex.code.add(S.t`vec3 applySkirts(inout vec2 uv, vec3 vpos, vec3 vnormal, float skirtScale) {
float skirtLength = 0.0;
if (uv.x >= 2.0) {
skirtLength = uv.y * skirtScale;
vec2 x = vec2(uv.x) - vec2(3.5, 4.5);
uv = clamp(vec2(1.5) - abs(x), vec2(0.0), vec2(1.0));
}
return vpos - vnormal * skirtLength;
}`)}function jA(e,t){e.varyings.add("vtc","vec2"),e.vertex.uniforms.add("texOffsetAndScale","vec4"),e.fragment.uniforms.add("tex","sampler2D"),e.fragment.uniforms.add("compositeBackground","bool"),e.fragment.uniforms.add("textureOpacity","float"),e.fragment.uniforms.add("baseOpacity","float"),t.textureFadingEnabled&&(e.vertex.uniforms.add("nextTexOffsetAndScale","vec4"),e.varyings.add("nvtc","vec2"),e.fragment.uniforms.add("texNext","sampler2D"),e.fragment.uniforms.add("textureFadeFactor","float")),e.vertex.code.add(S.t`
  void forwardTextureCoordinates(in vec2 uv) {
    vtc = uv * texOffsetAndScale.zw + texOffsetAndScale.xy;
    ${t.textureFadingEnabled?S.t`nvtc = uv * nextTexOffsetAndScale.zw + nextTexOffsetAndScale.xy;`:S.t``}
  }
  `),t.useGrid?(e.fragment.code.add(S.t`float lineFactorAtPosition(float value) {
float pos = value * 129.0;
if(pos < 0.5 || pos > 128.5) {
return 1.0;
}
pos = pos + 0.5;
float modulo = mod(pos, 16.0);
return modulo <= 2.0 ?  1.0 - abs(modulo - 1.0) : 0.0;
}
float lineFactorAtUV(vec2 uv) {
return max(lineFactorAtPosition(uv.x), lineFactorAtPosition(uv.y));
}
float lineFactor(vec2 uv) {
vec2 offset = fwidth(uv) * 0.25;
return (lineFactorAtUV(vec2(uv.x + offset.x, uv.y + offset.y)) +
lineFactorAtUV(vec2(uv.x - offset.x, uv.y + offset.y)) +
lineFactorAtUV(vec2(uv.x + offset.x, uv.y - offset.y)) +
lineFactorAtUV(vec2(uv.x - offset.x, uv.y - offset.y))) / 4.0;
}`),e.fragment.code.add(S.t`
    vec4 getTileColor() {
      vec4 color = ${t.textureFadingEnabled?S.t`textureFadeFactor < 1.0 ? mix(texture2D(texNext, nvtc), texture2D(tex, vtc), textureFadeFactor) : texture2D(tex, vtc);`:S.t`texture2D(tex, vtc);`};
      if(!compositeBackground) {
        return color;
      }

      float line = lineFactor(vtc) * 0.1 + 0.9;
      vec4 gridColor = vec4(1.0, 0.972, 0.918, 1.0) * line * baseOpacity;
      float alpha = textureOpacity * color.a;
      return mix(gridColor, color, alpha);
    }`)):t.hasBackgroundColor?(e.fragment.uniforms.add("backgroundColor","vec4"),e.fragment.code.add(S.t`
    vec4 getTileColor() {
      vec4 color = ${t.textureFadingEnabled?S.t`textureFadeFactor < 1.0 ? mix(texture2D(texNext, nvtc), texture2D(tex, vtc), textureFadeFactor) : texture2D(tex, vtc);`:S.t`texture2D(tex, vtc);`};
      float alpha = textureOpacity * color.a;
      return compositeBackground ? mix(backgroundColor * baseOpacity, color, alpha) : color;
    }`)):e.fragment.code.add(S.t`
    vec4 getTileColor() {
      return ${t.textureFadingEnabled?S.t`textureFadeFactor < 1.0 ? mix(texture2D(texNext, nvtc), texture2D(tex, vtc), textureFadeFactor) : texture2D(tex, vtc);`:S.t`texture2D(tex, vtc);`}
  }
  `)}function HA(e){const t=new S.n;if(t.include(S.bl,{name:"Terrain Shader",output:e.output}),t.include(NA),t.attributes.add("position","vec3"),t.attributes.add("uv0","vec2"),t.vertex.uniforms.add("proj","mat4").add("view","mat4").add("origin","vec3").add("skirtScale","float"),0===e.output){t.include(S.r,{linearDepth:!1}),t.include(ug,e),t.include(jA,e);const i=0!==e.overlayMode,r=2===e.overlayMode;i&&t.include(kA,{pbrMode:3,useCustomDTRExponentForWater:!1,ssrEnabled:e.ssrEnabled,highStepCount:e.highStepCount}),r&&t.include(qA,e),t.varyings.add("vnormal","vec3"),t.varyings.add("vpos","vec3"),t.vertex.uniforms.add("viewNormal","mat4"),e.receiveShadows&&t.varyings.add("linearDepth","float"),e.tileBorders&&t.varyings.add("vuv","vec2"),e.atmosphere&&(t.vertex.uniforms.add("lightingMainDirection","vec3"),t.varyings.add("wnormal","vec3"),t.varyings.add("wlight","vec3")),e.screenSizePerspective&&(t.vertex.uniforms.add("screenSizePerspective","vec4"),t.varyings.add("screenSizeDistanceToCamera","float"),t.varyings.add("screenSizeCosAngle","float")),t.vertex.code.add(S.t`
      void main(void) {
        vpos = position;
        vnormal = getLocalUp(vpos, origin);

        vec2 uv = uv0;
        vpos = applySkirts(uv, vpos, vnormal, skirtScale);
        ${e.atmosphere?S.t`
        wnormal = (viewNormal * vec4(normalize(vpos + origin), 1.0)).xyz;
        wlight = (view  * vec4(lightingMainDirection, 1.0)).xyz;`:""}
        ${e.tileBorders?S.t`vuv = uv;`:""}
        ${e.screenSizePerspective?S.t`
        vec3 viewPos = (view * vec4(vpos, 1.0)).xyz;
        screenSizeDistanceToCamera = length(viewPos);
        vec3 viewSpaceNormal = (viewNormal * vec4(normalize(vpos + origin), 1.0)).xyz;
        screenSizeCosAngle = abs(viewSpaceNormal.z);`:""}
        gl_Position = transformPosition(proj, view, vpos);
        ${e.receiveShadows?S.t`linearDepth = gl_Position.w;`:""}
        forwardTextureCoordinates(uv);
        ${i?S.t`setOverlayVTC(uv);`:""}
        ${r?S.t`forwardVertexTangent(vnormal);`:S.t``}
      }
    `),t.extensions.add("GL_OES_standard_derivatives"),t.extensions.add("GL_EXT_shader_texture_lod"),t.include(S.N,e),t.include(S.b1,e),t.fragment.uniforms.add("camPos","vec3").add("viewDirection","vec3").add("ssaoTex","sampler2D").add("viewportPixelSz","vec4").add("opacity","float"),e.screenSizePerspective&&t.fragment.uniforms.add("screenSizePerspective","vec4"),r&&(t.fragment.uniforms.add("ovWaterTex","sampler2D"),t.fragment.uniforms.add("view","mat4")),t.fragment.code.add(S.t`const vec3 ambient = vec3(0.2, 0.2, 0.2);
const vec3 diffuse = vec3(0.8, 0.8, 0.8);
const float diffuseHardness = 2.5;
const float sliceOpacity = 0.2;
float lum(vec3 c) {
float max = max(max(c.r, c.g), c.b);
float min = min(min(c.r, c.g), c.b);
return (min + max) * 0.5;
}`),e.atmosphere&&t.fragment.code.add(S.t`vec3 atmosphere(vec3 lightPos, vec3 normal, vec3 view) {
vec3 surfaceColor   = vec3(0.0);
vec3 fuzzySpecColor = vec3(1.0);
vec3 subColor       = vec3(0.0);
float rollOff       = 1.0;
vec3 Ln = normalize(lightPos);
vec3 Nn = normalize(normal);
vec3 Hn = normalize(view + Ln);
float ldn = dot(Ln, Nn);
float diffComp = max(0.0, ldn);
float vdn = clamp(1.0 - dot(view, Nn), 0.0, 1.0);
float ndv = dot(view, Ln);
vec3 diffContrib = surfaceColor * diffComp;
float subLamb = max(0.0, smoothstep(-rollOff, 1.0, ldn) - smoothstep(0.0, 1.0, ldn));
vec3 subContrib = subLamb * subColor;
vec3 vecColor = vec3(vdn);
vec3 diffuseContrib = (subContrib + diffContrib);
vec3 specularContrib = (vecColor * fuzzySpecColor);
return (diffContrib + specularContrib) * rollOff;
}`),t.fragment.code.add(S.t`
      void main() {
        ${e.receiveShadows?S.t`float shadow = readShadowMap(vpos, linearDepth);`:S.t`float shadow = 0.0;`}
        float vndl = dot(normalize(vnormal), lightingMainDirection);
        float k = smoothstep(0.0, 1.0, clamp(vndl*diffuseHardness, 0.0, 1.0));
        vec3 d = (1.0 - shadow/1.8) * diffuse * k;

        float ssao = viewportPixelSz.w < .0 ? 1.0 : texture2D(ssaoTex, (gl_FragCoord.xy - viewportPixelSz.xy) * viewportPixelSz.zw).a;
        vec4 tileColor = getTileColor() * opacity;
        ${i?S.t`
            vec4 overlayColorOpaque = getOverlayColor(ovColorTex, vtcOverlay);
            vec4 overlayColor = overlayOpacity * overlayColorOpaque;
            vec4 groundColor = tileColor;
            tileColor = tileColor * (1.0 - overlayColor.a) + overlayColor;`:""}
        if (rejectBySlice(vpos)) {
          tileColor *= sliceOpacity;
        }
        vec3 atm = vec3(0.0);
        ${e.atmosphere?S.t`
            float ndotl = max(0.0, min(1.0, vndl));
            atm = atmosphere(wlight, wnormal, -viewDirection);
            atm *= max(0.0, min(1.0, (1.0-lum(tileColor.rgb)*1.5))); //avoid atmosphere on bright base maps
            atm *= max(0.0, min(1.0, ndotl*2.0)); // avoid atmosphere on dark side of the globe
            atm *= tileColor.a; // premultiply with tile alpha`:""}
        vec3 albedo = atm + tileColor.rgb;
        vec3 normal = normalize(vnormal);

        // heuristic shading function used in the old terrain, now used to add ambient lighting
        float additionalAmbientScale = smoothstep(0.0, 1.0, clamp(vndl*2.5, 0.0, 1.0));
        vec3 additionalLight = ssao * lightingMainIntensity * additionalAmbientScale * ambientBoostFactor * lightingGlobalFactor;

        gl_FragColor = vec4(evaluateSceneLighting(normal, albedo, shadow, 1.0 - ssao, additionalLight), tileColor.a);
        ${r?S.t`
            vec4 overlayWaterMask = getOverlayColor(ovWaterTex, vtcOverlay);
            float waterNormalLength = length(overlayWaterMask);
            if (waterNormalLength > 0.95) {
              mat3 tbnMatrix = mat3(tbnTangent, tbnBiTangent, vnormal);
              vec4 waterOverlayColor = vec4(overlayColor.w > 0.0 ? overlayColorOpaque.xyz/overlayColor.w : vec3(1.0), overlayColor.w);
              vec4 viewPosition = view*vec4(vpos, 1.0);
              vec4 waterColorLinear = getOverlayWaterColor(overlayWaterMask, waterOverlayColor, -normalize(vpos - camPos), shadow, vnormal, tbnMatrix, viewPosition.xyz);
              vec4 waterColorNonLinear = delinearizeGamma(vec4(waterColorLinear.xyz, 1.0));
              // un-gamma the ground color to mix in linear space
              gl_FragColor = mix(groundColor, waterColorNonLinear, waterColorLinear.w);
            }`:""}
        ${e.screenSizePerspective?S.t`
          float perspectiveScale = screenSizePerspectiveScaleFloat(1.0, screenSizeCosAngle, screenSizeDistanceToCamera, screenSizePerspective);
          if (perspectiveScale <= 0.25) {
            gl_FragColor = mix(gl_FragColor, vec4(1.0, 0.0, 0.0, 1.0), perspectiveScale * 4.0);
          }
          else if (perspectiveScale <= 0.5) {
            gl_FragColor = mix(gl_FragColor, vec4(0.0, 0.0, 1.0, 1.0), (perspectiveScale - 0.25) * 4.0);
          }
          else if (perspectiveScale >= 0.99) {
            gl_FragColor = mix(gl_FragColor, vec4(0.0, 1.0, 0.0, 1.0), 0.2);
          }
          else {
            gl_FragColor = mix(gl_FragColor, vec4(1.0, 0.0, 1.0, 1.0), (perspectiveScale - 0.5) * 2.0);
          }`:""}
        ${e.tileBorders?S.t`
            vec2 dVuv = fwidth(vuv);
            vec2 edgeFactors = smoothstep(vec2(0.0), 1.5 * dVuv, min(vuv, 1.0 - vuv));
            float edgeFactor = 1.0 - min(edgeFactors.x, edgeFactors.y);
            gl_FragColor = mix(gl_FragColor, vec4(1.0, 0.0, 0.0, 1.0), edgeFactor);`:""}
        gl_FragColor = highlightSlice(gl_FragColor, vpos);
      }
    `)}return 1!==e.output&&3!==e.output||(t.include(S.r,{linearDepth:!0}),t.include(S.ao,{output:e.output}),t.include(ug,e),t.varyings.add("linearDepth","float"),t.vertex.uniforms.add("nearFar","vec2"),t.vertex.code.add(S.t`void main(void) {
vec3 normal = getLocalUp(position, origin);
vec2 uv = uv0;
vec3 vpos = applySkirts(uv, position, normal.xyz, skirtScale);
gl_Position = transformPositionWithDepth(proj, view, vpos, nearFar, linearDepth);
}`),t.fragment.code.add(S.t`void main() {
outputDepth(linearDepth);
}`)),2===e.output&&(t.include(S.r,{linearDepth:!1}),t.include(ug,e),t.varyings.add("vnormal","vec3"),t.varyings.add("vpos","vec3"),t.vertex.uniforms.add("viewNormal","mat4"),t.vertex.code.add(S.t`void main(void) {
vec3 normal = getLocalUp(position, origin);
vec2 uv = uv0;
vpos = applySkirts(uv, position, normal, skirtScale);
gl_Position = transformPosition(proj, view, vpos);
vnormal = normalize((viewNormal * vec4(normal, 1.0)).xyz);
}`),t.fragment.code.add(S.t`void main() {
vec3 normal = normalize(vnormal);
if (gl_FrontFacing == false) {
normal = -normal;
}
gl_FragColor = vec4(vec3(0.5) + 0.5 * normal, 0.0);
}`)),4===e.output&&(t.include(S.r,{linearDepth:!1}),t.include(ug,e),t.include(kA,{pbrMode:0}),t.vertex.code.add(S.t`void main() {
vec3 vnormal = getLocalUp(position, origin);
vec2 uv = uv0;
vec3 vpos = applySkirts(uv, position, vnormal, skirtScale);
setOverlayVTC(uv);
gl_Position = transformPosition(proj, view, vpos);
}`),t.include(S.S),t.fragment.code.add(S.t`void main() {
vec4 overlayColor = getCombinedOverlayColor();
if (overlayColor.a == 0.0) {
gl_FragColor = vec4(0.0);
return;
}
outputHighlight();
}`)),t}var WA=Object.freeze({__proto__:null,build:HA});class QA extends S.c{initializeProgram(e){const t=QA.shader.get(),i=this.configuration,r=t.build({overlayMode:i.overlayMode,output:i.output,viewingMode:e.viewingMode,slicePlaneEnabled:i.slicePlaneEnabled,sliceHighlightDisabled:!1,sliceEnabledForVertexPrograms:!1,textureFadingEnabled:i.textureFadingEnabled&&!i.renderOccluded,hasBackgroundColor:i.hasBackgroundColor,useGrid:i.useGrid,receiveShadows:i.receiveShadows&&!i.renderOccluded,receiveAmbientOcclusion:!1,atmosphere:i.atmosphere,tileBorders:i.tileBorders,screenSizePerspective:i.screenSizePerspective,pbrMode:0,ssrEnabled:i.ssrEnabled,highStepCount:!1});return new S.d(e.rctx,r,S.o)}initializePipeline(){const e=this.configuration,t=e.backfaceCullingEnabled&&!e.renderOccluded;return(0,V.g)({blending:e.renderOccluded?(0,V.t)(1,771):null,culling:t&&V.i,depthTest:!e.renderOccluded&&{func:513},depthWrite:!e.renderOccluded&&V.l,colorWrite:V.r,stencilTest:e.stencilEnabled?(0,S.bm)(1):null})}}QA.shader=new S.f(WA,(()=>i.e(793).then(i.bind(i,10793))));class ZA extends S.b{constructor(){super(...arguments),this.output=0,this.overlayMode=0,this.atmosphere=!1,this.receiveShadows=!1,this.slicePlaneEnabled=!1,this.backfaceCullingEnabled=!1,this.stencilEnabled=!1,this.textureFadingEnabled=!1,this.hasBackgroundColor=!1,this.useGrid=!1,this.renderOccluded=!1,this.ssrEnabled=!1,this.tileBorders=!1,this.screenSizePerspective=!1}}(0,r.e)([(0,S.a)({count:8})],ZA.prototype,"output",void 0),(0,r.e)([(0,S.a)({count:3})],ZA.prototype,"overlayMode",void 0),(0,r.e)([(0,S.a)()],ZA.prototype,"atmosphere",void 0),(0,r.e)([(0,S.a)()],ZA.prototype,"receiveShadows",void 0),(0,r.e)([(0,S.a)()],ZA.prototype,"slicePlaneEnabled",void 0),(0,r.e)([(0,S.a)()],ZA.prototype,"backfaceCullingEnabled",void 0),(0,r.e)([(0,S.a)()],ZA.prototype,"stencilEnabled",void 0),(0,r.e)([(0,S.a)()],ZA.prototype,"textureFadingEnabled",void 0),(0,r.e)([(0,S.a)()],ZA.prototype,"hasBackgroundColor",void 0),(0,r.e)([(0,S.a)()],ZA.prototype,"useGrid",void 0),(0,r.e)([(0,S.a)()],ZA.prototype,"renderOccluded",void 0),(0,r.e)([(0,S.a)()],ZA.prototype,"ssrEnabled",void 0),(0,r.e)([(0,S.a)()],ZA.prototype,"tileBorders",void 0),(0,r.e)([(0,S.a)()],ZA.prototype,"screenSizePerspective",void 0);const YA=(0,se.a)(),XA=(0,w.n)();class $A{constructor(){this.extent=(0,w.n)(),this.minLevel=0,this.maxLevel=0,this.callback=null}}let KA=class extends r.p{constructor(e){super(e),this.type="Terrain",this.isGround=!0,this.tileSize=256,this.rctx=null,this._isTransparent=!1,this.renderDataPool=new r.h(wA),this._patchGroups=new r.f({allocator:e=>e||{root:null,origin:null,patches:new r.f},deallocator:e=>(e.root=null,e.origin=null,e.patches.clear(),e)}),this.patchGroupsDirty=!0,this.patchGroupsMap=new Map,this.tileIterator=new VR,this.highestVisibleLODTile=null,this.visible=!0,this._opaque=!0,this._skirtScale=1,this._velvetOverground=!0,this.castShadows=!0,this._ssrEnabled=!1,this.emptyTex=null,this.tileRenderer=null,this.tileBackgroundInitialized=!1,this.tileBackgroundUpdating=!1,this.stencilEnabledLayerExtents=[],this.numTrianglesRendered=0,this.numTilesRendered=0,this.numTilesCulled=0,this.numOriginsRendered=0,this.clippingExtent=null,this.overlayOpacity=1,this.needsHighlight=!1,this.renderOccludedFlags=1,this.visibleScaleRangeQueries=new r.f({initialSize:10}),this.visibleScaleRangeQueriesInvPtr=0,this.visibleScaleRangeQueryQueue=new r.f({initialSize:30}),this.visibleScaleRangeQueryPool=new r.h($A)}get isGlobal(){return 1===this.stage.viewingMode}initialize(){this.stage.addRenderPlugin([2,7,9],this)}destroy(){this.stage.removeRenderPlugin(this),wR.clear(),SR.clear()}get updating(){return!this.tileBackgroundInitialized||this.tileBackgroundUpdating}get canRender(){return this.visible&&!!this.rootTiles&&this.tileBackgroundInitialized&&!this.renderingDisabled}set renderingDisabled(e){this._set("renderingDisabled",!!e),this.setNeedsRender()}set opaque(e){this._opaque!==e&&(this._opaque=e,this.setNeedsRender())}get needsLinearDepth(){return this.overlayRenderer.hasWater}get opaque(){return this._opaque&&!this.shaderTechniqueConfig.slicePlaneEnabled}set isTransparent(e){this._isTransparent!==e&&(this._isTransparent=e,this.setNeedsRender())}get isTransparent(){return this._isTransparent}set skirtScale(e){e!==this._skirtScale&&(this._skirtScale=e,this.setNeedsRender())}get skirtScale(){return this._skirtScale}get renderPatchBorders(){return!!this.shaderTechniqueConfig.tileBorders}set renderPatchBorders(e){this.shaderTechniqueConfig.tileBorders!==e&&(this.shaderTechniqueConfig.tileBorders=e,this.setNeedsRender(),this.notifyChange("renderPatchBorders"))}get cullBackFaces(){return this.shaderTechniqueConfig.backfaceCullingEnabled}set cullBackFaces(e){this.shaderTechniqueConfig.backfaceCullingEnabled!==e&&(this.shaderTechniqueConfig.backfaceCullingEnabled=e,this.notifyChange("cullBackFaces"),this.setNeedsRender())}set renderOrder(e){this._set("renderOrder",e),this.setNeedsRender()}set velvetOverground(e){this._velvetOverground!==e&&(this._velvetOverground=e,this.setNeedsRender())}get intersectionHandlerId(){return S.be}get slicePlane(){return this.shaderTechniqueConfig.slicePlaneEnabled}set slicePlane(e){this.shaderTechniqueConfig.slicePlaneEnabled!==e&&(this.shaderTechniqueConfig.slicePlaneEnabled=e,this.setNeedsRender())}set textureFadingEnabled(e){this.shaderTechniqueConfig.textureFadingEnabled!==e&&(this.shaderTechniqueConfig.textureFadingEnabled=e,this.setNeedsRender())}setDebugScreenSizePerspective(e){this.shaderTechniqueConfig.screenSizePerspective!==e&&(this.shaderTechniqueConfig.screenSizePerspective=e,this.setNeedsRender())}setRootTiles(e){this.rootTiles=e,this.setNeedsRender()}setNeedsHighlight(e){this.needsHighlight=e,this.setNeedsRender()}setRenderOccludedOverlay(e){this.renderOccludedFlags=e?pv:1,this.setNeedsRender()}setStencilEnabledLayerExtents(e){this.stencilEnabledLayerExtents=e,this.setNeedsRender()}setTileSize(e){this.tileSize=e,this.tileRenderer&&(this.tileRenderer.tileSize=e),this.setNeedsRender()}loadTile(e){e.renderData||(e.renderData=this.renderDataPool.acquire(),e.renderData.init(e),e.renderData.localOrigin=this._getLocalOriginOfTile(e)),this.updateTileGeometry(e),this.updateTileTexture(e)}queryVisibleLevelRange(e,t,i,r){const s=this.visibleScaleRangeQueryPool.acquire();(0,j.a)(s.extent,e),s.minLevel=t||-Number.MAX_VALUE,s.maxLevel=null!=i?i:Number.MAX_VALUE,s.callback=r,this.visibleScaleRangeQueryQueue.push(s),this.setNeedsRender()}updateTileTexture(e){this.tileRenderer&&this.tileBackgroundInitialized&&(this.tileRenderer.updateTileTexture(e),this.setNeedsRender(),e.resetPendingUpdate(64))}updateTileGeometry(e){for(const t of e.layerInfo[0])t.pendingUpdates&=-33;e.resetPendingUpdate(32),e.renderData.updateGeometry(this.rctx,this.wireframe)&&this.setNeedsRender()}unloadTile(e){e.renderData&&(e.renderData.releaseGeometry()&&this.setNeedsRender(),this.renderDataPool.release(e.renderData),e.renderData.clear(),e.renderData=null,e.setMemoryDirty(),this.setNeedsRender())}_getLocalOriginOfTile(e){const t=Math.max(0,7*Math.floor((e.lij[0]-3)/7));if(this.isGlobal&&0===t)return v.G;for(;e.parent&&e.lij[0]>t;)e=e.parent;return e.centerAtSeaLevel}setVisibility(e){this.visible=e,this.setNeedsRender()}getStats(){return{numTilesRendered:this.numTilesRendered,numTilesCulled:this.numTilesCulled,numTrianglesRendered:this.numTrianglesRendered,numOriginsRendered:this.numOriginsRendered}}set wireframe(e){this._get("wireframe")!==e&&(this._set("wireframe",e),this.allTiles.forAll((t=>{var i;return null==(i=t.renderData)?void 0:i.updateGeometry(this.rctx,e)})),this.setNeedsRender())}setNeedsRender(e=1){this.patchGroupsDirty=!0,this.context.requestRender(e)}setTileBackground(e){this.tileBackground=e,this._updateTileBackground()}initializeRenderContext(e){this.context=e,this.rctx=e.renderContext.rctx,this.shaderTechniques=e.shaderTechniqueRep,this.shaderTechniqueConfig=new ZA,this.tileRenderer=new VA(this.rctx,this.tileSize,this.shaderTechniques),this.tileBackground&&this._updateTileBackground(),this.emptyTex=(0,S.bj)(this.rctx)}uninitializeRenderContext(){null!=this.emptyTex&&(this.emptyTex.dispose(),this.emptyTex=null),this.tileRenderer&&(this.tileRenderer.dispose(),this.tileRenderer=null)}intersect(e,t,i,r){if(!this.rootTiles||e.options.selectOpaqueTerrainOnly&&e.options.selectionMode&&!this._opaque)return;const s=rM,n=sM;(0,v.c)(s,r,i),(0,v.a)(n,1/s[0],1/s[1],1/s[2]);const a=e.results.min,o=e.results.max,l=e.results.ground,c=0===e.options.store,h=!!e.results.ground.target;let d;const p=(0,S.bn)(e.verticalOffset),m=this.clippingExtent;this.allTiles.forAll((f=>{if(null===f.renderData||h&&this._useStencilForTile(f))return;if(e.options.invisibleTerrain){if(!f.visible&&m&&!f.intersectsExtent(m))return}else if(!f.visible)return;const g=f.renderData.geometryInfo;(0,se.A)(YA,g.boundingBox);const y=f.renderData.localOrigin;(0,u.r)(p)&&(p.localOrigin=y,p.applyToAabb(YA));const _=-this._skirtScale*g.skirtLength;if(0!==_){const e=f.up;(0,se.x)(YA,_*e[0],_*e[1],_*e[2])}const x=YA;(0,v.c)(nM,i,y);const b=c&&null!=a.dist?a.dist:1/0;if(!(0,S.bo)(x,nM,n,e.tolerance,b))return;const w=(e,t,i,r)=>{e.set(void 0,GR(t),i,r,T.a,void 0),e.intersector=oM,e.target={type:"external",metadata:{tile:t}}},C=(n,c)=>{if(n>=0&&(e.options.backfacesTerrain||(0,v.z)(c,s)<0)&&(e.options.invisibleTerrain||!e.options.selectionMode||null==t||t(i,r,n))){if((null==l.dist||n<l.dist)&&w(l,f,n,c),e.options.isFiltered)return;2===e.options.store&&((0,u.t)(d)?(d=new Ks(e.ray),w(d,f,n,c),e.results.all.push(d)):n<d.dist&&w(d,f,n,c)),(null==a.dist||n<a.dist)&&w(a,f,n,c),0!==e.options.store&&(null==o.dist||n>o.dist)&&w(o,f,n,c)}},P=aM;(0,v.c)(P,r,y);const R=g.indices,A=g.vertexAttributes,M={data:A.getField("position",de.i).typedBuffer,size:3,stride:A.stride/4},O=g.numWithoutSkirtIndices/3;if((0,S.a$)(nM,P,0,O,R,M,null,p,C),0!==_){const e=this.isGlobal?e=>(0,v.d)(e,e,_/(0,v.s)((0,v.u)(e,e,y))):e=>(0,v.a)(e,0,0,_),t=R.length/3;!function(e,t,i,r,s,n,a,o,l){const c=n.position,h=n.uv0,d=e[0],p=e[1],m=e[2],f=t[0]-d,g=t[1]-p,y=t[2]-m;r*=3;for(let e=i*=3;e<r;e+=3){const t=s[e],i=s[e+1],r=s[e+2];let n=c.get(t,0),_=c.get(t,1),x=c.get(t,2),b=c.get(i,0),w=c.get(i,1),C=c.get(i,2),T=c.get(r,0),P=c.get(r,1),R=c.get(r,2);h.get(t,0)>=2&&((0,v.a)(LR,n,_,x),a(LR),n+=LR[0],_+=LR[1],x+=LR[2]),h.get(i,0)>=2&&((0,v.a)(LR,b,w,C),a(LR),b+=LR[0],w+=LR[1],C+=LR[2]),h.get(r,0)>=2&&((0,v.a)(LR,T,P,R),a(LR),T+=LR[0],P+=LR[1],R+=LR[2]),(0,u.r)(o)&&([n,_,x]=o.applyToVertex(n,_,x),[b,w,C]=o.applyToVertex(b,w,C),[T,P,R]=o.applyToVertex(T,P,R));const A=b-n,M=w-_,O=C-x,D=T-n,E=P-_,z=R-x,I=g*z-E*y,L=y*D-z*f,F=f*E-D*g,V=A*I+M*L+O*F;if(Math.abs(V)<=Number.EPSILON)continue;const U=d-n,G=p-_,B=m-x,q=U*I+G*L+B*F;if(V>0){if(q<0||q>V)continue}else if(q>0||q<V)continue;const k=G*O-M*B,N=B*A-O*U,j=U*M-A*G,H=f*k+g*N+y*j;if(V>0){if(H<0||q+H>V)continue}else if(H>0||q+H<V)continue;const W=(D*k+E*N+z*j)/V;W>=0&&l(W,(0,S.bg)(A,M,O,D,E,z,FR))}}(nM,P,O,t,R,A,e,p,C)}}))}prepareRender(){this.overlayOpacity<1&&this.updateOverlayOpacity()}render(e){if(9===e.slot){if(0==(e.renderOccludedMask&pv))return!1}else{const t=this.opaque?2:7;if(e.slot!==t)return!1}const t=e.pass,i=1===e.scenelightingData.globalFactor,r=this._updatePatchGroups();switch(t){case 0:{const t=e.shadowMap&&e.shadowMap.enabled;this.shaderTechniqueConfig.receiveShadows!==t&&(this.shaderTechniqueConfig.receiveShadows=t);const i=this.overlayRenderer.isEmpty()?0:this.overlayRenderer.hasWater?2:1;this.shaderTechniqueConfig.overlayMode!==i&&(this.shaderTechniqueConfig.overlayMode=i);const s=9===e.slot?3:1;this._renderMaterialPass(e,0,r,s);break}case 4:case 6:this.castShadows&&i&&this._renderAuxiliaryPass(e,3,r,0);break;case 2:this.isTransparent&&this.overlayRenderer.isEmpty()||this._renderAuxiliaryPass(e,1,r,0);break;case 3:this._renderAuxiliaryPass(e,2,r,0);break;case 5:this.needsHighlight&&(this._renderAuxiliaryPass(e,4,r,2),e.rctx.clearSafe(256))}return 0!==this.visibleScaleRangeQueryQueue.length&&this.setNeedsRender(),!0}_renderMaterialPass(e,t,i,r){const{rctx:s,camera:n}=e;this._ssrEnabled=e.ssrParams.ssrEnabled,this._setTerrainTechnique(t,3===r);const a=this.shaderTechnique.program;s.useProgram(a),0!==this.shaderTechniqueConfig.overlayMode&&1===r&&e.ssrParams&&lg(a,e.ssrParams),e.shadowMap.bind(a),e.ssaoHelper.bind(a),this._bindOverlayData(a,r),a.setUniformMatrix4fv("viewNormal",n.viewInverseTransposeMatrix),(0,S.h)(a,n.projectionMatrix),e.scenelightingData.setUniforms(a,!0);const o=n.viewMatrix;(0,v.a)(iM,o[12],o[13],o[14]),(0,v.j)(iM,iM),a.setUniform3fv("viewDirection",iM),this.numTilesRendered=0,this.numTilesCulled=0,this.numTrianglesRendered=0,this.numOriginsRendered=0,this._prepareScaleRangeQueries(),this.opaque?this._renderPatchGroups(e,a,i,r):e.offscreenRenderingHelper.renderToTargets((()=>this._renderPatchGroups(e,a,i,r)),e.offscreenRenderingHelper.tmpColor,e.offscreenRenderingHelper.mainDepth,[0,0,0,0]),this._processScaleRangeQueries()}_renderAuxiliaryPass(e,t,i,r){this._setTerrainTechnique(t,3===r);const s=e.rctx,n=this.shaderTechnique.program;if(s.useProgram(n),5===e.pass){const t=e.offscreenRenderingHelper;n.bindTexture(t.depthTexture,"depthTex"),n.setUniform4f("highlightViewportPixelSz",0,0,1/t.width,1/t.height)}else n.setUniformMatrix4fv("viewNormal",e.camera.viewInverseTransposeMatrix),2!==e.pass&&4!==e.pass&&6!==e.pass||n.setUniform2fv("nearFar",e.camera.nearFar);this._renderPatchGroupsAuxiliary(e,n,i,r)}_updateTileBackground(){if(!this.tileRenderer)return;this.tileBackgroundUpdating=!0;const e=()=>{this.tileBackgroundInitialized=!0,this.tileBackgroundUpdating=!1,this.shaderTechniqueConfig.useGrid=this.tileRenderer.backgroundIsGrid,this.shaderTechniqueConfig.hasBackgroundColor=!this.tileRenderer.backgroundIsGrid&&!!(0,u.r)(this.tileRenderer.backgroundColor),this.allTiles.forAll((e=>this.tileRenderer.updateTileTexture(e))),this.setNeedsRender()};if("string"==typeof this.tileBackground){const t=this.tileBackground;(0,F.t)(t).then((i=>{t===this.tileBackground&&this.tileRenderer&&(this.tileRenderer.setBackground(i,this.tileBackground===Kt),e())}))}else{const t=this.tileBackground?z.o.toUnitRGBA(this.tileBackground):[0,0,0,0];this.tileRenderer.setBackground(t,!1),e()}}_updatePatchGroups(){const e=this._patchGroups;if(!this.patchGroupsDirty)return e;if(this.highestVisibleLODTile=null,this._renderCollectOrigins(e),0!==this.renderOrder){for(let t=0;t<e.length;t++)qR(this.renderOrder,e.data[t].patches);e.sort(((e,t)=>function(e,t,i){return 0===e.patches.length?-i:0===t.patches.length?i:kR(e.patches.data[0],t.patches.data[0],i)}(e,t,this.renderOrder)))}return this.patchGroupsDirty=!1,e}_renderCollectOrigins(e){const t=this.rootTiles,i=this.isGlobal;e.clear();for(const r of t){const t=e.pushNew();t.root=r,t.origin=i?v.G:r.centerAtSeaLevel,t.patches.clear(),this._renderCollectOriginsForRoot(e,t)}e.filterInPlace((e=>e.patches.length>0))}_renderCollectOriginsForRoot(e,t){const i=this.tileIterator;i.resetOne(t.root);const r=this.patchGroupsMap;for(r.clear(),r.set(t.origin,t);!i.done;){const t=i.next(),s=t.renderData;if(!s||t.visible){if(t.lij[0]%7==0){const i=e.pushNew();i.root=t,i.origin=t.centerAtSeaLevel,r.set(t.centerAtSeaLevel,i),i.patches.clear()}if(t.rendered){if(s){const e=r.get(s.localOrigin);e&&e.patches.push(t),(!this.highestVisibleLODTile||t.vlevel>this.highestVisibleLODTile.vlevel)&&(this.highestVisibleLODTile=t),i.skipSubtree()}}else this.numTilesCulled++}else this.numTilesCulled++,i.skipSubtree()}}_scaleQueriesForTile(e){const t=e.extent,i=e.lij[0];let r=0;for(;r<this.visibleScaleRangeQueriesInvPtr;){const e=this.visibleScaleRangeQueries.data[r],s=e.extent;i>=e.minLevel&&i<=e.maxLevel&&s[0]<=t[2]&&s[2]>=t[0]&&s[1]<=t[3]&&s[3]>=t[1]?(this.visibleScaleRangeQueries.swapElements(r,this.visibleScaleRangeQueriesInvPtr-1),this.visibleScaleRangeQueriesInvPtr--):r++}}_useStencilForTile(e){for(const t of this.stencilEnabledLayerExtents)if(e.intersectsExtent(t))return!0;return!1}_renderPatchGroupsAuxiliary(e,t,i,r){this.shaderTechnique.bindPipelineState(e.rctx);const s=this.stencilEnabledLayerExtents.length>0;t.setUniformMatrix4fv("proj",e.camera.projectionMatrix),t.setUniform1f("skirtScale",this._skirtScale),0!==r&&this._bindOverlayData(t,r);for(let n=0;n<i.length;n++){const a=i.data[n];this._bindPatchGroupData(t,a,e.camera.eye,e.camera.viewMatrix);for(let i=0;i<a.patches.length;i++)this._renderPatch(e.rctx,t,a.patches.data[i],4,s,r)}e.rctx.bindVAO(null)}_renderPatchGroups(e,t,i,r){const s=e.rctx,n=e.camera,a=n.viewMatrix;if(this.shaderTechnique.bindPipelineState(s),this.shaderTechniqueConfig.screenSizePerspective&&this.pointsOfInterest){const e=(0,S.bc)(this.stage.viewingMode,this.ellipsoidRadius),i=this.pointsOfInterest.centerOnSurfaceFrequent.distance;e.update({distance:i,fovY:n.fovY}),(0,S.ai)(e,t,"screenSizePerspective")}const o=this.stencilEnabledLayerExtents.length>0,l=3===r;l&&(t.bindTexture(this.emptyTex,"tex"),t.setUniform1f("blend",1),t.setUniform4fv("texOffsetAndScale",w._));const c=(0,u.r)(this.tileRenderer.backgroundColor)?this.tileRenderer.backgroundColor:w._;this.shaderTechniqueConfig.hasBackgroundColor&&t.setUniform4fv("backgroundColor",c);const h=l?0:this._skirtScale;t.setUniform1f("skirtScale",h);const d=this.wireframe?1:4;this.shaderTechniqueConfig.textureFadingEnabled&&t.bindTexture(this.emptyTex,"texNext");for(let c=0;c<i.length;c++){const h=i.data[c],p=h.patches;this._bindPatchGroupData(t,h,n.eye,a);const m=e.sliceHelper&&e.sliceHelper.plane;(0,S.bp)(t,this.shaderTechnique.configuration,m,h.origin),e.shadowMap&&e.shadowMap.bindView(t,h.origin),this.numOriginsRendered++;for(let e=0;e<p.length;e++){const i=p.data[e],n=i.renderData.textureReference;if((0,u.t)(n))continue;if(!l){this._scaleQueriesForTile(i),eM(i.renderData.geometryInfo.uvOffsetAndScale,n.offsetAndScale,XA),t.setUniform4fv("texOffsetAndScale",XA),t.bindTexture(n.texture.texture,"tex");const e=i.renderData.textureFadeFactor,r=e<1?i.renderData.nextTextureReference:null;this.shaderTechniqueConfig.textureFadingEnabled&&(0,u.r)(r)&&e<1?(eM(i.renderData.geometryInfo.uvOffsetAndScale,r.offsetAndScale,XA),t.setUniform1f("textureFadeFactor",e),t.setUniform4fv("nextTexOffsetAndScale",XA),t.bindTexture(r.texture.texture,"texNext")):t.setUniform1f("textureFadeFactor",1),i.renderData.textureIsFading&&this.setNeedsRender(),t.setUniform1f("opacity",i.renderData.opacity),t.setUniform1i("compositeBackground",i.renderData.compositeBackgroundInShader?1:0),t.setUniform1f("textureOpacity",i.renderData.layerOpacity),t.setUniform1f("baseOpacity",i.renderData.baseOpacity)}const a=this._renderPatch(s,t,i,d,o,r);i.renderOrder=this.numTilesRendered,this.numTilesRendered++,this.numTrianglesRendered+=a/3}}s.bindVAO(null)}_renderPatch(e,t,i,r,s,n){if((0,u.t)(i.renderData.vao.indexBuffer))return 0;0!==n&&this._bindOverlayPatchData(t,i.renderData.overlay),s&&(this._useStencilForTile(i)?this.stencilShaderTechnique.bindPipelineState(e):this.shaderTechnique.bindPipelineState(e));const a=0===this._skirtScale?i.renderData.geometryInfo.numWithoutSkirtIndices:i.renderData.vao.indexBuffer.size;return e.bindVAO(i.renderData.vao),t.assertCompatibleVertexAttributeLocations(i.renderData.vao),e.drawElements(r,a,i.renderData.vao.indexBuffer.indexType,0),a}_bindPatchGroupData(e,t,i,r){e.setUniform3fv("origin",t.origin),(0,C.c)(tM,r,t.origin),e.setUniformMatrix4fv("view",tM),e.setUniform3f("camPos",i[0]-t.origin[0],i[1]-t.origin[1],i[2]-t.origin[2])}_bindOverlayData(e,t){if(0===this.shaderTechniqueConfig.overlayMode)return;e.setUniform1f("overlayOpacity",this.overlayOpacity);const i=this.overlayRenderer.overlays;if(i.length>0){const r=i[0],s=r.getColorTexture(t);if(e.bindTexture((0,u.r)(s)?s:this.emptyTex,"ovColorTex"),2===this.shaderTechniqueConfig.overlayMode){const i=r.getNormalTexture(t);e.bindTexture((0,u.r)(i)?i:this.emptyTex,"ovWaterTex")}}}_bindOverlayPatchData(e,t){e.setUniform4fv("overlayTexOffset",t.offsets),e.setUniform4fv("overlayTexScale",t.scales)}_setTerrainTechnique(e,t){this.shaderTechniqueConfig.output=e,0===e&&(this.shaderTechniqueConfig.atmosphere=this.isGlobal&&this._velvetOverground,this.shaderTechniqueConfig.ssrEnabled=this._ssrEnabled),this.shaderTechniqueConfig.renderOccluded=t,this.shaderTechniqueConfig.stencilEnabled=!1,this.shaderTechnique=this.shaderTechniques.releaseAndAcquire(QA,this.shaderTechniqueConfig,this.shaderTechnique),this.shaderTechniqueConfig.stencilEnabled=!0,this.stencilShaderTechnique=this.shaderTechniques.releaseAndAcquire(QA,this.shaderTechniqueConfig,this.stencilShaderTechnique)}_prepareScaleRangeQueries(){const e=this.visibleScaleRangeQueries,t=this.visibleScaleRangeQueryQueue;for(;e.length<e.data.length&&t.length>0;){const i=t.pop();e.push(i)}this.visibleScaleRangeQueriesInvPtr=e.length}_processScaleRangeQueries(){const e=this.visibleScaleRangeQueries,t=this.visibleScaleRangeQueryPool;for(let i=0;i<e.length;i++){const r=e.data[i];t.release(r),r.callback(i>=this.visibleScaleRangeQueriesInvPtr),r.callback=null}e.clear()}get test(){return{tileRenderer:this.tileRenderer}}};(0,r.e)([(0,d.y)()],KA.prototype,"tileBackgroundInitialized",void 0),(0,r.e)([(0,d.y)()],KA.prototype,"tileBackgroundUpdating",void 0),(0,r.e)([(0,d.y)({constructOnly:!0})],KA.prototype,"overlayRenderer",void 0),(0,r.e)([(0,d.y)({constructOnly:!0})],KA.prototype,"stage",void 0),(0,r.e)([(0,d.y)({readOnly:!0})],KA.prototype,"isGlobal",null),(0,r.e)([(0,d.y)({constructOnly:!0})],KA.prototype,"updateOverlayOpacity",void 0),(0,r.e)([(0,d.y)({constructOnly:!0})],KA.prototype,"allTiles",void 0),(0,r.e)([(0,d.y)({constructOnly:!0})],KA.prototype,"ellipsoidRadius",void 0),(0,r.e)([(0,d.y)({readOnly:!0})],KA.prototype,"updating",null),(0,r.e)([(0,d.y)({value:!1})],KA.prototype,"renderingDisabled",null),(0,r.e)([(0,d.y)()],KA.prototype,"renderPatchBorders",null),(0,r.e)([(0,d.y)()],KA.prototype,"cullBackFaces",null),(0,r.e)([(0,d.y)({value:1})],KA.prototype,"renderOrder",null),(0,r.e)([(0,d.y)()],KA.prototype,"wireframe",null),KA=(0,r.e)([(0,d.n)("esri.views.3d.terrain.TerrainRenderer")],KA);var JA=KA;function eM(e,t,i){const r=e[0]*t[2]+t[0],s=e[1]*t[3]+t[1],n=e[2]*t[2],a=e[3]*t[3];(0,j.r)(i,r,s,n,a)}const tM=(0,T.e)(),iM=(0,v.n)(),rM=(0,v.n)(),sM=(0,v.n)(),nM=(0,v.n)(),aM=(0,v.n)(),oM="TerrainRenderer";class lM{constructor(){this.numNodes=0,this.numLeaves=0,this.numVisible=0,this.numRendered=0,this.numSplit=0,this.numMerged=0,this.numRenderedPerLevel=new Array,this.numLoadedPerLevel=new Array}}class cM{constructor(){this.offset=(0,N.n)(),this.scale=0,this.tile=null}init(e,t,i,r){this.tile=e,this.offset[0]=t,this.offset[1]=i,this.scale=r}dispose(){this.tile=null,this.offset[0]=0,this.offset[1]=0,this.scale=0}}const hM=u.n.getLogger("esri.views.3d.terrain.TerrainSurface");let dM=class extends(n.n.EventedMixin(r.p)){constructor(e){super(e),this._elevationBounds=new aR,this._rootExtent=(0,b.i)(),this._iteratorPool=new r.h(VR,(e=>e.remove=()=>this._iteratorPool.release(e))),this._postorderIterator=new UR,this._hasPendingUpdates=!1,this._pendingUpdates=0,this._asyncWorkItems=0,this._allTilesDirty=!0,this._allTilesSorted=!0,this._visible=!1,this._usedMemory=fM,this._performanceInfo=new lM,this._viewChanged=!1,this._inFrameTask=!1,this._viewChangeUpdateDirty=!1,this._overlayOpacity=1,this._eyePosRenderSR=(0,v.n)(),this._eyePosSurfaceSR=(0,v.n)(),this._splitLimits=new iA,this._snapLevel=1/0,this._frustum=wa(),this._viewProjectionMatrix=(0,T.e)(),this._layerViews=[new Array,new Array],this._layerIndexByUid=[new Map,new Map],this._basemapLayerViewHandles=new Map,this._handles=new R.u,this._watchUpdatingTracking=new W.l,this._allTiles=new r.f,this._upsampleInfoPool=new r.h(cM),this._getElevationData={spatialReference:null,rootTiles:null},this._maxNumUpdating=1,this.maxTextureScale=1.2,this.rootTiles=null,this.backgroundImage=Kt,this.backgroundColor=null,this._layerViewsDirty=!1}initialize(){this._lercDecoder=(0,Pe.n)(this.view.resourceController),this._tilePool=this.view.state.isLocal?new r.h(hA):new r.h(dA);const e=this.view.resourceController.memoryController;this._upsampleMapCache=e.getMemCache("esri.views.3d.terrain.upsample",(e=>e.unloadMapData())),this._elevationQueryCache=new KP(e.getMemCache("elevation-query")),this._set("overlayManager",new pR({surface:this})),this._handles.add([this.watch("overlayManager.hasHighlights",(e=>this._renderer.setNeedsHighlight(e))),this.watch("overlayManager.rendersOccluded",(e=>this._renderer.setRenderOccludedOverlay(e)))],"overlayManager"),this._renderer=new JA({overlayRenderer:this.overlayManager.renderer,ellipsoidRadius:(0,x.p)(this.view.spatialReference).radius,stage:this.view._stage,updateOverlayOpacity:()=>this.updateOverlayOpacity(),allTiles:this._allTiles}),this._handles.add([(0,p.d)(this,"baseOpacity",(e=>{this._handleLayerViewChanges(),this._updateBaseOpacity(e)}),!0),(0,p.d)(this,"_background",(()=>{this._handleLayerViewChanges(),this._renderer.setTileBackground(this._background)}),!0),this.view.watch("pointsOfInterest",(e=>{this._renderer.pointsOfInterest=e,this._watchUpdatingTracking.removeAll(),e&&this._watchUpdatingTracking.add(e.focus,"renderLocation",(()=>()=>this._allTilesSorted=!1))})),(0,p.d)(Ih,"TERRAIN_TILE_TREE_SHOW_TILES",(e=>{e&&!this._treeDebugger?Promise.all([i.e(9351),i.e(9996)]).then(i.bind(i,79996)).then((({TerrainTileTree3DDebugger:e})=>{!this._treeDebugger&&Ih.TERRAIN_TILE_TREE_SHOW_TILES&&(this._treeDebugger=new e({view:this.view}))})):e||!this._treeDebugger||Ih.TERRAIN_TILE_TREE_SHOW_TILES||(this._treeDebugger.destroy(),this._treeDebugger=null)}))]);const t={layers:this.view.map.allLayers,layerViews:this.view.allLayerViews,spatialReference:this.view.spatialReference};this.extentHelper=function(e,t){return 1===e?new fA(t):new gA(t)}(this.viewingMode,t),this._handles.add((0,p.d)(this.extentHelper,"stencilEnabledExtents",(e=>this._renderer.setStencilEnabledLayerExtents(e))),"extentHelper");const s=this.view.defaultsFromMap?new Te.p({getCollections:()=>{var e,t,i;return null==(e=this.view)||null==(t=e.defaultsFromMap)||null==(i=t.mapCollectionPaths)?void 0:i.map((e=>this.view.map.get(e)))},getChildrenFunction:e=>e&&"layers"in e?e.layers:null}):this.view.map.allLayers,n=new yA({layers:s,extentHelper:this.extentHelper,viewingMode:this.viewingMode,viewSpatialReference:this.view.spatialReference});this._set("tilingSchemeLogic",n),this._handles.add([this.tilingSchemeLogic.watch("tilingScheme",(()=>this._updateTilingSchemeAndExtent()),!0),this.tilingSchemeLogic.watch("extent",(()=>this._updateTilingSchemeAndExtent()),!0)],"tilingSchemeLogic"),this._updateTilingSchemeAndExtent(),this._elevationDataRequester=this.view.resourceController.createStreamDataRequester(0),this._mapDataRequester=this.view.resourceController.createStreamDataRequester(1);const a=this.view.resourceController.scheduler;this._frameTask=a.registerTask(Jd.TERRAIN_SURFACE,this),this.view.resourceController.memoryController.events.on("quality-changed",(()=>this._viewChangeUpdate())),this._handles.add([this.view.on("resize",(()=>this._viewChangeUpdate())),this.view.watch("state.camera",(()=>this._viewChangeUpdate()),!0),this.view.watch("state.contentCamera",(()=>this.view.state.fixedContentCamera&&this._viewChangeUpdate()),!0),this.view.watch("qualitySettings.tiledSurface.lodBias",(()=>this._viewChangeUpdate())),(0,p.d)(this.view,"qualitySettings.tiledSurface.textureFadeDuration",(e=>this._renderer.textureFadingEnabled=e>0)),this.view.watch("lodSnapping",(()=>this._viewChangeUpdate())),this.view.watch("clippingArea",(()=>this._clippingChanged()))]),this._handles.add(this.view.allLayerViews.on("after-changes",(()=>this._layerViewsDirty=!0))),this._layerViewsDirty=!0,this._handleLayerViewChanges(),this._updateClippingExtent(),this.notifyChange("extent")}destroy(){this._frameTask.remove(),this._handles.destroy(),this._watchUpdatingTracking.destroy(),this._lercDecoder=(0,u.h)(this._lercDecoder),this._removeAllTiles(),this._upsampleMapCache=(0,u.k)(this._upsampleMapCache),this._elevationQueryCache=(0,u.k)(this._elevationQueryCache),this._set("tilingSchemeLogic",(0,u.k)(this.tilingSchemeLogic)),this.extentHelper=(0,u.k)(this.extentHelper),this._basemapLayerViewHandles.forEach(((e,t)=>this._unregisterTiledLayerView(t))),this._elevationDataRequester=null,this._mapDataRequester=null,this._set("overlayManager",(0,u.k)(this.overlayManager)),this._tilePool=(0,u.k)(this._tilePool),rA.prune(),this._treeDebugger&&(this._treeDebugger.destroy(),this._treeDebugger=null),this._renderer=(0,u.k)(this._renderer),this._iteratorPool=(0,u.k)(this._iteratorPool),this._set("view",null),this._upsampleInfoPool=(0,u.k)(this._upsampleInfoPool),(0,Ce.u)(),$R.size>0&&(console.log(`${$R.size} live TilePerLayerInfo allocations:`),$R.forEach((e=>console.log(e,"\n"))))}get renderer(){return this._renderer}get frustum(){return this._frustum}get snapLevel(){var e,t;const i=null==(e=this.view.pointsOfInterest)||null==(t=e.contentCameraOnSurface)?void 0:t.scale;if(i){const e=this.view.state.contentCamera;let t=Mc(this.view,e.eye,e.viewForward,e.up).tilt;t>90&&(t=180-t);const r=2*(t/90)**2,s=Vc(this.view,i)-r;Math.abs(this._snapLevel-s)>.25&&(Math.round(s)!==Math.round(this._snapLevel)&&(this._viewChanged=!0),this._snapLevel=s)}return Math.round(this._snapLevel)}get lodSnapping(){return this.view.qualitySettings.tiledSurface.reduceTileLevelDifferences?1:0}get upsampleInfoPool(){return this._upsampleInfoPool}get upsampleMapCache(){return this._upsampleMapCache}get elevationQueryCache(){return this._elevationQueryCache}get mapTileRequester(){return this._mapDataRequester}get extent(){return(0,u.q)(this._clippingExtent,this._rootExtent)}get updating(){return this._hasPendingUpdates||(this._maxNumUpdating=1),!!((this._watchUpdatingTracking.updating||this._hasPendingUpdates||this._viewChanged||this._allTilesDirty||this._asyncWorkItems>0||!this._allTilesSorted||this._renderer.updating||this._layerViewsDirty)&&this.ready&&!this.suspended||this.overlayManager.updating||this._frameTask.updating)}get updatingProgressValue(){return this._maxNumUpdating=Math.max(this._pendingUpdates,this._maxNumUpdating),1-this._pendingUpdates/this._maxNumUpdating}get viewingMode(){return this.view.state.viewingMode}get ready(){return!!this.rootTiles}set renderOrder(e){this._renderer.renderOrder=e,this._set("renderOrder",e)}set skirtScale(e){this._renderer.skirtScale=e}get skirtScale(){return this._renderer.skirtScale}get spatialReference(){var e,t;return null!=(e=null==(t=this.tilingScheme)?void 0:t.spatialReference)?e:null}get _background(){return null!=this.backgroundColor?this.backgroundColor:this.backgroundImage}set slicePlaneEnabled(e){var t,i;this._renderer.slicePlane=e,this._set("slicePlaneEnabled",e),null==(t=this.view)||null==(i=t._stage)||i.renderView.setRenderParameters({opaqueTerrain:this.opaque})}set velvetOverground(e){e!==this.velvetOverground&&(this._renderer.velvetOverground=e),this._set("velvetOverground",e)}set visible(e){e!==this._visible&&(this._visible=e,this._renderer.setVisibility(e),this.suspended=!e)}get opaque(){return this._renderer.opaque}set suspended(e){this._set("suspended",e),this._viewChangeUpdate()}intersect(e,t,i,r){this._renderer.intersect(e,t,i,r)}getElevation(e,t,i,r){const s=gM,n=this.getTileWithElevation(e,t,i,r,s);return(0,u.t)(n)?null:oR.sample(s[0],s[1],n.renderData.geometryState.samplerData)}getTileWithElevation(e,t,i,r,s=gM){const n=this._getElevationData.rootTiles;if(!n||!n.length)return null;if(0===n[0].layerInfo[0].length)return null;if(s[0]=e,s[1]=t,s[2]=i,!(0,_.w)(s,r,s,this._getElevationData.spatialReference))return hM.error("TerrainSurface.getElevation(): could not project given point to tiling scheme coordinate system"),null;for(let e of n){if(!e.containsPoint(s))continue;for(;e&&!e.rendered&&!e.isLeaf;){let t=0;s[0]>.5*(e.extent[0]+e.extent[2])&&(t+=1),s[1]<.5*(e.extent[1]+e.extent[3])&&(t+=2),e=e.children[t]}const t=e.renderData;return t&&t.geometryState&&t.geometryState.samplerData?e:null}return null}get elevationBounds(){return this._elevationBounds}getScale(e){if(this.tilingScheme){if(!(0,_.R)(e,gM,this.spatialReference))return hM.error("TerrainSurface.getElevation(): could not project given point to tiling scheme coordinate system"),null;const t=this.rootTiles;if(t)for(let e of t)if(e.containsPoint(gM)){for(;null!=e.children[0];){let t=0;gM[0]>e.children[0].extent[2]&&(t+=1),gM[1]<e.children[0].extent[1]&&(t+=2),e=e.children[t]}return this._getLodBiasCorrectedScale(e.level)}}return 1e100}queryVisibleScaleRange(e,t,i,r){const s=t?this.tilingScheme.levelAtScale(t):0,n=i?this.tilingScheme.levelAtScale(i):1/0,a=this.lodBias;this._renderer.queryVisibleLevelRange(e,s+a,n+a,r)}_updateBaseOpacity(e){const t=this._renderer.opaque;this._renderer.opaque=e>=1,this._renderer.isTransparent=this._allTransparentSurfaceLayers();const i=t!==this._renderer.opaque;var r,s;i&&(null==(r=this.view)||null==(s=r._stage)||s.renderView.setRenderParameters({opaqueTerrain:this.opaque})),this._updateTileTextures(i)}_updateTilingSchemeAndExtent(){const e=this.tilingSchemeLogic.extent,t=e&&!(0,b.G)(e,this._dataExtent);t&&((0,u.r)(this._dataExtent)?(0,b.A)(this._dataExtent,e):this._dataExtent=(0,b.i)(e));const i=this.tilingSchemeLogic.tilingScheme,r=i!==this.tilingScheme;var s;r&&(XS(!!i,"tiling scheme cannot be reset to undefined"),this.tilingScheme&&this._removeAllTiles(),this._set("tilingScheme",i),this._updateClippingExtent(),i&&(this._updateTiledLayers(),this._renderer.setTileSize(i.pixelSize),this.overlayManager.setSpatialReference(i.spatialReference)),this._getElevationData.spatialReference=null!=(s=null==i?void 0:i.spatialReference)?s:null),(t||r)&&this._updateRootTiles()}_acquireTile(e,t,i,r){const s=this._tilePool.acquire();return yM[0]=e,yM[1]=t,yM[2]=i,s.init(yM,r,this),s}_updateRootTiles(){const e=this._clippingExtent||this._dataExtent,t=this.tilingScheme;if((0,u.t)(e)||!t)return;const i=vM;let s=t.rootTilesInExtent(e,i,320);const n=e=>{const t=this._acquireTile(0,e[1],e[2],null);return 2===t.shouldSplit(this._splitLimits,this._eyePosRenderSR,this.lodSnapping)&&t.setPendingUpdate(2),this._loadTile(t),t};if(this.rootTiles){if(s.length>64)return void hM.warn("Cannot extend surface to encompass all layers because it would result in too many root tiles.");const e=this.rootTiles.map((e=>e.lij)),t=(0,r.L)(e,s,pM);if(t.removed.length>0||t.added.length>0){const e=this.rootTiles.filter((e=>!(t.removed.findIndex(pM.bind(null,e.lij))>-1&&(this._purgeTile(e),1))));t.added.forEach((t=>e.push(n(t)))),this._setRootTiles(e)}}else s.length>64&&(hM.warn("Surface extent is too large for tile resolution at level 0."),s=t.rootTilesInExtent(e,i,64)),this._setRootTiles(s.map((e=>n(e))));(0,b.G)(i,this._rootExtent)||(this._rootExtent=(0,b.i)(i),this._hasFixedExtent()||this.notifyChange("extent")),this.visible=!0,this._viewChangeUpdate(),this.overlayManager.setOverlayPlacementDirty(),this.notifyChange("ready")}_setRootTiles(e){if(this._set("rootTiles",e),this._allTiles.clear(),e){const t=this._iteratorPool.acquire();for(t.reset(e);!t.done;)this._allTiles.push(t.next());t.remove()}this._getElevationData.rootTiles=e,this._renderer.setRootTiles(this.rootTiles),this._updateTileVisibility(e)}_runViewChangeUpdateIfDirty(){this._viewChangeUpdateDirty&&(this._viewChangeUpdateDirty=!1,this._viewChangeUpdate())}_viewChangeUpdate(){this.view&&!this.suspended&&this.tilingScheme&&this._visible&&(this._inFrameTask?this._viewChangeUpdateDirty=!0:(this._viewChangeUpdateDirty=!1,this._updateViewDependentParameters(),this._updateSkirts(),this.updateOverlayOpacity(),this._updateTileVisibility(this.rootTiles)))}_updateClippingStatus(e){e.updateClippingStatus(this._clippingExtent)&&e.resetPendingUpdate(32)&&this._updateTileGeometry(e)}_updateTileVisibility(e){if(!e)return;const t=this._iteratorPool.acquire();t.reset(e);const i=function(e){for(let t=0;t<e.length;t++){const i=e[t],r=i.parent;if(r)for(let e=0;e<4;e++){const t=r.children[e];if(t&&t!==i&&t.loadable)return!0}}return!1}(e);let r=i?this._elevationBounds.min:1/0,s=i?this._elevationBounds.max:-1/0;for(;!t.done;){const e=t.next();this._updateClippingStatus(e),e.updateVisibility(),e.setPendingUpdate(16),e.loadable?(e.updateScreenDepth(this._viewProjectionMatrix),e.renderData&&(r=Math.min(e.elevationBounds[0],r),s=Math.max(e.elevationBounds[1],s))):t.skipSubtree()}t.remove(),this._viewChanged=!0,this._allTilesDirty=!0,isFinite(r)&&isFinite(s)&&(this._elevationBounds.min===r&&this._elevationBounds.max===s||(this._elevationBounds.min=r,this._elevationBounds.max=s,this.emit("elevation-bounds-change",null)))}_updateViewDependentParameters(){const e=this.view.state.camera,t=this.view.state.contentCamera,i=Math.tan(.5*t.fovX),r=Math.tan(.5*t.fovY),s=this.tilingScheme.pixelSize,n=2**-this.lodBias*e.pixelRatio;this._splitLimits.aboveGround=e.aboveGround,this._splitLimits.fovX=i,this._splitLimits.fovY=r,this._splitLimits.relativeWidthLimit=s/e.width*this.maxTextureScale*n,this._splitLimits.relativeHeightLimit=s/e.height*this.maxTextureScale*n,this._splitLimits.maxLod=this.tilingScheme.getMaxLod(),this._splitLimits.angledSplitBias=this.view.qualitySettings.tiledSurface.angledSplitBias,this.view.state.fixedContentCamera?((0,u.t)(this._splitLimits.frustum)&&(this._splitLimits.frustum=wa()),Ta(t.frustum,this._splitLimits.frustum)):this._splitLimits.frustum=null,Ta(e.frustum,this._frustum),(0,C.e)(this._viewProjectionMatrix,t.projectionMatrix,t.viewMatrix),(0,v.h)(this._eyePosRenderSR,t.eye),(0,_.w)(e.eye,this.view.renderSpatialReference,this._eyePosSurfaceSR,this.spatialReference)}_updateSkirts(){const e=this.view.state.camera,t=this.view.state.constraints.collision.enabled?0:1.11*e.near;this.skirtScale=function(e,t,i){const r=YS[e.viewingMode];let s;if(r.isInsideExtent(e,t))s=(0,u.q)(e.getElevation(t[0],t[1],t[1],e.spatialReference),0);else{if(!r.isInsideExtent(e,t,1.2))return 0;const i=e.getTileWithElevation(t[0],t[1],t[1],e.spatialReference);s=.5*(((0,u.r)(i)?i.elevationBounds[0]:e.elevationBounds.min)+((0,u.r)(i)?i.elevationBounds[1]:e.elevationBounds.max));const n=r.tiltToExtentEdge(e,t,s);if(n>$S&&n<KS)return 0}const n=t[2]-s;return Math.abs(n)<i?0:n<0?-1:1}(this,this._eyePosSurfaceSR,t)}_updateRenderData(e){e.rendered&&!e.shouldLoad&&(mM(e)?this._loadChildren(e):function(e){return e.isLeaf&&e.parent&&e.parent.shouldLoad}(e)&&this._loadParent(e))}_updateTileGeometry(e){e.updateVisibility(),this._renderer.updateTileGeometry(e),this._elevationUpdate(e),this._usedMemory=fM}_elevationUpdate(e){xM.spatialReference=this.spatialReference,xM.tile=e,xM.extent=e.extent,this.emit("elevation-change",xM),(0,b.g)(e.extent,this._eyePosSurfaceSR)&&this._updateSkirts()}get running(){return this.updating&&this.ready&&!this.suspended}runTask(e){this._handleLayerViewChanges(e),this._frameTask.processQueue(e),this._inFrameTask=!0,this._pendingUpdates=0,this._hasPendingUpdates=!1,this._updateTileStatus(e),this._sortTiles(e);const t=!this.view.state.fixedContentCamera;this._mergeAndSplit(e,t),e.run((()=>this._updateElevation(e))),e.run((()=>this._updateTextures(e))),t||this._mergeAndSplit(e,!0),this._inFrameTask=!1,this._runViewChangeUpdateIfDirty(),e.done&&this.requestUpdate(),this.notifyChange("updatingProgressValue")}_updateTileStatus(e){if(!this._viewChanged||!this.rootTiles||e.done)return;this._viewChanged=!1;const t=this._iteratorPool.acquire();for(t.reset(this.rootTiles);!t.done;){const e=t.next();if(e.loadable){const i=e.shouldSplit(this._splitLimits,this._eyePosRenderSR,this.lodSnapping);if(2===i){e.resetPendingUpdate(8),e.isLeaf&&(e.setPendingUpdate(2),t.skipSubtree());continue}e.resetPendingUpdate(2)&&e.updateAgentSuspension(),4===i&&e.updateAgents(0)}if(t.skipSubtree(),!e.isLeaf){e.setPendingUpdate(8),e.resetPendingUpdate(2);const t=this._iteratorPool.acquire();t.resetOne(e);for(let e=t.next();!t.done;e=t.next())this._updateClippingStatus(e),e.updateVisibility(),e.loadable&&e.updateScreenDepth(this._viewProjectionMatrix);t.remove()}}t.remove(),this.requestUpdate(),e.madeProgress()}_sortTiles(e){e.done||this._allTilesSorted||(function(e,t){const i=new Map;e.forAll((e=>i.set(e,e.distanceToSquared(t)))),e.sort(((e,t)=>i.get(e)-i.get(t)))}(this._allTiles,this.view.pointsOfInterest.focus.renderLocation),this._allTilesSorted=!0,this._treeDebugger&&this._treeDebugger.update(),e.madeProgress())}_mergeAndSplit(e,t){if(this.suspended||!this._allTilesDirty||e.done)return;this._allTilesDirty=!1,this.requestUpdate();let i=0;for(;!e.done;){let r=!1;i=0;const s=!this._allTiles.some((s=>{if(i+=s.usedMemory,s.resetPendingUpdate(8)){if(!t)return s.setPendingUpdate(8),e.done;this._mergeTile(s),r=!0,e.madeProgress()}else s.resetPendingUpdate(2)&&(this._splitTile(s),r=!0,e.madeProgress());return s.resetPendingUpdate(16)&&(this._updateRenderData(s),e.madeProgress()),e.done}));if(r&&(this._allTilesSorted=!1,this._allTilesDirty=!0),s){if(this._usedMemory=i,!r)break}else this._allTilesDirty=!0}0===i&&(this._allTilesDirty=!0),this._sortTiles(e)}_updateElevation(e){return this._allTiles.some((t=>(t.resetPendingUpdate(32)&&(this._updateTileGeometry(t),t.resetPendingUpdate(64)&&(this._renderer.updateTileTexture(t),this._usedMemory=fM),e.madeProgress()),e.done))),e.hasProgressed}_updateTextures(e){return this._allTiles.some((t=>(t.resetPendingUpdate(64)&&(this._renderer.updateTileTexture(t),this._usedMemory=fM,e.madeProgress()),e.done))),e.hasProgressed}_updateClippingExtent(){if(!this.spatialReference)return!1;const e=(0,b.i)();let t=null;return jC(this.view.clippingArea,e,this.spatialReference)&&(t=e),!(0,b.G)(t,this._clippingExtent)&&(this._clippingExtent=t,this._renderer.clippingExtent=t,this.notifyChange("extent"),this.updateTileOverlayParams(),this.overlayManager.setOverlayPlacementDirty(),!0)}_clippingChanged(){this._updateClippingExtent()&&this._updateRootTiles()}get lodBias(){const e=this.view.resourceController.memoryController.memoryFactor;return this.view.qualitySettings.tiledSurface.lodBias-2.5*(1-e)}_getLodBiasCorrectedScale(e){const t=this.tilingScheme.levels,i=(0,v.o)(e-this.lodBias,0,t.length-1),r=i-Math.floor(i);return t[Math.floor(i)].scale*(1-r)+t[Math.ceil(i)].scale*r}_removeAllTiles(){this.rootTiles&&(this.rootTiles.forEach((e=>this._purgeTile(e))),this._setRootTiles(null),this.notifyChange("ready")),this._allTiles.clear(),this.visible=!1}_purgeChildTiles(e){if(e.isLeaf)return!1;let t=this._purgeTile(e.children[0]);return t=this._purgeTile(e.children[1])||t,t=this._purgeTile(e.children[2])||t,t=this._purgeTile(e.children[3])||t,e.unsetChildren(),t}_purgeTile(e){const t=this._purgeChildTiles(e)||e.rendered;return this._allTiles.removeUnordered(e),e.unload(this._renderer),this._tilePool.release(e),t}_splitTile(e){XS(e.isLeaf,"tile that is already split should not be split again!");const t=e.level+1,i=2*e.lij[1],r=2*e.lij[2];e.setChildren(this._createTile(t,i,r,e),this._createTile(t,i,r+1,e),this._createTile(t,i+1,r,e),this._createTile(t,i+1,r+1,e)),e.setPendingUpdate(16),e.updateAgentSuspension(),this._allTiles.pushArray(e.children),this._allTilesDirty=!0,this._emitTileScaleChange(e,t),++this._performanceInfo.numSplit}_emitTileScaleChange(e,t=e.level){bM.spatialReference=this.spatialReference,bM.extent=e.extent,bM.scale=this._getLodBiasCorrectedScale(t),this.emit("scale-change",bM)}_createTile(e,t,i,r){XS(!!r,"_createTile sanity check");const s=this._acquireTile(e,t,i,r);return s.updateClippingStatus(this._clippingExtent),s.loadable&&(s.updateScreenDepth(this._viewProjectionMatrix),2===s.shouldSplit(this._splitLimits,this._eyePosRenderSR,this.lodSnapping)&&s.setPendingUpdate(2)),s}_mergeTile(e){XS(!e.hasPendingUpdate(2),"_mergeTile sanity check"),this._purgeChildTiles(e)&&(XS(!e.renderData,"_mergeTile sanity check"),this._loadTile(e)),this._allTilesDirty=!0,++this._performanceInfo.numMerged,this._emitTileScaleChange(e)}_loadChildren(e){XS(e.rendered,"parent should be rendered"),e.unload(this._renderer),this._loadTile(e.children[0]),this._loadTile(e.children[1]),this._loadTile(e.children[2]),this._loadTile(e.children[3])}_loadParent(e){const t=e.parent;this._unloadChildren(t),this._loadTile(t)}_unloadChildren(e){e.isLeaf||(this._unloadChildren(e.children[0]),e.children[0].unload(this._renderer),this._unloadChildren(e.children[1]),e.children[1].unload(this._renderer),this._unloadChildren(e.children[2]),e.children[2].unload(this._renderer),this._unloadChildren(e.children[3]),e.children[3].unload(this._renderer))}_loadTile(e){e.load(this._renderer),e.setPendingUpdate(16),this.requestUpdate(),this.overlayManager&&this.overlayManager.hasOverlays&&this.overlayManager.setTileParameters(e),this._elevationUpdate(e)}_elevationDataArrived(e,t,i){const r=new oR(e.lij,e.extent,i);e.dataArrived(t,0,r);const s=[e],n=e.level,a=this._iteratorPool.acquire();for(a.reset(s);!a.done;){const e=a.next();e.findElevationBoundsForLayer(t,n),e.computeElevationBounds()}a.remove(),this._updateTileVisibility(s)}_handleLayerViewChanges(e=cu){if(!this._layerViewsDirty)return;this._layerViewsDirty=!1;let t=!1;const i=new Set;let r=-1;for(const e of this.view.allLayerViews.items)if(i.add(e.uid),aP(e))if(this._basemapLayerViewHandles.has(e.uid)){const i=this.layerClassFromLayerView(e),s=this._layerIndexByUid[i].get(e.uid);s<r&&(t=!0),r=s}else this._registerTiledLayerView(e),e.layer.loaded&&(t=!0);this._basemapLayerViewHandles.forEach(((e,r)=>{i.has(r)||(this._unregisterTiledLayerView(r),t=!0)})),t&&this._updateTiledLayers(),this._renderer.isTransparent=this._allTransparentSurfaceLayers(),e.madeProgress()}_allTransparentSurfaceLayers(){let e=0===this.view.map.ground.opacity;for(const t of this.view.allLayerViews.items)if(aP(t)&&!nP(t)&&!Bt(t.layer)&&0!==t.fullOpacity)return e=!1,e;return e}layerClassFromLayerView(e){return nP(e)?0:1}_registerTiledLayerView(e){const t=[],i=this.layerClassFromLayerView(e);t.push(e.watch("suspended",(()=>this._updateTiledLayers()))),t.push(e.watch("fullOpacity",(()=>this._updateTileTextures(!1)))),t.push(e.layer.watch("scaleRangeId",(()=>this._restartAllAgents(i)))),e.on("data-changed",(()=>{const t=this._layerIndexByUid[i].get(e.uid);null!=t&&this._invalidateLayerData(t,i)})),this._basemapLayerViewHandles.set(e.uid,t)}_unregisterTiledLayerView(e){const t=this._basemapLayerViewHandles.get(e);if(t){for(let e=0;e<t.length;e++)t[e].remove();this._basemapLayerViewHandles.delete(e)}}_updateTiledLayers(){if(!this.tilingScheme||this.view.suspended)return;const e=this.view.allLayerViews,t=[[],[]];let i=null;const r=(0,b.B)();e.forEach((e=>{const s=e.layer;if(!s||e.suspended||!aP(e))return;const n=e.fullExtent;if(!n)return void hM.warn("Terrain: Map or elevation layer does not have fullExtent: "+s.id);if(!this.tilingScheme.compatibleWith(e.tileInfo))return void hM.warn("Terrain: tiling scheme of layer "+s.id+" is incompatible with other tiled layers, will not be drawn");(0,b.c)(r,n);const a=this.layerClassFromLayerView(e);if(1===a){const t=e.displayLevelRange;t.maxLevel!==1/0&&(null===i||t.maxLevel>i)&&(i=t.maxLevel)}t[a].push(e)}));for(const e of Zt){const i=this._layerViews[e],r=t[e];r.reverse();const s=r.length;let n=i.length!==s;const a=new Array(s),o=new Array(i.length);this._layerIndexByUid[e].clear();for(let t=0;t<s;t++){const s=r[t].uid;this._layerIndexByUid[e].set(s,t);const l=i.indexOf(r[t]);a[t]=l,t!==l&&(n=!0),l>-1&&(o[l]=t)}if(n){const t=this._postorderIterator;for(t.reset(this.rootTiles);!t.done;)t.next().modifyLayers(o,a,e);this._layerViews[e]=r,this._restartAllAgents(e),this._updateTileVisibility(this.rootTiles)}}this.tilingScheme.ensureMaxLod(i)&&this._viewChangeUpdate()}_restartAllAgents(e){const t=this._postorderIterator;for(t.reset(this.rootTiles);!t.done;){const i=t.next();i.restartAgents(e),0===e&&i.computeElevationBounds()}}_hasFixedExtent(){return!!this._clippingExtent}layerViewByIndex(e,t){return this._layerViews[t][e]}numLayers(e){return this._layerViews[e].length}_updateTileTextures(e){this._allTiles.forAll((t=>{t.updateAgents(1),e?this.renderer.updateTileTexture(t):t.updateRenderData(1)})),this._renderer.isTransparent=this._allTransparentSurfaceLayers()}_invalidateLayerData(e,t){this._allTiles.forAll((i=>i.removeLayerAgent(e,t))),this._allTiles.forAll((i=>i.invalidateLayerData(e,t)))}setTileTreeDirty(){this._allTilesDirty=!0}requestRender(e=1){this.renderer.setNeedsRender(e)}requestUpdate(){1==++this._pendingUpdates&&(this._hasPendingUpdates=!0)}requestTileData(e,t,i,r){const s=this.layerViewByIndex(t,i),n=s.layer;return!n.tilemapCache||sP(s)?this._requestTileData(e,i,s,r):(++this._asyncWorkItems,n.tilemapCache.fetchAvailability(e.lij[0],e.lij[1],e.lij[2],{...r,timeout:6e3}).then((()=>--this._asyncWorkItems)).catch((t=>{throw--this._asyncWorkItems,(0,h.g)(t)||this._dataMissing(e,i,s,{notInTilemap:!0}),t})).then((()=>this._frameTask.schedule((()=>this._requestTileData(e,i,s,r)),r.signal))))}_requestTileData(e,t,i,r){return 0===t?this._requestElevationTileData(e,i,r):this._requestMapTileData(e,i,r)}_requestElevationTileData(e,t,i){if(!nP(t))return void XS(!1,"_requestElevationTileData can only be called for elevation layer views");const r=r=>{if(--this._asyncWorkItems,(0,h.b)(i))return;const s=this._layerIndexByUid[0].get(t.uid);null!=s?(this._usedMemory=fM,this.requestUpdate(),this._elevationDataArrived(e,s,r)):hM.warn("TerrainSurface: received data from unknown layer %d %s",0,e.lij.toString())},s=i=>{--this._asyncWorkItems,(0,h.g)(i)||(this._dataMissing(e,0,t,i),this.requestUpdate())};if(++this._asyncWorkItems,hP(t.layer))return t.layer.fetchTile(e.lij[0],e.lij[1],e.lij[2],{noDataValue:Yt,signal:i.signal}).then((e=>{if((0,h.b)(i))return hM.warnOnce("A call to fetchTile resolved even though the request was aborted. fetchTile should not resolve if options.signal.aborted is true."),void s((0,h.m)());this._frameTask.schedule((()=>r(e)),i.signal)}),s);const n=t.getTileUrl(e.lij[0],e.lij[1],e.lij[2]);return this._elevationDataRequester.request(n,"binary",i).then((e=>this._lercDecoder.decode(e,{noDataValue:Yt},i.signal))).then((e=>{r({values:e.pixelData,width:e.width,height:e.height,noDataValue:e.noDataValue,minValue:e.minValue,maxValue:e.maxValue})}),s)}_requestMapTileData(e,t,i){if(t instanceof sR)return Promise.reject();++this._asyncWorkItems;const r=(r,s)=>{--this._asyncWorkItems,cP(s),(0,h.b)(i)||(this._dataMissing(e,1,t,r),this.requestUpdate())},s=e=>t=>r(t,e),n=r=>this._frameTask.schedule((()=>{--this._asyncWorkItems,this.requestUpdate(),(0,h.b)(i)?cP(r):this._mapTileDataArrived(e,t,r)}),i.signal,s(r)).catch(s(r)),a=(e,t=null)=>this._frameTask.schedule((()=>r(e,t))).catch(s(t));if(sP(t)){const r=t.schemaHelper.getLevelRowColumn(e.lij);return t.fetchTile(r[0],r[1],r[2],i).then(n,a)}if(iP(t))return t.fetchTile(e.lij[0],e.lij[1],e.lij[2],i).then(n,a);if(rP(t)&&hP(t.layer))return t.layer.fetchTile(e.lij[0],e.lij[1],e.lij[2],i).then((e=>{if((0,h.b)(i))return hM.warnOnce("A call to fetchTile resolved even though the request was aborted. fetchTile should not resolve if options.signal.aborted is true."),void a((0,h.m)());n(e)}),a);let o=t.getTileUrl(e.lij[0],e.lij[1],e.lij[2]);(function(e){return null!=e.refreshInterval})(t)&&t.refreshTimestamp&&(o+=`${o.indexOf("?")>-1?"&":"?"}_ts=${t.refreshTimestamp}`);const l=t.hasMixedImageFormats?"image+type":"image";return this._mapDataRequester.request(o,l,i).then(n,a)}_mapTileDataArrived(e,t,i){const r=this._layerIndexByUid[1].get(t.uid);null!=r?e.dataArrived(r,1,i):(cP(i),hM.warn("TerrainSurface: received data from unknown layer"))}_dataMissing(e,t,i,r){const s=this._layerIndexByUid[t].get(i.uid);null!=s?e.dataMissing(s,t,r):hM.warn("TerrainSurface: received data from unknown layer")}updateTileOverlayParams(){this.rootTiles&&this.overlayManager&&(this._allTiles.forAll((e=>{e.renderData&&this.overlayManager.setTileParameters(e)})),this._renderer.setNeedsRender())}updateOverlayOpacity(){if(!this.overlayManager)return;const e=this._eyePosSurfaceSR[2],t=this.overlayManager.computeOpacity(e);this._overlayOpacity!==t&&(this._overlayOpacity=t,this._renderer.overlayOpacity=t,this._renderer.setNeedsRender())}get performanceInfo(){const e=this._performanceInfo;return e.numNodes=this._allTiles.length,e.numLeaves=e.numVisible=e.numRendered=e.numLoadedPerLevel.length=e.numRenderedPerLevel.length=0,this._allTiles.forAll((t=>{t.isLeaf&&e.numLeaves++;const i=t.level;t.renderData&&(e.numLoadedPerLevel[i]=(e.numLoadedPerLevel[i]||0)+1),t.visible&&(e.numVisible++,t.rendered&&(e.numRenderedPerLevel[i]=(e.numRenderedPerLevel[i]||0)+1,e.numRendered++))})),e}getUsedMemory(){return this.tilingScheme?(this._usedMemory===fM&&(this._usedMemory=0,this._allTiles.forAll((e=>this._usedMemory+=e.usedMemory))),this._usedMemory):0}getUsedMemoryForLayerView(e){let t=0;const i=this.layerClassFromLayerView(e),r=this._layerIndexByUid[i].get(e.uid);return this._allTiles.forAll((e=>t+=e.getUsedMemoryForLayer(i,r))),t}getTile(e){if((0,u.t)(e))return null;const t=e.split("/").map((e=>+e));if(0===t[0])return this.rootTiles.find((e=>e.lij[1]===t[1]&&e.lij[2]===t[2]));const i=2**t[0],r=Math.floor(t[1]/i),s=Math.floor(t[2]/i);let n;if(this.rootTiles.some((e=>e.lij[1]===r&&e.lij[2]===s&&(n=e,!0))),n){let e=1<<t[0]-1;for(;n.lij[0]<t[0];){let i=t[1]&e?2:0;if((t[2]&e)>0&&i++,!n.children[i])return null;n=n.children[i],e>>=1}return XS(n.lij[0]===t[0]&&n.lij[1]===t[1]&&n.lij[2]===t[2],"not the right tile?"),n}return null}get test(){const e=this;return{renderer:e._renderer,lercDecoder:e._lercDecoder,forceReload:()=>{e._mergeTile(e.rootTiles[0]),e._viewChangeUpdate()},getTiles:()=>e._allTiles.toArray(),getRenderedTiles:()=>(_M.clear(),e._allTiles.forAll((e=>{e.visible&&e.rendered&&_M.push(e)})),qR(e.renderOrder,_M),_M.toArray())}}};(0,r.e)([(0,d.y)()],dM.prototype,"_renderer",void 0),(0,r.e)([(0,d.y)()],dM.prototype,"_hasPendingUpdates",void 0),(0,r.e)([(0,d.y)()],dM.prototype,"_asyncWorkItems",void 0),(0,r.e)([(0,d.y)()],dM.prototype,"_allTilesDirty",void 0),(0,r.e)([(0,d.y)()],dM.prototype,"_allTilesSorted",void 0),(0,r.e)([(0,d.y)()],dM.prototype,"_viewChanged",void 0),(0,r.e)([(0,d.y)({readOnly:!0})],dM.prototype,"_watchUpdatingTracking",void 0),(0,r.e)([(0,d.y)()],dM.prototype,"_frameTask",void 0),(0,r.e)([(0,d.y)({readOnly:!0})],dM.prototype,"snapLevel",null),(0,r.e)([(0,d.y)({readOnly:!0})],dM.prototype,"lodSnapping",null),(0,r.e)([(0,d.y)({constructOnly:!0})],dM.prototype,"view",void 0),(0,r.e)([(0,Se.o)("_renderer.cullBackFaces")],dM.prototype,"cullBackFaces",void 0),(0,r.e)([(0,d.y)({readOnly:!0,dependsOn:[]})],dM.prototype,"extent",null),(0,r.e)([(0,d.y)({readOnly:!0})],dM.prototype,"updating",null),(0,r.e)([(0,d.y)(tR)],dM.prototype,"updatingProgress",void 0),(0,r.e)([(0,d.y)({readOnly:!0})],dM.prototype,"updatingProgressValue",null),(0,r.e)([(0,d.y)()],dM.prototype,"_maxNumUpdating",void 0),(0,r.e)([(0,d.y)({aliasOf:"view.map.ground.opacity"})],dM.prototype,"baseOpacity",void 0),(0,r.e)([(0,d.y)({readOnly:!0})],dM.prototype,"overlayManager",void 0),(0,r.e)([(0,d.y)({readOnly:!0})],dM.prototype,"viewingMode",null),(0,r.e)([(0,d.y)()],dM.prototype,"maxTextureScale",void 0),(0,r.e)([(0,d.y)({readOnly:!0})],dM.prototype,"ready",null),(0,r.e)([(0,d.y)({value:1})],dM.prototype,"renderOrder",null),(0,r.e)([(0,d.y)({readOnly:!0})],dM.prototype,"rootTiles",void 0),(0,r.e)([(0,d.y)({readOnly:!0})],dM.prototype,"spatialReference",null),(0,r.e)([(0,d.y)()],dM.prototype,"backgroundImage",void 0),(0,r.e)([(0,d.y)({type:z.o,aliasOf:"view.map.ground.surfaceColor"})],dM.prototype,"backgroundColor",void 0),(0,r.e)([(0,d.y)()],dM.prototype,"_background",null),(0,r.e)([(0,d.y)({value:!1})],dM.prototype,"slicePlaneEnabled",null),(0,r.e)([(0,d.y)({readOnly:!0})],dM.prototype,"tilingScheme",void 0),(0,r.e)([(0,d.y)({readOnly:!0,aliasOf:"tilingSchemeLogic.tilingSchemeLocked"})],dM.prototype,"tilingSchemeLocked",void 0),(0,r.e)([(0,d.y)({readOnly:!0,aliasOf:"tilingSchemeLogic.tilingSchemeDone"})],dM.prototype,"tilingSchemeDone",void 0),(0,r.e)([(0,d.y)({readOnly:!0})],dM.prototype,"tilingSchemeLogic",void 0),(0,r.e)([(0,d.y)({value:!0})],dM.prototype,"velvetOverground",null),(0,r.e)([(0,Se.o)("_renderer.wireframe")],dM.prototype,"wireframe",void 0),(0,r.e)([(0,d.y)({value:!1})],dM.prototype,"suspended",null),(0,r.e)([(0,d.y)({readOnly:!0,aliasOf:"view.qualitySettings.tiledSurface.textureFadeDuration"})],dM.prototype,"textureFadeDuration",void 0),(0,r.e)([(0,d.y)()],dM.prototype,"_layerViewsDirty",void 0),(0,r.e)([(0,Se.o)("_renderer.renderPatchBorders")],dM.prototype,"renderPatchBorders",void 0),(0,r.e)([(0,Se.o)("_renderer.renderingDisabled")],dM.prototype,"renderingDisabled",void 0),dM=(0,r.e)([(0,d.n)("esri.views.3d.terrain.TerrainSurface")],dM);var uM=dM;function pM(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]}function mM(e){return!e.isLeaf&&(e.children[0].shouldLoad||e.children[1].shouldLoad||e.children[2].shouldLoad||e.children[3].shouldLoad||mM(e.children[0])||mM(e.children[1])||mM(e.children[2])||mM(e.children[3]))}const fM=-1,gM=(0,w.n)(),vM=(0,b.i)(),yM=[0,0,0],_M=new r.f,xM={spatialReference:null,tile:null,extent:null,context:"ground"},bM={spatialReference:null,extent:null,scale:0};let wM=class extends r.p{constructor(e){super(e),this._residentGeomRecords=new Map,this._dirtyGeomRecords=new Map,this.dirty=!1}commit(e){this.dirty=!1,this._dirtyGeomRecords.forEach(((t,i)=>this.commitLayer(i,e)))}commitLayer(e,t){const i=this._dirtyGeomRecords.get(e);i&&(i.forEach(((i,r)=>{const s=this._ensureGeomRecord(e,r);i.forEach(((e,i)=>{const n=e[0],a=e[1],o=e[2];let l=!1;if(2&a){const e=s.get(i);if(e){const i=e[1];if(4&o){const e=this.model.getObject(r);this.model.updateRenderGeometryTransformation(e,n,i)&&(l=!0)}l||t.updates.push({renderGeometry:i,updateType:o})}else(0,S.i)(!1,"ModelDirtySet.getAddRemoveListFilteredByLayers: invalid update")}if(4&a||l){const e=s.get(i);e?(t.removes.push(e[1]),s.delete(i),e[0].disposed&&Hs.pool.release(e[0])):4===a&&(0,S.i)(!1,"ModelDirtySet.getAddRemoveListFilteredByLayers: invalid remove")}if(1&a||l){const e=this.model.getObject(r),a=this.model.getRenderGeometry(e,n),o=[n,a];t.adds.push(a),s.set(i,o)}})),0===s.size&&this._residentGeomRecords.get(e).delete(r)})),0===this._residentGeomRecords.get(e).size&&this._residentGeomRecords.delete(e),this._dirtyGeomRecords.delete(e))}getResidentRenderGeometries(e,t){const i=this._residentGeomRecords.get(e);i&&i.forEach((e=>e.forEach((e=>t.push(e[1])))))}_objectStateChanged(e,t){for(const i of t.geometryRecords)this._updateOrCreateDirtyRecord(t,i,null,2,0,0,2,5,e)}visibilityChanged(e){this._objectStateChanged(1,e)}highlightChanged(e){this._objectStateChanged(8,e)}occlusionChanged(e){this._objectStateChanged(16,e)}vertexAttrsUpdated(e){this._updateOrCreateDirtyRecord(e.object,e.record,null,2,0,0,2,5,2)}layerAdded(e){e.objects.forAll((t=>this._layerObjectAdded(e,t)))}layerRemoved(e){e.objects.forAll((t=>this._layerObjectRemoved(e,t)))}layerObjectAdded(e){this._layerObjectAdded(e.layer,e.object)}_layerObjectAdded(e,t){const i=e.id,r=t.geometryRecords;for(let e=0;e<r.length;e++)this._objectGeometryAdded(t,r[e],i)}layerObjectRemoved(e){this._layerObjectRemoved(e.layer,e.object)}layerObjectsAdded(e){for(const t of e.objects)this._layerObjectAdded(e.layer,t)}layerObjectsRemoved(e){for(const t of e.objects)this._layerObjectRemoved(e.layer,t)}_layerObjectRemoved(e,t){const i=e.id,r=t.geometryRecords;for(let e=0;e<r.length;e++)this._objectGeometryRemoved(t,r[e],i)}shaderTransformationChanged(e){const t=this._residentGeomRecords.get(e.id);t&&t.forEach(((e,t)=>{const i=this.model.getObject(t);i&&i.hasVolativeTransformation()&&e.forEach((e=>{e[1].shaderTransformationChanged()}))}))}objectTransformation(e){const t=this._getParentLayerId(e),i=e.id;this._ensureGeomRecord(t,i).forEach((i=>{this._updateOrCreateDirtyRecord(e,i[0],t,2,0,0,2,5,4)}))}objectGeometryAdded(e){this._objectGeometryAdded(e.object,e.record)}_objectGeometryAdded(e,t,i=null){this._updateOrCreateDirtyRecord(e,t,i,1,4,0,0,0)}objectGeometryRemoved(e){this._objectGeometryRemoved(e.object,e.record)}_objectGeometryRemoved(e,t,i=null){this._updateOrCreateDirtyRecord(e,t,i,4,1,2,0,0)}_updateOrCreateDirtyRecord(e,t,i,r,s,n,a,o,l){i=(0,u.q)(i,this._getParentLayerId(e));const c=e.id,h=t.id,d=this._ensureDirtyRecord(i,c),p=d.get(h);if(p){const e=p[1];e&s?(d.delete(h),p[0].disposed&&Hs.pool.release(p[0])):e&n?(p[1]=r,p[2]=l):e&a?p[2]|=l:e&o||(0,S.i)(!1,"ModelDirtySet.objectGeometryAdded: inconsistent state")}else d.set(h,[t,r,l]);this.dirty=this._hasDirtyGeometryRecords}_ensureGeomRecord(e,t){let i=this._residentGeomRecords.get(e);i||(i=new Map,this._residentGeomRecords.set(e,i));let r=i.get(t);return r||(r=new Map,i.set(t,r)),r}get _hasDirtyGeometryRecords(){return(0,s.g)(this._dirtyGeomRecords,(e=>(0,s.g)(e,(e=>e&&e.size>0))))}_ensureDirtyRecord(e,t){let i=this._dirtyGeomRecords.get(e);i||(i=new Map,this._dirtyGeomRecords.set(e,i));let r=i.get(t);return r||(r=new Map,i.set(t,r)),r}_getParentLayerId(e){return(0,u.r)(e.parentLayer)?e.parentLayer.id:Q.n}formatDebugInfo(){const e=["ADD","UPD",void 0,"REM"];let t="";return this._dirtyGeomRecords.forEach(((i,r)=>{i.forEach(((i,s)=>{t.length>0&&(t+="\n"),t+=r+"."+s;const n=[];i.forEach((e=>{const t=e[1];n[t]||(n[t]=[]),n[t].push(e[0].geometry.id)}));for(let i=0;i<n.length;i++)if(n[i]){t+=" "+e[i-1]+": ";for(let e=0;e<n[i].length;e++)t+=n[i][e]+", "}}))})),t}get test(){const e=this;return{get residentLayerCount(){return e._residentGeomRecords.size},get residentObjectCount(){return Array.from(e._residentGeomRecords.values()).reduce(((e,t)=>e+t.size),0)}}}};(0,r.e)([(0,d.y)({constructOnly:!0})],wM.prototype,"model",void 0),(0,r.e)([(0,d.y)()],wM.prototype,"dirty",void 0),wM=(0,r.e)([(0,d.n)("esri.views.3d.webgl-engine.lib.ModelDirtySet")],wM);var CM=wM;const TM=S.i,SM=S.bq;let PM=class extends r.p{constructor(){super(),this.dirtySet=new CM({model:this}),this._id2origin=new Map,this._content=new Map}getObject(e){return this._content.get(e)}add(e){const t=e.id;TM(!this._content.has(t),"Model/Stage already contains object to be added"),this._content.set(t,e),af(e)&&this.dirtySet.layerAdded(e)}remove(e){TM(this._content.has(e.id),"Model/Stage doesn't contain object to be removed"),this._content.delete(e.id),e.unload(),af(e)&&this.dirtySet.layerRemoved(e)}addMany(e){for(const t of e)TM(!this._content.has(t.id),"Model/Stage already contains object to be added"),this._content.set(t.id,t)}removeMany(e){for(const t of e)TM(this._content.has(t.id),"Model/Stage doesn't contain object to be removed"),this._content.delete(t.id),t.unload()}forEachOfType(e,t){this._content.forEach((i=>{i.type===e&&t(i)}))}_getOrigin(e){let t=0;const i=10*e[3]/1e4;i>1&&(t=Math.ceil(SM(i,2)));const r=2**t*1e4,s=Math.round(e[0]/r),n=Math.round(e[1]/r),a=Math.round(e[2]/r),o=t+"_"+s+"_"+n+"_"+a;let l=this._id2origin.get(o);return null==l&&(l=xm(s*r,n*r,a*r,o),this._id2origin.set(o,l)),l}getRenderGeometry(e,t){const{geometry:i,material:r,id:s,shaderTransformation:n,origin:a,instanceParameters:o}=t,l=new py(i,r,null,null,s,i.boundingInfo,n,e.castShadow);return l.updateTransformation((i=>e.getCombinedStaticTransformation(t,i))),l.origin=a||this._getOrigin(l.boundingSphere),l.instanceParameters=o,l}updateRenderGeometryTransformation(e,t,i){i.updateTransformation((i=>e.getCombinedStaticTransformation(t,i)));const r=this._getOrigin(i.boundingSphere);return i.origin!==r}getStats(){const e={},t=Array.from(this._content.values());for(let i=0;i<5;++i)e[i]=t.filter((e=>e.type===i)).length;return{contentTypes:e,dirtySet:this.dirtySet.formatDebugInfo()}}get test(){return{content:Array.from(this._content.values())}}};(0,r.e)([(0,d.y)({constructOnly:!0})],PM.prototype,"dirtySet",void 0),PM=(0,r.e)([(0,d.n)("esri.views.3d.webgl-engine.parts.Model")],PM);const RM=1e-6,AM=[0,0,0],MM=[0,0,0];const OM=[0,0,0],DM=[0,0,0],EM=[0,0,0],zM=[0,0,0],IM=[0,0,0],LM=[0,0,0],FM=[0,0,0],VM=[0,0,0],UM=[0,0,0],GM=[0,0],BM=[0,0,0],qM=[0,0,0],kM=[0,0,0],NM=[0,0,0],jM=[0,0,0],HM=[0,0,0];function WM(e,t,i,r,s,n){if(gO(t)<RM)return;mO(BM,i,t),mO(qM,r,t),mO(kM,s,t),ZM(e,t,GM),jM[1]=GM[0],NM[1]=GM[1],HM[1]=NM[1]-jM[1];const a=[i,r,s],o=[BM,qM,kM];for(let i=0;i<3;++i){ZM(e,a[i],GM),jM[0]=GM[0],NM[0]=GM[1],ZM(e,o[i],GM),jM[2]=GM[0],NM[2]=GM[1],HM[0]=NM[0]-jM[0],HM[2]=NM[2]-jM[2];const r=cO(HM);r<n.quality&&(pO(n.b0,a[i]),pO(n.b1,t),pO(n.b2,o[i]),n.quality=r)}}const QM=[0,0,0];function ZM(e,t,i){const{data:r,size:s}=e;i[0]=Number.POSITIVE_INFINITY,i[1]=Number.NEGATIVE_INFINITY;for(let e=0;e<r.length;e+=s){const s=r[e]*t[0]+r[e+1]*t[1]+r[e+2]*t[2];i[0]=Math.min(i[0],s),i[1]=Math.max(i[1],s)}}function YM(e,t,i){pO(i.center,e),uO(i.halfSize,t,.5),i.quaternion[0]=0,i.quaternion[1]=0,i.quaternion[2]=0,i.quaternion[3]=1}const XM=[0,0,0],$M=[0,0,0],KM=[0,0,0],JM=[0,0,0],eO=[0,0,0],tO=[0,0,0];function iO(e,t,i,r,s,n){ZM(e,t,GM),s[0]=GM[0],n[0]=GM[1],ZM(e,i,GM),s[1]=GM[0],n[1]=GM[1],ZM(e,r,GM),s[2]=GM[0],n[2]=GM[1]}const rO=[0,0,0],sO=[1,0,0,0,1,0,0,0,1],nO=[0,0,0];function aO(e,t,i,r,s,n,a){sO[0]=e[0],sO[1]=e[1],sO[2]=e[2],sO[3]=t[0],sO[4]=t[1],sO[5]=t[2],sO[6]=i[0],sO[7]=i[1],sO[8]=i[2],function(e,t){const i=t[0]+t[4]+t[8];if(i>0){let r=Math.sqrt(i+1);e[3]=.5*r,r=.5/r,e[0]=(t[5]-t[7])*r,e[1]=(t[6]-t[2])*r,e[2]=(t[1]-t[3])*r}else{let i=0;t[4]>t[0]&&(i=1),t[8]>t[3*i+i]&&(i=2);const r=(i+1)%3,s=(i+2)%3;let n=Math.sqrt(t[3*i+i]-t[3*r+r]-t[3*s+s]+1);e[i]=.5*n,n=.5/n,e[3]=(t[3*r+s]-t[3*s+r])*n,e[r]=(t[3*r+i]+t[3*i+r])*n,e[s]=(t[3*s+i]+t[3*i+s])*n}}(a.quaternion,sO),hO(nO,r,s),uO(nO,nO,.5),uO(a.center,e,nO[0]),uO(rO,t,nO[1]),hO(a.center,a.center,rO),uO(rO,i,nO[2]),hO(a.center,a.center,rO),uO(a.halfSize,n,.5)}class oO{constructor(e){this.minVert=new Array(7),this.maxVert=new Array(7),this.buffer=new ArrayBuffer(448);let t=0;this.minProj=new Float64Array(this.buffer,t,7),t+=56,this.maxProj=new Float64Array(this.buffer,t,7),t+=56;for(let e=0;e<7;++e)this.minVert[e]=new Float64Array(this.buffer,t,3),t+=24;for(let e=0;e<7;++e)this.maxVert[e]=new Float64Array(this.buffer,t,3),t+=24;for(let e=0;e<7;++e)this.minProj[e]=Number.POSITIVE_INFINITY,this.maxProj[e]=Number.NEGATIVE_INFINITY;const i=new Array(7),r=new Array(7),{data:s,size:n}=e;for(let e=0;e<s.length;e+=n){let t=s[e];t<this.minProj[0]&&(this.minProj[0]=t,i[0]=e),t>this.maxProj[0]&&(this.maxProj[0]=t,r[0]=e),t=s[e+1],t<this.minProj[1]&&(this.minProj[1]=t,i[1]=e),t>this.maxProj[1]&&(this.maxProj[1]=t,r[1]=e),t=s[e+2],t<this.minProj[2]&&(this.minProj[2]=t,i[2]=e),t>this.maxProj[2]&&(this.maxProj[2]=t,r[2]=e),t=s[e]+s[e+1]+s[e+2],t<this.minProj[3]&&(this.minProj[3]=t,i[3]=e),t>this.maxProj[3]&&(this.maxProj[3]=t,r[3]=e),t=s[e]+s[e+1]-s[e+2],t<this.minProj[4]&&(this.minProj[4]=t,i[4]=e),t>this.maxProj[4]&&(this.maxProj[4]=t,r[4]=e),t=s[e]-s[e+1]+s[e+2],t<this.minProj[5]&&(this.minProj[5]=t,i[5]=e),t>this.maxProj[5]&&(this.maxProj[5]=t,r[5]=e),t=s[e]-s[e+1]-s[e+2],t<this.minProj[6]&&(this.minProj[6]=t,i[6]=e),t>this.maxProj[6]&&(this.maxProj[6]=t,r[6]=e)}for(let e=0;e<7;++e){let t=i[e];pO(this.minVert[e],s,t),t=r[e],pO(this.maxVert[e],s,t)}}}class lO{constructor(){this.b0=[1,0,0],this.b1=[0,1,0],this.b2=[0,0,1],this.quality=0}}function cO(e){return e[0]*e[1]+e[0]*e[2]+e[1]*e[2]}function hO(e,t,i){e[0]=t[0]+i[0],e[1]=t[1]+i[1],e[2]=t[2]+i[2]}function dO(e,t,i){e[0]=t[0]-i[0],e[1]=t[1]-i[1],e[2]=t[2]-i[2]}function uO(e,t,i){e[0]=t[0]*i,e[1]=t[1]*i,e[2]=t[2]*i}function pO(e,t,i=0){e[0]=t[i+0],e[1]=t[i+1],e[2]=t[i+2]}function mO(e,t,i){const r=t[0],s=t[1],n=t[2],a=i[0],o=i[1],l=i[2];e[0]=s*l-n*o,e[1]=n*a-r*l,e[2]=r*o-s*a}function fO(e,t){const i=t[0]*t[0]+t[1]*t[1]+t[2]*t[2];if(i>0){const r=1/Math.sqrt(i);e[0]=t[0]*r,e[1]=t[1]*r,e[2]=t[2]*r}}function gO(e){return e[0]*e[0]+e[1]*e[1]+e[2]*e[2]}function vO(e,t){const i=t[0]-e[0],r=t[1]-e[1],s=t[2]-e[2];return i*i+r*r+s*s}function yO(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]}const _O=(0,X.a)(),xO=(0,v.n)(),bO=(0,v.n)(),wO=(0,X.e)();class CO{constructor(e){const t=56*e;this.buffer=new ArrayBuffer(t),this.obbs=new Array(e);for(let t=0;t<e;t++)this.obbs[t]={center:(0,v.Y)(this.buffer,56*t+0),halfSize:(0,B.a)(this.buffer,56*t+24),quaternion:(0,Ae.t)(this.buffer,56*t+36)}}}function TO(e=[0,0,0],t=[-1,-1,-1],i=[0,0,0,1]){return{center:(0,v.k)(e),halfSize:(0,B.r)(t),quaternion:(0,Ae.n)(i)}}function SO(e){return TO(e.center,e.halfSize,e.quaternion)}function PO(e,t){(0,v.h)(t.center,e.center),(0,v.h)(t.halfSize,e.halfSize),(0,X.F)(t.quaternion,e.quaternion)}function RO(e,t){return function(e,t){const{data:i,size:r}=e,s=i.length/r;if(s<=0)return;const n=new oO(e);hO(AM,n.minProj,n.maxProj),uO(AM,AM,.5),dO(MM,n.maxProj,n.minProj);const a=cO(MM),o=new lO;o.quality=a,s<14&&(e={data:new Float64Array(n.buffer,112,42),size:3});const l=[0,0,0],c=[0,0,0],h=[0,0,0],d=[0,0,0],u=[0,0,0],p=[0,0,0],m=[0,0,0];switch(function(e,t,i,r,s,n,a,o,l,c){return function(e,t,i){let r=vO(e.maxVert[0],e.minVert[0]),s=0;for(let t=1;t<7;++t){const i=vO(e.maxVert[t],e.minVert[t]);i>r&&(r=i,s=t)}pO(t,e.minVert[s]),pO(i,e.maxVert[s])}(e,r,s),vO(r,s)<RM?1:(dO(a,r,s),fO(a,a),function(e,t,i,r){const{data:s,size:n}=e;let a=Number.NEGATIVE_INFINITY,o=0;for(let e=0;e<s.length;e+=n){UM[0]=s[e]-t[0],UM[1]=s[e+1]-t[1],UM[2]=s[e+2]-t[2];const r=i[0]*UM[0]+i[1]*UM[1]+i[2]*UM[2],n=i[0]*i[0]+i[1]*i[1]+i[2]*i[2],l=UM[0]*UM[0]+UM[1]*UM[1]+UM[2]*UM[2]-r*r/n;l>a&&(a=l,o=e)}return pO(r,s,o),a}(t,r,a,n)<RM?2:(dO(o,s,n),fO(o,o),dO(l,n,r),fO(l,l),mO(i,o,a),fO(i,i),WM(t,i,a,o,l,c),0))}(n,e,m,l,c,h,d,u,p,o)){case 1:return void YM(AM,MM,t);case 2:return void function(e,t,i){pO(XM,t),Math.abs(t[0])>Math.abs(t[1])&&Math.abs(t[0])>Math.abs(t[2])?XM[0]=0:Math.abs(t[1])>Math.abs(t[2])?XM[1]=0:XM[2]=0,gO(XM)<RM&&(XM[0]=XM[1]=XM[2]=1),mO($M,t,XM),fO($M,$M),mO(KM,t,$M),fO(KM,KM),iO(e,t,$M,KM,JM,eO),dO(tO,eO,JM),aO(t,$M,KM,JM,eO,tO,i)}(e,d,t)}(function(e,t,i,r,s,n,a,o,l){(function(e,t,i,r,s){!function(e,t,i,r,s){const{data:n,size:a}=e;pO(r,n),pO(s,r),i[0]=yO(QM,t),i[1]=i[0];for(let e=a;e<n.length;e+=a){const a=n[e]*t[0]+n[e+1]*t[1]+n[e+2]*t[2];a<i[0]&&(i[0]=a,pO(r,n,e)),a>i[1]&&(i[1]=a,pO(s,n,e))}}(e,t,GM,s,r);const n=yO(i,t);GM[1]-RM<=n&&(r[0]=void 0),GM[0]+RM>=n&&(s[0]=void 0)})(e,t,i,OM,DM),void 0!==OM[0]&&(dO(EM,OM,i),fO(EM,EM),dO(zM,OM,r),fO(zM,zM),dO(IM,OM,s),fO(IM,IM),mO(LM,zM,n),fO(LM,LM),mO(FM,IM,a),fO(FM,FM),mO(VM,EM,o),fO(VM,VM),WM(e,LM,n,zM,EM,l),WM(e,FM,a,IM,zM,l),WM(e,VM,o,EM,IM,l)),void 0!==DM[0]&&(dO(EM,DM,i),fO(EM,EM),dO(zM,DM,r),fO(zM,zM),dO(IM,DM,s),fO(IM,IM),mO(LM,zM,n),fO(LM,LM),mO(FM,IM,a),fO(FM,FM),mO(VM,EM,o),fO(VM,VM),WM(e,LM,n,zM,EM,l),WM(e,FM,a,IM,zM,l),WM(e,VM,o,EM,IM,l))})(e,m,l,c,h,d,u,p,o),iO(e,o.b0,o.b1,o.b2,JM,eO);const f=[0,0,0];dO(f,eO,JM),o.quality=cO(f),o.quality<a?aO(o.b0,o.b1,o.b2,JM,eO,f,t):YM(AM,MM,t)}(e,t=t||TO()),t}function AO(e,t){const i=it(t,e.center),r=IO(e,t);return i>r?1:i<-r?-1:0}function MO(e,t){t||(t=(0,se.a)());const i=(0,Y.p)(wO,e.quaternion),r=e.halfSize[0]*Math.abs(i[0])+e.halfSize[1]*Math.abs(i[3])+e.halfSize[2]*Math.abs(i[6]),s=e.halfSize[0]*Math.abs(i[1])+e.halfSize[1]*Math.abs(i[4])+e.halfSize[2]*Math.abs(i[7]),n=e.halfSize[0]*Math.abs(i[2])+e.halfSize[1]*Math.abs(i[5])+e.halfSize[2]*Math.abs(i[8]);return t[0]=e.center[0]-r,t[1]=e.center[1]-s,t[2]=e.center[2]-n,t[3]=e.center[0]+r,t[4]=e.center[1]+s,t[5]=e.center[2]+n,t}function OO(e,t){return it(t,e.center)-IO(e,t)}function DO(e,t){return it(t,e.center)+IO(e,t)}function EO(e,t){return AO(e,t[0])<=0&&AO(e,t[1])<=0&&AO(e,t[2])<=0&&AO(e,t[3])<=0&&AO(e,t[4])<=0&&AO(e,t[5])<=0}function zO(e,t,i,r=0){(0,X.w)(_O,e.quaternion),(0,v.c)(xO,t,e.center);const s=(0,v.W)(xO,xO,_O),n=(0,v.W)(bO,i,_O);let a=-1/0,o=1/0;for(let t=0;t<3;t++)if(Math.abs(n[t])>1e-6){const i=(r+e.halfSize[t]-s[t])/n[t],l=(-r-e.halfSize[t]-s[t])/n[t];a=Math.max(a,Math.min(i,l)),o=Math.min(o,Math.max(i,l))}else if(s[t]>e.halfSize[t]+r||s[t]<-e.halfSize[t]-r)return!1;return a<=o}function IO(e,t){(0,X.w)(_O,e.quaternion),(0,v.W)(xO,t,_O);const i=e.halfSize;return Math.abs(xO[0]*i[0])+Math.abs(xO[1]*i[1])+Math.abs(xO[2]*i[2])}function LO(e,t){for(let i=0;i<8;++i){const r=t[i];r[0]=1&i?-e.halfSize[0]:e.halfSize[0],r[1]=2&i?-e.halfSize[1]:e.halfSize[1],r[2]=4&i?-e.halfSize[2]:e.halfSize[2],(0,v.W)(r,r,e.quaternion),(0,v.u)(r,r,e.center)}}(()=>{const e=new Int8Array(162);let t=0;const i=i=>{for(let r=0;r<i.length;r++)e[t+r]=i[r];t+=6};i([6,2,3,1,5,4]),i([0,2,3,1,5,4]),i([0,2,3,7,5,4]),i([0,1,3,2,6,4]),i([0,1,3,2,0,0]),i([0,1,5,7,3,2]),i([0,1,3,7,6,4]),i([0,1,3,7,6,2]),i([0,1,5,7,6,2]),i([0,1,5,4,6,2]),i([0,1,5,4,0,0]),i([0,1,3,7,5,4]),i([0,2,6,4,0,0]),i([0,0,0,0,0,0]),i([1,3,7,5,0,0]),i([2,3,7,6,4,0]),i([2,3,7,6,0,0]),i([2,3,1,5,7,6]),i([0,1,5,7,6,2]),i([0,1,5,7,6,4]),i([0,1,3,7,6,4]),i([4,5,7,6,2,0]),i([4,5,7,6,0,0]),i([4,5,1,3,7,6]),i([0,2,3,7,5,4]),i([6,2,3,7,5,4]),i([6,2,3,1,5,4])})();class FO{constructor(e){this._totalCount=e,this._indexRanges=[0,e]}componentCount(){const e=this._indexRanges;let t=0;for(let i=0;i<e.length;i+=2)t+=e[i+1];return t}reset(e){"all"===e||e.length===this._totalCount?this._indexRanges=[0,this._totalCount]:this._indexRanges=function(e){const t=new Array;if(0===e.length)return t;let i=e[0],r=1;for(let s=1;s<e.length;s++){const n=e[s];i+r===n?r+=1:(t.push(i),t.push(r),i=n,r=1)}return t.push(i),t.push(r),t}(e)}forEachComponent(e){const t=this._indexRanges;for(let i=0;i<t.length;i+=2){const r=t[i],s=r+t[i+1];for(let t=r;t<s;t++)if(!e(t))return!1}return!0}forEachComponentRange(e){const t=this._indexRanges;for(let i=0;i<t.length;i+=2){const r=t[i];if(!e(r,r+t[i+1]))return!1}return!0}computeOffsetRanges(e){const t=new Array(this._indexRanges.length),i=this._indexRanges;for(let r=0;r<i.length;r+=2){const s=i[r],n=s+i[r+1],a=e[s],o=e[n];t[r]=a,t[r+1]=o-a}return t}}class VO extends S.br{constructor(e,t){super(),this.pickability=null,this.highlightCounts=null,this.cachedGeometryRanges=null,this.cachedHighlightRanges=null,this.cachedDefaultRanges=null,this.offsets=(0,u.F)(t);const i=this.count;this.visibility=new FO(i),this.materialDataBuffer=e.getBuffer(i),this.materialDataIndices=new Uint16Array(i);for(let e=0;e<i;e++)this.materialDataIndices[e]=this.materialDataBuffer.acquireIndex()}dispose(){super.dispose();for(let e=0;e<this.count;e++)this.materialDataBuffer.releaseIndex(this.materialDataIndices[e])}get count(){return this.offsets.length-1}get geometryRanges(){return(0,u.t)(this.cachedGeometryRanges)&&(this.cachedGeometryRanges=this.visibility.computeOffsetRanges(this.offsets)),this.cachedGeometryRanges}get highlightRanges(){return(0,u.t)(this.highlightCounts)?null:(this.updateCachedHighlightRanges(),this.cachedHighlightRanges)}get defaultShadowMapRanges(){return(0,u.t)(this.highlightCounts)?this.geometryRanges:(this.updateCachedHighlightRanges(),this.cachedDefaultRanges)}highlightsDirty(){this.cachedHighlightRanges=null,this.cachedDefaultRanges=null}visibilityDirty(){this.cachedGeometryRanges=null,this.highlightsDirty()}updateCachedHighlightRanges(){if(((0,u.t)(this.cachedHighlightRanges)||(0,u.t)(this.cachedDefaultRanges))&&(0,u.r)(this.highlightCounts)){const{highlightRanges:e,defaultRanges:t}=function(e,t,i){const r=[],s=[];let n=i.length,a=i.length;return t.forEachComponent((t=>(e[t]>0?(n!==t-1&&(r.length&&r.push(i[n+1]-r[r.length-1]),r.push(i[t])),n=t):(a!==t-1&&(s.length&&s.push(i[a+1]-s[s.length-1]),s.push(i[t])),a=t),!0))),r.length&&r.push(i[n+1]-r[r.length-1]),s.length&&s.push(i[a+1]-s[s.length-1]),{highlightRanges:r,defaultRanges:s}}(this.highlightCounts,this.visibility,this.offsets);this.cachedHighlightRanges=e,this.cachedDefaultRanges=t}}}class UO extends S.br{constructor(){super(...arguments),this._bucket=null,this._bucketIndex=0}get bucketKey(){return this._bucket.key}}class GO{constructor(){this._buckets=new Map}add(e,t){const i=this._getBucket(e);t._bucket=i,t._bucketIndex=i.count,i.data.push(t),++i.statistics.added}remove(e){++e._bucket.statistics.removed;const t=e._bucket.data,i=t[t.length-1];t[e._bucketIndex]=i,i._bucketIndex=e._bucketIndex,t.pop(),e._bucket=null,e._bucketIndex=0}updateKey(e,t){this.remove(e),this.add(t,e)}getBucket(e){return this._getBucket(e).data}getPerformanceInfo(e){return this._getBucket(e).statistics}forEach(e){this._buckets.forEach((t=>e(t.data,t.key)))}get count(){let e=0;return this._buckets.forEach((t=>e+=t.count)),e}_getBucket(e){const t=this._buckets.get(e);if(t)return t;const i=new BO(e);return this._buckets.set(e,i),i}}class BO{constructor(e){this.key=e,this.data=new Array,this.statistics={added:0,removed:0}}get count(){return this.data.length}}class qO extends UO{get visible(){return!!(1&this.bucketKey)}}(0,r.e)([(0,S.aO)()],qO.prototype,"renderable",void 0),(0,r.e)([(0,S.aO)()],qO.prototype,"components",void 0);const kO=1e-6;class NO{constructor(e,t,i,r,s){this.aabb=e,this.axis=t,this.d=i,this.midStartIndex=r,this.rightStartIndex=s}}class jO{constructor(e,t,i,r){this.globalTriangleVertexIndices=e,this.firstTriangleIndex=t,this.positionAttribute=r,this.bspNodeTree=new Array,this.vertexPositionBuffer=r.data,this.vertexPositionStride=r.stride;const s=i-t,n=s<=ZO?new Uint16Array(s):new Uint32Array(s);this.indices=n;for(let e=0;e<s;++e)n[e]=e;{const a=function(e,t,i,r,s){const n=i-t,a=new Float32Array(6*n);for(let i=0;i<n;++i){const n=3*(i+t),o=e[n+0]*s,l=e[n+1]*s,c=e[n+2]*s;for(let e=0;e<3;++e){const t=r[o+e],s=r[l+e],n=r[c+e];a[6*i+e]=Math.min(t,s,n),a[6*i+3+e]=Math.max(t,s,n)}}return a}(e,t,i,r.data,r.stride),o=(e,t,i)=>{const r=function(e,t,i,r){if(r<=i)return(0,se.u)(NaN,NaN,NaN,NaN,NaN,NaN);{const r=6*e[i];for(let e=0;e<3;++e)WO[e]=t[r+0+e],QO[e]=t[r+3+e]}for(let s=i+1;s<r;++s){const i=6*e[s];for(let e=0;e<3;++e)WO[e]=Math.min(WO[e],t[i+0+e]),QO[e]=Math.max(QO[e],t[i+3+e])}return(0,se.u)(WO[0],WO[1],WO[2],QO[0],QO[1],QO[2])}(n,a,e,t),s=t-e;if(s<=20){const i=new NO(r,void 0,0,e,t);return this.bspNodeTree.push(i),i}const{axis:l,midValue:c}=function(e){const t=e[3]-e[0],i=e[4]-e[1],r=e[5]-e[2],s=t>i?t>r?0:i>r?1:2:i>r?1:r>t?2:0;return{axis:s,midValue:(e[s]+e[s+3])/2}}(r),h=function(e,t,i,r,s,n){let a=i,o=r;for(;a<o;){const i=e[a];t[6*i+s+3]<=n?++a:(--o,e[a]=e[o],e[o]=i)}let l=a;for(o=r;l<o;){const i=e[o-1];t[6*i+s]>=n?--o:(e[o-1]=e[l],e[l]=i,++l)}return{next:a,mid:l}}(n,a,e,t,l,c),d=(e,t)=>{if(i>15)return;const r=t-e;return r<20||r>=.8*s?void 0:o(e,t,i+1)},u=new NO(r,l,c,h.next,h.mid);return this.bspNodeTree.push(u),u.leftNode=d(e,h.next),u.rightNode=d(h.mid,t),u};o(0,s,0),this.triangleVertexIndices=function(e,t,i,r){const s=r-i;let n=0;for(let e=i;e<r;++e)for(let i=0;i<3;++i)n=Math.max(t[3*e+i],n);const a=n<=ZO?new Uint16Array(3*s):new Uint32Array(3*s);for(let r=0;r<s;++r){const s=3*(e[r]+i);for(let e=0;e<3;++e){const i=t[s+e];a[3*r+e]=i}}return a}(n,e,t,i)}}intersectRayTriangleRange(e,t){{if(e>=t)return;const i=this.triangleVertexIndices,r=this.positionAttribute.data,s=this.positionAttribute.stride,n=this.rayOrigin,a=n[0],o=n[1],l=n[2],c=this.rayDirection,h=c[0],d=c[1],u=c[2];for(let n=e,c=3*e;n<t;++n){const e=i[c]*s,t=r[e],p=r[e+1],m=r[e+2],f=i[c+1]*s,g=r[f],v=r[f+1],y=r[f+2],_=i[c+2]*s,x=r[_],b=r[_+1],w=r[_+2];c+=3;const C=g-t,T=v-p,P=y-m,R=x-t,A=b-p,M=w-m,O=d*M-A*u,D=u*R-M*h,E=h*A-R*d,z=C*O+T*D+P*E;if(Math.abs(z)<=Number.EPSILON)continue;const I=a-t,L=o-p,F=l-m,V=I*O+L*D+F*E;if(z>0){if(V<0||V>z)continue}else if(V>0||V<z)continue;const U=L*P-T*F,G=F*C-P*I,B=I*T-C*L,q=h*U+d*G+u*B;if(z>0){if(q<0||V+q>z)continue}else if(q>0||V+q<z)continue;const k=(R*U+A*G+M*B)/z;if(k>=0){const e=this.indices[n]+this.firstTriangleIndex,t=(0,S.bg)(C,T,P,R,A,M,HO);this.callback(k,t,e)}}}jO.numFacesTested+=t-e}intersectRay(e,t){jO.numFacesTested=0;const i=(0,v.i)(e.r0[0],e.r0[1],e.r0[2]),r=function(e,t){const i=(0,v.n)();return(0,v.J)(i,e,t),i}((0,v.i)(e.r1[0],e.r1[1],e.r1[2]),i);if((0,v.m)(r)<kO)return;this.rayOrigin=i,this.rayDirection=r;const s=this.triangleVertexIndices.length/3;this.callback=t;const n=this.bspNodeTree[0];this.intersectRayBSP(n,0,s)}intersectRayBSP(e,t,i){const r=this.rayOrigin,s=this.rayDirection;if(!function(e,t,i){const r=t,s=i;let n=0,a=1/0;for(let t=0;t<3;++t){{const i=e[t];if(r[t]<i){if(s[t]<=kO)return!1;const e=(i-r[t])/s[t];n=Math.max(n,e)}else if(s[t]<=-kO){const e=(i-r[t])/s[t];a=Math.min(a,e)}if(n>=a)return!1}{const i=e[t+3];if(r[t]>i){if(s[t]>=-kO)return!1;const e=(i-r[t])/s[t];n=Math.max(n,e)}else if(s[t]>=kO){const e=(i-r[t])/s[t];a=Math.min(a,e)}if(n>=a)return!1}}return!0}(e.aabb,r,s))return;const n=e.axis,a=e.d;if(r[n]<a||s[n]<0){const i=t,r=e.midStartIndex;if(i<r){const t=e.leftNode;void 0!==t?this.intersectRayBSP(t,i,r):this.intersectRayTriangleRange(i,r)}}if(this.intersectRayTriangleRange(e.midStartIndex,e.rightStartIndex),r[n]>a||s[n]>0){const t=e.rightStartIndex,r=i;if(t<r){const i=e.rightNode;void 0!==i?this.intersectRayBSP(i,t,r):this.intersectRayTriangleRange(t,r)}}}}jO.numFacesTested=0;const HO=(0,v.n)(),WO=(0,v.i)(1/0,1/0,1/0),QO=(0,v.i)(-1/0,-1/0,-1/0),ZO=65535;function YO(e,t,i,r){if(i>=t)return e;null==e&&(e=function(e=!0){return{isVisibleBit:!e,data:new Uint32Array(0)}}());const s=e.isVisibleBit;let n=e.data;const a=$O(n),o=i/a|0,l=i-a*o,c=(t-1)/a|0,h=n,d=r===s;if(!(i<h.length*a)&&d){const e=1.5,t=o+1,i=Math.ceil(h.length*e),r=c+1;let s=Math.max(t,i);s=Math.min(s,r),n=new Uint32Array(s),n.set(h)}return o<n.length&&(n[o]=function(e,t,i){return e&~(1<<t)|(i?1:0)<<t}(n[o],l,d)),e.data=n,e}function XO(e,t){if(null==e)return!0;const{isVisibleBit:i,data:r}=e,s=$O(r);return t<r.length*s?function(e,t,i,r){const s=i/r|0,n=i-s*r;return function(e,t){return 0!=(e&1<<t)}(t[s],n)===e}(i,r,t,s):!e.isVisibleBit}function $O(e){return 8*e.BYTES_PER_ELEMENT}class KO{constructor(e,t){this._indices=(0,u.r)(e.indices)?e.indices:(0,w.l)(e.positions.length/3),this._positions=new de.i(e.positions),this._components=t,this._componentIntersectionData=new Array(t.count)}getComponentAabb(e,t){if((0,u.r)(this._perComponentAabbs)){for(let i=0;i<6;i++)t[i]=this._perComponentAabbs[6*e+i];return t}return this._computePerComponentAabbs(),this.getComponentAabb(e,t)}getComponentPositions(e,t){t.indices=this._indices,t.data=this._positions.typedBuffer,t.stride=this._positions.typedBufferStride,t.startIndex=this._components.offsets[e],t.endIndex=this._components.offsets[e+1]}intersect(e,t,i,r,s,n){const a={data:this._positions.typedBuffer,stride:this._positions.typedBufferStride,size:3},o=this._indices,l=this._components.offsets,c=(0,S.bs)(e,t,JO);this._components.visibility.forEachComponent((h=>{if(!XO(this._components.pickability,h))return!0;const d=this.getComponentAabb(h,eD);if((0,u.r)(s)&&s.applyToAabb(d),!(0,S.b7)(d,e,c,i))return!0;const p=l[h]/3,m=l[h+1]/3,f=(e,t,i)=>{n(h,e,(0,v.L)(t,t,r),i)},g=m-p;return(0,u.t)(s)&&g>40?(null==this._componentIntersectionData[h]&&(this._componentIntersectionData[h]=new jO(this._indices,p,m,a)),this._componentIntersectionData[h].intersectRay({r0:e,r1:t},f)):(0,S.a$)(e,t,p,m,o,a,void 0,s,f),!0}))}_computePerComponentAabbs(){const e=this._components.count;this._perComponentAabbs=new Float32Array(6*e);for(let t=0;t<e;t++)this._computeAABB(t)}_computeAABB(e){const t=this._indices,i=this._positions,r=this._components.offsets,s=r[e],n=r[e+1],a=[0,0,0],o=[1/0,1/0,1/0],l=[-1/0,-1/0,-1/0];for(let e=s;e<n;e++){const r=t[e];i.getVec(r,a),(0,v.$)(o,o,a),(0,v.a0)(l,l,a)}let c=6*e;this._perComponentAabbs[c++]=o[0],this._perComponentAabbs[c++]=o[1],this._perComponentAabbs[c++]=o[2],this._perComponentAabbs[c++]=l[0],this._perComponentAabbs[c++]=l[1],this._perComponentAabbs[c]=l[2]}get positions(){return this._positions}get indices(){return this._indices}}const JO=(0,v.n)(),eD=(0,se.a)();class tD{constructor(e,t,i,r){this.material=e,this.drawParameters=t,this.geometry=i,this.meta=r}dispose(){this.material.dispose(),this.geometry.dispose()}}class iD extends S.br{constructor(e,t,i,r){super(),this.primitiveType=t,this.parameters=i,this.indexed=r,this.vao=e}}function rD(e){return e?sD(e,1/0,-1/0):{near:1/0,far:-1/0}}function sD(e,t,i){return e.near=t,e.far=i,e}function nD(e,t,i=e){return i.near=Math.min(e.near,t.near),i.far=Math.max(e.far,t.far),i}function aD(e,t){return e.near<=t&&t<=e.far}(0,r.e)([(0,S.aO)()],iD.prototype,"vao",void 0);const oD={near:0,far:0},lD=new r.f({allocator:e=>e||{near:1/0,far:-1/0,mask:0,object:null},deallocator:e=>(e.object=null,e)}),cD=rD(),hD=(0,v.n)(),dD=(0,v.n)(),uD=new r.f({deallocator:null}),pD=new r.f({deallocator:null});function mD(e,t,i){i.length=0;const r=t.length-3;fD(hD,t,r);const s=it(e,hD);s<=0&&(i.push(hD[0]),i.push(hD[1]),i.push(hD[2]));let n=0,a=s;for(;n<r;n+=3){fD(dD,t,n);const r=it(e,dD);a*r<0&&((0,v.y)(hD,dD,hD,r/(r-a)),gD(i,hD)),r<=0&&gD(i,dD),a=r,(0,v.h)(hD,dD)}a*s<0&&(fD(dD,t,r),(0,v.y)(hD,dD,hD,s/(s-a)),gD(i,hD))}function fD(e,t,i){return(0,v.a)(e,t.data[i+0],t.data[i+1],t.data[i+2])}function gD(e,t){e.push(t[0]),e.push(t[1]),e.push(t[2])}function vD(e,t,i,r){(0,X.w)(bD,e.quaternion),(0,v.J)(wD,t,e.center),(0,v.W)(wD,wD,bD);const s=8*((wD[0]<-e.halfSize[0]?-1:wD[0]>e.halfSize[0]?1:0)+3*(wD[1]<-e.halfSize[1]?-1:wD[1]>e.halfSize[1]?1:0)+9*(wD[2]<-e.halfSize[2]?-1:wD[2]>e.halfSize[2]?1:0)+13),n=yD[s];if(0===n)return n;(0,Y.p)(xD,e.quaternion),(0,Y.f)(xD,xD,e.halfSize);const a=(t,i)=>{const r=yD[s+i+1];return(0,v.a)(t,((1&r)<<1)-1,(2&r)-1,((4&r)>>1)-1),(0,v.L)(t,t,xD),(0,v.u)(t,e.center,t)};return i.length=0,gD(i,a(CD,0)),gD(i,a(TD,1)),gD(i,a(wD,2)),gD(i,a(SD,3)),r(i),1===n||(i.length=0,gD(i,CD),gD(i,SD),gD(i,a(wD,4)),gD(i,a(PD,5)),r(i),2===n||(i.length=0,gD(i,CD),gD(i,PD),gD(i,a(wD,6)),gD(i,TD),r(i))),n}const yD=(()=>{const e=new Int8Array(216);let t=0;const i=i=>{for(let r=0;r<i.length;r++)e[t+r]=i[r];t+=8};return i([3,0,6,2,3,1,5,4]),i([2,0,2,3,1,5,4,0]),i([3,1,0,2,3,7,5,4]),i([2,0,1,3,2,6,4,0]),i([1,0,1,3,2,0,0,0]),i([2,1,5,7,3,2,0,0]),i([3,2,0,1,3,7,6,4]),i([2,2,0,1,3,7,6,0]),i([3,3,0,1,5,7,6,2]),i([2,0,1,5,4,6,2,0]),i([1,0,1,5,4,0,0,0]),i([2,1,3,7,5,4,0,0]),i([1,0,2,6,4,0,0,0]),i([0,0,0,0,0,0,0,0]),i([1,1,3,7,5,0,0,0]),i([2,2,3,7,6,4,0,0]),i([1,2,3,7,6,0,0,0]),i([2,3,1,5,7,6,2,0]),i([3,4,0,1,5,7,6,2]),i([2,5,7,6,4,0,1,0]),i([3,5,0,1,3,7,6,4]),i([2,4,5,7,6,2,0,0]),i([1,4,5,7,6,0,0,0]),i([2,5,1,3,7,6,4,0]),i([3,6,0,2,3,7,5,4]),i([2,6,2,3,7,5,4,0]),i([3,7,6,2,3,1,5,4]),e})();function _D(e,t){let i=0;for(let r=0;r<4;r++){const s=AO(e,t[r]);if(s>0)return-1;0===s&&(i|=1<<r)}return i}const xD=(0,X.e)(),bD=(0,X.a)(),wD=(0,v.n)(),CD=(0,v.n)(),TD=(0,v.n)(),SD=(0,v.n)(),PD=(0,v.n)();class RD{constructor(e){this._objects=e}submit(e,t){this._objects.preSubmit(t);const i=this._objects.visibleObjects;for(let t=0;t<i.length;t++){const r=i[t];r.renderable.material.submit(e,r)}}queryShadowCasterDepthRange(e){return this._objects.visibleObjects.length?function(e,t){const i=rD(),{eye:r,frustum:s,viewForward:n}=e;for(let e=0;e<t.length;e++){const a=t[e].obb,o=(0,v.z)((0,v.J)(wD,a.center,r),n),l=IO(a,n);if(aD(i,o-l)&&aD(i,o+l))continue;const c=_D(a,s);if(-1===c)continue;if(0===c){cD.far=o+l,cD.near=o-l,nD(i,cD);continue}const h=lD.pushNew();h.near=o-l,h.far=o+l,h.mask=c,h.object=t[e]}for(let e=0;e<lD.length;e++){const t=lD.data[e];aD(i,t.near)&&aD(i,t.far)||(cD.far=t.far,cD.near=1/0,0===vD(t.object.obb,r,uD,(e=>{let i=pD;for(let r=0;r<4&&e.length>0;r++){if(0==(t.mask&1<<r))continue;mD(s[r],e,i);const n=e;e=i,i=n}for(let t=0;t<e.length;t+=3){(0,v.a)(hD,e.data[t+0],e.data[t+1],e.data[t+2]);const i=(0,v.z)((0,v.J)(hD,hD,r),n);cD.near=Math.min(cD.near,i)}}))&&(cD.near=0),nD(i,cD))}return lD.length=0,i}(e,this._objects.visibleObjects):null}}function AD(e){const t=(0,G.A)().vec3f("position");return e.normals&&t.vec2i16("normalCompressed",{glNormalized:!0}),1===e.textureCoordinates?t.vec2f("uv0"):2===e.textureCoordinates&&(t.vec2f("uv0"),t.vec4u16("uvRegion",{glNormalized:!0})),e.colors&&t.vec4u8("color",{glNormalized:!0}),t.alignTo(4)}function MD(e,t){1===t.componentData&&(e.vertex.uniforms.add("uComponentColorTex","sampler2D"),e.vertex.uniforms.add("uComponentColorTexInvDim","vec2"),e.attributes.add("componentIndex","float"),e.varyings.add("vExternalColorMixMode","mediump float"),e.varyings.add("vExternalColor","vec4"),e.include(S.bt),e.vertex.code.add(S.t`vec4 _readComponentColor() {
float normalizedIndex = (componentIndex + 0.5) * uComponentColorTexInvDim.x;
vec2 indexCoord = vec2(
mod(normalizedIndex, 1.0),
(floor(normalizedIndex) + 0.5) * uComponentColorTexInvDim.y
);
return texture2D(uComponentColorTex, indexCoord);
}
vec4 forwardExternalColor(out bool castShadows) {
vec4 componentColor = _readComponentColor() * 255.0;
float shadowFlag = mod(componentColor.b * 255.0, 2.0);
componentColor.b -= shadowFlag;
castShadows = shadowFlag >= 1.0;
int decodedColorMixMode;
vExternalColor = decodeSymbolColor(componentColor, decodedColorMixMode) * 0.003921568627451;
vExternalColorMixMode = float(decodedColorMixMode) + 0.5;
return vExternalColor;
}`),e.fragment.code.add(S.t`void readExternalColor(out vec4 externalColor, out int externalColorMixMode) {
externalColor = vExternalColor;
externalColorMixMode = int(vExternalColorMixMode);
}`)),0===t.componentData&&(e.vertex.uniforms.add("uExternalColor","vec4"),e.fragment.uniforms.add("uExternalColorMixMode","int"),e.varyings.add("vExternalColor","vec4"),e.vertex.code.add(S.t`vec4 forwardExternalColor(out bool castShadows) {
vExternalColor = uExternalColor;
castShadows = true;
return uExternalColor;
}`),e.fragment.code.add(S.t`void readExternalColor(out vec4 externalColor, out int externalColorMixMode) {
externalColor = vExternalColor;
externalColorMixMode = uExternalColorMixMode;
}`))}function OD(e,t){const i=e.vertex;switch(i.code.add(S.t`#define VERTEX_DISCARD_CUTOFF (1.0 - 1.0 / 255.0)`),t.vertexDiscardMode){case 0:i.code.add(S.t`#define vertexDiscardByOpacity(_opacity_) {}`);break;case 2:i.code.add(S.t`#define vertexDiscardByOpacity(_opacity_) { if (_opacity_ >  VERTEX_DISCARD_CUTOFF) {  gl_Position = vec4(1e38, 1e38, 1e38, 1.0); return; } }`);break;case 1:i.code.add(S.t`#define vertexDiscardByOpacity(_opacity_) { if (_opacity_ <= VERTEX_DISCARD_CUTOFF) {  gl_Position = vec4(1e38, 1e38, 1e38, 1.0); return; } }`)}}function DD(e,t){e.include(S.aV,t),e.fragment.include(S.bu);const i=e.fragment;i.uniforms.add("uBaseColor","vec4"),i.uniforms.add("uObjectOpacity","float"),t.attributeColor?i.code.add(S.t`vec3 _baseColor() {
return uBaseColor.rgb * vColor.rgb;
}
float _baseOpacity() {
return uBaseColor.a * vColor.a;
}`):i.code.add(S.t`vec3 _baseColor() {
return uBaseColor.rgb;
}
float _baseOpacity() {
return uBaseColor.a;
}`),i.code.add(S.t`vec4 computeMaterialColor(vec4 textureColor, vec4 externalColor, int externalColorMixMode) {
vec3 baseColor = _baseColor();
float baseOpacity = _baseOpacity();
vec3 color = mixExternalColor(
baseColor,
textureColor.rgb,
externalColor.rgb,
externalColorMixMode
);
float opacity = uObjectOpacity * mixExternalOpacity(
baseOpacity,
textureColor.a,
externalColor.a,
externalColorMixMode
);
return vec4(color, opacity);
}`)}function ED(e,t){const i=e.fragment;0===t.doubleSidedMode?i.code.add(S.t`vec3 _adjustDoublesided(vec3 normal) {
return normal;
}`):1===t.doubleSidedMode?(e.include(S.bv,t),i.uniforms.add("uTransform_ViewFromCameraLocal_T","vec3"),i.code.add(S.t`vec3 _adjustDoublesided(vec3 normal) {
vec3 viewDir = vPositionWorldCameraRelative + uTransform_ViewFromCameraLocal_T;
return dot(normal, viewDir) > 0.0 ? -normal : normal;
}`)):2===t.doubleSidedMode&&i.code.add(S.t`vec3 _adjustDoublesided(vec3 normal) {
return gl_FrontFacing ? normal : -normal;
}`),0===t.normalType||1===t.normalType?(e.include(S.b6,t),i.code.add(S.t`vec3 shadingNormalWorld() {
return _adjustDoublesided(normalize(vNormalWorld));
}
vec3 shadingNormal_view() {
vec3 normal = normalize(vNormalView);
return gl_FrontFacing ? normal : -normal;
}`)):3===t.normalType?(e.extensions.add("GL_OES_standard_derivatives"),e.include(S.bv,t),i.code.add(S.t`vec3 shadingNormalWorld() {
return normalize(cross(
dFdx(vPositionWorldCameraRelative),
dFdy(vPositionWorldCameraRelative)
));
}
vec3 shadingNormal_view() {
return normalize(cross(dFdx(vPosition_view),dFdy(vPosition_view)));
}`)):2===t.normalType&&(1===t.viewingMode?(e.include(S.bv,t),i.code.add(S.t`vec3 shadingNormalWorld() {
return normalize(positionWorld());
}`)):2===t.viewingMode&&i.code.add(S.t`vec3 shadingNormalWorld() {
return vec3(0.0, 0.0, 1.0);
}`),e.extensions.add("GL_OES_standard_derivatives"),i.code.add(S.t`vec3 shadingNormal_view() {
return normalize(cross(dFdx(vPosition_view),dFdy(vPosition_view))).xyz;
}`))}function zD(e,t){const i=e.fragment;t.baseColorTexture?(e.include(S.bw,t),i.uniforms.add("uBaseColorTexture","sampler2D"),i.uniforms.add("uBaseColorTextureSize","vec2"),2===t.attributeTextureCoordinates?(e.include(S.bx),i.code.add(S.t`vec4 readBaseColorTexture() {
return textureAtlasLookup(
uBaseColorTexture,
uBaseColorTextureSize,
vuv0,
vuvRegion
);
}`)):i.code.add(S.t`vec4 readBaseColorTexture() {
return texture2D(uBaseColorTexture, vuv0);
}`)):i.code.add(S.t`vec4 readBaseColorTexture() { return vec4(1.0); }`)}const ID=new Map([["position",0],["normal",1],["normalCompressed",1],["color",2],["uv0",3],["uvRegion",4],["componentIndex",5]]);function LD(e){const t=new S.n;t.include(S.bv,e),t.include(S.b6,e),t.include(S.aV,e),t.include(S.by,e),t.include(S.aF,e),t.include(MD,e),t.include(S.bz,e),t.include(S.N,e),t.include(zD,e),t.include(OD,e),t.fragment.uniforms.add("view","mat4"),1!==e.pbrMode&&2!==e.pbrMode||(t.include(S.bA,e),e.hasNormalTexture&&t.include(S.bB,e)),3===e.output&&1===e.componentData?t.vertex.code.add(S.t`#define discardShadows(castShadows) { if(!castShadows) { gl_Position = vec4(1e38, 1e38, 1e38, 1.0); return; } }`):t.vertex.code.add(S.t`#define discardShadows(castShadows) {}`);const i=e.overlayEnabled&&0===e.output&&4===e.pbrMode;return e.overlayEnabled&&(t.include(kA,e),1===e.viewingMode?t.vertex.code.add(S.t`
      const float invEllipsoidRadius = ${S.t.float(1/(1===e.ellipsoidMode?g.s.radius:2===e.ellipsoidMode?g.t.radius:g.e.radius))};
      vec2 projectOverlay(vec3 pos) {
        return pos.xy / (1.0 + invEllipsoidRadius * pos.z);
      }
      `):t.vertex.code.add(S.t`vec2 projectOverlay(vec3 pos) { return pos.xy; }`)),i&&(t.varyings.add("tbnTangent","vec3"),t.varyings.add("tbnBiTangent","vec3"),t.varyings.add("groundNormal","vec3"),t.varyings.add("positionView","vec3")),t.vertex.code.add(S.t`
    void main() {
      bool castShadows;
      vec4 externalColor = forwardExternalColor(castShadows);
      discardShadows(castShadows);

      vertexDiscardByOpacity(externalColor.a);

      if (externalColor.a < ${S.t.float(S.Q)}) {
        // Discard this vertex
        gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
        return;
      }
      forwardPosition();
      forwardNormal();
      ${i?S.t`
        positionView = position_view();
        ${1===e.viewingMode?S.t`
        groundNormal = normalize(positionWorld());
        tbnTangent = normalize(cross(vec3(0.0, 0.0, 1.0), groundNormal));
        tbnBiTangent = normalize(cross(groundNormal, tbnTangent));`:S.t`
        groundNormal = vec3(0.0, 0.0, 1.0);
        tbnTangent = vec3(1.0, 0.0, 0.0);
        tbnBiTangent = normalize(cross(groundNormal, tbnTangent));`}
        `:""}

      ${e.overlayEnabled?S.t`setOverlayVTC(projectOverlay(position));`:""}
      forwardTextureCoordinates();
      forwardVertexColor();
      forwardLinearDepth(); // depends on forwardPosition()
    }
  `),7===e.output&&(t.fragment.include(S.L),e.multipassTerrainEnabled&&t.include(S.ap,e),t.include(DD,e),t.fragment.code.add(S.t`
      void main() {
        discardBySlice(vPositionWorldCameraRelative);
        ${e.multipassTerrainEnabled?S.t`terrainDepthTest(gl_FragCoord, vPosition_view.z);`:""}

        vec4 textureColor = readBaseColorTexture();
        discardOrAdjustAlpha(textureColor);

        vec4 externalColor;
        int externalColorMixMode;
        readExternalColor(externalColor, externalColorMixMode);

        vec4 materialColor = computeMaterialColor(
          textureColor,
          externalColor,
          externalColorMixMode
        );
        ${e.overlayEnabled?S.t`
        vec4 overlayColorOpaque = getOverlayColor(ovColorTex, vtcOverlay);
        vec4 overlayColor = overlayOpacity * overlayColorOpaque;
        materialColor = materialColor * (1.0 - overlayColor.a) + overlayColor;`:""}

        gl_FragColor = vec4(materialColor.a);
      }
    `)),0===e.output&&(t.fragment.include(S.L),e.multipassTerrainEnabled&&t.include(S.ap,e),t.include(DD,e),t.include(ED,e),t.include(S.b1,e),i&&t.fragment.uniforms.add("ovNormalTex","sampler2D"),e.receiveShadows?(t.include(S.aG,e),t.fragment.code.add(S.t`float evaluateShadow() {
return readShadowMap(vPositionWorldCameraRelative, linearDepth);
}`)):t.fragment.code.add(S.t`float evaluateShadow() { return 0.0; }`),t.fragment.code.add(S.t`
      void main() {
        discardBySlice(vPositionWorldCameraRelative);
        ${e.multipassTerrainEnabled?S.t`terrainDepthTest(gl_FragCoord, vPosition_view.z);`:""}

        vec4 textureColor = readBaseColorTexture();
        discardOrAdjustAlpha(textureColor);

        vec4 externalColor;
        int externalColorMixMode;
        readExternalColor(externalColor, externalColorMixMode);

        vec4 materialColor = computeMaterialColor(
          textureColor,
          externalColor,
          externalColorMixMode
        );
        ${e.overlayEnabled?S.t`
        vec4 overlayColorOpaque = getOverlayColor(ovColorTex, vtcOverlay);
        vec4 overlayColor = overlayOpacity * overlayColorOpaque;
        materialColor = materialColor * (1.0 - overlayColor.a) + overlayColor;`:""}
    `),1===e.pbrMode||2===e.pbrMode?(t.fragment.code.add(S.t`
        ${1===e.pbrMode?S.t`
        applyPBRFactors();
        if (int(externalColorMixMode) == 3) {
          mrr = vec3(0.0, 0.6, 0.2);
        }`:""}
        vec3 normalVertex = shadingNormalWorld();
        float additionalIrradiance = 0.02 * lightingMainIntensity[2];
      `),e.hasNormalTexture?t.fragment.code.add(S.t`mat3 tangentSpace = computeTangentSpace(normalVertex, vPositionWorldCameraRelative, vuv0);
vec3 shadingNormal = computeTextureNormal(tangentSpace, vuv0);`):t.fragment.code.add(S.t`vec3 shadingNormal = normalVertex;`),t.fragment.code.add(S.t`${1===e.viewingMode?S.t`vec3 normalGround = normalize(positionWorld());`:S.t`vec3 normalGround = vec3(0.0, 0.0, 1.0);`}
      `),t.fragment.code.add(S.t`vec3 viewDir = normalize(vPositionWorldCameraRelative);
float ssao = 1.0 - occlusion * (1.0 - evaluateAmbientOcclusion());
vec3 additionalLight = evaluateAdditionalLighting(ssao, positionWorld());
vec4 shadedColor = vec4(evaluateSceneLightingPBR(shadingNormal, materialColor.rgb, evaluateShadow(), ssao, additionalLight, viewDir, normalGround, mrr, emission, additionalIrradiance), materialColor.a);`)):(e.receiveShadows?t.fragment.code.add(S.t`float shadow = evaluateShadow();`):1===e.viewingMode?t.fragment.code.add(S.t`float additionalAmbientScale = additionalDirectedAmbientLight(positionWorld());
float shadow = lightingGlobalFactor * (1.0 - additionalAmbientScale);`):t.fragment.code.add(S.t`float shadow = 0.0;`),t.fragment.code.add(S.t`
      float ambientOcclusion = evaluateAmbientOcclusion();
      // At global scale we create some additional ambient light based on the main light to simulate global illumination
      vec3 additionalLight = evaluateAdditionalLighting(ambientOcclusion, positionWorld());
      vec4 shadedColor = vec4(evaluateSceneLighting(shadingNormalWorld(), materialColor.rgb, shadow, ambientOcclusion, additionalLight), materialColor.a);
      ${i?S.t`
          vec4 overlayWaterMask = getOverlayColor(ovNormalTex, vtcOverlay);
          float waterNormalLength = length(overlayWaterMask);
          if (waterNormalLength > 0.95) {
            mat3 tbnMatrix = mat3(tbnTangent, tbnBiTangent, groundNormal);
            vec4 waterOverlayColor = vec4(overlayColorOpaque.xyz, overlayColor.w);
            vec4 waterColorLinear = getOverlayWaterColor(overlayWaterMask, waterOverlayColor, -normalize(vPositionWorldCameraRelative), shadow, groundNormal, tbnMatrix, positionView);
            vec4 waterColorNonLinear = delinearizeGamma(vec4(waterColorLinear.xyz, 1.0));
            // un-gamma the ground color to mix in linear space
            shadedColor = mix(shadedColor, waterColorNonLinear, waterColorLinear.w);
          }`:""}
      `)),t.fragment.code.add(S.t`
        gl_FragColor = highlightSlice(shadedColor, vPositionWorldCameraRelative);
        ${e.OITEnabled?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""}
      }
    `)),1!==e.output&&3!==e.output||(t.include(S.ao,e),t.fragment.code.add(S.t`void main() {
discardBySlice(vPositionWorldCameraRelative);
vec4 textureColor = readBaseColorTexture();
discardOrAdjustAlpha(textureColor);
outputDepth(linearDepth);
}`)),2===e.output&&(t.include(ED,e),t.fragment.code.add(S.t`
      void main() {
        discardBySlice(vPositionWorldCameraRelative);

        vec4 textureColor = readBaseColorTexture();
        discardOrAdjustAlpha(textureColor);

        // note: the alpha component needs to be 1.0 in order for this material
        // to influence ambient occlusion, see the ssao fragment shader
        float alpha = ${2===e.normalType?"0.0":"1.0"};
        gl_FragColor = vec4(vec3(.5) + .5 * shadingNormal_view(), alpha);
      }
    `)),4===e.output&&(t.include(S.S),t.fragment.code.add(S.t`
      void main() {
        discardBySlice(vPositionWorldCameraRelative);

        vec4 textureColor = readBaseColorTexture();
        discardOrAdjustAlpha(textureColor);

        ${e.overlayEnabled?S.t`
        vec4 overlayColor = getCombinedOverlayColor();

        if (overlayColor.a == 0.0) {
          gl_FragColor = vec4(0.0);
          return;
        }`:""}

        outputHighlight();
      }
    `)),t}var FD=Object.freeze({__proto__:null,attributeLocations:ID,build:LD});class VD extends S.c{bindPass(e){const t=this.program;S.bv.bindViewProjTransform(t,e.viewTransform),(0,S.bp)(this.program,this.configuration,e.slicePlane),0===e.identifier&&(void 0!==e.ssrParams&&lg(this.program,e.ssrParams),t.setUniformMatrix3fv("uTransformNormal_ViewFromGlobal",e.transformNormal_ViewFromGlobal),2===e.subPass&&t.setUniform2fv("cameraNearFar",e.cameraNearFar),0===e.subPass&&e.lighting.setUniforms(this.program,e.integratedMesh)),1===e.identifier&&this.program.setUniform2fv("cameraNearFar",e.cameraNearFar)}bindMaterial(e,t){const i=this.program;i.setUniform4fv("uBaseColor",e.baseColor),i.setUniform1f("uObjectOpacity",e.objectOpacity),i.setUniform1f("textureAlphaCutoff",e.alphaCutoff),1===e.componentParameters.type?e.componentParameters.texture.bind(i,"uComponentColorTex","uComponentColorTexInvDim"):(i.setUniform4fv("uExternalColor",e.componentParameters.externalColor),i.setUniform1i("uExternalColorMixMode",e.componentParameters.externalColorMixMode)),(0,u.r)(e.baseColorTexture)&&e.baseColorTexture.bind(i,"uBaseColorTexture","uBaseColorTextureSize"),0!==this.configuration.output&&7!==this.configuration.output||((0,S.bC)(this.program,e,this.configuration.isSchematic),(0,u.r)(e.metallicRoughnessTexture)&&e.metallicRoughnessTexture.bind(i,"texMetallicRoughness","texMetallicRoughnessSize"),(0,u.r)(e.emissionTexture)&&e.emissionTexture.bind(i,"texEmission","texEmissionSize"),(0,u.r)(e.occlusionTexture)&&e.occlusionTexture.bind(i,"texOcclusion","texOcclusionSize"),(0,u.r)(e.normalTexture)&&e.normalTexture.bind(i,"normalTexture","normalTextureSize")),e.isIntegratedMesh&&(0===t.identifier&&0===t.subPass?(i.bindTexture(e.overlayColor,"ovColorTex"),i.bindTexture(e.overlayNormal,"ovNormalTex")):2===t.identifier&&i.bindTexture(e.overlayHighlight,"ovColorTex"),i.setUniform1f("overlayOpacity",1)),2===t.identifier&&(0,S.a1)(this.program,t),0===t.identifier&&0===t.subPass&&(t.ambientOcclusionEnabled&&t.bindAmbientOcclusion(i),t.shadowsEnabled&&t.bindShadowMap(i)),0!==t.identifier||0!==t.subPass&&1!==t.subPass||!t.multipassTerrainParams.multipassTerrainEnabled||(this.program.setUniform2fv("cameraNearFar",t.cameraNearFar),i.setUniform2fv("inverseViewport",t.inverseViewport),t.multipassTerrainParams.terrainLinearDepthTexture&&i.bindTexture(t.multipassTerrainParams.terrainLinearDepthTexture,"terrainDepthTexture"))}bindDraw(e,t){if(S.bv.bindModelTransform(this.program,e),this.program.setUniformMatrix3fv("uTransformNormal_GlobalFromModel",e.transformNormal_GlobalFromModel),this.program.rebindTextures(),t.isIntegratedMesh){const i=t.overlayTexScale,r=t.overlayTexOffset;this.program.setUniform4fv("overlayTexOffset",[e.toMapSpace[0]*i[0]+r[0],e.toMapSpace[1]*i[1]+r[1],e.toMapSpace[0]*i[2]+r[2],e.toMapSpace[1]*i[3]+r[3]]),this.program.setUniform4fv("overlayTexScale",[e.toMapSpace[2]*i[0],e.toMapSpace[3]*i[1],e.toMapSpace[2]*i[2],e.toMapSpace[3]*i[3]])}}initializeProgram(e){const t=VD.shader.get(),i=this.configuration,r=t.build({multipassTerrainEnabled:i.multipassTerrainEnabled,cullAboveGround:i.cullAboveGround,OITEnabled:0===i.transparencyPassType,output:i.output,normalType:0===i.integratedMeshMode?i.hasNormals?1:3:2,attributeColor:i.hasVertexColors,attributeTextureCoordinates:i.vertexTextureCoordinates,componentData:i.componentData,alphaDiscardMode:i.alphaDiscardMode,baseColorTexture:i.baseColorTexture,doubleSidedMode:i.doubleSidedMode,receiveAmbientOcclusion:i.receiveAmbientOcclusion,receiveShadows:i.receiveShadows,slicePlaneEnabled:i.slicePlaneEnabled,sliceHighlightDisabled:!1,sliceEnabledForVertexPrograms:!1,viewingMode:e.viewingMode,vertexDiscardMode:i.vertexDiscardMode,pbrMode:3===i.integratedMeshMode?4:i.usePBR?i.isSchematic?2:1:0,hasMetalnessAndRoughnessTexture:i.hasMetalnessAndRoughnessTexture,hasEmissionTexture:i.hasEmissionTexture,hasOcclusionTexture:i.hasOcclusionTexture,hasNormalTexture:i.hasNormalTexture,vertexTangents:!1,supportsTextureAtlas:!0,doublePrecisionRequiresObfuscation:(0,S.bD)(e.rctx),overlayEnabled:2===i.integratedMeshMode||3===i.integratedMeshMode,ssrEnabled:i.ssrEnabled,highStepCount:!1,ellipsoidMode:i.ellipsoidMode});return new S.d(e.rctx,r,t.attributeLocations)}setPipelineState(e){const t=this.configuration,i=0!==t.integratedMeshMode,r=3===e,s=2===e;return(0,V.g)({blending:0!==t.output&&7!==t.output||!t.blendingEnabled?null:r?S.ar:(0,S.a5)(e),culling:(0,V.d)(t.cullFace),depthTest:{func:(0,S.as)(e)},depthWrite:r||s?V.l:null,colorWrite:V.r,stencilWrite:i||t.sceneHasOcludees?S.au:null,stencilTest:i?(0,S.bE)(1):t.sceneHasOcludees?S.aw:null,polygonOffset:r||s?t.polygonOffsetEnabled?{factor:2,units:2}:null:S.ax})}initializePipeline(){return this.setPipelineState(this.configuration.transparencyPassType)}}VD.shader=new S.f(FD,(()=>i.e(8071).then(i.bind(i,18071))));class UD extends S.bv.ModelTransform{constructor(){super(...arguments),this.transformNormal_GlobalFromModel=(0,X.e)(),this.toMapSpace=(0,w.n)()}}class GD extends S.b{constructor(){super(...arguments),this.output=0,this.hasVertexColors=!1,this.hasNormals=!1,this.vertexTextureCoordinates=0,this.componentData=0,this.slicePlaneEnabled=!1,this.cullFace=2,this.baseColorTexture=!1,this.receiveAmbientOcclusion=!0,this.receiveShadows=!0,this.vertexDiscardMode=0,this.doubleSidedMode=2,this.blendingEnabled=!0,this.alphaDiscardMode=1,this.integratedMeshMode=0,this.ssrEnabled=!1,this.polygonOffsetEnabled=!1,this.usePBR=!1,this.isSchematic=!1,this.hasMetalnessAndRoughnessTexture=!1,this.hasEmissionTexture=!1,this.hasOcclusionTexture=!1,this.hasNormalTexture=!1,this.sceneHasOcludees=!1,this.transparencyPassType=3,this.ellipsoidMode=1,this.multipassTerrainEnabled=!1,this.cullAboveGround=!1}}(0,r.e)([(0,S.a)({count:8})],GD.prototype,"output",void 0),(0,r.e)([(0,S.a)()],GD.prototype,"hasVertexColors",void 0),(0,r.e)([(0,S.a)()],GD.prototype,"hasNormals",void 0),(0,r.e)([(0,S.a)({count:3})],GD.prototype,"vertexTextureCoordinates",void 0),(0,r.e)([(0,S.a)({count:2})],GD.prototype,"componentData",void 0),(0,r.e)([(0,S.a)()],GD.prototype,"slicePlaneEnabled",void 0),(0,r.e)([(0,S.a)({count:3})],GD.prototype,"cullFace",void 0),(0,r.e)([(0,S.a)()],GD.prototype,"baseColorTexture",void 0),(0,r.e)([(0,S.a)()],GD.prototype,"receiveAmbientOcclusion",void 0),(0,r.e)([(0,S.a)()],GD.prototype,"receiveShadows",void 0),(0,r.e)([(0,S.a)({count:3})],GD.prototype,"vertexDiscardMode",void 0),(0,r.e)([(0,S.a)({count:3})],GD.prototype,"doubleSidedMode",void 0),(0,r.e)([(0,S.a)()],GD.prototype,"blendingEnabled",void 0),(0,r.e)([(0,S.a)({count:4})],GD.prototype,"alphaDiscardMode",void 0),(0,r.e)([(0,S.a)({count:4})],GD.prototype,"integratedMeshMode",void 0),(0,r.e)([(0,S.a)()],GD.prototype,"ssrEnabled",void 0),(0,r.e)([(0,S.a)()],GD.prototype,"polygonOffsetEnabled",void 0),(0,r.e)([(0,S.a)()],GD.prototype,"usePBR",void 0),(0,r.e)([(0,S.a)()],GD.prototype,"isSchematic",void 0),(0,r.e)([(0,S.a)()],GD.prototype,"hasMetalnessAndRoughnessTexture",void 0),(0,r.e)([(0,S.a)()],GD.prototype,"hasEmissionTexture",void 0),(0,r.e)([(0,S.a)()],GD.prototype,"hasOcclusionTexture",void 0),(0,r.e)([(0,S.a)()],GD.prototype,"hasNormalTexture",void 0),(0,r.e)([(0,S.a)()],GD.prototype,"sceneHasOcludees",void 0),(0,r.e)([(0,S.a)({count:4})],GD.prototype,"transparencyPassType",void 0),(0,r.e)([(0,S.a)({count:4})],GD.prototype,"ellipsoidMode",void 0),(0,r.e)([(0,S.a)()],GD.prototype,"multipassTerrainEnabled",void 0),(0,r.e)([(0,S.a)()],GD.prototype,"cullAboveGround",void 0);class BD{constructor(){this._dirty=!0}_setDirty(){this._dirty=!0}_setClean(){this._dirty=!1}get dirty(){return this._dirty}}function qD(e={}){return(t,i)=>{var r;const s=null!=(r=t._parameterCount)?r:0;if(t._parameterCount=s+1,e.vectorOps){const r=e.vectorOps;Object.defineProperty(t,i,{get(){return this[s]},set(e){const t=this[s];if(null==t)this[s]=e;else{if(r.equals(t,e))return;r.copy(t,e)}this._setDirty()}})}else Object.defineProperty(t,i,{get(){return this[s]},set(t){this[s]!==t&&(e.dispose&&this[s]&&this[s].dispose(),this[s]=t,this._setDirty())}})}}function kD(){return(e,t)=>{var i;const r=null!=(i=e._parameterCount)?i:0;e._parameterCount=r+1,e._parameterBlocks=e._parameterBlocks||[],e._parameterBlocks.push(r),Object.defineProperty(e,t,{get(){return this[r]},set(e){this[r]!==e&&(this[r]=e,this._setDirty())}})}}class ND extends class{constructor(){this._dirty=!0}_setDirty(){this._dirty=!0}_setClean(){if(this._dirty=!1,null!=this._parameterBlocks)for(const e of this._parameterBlocks)this[e]._setClean()}get dirty(){return this._dirty||this._checkParameterBlocksDirty()}_checkParameterBlocksDirty(){if(null==this._parameterBlocks)return!1;for(const e of this._parameterBlocks)if(this[e].dirty)return!0;return!1}}{constructor(){super(...arguments),this.baseColor=(0,_e.t)(1,1,1,1),this.usePBR=!1,this.hasParametersFromSource=!1,this.mrrFactors=(0,B.t)(1,1,.5),this.emissiveFactor=(0,B.t)(0,0,0),this.baseColorTexture=null,this.metallicRoughnessTexture=null,this.emissionTexture=null,this.occlusionTexture=null,this.normalTexture=null,this.overlayTexOffset=(0,w.a)(-1,-1,-1,-1),this.overlayTexScale=(0,w.a)(0,0,0,0),this.overlayColor=null,this.overlayHighlight=null,this.overlayNormal=null,this.objectOpacity=1,this.commonMaterialParameters=new jD,this.componentParameters=new HD,this.alphaCutoff=S.R,this.alphaDiscardMode=1,this.isIntegratedMesh=!1,this.polygonOffsetEnabled=!1,this.ellipsoidMode=1,this.sceneHasOcludees=!1,this._techniqueConfig=new GD}dispose(){this._technique=(0,u.h)(this._technique),this.baseColorTexture=null,this.metallicRoughnessTexture=null,this.emissionTexture=null,this.occlusionTexture=null,this.normalTexture=null}getTechnique(e,t,i){const r=this._techniqueConfig;if(r.hasVertexColors=i.colors,r.hasNormals=i.normals,r.vertexTextureCoordinates=i.textureCoordinates,r.usePBR=this.usePBR,r.hasMetalnessAndRoughnessTexture=(0,u.r)(this.metallicRoughnessTexture),r.hasEmissionTexture=(0,u.r)(this.emissionTexture),r.hasOcclusionTexture=(0,u.r)(this.occlusionTexture),r.hasNormalTexture=(0,u.r)(this.normalTexture),r.transparencyPassType=0===t.identifier&&null!=t.transparencyPassType?t.transparencyPassType:3,r.multipassTerrainEnabled=0===t.identifier&&null!=t.multipassTerrainParams&&t.multipassTerrainParams.multipassTerrainEnabled,r.cullAboveGround=0===t.identifier&&null!=t.multipassTerrainParams&&t.multipassTerrainParams.cullAboveGround,r.ellipsoidMode=this.ellipsoidMode,this.dirty){r.componentData=this.componentParameters.type,r.cullFace=this.commonMaterialParameters.cullFace,r.doubleSidedMode=this.commonMaterialParameters.doubleSided?1:0,r.baseColorTexture=(0,u.r)(this.baseColorTexture),r.isSchematic=this.hasParametersFromSource&&!(0,u.r)(this.baseColorTexture);const e=this._computeWhichMaterialPass();r.blendingEnabled=1===e||2===e,r.alphaDiscardMode=this.alphaDiscardMode,r.integratedMeshMode=this.isIntegratedMesh?this.overlayColor?this.overlayNormal?3:2:1:0,r.polygonOffsetEnabled=this.polygonOffsetEnabled,this._setClean()}return r.slicePlaneEnabled=t.slicePlaneEnabled&&this.commonMaterialParameters.slicePlaneEnabled,1===t.identifier?(r.output=3,r.vertexDiscardMode=0):2===t.identifier?(r.output=4,r.vertexDiscardMode=0):(2===this._computeWhichMaterialPass()?r.vertexDiscardMode=t.transparent?2:1:r.vertexDiscardMode=0,r.output=function(e){switch(e){case 0:return 0;case 1:return 7;case 2:return 1;case 3:return 2;case 4:return 8}}(t.subPass),1===t.subPass&&(r.sceneHasOcludees=t.sceneHasOcludees),0===t.subPass?(r.receiveAmbientOcclusion=t.ambientOcclusionEnabled,r.sceneHasOcludees=t.sceneHasOcludees,r.receiveShadows=t.shadowsEnabled,r.ssrEnabled=t.ssrParams.ssrEnabled):(r.receiveAmbientOcclusion=!1,r.receiveShadows=!1)),this._technique=e.releaseAndAcquire(VD,r,this._technique),this._technique}submit(e,t){if(0===this.objectOpacity)return;const i=t.renderable.geometry,r=t.components,s=t.renderable.drawParameters,n=t.renderable.meta.cameraDepthSquared,a=r.geometryRanges,o=r.highlightRanges,l=r.defaultShadowMapRanges;switch(this._computeWhichMaterialPass()){case 0:e.materialOpaque.submitDraw(this,i,a,s,n);break;case 1:e.materialTransparent.submitDraw(this,i,a,s,n);break;case 2:e.materialOpaque.submitDraw(this,i,a,s,n),e.materialTransparent.submitDraw(this,i,a,s,n);break;case 3:e.materialIntegratedMesh.submitDraw(this,i,a,s,n),this.overlayHighlight&&e.highlightIntegratedMesh.submitDraw(this,i,a,s,n)}(0,u.r)(e.shadowMap)&&2!==this.componentParameters.castShadows&&e.shadowMap.submitDraw(this,i,a,s,n),(0,u.r)(e.highlight)&&(0,u.r)(o)&&e.highlight.submitDraw(this,i,o,s,n),(0,u.r)(e.highlightShadowMap)&&2!==this.componentParameters.castShadows&&(0,u.r)(o)&&e.highlightShadowMap.submitDraw(this,i,o,s,n),(0,u.r)(e.defaultShadowMap)&&2!==this.componentParameters.castShadows&&(0,u.r)(l)&&e.defaultShadowMap.submitDraw(this,i,l,s,n)}get attributeLocations(){return ID}_computeWhichMaterialPass(){return this.isIntegratedMesh?3:this.objectOpacity<1?1:0===this.componentParameters.opaqueOverride?0:this.baseColor[3]<1||0===this.alphaDiscardMode||3===this.alphaDiscardMode?1:2===this.componentParameters.transparent?0:0===this.componentParameters.transparent?1:2}}(0,r.e)([qD({vectorOps:j.I})],ND.prototype,"baseColor",void 0),(0,r.e)([qD()],ND.prototype,"usePBR",void 0),(0,r.e)([qD()],ND.prototype,"hasParametersFromSource",void 0),(0,r.e)([qD({vectorOps:v.a1})],ND.prototype,"mrrFactors",void 0),(0,r.e)([qD({vectorOps:v.a1})],ND.prototype,"emissiveFactor",void 0),(0,r.e)([qD({dispose:!0})],ND.prototype,"baseColorTexture",void 0),(0,r.e)([qD({dispose:!0})],ND.prototype,"metallicRoughnessTexture",void 0),(0,r.e)([qD({dispose:!0})],ND.prototype,"emissionTexture",void 0),(0,r.e)([qD({dispose:!0})],ND.prototype,"occlusionTexture",void 0),(0,r.e)([qD({dispose:!0})],ND.prototype,"normalTexture",void 0),(0,r.e)([qD({vectorOps:{equals:j.D,copy:j.a}})],ND.prototype,"overlayTexOffset",void 0),(0,r.e)([qD({vectorOps:{equals:j.D,copy:j.a}})],ND.prototype,"overlayTexScale",void 0),(0,r.e)([qD()],ND.prototype,"overlayColor",void 0),(0,r.e)([qD()],ND.prototype,"overlayHighlight",void 0),(0,r.e)([qD()],ND.prototype,"overlayNormal",void 0),(0,r.e)([qD()],ND.prototype,"objectOpacity",void 0),(0,r.e)([kD()],ND.prototype,"commonMaterialParameters",void 0),(0,r.e)([kD()],ND.prototype,"componentParameters",void 0),(0,r.e)([qD()],ND.prototype,"alphaCutoff",void 0),(0,r.e)([qD()],ND.prototype,"alphaDiscardMode",void 0),(0,r.e)([qD()],ND.prototype,"isIntegratedMesh",void 0),(0,r.e)([qD()],ND.prototype,"polygonOffsetEnabled",void 0),(0,r.e)([qD()],ND.prototype,"ellipsoidMode",void 0),(0,r.e)([qD()],ND.prototype,"sceneHasOcludees",void 0);class jD extends BD{constructor(){super(...arguments),this.doubleSided=!1,this.cullFace=2,this.slicePlaneEnabled=!0}}(0,r.e)([qD()],jD.prototype,"doubleSided",void 0),(0,r.e)([qD()],jD.prototype,"cullFace",void 0),(0,r.e)([qD()],jD.prototype,"slicePlaneEnabled",void 0);class HD extends BD{constructor(){super(...arguments),this.externalColor=(0,_e.t)(1,1,1,1),this.externalColorMixMode=1,this.castShadows=0}get transparent(){return this.externalColor[3]<1?0:2}get opaqueOverride(){return 3===this.externalColorMixMode&&1===this.externalColor[3]?0:2}get visible(){return this.externalColor[3]>0?0:2}get type(){return 0}}(0,r.e)([qD({vectorOps:j.I})],HD.prototype,"externalColor",void 0),(0,r.e)([qD()],HD.prototype,"externalColorMixMode",void 0),(0,r.e)([qD()],HD.prototype,"castShadows",void 0);class WD extends BD{constructor(){super(...arguments),this.texture=null,this.transparent=2,this.opaqueOverride=2,this.castShadows=2}get type(){return 1}}(0,r.e)([qD()],WD.prototype,"texture",void 0),(0,r.e)([qD()],WD.prototype,"transparent",void 0),(0,r.e)([qD()],WD.prototype,"opaqueOverride",void 0),(0,r.e)([qD()],WD.prototype,"castShadows",void 0);class QD{constructor(e){this._low=(0,B.n)(),this._high=(0,B.n)(),e&&this.set(e)}get low(){return this._low}get high(){return this._high}set(e){const t=this._low,i=this._high;(0,v.h)(t,e),(0,v.J)(i,e,t)}setElements(e,t,i){(0,v.a)(ZD,e,t,i),this.set(ZD)}get(e){return(0,v.u)(e,this._low,this._high)}getLowScaled(e){return(0,v.d)(e,this._low,1)}}const ZD=(0,v.n)();class YD{constructor(e){this.maxCount=e,this._nextIndex=0,this.recycledIndices=[]}get activeCount(){return this._nextIndex-this.recycledIndices.length}get availableCount(){return this.recycledIndices.length+this.maxCount-this._nextIndex}acquire(){return this.recycledIndices.length>0?this.recycledIndices.pop():this.availableCount?this._nextIndex++:void 0}release(e){this.recycledIndices.push(e)}}class XD{constructor(e,t=1){this.rctx=e,this.fieldCount=t,this.textureWidth=4096,this.dirty=!0,this.texture=new q.r(this.rctx,{target:3553,pixelFormat:6408,dataType:5121,samplingMode:9728,wrapMode:33071,width:this.textureWidth,height:1,flipped:!1}),this.data=new de.x(new ArrayBuffer(4*this.textureWidth))}dispose(){this.texture.dispose(),this.texture=void 0,this.data=void 0}setData(e,t,i,r,s,n){const a=e*this.fieldCount+t;this.dirty=!0,this.data.set(a,0,i),this.data.set(a,1,r),this.data.set(a,2,s),this.data.set(a,3,n)}setDataElement(e,t,i,r){const s=e*this.fieldCount+t;this.dirty=!0,this.data.set(s,i,r)}resizeToFit(e){const t=e*this.fieldCount;if(t>=this.data.count){const e=Math.ceil((t+1)/this.textureWidth)*this.textureWidth,i=new de.x(new ArrayBuffer(4*e));i.typedBuffer.set(this.data.typedBuffer),this.data=i}}updateTexture(){if(!this.dirty)return;const e=this.texture.descriptor.width,t=this.texture.descriptor.height;this.data.count>e*t&&this.texture.resize(e,this.data.count/e),this.texture.setData(this.data.typedBuffer),this.dirty=!1}bind(e,t,i){e.bindTexture(this.texture,t),e.setUniform2f(i,1/this.texture.descriptor.width,1/this.texture.descriptor.height)}}class $D{constructor(e,t=1){this.textureBuffer=new XD(e,t),this.indexManager=new YD(65536)}dispose(){this.textureBuffer.dispose(),this.textureBuffer=void 0}get availableCount(){return this.indexManager.availableCount}get activeCount(){return this.indexManager.activeCount}acquireIndex(){const e=this.indexManager.acquire();return this.textureBuffer.resizeToFit(e),e}releaseIndex(e){this.indexManager.release(e)}}class KD{constructor(e,t=1){this.rctx=e,this.fieldCount=t,this.buffers=[]}garbageCollect(){this.buffers=this.buffers.filter((e=>0!==e.activeCount||(e.dispose(),!1)))}destroy(){this.buffers.forEach((e=>e.dispose())),this.buffers=[]}getBuffer(e){for(const t of this.buffers)if(t.availableCount>=e)return t;if(e>65536)return null;const t=new $D(this.rctx,this.fieldCount);return this.buffers.push(t),t}updateTextures(){for(const e of this.buffers)e.textureBuffer.updateTexture()}}const JD=u.n.getLogger("esri.views.3d.webgl-engine.collections.Component.ComponentObjectCollection");class eE{constructor(e){this._renderManager=e,this._objects=new GO,this._renderSubmit=new RD(this),this._renderManager.register(this._renderSubmit),this._componentBufferManager=new KD(e.rctx)}dispose(){(0,S.i)(0===this._objects.count,"ObjectCollection should be empty upon disposal"),this._componentBufferManager.destroy()}createObject(e){const t=new qO;return t.toMapSpace=e.toMapSpace.slice(),t.transform=e.transform,t.obb=SO(e.obb),t.components=new VO(this._componentBufferManager,e.geometry.componentOffsets),t.renderable=this._createRenderable(e,t.components),t.intersectionGeometry=new KO(e.geometry.positionData,t.components),this._objects.add(e.visible?1:0,t),t}destroyObject(e){const t=e;this._objects.remove(t),t.dispose(),this._notifyDirty()}setObjectVisibility(e,t){const i=e;if(t!==i.visible){const e=t?1|i.bucketKey:-2&i.bucketKey;this._objects.updateKey(i,e),this._notifyDirty()}}preSubmit(e){const t=e.camera.eye;this._objects.forEach(((e,i)=>{1&i&&e.forEach((e=>{const i=(0,v.D)(t,e.obb.center);e.renderable.meta.cameraDepthSquared=i}))}))}getMaterial(e){return e.renderable.material}updateMaterial(e,t){const i=e.renderable.material;t(i),i.dirty&&this._notifyDirty()}setAllComponentVisibilities(e,t){const i=e;i.components.visibility.reset(t),i.components.visibilityDirty(),this._notifyDirty()}forEachVisibleComponent(e,t){return e.components.visibility.forEachComponent(t)}getComponentCount(e){const t=e,i=t.components.visibility.componentCount();return{visible:i,invisible:t.components.count-i}}setComponentData(e,t){const i=e,r=i.renderable.material;if(function(e){return"function"==typeof e}(t)){const e=i.components,s=e.materialDataBuffer,n=e.materialDataIndices,a={castShadows:!0,pickable:!0,externalColor:(0,_e.a)(),externalColorMixMode:1},o=s.textureBuffer,l=new Uint8Array(4),c=new Uint32Array(l.buffer);let h=0,d=0,u=0,p=!1,m=0;for(let i=0;i<e.count;i++)t(i,a),h+=+(a.externalColor[3]<1),d+=+(3===a.externalColorMixMode&&1===a.externalColor[3]),u+=+a.castShadows,Ey(a.externalColor,a.externalColorMixMode,l),l[2]=254&l[2]|+a.castShadows,o.setData(n[i],0,l[0],l[1],l[2],l[3]),p=p||i>0&&m!==c[0],m=c[0],a.pickable!==XO(e.pickability,i)&&(e.pickability=YO(e.pickability,e.count,i,a.pickable));p?(r.componentParameters=new WD,r.componentParameters.castShadows=iE(u,e.count),r.componentParameters.transparent=iE(h,e.count),r.componentParameters.opaqueOverride=iE(d,e.count),r.componentParameters.texture=o,o.updateTexture()):(r.componentParameters=new HD,r.componentParameters.castShadows=a.castShadows?0:2,r.componentParameters.externalColor=a.externalColor,r.componentParameters.externalColorMixMode=a.externalColorMixMode)}else r.componentParameters=new HD,r.componentParameters.castShadows=t.castShadows?0:2,r.componentParameters.externalColor=t.externalColor,r.componentParameters.externalColorMixMode=t.externalColorMixMode;this._notifyDirty()}getComponentAabb(e,t,i){return e.intersectionGeometry.getComponentAabb(t,i)}getComponentObb(e){return e.obb}getObjectTransform(e){return e.transform}getComponentPositions(e,t,i){return e.intersectionGeometry.getComponentPositions(t,i)}intersect(e,t,i,r,s,n){const a=e;(0,u.r)(s)&&(s.localOrigin=a.transform.position);const o=(0,Y.u)(rE,a.transform.rotationScale);(0,v.J)(sE,t,a.transform.position),(0,v.J)(nE,i,a.transform.position),(0,v.L)(sE,sE,o),(0,v.L)(nE,nE,o);const l=(0,Y.o)(rE,o);return a.intersectionGeometry.intersect(sE,nE,r,l,s,n)}addEdges(e,t,i,r){const s=e,{indices:n,positions:a}=s.intersectionGeometry,o=s.components.offsets;return t.addComponentObject(e,s.transform,s.obb.center,a,n,o,i,r)}addComponentHighlight(e,t){const i=e.components;(0,u.t)(i.highlightCounts)&&(i.highlightCounts=new Uint32Array(i.count+1)),0==i.highlightCounts[t]++&&(i.highlightsDirty(),this._notifyDirty()),i.highlightCounts[i.count]++}removeComponentHighlight(e,t){const i=e.components;if((0,u.t)(i.highlightCounts))return void JD.warn("Removing non-existing highlight.");const r=i.highlightCounts[t],s=i.highlightCounts[i.count];if(0!==r){if(r>1)return i.highlightCounts[t]=r-1,void(i.highlightCounts[i.count]=s-1);i.highlightCounts[t]=0,i.highlightsDirty(),this._notifyDirty(),1===s?i.highlightCounts=null:i.highlightCounts[i.count]=s-1}else JD.warn("Removing non-existing highlight.")}clearHighlights(e){const t=e.components;(0,u.r)(t.highlightCounts)&&(t.highlightCounts=null,t.highlightsDirty(),this._notifyDirty())}getObjectGPUMemoryUsage(e){return e.renderable.meta.gpuMemoryEstimate}get visibleObjects(){return this._objects.getBucket(1)}get performanceInfo(){const e=this._objects.getPerformanceInfo(1);return{shown:e.added,hidden:e.removed}}_createRenderable(e,t){const i=this._renderManager.rctx,r=e.geometry,n=r.vertices.layoutParameters,a=V.h.createVertex(i,35044,r.vertices.data),o=(0,u.x)(r.indices,(e=>V.h.createIndex(i,35044,e))),l=(0,U.t)(AD(n)),c=new Uint16Array(r.vertices.count);for(let e=0;e<t.count;e++){const i=t.offsets[e],s=t.offsets[e+1],n=t.materialDataIndices[e];if((0,u.r)(r.indices))for(let e=i;e<s;e++)c[r.indices[e]]=n;else for(let e=i;e<s;e++)c[e]=n}const h=V.h.createVertex(i,35044,c.buffer),d=new QD(e.transform.position),p=(0,s.a1)(e.transform.rotationScale);(0,Y.u)(p,p),(0,Y.o)(p,p);const m=new UD;(0,v.h)(m.worldFromModel_TL,d.low),(0,v.h)(m.worldFromModel_TH,d.high),(0,Y.n)(m.worldFromModel_RS,e.transform.rotationScale),(0,Y.n)(m.transformNormal_GlobalFromModel,p),(0,j.a)(m.toMapSpace,e.toMapSpace);const f=new ND,g=new V.f(i,f.attributeLocations,{data:l,componentIndices:tE},{data:a,componentIndices:h},(0,u.f)(o)),y=new iD(g,4,n,(0,u.r)(o)),_={cameraDepthSquared:.5,gpuMemoryEstimate:a.byteSize+h.byteSize+((0,u.r)(o)?o.byteSize:0)};return new tD(f,m,y,_)}_notifyDirty(){this._renderManager.notifyDirty()}}const tE=(0,U.t)((0,G.A)().u16("componentIndex"));function iE(e,t){return e===t?0:0===e?2:1}const rE=(0,s.a0)(),sE=(0,v.n)(),nE=(0,v.n)();function aE(e){const t=new S.n;return t.include(Gg),t.fragment.uniforms.add("tex","sampler2D"),0===e.function&&(e.hasOpacityFactor?(t.fragment.uniforms.add("opacity","float"),t.fragment.code.add(S.t`void main() {
gl_FragColor = texture2D(tex, uv) * opacity;
}`)):t.fragment.code.add(S.t`void main() {
gl_FragColor = texture2D(tex, uv);
}`)),3===e.function&&(t.fragment.uniforms.add("overlayIdx","int"),e.hasOpacityFactor&&t.fragment.uniforms.add("opacity","float"),t.fragment.code.add(S.t`
      void main() {
        vec2 overlayUV = overlayIdx == 0 ? vec2(uv.x * 0.5, uv.y) : vec2(uv.x * 0.5+ 0.5, uv.y);
        gl_FragColor = texture2D(tex, overlayUV) ${e.hasOpacityFactor?"* opacity":""};
      }`)),1===e.function&&t.fragment.code.add(S.t`void main() {
gl_FragColor = vec4(1.0 - texture2D(tex, uv).a);
}`),2===e.function&&(t.fragment.uniforms.add("colorTexture","sampler2D"),t.fragment.uniforms.add("alphaTexture","sampler2D"),t.fragment.uniforms.add("frontFaceTexture","sampler2D"),t.fragment.code.add(S.t`void main() {
vec4 srcColor = texture2D(colorTexture, uv);
float srcAlpha = texture2D(alphaTexture, uv).r;
vec4 frontFace = texture2D(frontFaceTexture, uv);
if(srcColor.a <= 1e-5){
discard;
}
gl_FragColor = vec4(mix(srcColor.rgb/srcColor.a, frontFace.rgb, frontFace.a), 1.0 - srcAlpha);
}`)),t}var oE=Object.freeze({__proto__:null,build:aE});class lE extends S.c{initializeProgram(e){const t=lE.shader.get().build(this.configuration);return new S.d(e.rctx,t,S.o)}initializePipeline(){if(1===this.configuration.function)return(0,V.g)({colorWrite:{r:!1,g:!0,b:!1,a:!1}});switch(this.configuration.alphaMode){case 0:return(0,V.g)({colorWrite:V.r});case 1:return(0,V.g)({blending:(0,V.e)(770,1,771,771),colorWrite:V.r});default:return(0,V.g)({blending:(0,V.t)(1,771),colorWrite:V.r})}}}lE.shader=new S.f(oE,(()=>i.e(1555).then(i.bind(i,91555))));class cE extends S.b{constructor(){super(...arguments),this.function=0,this.alphaMode=0,this.hasOpacityFactor=!1}}(0,r.e)([(0,S.a)({count:4})],cE.prototype,"function",void 0),(0,r.e)([(0,S.a)({count:3})],cE.prototype,"alphaMode",void 0),(0,r.e)([(0,S.a)()],cE.prototype,"hasOpacityFactor",void 0);class hE{constructor(e,t){this._rctx=e,this._techniqueRepository=t}dispose(){this._vao=(0,u.z)(this._vao)}compositeTransparent(e,t,i,r=1){const s=this._rctx;dE.alphaMode=1,dE.function=2,dE.hasOpacityFactor=1!==r;const n=this._techniqueRepository.acquire(lE,dE);s.useProgram(n.program),n.bindPipelineState(s),n.program.bindTexture(e,"colorTexture"),n.program.bindTexture(t,"alphaTexture"),n.program.bindTexture(i,"frontFaceTexture");const a=this.ensureVAO();s.bindVAO(a),s.drawArrays(5,0,(0,V.a)(a,"geometry")),n.release()}compositeSpecial(e,t){this.composite(e,0,1,t)}composite(e,t=0,i=1,r=0,s=0){const n=this._rctx;dE.alphaMode=t,dE.function=r,dE.hasOpacityFactor=1!==i;const a=this._techniqueRepository.acquire(lE,dE);n.useProgram(a.program),a.bindPipelineState(n),a.program.bindTexture(e,"tex"),dE.hasOpacityFactor&&a.program.setUniform1f("opacity",i),3===r&&a.program.setUniform1i("overlayIdx",s);const o=this.ensureVAO();n.bindVAO(o),n.drawArrays(5,0,(0,V.a)(o,"geometry")),a.release()}ensureVAO(){return(0,u.t)(this._vao)&&(this._vao=(0,S.l)(this._rctx)),this._vao}}const dE=new cE;function uE(e,t,i){return(0,S.bF)(t,e)*(i[1]-i[0])+i[0]}function pE(e,t,i){if(!i.isVisible)return;if(!Ra(t.frustum,i.boundingVolumeWorldSpace.bounds))return;const r=i.transformation,n=yE;i.geometryRecords.forEach((i=>{(0,C.e)(n,r,i.getShaderTransformation());const a=(0,s.H)(n);mE(e,t,i.geometry.boundingInfo,n,a)}))}function mE(e,t,i,r,s){if((0,u.t)(i))return;const n=t.eye,a=t.viewForward;(0,v.I)(vE,i.center,r);const o=a[0]*(vE[0]-n[0])+a[1]*(vE[1]-n[1])+a[2]*(vE[2]-n[2]);if(vE[3]=i.radius*s,!(o-vE[3]>e.near&&o+vE[3]<e.far)&&Ra(t.frustum,vE))if(i.radius>100&&i.getChildren()){const n=i.getChildren();for(let i=0;i<8;++i)n[i]&&mE(e,t,n[i],r,s)}else wE.unionDepthRangeWithAABB(e,t.viewProjectionMatrix,r,i.bbMin,i.bbMax)}function fE(e,t,i){const r=t.eye,s=t.viewForward,n=(i[0]-r[0])*s[0]+(i[1]-r[1])*s[1]+(i[2]-r[2])*s[2];e.near=Math.min(e.near,n-i[3]),e.far=Math.max(e.far,n+i[3])}const gE=[[0,1,3],[2,3,1],[1,5,2],[6,2,5],[5,4,6],[7,6,4],[4,0,7],[3,7,0],[3,2,7],[6,7,2],[4,5,0],[1,0,5]],vE=(0,S._)(),yE=(0,T.e)(),_E=rD(),xE=new class{constructor(){this._items=new r.f({allocator:e=>e||{obj:null,distance:0,near:0,far:0},deallocator:e=>(e.obj=null,e.distance=0,e.near=0,e.far=0,e)})}get length(){return this._items.length}get empty(){return 0===this._items.length}clear(){this._items.clear()}add(e){this._items.pushNew().obj=e}sort(e){const t=e.eye,i=e.viewForward;this._items.forAll((e=>{const r=e.obj.boundingVolumeWorldSpace.bounds,s=(r[0]-t[0])*i[0]+(r[1]-t[1])*i[1]+(r[2]-t[2])*i[2];e.distance=s,e.near=s-r[3],e.far=s+r[3]})),this._items.sort(((e,t)=>e.distance-t.distance))}forEachInDepthRange(e,t,i){if(1===t)for(let t=0;t<this._items.length;++t){const r=this._items.data[t];r.far<e.near||r.near>e.far||i(r.obj,r.near,r.far)}else for(let t=this._items.length-1;t>=0;--t){const r=this._items.data[t];r.far<e.near||r.near>e.far||i(r.obj,r.near,r.far)}}},bE=new class{constructor(){this.view=(0,T.e)(),this.viewProj=(0,T.e)(),this.frustum=wa(),this.geometries=[],this.near=[],this.far=[],this.nearCandidates=[],this.farCandidates=[],this.range={near:0,far:0},this.looseRange={near:0,far:0}}compute(e,t){this.reset(),(0,C.n)(this.view,e.viewMatrix),(0,C.e)(this.viewProj,e.projectionMatrix,this.view),Ta(e.frustum,this.frustum);const i=this.view,r=i[2],s=i[6],n=i[10],a=i[14],o=this.range;let l=0;if(t.forEach((e=>{if(!e.instanceParameters.visible)return;if(!e.castShadow)return;let t;e.hasShaderTransformation?(e.computeBoundingSphere(e.getShaderTransformation(),vE,1),t=vE):t=e.boundingSphere;const i=r*t[0]+s*t[1]+n*t[2]+a,o=i-t[3],c=i+t[3];this.geometries[l]=e,this.near[l]=-c,this.far[l]=-o,++l})),0===this.geometries.length)return o;for(let e=0;e<this.geometries.length;++e)this.near[e]>o.far&&(o.far=this.near[e]),this.near[e]>2&&this.far[e]<o.near&&(o.near=this.far[e]);const c=this.looseRange;c.near=Math.max(.5*o.near,2),c.far=2*o.far;let h=0,d=0;for(let e=0;e<this.geometries.length;++e)this.near[e]<o.near&&(this.near[e]>=c.near?o.near=this.near[e]:this.nearCandidates[h++]=e),this.far[e]>o.far&&(this.far[e]<=c.far?o.far=this.far[e]:this.farCandidates[d++]=e);if(0===this.nearCandidates.length&&0===this.farCandidates.length)return o;this.nearCandidates.sort(((e,t)=>this.near[e]<this.near[t]?-1:this.near[e]>this.near[t]?1:0)),this.farCandidates.sort(((e,t)=>this.far[e]<this.far[t]?1:this.far[e]>this.far[t]?-1:0));for(let e=0;e<this.nearCandidates.length;++e){const t=this.nearCandidates[e];if(this.near[t]<o.near){const e=this.geometries[t],i=e.boundingInfo;this.includeNearBoundingInfoRec(i,e.getShaderTransformation())}}for(let e=0;e<this.farCandidates.length;++e){const t=this.farCandidates[e];if(this.far[t]>o.far){const e=this.geometries[t],i=e.boundingInfo;this.includeFarBoundingInfoRec(i,e.getShaderTransformation())}}return o}reset(){this.geometries.length=0,this.near.length=0,this.far.length=0,this.nearCandidates.length=0,this.farCandidates.length=0,this.range.near=Number.MAX_VALUE,this.range.far=-Number.MAX_VALUE}includeNearBoundingInfoRec(e,t){if((0,u.t)(e))return;const i=e.getCenter();(0,v.I)(vE,i,t);const r=(0,s.H)(t),n=vE[0],a=vE[1],o=vE[2],l=e.getBSRadius()*r,c=this.frustum;if(c[0][0]*n+c[0][1]*a+c[0][2]*o+c[0][3]>l||c[1][0]*n+c[1][1]*a+c[1][2]*o+c[1][3]>l||c[2][0]*n+c[2][1]*a+c[2][2]*o+c[2][3]>l||c[3][0]*n+c[3][1]*a+c[3][2]*o+c[3][3]>l)return;const h=this.view[2]*n+this.view[6]*a+this.view[10]*o+this.view[14],d=h+l;if(!(-(h-l)<2||-d>=this.range.near))if(-d>this.looseRange.near)this.range.near=-d;else{if(l>100){const i=e.getChildren();if(void 0!==i){for(let e=0;e<8;++e)void 0!==i[e]&&this.includeNearBoundingInfoRec(i[e],t);return}}wE.unionDepthRangeWithAABB(this.range,this.viewProj,t,e.getBBMin(),e.getBBMax())}}includeFarBoundingInfoRec(e,t){if((0,u.t)(e))return;let i=e.getBSRadius();const r=e.getCenter();(0,v.I)(vE,r,t);const n=(0,s.H)(t),a=vE[0],o=vE[1],l=vE[2];i*=n;const c=this.frustum;if(c[0][0]*a+c[0][1]*o+c[0][2]*l+c[0][3]>i||c[1][0]*a+c[1][1]*o+c[1][2]*l+c[1][3]>i||c[2][0]*a+c[2][1]*o+c[2][2]*l+c[2][3]>i||c[3][0]*a+c[3][1]*o+c[3][2]*l+c[3][3]>i)return;const h=this.view[2]*a+this.view[6]*o+this.view[10]*l+this.view[14]-i;if(!(-h<=this.range.far))if(-h<this.looseRange.far)this.range.far=-h;else{if(i>100){const i=e.getChildren();if(void 0!==i){for(let e=0;e<8;++e)void 0!==i[e]&&this.includeFarBoundingInfoRec(i[e],t);return}}wE.unionDepthRangeWithAABB(this.range,this.viewProj,t,e.getBBMin(),e.getBBMax())}}},wE=new class{constructor(){this.modelViewProj=(0,T.e)(),this.clipPosition=[(0,w.n)(),(0,w.n)(),(0,w.n)(),(0,w.n)(),(0,w.n)(),(0,w.n)(),(0,w.n)(),(0,w.n)()]}unionDepthRangeWithAABB(e,t,i,r,s){const n=this.modelViewProj;(0,C.e)(n,t,i);let a=!1;for(let e=0;e<8;++e){const t=this.clipPosition[e],i=0===e||3===e||4===e||7===e?r[0]:s[0],a=0===e||1===e||4===e||5===e?r[1]:s[1],o=e<4?r[2]:s[2];t[0]=n[0]*i+n[4]*a+n[8]*o+n[12],t[1]=n[1]*i+n[5]*a+n[9]*o+n[13],t[2]=n[2]*i+n[6]*a+n[10]*o+n[14],t[3]=n[3]*i+n[7]*a+n[11]*o+n[15]}for(let t=0;t<12;++t){const i=this.clipPosition[gE[t][0]],r=this.clipPosition[gE[t][1]],s=this.clipPosition[gE[t][2]],n=this.clipTriangle(i,r,s);let o=!0;for(let e=0;e<n.length;++e)if(n[e][3]>=2){o=!1;break}if(!o){a=!0;for(let t=0;t<n.length;++t){const i=n[t][3];i<e.near&&(e.near=i),i>e.far&&(e.far=i)}}}return a}inside(e,t){return 0===t?e[0]>=-e[3]:1===t?e[1]>=-e[3]:2===t?e[0]<=e[3]:3===t?e[1]<=e[3]:void(0,S.i)(!1)}intersect(e,t,i){let r=0;return 0===i?r=(-e[3]-e[0])/(t[0]-e[0]+t[3]-e[3]):1===i?r=(-e[3]-e[1])/(t[1]-e[1]+t[3]-e[3]):2===i?r=(e[3]-e[0])/(t[0]-e[0]-t[3]+e[3]):3===i&&(r=(e[3]-e[1])/(t[1]-e[1]-t[3]+e[3])),(0,j.j)((0,w.n)(),e,t,r)}clipTriangle(e,t,i){let r=[e,t,i];for(let e=0;e<4;++e){const t=r;r=[];for(let i=0;i<t.length;++i){const s=t[i],n=t[(i+1)%t.length];this.inside(n,e)?(this.inside(s,e)||r.push(this.intersect(s,n,e)),r.push(n)):this.inside(s,e)&&r.push(this.intersect(s,n,e))}}return r}};let CE=class extends r.p{constructor(){super(...arguments),this._handles=new R.u,this._magnifier=null,this._imageSources=null,this._imageLoadTask=null,this._resources=null,this.events=new n.n,this.attributeLocations=new Map([["position",0]]),this.tmpScreenPoint=(0,f.i)(),this.tmpRenderPoint=(0,f.s)()}get updating(){return(0,u.t)(this._imageSources)&&(0,u.r)(this._imageLoadTask)&&!this._imageLoadTask.task.finished}get magnifier(){return this._magnifier}set magnifier(e){if(e===this._magnifier)return;this._handles.removeAll(),this._magnifier=e;const t=()=>{this.updateResourceLoading(),this.events.emit("request-render")};(0,u.r)(this._magnifier)&&this._handles.add(this._magnifier.watch("version",t)),t()}get enabled(){return(0,u.r)(this._validMagnifier)}get _validMagnifier(){return(0,u.r)(this._magnifier)&&this._magnifier.visible&&(0,u.r)(this._magnifier.position)&&this._magnifier.size>0?this._magnifier:null}get factor(){return(0,u.r)(this._magnifier)&&this._magnifier.factor||1}dispose(){this._magnifier=null,this._handles.destroy(),(0,u.r)(this._imageLoadTask)&&(this._imageLoadTask.task.abort(),this._imageLoadTask=null),this.disposeResources()}render(e,t){const i=this._validMagnifier;if((0,u.t)(i))return;const r=t.camera.pixelRatio,s=Math.ceil(r*i.size);if(this.updateResources(e,s),(0,u.t)(this._resources))return;const n=this._resources.program;e.useProgram(n);const a=this._resources.textures,o=Math.ceil(1/this.factor*s);a.input.resize(o,o);const l=t.camera.fullWidth,c=t.camera.fullHeight;(0,f.d)(i.position,this.tmpScreenPoint);const h=t.camera.screenToRender(this.tmpScreenPoint,this.tmpRenderPoint),d=.5*o,p=.5*o;h[0]=(0,v.o)(h[0],d,l-d-1),h[1]=(0,v.o)(h[1],p,c-p-1);const m=Math.floor(h[0]-d),g=Math.floor(h[1]-p);n.bindTexture(a.input,"textureInput"),e.gl.copyTexImage2D(a.input.descriptor.target,0,a.input.descriptor.pixelFormat,m,g,o,o,0);const y=i.offset.x*r,_=i.offset.y*r,x=(h[0]+y)/l*2-1,b=(h[1]-_)/c*2-1,w=s/l*2,C=s/c*2;e.bindVAO(this._resources.vao),n.bindTexture(a.overlay,"textureOverlay"),n.bindTexture(a.mask,"textureMask"),n.setUniform4f("drawPosition",x,b,w,C),n.setUniform1i("maskEnabled",i.maskEnabled?1:0),n.setUniform1i("overlayEnabled",i.overlayEnabled?1:0),e.setPipelineState(this._resources.pipelineState),e.drawArrays(5,0,4)}updateResourceLoading(){const e=this._validMagnifier;if((0,u.t)(e))return;const t=e.maskUrl,i=e.overlayUrl;!(0,u.r)(this._imageLoadTask)||this._imageLoadTask.maskUrl===t&&this._imageLoadTask.overlayUrl===i||(this._imageLoadTask.task.abort(),this._imageLoadTask=null,this._imageSources=null),(0,u.r)(this._imageSources)||(0,u.r)(this._imageLoadTask)||(this._imageLoadTask={maskUrl:t,overlayUrl:i,task:(0,h.G)((async e=>{const r=(0,u.t)(t)||(0,u.t)(i)?(0,K.c)(e):null,s=(0,u.r)(t)?(0,F.t)(t,{signal:e}):r.then((e=>e.mask)),n=(0,u.r)(i)?(0,F.t)(i,{signal:e}):r.then((e=>e.overlay));this._imageSources={mask:await s,overlay:await n},this.disposeResources(),this.events.emit("request-render")}))},this._imageLoadTask.task.promise.then((()=>this.notifyChange("updating")),(()=>this.notifyChange("updating"))))}updateResources(e,t){if(!this.enabled)return void this.disposeResources();if((0,u.r)(this._resources)){if(this._resources.textures.size!==t){const i=this.createTextureResources(e,t);if((0,u.t)(i))return void this.disposeResources();this.disposeTextureResources(this._resources.textures),this._resources.textures=i}return}const i=this.createTextureResources(e,t);(0,u.t)(i)||(this._resources={textures:i,program:this.createProgram(e),vao:(0,S.l)(e,S.bG,this.attributeLocations,0,1),pipelineState:(0,V.g)({blending:(0,V.t)(1,771),depthTest:null,depthWrite:null,colorWrite:V.r})})}disposeResources(){(0,u.t)(this._resources)||(this.disposeTextureResources(this._resources.textures),this._resources.program.dispose(),this._resources.vao.dispose(),this._resources=null)}disposeTextureResources(e){e.mask.dispose(),e.overlay.dispose(),e.input.dispose()}createTextureResources(e,t){if((0,u.t)(this._imageSources))return null;this._imageSources.overlay.width=t,this._imageSources.overlay.height=t,this._imageSources.mask.width=t,this._imageSources.mask.height=t;const i=new q.r(e,{target:3553,pixelFormat:6408,internalFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9729,flipped:!0,preMultiplyAlpha:!(0,n.w)(this._imageSources.overlay.src)||!(0,S.bb)(e).svgAlwaysPremultipliesAlpha},this._imageSources.overlay),r=new q.r(e,{target:3553,pixelFormat:6406,internalFormat:6406,dataType:5121,wrapMode:33071,samplingMode:9729,flipped:!0},this._imageSources.mask);return{input:new q.r(e,{target:3553,pixelFormat:6408,internalFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9729,flipped:!1}),mask:r,overlay:i,size:t}}createProgram(e){const t=function(){const e=new S.n;return e.attributes.add("position","vec2"),e.vertex.uniforms.add("proj","mat4"),e.vertex.uniforms.add("drawPosition","vec4"),e.varyings.add("vUV","vec2"),e.vertex.code.add(S.t`void main(void) {
vUV = position;
gl_Position = vec4(drawPosition.xy + vec2(position - 0.5) * drawPosition.zw, 0.0, 1.0);
}`),e.fragment.uniforms.add("textureInput","sampler2D"),e.fragment.uniforms.add("textureMask","sampler2D"),e.fragment.uniforms.add("textureOverlay","sampler2D"),e.fragment.uniforms.add("maskEnabled","bool"),e.fragment.uniforms.add("overlayEnabled","bool"),e.fragment.code.add(S.t`const float barrelFactor = 1.1;
vec2 barrel(vec2 uv) {
vec2 uvn = uv * 2.0 - 1.0;
if (uvn.x == 0.0 && uvn.y == 0.0) {
return vec2(0.5, 0.5);
}
float theta = atan(uvn.y, uvn.x);
float r = pow(length(uvn), barrelFactor);
return r * vec2(cos(theta), sin(theta)) * 0.5 + 0.5;
}
void main() {
float mask = maskEnabled ? texture2D(textureMask, vUV).a : 1.0;
vec4 inputColor = texture2D(textureInput, barrel(vUV)) * mask;
vec4 overlayColor = overlayEnabled ? texture2D(textureOverlay, vUV) : vec4(0);
gl_FragColor = overlayColor + (1.0 - overlayColor.a) * inputColor;
}`),e}();return new S.d(e,t,this.attributeLocations)}};(0,r.e)([(0,d.y)()],CE.prototype,"_imageSources",void 0),(0,r.e)([(0,d.y)()],CE.prototype,"_imageLoadTask",void 0),(0,r.e)([(0,d.y)({readOnly:!0})],CE.prototype,"updating",null),CE=(0,r.e)([(0,d.n)("esri/views/3d/webgl-engine/lib/MagnifierHelper")],CE);class TE{constructor(e,t=.9){this._alpha=.9,this._startTime=0,this._count=0,this._sum=0,this._smooth=0,this._min=0,this._max=0,this._name=e,this._alpha=t,this.reset()}reset(){this._count=0,this._sum=0,this._smooth=0,this._min=1/0,this._max=0}get name(){return this._name}get count(){return this._count}get average(){return this._count>0?this._sum/this._count:0}get smooth(){return this._smooth}get min(){return this._min}get max(){return this._max}begin(){this._startTime=performance.now()}end(){const e=performance.now()-this._startTime;this._count+=1,this._sum+=e,this._smooth=this._alpha*e+(1-this._alpha)*this._smooth,this._min=Math.min(this._min,e),this._max=Math.max(this._max,e)}toJSON(){return{name:this.name,count:this.count,average:this.average,smooth:this.smooth,min:this.min,max:this.max}}}!function(e){const t={},i={};function r(i){return i in t||(t[i]=new e(i)),t[i]}function s(e){console.log(r(e).toJSON())}e.get=r,e.begin=function(e){r(e).begin()},e.end=function(e,t=!0){r(e).end();const n=performance.now();t&&(!(e in i)||n>=i[e]+1e3)&&(s(e),i[e]=n)},e.log=s,e.logAll=function(){for(const e in t)s(e)}}(TE||(TE={}));var SE=TE;class PE{constructor(){this.identifier=0,this.transparent=!1,this.integratedMesh=!1,this.viewTransform=new S.bv.ViewProjectionTransform,this.transformNormal_ViewFromGlobal=(0,X.e)(),this.cameraNearFar=(0,N.n)(),this.inverseViewport=(0,N.n)(),this.slicePlane=lt(),this.slicePlaneEnabled=!0,this.ambientOcclusionEnabled=!0,this.shadowsEnabled=!0,this.sceneHasOcludees=!1,this.transparencyPassType=3}}class RE{constructor(){this.identifier=1,this.viewTransform=new S.bv.ViewProjectionTransform,this.cameraNearFar=(0,N.n)(),this.slicePlane=lt()}}class AE{constructor(){this.identifier=2,this.viewTransform=new S.bv.ViewProjectionTransform,this.slicePlane=lt(),this.inverseViewport=(0,N.n)(),this.viewport=(0,w.n)()}}class ME{constructor(e,t,i=0){this._rctx=e,this._techniqueRepository=t,this._sorting=i,this._draws=new r.f({initialSize:32,allocator:e=>e||{material:null,geometry:null,geometryRanges:null,bindDrawParams:null,depthSquaredHint:0,indexType:0}}),this._passBoundTechniques=new Set,this._previouslyBoundMaterials=new Map,this._previouslyBoundDraw=new Map}submitDraw(e,t,i,r,s){const n=this._draws.pushNew();n.geometry=t,n.geometryRanges=i,n.material=e,n.bindDrawParams=r,n.depthSquaredHint=s,n.indexType=t.indexed?(0,u.f)(t.vao.indexBuffer).indexType:0}dispatch(e){const t=this._rctx;this._passBoundTechniques.clear(),this._previouslyBoundMaterials.clear(),this._previouslyBoundDraw.clear();let i=null;const r=this._draws.length;for(let s=0;s<r;s++){const r=this._draws.data[s],n=r.geometry,a=r.material.getTechnique(this._techniqueRepository,e,n.parameters);a===i&&3===a.configuration.transparencyPassType||(t.useProgram(a.program),t.setPipelineState(a.pipeline),i=a),this._passBoundTechniques.has(a)||(a.bindPass(e),this._passBoundTechniques.add(a)),t.bindVAO(n.vao),this._previouslyBoundMaterials.get(a)!==r.material&&(a.bindMaterial(r.material,e),this._previouslyBoundMaterials.set(a,r.material)),this._previouslyBoundDraw.get(a)!==r.bindDrawParams&&(a.bindDraw(r.bindDrawParams,r.material,e),this._previouslyBoundDraw.set(a,r.bindDrawParams));const o=r.geometryRanges,l=o.length;if(0!==r.indexType){const e=OE.get(r.indexType);for(let i=0;i<l;i+=2){const s=o[i],a=o[i+1];t.drawElements(n.primitiveType,a,r.indexType,s*e)}}else for(let e=0;e<l;e+=2){const i=o[e],r=o[e+1];t.drawArrays(n.primitiveType,i,r)}}}prepareSubmit(){this._draws.clear()}finishSubmit(){const e=0===this._sorting?1:-1;this._draws.sort(((t,i)=>{const r=e*(t.depthSquaredHint-i.depthSquaredHint);return 0!==r?r:t.geometry.vao.size-i.geometry.vao.size}))}get count(){return this._draws.length}}const OE=new Map;OE.set(5121,1),OE.set(5123,2),OE.set(5125,4);class DE{constructor(e,t){this.rctx=e,this.shaderTechniqueRepository=t,this.canRender=!0,this._materialPassParams=new PE,this._shadowPassParams=new RE,this._highlightPassParams=new AE,this._systems=new Set,this._passes=new Array,this._shadowMapPass=this._registerPass(new ME(e,this.shaderTechniqueRepository)),this.passes={materialOpaque:this._registerPass(new ME(e,this.shaderTechniqueRepository)),materialTransparent:this._registerPass(new ME(e,this.shaderTechniqueRepository,1)),materialIntegratedMesh:this._registerPass(new ME(e,this.shaderTechniqueRepository)),shadowMap:this._shadowMapPass,highlight:this._registerPass(new ME(e,this.shaderTechniqueRepository)),highlightIntegratedMesh:this._registerPass(new ME(e,this.shaderTechniqueRepository)),highlightShadowMap:this._registerPass(new ME(e,this.shaderTechniqueRepository)),defaultShadowMap:this._registerPass(new ME(e,this.shaderTechniqueRepository))}}register(e){this._systems.add(e)}prepareRender(e){0!==this._systems.size&&(this._passes.forEach((e=>e.prepareSubmit())),this._systems.forEach((t=>t.submit(this.passes,{camera:e}))),this._passes.forEach((e=>e.finishSubmit())),this.shaderTechniqueRepository.frameUpdate())}render(e){if(0===this._systems.size)return!1;if(4===e.slot)switch(this._configure(e),e.pass){case 0:this._materialPassParams.subPass=0,this._configureMaterialColorPass(e),this.passes.materialOpaque.dispatch(this._materialPassParams);break;case 2:this._materialPassParams.subPass=2,this.passes.materialOpaque.dispatch(this._materialPassParams);break;case 3:this._materialPassParams.subPass=3,this.passes.materialOpaque.dispatch(this._materialPassParams);break;case 5:this.passes.highlight.dispatch(this._highlightPassParams);break;case 4:this._shadowMapPass.dispatch(this._shadowPassParams);break;case 7:(0,u.r)(this.passes.highlightShadowMap)&&this.passes.highlightShadowMap.dispatch(this._shadowPassParams);break;case 6:(0,u.r)(this.passes.defaultShadowMap)&&this.passes.defaultShadowMap.dispatch(this._shadowPassParams)}if(6===e.slot)switch(this._configure(e),e.pass){case 0:this._materialPassParams.subPass=0,this._configureMaterialColorPass(e),this.passes.materialTransparent.dispatch(this._materialPassParams);break;case 1:this._materialPassParams.subPass=1,this._configureMaterialColorPass(e),this.passes.materialTransparent.dispatch(this._materialPassParams);break;case 2:this._materialPassParams.subPass=2,this.passes.materialTransparent.dispatch(this._materialPassParams);break;case 3:this._materialPassParams.subPass=3,this.passes.materialTransparent.dispatch(this._materialPassParams)}if(1===e.slot)switch(this._configure(e),e.pass){case 0:this._materialPassParams.subPass=0,this._configureMaterialColorPass(e),this._materialPassParams.ssrParams=e.ssrParams,this.passes.materialIntegratedMesh.dispatch(this._materialPassParams);break;case 2:this._materialPassParams.subPass=2,this.passes.materialIntegratedMesh.dispatch(this._materialPassParams);break;case 3:this._materialPassParams.subPass=3,this.passes.materialIntegratedMesh.dispatch(this._materialPassParams);break;case 5:this.passes.highlightIntegratedMesh.dispatch(this._highlightPassParams)}return!0}notifyDirty(){this.context.requestRender()}slots(){return[4,6,1]}initializeRenderContext(e){this.context=e}uninitializeRenderContext(){}queryDepthRange(e){const t={near:1/0,far:-1/0};return this._systems.forEach((i=>{const r=i.queryShadowCasterDepthRange(e);(0,u.r)(r)&&nD(t,r,t)})),t}get shadowCastingEnabled(){return(0,u.r)(this.passes.shadowMap)}set shadowCastingEnabled(e){e?(this._materialPassParams.shadowsEnabled=!0,this.passes.shadowMap=this._shadowMapPass):(this._materialPassParams.shadowsEnabled=!1,this.passes.shadowMap=null)}get screenSpaceReflectionsEnabled(){return(0,u.r)(this._materialPassParams.ssrParams.ssrEnabled)}set screenSpaceReflectionsEnabled(e){this._materialPassParams.ssrParams.ssrEnabled=!!e}_configureMaterialColorPass(e){this._materialPassParams.bindShadowMap=t=>{e.shadowMap.bind(t);const i=this._materialPassParams.viewTransform;(0,v.u)(EE,i.worldFromView_TL,i.worldFromView_TH),e.shadowMap.bindView(t,EE)},this._materialPassParams.bindAmbientOcclusion=t=>e.ssaoHelper.bind(t),this._materialPassParams.ambientOcclusionEnabled=!!e.ssaoHelper&&e.ssaoHelper.ready,this._materialPassParams.sceneHasOcludees=e.hasOccludees}_configure(e){const t=4===e.pass||7===e.pass||6===e.pass?this._shadowPassParams:5===e.pass?this._highlightPassParams:this._materialPassParams;this._updateParameters(e,t)}_updateParameters(e,t){const i=e.camera,r=i.viewInverseTransposeMatrix;(0,v.a)(EE,r[3],r[7],r[11]),IE.set(EE),(0,v.h)(t.viewTransform.worldFromView_TH,IE.high),(0,v.h)(t.viewTransform.worldFromView_TL,IE.low),(0,Y.a)(t.viewTransform.viewFromCameraRelative_RS,i.viewMatrix),(0,C.n)(t.viewTransform.projFromView,i.projectionMatrix),0===t.identifier?(this._materialPassParams.transparent=6===e.slot,this._materialPassParams.integratedMesh=1===e.slot,this._materialPassParams.lighting=e.scenelightingData,(0,Y.o)(zE,t.viewTransform.viewFromCameraRelative_RS),(0,Y.u)(t.transformNormal_ViewFromGlobal,zE),(0,k.r)(t.cameraNearFar,i.near,i.far)):1===t.identifier?(0,k.r)(t.cameraNearFar,i.near,i.far):2===t.identifier&&(t.highlightDepthTexture=e.highlightDepthTexture,(0,j.a)(t.viewport,i.fullViewport)),0!==t.identifier&&2!==t.identifier||(t.inverseViewport[0]=1/i.fullViewport[2],t.inverseViewport[1]=1/i.fullViewport[3]),ht(e.sliceHelper.plane,t.slicePlane),(0,v.c)(t.slicePlane.origin,t.slicePlane.origin,EE),t.slicePlaneEnabled=e.sliceHelper.isEnabled,this._materialPassParams.transparencyPassType=e.transparencyPassType,this._materialPassParams.multipassTerrainParams=e.multipassTerrainParams}_registerPass(e){return this._passes.push(e),e}get needsHighlight(){return this.passes.highlight.count>0||this.passes.highlightIntegratedMesh.count>0}}const EE=(0,v.n)(),zE=(0,X.e)(),IE=new QD;function LE(e){const t=new S.n,i=t.vertex.code,r=t.fragment.code;return t.attributes.add("position","vec2"),2===e.highlightStage&&(i.add(S.t`void main() {
gl_Position = vec4(vec2(1.0) - position * 2.0, 0.0, 1.0);
}`),t.fragment.uniforms.add("tex","sampler2D"),t.fragment.uniforms.add("invFramebufferDim","vec2"),r.add(S.t`void main() {
vec2 coord = gl_FragCoord.xy * invFramebufferDim;
vec4 value = texture2D(tex, coord);
float mx = floor(max(value.g, value.b));
gl_FragColor = vec4(ceil(value.r), mx, mx, 1.0);
}`)),0===e.highlightStage&&(t.attributes.add("uv0","vec2"),e.gridOptimization?(t.vertex.uniforms.add("coverageTex","sampler2D"),t.fragment.uniforms.add("blurSize","vec2"),t.varyings.add("blurCoordinate","vec3")):(t.vertex.uniforms.add("blurSize","vec2"),t.varyings.add("blurCoordinates[5]","vec2")),i.add(S.t`
    void main() {
      gl_Position = vec4(position, 0.0, 1.0);
      ${e.gridOptimization?S.t`
      vec4 cov = texture2D(coverageTex, uv0);
      if (cov.r == 0.0) {
        gl_Position = vec4(0.0);
      }
      blurCoordinate = vec3(gl_Position.xy * 0.5 + vec2(0.5), max(cov.g, cov.b));
      `:S.t`
      vec2 uv = position.xy * 0.5 + vec2(0.5);
      blurCoordinates[0] = uv;
      blurCoordinates[1] = uv + blurSize * 1.407333;
      blurCoordinates[2] = uv - blurSize * 1.407333;
      blurCoordinates[3] = uv + blurSize * 3.294215;
      blurCoordinates[4] = uv - blurSize * 3.294215;
          `}
    }`),t.fragment.uniforms.add("tex","sampler2D"),r.add(S.t`
    void main() {
      ${e.gridOptimization?S.t`
          vec2 uv = blurCoordinate.xy;
          vec4 center = texture2D(tex, uv);

          // do not blur if no pixel or all pixels in neighborhood are set
          if (blurCoordinate.z == 1.0) {
            gl_FragColor = center;
          } else {
            vec4 sum = vec4(0.0);
            sum += center * 0.204164;
            sum += texture2D(tex, uv + blurSize * 1.407333) * 0.304005;
            sum += texture2D(tex, uv - blurSize * 1.407333) * 0.304005;
            sum += texture2D(tex, uv + blurSize * 3.294215) * 0.093913;
            sum += texture2D(tex, uv - blurSize * 3.294215) * 0.093913;
            gl_FragColor = sum;
          }`:S.t`
          vec4 sum = vec4(0.0);
          sum += texture2D(tex, blurCoordinates[0]) * 0.204164;
          sum += texture2D(tex, blurCoordinates[1]) * 0.304005;
          sum += texture2D(tex, blurCoordinates[2]) * 0.304005;
          sum += texture2D(tex, blurCoordinates[3]) * 0.093913;
          sum += texture2D(tex, blurCoordinates[4]) * 0.093913;
          gl_FragColor = sum;`}
    }`)),1===e.highlightStage&&(t.varyings.add("uv","vec2"),e.gridOptimization&&(t.attributes.add("uv0","vec2"),t.vertex.uniforms.add("coverageTex","sampler2D")),i.add(S.t`
      void main() {
        ${e.gridOptimization?S.t`
            vec4 cov = texture2D(coverageTex, uv0);
            // if no highlight pixel set in this block, hide block
            if (cov.r == 0.0) {
              gl_Position = vec4(0.0);
              return;
            }`:""}
        gl_Position = vec4(position, 0.0, 1.0);
        uv = position.xy * 0.5 + vec2(0.5);
      }`),t.fragment.uniforms.add("tex","sampler2D"),t.fragment.uniforms.add("origin","sampler2D"),t.fragment.uniforms.add("color","vec4"),t.fragment.uniforms.add("haloColor","vec4"),t.fragment.uniforms.add("outlineSize","float"),t.fragment.uniforms.add("blurSize","float"),t.fragment.uniforms.add("opacities","vec4"),r.add(S.t`void main() {
vec4 blurredHighlightValue = texture2D(tex, uv);
float highlightIntensity = blurredHighlightValue.a;
if (highlightIntensity == 0.0) {
discard;
}
vec4 origin_color = texture2D(origin, uv);
float outlineIntensity;
float fillIntensity;
if (blurredHighlightValue.g > blurredHighlightValue.b) {
outlineIntensity = haloColor.w * opacities[1];
fillIntensity = color.w * opacities[3];
}
else {
outlineIntensity = haloColor.w * opacities[0];
fillIntensity = color.w * opacities[2];
}
float inner = 1.0 - outlineSize / 9.0;
float outer = 1.0 - (outlineSize + blurSize) / 9.0;
float outlineFactor = smoothstep(outer, inner, highlightIntensity);
float fillFactor = any(notEqual(origin_color, vec4(0.0, 0.0, 0.0, 0.0))) ? 1.0 : 0.0;
float intensity = outlineIntensity * outlineFactor * (1.0 - fillFactor) + fillIntensity * fillFactor;
gl_FragColor = vec4(mix(haloColor.rgb, color.rgb, fillFactor), intensity);
}`)),t}var FE=Object.freeze({__proto__:null,build:LE});class VE extends S.c{initializeProgram(e){const t=VE.shader.get().build(this.configuration);return new S.d(e.rctx,t,S.o)}bindApplyPass(e){this.program.setUniform4fv("color",e.color),this.program.setUniform4fv("haloColor",e.haloColor),this.program.setUniform1f("outlineSize",8.6),this.program.setUniform1f("blurSize",.4),this.program.setUniform4f("opacities",e.haloOpacity,e.haloOpacityOccluded,e.fillOpacity,e.fillOpacityOccluded)}initializePipeline(){return 1===this.configuration.highlightStage?(0,V.g)({blending:(0,V.e)(770,1,771,771),colorWrite:V.r}):(0,V.g)({colorWrite:V.r})}get primitiveType(){return this.configuration.gridOptimization?4:5}}VE.shader=new S.f(FE,(()=>i.e(6649).then(i.bind(i,16649))));class UE extends S.b{constructor(){super(...arguments),this.highlightStage=0,this.gridOptimization=!1}}(0,r.e)([(0,S.a)({count:3})],UE.prototype,"highlightStage",void 0),(0,r.e)([(0,S.a)()],UE.prototype,"gridOptimization",void 0);class GE{constructor(e,t){this._techniqueRep=e,this._rctx=t,this.viewportToRestore=(0,w.n)(),this.defaultOptions={color:(0,_e.t)(1,0,1,1),haloColor:(0,_e.t)(1,0,1,1),haloOpacity:1,fillOpacity:.2,haloOpacityOccluded:.25,fillOpacityOccluded:.05,shadowColor:(0,_e.t)(1,0,1,1),shadowOpacity:.15,occludedShadowOpacity:.075},this._grid={coverageMipmap:null,vao:null,verticalCellCount:0,horizontalCellCount:0,cellPixelSize:0,mipmapLevels:0,viewportWidth:0,viewportHeight:0}}assertResources(){if(this.quadVAO)return;this.quadVAO=(0,S.l)(this._rctx);const e={colorTarget:0,depthStencilTarget:0,width:0,height:0},t={target:3553,pixelFormat:6408,dataType:5121,samplingMode:9729,wrapMode:33071,width:0,height:0};this.blur0Fbo=new V.o(this._rctx,e,t),this.blur1Fbo=new V.o(this._rctx,e,t);const i=new UE;i.highlightStage=0,i.gridOptimization=!1,this.blurTechnique=this._techniqueRep.acquire(VE,i),i.highlightStage=0,i.gridOptimization=!0,this.blurGridTechnique=this._techniqueRep.acquire(VE,i),i.highlightStage=1,i.gridOptimization=!1,this.applyTechnique=this._techniqueRep.acquire(VE,i),i.highlightStage=1,i.gridOptimization=!0,this.applyGridTechnique=this._techniqueRep.acquire(VE,i),i.highlightStage=2,i.gridOptimization=!1,this.downsampleTechnique=this._techniqueRep.acquire(VE,i)}dispose(){if(this._grid.coverageMipmap)for(let e=1;e<this._grid.coverageMipmap.length;e++)this._grid.coverageMipmap[e].dispose();this._grid.vao&&this._grid.vao.dispose(!0),this.quadVAO&&(this.quadVAO.dispose(!0),this.quadVAO=null),this.blur0Fbo=(0,u.z)(this.blur0Fbo),this.blur1Fbo=(0,u.z)(this.blur1Fbo)}get profilingCallback(){return Ih.HIGHLIGHTS_PROFILE_TO_CONSOLE?e=>console.log(e):null}setDefaultOptions(e){this.defaultOptions=e}render(e,t,i){const r=e.pixelRatio,s=Ih.HIGHLIGHTS_GRID_OPTIMIZATION_ENABLED,n=this._rctx;this.assertResources(),(0,j.a)(this.viewportToRestore,e.fullViewport);const a=e.fullWidth,o=e.fullHeight,l=Math.ceil(a/r),c=Math.ceil(o/r);this.blur0Fbo.resize(l,c),this.blur1Fbo.resize(l,c),n.bindVAO(this.quadVAO);let h=null;const d=s?this.blurGridTechnique:this.blurTechnique;d.bindPipelineState(n),n.useProgram(d.program),s?(this._gridUpdateResources(t,32),this._gridComputeMipmap(),h=this._grid.vao,d.program.bindTexture(this._grid.coverageMipmap[this._grid.mipmapLevels].colorTexture,"coverageTex")):h=this.quadVAO,n.bindVAO(h),n.bindFramebuffer(this.blur0Fbo),n.setViewport(0,0,l,c),n.setClearColor(0,0,0,0),n.clear(16384),d.program.bindTexture(t.colorTexture,"tex"),d.program.setUniform2f("blurSize",1/l,0),n.drawArrays(d.primitiveType,0,(0,V.a)(h,"geometry")),n.bindFramebuffer(this.blur1Fbo),n.clear(16384),d.program.bindTexture(this.blur0Fbo.colorTexture,"tex"),d.program.setUniform2f("blurSize",0,1/c),n.drawArrays(d.primitiveType,0,(0,V.a)(h,"geometry"));const u=s?this.applyGridTechnique:this.applyTechnique;if(n.bindFramebuffer(i),u.bindPipelineState(n),n.setViewport(this.viewportToRestore[0],this.viewportToRestore[1],this.viewportToRestore[2],this.viewportToRestore[3]),n.useProgram(u.program),u.program.bindTexture(this.blur1Fbo.colorTexture,"tex"),u.program.bindTexture(t.colorTexture,"origin"),s){const e=this._grid.coverageMipmap[this._grid.mipmapLevels].colorTexture;u.program.bindTexture(e,"coverageTex")}u.bindApplyPass(this.defaultOptions),n.drawArrays(u.primitiveType,0,(0,V.a)(h,"geometry")),n.bindVAO(null)}_gridUpdateResources(e,t){const i=this._rctx,r=this._grid;let s=!1;if(null===r.coverageMipmap&&(r.coverageMipmap=[e],s=!0),r.viewportWidth===e.width&&r.viewportHeight===e.height||(s=!0,r.viewportWidth=e.width,r.viewportHeight=e.height),r.coverageMipmap[0]=e,r.cellPixelSize!==t&&(r.cellPixelSize=t,s=!0),s){for(let e=1;e<r.coverageMipmap.length;e++)r.coverageMipmap[e].dispose();r.mipmapLevels=Math.ceil(Math.log(r.cellPixelSize)*Math.LOG2E),r.coverageMipmap.length=r.mipmapLevels+1;for(let e=0;e<r.mipmapLevels;e++){const t=r.coverageMipmap[e],s={target:3553,pixelFormat:6407,dataType:33635,samplingMode:9729,wrapMode:33071,width:Math.ceil(t.width/2),height:Math.ceil(t.height/2)},n={colorTarget:0,depthStencilTarget:0,width:Math.ceil(t.width/2),height:Math.ceil(t.height/2)};r.coverageMipmap[e+1]=new V.o(i,n,s)}}const n=Math.ceil(e.height/r.cellPixelSize),a=Math.ceil(e.width/r.cellPixelSize);if(!r.vao||r.verticalCellCount!==n||r.horizontalCellCount!==a){r.verticalCellCount=n,r.horizontalCellCount=a;const e=n+1,t=a+1,s=1/n,o=1/a,l=6,c=4,h=new Float32Array(l*c*e*t);let d=0;for(let i=0;i<e;i++)for(let e=0;e<t;e++)h[d+0]=(e-.5)*o*2-1,h[d+1]=(i-.5)*s*2-1,h[d+2]=e*o,h[d+3]=i*s,h[d+4]=(e+.5)*o*2-1,h[d+5]=(i-.5)*s*2-1,h[d+6]=e*o,h[d+7]=i*s,h[d+8]=(e-.5)*o*2-1,h[d+9]=(i+.5)*s*2-1,h[d+10]=e*o,h[d+11]=i*s,h[d+12]=(e-.5)*o*2-1,h[d+13]=(i+.5)*s*2-1,h[d+14]=e*o,h[d+15]=i*s,h[d+16]=(e+.5)*o*2-1,h[d+17]=(i-.5)*s*2-1,h[d+18]=e*o,h[d+19]=i*s,h[d+20]=(e+.5)*o*2-1,h[d+21]=(i+.5)*s*2-1,h[d+22]=e*o,h[d+23]=i*s,d+=l*c;r.vao&&r.vao.dispose(!0),r.vao=new V.f(i,S.o,{geometry:S.bh},{geometry:V.h.createVertex(i,35044,h)})}}_gridComputeMipmap(){const e=this._rctx,t=this._grid,i=this.downsampleTechnique.program;this.downsampleTechnique.bindPipelineState(e),e.bindVAO(this.quadVAO),e.useProgram(i);for(let r=0;r<t.mipmapLevels;r++){e.bindFramebuffer(t.coverageMipmap[r+1]),i.bindTexture(t.coverageMipmap[r].colorTexture,"tex");const s=t.coverageMipmap[r+1].width,n=t.coverageMipmap[r+1].height;i.setUniform2f("invFramebufferDim",1/s,1/n),e.setViewport(0,0,s,n),e.drawArrays(5,0,(0,V.a)(this.quadVAO,"geometry"))}}getGpuMemoryUsage(){let e=((0,u.r)(this.blur0Fbo)?this.blur0Fbo.gpuMemoryUsage:0)+((0,u.r)(this.blur1Fbo)?this.blur1Fbo.gpuMemoryUsage:0);if(this._grid.coverageMipmap)for(const t of this._grid.coverageMipmap)e+=t.gpuMemoryUsage;return e}get test(){return{coverage:this._grid.coverageMipmap,blur:[this.blur0Fbo,this.blur1Fbo]}}}const BE={dataType:5121,internalFormat:6408},qE={};class kE{constructor(e){this.rctx=e,this._activeTargets=new Set,this._depthTextures=new Map,this._depthBuffers=new Map,this._colorTextures=new Map,this._framebuffers=new Map,this._nextId=1,this.depthTextureSupported=e.capabilities.depthTexture}dispose(){this._depthBuffers.forEach((e=>e.dispose())),this._depthBuffers.clear(),this._depthTextures.forEach((e=>e.dispose())),this._depthTextures.clear(),this._colorTextures.forEach((e=>e.dispose())),this._colorTextures.clear(),this._framebuffers.forEach((e=>e.dispose())),this._framebuffers.clear()}disposeTargetResource(e){const t=e.id;this._activeTargets.has(t)&&(this._activeTargets.delete(t),this.disposeWithFramebuffers(this._depthTextures,t),this.disposeWithFramebuffers(this._depthBuffers,t),this.disposeWithFramebuffers(this._colorTextures,t))}disposeWithFramebuffers(e,t){const i=e.get(t);i&&(this._framebuffers.forEach(((e,t)=>{e.colorAttachment!==i&&e.depthStencilAttachment!==i||(e.detachAll(),e.dispose(),this._framebuffers.delete(t))})),i.dispose(),e.delete(t))}getDepthTexture(e,t){if(!this.depthTextureSupported)return;let i=this._depthTextures.get(e.id);return i&&(i.descriptor.width===t.width&&i.descriptor.height===t.height||(i.dispose(),i=void 0)),i||(i=new q.r(this.rctx,{target:3553,pixelFormat:34041,dataType:34042,samplingMode:9728,wrapMode:33071,width:t.width,height:t.height}),this._depthTextures.set(e.id,i),this._activeTargets.add(e.id)),i}getAllocatedDepthTexture(e){return this._depthTextures.get(e.id)}getDepthBuffer(e,t){if(this.depthTextureSupported)return;let i=this._depthBuffers.get(e.id);return i?i.descriptor.width===t.width&&i.descriptor.height===t.height||i.resize(t.width,t.height):(i=new V.k(this.rctx,{internalFormat:34041,...t}),this._depthBuffers.set(e.id,i),this._activeTargets.add(e.id)),i}getColorTexture(e,t){let i=this._colorTextures.get(e.id);return i&&(i.descriptor.width===t.width&&i.descriptor.height===t.height||(i.dispose(),i=void 0)),i||(i=new q.r(this.rctx,{target:3553,pixelFormat:6408,internalFormat:e.internalFormat,dataType:e.dataType,samplingMode:null!=e.samplingMode?e.samplingMode:9729,wrapMode:33071,width:t.width,height:t.height}),this._colorTextures.set(e.id,i),this._activeTargets.add(e.id)),i}getAllocatedColorTexture(e){return this._colorTextures.get(e.id)}registerDepthTarget(e={}){return{id:this._nextId++,...qE,...e}}registerColorTarget(e={}){return{id:this._nextId++,...BE,...e}}getFramebuffer(e,t,i){const r=this.getKey(t,i);let s=this._framebuffers.get(r);const n=this.getColorTexture(t,e);if(this.depthTextureSupported){const t=i?this.getDepthTexture(i,e):void 0;return s?((s.width!==e.width||s.height!==e.height||s.colorTexture!==n||s.depthStencilTexture!==t)&&(s.detachAll(),s.resize(e.width,e.height),s.attachColorTexture(n),s.attachDepthStencilTexture(t)),s):(s=i?new V.o(this.rctx,{colorTarget:0,depthStencilTarget:4},n,t):new V.o(this.rctx,{colorTarget:0,depthStencilTarget:0},n),this._framebuffers.set(r,s),s)}const a=i?this.getDepthBuffer(i,e):void 0;return s?((s.width!==e.width||s.height!==e.height||s.colorTexture!==n)&&(s.detachAll(),s.resize(e.width,e.height),s.attachColorTexture(n),s.attachDepthStencilBuffer(a)),s):(s=new V.o(this.rctx,{colorTarget:0,depthStencilTarget:i?3:0},n,a),this._framebuffers.set(r,s),s)}getKey(e,t){return`${e.id}_${t?t.id:"X"}_${e.name}${t?"_"+t.name:""}`}getGpuMemoryUsage(){let e=0;const t=new Set,i=i=>{t.has(i)||(t.add(i),e+=(0,V.j)(i))};return this._depthTextures.forEach(i),this._colorTextures.forEach(i),this._depthBuffers.forEach(i),e}}class NE{constructor(e,t){this._rctx=e,this._compositingHelper=t,this._currentRenderTarget=0,this.dimensions={width:4,height:4},this._needLastFrameColorTexture=!1,this._background={type:"color",color:[0,0,0,1]};const i=this._rctx,r="webgl2"===i.webglVersion;this.renderTargetHelper=new kE(i);const s=this.renderTargetHelper;this.mainColorTarget0=s.registerColorTarget({name:"mainColorTarget0"}),this.mainColorTarget1=s.registerColorTarget({name:"mainColorTarget1"}),this.frontFaceTarget=s.registerColorTarget({name:"frontFaceTarget"});const n=e=>s.registerColorTarget({name:e,dataType:5126,internalFormat:r?34836:6408,samplingMode:9728});this.colorFloatTarget=n("colorFloatTarget"),this.alphaFloatTarget=n("alphaFloatTarget"),this.mainDepth=s.registerDepthTarget({name:"mainDepth"}),this.linearDepth=s.registerColorTarget({name:"linearDepth",samplingMode:9728}),this.terrainLinearDepth=s.registerColorTarget({name:"terrainLinearDepth"}),this.geometryLinearDepth=s.registerColorTarget({name:"geometryLinearDepth"}),this.normal=s.registerColorTarget({name:"normal"}),this.highlight=s.registerColorTarget({name:"highlight",internalFormat:r?32854:6408,dataType:32819}),this.hudVisibility=s.registerColorTarget({name:"hudVisibility",internalFormat:r?32854:6408,dataType:32819}),this.tmpColor=s.registerColorTarget({name:"tmpColor"}),this.tmpDepth=s.registerDepthTarget({name:"tmpDepth"}),this.hudColor=s.registerColorTarget({name:"hudColor"})}dispose(){this.renderTargetHelper.dispose()}get width(){return this.dimensions.width}get height(){return this.dimensions.height}set background(e){this._background=e}get background(){return this._background}get currentColorTarget(){return 0===this._currentRenderTarget?this.mainColorTarget0:this.mainColorTarget1}get previousColorTarget(){return 0===this._currentRenderTarget?this.mainColorTarget1:this.mainColorTarget0}get currentRenderTarget(){return this._currentRenderTarget}get framebuffer(){return this.getFramebuffer(this.currentColorTarget,this.mainDepth)}getFramebuffer(e,t){return this.renderTargetHelper.getFramebuffer(this.dimensions,e,t)}get colorTexture(){return this.renderTargetHelper.getAllocatedColorTexture(this.currentColorTarget)}get depthTexture(){return this.renderTargetHelper.getAllocatedDepthTexture(this.mainDepth)}get linearDepthTexture(){return this.renderTargetHelper.getAllocatedColorTexture(this.linearDepth)}get terrainLinearDepthTexture(){return this.renderTargetHelper.getAllocatedColorTexture(this.terrainLinearDepth)}get geometryLinearDepthTexture(){return this.renderTargetHelper.getAllocatedColorTexture(this.geometryLinearDepth)}get lastFrameColorTexture(){return this.renderTargetHelper.getAllocatedColorTexture(this.previousColorTarget)}get normalTexture(){return this.renderTargetHelper.getAllocatedColorTexture(this.normal)}get highlightTexture(){return this.renderTargetHelper.getAllocatedColorTexture(this.highlight)}get hudVisibilityTexture(){return this.getColorTexture(this.hudVisibility)}get tmpColorTexture(){return this.getColorTexture(this.tmpColor)}get hudColorTexture(){return this.getColorTexture(this.hudColor)}get mainColorTexture(){return this.getColorTexture(this.currentColorTarget)}advanceCurrentRenderTarget(){this._currentRenderTarget=0===this._currentRenderTarget&&this._needLastFrameColorTexture?1:0}initializeFrame(e){const t=this._rctx;this.dimensions.width=e.fullWidth,this.dimensions.height=e.fullHeight,this.bindTarget(this.currentColorTarget,this.mainDepth),t.setClearStencil(0);const i=this._background.color;t.setClearColor(i[0]*i[3],i[1]*i[3],i[2]*i[3],i[3]),t.clearSafe(17664)}composite(){this._compositingHelper.composite(this.colorTexture,0)}renderTmpAndCompositeToMain(e,t,i=!1){this.renderToTargets(e,this.tmpColor,i?this.tmpDepth:this.mainDepth,jE),this._compositingHelper.composite(this.getColorTexture(this.tmpColor),t)}renderHUDVisibility(e,t=!1){this.renderToTargets(e,this.hudVisibility,t?this.tmpDepth:this.mainDepth,HE)}compositeTransparentTerrainOntoHUDVisibility(){this.renderToTargets((()=>{this._compositingHelper.compositeSpecial(this.getColorTexture(this.tmpColor),1)}),this.hudVisibility,this.tmpDepth)}renderOITPass(e,t,i){let r,s;switch(t){case 0:r=this.colorFloatTarget,s=[0,0,0,0];break;case 1:r=this.alphaFloatTarget,s=[1,1,1,1];break;case 2:r=this.frontFaceTarget,s=[0,0,0,0]}i?this.renderToTargets(e,r,this.tmpDepth,s,!0,!0):this.renderToTargets(e,r,this.mainDepth,s,!1)}compositeTransparentTerrainOntoMain(){this.bindFramebuffer(),this._compositingHelper.composite(this.getColorTexture(this.tmpColor),2)}compositeOccludedOntoMain(e){this.bindFramebuffer(),this._compositingHelper.composite(this.getColorTexture(this.tmpColor),2,e)}compositeTransparentOntoOpaque(e){e?(this.bindTarget(this.hudColor,this.tmpDepth),this._rctx.setClearColor(0,0,0,1e-13),this._rctx.clearSafe(16384)):this.bindFramebuffer(),this._compositingHelper.compositeTransparent(this.getColorTexture(this.colorFloatTarget),this.getColorTexture(this.alphaFloatTarget),this.getColorTexture(this.frontFaceTarget))}bindFramebuffer(){this._rctx.bindFramebuffer(this.framebuffer)}renderDepthDetached(e){this.bindTarget(this.currentColorTarget),e(),this.bindTarget(this.currentColorTarget,this.mainDepth)}disposeTarget(e){this.renderTargetHelper.disposeTargetResource(e)}set needLastFrameColorTexture(e){!e&&this._needLastFrameColorTexture&&(this._currentRenderTarget=0,this.disposeTarget(this.mainColorTarget1)),this._needLastFrameColorTexture=e}get needLastFrameColorTexture(){return this._needLastFrameColorTexture}renderToTargets(e,t,i,r,s=!1,n=!1){const a=this._rctx,o=this.bindTarget(t,i);let l=0;if(r){const e=1e-13,t=Math.max(e,r[3]);a.setClearColor(r[0],r[1],r[2],t),l|=16384}return s&&(l|=256),!1===n?n=0:(!0===n&&(n=255),l|=1024),l&&a.clearSafe(l,n),e(),a.gl.flush(),this.bindTarget(this.currentColorTarget,this.mainDepth),o}bindTarget(e,t){const i=this.renderTargetHelper.getFramebuffer(this.dimensions,e,t);return this._rctx.bindFramebuffer(i),i}getColorTexture(e){return this.renderTargetHelper.getColorTexture(e,this.dimensions)}getGpuMemoryUsage(){let e=0;return this.renderTargetHelper&&(e+=this.renderTargetHelper.getGpuMemoryUsage()),e}}const jE=[0,0,0,0],HE=[0,1,0,1];class WE{constructor(e){this.context=e,this.renderPlugins=new Array,this.slots=[];for(let e=0;e<23;++e)this.slots[e]=[]}add(e,t,i=null){const r=t.initializeRenderContext(this.context,i),s=()=>{this.renderPlugins.push(t);for(let i=0;i<e.length;++i){const r=e[i];this.slots[r].push(t)}this.context.requestRender()};if((0,h.z)(r))return r.then(s);s()}remove(e){const t=this.renderPlugins.length;this.renderPlugins=this.renderPlugins.filter((t=>t!==e)),(0,S.i)(this.renderPlugins.length<t,"Removing non-added render plugin");for(let t=0;t<this.slots.length;++t)this.slots[t]=this.slots[t].filter((t=>t!==e));e.uninitializeRenderContext(),this.context.requestRender()}prepareRender(e,t){for(const i of this.renderPlugins)i.prepareRender&&i.prepareRender(e,t)}render(){const e=this.slots[this.context.renderContext.slot];let t=!1;for(const i of e)i.canRender&&i.render(this.context.renderContext)&&(t=!0);return t}queryDepthRange(e){const t=QE;t.near=1/0,t.far=-1/0;for(const i of this.renderPlugins)if(i.queryDepthRange){const r=i.queryDepthRange(e);r&&nD(t,r,t)}return t}get needsHighlight(){return this.renderPlugins.some((e=>e.needsHighlight))}get needsLinearDepth(){return this.renderPlugins.some((e=>e.needsLinearDepth))}get needsLaserlineWithContrastControl(){const e=this.slots[17];return!!e&&e.length>0}get renderOccludedFlags(){let e=0;return this.renderPlugins.forEach((t=>{t.renderOccludedFlags&&(e|=t.renderOccludedFlags)})),e}}const QE={near:0,far:0};function ZE(e){e.fragment.uniforms.add("projInfo","vec4"),e.fragment.uniforms.add("zScale","vec2"),e.fragment.code.add(S.t`vec3 reconstructPosition(vec2 fragCoord, float depth) {
return vec3((fragCoord * projInfo.xy + projInfo.zw) * (zScale.x * depth + zScale.y), depth);
}`)}const YE=255,XE=1/YE;function $E(e){const t=new S.n;t.fragment.include(S.M),t.fragment.include(S.L),t.include(ZE),t.include(Gg);const{pass:i}=e;if(1===i){const{visualization:i,bandsEnabled:r}=e;t.fragment.constants.add("inverseSampleValue","float",YE),t.fragment.uniforms.add("shadowAccumulationMap","sampler2D"),t.fragment.uniforms.add("sampleScale","float"),t.fragment.uniforms.add("opacityFromElevation","float"),0===i?(t.fragment.uniforms.add("colorRamp","sampler2D"),t.fragment.uniforms.add("rampSize","float"),t.fragment.code.add(S.t`vec4 sampleColorRamp(sampler2D ramp, float rampSize, float u) {
float rampU = (u * (rampSize - 1.0) + 0.5) / rampSize;
return texture2D(ramp, vec2(rampU, 0.5));
}`),r&&t.fragment.uniforms.add("bandSize","float")):1===i&&(t.fragment.uniforms.add("threshold","float"),t.fragment.uniforms.add("colors","vec4",2)),t.fragment.code.add(S.t`
      void main(void) {
        vec4 record = texture2D(shadowAccumulationMap, uv);
        float pixelSamples = record.r * inverseSampleValue;

        if (pixelSamples < 1.0) {
          discard;
        }

        float strength = pixelSamples * sampleScale;

        ${0===i&&r?S.t`strength = ceil(strength / bandSize) * bandSize;`:""}

        gl_FragColor = ${0===i?S.t`sampleColorRamp(colorRamp, rampSize, strength)`:S.t`strength <= threshold ? colors[0] : colors[1]`};

        gl_FragColor.a *= opacityFromElevation;
      }
    `)}else 0!==i&&2!==i||(t.include(S.aG),t.fragment.uniforms.add("depthMap","sampler2D"),t.fragment.uniforms.add("inverseView","mat4"),t.fragment.uniforms.add("nearFar","vec2"),0===i?t.fragment.constants.add("sampleValue","float",XE):t.fragment.constants.add("shadowColor","vec4",[0,0,0,.8]),t.fragment.code.add(S.t`
      void main(void) {

        float depth = rgba2float(texture2D(depthMap, uv));
        // 0.0 is the clear value of depthMap, which means nothing has been drawn there and we should discard
        if (depth == 0.0) {
          discard;
        }

        float currentPixelDepth = linearDepthFromFloat(depth, nearFar);

        if (-currentPixelDepth > nearFar.y || -currentPixelDepth < nearFar.x) {
          discard;
        }

        vec4 currentPixelPos = vec4(reconstructPosition(gl_FragCoord.xy, currentPixelDepth), 1.0);
        vec4 worldSpacePos = inverseView * currentPixelPos;

        mat4 shadowMatrix;
        float linearDepth = -currentPixelDepth;
        int i = chooseCascade(linearDepth, shadowMatrix);

        if (i >= uShadowMapNum) {
          discard;
        }

        vec3 lvpos = lightSpacePosition(worldSpacePos.xyz, shadowMatrix);

        // vertex completely outside? -> no shadow
        if (lvpos.z >= 1.0 || lvpos.x < 0.0 || lvpos.x > 1.0 || lvpos.y < 0.0 || lvpos.y > 1.0) {
          discard;
        }

        vec2 uvShadow = cascadeCoordinates(i, lvpos);

        float depthShadow = readShadowMapDepth(uvShadow, uShadowMapTex);
        bool shadow = depthShadow < lvpos.z;

        if (!shadow) {
          discard;
        }

        gl_FragColor = ${0===i?S.t`vec4(sampleValue)`:S.t`shadowColor`};
      }
    `));return t}var KE=Object.freeze({__proto__:null,shadowAccumulationMaxSamples:YE,build:$E});class JE extends S.c{initializeProgram(e){const t=JE.shader.get().build(this.configuration);return new S.d(e.rctx,t,S.o)}initializePipeline(e){return 0===this.configuration.pass?(0,V.g)({blending:(0,V.e)(1,1,1,1),colorWrite:V.r,depthTest:null,depthWrite:null}):1===this.configuration.pass||2===this.configuration.pass?(0,V.g)({blending:S.ar,colorWrite:V.r,depthTest:null,depthWrite:null}):(0,V.g)({})}bindPass(e){if(0===this.configuration.pass||2===this.configuration.pass){const t=e;this.program.bindTexture(t.linearDepthTexture,"depthMap"),t.shadowMap.bind(this.program),t.shadowMap.bindView(this.program,t.camera.center),this.program.setUniform2fv("nearFar",t.camera.nearFar),this.program.setUniformMatrix4fv("inverseView",t.inverseView),this.program.setUniform4fv("projInfo",t.projInfo),this.program.setUniform2fv("zScale",t.zScale)}else if(1===this.configuration.pass){const t=e;if(this.program.bindTexture(t.shadowAccumulationMap,"shadowAccumulationMap"),this.program.setUniform1f("sampleScale",t.sampleScale),this.program.setUniform1f("opacityFromElevation",t.opacityFromElevation),0===this.configuration.visualization){const t=e;this.program.bindTexture(t.colorRamp,"colorRamp"),this.program.setUniform1f("rampSize",t.rampSize),this.configuration.bandsEnabled&&this.program.setUniform1f("bandSize",t.bandSize)}else if(1===this.configuration.visualization){const t=e;this.program.setUniform1f("threshold",t.threshold),this.program.setUniform4fv("colors",t.colors)}}}get primitiveType(){return 5}}JE.shader=new S.f(KE,(()=>i.e(4475).then(i.bind(i,54475))));class ez extends S.b{constructor(){super(...arguments),this.pass=0,this.visualization=0,this.bandsEnabled=!1}}(0,r.e)([(0,S.a)({count:3})],ez.prototype,"pass",void 0),(0,r.e)([(0,S.a)()],ez.prototype,"visualization",void 0),(0,r.e)([(0,S.a)()],ez.prototype,"bandsEnabled",void 0);const tz=[(0,w.a)(.01,0,.25,0),(0,w.a)(.01,0,.25,1)],iz=1/512;class rz{constructor(e,t,i,s){this._techniqueRep=e,this._rctx=t,this._shadowAccumulator=i,this._requestRender=s,this._enabled=!1,this._vao=(0,S.l)(t),this._visualizationConfig=new ez,this._visualizationConfig.pass=1,this._visualizationConfig.visualization=0,this._visualizeAccumulationTechnique=e.acquire(JE,this._visualizationConfig);const n={target:3553,pixelFormat:6408,dataType:5121,samplingMode:9729,wrapMode:33071,width:tz.length,height:1};this._colorRampTexture=new q.r(this._rctx,n,sz(tz)),this._visualizationParams={shadowAccumulationMap:this._accumulationTexture,sampleScale:0,colorRamp:this._colorRampTexture,rampSize:n.width,threshold:.5,bandSize:.1,colors:(0,r.M)([(0,w.a)(0,1,0,.5),(0,w.a)(1,0,0,.5)]),opacityFromElevation:1}}dispose(){this._stop(),this._vao=(0,u.z)(this._vao),this._visualizeAccumulationTechnique=(0,u.z)(this._visualizeAccumulationTechnique),this._colorRampTexture=(0,u.z)(this._colorRampTexture),this._shadowAccumulator=null}render(){this._isRenderingVisualization&&(this._sampleScale=1/this._computedSamples,this._rctx.bindVAO(this._vao),this._rctx.useProgram(this._visualizeAccumulationTechnique.program),this._visualizeAccumulationTechnique.bindPipelineState(this._rctx),this._visualizeAccumulationTechnique.bindPass(this._visualizationParams),this._rctx.drawArrays(this._visualizeAccumulationTechnique.primitiveType,0,(0,V.a)(this._vao,"geometry")))}setOptions(e){void 0!==e.enabled&&this._setEnabled(e.enabled),void 0!==e.gradientColorRamp&&this._setColorRamp(e.gradientColorRamp),void 0!==e.threshold&&(this._threshold=e.threshold),void 0!==e.thresholdColors&&this._setThresholdColors(e.thresholdColors),void 0!==e.visualization&&(this._visualization=e.visualization),void 0!==e.bandSize&&(this._bandSize=e.bandSize),void 0!==e.bandsEnabled&&(this._bandsEnabled=e.bandsEnabled)}get opacityFromElevation(){return this._visualizationParams.opacityFromElevation}set opacityFromElevation(e){this._visualizationParams.opacityFromElevation=e}get _isRenderingVisualization(){return this._enabled&&this._computedSamples>0&&this.opacityFromElevation>iz}get _computedSamples(){return this._shadowAccumulator.computedSamples}get _accumulationTexture(){return this._shadowAccumulator.accumulationTexture}get _sampleScale(){return this._visualizationParams.sampleScale}set _sampleScale(e){this._visualizationParams.sampleScale=e}get _threshold(){return this._visualizationParams.threshold}set _threshold(e){this._threshold!==e&&(this._visualizationParams.threshold=e,this._requestRenderIfRunning())}get _visualization(){return this._visualizationConfig.visualization}set _visualization(e){if(e===this._visualization)return;const t=this._visualizationConfig;t.visualization=e,this._visualizeAccumulationTechnique=this._techniqueRep.releaseAndAcquire(JE,t,this._visualizeAccumulationTechnique),this._requestRenderIfRunning()}get _bandSize(){return this._visualizationParams.bandSize}set _bandSize(e){e!==this._bandSize&&(this._visualizationParams.bandSize=e,this._requestRenderIfRunning())}get _bandsEnabled(){return this._visualizationConfig.bandsEnabled}set _bandsEnabled(e){if(e===this._bandsEnabled)return;const t=this._visualizationConfig;t.bandsEnabled=e,this._visualizeAccumulationTechnique=this._techniqueRep.releaseAndAcquire(JE,t,this._visualizeAccumulationTechnique),this._requestRenderIfRunning()}_setColorRamp(e){const t=e.length,i=sz(e);this._colorRampTexture.resize(t,1),this._colorRampTexture.setData(i),this._visualizationParams.rampSize=t,this._requestRenderIfRunning()}_setThresholdColors(e){const t=this._visualizationParams.colors,i=(0,r.M)(e);(0,r.K)(t,i)||(this._visualizationParams.colors=i,this._requestRenderIfRunning())}_setEnabled(e){e!==this._enabled&&(e?this._start():this._stop())}_requestRenderIfRunning(){this._enabled&&this._requestRender()}_start(){this._enabled=!0,this._requestRender()}_stop(){this._enabled=!1,this._requestRender()}}function sz(e){const t=e.length,i=new Uint8Array(4*t);for(let r=0;r<t;++r){const t=e[r];i[4*r+0]=255*t[0],i[4*r+1]=255*t[1],i[4*r+2]=255*t[2],i[4*r+3]=255*t[3]}return i}class nz{constructor(){this.camera=new Ia,this.lightMat=(0,T.e)()}}class az{constructor(e,t,i=0){this.rctx=e,this.viewingMode=t,this._enabled=!1,this._snapshots=new Array,this.textureSize=0,this.maxTextureSize=0,this.numCascades=1,this.maxNumCascades=4,this.splitSchemeLambda=0,this.warp=!0,this.cascadeDistances=[0,0,0,0,0],this.cascades=[],this.maxTextureSize=this.rctx.parameters.maxTextureSize;for(let e=0;e<4;++e)this.cascades.push(new nz);this.snapshotCount=i}dispose(){this.discardDepthTexture(),this.discardAllSnapshots()}set maxCascades(e){this.maxNumCascades=(0,v.o)(Math.floor(e),1,4)}get maxCascades(){return this.maxNumCascades}set enabled(e){this._enabled=e,e||(this.discardDepthTexture(),this.discardAllSnapshots())}get enabled(){return this._enabled}get snapshotCount(){return this._snapshots.length}set snapshotCount(e){const t=this._snapshots.length;if(e>t){const i=e-t;this._snapshots.length=e;for(let e=0;e<i;++e)this._snapshots[t+e]=null}else if(e<this.snapshotCount){const i=t-e;for(let t=0;t<i;++t)this.discardSnapshot(e+t);this._snapshots.length=e}}getSnapshot(e){return this.enabled?this._snapshots[e]:null}getCascades(){for(let e=0;e<this.numCascades;++e)bz[e]=this.cascades[e];return bz.length=this.numCascades,bz}start(e,t,i){(0,S.i)(this.enabled),this.textureSize=this.computeTextureSize(e.fullWidth,e.fullHeight),this.ensureDepthTexture();const{near:r,far:s}=this.clampNearFar(i);this.computeCascadeDistances(s,r),this.setupMatrices(e,t);const n=e.viewMatrix,a=e.projectionMatrix;for(let e=0;e<this.numCascades;++e)this.constructCascade(e,a,n,t);this.lastOrigin=null,this.clear()}finish(e){(0,S.i)(this.enabled),this.rctx.bindFramebuffer(e)}bind(e){this.enabled?(this._depthTextureUnit=e.bindTexture(this._depthTexture,"uShadowMapTex"),e.setUniform1f("uDepthHalfPixelSz",.5/this.textureSize),e.setUniform1i("uShadowMapNum",this.numCascades),e.setUniform4f("uShadowMapDistance",this.cascadeDistances[0],this.numCascades>1?this.cascadeDistances[1]:1/0,this.numCascades>2?this.cascadeDistances[2]:1/0,this.numCascades>3?this.cascadeDistances[3]:1/0)):e.setUniform1f("uDepthHalfPixelSz",-1)}bindView(e,t){if(!this.enabled)return;const i=this.lastOrigin;if(!i||i[0]!==t[0]||i[1]!==t[1]||i[2]!==t[2]){this.lastOrigin=this.lastOrigin||(0,v.n)(),(0,v.h)(this.lastOrigin,t);for(let e=0;e<this.numCascades;++e){(0,C.c)(wz,this.cascades[e].lightMat,t);for(let t=0;t<16;++t)Cz[16*e+t]=wz[t]}}e.setUniformMatrix4fv("uShadowMapMatrix",Cz)}takeCascadeSnapshotTo(e,t){(0,S.i)(this.enabled),this.ensureSnapshot(t),this._bindFbo();const i=this.rctx,r=i.bindTexture(this._snapshots[t],q.r.TEXTURE_UNIT_FOR_UPDATES);i.gl.copyTexSubImage2D(3553,0,e.camera.viewport[0],e.camera.viewport[1],e.camera.viewport[0],e.camera.viewport[1],e.camera.viewport[2],e.camera.viewport[3]),i.bindTexture(r,q.r.TEXTURE_UNIT_FOR_UPDATES)}clear(){const e=this.rctx;this._bindFbo(),e.setClearColor(1,1,1,1),e.clearSafe(16640)}computeTextureSize(e,t){const i=.5*Math.log(e*e+t*t)*Math.LOG2E,r=2**Math.round(i+.35);return Math.min(this.maxTextureSize,2*r)}ensureDepthTexture(){if(null!=this._depthTexture&&this._depthTexture.descriptor.width===this.textureSize)return;this.discardDepthTexture();const e={target:3553,pixelFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9728,flipped:!0,width:this.textureSize,height:this.textureSize};this._depthTexture=new q.r(this.rctx,e),this.fbo=new V.o(this.rctx,{colorTarget:0,depthStencilTarget:1,width:this.textureSize,height:this.textureSize},this._depthTexture)}ensureSnapshot(e){const t=this._snapshots[e];if((0,u.r)(t)&&t.descriptor.width===this.textureSize)return;this.discardSnapshot(e);const i={target:3553,pixelFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9728,flipped:!0,width:this.textureSize,height:this.textureSize};this._snapshots[e]=new q.r(this.rctx,i)}discardDepthTexture(){this.fbo=(0,u.z)(this.fbo),this._depthTexture=(0,u.z)(this._depthTexture)}discardSnapshot(e){this._snapshots[e]=(0,u.z)(this._snapshots[e])}discardAllSnapshots(){for(let e=0;e<this.snapshotCount;++e)this.discardSnapshot(e)}_bindFbo(){const e=this.rctx;(0,u.r)(this._depthTextureUnit)&&(e.bindTexture(null,this._depthTextureUnit),this._depthTextureUnit=null),e.bindFramebuffer(this.fbo)}constructCascade(e,t,i,r){const s=this.cascades[e],n=-this.cascadeDistances[e],a=-this.cascadeDistances[e+1],o=(t[10]*n+t[14])/Math.abs(t[11]*n+t[15]),l=(t[10]*a+t[14])/Math.abs(t[11]*a+t[15]);(0,S.i)(o<l);for(let e=0;e<8;++e){(0,j.r)(hz,e%4==0||e%4==3?-1:1,e%4==0||e%4==1?-1:1,e<4?o:l,1),(0,j.y)(dz[e],hz,cz);for(let t=0;t<3;++t)dz[e][t]/=dz[e][3]}(0,v.E)(xz,dz[0]),(0,C.c)(oz,_z,xz),s.camera.viewMatrix=oz;for(let e=0;e<8;++e)(0,v.I)(dz[e],dz[e],s.camera.viewMatrix);(0,v.h)(uz,dz[0]),(0,v.h)(pz,dz[0]);for(let e=1;e<8;++e)for(let t=0;t<3;++t)uz[t]=Math.min(uz[t],dz[e][t]),pz[t]=Math.max(pz[t],dz[e][t]);uz[2]-=200,pz[2]+=200,s.camera.near=-pz[2],s.camera.far=-uz[2],this.warp?this.constructTrapezoidalProjection(i,r,s):this.constructOrthogonalProjection(s),(0,C.e)(s.lightMat,s.camera.projectionMatrix,s.camera.viewMatrix);const c=this.textureSize/2;s.camera.viewport[0]=e%2==0?0:c,s.camera.viewport[1]=0===Math.floor(e/2)?0:c,s.camera.viewport[2]=c,s.camera.viewport[3]=c}constructOrthogonalProjection(e){(0,C.E)(e.camera.projectionMatrix,uz[0],pz[0],uz[1],pz[1],e.camera.near,e.camera.far)}constructTrapezoidalProjection(e,t,i){const r=1/dz[0][3],s=1/dz[4][3];(0,S.i)(r<s);let n=r+Math.sqrt(r*s);const a=Math.sin((0,v.x)(e[2]*t[0]+e[6]*t[1]+e[10]*t[2]));n/=a,function(e,t,i,r,s,n,a,o){(0,k.r)(Tz,0,0);for(let t=0;t<4;++t)(0,k.s)(Tz,Tz,e[t]);(0,k.l)(Tz,Tz,.25),(0,k.r)(Sz,0,0);for(let t=4;t<8;++t)(0,k.s)(Sz,Sz,e[t]);(0,k.l)(Sz,Sz,.25),(0,k.y)(Pz[0],e[4],e[5],.5),(0,k.y)(Pz[1],e[5],e[6],.5),(0,k.y)(Pz[2],e[6],e[7],.5),(0,k.y)(Pz[3],e[7],e[4],.5);let l=0,c=(0,k.q)(Pz[0],Tz);for(let e=1;e<4;++e){const t=(0,k.q)(Pz[e],Tz);t<c&&(c=t,l=e)}(0,k.o)(Rz,Pz[l],e[l+4]);const h=Rz[0];let d,u;Rz[0]=-Rz[1],Rz[1]=h,(0,k.o)(Az,Sz,Tz),(0,k._)(Az,Rz)<0&&(0,k.p)(Rz,Rz),(0,k.y)(Rz,Rz,Az,i),(0,k.g)(Rz,Rz),d=u=(0,k._)((0,k.o)(Mz,e[0],Tz),Rz);for(let t=1;t<8;++t){const i=(0,k._)((0,k.o)(Mz,e[t],Tz),Rz);i<d?d=i:i>u&&(u=i)}(0,k.a)(r,Tz),(0,k.l)(Mz,Rz,d-t),(0,k.s)(r,r,Mz);let p=-1,m=1,f=0,g=0;for(let t=0;t<8;++t){(0,k.o)(Oz,e[t],r),(0,k.g)(Oz,Oz);const i=Rz[0]*Oz[1]-Rz[1]*Oz[0];i>0?i>p&&(p=i,f=t):i<m&&(m=i,g=t)}(0,S.bH)(p>0,"leftArea"),(0,S.bH)(m<0,"rightArea"),(0,k.l)(Dz,Rz,d),(0,k.s)(Dz,Dz,Tz),(0,k.l)(Ez,Rz,u),(0,k.s)(Ez,Ez,Tz),zz[0]=-Rz[1],zz[1]=Rz[0];const v=(0,S.bI)(r,e[g],Ez,(0,k.s)(Mz,Ez,zz),1,s),y=(0,S.bI)(r,e[f],Ez,Mz,1,n),_=(0,S.bI)(r,e[f],Dz,(0,k.s)(Mz,Dz,zz),1,a),x=(0,S.bI)(r,e[g],Dz,Mz,1,o);(0,S.bH)(v,"rayRay"),(0,S.bH)(y,"rayRay"),(0,S.bH)(_,"rayRay"),(0,S.bH)(x,"rayRay")}(dz,n,a,mz,fz,gz,vz,yz),function(e,t,i,r,s){(0,k.o)(Vz,i,r),(0,k.l)(Vz,Vz,.5),Uz[0]=Vz[0],Uz[1]=Vz[1],Uz[2]=0,Uz[3]=Vz[1],Uz[4]=-Vz[0],Uz[5]=0,Uz[6]=Vz[0]*Vz[0]+Vz[1]*Vz[1],Uz[7]=Vz[0]*Vz[1]-Vz[1]*Vz[0],Uz[8]=1,Uz[Iz(0,2)]=-(0,k._)(Fz(Uz,0),e),Uz[Iz(1,2)]=-(0,k._)(Fz(Uz,1),e);let n=(0,k._)(Fz(Uz,0),i)+Uz[Iz(0,2)],a=(0,k._)(Fz(Uz,1),i)+Uz[Iz(1,2)],o=(0,k._)(Fz(Uz,0),r)+Uz[Iz(0,2)],l=(0,k._)(Fz(Uz,1),r)+Uz[Iz(1,2)];n=-(n+o)/(a+l),Uz[Iz(0,0)]+=Uz[Iz(1,0)]*n,Uz[Iz(0,1)]+=Uz[Iz(1,1)]*n,Uz[Iz(0,2)]+=Uz[Iz(1,2)]*n,n=1/((0,k._)(Fz(Uz,0),i)+Uz[Iz(0,2)]),a=1/((0,k._)(Fz(Uz,1),i)+Uz[Iz(1,2)]),Uz[Iz(0,0)]*=n,Uz[Iz(0,1)]*=n,Uz[Iz(0,2)]*=n,Uz[Iz(1,0)]*=a,Uz[Iz(1,1)]*=a,Uz[Iz(1,2)]*=a,Uz[Iz(2,0)]=Uz[Iz(1,0)],Uz[Iz(2,1)]=Uz[Iz(1,1)],Uz[Iz(2,2)]=Uz[Iz(1,2)],Uz[Iz(1,2)]+=1,n=(0,k._)(Fz(Uz,1),t)+Uz[Iz(1,2)],a=(0,k._)(Fz(Uz,2),t)+Uz[Iz(2,2)],o=(0,k._)(Fz(Uz,1),i)+Uz[Iz(1,2)],l=(0,k._)(Fz(Uz,2),i)+Uz[Iz(2,2)],n=-.5*(n/a+o/l),Uz[Iz(1,0)]+=Uz[Iz(2,0)]*n,Uz[Iz(1,1)]+=Uz[Iz(2,1)]*n,Uz[Iz(1,2)]+=Uz[Iz(2,2)]*n,n=(0,k._)(Fz(Uz,1),t)+Uz[Iz(1,2)],a=(0,k._)(Fz(Uz,2),t)+Uz[Iz(2,2)],o=-a/n,Uz[Iz(1,0)]*=o,Uz[Iz(1,1)]*=o,Uz[Iz(1,2)]*=o,s[0]=Uz[0],s[1]=Uz[1],s[2]=0,s[3]=Uz[2],s[4]=Uz[3],s[5]=Uz[4],s[6]=0,s[7]=Uz[5],s[8]=0,s[9]=0,s[10]=1,s[11]=0,s[12]=Uz[6],s[13]=Uz[7],s[14]=0,s[15]=Uz[8]}(mz,fz,vz,yz,i.camera.projectionMatrix),i.camera.projectionMatrix[10]=2/(uz[2]-pz[2]),i.camera.projectionMatrix[14]=-(uz[2]+pz[2])/(uz[2]-pz[2])}setupMatrices(e,t){(0,C.e)(lz,e.projectionMatrix,e.viewMatrix),(0,C.h)(cz,lz);const i=1===this.viewingMode?e.eye:(0,v.a)(xz,0,0,1);(0,C.F)(_z,[0,0,0],[-t[0],-t[1],-t[2]],i)}clampNearFar(e){let{near:t,far:i}=e;return t<2&&(t=2),i<2&&(i=2),t>=i&&(t=2,i=4),{near:t,far:i}}computeCascadeDistances(e,t){this.numCascades=Math.min(1+Math.floor((0,S.bq)(e/t,4)),this.maxNumCascades);const i=(e-t)/this.numCascades,r=(e/t)**(1/this.numCascades);let s=t,n=t;for(let e=0;e<this.numCascades+1;++e)this.cascadeDistances[e]=(0,v.C)(s,n,this.splitSchemeLambda),s*=r,n+=i}getGpuMemoryUsage(){var e,t;return this._snapshots.reduce(((e,t)=>e+(0,V.j)(t)),null!=(e=null==(t=this.fbo)?void 0:t.gpuMemoryUsage)?e:0)}get test(){const e=this;return{maxNumCascades:this.maxNumCascades,cascades:this.cascades,textureSize:this.textureSize,depthTexture:this._depthTexture,set splitSchemeLambda(t){e.splitSchemeLambda=t},get splitSchemeLambda(){return e.splitSchemeLambda},set warp(t){e.warp=t},get warp(){return e.warp}}}}const oz=(0,T.e)(),lz=(0,T.e)(),cz=(0,T.e)(),hz=(0,w.n)(),dz=[];for(let e=0;e<8;++e)dz.push((0,w.n)());const uz=(0,v.n)(),pz=(0,v.n)(),mz=(0,N.n)(),fz=(0,N.n)(),gz=(0,N.n)(),vz=(0,N.n)(),yz=(0,N.n)(),_z=(0,T.e)(),xz=(0,v.n)(),bz=[],wz=(0,T.e)(),Cz=new Float32Array(64),Tz=(0,N.n)(),Sz=(0,N.n)(),Pz=[(0,N.n)(),(0,N.n)(),(0,N.n)(),(0,N.n)()],Rz=(0,N.n)(),Az=(0,N.n)(),Mz=(0,N.n)(),Oz=(0,N.n)(),Dz=(0,N.n)(),Ez=(0,N.n)(),zz=(0,N.n)();function Iz(e,t){return 3*t+e}const Lz=(0,N.n)();function Fz(e,t){return(0,k.r)(Lz,e[t],e[t+3]),Lz}const Vz=(0,N.n)(),Uz=(0,X.e)();class Gz{constructor(e,t,i,s,n,a){this._rctx=e,this._stage=i,this._prepareForShadowMapPass=s,this._renderToShadowMap=n,this._requestRender=a,this._progress=0,this._sampleCount=0,this._cachedCamera=new Ia,this._contentCamera=new Ia,this._enabled=!1,this._cachedLightDirections=[],this._depthRange=oD,this._previewing=!1,this._handles=new R.u,this._cameraForcedForScreenshot=!1,this._shadowMap=new az(e,i.viewingMode),this._shadowMap.enabled=!0,this._vao=(0,S.l)(e);const o={rctx:e,viewingMode:i.viewingMode},l=new ez;l.pass=0,this._accumulationTechnique=new JE(o,l),this._fbo=new V.o(e,{colorTarget:0,depthStencilTarget:0,width:0,height:0},{target:3553,pixelFormat:6408,dataType:5121,samplingMode:9729,wrapMode:33071,width:0,height:0}),this._accumulationParams={camera:this._cachedCamera,linearDepthTexture:null,shadowMap:this._shadowMap,inverseView:(0,T.e)(),projInfo:(0,w.n)(),zScale:(0,N.n)()},this._accumulationRenderer=new rz(t,e,this,a);const c=this._stage.resourceController.scheduler;this._handles.add(c.registerTask(Jd.SHADOW_ACCUMULATOR,this)),this._handles.add((0,r.N)((()=>i.renderView),(e=>{this._handles.remove(Gz.renderViewHandleKey),(0,u.t)(e)||this._handles.add(e.events.on("force-camera-for-screenshot",(()=>this._cameraForcedForScreenshot=!0)),Gz.renderViewHandleKey)})))}get computedSamples(){return this._progress}get accumulationTexture(){return this._fbo.colorTexture}get running(){return this._isRefining&&this._canAccumulate}get isAccumulating(){return this._isPreviewing||this._isRefining}get _isRefining(){return this._isActive&&!this._isDoneAccumulating&&!this._previewing}get _isPreviewing(){return this._isActive&&this._previewing}get _isActive(){return this._enabled&&this._sampleCount>0}get _canAccumulate(){return null!==this._accumulationParams.linearDepthTexture&&this._depthRange!==oD&&this._opacityFromElevation>iz}get _isDoneAccumulating(){return this._progress>=this._sampleCount}get _lightDirections(){return this._cachedLightDirections}set _lightDirections(e){const t=this._cachedLightDirections;if((0,r.K)(t,e,v.T))return;const i=e.length;t.length=i,this._sampleCount=Math.min(YE,i);for(let r=0;r<i;++r){const i=e[r],s=t[r]||(0,v.n)();(0,v.h)(s,i),t[r]=s}this._invalidate()}get _projInfo(){return this._accumulationParams.projInfo}get _zScale(){return this._accumulationParams.zScale}get _inverseView(){return this._accumulationParams.inverseView}get _opacityFromElevation(){return this._accumulationRenderer.opacityFromElevation}set _opacityFromElevation(e){this._accumulationRenderer.opacityFromElevation=e}runTask(e){for(this._prepareForShadowMapPass(this._cachedCamera,this._contentCamera);!e.done&&!this._isDoneAccumulating;)this._accumulateShadow(),e.madeProgress();this._requestRender()}accumulateFixedSamples(){if(!this.isAccumulating||!this._canAccumulate)return;(this._previewing||0===this._progress||this._cameraForcedForScreenshot)&&this._clear();const e=this._cameraForcedForScreenshot?this._sampleCount:Math.min(Gz.previewSamples,this._sampleCount-this._progress);for(let t=0;t<e;++t)this._accumulateShadow();this._cameraForcedForScreenshot=!1}render(){this._accumulationRenderer.render()}dispose(){this._stop(),this._handles.destroy(),this._accumulationRenderer=(0,u.z)(this._accumulationRenderer),this._shadowMap=(0,u.z)(this._shadowMap),this._fbo=(0,u.z)(this._fbo),this._vao=(0,u.z)(this._vao),this._accumulationTechnique=(0,u.z)(this._accumulationTechnique),this._cachedLightDirections.length=0,this._sampleCount=0}setOptions(e){void 0!==e.enabled&&this._setEnabled(e.enabled),void 0!==e.previewing&&this.setPreviewing(e.previewing),void 0!==e.lightDirections&&this.setLightDirections(e.lightDirections),this._accumulationRenderer.setOptions(e)}setPreviewing(e){this._previewing!==e&&(this._previewing=e,this._requestRenderIfEnabled())}setLightDirections(e){this._lightDirections=e}setAccumulationDependencies(e,t,i,r){this._accumulationParams.linearDepthTexture=e,this._depthRange=t,this._updateCamera(i),this._contentCamera=r}readAccumulatedShadow(e,t){if(!this._isActive||this._progress<1||e<0||e>this._fbo.width||t<0||t>this._fbo.height)return 0;const i=Bz;return this._fbo.readPixels(e,t,1,1,6408,5121,i),i[0]/this._progress}_start(){this._progress=0,this._enabled=!0}_stop(){this._enabled=!1}_invalidate(){this._progress=0,this._requestRenderIfEnabled()}_clear(){this._rctx.bindFramebuffer(this._fbo),this._rctx.setClearColor(0,0,0,0),this._rctx.clearSafe(16384),this._progress=0}_accumulateShadow(){const e=this._lightDirections[this._progress],t=this._cachedCamera;this._renderToShadowMap(this._shadowMap,e,t,this._depthRange),this._rctx.bindFramebuffer(this._fbo),this._rctx.useProgram(this._accumulationTechnique.program),this._accumulationTechnique.bindPipelineState(this._rctx),this._accumulationTechnique.bindPass(this._accumulationParams),this._rctx.bindVAO(this._vao),this._rctx.drawArrays(this._accumulationTechnique.primitiveType,0,(0,V.a)(this._vao,"geometry")),this._progress++}_updateCamera(e){if(e.equals(this._cachedCamera))return;const{fullWidth:t,fullHeight:i,projectionMatrix:r,viewMatrix:s,center:n}=e;this._cachedCamera.copyFrom(e),this._fbo.resize(t,i),(0,S.bJ)(r,t,i,this._projInfo,this._zScale),(0,C.c)(this._inverseView,s,n),(0,C.h)(this._inverseView,this._inverseView),this._opacityFromElevation=1-(0,v.a2)(4e4,5e4,e.relativeElevation)}_setEnabled(e){e!==this._enabled&&(e?this._start():this._stop())}_requestRenderIfEnabled(){this._enabled&&this._requestRender()}}Gz.previewSamples=6,Gz.renderViewHandleKey="renderView";const Bz=new Uint8Array(4);function qz(e){const t=new S.n;return t.include(S.aG),t.fragment.include(S.M),t.fragment.include(S.L),t.include(ZE),t.include(Gg),t.fragment.uniforms.add("defaultDepthTex","sampler2D").add("highlightDepthTex","sampler2D").add("depthMap","sampler2D").add("highlightMap","sampler2D").add("color","vec4").add("nearFar","vec2").add("opacity","float").add("occludedOpacity","float").add("terminationFactor","float").add("inverseView","mat4").add("lightingMainDirectionView","vec3").add("texelSize","vec2"),t.fragment.constants.add("unoccludedHighlightFlag","vec4",S.bK).add("highlightedThreshold","float",e.highlightedThreshold).add("selfShadowThreshold","float",e.selfShadowThreshold),t.fragment.code.add(S.t`vec3 normalFromDepth(vec3 pixelPos, vec2 fragCoord, vec2 uv, vec2 texelSize, sampler2D depthMap, vec2 nearFar) {
float leftPixelDepth = linearDepthFromTexture(depthMap, uv + vec2(-1.0, 0.0) * texelSize, nearFar);
float rightPixelDepth = linearDepthFromTexture(depthMap, uv + vec2(1.0, 0.0) * texelSize, nearFar);
float bottomPixelDepth = linearDepthFromTexture(depthMap, uv + vec2(0.0, -1.0) * texelSize, nearFar);
float topPixelDepth = linearDepthFromTexture(depthMap, uv + vec2(0.0, 1.0) * texelSize, nearFar);
bool pickLeft = abs(pixelPos.z - leftPixelDepth) < abs(pixelPos.z - rightPixelDepth);
bool pickBottom = abs(pixelPos.z - bottomPixelDepth) < abs(pixelPos.z - topPixelDepth);
vec3 fragCoordHorizontal = pickLeft
? vec3(fragCoord + vec2(-1.0, 0.0), leftPixelDepth)
: vec3(fragCoord + vec2(1.0, 0.0), rightPixelDepth);
vec3 fragCoordVertical = pickBottom
? vec3(fragCoord + vec2(0.0, -1.0), bottomPixelDepth)
: vec3(fragCoord + vec2(0.0, 1.0), topPixelDepth);
vec3 verticalPixelPos = reconstructPosition(fragCoordHorizontal.xy, fragCoordHorizontal.z);
vec3 horizontalPixelPos = reconstructPosition(fragCoordVertical.xy, fragCoordVertical.z);
vec3 normal = normalize(cross(verticalPixelPos - pixelPos, horizontalPixelPos - pixelPos));
return pickLeft == pickBottom ? normal : -normal;
}`),t.fragment.code.add(S.t`void main(void) {
vec4 highlightInfo = texture2D(highlightMap, uv);
float visiblyHighlighted = (1.0 - clamp(distance(unoccludedHighlightFlag, highlightInfo), 0.0, 1.0)) * highlightInfo.a;
if (visiblyHighlighted > highlightedThreshold) {
discard;
}
float depth = rgba2float(texture2D(depthMap, uv));
if (depth == 0.0) {
discard;
}
float currentPixelDepth = linearDepthFromFloat(depth, nearFar);
if (-currentPixelDepth>nearFar.y || -currentPixelDepth<nearFar.x) {
discard;
}
vec4 currentPixelPos = vec4(reconstructPosition(gl_FragCoord.xy, currentPixelDepth), 1.0);
vec4 worldSpacePos = inverseView * currentPixelPos;
mat4 shadowMatrix;
float linearDepth = -currentPixelDepth;
int i = chooseCascade(linearDepth, shadowMatrix);
if (i >= uShadowMapNum) {
discard;
}
vec3 lvpos = lightSpacePosition(worldSpacePos.xyz, shadowMatrix);
if (lvpos.z >= 1.0 || lvpos.x < 0.0 || lvpos.x > 1.0 || lvpos.y < 0.0 || lvpos.y > 1.0) {
discard;
}
vec2 uvShadow = cascadeCoordinates(i, lvpos);
float depthHighlight = readShadowMapDepth(uvShadow, highlightDepthTex);
bool shadowHighlight = depthHighlight < lvpos.z;
if (!shadowHighlight) {
discard;
}
float depthDefault = readShadowMapDepth(uvShadow, defaultDepthTex);
bool shadowDefault = depthDefault < lvpos.z;
vec3 normal = normalFromDepth(currentPixelPos.xyz, gl_FragCoord.xy, uv, texelSize, depthMap, nearFar);
bool shaded = dot(normal, lightingMainDirectionView) < selfShadowThreshold;
float differenceOpacity = opacity;
float bothOpacity = occludedOpacity;
float fragOpacity = (shadowDefault || shaded) ? bothOpacity : differenceOpacity;
gl_FragColor = vec4(color.rgb, color.a * fragOpacity * terminationFactor);
}`),t}var kz=Object.freeze({__proto__:null,build:qz});class Nz extends S.c{constructor(){super(...arguments),this.opacityElevation=1,this.dayNightTerminator=1,this.highlightShadowMapSlot=0,this.defaultSnapshotSlot=1}initializeProgram(e){const t=Nz.shader.get();this._viewingMode=e.viewingMode;const i=t.build({highlightedThreshold:.99999,selfShadowThreshold:.025});return new S.d(e.rctx,i,S.o)}initializePipeline(e){return(0,V.g)({blending:(0,V.e)(770,1,771,771),colorWrite:V.r,depthTest:null,depthWrite:null})}bindPass(e,t){this.opacityElevation=1-(0,v.a2)(4e4,5e4,t.camera.relativeElevation);const i=1===this._viewingMode?(0,v.j)(jz,t.camera.center):(0,v.a)(jz,0,0,1),r=(0,v.z)(i,t.lighting.lightingMainDirection);this.dayNightTerminator=(0,v.a2)(0,1,(0,v.o)(30*r,0,1)),this.program.bindTexture(t.linearDepthTexture,"depthMap"),this.program.bindTexture(t.highlightColorTexture,"highlightMap"),(0,v.I)(Hz,t.lighting.lightingMainDirection,t.camera.viewInverseTransposeMatrix),(0,v.j)(Hz,Hz),(0,S.bJ)(t.camera.projectionMatrix,t.camera.fullWidth,t.camera.fullHeight,Qz,Wz),(0,C.c)(Zz,t.camera.viewMatrix,t.camera.center),(0,C.h)(Zz,Zz),this.program.setUniform4fv("color",e.shadowColor),this.program.setUniform1f("opacity",e.shadowOpacity),this.program.setUniform1f("occludedOpacity",e.occludedShadowOpacity),this.program.setUniform1f("terminationFactor",this.opacityElevation*this.dayNightTerminator),this.program.setUniform2fv("nearFar",t.camera.nearFar),this.program.setUniformMatrix4fv("inverseView",Zz),this.program.setUniform4fv("projInfo",Qz),this.program.setUniform2fv("zScale",Wz),this.program.setUniform3fv("lightingMainDirectionView",Hz),this.program.setUniform2f("texelSize",1/t.linearDepthTexture.descriptor.width,1/t.linearDepthTexture.descriptor.height),t.shadowMap.bind(this.program),t.shadowMap.bindView(this.program,t.camera.center);let s=t.shadowMap.getSnapshot(this.highlightShadowMapSlot);(0,u.r)(s)&&this.program.bindTexture(s,"highlightDepthTex"),s=t.shadowMap.getSnapshot(this.defaultSnapshotSlot),(0,u.r)(s)&&this.program.bindTexture(s,"defaultDepthTex")}get primitiveType(){return 5}}Nz.shader=new S.f(kz,(()=>i.e(3978).then(i.bind(i,73978))));const jz=(0,v.n)(),Hz=(0,v.n)(),Wz=(0,N.n)(),Qz=(0,w.n)(),Zz=(0,T.e)();class Yz{constructor(e,t){this._rctx=e,this._maxOpacity=1,this._defaultOptions={shadowColor:(0,_e.t)(1,0,1,1),shadowOpacity:.2,occludedShadowOpacity:.1},this._technique=new Nz({rctx:e,viewingMode:t},null),this._vao=(0,S.l)(this._rctx)}render(e,t){e.shadowMap.enabled&&e.linearDepthTexture&&this.isVisible&&(this._rctx.bindFramebuffer(t),this._rctx.useProgram(this._technique.program),this._technique.bindPipelineState(this._rctx),this._technique.bindPass(this._defaultOptions,e),this._rctx.bindVAO(this._vao),this._rctx.drawArrays(this._technique.primitiveType,0,(0,V.a)(this._vao,"geometry")))}getGpuMemoryUsage(){return this._vao?this._vao.size:0}setDefaultOptions(e){this._defaultOptions=e,this._updateMaxOpacity()}get highlightShadowMapSlot(){return this._technique.highlightShadowMapSlot}get defaultSnapshotSlot(){return this._technique.defaultSnapshotSlot}dispose(){this._vao=(0,u.z)(this._vao),this._technique=(0,u.z)(this._technique)}get isVisible(){return this._maxOpacity*this._technique.opacityElevation*this._technique.dayNightTerminator>=.001953125}_updateMaxOpacity(){const e=this._defaultOptions,t=e.shadowColor,i=Math.max(e.shadowOpacity,e.occludedShadowOpacity);this._maxOpacity=i*t[3]}}const Xz=lt();class $z{constructor(){this._worldPlane=Xz}get isEnabled(){return this.plane!==Xz}get plane(){return this._worldPlane}set plane(e){this._worldPlane=e||Xz}}function Kz(e){const t=new S.n;return 0===e.output&&(t.attributes.add("position","vec2"),t.vertex.uniforms.add("uResolution","vec4"),t.varyings.add("fTexCoord","vec2"),t.varyings.add("fOffset[3]","vec4"),t.vertex.code.add(S.t`void SMAAEdgeDetectionVS( vec2 texcoord ) {
fOffset[0] = texcoord.xyxy + uResolution.xyxy * vec4( -1.0, 0.0, 0.0,  1.0 );
fOffset[1] = texcoord.xyxy + uResolution.xyxy * vec4(  1.0, 0.0, 0.0, -1.0 );
fOffset[2] = texcoord.xyxy + uResolution.xyxy * vec4( -2.0, 0.0, 0.0,  2.0 );
}
void main() {
fTexCoord = (position + 1.0 ) * 0.5;
gl_Position = vec4(position, 0, 1);
SMAAEdgeDetectionVS( fTexCoord );
}`),t.fragment.uniforms.add("tColor","sampler2D"),t.fragment.code.add(S.t`
      vec4 SMAAColorEdgeDetectionPS( vec2 texcoord, vec4 offset[3], sampler2D colorTex ) {
        vec2 threshold = vec2( ${S.t.float(e.threshold)} );

        // Calculate color deltas:
        vec4 delta;
        vec3 C = texture2D( colorTex, texcoord ).rgb;

        vec3 Cleft = texture2D( colorTex, offset[0].xy ).rgb;
        vec3 t = abs( C - Cleft );
        delta.x = max( max( t.r, t.g ), t.b );

        vec3 Ctop = texture2D( colorTex, offset[0].zw ).rgb;
        t = abs( C - Ctop );
        delta.y = max( max( t.r, t.g ), t.b );

        // We do the usual threshold:
        vec2 edges = step( threshold, delta.xy );

        // Then discard if there is no edge:
        if ( dot( edges, vec2( 1.0, 1.0 ) ) == 0.0 )
            discard;

        // Calculate right and bottom deltas:
        vec3 Cright = texture2D( colorTex, offset[1].xy ).rgb;
        t = abs( C - Cright );
        delta.z = max( max( t.r, t.g ), t.b );

        vec3 Cbottom  = texture2D( colorTex, offset[1].zw ).rgb;
        t = abs( C - Cbottom );
        delta.w = max( max( t.r, t.g ), t.b );

        // Calculate the maximum delta in the direct neighborhood:
        float maxDelta = max( max( max( delta.x, delta.y ), delta.z ), delta.w );

        // Calculate left-left and top-top deltas:
        vec3 Cleftleft  = texture2D( colorTex, offset[2].xy ).rgb;
        t = abs( C - Cleftleft );
        delta.z = max( max( t.r, t.g ), t.b );

        vec3 Ctoptop = texture2D( colorTex, offset[2].zw ).rgb;
        t = abs( C - Ctoptop );
        delta.w = max( max( t.r, t.g ), t.b );

        // Calculate the final maximum delta:
        maxDelta = max( max( maxDelta, delta.z ), delta.w );

        // Local contrast adaptation in action:
        edges.xy *= step( maxDelta, float(${S.t.float(e.localConstrastAdaption)}) * delta.xy );

        return vec4( edges, 0.0, 0.0 );
      }

      void main() {
        gl_FragColor = SMAAColorEdgeDetectionPS( fTexCoord, fOffset, tColor );
      }
    `)),1===e.output&&(t.attributes.add("position","vec2"),t.vertex.uniforms.add("uResolution","vec4"),t.varyings.add("fTexCoord","vec2"),t.varyings.add("fOffset[3]","vec4"),t.varyings.add("fPixCoord","vec2"),t.vertex.code.add(S.t`
      void SMAABlendingWeightCalculationVS( vec2 texcoord ) {
        fPixCoord = texcoord * uResolution.zw;
        fOffset[0] = texcoord.xyxy + uResolution.xyxy * vec4( -0.25, 0.125, 1.25, 0.125 );
        fOffset[1] = texcoord.xyxy + uResolution.xyxy * vec4( -0.125, 0.25, -0.125, -1.25 );
        fOffset[2] = vec4( fOffset[0].xz, fOffset[1].yw ) + vec4( -2.0, 2.0, -2.0, 2.0 ) * uResolution.xxyy * float( ${S.t.int(e.maxSearchSteps)} );
      }

      void main() {
        fTexCoord = (position + 1.0 ) * 0.5;
        gl_Position = vec4(position, 0, 1);
        SMAABlendingWeightCalculationVS( fTexCoord );
      }
    `),t.fragment.uniforms.add("tEdges","sampler2D").add("tArea","sampler2D").add("tSearch","sampler2D").add("tColor","sampler2D").add("uResolution","vec4"),t.fragment.code.add(S.t`
      #define SMAA_AREATEX_PIXEL_SIZE ( 1.0 / vec2( 160.0, 560.0 ) )
      #define SMAA_AREATEX_SUBTEX_SIZE ( 1.0 / 7.0 )

      vec4 SMAASampleLevelZeroOffset(sampler2D tex, vec2 coord, vec2 offset) {
        return texture2D( tex, coord + offset.x * uResolution.xy, 0.0 );
      }

      vec2 round( vec2 x ) {
        return sign( x ) * floor( abs( x ) + 0.5 );
      }

      float SMAASearchLength( sampler2D searchTex, vec2 e, float bias, float scale ) {
        e.r = bias + e.r * scale;
        return 255.0 * texture2D( searchTex, e, 0.0 ).r;
      }

      float SMAASearchXLeft( sampler2D edgesTex, sampler2D searchTex, vec2 texcoord, float end ) {
        vec2 e = vec2( 0.0, 1.0 );
        for ( int i = 0; i < ${S.t.int(e.maxSearchSteps)}; i ++ ) {
          e = texture2D( edgesTex, texcoord, 0.0 ).rg;
          texcoord -= vec2( 2.0, 0.0 ) * uResolution.xy;
          if ( ! ( texcoord.x > end && e.g > 0.8281 && e.r == 0.0 ) ) break;
        }
        texcoord.x += 0.25 * uResolution.x;
        texcoord.x += uResolution.x;
        texcoord.x += 2.0 * uResolution.x;
        texcoord.x -= uResolution.x * SMAASearchLength(searchTex, e, 0.0, 0.5);
        return texcoord.x;
      }

      float SMAASearchXRight( sampler2D edgesTex, sampler2D searchTex, vec2 texcoord, float end ) {
        vec2 e = vec2( 0.0, 1.0 );
        for ( int i = 0; i < ${S.t.int(e.maxSearchSteps)}; i ++ ) {
          e = texture2D( edgesTex, texcoord, 0.0 ).rg;
          texcoord += vec2( 2.0, 0.0 ) * uResolution.xy;
          if ( ! ( texcoord.x < end && e.g > 0.8281 && e.r == 0.0 ) ) break;
        }
        texcoord.x -= 0.25 * uResolution.x;
        texcoord.x -= uResolution.x;
        texcoord.x -= 2.0 * uResolution.x;
        texcoord.x += uResolution.x * SMAASearchLength( searchTex, e, 0.5, 0.5 );
        return texcoord.x;
      }

      float SMAASearchYUp( sampler2D edgesTex, sampler2D searchTex, vec2 texcoord, float end ) {
        vec2 e = vec2( 1.0, 0.0 );
        for ( int i = 0; i < ${S.t.int(e.maxSearchSteps)}; i ++ ) {
          e = texture2D( edgesTex, texcoord, 0.0 ).rg;
          texcoord += vec2( 0.0, 2.0 ) * uResolution.xy;
          if ( ! ( texcoord.y > end && e.r > 0.8281 && e.g == 0.0 ) ) break;
        }
        texcoord.y -= 0.25 * uResolution.y;
        texcoord.y -= uResolution.y;
        texcoord.y -= 2.0 * uResolution.y;
        texcoord.y += uResolution.y * SMAASearchLength( searchTex, e.gr, 0.0, 0.5 );
        return texcoord.y;
      }

      float SMAASearchYDown( sampler2D edgesTex, sampler2D searchTex, vec2 texcoord, float end ) {
        vec2 e = vec2( 1.0, 0.0 );
        for ( int i = 0; i < ${S.t.int(e.maxSearchSteps)}; i ++ ) {
          e = texture2D( edgesTex, texcoord, 0.0 ).rg;
          texcoord -= vec2( 0.0, 2.0 ) * uResolution.xy;
          if ( ! ( texcoord.y < end && e.r > 0.8281 && e.g == 0.0 ) ) break;
        }
        texcoord.y += 0.25 * uResolution.y;
        texcoord.y += uResolution.y;
        texcoord.y += 2.0 * uResolution.y;
        texcoord.y -= uResolution.y * SMAASearchLength( searchTex, e.gr, 0.5, 0.5 );
        return texcoord.y;
      }

      vec2 SMAAArea( sampler2D areaTex, vec2 dist, float e1, float e2, float offset ) {
        vec2 texcoord = float( ${S.t.int(e.maxDistanceAreaTex)} ) * round( 4.0 * vec2( e1, e2 ) ) + dist;
        texcoord = SMAA_AREATEX_PIXEL_SIZE * texcoord + ( 0.5 * SMAA_AREATEX_PIXEL_SIZE );
        texcoord.y += SMAA_AREATEX_SUBTEX_SIZE * offset;
        return texture2D( areaTex, texcoord, 0.0 ).rg;
      }

      vec4 SMAABlendingWeightCalculationPS( vec2 texcoord, vec2 pixcoord, vec4 offset[ 3 ], sampler2D edgesTex, sampler2D areaTex, sampler2D searchTex, ivec4 subsampleIndices ) {
        vec4 weights = vec4( 0.0, 0.0, 0.0, 0.0 );
        vec2 e = texture2D( edgesTex, texcoord ).rg;
        if ( e.g > 0.0 ) {
          vec2 d;
          vec2 coords;
          coords.x = SMAASearchXLeft( edgesTex, searchTex, offset[ 0 ].xy, offset[ 2 ].x );
          coords.y = offset[ 1 ].y;
          d.x = coords.x;
          float e1 = texture2D( edgesTex, coords, 0.0 ).r;
          coords.x = SMAASearchXRight( edgesTex, searchTex, offset[ 0 ].zw, offset[ 2 ].y );
          d.y = coords.x;
          d = d * uResolution.z - pixcoord.x;
          vec2 sqrt_d = sqrt( abs( d ) );
          coords.y -= 1.0 * uResolution.y;
          float e2 = SMAASampleLevelZeroOffset( edgesTex, coords, vec2( 1.0, 0.0 ) ).r;
          weights.rg = SMAAArea( areaTex, sqrt_d, e1, e2, float( subsampleIndices.y ) );
        }

        if ( e.r > 0.0 ) {
          vec2 d;
          vec2 coords;
          coords.y = SMAASearchYUp( edgesTex, searchTex, offset[ 1 ].xy, offset[ 2 ].z );
          coords.x = offset[ 0 ].x;
          d.x = coords.y;
          float e1 = texture2D( edgesTex, coords, 0.0 ).g;
          coords.y = SMAASearchYDown( edgesTex, searchTex, offset[ 1 ].zw, offset[ 2 ].w );
          d.y = coords.y;
          d = d * uResolution.w - pixcoord.y;
          vec2 sqrt_d = sqrt( abs( d ) );
          coords.y -= 1.0 * uResolution.y;
          float e2 = SMAASampleLevelZeroOffset( edgesTex, coords, vec2( 0.0, 1.0 ) ).g;
          weights.ba = SMAAArea( areaTex, sqrt_d, e1, e2, float( subsampleIndices.x ) );

          // for some reason the following lines are necessary to prevent
          // texture lookup precision issues on some Intel integrated graphics chips
          vec4 dbg = (offset[ 0 ]+offset[ 1 ]+offset[ 2 ] + coords.xyyx);
          weights.r += 0.00000001 * dot(vec4(0,1,0,1),dbg);
        }
        return weights;
      }

      void main() {
        gl_FragColor = SMAABlendingWeightCalculationPS( fTexCoord, fPixCoord, fOffset, tEdges, tArea, tSearch, ivec4( 0.0 ) );
      }
    `)),2===e.output&&(t.attributes.add("position","vec2"),t.vertex.uniforms.add("uResolution","vec4"),t.varyings.add("fTexCoord","vec2"),t.varyings.add("fOffset[2]","vec4"),t.vertex.code.add(S.t`void SMAANeighborhoodBlendingVS( vec2 texcoord ) {
fOffset[0] = texcoord.xyxy + uResolution.xyxy * vec4( -1.0, 0.0, 0.0, 1.0 );
fOffset[1] = texcoord.xyxy + uResolution.xyxy * vec4( 1.0, 0.0, 0.0, -1.0 );
}
void main() {
fTexCoord = (position + 1.0 ) * 0.5;
gl_Position = vec4(position, 0, 1);
SMAANeighborhoodBlendingVS(fTexCoord);
}`),t.fragment.uniforms.add("tBlendWeights","sampler2D"),t.fragment.uniforms.add("tColor","sampler2D"),t.fragment.uniforms.add("uResolution","vec4"),t.fragment.code.add(S.t`vec4 SMAANeighborhoodBlendingPS( vec2 texcoord, vec4 offset[ 2 ], sampler2D colorTex, sampler2D blendTex ) {
vec4 a;
a.xz = texture2D( blendTex, texcoord ).xz;
a.y = texture2D( blendTex, offset[ 1 ].zw ).g;
a.w = texture2D( blendTex, offset[ 1 ].xy ).a;
if ( dot(a, vec4( 1.0, 1.0, 1.0, 1.0 )) < 1e-5 ) {
return texture2D( colorTex, texcoord, 0.0 );
} else {
vec2 offset;
offset.x = a.a > a.b ? a.a : -a.b;
offset.y = a.g > a.r ? -a.g : a.r;
if ( abs( offset.x ) > abs( offset.y )) {
offset.y = 0.0;
} else {
offset.x = 0.0;
}
vec4 C = texture2D( colorTex, texcoord, 0.0 );
texcoord += sign( offset ) * uResolution.xy;
vec4 Cop = texture2D( colorTex, texcoord, 0.0 );
float s = abs( offset.x ) > abs( offset.y ) ? abs( offset.x ) : abs( offset.y );
vec4 mixed = mix(C, Cop, s);
return mixed;
}
}
void main() {
gl_FragColor = SMAANeighborhoodBlendingPS( fTexCoord, fOffset, tColor, tBlendWeights );
}`)),t}var Jz=Object.freeze({__proto__:null,build:Kz});class eI extends S.c{initializeProgram(e){const t=eI.shader.get(),i=this.configuration,r=t.build({output:i.output,threshold:.05,localConstrastAdaption:2,maxSearchSteps:8,maxDistanceAreaTex:16});return new S.d(e.rctx,r,S.o)}initializePipeline(){return(0,V.g)({colorWrite:V.r})}}eI.shader=new S.f(Jz,(()=>i.e(3171).then(i.bind(i,13171))));class tI extends S.b{constructor(){super(...arguments),this.output=0}}(0,r.e)([(0,S.a)({count:3})],tI.prototype,"output",void 0);class iI{constructor(e,t){this.rctx=e,this._techniqueRep=t,this.resourceLoadingPromise=null,this.isEnabled=!1}loadResources(e){if(!this.data||!this.textureArea||!this.textureSearch){const t=this.resourceLoadingPromise||this.loadDataModule().then((()=>this.loadTextures()));return e&&t.then(e),this.resourceLoadingPromise||(this.resourceLoadingPromise=t,t.then((()=>this.resourceLoadingPromise=null))),!1}return!0}loadDataModule(){return this.data?Promise.resolve():i.e(5026).then(i.bind(i,95026)).then((e=>{this.data=e}))}loadTextures(){return Promise.all([this.loadTextureFromBase64(this.data.areaTexture,9729,6407),this.loadTextureFromBase64(this.data.searchTexure,9728,6409)]).then((([e,t])=>{this.textureArea=e,this.textureSearch=t}))}get isLoadingResources(){return null!=this.resourceLoadingPromise}enable(){if(this.isEnabled)return!0;if(!this._edgeDetectTechnique||!this._blendWeights||!this._blur){const e=new tI,t=(e,t)=>this._techniqueRep.releaseAndAcquire(eI,e,t);e.output=0,this._edgeDetectTechnique=t(e,this._edgeDetectTechnique),e.output=1,this._blendWeights=t(e,this._blendWeights),e.output=2,this._blur=t(e,this._blur)}return!!this.loadResources()&&(this.vao=(0,S.bL)(this.rctx),this.edges=new V.o(this.rctx,{colorTarget:0,depthStencilTarget:0},{target:3553,pixelFormat:6407,dataType:5121,samplingMode:9729,wrapMode:33071,width:4,height:4}),this.blend=new V.o(this.rctx,{colorTarget:0,depthStencilTarget:0},{target:3553,pixelFormat:6408,dataType:5121,samplingMode:9729,wrapMode:33071,width:4,height:4}),this.isEnabled=!0,!0)}disable(){this.isEnabled&&(this.vao.dispose(),this.vao=null,this.textureArea.dispose(),this.textureArea=null,this.textureSearch.dispose(),this.textureSearch=null,this.blend.dispose(),this.blend=null,this.edges.dispose(),this.edges=null,this.isEnabled=!1)}render(e){this.enable();const t=this.rctx,i=t.getBoundFramebufferObject(),r={x:0,y:0,width:e.colorTexture.descriptor.width,height:e.colorTexture.descriptor.height};t.bindVAO(this.vao),t.setPipelineState(this._edgeDetectTechnique.pipeline),t.setViewport(r.x,r.y,r.width,r.height),this.edges.resize(r.width,r.height),t.bindFramebuffer(this.edges),t.setClearColor(0,0,0,1),t.clear(16384),t.useProgram(this._edgeDetectTechnique.program),this._edgeDetectTechnique.program.bindTexture(e.colorTexture,"tColor"),this._edgeDetectTechnique.program.setUniform4f("uResolution",1/r.width,1/r.height,r.width,r.height),t.drawArrays(4,0,3),this.blend.resize(r.width,r.height),t.bindFramebuffer(this.blend),t.setClearColor(0,0,1,1),t.clear(16384),t.useProgram(this._blendWeights.program),this._blendWeights.program.setUniform4f("uResolution",1/r.width,1/r.height,r.width,r.height),this._blendWeights.program.bindTexture(this.textureSearch,"tSearch"),this._blendWeights.program.bindTexture(this.textureArea,"tArea"),this._blendWeights.program.bindTexture(this.edges.colorTexture,"tEdges"),t.drawArrays(4,0,3),t.bindFramebuffer(i),t.setClearColor(0,1,0,1),t.clear(16384),t.useProgram(this._blur.program),this._blur.program.setUniform4f("uResolution",1/r.width,1/r.height,r.width,r.height),this._blur.program.bindTexture(e.colorTexture,"tColor"),this._blur.program.bindTexture(this.blend.colorTexture,"tBlendWeights"),t.drawArrays(4,0,3)}loadTextureFromBase64(e,t,i){const r=new q.r(this.rctx,{pixelFormat:i,dataType:5121,wrapMode:33071,samplingMode:t},null);return(0,F.t)(e).then((e=>(r.resize(e.width,e.height),r.setData(e),r)))}}function rI(e){const t=new S.n;return t.include(Gg),1===e.output&&(t.fragment.include(S.L),t.fragment.uniforms.add("normalMap","sampler2D").add("depthMap","sampler2D").add("tex","sampler2D").add("blurSize","vec2").add("g_BlurFalloff","float").add("projScale","float").add("nearFar","vec2").add("zScale","vec2"),t.fragment.code.add(S.t`
      float blurFunction(vec2 uv, float r, float center_d, inout float w_total, float sharpness) {
        float c = texture2D(tex, uv).r;
        float d = linearDepthFromTexture(depthMap, uv, nearFar);

        float ddiff = d - center_d;

        float w = exp(-r*r*g_BlurFalloff - ddiff*ddiff*sharpness);

        w_total += w;

        return w*c;
      }

      void main(void) {
        float b = 0.0;
        float w_total = 0.0;

        float center_d = linearDepthFromTexture(depthMap, uv, nearFar);

        float sharpness = -0.05 * projScale/(center_d*zScale.x+zScale.y);
        for (int r = -${S.t.int(e.radius)}; r <= ${S.t.int(e.radius)}; ++r) {
          float rf = float(r);
          vec2 uvOffset = uv + rf*blurSize;
          b += blurFunction(uvOffset, rf, center_d, w_total, sharpness);
        }

        gl_FragColor = vec4(b/w_total);
      }
    `)),0===e.output&&(t.fragment.include(S.L),t.include(ZE),t.fragment.uniforms.add("projMatrixInv","mat4").add("normalMap","sampler2D").add("depthMap","sampler2D").add("intensity","float").add("projScale","float").add("radius","float").add("nearFar","vec2").add("screenDimensions","vec2").add("rnmScale","vec2").add("rnm","sampler2D"),t.fragment.code.add(S.t`
    uniform vec3 pSphere[${S.t.int(e.samples)}];

    float fallOffFunction(float vv, float vn, float bias) {
      float radius2 = radius * radius;
      float f = max(radius2 - vv, 0.0);
      return f * f * f * max(vn-bias, 0.0);
    }
    `),t.fragment.code.add(S.t`float aoValueFromPositionsAndNormal(vec3 C, vec3 n_C, vec3 Q) {
vec3 v = Q - C;
float vv = dot(v, v);
float vn = dot(normalize(v), n_C);
return fallOffFunction(vv, vn, 0.1);
}`),t.fragment.code.add(S.t`
      void main(void) {
        vec3 fres = normalize((texture2D(rnm, uv * rnmScale).xyz * 2.0) - vec3(1.0));
        float currentPixelDepth = linearDepthFromTexture(depthMap, uv, nearFar);

        if (-currentPixelDepth>nearFar.y || -currentPixelDepth<nearFar.x) {
          gl_FragColor = vec4(0.0);
          return;
        }

        vec3 currentPixelPos = reconstructPosition(gl_FragCoord.xy,currentPixelDepth);

        // get the normal of current fragment
        vec4 norm4 = texture2D(normalMap, uv);
        vec3 norm = vec3(-1.0) + 2.0 * norm4.xyz;
        bool isTerrain = norm4.w<0.5;

        float sum = .0;

        vec4 occluderFragment;
        vec3 ray;

        vec3 tapPixelPos;

        // note: the factor 2.0 should not be necessary, but makes ssao much nicer.
        // bug or deviation from CE somewhere else?
        float ps = projScale/(2.0*currentPixelPos.z*zScale.x+zScale.y);

        for(int i = 0; i < ${S.t.int(e.samples)}; ++i) {
          // get a vector (randomized inside of a sphere with radius 1.0) from a texture and reflect it
          //float ssR;
          //vec2 unitOffset = tapLocation(i, randomPatternRotationAngle, ssR);
          // get the depth of the occluder fragment
          //vec2 offset = vec2(-unitOffset*radius*ssR*ps);

          vec2 unitOffset = reflect(pSphere[i], fres).xy;
          vec2 offset = vec2(-unitOffset*radius*ps);

          //don't use current or very nearby samples
          if ( abs(offset.x)<2.0 || abs(offset.y)<2.0) continue;

          vec2 tc = vec2(gl_FragCoord.xy + offset);
          if (tc.x < 0.0 || tc.y < 0.0 || tc.x > screenDimensions.x || tc.y > screenDimensions.y) continue;
          vec2 tcTap = tc/screenDimensions;
          float occluderFragmentDepth = linearDepthFromTexture(depthMap, tcTap, nearFar);

          if (isTerrain) {
            bool isTerrainTap = texture2D(normalMap, tcTap).w<0.5;
            if (isTerrainTap) {
              continue;
            }
          }

          tapPixelPos = reconstructPosition(tc, occluderFragmentDepth);

          sum+= aoValueFromPositionsAndNormal(currentPixelPos, norm, tapPixelPos);
        }

        // output the result

        float A = max(1.0-sum*intensity/float(${S.t.int(e.samples)}),0.0);

        // Anti-tone map to reduce contrast and drag dark region farther
        // (x^0.2 + 1.2 * x^4)/2.2
        A = (pow(A, 0.2) + 1.2 * A*A*A*A) / 2.2;

        //gl_FragColor = vec4(norm/2.0+0.5, 1.0);
        //gl_FragColor = vec4(-currentPixelDepth/1000.0);
        //gl_FragColor = vec4(tapPixelPos.x/100.0);
        gl_FragColor = vec4(A);
      }
    `)),t}var sI=Object.freeze({__proto__:null,build:rI});class nI extends S.c{initializeProgram(e){const t=nI.shader.get(),i=this.configuration,r=3===i.samples?64:2===i.samples?32:1===i.samples?16:8,s=t.build({output:i.output,samples:r,radius:4});return new S.d(e.rctx,s,S.o)}initializePipeline(){return(0,V.g)({colorWrite:V.r})}}nI.shader=new S.f(sI,(()=>i.e(107).then(i.bind(i,60107))));class aI extends S.b{constructor(){super(...arguments),this.output=0,this.samples=3}}(0,r.e)([(0,S.a)({count:2})],aI.prototype,"output",void 0),(0,r.e)([(0,S.a)()],aI.prototype,"samples",void 0);class oI{constructor(e,t,i){this._techniqueRep=e,this._rctx=t,this._requestRender=i,this._enabled=!1,this._ssaoTechniqueConfig=new aI,this.quadVAO=null,this._BLUR_F=2,this._attenuation=.5,this._radius=3,this._samples=16,this._viewportToRestore=(0,w.n)()}dispose(){this.quadVAO=(0,u.z)(this.quadVAO)}set enabled(e){e?this._enable():this._disable()}get enabled(){return this._enabled}set attenuation(e){this._attenuation=e}get attenuation(){return this._attenuation}set radius(e){this._radius=e}get radius(){return this._radius}set samples(e){this._samples=e,this._enabled&&this._selectPrograms()}get samples(){return this._samples}get ready(){return this.enabled&&(0,u.r)(this._noiseTexture)&&(0,u.r)(this._ssaoFBO)&&(0,u.r)(this._blur0FBO)&&(0,u.r)(this._blur1FBO)}computeSSAO(e,t,i){if(!this.enabled||(0,u.t)(this._noiseTexture)||(0,u.t)(this._ssaoFBO)||(0,u.t)(this._blur0FBO)||(0,u.t)(this._blur1FBO))return;const r=this._rctx,s=e.fullViewport,n=s[2],a=s[3],o=n/this._BLUR_F,l=a/this._BLUR_F;this._ssaoFBO.resize(n,a),this._blur0FBO.resize(o,l),this._blur1FBO.resize(o,l);const c=1*n,h=1*a;(0,j.a)(this._viewportToRestore,e.fullViewport),r.bindFramebuffer(this._ssaoFBO),r.setViewport(0,0,n,a);const d=this._ssaoTechnique.program;r.useProgram(d),r.setPipelineState(this._ssaoTechnique.pipeline),d.setUniform2f("rnmScale",n/this._noiseTexture.descriptor.width,a/this._noiseTexture.descriptor.height),d.setUniform3fv("pSphere",this._samples<=8?this._data.random8:this._samples<=16?this._data.random16:this._samples<=32?this._data.random32:this._data.random64);const p=this._data.minDiscrepancy,m=this._samples<p.length?p[this._samples]:5779;d.setUniform1f("numSpiralTurns",m);const f=cI,g=lI;(0,S.bJ)(e.projectionMatrix,e.fullWidth,e.fullHeight,f,g),d.setUniform4fv("projInfo",f),d.setUniform2fv("zScale",g),d.setUniform2f("nearFar",e.near,e.far);let y=1/e.computeRenderPixelSizeAtDist(1);d.setUniform1f("projScale",1*y),d.setUniform2f("screenDimensions",c,h);const _=(0,v.q)(e.eye,e.center);let x=20*e.computeRenderPixelSizeAtDist(_);x=Math.max(.1,x),d.setUniform1f("radius",x),d.setUniform1f("intensity",4*this._attenuation/x**6),d.bindTexture(this._noiseTexture,"rnm"),d.bindTexture(i,"normalMap"),d.bindTexture(t,"depthMap"),(0,u.t)(this.quadVAO)&&(this.quadVAO=(0,S.l)(this._rctx));const b=this.quadVAO;r.bindVAO(b),r.drawArrays(5,0,(0,V.a)(b,"geometry"));const w=this._blurTechnique.program;r.useProgram(w),w.bindTexture(this._ssaoFBO.colorTexture,"tex"),w.bindTexture(i,"normalMap"),w.bindTexture(t,"depthMap"),r.setViewport(0,0,c/this._BLUR_F,h/this._BLUR_F),r.bindFramebuffer(this._blur0FBO),w.setUniform2f("screenDimensions",c,h),w.setUniform2f("blurSize",0,1*this._BLUR_F/h),w.setUniform1i("radius",4),w.setUniform1f("g_BlurFalloff",.08),w.setUniform2f("nearFar",e.near,e.far),_>5e4&&(y=Math.max(0,y-(_-5e4))),w.setUniform1f("projScale",y),w.setUniform2f("zScale",1,0),r.drawArrays(5,0,(0,V.a)(b,"geometry")),w.setUniform2f("blurSize",1*this._BLUR_F/c,0),r.bindFramebuffer(this._blur1FBO),w.bindTexture(this._blur0FBO.colorTexture,"tex"),r.drawArrays(5,0,(0,V.a)(b,"geometry")),r.setViewport(this._viewportToRestore[0],this._viewportToRestore[1],this._viewportToRestore[2],this._viewportToRestore[3])}bind(e){this.enabled&&(0,u.r)(this._blur1FBO)&&(0,u.r)(this._ssaoFBO)?(e.bindTexture(this._blur1FBO.colorTexture,"ssaoTex"),e.setUniform4f("viewportPixelSz",this._viewportToRestore[0],this._viewportToRestore[1],1/this._ssaoFBO.width,1/this._ssaoFBO.height)):e.setUniform4f("viewportPixelSz",-1,-1,-1,-1)}_selectPrograms(){const e=this._samples<=8?0:this._samples<=16?1:this._samples<=32?2:3;this._ssaoTechniqueConfig.samples=e,this._ssaoTechniqueConfig.output=0,this._ssaoTechnique=this._techniqueRep.releaseAndAcquire(nI,this._ssaoTechniqueConfig,this._ssaoTechnique),this._ssaoTechniqueConfig.output=1,this._blurTechnique=this._techniqueRep.releaseAndAcquire(nI,this._ssaoTechniqueConfig,this._blurTechnique)}_enable(){this.enabled||(this._enabled=!0,this._loadResources((()=>{this._enabled&&this._initialize()})))}_loadResources(e){this._data?e():i.e(2475).then(i.bind(i,92475)).then((t=>{this._data=t,e()}))}_initialize(){const e={target:3553,pixelFormat:6408,dataType:5121,samplingMode:9729,wrapMode:33071,width:0,height:0},t={colorTarget:0,depthStencilTarget:0};(0,F.t)(this._data.noiseTexture).then((i=>{this._enabled&&(this._ssaoFBO=new V.o(this._rctx,t,e),this._blur0FBO=new V.o(this._rctx,t,e),this._blur1FBO=new V.o(this._rctx,t,e),this._noiseTexture=new q.r(this._rctx,{target:3553,pixelFormat:6408,dataType:5121,hasMipmap:!0,width:i.width,height:i.height},i),this._requestRender())})),this._selectPrograms()}_disable(){this._enabled=!1,this._noiseTexture=(0,u.z)(this._noiseTexture),this._blur1FBO=(0,u.z)(this._blur1FBO),this._blur0FBO=(0,u.z)(this._blur0FBO),this._ssaoFBO=(0,u.z)(this._ssaoFBO)}get gpuMemoryUsage(){return((0,u.r)(this._blur0FBO)?this._blur0FBO.gpuMemoryUsage:0)+((0,u.r)(this._blur1FBO)?this._blur1FBO.gpuMemoryUsage:0)+((0,u.r)(this._ssaoFBO)?this._ssaoFBO.gpuMemoryUsage:0)}get test(){return{ssao:this._ssaoFBO,blur:this._blur1FBO}}}const lI=(0,N.n)(),cI=(0,w.n)();class hI{constructor(e){this.factory=e,this.originData=new Map}acquire(e){return this.register(this.factory.getOrigin(e))}register(e){const t=this.originData.get(e.id);return t?(t.refCount++,t.origin):(this.originData.set(e.id,{refCount:1,viewMatrix:(0,T.e)(),origin:e}),e)}release(e){const t=this.originData.get(e.id);t&&(t.refCount--,0===t.refCount&&this.originData.delete(e.id))}updateViewMatrices(e){this.originData.forEach((t=>{(0,C.n)(t.viewMatrix,e),function(e,t){const i=t,r=e[0],s=e[1],n=e[2];i[12]+=r*i[0]+s*i[4]+n*i[8],i[13]+=r*i[1]+s*i[5]+n*i[9],i[14]+=r*i[2]+s*i[6]+n*i[10],i[14]+=r*i[3]+s*i[7]+n*i[11]}(t.origin.vec3,t.viewMatrix)}))}getViewMatrix(e){return this.originData.get(e.id).viewMatrix}}function dI(e){const t=S.t`bool isNaN( float val )
{
return ( val < 0.0 || 0.0 < val || val == 0.0 ) ? false : true;
}`;e.code.add(t)}function uI(e,t){e.vertex.include(dI),e.include(S.bv,t);const i=e.vertex;i.uniforms.add("uDepthBias","vec2"),i.uniforms.add("uViewportDimInv","vec2"),t.legacy?(i.uniforms.add("uView","mat4"),i.uniforms.add("uProj","mat4")):i.uniforms.add("uTransformNormal_ViewFromGlobal","mat3"),t.legacy?i.code.add(S.t`vec2 calculateProjectedBiasXY(vec4 projPos, vec3 globalNormal) {
float offsetXY = uDepthBias.x;
float offsetZ  = uDepthBias.y;
vec4 projNormal = uProj * uView * vec4(globalNormal, 0.0);
return offsetXY * projPos.w * 2.0 * uViewportDimInv * normalize(projNormal.xyz).xy;
}`):i.code.add(S.t`vec2 calculateProjectedBiasXY(vec4 projPos, vec3 globalNormal) {
float offsetXY = uDepthBias.x;
float offsetZ  = uDepthBias.y;
vec4 projNormal = uTransform_ProjFromView * vec4(uTransformNormal_ViewFromGlobal * globalNormal, 0.0);
return offsetXY * projPos.w * 2.0 * uViewportDimInv * normalize(projNormal.xyz).xy;
}`),i.code.add(S.t`float _calculateProjectedBiasZ(vec4 projPos) {
float offsetZ = uDepthBias.y;
return sqrt(projPos.z) * offsetZ;
}
vec4 adjustProjectedPosition(vec4 projPos, vec3 worldNormal, float lineWidth) {
vec2 offsetXY = calculateProjectedBiasXY(projPos, worldNormal);
if (!isNaN(offsetXY.x) && !isNaN(offsetXY.y)) {
projPos.xy += offsetXY;
}
projPos.z += _calculateProjectedBiasZ(projPos);
return projPos;
}`)}function pI(e,t){const i=e.fragment;i.constants.add("coverageTestThreshold","float",.01),t.antialiasing?i.code.add(S.t`#define discardByCoverage(radius, coverage) { if (coverage < coverageTestThreshold) discard; }`):i.code.add(S.t`#define discardByCoverage(radius, coverage) { float coverageLimit = radius <= 0.5 ? coverageTestThreshold : 0.75; if (coverage < coverageLimit) discard; }`)}function mI(e,t){const i=e.vertex;t.silhouette?(i.code.add(S.t`bool isSilhouetteEdge(vec3 viewDir, vec3 normalA, vec3 normalB) {
float faceAVisible = dot(viewDir, normalA);
float faceBVisible = dot(viewDir, normalB);
return faceAVisible * faceBVisible < 0.0;
}`),t.legacy?i.code.add(S.t`bool discardNonSilhouetteEdges(vec3 viewPos, vec3 worldPos) {
vec3 viewNormalA = _modelToViewNormal(normalA);
vec3 viewNormalB = _modelToViewNormal(normalB);
vec3 viewDir = -viewPos;
if (isSilhouetteEdge(viewDir, viewNormalA, viewNormalB)) {
return false;
}
gl_Position = vec4(10.0, 10.0, 10.0, 1.0);
return true;
}`):i.code.add(S.t`bool discardNonSilhouetteEdges(vec3 viewPos, vec3 worldPos) {
vec3 worldNormalA = _modelToWorldNormal(normalA);
vec3 worldNormalB = _modelToWorldNormal(normalB);
vec3 viewDir = -worldPos;
if (isSilhouetteEdge(viewDir, worldNormalA, worldNormalB)) {
return false;
}
gl_Position = vec4(10.0, 10.0, 10.0, 1.0);
return true;
}`)):i.code.add(S.t`bool discardNonSilhouetteEdges(vec3 viewPos, vec3 worldPos) {
return false;
}`)}function fI(e,t){const i=e.vertex;switch(t.mode){case 1:i.code.add(S.t`#define discardShortEdges(unpackedAttributes, lineLengthPixels) { if (lineLengthPixels <= 3.0) { gl_Position = vec4(10.0, 10.0, 10.0, 1.0); return; }}`);break;case 2:i.code.add(S.t`#define discardShortEdges(unpackedAttributes, lineLengthPixels) { if (unpackedAttributes.type <= 0.0 && lineLengthPixels <= 3.0) { gl_Position = vec4(10.0, 10.0, 10.0, 1.0); return; }}`);break;case 0:i.code.add(S.t`#define discardShortEdges(unpackedAttributes, lineLengthPixels) {}`)}}function gI(e,t){const i=e.vertex;i.uniforms.add("uDistanceFalloffFactor","float"),i.code.add(S.t`float distanceBasedPerspectiveFactor(float distance) {
return clamp(sqrt(uDistanceFalloffFactor / distance), 0.0, 1.0);
}`),i.uniforms.add("uComponentDataTex","sampler2D"),i.uniforms.add("uComponentDataTexInvDim","vec2"),e.attributes.add("componentIndex","float"),i.constants.add("componentColorFieldOffset","float",0),i.constants.add("componentOtherFieldOffset","float",1),i.constants.add("componentFieldCount","float",2),i.constants.add("lineWidthFractionFactor","float",8),i.constants.add("extensionLengthOffset","float",128),i.constants.add("componentTexWidth","float",4096),i.code.add(S.t`vec2 _componentTextureCoords(float componentIndex, float fieldOffset) {
float fieldIndex = componentFieldCount * componentIndex + fieldOffset;
float rowIndex = floor(fieldIndex / componentTexWidth);
float colIndex = mod(fieldIndex, componentTexWidth);
vec2 linearIndex = vec2(
(colIndex + 0.5) / componentTexWidth,
(rowIndex + 0.5) * uComponentDataTexInvDim.y
);
return linearIndex;
}
struct ComponentData {
vec4 color;
float lineWidth;
float extensionLength;
float type;
};
ComponentData readComponentData() {
vec2 colorIndex = _componentTextureCoords(componentIndex, componentColorFieldOffset);
vec2 otherIndex = _componentTextureCoords(componentIndex, componentOtherFieldOffset);
vec4 colorValue = texture2D(uComponentDataTex, colorIndex);
vec4 otherValue = texture2D(uComponentDataTex, otherIndex);
return ComponentData(
vec4(colorValue.rgb, colorValue.a * otherValue.w),
otherValue.x * (255.0 / lineWidthFractionFactor),
otherValue.y * 255.0 - extensionLengthOffset,
-(otherValue.z * 255.0) + 0.5
);
}`),t.legacy?i.code.add(S.t`vec3 _modelToWorldNormal(vec3 normal) {
return (uModel * vec4(normal, 0.0)).xyz;
}
vec3 _modelToViewNormal(vec3 normal) {
return (uView * uModel * vec4(normal, 0.0)).xyz;
}`):(i.uniforms.add("uTransformNormal_GlobalFromModel ","mat3"),i.code.add(S.t`vec3 _modelToWorldNormal(vec3 normal) {
return uTransformNormal_GlobalFromModel * normal;
}`)),t.silhouette?(e.attributes.add("normalA","vec3"),e.attributes.add("normalB","vec3"),i.code.add(S.t`vec3 worldNormal() {
return _modelToWorldNormal(normalize(normalA + normalB));
}`)):(e.attributes.add("normal","vec3"),i.code.add(S.t`vec3 worldNormal() {
return _modelToWorldNormal(normal);
}`)),t.legacy?i.code.add(S.t`vec3 worldFromModelPosition(vec3 position) {
return (uModel * vec4(position, 1.0)).xyz;
}
vec3 viewFromModelPosition(vec3 position) {
return (uView * vec4(worldFromModelPosition(position), 1.0)).xyz;
}
vec4 projFromViewPosition(vec3 position) {
return uProj * vec4(position, 1.0);
}`):(e.vertex.include(S.bM,t),i.code.add(S.t`vec3 worldFromModelPosition(vec3 position) {
vec3 rotatedModelPosition = uTransform_WorldFromModel_RS * position;
vec3 transform_CameraRelativeFromModel = dpAdd(
uTransform_WorldFromModel_TL,
uTransform_WorldFromModel_TH,
-uTransform_WorldFromView_TL,
-uTransform_WorldFromView_TH
);
return transform_CameraRelativeFromModel + rotatedModelPosition;
}
vec3 viewFromModelPosition(vec3 position) {
return uTransform_ViewFromCameraRelative_RS * worldFromModelPosition(position);
}
vec4 projFromViewPosition(vec3 position) {
return uTransform_ProjFromView * vec4(position, 1.0);
}`)),i.code.add(S.t`float calculateExtensionLength(float extensionLength, float lineLength) {
return extensionLength / (log2(max(1.0, 256.0 / lineLength)) * 0.2 + 1.0);
}`)}function vI(e,t){const i=e.vertex;switch(e.include(gI,t),e.attributes.add("sideness","vec2"),2===t.mode?i.code.add(S.t`struct UnpackedAttributes {
vec2 sideness;
vec2 sidenessNorm;
float lineWidthPixels;
float extensionLengthPixels;
float type;
};`):i.code.add(S.t`struct UnpackedAttributes {
vec2 sideness;
vec2 sidenessNorm;
float lineWidthPixels;
float extensionLengthPixels;
};`),t.mode){case 2:i.code.add(S.t`UnpackedAttributes unpackAttributes(ComponentData component) {
vec2 sidenessNorm = sideness;
vec2 sideness = sidenessNorm * 2.0 - 1.0;
float fType = component.type;
float extensionLengthPixels = component.extensionLength;
float lineWidth = component.lineWidth;
if (fType <= 0.0) {
extensionLengthPixels *= variantExtension * 2.0 - 1.0;
}
return UnpackedAttributes(sideness, sidenessNorm, lineWidth, extensionLengthPixels, fType);
}`);break;case 1:i.code.add(S.t`UnpackedAttributes unpackAttributes(ComponentData component) {
vec2 sidenessNorm = sideness;
vec2 sideness = sidenessNorm * 2.0 - 1.0;
float extensionLengthPixels = component.extensionLength;
extensionLengthPixels *= variantExtension * 2.0 - 1.0;
float lineWidth = component.lineWidth;
return UnpackedAttributes(sideness, sidenessNorm, lineWidth, extensionLengthPixels);
}`);break;case 0:i.code.add(S.t`UnpackedAttributes unpackAttributes(ComponentData component) {
vec2 sidenessNorm = sideness;
vec2 sideness = sidenessNorm * 2.0 - 1.0;
float extensionLengthPixels = component.extensionLength;
float lineWidth = component.lineWidth;
return UnpackedAttributes(sideness, sidenessNorm, lineWidth, extensionLengthPixels);
}`)}}function yI(e,t){const i=e.vertex;switch(e.include(vI,t),gI.usesSketchLogic(t)&&i.uniforms.add("uStrokesAmplitude","float"),t.mode){case 0:i.code.add(S.t`float calculateLineAmplitude(UnpackedAttributes unpackedAttributes) {
return 0.0;
}`);break;case 1:i.code.add(S.t`float calculateLineAmplitude(UnpackedAttributes unpackedAttributes) {
return uStrokesAmplitude;
}`);break;case 2:i.code.add(S.t`float calculateLineAmplitude(UnpackedAttributes unpackedAttributes) {
float type = unpackedAttributes.type;
if (type <= 0.0) {
return uStrokesAmplitude;
}
else {
return 0.0;
}
}`)}}function _I(e,t){const i=e.vertex;e.include(vI,t);const r=e.fragment;switch(gI.usesSketchLogic(t)&&(i.uniforms.add("uStrokesTextureScale","vec2"),i.uniforms.add("uStrokesLog2Resolution","float"),i.uniforms.add("uStrokeVariants","float"),e.varyings.add("vStrokeUV","vec2"),r.uniforms.add("uStrokesTexture","sampler2D"),r.uniforms.add("uStrokesNormalizationScale","float"),i.code.add(S.t`void calculateStyleOutputsSketch(float lineLength, UnpackedAttributes unpackedAttributes) {
vec2 sidenessNorm = unpackedAttributes.sidenessNorm;
float lineIndex = clamp(ceil(log2(lineLength)), 0.0, uStrokesLog2Resolution);
vStrokeUV = vec2(exp2(lineIndex) * sidenessNorm.y, lineIndex * uStrokeVariants + variantStroke + 0.5) * uStrokesTextureScale;
vStrokeUV.x += variantOffset;
}`),e.fragment.include(S.M),r.code.add(S.t`float calculateLineOffsetSketch() {
float offsetNorm = rgba2float(texture2D(uStrokesTexture, vStrokeUV));
return (offsetNorm - 0.5) * uStrokesNormalizationScale;
}
float calculateLinePressureSketch() {
return rgba2float(texture2D(uStrokesTexture, vStrokeUV + vec2(0.0, 0.5)));
}`)),t.mode){case 0:i.code.add(S.t`void calculateStyleOutputs(UnpackedAttributes unpackedAttributes) {}`),r.code.add(S.t`float calculateLineOffset() {
return 0.0;
}
float calculateLinePressure() {
return 1.0;
}`);break;case 1:i.code.add(S.t`void calculateStyleOutputs(UnpackedAttributes unpackedAttributes)
{
calculateStyleOutputsSketch(vLineLengthPixels, unpackedAttributes);
}`),r.code.add(S.t`float calculateLineOffset() {
return calculateLineOffsetSketch();
}
float calculateLinePressure() {
return calculateLinePressureSketch();
}`);break;case 2:e.varyings.add("vType","float"),i.code.add(S.t`void calculateStyleOutputs(UnpackedAttributes unpackedAttributes)
{
vType = unpackedAttributes.type;
if (unpackedAttributes.type <= 0.0) {
calculateStyleOutputsSketch(vLineLengthPixels, unpackedAttributes);
}
}`),r.code.add(S.t`float calculateLineOffset() {
if (vType <= 0.0) {
return calculateLineOffsetSketch();
}
else {
return 0.0;
}
}
float calculateLinePressure() {
if (vType <= 0.0) {
return calculateLinePressureSketch();
}
else {
return 1.0;
}
}`)}}function xI(e){const t=new S.n,i=t.vertex,r=t.fragment;return e.legacy&&i.uniforms.add("uModel","mat4"),e.antialiasing&&(i.code.add(S.t`#define ANTIALIASING 1`),r.code.add(S.t`#define ANTIALIASING 1`)),t.include(uI,e),t.include(yI,e),t.include(gI,e),t.include(vI,e),t.include(_I,e),t.include(S.N,e),t.include(mI,e),t.include(pI,e),t.include(fI,e),t.varyings.add("vColor","vec4"),t.varyings.add("vRadius","float"),t.varyings.add("vPosition","vec3"),t.varyings.add("vWorldPosition","vec3"),t.varyings.add("vViewPos","vec3"),t.varyings.add("vLineLengthPixels","float"),t.varyings.add("vSizeFalloffFactor","float"),i.uniforms.add("uPixelToNDC","vec2"),i.uniforms.add("uNDCToPixel","vec2"),i.uniforms.add("uPixelRatio","float"),t.attributes.add("position0","vec3"),t.attributes.add("position1","vec3"),t.attributes.add("variantOffset","float"),t.attributes.add("variantStroke","float"),t.attributes.add("variantExtension","float"),i.code.add(S.t`const float opaqueCutoff = 1.0 / 255.0;
void calculateGeometricOutputs(vec3 viewPosV0, vec3 viewPosV1, vec3 worldPosV0, vec3 worldPosV1, vec3 worldNormal, UnpackedAttributes unpackedAttributes) {
vec2 sideness = unpackedAttributes.sideness;
vec2 sidenessNorm = unpackedAttributes.sidenessNorm;
vWorldPosition = mix(worldPosV0, worldPosV1, sidenessNorm.y).xyz;
vec3 viewPos = mix(viewPosV0, viewPosV1, sidenessNorm.y);
vViewPos = viewPos;
vec4 projPosV0 = projFromViewPosition(viewPosV0);
vec4 projPosV1 = projFromViewPosition(viewPosV1);
vec4 projPos = projFromViewPosition(viewPos);
vec3 screenSpaceLineNDC = (projPosV1.xyz / projPosV1.w - projPosV0.xyz / projPosV0.w);
vec2 screenSpaceLinePixels = screenSpaceLineNDC.xy * uNDCToPixel;
float lineLengthPixels = length(screenSpaceLinePixels);
float dzPerPixel = screenSpaceLineNDC.z / lineLengthPixels;
vec2 screenSpaceDirection = screenSpaceLinePixels / lineLengthPixels;
vec2 perpendicularScreenSpaceDirection = vec2(screenSpaceDirection.y, -screenSpaceDirection.x) * sideness.x;
float falloffFactor = distanceBasedPerspectiveFactor(-viewPos.z) * uPixelRatio;
float lineWidthPixels = unpackedAttributes.lineWidthPixels * falloffFactor;
float extensionLengthPixels = calculateExtensionLength(unpackedAttributes.extensionLengthPixels, lineLengthPixels) * falloffFactor;
float lineAmplitudePixels = calculateLineAmplitude(unpackedAttributes) * uPixelRatio;
vSizeFalloffFactor = falloffFactor;
float lineWidthAndAmplitudePixels = lineWidthPixels + lineAmplitudePixels + lineAmplitudePixels;
float extendedLineLengthPixels = lineLengthPixels + extensionLengthPixels + extensionLengthPixels;
#ifdef ANTIALIASING
const float aaPaddingPixels = 1.0;
float halfAAPaddedLineWidthAndAmplitudePixels = lineWidthAndAmplitudePixels * 0.5 + aaPaddingPixels;
float aaPaddedRoundedCapSizePixels = lineWidthPixels * 0.5 + aaPaddingPixels;
#else
float halfAAPaddedLineWidthAndAmplitudePixels = max(lineWidthAndAmplitudePixels, 1.0) * 0.5;
float aaPaddedRoundedCapSizePixels = max(lineWidthPixels, 1.0) * 0.5;
#endif
vec2 halfAAPaddedLineWidthAndAmplitudeNDC = halfAAPaddedLineWidthAndAmplitudePixels * uPixelToNDC;
vec2 aaPaddedRoundedCapSizeNDC = aaPaddedRoundedCapSizePixels * uPixelToNDC;
vec2 extensionLengthNDC = extensionLengthPixels * uPixelToNDC;
vec2 ndcOffset = (
screenSpaceDirection * sideness.y * (aaPaddedRoundedCapSizeNDC + extensionLengthNDC)
+ perpendicularScreenSpaceDirection * halfAAPaddedLineWidthAndAmplitudeNDC
);
projPos.xy += ndcOffset * projPos.w;
projPos.z += (dzPerPixel * (aaPaddedRoundedCapSizePixels + extensionLengthPixels)) * sideness.y * projPos.w;
projPos = adjustProjectedPosition(projPos, worldNormal, 1.0 + max((lineWidthAndAmplitudePixels - 1.0) * 0.5, 0.0));
float aaPaddedLineWithCapsLengthPixels = extendedLineLengthPixels + aaPaddedRoundedCapSizePixels + aaPaddedRoundedCapSizePixels;
float pixelPositionAlongLine = aaPaddedLineWithCapsLengthPixels * sidenessNorm.y - aaPaddedRoundedCapSizePixels;
vPosition = vec3(
halfAAPaddedLineWidthAndAmplitudePixels * sideness.x,
pixelPositionAlongLine,
pixelPositionAlongLine / extendedLineLengthPixels
);
vRadius = lineWidthPixels * 0.5;
vLineLengthPixels = extendedLineLengthPixels;
discardShortEdges(unpackedAttributes, lineLengthPixels);
gl_Position = projPos;
}
void main() {
ComponentData component = readComponentData();
UnpackedAttributes unpackedAttributes = unpackAttributes(component);
vec3 worldPosV0 = worldFromModelPosition(position0);
vec3 worldPosV1 = worldFromModelPosition(position1);
vec3 viewPosV0 = viewFromModelPosition(position0);
vec3 viewPosV1 = viewFromModelPosition(position1);
vColor = component.color;
if (vColor.a < opaqueCutoff) {
gl_Position = vec4(10.0, 10.0, 10.0, 1.0);
return;
}
if (discardNonSilhouetteEdges(viewPosV0, worldPosV0)) {
return;
}
calculateGeometricOutputs(viewPosV0, viewPosV1, worldPosV0, worldPosV1, worldNormal(), unpackedAttributes);
calculateStyleOutputs(unpackedAttributes);
}`),e.multipassTerrainEnabled&&(t.fragment.include(S.L),t.include(S.ap,e)),t.fragment.code.add(S.t`
    vec2 lineWithCapsDistance(float radius, vec2 position, float lineLength) {
      float lineOffset = calculateLineOffset();
      float positionX = position.x - lineOffset;

      if (radius < 1.0) {
        // Handle this specifically for subpixel sizes:
        // 1. Compute correct coverage (note coverage is computed by
        //    0.5 - dist, so we make sure that that will lead to correct
        //    subpixel coverage
        // 2. Ignore rounded caps
        float coverageX = clamp(min(radius, positionX + 0.5) - max(-radius, positionX - 0.5), 0.0, 1.0);
        float coverageY = clamp(min(lineLength, position.y + 0.5) - max(0.0, position.y - 0.5), 0.0, 1.0);

        float coverage = min(coverageX, coverageY);

        return vec2(0.5 - coverage, 0.0);
      }
      else {
        // Between -radius -> 0 for start cap, 0 for line, 0 -> radius
        float positionOnCap = position.y - clamp(position.y, 0.0, lineLength);

        vec2 lineToPosition = vec2(positionX, positionOnCap);
        return vec2(length(lineToPosition) - radius, positionOnCap / radius);
      }
    }

    void main() {
      ${e.multipassTerrainEnabled?"terrainDepthTest(gl_FragCoord, vViewPos.z);":""}
      float radius = vRadius * calculateLinePressure();

      vec2 distance = lineWithCapsDistance(radius, vPosition.xy, vLineLengthPixels);
      float coverage = clamp(0.5 - distance.x, 0.0, 1.0);

      discardByCoverage(radius, coverage);
      discardBySlice(vWorldPosition);

      float alpha = vColor.a * coverage;

      gl_FragColor = vec4(vColor.rgb, alpha);

    }
  `),t}!function(e){e.usesSketchLogic=function(e){return 1===e.mode||2===e.mode},e.usesSolidLogic=function(e){return 0===e.mode||2===e.mode}}(gI||(gI={}));var bI=Object.freeze({__proto__:null,build:xI});class wI extends S.c{bindPass(e){const t=this.program,{edgeRenderParameters:i,bindParameters:r}=e;S.bv.bindViewProjTransform(t,i.viewProjectionTransform),t.setUniformMatrix3fv("uTransformNormal_ViewFromGlobal",i.transformNormal_ViewFromGlobal),t.setUniformMatrix4fv("uProj",r.camera.projectionMatrix),t.setUniform2f("uDepthBias",.5,-4e-4),t.setUniform2f("uPixelToNDC",2/r.camera.fullViewport[2],2/r.camera.fullViewport[3]),t.setUniform2f("uNDCToPixel",r.camera.fullViewport[2]/2,r.camera.fullViewport[3]/2),t.setUniform1f("uDistanceFalloffFactor",i.distanceFalloffFactor),t.setUniform2f("uViewportDimInv",1/r.camera.fullViewport[2],1/r.camera.fullViewport[3]),t.setUniform1f("uPixelRatio",r.camera.pixelRatio||1)}initializeProgram(e){const t=wI.shader.get(),i=this.configuration,r=t.build({slicePlaneEnabled:i.slicePlaneEnabled,sliceHighlightDisabled:!1,sliceEnabledForVertexPrograms:!1,silhouette:i.silhouette,legacy:i.legacy,antialiasing:i.antialiasing,mode:i.mode,doublePrecisionRequiresObfuscation:i.doublePrecisionRequiresObfuscation,multipassTerrainEnabled:i.multipassTerrainEnabled,cullAboveGround:i.cullAboveGround});return new S.d(e.rctx,r,U.p)}initializePipeline(e){const t=e.rctx.capabilities.blendMinMax;return(0,V.g)(t?{blending:(0,V.e)(1,1,0,1,32774,t.MAX),depthTest:{func:515},colorWrite:V.r}:{depthTest:{func:515},depthWrite:V.l,colorWrite:V.r})}}wI.shader=new S.f(bI,(()=>i.e(7585).then(i.bind(i,57585)))),function(e){class t extends S.b{constructor(){super(...arguments),this.slicePlaneEnabled=!1,this.silhouette=!1,this.legacy=!1,this.antialiasing=!1,this.mode=0,this.doublePrecisionRequiresObfuscation=!1,this.multipassTerrainEnabled=!1,this.cullAboveGround=!1}}(0,r.e)([(0,S.a)()],t.prototype,"slicePlaneEnabled",void 0),(0,r.e)([(0,S.a)()],t.prototype,"silhouette",void 0),(0,r.e)([(0,S.a)()],t.prototype,"legacy",void 0),(0,r.e)([(0,S.a)()],t.prototype,"antialiasing",void 0),(0,r.e)([(0,S.a)({count:3})],t.prototype,"mode",void 0),(0,r.e)([(0,S.a)()],t.prototype,"doublePrecisionRequiresObfuscation",void 0),(0,r.e)([(0,S.a)()],t.prototype,"multipassTerrainEnabled",void 0),(0,r.e)([(0,S.a)()],t.prototype,"cullAboveGround",void 0),e.Configuration=t}(wI||(wI={}));const CI={type:"uber",slicePlaneEnabled:!1,sliceHighlightDisabled:!1,strokesTexture:null,legacy:!0};class TI{constructor(){this._value=0}get value(){return this._value}increment(){this._value++}decrement(){this._value--}}const SI={solid:0,sketch:1,uber:2};class PI{constructor(e,t,i){this.rctx=e,this.shaderTechniqueRepository=t,this.config=new wI.Configuration,this.technique=null,this.refCount=new TI,this.renderables=new Set,this.sortedRenderables={1:{1:new r.f,2:new r.f},2:{1:new r.f,2:new r.f}},this.renderablesDirty=!1,this.settings={...CI,...i},this.key=PI.getKey(this.settings.type,this.settings.slicePlaneEnabled,this.settings.legacy);const s=this.settings.strokesTexture.variants;this.writerSettings={variants:s,reducedPrecision:Ih.DISABLE_ELEVATION_ALIGNERS_ITERATIVE_UPDATES},this.config.legacy=this.settings.legacy,this.config.mode=SI[this.settings.type],this.config.silhouette=!1,this.config.antialiasing=!!this.rctx.capabilities.blendMinMax,this.config.slicePlaneEnabled=this.settings.slicePlaneEnabled,this.config.doublePrecisionRequiresObfuscation=(0,S.bD)(e)}dispose(){this.technique=(0,u.h)(this.technique)}addRenderable(e){this.renderables.add(e),this.renderablesDirty=!0}removeRenderable(e){this.renderables.delete(e),this.renderablesDirty=!0}setRenderablesDirty(){this.renderablesDirty=!0}forEachRenderable(e,t){this.renderablesDirty&&this.sortRenderables(),this.sortedRenderables[t][1].forAll(e),this.sortedRenderables[t][2].forAll(e)}setMultipassParameters(e){this.config.multipassTerrainEnabled=!!e.multipassTerrainEnabled&&e.multipassTerrainEnabled,this.config.cullAboveGround=!!e.cullAboveGround&&e.cullAboveGround}bindRegularEdges(e,t){this.setMultipassParameters(e),this.config.silhouette=!1,this.technique=this.shaderTechniqueRepository.releaseAndAcquire(wI,this.config,this.technique),this.technique.bindPass({bindParameters:e,edgeRenderParameters:t}),this.rctx.setPipelineState(this.technique.pipeline),this.rctx.useProgram(this.technique.program)}bindSilhouetteEdges(e,t){this.setMultipassParameters(e),this.config.silhouette=!0,this.technique=this.shaderTechniqueRepository.releaseAndAcquire(wI,this.config,this.technique),this.technique.bindPass({bindParameters:e,edgeRenderParameters:t}),this.rctx.setPipelineState(this.technique.pipeline),this.rctx.useProgram(this.technique.program)}renderRegularEdges(e,t,i){this.render(e,e.regular.vao,t,i)}renderSilhouetteEdges(e,t,i){this.render(e,e.silhouette.vao,t,i)}render(e,t,i,r){this.setUniforms(e,i),this.rctx.bindVAO(t),this.rctx.capabilities.instancing.drawArraysInstanced(6,0,4,r)}setUniforms(e,t){const i=this.technique.program;if(e.components.buffer.textureBuffer.bind(i,RI,AI),t.multipassTerrainEnabled&&(i.setUniform2fv("cameraNearFar",t.camera.nearFar),i.setUniform2fv("inverseViewport",t.inverseViewport),(0,S.Y)(i,t)),"origin"in e.transform)i.setUniformMatrix4fv("uView",t.localViewMatrixForEdges),i.setUniformMatrix4fv("uModel",e.transform.modelMatrix),(0,S.bp)(i,this.settings,t.slicePlane,e.transform.origin.vec3);else{const r=new QD(e.transform.position),s=(0,Y.o)(MI,(0,Y.u)(MI,e.transform.rotationScale)),n=new UD;(0,v.h)(n.worldFromModel_TL,r.low),(0,v.h)(n.worldFromModel_TH,r.high),(0,Y.n)(n.worldFromModel_RS,e.transform.rotationScale),(0,Y.n)(n.transformNormal_GlobalFromModel,s),S.bv.bindModelTransform(i,n),i.setUniformMatrix3fv("uTransformNormal_GlobalFromModel",n.transformNormal_GlobalFromModel);const a=t.camera.viewInverseTransposeMatrix,o=(0,v.a)(OI,a[3],a[7],a[11]);(0,S.bp)(i,this.settings,t.slicePlane,o)}"uber"!==this.settings.type&&"sketch"!==this.settings.type||this.setSketchUniforms(i),i.setUniform1f("uWorldLineRadiusPerDistance",Math.tan(t.camera.fovY/2)/(t.camera.fullViewport[3]/2))}setSketchUniforms(e){const t=this.settings.strokesTexture,i=t.texture;(0,u.t)(i)||(e.bindTexture(i,"uStrokesTexture"),e.setUniform2f("uStrokesTextureScale",1/i.descriptor.width,1/i.descriptor.height),e.setUniform1f("uStrokesLog2Resolution",(0,v.V)(t.resolution)),e.setUniform1f("uStrokesNormalizationScale",t.normalizationScale),e.setUniform1f("uStrokesAmplitude",t.amplitude),e.setUniform1f("uStrokeVariants",t.variants))}sortRenderables(){this.renderablesDirty=!1,this.sortedRenderables[1][1].clear(),this.sortedRenderables[1][2].clear(),this.sortedRenderables[2][1].clear(),this.sortedRenderables[2][2].clear(),this.renderables.forEach((e=>{0!==e.objectTransparency&&0!==e.edgeTransparency&&this.sortedRenderables[e.objectTransparency][e.edgeTransparency].push(e)}));const e=(e,t)=>"origin"in e.transform&&"origin"in t.transform?e.transform.origin.id<t.transform.origin.id?-1:e.transform.origin.id>t.transform.origin.id?1:0:0;this.sortedRenderables[1][1].sort(e),this.sortedRenderables[1][2].sort(e),this.sortedRenderables[2][1].sort(e),this.sortedRenderables[2][2].sort(e)}static getKey(e,t,i){return`edges-t:${e}:${t}:${i}`}}const RI="uComponentDataTex",AI="uComponentDataTexInvDim",MI=(0,s.a0)(),OI=(0,v.n)();class DI extends Pe.a{constructor(e){super("EdgeProcessingWorker","wrappedWork",e)}async process(e,t,i){if(i)return(0,U.f)(e);const r=this._packInput(e),s=await this.invoke(r,t);return this._unpackOutput(s)}getTransferList(e){return[e.dataBuffer]}_packInput(e){return{dataBuffer:e.data.buffer,writerSettings:e.writerSettings,skipDeduplicate:e.skipDeduplicate,indicesBuffer:e.indices.buffer,indicesType:(0,u.H)(e.indices)?"Uint32Array":"Uint16Array",indicesLength:e.indicesLength}}_unpackOutput(e){return{regular:{instancesData:(0,U.D)(e.regular.instancesData),lodInfo:{lengths:new Float32Array(e.regular.lodInfo.lengths)}},silhouette:{instancesData:(0,U.D)(e.silhouette.instancesData),lodInfo:{lengths:new Float32Array(e.silhouette.lodInfo.lengths)}},averageEdgeLength:e.averageEdgeLength}}}function EI(e,t){if(!e)return null;const i=e.length/2,r=zI*i,s=new Array(i);let n=0;const a=1===t;for(let t=0;t<e.length;t+=2){const i=(e[t]+e[t+1])/2;s[n++]=a?Math.min(r,1-(1-i)*II):Math.min(r,i*II)}return s}const zI=.1,II=.5;class LI{constructor(e,t,i,r,s){this.resolution=e,this.normalizationScale=t,this.amplitude=i,this.variants=r,this.texture=s}dispose(){this.texture=(0,u.z)(this.texture)}}const FI=8,VI=256,UI=[{distance:[-1.59027,-1.59426,-1.59674,-1.59766,-1.59702,-1.59479,-1.59095,-1.5855,-1.57843,-1.56973,-1.55942,-1.5475,-1.53398,-1.5189,-1.50226,-1.4841,-1.46446,-1.44337,-1.42088,-1.39703,-1.37188,-1.34547,-1.31786,-1.28912,-1.2593,-1.22847,-1.19668,-1.16402,-1.13053,-1.09629,-1.06137,-1.02582,-.98972,-.95313,-.91611,-.87872,-.84102,-.80306,-.76488,-.72654,-.68807,-.64952,-.61092,-.57232,-.53375,-.49527,-.45692,-.41874,-.38078,-.34309,-.3057,-.26867,-.23204,-.19585,-.16015,-.12497,-.09036,-.05634,-.02296,.00977,.04183,.07321,.10389,.13386,.16313,.19169,.21956,.24672,.27321,.299,.32413,.34858,.37237,.3955,.41798,.43981,.461,.48154,.50145,.52073,.53939,.55744,.57488,.5917,.6079,.62347,.63837,.65259,.66609,.67885,.69083,.70201,.71235,.72183,.73042,.73812,.7449,.75076,.7557,.75973,.76284,.76507,.76642,.76692,.76659,.76545,.76352,.76083,.7574,.75324,.74837,.74279,.73652,.72959,.72199,.71377,.70493,.69553,.68558,.67515,.66426,.65298,.64135,.62944,.6173,.60499,.59257,.58008,.56759,.55513,.54275,.5305,.51842,.50654,.4949,.48353,.47246,.4617,.45128,.44121,.43149,.42213,.41313,.40448,.39617,.38818,.3805,.37309,.36594,.35902,.35229,.34572,.33927,.33292,.32663,.32035,.31407,.30774,.30135,.29486,.28824,.28148,.27454,.26739,.26002,.25241,.24454,.23639,.22796,.21922,.21016,.20076,.19098,.18082,.17023,.1592,.14768,.13566,.1231,.10996,.09624,.08188,.06688,.05121,.03485,.01778,0,-.0185,-.03771,-.05763,-.07824,-.09952,-.12144,-.14396,-.16706,-.19069,-.21481,-.23938,-.26436,-.28971,-.31539,-.34136,-.36759,-.39404,-.42067,-.44746,-.47437,-.50136,-.52839,-.55544,-.58248,-.60948,-.63642,-.66329,-.6901,-.71684,-.74352,-.77015,-.79675,-.82332,-.84988,-.87644,-.90301,-.92958,-.95615,-.98272,-1.00926,-1.03575,-1.06217,-1.08847,-1.11463,-1.1406,-1.16633,-1.19178,-1.2169,-1.24164,-1.26595,-1.28979,-1.31312,-1.3359,-1.35809,-1.37963,-1.4005,-1.42064,-1.44,-1.45853,-1.47616,-1.49285,-1.50853,-1.52313,-1.53659,-1.54886,-1.55986,-1.56955,-1.57788,-1.5848],pressure:[-.01365,-.00206,.01025,.02327,.03696,.05129,.06619,.08163,.09755,.11393,.1307,.14784,.16531,.18308,.20111,.21938,.23786,.25651,.2753,.29419,.31315,.33215,.35115,.37015,.38913,.40806,.42694,.44576,.46449,.48313,.50167,.5201,.53839,.55653,.57448,.59222,.60971,.62692,.6438,.66033,.67648,.69221,.70753,.72242,.73688,.75093,.76456,.77779,.79063,.80309,.81517,.82686,.83817,.84911,.85967,.86987,.87972,.88924,.89845,.90734,.91594,.92425,.93229,.94005,.94754,.95475,.96166,.96826,.97451,.9804,.98588,.99092,.99549,.99957,.99685,.99381,.99131,.98936,.98796,.98711,.98681,.98706,.98787,.98923,.99113,.99357,.99654,1,.99607,.99171,.98695,.98181,.97634,.97057,.96452,.95824,.95175,.94506,.93818,.93113,.92389,.91647,.90887,.90109,.89314,.88501,.87672,.86831,.85978,.85119,.84256,.83393,.82533,.8168,.80836,.80002,.79181,.78374,.77582,.7681,.76059,.75331,.74629,.73955,.73311,.72697,.72116,.71568,.71054,.70572,.70121,.697,.69304,.68931,.68576,.68236,.67905,.67582,.67262,.66941,.66619,.66291,.65957,.65613,.65259,.64892,.6451,.6411,.6369,.63248,.62783,.62295,.61783,.61247,.60688,.60104,.59498,.58868,.58216,.57542,.56845,.56125,.5538,.5461,.53813,.52986,.52129,.51239,.50316,.49359,.4837,.47349,.46299,.45223,.44124,.43005,.41869,.40719,.39557,.38386,.37207,.36023,.34836,.33648,.32464,.31287,.30119,.28963,.27822,.26698,.25594,.2451,.23448,.22409,.21391,.20394,.19415,.18452,.17503,.16565,.15636,.14713,.13794,.1288,.11968,.11058,.10151,.09247,.08346,.07447,.06552,.05659,.0477,.03885,.03007,.02137,.01278,.00433,-.00393,-.012,-.01983,-.02738,-.03463,-.04155,-.0481,-.05429,-.0601,-.06553,-.07057,-.07524,-.07954,-.08347,-.08703,-.09022,-.09303,-.09544,-.09744,-.09898,-.10004,-.10059,-.1006,-.10005,-.09892,-.0972,-.09487,-.09192,-.08833,-.08409,-.07918,-.07357,-.06724,-.06019,-.0524,-.04386,-.03455,-.02448]},{distance:[-3.46259,-3.47131,-3.47668,-3.47863,-3.47712,-3.4721,-3.46352,-3.45138,-3.43566,-3.41635,-3.39347,-3.36704,-3.33709,-3.30368,-3.26684,-3.22667,-3.18322,-3.1366,-3.08689,-3.0342,-2.97865,-2.92036,-2.85946,-2.79607,-2.73034,-2.66241,-2.59242,-2.52052,-2.44686,-2.37159,-2.29485,-2.2168,-2.13757,-2.05731,-1.97616,-1.89426,-1.81174,-1.72875,-1.64543,-1.56191,-1.47833,-1.39483,-1.3115,-1.22847,-1.14581,-1.06361,-.98193,-.90083,-.82036,-.74054,-.66141,-.583,-.50532,-.4284,-.35228,-.277,-.20261,-.12916,-.05672,.01463,.08485,.15384,.22153,.28784,.35269,.41602,.47776,.53787,.59629,.653,.70799,.76123,.81274,.86253,.9106,.95698,1.0017,1.04477,1.0862,1.126,1.16415,1.20065,1.23546,1.26857,1.29994,1.32953,1.35731,1.38321,1.40719,1.42921,1.44922,1.46719,1.48309,1.49691,1.50862,1.51825,1.52581,1.53133,1.53486,1.53644,1.53616,1.53409,1.53031,1.52493,1.51803,1.50972,1.50009,1.48924,1.47725,1.46421,1.45019,1.43527,1.4195,1.40295,1.38568,1.36778,1.34929,1.3303,1.31087,1.29108,1.27099,1.25066,1.23018,1.2096,1.18898,1.16838,1.14785,1.12745,1.10721,1.08719,1.06741,1.04791,1.02871,1.00986,.99136,.97324,.95551,.93819,.92127,.90476,.88866,.87296,.85767,.84277,.82823,.81406,.80022,.7867,.77346,.76049,.74774,.73519,.72278,.71049,.69827,.68606,.67381,.66145,.64893,.63618,.62313,.60973,.5959,.5816,.56675,.5513,.53516,.51826,.50053,.4819,.46231,.44169,.42002,.39725,.37336,.34834,.32219,.2949,.2665,.23698,.20638,.17469,.14193,.10809,.07316,.03714,0,-.03827,-.07772,-.11836,-.16022,-.20332,-.24768,-.29332,-.34024,-.38844,-.43788,-.48854,-.54036,-.59329,-.64724,-.70211,-.75782,-.81425,-.87128,-.92881,-.98674,-1.04498,-1.10346,-1.1621,-1.22086,-1.27969,-1.33854,-1.3974,-1.45625,-1.51511,-1.57396,-1.63283,-1.69173,-1.75067,-1.80968,-1.86875,-1.9279,-1.98712,-2.04639,-2.10568,-2.16495,-2.22416,-2.28322,-2.34208,-2.40063,-2.4588,-2.51647,-2.57354,-2.62989,-2.68543,-2.74002,-2.79357,-2.84597,-2.89711,-2.94689,-2.99521,-3.04195,-3.087,-3.13023,-3.17152,-3.21075,-3.24779,-3.28252,-3.3148,-3.34451,-3.37154,-3.39577,-3.41709,-3.43539,-3.45059],pressure:[.87183,.87151,.87129,.87118,.87117,.87128,.87149,.87182,.87225,.8728,.87347,.87424,.87513,.87613,.87723,.87845,.87978,.88122,.88276,.88441,.88616,.88801,.88996,.892,.89414,.89637,.89868,.90108,.90356,.90611,.90874,.91144,.91421,.91704,.91993,.92287,.92587,.92892,.93201,.93514,.93831,.94151,.94474,.94799,.95126,.95456,.95786,.96118,.9645,.96783,.97116,.97448,.9778,.98111,.98441,.9877,.99096,.99421,.99742,.99938,.99622,.9931,.99001,.98697,.98397,.98101,.97811,.97526,.97246,.96972,.96703,.96441,.96185,.95935,.95691,.95455,.95225,.95002,.94786,.94577,.94376,.94182,.93995,.93817,.93646,.93483,.93328,.93181,.93042,.92911,.92788,.92673,.92566,.92467,.92376,.92293,.92217,.92149,.92088,.92034,.91987,.91947,.91913,.91886,.91864,.91849,.91838,.91833,.91834,.91839,.91849,.91863,.91883,.91907,.91935,.91968,.92005,.92046,.92092,.92142,.92195,.92253,.92314,.9238,.92449,.92521,.92598,.92677,.9276,.92847,.92936,.93029,.93125,.93224,.93325,.9343,.93537,.93646,.93758,.93872,.93988,.94106,.94225,.94346,.94469,.94593,.94718,.94844,.94971,.95098,.95226,.95354,.95482,.9561,.95738,.95867,.95995,.96122,.9625,.96377,.96504,.9663,.96757,.96883,.97009,.97135,.97261,.97387,.97513,.9764,.97767,.97895,.98023,.98153,.98284,.98416,.98549,.98684,.98821,.9896,.99101,.99244,.99389,.99537,.99688,.99842,1,.99839,.99675,.99508,.99336,.99161,.98982,.98799,.98613,.98422,.98228,.98029,.97827,.97622,.97414,.97202,.96987,.9677,.96551,.9633,.96107,.95882,.95656,.9543,.95202,.94975,.94747,.94519,.94292,.94065,.93838,.93613,.93388,.93164,.92941,.9272,.92499,.9228,.92062,.91846,.91631,.91418,.91207,.90998,.90792,.90588,.90387,.90189,.89995,.89804,.89617,.89434,.89256,.89083,.88914,.88752,.88595,.88443,.88299,.88161,.8803,.87907,.87791,.87683,.87584,.87494,.87412,.8734,.87278,.87225]},{distance:[.39335,.43437,.47737,.52234,.56923,.61801,.66864,.72109,.7753,.83123,.88882,.94801,1.00875,1.07097,1.13461,1.1996,1.26586,1.33333,1.40193,1.47158,1.54221,1.61373,1.68607,1.75913,1.83284,1.90711,1.98186,2.05699,2.13243,2.20809,2.28387,2.35971,2.4355,2.51117,2.58663,2.66179,2.73658,2.81092,2.88473,2.95792,3.03043,3.10217,3.17308,3.24309,3.31211,3.3801,3.44697,3.51267,3.57712,3.64028,3.70208,3.76247,3.8214,3.87881,3.93467,3.98892,4.04152,4.09244,4.14164,4.18908,4.23474,4.27859,4.32061,4.36077,4.39905,4.43544,4.46992,4.50249,4.53314,4.56185,4.58864,4.61349,4.63642,4.65745,4.67657,4.69381,4.7092,4.72274,4.73447,4.74441,4.75259,4.75903,4.76376,4.76682,4.76822,4.768,4.76618,4.76279,4.75786,4.75142,4.74348,4.73409,4.72326,4.71102,4.69739,4.68241,4.6661,4.64849,4.6296,4.60948,4.58816,4.56567,4.54204,4.51732,4.49154,4.46473,4.43694,4.4082,4.37854,4.348,4.31662,4.28443,4.25145,4.21773,4.1833,4.14819,4.11243,4.07606,4.03912,4.00162,3.96361,3.92512,3.88618,3.84683,3.80708,3.76697,3.72653,3.68579,3.64478,3.60351,3.56202,3.52033,3.47845,3.43642,3.39425,3.35196,3.30957,3.2671,3.22455,3.18196,3.13933,3.09668,3.05402,3.01136,2.96873,2.92613,2.88357,2.84108,2.79865,2.75631,2.71407,2.67195,2.62994,2.58807,2.54634,2.50477,2.46338,2.42216,2.38114,2.34032,2.29971,2.25933,2.21916,2.17923,2.13954,2.10008,2.06087,2.02189,1.98316,1.94468,1.90644,1.86845,1.83069,1.79316,1.75586,1.71877,1.68189,1.6452,1.60868,1.57232,1.53611,1.50004,1.46407,1.4282,1.39241,1.35668,1.321,1.28535,1.24972,1.2141,1.17849,1.14286,1.10723,1.07158,1.03593,1.00028,.96464,.92902,.89344,.85793,.8225,.78719,.75203,.71705,.68231,.64784,.61369,.57991,.54656,.51368,.48134,.44959,.41849,.3881,.35848,.32967,.30174,.27474,.24872,.22373,.19982,.17702,.15539,.13497,.11579,.09791,.08137,.06621,.05248,.04022,.02948,.02029,.01271,.00677,.00252,0,-76e-5,27e-5,.00314,.00788,.01451,.02307,.03357,.04604,.0605,.07697,.09546,.11599,.13858,.16322,.18992,.21869,.24952,.28241,.31735,.35434],pressure:[.95248,.95236,.95228,.95223,.95222,.95224,.95231,.95241,.95256,.95274,.95296,.95322,.95352,.95385,.95423,.95465,.9551,.9556,.95613,.9567,.95731,.95796,.95864,.95936,.96012,.96091,.96173,.96259,.96348,.9644,.96535,.96633,.96734,.96838,.96944,.97053,.97164,.97277,.97393,.9751,.97629,.9775,.97873,.97997,.98122,.98249,.98376,.98505,.98634,.98763,.98893,.99023,.99154,.99284,.99414,.99544,.99673,.99802,.9993,.99942,.99816,.99691,.99568,.99445,.99324,.99205,.99087,.98972,.98858,.98746,.98636,.98528,.98423,.9832,.98219,.98121,.98025,.97931,.9784,.97752,.97666,.97582,.97501,.97423,.97347,.97274,.97203,.97135,.9707,.97007,.96948,.9689,.96836,.96784,.96735,.96689,.96646,.96605,.96567,.96533,.965,.96471,.96445,.96421,.964,.96382,.96367,.96355,.96346,.96339,.96335,.96334,.96336,.9634,.96348,.96358,.9637,.96385,.96403,.96423,.96446,.96471,.96499,.96529,.96561,.96595,.96631,.96669,.96709,.96751,.96795,.9684,.96887,.96935,.96984,.97035,.97087,.9714,.97194,.97249,.97304,.97361,.97418,.97476,.97534,.97592,.97651,.97711,.9777,.9783,.9789,.9795,.9801,.9807,.9813,.9819,.9825,.98309,.98369,.98428,.98486,.98545,.98603,.98661,.98718,.98775,.98832,.98888,.98944,.99,.99056,.99112,.99167,.99223,.99279,.99335,.99392,.99449,.99507,.99565,.99624,.99684,.99745,.99807,.9987,.99934,1,.99933,.99866,.99797,.99727,.99656,.99583,.9951,.99435,.99359,.99283,.99205,.99126,.99046,.98966,.98885,.98803,.9872,.98637,.98554,.9847,.98387,.98303,.98219,.98134,.9805,.97967,.97883,.978,.97717,.97634,.97552,.97471,.97389,.97309,.97229,.9715,.97071,.96993,.96915,.96838,.96762,.96687,.96612,.96539,.96466,.96395,.96324,.96255,.96187,.9612,.96055,.95991,.95929,.95869,.95811,.95754,.957,.95648,.95599,.95552,.95508,.95467,.95428,.95393,.9536,.95331,.95305,.95283,.95264]},{distance:[2.85606,2.86149,2.86432,2.8645,2.862,2.85686,2.84912,2.83886,2.82618,2.81117,2.79393,2.77456,2.75314,2.72975,2.70447,2.67734,2.64844,2.61784,2.58564,2.55196,2.5169,2.48057,2.44305,2.40438,2.36462,2.32383,2.28208,2.23943,2.19591,2.15153,2.10628,2.06016,2.01321,1.96548,1.91702,1.86793,1.8183,1.76829,1.71803,1.66767,1.61737,1.56726,1.51746,1.46803,1.41902,1.37044,1.32228,1.27452,1.22716,1.18023,1.13376,1.08781,1.04244,.99769,.95357,.91003,.86701,.82447,.78238,.74069,.69938,.65836,.61758,.57699,.53656,.49627,.45611,.41611,.37632,.33683,.29776,.25924,.22141,.18441,.14839,.11346,.07972,.04727,.01619,-.01348,-.0417,-.0684,-.09351,-.11698,-.13875,-.1588,-.17713,-.19381,-.20889,-.22242,-.23444,-.24501,-.25421,-.26216,-.26897,-.27473,-.27951,-.28336,-.28631,-.28836,-.28948,-.28963,-.28873,-.28673,-.28355,-.27916,-.27354,-.26673,-.25878,-.2498,-.23992,-.22929,-.21802,-.20623,-.19398,-.18134,-.16836,-.1551,-.14163,-.12809,-.11461,-.1013,-.08826,-.07557,-.06335,-.0517,-.04077,-.03065,-.02143,-.01321,-.00606,0,.00496,.00888,.01181,.01385,.01511,.0157,.01574,.01533,.01458,.01358,.0124,.01112,.00979,.00851,.00738,.0065,.006,.00596,.00646,.00754,.00924,.01161,.01471,.01858,.02323,.02865,.03481,.04169,.0493,.05765,.06677,.07671,.08754,.09934,.11222,.12628,.14159,.15823,.17624,.19561,.21632,.23828,.26142,.28563,.31083,.33696,.36397,.39185,.42057,.4501,.48036,.51125,.54264,.5744,.60646,.63871,.67105,.70337,.73556,.76751,.79918,.83048,.86139,.8919,.92202,.95184,.98144,1.01094,1.04045,1.0701,1.10002,1.13029,1.16103,1.1923,1.22416,1.25664,1.28979,1.32364,1.35824,1.39363,1.42985,1.4669,1.50475,1.54332,1.58252,1.62227,1.6625,1.70312,1.744,1.78501,1.82598,1.8668,1.90734,1.94754,1.98732,2.02666,2.06555,2.10402,2.1421,2.17985,2.2173,2.25448,2.29139,2.328,2.36424,2.4,2.43515,2.46955,2.50309,2.53565,2.56717,2.59761,2.62692,2.65505,2.68191,2.7074,2.73138,2.75375,2.7744,2.79324,2.81017,2.82504,2.83772,2.8481],pressure:[.22758,.23641,.24578,.25568,.26609,.27699,.28835,.30016,.31237,.32495,.33789,.35113,.36466,.37843,.39241,.40658,.4209,.43535,.44989,.4645,.47916,.49385,.50853,.5232,.53784,.55243,.56696,.58141,.59578,.61004,.62419,.63821,.65209,.6658,.67934,.69268,.70582,.71873,.73139,.7438,.75594,.76779,.77935,.79061,.80156,.81221,.82254,.83258,.84231,.85176,.86091,.86978,.87837,.88669,.89473,.9025,.91,.91725,.92425,.931,.93752,.9438,.94985,.95566,.96124,.96658,.97168,.97652,.98109,.98539,.98939,.99309,.99646,.99949,.99783,.99552,.99361,.99209,.99098,.99029,.99003,.99019,.99079,.99181,.99324,.9951,.99735,1,.99698,.99361,.98992,.98592,.98163,.97709,.97231,.96731,.96212,.95676,.95122,.94554,.93973,.93378,.92773,.92157,.91532,.90899,.90258,.89612,.88961,.88308,.87653,.87,.8635,.85705,.85068,.8444,.83823,.83219,.82628,.82052,.81493,.80952,.8043,.79929,.7945,.78994,.78561,.78151,.77765,.77402,.77062,.76742,.76443,.76161,.75896,.75645,.75406,.75175,.74951,.7473,.74511,.74289,.74064,.73833,.73592,.73341,.73078,.728,.72507,.72197,.71869,.71522,.71156,.70769,.70363,.69936,.69489,.69021,.68533,.68023,.67492,.66939,.66363,.65765,.65145,.64501,.63833,.63143,.62428,.61691,.60931,.60148,.59344,.58521,.57679,.5682,.55948,.55063,.54167,.53264,.52354,.51439,.50522,.49603,.48686,.47773,.46865,.45964,.45072,.44192,.43324,.42469,.41629,.40804,.39994,.392,.3842,.37655,.36903,.36164,.35437,.3472,.34012,.33312,.3262,.31933,.31251,.30574,.299,.2923,.28563,.27899,.27239,.26583,.25933,.25288,.24652,.24025,.2341,.22808,.22221,.21653,.21104,.20576,.20072,.19592,.19138,.18712,.18313,.17943,.17602,.17292,.17013,.16766,.16551,.16369,.16222,.1611,.16036,.16001,.16007,.16055,.16148,.16286,.16471,.16705,.16988,.17321,.17706,.18144,.18636,.19182,.19785,.20443,.21158,.2193]},{distance:[-2.31317,-2.3191,-2.32189,-2.32154,-2.31811,-2.31174,-2.30254,-2.29062,-2.27609,-2.25904,-2.23954,-2.21767,-2.19355,-2.16732,-2.13907,-2.10885,-2.07672,-2.04268,-2.00677,-1.96911,-1.92985,-1.88914,-1.84713,-1.80397,-1.75979,-1.71467,-1.66864,-1.62171,-1.57395,-1.52546,-1.47625,-1.42628,-1.3755,-1.32384,-1.27131,-1.218,-1.16408,-1.10972,-1.05508,-1.00031,-.94551,-.89077,-.83615,-.7817,-.72757,-.6739,-.62076,-.56821,-.51625,-.46484,-.41397,-.36366,-.314,-.26506,-.21689,-.16957,-.12316,-.07766,-.03301,.01085,.05399,.09643,.13827,.17967,.22079,.26176,.30265,.34342,.38397,.42414,.46381,.50285,.54115,.57863,.61524,.65093,.6856,.71914,.75153,.78275,.81283,.84182,.86972,.89651,.92208,.94634,.96919,.99052,1.01025,1.02835,1.04484,1.05976,1.07309,1.08479,1.09492,1.1036,1.11096,1.11714,1.12224,1.12627,1.12916,1.13083,1.13125,1.13036,1.12816,1.12466,1.11992,1.11397,1.10677,1.09827,1.08849,1.07746,1.06527,1.05203,1.03786,1.02283,1.00695,.99025,.97279,.9546,.93573,.9163,.8965,.8765,.85647,.83652,.81687,.79775,.77939,.76199,.74568,.73049,.71635,.70316,.69082,.67925,.66834,.65804,.64831,.63911,.63032,.62184,.61363,.60564,.59788,.59036,.58308,.57597,.5689,.56177,.55447,.5469,.53896,.53062,.5219,.51283,.5034,.49355,.48335,.47287,.46223,.45154,.44085,.43012,.41923,.40805,.39648,.38441,.37176,.35849,.34458,.32999,.31461,.29833,.28109,.26288,.2437,.22361,.20265,.18082,.15807,.13434,.1096,.0838,.0569,.02894,0,-.0298,-.0604,-.09173,-.12364,-.15594,-.18843,-.22092,-.25331,-.28559,-.31781,-.35006,-.38244,-.41502,-.44785,-.48098,-.5144,-.54811,-.58218,-.61666,-.65153,-.68677,-.72232,-.75807,-.79397,-.83002,-.86628,-.90281,-.93968,-.97693,-1.01465,-1.05282,-1.09139,-1.13031,-1.16956,-1.20917,-1.24905,-1.28907,-1.32908,-1.36891,-1.40844,-1.44765,-1.48658,-1.52527,-1.56376,-1.60206,-1.64016,-1.67801,-1.71552,-1.75264,-1.78936,-1.8257,-1.86161,-1.89702,-1.93182,-1.96584,-1.99894,-2.03102,-2.06203,-2.0919,-2.12056,-2.14794,-2.17397,-2.19852,-2.22138,-2.24235,-2.26129,-2.27805,-2.29243,-2.30422],pressure:[.9681,.97424,.98046,.98674,.99309,.9995,.99404,.98754,.981,.97444,.96785,.96124,.95462,.94801,.94139,.93479,.92822,.92167,.91515,.90868,.90225,.89589,.88959,.88336,.87722,.87115,.86519,.85932,.85356,.84792,.84239,.83699,.83173,.8266,.82162,.81679,.81211,.80759,.80324,.79906,.79505,.79121,.78756,.78409,.78081,.77771,.77481,.77211,.76959,.76728,.76516,.76324,.76153,.76001,.75869,.75757,.75665,.75593,.7554,.75507,.75493,.75498,.75523,.75565,.75627,.75706,.75803,.75917,.76049,.76197,.76361,.76541,.76737,.76947,.77172,.77409,.7766,.77923,.78198,.78484,.7878,.79086,.79401,.79724,.80055,.80394,.8074,.81092,.8145,.81813,.82182,.82556,.82934,.83317,.83703,.84093,.84487,.84884,.85284,.85687,.86094,.86503,.86915,.87329,.87746,.88166,.88587,.89011,.89436,.89863,.90291,.9072,.91149,.91579,.92009,.92438,.92867,.93295,.9372,.94144,.94566,.94985,.954,.95812,.96219,.96623,.97021,.97415,.97802,.98184,.9856,.9893,.99293,.9965,1,.99657,.9932,.98991,.98668,.98352,.98042,.97738,.9744,.97148,.9686,.96577,.96298,.96023,.95751,.95482,.95214,.94949,.94684,.9442,.94156,.93892,.93627,.93361,.93094,.92825,.92555,.92284,.9201,.91735,.91458,.91179,.90899,.90616,.90332,.90047,.8976,.89472,.89183,.88893,.88603,.88314,.88024,.87735,.87448,.87162,.86878,.86597,.86319,.86044,.85774,.85508,.85247,.84993,.84744,.84503,.84269,.84042,.83825,.83616,.83417,.83227,.83048,.8288,.82724,.82578,.82445,.82324,.82215,.82119,.82037,.81967,.81911,.81868,.81839,.81824,.81823,.81835,.81862,.81903,.81957,.82026,.82109,.82206,.82317,.82443,.82583,.82737,.82906,.83089,.83287,.83499,.83726,.83968,.84223,.84494,.84778,.85077,.8539,.85717,.86058,.86412,.86781,.87163,.87559,.87968,.88391,.88826,.89275,.89737,.90211,.90698,.91198,.91709,.92233,.92768,.93315,.93873,.94441,.95019,.95607,.96205]},{distance:[4.72925,4.81721,4.9037,4.98859,5.07177,5.15311,5.23249,5.3098,5.38491,5.45772,5.52811,5.59598,5.66122,5.72375,5.78346,5.84028,5.8941,5.94486,5.99248,6.03689,6.07803,6.11584,6.15028,6.18128,6.20882,6.23285,6.25336,6.27031,6.28369,6.29348,6.29969,6.3023,6.30133,6.29678,6.28867,6.27703,6.26187,6.24324,6.22116,6.19567,6.16683,6.13468,6.09928,6.06068,6.01896,5.97417,5.92639,5.87569,5.82217,5.76589,5.70696,5.64545,5.58147,5.5151,5.44644,5.37559,5.30265,5.2277,5.15085,5.0722,4.99184,4.90987,4.82639,4.74151,4.65533,4.56794,4.47945,4.38996,4.29959,4.20843,4.11658,4.02416,3.93125,3.83796,3.74437,3.65057,3.55666,3.46272,3.36884,3.27509,3.18155,3.08831,2.99545,2.90303,2.81114,2.71984,2.62922,2.53933,2.45026,2.36207,2.27484,2.18862,2.10349,2.01951,1.93675,1.85528,1.77515,1.69644,1.61919,1.54348,1.46935,1.39685,1.32605,1.25698,1.18967,1.12417,1.06049,.99863,.93862,.88044,.82408,.76953,.71676,.66574,.61644,.56882,.52282,.47841,.43553,.39413,.35414,.31551,.27817,.24206,.20712,.17328,.14048,.10866,.07776,.04772,.01848,-.00999,-.03776,-.06487,-.09134,-.11721,-.14251,-.16725,-.19144,-.21509,-.2382,-.26076,-.28275,-.30416,-.32496,-.34511,-.36459,-.38334,-.40134,-.41852,-.43485,-.45026,-.46471,-.47815,-.49052,-.50179,-.51189,-.52081,-.52849,-.5349,-.54003,-.54383,-.54627,-.54734,-.54702,-.54528,-.54211,-.53752,-.53149,-.52403,-.51515,-.50487,-.4932,-.48015,-.46575,-.45001,-.43297,-.41463,-.39503,-.37419,-.35213,-.32887,-.30443,-.27885,-.25214,-.22432,-.19541,-.16544,-.13442,-.10235,-.06926,-.03514,0,.03616,.07336,.11159,.15088,.19125,.23272,.27531,.31906,.36401,.41019,.45764,.5064,.55651,.60802,.66096,.71538,.77129,.82874,.88776,.94836,1.01056,1.07438,1.13982,1.20687,1.27554,1.34581,1.41766,1.49107,1.56599,1.64239,1.72025,1.79951,1.88013,1.96209,2.04532,2.12979,2.21546,2.30226,2.39017,2.47911,2.56905,2.65991,2.75164,2.84416,2.93742,3.03133,3.12582,3.2208,3.31619,3.41191,3.50785,3.60393,3.70006,3.79612,3.89202,3.98765,4.08291,4.17767,4.27182,4.36525,4.45783,4.54944,4.63995],pressure:[.30942,.30838,.30765,.30724,.30715,.30738,.30795,.30884,.31007,.31164,.31354,.31578,.31837,.32129,.32455,.32815,.33209,.33636,.34097,.34591,.35117,.35675,.36265,.36887,.37539,.38221,.38933,.39674,.40442,.41238,.4206,.42907,.43779,.44675,.45593,.46533,.47493,.48473,.49471,.50486,.51517,.52563,.53623,.54694,.55777,.5687,.57971,.59079,.60194,.61313,.62435,.6356,.64686,.65811,.66935,.68056,.69174,.70286,.71391,.72489,.73579,.74659,.75728,.76785,.7783,.7886,.79876,.80877,.81861,.82827,.83776,.84706,.85617,.86507,.87378,.88227,.89056,.89863,.90649,.91412,.92153,.92872,.93568,.94241,.94892,.95519,.96122,.96702,.97258,.97791,.98299,.98783,.99242,.99677,.99911,.99525,.99164,.98827,.98515,.98228,.97966,.97728,.97514,.97324,.97159,.97017,.96898,.96801,.96727,.96674,.96641,.96629,.96635,.96661,.96703,.96762,.96838,.96928,.97032,.97149,.97279,.9742,.97572,.97734,.97905,.98085,.98273,.98468,.98669,.98877,.99091,.99311,.99535,.99765,1,.9976,.99516,.99267,.99014,.98755,.98491,.98222,.97947,.97666,.97378,.97083,.96781,.96471,.96153,.95826,.9549,.95144,.94787,.9442,.94042,.93651,.93249,.92834,.92407,.91966,.91512,.91045,.90564,.90069,.8956,.89037,.885,.87949,.87384,.86806,.86214,.85608,.84988,.84356,.83711,.83053,.82383,.81702,.81009,.80306,.79594,.78872,.78141,.77403,.76657,.75905,.75148,.74385,.73619,.72849,.72076,.71302,.70526,.69749,.68972,.68195,.67419,.66644,.65871,.65099,.64329,.63561,.62795,.62032,.61271,.60512,.59755,.59001,.58248,.57497,.56749,.56002,.55256,.54512,.5377,.5303,.52291,.51554,.50819,.50087,.49358,.48632,.4791,.47192,.4648,.45773,.45072,.44378,.43692,.43015,.42346,.41687,.41039,.40403,.39779,.39168,.38571,.37989,.37423,.36873,.36342,.35828,.35335,.34862,.34409,.3398,.33573,.3319,.32831,.32498,.32192,.31912,.3166,.31436,.31242,.31077]}];function GI(e){let t=null;for(const i of e){const e=i.type;if(kI(i))if((0,u.t)(t))t=e;else if(t!==e)return"uber"}return(0,u.r)(t)?t:"solid"}function BI(e){let t=0;for(const{material:i}of e)if(kI(i)){if(i.color[3]*i.opacity<1)return 1;t=2}return t}function qI(e){let t=0;for(const{material:i}of e)if(kI(i)){switch(i.objectTransparency){case 1:case 0:return 1;case 2:if(i.opacity<1)return 1}t=2}return t}function kI(e){return e.size*e.color[3]*e.opacity>0}function NI(e,t,i,r){return i*(r/e)*2*Math.tan(.5*t)}function jI(e,t,i){return e.length-function(e,t){const i=(0,r.O)(e,t,!0);return-1===i?t<e[0]?0:e.length:i}(e,t*i.minimumEdgeLength)}function HI(e,t,i,r){for(let s=0;s<e.length;s++){const n=e[s].index,a=t[s],o=t[s+1];if(r)for(let e=a;e<o;e++){const t=r[e];i.set(t,n)}else for(let e=a;e<o;e++)i.set(e,n)}}const WI=u.n.getLogger("esri.views.3d.webgl-engine.lib.edgeRendering.EdgeView");let QI=class extends r.p{constructor(e){super(e),this.updatingHandles=new W.l,this.perObjectData=new Map,this.renderers=new Map,this.numberOfRenderedEdges=0,this.gpuMemoryUsage=0,this.workerAbort=(0,h.h)(),this.tmpModelPosition=(0,v.n)(),this.tmpCameraPosition=(0,v.n)(),this.localOrigins=new hI(new Zf(e.renderSR))}initialize(){this.worker=new DI(this.schedule),this.componentColorManager=new KD(this.rctx,2);const e=U.i.createBuffer(4);for(let t=0;t<4;t++)e.sideness.set(t,0,0===t||3===t?0:1),e.sideness.set(t,1,0===t||1===t?0:1);this.verticesBufferObject=V.h.createVertex(this.rctx,35044,e.buffer)}destroy(){this.destroyed||(this.perObjectData.forEach((e=>this._discardObjectEntry(e))),this.perObjectData.clear(),this.strokesTexture=(0,u.z)(this.strokesTexture),this.componentColorManager=(0,u.k)(this.componentColorManager),this.workerAbort.abort(),this.worker.destroy(),this.verticesBufferObject=(0,u.z)(this.verticesBufferObject),this.renderers.clear(),this.updatingHandles.destroy())}get updating(){return this.updatingHandles.updating}get usedMemory(){return this.gpuMemoryUsage}get numberOfRenderedPrimitives(){return this.numberOfRenderedEdges}shouldRender(){return this.renderers.size>0}async addComponentObject(e,t,i,r,s,n,a,o){if(this.hasObject(e))return;let l;const c=new ZI(new Promise((e=>l=e)),i);this.perObjectData.set(e,c),await this.updatingHandles.addPromise(this.addComponentGeometry(t,c,r,s,n,a,o)),this.setNeedsRender(),l()}async addOrUpdateObject3D(e,t,i,s){if(this.destroyed)return void WI.warn("Attempt to add an object to a destroyed instance");const n=this.perObjectData.get(e);let a;const o=new ZI(new Promise((e=>a=e)));this.perObjectData.set(e,o);const l=new Array;if(i.mergeGeometries&&e.geometries.length>1&&function(e){let t=null,i=null;for(let n=0;n<e.geometries.length;n++){var s;const a=e.geometryRecords[n];if(a.material.supportsEdges){if(t){if(!(0,r.K)(t,a.transformation))return!1}else t=a.transformation;if(!i&&(0,u.r)(a.origin))i=a;else if((0,u.r)(null==(s=i)?void 0:s.origin)&&(0,u.r)(a.origin)&&i.origin.id!==a.origin.id)return!1}}return!0}(e))l.push(this.addObjectMergedGeometries(e,o,t,i,s));else for(let r=0;r<e.geometries.length;r++){const n=e.geometries[r],a=e.geometryRecords[r];a.material.supportsEdges&&l.push(this.addGeometry(e,o,n,a,t[0],i,s))}await this.updatingHandles.addPromise(Promise.all(l)),this._discardObjectEntry(n),this.setNeedsRender(),a()}_discardObjectEntry(e){e&&(e.renderables.length&&(e.renderables.forEach((e=>this.removeRenderable(e))),this.setNeedsRender()),e.loaded=null)}hasObject(e){return this.perObjectData.has(e)}async updateAllComponentOpacities(e,t){const i=t instanceof Array?e=>t[e]:()=>t;(await this.updatingHandles.addPromise(this.getObjectEntry(e))).renderables.forEach((e=>{const t=e.components.meta.length;for(let r=0;r<t;r++){const t=i(r),s=e.components.meta[r],n=s.index;s.material.opacity=t,e.components.buffer.textureBuffer.setDataElement(n,1,3,255*t)}this.updateTransparency(e)})),this.setNeedsRender()}async updateAllComponentMaterials(e,t,i,r){const s=e instanceof Qs,n=!!i.slicePlaneEnabled,a=GI(t),o=PI.getKey(a,n,s);(await this.updatingHandles.addPromise(this.getObjectEntry(e))).renderables.forEach((e=>{if(o!==e.rendererKey){const t=this.renderers.get(e.rendererKey),i=this.acquireRenderer(a,n,s);t.removeRenderable(e),t.refCount.decrement(),e.rendererKey=o,i.addRenderable(e)}for(let i=0;i<t.length;i++)e.components.meta[i].material=t[i];r&&this.updateComponentBuffer(e.components),this.updateTransparency(e)})),this.setNeedsRender()}async updateObjectVisibility(e,t){(await this.updatingHandles.addPromise(this.getObjectEntry(e))).renderables.forEach((e=>e.visible=t)),this.setNeedsRender()}removeObject(e){const t=this.perObjectData.get(e);t&&(this.perObjectData.delete(e),this._discardObjectEntry(t))}async getObjectEntry(e){const t=this.perObjectData.get(e);if(!t)throw"no object";return await t.loaded,t}removeAll(){this.perObjectData.forEach(((e,t)=>this.removeObject(t)))}render(e,t){if((0,u.t)(this.componentColorManager))return;this.localOrigins.updateViewMatrices(e.camera.viewMatrix);const i=e.camera.viewInverseTransposeMatrix,r=(0,v.n)(),s=new QD,n=new S.bv.ViewProjectionTransform,a=(0,X.e)();(0,v.a)(r,i[3],i[7],i[11]),s.set(r),(0,v.h)(n.worldFromView_TH,s.high),(0,v.h)(n.worldFromView_TL,s.low),(0,Y.a)(n.viewFromCameraRelative_RS,e.camera.viewMatrix),(0,C.n)(n.projFromView,e.camera.projectionMatrix);const o=(0,X.e)();(0,Y.o)(o,n.viewFromCameraRelative_RS),(0,Y.u)(a,o);let l=0,c=0;if(this.renderers.forEach((e=>{0===e.refCount.value?(this.renderers.delete(e.key),e.dispose()):e.forEachRenderable((e=>{l+=e.statistics.averageEdgeLength,c++}),t)})),this.componentColorManager.garbageCollect(),this.componentColorManager.updateTextures(),0===c)return;const h={distanceFalloffFactor:40*l/c,minimumEdgeLength:NI(e.camera.fullViewport[3],e.camera.fovY,1,3.5*e.camera.pixelRatio),transparency:t,viewProjectionTransform:n,transformNormal_ViewFromGlobal:a};this.updateObjectCameraDistances(e),this.numberOfRenderedEdges=0,this.renderers.forEach((t=>{this.renderRegularEdges(t,e,h),this.renderSilhouetteEdges(t,e,h)}))}updateTransparency(e){const t=BI(e.components.meta),i=qI(e.components.meta);t===e.edgeTransparency&&i===e.objectTransparency||(e.edgeTransparency=t,e.objectTransparency=i,this.renderers.get(e.rendererKey).setRenderablesDirty())}computeModelTransformWithLocalOrigin(e,t,i){if(e.getCombinedStaticTransformation(t,i),(0,u.r)(t.origin))this.localOrigins.register(t.origin);else{const e=(0,v.a)(this.tmpModelPosition,i[12],i[13],i[14]);t.origin=this.localOrigins.acquire(e)}return function(e,t){const i=t,r=-e[0],s=-e[1],n=-e[2],a=i[3],o=i[7],l=i[11],c=i[15];i[0]+=a*r,i[1]+=a*s,i[2]+=a*n,i[4]+=o*r,i[5]+=o*s,i[6]+=o*n,i[8]+=l*r,i[9]+=l*s,i[10]+=l*n,i[12]+=c*r,i[13]+=c*s,i[14]+=c*n}(t.origin.vec3,i),t.origin}updateComponentBuffer(e){const{meta:t,buffer:i}=e;for(let e=0;e<t.length;e++){const r=t[e].material,s=t[e].index,n=(0,v.o)(Math.round(8*r.size),0,255),a=(0,v.o)(r.extensionLength,-128,127)+128,o="solid"===r.type?0:1,l=255*r.opacity,c=r.color,h=255*c[0],d=255*c[1],u=255*c[2],p=255*c[3];i.textureBuffer.setData(s,0,h,d,u,p),i.textureBuffer.setData(s,1,n,a,o,l)}}createComponentBuffers(e){if((0,u.t)(this.componentColorManager))return null;const t=new Array,i=this.componentColorManager.getBuffer(e.length);for(let r=0;r<e.length;r++){const s=e[r],n=i.acquireIndex();t.push({index:n,material:s})}const r={meta:t,buffer:i};return this.updateComponentBuffer(r),r}extractEdges(e,t,i,r,s,n=s.length){return this.worker.process({data:t,indices:s,indicesLength:n,writerSettings:e,skipDeduplicate:i},this.workerAbort.signal,r)}createEdgeResources(e){const t={};if((0,u.t)(this.verticesBufferObject))return t;if(e.regular.lodInfo.lengths.length>0){const i=new V.f(this.rctx,U.p,{vertices:U.a,instances:U.d.glLayout},{vertices:this.verticesBufferObject,instances:V.h.createVertex(this.rctx,35044,e.regular.instancesData.buffer)});t.regular={vao:i,lod:e.regular.lodInfo}}if(e.silhouette.lodInfo.lengths.length>0){const i=new V.f(this.rctx,U.p,{vertices:U.a,instances:U.w.glLayout},{vertices:this.verticesBufferObject,instances:V.h.createVertex(this.rctx,35044,e.silhouette.instancesData.buffer)});t.silhouette={vao:i,lod:e.silhouette.lodInfo}}return t}async addGeometry(e,t,i,r,s,n,a){const o=i.vertexAttributes.get("position"),l=i.indices.get("position"),c=(0,T.e)(),h={position:o,indices:l,modelTransform:c,origin:this.computeModelTransformWithLocalOrigin(e,r,c)};return this.addPositionData(t,h,i.edgeIndicesLength,s,n,a)}async addPositionData(e,t,i,r,s,n=!1){if(null==e.loaded)return;const a=this.createComponentBuffers([r]);if((0,u.t)(a)||i<=0)return;const o=this.acquireRenderer(r.type,!!s.slicePlaneEnabled),{modelTransform:l,origin:c}=t,h=t.indices,d=t.position,p=d.data.length/d.size,m=U.e.createBuffer(p);for(let e=0;e<p;e++)m.position.set(e,0,d.data[e*d.size+0]),m.position.set(e,1,d.data[e*d.size+1]),m.position.set(e,2,d.data[e*d.size+2]);HI(a.meta,[0,m.componentIndex.count],m.componentIndex);const f=await this.updatingHandles.addPromise(this.extractEdges(o.writerSettings,m,!1,n,h,i));if(null==e.loaded)return;const{regular:g,silhouette:v}=this.createEdgeResources(f),y=(g?g.vao.size:0)+(v?v.vao.size:0),_={regular:g,silhouette:v,transform:{modelMatrix:l,origin:c},statistics:{gpuMemoryUsage:y,averageEdgeLength:f.averageEdgeLength},components:a,visible:!0,edgeTransparency:BI(a.meta),objectTransparency:qI(a.meta),distanceToCamera:0,rendererKey:o.key};e.renderables.push(_),o.addRenderable(_),this.gpuMemoryUsage+=y}async addComponentGeometry(e,t,i,r,s,n,a){if(null==t.loaded)return;const o=this.createComponentBuffers(n);if((0,u.t)(o))return;const l=GI(n),c=this.acquireRenderer(l,a.slicePlaneEnabled||!1,!1),h=U.e.createBuffer(i.count);(0,T.c)(h.position,i),HI(o.meta,s,h.componentIndex,r);const d=c.writerSettings,p=await this.updatingHandles.addPromise(this.extractEdges(d,h,!0,!1,r));if(null==t.loaded)return;const{regular:m,silhouette:f}=this.createEdgeResources(p),g=(m?m.vao.size:0)+(f?f.vao.size:0),v={regular:m,silhouette:f,transform:e,statistics:{gpuMemoryUsage:g,averageEdgeLength:p.averageEdgeLength},components:o,visible:!0,edgeTransparency:BI(o.meta),objectTransparency:qI(o.meta),distanceToCamera:0,rendererKey:c.key};t.renderables.push(v),c.addRenderable(v),this.gpuMemoryUsage+=g}async addObjectMergedGeometries(e,t,i,r,s){const n=new Map;let a=0,o=null,l=null;for(let t=0;t<e.geometries.length;t++){const i=e.geometries[t],r=e.geometryRecords[t];if(!r.material.supportsEdges)continue;!l&&r.origin&&(l=r);const s=i.indices.get("position");a+=i.edgeIndicesLength,null!=o&&o!==Uint16Array||(o=(0,u.I)(s)?Uint16Array:Uint32Array)}const c=a?new o(a):null,h=[];let d=0;for(let t=0;t<e.geometries.length;t++){const i=e.geometries[t];if(!e.geometryRecords[t].material.supportsEdges)continue;const r=i.vertexAttributes.get("position"),s=i.indices.get("position");let a=n.get(r.data);if(null==a){a=h.length/3;for(let e=0;e<r.data.length;e+=r.size)h.push(r.data[e+0]),h.push(r.data[e+1]),h.push(r.data[e+2]);n.set(r.data,a)}if(s)for(let e=0;e<i.edgeIndicesLength;e++)c[d++]=a+s[e]}const p=l||e.geometryRecords[0],m=(0,T.e)(),f=this.computeModelTransformWithLocalOrigin(e,p,m);for(let t=0;t<e.geometryRecords.length;t++)e.geometryRecords[t].origin=f;const g={position:{data:h,size:3},indices:c,modelTransform:m,origin:f};await this.updatingHandles.addPromise(this.addPositionData(t,g,c.length,i[0],r,s))}acquireRenderer(e,t,i=!0){const r=PI.getKey(e,t,i);let s=this.renderers.get(r);return(0,u.t)(this.strokesTexture)&&(this.strokesTexture=function(e){const t=VI,i=t/2,r=new Uint8Array(4*t*t),s=4*t*i,n=FI,a=2*n,o=4*t,l=(0,v.V)(t)+1,c=UI.length;let h=(l-1)*c*o;for(const{distance:e,pressure:t}of UI){let i=e,n=t,d=h;for(let e=0;e<l;e++){0!==e&&(i=EI(i,0),n=EI(n,1));for(let e=0;e<VI;e++){const t=.5+(i?i[e%i.length]/a:0),o=n?n[e%n.length]:1;(0,S.aS)(t,r,d),(0,S.aS)(o,r,d+s),d+=4}d-=o*(c+1)}h+=o}const d=new q.r(e,{pixelFormat:6408,dataType:5121,hasMipmap:!1,samplingMode:9729,width:t,height:t,wrapMode:10497},r);return new LI(t,a,n,c,d)}(this.rctx)),s||(s=new PI(this.rctx,this.techniqueRepository,{type:e,slicePlaneEnabled:t,strokesTexture:this.strokesTexture,legacy:i}),this.renderers.set(r,s)),s.refCount.increment(),s}removeRenderable(e){!function(e){e.regular&&(e.regular.vao.vertexBuffers.instances.dispose(),e.regular.vao.dispose(!1),e.regular.vao=null),e.silhouette&&(e.silhouette.vao.vertexBuffers.instances.dispose(),e.silhouette.vao.dispose(!1),e.silhouette.vao=null)}(e);const t=this.renderers.get(e.rendererKey);if(t){t.removeRenderable(e),t.refCount.decrement(),"origin"in e.transform&&this.localOrigins.release(e.transform.origin),this.gpuMemoryUsage-=e.statistics.gpuMemoryUsage;for(const t of e.components.meta)e.components.buffer.releaseIndex(t.index)}}updateObjectCameraDistances(e){const t=e.camera.viewInverseTransposeMatrix;(0,v.a)(this.tmpCameraPosition,t[3],t[7],t[11]),this.perObjectData.forEach(((e,t)=>{const i=(0,u.r)(e.center)?e.center:(0,S.O)(t.boundingVolumeWorldSpace.bounds),r=(0,v.q)(i,this.tmpCameraPosition);e.renderables.forEach((e=>e.distanceToCamera=r))}))}renderRegularEdges(e,t,i){e.bindRegularEdges(t,i);const r=i.transparency;e.forEachRenderable((r=>{if(!r.visible||!r.regular)return;const s=jI(r.regular.lod.lengths,r.distanceToCamera,i);"origin"in r.transform&&(t.localViewMatrixForEdges=this.localOrigins.getViewMatrix(r.transform.origin)),e.renderRegularEdges(r,t,s),this.numberOfRenderedEdges+=s}),r)}renderSilhouetteEdges(e,t,i){e.bindSilhouetteEdges(t,i);const r=i.transparency;e.forEachRenderable((r=>{if(!r.visible||!r.silhouette)return;const s=jI(r.silhouette.lod.lengths,r.distanceToCamera,i);"origin"in r.transform&&(t.localViewMatrixForEdges=this.localOrigins.getViewMatrix(r.transform.origin)),e.renderSilhouetteEdges(r,t,s),this.numberOfRenderedEdges+=s}),r)}};(0,r.e)([(0,d.y)({constructOnly:!0})],QI.prototype,"rctx",void 0),(0,r.e)([(0,d.y)({constructOnly:!0})],QI.prototype,"renderSR",void 0),(0,r.e)([(0,d.y)({constructOnly:!0})],QI.prototype,"techniqueRepository",void 0),(0,r.e)([(0,d.y)({constructOnly:!0})],QI.prototype,"setNeedsRender",void 0),(0,r.e)([(0,d.y)({constructOnly:!0})],QI.prototype,"schedule",void 0),(0,r.e)([(0,d.y)({readOnly:!0})],QI.prototype,"updatingHandles",void 0),(0,r.e)([(0,d.y)({readOnly:!0})],QI.prototype,"updating",null),QI=(0,r.e)([(0,d.n)("esri.views.3d.webgl-engine.lib.edgeRendering.EdgeView")],QI);class ZI{constructor(e,t=null){this.center=t,this.renderables=new Array,this.loaded=e,this.loaded.then((()=>{null!=this.loaded&&(this.loaded=!0)}))}}class YI{constructor(e,t,i,r,s,n,a,o,l){this._materialRep=e,this._shaderTechniqueRepository=i,this._rctx=r,this._compositingHelper=s,this._magnifierHelper=n,this.requestRender=a,this._stage=l,this._materialRenderers=new Map,this._hasHighlights=!1,this._hasOccludees=!1,this._hasWater=!1,this._hasOverlayWater=!1,this._content=new Map,this._isRendering=!1,this._fallbackDepthStencilTexture=null,this.performanceInfo=new Og,this._antialiasing=1,this._oitEnabled=!1,this._multipassTerrain=!0,this._opaqueTerrain=!0,this._lighting=new rv,this._handles=new R.u,this.renderHiddenTransparentEdges=()=>{},this._smaaPass=new iI(this._rctx,i),this._oitEnabled=this._hasOITSupport,this.requestRender(),this._offscreenRendering=new NE(this._rctx,this._compositingHelper),this._sliceHelper=new $z,this._shadowMap=new az(this._rctx,l.viewingMode,2),this._ssaoHelper=new oI(i,this._rctx,(()=>this.requestRender())),this._highlightHelper=new GE(i,this._rctx),this._shadowHighlightHelper=new Yz(this._rctx,l.viewingMode),this._shadowAccumulator=new Gz(this._rctx,i,l,((e,t)=>{this.renderPassManager.shadowCastingEnabled=!0,this._renderPlugins.prepareRender(e,t),this.renderPassManager.shadowCastingEnabled=this._shadowMap.enabled}),((e,t,i,r)=>{e.start(i,t,r),this.renderShadowCascades(4,e),i.setGLViewport(this._rctx),this.ensureCameraBindParameters(i)}),(()=>this.requestRender())),this._bindParameters={slot:null,camera:null,inverseViewport:(0,N.n)(),shadowMap:this._shadowMap,shadowMappingEnabled:this._shadowMap.enabled,ssaoHelper:this._ssaoHelper,ssaoEnabled:this._ssaoHelper.enabled,origin:null,screenToWorldRatio:null,screenToWorldRatioGlobalWM:null,slicePlane:this._sliceHelper.plane,highlightDepthTexture:null,hasOccludees:!1,linearDepthTexture:null,terrainLinearDepthTexture:null,geometryLinearDepthTexture:null,multipassTerrainEnabled:!1,multipassGeometryEnabled:!1,cullAboveGround:!1,lastFrameColorTexture:null,reprojectionMat:null,ssrEnabled:!1,lighting:this._lighting,highlightColorTexture:null},this._renderContext=new Kf(this._rctx,this._offscreenRendering,this._lighting,this._shadowMap,this._ssaoHelper,this._sliceHelper),this._renderContext.multipassTerrainParams={camera:null,multipassTerrainEnabled:!1,cullAboveGround:!1,terrainLinearDepthTexture:null},this._renderContext.multipassGeometryParams={multipassGeometryEnabled:!1,geometryLinearDepthTexture:null},this._renderContext.ssrParams={camera:null,linearDepthTexture:null,lastFrameColorTexture:null,reprojectionMat:null,ssrEnabled:!1},this._renderPlugins=new WE({renderContext:this._renderContext,shaderTechniqueRep:i,textureRep:t,materialRep:this._materialRep,requestRender:this.requestRender,schedule:o}),this.renderPassManager=new DE(this._rctx,this._shaderTechniqueRepository),this._renderPlugins.add(this.renderPassManager.slots(),this.renderPassManager),this._handles.add([(0,p.d)(Ih,"EDGES_SHOW_HIDDEN_TRANSPARENT_EDGES",(e=>{this.renderHiddenTransparentEdges=e?()=>this.renderEdges(1):()=>{},this.requestRender()})),(0,p.d)(this._stage,"camera",(()=>this.requestRender()),!0)])}get hasWater(){return this._hasWater||this._hasOverlayWater}get hasWaterReflection(){return this.hasWater&&this._waterReflectionEnabled}dispose(){this._handles.destroy(),this._smaaPass.disable(),this._materialRenderers.forEach((e=>e.dispose())),this._materialRenderers.clear(),this._edgeView=(0,u.k)(this._edgeView),this._offscreenRendering.dispose(),this._fallbackDepthStencilTexture=(0,u.z)(this._fallbackDepthStencilTexture),this._shadowMap.enabled=!1,this._shadowMap.dispose(),this._ssaoHelper.enabled=!1,this._ssaoHelper.dispose(),this._highlightHelper.dispose(),this._shadowHighlightHelper.dispose(),this._shadowAccumulator.dispose(),S.bN.prune(),this._content.clear()}get updating(){return 1===this._antialiasing&&this._smaaPass.isLoadingResources||(0,u.r)(this._edgeView)&&this._edgeView.updating||this._shadowAccumulator.running||!this.isCameraFinal}ensureEdgeView(){return(0,u.t)(this._edgeView)&&(this._edgeView=new QI({rctx:this._rctx,renderSR:this._stage.renderSR,techniqueRepository:this._shaderTechniqueRepository,setNeedsRender:()=>this.requestRender(),schedule:e=>this._stage.resourceController.schedule(e)}),this._handles.add(this._edgeView.watch("updating",(()=>this.requestRender()),!0)),this.requestRender()),this._edgeView}get edgeView(){return this._edgeView}get isCameraFinal(){return null===this._bindParameters.reprojectionMat||(0,C.C)(this._bindParameters.reprojectionMat,iL)}get hasShadowsEnabled(){var e;return!(null==(e=this._shadowMap)||!e.enabled)}setRenderParameters(e){const{renderPassManager:t,_shadowMap:i,_ssaoHelper:r}=this;void 0!==e.screenSpaceReflectionsEnabled&&t.screenSpaceReflectionsEnabled!==e.screenSpaceReflectionsEnabled&&(t.screenSpaceReflectionsEnabled=e.screenSpaceReflectionsEnabled,this.requestRender()),void 0===e.shadowMap||i.enabled===e.shadowMap&&t.shadowCastingEnabled===e.shadowMap||(i.enabled=e.shadowMap,t.shadowCastingEnabled=e.shadowMap,this.requestRender()),void 0!==e.shadowMapMaxCascades&&i.maxCascades!==e.shadowMapMaxCascades&&(i.maxCascades=e.shadowMapMaxCascades,this.requestRender()),void 0!==e.ssao&&r.enabled!==e.ssao&&(r.enabled=e.ssao,this.requestRender()),void 0!==e.ssaoAttenuation&&r.attenuation!==e.ssaoAttenuation&&(r.attenuation=e.ssaoAttenuation,this.requestRender()),void 0!==e.ssaoRadius&&r.radius!==e.ssaoRadius&&(r.radius=e.ssaoRadius,this.requestRender()),void 0!==e.ssaoSamples&&r.samples!==e.ssaoSamples&&(r.samples=e.ssaoSamples,this.requestRender()),e.background&&this._offscreenRendering.background!==e.background&&(this._offscreenRendering.background=e.background,this.requestRender());const s=e.antialiasingEnabled?1:0;void 0!==e.antialiasingEnabled&&this._antialiasing!==s&&(this._antialiasing=s,this.requestRender()),void 0!==e.highQualityTransparency&&this._multipassTerrain!==e.highQualityTransparency&&(this._multipassTerrain=e.highQualityTransparency,this._oitEnabled=e.highQualityTransparency&&this._hasOITSupport,this.requestRender()),void 0!==e.defaultHighlightOptions&&(this._highlightHelper.setDefaultOptions(e.defaultHighlightOptions),this._shadowHighlightHelper.setDefaultOptions(e.defaultHighlightOptions),this.requestRender()),void 0!==e.slicePlane&&this._sliceHelper.plane!==e.slicePlane&&(this._sliceHelper.plane=(0,u.f)(e.slicePlane),this.requestRender());const n=this._rctx.parameters.maxTextureImageUnits>=10&&e.waterReflectionEnabled;void 0!==e.waterReflectionEnabled&&this._waterReflectionEnabled!==n&&(this._waterReflectionEnabled=n,this.requestRender()),void 0!==e.opaqueTerrain&&this._opaqueTerrain!==e.opaqueTerrain&&(this._opaqueTerrain=e.opaqueTerrain,this.requestRender()),void 0!==e.hasOverlayWater&&this._hasOverlayWater!==e.hasOverlayWater&&(this._hasOverlayWater=e.hasOverlayWater,this.requestRender()),void 0!==e.shadowAccumulationOptions&&this._shadowAccumulator.setOptions(e.shadowAccumulationOptions)}get hasSlicePlane(){return!!this._sliceHelper.plane}get renderPlugins(){return this._renderPlugins}get _hasOITSupport(){return this._rctx.capabilities.textureFloat&&this._rctx.capabilities.textureFloat.textureFloat&&this._rctx.capabilities.colorBufferFloat&&this._rctx.capabilities.colorBufferFloat.textureFloat}modify(e){this._isRendering&&console.warn("Renderer.modify called while rendering");const{adds:t,removes:i,updates:r}=e;if(0===t.length&&0===i.length&&0===r.length)return;i.forAll((({id:e})=>this._content.delete(e))),t.forAll((e=>this._content.set(e.id,e)));const n=rg(e);let a=!1;n.forEach(((e,t)=>{let i=this._materialRenderers.get(t);if(!i){if(!(e.adds.length>0))return;i=new Dg(this._rctx,this._materialRep,t),this._materialRenderers.set(t,i)}i.modify(e),i.isEmpty&&(a=!0)})),a&&this._materialRenderers.forEach(((e,t)=>{e.isEmpty&&(this._materialRenderers.delete(t),e.dispose())})),this._hasHighlights=(0,s.g)(this._materialRenderers,(e=>e.hasHighlights)),this._hasOccludees=(0,s.g)(this._materialRenderers,(e=>e.hasOccludees)),this._hasWater=(0,s.g)(this._materialRenderers,(e=>e.hasWater)),this.requestRender()}updateLogic(e){let t=!1;return this._materialRenderers.forEach((i=>{i.updateLogic&&(t=i.updateLogic(e)||t)})),t}updateLightSources(e,t,i){this._lighting.groundLightingFactor=t,this._lighting.globalFactor=i,this._lighting.set(e)}render(e,t,i,r){this._isRendering=!0,this.performanceInfo.prerender(this._rctx),this._bindParameters.lighting=this._lighting,this._renderContext.hasOccludees=this._hasOccludees,this._renderContext.transparencyPassType=3,this._bindParameters.transparencyPassType=3;const s=this._offscreenRendering;s.needLastFrameColorTexture=this.hasWaterReflection,s.advanceCurrentRenderTarget();const n=this._sliceHelper.plane;r&&(this._sliceHelper.plane=null),this._rctx.bindFramebuffer(e),t.setGLViewport(this._rctx),this.needsShadowAccumulation&&(this.renderPassManager.shadowCastingEnabled=!0),this._renderPlugins.prepareRender(t,i),this.performanceInfo.advance(0);const a=this.computeDepthRange(t);this.renderShadowMap(e,t,this._lighting.lightingMainDirection,a),this.performanceInfo.advance(1),s.initializeFrame(t),this.ensureBindParameters(t),this.renderLinearDepth(),this.performanceInfo.advance(2),this.accumulateShadows(a,t,i),this.renderNormal(),this.performanceInfo.advance(3),this.ensureBindParametersSSR(),this._ssaoHelper.computeSSAO(t,s.linearDepthTexture,s.normalTexture),this.performanceInfo.advance(4),this.performanceInfo.stats.reset(),this._renderContext.pass=0,s.bindFramebuffer(),this.renderSlot(0),this.renderOpaqueGeometry(),this.performanceInfo.advance(5);const o=this._multipassTerrain&&!this._opaqueTerrain;this.renderTerrainLinearDepth(o),this.setMultipassFlags(o),this.setTerrainCulling(o),this.renderEdges(2),this.performanceInfo.advance(6),this.renderHiddenTransparentEdges(),this._oitEnabled?this.renderOrderIndependentTransparency((()=>this.renderTransparentGeometry()),!1):this.renderTransparentGeometry(),this.performanceInfo.advance(7),this.renderGeometryLinearDepth(o);const l={hudVisibility:!1,transparentTerrain:!1};l.hudVisibility=this.renderHUDVisibility(),o||this.renderInternalSlot(20),this.performanceInfo.advance(9),this.renderEdges(1,o),this.performanceInfo.advance(8),l.transparentTerrain=this.renderTransparentTerrain(),l.transparentTerrain&&l.hudVisibility&&(o?this.renderLineCallouts(0):s.compositeTransparentTerrainOntoHUDVisibility(),this.renderHUD(0,s.framebuffer),this.performanceInfo.advance(16)),this.performanceInfo.advance(10),this.setTerrainCulling(!1),l.transparentTerrain&&(s.compositeTransparentTerrainOntoMain(),o&&(this.renderEdges(2),this.performanceInfo.advance(6),this._oitEnabled?this.renderOrderIndependentTransparency((()=>this.renderTransparentGeometry()),!1):this.renderTransparentGeometry(),this.performanceInfo.advance(7),this.renderEdges(1),this.performanceInfo.advance(8))),o&&this.renderLineCallouts(1),this.setMultipassFlags(!1),this._shadowAccumulator.render(),s.renderToTargets((()=>{this.renderInternalSlot(8),this.renderSlot(15),this.renderSlot(16)}),s.currentColorTarget,s.mainDepth),this.performanceInfo.advance(11),this._renderPlugins.needsLaserlineWithContrastControl&&s.renderTmpAndCompositeToMain((()=>{this.renderSlot(17)}),2),this.performanceInfo.advance(12),this.renderOccluded(),this.performanceInfo.advance(13);const c=!r&&this._magnifierHelper.enabled,h=c&&(0,u.t)(e)?this._offscreenRendering.getFramebuffer(this._offscreenRendering.tmpColor,this._offscreenRendering.tmpDepth):e;this._rctx.bindFramebuffer(h),this.renderAntiAliasing(this._antialiasing,this._offscreenRendering.colorTexture)||this._compositingHelper.composite(this._offscreenRendering.colorTexture,0),this.performanceInfo.advance(14),this.renderHUD(1,h),this.performanceInfo.advance(17),this.renderHighlights(h,this._bindParameters),this.performanceInfo.advance(15),c&&this._magnifierHelper.render(this._rctx,this._bindParameters),h!==e&&(this._rctx.bindFramebuffer(e),this._compositingHelper.composite(this._offscreenRendering.tmpColorTexture,0)),this._renderContext.lastFrameCamera.copyFrom(this._renderContext.camera),this._sliceHelper.plane=n,this._isRendering=!1,this.onPostRender&&this.onPostRender(),this.performanceInfo.postrender()}readDepthPixels(e,t,i,r,s,n){const a=this._offscreenRendering.bindTarget(this._offscreenRendering.linearDepth,this._offscreenRendering.tmpDepth);if(!this._needsLinearDepth){this.ensureBindParameters(e),this._renderContext.camera.setGLViewport(this._rctx),this._rctx.setClearColor(0,0,0,0);const t=17664;this._rctx.clearSafe(t),this.renderGeometryAndTransparentTerrainPass(2)}a.readPixels(t,i,r,s,6408,5121,n)}readAccumulatedShadow(e,t){return this._shadowAccumulator.readAccumulatedShadow(e,t)}setMultipassFlags(e){this._renderContext.multipassTerrainParams.multipassTerrainEnabled=this._bindParameters.multipassTerrainEnabled=e,this._renderContext.multipassGeometryParams.multipassGeometryEnabled=this._bindParameters.multipassGeometryEnabled=e}setTerrainCulling(e){this._renderContext.multipassTerrainParams.cullAboveGround=this._bindParameters.cullAboveGround=e}renderSlot(e){return this._renderContext.slot=e,this._renderPlugins.render()}renderEdges(e,t=!1){const i=this._edgeView;(0,u.r)(i)&&i.shouldRender()&&this._offscreenRendering.renderTmpAndCompositeToMain((()=>i.render(this._bindParameters,e)),1,t)}renderShadowMap(e,t,i,r){const s=this._shadowMap;if(s.enabled){if(Ih.ENABLE_PROFILE_DEPTH_RANGE&&SE.begin("depthRange"),Ih.ENABLE_PROFILE_DEPTH_RANGE&&SE.end("depthRange"),s.start(t,i,r),this.needsShadowHighlight){const e=this._shadowHighlightHelper;this.renderShadowCascades(7,this._shadowMap,(t=>s.takeCascadeSnapshotTo(t,e.highlightShadowMapSlot))),s.clear(),this.renderShadowCascades(6,this._shadowMap,(t=>{s.takeCascadeSnapshotTo(t,e.defaultSnapshotSlot),this.renderGeometryAndTransparentTerrainPass(7)}))}else this.renderShadowCascades(4);s.finish(e),t.setGLViewport(this._rctx)}}renderShadowCascades(e,t=this._shadowMap,i=(e=>{})){for(const r of t.getCascades())r.camera.setGLViewport(this._rctx),this.ensureCameraBindParameters(r.camera),this.renderGeometryAndTransparentTerrainPass(e),i(r)}get _needsLinearDepth(){return this._ssaoHelper.enabled||this._renderPlugins.needsLinearDepth||this._hasWater&&this._waterReflectionEnabled||this.needsShadowHighlight||this.needsShadowAccumulation}renderLinearDepth(){this._needsLinearDepth?this._offscreenRendering.renderToTargets((()=>this.renderGeometryAndTransparentTerrainPass(2)),this._offscreenRendering.linearDepth,this._offscreenRendering.tmpDepth,[0,0,0,0],!0,!0):this._offscreenRendering.disposeTarget(this._offscreenRendering.linearDepth),this._renderContext.ssrParams.linearDepthTexture=this._bindParameters.linearDepthTexture=this._offscreenRendering.linearDepthTexture}renderTerrainLinearDepth(e){if(e){const e=this._renderContext.pass;this._renderContext.pass=2,this._offscreenRendering.renderToTargets((()=>this.renderTransparentTerrain()),this._offscreenRendering.terrainLinearDepth,this._offscreenRendering.tmpDepth,[-1e10,-1e10,-1e10,1],!0,!0),this._renderContext.pass=e}else this._offscreenRendering.disposeTarget(this._offscreenRendering.terrainLinearDepth);this._renderContext.multipassTerrainParams.terrainLinearDepthTexture=this._bindParameters.terrainLinearDepthTexture=this._offscreenRendering.terrainLinearDepthTexture}renderGeometryLinearDepth(e){if(e){const e=this._renderContext.pass;this._offscreenRendering.renderToTargets((()=>this.renderGeometryPass(2)),this._offscreenRendering.geometryLinearDepth,this._offscreenRendering.tmpDepth,[1,1,1,1],!0,!0),this._renderContext.pass=e}else this._offscreenRendering.disposeTarget(this._offscreenRendering.geometryLinearDepth);this._renderContext.multipassGeometryParams.geometryLinearDepthTexture=this._bindParameters.geometryLinearDepthTexture=this._offscreenRendering.geometryLinearDepthTexture}get needsNormal(){return this._ssaoHelper.enabled}renderNormal(){this.needsNormal?this._offscreenRendering.renderToTargets((()=>{this.renderGeometryAndTransparentTerrainPass(3)}),this._offscreenRendering.normal,this._offscreenRendering.tmpDepth,[0,0,0,0],!0,!0):this._offscreenRendering.disposeTarget(this._offscreenRendering.normal)}get needsDepthRange(){return this._shadowMap.enabled||this.needsShadowAccumulation}computeDepthRange(e){if(!this.needsDepthRange)return oD;const t=function(e,t,i){if(t.size<1e4)return bE.compute(e,t);const r=rD();return i.forAll((t=>{t.isVisible&&nD(r,function(e,t){if(!t.isVisible)return;const i=rD(),r=t.getSpatialQueryAccelerator();return(0,u.r)(r)?function(e,t,i){const r=t.eye,s=t.viewForward,n=t.frustum,a=e=>e.isVisible,o=i.objectCount;if(o<500)sD(_E,t.near,Math.min(e.near,t.far)),i.forEachInDepthRange(r,s,1,_E,((i,r)=>{pE(e,t,i),_E.far=e.near,r.setRange(_E)}),n,a),sD(_E,Math.max(e.far,t.near),t.far),i.forEachInDepthRange(r,s,-1,_E,((i,r)=>{pE(e,t,i),_E.near=e.far,r.setRange(_E)}),n,a);else{const r=Math.max(Math.min(o,500),Math.ceil(.1*o)),l=i.findClosest(s,1,n,a,r),c=i.findClosest(s,-1,n,a,r);l&&c&&(fE(e,t,l.boundingVolumeWorldSpace.bounds),fE(e,t,c.boundingVolumeWorldSpace.bounds))}}(i,e,r):function(e,t,i){xE.clear(),i.forAll((e=>{e.isVisible&&0!==e.getNumGeometryRecords()&&xE.add(e)})),xE.empty||(xE.sort(t),sD(_E,t.near,Math.min(e.near,t.far)),xE.forEachInDepthRange(_E,1,((i,r)=>{r<e.near&&pE(e,t,i)})),sD(_E,Math.max(e.far,t.near),t.far),xE.forEachInDepthRange(_E,-1,((t,i,r)=>{e.far=Math.max(e.far,r)})))}(i,e,t.objects),i}(e,t))})),r}(e,this._content,this._stage.layers);return nD(t,this.renderPlugins.queryDepthRange(e)),t.near=Math.max(e.near,t.near),t.far=Math.min(e.far,t.far),t}renderGeometryAndTransparentTerrainPass(e){this._renderContext.pass=e,this.renderGeometryPass(e),this.renderTransparentTerrain()}renderGeometryPass(e){this._renderContext.pass=e,this.renderOpaqueGeometry(),this.renderTransparentGeometry()}renderOpaqueGeometry(){this.renderSlot(1),this.renderSlot(2),this.renderInternalSlot(3),this.renderSlot(4),this.renderSlot(14)}renderTransparentGeometry(){this.renderInternalSlot(5),this.renderSlot(6)}renderTransparentTerrain(){return this.renderSlot(7)}renderHUDVisibility(){let e=!1;return this._renderContext.offscreenRenderingHelper&&this._renderContext.offscreenRenderingHelper.renderHUDVisibility((()=>{this._bindParameters.hudVisibilityTexture=this._renderContext.offscreenRenderingHelper?this._renderContext.offscreenRenderingHelper.hudVisibilityTexture:null,e=this.renderInternalSlot(12)}),this._multipassTerrain&&!this._opaqueTerrain),e}renderLineCallouts(e){this._bindParameters.renderTransparentlyOccludedHUD=e,0===e?this._offscreenRendering.renderToTargets((()=>this.renderInternalSlot(20)),this._offscreenRendering.currentColorTarget,this._offscreenRendering.tmpDepth,void 0,!0,!0):this.renderInternalSlot(20)}renderHUD(e,t){this._oitEnabled?(this.renderOrderIndependentTransparency((()=>this.renderHUDElements(e)),!0),this._rctx.bindFramebuffer(t),this._compositingHelper.composite(this._offscreenRendering.hudColorTexture,2)):0===e?this._offscreenRendering.renderToTargets((()=>this.renderHUDElements(0)),this._offscreenRendering.currentColorTarget,this._offscreenRendering.tmpDepth,void 0,!0,!0):this.renderHUDElements(e)}renderHUDElements(e){this._bindParameters.renderTransparentlyOccludedHUD=e,this.renderInternalSlot(21),this.renderInternalSlot(18),this.renderInternalSlot(19)}get needsHighlight(){return this._hasHighlights||this._renderPlugins.needsHighlight}get needsShadowHighlight(){return this._shadowMap.enabled&&this._shadowHighlightHelper.isVisible&&this.needsHighlight}renderHighlights(e,t){if(!this.needsHighlight)return void this._offscreenRendering.disposeTarget(this._offscreenRendering.highlight);const i=this._highlightHelper,r=i.profilingCallback&&wg(this._renderContext.rctx);this._renderContext.highlightDepthTexture=t.highlightDepthTexture;const s=this._offscreenRendering.renderToTargets((()=>{this.renderGeometryAndTransparentTerrainPass(5),this._rctx.clearSafe(256),this.renderHUDElements(2)}),this._offscreenRendering.highlight,this._offscreenRendering.tmpDepth,[0,0,0,0],!0,!0);this._bindParameters.highlightColorTexture=s.colorTexture,this.needsShadowHighlight&&this._shadowHighlightHelper.render(t,e),i.render(this._renderContext.camera,s,e),(0,u.r)(r)&&i.profilingCallback&&r.stop((e=>{i.profilingCallback&&i.profilingCallback(e)}))}get needsShadowAccumulation(){return this._shadowAccumulator.isAccumulating}accumulateShadows(e,t,i){this.needsShadowAccumulation&&(this._shadowAccumulator.setAccumulationDependencies(this._offscreenRendering.linearDepthTexture,e,t,i),this._shadowAccumulator.accumulateFixedSamples(),this.renderPassManager.shadowCastingEnabled=this._shadowMap.enabled)}renderOrderIndependentTransparency(e,t){const i=i=>{this._renderContext.transparencyPassType=i,this._bindParameters.transparencyPassType=this._renderContext.transparencyPassType,this._offscreenRendering.renderOITPass((()=>e()),i,t)},r=this._renderContext.pass;this._renderContext.pass=1,i(1),this._renderContext.pass=0,i(0),i(2),this._offscreenRendering.compositeTransparentOntoOpaque(t),this._renderContext.transparencyPassType=3,this._bindParameters.transparencyPassType=this._renderContext.transparencyPassType,this._renderContext.pass=r}renderOccluded(){let e=0;this._materialRenderers.forEach(((t,i)=>{i&&i.isVisible()&&8===i.renderOccluded&&(e|=i.renderOccluded,$I.push(i))}));const t=this._offscreenRendering,i=(i,r,s,n,a)=>{0!=(e&r)&&(t.renderToTargets(s,t.tmpColor,t.mainDepth,[0,0,0,0],n,a),t.compositeOccludedOntoMain(i))};0!==$I.length&&(this.renderInternalSlot(10,$I),i(.5,8,(()=>this.renderInternalSlot(11,$I)),!1,!1),$I.length=0),this._materialRenderers.forEach(((t,i)=>{i&&i.isVisible()&&(4===i.renderOccluded||2===i.renderOccluded||16===i.renderOccluded)&&(e|=i.renderOccluded,XI.push(i))}));const r=this._renderPlugins.renderOccludedFlags;if(e|=r,!e)return;const s=e=>{this._renderContext.renderOccludedMask=e,r>1&&this.renderSlot(9),this.renderInternalSlot(3,XI),this.renderInternalSlot(5,XI),this.renderInternalSlot(8,XI),this._renderContext.resetRenderOccludedMask()};this._renderContext.pass=0,i(.5,4,(()=>s(4)),!0,2),i(.5,2,(()=>s(2)),!0,2),i(1,16,(()=>s(16)),!0,2),XI.length=0}renderAntiAliasing(e,t){if(1===e){if(this._smaaPass.loadResources((()=>this.requestRender())),this._smaaPass.enable())return this._smaaPass.render({colorTexture:t}),!0}else this._smaaPass.disable();return!1}ensureCameraBindParameters(e){this._renderContext.camera=e,this._bindParameters.camera=this._renderContext.camera,this._bindParameters.inverseViewport[0]=1/this._renderContext.camera.fullViewport[2],this._bindParameters.inverseViewport[1]=1/this._renderContext.camera.fullViewport[3]}ensureBindParameters(e){var t;this.ensureCameraBindParameters(e);const i=this._renderContext.offscreenRenderingHelper;this._bindParameters.shadowMap=this._renderContext.shadowMap,this._bindParameters.shadowMappingEnabled=this._renderContext.shadowMap.enabled,this._bindParameters.ssaoHelper=this._renderContext.ssaoHelper,this._bindParameters.ssaoEnabled=this._renderContext.ssaoHelper.enabled,this._bindParameters.slicePlane=this._renderContext.sliceHelper.plane,this._bindParameters.hasOccludees=this._renderContext.hasOccludees,this._renderContext.multipassTerrainParams.camera=this._renderContext.camera,this._bindParameters.hudVisibilityTexture=i.hudVisibilityTexture,this._bindParameters.highlightDepthTexture=null!=(t=i.depthTexture)?t:this.getFallbackDepthTexture()}ensureBindParametersSSR(){this.hasWaterReflection?(this._renderContext.lastFrameCamera.equals(this._renderContext.camera)?this._renderContext.ssrParams.reprojectionMat=this._bindParameters.reprojectionMat=iL:((0,C.c)(KI,this._renderContext.lastFrameCamera.viewMatrix,this._bindParameters.origin?this._bindParameters.origin:[0,0,0]),(0,C.c)(eL,this._renderContext.camera.viewMatrix,this._bindParameters.origin?this._bindParameters.origin:[0,0,0]),(0,C.h)(eL,eL),(0,C.h)(JI,this._renderContext.camera.projectionMatrix),(0,C.e)(tL,eL,JI),(0,C.e)(tL,KI,tL),(0,C.e)(tL,this._renderContext.lastFrameCamera.projectionMatrix,tL),this._renderContext.ssrParams.reprojectionMat=this._bindParameters.reprojectionMat=tL),this._renderContext.ssrParams.camera=this._renderContext.camera,this._renderContext.ssrParams.lastFrameColorTexture=this._bindParameters.lastFrameColorTexture=this._offscreenRendering.lastFrameColorTexture):this._renderContext.ssrParams.lastFrameColorTexture=this._bindParameters.lastFrameColorTexture=null,this._renderContext.ssrParams.ssrEnabled=this._bindParameters.ssrEnabled=this.hasWaterReflection}renderInternalSlot(e,t){const i=0===this._renderContext.pass?this.performanceInfo.stats:null;let r=!1;return this._bindParameters.slot=e,(0,u.r)(t)?t.forEach((t=>{if(!(0,S.aN)(t,this._renderContext))return;const i=this._materialRenderers.get(t);(0,u.r)(i)&&(r=i.render(e,this._renderContext.pass,this._bindParameters)||r)})):this._materialRenderers.forEach(((t,s)=>{(0,S.aN)(s,this._renderContext)&&(r=t.render(e,this._renderContext.pass,this._bindParameters,i)||r)})),r}getFallbackDepthTexture(){return this._fallbackDepthStencilTexture||(this._fallbackDepthStencilTexture=(0,S.aQ)(this._rctx)),this._fallbackDepthStencilTexture}getGpuMemoryUsage(){return{offscreen:this._offscreenRendering?this._offscreenRendering.getGpuMemoryUsage():0,highlights:(this._highlightHelper?this._highlightHelper.getGpuMemoryUsage():0)+(this._shadowHighlightHelper?this._shadowHighlightHelper.getGpuMemoryUsage():0),shadows:this._shadowMap?this._shadowMap.getGpuMemoryUsage():0,ssao:this._ssaoHelper?this._ssaoHelper.gpuMemoryUsage:0}}get test(){const e=this;return{antialiasing:this._antialiasing,offscreen:this._offscreenRendering,shadowMap:this._shadowMap,ssao:this._ssaoHelper,highlight:this._highlightHelper,lighting:this._lighting,materialRenderers:this._materialRenderers,oitEnabled:this._oitEnabled,shadowHighlights:this._shadowHighlightHelper,getFramebufferTexture:t=>{var i;switch(t){case 0:return e._offscreenRendering.colorTexture;case 1:return e._offscreenRendering.linearDepthTexture;case 2:return e._offscreenRendering.normalTexture;case 3:return null==(i=e._shadowMap)?void 0:i.test.depthTexture;case 4:return e._offscreenRendering.hudVisibilityTexture;case 5:return e._offscreenRendering.highlightTexture}}}}}const XI=[],$I=[],KI=(0,T.e)(),JI=(0,T.e)(),eL=(0,T.e)(),tL=(0,T.e)(),iL=(0,T.e)(),rL=u.n.getLogger("esri.views.3d.webgl-engine.lib.TextureRepository");class sL{constructor(e,t,i){this._stage=e,this._rctx=i,this._idToRefCountedTexture=new Map,this._loadingCount=0,this._frameUpdates=new Map,this._fallbackTextureData=new Uint8Array(256),this._fallbackTextureTransparentData=new Uint8Array(256),this.events=new n.n,this._textureTechnique=t.acquire(kg,new Ng);for(let e=0;e<this._fallbackTextureData.length;++e)this._fallbackTextureData[e]=255,this._fallbackTextureTransparentData[e]=(e+1)%4!=0?255:0;this._fallbackTextureDesc={target:3553,pixelFormat:6408,dataType:5121,samplingMode:9728,width:8,height:8,maxAnisotropy:this._rctx.parameters.maxMaxAnisotropy},this._frameTask=e.resourceController.scheduler.registerTask(Jd.TEXTURE_UNLOAD)}dispose(){this._frameTask.remove(),(0,u.r)(this._fallbackTexture)&&(this._fallbackTexture.dispose(),this._fallbackTexture=null),(0,u.r)(this._fallbackTextureTransparent)&&(this._fallbackTextureTransparent.dispose(),this._fallbackTextureTransparent=null),this._stage.forEachOfType(4,(e=>e.unload()))}get updating(){return this.loadingCount>0||this._frameTask.updating}acquire(e,t=!1,i){const r=this._getOrCreateRef(e,t,i);return r.ref(),r}update(){let e=!1;this._frameUpdates.forEach((t=>{const i=t.texture.frameUpdate(this._rctx,this._textureTechnique,t.previousToken);i>=0&&i!==t.previousToken&&(t.previousToken=i,e=!0)})),e&&this.events.emit("changed",0)}_getOrCreateRef(e,t,i){return this._idToRefCountedTexture.get(e)||this._createNewRef(e,t,i)}_createNewRef(e,t,i){const r=this._stage.getObject(e);(0,S.i)(void 0!==r);const s=r.events.on("unloaded",(()=>{s.remove(),this._onTextureUnloaded(e)})),n=new nL;this._idToRefCountedTexture.set(e,n);const a=r.load(this._rctx,this._textureTechnique);this._loadingCount++;const o=t=>(this._loadingCount--,this._updateGLTexture(n,t),i&&i(n),r.requiresFrameUpdates&&this._frameUpdates.set(e,{texture:r,previousToken:-1}),n);return(0,h.U)(a)?(this._updateGLTexture(n,t?this.fallbackTextureTransparent:this.fallbackTexture),a.then(o,(e=>{this._loadingCount--,(0,h.g)(e)||rL.error(e)}))):o(a),n}_updateGLTexture(e,t){e.glTexture=t,this.events.emit("changed",1)}release(e){const t=this._idToRefCountedTexture.get(e);if(t&&(t.unref(),t.isUnreferenced)){const i=this._stage.getObject(e);this._frameTask.schedule((()=>{t.isUnreferenced&&i.unload()}))}}getTexture(e){return this._stage.getObject(e)}get loadingCount(){return this._loadingCount}_onTextureUnloaded(e){this._idToRefCountedTexture.delete(e),this._frameUpdates.delete(e)}get fallbackTexture(){return(0,u.t)(this._fallbackTexture)&&(this._fallbackTexture=new q.r(this._rctx,this._fallbackTextureDesc,this._fallbackTextureData)),this._fallbackTexture}get fallbackTextureTransparent(){return(0,u.t)(this._fallbackTextureTransparent)&&(this._fallbackTextureTransparent=new q.r(this._rctx,this._fallbackTextureDesc,this._fallbackTextureTransparentData)),this._fallbackTextureTransparent}}class nL{constructor(){this._refCount=0,this.glTexture=null}get isUnreferenced(){return 0===this._refCount}ref(){++this._refCount}unref(){0!==this._refCount?--this._refCount:rL.error("Cannot dereference texture that has no references!")}}const aL=u.n.getLogger("esri.views.3d.webgl-engine.materials.internal.waterMaterialUtils");let oL=class extends r.p{constructor(){super(...arguments),this._data=new Array,this.loadingState=0}dispose(){this.loadingState=0,this._data.forEach((e=>e.dispose())),this._data.length=0}get updating(){return 1===this.loadingState}get ready(){return 2===this.loadingState}loadTextures(e){const t=[(0,H.a)("esri/images/materials/water/normals.jpg"),(0,H.a)("esri/images/materials/water/perturbation.jpg")];this.loadingState=1,Promise.all(t.map((e=>(0,F.t)(e)))).then((t=>{t.forEach((t=>this._data.push(new q.r(e,{target:3553,pixelFormat:6408,dataType:5121,wrapMode:10497,samplingMode:9987,hasMipmap:!0,maxAnisotropy:8,width:t.width,height:t.height},t)))),this.loadingState=2})).catch((e=>{aL.error("Failed to load textures for water material.",e),this.loadingState=0}))}bind(e){this._data.length>=2&&(e.bindTexture(this._data[0],"texWaveNormal"),e.bindTexture(this._data[1],"texWavePerturbation"))}};(0,r.e)([(0,d.y)()],oL.prototype,"loadingState",void 0),(0,r.e)([(0,d.y)({type:Boolean,readOnly:!0})],oL.prototype,"updating",null),oL=(0,r.e)([(0,d.n)("esri.views.3d.webgl-engine.materials.internal.WaterTextureRepository")],oL);class lL extends S.br{constructor(e,t,i,r=null,s,n=!0){super(),this._rctx=e,this._renderScene=t,this._requestRenderScene=i,this._renderOverlay=r,this.forceCameraHook=s,this.supersample=n,this._screenshotQueue=[]}dispose(){this._rctx=null}takeScreenshot(e){this._requestRenderScene();const t=(0,h.D)();return this._screenshotQueue.push({settings:e,resolver:t}),t.promise}update(e){if(0!==this._screenshotQueue.length){for(const t of this._screenshotQueue){if(this.isDisposed){t.resolver.reject();continue}const i={...t.settings,pixelRatio:t.settings.pixelRatio*e.viewCamera.pixelRatio},r=this._ensureScreenshotEncodeCanvas(),s=this._renderScreenshot(e,i),n=(0,Me.a)(s,i,r,{flipY:!0,premultipliedAlpha:!0});t.resolver(n)}this._screenshotQueue=[]}}_renderScreenshotOverlay(e,t,i){if((0,u.t)(this._renderOverlay))return t;e.width=t.width,e.height=t.height;const r=e.getContext("2d"),s=i.pixelRatio;return r.save(),r.translate(0,t.height),r.scale(1,-1),i.region&&r.translate(-i.region.x,-i.region.y),r.scale(s,s),t=this._renderOverlay(e,t),r.restore(),t}_readbackScreenshot(e){return e.resample?this._readbackScreenshotResampled(e):this._readbackScreenshotImmediate(e)}_readbackScreenshotResampled(e){const{framebufferWidth:t,framebufferHeight:i,region:r,resample:s}=e,n=this._ensureScreenshotEncodeCanvas();let a=(0,Me.l)(t,i,n);this._rctx.gl.readPixels(0,0,t,i,6408,5121,new Uint8Array(a.data.buffer)),a=this._renderScreenshotOverlay(n,a,{...e,region:null});const o=(0,Me.l)(r.width,r.height,n);return(0,Me.d)(a,o,!0,s.region.x,i-(s.region.y+s.region.height),s.region.width,s.region.height)}_readbackScreenshotImmediate(e){const{framebufferHeight:t,region:i}=e,r=this._ensureScreenshotEncodeCanvas(),s=(0,Me.l)(i.width,i.height,r);return this._rctx.gl.readPixels(i.x,t-(i.y+i.height),i.width,i.height,6408,5121,new Uint8Array(s.data.buffer)),this._renderScreenshotOverlay(r,s,e)}_renderScreenshot(e,t){let i=null;const r=e.viewCamera,{framebufferWidth:s,framebufferHeight:n}=t;let a=!1;const o=t.disableDecorations&&e.frameHasDecorations,l=s!==r.fullWidth||n!==r.fullHeight,c=t.ignorePadding&&r.pixelRatio!==t.pixelRatio,h=l||o||c;if(h){const e=r.clone();if(t.ignorePadding){const i=(0,w.t)(e.padding);for(let r=0;r<4;r++)i[r]=Math.round(i[r]/e.pixelRatio*t.pixelRatio);e.padding=i}e.fullWidth=s,e.fullHeight=n,e.pixelRatio=t.pixelRatio;const o=r.fovX-e.fovX,l=r.fovY-e.fovY;o<0&&o<l?e.fovX=r.fovX:l<0&&l<o&&(e.fovY=r.fovY),this.forceCameraHook(e),a=!0,i=new V.o(this._rctx,{width:e.fullWidth,height:e.fullHeight,colorTarget:0,depthStencilTarget:3}),this._renderScene(i,e,t.disableDecorations)}const d=this._readbackScreenshot(t);if(h&&!this._rctx.contextAttributes.alpha)for(let e=3;e<d.data.length;e+=4)d.data[e]=255;return i&&i.dispose(),this._rctx.bindFramebuffer(null),a&&this.forceCameraHook(r),d}_ensureScreenshotEncodeCanvas(){return this._screenshotEncodeCanvas||(this._screenshotEncodeCanvas=document.createElement("canvas")),this._screenshotEncodeCanvas}}const cL=u.n.getLogger("esri.views.3d.webgl-engine.parts.View");let hL=class extends((0,S.aP)(r.p)){constructor(e){super({}),this.events=new n.n,this.waterTextureRepository=new oL,this._magnifierHelper=new CE,this._componentObjectCollection=null,this._needsUpdate=!0,this._needsRender=!0,this._idleSuspend=!0,this._needsWaterReflectionUpdate=!1,this._logicUpdateLast=0,this._container=e.container,this._initializeContext(e.options),(0,p.d)(this.waterTextureRepository,"loadingState",(()=>this.setNeedsRender())),this._magnifierHelper.events.on("request-render",(()=>this.setNeedsRender())),this._stippleTextureRepository=new nv(this._rctx),this._shaderTechniqueRepository=new Pm({rctx:this._rctx,viewingMode:e.viewingMode,stippleTextureRepository:this._stippleTextureRepository,waterTextureRepository:this.waterTextureRepository}),this._textureRepository=new sL(e,this._shaderTechniqueRepository,this._rctx),this._textureRepository.events.on("changed",(e=>this.setNeedsRender(e))),this._materialRepository=new Dm(this._textureRepository,this._shaderTechniqueRepository,(()=>this.setNeedsRender())),this._compositingHelper=new hE(this._rctx,this._shaderTechniqueRepository),this._renderer=new YI(this._materialRepository,this._textureRepository,this._shaderTechniqueRepository,this._rctx,this._compositingHelper,this._magnifierHelper,((e=1)=>this.setNeedsRender(e)),((t,i)=>e.schedule(t,i)),e),this._screenshotManager=new lL(this._rctx,((e,t,i)=>this._renderer.render(e,t,t,i)),(()=>this.setNeedsRender()),e.options.screenshot.renderOverlay,(e=>this.events.emit("force-camera-for-screenshot",e))),this._registerFrameTask(e)}normalizeCtorArgs(){return{}}dispose(){this._container.contains(this._canvas)&&this._container.removeChild(this._canvas),this._frameTask&&(this._frameTask.remove(),this._frameTask=null),this._shaderTechniqueRepository.dispose(),this._shaderTechniqueRepository=null,(0,S.bO)(this._rctx),super.dispose(),this._tmpDepthBuffer=null,this._rctx=null}get performanceInfo(){const e=this._rctx.gl;return{renderer:this._renderer.performanceInfo,textureMemory:void 0!==e.getUsedTextureMemory?e.getUsedTextureMemory():void 0,renderbufferMemory:void 0!==e.getUsedRenderbufferMemory?e.getUsedRenderbufferMemory():void 0,VBOMemory:void 0!==e.getUsedVBOMemory?e.getUsedVBOMemory():void 0}}setNeedsRender(e=1){1===e?this._needsUpdate||(this._needsUpdate=!0,this.notifyChange("updating")):this._needsRender=!0}get needsUpdate(){return this._needsUpdate}get updating(){return this.evaluateUpdating()}evaluateUpdating(){return this.needsUpdate||this._needsWaterReflectionUpdate||this._renderer.updating||this._textureRepository.updating||this.waterTextureRepository.updating||this._magnifierHelper.updating}ensureEdgeView(){return this._renderer.ensureEdgeView()}get edgeView(){return this._renderer.edgeView}get textureRepository(){return this._textureRepository}get compositingHelper(){return this._compositingHelper}set magnifier(e){this._magnifierHelper.magnifier=e}updateLightSources(e,t,i){this._renderer.updateLightSources(e,t,i),this.setNeedsRender()}setRenderParameters(e){void 0!==e.idleSuspend&&this._idleSuspend!==!!e.idleSuspend&&(this._idleSuspend=!!e.idleSuspend,this.setNeedsRender()),this._renderer.setRenderParameters(e)}get renderingContext(){return this._rctx}has(e){switch(e){case 0:return!!this._rctx.capabilities.compressedTextureETC;case 1:return!!this._rctx.capabilities.compressedTextureS3TC;case 2:return!!this._rctx.capabilities.shaderTextureLOD;case 3:return this._renderer.hasShadowsEnabled;default:return!1}}modify(e){this._renderer.modify(e),e.clear()}get canvas(){return this._canvas}takeScreenshot(e){return this._screenshotManager.takeScreenshot(e)}readAccumulatedShadow(e){return this._renderer.readAccumulatedShadow(e[0],e[1])}getMinimalDepthForArea(e,t,i,r,s=r){const n=i.constrainWindowSize(e,t,r*i.pixelRatio,s*i.pixelRatio),a=this._ensureDepthBuffer(n);this._renderer.readDepthPixels(i,n[0],n[1],n[2],n[3],a);let o=Number.MAX_VALUE;for(let e=0;e<n[2]*n[3];e++){const t=uE(4*e,a,i.nearFar);o>t&&t!==i.nearFar[0]&&t!==i.nearFar[1]&&(o=t)}return o===Number.MAX_VALUE?void 0:o}_ensureDepthBuffer(e){const t=4*e[2]*e[3];return((0,u.t)(this._tmpDepthBuffer)||this._tmpDepthBuffer.byteLength<t)&&(this._tmpDepthBuffer=new Uint8Array(t)),this._tmpDepthBuffer}get renderPlugins(){return this._renderer.renderPlugins}get test(){return{renderer:this._renderer}}getGpuMemoryUsage(){return this._renderer.getGpuMemoryUsage()}async hotReloadShaders(){hR(),await this._shaderTechniqueRepository.hotReload(),this.setNeedsRender()}_registerFrameTask(e){const t=e.state,i={viewCamera:t.camera,frameHasDecorations:!1};let s=!1;const n={preRender:i=>{s=this.evaluateUpdating(),e.processSyncLayers();const n=(0,r.w)(i.time-this._logicUpdateLast);if(n>lR){const e={camera:t.camera,dt:n};this._logicUpdateLast=i.time,this._renderer.updateLogic(e)&&this.setNeedsRender(0)}},render:()=>{if((this.needsUpdate||this._needsRender||!this._idleSuspend||!this._renderer.isCameraFinal||this._needsWaterReflectionUpdate)&&t.camera.fullWidth>0&&t.camera.fullHeight>0){const e=this._needsUpdate&&this._idleSuspend&&this._renderer.isCameraFinal;this._needsRender=!1,this._needsUpdate=!1,this._needsWaterReflectionUpdate=!1,this._renderer.render(null,t.camera,t.contentCamera,!1),e&&this._renderer.hasWaterReflection&&(this.setNeedsRender(0),this._needsWaterReflectionUpdate=!0)}},postRender:()=>{s===this.updating&&s===this.evaluateUpdating()||this.notifyChange("updating")},update:()=>{i.viewCamera=t.camera,i.frameHasDecorations=this._renderer.hasSlicePlane||this._magnifierHelper.enabled,this._textureRepository.update(),this._screenshotManager.update(i)}};this._frameTask=(0,r.A)(n)}_initializeContext(e){this._canvas=e.canvas,this._canvas||(this._canvas=document.createElement("canvas")),this._canvas.setAttribute("style","width: 100%; height:100%; display:block;");const t={alpha:e.alpha||!1,premultipliedAlpha:!0,antialias:!1,depth:!0,stencil:null==e.stencil||e.stencil,powerPreference:"high-performance"},i=(0,Oe.e)(this._canvas,t,e.renderContext),r={disabledExtensions:e.deactivatedWebGLExtensions||{},debugWebGLExtensions:e.debugWebGLExtensions||{},maxAnisotropy:8};this._rctx=new V.m(i,r),(0,S.bb)(this._rctx),this._loadShaderOnlyExtensions(this._rctx),!e.alpha&&this._rctx.contextAttributes.alpha&&cL.error("WebGL context has alpha channel even though no alpha channel was requested"),!this._rctx.contextAttributes.alpha&&(0,u.c)("safari")>=11&&(this._container.style.backgroundColor="black"),this._container.appendChild(this._canvas)}_loadShaderOnlyExtensions(e){const t=e.capabilities;t.enable("standardDerivatives"),t.enable("shaderTextureLOD"),t.enable("textureFloat")}get componentObjectCollection(){return(0,u.t)(this._componentObjectCollection)&&(this._componentObjectCollection=new eE(this._renderer.renderPassManager)),this._componentObjectCollection}set componentObjectCollection(e){this._componentObjectCollection=e}};var dL;(0,r.e)([(0,d.y)({type:Boolean,readOnly:!0})],hL.prototype,"updating",null),(0,r.e)([(0,S.aO)()],hL.prototype,"_rctx",void 0),(0,r.e)([(0,S.aO)()],hL.prototype,"_container",void 0),(0,r.e)([(0,S.aO)()],hL.prototype,"_canvas",void 0),(0,r.e)([(0,S.aO)()],hL.prototype,"_stippleTextureRepository",void 0),(0,r.e)([(0,S.aO)(),(0,d.y)()],hL.prototype,"waterTextureRepository",void 0),(0,r.e)([(0,S.aO)(),(0,d.y)()],hL.prototype,"_magnifierHelper",void 0),(0,r.e)([(0,S.aO)(),(0,d.y)()],hL.prototype,"_textureRepository",void 0),(0,r.e)([(0,S.aO)()],hL.prototype,"_compositingHelper",void 0),(0,r.e)([(0,S.aO)()],hL.prototype,"_renderer",void 0),(0,r.e)([(0,S.aO)()],hL.prototype,"_screenshotManager",void 0),(0,r.e)([(0,S.aO)()],hL.prototype,"componentObjectCollection",null),(0,r.e)([(0,S.aO)()],hL.prototype,"_componentObjectCollection",void 0),hL=(0,r.e)([(0,d.n)("esri.views.3d.webgl-engine.parts.RenderView")],hL);let uL=dL=class extends((0,S.aP)(r.p)){constructor(e){super(e),this._handles=new R.u,this._model=new PM,this._layers=new r.f,this._changeSet=new eg,this._layerSyncSet=new Set}initialize(){this._set("renderView",new hL(this)),this._frameTask=this.resourceController.scheduler.registerTask(Jd.STAGE,this),this._handles.add(this._frameTask)}destroy(){Hs.pool.prune(0),this._handles.destroy(),this.dispose()}get viewingMode(){return this.state.viewingMode}get updating(){return this._model.dirtySet.dirty||this.renderView.updating}add(e){this._model.add(e),af(e)&&(e.attachStage(this),this._addLayer(e)),this.renderView.setNeedsRender()}remove(e){(0,u.t)(e)||(this.renderView.setNeedsRender(),this._model.remove(e),af(e)&&(this._removeLayer(e),e.detachStage()))}addMany(e){(0,u.r)(e)&&(this._model.addMany(e),this.renderView.setNeedsRender())}removeMany(e){(0,u.r)(e)&&(this._model.removeMany(e),this.renderView.setNeedsRender())}forEachOfType(e,t){this._model.forEachOfType(e,t)}handleEvent(e,t){this.destroyed||(this._model.dirtySet[e](t),this.renderView.setNeedsRender())}get running(){return this._model.dirtySet.dirty}runTask(e){this._frameTask.processQueue(e),e.done||this._commit()}_commit(){const e=this._model.dirtySet;dL.DebugSettings.logDirtySet&&console.log("Dirty set: "+e.formatDebugInfo()),e.commit(this._changeSet),dL.DebugSettings.logDirtySet&&(console.log("RGs add: "+this._changeSet.adds.map((e=>e.id))),console.log("RGs remove: "+this._changeSet.removes.map((e=>e.id)))),this._layerSyncSet.clear(),this.renderView.modify(this._changeSet),this.renderView.setNeedsRender()}schedule(e,t){return this._frameTask.schedule(e,t)}syncLayer(e){this._layerSyncSet.add(e),this.renderView.setNeedsRender()}processSyncLayers(){const e=this._model.dirtySet;this._layers.forAll((t=>{(this._layerSyncSet.has(t.id)||1===t.updatePolicy)&&(e.commitLayer(t.id,this._changeSet),this._layerSyncSet.delete(t.id))}));for(const t of this._layerSyncSet)e.commitLayer(t,this._changeSet);this._layerSyncSet.clear(),this.renderView.modify(this._changeSet)}getObject(e){return this._model.getObject(e)}get layers(){return this._layers}_addLayer(e){this._layers.some((t=>t===e))||this._layers.push(e)}_removeLayer(e){this._commit(),null!=this._layers.removeUnordered(e)&&(this._model.dirtySet.getResidentRenderGeometries(e.id,this._changeSet.removes),this.renderView.modify(this._changeSet))}addRenderPlugin(e,t,i){const r=this.renderView.renderPlugins.add(e,t,i),s=()=>{sS(t)&&this.sceneIntersectionHelper.addIntersectionHandler(t)};if((0,h.z)(r))return r.then(s);s()}removeRenderPlugin(e){sS(e)&&this.sceneIntersectionHelper.removeIntersectionHandler(e),this.renderView.renderPlugins.remove(e)}get performanceInfo(){return{renderView:this.renderView.performanceInfo,model:this._model.getStats()}}get test(){const e=this;return{getCount:t=>e._model.test.content.filter((e=>e.type===t)).length,stopAnimations:t=>e._model.test.content.filter((e=>3===e.type)).forEach((e=>(0,u.x)(e.animation,(e=>e.stopAtTime(t))))),model:e._model}}};function pL(e,t){if(!e.target)return null;switch(e.target.type){case"stage":return gL(e.target.obj.metadata,t);case"external":switch(e.intersector){case"PointRenderer":return function(e,t){const i=e.metadata.layerUid;return null!=i?t.map.findLayerByUid(i):null}(e.target,t);case"I3S":case"IM":case"LodRenderer":case"OverlayRenderer":return gL(e.target.metadata,t);case"TerrainRenderer":return t.map&&t.map.ground}}return null}function mL(e,t){if(!e.target)return null;switch(e.target.type){case"stage":return fL(e.target.obj.metadata,t);case"external":switch(e.intersector){case"PointRenderer":return function(e){return e.metadata.createGraphic()}(e.target);case"I3S":case"IM":case"LodRenderer":case"OverlayRenderer":return fL(e.target.metadata,t)}}return null}function fL(e,t){if((0,u.t)(e))return null;const i=gL(e,t);if((0,u.t)(i))return null;if(i===t.graphics)return(0,u.r)(t.graphicsView)?(0,u.f)(t.graphicsView.getGraphicFromGraphicUid(e.graphicUid)):null;const r=t.allLayerViews.find((e=>e.layer===i));return r?function(e,t){return!e||e.suspended?null:"getGraphicFromIntersectorMetadata"in e&&t?e.getGraphicFromIntersectorMetadata(t):"getGraphicFromGraphicUid"in e&&null!=t.graphicUid?e.getGraphicFromGraphicUid(t.graphicUid):null}(r,e):null}function gL(e,t){return(0,u.t)(e)||null==e.layerUid?null:(0,u.r)(t.graphicsView)&&e.layerUid===t.graphicsView.graphics3d.layer.id?t.graphics:t.map.findLayerByUid(e.layerUid)}uL.DebugSettings={endFrameContentValidation:!1,logDirtySet:!1},(0,r.e)([(0,d.y)({constructOnly:!0})],uL.prototype,"resourceController",void 0),(0,r.e)([(0,d.y)({constructOnly:!0})],uL.prototype,"options",void 0),(0,r.e)([(0,d.y)({constructOnly:!0})],uL.prototype,"state",void 0),(0,r.e)([(0,d.y)({constructOnly:!0})],uL.prototype,"sceneIntersectionHelper",void 0),(0,r.e)([(0,d.y)({readOnly:!0})],uL.prototype,"viewingMode",null),(0,r.e)([(0,d.y)({constructOnly:!0})],uL.prototype,"container",void 0),(0,r.e)([(0,d.y)({constructOnly:!0})],uL.prototype,"renderSR",void 0),(0,r.e)([(0,d.y)({constructOnly:!0})],uL.prototype,"_handles",void 0),(0,r.e)([(0,d.y)({readOnly:!0})],uL.prototype,"updating",null),(0,r.e)([(0,d.y)({constructOnly:!0})],uL.prototype,"_model",void 0),(0,r.e)([(0,S.aO)(),(0,d.y)()],uL.prototype,"renderView",void 0),uL=dL=(0,r.e)([(0,d.n)("esri.views.3d.webgl-engine.Stage")],uL);let vL=class extends s.z{constructor(e){super(e),this.components=["attribution","zoom","navigation-toggle","compass"]}};(0,r.e)([(0,d.y)()],vL.prototype,"components",void 0),vL=(0,r.e)([(0,d.n)("esri.views.ui.3d.DefaultUI3D")],vL);var yL=vL;const _L=u.n.getLogger("esri.views.SceneView");let xL=class extends((0,s.B)((0,s._)((0,s.a)(s.P)))){constructor(e){super(e),this._clippingArea=null,this._userClippingArea=null,this._initialDefaultSpatialReference=null,this._defaults={},this._externallySet={environment:!1},this._createGraphicsViewController=null,this._resolveWhenReady=[],this.propertiesPool=new KC({slicePlane:ot},this),this._resourceController=function(e,t=(()=>performance.now())){return new US.ResourceController({view:e,now:t})}(this),this._defaultToMapOptions={include:new Set},this._defaultHitTestOptions={exclude:new Set},this.deconflictor=new uu({view:this}),this.labeler=new iC({view:this,deconflictor:this.deconflictor.labels}),this.sharedSymbolResources=null,this.basemapTerrain=null,this.elevationProvider=null,this.camera=null,this.canvas=null,this.center=null,this.constraints=new Ti,this.environmentManager=new ws,this.extent=null,this.floors=new l.L,this.windowDevicePixelRatio=1,this.fullOpacity=1,this.graphicsView=null,this.groundView=null,this.navigating=!1,this.map=null,this.screenSizePerspectiveEnabled=!0,this.state=new eT,this.scale=null,this.spatialReference=null,this.isHeightModelInfoRequired=!0,this.alphaCompositingEnabled=!1,this.supersampleScreenhotsEnabled=!0,this.type="3d",this.ui=new yL,this._numUpdating=0,this._lastUpdateTime=0,this.updatingProgress=.5,this.viewpoint=null,this.zoom=null,this.highlightOptions=new fS,(0,m.m)(),e&&e.environment||(this._defaults.environment=new Zi,this.environment=this._defaults.environment);const t=e=>{(0,u.r)(e)&&4===e.type||(this.notifyChange("dataExtent"),this.updatingChanged(),this.map&&this.map.allLayers.forEach((async e=>{try{await e.when()}catch{}this.updatingChanged()})))};this.handles.add([(0,p.C)(this,"map.allLayers","after-changes",t,t,t,!0),this.allLayerViews.on("after-changes",(e=>this._updateUpdatingMonitors(e))),this.watch("map",(e=>{e&&e.load&&e.load().catch((()=>{}))}))]),this.inputManager=new Eh({view:this}),this.stateManager=new HT({view:this,updateDevicePixelRatio:()=>{const e=window.devicePixelRatio;e!==this.windowDevicePixelRatio&&(this.windowDevicePixelRatio=e,this.notifyChange("pixelRatio"))}})}initialize(){this.groundView=new ri({view:this}),this._updateUpdatingMonitors();const e=()=>this._updateDefaultToMapOptions();this.handles.add((0,p.C)(this,"map.allLayers","after-changes",e,e,e)),this.updatingHandles.add(this.qualitySettings,"memoryLimit",(e=>{this.resourceController&&(this.resourceController.memoryController.maxMemory=e)}),2),this.updatingHandles.add(this.qualitySettings,"additionalCacheMemory",(e=>{this.resourceController&&(this.resourceController.memoryController.additionalCacheMemory=e)}),2),this.updatingHandles.add(this.qualitySettings,"frameRate",(e=>(0,r.P)(e>0?1e3/Math.ceil(e):0)),2),this.updatingHandles.add(Ih,"SCENEVIEW_LOCKING_LOG",(e=>this.defaultsFromMap.logDebugInformation=e),2),this.updatingHandles.add(this,"map.ground",e,3),this.updatingHandles.add(this,"map.ground.opacity",(()=>this._updateDefaultHitTestOptions()),3),this.handles.add(this.watch("spatialReference",(()=>this.notifyChange("clippingArea")),!0))}destroy(){this.destroyed||(this.invalidate(),this.activeTool=null,this.layerViewManager.clear(),this._exitSurface(),this._disposeGraphicsView(),this.sharedSymbolResources&&(this.sharedSymbolResources.destroy(),this.sharedSymbolResources=null),this.labeler.destroy(),this._set("labeler",null),this.deconflictor.destroy(),this._set("deconflictor",null),this._resourceController.destroy(),this._resourceController=null,this.stateManager.destroy(),this._set("stateManager",null),this.inputManager.destroy(),this._set("inputManager",null),this.propertiesPool.destroy(),this.handles.remove("updatingMonitors"),this.environmentManager.destroy(),this._set("environmentManager",null),this.groundView.destroy(),this.groundView=null)}get renderSpatialReference(){return this.renderCoordsHelper&&this.renderCoordsHelper.spatialReference}get basemapSpatialReference(){return this.basemapTerrain&&this.basemapTerrain.spatialReference}installContentCameraReset(e={sticky:!1}){return this.stateManager.installContentCameraReset(e)}get clippingArea(){if("global"===this.viewingMode)return null;let e=this._userClippingArea||this.get("map.clippingArea");if(!this._userClippingArea&&!this.get("map.clippingEnabled")||!e)return this._clippingArea=null,null;if(!(e instanceof A.M))return _L.error("#clippingArea","only clippingArea geometries of type Extent are supported"),this._clippingArea;if(this.spatialReference){if(!(0,g.x)(e.spatialReference,this.spatialReference))return _L.error("#clippingArea","setting clippingArea with incompatible SpatialReference"),this._clippingArea;e=(0,g.g)(e,this.spatialReference)}return this._clippingArea&&e&&this._clippingArea.equals(e)?this._clippingArea:(this._clippingArea=e,e)}set clippingArea(e){this.ready&&"global"===this.viewingMode&&e?_L.error("#clippingArea=","Clipping area is only supported in local viewingMode"):(this._userClippingArea=e,this.notifyChange("clippingArea"))}get dataExtent(){const e=this.spatialReference||O.k.WGS84;let t,i=this.clippingArea;i&&(i=(0,g.g)(i,e));const r=r=>{let s=(0,g.g)(r,e);s&&(i&&(s=s.intersection(i),!s)||((0,u.r)(t)?t.union(s):t=s))},s=this.basemapTerrain;if(s&&s.spatialReference&&r(new A.M({xmin:s.extent[0],ymin:s.extent[1],zmin:0,xmax:s.extent[2],ymax:s.extent[3],zmax:0,spatialReference:s.spatialReference})),this.map){const e=e=>{!e.fullExtent||"graphics"===e.type&&e.internal||r(e.fullExtent)};this.map.allLayers.forEach((t=>e(t)))}return(0,u.t)(t)?new A.M({xmin:0,ymin:0,zmin:0,xmax:0,ymax:0,zmax:0,spatialReference:e}):(t.hasZ?(t.zmin=Math.min(0,t.zmin),t.zmax=Math.max(0,t.zmax)):(t.zmin=0,t.zmax=0),t)}set environment(e){e!==this._defaults.environment&&(this._externallySet.environment=!0),this._set("environment",e)}castEnvironment(e){return e?e instanceof Zi?e:e instanceof Wi?null!=this.environment?this.environment.cloneWithWebsceneEnvironment(e):Zi.fromWebsceneEnvironment(e):(0,d.d)(Zi,e):new Zi}get pixelRatio(){return Math.min(this.windowDevicePixelRatio,this.maximumPixelRatio)}set pixelRatio(e){(0,u.r)(e)?this._override("pixelRatio",e):this._clearOverride("pixelRatio")}get maximumPixelRatio(){let e=1/0;const{maximumPixelRatio:t,maximumRenderResolution:i}=this.qualitySettings;if(null!=t&&(e=Math.min(e,t)),null!=i){const t=i/Math.max(this.width,this.height);e=Math.min(e,t)}return e}set maximumPixelRatio(e){(0,u.r)(e)?this._override("maximumPixelRatio",e):this._clearOverride("maximumPixelRatio")}get groundExtent(){const e=this._get("basemapTerrain");if(e&&e.spatialReference){const t=e.extent;return new A.M({xmin:t[0],ymin:t[1],xmax:t[2],ymax:t[3],spatialReference:e.spatialReference})}const t=this.spatialReference||O.k.WGS84;return new A.M({spatialReference:t})}get initialExtentRequired(){return this.stateManager&&!this.stateManager.hasInitialView}get interacting(){return this.navigating||(0,u.r)(this.activeTool)}get stationary(){return!this.animation&&!this.resizing&&((0,u.t)(this.state)||this.state.stationary)}set qualityProfile(e){pS.isValidProfile(e)&&(pS.apply(e,this.qualitySettings),this._set("qualityProfile",e))}get qualityProfile(){return this._get("qualityProfile")||pS.getDefaultProfile()}set slicePlane(e){if(this._stage.renderView.setRenderParameters({slicePlane:e}),(0,u.t)(e))return void this._set("slicePlane",null);const t=this.propertiesPool.get("slicePlane");ct(e,t),this._set("slicePlane",t)}get resolution(){return null!=this.spatialReference?(0,P.i)(this.scale,this.spatialReference):0}get heightModelInfo(){const e=this.getDefaultHeightModelInfo();return null!=e?y.v.deriveUnitFromSR(e,this.spatialReference):null}get updating(){var e,t,i;let r=0,s=this.layerViewManager.updating,n=s?this.layerViewManager.updatingRemaining:0;this.allLayerViews.forEach((e=>{if(e.isFulfilled()){if(e.updating){if(s=!0,e.suspended||aP(e))return;++n,r+="updatingProgress"in e?e.updatingProgress:.5}}else++n}));for(const e of[this.graphicsView,this.basemapView,this._resourceController,this._stage,this.featureTiles,this.pointsOfInterest,this.environmentManager,this.overlay,this.featureTreeDebugger,this.toolViewManager])if((0,u.r)(e)&&e.updating){const e=.1;n+=e,r+=.5*e}for(const e of[this.deconflictor,this.labeler,this.basemapTerrain])(0,u.r)(e)&&e.updating&&(++n,r+=e.updatingProgress);if(s=!!(s||n>0||this.updatingHandles.updating||!this.ready||!this.stationary||this._createGraphicsViewController||null!=(e=this.inputManager)&&e.hasPendingInputs||null!=(t=this.map)&&null!=(i=t.allLayers)&&i.some((e=>!e.isFulfilled()))),s?(this._numUpdating=Math.max(n,this._numUpdating),r+=this._numUpdating-n):this._numUpdating=0,this._numUpdating>0?r/=this._numUpdating:r=s?0:1,this._get("updatingProgress")!==r){const e=this._resourceController.scheduler.now;if(r<1){const t=Math.min((e-this._lastUpdateTime)/2e3,1);r=this.updatingProgress*(1-t)+r*t}this._set("updatingProgress",r),this._lastUpdateTime=s&&r<1?e:0}return s}get viewingMode(){const e=this.get("map.initialViewProperties.viewingMode");if(e)return e;const t=this.spatialReference;return!t||uc(t,"global")?"global":"local"}set viewingMode(e){this.ready?_L.error("#viewingMode","viewingMode cannot be set once view is ready"):["local","global"].indexOf(e)>=0?this._override("viewingMode",e):void 0===e&&this._clearOverride("viewingMode")}get resourceController(){return this._resourceController}get performanceInfo(){return new fP(this)}on(e,t,i,r){return this.viewEvents.on(e,t,i,r)||super.on(e,t)}hasEventListener(e){return super.hasEventListener(e)||this.viewEvents.hasHandler(e)}toMap(e,t){if(!this.ready)return _L.error("#toMap()","Scene view cannot be used before it is ready"),null;const i=t?this.externalToInternalIntersectOptions(t):this._defaultToMapOptions,r=(0,u.r)(i.graphics)&&((0,u.r)(i.graphics.include)||(0,u.r)(i.graphics.exclude)),n=(0,s.C)(e)?(0,s.D)(this,e):e,a=(0,f.d)(n);i.enableDraped=i.include&&!i.include.has(S.be)||i.exclude&&i.exclude.has(S.be);const o=this.sceneIntersectionHelper,l=new sn(this.state.viewingMode);if(l.options.selectionMode=!0,l.options.store=r?2:0,o.intersectIntersectorScreen(a,l,i),r){for(const e of l.results.all){const t=mL(e,this);if((0,u.t)(t))return this._intersectResultToMapPoint(e);if(this._testGraphicUidFilter(i.graphics,t))return this._intersectResultToMapPoint(e)}return null}return this._intersectResultToMapPoint(l.results.min)}toScreen(e){if(!this.ready)return _L.error("#toScreen()","Scene view cannot be used before it is ready"),null;const t=(0,u.q)(null==e.z&&Ht(this.elevationProvider,e),0);return(0,_.R)(e,wL,this.renderSpatialReference,t),this.state.camera.projectToScreen(wL,CL),(0,f.c)(CL[0],CL[1])}pixelSizeAt(e){return this.ready?e?((0,_.R)(e,wL,this.renderSpatialReference),this.state.camera.computeScreenPixelSizeAt(wL)):0:(_L.error("#pixelSizeAt()","Scene view cannot be used before it is ready"),null)}overlayPixelSizeInMapUnits(e){const t=this.basemapTerrain.overlayManager;return t?t.overlayPixelSizeInMapUnits(e):1}hitTest(e,t){if(!this.ready)return _L.error("#hitTest()","Scene view cannot be used before it is ready"),null;const i=(0,s.C)(e)?(0,s.D)(this,e):e,r=(0,f.i)(i.x,i.y),n=t?this.externalToInternalIntersectOptions(t):this._defaultHitTestOptions;n.requiresGroundFeedback=!0,n.enableDraped=!0;const a=new sn(this.state.viewingMode);a.options.selectionMode=!0,a.options.store=2,this.sceneIntersectionHelper.intersectIntersectorScreen(r,a,n);const o=this._intersectResultsToHits(a.results.all,n.graphics),l=a.results.ground,c=pL(l,this),h=(0,u.r)(c)&&"type"in c&&"integrated-mesh"===c.type?c:null,d={screenPoint:i,results:o,ground:{mapPoint:this._intersectResultToMapPoint(l),distance:l.hasIntersectionPoint?l.distanceInRenderSpace:0,layer:h}};return Ih.SCENEVIEW_HITTEST_RETURN_INTERSECTOR&&(d.intersector=a),Promise.resolve(d)}popupHitTest(e){return async function(e,t){if("2d"===e.type)return e.hitTest(t);const i=await e.hitTest(t),r=i.results[0],s=i.results.findIndex((e=>e.distance!==r.distance));return-1!==s&&(i.results=i.results.slice(0,s)),i}(this,e).then((({results:t,ground:i})=>{let r=null;return!(0===t.length||Math.abs(t[0].distance-i.distance)<1e-5)||i.layer&&"integrated-mesh"===i.layer.type||(r=i.mapPoint),{results:t,screenPoint:e,mapPoint:r}}))}goTo(e,t){return this.updatingHandles.addPromise(this.stateManager.goTo(e,t))}whenLayerView(e){return super.whenLayerView(e)}takeScreenshot(e){return this.whenReady().then((()=>{const t=(0,Me.n)(e,this);return t.pixelRatio/=this.pixelRatio,this._stage.renderView.takeScreenshot((0,Me.f)(t,this.supersampleScreenhotsEnabled,this.padding))}))}addUpdatingPromise(e){return this.updatingHandles.addPromise(e)}importLayerView(e){return(e=>{const t=oi[e.type];if(!(0,u.r)(t))throw function(e){const t=e.declaredClass?e.declaredClass.slice(e.declaredClass.lastIndexOf(".")+1):"Unknown",i=t.replace(/([a-z])([A-Z])/g,"$1-$2").toLowerCase();return new h.s(`${i}:view-not-supported`,`${t} is not supported in 3D`)}(e);return t(e)})(e)}hasLayerViewModule(e){return(e=>(0,u.r)(oi[e.type]))(e)}forceDOMReadyCycle(){this.forceReadyCycle()}getDefaultSpatialReference(){return this.get("map.initialViewProperties.spatialReference")||this.get("defaultsFromMap.spatialReference")||this.get("defaultsFromMap.isSpatialReferenceDone")&&this._initialDefaultSpatialReference||null}async validate(){let e=(0,s.E)();if((0,u.c)("safari")&&(0,u.c)("safari")<9&&(e=new h.s("sceneview:browser-not-supported","This browser is not supported by SceneView (Safari < 9)",{type:"safari",requiredVersion:9,detectedVersion:(0,u.c)("safari")})),(0,u.r)(e))throw _L.warn("#validate()",e.message),e}isSpatialReferenceSupported(e,t,i){const r=e.isGeographic,s=e.isWebMercator,n=uc(e,"global"),a="local"===this.viewingMode,o=!(!this._isOverridden("viewingMode")&&!this.get("map.initialViewProperties.viewingMode"));if(o){if(a&&r)return i?i(`Layer ${t.id} is ignored because it is GCS and viewing mode is local`):_L.warnOnce("Geographic coordinate systems are not supported in local viewing mode."),!1;if(!a&&!n)return i?i(`Layer ${t.id} is ignored because its spatial reference is not supported in global viewing mode`):_L.warnOnce("Spatial reference defined on view not supported in global viewing mode."),!1}else if(r&&!n)return i?i(`Layer ${t.id} is ignored because its spatial reference is geographic but unsupported`):_L.warnOnce("Spatial reference is geographic but not supported."),!1;if(t)if(Gt(t)){let r;if(o)r=null!=uP(t,e,si(this.viewingMode)).tileInfo;else{let i=uP(t,e,1);null==i.tileInfo&&(i=uP(t,e,2),null!=i.tileInfo&&s&&!this.ready&&(this.viewingMode="local")),r=null!=i.tileInfo}if(!r)return i&&i(`Layer ${t.id} is ignored because it is tiled but\n            its tiling scheme is not supported or compatible with the viewing mode`),!1}else if((e.isWGS84||s)&&!a)return null==this._initialDefaultSpatialReference&&(this._initialDefaultSpatialReference=e),o||this.ready||(this.viewingMode="global",i&&i(`Viewing mode locked to global due to reprojectable layer ${t.id}`)),i&&i(`Layer ${t.id} is ignored because it supports server-side reprojection`),!1;return!0}whenReady(){return new Promise((e=>{this.ready?e(this):this._resolveWhenReady.push(e)}))}computeMapPointFromVec3d(e,t){let i=this.spatialReference||O.k.WGS84;return(0,_.w)(e,this.renderSpatialReference,e,i)||(i=O.k.WGS84,(0,_.w)(e,this.renderSpatialReference,e,i)),t?(t.x=e[0],t.y=e[1],t.z=e[2],t.spatialReference=i):t=new g.b(e,i),t}trackGraphicState(e){if(!e.graphic)return _L.error("trackGraphicState","GraphicState.graphic must not be null or undefined to start tracking"),null;const t=this.getViewForGraphic(e.graphic);let i=null,r=!1;const s=t=>{!r&&(0,u.r)(t)&&"graphics3d"in t&&t.graphics3d&&t.graphics3d.graphicsCore&&(i=t.graphics3d.graphicsCore.trackGraphicState(e))};return(0,u.r)(t)?s(t):this.whenViewForGraphic(e.graphic,{waitForLayer:!0}).then((e=>s(e)),(()=>{})).catch((()=>{})),{remove:()=>{r=!0,(0,u.r)(i)&&(i.remove(),i=null)}}}highlight(e){if(Array.isArray(e))return(0,d.x)(e.map((e=>this.highlight(e))));if(l.L.isCollection(e))return(0,d.x)(e.toArray().map((e=>this.highlight(e))));const t=this.getViewForGraphic(e);return t&&"highlight"in t?t.highlight(e):(0,d.A)()}maskOccludee(e){if(!e)return _L.error("maskOccludee","GraphicState.graphic must not be null or undefined to mask an occludee"),null;const t=this.getViewForGraphic(e);let i=null,r=!1;const n=t=>{!r&&(0,u.r)(t)&&"graphics3d"in t&&(0,s.a2)(t)&&(i=t.maskOccludee(e))};return(0,u.r)(t)?n(t):this.whenViewForGraphic(e,{waitForLayer:!0}).then((e=>n(e)),(()=>{})).catch((()=>{})),{remove:()=>{r=!0,(0,u.r)(i)&&(i.remove(),i=null)}}}getViewForGraphic(e){return e.layer===this.graphics?this.graphicsView:e.layer?this.allLayerViews.find((t=>t.layer===e.layer)):null}graphicChanged(e){(0,u.r)(this.graphicsView)&&this.graphicsView.graphicChanged(e)}async whenViewForGraphic(e,t){if(e.layer===this)return await(0,p.j)(this,"graphicsView"),this.graphicsView;if(!e.layer||!this.map)throw new h.s("no-view-for-graphic");return t&&t.waitForLayer&&!this.map.allLayers.includes(e.layer)?new Promise(((t,i)=>{const r=this.map.allLayers.on("change",(s=>{-1!==s.added.indexOf(e.layer)&&(r.remove(),this.whenLayerView(e.layer).then(t,i))}))})):this.whenLayerView(e.layer)}externalToInternalIntersectOptions(e){const t=this._externalToInternalRenderItems(e.include,0),i=this._externalToInternalRenderItems(e.exclude,1);return{include:t.layerUids,exclude:i.layerUids,graphics:{include:t.graphicUids,exclude:i.graphicUids}}}_intersectResultToMapPoint(e,t){return e.getIntersectionPoint(wL)?(t=this.computeMapPointFromVec3d(wL,t),"TerrainRenderer"===e.intersector&&this.basemapTerrain&&(t.z=(0,u.q)(Ht(this.basemapTerrain,t),0)),t):null}_intersectResultsToHits(e,t){const i=new Array;let r=null;for(let s=0;s<e.length;s++){const n=e[s],a=pL(n,this);if((0,u.r)(a)&&(a===this.map.ground||"type"in a&&"integrated-mesh"===a.type))break;const o=mL(n,this);if(!(0,u.r)(o))continue;if((0,u.t)(r)&&s!==e.length-1&&(r=new Set),(0,u.r)(r)){const e=this._getGraphicFilterUid(o);if(r.has(e))continue;r.add(e)}if(!this._testGraphicUidFilter(t,o))continue;const l=this._intersectResultToMapPoint(n),c=n.distanceInRenderSpace;i.push({graphic:o,mapPoint:l,distance:c})}return i}_getGraphicFilterUid(e){if(e.layer&&"objectIdField"in e.layer){const t=e.attributes[e.layer.objectIdField];if(t)return`o-${e.layer.id}-${t}`}return`u-${e.uid}`}_testGraphicUidFilter(e,t){const i=this._getGraphicFilterUid(t);return(0,u.t)(e)||((0,u.t)(e.include)||e.include.has(i))&&((0,u.t)(e.exclude)||!e.exclude.has(i))}_externalToInternalRenderItems(e,t,i={layerUids:null,graphicUids:null}){return e?(e instanceof a.h?(function(e,t){e.graphicUids||(e.graphicUids=new Set),e.graphicUids.add(t)}(i,this._getGraphicFilterUid(e)),0===t&&((0,u.r)(this.graphicsView)&&e.layer===this?bL(i,this.graphicsView.graphics3d.layer.id):e.layer&&bL(i,e.layer.uid))):"forEach"in e?e.forEach((e=>{Array.isArray(e)?this._externalToInternalRenderItems(e,t,i):l.L.isCollection(e)?e===this.graphics&&(0,u.r)(this.graphicsView)?bL(i,this.graphicsView.graphics3d.layer.id):this._externalToInternalRenderItems(e,t,i):e instanceof o.A?e===this.map.ground&&bL(i,S.be):this._externalToInternalRenderItems(e,t,i)})):bL(i,e.uid),i):i}_initBasemapTerrain(){this._set("basemapTerrain",new uM({view:this})),this._set("elevationProvider",new cS({view:this})),this.elevationProvider.register("ground",this.basemapTerrain)}_exitBasemapTerrain(){this.basemapTerrain&&(this.elevationProvider.unregister(this.basemapTerrain),this.elevationProvider.destroy(),this._set("elevationProvider",null),this.basemapTerrain.destroy(),this._set("basemapTerrain",null))}_initGlobe(){this._initCoordinateSystem(),this.state.createInitialCamera(),this._initBasemapTerrain(),this._set("pointsOfInterest",new $P({view:this})),this._set("featureTiles",new $C({renderCoordsHelper:this.renderCoordsHelper,cameraOnSurface:this.pointsOfInterest.contentCameraOnSurface,focus:this.pointsOfInterest.focus,tilingSchemeOwner:this.basemapTerrain,viewState:this.state,scheduler:this._resourceController.scheduler,terrain:this.basemapTerrain}));const e=()=>{const e=this.basemapTerrain&&this.basemapTerrain.extent;if(this.clippingArea||e)if(e&&this.basemapTerrain.spatialReference){const e=(0,b.o)(this.basemapTerrain.extent,this.basemapTerrain.spatialReference);this.clippingArea?this.featureTiles.filterExtent=e.intersection(this.clippingArea):this.featureTiles.filterExtent=e}else this.featureTiles.filterExtent=this.clippingArea;else this.featureTiles.filterExtent=null};this.handles.add([this.updatingHandles.add(Ih,"FEATURE_TILE_TREE_SHOW_TILES",(e=>{e&&this.featureTiles&&!this.featureTreeDebugger?this.updatingHandles.addPromise(Promise.all([i.e(9351),i.e(3868)]).then(i.bind(i,53868))).then((({FeatureTileTree3DDebugger:e})=>{!this.featureTreeDebugger&&Ih.FEATURE_TILE_TREE_SHOW_TILES&&(this.featureTreeDebugger=new e({view:this}))})):e||!this.featureTreeDebugger||Ih.FEATURE_TILE_TREE_SHOW_TILES||(this.featureTreeDebugger.destroy(),this.featureTreeDebugger=null)}),3),this.updatingHandles.add(this,"clippingArea",e,3),this.updatingHandles.add(this,"basemapTerrain.extent",e,3)],"feature-tiles"),this.stateManager.init()}_exitGlobe(){this.state&&(this.stateManager.deinit(),this.handles.remove("render-coords-helper"),this.handles.remove("feature-tiles"),this.featureTiles.destroy(),this._set("featureTiles",null),this.pointsOfInterest.destroy(),this._set("pointsOfInterest",null),this._exitBasemapTerrain(),this.state.exit(),this._exitCoordinateSystem())}_initCoordinateSystem(){if(this.spatialReference){const e=this.spatialReference;this.mapCoordsHelper&&this.mapCoordsHelper.spatialReference.equals(e)||this._set("mapCoordsHelper",new gS(this.map,e));const t=this.state.isGlobal,i=t?(0,x.e)(e):e;i!==this.renderSpatialReference&&(this._set("renderCoordsHelper",TS.create(this.state.viewingMode,i)),t||this.handles.add(this.watch("basemapTerrain.extent",(e=>{0===e[0]&&0===e[1]&&0===e[2]&&0===e[3]||(this.renderCoordsHelper.extent=e)}),!0),"render-coords-helper"),this.sceneIntersectionHelper&&this.sceneIntersectionHelper.setTolerance(sn.DEFAULT_TOLERANCE/this.renderCoordsHelper.unitInMeters))}else this._set("mapCoordsHelper",null),this._set("renderCoordsHelper",null)}_exitCoordinateSystem(){this.mapCoordsHelper&&(this.handles.remove("render-coords-helper"),this._set("renderCoordsHelper",null),this._set("mapCoordsHelper",null))}updatingChanged(){this.notifyChange("updating")}_updateUpdatingMonitors(e=null){(0,u.r)(e)&&4===e.type||(this.handles.remove("updatingMonitors"),this.allLayerViews.forEach((e=>{e.destroyed||(this.handles.add([e.watch(["updating","updatingProgress"],(()=>this.updatingChanged()),!0)],"updatingMonitors"),e.when((()=>this.updatingChanged()),(()=>this.updatingChanged())))})),this.updatingChanged())}_renderScreenshotOverlay(e,t){if(!this.overlay||!this.overlay.hasVisibleItems)return t;const i=e.getContext("2d");return i.putImageData(t,0,0),this.overlay.renderCanvas(e),i.getImageData(0,0,t.width,t.height)}_initStage(){const e={renderContext:this.renderContext,deactivatedWebGLExtensions:this.deactivatedWebGLExtensions,debugWebGLExtensions:this.debugWebGLExtensions,alpha:this.alphaCompositingEnabled,canvas:this.renderCanvas,screenshot:{renderOverlay:(e,t)=>this._renderScreenshotOverlay(e,t)}},t=new JT(this.state.viewingMode,{forEachLayer:e=>this._stage.layers.forAll(e)},this);this._set("sceneIntersectionHelper",t);const i=(0,c.c)(this.surface),{resourceController:r,state:s,renderSpatialReference:n}=this;this._stage=new uL({resourceController:r,container:i,options:e,state:s,sceneIntersectionHelper:t,renderSR:n}),this._lostWebGLContextHandle=(0,h.r)(this._stage.renderView.canvas,"webglcontextlost",(()=>this.fatalError=new h.s("webgl-context-lost"))),this.handles.add([this.updatingHandles.add(this.qualitySettings,"antialiasingEnabled",(()=>{this._stage.renderView.setRenderParameters({antialiasingEnabled:this.qualitySettings.antialiasingEnabled})}),2),this.updatingHandles.add(this.qualitySettings,"highQualityTransparency",(()=>{this._stage.renderView.setRenderParameters({highQualityTransparency:this.qualitySettings.highQualityTransparency})}),2),(0,p.d)(this,"magnifier",(e=>this._stage.renderView.magnifier=e),!0)],"stage");const a=()=>{this._stage.renderView.setRenderParameters({defaultHighlightOptions:fS.toEngineOptions(this.highlightOptions)})};for(const e of["highlightOptions","highlightOptions.color","highlightOptions.haloColor","highlightOptions.haloOpacity","highlightOptions.fillOpacity","highlightOptions.shadowOpacity","highlightOptions.shadowColor","highlightOptions.shadowDifference"])this.handles.add(this.updatingHandles.add(this,e,a),"stage");a(),this.renderCoordsHelper&&this.sceneIntersectionHelper.setTolerance(sn.DEFAULT_TOLERANCE/this.renderCoordsHelper.unitInMeters),this._set("canvas",this._stage.renderView.canvas)}_exitStage(){this._set("sceneIntersectionHelper",null),this._stage.destroy(),this._stage=null,this._lostWebGLContextHandle.remove(),this._lostWebGLContextHandle=null,this.handles.remove("stage"),this._set("canvas",null)}_initSurface(e){this._exitSurface(),this.state.init(e,this.spatialReference),this._initStage(),this._initGlobe(),this.sharedSymbolResources=new vP({view:this,viewingMode:e,resourceController:this._resourceController,pointsOfInterest:this.pointsOfInterest,viewState:this.state,objectResourceCache:new lC})}_exitSurface(){this.sharedSymbolResources&&(this.sharedSymbolResources.objectResourceCache.destroy(),this.sharedSymbolResources.destroy(),this.sharedSymbolResources=null,this._exitGlobe(),this._exitStage())}_createGraphicsViewIfNeeded(){if(this.graphicsView||this._createGraphicsViewController)return;if(0===this.graphics.length)return;this.handles.remove("graphics-view"),this._createGraphicsViewController=(0,h.h)();const e=()=>{this._createGraphicsViewController=null,this.updatingChanged()};this._createGraphicsViewAsync(this._createGraphicsViewController.signal).then(e,e),this.updatingChanged()}async _createGraphicsViewAsync(e){const t=(await Promise.all([i.e(9351),i.e(3284)]).then(i.bind(i,43284))).default;(0,h.a)(e),await(0,p.x)(this.basemapTerrain,"ready",e),this._set("graphicsView",new t({view:this}))}_disposeGraphicsView(){this._createGraphicsViewController&&(this._createGraphicsViewController.abort(),this._createGraphicsViewController=null),this.handles.remove("graphics-view"),(0,u.r)(this.graphicsView)&&(this.handles.remove(this.graphicsView.graphics3d.layer.id),this.graphicsView.destroy(),this._set("graphicsView",null))}_startup(){const e=si(this.viewingMode);if(1===e&&(this._clippingArea=null),this._set("ready",!0),this._initSurface(e),this.handles.add((0,p.C)(this,"graphics","after-changes",(()=>this._createGraphicsViewIfNeeded())),"graphics-view"),this._createGraphicsViewIfNeeded(),!this._externallySet.environment){const e=this.get("map.initialViewProperties.environment");e&&(this.environment=e)}this.labeler.setup(),this.environmentManager.connectView(this),this.inputManager.connect();const t=this._resolveWhenReady;this._resolveWhenReady=[],t.forEach((e=>e(this)))}_teardown(){this._initialDefaultSpatialReference=null,this.inputManager.disconnect(),this.environmentManager.disconnectView(),this.labeler.dispose(),this._disposeGraphicsView(),this.handles.remove("graphics-view"),this._exitSurface(),this._set("ready",!1)}_updateDefaultToMapOptions(){if(this._defaultToMapOptions.include.clear(),this.map){this.map.ground&&this._defaultToMapOptions.include.add(S.be);for(const e of this.map.allLayers.items)"integrated-mesh"===e.type&&this._defaultToMapOptions.include.add(e.uid)}}_updateDefaultHitTestOptions(){if(this._defaultHitTestOptions.exclude.clear(),this.map){this.map.ground&&this.map.ground.opacity<1&&this._defaultHitTestOptions.exclude.add(S.be);for(const e of this.map.allLayers.items)"integrated-mesh"===e.type&&e.opacity<1&&this._defaultToMapOptions.exclude.add(e.uid)}}};function bL(e,t){e.layerUids||(e.layerUids=new Set),e.layerUids.add(t)}(0,r.e)([(0,d.y)()],xL.prototype,"_resourceController",void 0),(0,r.e)([(0,d.y)()],xL.prototype,"_stage",void 0),(0,r.e)([(0,d.y)({readOnly:!0})],xL.prototype,"deconflictor",void 0),(0,r.e)([(0,d.y)({readOnly:!0})],xL.prototype,"labeler",void 0),(0,r.e)([(0,d.y)({type:s.n,readOnly:!0,aliasOf:"state.animation"})],xL.prototype,"animation",void 0),(0,r.e)([(0,d.y)({readOnly:!0})],xL.prototype,"basemapTerrain",void 0),(0,r.e)([(0,d.y)({readOnly:!0})],xL.prototype,"elevationProvider",void 0),(0,r.e)([(0,d.y)({type:s.R,aliasOf:"stateManager.camera"})],xL.prototype,"camera",void 0),(0,r.e)([(0,d.y)({type:s.R,aliasOf:"stateManager.contentCamera"})],xL.prototype,"contentCamera",void 0),(0,r.e)([(0,d.y)({readOnly:!0})],xL.prototype,"canvas",void 0),(0,r.e)([(0,d.y)({type:g.b,aliasOf:"stateManager.center"})],xL.prototype,"center",void 0),(0,r.e)([(0,d.y)({type:A.M,dependsOn:["map.clippingArea?","map.clippingEnabled?","viewingMode"]})],xL.prototype,"clippingArea",null),(0,r.e)([(0,d.y)({type:Ti})],xL.prototype,"constraints",void 0),(0,r.e)([(0,d.y)({type:A.M,dependsOn:["basemapTerrain.extent","clippingArea","map"],readOnly:!0})],xL.prototype,"dataExtent",null),(0,r.e)([(0,d.y)({value:null,type:Zi})],xL.prototype,"environment",null),(0,r.e)([(0,g.c)("environment")],xL.prototype,"castEnvironment",null),(0,r.e)([(0,d.y)({readOnly:!0})],xL.prototype,"environmentManager",void 0),(0,r.e)([(0,d.y)({type:A.M,aliasOf:"stateManager.extent"})],xL.prototype,"extent",void 0),(0,r.e)([(0,d.y)()],xL.prototype,"floors",void 0),(0,r.e)([(0,d.y)({readOnly:!0,aliasOf:"stateManager.screenCenter"})],xL.prototype,"screenCenter",void 0),(0,r.e)([(0,d.y)({type:Number})],xL.prototype,"pixelRatio",null),(0,r.e)([(0,d.y)({type:Number,dependsOn:["qualitySettings.maximumPixelRatio","qualitySettings.maximumRenderResolution","size"]})],xL.prototype,"maximumPixelRatio",null),(0,r.e)([(0,d.y)({aliasOf:"stateManager.frustum"})],xL.prototype,"frustum",void 0),(0,r.e)([(0,d.y)({type:Number,readOnly:!0})],xL.prototype,"fullOpacity",void 0),(0,r.e)([(0,d.y)({readOnly:!0})],xL.prototype,"graphicsView",void 0),(0,r.e)([(0,d.y)({type:A.M,dependsOn:["basemapTerrain.extent"],readOnly:!0})],xL.prototype,"groundExtent",null),(0,r.e)([(0,d.y)()],xL.prototype,"groundView",void 0),(0,r.e)([(0,d.y)({type:Boolean})],xL.prototype,"initialExtentRequired",null),(0,r.e)([(0,d.y)({type:Boolean,readOnly:!0})],xL.prototype,"interacting",null),(0,r.e)([(0,d.y)()],xL.prototype,"stationary",null),(0,r.e)([(0,d.y)({aliasOf:"state.navigating"})],xL.prototype,"navigating",void 0),(0,r.e)([(0,d.y)()],xL.prototype,"map",void 0),(0,r.e)([(0,d.y)({readOnly:!0})],xL.prototype,"mapCoordsHelper",void 0),(0,r.e)([(0,d.y)({aliasOf:"stateManager.padding"})],xL.prototype,"padding",void 0),(0,r.e)([(0,d.y)({type:$P,readOnly:!0})],xL.prototype,"pointsOfInterest",void 0),(0,r.e)([(0,d.y)({type:$C,readOnly:!0})],xL.prototype,"featureTiles",void 0),(0,r.e)([(0,d.y)()],xL.prototype,"featureTreeDebugger",void 0),(0,r.e)([(0,d.y)({type:Boolean})],xL.prototype,"screenSizePerspectiveEnabled",void 0),(0,r.e)([(0,d.y)({constructOnly:!0})],xL.prototype,"deactivatedWebGLExtensions",void 0),(0,r.e)([(0,d.y)({constructOnly:!0})],xL.prototype,"debugWebGLExtensions",void 0),(0,r.e)([(0,d.y)({constructOnly:!0})],xL.prototype,"renderCanvas",void 0),(0,r.e)([(0,d.y)({constructOnly:!0})],xL.prototype,"state",void 0),(0,r.e)([(0,d.y)({readOnly:!0})],xL.prototype,"inputManager",void 0),(0,r.e)([(0,d.y)({readOnly:!0})],xL.prototype,"stateManager",void 0),(0,r.e)([(0,d.y)({type:["low","medium","high"]})],xL.prototype,"qualityProfile",null),(0,r.e)([(0,d.y)({type:CS,get(){let e=this._get("qualitySettings");return e||(e=new CS,pS.apply(this.qualityProfile,e)),e}})],xL.prototype,"qualitySettings",void 0),(0,r.e)([(0,d.y)()],xL.prototype,"slicePlane",null),(0,r.e)([(0,d.y)({dependsOn:["viewingMode"]})],xL.prototype,"preconditionsReady",void 0),(0,r.e)([(0,d.y)({readOnly:!0})],xL.prototype,"renderCoordsHelper",void 0),(0,r.e)([(0,d.y)({readOnly:!0})],xL.prototype,"sceneIntersectionHelper",void 0),(0,r.e)([(0,d.y)({type:Number,dependsOn:["scale","spatialReference"],readOnly:!0})],xL.prototype,"resolution",null),(0,r.e)([(0,d.y)({type:Number,aliasOf:"stateManager.scale"})],xL.prototype,"scale",void 0),(0,r.e)([(0,d.y)({dependsOn:[]})],xL.prototype,"heightModelInfo",null),(0,r.e)([(0,d.y)({dependsOn:["map.initialViewProperties?.spatialReference","defaultsFromMap.isSpatialReferenceDone"]})],xL.prototype,"spatialReference",void 0),(0,r.e)([(0,d.y)({type:Boolean,constructOnly:!0})],xL.prototype,"alphaCompositingEnabled",void 0),(0,r.e)([(0,d.y)({type:Boolean})],xL.prototype,"supersampleScreenhotsEnabled",void 0),(0,r.e)([(0,d.y)({readOnly:!0})],xL.prototype,"type",void 0),(0,r.e)([(0,d.y)({type:yL})],xL.prototype,"ui",void 0),(0,r.e)([(0,d.y)({type:Boolean,readOnly:!0,dependsOn:["graphicsView.updating","basemapView.updating","basemapTerrain.updating","layerViewManager.updating","layerViewManager.updatingRemaining","_resourceController.updating","_stage.updating","featureTiles.updating","pointsOfInterest.updating","environmentManager.updating","overlay.updating","updatingHandles.updating","featureTreeDebugger.updating","labeler.updating","deconflictor.updating","ready","stationary","inputManager.hasPendingInputs","toolViewManager.updating"]})],xL.prototype,"updating",null),(0,r.e)([(0,d.y)({type:Number,readOnly:!0,dependsOn:["updating"]})],xL.prototype,"updatingProgress",void 0),(0,r.e)([(0,d.y)({type:["global","local"],dependsOn:["map.initialViewProperties?.viewingMode","spatialReference"]})],xL.prototype,"viewingMode",null),(0,r.e)([(0,d.y)({type:s.u,aliasOf:"stateManager.viewpoint"})],xL.prototype,"viewpoint",void 0),(0,r.e)([(0,d.y)({type:Number,aliasOf:"stateManager.zoom"})],xL.prototype,"zoom",void 0),(0,r.e)([(0,d.y)({type:fS})],xL.prototype,"highlightOptions",void 0),xL=(0,r.e)([(0,d.n)("esri.views.SceneView")],xL);const wL=(0,v.n)(),CL=(0,f.i)();var TL=xL}}]);