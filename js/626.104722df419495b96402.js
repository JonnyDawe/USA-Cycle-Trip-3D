(self.webpackChunk=self.webpackChunk||[]).push([[626],{90626:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>p}),i(33807);var s=i(78155),r=i(20215),n=i(36845),a=i(88903),l=i(80219),o=i(80987),h=i(60816),d=i(63358),c=i(32422),u=i(50822);function _(e){return(0,d.a)(`esri/libs/vxl/${e}`)}i(98548),i(20736),i(4169),i(92858),i(31531),i(71391),i(83731),i(40130),i(55688),i(15015),i(31516),i(95629),i(9612),i(52109),i(6585),i(3621),i(76326),i(4807),i(17762),i(30316),i(29126),i(61888),i(18559),i(32769),i(42296),i(17331),i(41290),i(62121),i(91236),i(82906),i(52957),i(82361),i(65352),i(71394),i(73574),i(81135),i(94527),i(29832),i(89710),i(13564),i(95559),i(68631),i(56803),i(18143),i(47365),i(67079),i(2903),i(85570),i(71470),i(80136),i(91507),i(85289),i(98843),i(91790),i(52737),i(29831),i(16040),i(34396),i(5250),i(49878),i(84271),i(48643),i(4618),i(80657),i(94449),i(97325),i(3629),i(79506),i(26779),i(98420),i(54223),i(8725),i(51218),i(21793),i(13895),i(15576),i(28941),i(19438),i(15022),i(56416),i(92758),i(78435),i(53902),i(40481),i(78730),i(2570),i(71666),i(72257),i(41822),i(99987),i(11838),i(39068),i(24776),i(95186),i(67726),i(59312),i(7571),i(93242),i(58404),i(79679),i(71542),i(16063),i(43194),i(62654),i(15346),i(65311),i(72105),i(53185),i(60183),i(93875),i(14215),i(20868),i(72600),i(334),i(37762),i(92722),i(25290),i(7552),i(78082),i(27270),i(37191),i(30665),i(28090),i(84796),i(87405),i(84320),i(93450),i(97431),i(32892),i(41374),i(86897),i(41392),i(79949),i(6660),i(6783),i(75200),i(29218),i(49293),i(30494);const g=l.n.getLogger(" esri.layers.VoxelWasmPerScene");class x{constructor(e){this._useDepthPass=!1,this._havePreparedWithAllLayers=!1,this._renderPluginContext=null,this._vxl=null,this._pluginIsActive=!1,this._moreToLoad=!1,this._viewportWidth=-1,this._viewportHeight=-1,this._newLayers=[],this._layers=new Map,this._renderPass=0,this._renderSlot=4,this._rctx=null,this._renderTargetToRestore=null,this._dbgFlags=new Set,this._dbgFlags.add(4),this._view=e,this.initialize()}get canRender(){return!!this._vxl&&"local"===this._view.viewingMode}dbg(e,t){this._dbgFlags.has(e)&&(4===e?g.error(t):g.warn(t))}removeRenderPlugin(){this._pluginIsActive&&this._view._stage&&(this.dbg(1,"--removeRenderPlugin--"),this._view._stage.removeRenderPlugin(this)),this._pluginIsActive=!1}initialize(){this.dbg(1,"--initialize--"),this._readyWatchHandle=(0,n.d)(this._view,"ready",(e=>{e&&"local"===this._view.viewingMode?(this.dbg(1,"view ready status changed to ready on a local view, calling addRenderPlugin"),this._view._stage.addRenderPlugin([this._renderSlot],this),this._pluginIsActive=!0):(this.dbg(1,"view ready status changed, not ready or not a local view!"),this.removeRenderPlugin())})),this._qualityWatchHandle=(0,n.d)(this._view,"qualityProfile",(e=>{this.dbg(3,"qualityProfile changed to "+e),this._vxl&&this._vxl.set_quality(this.toWasmQuality(e))}))}initializeRenderContext(e){this.dbg(1,"--initializeRenderContext--");const t=e.renderContext.rctx;"webgl2"===t.webglVersion?(this._renderPluginContext=e,this._rctx=e.renderContext.rctx,this.initializeWasm(t.gl)):this.dbg(4,"WebGL 1 context only!")}uninitializeRenderContext(){this._renderPluginContext=null,this._rctx=null,this.dbg(1,"--uninitializeRenderContext--")}restoreFramebuffer(){if(!this._renderTargetToRestore)return;const e=this._renderTargetToRestore.fbo;if(!this._rctx)return void this.dbg(4,"no context in restoreFramebuffer!");this._rctx.bindFramebuffer(e,!0);const t=this._renderTargetToRestore.viewport;this._rctx.setViewport(t.x,t.y,t.width,t.height)}bindPreviousDepthToSlot(e,t){const i=!!this._rctx,s=!!this._renderTargetToRestore;if(!i||!s)return 0;const r=this._renderTargetToRestore.fbo.depthStencilTexture;return r?(0===t?this._rctx.bindTexture(null,e,!0):this._rctx.bindTexture(r,e,!0),1):(this.dbg(4,"no depth/stencil texture exists!"),0)}setBlendState(e,t,i,s){this._rctx?(this._rctx.setBlendingEnabled(1===e),this._rctx.setBlendFunction(t,i),this._rctx.setBlendEquation(s)):this.dbg(4,"setBlendState callback has no rendering context!")}setFrontFace(e){this._rctx?this._rctx.setFrontFace(e):this.dbg(4,"setFrontFace callback has no rendering context!")}setDepthStencilStateFunction(e,t,i){this._rctx?(this._rctx.setDepthFunction(i),this._rctx.setDepthTestEnabled(1===e),this._rctx.setDepthWriteEnabled(1===t),this._rctx.setStencilTestEnabled(!1),this._rctx.setStencilFunction(519,0,255),this._rctx.setStencilOpSeparate(1028,7680,7682,7680),this._rctx.setStencilOpSeparate(1029,7680,7683,7680)):this.dbg(4,"setDepthStencilStateFunction callback has no rendering context!")}setRasterizerState(e){if(this._rctx)switch(e){case 1:this._rctx.setFaceCullingEnabled(!1);break;case 3:this._rctx.setCullFace(1029),this._rctx.setFaceCullingEnabled(!0);break;case 2:this._rctx.setCullFace(1028),this._rctx.setFaceCullingEnabled(!0)}else this.dbg(4,"setRasterizerState callback has no rendering context!")}setViewport(e,t,i,s){this._rctx?this._rctx.setViewport(e,t,i,s):this.dbg(4,"setViewport callback has no rendering context!")}syncRequestsResponses(){this._layers.forEach(((e,t)=>{const i=[];e.responses.forEach(((e,s)=>{i.push(s),this.dbg(2,"responding for requestID:"+s+" size:"+e.size),this._vxl.respond(t,s,e)}));const s=e.responses;for(const e of i)s.delete(e);const n=this._vxl.get_new_requests(t),a=e.abortController.signal;for(const t in n){e.outstandingRequestCount+=1,1===e.outstandingRequestCount&&e.layerView.updatingFlagChanged();const i=n[t],l={responseType:"array-buffer",signal:a};this.dbg(2,"making requestID:"+t+" url:"+i.url),(0,o.L)(i.url,l).then((r=>{e.outstandingRequestCount-=1,0===e.outstandingRequestCount&&e.layerView.updatingFlagChanged(),this.dbg(2,"have response for requestID:"+t);let n=0;if(r.data.byteLength>0){n=this._vxl._malloc(r.data.byteLength);const e=new Uint8Array(this._vxl.HEAPU8.buffer,n,r.data.byteLength),t=new Uint8Array(r.data);for(let i=0;i<r.data.byteLength;++i)e[i]=t[i]}s.set(+t,{type:i.type,ptr:n,size:r.data.byteLength,success:!0})})).catch((n=>{e.outstandingRequestCount-=1,0===e.outstandingRequestCount&&e.layerView.updatingFlagChanged(),(0,r.g)(n)||(this.dbg(4,"requestID:"+t+" failed"),s.set(+t,{type:i.type,ptr:0,size:0,success:!1}))}))}}))}updateWasmCamera(e){this._vxl.set_projection_matrix.apply(this._vxl,e.projectionMatrix),this._vxl.set_view_matrix.apply(this._vxl,e.viewMatrix),this._vxl.set_near_far(e.near,e.far)}isUpdating(e){return!(this._vxl||!this._vxlPromise)||!!this._layers.has(e)&&this._layers.get(e).outstandingRequestCount>0}setEnabled(e,t){this._layers.forEach(((i,s)=>{i.layerView===e&&(this._vxl.set_enabled(s,t?1:0),this._renderPluginContext.requestRender())}))}addVoxelLayer(e){if(!this._vxl){const t={layerView:e,resolveCallback:"",rejectCallback:""},i=new Promise(((e,i)=>{t.resolveCallback=e,t.rejectCallback=i}));return this._newLayers.push(t),i}const t=this._addVoxelLayer(e);return t<0?Promise.reject(-1):Promise.resolve(t)}removeVoxelLayer(e){if(!this._vxl){const t=this._newLayers.findIndex((t=>e===t.layerView));t>=0&&(this._newLayers[t].resolveCallback(-1),this._newLayers.splice(t,1));const i=this._newLayers.length;return 0===i&&(this.dbg(1," no voxel layers left after removing a layer, removing RenderPlugin and destroying"),this.destroy()),i}let t=-1;this._layers.forEach(((i,s)=>{i.layerView===e&&(t=s,i.abortController.abort(),this._vxl.remove_layer(t))})),t>=0&&this._layers.delete(t);const i=this._layers.size;return 0===i&&(this.dbg(1," no voxel layers left after removing a layer, removing RenderPlugin and destroying"),this.destroy()),i}_addVoxelLayer(e){const t=e.layer;let i=-1;const s=t.layerData;if(s&&s.data.byteLength>0){const e=this._vxl._malloc(s.data.byteLength),r=new Uint8Array(this._vxl.HEAPU8.buffer,e,s.data.byteLength),n=new Uint8Array(s.data);for(let e=0;e<s.data.byteLength;++e)r[e]=n[e];const a=32662===this._view.spatialReference.wkid&&t.spatialReference.isWGS84?111319.49079327357:1;i=this._vxl.add_layer(t.serviceRoot,e,s.data.byteLength,a,a),this._vxl._free(e)}if(i>=0){const t=(0,r.h)();return this._layers.set(i,{layerView:e,responses:new Map,outstandingRequestCount:0,abortController:t}),i}return-1}prepareRender(e){if(!this._vxl)return;const t=e.viewForward,i=e.eye;this._vxl.update_camera_pos_and_direction(i[0],i[1],i[2],t[0],t[1],t[2]);const s=this._vxl.cull();this.dbg(2,"missingResourceCount="+s),this._moreToLoad=s>0,this._havePreparedWithAllLayers=0===this._newLayers.length}render(e){if(!this._vxl)return!1;for(const e of this._newLayers){const t=this._addVoxelLayer(e.layerView);-1===t?e.rejectCallback(-1):e.resolveCallback(t)}if(this._newLayers=[],e.pass!==this._renderPass)return!1;if(e.slot!==this._renderSlot)return!1;if(0===this._layers.size)return this.dbg(4,"No voxel layers but RenderPlugin instance is being asked to render!"),!0;this._renderTargetToRestore={fbo:this._rctx.getBoundFramebufferObject(),viewport:this._rctx.getViewport()},this.syncRequestsResponses(),this._vxl.begin_frame();const t=this._renderTargetToRestore.viewport;return t.width===this._viewportWidth&&t.height===this._viewportHeight||(this._viewportWidth=t.width,this._viewportHeight=t.height,this._vxl.set_viewport(t.width,t.height)),0===t.x&&0===t.y||this.dbg(4,"Unsupported viewport parameters detected!"),this.updateWasmCamera(e.camera),this._vxl.draw(),this._renderTargetToRestore.fbo=null,e.rctx.externalTextureUnitUpdate(this._vxl.get_texture_units_bound_in_frame(),this._vxl.get_active_texture_unit()),e.rctx.externalVertexArrayObjectUpdate(),e.rctx.externalVertexBufferUpdate(),(this._moreToLoad||!this._havePreparedWithAllLayers&&this._layers.size>0)&&this._renderPluginContext.requestRender(),!0}queryDepthRange(e){this.dbg(1,"--queryDepthRange--");const t=e.viewForward,i=e.eye;this._vxl.update_camera_pos_and_direction(i[0],i[1],i[2],t[0],t[1],t[2]),this._vxl.cull();const s={near:5,far:1e4};return s.near=this._vxl.get_near(),s.far=this._vxl.get_far(),s}destroy(){this.dbg(1,"--destroy--"),this.removeRenderPlugin(),this._readyWatchHandle&&(this._readyWatchHandle.remove(),this._readyWatchHandle=null),this._qualityWatchHandle&&(this._qualityWatchHandle.remove(),this._qualityWatchHandle=null),this._vxl&&(this._vxl.uninitialize_voxel_wasm(),this._vxl=null)}initializeWasm(e){return this._vxl?Promise.resolve():(this._vxlPromise||(this._vxlPromise=function(e){return new Promise((t=>i.e(3940).then(i.bind(i,40886)).then((function(e){return e.v})).then((({default:i})=>{const s=i({locateFile:_,preinitializedWebGLContext:e,onRuntimeInitialized:()=>t(s)})})))).catch((e=>Promise.reject(e)))}(e).then((e=>{if(this._vxl=e,this._vxlPromise=null,this._newLayers.length<=0)return this.dbg(1," no voxel layers left after WASM downloaded, removing RenderPlugin and destroying"),void this.destroy();const t=this._vxl.addFunction(this.restoreFramebuffer.bind(this),"v"),i=this._vxl.addFunction(this.setBlendState.bind(this),"viiii"),s=this._vxl.addFunction(this.setFrontFace.bind(this),"vi"),r=this._vxl.addFunction(this.setRasterizerState.bind(this),"vi"),n=this._vxl.addFunction(this.setDepthStencilStateFunction.bind(this),"viii"),a=this._vxl.addFunction(this.setViewport.bind(this),"viiii"),l=this._vxl.addFunction(this.bindPreviousDepthToSlot.bind(this),"iii");this._vxl.initialize_voxel_wasm(t,i,s,r,n,a,l),this._vxl.set_quality(this.toWasmQuality(this._view.qualityProfile)),this._renderPluginContext&&this._renderPluginContext.requestRender()})).catch((()=>{for(const e of this._newLayers)e.rejectCallback(-2);this.dbg(4," WASM failed to download, removing RenderPlugin and destroying"),this.destroy()}))),this._vxlPromise)}get type(){return"external"}get isGround(){return!1}get slicePlane(){return!1}get intersectionHandlerId(){return"unj"}intersect(e,t,i,s,r){if(!this._vxl)return;if(!this._rctx)return;if(0===this._layers.size)return;if(r[0]<0||r[0]>e.camera.viewport[2]||r[1]<0||r[1]>e.camera.viewport[3])return;this._renderTargetToRestore={fbo:this._rctx.getBoundFramebufferObject(),viewport:this._rctx.getViewport()};const n=e.camera.viewForward,a=e.camera.eye;this._vxl.update_camera_pos_and_direction(a[0],a[1],a[2],n[0],n[1],n[2]),this.updateWasmCamera(e.camera),this._vxl.begin_frame(),this._useDepthPass?this.intersectDepth(e,t,i,s,r):this.intersectObject(e,t,i,s,r),this._renderTargetToRestore.fbo=null,this._rctx.externalTextureUnitUpdate(this._vxl.get_texture_units_bound_in_frame(),this._vxl.get_active_texture_unit()),this._rctx.externalVertexArrayObjectUpdate(),this._rctx.externalVertexBufferUpdate()}intersectObject(e,t,i,s,r){const n=this._vxl.pick_object(r[0],r[1]);if(n.success){const r=(0,h.n)();(0,h.J)(r,s,i),(0,h.j)(r,r);const a=(0,h.q)(i,s),l=(0,h.n)();(0,h.a)(l,n.worldX,n.worldY,n.worldZ);const o=(0,h.n)();(0,h.J)(o,l,i);const d=(0,h.n)();(0,h.d)(d,r,(0,h.z)(o,r));const u=(0,h.n)();(0,h.u)(u,i,d);const _=(0,h.q)(i,u),g=(0,h.o)(_/a,0,1),x=e=>{e.intersector="Voxel",e.dist=g,e.target={type:"external",metadata:{layerUid:this.intersectionHandlerId}}},v=e.results.min;(null==v.dist||g<v.dist)&&(null==t||t(i,s,g))&&x(v);const y=e.results.max;if(0!==e.options.store&&(null==y.dist||g>y.dist)&&(null==t||t(i,s,g))&&x(y),2===e.options.store){const t=new c.C(e.ray);x(t),e.results.all.push(t)}}}intersectDepth(e,t,i,s,r){const n=this._vxl.pick_depth(r[0],r[1]);if(n.success){const r=(0,h.n)();(0,h.J)(r,s,i),(0,h.j)(r,r);const a=(0,h.q)(i,s),l=(0,h.n)();(0,h.a)(l,n.worldX,n.worldY,n.worldZ);const o=(0,h.n)();(0,h.J)(o,l,i);const d=(0,h.n)();(0,h.d)(d,r,(0,h.z)(o,r));const u=(0,h.n)();(0,h.u)(u,i,d);const _=(0,h.q)(i,u),g=(0,h.o)(_/a,0,1),x=e=>{e.intersector="Voxel",e.dist=g,e.target={type:"external",metadata:{layerUid:this.intersectionHandlerId}}},v=e.results.min;(null==v.dist||g<v.dist)&&(null==t||t(i,s,g))&&x(v);const y=e.results.max;if(0!==e.options.store&&(null==y.dist||g>y.dist)&&(null==t||t(i,s,g))&&x(y),2===e.options.store){const t=new c.C(e.ray);x(t),e.results.all.push(t)}}}toWasmQuality(e){switch(e){case"low":return 0;case"medium":return 1;case"high":return 2}}}class v{constructor(){this.view2WASM=new Map}static getInstance(){return v.instance||(v.instance=new v),v.instance}isUpdating(e,t){return!!this.view2WASM.has(e)&&this.view2WASM.get(e).isUpdating(t)}addLayer(e,t){return this.view2WASM.has(e)||this.view2WASM.set(e,new x(e)),this.view2WASM.get(e).addVoxelLayer(t)}removeLayer(e,t){this.view2WASM.has(e)&&this.view2WASM.get(e).removeVoxelLayer(t)<1&&this.view2WASM.delete(e)}setLayerEnabled(e,t,i){this.view2WASM.has(e)&&this.view2WASM.get(e).setEnabled(t,i)}}let y=class extends((0,c.m)(u.d)){constructor(){super(...arguments),this.type="voxel-3d",this._wasmLayerId=-1}initialize(){if("local"!==this.view.viewingMode)throw new r.s("voxel:unsupported-viewingMode","Voxel layers support local viewingMode only.",{});if("webgl"===this.view.renderContext)throw new r.s("voxel:unsupported-context","Voxel layers are supported in WebGL2 rendering contexts only.",{});const e=v.getInstance(),t=e.addLayer(this.view,this).then((e=>{this._wasmLayerId=e,this._suspendedHandle=(0,n.d)(this,"suspended",(e=>{v.getInstance().setLayerEnabled(this.view,this,!e)}))})).catch((t=>{if(e.removeLayer(this.view,this),this._wasmLayerId=-1,-1===t)throw new r.s("voxel:addLayer-failure","The voxel layer description was invalid.",{});if(-2===t)throw new r.s("voxel:addLayer-failure","The voxel layer web assembly module failed to download.",{})}));this.addResolvingPromise(t)}destroy(){v.getInstance().removeLayer(this.view,this),this._suspendedHandle&&(this._suspendedHandle.remove(),this._suspendedHandle=null)}isUpdating(){return!(this._wasmLayerId<0)&&v.getInstance().isUpdating(this.view,this._wasmLayerId)}updatingFlagChanged(){this.notifyChange("updating")}};(0,s.e)([(0,a.y)()],y.prototype,"layer",void 0),(0,s.e)([(0,a.y)({readOnly:!0,aliasOf:"layer.parsedUrl.path"})],y.prototype,"baseUrl",void 0),y=(0,s.e)([(0,a.n)("esri.views.3d.layers.VoxelLayerView3D")],y);const p=y}}]);