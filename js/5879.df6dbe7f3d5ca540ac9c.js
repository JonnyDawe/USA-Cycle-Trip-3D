(self.webpackChunk=self.webpackChunk||[]).push([[5879],{5879:(e,t,a)=>{"use strict";a.r(t),a.d(t,{CIMSymbolRasterizer:()=>I,GeometryStyle:()=>y}),a(33807);var i=a(80987),r=a(20215),s=a(94527),n=a(80219),o=a(89710),l=a(98128),c=a(38088),h=(a(17762),a(81135));function m(e,t,a,i){if("CIMTextSymbol"!==e.type){if(a&&e.effects)for(const a of e.effects)g(a,t);if(e.symbolLayers)for(const a of e.symbolLayers)switch(a.type){case"CIMPictureMarker":case"CIMVectorMarker":f(a,t,i);break;case"CIMPictureStroke":case"CIMSolidStroke":null!=i&&i.preserveOutlineWidth||(a.width*=t);break;case"CIMPictureFill":a.height*=t,a.offsetX*=t,a.offsetY*=t;break;case"CIMHatchFill":m(a.lineSymbol,t,!0,{...i,preserveOutlineWidth:!1}),a.offsetX*=t,a.offsetY*=t,a.separation*=t}}else e.height*=t}function f(e,t,a){if(e.markerPlacement&&function(e,t){switch((0,l.s)(e)&&(e.offset*=t),e.type){case"CIMMarkerPlacementAlongLineRandomSize":case"CIMMarkerPlacementAlongLineSameSize":if(e.customEndingOffset*=t,e.offsetAlongLine*=t,e.placementTemplate&&e.placementTemplate.length){const a=e.placementTemplate.map((e=>e*t));e.placementTemplate=a}break;case"CIMMarkerPlacementAlongLineVariableSize":if(e.maxRandomOffset*=t,e.placementTemplate&&e.placementTemplate.length){const a=e.placementTemplate.map((e=>e*t));e.placementTemplate=a}break;case"CIMMarkerPlacementOnLine":e.startPointOffset*=t;break;case"CIMMarkerPlacementAtExtremities":e.offsetAlongLine*=t;break;case"CIMMarkerPlacementAtMeasuredUnits":case"CIMMarkerPlacementOnVertices":break;case"CIMMarkerPlacementAtRatioPositions":e.beginPosition*=t,e.endPosition*=t;break;case"CIMMarkerPlacementPolygonCenter":e.offsetX*=t,e.offsetY*=t;break;case"CIMMarkerPlacementInsidePolygon":e.offsetX*=t,e.offsetY*=t,e.stepX*=t,e.stepY*=t}}(e.markerPlacement,t),e.offsetX*=t,e.offsetY*=t,e.anchorPoint&&"Absolute"===e.anchorPointUnits&&(e.anchorPoint={x:e.anchorPoint.x*t,y:e.anchorPoint.y*t}),e.size*=t,"CIMVectorMarker"===e.type&&e.markerGraphics)for(const i of e.markerGraphics)e.scaleSymbolsProportionally||m(i.symbol,t,!0,a)}function g(e,t){switch(e.type){case"CIMGeometricEffectArrow":case"CIMGeometricEffectDonut":e.width*=t;break;case"CIMGeometricEffectBuffer":e.size*=t;break;case"CIMGeometricEffectCut":e.beginCut*=t,e.endCut*=t,e.middleCut*=t;break;case"CIMGeometricEffectDashes":if(e.customEndingOffset*=t,e.offsetAlongLine*=t,e.dashTemplate&&e.dashTemplate.length){const a=e.dashTemplate.map((e=>e*t));e.dashTemplate=a}break;case"CIMGeometricEffectExtension":case"CIMGeometricEffectJog":case"CIMGeometricEffectRadial":e.length*=t;break;case"CIMGeometricEffectMove":e.offsetX*=t,e.offsetY*=t;break;case"CIMGeometricEffectOffset":case"CIMGeometricEffectOffsetTangent":e.offset*=t;break;case"CIMGeometricEffectRegularPolygon":e.radius*=t;break;case"CIMGeometricEffectTaperedPolygon":e.fromWidth*=t,e.length*=t,e.toWidth*=t;break;case"CIMGeometricEffectWave":e.amplitude*=t,e.period*=t}}a(88903),a(98548),a(78155),a(20736),a(4169),a(92858),a(31531),a(29126),a(52957),a(50388),a(60816),a(58404),a(97431),a(28090),a(61888),a(29832),a(40130),a(31516),a(52109),a(6585),a(3621),a(63358);class u{constructor(){}rasterizeText(e,t){this._textRasterizationCanvas||(this._textRasterizationCanvas=document.createElement("canvas"));const a=this._textRasterizationCanvas,i=a.getContext("2d");this.setFontProperties(i,t),this.parameters=t,this.textLines=e.split(/\r?\n/),this.lineHeight=this.computeLineHeight();const r=this.computeTextWidth(i,t),s=this.lineHeight*this.textLines.length;a.width=r,a.height=s,this.renderedLineHeight=Math.round(this.lineHeight*t.pixelRatio),this.renderedHaloSize=t.halo.size*t.pixelRatio,this.renderedWidth=r*t.pixelRatio,this.renderedHeight=s*t.pixelRatio,this.fillStyle=function(e){return`rgba(${e.slice(0,3).toString()},${e[3]})`}(t.color),this.haloStyle=function(e){return`rgb(${e.slice(0,3).toString()})`}(t.halo.color);const n=this.renderedLineHeight,o=this.renderedHaloSize;this.setFontProperties(i,t);const l=function(e,t){return"center"===e?.5*t:"right"===e?t:0}(i.textAlign,this.renderedWidth)+o,c=o;let h=0,m=0;o>0&&this.renderHalo(i,l,c,h,m,t),m+=c,h+=l;for(const e of this.textLines)i.globalCompositeOperation="destination-out",i.fillStyle="rgb(0, 0, 0)",i.fillText(e,h,m),i.globalCompositeOperation="source-over",i.fillStyle=this.fillStyle,i.fillText(e,h,m),m+=n;const f=i.getImageData(0,0,this.renderedWidth,this.renderedHeight),g=new Uint8Array(f.data);if(t.premultiplyColors){let e;for(let t=0;t<g.length;t+=4)e=g[t+3]/255,g[t]=g[t]*e,g[t+1]=g[t+1]*e,g[t+2]=g[t+2]*e}return{size:[this.renderedWidth,this.renderedHeight],image:new Uint32Array(g.buffer),sdf:!1,simplePattern:!1,anchorX:0,anchorY:0}}renderHalo(e,t,a,i,r,s){const n=this.renderedWidth,o=this.renderedHeight;this._haloRasterizationCanvas||(this._haloRasterizationCanvas=document.createElement("canvas")),this._haloRasterizationCanvas.width=n,this._haloRasterizationCanvas.height=o;const l=this._haloRasterizationCanvas,c=l.getContext("2d");c.clearRect(0,0,n,o),this.setFontProperties(c,s),c.fillStyle=this.haloStyle,c.strokeStyle=this.haloStyle;const h=this.renderedHaloSize<3;c.lineJoin=h?"miter":"round",h?this.renderHaloEmulated(c,t,a):this.renderHaloNative(c,t,a),e.globalAlpha=this.parameters.halo.color[3],e.drawImage(l,0,0,n,o,i,r,n,o),e.globalAlpha=1}renderHaloEmulated(e,t,a){const i=this.renderedLineHeight,r=this.renderedHaloSize;for(const s of this.textLines){for(const[i,n]of d)e.fillText(s,t+r*i,a+r*n);a+=i}}renderHaloNative(e,t,a){const i=this.renderedLineHeight,r=this.renderedHaloSize;for(const s of this.textLines){const n=2*r,o=5,l=.1;for(let i=0;i<o;i++){const r=1-(o-1)*l+i*l;e.lineWidth=r*n,e.strokeText(s,t,a)}a+=i}}setFontProperties(e,t){const a=t.font,i=`${a.style} ${a.weight} ${(0,s.u)(t.size*t.pixelRatio)}px ${a.family}, sans-serif`;let r;switch(e.font=i,e.textBaseline="top",t.horizontalAlignment){case"left":r="left";break;case"right":r="right";break;case"center":r="center";break;default:r="left"}e.textAlign=r}computeTextWidth(e,t){let a=0;for(const t of this.textLines)a=Math.max(a,e.measureText(t).width);const i=t.font;return("italic"===i.style||"oblique"===i.style||"string"==typeof i.weight&&("bold"===i.weight||"bolder"===i.weight)||"number"==typeof i.weight&&i.weight>600)&&(a+=.3*e.measureText("A").width),a+=2*this.parameters.halo.size,Math.round(a)}computeLineHeight(){const e=1.275*this.parameters.size;return Math.round(e+2*this.parameters.halo.size)}}const d=[];{const e=16;for(let t=0;t<360;t+=360/e)d.push([Math.cos(Math.PI*t/180),Math.sin(Math.PI*t/180)])}var y,p;(p=y||(y={})).Legend="legend",p.Preview="preview";const M=(e,t,a)=>{if(e&&e.targetSize){let i;if(a){const t=Math.max(a.frame.xmax-a.frame.xmin,a.frame.ymax-a.frame.ymin);i=e.targetSize/(0,s.u)(t)}else i=e.targetSize/t.referenceSize;return i}return e&&e.scaleFactor?e.scaleFactor:1},C={fill:{legend:{frame:{xmax:15,xmin:0,ymax:15,ymin:0},geometry:{rings:[[[0,15],[15,7.5],[15,0],[0,0],[0,15]]]},canvasPaths:{rings:[[[0,15],[0,0],[15,7.5],[15,15],[0,15]]]}},preview:{frame:{xmax:100,xmin:0,ymax:100,ymin:0},geometry:{rings:[[[0,100],[100,100],[100,0],[0,0],[0,100]]]},canvasPaths:{rings:[[[0,100],[0,0],[100,0],[100,100],[0,100]]]}}},stroke:{legend:{frame:{xmax:24,xmin:0,ymax:-2,ymin:2},geometry:{paths:[[[0,0],[12,0],[24,0]]]},canvasPaths:{paths:[[[0,2],[12,2],[24,2]]]}},preview:{frame:{xmax:100,xmin:0,ymax:-2,ymin:2},geometry:{paths:[[[0,0],[50,0],[100,0]]]},canvasPaths:{paths:[[[0,2],[50,2],[100,2]]]}}}};class I{constructor(e,t){this._spatialReference=e,this._avoidSDF=t,this._resourceCache=new Map,this._rasterizer=new c.o,this._textRasterizer=new u,this._pictureMarkerCache=new Map}async rasterizeCIMSymbolAsync(e,t,a,i,r,s,n,l){i=i||(t?null!=t.centroid?"esriGeometryPolygon":(0,o.d)(t.geometry):null)||function(e){if(!(e&&e.data&&e.data.symbol))return null;switch(e.data.symbol.type){case"CIMPointSymbol":case"CIMTextSymbol":return"esriGeometryPoint";case"CIMLineSymbol":return"esriGeometryPolyline";case"CIMPolygonSymbol":return"esriGeometryPolygon";default:return null}}(e);const c=await this.analyzeCIMSymbol(e,t?function(e){return(e?Object.keys(e):[]).map((t=>({name:t,alias:t,type:"string"==typeof e[t]?"esriFieldTypeString":"esriFieldTypeDouble"})))}(t.attributes):null,a,i,l);return this.rasterizeCIMSymbol(c,t,i,r,s,n)}async analyzeCIMSymbol(e,t,a,i,s){const n=[],o=t?{geometryType:i,spatialReference:this._spatialReference,fields:t}:null;let c;await(0,l.k)(e.data,o,n,this._avoidSDF),(0,r.a)(s);for(const e of n)"CIMPictureMarker"!==e.cim.type&&"CIMPictureFill"!==e.cim.type&&"CIMPictureStroke"!==e.cim.type||(c||(c=[]),c.push(this.fetchPictureMarkerResource(e,s))),a&&"text"===e.type&&"string"==typeof e.text&&e.text.indexOf("[")>-1&&(e.text=(0,l.n)(a,e.text,e.cim.textCase));return c&&await Promise.all(c),n}async fetchPictureMarkerResource(e,t){const a=e.materialHash;if(!this._pictureMarkerCache.get(a)){const r=(await(0,i.L)(e.cim.url,{responseType:"image",signal:t&&t.signal})).data;this._pictureMarkerCache.set(a,r)}}rasterizeCIMSymbol(e,t,a,i,r,s){const n=[];for(const o of e){i&&"function"==typeof i.scaleFactor&&(i.scaleFactor=i.scaleFactor(t,r,s));const e=this._getRasterizedResource(o,t,a,i,r,s);if(!e)continue;let c=0,h=e.anchorX||0,m=e.anchorY||0,f=!1,g=0,u=0;if("esriGeometryPoint"===a){const e=M(i,o,null);if(g=(0,l.e)(o.offsetX,t,r,s)*e||0,u=(0,l.e)(o.offsetY,t,r,s)*e||0,"marker"===o.type)c=(0,l.e)(o.rotation,t,r,s)||0,f=!!o.rotateClockwise&&o.rotateClockwise;else if("text"===o.type){if(c=(0,l.e)(o.angle,t,r,s)||0,void 0!==o.horizontalAlignment)switch(o.horizontalAlignment){case"left":h=-.5;break;case"right":h=.5;break;default:h=0}if(void 0!==o.verticalAlignment)switch(o.verticalAlignment){case"top":m=.5;break;case"bottom":m=-.5;break;case"baseline":m=-.25;break;default:m=0}}}null!=e&&n.push({angle:c,rotateClockWise:f,anchorX:h,anchorY:m,offsetX:g,offsetY:u,rasterizedResource:e})}return this.getSymbolImage(n)}getSymbolImage(e){const t=document.createElement("canvas"),a=t.getContext("2d");let i=0,r=0,n=0,o=0;const l=[];for(let t=0;t<e.length;t++){const c=e[t],h=c.rasterizedResource;if(!h)continue;const m=h.size,f=c.offsetX,g=c.offsetY,u=c.anchorX,d=c.anchorY,y=c.rotateClockWise||!1;let p=c.angle,M=(0,s.u)(f)-m[0]*(.5+u),C=(0,s.u)(g)-m[1]*(.5+d),I=M+m[0],P=C+m[1];if(p){y&&(p=-p);const e=Math.sin(p*Math.PI/180),t=Math.cos(p*Math.PI/180),a=M*t-C*e,i=M*e+C*t,r=M*t-P*e,s=M*e+P*t,n=I*t-P*e,o=I*e+P*t,l=I*t-C*e,c=I*e+C*t;M=Math.min(a,r,n,l),C=Math.min(i,s,o,c),I=Math.max(a,r,n,l),P=Math.max(i,s,o,c)}i=M<i?M:i,r=C<r?C:r,n=I>n?I:n,o=P>o?P:o;const k=a.createImageData(h.size[0],h.size[1]);k.data.set(new Uint8ClampedArray(h.image.buffer));const x={offsetX:f,offsetY:g,rotateClockwise:y,angle:p,rasterizedImage:k,anchorX:u,anchorY:d};l.push(x)}t.width=n-i,t.height=o-r;const c=-i,m=o;for(let e=0;e<l.length;e++){const t=l[e],i=this._imageDataToCanvas(t.rasterizedImage),r=t.rasterizedImage.width,n=t.rasterizedImage.height,o=c-r*(.5+t.anchorX),h=m-n*(.5-t.anchorY);if(t.angle){const e=(360-t.angle)*Math.PI/180;a.save(),a.translate((0,s.u)(t.offsetX),-(0,s.u)(t.offsetY)),a.translate(c,m),a.rotate(e),a.translate(-c,-m),a.drawImage(i,o,h),a.restore()}else a.drawImage(i,o+(0,s.u)(t.offsetX),h-(0,s.u)(t.offsetY))}const f=new h.B({x:c/t.width-.5,y:m/t.height-.5});return{imageData:0!==t.width&&0!==t.height?a.getImageData(0,0,t.width,t.height):a.createImageData(1,1),anchorPosition:f}}_imageDataToCanvas(e){this._imageDataCanvas||(this._imageDataCanvas=document.createElement("canvas"));const t=this._imageDataCanvas,a=t.getContext("2d");return t.width=e.width,t.height=e.height,a.putImageData(e,0,0),t}_imageTo32Array(e,t,a){this._imageDataCanvas||(this._imageDataCanvas=document.createElement("canvas"));const i=this._imageDataCanvas,r=i.getContext("2d");return i.width=t,i.height=a,r.drawImage(e,0,0,t,a),new Uint32Array(r.getImageData(0,0,t,a).data.buffer)}_getRasterizedResource(e,t,a,i,r,s){let o,c,h,m;if("esriGeometryPolyline"===a||"esriGeometryPolygon"===a){const m=i&&i.style?i.style:y.Legend,f="esriGeometryPolyline"===a?C.stroke[m]:C.fill[m];if("line"===e.type){if("CIMSolidStroke"!==e.cim.type){if("CIMPictureStroke"===e.cim.type){const a=(0,l.e)(e.width,t,r,s),{image:i,width:n,height:o}=this._getPictureResource(e,a);return this._rasterizePictureResource(e,i,n,o,f,a)}return null}({analyzedCIM:o,hash:h}=P(e,t,r,s)),c=this._embedCIMLayerInVectorMarker(o,f)}else if("marker"===e.type){if("CIMPictureMarker"===e.cim.type)return null;if("CIMVectorMarker"!==e.cim.type)return null;e.cim.offsetX=(0,l.e)(e.offsetX,t,r,s),e.cim.offsetY=(0,l.e)(e.offsetY,t,r,s),e.cim.rotation=(0,l.e)(e.rotation,t,r,s),e.cim.markerPlacement=e.markerPlacement,({analyzedCIM:o}=P(e,t,r,s)),h=(0,n.w)(JSON.stringify(o)).toString(),c=this._embedCIMLayerInVectorMarker(o,f)}else{if("text"===e.type)return null;if("fill"===e.type){if("CIMHatchFill"===e.cim.type||"CIMVectorMarker"===e.cim.type||"CIMPictureMarker"===e.cim.type||"CIMPictureFill"===e.cim.type){const a=e.cim.size||e.cim.height;let i,n,l;if("CIMPictureMarker"===e.cim.type||"CIMPictureFill"===e.cim.type)({image:i,width:n,height:l}=this._getPictureResource(e,a));else{({analyzedCIM:o,hash:h}=P(e,t,r,s));const a=this._rasterizer.rasterizeJSONResource(o,1,this._avoidSDF);i=a.image,n=a.size[0],l=a.size[1]}return this._rasterizePictureResource(e,i,n,l,f,null)}if("CIMSolidFill"!==e.cim.type)return null;({analyzedCIM:o,hash:h}=P(e,t,r,s)),c=this._embedCIMLayerInVectorMarker(o,f)}}}else{if("text"===e.type)return m=this._rasterizeTextResource(e,t,i,r,s),m;({analyzedCIM:o,hash:h}=P(e,t,r,s));const a=M(i,e,null);if("CIMPictureMarker"===e.cim.type){const i=(0,l.e)(e.size,t,r,s)*a,{image:n,width:o,height:c}=this._getPictureResource(e,i);return m={image:n,size:[o,c],sdf:!1,simplePattern:!1,anchorX:e.anchorPoint?e.anchorPoint.x:0,anchorY:e.anchorPoint?e.anchorPoint.y:0},m}f(o,a,{preserveOutlineWidth:!1}),c=o}h+=a,i&&(h+=JSON.stringify(i));const g=this._resourceCache;return g.has(h)?g.get(h):(m=this._rasterizer.rasterizeJSONResource(c,window.devicePixelRatio||1,this._avoidSDF),g.set(h,m),m)}_rasterizeTextResource(e,t,a,i,r){const s=M(a,e,null),n=(0,l.e)(e.text,t,i,r);if(!n||0===n.length)return null;const o=(0,l.e)(e.fontName,t,i,r),c=(0,l.e)(e.style,t,i,r),h=(0,l.e)(e.weight,t,i,r),m=(0,l.e)(e.decoration,t,i,r),f=(0,l.e)(e.size,t,i,r)*s,g=(0,l.e)(e.horizontalAlignment,t,i,r),u=(0,l.e)(e.verticalAlignment,t,i,r),d=(0,l.b)((0,l.e)(e.color,t,i,r)),y=(0,l.b)((0,l.e)(e.outlineColor,t,i,r)),p={color:d,size:f,horizontalAlignment:g,verticalAlignment:u,font:{family:o,style:c,weight:h,decoration:m},halo:{size:(0,l.e)(e.outlineSize,t,i,r)||0,color:y,style:c},pixelRatio:1,premultiplyColors:!this._avoidSDF};return this._textRasterizer.rasterizeText(n,p)}_rasterizePictureResource(e,t,a,i,r,n){const l=document.createElement("canvas"),c=l.getContext("2d");l.height=(0,s.u)(Math.max(Math.abs(r.frame.ymax-r.frame.ymin),n)),l.width=(0,s.u)(Math.abs(r.frame.xmax-r.frame.xmin));const h=c.createImageData(a,i);h.data.set(new Uint8ClampedArray(t.buffer));const m=this._imageDataToCanvas(h),f=c.createPattern(m,"repeat"),g=Math.cos((-e.cim.rotation||0)*Math.PI/180),u=Math.sin((-e.cim.rotation||0)*Math.PI/180);f.setTransform({m11:g,m12:u,m21:-u,m22:g,m41:(0,s.u)(e.cim.offsetX)||0,m42:(0,s.u)(e.cim.offsetY)||0});const d=r.canvasPaths;let y,p,M;(0,o.y)(d)?(y=d.rings,c.fillStyle=f,p=c.fill,M=["evenodd"]):(0,o.f)(d)&&(y=d.paths,c.strokeStyle=f,c.lineWidth=n,p=c.stroke,y[0][0][1]=l.height/2,y[0][1][1]=l.height/2),c.beginPath();for(const e of y){const t=e?e.length:0;if(t>1){let a=e[0];c.moveTo((0,s.u)(a[0]),(0,s.u)(a[1]));for(let i=1;i<t;++i)a=e[i],c.lineTo((0,s.u)(a[0]),(0,s.u)(a[1]));c.closePath()}}p.apply(c,M);const C=c.getImageData(0,0,l.width,l.height),I=new Uint8Array(C.data);return{size:[l.width,l.height],image:new Uint32Array(I.buffer),sdf:!1,simplePattern:!1,anchorX:0,anchorY:0}}_getPictureResource(e,t){const a=this._pictureMarkerCache.get(e.materialHash);if(!a)return null;const i=a.height/a.width,r=t?i>1?(0,s.u)(t):(0,s.u)(t)/i:a.width,n=t?i>1?(0,s.u)(t)*i:(0,s.u)(t):a.height;return{image:this._imageTo32Array(a,r,n),width:r,height:n}}_embedCIMLayerInVectorMarker(e,t){const a=(0,o.y)(t.geometry)?"CIMPolygonSymbol":"CIMLineSymbol";return{type:"CIMVectorMarker",frame:t.frame,markerGraphics:[{type:"CIMMarkerGraphic",geometry:t.geometry,symbol:{type:a,symbolLayers:[e]}}]}}}function P(e,t,a,i){let r,s;return"function"==typeof e.materialHash?(r=(0,e.materialHash)(t,a,i),s=(0,l.T)(e.cim,e.materialOverrides)):(r=e.materialHash,s=e.cim),{analyzedCIM:s,hash:r}}}}]);