(self.webpackChunk=self.webpackChunk||[]).push([[8771],{28771:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>I,LineOfSightLayerView3D:()=>S});var n=i(78155),s=i(80219),o=i(88903),r=i(32422),a=(i(80987),i(83731)),l=i(20215),y=i(60816),c=i(72105),u=i(20736),d=i(40130),h=i(17762),p=i(71542),g=i(58275),_=i(50822);i(71391),i(36845),i(55688),i(15015),i(31516),i(95629),i(9612),i(92858),i(52109),i(6585),i(31531),i(3621),i(63358),i(4169),i(98548),i(76326),i(4807),i(30316),i(29126),i(61888),i(18559),i(32769),i(42296),i(17331),i(41290),i(62121),i(91236),i(82906),i(52957),i(82361),i(65352),i(71394),i(73574),i(81135),i(94527),i(29832),i(89710),i(13564),i(95559),i(68631),i(56803),i(18143),i(47365),i(67079),i(2903),i(85570),i(71470),i(80136),i(91507),i(85289),i(98843),i(91790),i(52737),i(29831),i(16040),i(34396),i(5250),i(49878),i(84271),i(48643),i(4618),i(80657),i(94449),i(97325),i(3629),i(79506),i(26779),i(98420),i(54223),i(8725),i(51218),i(21793),i(13895),i(15576),i(28941),i(19438),i(15022),i(56416),i(92758),i(78435),i(53902),i(40481),i(78730),i(2570),i(71666),i(72257),i(41822),i(99987),i(11838),i(39068),i(24776),i(95186),i(67726),i(59312),i(7571),i(93242),i(58404),i(79679),i(16063),i(43194),i(62654),i(15346),i(65311),i(37762),i(92722),i(25290),i(60183),i(93875),i(14215),i(7552),i(78082),i(20868),i(72600),i(27270),i(37191),i(30665),i(53185),i(28090),i(84796),i(87405),i(84320),i(93450),i(97431),i(32892),i(41374),i(86897),i(41392),i(79949),i(6660),i(6783),i(75200),i(29218),i(49293),i(30494),i(334);let v=class extends n.p{constructor(e){super(e),this.inputPoints={isValid:!1,observer:(0,y.n)(),target:(0,y.n)(),observerAdjusted:(0,y.n)(),targetAdjusted:(0,y.n)()},this.computationResult={start:(0,y.n)(),end:(0,y.n)(),intersection:(0,y.n)(),isValid:!1,isTargetVisible:!1},this.result=null}updateComputationResults(){this.notifyChange("computationResult")}updateInputPoints(){this.notifyChange("inputPoints")}};(0,n.e)([(0,o.y)()],v.prototype,"target",void 0),(0,n.e)([(0,o.y)()],v.prototype,"inputPoints",void 0),(0,n.e)([(0,o.y)()],v.prototype,"computationResult",void 0),(0,n.e)([(0,o.y)()],v.prototype,"result",void 0),v=(0,n.e)([(0,o.n)("esri.views.3d.layers.analysis.LineOfSight.LineOfSightAnalysis")],v);let C=class extends n.p{constructor(e){super(e)}};(0,n.e)([(0,o.y)()],C.prototype,"target",void 0),(0,n.e)([(0,o.y)()],C.prototype,"intersectedGraphic",void 0),(0,n.e)([(0,o.y)()],C.prototype,"intersectedLocation",void 0),(0,n.e)([(0,o.y)()],C.prototype,"visible",void 0),C=(0,n.e)([(0,o.n)("esri.views.3d.layers.analysis.LineOfSight.LineOfSightResult")],C);let m=class extends n.p{constructor(e){super(e),this._tasks=r.y,this._handles=new a.u,this._analysisHandles=new a.u}initialize(){var e;const t=null==(e=this.view.resourceController)?void 0:e.scheduler;t&&(this._tasks=t.registerTask(r.p.LINE_OF_SIGHT_TOOL)),this._handles.add([(0,n.N)((()=>this.layer.observer),(e=>this._onObserverChange(e))),this._connectAnalyses(),this._connectTargets()]),this._intersector=new r.u(this.view.state.viewingMode),this._intersector.options.hud=!1,this._intersector.options.store=0}destroy(){this._handles.destroy(),this._analysisHandles.destroy(),this._analyses.removeAll()}get updating(){return this._tasks.updating}get priority(){return this._tasks.priority}set priority(e){this._tasks.priority=e}get _analyses(){return this.layerViewData.analyses}get _observerEngineLocation(){return this.layerViewData.observerEngineLocation}set _observerEngineLocation(e){this.layerViewData.observerEngineLocation=e}get _screenPixelSize(){return this.view.state.camera.computeScreenPixelSizeAt(this._observerEngineLocation)}getLineOfSightComputationDependencies(e){const{inputPoints:t}=e;return{inputPoints:t}}computeAnalysis(e,t=!1){const{analysis:i}=e,{inputPoints:n,computationResult:s}=i,{observerAdjusted:o,targetAdjusted:r}=n,{start:a,end:l}=s;(0,y.h)(a,o),(0,y.h)(l,r),t||this._canComputeAnalysis(i)?this._computeAnalysisIntersection(e):this._interpolateAnalysisIntersection(e),i.updateComputationResults()}_adjustStartEndPositions(e){const t=this._screenPixelSize,i=this.view,{inputPoints:n}=e,{observer:s,target:o,observerAdjusted:r,targetAdjusted:a}=n,l=f;(0,y.c)(l,o,s);const c=t;(0,y.j)(l,l),(0,y.d)(l,l,Math.min(c,1)),(0,y.u)(r,s,l),(0,y.c)(l,s,o);const u=i.state.camera.computeScreenPixelSizeAt(o);(0,y.j)(l,l),(0,y.d)(l,l,Math.min(u,1)),(0,y.u)(a,o,l)}_computeAnalysisIntersection({analysis:e,interpolationInfo:t}){const{view:i}=this,{sceneIntersectionHelper:n,renderCoordsHelper:o}=i;if((0,s.t)(n))return;const a=this._intersector,{computationResult:l,inputPoints:d}=e,{observer:h,target:p}=d,{start:g,end:_}=l,v=(0,c.A)(g,_,O);n.intersectToolIntersectorRay(v,a);const m=l.intersection,w=f,A=!!a.results.min&&a.results.min.getIntersectionPoint(m);let b=!0;if(A){(0,y.h)(t.originalIntersection,m),(0,y.h)(t.originalObserver,g),(0,y.h)(t.originalTarget,_),o.fromRenderCoords(m,w,i.spatialReference);const e=1-(0,y.S)(_,p)/(0,y.S)(g,p);b=(0,y.S)(h,m)>=e*(0,y.S)(h,p)}const L=new u.b(w,i.spatialReference);e.result=new C({target:e.target,intersectedGraphic:b?null:(0,r.a8)(a.results.min,i),intersectedLocation:b?null:L,visible:!!A&&b}),l.isValid=d.isValid=!0,l.isTargetVisible=b}_interpolateAnalysisIntersection({analysis:e,interpolationInfo:t}){const{computationResult:i,inputPoints:n}=e,{start:s,end:o,intersection:r}=i,{originalIntersection:a,originalObserver:l,originalTarget:c}=t;if((0,y.h)(r,a),n.isValid){const e=f,t=(0,y.S)(l,a)/(0,y.S)(l,c);(0,y.J)(e,s,l),(0,y.d)(e,e,1-t),(0,y.u)(r,r,e),(0,y.J)(e,o,c),(0,y.d)(e,e,t),(0,y.u)(r,r,e),i.isValid=!0}else e.result=null,i.isValid=!1,i.isTargetVisible=!1}_canComputeAnalysis(e){const t=this.layer.observer,i=this.view.frustum;if((0,s.t)(t)||(0,s.t)(e.target)||(0,s.t)(i))return!1;const{observerAdjusted:n,targetAdjusted:o}=e.inputPoints,r=i.intersectsPoint(n),a=i.intersectsPoint(o);return r&&a}_onObserverChange(e){if((0,s.t)(e))return void this.layer.targets.removeAll();const t=(0,y.n)();this.view.renderCoordsHelper.toRenderCoords(e,t),this._observerEngineLocation=t,this.priority=r.p.LINE_OF_SIGHT_TOOL_INTERACTIVE}_onObserverChangeForAnalysis(e){e.inputPoints.isValid=!1}_onObserverEngineForAnalysis(e,t){const{inputPoints:i}=e;(0,y.h)(i.observer,t),this._adjustStartEndPositions(e),e.updateInputPoints(),this.priority=r.p.LINE_OF_SIGHT_TOOL_INTERACTIVE}_onTargetLocationChange(e,t){const{inputPoints:i}=e;i.isValid=!1,this.view.renderCoordsHelper.toRenderCoords(t,i.target),this._adjustStartEndPositions(e),e.updateInputPoints(),this.priority=r.p.LINE_OF_SIGHT_TOOL_INTERACTIVE}_connectAnalysisToTarget(e){return(0,n.N)((()=>({analysis:e,target:e.target})),(({analysis:e,target:t})=>{(0,s.r)(t)&&this._onTargetLocationChange(e,t)}))}_connectAnalysisToObserver(e){return(0,n.N)((()=>({analysis:e,observer:this.layer.observer})),(({analysis:e})=>{this._onObserverChangeForAnalysis(e)}))}_connectAnalysisToObserverEngine(e){return(0,n.N)((()=>({analysis:e,observer:this._observerEngineLocation})),(({analysis:e,observer:t})=>{this._onObserverEngineForAnalysis(e,t)}))}_connectAnalysisForCompute(e){let t=s.G;const i={analysis:e,interpolationInfo:{originalIntersection:(0,y.n)(),originalObserver:(0,y.n)(),originalTarget:(0,y.n)()}};return(0,o.x)([(0,n.N)((()=>this.getLineOfSightComputationDependencies(e)),(()=>{t=(0,s.B)(t),t=(0,l.G)((async e=>{await(0,l.y)(this._tasks.schedule((()=>this.computeAnalysis(i)),e))}))})),(0,o.A)((()=>t=(0,s.B)(t)))])}_connectAnalysis(e){const t=this._analysisHandles;t.has(e)||t.add([this._connectAnalysisToTarget(e),this._connectAnalysisToObserver(e),this._connectAnalysisToObserverEngine(e),this._connectAnalysisForCompute(e)])}_disconnectAnalysis(e){this._analysisHandles.remove(e)}_onAnalysesCollectionChange(e){e.added.forEach((e=>this._connectAnalysis(e))),e.removed.forEach((e=>this._disconnectAnalysis(e)))}_onTargetsChange(e){return this._analyses.removeAll(),e.items.length>0&&e.forEach((e=>this._addTarget(e))),e.on("change",(e=>this._onTargetCollectionChange(e)))}_onTargetCollectionChange(e){e.added.forEach((e=>this._addTarget(e))),e.removed.forEach((e=>this._removeTarget(e)))}_addTarget(e){const t=this._analyses;t.some((t=>t.target===e))||t.add(new v({target:e}))}_removeTarget(e){const t=this._analyses,i=t.find((t=>t.target===e));t.remove(i)}_connectAnalyses(){let e=null;return(0,o.x)([(0,n.N)((()=>this._analyses),(t=>{e=(0,s.a)(e),e=t.on("change",(e=>this._onAnalysesCollectionChange(e))),t.forEach((e=>this._connectAnalysis(e)))})),(0,o.A)((()=>e=(0,s.a)(e)))])}_connectTargets(){let e=null;return(0,o.x)([(0,n.N)((()=>this.layer.targets),(t=>{e=(0,s.a)(e),e=this._onTargetsChange(t)})),(0,o.A)((()=>e=(0,s.a)(e)))])}};(0,n.e)([(0,o.y)({constructOnly:!0})],m.prototype,"layer",void 0),(0,n.e)([(0,o.y)({constructOnly:!0})],m.prototype,"layerViewData",void 0),(0,n.e)([(0,o.y)({constructOnly:!0})],m.prototype,"view",void 0),(0,n.e)([(0,o.y)()],m.prototype,"updating",null),(0,n.e)([(0,o.y)()],m.prototype,"priority",null),(0,n.e)([(0,o.y)()],m.prototype,"_analyses",null),(0,n.e)([(0,o.y)()],m.prototype,"_observerEngineLocation",null),(0,n.e)([(0,o.y)()],m.prototype,"_screenPixelSize",null),(0,n.e)([(0,o.y)()],m.prototype,"_tasks",void 0),m=(0,n.e)([(0,o.n)("esri.views.3d.layers.analysis.LineOfSight.LineOfSightController")],m);const f=(0,y.n)(),O=(0,c.x)();let w=class extends n.p{constructor(e){super(e),this.innerWidth=2,this.outerWidth=8,this.visibleInnerColor=new h.o([3,252,111,1]),this.visibleOuterColor=new h.o([3,252,111,.15]),this.occludedInnerColor=new h.o([252,3,69,1]),this.occludedOuterColor=new h.o([252,3,69,.1]),this.undefinedInnerColor=new h.o([255,255,255,1]),this.undefinedOuterColor=new h.o([127,127,127,.2])}};(0,n.e)([(0,o.y)({type:Number})],w.prototype,"innerWidth",void 0),(0,n.e)([(0,o.y)({type:Number})],w.prototype,"outerWidth",void 0),(0,n.e)([(0,o.y)({type:h.o})],w.prototype,"visibleInnerColor",void 0),(0,n.e)([(0,o.y)({type:h.o})],w.prototype,"visibleOuterColor",void 0),(0,n.e)([(0,o.y)({type:h.o})],w.prototype,"occludedInnerColor",void 0),(0,n.e)([(0,o.y)({type:h.o})],w.prototype,"occludedOuterColor",void 0),(0,n.e)([(0,o.y)({type:h.o})],w.prototype,"undefinedInnerColor",void 0),(0,n.e)([(0,o.y)({type:h.o})],w.prototype,"undefinedOuterColor",void 0),w=(0,n.e)([(0,o.n)("esri.views.3d.layers.analysis.LineOfSight.LineOfSightConfiguration")],w);let A=class extends n.p{constructor(){super(...arguments),this.analyses=new d.L,this.configuration=new w,this.observerEngineLocation=(0,y.n)()}};(0,n.e)([(0,o.y)()],A.prototype,"analyses",void 0),(0,n.e)([(0,o.y)({type:w})],A.prototype,"configuration",void 0),(0,n.e)([(0,o.y)()],A.prototype,"observerEngineLocation",void 0),A=(0,n.e)([(0,o.n)("esri.views.3d.layers.analysis.LineOfSight.LineOfSightLayerViewData")],A);let b=class extends n.p{constructor(e){super(e),this._handle=null,this._analysisHandles=new a.u}initialize(){this._handle=this._connectAnalyses()}destroy(){this._handle=(0,s.a)(this._handle),this._analysisHandles=(0,s.k)(this._analysisHandles)}get _analyses(){return this.layerViewData.analyses}get _configuration(){return this.layerViewData.configuration}createLineOfSightVisualization(){const e=this._configuration,t={view:this.view,attached:!0,width:e.outerWidth,innerWidth:e.innerWidth};return{visibleLineVisualElement:new g.m({...t,color:h.o.toUnitRGBA(e.visibleOuterColor),innerColor:h.o.toUnitRGBA(e.visibleInnerColor)}),occludedLineVisualElement:new g.m({...t,color:h.o.toUnitRGBA(e.occludedOuterColor),innerColor:h.o.toUnitRGBA(e.occludedInnerColor)}),undefinedLineVisualElement:new g.m({...t,color:h.o.toUnitRGBA(e.undefinedOuterColor),innerColor:h.o.toUnitRGBA(e.undefinedInnerColor)})}}destroyLineOfSightVisualization(e){e.visibleLineVisualElement=(0,s.k)(e.visibleLineVisualElement),e.occludedLineVisualElement=(0,s.k)(e.occludedLineVisualElement),e.undefinedLineVisualElement=(0,s.k)(e.undefinedLineVisualElement)}updateLineOfSightVisualization(e,t){const i=this._configuration,{computationResult:n,inputPoints:s}=e,{start:o,end:r,intersection:a,isValid:l,isTargetVisible:c}=n,{observer:u}=s,d=T;d[12]=u[0],d[13]=u[1],d[14]=u[2];const p=(0,y.c)(L,o,u),g=(0,y.c)(V,r,u),_=(0,y.c)(E,a,u),{visibleLineVisualElement:v,occludedLineVisualElement:C,undefinedLineVisualElement:m}=t;v.geometry=null,C.geometry=null,m.geometry=null,l?c?(v.geometry=[[(0,y.M)(p),(0,y.M)(g)]],v.transform=d,v.color=h.o.toUnitRGBA(i.visibleOuterColor)):(v.geometry=[[(0,y.M)(p),(0,y.M)(_)]],v.transform=d,v.color=h.o.toUnitRGBA(i.occludedOuterColor),C.geometry=[[(0,y.M)(_),(0,y.M)(g)]],C.transform=d):(m.geometry=[[(0,y.M)(p),(0,y.M)(g)]],m.transform=d)}getLineOfSightVisualizationDependencies(e){const{computationResult:t}=e,{occludedOuterColor:i,visibleOuterColor:n}=this._configuration;return{computationResult:t,occludedOuterColor:i,visibleOuterColor:n}}_connectAnalysis(e){const t=this._analysisHandles;if(t.has(e))return;const i=this.createLineOfSightVisualization();t.add([(0,n.N)((()=>this.getLineOfSightVisualizationDependencies(e)),(()=>this.updateLineOfSightVisualization(e,i))),(0,o.A)((()=>this.destroyLineOfSightVisualization(i)))])}_disconnectAnalysis(e){this._analysisHandles.remove(e)}_connectAnalyses(){let e=null;return(0,o.x)([(0,n.N)((()=>this._analyses),(t=>{e=(0,s.a)(e),e=t.on("change",(e=>this._onAnalysesCollectionChange(e))),this._onAnalysesCollectionChange({target:t,added:t.items,removed:[],moved:[]})})),(0,o.A)((()=>e=(0,s.a)(e)))])}_onAnalysesCollectionChange(e){e.added.forEach((e=>this._connectAnalysis(e))),e.removed.forEach((e=>this._disconnectAnalysis(e)))}};(0,n.e)([(0,o.y)({constructOnly:!0})],b.prototype,"layer",void 0),(0,n.e)([(0,o.y)({constructOnly:!0})],b.prototype,"view",void 0),(0,n.e)([(0,o.y)({constructOnly:!0})],b.prototype,"layerViewData",void 0),(0,n.e)([(0,o.y)()],b.prototype,"_analyses",null),(0,n.e)([(0,o.y)()],b.prototype,"_configuration",null),b=(0,n.e)([(0,o.n)("esri.views.3d.layers.analysis.LineOfSight.LineOfSightView")],b);const L=(0,y.n)(),V=(0,y.n)(),E=(0,y.n)(),T=(0,p.e)();let S=class extends((0,r.m)(_.d)){constructor(){super(...arguments),this.type="line-of-sight-3d",this._layerViewData=new A}initialize(){const e=this.view,t=this.layer,i=this._layerViewData;this._analysisController=new m({layer:t,layerViewData:i,view:e}),this._analysisView=new b({layer:t,layerViewData:i,view:e})}destroy(){this._analysisController=(0,s.k)(this._analysisController),this._analysisView=(0,s.k)(this._analysisView)}get results(){return this._layerViewData.analyses.map((e=>e.result))}get priority(){return this._analysisController.priority}set priority(e){this._analysisController.priority=e}getResultForTarget(e){const t=this._layerViewData.analyses.find((t=>t.target===e)),i=(0,s.x)(t,(e=>e.result));return(0,s.q)(i,null)}isUpdating(){return(0,s.v)(this._analysisController,!1,(e=>e.updating))}};(0,n.e)([(0,o.y)({readOnly:!0})],S.prototype,"type",void 0),(0,n.e)([(0,o.y)()],S.prototype,"layer",void 0),(0,n.e)([(0,o.y)({readOnly:!0})],S.prototype,"results",null),(0,n.e)([(0,o.y)()],S.prototype,"priority",null),(0,n.e)([(0,o.y)()],S.prototype,"_layerViewData",void 0),(0,n.e)([(0,o.y)()],S.prototype,"_analysisController",void 0),(0,n.e)([(0,o.y)()],S.prototype,"_analysisView",void 0),S=(0,n.e)([(0,o.n)("esri.views.3d.layers.LineOfSightLayerView3D")],S);const I=S}}]);