(self.webpackChunk=self.webpackChunk||[]).push([[9532],{49532:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>R});var s=i(78155),r=i(80219),l=i(20215),a=i(36845),n=i(88903),o=i(6488),h=i(3629),c=i(71391),d=i(58404),u=i(6660),g=i(78185),y=i(29218),p=i(26799),_=i(84585),m=i(82030),f=i(32422),C=(i(95186),i(93875),i(14215),i(75200),i(50822));i(25290),i(31531),i(65352),i(92858),i(20736),i(4169),i(83731),i(40130),i(80987),i(98548),i(55688),i(15015),i(31516),i(95629),i(9612),i(52109),i(6585),i(3621),i(63358),i(76326),i(4807),i(17762),i(60816),i(30316),i(29126),i(61888),i(18559),i(32769),i(42296),i(17331),i(41290),i(62121),i(91236),i(82906),i(52957),i(82361),i(71394),i(73574),i(81135),i(94527),i(29832),i(89710),i(13564),i(95559),i(68631),i(56803),i(18143),i(47365),i(67079),i(2903),i(85570),i(71470),i(80136),i(91507),i(85289),i(98843),i(91790),i(52737),i(29831),i(16040),i(34396),i(5250),i(49878),i(84271),i(48643),i(4618),i(80657),i(94449),i(97325),i(79506),i(26779),i(98420),i(54223),i(8725),i(51218),i(21793),i(13895),i(15576),i(28941),i(19438),i(15022),i(56416),i(92758),i(78435),i(53902),i(40481),i(78730),i(2570),i(71666),i(72257),i(41822),i(99987),i(11838),i(39068),i(24776),i(67726),i(59312),i(6783),i(50388),i(36542),i(21779),i(43356),i(86897),i(5772),i(79766),i(2098),i(78191),i(34534),i(7571),i(93242),i(79679),i(71542),i(16063),i(43194),i(62654),i(15346),i(65311),i(72105),i(53185),i(60183),i(20868),i(72600),i(334),i(37762),i(92722),i(7552),i(78082),i(27270),i(37191),i(30665),i(28090),i(84796),i(87405),i(84320),i(93450),i(97431),i(32892),i(41374),i(41392),i(79949),i(49293),i(30494);class b extends g.f{constructor(e,t,i,s,r){super(e,t,i),this._memCache=s,this._loader=r,this._ongoingTileRequests=new Map,this._ongoingRequestToController=new Map}destroy(){this._ongoingRequestToController.forEach((e=>e.abort())),this._ongoingRequestToController.clear(),this._ongoingTileRequests.clear()}async getVectorTile(e,t,i,s){const a=new y.e(e,t,i,0);let n=this._memCache.get(a.id);if((0,r.r)(n))return n.retain(),n;const o=await this._getVectorTileData(a);if((0,l.a)(s),!this._vectorTileLayer)return null;if(n=this._memCache.get(a.id),(0,r.r)(n))return n.retain(),n;const p=this._vectorTileLayer.tileInfo.getTileBounds((0,d.i)(),a);return n=new u.d(a,this._styleRepository,p,[512,512],this._memCache),(0,r.r)(o)&&o.tileData?(n.setData(o.tileData),n.retain(),this._memCache.put(a.id,n,n.memoryUsage*n.referenced,h.e)):n.setData(null),n.neededForCoverage=!0,n.transforms.tileUnitsToPixels=(0,c.ap)(1/8,0,0,0,1/8,0,0,0,1),function(e,t){const i=[],s=new g.r(4096,i,(()=>{const e=new u.s;return e.show=!1,e.parts.push({startTime:0,startOpacity:0,targetOpacity:0,show:!1}),e.parts.push({startTime:0,startOpacity:0,targetOpacity:0,show:!1}),e})),r=new g.i(i,s,((t,i,s)=>new g.a(t,i,s,e.styleRepository,e.key.level,0)),((e,t)=>{(0,u.h)(e,t,!1)}),(()=>0),(e=>{const i=t.getStyleLayerByUID(e).getLayoutProperty("visibility");return!i||1!==i.getValue()}));i.push(e),s.add(e),r.setScreenSize(512,512),r.continue(1/0)}(n,this._styleRepository),n}_getVectorTileData(e){const t=e.id;if(this._ongoingTileRequests.has(t))return this._ongoingTileRequests.get(t);const i=new AbortController,s={signal:i.signal},r=this._getParsedVectorTileData(e,s).then((e=>(this._ongoingTileRequests.delete(t),this._ongoingRequestToController.delete(t),e))).catch((()=>(this._ongoingTileRequests.delete(t),this._ongoingRequestToController.delete(t),null)));return this._ongoingTileRequests.set(t,r),this._ongoingRequestToController.set(t,i),r}_getParsedVectorTileData(e,t){return this.fetchTileData(e,t).then((i=>this.parseTileData({key:e,data:i},t)))}request(e,t){return this._loader.request(e,"binary",t)}}const T=1e-6;class v{constructor(e,t){this.spriteMosaic=e,this.glyphMosaic=t,this._brushCache=new Map,this._vtlMaterialManager=new _.c}dispose(){this._brushCache&&(this._brushCache.forEach((e=>e.dispose())),this._brushCache=null),this._vtlMaterialManager=(0,r.z)(this._vtlMaterialManager),this.spriteMosaic.dispose(),this.glyphMosaic.dispose()}get vectorTilesMaterialManager(){return this._vtlMaterialManager}drawTile(e,t,i){const{context:s}=e,r=i.layers;i.backgroundBucketIds.length>0&&(e.renderPass="background",i.backgroundBucketIds.forEach((s=>this._renderStyleLayer(i.getLayerById(s),e,t,!0)))),s.setBlendingEnabled(!1),s.setDepthTestEnabled(!0),s.setDepthWriteEnabled(!0),s.setDepthFunction(515),e.renderPass="opaque";for(let i=r.length-1;i>=0;i--)this._renderStyleLayer(r[i],e,t,!1);s.setDepthWriteEnabled(!1),s.setBlendingEnabled(!0),s.setBlendFunctionSeparate(1,771,1,771),e.renderPass="translucent";for(let i=0;i<r.length;i++)this._renderStyleLayer(r[i],e,t,!1);s.setDepthTestEnabled(!1),e.renderPass="symbol";for(let i=0;i<r.length;i++)this._renderStyleLayer(r[i],e,t,!1);s.bindVAO()}_renderStyleLayer(e,t,i,s=!1){if(!(s||e&&i.layerData.has(e.uid)))return;const r=e.getLayoutProperty("visibility");if(r&&1===r.getValue())return;const{renderPass:l}=t;let a;switch(e.type){case 0:if("background"!==l)return;a="vtlBackground";break;case 1:if("opaque"!==l&&"translucent"!==t.renderPass)return;a="vtlFill";break;case 2:if("translucent"!==l)return;a="vtlLine";break;case 4:if("symbol"!==l)return;a="vtlCircle";break;case 3:if("symbol"!==l)return;a="vtlSymbol"}const n=t.displayLevel;void 0!==e.minzoom&&e.minzoom>n+T||void 0!==e.maxzoom&&e.maxzoom<=n-T||(t.styleLayerUID=e.uid,t.styleLayer=e,this.drawWithBrush(t,i,a))}drawWithBrush(e,t,i){if(!this._brushCache.has(i)){const e=p.G[i];this._brushCache.set(i,new e)}this._brushCache.get(i).drawMany(e,[t])}}let w=class extends((0,f.l)((0,f.m)(C.d))){constructor(e){super(e),this.type="vector-tile-3d"}initialize(){const e=this.layer.compatibleTileInfo256,t=this._getTileInfoSupportError(e,this.layer.fullExtent);if(t)return void this.addResolvingPromise(Promise.reject(t));const{basemapTerrain:i,spatialReference:s,pixelRatio:r}=this.view,n=(0,a.x)(this.view,"basemapTerrain.tilingSchemeLocked").then((()=>{const e=i.tilingScheme,t=e.pixelSize;let r;this.schemaHelper=new o.t(t,s.isGeographic),r=256===t?this.layer.compatibleTileInfo256:this.view.spatialReference.isGeographic?this.layer.compatibleTileInfo512:this.layer.tileInfo;const l=this._getTileInfoCompatibilityError(r,e);if(l)throw l;this._set("tileInfo",r)}));this._tileHandlerController=(0,l.h)();const h=this.view.resourceController;this._memCache=h.memoryController.getMemCache(this.layer.uid,(e=>e.release()));const{style:c,spriteUrl:d,glyphsUrl:u}=this.layer.currentStyleInfo,g=new m.g(c,{spriteUrl:d,glyphsUrl:u}),y=i.mapTileRequester;this._tileHandler=new b(this.layer,g,r,this._memCache,y);const p=this._tileHandlerController.signal,_=e=>h.schedule(e),f=this._tileHandler.start({signal:p,schedule:_}),C=this._tileHandler.spriteMosaic;C.then((e=>{!(0,l.b)(p)&&this._tileHandler&&(this.painter=new v(e,this._tileHandler.glyphMosaic))})),f.then((()=>this._tileHandlerController=null));const T=()=>{this._tileHandlerController&&this._tileHandlerController.abort(),this._tileHandlerController=(0,l.h)(),this._memCache.clear();const{style:e,spriteUrl:t,glyphsUrl:i}=this.layer.currentStyleInfo,s=new m.g(e,{spriteUrl:t,glyphsUrl:i}),a=new b(this.layer,s,r,this._memCache,y),n=a.start({signal:this._tileHandlerController.signal,schedule:_}),o=a.spriteMosaic;n.then((()=>this._tileHandlerController=null)),this.updatingHandles.addPromise(Promise.all([n,o]).then((([,e])=>{const t=this._tileHandler,i=this.painter;this.painter=new v(e,a.glyphMosaic),this._tileHandler=a,this.emit("data-changed"),t.destroy(),i&&i.dispose()})))};this.updatingHandles.add(this,"layer.currentStyleInfo",T),this.updatingHandles.add(this,"view.pixelRatio",T);const w=Promise.all([n,f,C]);this.addResolvingPromise(w)}destroy(){this.painter=(0,r.z)(this.painter),this._tileHandlerController&&(this._tileHandlerController.abort(),this._tileHandlerController=null),(0,r.k)(this._tileHandler),this._memCache=(0,r.k)(this._memCache),this._tileHandler=null}get dataLevelRange(){const e=this.tileInfo.lods,t=e[0].scale,i=e[e.length-1].scale,s=this.levelRangeFromScaleRange(t,i);return 1===s.minLevel&&256===this.tileInfo.size[0]&&(s.minLevel=0),s}async fetchTile(e,t,i,s){return this._tileHandler.getVectorTile(e,t,i,s)}};(0,s.e)([(0,n.y)({aliasOf:"layer.fullExtent"})],w.prototype,"fullExtent",void 0),(0,s.e)([(0,n.y)()],w.prototype,"layer",void 0),(0,s.e)([(0,n.y)()],w.prototype,"tileInfo",void 0),(0,s.e)([(0,n.y)()],w.prototype,"dataLevelRange",null),(0,s.e)([(0,n.y)()],w.prototype,"updatingProgressValue",void 0),w=(0,s.e)([(0,n.n)("esri.views.3d.layers.VectorTileLayerView3D")],w);const R=w}}]);