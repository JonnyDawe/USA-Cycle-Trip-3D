(self.webpackChunk=self.webpackChunk||[]).push([[9351],{68683:(e,t,i)=>{"use strict";i.d(t,{i:()=>Me,t:()=>Te}),i(33807);var r=i(78155),s=i(32769),n=i(80219),a=i(20215),o=i(94527),l=i(88903),h=i(98548),u=i(92858),c=i(58404),d=i(89710),p=i(71470),f=i(29986),y=i(2566),m=i(40481),g=i(43356),_=i(5772),x=i(93875),v=(i(14215),i(3805)),b=i(83991),w=i(84352),S=i(29831),I=i(90258),C=i(65352),M=i(98128),T=i(28090),E=i(91728),F=i(33180),A=i(732);function R(e,t,i){if(Array.isArray(e)){const r=e[0];if(r>t){const i=(0,p.i)(r,t);e[0]=r+i*(-2*t)}else if(r<i){const t=(0,p.i)(r,i);e[0]=r+t*(-2*i)}}else{const r=e.x;if(r>t){const i=(0,p.i)(r,t);e.x+=i*(-2*t)}else if(r<i){const t=(0,p.i)(r,i);e.x+=t*(-2*i)}}return e}function P(e,t){const[i,r]=t.valid,s=2*r;let n,a=0;return e>r?(n=Math.ceil(Math.abs(e-r)/s),e-=n*s,a=n):e<i&&(n=Math.ceil(Math.abs(e-i)/s),e+=n*s,a=-n),{x:e,frameId:a}}function L(e,t){const{xmin:i,ymin:r,xmax:s,ymax:n}=t;return D(e,i,r)&&D(e,i,n)&&D(e,s,n)&&D(e,s,r)}function D(e,t,i){return t>=e.xmin&&t<=e.xmax&&i>=e.ymin&&i<=e.ymax}class N{cut(e,t){let i;if(e.rings)this.closed=!0,i=e.rings,this.minPts=4;else{if(!e.paths)return null;this.closed=!1,i=e.paths,this.minPts=2}const r=i.length,s=-2*t;for(let e=0;e<r;e++){const t=i[e];if(t&&t.length>=this.minPts){const e=[];for(const i of t)e.push([i[0]+s,i[1]]);i.push(e)}}return this.closed?e.rings=i:e.paths=i,e}}const O=(0,c.i)();function k(e,t,i){if(!e.allDirty)if(null!=e.from&&null!=e.count){const r=Math.min(e.from,t),s=Math.max(e.from+e.count,t+i)-r;e.from=r,e.count=s}else e.from=t,e.count=i}class V{constructor(){this._dirties=(0,_.D)((()=>({indices:{from:null,count:null,allDirty:!1}})),(()=>({vertices:{from:null,count:null,allDirty:!1}})))}hasDirty(){for(const e of this._dirties)if(null!==e.data.indices.count||e.data.indices.allDirty)return!0;return!1}markAllClean(){for(const e of this._dirties){e.data.indices.from=null,e.data.indices.count=null,e.data.indices.allDirty=!1;for(const t in e.buffers)e.buffers[t].data.vertices.from=null,e.buffers[t].data.vertices.count=null,e.buffers[t].data.vertices.allDirty=!1}}markAllDirty(){for(const e of this._dirties){e.data.indices.allDirty=!0;for(const t in e.buffers)e.buffers[t].data.vertices.allDirty=!0}}forEach(e){for(let t=0;t<this._dirties.length;++t){const i=this._dirties[t],r={};for(const e in i.buffers){const t=i.buffers[e].data.vertices;(t.allDirty||null!=t.from&&null!=t.count&&t.count>0)&&(r[e]=t)}const s=i.data.indices;let n;n=s.allDirty||null!=s.from&&null!=s.count&&s.count>0?{indices:s,vertices:r}:{indices:null,vertices:r},(n.indices||Object.keys(n).length>0)&&e(n,t)}}markDirtyIndices(e,t,i){k(this._dirties[e].data.indices,t,i)}markDirtyVertices(e,t,i,r){k(this._dirties[e].buffers[t].data.vertices,i,r)}}class U{constructor(e){this._largestRange=null,this._parent=e,this._updateLargestRange()}get largestRange(){return this._largestRange}rangeCreated(e){(!this._largestRange||e.count>this._largestRange.count)&&(this._largestRange=e)}rangeResized(e,t){e===this._largestRange?e.count<t&&this._updateLargestRange():(!this._largestRange||e.count>this._largestRange.count)&&(this._largestRange=e)}findBestRange(e){let t=this._parent._freeHead,i=null;for(;null!==t;)t.count>=e&&(!i||t.count-e<i.count-e)&&(i=t),t=t.next;return i}findAdjacentRanges(e,t){let i=!0,r=!1,s=null,n=this._parent._freeHead;for(;i&&!r;){const a=null!==s?s.from+s.count:0,o=null!==n?n.from:this._parent._size;e>=a&&e+t<=o?(i=!1,r=!0):null!==n?(s=n,n=n.next):i=!1}return[s,n]}_updateLargestRange(){let e=null,t=this._parent._freeHead;for(;null!==t;)(!e||t.count>e.count)&&(e=t),t=t.next;this._largestRange=e}}class G{constructor(e,t){this._allocated=0,this._size=e,this._freeHead=e>0?{from:0,count:e,prev:null,next:null}:null,this._bookKeeper=t||new U(this),this._freeHead&&this._bookKeeper.rangeCreated(this._freeHead)}allocate(e){const t=this._bookKeeper.findBestRange(e);if(null===t)return-1;const i=t.from,r=t.count;if(t.from+=e,t.count-=e,this._bookKeeper.rangeResized(t,i,r),this._allocated+=e,0===t.count){const e=null!==t.prev?this._freeHead:t.next;G._removeRange(t),this._freeHead=e}return i}free(e,t){const[i,r]=this._bookKeeper.findAdjacentRanges(e,t),s={from:e,count:t,prev:i,next:r};if(null!==i&&(i.next=s),null!==r&&(r.prev=s),this._bookKeeper.rangeCreated(s),this._allocated-=t,null!==r&&s.from+s.count===r.from){const e=s.from,t=s.count;G._fuse(s,r),G._removeRange(r),this._bookKeeper.rangeResized(s,e,t),this._bookKeeper.rangeResized(r,void 0,0)}if(null!==i&&i.from+i.count===s.from){const e=i.from,t=i.count;G._fuse(i,s),G._removeRange(s),this._bookKeeper.rangeResized(i,e,t),this._bookKeeper.rangeResized(s,void 0,0)}this._freeHead=null!==s.prev?this._freeHead:s}get fragmentation(){const e=this._size-this._allocated;return 0===e?0:1-this._bookKeeper.largestRange.count/e}static _removeRange(e){null!==e.prev?null!==e.next?(e.prev.next=e.next,e.next.prev=e.prev):e.prev.next=null:null!==e.next&&(e.next.prev=null)}static _fuse(e,t){e.count+=t.count,e.next=t.next,t.from+=t.count,t.count=0,null!==t.next&&(t.next.prev=e)}}const z=["FILL","LINE","MARKER","TEXT","LABEL"];class B{constructor(e,t,i,r){this._strides=e,this._displayList=t,this._freeListsAndStorage={},this._dirtyMap=null,this._dirtyMap=i;for(const t in e){this._freeListsAndStorage[t]={vtxFreeList:r?new G(r):null,idxFreeList:r?new G(r):null,vertexBuffers:{},indexBuffer:r?new Uint32Array(r):null};for(const i in e[t])this._freeListsAndStorage[t].vertexBuffers[i]={data:r?(0,_.R)(r,e[t][i]):null,stride:e[t][i]}}}static fromTileData(e,t){const i=function(e){const t=e.getStrides(),i={};for(let e=0;e<t.length;e++)i[z[e]]=t[e];return i}(e),r=[0,0,0,0,0],s=[0,0,0,0,0],n=e.tileDisplayData.displayObjects;for(const e of n)for(const t of e.displayRecords)r[t.geometryType]=Math.max(r[t.geometryType],t.vertexFrom+t.vertexCount),s[t.geometryType]=Math.max(s[t.geometryType],t.indexFrom+t.indexCount);const a=new B(i,e.tileDisplayData.displayList,t,null);for(let t=0;t<e.tileBufferData.geometries.length;++t){const i=r[t],n=s[t],o=e.tileBufferData.geometries[t],l=z[t],h=a._storageFor(l),u=e.tileBufferData.geometries[t].indexBuffer;let c;h.indexBuffer=u,h.idxFreeList=new G(u.length),h.idxFreeList.allocate(n);for(const i in o.vertexBuffer){const r=e.tileBufferData.geometries[t].vertexBuffer[i];h.vertexBuffers[i].data=r.data,h.vertexBuffers[i].stride=r.stride;const s=(0,_.C)(r.stride),n=r.data.length*s/r.stride;c||(c=n)}h.vtxFreeList=new G(c),h.vtxFreeList.allocate(i)}return a}delete(e){const t=z[e.geometryType];this._freeVertices(t,e.vertexFrom,e.vertexCount),this._freeIndices(t,e.indexFrom,e.indexCount),this._displayList.removeFromList(e),e.vertexFrom=void 0,e.indexFrom=void 0}setMeshData(e,t,i,r,s){const n=z[e.geometryType];let a,o;e.meshData=null,void 0===e.vertexFrom?(o=t.vertexCount,a=this._allocateVertices(n,o)):t.vertexCount>e.vertexCount?(this._freeVertices(n,e.vertexFrom,e.vertexCount),o=t.vertexCount,a=this._allocateVertices(n,o)):t.vertexCount===e.vertexCount?(a=e.vertexFrom,o=e.vertexCount):(this._freeVertices(n,e.vertexFrom+t.vertexCount,e.vertexCount-t.vertexCount),a=e.vertexFrom,o=t.vertexCount);let l,h,u,c=!0;if(void 0===e.indexFrom?(l=s,u=t.indexCount,h=this._allocateIndices(n,u)):t.indexCount>e.indexCount?(l=this._displayList.removeFromList(e),this._freeIndices(n,e.indexFrom,e.indexCount),u=t.indexCount,h=this._allocateIndices(n,u)):t.indexCount===e.indexCount?(c=!1,h=e.indexFrom,u=e.indexCount):(l=this._displayList.removeFromList(e),this._freeIndices(n,e.indexFrom+t.indexCount,e.indexCount-t.indexCount),h=e.indexFrom,u=t.indexCount),-1!==a&&-1!==h){const s=this._storageFor(n);if((0,_._)(a,h,s.vertexBuffers,s.indexBuffer,t,i,r),e.vertexFrom=a,e.indexFrom=h,e.vertexCount=t.vertexCount,e.indexCount=t.indexCount,this._dirtyMap){this._dirtyMap.markDirtyIndices(e.geometryType,e.indexFrom,e.indexCount);for(const t in i)this._dirtyMap.markDirtyVertices(e.geometryType,t,e.vertexFrom,e.vertexCount)}return c&&this._displayList.addToList(e,l),!0}return-1!==a&&this._freeVertices(n,a,o),-1!==h&&this._freeIndices(n,h,u),e.setMeshDataFromBuffers(t,i,r),e.vertexFrom=void 0,e.vertexCount=0,e.indexFrom=void 0,e.indexCount=0,!1}tryAddMeshData(e,t){const i=t.vertexBuffer,r=t.indexBuffer,s=z[e.geometryType],n=this._allocateVertices(s,e.vertexCount);if(-1===n)return this._freeVertices(s,n,e.vertexCount),!1;const a=this._allocateIndices(s,e.indexCount);if(-1===a)return this._freeVertices(s,n,e.vertexCount),this._freeIndices(s,a,e.indexCount),!1;const o=this._storageFor(s);if((0,_._)(n,a,o.vertexBuffers,o.indexBuffer,e,i,r),e.vertexFrom=n,e.indexFrom=a,this._dirtyMap){this._dirtyMap.markDirtyIndices(e.geometryType,e.indexFrom,e.indexCount);for(const t in i)this._dirtyMap.markDirtyVertices(e.geometryType,t,n,e.vertexCount)}return this._displayList.addToList(e),!0}_allocateVertices(e,t){const i=this._storageFor(e),r=i.vtxFreeList.allocate(t);return-1===r||i.vtxFreeList.fragmentation>.5?-1:r}_freeVertices(e,t,i){this._storageFor(e).vtxFreeList.free(t,i)}_freeIndices(e,t,i){this._storageFor(e).idxFreeList.free(t,i)}_allocateIndices(e,t){const i=this._storageFor(e),r=i.idxFreeList.allocate(t);return-1===r||i.idxFreeList.fragmentation>.5?-1:r}_storageFor(e){return this._freeListsAndStorage[e]}_stridesFor(e,t){return this._strides[e][t]}}class j{constructor(e){this.geometryMap=(0,_.D)((()=>({indexBuffer:x.h.createIndex(e,35044),vao:null})),((t,i)=>({vertexBuffer:x.h.createVertex(e,_.q[i])})))}dispose(){for(let e=0;e<5;e++){const t=this.geometryMap[e];if(t){t.data.vao&&t.data.vao.dispose(!1),t.data.indexBuffer&&t.data.indexBuffer.dispose();for(const e in t.buffers)t.buffers[e]&&t.buffers[e].data.vertexBuffer.dispose()}}}get(e){const t=this.geometryMap[e];return{draw(e,i,r,s,n){if(!t.data.vao){const s={};for(const e in t.buffers)s[e]=t.buffers[e].data.vertexBuffer;t.data.vao=new x.f(e,r,i,s,t.data.indexBuffer)}const a=t.data.vao;e.bindVAO(a),e.drawElements(4,n,5125,Uint32Array.BYTES_PER_ELEMENT*s),e.bindVAO(null)}}}has(e){return null!=this.geometryMap[e]}upload(e,t){t.forEach(((t,i)=>{this._upload(t,i,e)}))}_upload(e,t,i){if(e.indices&&(e.indices.allDirty?this._uploadIndices(i,t):null!=e.indices.from&&null!=e.indices.count&&this._uploadIndices(i,t,e.indices.from,e.indices.count)),e.vertices){const r=e.vertices;for(const e in r){const s=r[e];s.allDirty?this._uploadVertices(i,t,e):null!=s.from&&null!=s.count&&this._uploadVertices(i,t,e,s.from,s.count)}}}_uploadVertices(e,t,i,r,s){const n=this.geometryMap[t];if(!n)return;const a=e.geometries[t].vertexBuffer[i];if(!a)return;const o=a.stride,l=a.data.buffer;n.buffers[i]&&l.byteLength>0&&(null!=r&&null!=s?n.buffers[i].data.vertexBuffer.setSubData(l,r*o,r*o,(r+s)*o):n.buffers[i].data.vertexBuffer.setData(l))}_uploadIndices(e,t,i,r){const s=this.geometryMap[t];if(!s)return;const n=e.geometries[t].indexBuffer.buffer;s.data.indexBuffer&&n.byteLength>0&&(null!=i&&null!=r?s.data.indexBuffer.setSubData(n,4*i,4*i,4*(i+r)):s.data.indexBuffer.setData(n))}}class q extends v.r{constructor(){super(...arguments),this._data=null,this._displayList=null,this._lastCommitTime=0,this._hasData=!1,this._invalidated=!1,this._wglBuffers=null,this._dirtyMap=new V}destroy(){super.destroy(),this.clear()}get hasData(){return!!this._hasData}get displayObjects(){var e;return null!=(e=this._displayObjects)?e:[]}getGeometry(e){return this._wglBuffers&&this._wglBuffers.has(e)?this._wglBuffers.get(e):null}getDisplayList(){return this._displayList}patch(e){if(!0===e.clear)return this.clear(),void(this._hasData=!1);const t=e.addOrUpdate,i=e.remove;!this._data&&t&&t.tileDisplayData.displayObjects.length?(t.tileDisplayData.computeDisplayList(),this._dirtyMap=new V,this._dispRecStore=B.fromTileData(t,this._dirtyMap),this._data=t,this._dirtyMap.markAllDirty(),this._hasData=!0,e.end&&this.ready()):this._data&&(t&&t.tileDisplayData.displayObjects.length||i.length)?this._doPatchData(e):e.end&&this.ready(),e.end&&!this._data&&this.clear(),this.requestRender(),this.emit("change")}commit(e){e.time&&e.time===this._lastCommitTime||(this._lastCommitTime=e.time,this.visible&&this._data&&(this._wglBuffers||(this._wglBuffers=new j(e.context)),(this._dirtyMap.hasDirty()||this._invalidated)&&(this._invalidated=!1,this._wglBuffers.upload(this._data.tileBufferData,this._dirtyMap),this._displayList=this._data.tileDisplayData.displayList.clone(),this._displayObjects=this._data.tileDisplayData.displayObjects.slice(),this._dirtyMap.markAllClean())))}clear(){this._data=null,this._displayList=null,this._dispRecStore=null,this._wglBuffers&&(this._wglBuffers.dispose(),this._wglBuffers=null)}_doPatchData(e){this._invalidated=!0,this._patchData(e)||(this._dirtyMap.markAllDirty(),this._data.reshuffle(),this._dispRecStore=B.fromTileData(this._data,this._dirtyMap)),this.requestRender()}_patchData(e){let t=!0;const i=e.addOrUpdate&&e.addOrUpdate.tileDisplayData&&e.addOrUpdate.tileDisplayData.displayObjects||[],r=(e.remove||[]).slice();for(const e of i)null!=e.insertAfter&&r.push(e.id);for(const e of r){const t=this._data.tileDisplayData.displayObjectRegistry.get(e);if(t){this._data.tileDisplayData.displayList.removeFromList(t.displayRecords);for(const e of t.displayRecords)this._dispRecStore.delete(e);this._data.tileDisplayData.displayObjectRegistry.delete(e);const i=this._data.tileDisplayData.displayObjects.indexOf(t);this._data.tileDisplayData.displayObjects.splice(i,1)}}for(const r of i){let i,s=this._data.tileDisplayData.displayObjectRegistry.get(r.id);if(s){const e=s.displayRecords;s.set(r),s.displayRecords=e;const t=s.displayRecords.length;for(let e=0;e<t;++e){const t=s.displayRecords[e],i=r.displayRecords[e];(e>=r.displayRecords.length||t.geometryType!==i.geometryType||t.symbolLevel!==i.symbolLevel||t.zOrder!==i.zOrder||t.materialKey!==i.materialKey)&&(this._dispRecStore.delete(s.displayRecords[e]),e<r.displayRecords.length&&(s.displayRecords[e]=void 0))}s.displayRecords.length=r.displayRecords.length}else{let e;s=r.copy(),s.displayRecords=[],this._data.tileDisplayData.displayObjectRegistry.set(r.id,s);const t=this._data.tileDisplayData.displayObjects;if(null!=s.insertAfter)if(i={},s.insertAfter>=0){const i=this._data.tileDisplayData.displayObjectRegistry.get(s.insertAfter);i?(e=t.indexOf(i)+1,e<t.length?t.splice(e,0,s):(t.push(s),e=t.length)):(t.push(s),e=t.length)}else t.unshift(s),e=0;else t.push(s),e=t.length;if(i){const s=r.displayRecords.length>0?1:0;let n=0;for(let r=e-1;r>=0&&n<s;--r)for(let e=t[r].displayRecords.length-1;e>=0&&n<s;--e){const s=t[r].displayRecords[e],a=this._data.tileDisplayData.displayList.getDPInfoType();i[a]||(i[a]=s,++n)}}}const n=r.displayRecords.length;for(let a=0;a<n;++a){const n=r.displayRecords[a];let o=s.displayRecords[a];o?(o.meshData=n.meshData,o.materialKey=n.materialKey):(o=n.copy(),o.vertexFrom=void 0,o.indexFrom=void 0,s.displayRecords[a]=o);const l=n.geometryType,h=this._data.tileDisplayData.displayList.getDPInfoType(),u=e.addOrUpdate.tileBufferData.geometries[l],c=u.vertexBuffer,d=u.indexBuffer;let p;i&&(p=i[h]?this._data.tileDisplayData.displayList.splitAfter(i[h]):-1),t=this._dispRecStore.setMeshData(o,n,c,d,p)&&t,i&&null!=o.indexFrom&&null!=o.indexFrom&&(i[h]=o)}}return t}}class H{constructor(){this._byGeometryType=null}get satisfied(){return!this._byGeometryType}reset(){this._byGeometryType=null}verticesFor(e){return this._byGeometryType?this._byGeometryType[e].vertices:0}indicesFor(e){return this._byGeometryType?this._byGeometryType[e].indices:0}needMore(e,t,i){if(!t&&!i)return;this._byGeometryType||(this._byGeometryType=[{vertices:0,indices:0},{vertices:0,indices:0},{vertices:0,indices:0},{vertices:0,indices:0},{vertices:0,indices:0}]);const r=this._byGeometryType[e];r.vertices+=t,r.indices+=i}}class W{constructor(){this.geometries=[{indexBuffer:void 0,vertexBuffer:{}},{indexBuffer:void 0,vertexBuffer:{}},{indexBuffer:void 0,vertexBuffer:{}},{indexBuffer:void 0,vertexBuffer:{}},{indexBuffer:void 0,vertexBuffer:{}}]}clone(){const e=new W;for(let t=0;t<this.geometries.length;t++){const i=this.geometries[t],r=e.geometries[t];r.indexBuffer=i.indexBuffer.slice(),r.vertexBuffer={};for(const e in i.vertexBuffer){const{data:t,stride:s}=i.vertexBuffer[e];r.vertexBuffer[e]={data:t.slice(),stride:s}}}return e}static deserialize(e){const t=new W;for(let i=0;i<5;++i){t.geometries[i].indexBuffer=new Uint32Array(e.geometries[i].indexBuffer),t.geometries[i].vertexBuffer={};for(const r in e.geometries[i].vertexBuffer)t.geometries[i].vertexBuffer[r]={data:(0,_.a)(e.geometries[i].vertexBuffer[r].data,e.geometries[i].vertexBuffer[r].stride),stride:e.geometries[i].vertexBuffer[r].stride}}return t}serialize(){const e={geometries:[{indexBuffer:this.geometries[0].indexBuffer.buffer,vertexBuffer:{}},{indexBuffer:this.geometries[1].indexBuffer.buffer,vertexBuffer:{}},{indexBuffer:this.geometries[2].indexBuffer.buffer,vertexBuffer:{}},{indexBuffer:this.geometries[3].indexBuffer.buffer,vertexBuffer:{}},{indexBuffer:this.geometries[4].indexBuffer.buffer,vertexBuffer:{}}]};for(let t=0;t<5;++t)for(const i in this.geometries[t].vertexBuffer)e.geometries[t].vertexBuffer[i]={data:this.geometries[t].vertexBuffer[i].data.buffer,stride:this.geometries[t].vertexBuffer[i].stride};return e}getBuffers(){const e=[];for(let t=0;t<5;++t){e.push(this.geometries[t].indexBuffer.buffer);for(const i in this.geometries[t].vertexBuffer)e.push(this.geometries[t].vertexBuffer[i].data.buffer)}return e}}function Q(e,t,i,...r){t<e.length?e.splice(t,i,...r):e.push(...r)}const Z=new Map;Z.set(_.I.MAP,[_.E.FILL,_.E.LINE,_.E.MARKER,_.E.TEXT]),Z.set(_.I.LABEL,[_.E.LABEL]),Z.set(_.I.LABEL_ALPHA,[_.E.LABEL]);class Y{constructor(){this.symbolLevels=[]}replay(e,t,i){for(const r of this.symbolLevels)for(const s of r.zLevels){const r=s.geometryDPInfo.unified;if(r)for(const s of r){const r=e.painter.getGeometryBrush(s.geometryType),n=t.getGeometry(s.geometryType),a={geometryType:s.geometryType,materialKey:s.materialKey,indexFrom:s.indexFrom,indexCount:s.indexCount,draw:(e,t,i)=>{n.draw(e,t,i,s.indexFrom,s.indexCount)}};r.prepareState(e,t),r.drawGeometry(e,t,a,i)}}}get empty(){return!this.symbolLevels||0===this.symbolLevels.length}clear(){this.symbolLevels.length=0}addToList(e,t){if(Array.isArray(e))for(const i of e)this._addToList(i,t);else this._addToList(e,t)}removeFromList(e){Array.isArray(e)||(e=[e]);let t=null;for(const i of e)t=this._removeFromList(i);return t}clone(){const e=new Y;for(const t of this.symbolLevels)e.symbolLevels.push(t.clone());return e}splitAfter(e){const t=this._getDisplayList(e.symbolLevel,e.zOrder),i=t.length,r=e.indexFrom+e.indexCount;for(let s=0;s<i;++s){const i=t[s];if(i.geometryType===e.geometryType&&r>i.indexFrom&&r<=i.indexFrom+i.indexCount){if(r<i.indexFrom+i.indexCount){const e=new J;e.geometryType=i.geometryType,e.materialKey=i.materialKey,e.indexFrom=r,e.indexCount=i.indexFrom+i.indexCount-r,t.splice(s+1,0,e),i.indexCount=r-i.indexFrom}return s}}}_addToList(e,t){const i=e.symbolLevel,r=e.zOrder,s=this._getDisplayList(i,r),n=null!=t?t:s.length-1,a=n>=0&&n<s.length?s[n]:null;if(null!==a&&a.materialKey===e.materialKey&&a.indexFrom+a.indexCount===e.indexFrom&&a.geometryType===e.geometryType)a.indexCount+=e.indexCount;else{const t=new J;t.indexFrom=e.indexFrom,t.indexCount=e.indexCount,t.materialKey=e.materialKey,t.geometryType=e.geometryType,Q(s,n+1,0,t)}}_removeFromList(e){const t=e.symbolLevel,i=e.zOrder,r=this._getDisplayList(t,i),s=r.length;let n;for(let t=0;t<s;++t){const i=r[t];if(e.indexFrom+e.indexCount>i.indexFrom&&e.indexFrom<i.indexFrom+i.indexCount&&i.geometryType===e.geometryType){n=t;break}}if(void 0!==n){const t=r[n];if(e.indexFrom===t.indexFrom)return t.indexCount-=e.indexCount,t.indexFrom+=e.indexCount,0===t.indexCount&&Q(r,n,1),n-1;if(e.indexFrom+e.indexCount===t.indexFrom+t.indexCount)return t.indexCount-=e.indexCount,0===t.indexCount?(Q(r,n,1),n-1):n;{const i=t.indexFrom,s=e.indexFrom-t.indexFrom,a=e.indexCount,o=t.indexFrom+t.indexCount-(e.indexFrom+e.indexCount);t.indexCount=s;const l=new J;return l.geometryType=t.geometryType,l.materialKey=t.materialKey,l.indexFrom=i+s+a,l.indexCount=o,Q(r,n+1,0,l),n}}return null}_getDisplayList(e,t){let i;const r=this.symbolLevels.length;for(let t=0;t<r;t++)if(this.symbolLevels[t].symbolLevel===e){i=this.symbolLevels[t];break}let s;i||(i=new K,i.symbolLevel=e,this.symbolLevels.push(i));const n=i.zLevels.length;for(let e=0;e<n;e++)if(i.zLevels[e].zLevel===t){s=i.zLevels[e];break}return s||(s=new $,s.geometryDPInfo=new X,s.zLevel=t,i.zLevels.push(s)),s.geometryDPInfo.unified||(s.geometryDPInfo.unified=[]),s.geometryDPInfo.unified}getDPInfoType(){return"unified"}}class J{constructor(){this.materialKey=null,this.indexFrom=0,this.indexCount=0}clone(){const e=new J;return e.geometryType=this.geometryType,e.materialKey=this.materialKey,e.indexFrom=this.indexFrom,e.indexCount=this.indexCount,e}}class X{constructor(){this.fill=null,this.line=null,this.marker=null,this.text=null,this.label=null,this.unified=null}clone(){const e=new X;return e.fill=this.fill&&this.fill.map((e=>e.clone())),e.line=this.line&&this.line.map((e=>e.clone())),e.marker=this.marker&&this.marker.map((e=>e.clone())),e.text=this.text&&this.text.map((e=>e.clone())),e.label=this.label&&this.label.map((e=>e.clone())),e.unified=this.unified&&this.unified.map((e=>e.clone())),e}}class ${constructor(){this.geometryDPInfo=new X}clone(){const e=new $;return e.zLevel=this.zLevel,e.geometryDPInfo=this.geometryDPInfo.clone(),e}}class K{constructor(){this.zLevels=[]}clone(){const e=new K;e.symbolLevel=this.symbolLevel;for(const t of this.zLevels)e.zLevels.push(t.clone());return e}}class ee{constructor(){this.vertexData=new Map,this.vertexCount=0,this.indexData=[]}clear(){this.vertexData.clear(),this.vertexCount=0,this.indexData=[]}update(e,t,i){for(const t in e)this.vertexData.set(t,e[t]);for(const t in this.vertexData)null===e[t]&&this.vertexData.delete(t);this.vertexCount=t,this.indexData=i}}class te{constructor(e,t,i,r=0,s=0){this.id=e,this.geometryType=t,this.materialKey=i,this.minZoom=r,this.maxZoom=s,this.meshData=null,this.symbolLevel=0,this.zOrder=0,this.vertexFrom=0,this.vertexCount=0,this.indexFrom=0,this.indexCount=0}get sortKey(){return void 0===this._sortKey&&this._computeSortKey(),this._sortKey}clone(){return this.copy()}copy(){const e=new te(this.id,this.geometryType,this.materialKey);return e.vertexFrom=this.vertexFrom,e.vertexCount=this.vertexCount,e.indexFrom=this.indexFrom,e.indexCount=this.indexCount,e.zOrder=this.zOrder,e.symbolLevel=this.symbolLevel,e.meshData=this.meshData,e.minZoom=this.minZoom,e.maxZoom=this.maxZoom,e}setMeshDataFromBuffers(e,t,i){const r=new ee;for(const i in t){const s=t[i].stride,n=t[i].data,a=[],o=(0,_.C)(s);for(let t=0;t<s*e.vertexCount/o;++t)a[t]=n[t+s*e.vertexFrom/o];r.vertexData.set(i,a)}r.indexData.length=0;for(let t=0;t<e.indexCount;++t)r.indexData[t]=i[t+e.indexFrom]-e.vertexFrom;r.vertexCount=e.vertexCount,this.meshData=r}readMeshDataFromBuffers(e,t){this.meshData?this.meshData.clear():this.meshData=new ee;for(const t in e){const i=e[t].stride,r=e[t].data,s=[],n=(0,_.C)(i);for(let e=0;e<i*this.vertexCount/n;++e)s[e]=r[e+i*this.vertexFrom/n];this.meshData.vertexData.set(t,s)}this.meshData.indexData.length=0;for(let e=0;e<this.indexCount;++e)this.meshData.indexData[e]=t[e+this.indexFrom]-this.vertexFrom;this.meshData.vertexCount=this.vertexCount}writeMeshDataToBuffers(e,t,i,r){for(const i in t){const r=t[i].stride,s=this.meshData.vertexData.get(i),n=t[i].data,a=(0,_.C)(r);for(let t=0;t<r*this.meshData.vertexCount/a;++t)n[t+r*e/a]=s[t]}for(let t=0;t<this.meshData.indexData.length;++t)r[t+i]=this.meshData.indexData[t]+e;this.vertexFrom=e,this.vertexCount=this.meshData.vertexCount,this.indexFrom=i,this.indexCount=this.meshData.indexData.length}static writeAllMeshDataToBuffers(e,t,i){let r=0,s=0;for(const n of e)n.writeMeshDataToBuffers(r,t,s,i),r+=n.vertexCount,s+=n.indexCount}_computeSortKey(){this._sortKey=(31&this.symbolLevel)<<12|(127&this.zOrder)<<4|7&this.geometryType}serialize(e){return e.push(this.geometryType),e.push(this.materialKey),e.push(this.vertexFrom),e.push(this.vertexCount),e.push(this.indexFrom),e.push(this.indexCount),e.push(this.minZoom),e.push(this.maxZoom),e}static deserialize(e,t){const i=e.readInt32(),r=e.readInt32(),s=new te(t.id,i,r);return s.vertexFrom=e.readInt32(),s.vertexCount=e.readInt32(),s.indexFrom=e.readInt32(),s.indexCount=e.readInt32(),s.minZoom=e.readInt32(),s.maxZoom=e.readInt32(),s}}function ie(e,t){if(null!==t){e.push(t.length);for(const i of t)i.serialize(e);return e}e.push(0)}class re{constructor(e){this.insertAfter=null,this.id=e,this.displayRecords=[]}copy(){const e=new re(this.id);return e.set(this),e}clone(){const e=new re(this.id);return e.displayRecords=this.displayRecords.map((e=>e.clone())),e.insertAfter=this.insertAfter,e}set(e){this.id=e.id,this.displayRecords=e.displayRecords,this.insertAfter=e.insertAfter}serialize(e){return e.push(this.id),ie(e,this.displayRecords),e}static deserialize(e){const t=e.readInt32(),i=new re(t),r={id:t};return i.displayRecords=function(e,t,i){const r=e.readInt32(),s=new Array(r);for(let r=0;r<s.length;r++)s[r]=t.deserialize(e,i);return s}(e,te,r),i}}class se{constructor(){}get displayObjectRegistry(){if(!this._displayObjectRegistry){this._displayObjectRegistry=new Map;for(const e of this.displayObjects)this._displayObjectRegistry.set(e.id,e)}return this._displayObjectRegistry}get displayList(){return this._displayList}computeDisplayList(){this._displayList=new Y;for(const e of this.displayObjects)for(const t of e.displayRecords)this._displayList.addToList(t)}clone(){const e=new se;return this.displayObjects&&(e.displayObjects=this.displayObjects.map((e=>e.clone()))),e}serialize(e){return ie(e,this.displayObjects),e}_deserializeObjects(e){const t=e.readInt32(),i=new Array(t),r=new Map;for(let t=0;t<i.length;++t){const s=re.deserialize(e);i[t]=s,r.set(s.id,s)}this.displayObjects=i,this._displayList=null,this._displayObjectRegistry=r}static deserialize(e){const t=new se;return t._deserializeObjects(e),t}}class ne{constructor(e,t){this.data=e,this.stride=t}static decode(e){const t=(0,_.a)(e.data,e.stride),i=e.stride;return new ne(t,i)}static fromVertexVector(e){const t=(0,_.a)(e.data.buffer(),e.stride),i=e.stride;return new ne(t,i)}}class ae{constructor(e,t,i){this.geometryType=e,this.indexBuffer=new Uint32Array(t),this.namedBuffers=i}static decode(e){const t=e.geometryType,i=e.indexBuffer,r={};for(const t in e.namedBuffers)r[t]=ne.decode(e.namedBuffers[t]);return new ae(t,i,r)}static fromVertexData(e,t){const i=e.indices,r=(0,_.a)(e.vertices,e.stride),s=e.stride,n={geometry:new ne(r,s)};return new ae(t,i,n)}static fromVertexVectors(e){const t=e.geometryType,i=e.indexVector.buffer(),r={};for(const t in e.namedVectors)r[t]=ne.fromVertexVector(e.namedVectors[t]);return new ae(t,i,r)}}class oe{constructor(e,t){this.data=e,this.stride=t}get vertexCount(){const e=this.stride/4,t=this.data.length/e;return t!==(0|t)&&console.debug("Corrupted stride"),t}transfer(e,t){const i=this.data.buffer();e.vertexCount=this.vertexCount,e.data=i,e.stride=this.stride,t.push(i)}}class le{constructor(e,t,i=!1){this.geometryType=e,this.indexVector=new y.a(Uint32Array,6*t),this.namedVectors={};const r=(0,_.T)(e,i);for(const e in r){const i=r[e];let s;switch(i%4){case 0:case 2:s=new y.a(Uint32Array,i*t);break;case 1:case 3:s=new y.a(Uint8Array,i*t)}this.namedVectors[e]=new oe(s,i)}}get(e){return this.namedVectors[e].data}getVector(e){return this.namedVectors[e]}transfer(e,t){const i=this.indexVector.buffer(),r={};t.push(i);for(const e in this.namedVectors){const i=this.namedVectors[e];r[e]={},i.transfer(r[e],t)}e.geometryType=this.geometryType,e.indexBuffer=i,e.namedBuffers=r,this.destroy()}intoBuffers(){const e=ae.fromVertexVectors(this);return this.destroy(),e}destroy(){this.indexVector=null,this.namedVectors=null}}const he=new H,ue=new H;function ce(e,t){const i={};for(const r in e){const s={data:(0,_.R)(t,e[r]),stride:e[r]};i[r]=s}return i}class de{constructor(){this.tileDisplayData=null,this.tileBufferData=null}reshuffle(){he.reset();const e=function(e){const t=[[],[],[],[],[]],i=e;for(const e of i)for(const i of e.displayRecords)t[i.geometryType].push(i);return t}(this.tileDisplayData.displayObjects);for(const t of e)for(const e of t)e&&he.needMore(e.geometryType,e.meshData?e.meshData.vertexCount:e.vertexCount,e.meshData?e.meshData.indexData.length:e.indexCount);const t=e.length,i=new W;for(let e=0;e<t;++e){i.geometries[e].indexBuffer=new Uint32Array(Math.round(1.5*he.indicesFor(e)));const t=[];for(const i in this.tileBufferData.geometries[e].vertexBuffer)t.push(this.tileBufferData.geometries[e].vertexBuffer[i].stride);const r=de._computeVertexAlignment(t),s=Math.round(1.5*he.verticesFor(e)),n=de._align(s,r);for(const t in this.tileBufferData.geometries[e].vertexBuffer){const r=this.tileBufferData.geometries[e].vertexBuffer[t].stride;i.geometries[e].vertexBuffer[t]={stride:r,data:(0,_.R)(n,r)}}}ue.reset(),this.tileDisplayData.displayList.clear();for(let r=0;r<t;++r){const t=e[r];for(const e of t){if(e.meshData)e.writeMeshDataToBuffers(ue.verticesFor(r),i.geometries[r].vertexBuffer,ue.indicesFor(r),i.geometries[r].indexBuffer),e.meshData=null;else{const t=this.tileBufferData.geometries[r].vertexBuffer,s=this.tileBufferData.geometries[r].indexBuffer,n=i.geometries[r].vertexBuffer,a=i.geometries[r].indexBuffer,o=ue.verticesFor(r),l=ue.indicesFor(r);(0,_._)(o,l,n,a,e,t,s),e.vertexFrom=o,e.indexFrom=l}ue.needMore(r,e.vertexCount,e.indexCount)}}for(const e of this.tileDisplayData.displayObjects)this.tileDisplayData.displayList.addToList(e.displayRecords);this.tileBufferData=i}getStrides(){const e=[];for(let t=0;t<this.tileBufferData.geometries.length;++t){const i=this.tileBufferData.geometries[t];e[t]={};for(const r in i.vertexBuffer)e[t][r]=i.vertexBuffer[r].stride}return e}clone(){const e=new de;return e.tileBufferData=this.tileBufferData.clone(),e.tileDisplayData=this.tileDisplayData.clone(),e}_guessSize(){const{displayObjects:e}=this.tileDisplayData,t=Math.min(e.length,4);let i=0;for(let r=0;r<t;r++)i=Math.max(i,e[r].displayRecords.length);return 2*(12*e.length+e.length*i*40)}serialize(){const e=this.tileBufferData.serialize(),t=this.tileBufferData.getBuffers(),i=this.tileDisplayData.serialize(new y.a(Int32Array,this._guessSize())).buffer();return t.push(i),{result:{displayData:i,bufferData:e},transferList:t}}static fromVertexData(e,t){const i={},r=new Map;for(const e of t)r.set(e.id,e);return(0,_.r)((t=>{const s=e.data[t];if((0,n.r)(s)){const e=y.r.from(s.records).getCursor();for(;e.next();){const i=e.id,s=e.materialKey,n=e.indexFrom,a=e.indexCount,o=e.vertexFrom,l=e.vertexCount,h=r.get(i),u=new te(i,t,s);u.indexFrom=n,u.indexCount=a,u.vertexFrom=o,u.vertexCount=l,h.displayRecords.push(u)}i[t]=ae.fromVertexData(s,t)}else i[t]=new le(t,0).intoBuffers()})),de.fromMeshData({displayObjects:t,vertexBuffersMap:i})}static fromMeshData(e){const t=new de,i=new se,r=new W;i.displayObjects=e.displayObjects;for(const t in e.vertexBuffersMap){const i=e.vertexBuffersMap[t];r.geometries[t].indexBuffer=i.indexBuffer,r.geometries[t].vertexBuffer=i.namedBuffers}return t.tileDisplayData=i,t.tileBufferData=r,t}static bind(e,t){const i=new de;return i.tileDisplayData=e,i.tileBufferData=t,i}static create(e,t){const i=new de;i.tileDisplayData=new se,i.tileDisplayData.displayObjects=e;const r=[0,0,0,0,0],s=[0,0,0,0,0],n=[[],[],[],[],[]];for(const t of e)for(const e of t.displayRecords)n[e.geometryType].push(e),r[e.geometryType]+=e.meshData.vertexCount,s[e.geometryType]+=e.meshData.indexData.length;const a=new W,o=function(e){return[e.fill||{},e.line||{},e.icon||{},e.text||{},e.label||{}]}(t);for(let e=0;e<5;e++){const t=new Uint32Array(s[e]),i=ce(o[e],r[e]);te.writeAllMeshDataToBuffers(n[e],i,t),a.geometries[e]={indexBuffer:t,vertexBuffer:i}}return i.tileBufferData=a,i}static _align(e,t){const i=e%t;return 0===i?e:e+(t-i)}static _computeVertexAlignment(e){let t=!1,i=!1;for(const r of e)r%4==2?t=!0:r%4!=0&&(i=!0);return i?4:t?2:1}}class pe extends w.c{constructor(e,t){super(e,t,null)}static from(e){const t=I.h.createInstance(),i=[],r=e.filter((e=>!!e.geometry));for(const e of r){const t=(0,d.d)(e.geometry);(0,S.Q)(i,[e],t,!1,!1,"uid")}return new pe(t,i)}get geometryType(){const e=this._current;return e?e.geometryType:null}get insertAfter(){return this._current.insertAfter}readGraphic(){return this._current}getCursor(){return this.copy()}copy(){const e=new pe(this.instance,this._features);return this.copyInto(e),e}}const fe=new E.a,ye=new E.a,me="esriGeometryPolyline";function ge(e){e.coords.length=0,e.lengths.length=0}class _e{constructor(){this.bounds=(0,c.i)(),this.graphic=null,this.size=[0,0,0,0]}static acquire(e=null,t,i,r,s,n){let a;return 0===_e._pool.length?a=new _e:(a=_e._pool.pop(),this._set.delete(a)),a.acquire(e,t,i,r,s,n),a}static release(e){e&&!this._set.has(e)&&(e.release(),this._pool.push(e),this._set.add(e))}static getCentroidQuantized(e,t){if((0,d.y)(e.geometry)){const i=e.symbol;if((0,n.t)(i))return null;if((0,b.H)(i.type)||(0,b.C)(i.type)){const i=(0,h.g)(e.geometry);return(0,T.L)(t,{},{x:i[0],y:i[1]},!1,!1)}}return null}acquire(e=null,t,i,r,s,n){e&&this.set(e,t,i,r,s,n)}release(){this.graphic=null,this.symbolResource=null,this.geometry=null}get symbol(){return this.symbolResource.symbol}set(e,t,i,r,s,n){this.graphic=e,this.geometry=i,this.symbolResource=t,this.resolution=r,this.updateBounds(r,s,n)}updateBounds(e,t,i){(0,b.A)(this.bounds,this.size,this.symbolResource,this.geometry,e,t,i)}getGeometryQuantized(e,t){const i=this.geometry;if((0,d.y)(i)){const t=i.rings;if(1===t.length&&2===t[0].length)return(0,T.d)(e,{paths:[[t[0][0],t[0][1]]]})}else{if((0,d.f)(i))return ge(fe),ge(ye),(0,S.U)(fe,i),(0,S.l)(ye,fe,i.hasZ,i.hasM,me,e.scale[0]),(0,S.c)(fe,ye,i.hasZ,i.hasM,me,e),(0,S.A)(fe,i.hasZ,i.hasM);if((0,d.s)(i)){const r=.5*this.resolution*this.size[0],s=i.points.filter((e=>(0,c.j)(t,e,r)));return 0===s.length?{points:s}:(0,T.d)(e,{points:s})}}return(0,T.d)(e,this.geometry)}}_e._pool=[],_e._set=new Set;const xe={minX:0,minY:0,maxX:0,maxY:0},ve=(0,c.i)(),be=1e-5;function we(e,t,i,r,s){return xe.minX=t,xe.minY=i,xe.maxX=r,xe.maxY=s,e.search(xe)}class Se{constructor(e,t,i,r,s,a){this._graphics=r,this._onAdd=s,this._onRemove=a,this._index=(0,w.i)(9,(0,n.c)("csp-restrictions")?e=>({minX:e.bounds[0],minY:e.bounds[1],maxX:e.bounds[2],maxY:e.bounds[3]}):[".bounds[0]",".bounds[1]",".bounds[2]",".bounds[3]"]),this._itemByGraphic=new Map,this._currentLevel=-1/0,this._tileInfoView=e,this._uidFieldName=i;const o=e.getClosestInfoForScale(t);o&&(this._currentLevel=o.level,this._resolution=this._tileInfoView.getTileResolution(o.level));const l=e.spatialReference;this._metersPerUnit=(0,u.s)(l)?(0,C.H)(e.spatialReference):1}hitTest(e,t,i,r,s){e=(0,p.k)(e,this._tileInfoView.spatialReference);const n=.5*r*i;ve[0]=e-n,ve[1]=t-n,ve[2]=e+n,ve[3]=t+n;const a=.5*r*(i+b.P),l=we(this._index,e-a,t-a,e+a,t+a);if(!l||0===l.length)return[];const u={x:e,y:t},f=[];let y;for(const i of l)if(i.graphic.visible)switch((0,d.d)(i.geometry)){case"esriGeometryPoint":{const e=i.symbol;if(!e)continue;const t=i.geometry,{x:n,y:a}=t,o=r*this._metersPerUnit;let l;switch(e.type){case"esriTS":l=(0,b.K)(n,a,e,i.size,r,s);break;case"expanded-cim":l=(0,b.J)(n,a,e,r,o,s);break;case"esriSMS":case"esriPMS":l=(0,b.G)(n,a,e,r,o,s)}(0,h.f)(l,u)&&f.push(i)}break;case"esriGeometryPolyline":{const s=i.symbol;let n=0;if("expanded-cim"===s.type){const e=s.layers;if(!e||0===e.length)continue;const t=e.findIndex((e=>"line"===e.type));if(-1===t)continue;const i=e[t];n=(0,M.e)(i.width,null,null)}else{const e=s.layers;if(!e||0===e.length)continue;n=e[0].width}y=1.5*r*window.devicePixelRatio*(0,o.u)(n),(0,b.D)(i.geometry,e,t,y)&&f.push(i)}break;case"esriGeometryEnvelope":{const e=i.geometry,t=(0,c.u)(e.xmin,e.ymin,e.xmax,e.ymax);(0,c.F)(t,ve)&&f.push(i);break}case"esriGeometryPolygon":{if((0,h.f)(i.geometry,u)){f.push(i);break}const e=(0,h.v)(i.geometry);if(Math.abs(e.ymax-e.ymin)<5*r||Math.abs(e.xmax-e.xmin)<5*r){const t=(0,c.u)(e.xmin,e.ymin,e.xmax,e.ymax);(0,c.F)(t,ve)&&f.push(i)}break}case"esriGeometryMultipoint":{const e=i.symbol;if(!e)continue;const t=i.geometry.points;let n;for(let a=0;a<t.length;a++)if(n="esriTS"===e.type?(0,b.K)(t[a][0],t[a][1],e,i.size,r,s):(0,b.G)(t[a][0],t[a][1],e,r,r*this._metersPerUnit,s),(0,h.f)(n,u)){f.push(i);break}break}}return f.sort(((e,t)=>{const i=(0,b.W)(e.graphic),r=(0,b.W)(t.graphic);return i===r?t.zorder-e.zorder:i-r})),f.map((e=>e.graphic))}getGraphicsData(e,t,i){const r=this._searchForItems(t);if(0===r.length||0===i.length)return[];r.sort(((e,t)=>e.zorder-t.zorder)),r[0].insertAfter=-1;for(let e=1;e<r.length;e++)r[e].insertAfter=r[e-1].graphic.uid;r.sort(((e,t)=>e.graphic.uid-t.graphic.uid)),i.sort(((e,t)=>e.uid-t.uid));let s,n=0,a=0;const o=[],l={originPosition:"upperLeft",scale:[t.resolution,t.resolution],translate:[t.bounds[0],t.bounds[3]]};for(const h of i){for(a=-2;n<r.length;)if(s=r[n],n++,h.uid===s.graphic.uid){a=s.insertAfter;break}if(!s.geometry||-2===a)continue;const i=s.getGeometryQuantized(l,t.bounds),u={...s.graphic.attributes};u[this._uidFieldName]=h.uid,null==s.groupId&&(s.groupId=e.createTemplateGroup(s.symbol,null)),o.push({centroid:_e.getCentroidQuantized(s,l),geometry:i,attributes:u,symbol:s.symbol,groupId:s.groupId,insertAfter:a,zorder:s.zorder})}return o.sort(((e,t)=>e.zorder-t.zorder)),o}queryTileData(e,t){const{bounds:i,resolution:r}=t,s=this._searchForItems(t),n=[];return 0===s.length||this._createTileGraphics(n,e,s,{originPosition:"upperLeft",scale:[r,r],translate:[i[0],i[3]]},t.bounds),n}has(e){return this._itemByGraphic.has(e)}getBounds(e){return this._itemByGraphic.has(e)?this._itemByGraphic.get(e).bounds:null}addOrModify(e,t,i){if(!e)return;this.has(e)&&this.remove(e),this._onAdd(e);const r=_e.acquire(e,t,i,this._resolution,this._resolution*this._metersPerUnit,this._tileInfoView.spatialReference);return this._itemByGraphic.set(e,r),i&&this._index.insert(r),r.bounds}remove(e){if(!this._itemByGraphic.has(e))return;this._onRemove(e);const t=this._itemByGraphic.get(e);this._index.remove(t),this._itemByGraphic.delete(e)}updateZ(){const e=this._graphics.items;let t,i;for(let r=0;r<e.length;r++)i=e[r],t=this._itemByGraphic.get(i),t&&(t.zorder=r)}update(e,t,i){const r=this._itemByGraphic.get(e);r.groupId=null;const s=(0,c.e)(r.bounds);return r.size[0]=r.size[1]=0,this._index.remove(r),r.set(e,t,i,this._resolution,this._resolution*this._metersPerUnit,this._tileInfoView.spatialReference),i&&this._index.insert(r),{oldBounds:s,newBounds:r.bounds}}updateLevel(e){if(this._currentLevel===e)return;this._currentLevel=e;const t=this._tileInfoView,i=t.getTileResolution(e);this._resolution=i,this._index.clear();const r=this._itemByGraphic,s=[];for(const[e,i]of r)i.updateBounds(this._resolution,this._resolution*this._metersPerUnit,t.spatialReference),i.geometry&&s.push(i);this._index.load(s)}clear(){this._itemByGraphic.clear(),this._index.clear()}_createTileGraphics(e,t,i,r,s){const n=this._uidFieldName;let a,o,l,h;i.sort(((e,t)=>e.zorder-t.zorder));for(let u=0;u<i.length;u++){l=i[u],a=l.graphic,o=l.getGeometryQuantized(r,s),h=0===u?-1:i[u-1].graphic.uid;const c={...l.graphic.attributes};c[n]=a.uid,null==l.groupId&&(l.groupId=t.createTemplateGroup(l.symbol,null)),e.push({centroid:_e.getCentroidQuantized(l,r),geometry:o,attributes:c,symbol:l.symbol,groupId:l.groupId,insertAfter:h,zorder:l.zorder})}}_searchForItems(e){const t=this._tileInfoView.spatialReference,i=e.bounds;if(t.isWrappable){const[r,s]=(0,p.a)(t),n=Math.abs(i[2]-s)<be,a=Math.abs(i[0]-r)<be;if((!n||!a)&&(n||a)){const t=e.resolution;let a;a=(0,c.i)(n?[r,i[1],r+t*b.P,i[3]]:[s-t*b.P,i[1],s,i[3]]);const o=we(this._index,i[0],i[1],i[2],i[3]),l=we(this._index,a[0],a[1],a[2],a[3]);return[...new Set([...o,...l])]}}return we(this._index,i[0],i[1],i[2],i[3])}}function Ie(e,t,i){if(i.has(e))return i.get(e);const r={tile:t,addedOrModified:[],removed:[]};return i.set(e,r),r}let Ce=class extends((0,F.t)((0,s.a)(r.p))){constructor(e){super(e),this._storage=new w.u,this._displayIds=new Map,this._controller=new AbortController,this._tiles=new Map,this._graphicStoreUpdate=!1,this._graphicsSet=new Set,this._matcher=Promise.resolve(null),this._tileUpdateSet=new Set,this._tilesToUpdate=new Map,this._graphicIdToAbortController=new Map,this._attached=!1,this._highlightIds=new Map,this._updatingGraphicsTimer=null,this._hashToExpandedSymbol=new Map,this._hashTpExpandedSymbolPromise=new Map,this._processing=!1,this._needsProcessing=!1,this._pendingUpdate={added:new Set,updated:new Set,removed:new Set},this.lastUpdateId=-1,this.updateRequested=!1,this.graphicUpdateHandler=this.graphicUpdateHandler.bind(this)}_createMatcher(e,t){if(e){const i=(0,b.a)({indexCount:0,fields:{}},"feature",e);this._matcher=(0,y.u)(i,t,null)}}_createDisplayId(e){return this._displayIds.has(e)||this._displayIds.set(e,this._storage.createDisplayId()),this._displayIds.get(e)}initialize(){this._tileStore=new w.l(this.view.featuresTilingScheme),this._attributeStore=new w.O({type:"local",initialize:e=>Promise.resolve(this.container.attributeView.initialize(e)),update:e=>this.container.attributeView.requestUpdate(e),render:()=>this.container.requestRender()},(0,A.r)()),this._graphicStore=new Se(this.view.featuresTilingScheme,this.view.state.scale,this.uid,this.graphics,(e=>{this._createDisplayId(e.uid),this._setFilterState(e.uid,e.visible)}),(e=>{const t=this._displayIds.get(e.uid);this._displayIds.delete(e.uid),this._storage.releaseDisplayId(t)}));const e=new y.k(this.container.getMaterialItems.bind(this.container),this.view.featuresTilingScheme.tileInfo);this._createMatcher(this.renderer,e),this._meshFactory=new y.i(null,this.uid,e),this._templateStore=e,this.watch("renderer",(t=>{this._createMatcher(t,e);for(const e of this.graphics)this._pendingUpdate.updated.add(e);this.requestUpdate()})),this._tileStore.on("update",this._onTileUpdate.bind(this)),this.container.on("attach",(()=>{this.graphics.items.length>0&&this._graphicsChangeHandler({target:this.graphics,added:this.graphics.items,removed:[],moved:[]}),this.handles.add(this.graphics.on("change",(e=>this._graphicsChangeHandler(e))),"graphics"),this._attached=!0,this.notifyChange("updating")}))}destroy(){this._updatingGraphicsTimer&&(clearTimeout(this._updatingGraphicsTimer),this._updatingGraphicsTimer=null,this.notifyChange("updating")),this._controller.abort(),this.container.destroy(),this._set("graphics",null),this._graphicStore.clear(),this._tileStore.destroy(),this._attributeStore=null,this._hashToExpandedSymbol.clear(),this.view=null,this.renderer=null}get updating(){return!this._attached||null!==this._updatingGraphicsTimer||this._tileUpdateSet.size>0||this._tilesToUpdate.size>0}hitTest(e,t){if(!this.view||!this.view.position)return Promise.resolve(null);const i=this.view.toMap((0,o.c)(e,t));return this.searchFeatures(i).then((e=>e&&e.length?e[0]:null))}async searchFeatures(e,t=2){return this._graphicStore.hitTest(e.x,e.y,t,this.view.state.resolution,this.view.state.rotation)}update(e){(0,a.a)(this._controller.signal);const t=e.state,i=this.view.featuresTilingScheme.getClosestInfoForScale(t.scale).level;if(this._graphicStore.updateLevel(i),this._tileStore.setViewState(t),this._graphicStoreUpdate=!0,this.updateRequested=!1,this._pendingUpdate.updated.size>0){if(!this._processing)return void this._updateGraphics();this._needsProcessing=!0}}viewChange(){this.requestUpdate()}requestUpdate(){this.updateRequested||(this.updateRequested=!0,this.requestUpdateCallback())}processUpdate(e){this.updateRequested&&(this.updateRequested=!1,this.update(e))}graphicUpdateHandler(e){const{graphic:t,property:i,newValue:r}=e;switch(i){case"attributes":break;case"geometry":case"symbol":this._pendingUpdate.updated.add(t),this.requestUpdate();break;case"visible":this._setFilterState(t.uid,r),this._attributeStore.sendUpdates()}}addHighlight(e){for(const t of e)if(this._highlightIds.has(t)){const e=this._highlightIds.get(t);this._highlightIds.set(t,e+1)}else this._highlightIds.set(t,1);this._updateHighlight()}removeHighlight(e){for(const t of e)if(this._highlightIds.has(t)){const e=this._highlightIds.get(t)-1;0===e?this._highlightIds.delete(t):this._highlightIds.set(t,e)}this._updateHighlight()}_updateHighlight(){const e=Array.from(this._highlightIds.keys()),t=e.map((e=>this._displayIds.get(e)));this._attributeStore.setHighlight(e,t)}_getIntersectingTiles(e){const t=this._graphicStore.getBounds(e);if(!t||0===(0,c.x)(t)||0===(0,c.M)(t))return[];const i=(0,b.T)(t,this.view.spatialReference);return(0,n.r)(i)?[...this._tileStore.boundsIntersections(i[0]),...this._tileStore.boundsIntersections(i[1])]:this._tileStore.boundsIntersections(t)}async _updateTile(e){(0,a.a)(this._controller.signal);const t=e.tile,i=this._getGraphicsData(this._templateStore,t,e.addedOrModified),r=await this._processGraphics(t,i);return(0,a.a)(this._controller.signal),this._patchTile(t.key,{type:"update",addOrUpdate:r,remove:e.removed,end:!0,clear:!1}),r}_patchTile(e,t){if(!this._tiles.has(e))return;const i=this._tiles.get(e);this.container.onTileData(i,t),this.container.requestRender()}_graphicsChangeHandler(e){const t=this._pendingUpdate;for(const i of e.added)t.added.add(i);for(const i of e.moved)t.updated.add(i);for(const i of e.removed)this._pendingUpdate.added.has(i)?t.added.delete(i):t.removed.add(i);this._processing?this._needsProcessing=!0:this._updateGraphics()}_getGraphicsToUpdate(){const e={added:[],removed:[],updated:[]};if(!this.graphics)return e;const t=this._pendingUpdate;for(const i of this.graphics.items)t.added.has(i)?e.added.push(i):t.updated.has(i)&&e.updated.push(i);for(const i of t.removed)this._graphicStore.has(i)&&e.removed.push(i);return t.added.clear(),t.removed.clear(),t.updated.clear(),e}async _updateGraphics(){this._processing=!0;const{added:e,removed:t,updated:i}=this._getGraphicsToUpdate(),r=this._tilesToUpdate;let s;try{if(!this._graphicStoreUpdate){const e=this.view.state,t=this.view.featuresTilingScheme.getClosestInfoForScale(e.scale).level;this._graphicStore.updateLevel(t),this._tileStore.setViewState(e)}const n=[],a=new Array(e.length+t.length);for(let e=0;e<i.length;e++){const t=i[e],o=this._getIntersectingTiles(t);for(const e of o)s=e.id,Ie(s,e,r).removed.push(this._displayIds.get(t.uid));n.push(this._updateGraphic(t,null)),a[e]=t}const o=i.length;for(let t=0;t<e.length;t++){const i=e[t];a[o+t]=i,this._graphicsSet.add(i),n.push(this._addGraphic(i))}for(const e of t){this._abortProcessingGraphic(e.uid);const t=this._getIntersectingTiles(e);for(const i of t)s=i.id,Ie(s,i,r).removed.push(this._displayIds.get(e.uid));this._graphicsSet.delete(e),this._graphicStore.remove(e)}let l;this._flipUpdatingGraphics(),await Promise.all(n);for(let e=0;e<a.length;e++){l=a[e];const t=this._getIntersectingTiles(l);for(const e of t)s=e.id,Ie(s,e,r).addedOrModified.push(l)}this._graphicStore.updateZ();const h=[];for(const[e,t]of r)h.push(this._updateTile(t));await Promise.all(h)}catch(e){(0,a.g)(e)}for(const e of t)try{const t=await this._getSymbolForGraphic(e,{});t&&this._hashToExpandedSymbol.delete(t.hash())}catch(e){(0,a.g)(e)}r.clear(),this.notifyChange("updating"),this._processing=!1,this._needsProcessing&&(this._needsProcessing=!1,this._updateGraphics())}_getArcadeInfo(e){const t=(e.attributes?Object.keys(e.attributes):[]).map((t=>({name:t,alias:t,type:"string"==typeof e.attributes[t]?"esriFieldTypeString":"esriFieldTypeDouble"})));return(0,n.t)(e.geometry)?null:{geometryType:(0,d.d)(e.geometry),spatialReference:u.k.fromJSON(e.geometry.spatialReference),fields:t}}async _getSymbolForGraphic(e,t){return(0,a.a)(this._controller.signal),(0,n.r)(e.symbol)?e.symbol:(0,n.r)(this.renderer)?this.renderer.getSymbolAsync(e,{scale:this.view.scale,abortOptions:t}):this._getNullSymbol(e)}async _getSymbolResources(e,t){if((0,a.a)(this._controller.signal),!this.container.stage)return null;const i=await this._getSymbolForGraphic(e,t),r=i.hash();let s=this._hashToExpandedSymbol.get(r);if(!s){let n=this._hashTpExpandedSymbolPromise.get(r);if(n)s=await n,(0,a.a)(this._controller.signal);else{const o=this._getArcadeInfo(e),l=(0,b.S)(i);n=(0,y.b)(l,o,t),this._hashTpExpandedSymbolPromise.set(r,n);try{s=await n,this._hashTpExpandedSymbolPromise.delete(r),this._hashToExpandedSymbol.set(r,s)}catch(e){this._hashTpExpandedSymbolPromise.delete(r),(0,a.a)(e)}}}if("esriTS"===s.type){const e=[],[t]=(0,b.n)(s.text);for(let i=0;i<t.length;i++)e.push(t.charCodeAt(i));const i={symbol:s,id:0,glyphIds:e},[{mosaicItem:r}]=await this.container.getMaterialItems([i]);return{symbol:s,mosaicItem:r}}return{symbol:s,mosaicItem:null}}async _projectAndNormalizeGeometry(e,t){if((0,a.a)(this._controller.signal),(0,n.t)(e.geometry)||"mesh"===e.geometry.type)return null;let i=e.geometry;if((0,d.y)(i)){const e=i.rings;i.rings=e}else if((0,d.f)(i)){const e=i.paths;i.paths=e}else if((0,d.u)(i)){const r=await this._getSymbolForGraphic(e,t);(0,a.a)(this._controller.signal),i=(0,b.H)(r.type)||(0,b.C)(r.type)?i.center:h.j.fromExtent(i)}await(0,f.p)(i.spatialReference,this.view.spatialReference);const r=function(e){if(!e)return null;if("mesh"===e.type)return e.toJSON();let t=null;const i=e.spatialReference,r=(0,u.S)(i);if(!r)return e.toJSON();const s=i.isWebMercator?102100:4326,n=p.r[s].maxX,a=p.r[s].minX,o=p.r[s].plus180Line,l=p.r[s].minus180Line;let c;const f=e.toJSON();if((0,d.l)(f))c=R(f,n,a);else if((0,d.s)(f))f.points=f.points.map((e=>R(e,n,a))),c=f;else if((0,d.u)(f))c=function(e,t){if(!t)return e;const i=function(e,t){const i=[],{ymin:r,ymax:s}=e,n=e.xmax-e.xmin,a=e.xmin,o=e.xmax;let l;const[h,u]=t.valid;l=P(e.xmin,t);const c=l.x,d=l.frameId;l=P(e.xmax,t);const p=l.x,f=l.frameId,y=c===p&&n>0;if(n>2*u){const e={xmin:a<o?c:p,ymin:r,xmax:u,ymax:s},t={xmin:h,ymin:r,xmax:a<o?p:c,ymax:s},n={xmin:0,ymin:r,xmax:u,ymax:s},l={xmin:h,ymin:r,xmax:0,ymax:s},y=[],m=[];L(e,n)&&y.push(d),L(e,l)&&m.push(d),L(t,n)&&y.push(f),L(t,l)&&m.push(f);for(let e=d+1;e<f;e++)y.push(e),m.push(e);i.push({extent:e,frameIds:[d]},{extent:t,frameIds:[f]},{extent:n,frameIds:y},{extent:l,frameIds:m})}else c>p||y?i.push({extent:{xmin:c,ymin:r,xmax:u,ymax:s},frameIds:[d]},{extent:{xmin:h,ymin:r,xmax:p,ymax:s},frameIds:[f]}):i.push({extent:{xmin:c,ymin:r,xmax:p,ymax:s},frameIds:[d]});return i}(e,t).map((e=>e.extent));return i.length<2?i[0]||e:i.length>2?(e.xmin=t.valid[0],e.xmax=t.valid[1],e):{rings:i.map((e=>[[e.xmin,e.ymin],[e.xmin,e.ymax],[e.xmax,e.ymax],[e.xmax,e.ymin],[e.xmin,e.ymin]]))}}(f,r);else if((0,d.y)(f)||(0,d.f)(f)){const e=O;(0,h.c)(e,f);const i={xmin:e[0],ymin:e[1],xmax:e[2],ymax:e[3]},r=(0,p.i)(i.xmin,a)*(2*n),s=0===r?f:function(e,t){const i=(0,p.s)(e);for(const e of i)for(const i of e)i[0]+=t;return e}(f,r);i.xmin+=r,i.xmax+=r,(0,h.y)(i,o)&&i.xmax!==n||(0,h.y)(i,l)&&i.xmin!==a?t=s:c=s}else c=e.toJSON();return null!==t?(new N).cut(t,n):c}(i),s=(0,f.y)(r,i.spatialReference,this.view.spatialReference);return(0,h.h)(s),s}_onTileUpdate(e){const t=(0,u.S)(this.view.spatialReference);if(e.added&&e.added.length>0)for(const i of e.added)this._addNewTile(i,t);if(e.removed&&e.removed.length>0)for(const t of e.removed)this._removeTile(t.key)}async _addGraphic(e){this._abortProcessingGraphic(e.uid),(0,a.a)(this._controller.signal);const t=(0,a.h)();this._graphicIdToAbortController.set(e.uid,t);const i={signal:t.signal};try{await this._addOrUpdateGraphic(e,i),(0,a.a)(this._controller.signal),this._graphicIdToAbortController.delete(e.uid)}catch(t){if(this._graphicIdToAbortController.delete(e.uid),!(0,a.g)(t))throw t}}async _updateGraphic(e,t){(0,a.a)(this._controller.signal);const i=this._projectAndNormalizeGeometry(e,t),r=this._getSymbolResources(e,t),[s,n]=await Promise.all([i,r]);(0,a.a)(this._controller.signal),this._graphicStore.addOrModify(e,n,s)}async _addOrUpdateGraphic(e,t){(0,a.a)(this._controller.signal);const i=this._projectAndNormalizeGeometry(e,t),r=this._getSymbolResources(e,t);try{const[t,s]=await Promise.all([i,r]);(0,a.a)(this._controller.signal),this._addProjectedGraphic(e,s,t)}catch(e){if(!(0,a.g)(e))throw e}}_addProjectedGraphic(e,t,i){this._graphicsSet.has(e)&&this._graphicStore.addOrModify(e,t,i)}_addTile(e){const t=this.view.featuresTilingScheme.getTileBounds((0,c.i)(),e),i=new q(e,t);return this._tiles.set(e,i),this.container.addChild(i),i}_addNewTile(e,t){const i=this._addTile(e.key),r=this._graphicStore.queryTileData(this._templateStore,e);if(t){const i=Math.round((t.valid[1]-t.valid[0])/e.resolution);for(const e of r)e.geometry&&((0,d.l)(e.geometry)||(0,d.s)(e.geometry))&&this._wrapPoints(e,i)}const s=e.key;this._tileUpdateSet.add(e.key),this.notifyChange("updating"),this._processGraphics(e,r).then((e=>{const t={type:"update",clear:!1,addOrUpdate:e,remove:[],end:!0};i.patch(t),this._tileUpdateSet.delete(s),this.notifyChange("updating")})).catch((e=>{if(this._tileUpdateSet.delete(s),this.notifyChange("updating"),!(0,a.g)(e))throw e}))}_removeTile(e){if(!this._tiles.has(e))return;const t=this._tiles.get(e);this.container.removeChild(t),t.destroy(),this._tiles.delete(e)}_setFilterState(e,t){const i=this._displayIds.get(e),r=this._attributeStore.getHighlightFlag(e);this._attributeStore.setData(i,0,0,r|(t?g.P:0))}_getGraphicsData(e,t,i){const r=(0,u.S)(this.view.spatialReference),s=this._graphicStore.getGraphicsData(e,t,i);if(r){const e=Math.round((r.valid[1]-r.valid[0])/t.resolution);for(const t of s)t.geometry&&((0,d.l)(t.geometry)||(0,d.s)(t.geometry))&&this._wrapPoints(t,e)}return s}_wrapPoints(e,t){const i=e.geometry;(0,d.s)(i)?this._wrapMultipoint(i,t):this._wrapPoint(e,t)}_wrapMultipoint(e,t){const i=e.points,r=[];let s=0,n=0;for(const[e,a]of i){if(r.push([e+s,a]),s=0,t===b.z){const i=5*b.P;e+n<i?(r.push([t,0]),s=-t):e+n>b.z-i&&(r.push([-t,0]),s=t)}else e+n<-b.P?(r.push([t,0]),s=-t):e+n>b.z+b.P&&(r.push([-t,0]),s=t);n+=e}e.points=r}_wrapPoint(e,t){const i=e.geometry;if(t===b.z){const r=5*b.P;i.x<r?e.geometry={points:[[i.x,i.y],[t,0]]}:i.x>b.z-r&&(e.geometry={points:[[i.x,i.y],[-t,0]]})}else i.x<-b.P?e.geometry={points:[[i.x,i.y],[t,0]]}:i.x>b.z+b.P&&(e.geometry={points:[[i.x,i.y],[-t,0]]})}async _processGraphics(e,t,i){if(!t||!t.length||!this._meshFactory)return null;const r=pe.from(t),s=this._meshFactory,n=await this._matcher;return await s.analyzeGraphics(r,n,null,null,i),this._attributeStore.sendUpdates(),this._processAnalyzedGraphics(e,r)}_processAnalyzedGraphics(e,t){const i=this._meshFactory,r=t.getSize(),s=t.getCursor(),n={features:r,records:r,metrics:0},a=new y.E(e.key.id,n,!1,!1,!1),o=[];for(;s.next();){const t=s.readGraphic();t.insertAfter=-1===t.insertAfter?-1:this._displayIds.get(t.insertAfter),t.displayId=this._displayIds.get(t.attributes[this.uid]);const r=new re(t.displayId);r.insertAfter=t.insertAfter,o.push(r),i.writeGraphic(a,s,e.level)}const l=e.tileInfoView.tileInfo.isWrappable,h=a.serialize(l);if(1!==h.length)return new de;const u=h[0].message;return de.fromVertexData(u,o)}_abortProcessingGraphic(e){this._graphicIdToAbortController.has(e)&&this._graphicIdToAbortController.get(e).abort()}_getNullSymbol(e){const t=e.geometry;return(0,d.f)(t)?m.O:(0,d.y)(t)||(0,d.u)(t)?m.j:m.N}_flipUpdatingGraphics(){this._updatingGraphicsTimer&&clearTimeout(this._updatingGraphicsTimer),this._updatingGraphicsTimer=setTimeout((()=>{this._updatingGraphicsTimer=null,this.notifyChange("updating")}),160),this.notifyChange("updating")}};(0,r.e)([(0,l.y)({constructOnly:!0})],Ce.prototype,"requestUpdateCallback",void 0),(0,r.e)([(0,l.y)()],Ce.prototype,"container",void 0),(0,r.e)([(0,l.y)({constructOnly:!0})],Ce.prototype,"graphics",void 0),(0,r.e)([(0,l.y)()],Ce.prototype,"updating",null),(0,r.e)([(0,l.y)()],Ce.prototype,"view",void 0),(0,r.e)([(0,l.y)()],Ce.prototype,"updateRequested",void 0),Ce=(0,r.e)([(0,l.n)("esri.views.2d.layers.support.GraphicsView2D")],Ce);var Me=Ce;class Te extends v.o{constructor(e){super(e)}get hasLabels(){return!1}onTileData(e,t){e.patch(t),this.contains(e)||this.addChild(e),this.requestRender()}onTileError(e){e.clear(),this.contains(e)||this.addChild(e)}_renderChildren(e,t){for(const i of this.children)i.isReady&&i.hasData&&(i.commit(e),e.context.setStencilFunction(514,i.stencilRef,255),i._displayList.replay(e,i,t))}}},52842:(e,t,i)=>{"use strict";i.d(t,{p:()=>o});var r=i(78155),s=i(32769),n=i(88903);i(80219);let a=class extends s.d{initialize(){}destroy(){}get supportsTileUpdates(){return!1}get spatialReference(){const e=this.get("tileStore.tileScheme.spatialReference");return e&&e.toJSON()||null}};(0,r.e)([(0,n.y)({readOnly:!0})],a.prototype,"supportsTileUpdates",null),(0,r.e)([(0,n.y)({constructOnly:!0})],a.prototype,"remoteClient",void 0),(0,r.e)([(0,n.y)({constructOnly:!0})],a.prototype,"service",void 0),(0,r.e)([(0,n.y)()],a.prototype,"spatialReference",null),(0,r.e)([(0,n.y)({constructOnly:!0})],a.prototype,"tileInfo",void 0),(0,r.e)([(0,n.y)({constructOnly:!0})],a.prototype,"tileStore",void 0),a=(0,r.e)([(0,n.n)("esri.views.2d.layers.features.processors.BaseProcessor")],a);var o=a},69863:(e,t,i)=>{"use strict";i.d(t,{o:()=>o});var r=i(78155),s=i(32769),n=i(88903);i(80219);let a=class extends s.d{constructor(e){super(e),this.tiles=new Map}destroy(){this.tiles.clear(),this.layer=this.layerView=this.tileInfoView=this.tiles=null}get updating(){return this.isUpdating()}acquireTile(e){const t=this.createTile(e);return t.once("isReady",(()=>this.notifyChange("updating"))),this.tiles.set(e.id,t),t}forceAttributeTextureUpload(){}forEachTile(e){this.tiles.forEach(e)}releaseTile(e){this.tiles.delete(e.key.id),this.disposeTile(e)}isUpdating(){let e=!0;return this.tiles.forEach((t=>{e=e&&t.isReady})),!e}setHighlight(){}invalidateLabels(){}requestUpdate(){this.layerView.requestUpdate()}};(0,r.e)([(0,n.y)()],a.prototype,"layer",void 0),(0,r.e)([(0,n.y)()],a.prototype,"layerView",void 0),(0,r.e)([(0,n.y)()],a.prototype,"tileInfoView",void 0),(0,r.e)([(0,n.y)()],a.prototype,"updating",null),a=(0,r.e)([(0,n.n)("esri.views.2d.layers.features.tileRenderers.BaseTileRenderer")],a);var o=a},76119:(e,t,i)=>{"use strict";i.d(t,{C:()=>C});const r=[["(",")"],[")","("],["<",">"],[">","<"],["[","]"],["]","["],["{","}"],["}","{"],["«","»"],["»","«"],["‹","›"],["›","‹"],["⁽","⁾"],["⁾","⁽"],["₍","₎"],["₎","₍"],["≤","≥"],["≥","≤"],["〈","〉"],["〉","〈"],["﹙","﹚"],["﹚","﹙"],["﹛","﹜"],["﹜","﹛"],["﹝","﹞"],["﹞","﹝"],["﹤","﹥"],["﹥","﹤"]],s=["آ","أ","إ","ا"],n=["ﻵ","ﻷ","ﻹ","ﻻ"],a=["ﻶ","ﻸ","ﻺ","ﻼ"],o=["ا","ب","ت","ث","ج","ح","خ","د","ذ","ر","ز","س","ش","ص","ض","ط","ظ","ع","غ","ف","ق","ك","ل","م","ن","ه","و","ي","إ","أ","آ","ة","ى","ل","م","ن","ه","و","ي","إ","أ","آ","ة","ى","ی","ئ","ؤ"],l=["ﺍ","ﺏ","ﺕ","ﺙ","ﺝ","ﺡ","ﺥ","ﺩ","ﺫ","ﺭ","ﺯ","ﺱ","ﺵ","ﺹ","ﺽ","ﻁ","ﻅ","ﻉ","ﻍ","ﻑ","ﻕ","ﻙ","ﻝ","ﻡ","ﻥ","ﻩ","ﻭ","ﻱ","ﺇ","ﺃ","ﺁ","ﺓ","ﻯ","ﯼ","ﺉ","ﺅ","ﹰ","ﹲ","ﹴ","ﹶ","ﹸ","ﹺ","ﹼ","ﹾ","ﺀ","ﺉ","ﺅ"],h=["ﺎ","ﺐ","ﺖ","ﺚ","ﺞ","ﺢ","ﺦ","ﺪ","ﺬ","ﺮ","ﺰ","ﺲ","ﺶ","ﺺ","ﺾ","ﻂ","ﻆ","ﻊ","ﻎ","ﻒ","ﻖ","ﻚ","ﻞ","ﻢ","ﻦ","ﻪ","ﻮ","ﻲ","ﺈ","ﺄ","ﺂ","ﺔ","ﻰ","ﯽ","ﺊ","ﺆ","ﹰ","ﹲ","ﹴ","ﹶ","ﹸ","ﹺ","ﹼ","ﹾ","ﺀ","ﺊ","ﺆ"],u=["ﺎ","ﺒ","ﺘ","ﺜ","ﺠ","ﺤ","ﺨ","ﺪ","ﺬ","ﺮ","ﺰ","ﺴ","ﺸ","ﺼ","ﻀ","ﻄ","ﻈ","ﻌ","ﻐ","ﻔ","ﻘ","ﻜ","ﻠ","ﻤ","ﻨ","ﻬ","ﻮ","ﻴ","ﺈ","ﺄ","ﺂ","ﺔ","ﻰ","ﯿ","ﺌ","ﺆ","ﹱ","ﹲ","ﹴ","ﹷ","ﹹ","ﹻ","ﹽ","ﹿ","ﺀ","ﺌ","ﺆ"],c=["ﺍ","ﺑ","ﺗ","ﺛ","ﺟ","ﺣ","ﺧ","ﺩ","ﺫ","ﺭ","ﺯ","ﺳ","ﺷ","ﺻ","ﺿ","ﻃ","ﻇ","ﻋ","ﻏ","ﻓ","ﻗ","ﻛ","ﻟ","ﻣ","ﻧ","ﻫ","ﻭ","ﻳ","ﺇ","ﺃ","ﺁ","ﺓ","ﻯ","ﯾ","ﺋ","ﺅ","ﹰ","ﹲ","ﹴ","ﹶ","ﹸ","ﹺ","ﹼ","ﹾ","ﺀ","ﺋ","ﺅ"],d=["ء","آ","أ","ؤ","إ","ا","ة","د","ذ","ر","ز","و","ى"],p=["ً","ً","ٌ","؟","ٍ","؟","َ","َ","ُ","ُ","ِ","ِ","ّ","ّ","ْ","ْ","ء","آ","آ","أ","أ","ؤ","ؤ","إ","إ","ئ","ئ","ئ","ئ","ا","ا","ب","ب","ب","ب","ة","ة","ت","ت","ت","ت","ث","ث","ث","ث","ج","ج","ج","ج","ح","ح","ح","ح","خ","خ","خ","خ","د","د","ذ","ذ","ر","ر","ز","ز","س","س","س","س","ش","ش","ش","ش","ص","ص","ص","ص","ض","ض","ض","ض","ط","ط","ط","ط","ظ","ظ","ظ","ظ","ع","ع","ع","ع","غ","غ","غ","غ","ف","ف","ف","ف","ق","ق","ق","ق","ك","ك","ك","ك","ل","ل","ل","ل","م","م","م","م","ن","ن","ن","ن","ه","ه","ه","ه","و","و","ى","ى","ي","ي","ي","ي","ﻵ","ﻶ","ﻷ","ﻸ","ﻹ","ﻺ","ﻻ","ﻼ","؟","؟","؟"],f=["ء","ف"],y=["غ","ي"],m=[[0,3,0,1,0,0,0],[0,3,0,1,2,2,0],[0,3,0,17,2,0,1],[0,3,5,5,4,1,0],[0,3,21,21,4,0,1],[0,3,5,5,4,2,0]],g=[[2,0,1,1,0,1,0],[2,0,1,1,0,2,0],[2,0,2,1,3,2,0],[2,0,2,33,3,1,1]],_=10,x=11,v=12,b=18,w=["UBAT_L","UBAT_R","UBAT_EN","UBAT_AN","UBAT_ON","UBAT_B","UBAT_S","UBAT_AL","UBAT_WS","UBAT_CS","UBAT_ES","UBAT_ET","UBAT_NSM","UBAT_LRE","UBAT_RLE","UBAT_PDF","UBAT_LRO","UBAT_RLO","UBAT_BN"],S=[100,0,0,0,0,101,102,103,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,104,4,4,4,0,4,0,4,0,4,4,4,0,0,4,4,0,0,0,0,0,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,0,0,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,0,0,0,0,0,0,0,0,0,0,0,0,0,0,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,0,0,4,4,0,0,4,4,0,0,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,0,0,0,105,7,7,106,107],I=[[b,b,b,b,b,b,b,b,b,6,5,6,8,5,b,b,b,b,b,b,b,b,b,b,b,b,b,b,5,5,5,6,8,4,4,x,x,x,4,4,4,4,4,_,9,_,9,9,2,2,2,2,2,2,2,2,2,2,9,4,4,4,4,4,4,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,4,4,4,4,4,4,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,4,4,4,4,b,b,b,b,b,b,5,b,b,b,b,b,b,b,b,b,b,b,b,b,b,b,b,b,b,b,b,b,b,b,b,b,b,9,4,x,x,x,x,4,4,4,4,0,4,4,b,4,4,x,x,2,2,4,0,4,4,4,2,0,4,4,4,4,4,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,4,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,4,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,4,4,4,4,4,4,4,4,4,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,4,4,0,0,0,0,0,0,0,4,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,4,0,4,4,4,4,4,4,4,v,v,v,v,v,v,v,v,v,v,v,v,v,v,v,v,v,v,v,v,v,v,v,v,v,v,v,v,v,v,v,v,v,v,v,v,v,v,v,v,v,v,v,v,v,1,v,1,v,v,1,v,v,1,v,4,4,4,4,4,4,4,4,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,4,4,4,4,4,1,1,1,1,1,4,4,4,4,4,4,4,4,4,4,4],[3,3,3,3,4,4,4,4,7,x,x,7,9,7,4,4,v,v,v,v,v,v,v,v,v,v,v,7,4,4,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,v,v,v,v,v,v,v,v,v,v,v,v,v,v,v,v,v,v,v,v,v,3,3,3,3,3,3,3,3,3,3,x,3,3,7,7,7,v,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,v,v,v,v,v,v,v,3,4,v,v,v,v,v,v,7,7,v,v,4,v,v,v,v,7,7,2,2,2,2,2,2,2,2,2,2,7,7,7,7,7,7],[7,7,7,7,7,7,7,7,7,7,7,7,7,7,4,7,7,v,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,v,v,v,v,v,v,v,v,v,v,v,v,v,v,v,v,v,v,v,v,v,v,v,v,v,v,v,4,4,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,v,v,v,v,v,v,v,v,v,v,v,7,4,4,4,4,4,4,4,4,4,4,4,4,4,4,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,v,v,v,v,v,v,v,v,v,1,1,4,4,4,4,1,4,4,4,4,4],[8,8,8,8,8,8,8,8,8,8,8,b,b,b,0,1,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,8,5,13,14,15,16,17,9,x,x,x,x,x,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,9,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,8,b,b,b,b,b,4,4,4,4,4,b,b,b,b,b,b,2,0,4,4,2,2,2,2,2,2,_,_,4,4,4,0,2,2,2,2,2,2,2,2,2,2,_,_,4,4,4,4,0,0,0,0,0,0,0,0,0,0,0,0,0,4,4,4,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,v,v,v,v,v,v,v,v,v,v,v,v,v,v,v,v,v,v,v,v,v,v,v,v,v,v,v,v,v,v,v,v,v,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4],[0,0,0,0,0,0,0,4,4,4,4,4,4,4,4,4,4,4,4,0,0,0,0,0,4,4,4,4,4,1,v,1,1,1,1,1,1,1,1,1,1,_,1,1,1,1,1,1,1,1,1,1,1,1,1,4,1,1,1,1,1,4,1,4,1,1,4,1,1,4,1,1,1,1,1,1,1,1,1,1,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7],[v,v,v,v,v,v,v,v,v,v,v,v,v,v,v,v,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,v,v,v,v,v,v,v,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,9,4,9,4,4,9,4,4,4,4,4,4,4,4,4,x,4,4,_,_,4,4,4,4,4,x,x,4,4,4,4,4,7,7,7,7,7,4,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,4,4,b],[4,4,4,x,x,x,4,4,4,4,4,_,9,_,9,9,2,2,2,2,2,2,2,2,2,2,9,4,4,4,4,4,4,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,4,4,4,4,4,4,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,4,4,4,4,4,4,4,4,4,4,4,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,4,4,4,0,0,0,0,0,0,4,4,0,0,0,0,0,0,4,4,0,0,0,0,0,0,4,4,0,0,0,4,4,4,x,x,4,4,4,x,x,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4]];class C{constructor(){this.inputFormat="ILYNN",this.outputFormat="VLNNN",this.sourceToTarget=[],this.targetToSource=[],this.levels=[]}bidiTransform(e,t,i){if(this.sourceToTarget=[],this.targetToSource=[],!e)return"";if(function(e,t,i){Q=[],Y=[];for(let r=0;r<i;r++)e[r]=r,t[r]=r,Q[r]=r}(this.sourceToTarget,this.targetToSource,e.length),!this.checkParameters(t,i))return e;t=this.inputFormat,i=this.outputFormat;let r=e;const o=J,u=j(t.charAt(1)),d=j(i.charAt(1)),f=("I"===t.charAt(0)?"L":t.charAt(0))+u,y=("I"===i.charAt(0)?"L":i.charAt(0))+d,m=t.charAt(2)+i.charAt(2);o.defInFormat=f,o.defOutFormat=y,o.defSwap=m;const g=M(e,f,y,m,o);let _=!1;return"R"===i.charAt(1)?_=!0:"C"!==i.charAt(1)&&"D"!==i.charAt(1)||(_="rtl"===this.checkContextual(g)),this.sourceToTarget=Q,this.targetToSource=function(e){const t=new Array(e.length);for(let i=0;i<e.length;i++)t[e[i]]=i;return t}(this.sourceToTarget),Z=this.targetToSource,r=t.charAt(3)===i.charAt(3)?g:"S"===i.charAt(3)?function(e,t,i){if(0===t.length)return"";void 0===e&&(e=!0),void 0===i&&(i=!0);const r=(t=String(t)).split("");let s=0,o=1,u=r.length;e||(s=r.length-1,o=-1,u=1);const d=function(e,t,i,r,s){let o=0;const u=[];let d=0;for(let p=t;p*i<r;p+=i)if(L(e[p])||B(e[p])){if("ل"===e[p]&&N(e,p+i,i,r)){e[p]=H(e[p+i],0===o?n:a),p+=i,q(e,p,i,r),s&&(u[d]=p,d++),o=0;continue}const t=e[p];1===o?e[p]=D(e,p+i,i,r)?G(e[p]):z(e[p],h):!0===D(e,p+i,i,r)?e[p]=z(e[p],c):e[p]=z(e[p],l),B(t)||(o=1),!0===U(t)&&(o=0)}else o=0;return u}(r,s,o,u,i);let p="";for(let t=0;t<r.length;t++)i&&P(d,d.length,t)>-1?(W(Z,t,!e,-1),Q.splice(t,1)):p+=r[t];return p}(_,g,!0):function(e,t,i){if(0===e.length)return"";void 0===i&&(i=!0),void 0===t&&(t=!0);let r="";const n=(e=String(e)).split("");for(let a=0;a<e.length;a++){let o=!1;if(n[a]>="ﹰ"&&n[a]<"\ufeff"){const l=e.charCodeAt(a);n[a]>="ﻵ"&&n[a]<="ﻼ"?(t?(a>0&&i&&" "===n[a-1]?r=r.substring(0,r.length-1)+"ل":(r+="ل",o=!0),r+=s[(l-65269)/2]):(r+=s[(l-65269)/2],r+="ل",a+1<e.length&&i&&" "===n[a+1]?a++:o=!0),o&&(W(Z,a,!0,1),Q.splice(a,0,Q[a]))):r+=p[l-65136]}else r+=n[a]}return r}(g,_,!0),this.sourceToTarget=Q,this.targetToSource=Z,this.levels=Y,r}_inputFormatSetter(e){if(!te.test(e))throw new Error("dojox/string/BidiEngine: the bidi layout string is wrong!");this.inputFormat=e}_outputFormatSetter(e){if(!te.test(e))throw new Error("dojox/string/BidiEngine: the bidi layout string is wrong!");this.outputFormat=e}checkParameters(e,t){return e?this._inputFormatSetter(e):e=this.inputFormat,t?this._outputFormatSetter(t):t=this.outputFormat,e!==t}checkContextual(e){let t=T(e);if("ltr"!==t&&"rtl"!==t){try{t=document.dir.toLowerCase()}catch(e){}"ltr"!==t&&"rtl"!==t&&(t="ltr")}return t}hasBidiChar(e){return ie.test(e)}}function M(e,t,i,r,s){const n=function(e,t,i){if(void 0===t.inFormat&&(t.inFormat=i.defInFormat),void 0===t.outFormat&&(t.outFormat=i.defOutFormat),void 0===t.swap&&(t.swap=i.defSwap),t.inFormat===t.outFormat)return t;const r=t.inFormat.substring(0,1),s=t.outFormat.substring(0,1);let n,a=t.inFormat.substring(1,4),o=t.outFormat.substring(1,4);return"C"===a.charAt(0)&&(n=T(e),a="ltr"===n||"rtl"===n?n.toUpperCase():"L"===t.inFormat.charAt(2)?"LTR":"RTL",t.inFormat=r+a),"C"===o.charAt(0)&&(n=T(e),"rtl"===n?o="RTL":"ltr"===n?(n=function(e){const t=e.split("");return t.reverse(),T(t.join(""))}(e),o=n.toUpperCase()):o="L"===t.outFormat.charAt(2)?"LTR":"RTL",t.outFormat=s+o),t}(e,{inFormat:t,outFormat:i,swap:r},s);if(n.inFormat===n.outFormat)return e;t=n.inFormat,i=n.outFormat,r=n.swap;const a=t.substring(0,1),o=t.substring(1,4),l=i.substring(0,1),h=i.substring(1,4);if(s.inFormat=t,s.outFormat=i,s.swap=r,"L"===a&&"VLTR"===i){if("LTR"===o)return s.dir=K,E(e,s);if("RTL"===o)return s.dir=ee,E(e,s)}if("V"===a&&"V"===l)return s.dir="RTL"===o?ee:K,R(e,s);if("L"===a&&"VRTL"===i)return"LTR"===o?(s.dir=K,e=E(e,s)):(s.dir=ee,e=E(e,s)),R(e);if("VLTR"===t&&"LLTR"===i)return s.dir=K,E(e,s);if("V"===a&&"L"===l&&o!==h)return e=R(e),"RTL"===o?M(e,"LLTR","VLTR",r,s):M(e,"LRTL","VRTL",r,s);if("VRTL"===t&&"LRTL"===i)return M(e,"LRTL","VRTL",r,s);if("L"===a&&"L"===l){const t=s.swap;return s.swap=t.substr(0,1)+"N","RTL"===o?(s.dir=ee,e=E(e,s),s.swap="N"+t.substr(1,2),s.dir=K,e=E(e,s)):(s.dir=K,e=E(e,s),s.swap="N"+t.substr(1,2),e=M(e,"VLTR","LRTL",s.swap,s)),e}return e}function T(e){const t=/[A-Za-z\u05d0-\u065f\u066a-\u06ef\u06fa-\u07ff\ufb1d-\ufdff\ufe70-\ufefc]/.exec(e);return t?t[0]<="z"?"ltr":"rtl":""}function E(e,t){const i=e.split(""),r=[];return F(i,r,t),function(e,t,i){if(0!==i.hiLevel&&i.swap.substr(0,1)!==i.swap.substr(1,2))for(let i=0;i<e.length;i++)1===t[i]&&(e[i]=V(e[i]))}(i,r,t),O(2,i,r,t),O(1,i,r,t),Y=r,i.join("")}function F(e,t,i){const r=e.length,s=i.dir?g:m;let n=0,a=-1;const o=[],l=[];i.hiLevel=i.dir,i.lastArabic=!1,i.hasUbatAl=!1,i.hasUbatB=!1,i.hasUbatS=!1;for(let t=0;t<r;t++)o[t]=A(e[t]);for(let h=0;h<r;h++){const r=n,u=k(e,o,l,h,i);l[h]=u,n=s[r][u];const c=240&n;n&=15;const d=s[n][X];if(t[h]=d,c>0)if(16===c){for(let e=a;e<h;e++)t[e]=1;a=-1}else a=-1;if(s[n][$])-1===a&&(a=h);else if(a>-1){for(let e=a;e<h;e++)t[e]=d;a=-1}5===o[h]&&(t[h]=0),i.hiLevel|=d}i.hasUbatS&&function(e,t,i,r){for(let s=0;s<i;s++)if(6===e[s]){t[s]=r.dir;for(let i=s-1;i>=0&&8===e[i];i--)t[i]=r.dir}}(o,t,r,i)}function A(e){const t=e.charCodeAt(0),i=S[t>>8];return i<100?i:I[i-100][255&t]}function R(e,t){const i=e.split("");if(t){const e=[];F(i,e,t),Y=e}return i.reverse(),Q.reverse(),i.join("")}function P(e,t,i){for(let r=0;r<t;r++)if(e[r]===i)return r;return-1}function L(e){for(let t=0;t<f.length;t++)if(e>=f[t]&&e<=y[t])return!0;return!1}function D(e,t,i,r){for(;t*i<r&&B(e[t]);)t+=i;return!!(t*i<r&&L(e[t]))}function N(e,t,i,r){for(;t*i<r&&B(e[t]);)t+=i;let n=" ";if(!(t*i<r))return!1;n=e[t];for(let e=0;e<s.length;e++)if(s[e]===n)return!0;return!1}function O(e,t,i,r){if(r.hiLevel<e)return;if(1===e&&r.dir===ee&&!r.hasUbatB)return t.reverse(),void Q.reverse();const s=t.length;let n,a,o,l,h,u=0;for(;u<s;){if(i[u]>=e){for(n=u+1;n<s&&i[n]>=e;)n++;for(a=u,o=n-1;a<o;a++,o--)l=t[a],t[a]=t[o],t[o]=l,h=Q[a],Q[a]=Q[o],Q[o]=h;u=n}u++}}function k(e,t,i,r,s){const n=t[r];return{UBAT_L:()=>(s.lastArabic=!1,0),UBAT_R:()=>(s.lastArabic=!1,1),UBAT_ON:()=>4,UBAT_AN:()=>3,UBAT_EN:()=>s.lastArabic?3:2,UBAT_AL:()=>(s.lastArabic=!0,s.hasUbatAl=!0,1),UBAT_WS:()=>4,UBAT_CS:()=>{let e,n;return r<1||r+1>=t.length||2!==(e=i[r-1])&&3!==e||2!==(n=t[r+1])&&3!==n?4:(s.lastArabic&&(n=3),n===e?n:4)},UBAT_ES:()=>2===(r>0?i[r-1]:5)&&r+1<t.length&&2===t[r+1]?2:4,UBAT_ET:()=>{if(r>0&&2===i[r-1])return 2;if(s.lastArabic)return 4;let e=r+1;const n=t.length;for(;e<n&&t[e]===x;)e++;return e<n&&2===t[e]?2:4},UBAT_NSM:()=>{if("VLTR"===s.inFormat){const i=t.length;let s=r+1;for(;s<i&&t[s]===v;)s++;if(s<i){const i=e[r].charCodeAt[0],n=i>=1425&&i<=2303||64286===i,a=t[s];if(n&&(1===a||7===a))return 1}}return r<1||5===t[r-1]?4:i[r-1]},UBAT_B:()=>(s.lastArabic=!0,s.hasUbatB=!0,s.dir),UBAT_S:()=>(s.hasUbatS=!0,4),UBAT_LRE:()=>(s.lastArabic=!1,4),UBAT_RLE:()=>(s.lastArabic=!1,4),UBAT_LRO:()=>(s.lastArabic=!1,4),UBAT_RLO:()=>(s.lastArabic=!1,4),UBAT_PDF:()=>(s.lastArabic=!1,4),UBAT_BN:()=>4}[w[n]]()}function V(e){let t,i=0,s=r.length-1;for(;i<=s;)if(t=Math.floor((i+s)/2),e<r[t][0])s=t-1;else{if(!(e>r[t][0]))return r[t][1];i=t+1}return e}function U(e){for(let t=0;t<d.length;t++)if(d[t]===e)return!0;return!1}function G(e){for(let t=0;t<o.length;t++)if(e===o[t])return u[t];return e}function z(e,t){for(let i=0;i<o.length;i++)if(e===o[i])return t[i];return e}function B(e){return e>="ً"&&e<="ٕ"}function j(e){return"L"===e?"LTR":"R"===e?"RTL":"C"===e?"CLR":"D"===e?"CRL":""}function q(e,t,i,r){for(;t*i<r&&B(e[t]);)t+=i;return t*i<r&&(e[t]=" ",!0)}function H(e,t){for(let i=0;i<s.length;i++)if(e===s[i])return t[i];return e}function W(e,t,i,r){for(let s=0;s<e.length;s++)(e[s]>t||!i&&e[s]===t)&&(e[s]+=r)}let Q=[],Z=[],Y=[];const J={dir:0,defInFormat:"LLTR",defoutFormat:"VLTR",defSwap:"YN",inFormat:"LLTR",outFormat:"VLTR",swap:"YN",hiLevel:0,lastArabic:!1,hasUbatAl:!1,hasBlockSep:!1,hasSegSep:!1,defOutFormat:""},X=5,$=6,K=0,ee=1,te=/^[(I|V)][(L|R|C|D)][(Y|N)][(S|N)][N]$/,ie=/[\u0591-\u06ff\ufb1d-\ufefc]/},12046:(e,t,i)=>{"use strict";i.d(t,{e:()=>l,g:()=>u}),i(33807);var r=i(95186),s=i(71391),n=i(24776),a=(i(93875),i(80219),i(14215)),o=i(75200);class l{constructor(e,t,i){this.pixelBlock=e,this.extent=t,this.originalPixelBlock=i}get width(){return this.pixelBlock?this.pixelBlock.width:0}get height(){return this.pixelBlock?this.pixelBlock.height:0}render(e){const t=this.pixelBlock;if(!t)return;const i=this.filter({pixelBlock:t}),r=i.pixelBlock.getAsRGBA(),s=e.createImageData(i.pixelBlock.width,i.pixelBlock.height);s.data.set(r),e.putImageData(s,0,0)}getRenderedRasterPixels(){const e=this.filter({pixelBlock:this.pixelBlock});return{width:e.pixelBlock.width,height:e.pixelBlock.height,renderedRasterPixels:new Uint8Array(e.pixelBlock.getAsRGBA().buffer)}}}function h(e,t,i){const r={target:3553,pixelFormat:6408,internalFormat:6408,dataType:5121,wrapMode:33071};return t&&i&&(r.width=t,r.height=i),new a.r(e,r)}class u extends o.a{constructor(e=null,t,i=!0){super(),this.requestRenderOnSourceChangedEnabled=i,this._textureInvalidated=!0,this.stencilRef=0,this.coordScale=[1,1],this._height=void 0,this.pixelRatio=1,this.resolution=0,this.rotation=0,this._source=null,this._width=void 0,this.x=0,this.y=0,this.transforms={dvs:(0,s.a0)()},this.blendFunction=t,this.source=e,this.requestRender=this.requestRender.bind(this)}destroy(){this._texture&&(this._texture.dispose(),this._texture=null)}get isSourceScaled(){return this.width!==this.sourceWidth||this.height!==this.sourceHeight}get height(){return void 0!==this._height?this._height:this.sourceHeight}set height(e){this._height=e}get source(){return this._source}set source(e){this._source=e,this.invalidateTexture()}get sourceHeight(){return this._source instanceof HTMLImageElement?this._source.naturalHeight:this._source.height}get sourceWidth(){return this._source instanceof HTMLImageElement?this._source.naturalWidth:this._source.width}get width(){return void 0!==this._width?this._width:this.sourceWidth}set width(e){this._width=e}beforeRender(e){super.beforeRender(e),this.updateTexture(e.context)}invalidateTexture(){this._textureInvalidated||(this._textureInvalidated=!0,this.requestRenderOnSourceChangedEnabled&&this.requestRender())}setTransform(e){const t=(0,r.r)(this.transforms.dvs),[i,s]=e.toScreenNoRotation([0,0],this.x,this.y),a=this.resolution/this.pixelRatio/e.resolution,o=a*this.width,l=a*this.height,h=Math.PI*this.rotation/180;(0,r.M)(t,t,(0,n.t)(i,s)),(0,r.M)(t,t,(0,n.t)(o/2,l/2)),(0,r.h)(t,t,-h),(0,r.M)(t,t,(0,n.t)(-o/2,-l/2)),(0,r.b)(t,t,(0,n.t)(o,l)),(0,r.i)(this.transforms.dvs,e.displayViewMat3,t)}setSamplingProfile(e){this._texture&&(e.mips&&!this._texture.descriptor.hasMipmap&&this._texture.generateMipmap(),this._texture.setSamplingMode(e.samplingMode))}bind(e,t){this._texture&&e.bindTexture(this._texture,t)}updateTexture(e){var t;if(!this.stage)return null==(t=this._texture)||t.dispose(),void(this._texture=null);if(!this._textureInvalidated)return;this._textureInvalidated=!1,this._texture||(this.source?this._texture=h(e,this.sourceWidth,this.sourceHeight):this._texture=h(e));const i=this.source;if(i){if(this._texture.resize(this.sourceWidth,this.sourceHeight),function(e){return e&&"render"in e}(i))if(i instanceof l){const e=i.getRenderedRasterPixels();this._texture.setData(e.renderedRasterPixels)}else this._texture.setData(function(e){const t=document.createElement("canvas");return t.width=e.width,t.height=e.height,e.render(t.getContext("2d")),t}(i));else(function(e){return e&&!("render"in e)})(i)&&this._texture.setData(i);this.ready()}else this._texture.setData(null)}onAttach(){this.invalidateTexture()}onDetach(){this.invalidateTexture()}}},9892:(e,t,i)=>{"use strict";i.d(t,{t:()=>a});var r=i(26799),s=i(5772),n=i(80163);class a extends n.o{get requiresDedicatedFBO(){return this.children.some((e=>"additive"===e.blendFunction))}prepareRenderPasses(e){const t=e.registerRenderPass({name:"bitmap",brushes:[r.g.bitmap],target:()=>this.children,drawPhase:s.I.MAP});return[...super.prepareRenderPasses(e),t]}}},3429:(e,t,i)=>{"use strict";i.d(t,{n:()=>u});var r=i(58404),s=i(12046),n=i(6783),a=i(26799),o=i(5772),l=i(79061);class h extends n.r{constructor(e,t,i,r=null){super(e,t,i,i),this.bitmap=new s.g(r,"standard",!1),this.bitmap.coordScale=i,this.bitmap.once("isReady",(()=>this.ready()))}destroy(){super.destroy(),this.bitmap.destroy()}beforeRender(e){super.beforeRender(e),this.bitmap.beforeRender(e)}afterRender(e){super.afterRender(e),this.bitmap.afterRender(e)}set stencilRef(e){this.bitmap.stencilRef=e}get stencilRef(){return this.bitmap.stencilRef}setTransform(e,t){super.setTransform(e,t),this.bitmap.transforms.dvs=this.transforms.dvs}onAttach(){this.bitmap.stage=this.stage}onDetach(){this.bitmap&&(this.bitmap.stage=null)}}class u extends l.o{get requiresDedicatedFBO(){return this.children.some((e=>"additive"===e.bitmap.blendFunction))}createTile(e){const t=this._tileInfoView.getTileBounds((0,r.i)(),e);return new h(e,t,this._tileInfoView.tileInfo.size)}destroyTile(){}prepareRenderPasses(e){const t=e.registerRenderPass({name:"bitmap (tile)",brushes:[a.g.bitmap],target:()=>this.children.map((e=>e.bitmap)),drawPhase:o.I.MAP});return[...super.prepareRenderPasses(e),t]}doRender(e){this.visible&&e.drawPhase===o.I.MAP&&super.doRender(e)}}},2395:(e,t,i)=>{"use strict";i.d(t,{r:()=>a});var r=i(78155),s=i(88903),n=(i(80219),i(3429));const a=e=>{let t=class extends e{attach(){this.view.timeline.record(`${this.layer.title} (BitmapTileLayer) Attach`),this._bitmapView=new n.n(this._tileInfoView),this.container.addChild(this._bitmapView)}detach(){this.container.removeChild(this._bitmapView),this._bitmapView.removeAllChildren()}};return t=(0,r.e)([(0,s.n)("esri.views.2d.layers.BitmapTileLayerView2D")],t),t}},44844:(e,t,i)=>{"use strict";i.d(t,{E:()=>R,n:()=>T});var r=i(78155),s=i(82906),n=(i(34396),i(94449)),a=i(80987),o=i(20215),l=i(31531),h=i(80219),u=i(88903),c=i(29126),d=i(4169),p=i(98548),f=i(92858),y=i(16040),m=i(62121),g=i(79506),_=i(13895),x=i(51962),v=i(72257),b=i(2502),w=i(71409),S=i(65862),I=i(18143),C=i(99987);let M=class extends((0,m.r)(g.O)){constructor(e){super(e),this.title="",this.id=-1,this.modelName=null,this.isEmpty=null,this.visible=!0,this.opacity=1}readTitle(e,t){return"string"==typeof t.alias?t.alias:"string"==typeof t.name?t.name:""}readIdOnlyOnce(e){return-1!==this.id?this.id:"number"==typeof e?e:void 0}};(0,r.e)([(0,u.y)({type:String,json:{origins:{"web-scene":{write:!0},"portal-item":{write:!0}}}})],M.prototype,"title",void 0),(0,r.e)([(0,d.e)("service","title",["alias","name"])],M.prototype,"readTitle",null),(0,r.e)([(0,u.y)()],M.prototype,"layer",void 0),(0,r.e)([(0,u.y)({type:u.N,readOnly:!0,json:{read:!1,write:{ignoreOrigin:!0}}})],M.prototype,"id",void 0),(0,r.e)([(0,d.e)("service","id")],M.prototype,"readIdOnlyOnce",null),(0,r.e)([(0,u.y)((0,_.d)(String))],M.prototype,"modelName",void 0),(0,r.e)([(0,u.y)((0,_.d)(Boolean))],M.prototype,"isEmpty",void 0),(0,r.e)([(0,u.y)({type:Boolean,json:{name:"visibility",write:!0}})],M.prototype,"visible",void 0),(0,r.e)([(0,u.y)({type:Number,json:{write:!0}})],M.prototype,"opacity",void 0),M=(0,r.e)([(0,u.n)("esri.layers.buildingSublayers.BuildingSublayer")],M);var T=M;const E=h.n.getLogger("esri.layers.buildingSublayers.BuildingComponentSublayer"),F=(0,v.l)();let A=class extends(a.f.LoadableMixin((0,a.d)(T))){constructor(e){super(e),this.type="building-component",this.nodePages=null,this.materialDefinitions=null,this.textureSetDefinitions=null,this.geometryDefinitions=null,this.serviceUpdateTimeStamp=null,this.fields=null,this.associatedLayer=null,this.outFields=null,this.listMode="show",this.renderer=null,this.definitionExpression=null,this.popupEnabled=!0,this.popupTemplate=null,this.layerType="3d-object"}get parsedUrl(){return this.layer?{path:`${this.layer.parsedUrl.path}/sublayers/${this.id}`,query:this.layer.parsedUrl.query}:null}get fieldsIndex(){return new b.e(this.fields)}readAssociatedLayer(e,t){const i=this.layer.associatedFeatureServiceItem,r=t.associatedLayerID;return(0,h.r)(i)&&"number"==typeof r?new y.W({portalItem:i,layerId:r}):null}get objectIdField(){if(null!=this.fields)for(const e of this.fields)if("oid"===e.type)return e.name;return null}get displayField(){return(0,h.r)(this.associatedLayer)?this.associatedLayer.displayField:null}get defaultPopupTemplate(){return this.createPopupTemplate()}load(e){const t=(0,h.r)(e)?e.signal:null,i=this._fetchService(t).then((()=>{this.indexInfo=(0,w.n)(this.parsedUrl.path,this.rootNode,this.nodePages,this.apiKey,E,t)}));return this.addResolvingPromise(i),Promise.resolve(this)}createPopupTemplate(e){return(0,C.a)(this,e)}async _fetchService(e){const t=(await(0,a.L)(this.parsedUrl.path,{query:{f:"json",token:this.apiKey},responseType:"json",signal:e})).data;this.read(t,{origin:"service",url:this.parsedUrl})}getField(e){return this.fieldsIndex.get(e)}getFieldDomain(e,t){var i,r,s,n;const a=null==(i=this.getFeatureType(null==t?void 0:t.feature))||null==(r=i.domains)?void 0:r[e];return a&&"inherited"!==a.type?a:null!=(s=null==(n=this.getField(e))?void 0:n.domain)?s:null}getFeatureType(e){return e&&(0,h.r)(this.associatedLayer)?this.associatedLayer.getFeatureType(e):null}get types(){return(0,h.r)(this.associatedLayer)?this.associatedLayer.types:[]}get typeIdField(){return(0,h.r)(this.associatedLayer)?this.associatedLayer.typeIdField:null}get geometryType(){return"3d-object"===this.layerType?"mesh":"point"}get profile(){return"3d-object"===this.layerType?"mesh-pyramids":"points"}get capabilities(){const e=(0,h.r)(this.associatedLayer)&&this.associatedLayer.capabilities?this.associatedLayer.capabilities:x.s,{query:t,data:{supportsZ:i,supportsM:r,isVersioned:s}}=e;return{query:t,data:{supportsZ:i,supportsM:r,isVersioned:s}}}createQuery(){const e=new I.b;return"mesh"!==this.geometryType&&(e.returnGeometry=!0,e.returnZ=!0),e.where=this.definitionExpression||"1=1",e.sqlFormat="standard",e}queryExtent(e,t){return this._getAssociatedLayerForQuery().then((i=>i.queryExtent(e||this.createQuery(),t)))}queryFeatureCount(e,t){return this._getAssociatedLayerForQuery().then((i=>i.queryFeatureCount(e||this.createQuery(),t)))}queryFeatures(e,t){return this._getAssociatedLayerForQuery().then((i=>i.queryFeatures(e||this.createQuery(),t))).then((e=>{if(null!=e&&e.features)for(const t of e.features)t.layer=this.layer,t.sourceLayer=this;return e}))}queryObjectIds(e,t){return this._getAssociatedLayerForQuery().then((i=>i.queryObjectIds(e||this.createQuery(),t)))}getFieldUsageInfo(e){return this.fieldsIndex.has(e)?{supportsLabelingInfo:!1,supportsRenderer:!1,supportsPopupTemplate:!1,supportsLayerQuery:!1}:{supportsLabelingInfo:!1,supportsRenderer:!0,supportsPopupTemplate:!0,supportsLayerQuery:(0,h.r)(this.associatedLayer)}}_getAssociatedLayerForQuery(){const e=this.associatedLayer;return(0,h.r)(e)&&e.loaded?Promise.resolve(e):this._loadAssociatedLayerForQuery()}async _loadAssociatedLayerForQuery(){if(await this.load(),(0,h.t)(this.associatedLayer))throw new o.s("buildingscenelayer:query-not-available","BuildingSceneLayer component layer queries are not available without an associated feature layer",{layer:this});try{await this.associatedLayer.load()}catch(e){throw new o.s("buildingscenelayer:query-not-available","BuildingSceneLayer associated feature layer could not be loaded",{layer:this,error:e})}return this.associatedLayer}};(0,r.e)([(0,u.y)({readOnly:!0})],A.prototype,"parsedUrl",null),(0,r.e)([(0,u.y)({type:S.s,readOnly:!0})],A.prototype,"nodePages",void 0),(0,r.e)([(0,u.y)({type:[S.l],readOnly:!0})],A.prototype,"materialDefinitions",void 0),(0,r.e)([(0,u.y)({type:[S.u],readOnly:!0})],A.prototype,"textureSetDefinitions",void 0),(0,r.e)([(0,u.y)({type:[S.m],readOnly:!0})],A.prototype,"geometryDefinitions",void 0),(0,r.e)([(0,u.y)({readOnly:!0})],A.prototype,"serviceUpdateTimeStamp",void 0),(0,r.e)([(0,u.y)({readOnly:!0})],A.prototype,"store",void 0),(0,r.e)([(0,u.y)({type:String,readOnly:!0,json:{read:{source:"store.rootNode"}}})],A.prototype,"rootNode",void 0),(0,r.e)([(0,u.y)({readOnly:!0})],A.prototype,"attributeStorageInfo",void 0),(0,r.e)([(0,u.y)(F.fields)],A.prototype,"fields",void 0),(0,r.e)([(0,u.y)({readOnly:!0})],A.prototype,"fieldsIndex",null),(0,r.e)([(0,u.y)({readOnly:!0,type:y.W})],A.prototype,"associatedLayer",void 0),(0,r.e)([(0,d.e)("service","associatedLayer",["associatedLayerID"])],A.prototype,"readAssociatedLayer",null),(0,r.e)([(0,u.y)(F.outFields)],A.prototype,"outFields",void 0),(0,r.e)([(0,u.y)({type:String,readOnly:!0})],A.prototype,"objectIdField",null),(0,r.e)([(0,u.y)({readOnly:!0,type:String,json:{read:!1}})],A.prototype,"displayField",null),(0,r.e)([(0,u.y)({readOnly:!0,type:String,aliasOf:"layer.apiKey"})],A.prototype,"apiKey",void 0),(0,r.e)([(0,u.y)({readOnly:!0,type:p.M,aliasOf:"layer.fullExtent"})],A.prototype,"fullExtent",void 0),(0,r.e)([(0,u.y)({readOnly:!0,type:f.k,aliasOf:"layer.spatialReference"})],A.prototype,"spatialReference",void 0),(0,r.e)([(0,u.y)({readOnly:!0,aliasOf:"layer.version"})],A.prototype,"version",void 0),(0,r.e)([(0,u.y)({readOnly:!0,type:_.x,aliasOf:"layer.elevationInfo"})],A.prototype,"elevationInfo",void 0),(0,r.e)([(0,u.y)({readOnly:!0,type:Number,aliasOf:"layer.minScale"})],A.prototype,"minScale",void 0),(0,r.e)([(0,u.y)({readOnly:!0,type:Number,aliasOf:"layer.maxScale"})],A.prototype,"maxScale",void 0),(0,r.e)([(0,u.y)({type:["hide","show"],json:{write:!0}})],A.prototype,"listMode",void 0),(0,r.e)([(0,u.y)({types:n.n,json:{origins:{service:{read:{source:"drawingInfo.renderer"}}},name:"layerDefinition.drawingInfo.renderer",write:!0},value:null})],A.prototype,"renderer",void 0),(0,r.e)([(0,u.y)({type:String,json:{origins:{service:{read:!1,write:!1}},name:"layerDefinition.definitionExpression",write:{enabled:!0,allowNull:!0}}})],A.prototype,"definitionExpression",void 0),(0,r.e)([(0,u.y)(_.s)],A.prototype,"popupEnabled",void 0),(0,r.e)([(0,u.y)({type:s.M,json:{read:{source:"popupInfo"},write:{target:"popupInfo"}}})],A.prototype,"popupTemplate",void 0),(0,r.e)([(0,u.y)({readOnly:!0,type:String,json:{origins:{service:{read:{source:"store.normalReferenceFrame"}}},read:!1}})],A.prototype,"normalReferenceFrame",void 0),(0,r.e)([(0,u.y)({readOnly:!0,json:{read:!1}})],A.prototype,"defaultPopupTemplate",null),(0,r.e)([(0,u.y)()],A.prototype,"types",null),(0,r.e)([(0,u.y)()],A.prototype,"typeIdField",null),(0,r.e)([(0,u.y)({json:{write:!1}}),(0,c.r)(new l.o({"3DObject":"3d-object",Point:"point"}))],A.prototype,"layerType",void 0),(0,r.e)([(0,u.y)()],A.prototype,"geometryType",null),(0,r.e)([(0,u.y)()],A.prototype,"profile",null),(0,r.e)([(0,u.y)({readOnly:!0,json:{read:!1}})],A.prototype,"capabilities",null),A=(0,r.e)([(0,u.n)("esri.layers.buildingSublayers.BuildingComponentSublayer")],A);var R=A},67075:(e,t,i)=>{"use strict";i.d(t,{d:()=>p});var r,s=i(78155),n=i(40130),a=i(95629),o=i(88903),l=(i(80219),i(44844));const h={type:n.L,readOnly:!0,json:{origins:{service:{read:{source:"sublayers",reader:u}}},read:!1}};function u(e,t,i){if(e&&Array.isArray(e))return new n.L(e.map((e=>{const t=function(e){return"group"===e.layerType?c:l.E}(e);if(t){const r=new t;return r.read(e,i),r}i&&i.messages&&e&&i.messages.push(new o.z("building-scene-layer:unsupported-sublayer-type","Building scene sublayer of type '"+(e.type||"unknown")+"' are not supported",{definition:e,context:i}))})))}let c=r=class extends l.n{constructor(e){super(e),this.type="building-group",this.listMode="show",this.sublayers=null}loadAll(){return(0,a.i)(this,(e=>r.forEachSublayer(this.sublayers,(t=>{"building-group"!==t.type&&e(t)}))))}};var d;(0,s.e)([(0,o.y)({type:["hide","show","hide-children"],json:{write:!0}})],c.prototype,"listMode",void 0),(0,s.e)([(0,o.y)(h)],c.prototype,"sublayers",void 0),c=r=(0,s.e)([(0,o.n)("esri.layers.buildingSublayers.BuildingGroupSublayer")],c),(d=c||(c={})).sublayersProperty=h,d.readSublayers=u,d.forEachSublayer=function e(t,i){t.forEach((t=>{i(t),"building-group"===t.type&&e(t.sublayers,i)}))};var p=c},50388:(e,t,i)=>{"use strict";i.d(t,{A:()=>be,G:()=>ve,S:()=>ze,a:()=>Le,b:()=>Ge,h:()=>Ue,o:()=>c,p:()=>m,r:()=>u,t:()=>we}),i(33807);var r=i(17762),s=i(80219),n=i(60816),a=i(58404),o=i(98548),l=i(89710);class h{constructor(){this.setIdentity()}getAngle(){return(null==this.rz||0===this.rz&&1!==this.rz_c&&0!==this.rz_s)&&(this.rz=Math.atan2(this.rz_s,this.rz_c)),this.rz}setIdentity(){this.tx=0,this.ty=0,this.tz=0,this.s=1,this.rx=0,this.ry=0,this.rz=0,this.rz_c=1,this.rz_s=0}setTranslate(e,t){this.tx=e,this.ty=t}setTranslateZ(e){this.tz=e}setRotateCS(e,t){this.rz=void 0,this.rz_c=e,this.rz_s=t}setRotate(e){this.rz=e,this.rz_c=void 0,this.rz_s=void 0}setRotateY(e){this.ry=e}setScale(e){this.s=e}setMeasure(e){this.m=e}}class u{constructor(e){this._geometry=e}next(){const e=this._geometry;return this._geometry=null,e}}function c(e){const t=(0,s.y)(e);return function(e){e&&((0,l.y)(e)?y(e.rings):(0,l.f)(e)?y(e.paths):(0,l.s)(e)&&f(e.points))}(t),t}function d(e){if(e)for(let t=e.length-1;t>0;--t)e[t][0]-=e[t-1][0],e[t][1]-=e[t-1][1]}function p(e){if(e)for(const t of e)d(t)}function f(e){if(e){const t=e.length;for(let i=1;i<t;++i)e[i][0]+=e[i-1][0],e[i][1]+=e[i-1][1]}}function y(e){if(e)for(const t of e)f(t)}function m(e){e&&((0,l.y)(e)?p(e.rings):(0,l.f)(e)?p(e.paths):(0,l.s)(e)&&d(e.points))}function g(e){if(e)for(const t of e)_(t)}function _(e){e&&e.reverse()}function x(e,t,i){return[e[0]+(t[0]-e[0])*i,e[1]+(t[1]-e[1])*i]}function v(e){return e[4]}function b(e,t){e[4]=t}class w{constructor(e,t,i,r){this.acceptPolygon=t,this.acceptPolyline=i,this.geomUnitsPerPoint=r,this.pathCount=-1,this.pathIndex=-1,this.iteratePath=!1,e&&((0,l.y)(e)?t&&(this.multiPath=e.rings,this.isClosed=!0):(0,l.f)(e)?i&&(this.multiPath=e.paths,this.isClosed=!1):(0,l.u)(e)&&t&&(this.multiPath=I(e).rings,this.isClosed=!0),this.multiPath&&(this.pathCount=this.multiPath.length)),this.internalPlacement=new h}next(){if(!this.multiPath)return null;for(;this.iteratePath||this.pathIndex<this.pathCount-1;){this.iteratePath||this.pathIndex++;const e=this.processPath(this.multiPath[this.pathIndex]);if(e)return e}return this.pathCount=-1,this.pathIndex=-1,this.multiPath=null,null}}class S{constructor(e,t,i,r){this.inputGeometries=e,this.acceptPolygon=t,this.acceptPolyline=i,this.geomUnitsPerPoint=r,this.pathCount=-1,this.pathIndex=-1,this.iteratePath=!1}next(){for(;;){if(!this.multiPath){let e=this.inputGeometries.next();for(;e;){if((0,l.y)(e)?this.acceptPolygon&&(this.multiPath=e.rings,this.isClosed=!0):(0,l.f)(e)?this.acceptPolyline&&(this.multiPath=e.paths,this.isClosed=!1):(0,l.u)(e)&&this.acceptPolygon&&(this.multiPath=I(e).rings,this.isClosed=!0),this.multiPath){this.pathCount=this.multiPath.length,this.pathIndex=-1;break}e=this.inputGeometries.next()}if(!this.multiPath)return null}for(;this.iteratePath||this.pathIndex<this.pathCount-1;){this.iteratePath||this.pathIndex++;const e=this.processPath(this.multiPath[this.pathIndex]);if(e)return e}this.pathCount=-1,this.pathIndex=-1,this.multiPath=null}}}function I(e){return{rings:[[[e.xmin,e.ymin],[e.xmin,e.ymax],[e.xmax,e.ymax],[e.xmax,e.ymin],[e.xmin,e.ymin]]]}}class C{static local(){return null===C.instance&&(C.instance=new C),C.instance}execute(e,t,i){return new M(e,t,i)}}C.instance=null;class M{constructor(e,t,i){this._inputGeometries=e,this._angleTolerance=void 0!==t.angleTolerance?t.angleTolerance:120,this._maxCosAngle=Math.cos((1-Math.abs(this._angleTolerance)/180)*Math.PI)}next(){let e=this._inputGeometries.next();for(;e;){if((0,l.y)(e)){this._isClosed=!0;const t=(0,s.y)(e);return this._processMultipath(t.rings),t}if((0,l.f)(e)){this._isClosed=!1;const t=(0,s.y)(e);return this._processMultipath(t.paths),t}if((0,l.u)(e)){if(this._maxCosAngle)return e;this._isClosed=!0;const t=[[e.xmin,e.ymin],[e.xmin,e.ymax],[e.xmax,e.ymax],[e.xmax,e.ymin],[e.xmin,e.ymin]];return this._processPath(t),{rings:[t]}}e=this._inputGeometries.next()}return null}_processMultipath(e){if(e)for(const t of e)this._processPath(t)}_processPath(e){if(e){let t,i,r,s,n,a,o=e.length,l=e[0];this._isClosed&&++o;for(let h=1;h<o;++h){let u;u=this._isClosed&&h===o-1?e[0]:e[h];const c=u[0]-l[0],d=u[1]-l[1],p=Math.sqrt(c*c+d*d);h>1&&p>0&&r>0&&(t*c+i*d)/p/r<=this._maxCosAngle&&b(l,1),1===h&&(s=c,n=d,a=p),p>0&&(l=u,t=c,i=d,r=p)}this._isClosed&&r>0&&a>0&&(t*s+i*n)/a/r<=this._maxCosAngle&&b(e[0],1)}}}const T=.03;class E{constructor(){this._path=[]}path(){return this._path}addPath(e,t){t||e.reverse(),Array.prototype.push.apply(this._path,e),t||e.reverse()}static mergePath(e,t){t&&Array.prototype.push.apply(e,t)}startPath(e){this._path.push(e)}lineTo(e){this._path.push(e)}close(){const e=this._path;e.length>1&&(e[0][0]===e[e.length-1][0]&&e[0][1]===e[e.length-1][1]||e.push([e[0][0],e[0][1]]))}}class F{constructor(e=0,t=!1){}normalize(e){const t=Math.sqrt(e[0]*e[0]+e[1]*e[1]);e[0]/=t,e[1]/=t}calculateLength(e,t){const i=t[0]-e[0],r=t[1]-e[1];return Math.sqrt(i*i+r*r)}calculateSegLength(e,t){return this.calculateLength(e[t],e[t+1])}calculatePathLength(e){let t=0;const i=e?e.length:0;for(let r=0;r<i-1;++r)t+=this.calculateSegLength(e,r);return t}calculatePathArea(e){let t=0;const i=e?e.length:0;for(let r=0;r<i-1;++r)t+=(e[r+1][0]-e[r][0])*(e[r+1][1]+e[r][1]);return t/2}getCoord2D(e,t,i){return[e[0]+(t[0]-e[0])*i,e[1]+(t[1]-e[1])*i]}getSegCoord2D(e,t,i){return this.getCoord2D(e[t],e[t+1],i)}getAngle(e,t,i){const r=t[0]-e[0],s=t[1]-e[1];return Math.atan2(s,r)}getSegAngle(e,t,i){return this.getAngle(e[t],e[t+1],i)}getAngleCS(e,t,i){const r=t[0]-e[0],s=t[1]-e[1],n=Math.sqrt(r*r+s*s);return n>0?[r/n,s/n]:[1,0]}getSegAngleCS(e,t,i){return this.getAngleCS(e[t],e[t+1],i)}cut(e,t,i,r){return[i<=0?e[t]:this.getSegCoord2D(e,t,i),r>=1?e[t+1]:this.getSegCoord2D(e,t,r)]}addSegment(e,t,i){i&&e.push(t[0]),e.push(t[1])}getSubCurve(e,t,i){const r=[];return this.appendSubCurve(r,e,t,i)?r:null}appendSubCurve(e,t,i,r){const s=t?t.length-1:0;let n=0,a=!0,o=0;for(;o<s;){const s=this.calculateSegLength(t,o);if(0!==s){if(a){if(n+s>i){const l=(i-n)/s;let h=1,u=!1;n+s>=r&&(h=(r-n)/s,u=!0);const c=this.cut(t,o,l,h);if(c&&this.addSegment(e,c,a),u)break;a=!1}}else{if(n+s>r){const i=this.cut(t,o,0,(r-n)/s);i&&this.addSegment(e,i,a);break}this.addSegment(e,[t[o],t[o+1]],a)}n+=s,++o}else++o}return!0}getCIMPointAlong(e,t){const i=e?e.length-1:0;let r=0,s=-1;for(;s<i;){++s;const i=this.calculateSegLength(e,s);if(0!==i){if(r+i>t){const n=(t-r)/i;return this.getCoord2D(e[s],e[s+1],n)}r+=i}}return null}isEmpty(e,t){if(!e||e.length<=1)return!0;const i=e?e.length-1:0;let r=-1;for(;r<i;){if(++r,e[r+1][0]!==e[r][0]||e[r+1][1]!==e[r][1])return!1;if(t&&e[r+1][2]!==e[r][2])return!1}return!0}offset(e,t,i,r,s){if(!e||e.length<2)return null;let n=e.length;const a=e[0][0]===e[n-1][0]&&e[0][1]===e[n-1][1];if(a){if(e.length<3)return null;--n}const o=[];let l=a?e[n-1]:null,h=e[0];for(let s=0;s<n;s++){const u=s===n-1?a?e[0]:null:e[s+1];if(l)if(u){const e=[u[0]-h[0],u[1]-h[1]];this.normalize(e);const s=[h[0]-l[0],h[1]-l[1]];this.normalize(s);const n=s[0]*e[1]-s[1]*e[0],a=s[0]*e[0]+s[1]*e[1];if(n>=0==t<=0){const i=[e[0]-s[0],e[1]-s[1]];this.normalize(i);const r=Math.sqrt((1+a)/2),n=-Math.abs(t)/r;o.push([h[0]-i[0]*n,h[1]-i[1]*n])}else switch(i){case"Mitered":{const i=Math.sqrt((1+a)/2);if(i>0&&1/i<r){const r=[e[0]-s[0],e[1]-s[1]];this.normalize(r);const n=Math.abs(t)/i;o.push([h[0]-r[0]*n,h[1]-r[1]*n]);break}}case"Bevelled":o.push([h[0]+s[1]*t,h[1]-s[0]*t]),o.push([h[0]+e[1]*t,h[1]-e[0]*t]);break;case"Rounded":{o.push([h[0]+s[1]*t,h[1]-s[0]*t]);const i=5,r=1/i;let n=r;for(let a=1;a<i;a++,n+=r){const i=[s[1]*(1-n)+e[1]*n,-s[0]*(1-n)-e[0]*n];this.normalize(i),o.push([h[0]+i[0]*t,h[1]+i[1]*t])}o.push([h[0]+e[1]*t,h[1]-e[0]*t]);break}case"Square":default:if(n<0)o.push([h[0]+(s[1]+s[0])*t,h[1]+(s[1]-s[0])*t]),o.push([h[0]+(e[1]-e[0])*t,h[1]-(e[0]+e[1])*t]);else{const i=Math.sqrt((1+Math.abs(a))/2),r=[e[0]-s[0],e[1]-s[1]];this.normalize(r);const n=t/i;o.push([h[0]-r[0]*n,h[1]-r[1]*n])}}}else{const e=[h[0]-l[0],h[1]-l[1]];this.normalize(e),o.push([h[0]+e[1]*t,h[1]-e[0]*t])}else{const e=[u[0]-h[0],u[1]-h[1]];this.normalize(e),o.push([h[0]+e[1]*t,h[1]-e[0]*t])}l=h,h=u}return a&&o.push([o[0][0],o[0][1]]),o}}const A=1.7320508075688772;class R{static local(){return null===R.instance&&(R.instance=new R),R.instance}execute(e,t,i){return new P(e,t,i)}}R.instance=null;class P extends S{constructor(e,t,i){super(e,!1,!0),this._curveHelper=new F,this._width=(void 0!==t.width?t.width:5)*i,this._arrowType=void 0!==t.geometricEffectArrowType?t.geometricEffectArrowType:"OpenEnded",this._offsetFlattenError=T*i}processPath(e){switch(this._arrowType){case"OpenEnded":default:return this._constructSimpleArrow(e,!0);case"Block":return this._constructSimpleArrow(e,!1);case"Crossed":return this._constructCrossedArrow(e)}}_constructSimpleArrow(e,t){const i=this._curveHelper.calculatePathLength(e);let r=this._width;i<2*r&&(r=i/2);const s=this._curveHelper.getSubCurve(e,0,i-r);if(!s)return null;const n=r/2;if(this._curveHelper.isEmpty(s,!1))return null;const a=this._constructOffset(s,-n);if(!a)return null;const o=this._constructOffset(s,n);if(!o)return null;const l=this._constructArrowBasePoint(a,-n/2);if(!l)return null;const h=this._constructArrowBasePoint(o,n/2);if(!h)return null;const u=e[e.length-1];t||(this._makeControlPoint(o,!0),this._makeControlPoint(a,!0));const c=new E;return c.addPath(o,!0),c.lineTo(h),this._makeControlPoint(c.path()),c.lineTo(u),this._makeControlPoint(c.path()),c.lineTo(l),this._makeControlPoint(c.path()),c.addPath(a,!1),t?{paths:[c.path()]}:(c.close(),{rings:[c.path()]})}_constructCrossedArrow(e){const t=this._curveHelper.calculatePathLength(e);let i=this._width;t<i*(1+A+1)&&(i=t/(1+A+1));const r=this._curveHelper.getSubCurve(e,0,t-i*(1+A));if(!r)return null;const s=i/2;if(this._curveHelper.isEmpty(r,!1))return null;const n=this._constructOffset(r,s);if(!n)return null;const a=this._constructOffset(r,-s);if(!a)return null;const o=this._curveHelper.getSubCurve(e,0,t-i);if(!o)return null;if(this._curveHelper.isEmpty(o,!1))return null;const l=this._constructOffset(o,s);if(!l)return null;const h=this._constructOffset(o,-s);if(!h)return null;const u=l[l.length-1],c=this._constructArrowBasePoint(l,s/2);if(!c)return null;const d=h[h.length-1],p=this._constructArrowBasePoint(h,-s/2);if(!p)return null;const f=e[e.length-1];this._makeControlPoint(n,!1),this._makeControlPoint(a,!1);const y=new E;return y.addPath(n,!0),this._makeControlPoint(y.path()),y.lineTo(d),y.lineTo(p),this._makeControlPoint(y.path()),y.lineTo(f),this._makeControlPoint(y.path()),y.lineTo(c),this._makeControlPoint(y.path()),y.lineTo(u),this._makeControlPoint(y.path()),y.addPath(a,!1),{paths:[y.path()]}}_constructOffset(e,t){return this._curveHelper.offset(e,t,"Rounded",4,this._offsetFlattenError)}_constructArrowBasePoint(e,t){if(!e||e.length<2)return null;const i=e[e.length-2],r=e[e.length-1],s=[r[0]-i[0],r[1]-i[1]];return this._curveHelper.normalize(s),[r[0]+s[1]*t,r[1]-s[0]*t]}_makeControlPoint(e,t=!1){b(t?e[0]:e[e.length-1],1)}}class L{static local(){return null===L.instance&&(L.instance=new L),L.instance}execute(e,t,i){return new D(e,t,i)}}L.instance=null;class D{constructor(e,t,i){this._inputGeometries=e,this._curveHelper=new F,this._size=(void 0!==t.size?t.size:1)*i,this._offsetFlattenError=T*i}next(){let e=this._inputGeometries.next();for(;e;){if((0,l.u)(e))if(this._size>0){const t=[[e.xmin,e.ymin],[e.xmin,e.ymax],[e.xmax,e.ymax],[e.xmax,e.ymin],[e.xmin,e.ymin]],i=this._curveHelper.offset(t,this._size,"Rounded",4,this._offsetFlattenError);if(i)return{rings:[i]}}else{if(!(this._size<0))return e;if(Math.min(e.xmax-e.xmin,e.ymax-e.ymin)+2*this._size>0)return{xmin:e.xmin-this._size,xmax:e.xmax+this._size,ymin:e.ymin-this._size,ymax:e.ymax+this._size}}if((0,l.y)(e)){if(0===this._size)return e;const t=[];for(const i of e.rings){const e=this._curveHelper.offset(i,this._size,"Rounded",4,this._offsetFlattenError);e&&t.push(e)}if(t.length)return{rings:t}}if((0,l.f)(e)&&this._size>0){const t=[];for(const i of e.paths)if(i&&i.length>1){const e=this._curveHelper.offset(i,this._size,"Rounded",4,this._offsetFlattenError),r=this._curveHelper.offset(i,-this._size,"Rounded",4,this._offsetFlattenError);if(e&&r){for(let t=r.length-1;t>=0;t--)e.push(r[t]);e.push([e[0][0],e[0][1]]),t.push(e)}}if(t.length)return{rings:t}}(0,l.l)(e)&&this._size,e=this._inputGeometries.next()}return null}}class N{static local(){return null===N.instance&&(N.instance=new N),N.instance}execute(e,t,i){return new O(e,t,i)}}N.instance=null;class O extends S{constructor(e,t,i){super(e,!0,!0),this._curveHelper=new F,this._beginCut=(void 0!==t.beginCut?t.beginCut:1)*i,this._endCut=(void 0!==t.endCut?t.endCut:1)*i,this._middleCut=(void 0!==t.middleCut?t.middleCut:0)*i,this._invert=void 0!==t.invert&&t.invert,this._beginCut<0&&(this._beginCut=0),this._endCut<0&&(this._endCut=0),this._middleCut<0&&(this._middleCut=0)}processPath(e){const t=this._beginCut,i=this._endCut,r=this._middleCut,s=this._curveHelper.calculatePathLength(e),n=[];if(this._invert)if(0===t&&0===i&&0===r);else if(t+i+r>=s)n.push(e);else{let a=this._curveHelper.getSubCurve(e,0,t);a&&n.push(a),a=this._curveHelper.getSubCurve(e,.5*(s-r),.5*(s+r)),a&&n.push(a),a=this._curveHelper.getSubCurve(e,s-i,i),a&&n.push(a)}else if(0===t&&0===i&&0===r)n.push(e);else if(t+i+r>=s);else if(0===r){const r=this._curveHelper.getSubCurve(e,t,s-i);r&&n.push(r)}else{let a=this._curveHelper.getSubCurve(e,t,.5*(s-r));a&&n.push(a),a=this._curveHelper.getSubCurve(e,.5*(s+r),s-i),a&&n.push(a)}return 0===n.length?null:{paths:n}}}class k{constructor(){this._values=[],this.extPtGap=0,this.ctrlPtGap=0,this._length=0,this._currentValue=0}isEmpty(){return 0===this._values.length}size(){return this._values.length}init(e,t,i=!0){if(this._setEmpty(),!e||0===e.length)return!1;for(let t=0;t<e.length;t++){let r=Math.abs(e[t]);i&&r<1e-7&&(r=1e-7),this._values.push(r),this._length+=r}return t&&1&e.length&&(this._length*=2),0!==this._length&&(this.ctrlPtGap=this.extPtGap=0,this._currentValue=-1,!0)}scale(e){const t=this._values?this._values.length:0;for(let i=0;i<t;++i)this._values[i]*=e;this._length*=e,this.extPtGap*=e,this.ctrlPtGap*=e}addValue(e){this._length+=e,this._values.push(e)}firstValue(){return this._values[0]}lastValue(){return this._values[this._values.length-1]}nextValue(){return this._currentValue++,this._currentValue===this._values.length&&(this._currentValue=0),this._values[this._currentValue]}reset(){this._currentValue=-1}length(){return this._length}_setEmpty(){this.extPtGap=this.ctrlPtGap=this._length=0,this._currentValue=-1,this._values.length=0}}class V{constructor(){this.reset()}reset(){this.segment=-1,this.segmentLength=0,this.abscissa=0,this.isPathEnd=!1,this.isPartEnd=!1}isValid(){return-1!==this.segment}copyTo(e){e.segment=this.segment,e.segmentLength=this.segmentLength,e.abscissa=this.abscissa,e.isPathEnd=this.isPathEnd,e.isPartEnd=this.isPartEnd}}class U extends F{constructor(e=0,t=!1){super(e,t),this._tolerance=T,this._currentPosition=new V}updateTolerance(e){this._tolerance=T*e}init(e,t,i=!0){return i?(this._patternLength=t.length(),this._partExtPtGap=t.extPtGap,this._partCtrlPtGap=t.ctrlPtGap):(this._patternLength=0,this._partExtPtGap=0,this._partCtrlPtGap=0),this._currentPosition.reset(),this._partSegCount=0,this._path=e,this._seg=-1,this.setPosAtNextPart()}curPositionIsValid(){return this._currentPosition.isValid()}nextPosition(e,t=0){const i=new V;return!!this._nextPosition(e,i,null,t)&&(i.copyTo(this._currentPosition),!0)}curPointAndAngle(e){e.pt=this._getPoint(this._currentPosition);const[t,i]=this._getAngle(this._currentPosition);e.ca=t,e.sa=i}nextPointAndAngle(e,t,i=0){const r=new V;if(!this._nextPosition(e,r,null,i))return!1;r.copyTo(this._currentPosition),t.pt=this._getPoint(r);const[s,n]=this._getAngle(r);return t.ca=s,t.sa=n,!0}nextCurve(e){if(0===e)return null;const t=[],i=new V;return this._nextPosition(e,i,t,1)?(i.copyTo(this._currentPosition),t):null}isPathEnd(){return this._currentPosition.isPathEnd}getPathEnd(){if(-1===this._currentPosition.segment)throw new Error("missing segment");return this._path[this._currentPosition.segment+1]}_nextPosition(e,t,i,r){if(this._currentPosition.isPathEnd)return!1;let s=this._currentPosition.abscissa;for(this._currentPosition.segmentLength>0&&(s/=this._currentPosition.segmentLength),this._currentPosition.copyTo(t);t.abscissa+e*this._partLengthRatio>t.segmentLength+this._tolerance;){if(i){if(0===i.length)if(0===s){const e=this._path[t.segment];i.push([e[0],e[1]])}else i.push(this.getSegCoord2D(this._path,t.segment,s));const e=this._path[t.segment+1];i.push([e[0],e[1]])}if(s=0,e-=(t.segmentLength-t.abscissa)/this._partLengthRatio,this._partSegCount)t.segment=this.nextSegment(),t.segmentLength=this.calculateSegLength(this._path,t.segment),t.abscissa=0,this._partSegCount--;else{if(!this.setPosAtNextPart())return 0!==r&&(t.segmentLength=this.calculateSegLength(this._path,t.segment),t.isPartEnd=!0,1===r?(t.abscissa=t.segmentLength,t.isPathEnd=!0):t.abscissa=t.segmentLength+e,!0);this._currentPosition.copyTo(t)}}if(t.abscissa+=e*this._partLengthRatio,i){if(0===i.length)if(0===s){const e=this._path[t.segment];i.push([e[0],e[1]])}else i.push(this.getSegCoord2D(this._path,t.segment,s));const e=t.abscissa/t.segmentLength;if(1===e){const e=this._path[t.segment+1];i.push([e[0],e[1]])}else i.push(this.getSegCoord2D(this._path,t.segment,e))}return this._partSegCount||Math.abs(t.abscissa-t.segmentLength)<this._tolerance&&(t.isPathEnd=this._partIsLast,t.isPartEnd=!0),!0}_getPoint(e){if(-1===e.segment)throw new Error("missing segment");const t=e.segmentLength<=0?0:e.abscissa/e.segmentLength;return this.getSegCoord2D(this._path,e.segment,t)}_getAngle(e){if(-1===e.segment)throw new Error("missing segment");const t=e.segmentLength<=0?0:e.abscissa/e.segmentLength;return this.getSegAngleCS(this._path,e.segment,t)}setPosAtNextPart(){for(;this._partSegCount;)this.hasNextSegment()&&this.nextSegment(),this._partSegCount--;if(!this.hasNextSegment())return!1;for(this._partLength=0,this._partIsLast=!0,this._partSegCount=0;this.hasNextSegment();)if(this._partLength+=this.calculateSegLength(this._path,this.nextSegment()),this._partSegCount++,1===v(this._path[this.getEndPointIndex()])){this._partIsLast=!this.hasNextSegment();break}let e=this._partSegCount;for(;e;)this.previousSegment(),--e;this._currentPosition.segment=this.nextSegment(),this._currentPosition.segmentLength=this.calculateSegLength(this._path,this._currentPosition.segment),this._currentPosition.abscissa=0,this._currentPosition.isPathEnd=this._currentPosition.isPartEnd=!1,--this._partSegCount;const t=this.getStartPointIndex();this._ctrlPtBegin=1===v(this._path[t]);let i=t+this._partSegCount+1;if(i>=this._path.length&&(i=0),this._ctrlPtEnd=1===v(this._path[i]),this._patternLength>0){const e=this._ctrlPtBegin?this._partCtrlPtGap:this._partExtPtGap,t=this._ctrlPtEnd?this._partCtrlPtGap:this._partExtPtGap;let i=Math.round((this._partLength-(e+t))/this._patternLength);i<=0&&(i=e+t>0?0:1),this._partLengthRatio=this._partLength/(e+t+i*this._patternLength),this._partLengthRatio<.01&&(this._partLengthRatio=1)}else this._partLengthRatio=1;return!0}hasNextSegment(){return this._seg<this._path.length-2}previousSegment(){return--this._seg}nextSegment(){return++this._seg}getStartPointIndex(){return this._seg}getEndPointIndex(){return this._seg+1}}class G{static local(){return null===G.instance&&(G.instance=new G),G.instance}execute(e,t,i){return new z(e,t,i)}}G.instance=null;class z extends S{constructor(e,t,i){super(e,!0,!0),this._walker=new U,this._walker.updateTolerance(i),this._endings=t.lineDashEnding,this._customDashPos=void 0!==t.offsetAlongLine?t.offsetAlongLine*i:0,this._offsetAtEnd=void 0!==t.customEndingOffset?t.customEndingOffset*i:0,this._pattern=new k,this._pattern.init(t.dashTemplate,!0),this._pattern.scale(i)}processPath(e){if(0===this._pattern.length())return this.iteratePath=!1,{paths:[e]};if(!this.iteratePath){let t=!0;switch(this._endings){case"HalfPattern":case"HalfGap":default:this._pattern.extPtGap=0;break;case"FullPattern":this.isClosed||(this._pattern.extPtGap=.5*this._pattern.firstValue());break;case"FullGap":this.isClosed||(this._pattern.extPtGap=.5*this._pattern.lastValue());break;case"NoConstraint":this.isClosed||(t=!1);break;case"Custom":this.isClosed||(this._pattern.extPtGap=.5*this._offsetAtEnd)}const i=this._walker.calculatePathLength(e);if(this._pattern.isEmpty()||i<.1*this._pattern.length())return{paths:[e]};if(!this._walker.init(e,this._pattern,t))return{paths:[e]}}let t;if(this.iteratePath)t=this._pattern.nextValue();else{let e;switch(this._endings){case"HalfPattern":default:e=.5*this._pattern.firstValue();break;case"HalfGap":e=.5*-this._pattern.lastValue();break;case"FullGap":e=-this._pattern.lastValue();break;case"FullPattern":e=0;break;case"NoConstraint":case"Custom":e=-this._customDashPos}let i=e/this._pattern.length();i-=Math.floor(i),e=i*this._pattern.length(),this._pattern.reset(),t=this._pattern.nextValue();let r=!1;for(;e>=t;)e-=t,t=this._pattern.nextValue(),r=!r;t-=e,r?(this._walker.nextPosition(t),t=this._pattern.nextValue()):this.isClosed&&(this._firstCurve=this._walker.nextCurve(t),t=this._pattern.nextValue(),this._walker.nextPosition(t),t=this._pattern.nextValue())}let i=this._walker.nextCurve(t);return i?this._walker.isPathEnd()?(this.iteratePath=!1,this._firstCurve&&(this._firstCurve.splice(0,1),E.mergePath(i,this._firstCurve),this._firstCurve=null)):(t=this._pattern.nextValue(),!this._walker.nextPosition(t)||this._walker.isPathEnd()?(this.iteratePath=!1,this._firstCurve&&(i=this._firstCurve,this._firstCurve=null)):this.iteratePath=!0):(this.iteratePath=!1,i=this._firstCurve,this._firstCurve=null),{paths:[i]}}}class B{static local(){return null===B.instance&&(B.instance=new B),B.instance}execute(e,t,i){return new j(e,t,i)}}B.instance=null;class j{constructor(e,t,i){switch(this._inputGeometries=e,this._curveHelper=new F,this._width=(void 0!==t.width?t.width:2)*i,t.method){case"Mitered":default:this._method="Mitered";break;case"Bevelled":this._method="Bevelled";break;case"Rounded":case"TrueBuffer":this._method="Rounded";break;case"Square":this._method="Square"}this._option=t.option,this._offsetFlattenError=T*i}next(){let e=this._inputGeometries.next();for(;e;){if((0,l.u)(e)&&this._width>0){if(Math.min(e.xmax-e.xmin,e.ymax-e.ymin)-2*this._width<0)return e;const t=[];return t.push([[e.xmin,e.ymin],[e.xmin,e.ymax],[e.xmax,e.ymax],[e.xmax,e.ymin],[e.xmin,e.ymin]]),t.push([[e.xmin+this._width,e.ymin+this._width],[e.xmax-this._width,e.ymin+this._width],[e.xmax-this._width,e.ymax-this._width],[e.xmin+this._width,e.ymax-this._width],[e.xmin+this._width,e.ymin+this._width]]),{rings:t}}if((0,l.y)(e)&&this._width>0){const t=[];for(const i of e.rings){const e=this._curveHelper.calculatePathLength(i),r=this._curveHelper.offset(i,this._width,this._method,4,this._offsetFlattenError);r&&(e<0&&r.reverse(),t.push(r))}if(t.length)return{rings:t}}e=this._inputGeometries.next()}return null}}class q{static local(){return null===q.instance&&(q.instance=new q),q.instance}execute(e,t,i){return new H(e,t,i)}}q.instance=null;class H extends S{constructor(e,t,i){super(e,!1,!0),this._curveHelper=new F,this._length=(void 0!==t.length?t.length:20)*i,this._angle=void 0!==t.angle?t.angle:225,this._position=void 0!==t.position?t.position:50,this._length<0&&(this._length=-this._length),this._position<20&&(this._position=20),this._position>80&&(this._position=80),this._mirror=!1}processPath(e){if(this._curveHelper.isEmpty(e,!1))return null;const t=e[0],i=e[e.length-1],r=[i[0]-t[0],i[1]-t[1]];this._curveHelper.normalize(r);const s=[t[0]+(i[0]-t[0])*this._position/100,t[1]+(i[1]-t[1])*this._position/100],n=Math.cos((90-this._angle)/180*Math.PI);let a=Math.sin((90-this._angle)/180*Math.PI);return this._mirror&&(a=-a),this._mirror=!this._mirror,{paths:[[t,[s[0]-this._length/2*n,s[1]-this._length/2*a],[s[0]+this._length/2*n,s[1]+this._length/2*a],i]]}}}class W{static local(){return null===W.instance&&(W.instance=new W),W.instance}execute(e,t,i){return new Q(e,t,i)}}W.instance=null;class Q{constructor(e,t,i){this._inputGeometries=e,this._offsetX=void 0!==t.offsetX?t.offsetX*i:0,this._offsetY=void 0!==t.offsetY?-t.offsetY*i:0}next(){let e=this._inputGeometries.next();for(;e;){if((0,l.u)(e))return{xmin:e.xmin+this._offsetX,xmax:e.xmax+this._offsetX,ymin:e.ymin+this._offsetY,ymax:e.ymax+this._offsetY};if((0,l.y)(e)){const t=(0,s.y)(e);return this._moveMultipath(t.rings,this._offsetX,this._offsetY),t}if((0,l.f)(e)){const t=(0,s.y)(e);return this._moveMultipath(t.paths,this._offsetX,this._offsetY),t}if((0,l.s)(e)){const t=(0,s.y)(e);return this._movePath(t.points,this._offsetX,this._offsetY),t}if((0,l.l)(e))return{x:e.x+this._offsetX,y:e.y+this._offsetY};e=this._inputGeometries.next()}return null}_moveMultipath(e,t,i){if(e)for(const r of e)this._movePath(r,t,i)}_movePath(e,t,i){if(e)for(const r of e)r[0]+=t,r[1]+=i}}class Z{static local(){return null===Z.instance&&(Z.instance=new Z),Z.instance}execute(e,t,i){return new Y(e,t,i)}}Z.instance=null;class Y{constructor(e,t,i){this._inputGeometries=e,this._curveHelper=new F,this._offset=(void 0!==t.offset?t.offset:1)*i,this._method=t.method,this._option=t.option,this._offsetFlattenError=T*i}next(){let e=this._inputGeometries.next();for(;e;){if(0===this._offset)return e;if((0,l.u)(e)){if("Rounded"===this._method&&this._offset>0){const t=[[e.xmin,e.ymin],[e.xmin,e.ymax],[e.xmax,e.ymax],[e.xmax,e.ymin],[e.xmin,e.ymin]],i=this._curveHelper.offset(t,this._offset,this._method,4,this._offsetFlattenError);return i?{rings:[i]}:null}if(Math.min(e.xmax-e.xmin,e.ymax-e.ymin)+2*this._offset>0)return{xmin:e.xmin-this._offset,xmax:e.xmax+this._offset,ymin:e.ymin-this._offset,ymax:e.ymax+this._offset}}if((0,l.y)(e)){const t=[];for(const i of e.rings){const e=this._curveHelper.offset(i,this._offset,this._method,4,this._offsetFlattenError);e&&t.push(e)}if(t.length)return{rings:t}}if((0,l.f)(e)){const t=[];for(const i of e.paths){const e=this._curveHelper.offset(i,this._offset,this._method,4,this._offsetFlattenError);e&&t.push(e)}if(t.length)return{paths:t}}e=this._inputGeometries.next()}return null}}class J{static local(){return null===J.instance&&(J.instance=new J),J.instance}execute(e,t,i){return new X(e,t,i)}}J.instance=null;class X{constructor(e,t,i){this._inputGeometries=e,this._reverse=void 0===t.reverse||t.reverse}next(){let e=this._inputGeometries.next();for(;e;){if(!this._reverse)return e;if((0,l.f)(e)){const t=(0,s.y)(e);return g(t.paths),t}e=this._inputGeometries.next()}return null}}class ${static local(){return null===$.instance&&($.instance=new $),$.instance}execute(e,t,i){return new K(e,t,i)}}$.instance=null;class K{constructor(e,t,i){this._inputGeometries=e,this._rotateAngle=void 0!==t.angle?-t.angle*Math.PI/180:0}next(){let e=this._inputGeometries.next();for(;e;){if(0===this._rotateAngle)return e;const t=(0,a.i)();(0,o.c)(t,e);const i=(t[2]+t[0])/2,r=(t[3]+t[1])/2;if((0,l.u)(e)){const t={rings:[[[e.xmin,e.ymin],[e.xmin,e.ymax],[e.xmax,e.ymax],[e.xmax,e.ymin],[e.xmin,e.ymin]]]};return this._rotateMultipath(t.rings,i,r),t}if((0,l.y)(e)){const t=(0,s.y)(e);return this._rotateMultipath(t.rings,i,r),t}if((0,l.f)(e)){const t=(0,s.y)(e);return this._rotateMultipath(t.paths,i,r),t}if((0,l.s)(e)){const t=(0,s.y)(e);return this._rotatePath(t.points,i,r),t}if((0,l.l)(e))return e;e=this._inputGeometries.next()}return null}_rotateMultipath(e,t,i){if(e)for(const r of e)this._rotatePath(r,t,i)}_rotatePath(e,t,i){if(e){const r=Math.cos(this._rotateAngle),s=Math.sin(this._rotateAngle);for(const n of e){const e=n[0]-t,a=n[1]-i;n[0]=t+e*r-a*s,n[1]=i+e*s+a*r}}}}class ee{static local(){return null===ee.instance&&(ee.instance=new ee),ee.instance}execute(e,t,i){return new te(e,t,i)}}ee.instance=null;class te{constructor(e,t,i){this._inputGeometries=e,this._xFactor=void 0!==t.xScaleFactor?t.xScaleFactor:1.15,this._yFactor=void 0!==t.yScaleFactor?t.yScaleFactor:1.15}next(){let e=this._inputGeometries.next();for(;e;){if(1===this._xFactor&&1===this._yFactor)return e;const t=(0,a.i)();(0,o.c)(t,e);const i=(t[2]+t[0])/2,r=(t[3]+t[1])/2;if((0,l.u)(e)){const t={rings:[[[e.xmin,e.ymin],[e.xmin,e.ymax],[e.xmax,e.ymax],[e.xmax,e.ymin],[e.xmin,e.ymin]]]};return this._scaleMultipath(t.rings,i,r),t}if((0,l.y)(e)){const t=(0,s.y)(e);return this._scaleMultipath(t.rings,i,r),t}if((0,l.f)(e)){const t=(0,s.y)(e);return this._scaleMultipath(t.paths,i,r),t}if((0,l.s)(e)){const t=(0,s.y)(e);return this._scalePath(t.points,i,r),t}if((0,l.l)(e))return e;e=this._inputGeometries.next()}return null}_scaleMultipath(e,t,i){if(e)for(const r of e)this._scalePath(r,t,i)}_scalePath(e,t,i){if(e)for(const r of e){const e=(r[0]-t)*this._xFactor,s=(r[1]-i)*this._yFactor;r[0]=t+e,r[1]=i+s}}}class ie{static local(){return null===ie.instance&&(ie.instance=new ie),ie.instance}execute(e,t,i){return new re(e,t,i)}}ie.instance=null;class re{constructor(e,t,i){this._inputGeometries=e,this._height=(void 0!==t.amplitude?t.amplitude:2)*i,this._period=(void 0!==t.period?t.period:3)*i,this._style=t.waveform,this._height<=0&&(this._height=Math.abs(this._height)),this._period<=0&&(this._period=Math.abs(this._period)),this._pattern=new k,this._pattern.addValue(this._period),this._pattern.addValue(this._period),this._walker=new U,this._walker.updateTolerance(i)}next(){let e=this._inputGeometries.next();for(;e;){if(0===this._height||0===this._period)return e;if((0,l.f)(e)){const t=this._processGeom(e.paths);if(t.length)return{paths:t}}if((0,l.y)(e)){const t=this._processGeom(e.rings);if(t.length)return{rings:t}}e=this._inputGeometries.next()}return null}_processGeom(e){const t=[];for(const i of e)if(this._walker.init(i,this._pattern))switch(this._style){case"Sinus":default:t.push(this._constructCurve(i,!1));break;case"Square":t.push(this._constructSquare(i));break;case"Triangle":t.push(this._constructTriangle(i));break;case"Random":t.push(this._constructCurve(i,!0))}else t.push(i);return t}_constructCurve(e,t){const i=new E,r=this._walker.calculatePathLength(e);let s=Math.round(r/this._period);0===s&&(s=1);const n=16*s+1,a=r/s,o=this._period/16,l=1/n,h=2*Math.PI*r/a,u=2*Math.PI*Math.random(),c=2*Math.PI*Math.random(),d=2*Math.PI*Math.random(),p=.75-Math.random()/2,f=.75-Math.random()/2,y={};this._walker.curPointAndAngle(y),i.startPath(y.pt);let m=0;for(;;){if(!this._walker.nextPointAndAngle(o,y)){i.lineTo(e[e.length-1]);break}{const e=m;let r;if(m+=l,t){const t=this._height/2*(1+.3*Math.sin(p*h*e+u));r=t*Math.sin(h*e+c),r+=t*Math.sin(f*h*e+d),r/=2}else r=.5*this._height*Math.sin(.5*h*e);i.lineTo([y.pt[0]-r*y.sa,y.pt[1]+r*y.ca])}}return i.path()}_constructSquare(e){const t=new E,i=this._walker.calculatePathLength(e);Math.round(i/this._period);let r=!0;for(;;){let e=!1;if(this._walker.curPositionIsValid()){const i={};this._walker.curPointAndAngle(i);const s={};if(this._walker.nextPointAndAngle(this._period,s)){const n={};this._walker.nextPointAndAngle(this._period,n)&&(r?(t.startPath(i.pt),r=!1):t.lineTo(i.pt),t.lineTo([i.pt[0]-this._height/2*i.sa,i.pt[1]+this._height/2*i.ca]),t.lineTo([s.pt[0]-this._height/2*s.sa,s.pt[1]+this._height/2*s.ca]),t.lineTo([s.pt[0]+this._height/2*s.sa,s.pt[1]-this._height/2*s.ca]),t.lineTo([n.pt[0]+this._height/2*n.sa,n.pt[1]-this._height/2*n.ca]),e=!0)}}if(!e){t.lineTo(this._walker.getPathEnd());break}}return t.path()}_constructTriangle(e){const t=new E,i=this._walker.calculatePathLength(e);Math.round(i/this._period);let r=!0;for(;;){let e=!1;if(this._walker.curPositionIsValid()){const i={};this._walker.curPointAndAngle(i);const s={};if(this._walker.nextPointAndAngle(this._period/2,s)){const n={};this._walker.nextPointAndAngle(this._period,n)&&(this._walker.nextPosition(this._period/2)&&(r?(t.startPath(i.pt),r=!1):t.lineTo(i.pt),t.lineTo([s.pt[0]-this._height/2*s.sa,s.pt[1]+this._height/2*s.ca]),t.lineTo([n.pt[0]+this._height/2*n.sa,n.pt[1]-this._height/2*n.ca])),e=!0)}}if(!e){t.lineTo(this._walker.getPathEnd());break}}return t.path()}}var se;!function(e){e.NoConstraint="NoConstraint",e.WithMarkers="WithMarkers",e.WithFullGap="WithFullGap",e.WithHalfGap="WithHalfGap",e.Custom="Custom"}(se||(se={}));class ne{static local(){return null===ne.instance&&(ne.instance=new ne),ne.instance}execute(e,t,i){return new ae(e,t,i)}}ne.instance=null;class ae extends w{constructor(e,t,i){super(e,!0,!0),this._grometryWalker=new U,this._grometryWalker.updateTolerance(i),this._angleToLine=void 0===t.angleToLine||t.angleToLine,this._offset=void 0!==t.offset?t.offset*i:0,this._originalEndings=t.endings,this._offsetAtEnd=void 0!==t.customEndingOffset?t.customEndingOffset*i:0,this._position=void 0!==t.offsetAlongLine?t.offsetAlongLine*i:0,this._pattern=new k,this._pattern.init(t.placementTemplate,!1),this._pattern.scale(i),this._endings=this._originalEndings}processPath(e){if(this._pattern.isEmpty())return null;let t;if(this.iteratePath)t=this._pattern.nextValue();else{this._originalEndings===se.WithFullGap&&this.isClosed?this._endings=se.WithMarkers:this._endings=this._originalEndings,this._pattern.extPtGap=0;let i,r=!0;switch(this._endings){case se.NoConstraint:i=-this._position,i=this._adjustPosition(i),r=!1;break;case se.WithHalfGap:default:i=-this._pattern.lastValue()/2;break;case se.WithFullGap:i=-this._pattern.lastValue(),this._pattern.extPtGap=this._pattern.lastValue();break;case se.WithMarkers:i=0;break;case se.Custom:i=-this._position,i=this._adjustPosition(i),this._pattern.extPtGap=.5*this._offsetAtEnd}if(!this._grometryWalker.init(e,this._pattern,r))return null;this._pattern.reset();let s=0;for(;i>s;)i-=s,s=this._pattern.nextValue();s-=i,t=s,this.iteratePath=!0}const i={};return this._grometryWalker.nextPointAndAngle(t,i)?this._endings===se.WithFullGap&&this._grometryWalker.isPathEnd()?(this.iteratePath=!1,null):this._endings===se.WithMarkers&&this._grometryWalker.isPathEnd()&&(this.iteratePath=!1,this.isClosed)?null:(this.internalPlacement.setTranslate(i.pt[0]+this._offset*i.sa,i.pt[1]-this._offset*i.ca),this._angleToLine&&this.internalPlacement.setRotateCS(i.ca,i.sa),this.internalPlacement):(this.iteratePath=!1,null)}_adjustPosition(e){let t=e/this._pattern.length();return t-=Math.floor(t),t*this._pattern.length()}}class oe{static local(){return null===oe.instance&&(oe.instance=new oe),oe.instance}execute(e,t,i){return new le(e,t,i)}}oe.instance=null;class le extends w{constructor(e,t,i){super(e,!1,!0),this._curveHelper=new F,this._angleToLine=void 0===t.angleToLine||t.angleToLine,this._offset=void 0!==t.offset?t.offset*i:0,this._type=t.extremityPlacement,this._position=void 0!==t.offsetAlongLine?t.offsetAlongLine*i:0,this._beginProcessed=!1}processPath(e){let t;switch(this._type){case"Both":default:this._beginProcessed?(t=this._atExtremities(e,this._position,!1),this._beginProcessed=!1,this.iteratePath=!1):(t=this._atExtremities(e,this._position,!0),this._beginProcessed=!0,this.iteratePath=!0);break;case"JustBegin":t=this._atExtremities(e,this._position,!0);break;case"JustEnd":t=this._atExtremities(e,this._position,!1);break;case"None":}return t}_atExtremities(e,t,i){const r=e.length;if(r<2)return null;const s=i?1:r-2,n=i?r:-1,a=i?1:-1;let o,l=0,h=i?e[0]:e[r-1];for(let i=s;i!==n;i+=a){o=h,h=e[i];const r=this._curveHelper.calculateLength(o,h);if(l+r>t){const e=(t-l)/r,[i,s]=this._curveHelper.getAngleCS(o,h,e),n=x(o,h,e);return this.internalPlacement.setTranslate(n[0]-this._offset*s,n[1]+this._offset*i),this._angleToLine&&this.internalPlacement.setRotateCS(-i,-s),this.internalPlacement}l+=r}return null}}class he{static local(){return null===he.instance&&(he.instance=new he),he.instance}execute(e,t,i){return new ue(e,t,i)}}he.instance=null;class ue extends w{constructor(e,t,i){super(e,!0,!0),this._walker=new U,this._walker.updateTolerance(i),this._angleToLine=void 0===t.angleToLine||t.angleToLine,this._offset=void 0!==t.offset?t.offset*i:0,this._beginGap=void 0!==t.beginPosition?t.beginPosition*i:0,this._endGap=void 0!==t.endPosition?t.endPosition*i:0,this._flipFirst=void 0===t.flipFirst||t.flipFirst,this._pattern=new k,this._pattern.init(t.positionArray,!1,!1),this._subPathLen=0,this._posCount=this._pattern.size(),this._isFirst=!0,this._prevPos=0}processPath(e){if(this._pattern.isEmpty())return null;let t;if(this.iteratePath){const e=this._pattern.nextValue()*this._subPathLen,i=this._beginGap+e;t=i-this._prevPos,this._prevPos=i}else{if(this._posCount=this._pattern.size(),this._isFirst=!0,this._prevPos=0,this._subPathLen=this._walker.calculatePathLength(e)-this._beginGap-this._endGap,this._subPathLen<0)return this.iteratePath=!1,null;if(!this._walker.init(e,this._pattern,!1))return null;this._pattern.reset();const i=this._pattern.nextValue()*this._subPathLen,r=this._beginGap+i;t=r-this._prevPos,this._prevPos=r,this.iteratePath=!0}const i={};if(!this._walker.nextPointAndAngle(t,i,1))return this.iteratePath=!1,null;this.internalPlacement.setTranslate(i.pt[0]+this._offset*i.sa,i.pt[1]-this._offset*i.ca);const r=this._isFirst&&this._flipFirst;let s,n;return this._angleToLine?(s=i.ca,n=i.sa):(s=1,n=0),r&&(s=-s,n=-n),this.internalPlacement.setRotateCS(s,n),this._isFirst=!1,this._posCount--,0===this._posCount&&(this.iteratePath=!1),this.internalPlacement}}class ce{static local(){return null===ce.instance&&(ce.instance=new ce),ce.instance}execute(e,t,i){return new de(e,t,i)}}ce.instance=null;class de{constructor(e,t,i){if(this._xMin=0,this._xMax=0,this._yMin=0,this._yMax=0,this._currentX=0,this._currentY=0,this._stepX=(void 0!==t.stepX?Math.abs(t.stepX):16)*i,this._stepY=(void 0!==t.stepY?Math.abs(t.stepY):16)*i,0!==this._stepX&&0!==this._stepY&&e&&function(e){return void 0!==e.rings}(e)&&e.rings){if(this._gridType=void 0!==t.gridType?t.gridType:"Fixed","Random"===this._gridType)this._randomness=void 0!==t.randomness?t.randomness/100:1,this._gridAngle=0,this._shiftOddRows=!1,this._cosAngle=1,this._sinAngle=0,this._offsetX=0,this._offsetY=0;else{if(this._randomness=0,this._gridAngle=void 0!==t.gridAngle?t.gridAngle:0,this._shiftOddRows=void 0!==t.shiftOddRows&&t.shiftOddRows,this._offsetX=void 0!==t.offsetX?t.offsetX*i:0,this._offsetY=void 0!==t.offsetY?t.offsetY*i:0,this._cosAngle=Math.cos(this._gridAngle/180*Math.PI),this._sinAngle=-Math.sin(this._gridAngle/180*Math.PI),this._stepX)if(this._offsetX<0)for(;this._offsetX<-.5*this._stepX;)this._offsetX+=this._stepX;else for(;this._offsetX>=.5*this._stepX;)this._offsetX-=this._stepX;if(this._stepY)if(this._offsetY<0)for(;this._offsetY<-.5*this._stepY;)this._offsetY+=this._stepY;else for(;this._offsetY>=.5*this._stepY;)this._offsetY-=this._stepY}this._graphicOriginX=0,this._graphicOriginY=0,this._internalPlacement=new h,this._calculateMinMax(e),this._geometry=e}}next(){return this._geometry?this._nextInside():null}_calculateMinMax(e){let t,i,r,s,n,a,o,l;this._xMin=0,this._xMax=0,this._yMin=0,this._yMax=0,n=a=Number.MAX_VALUE,o=l=-Number.MAX_VALUE;for(const h of e.rings){const e=h?h.length:0;for(let u=0;u<e;++u)t=h[u][0]-this._graphicOriginX-this._offsetX,i=h[u][1]-this._graphicOriginY-this._offsetY,r=this._cosAngle*t-this._sinAngle*i,s=this._sinAngle*t+this._cosAngle*i,n=Math.min(n,r),o=Math.max(o,r),a=Math.min(a,s),l=Math.max(l,s)}n+=this._graphicOriginX,o+=this._graphicOriginX,a+=this._graphicOriginY,l+=this._graphicOriginY,this._xMin=Math.round(n/this._stepX),this._xMax=Math.round(o/this._stepX),this._yMin=Math.round(a/this._stepY),this._yMax=Math.round(l/this._stepY),this._currentX=this._xMax+1,this._currentY=this._yMin-1}_nextInside(){for(;;){if(this._currentX>this._xMax){if(this._currentY++,this._currentY>this._yMax)return null;this._currentX=this._xMin,this._shiftOddRows&&this._currentY%2&&this._currentX--}let e=this._currentX*this._stepX+this._offsetX;this._shiftOddRows&&this._currentY%2&&(e+=.5*this._stepX);const t=this._currentY*this._stepY+this._offsetY;let i,r;return this._currentX++,"Random"===this._gridType?(i=this._graphicOriginX+e+this._stepX*this._randomness*(.5-Math.random())*2/3,r=this._graphicOriginY+t+this._stepY*this._randomness*(.5-Math.random())*2/3):(i=this._graphicOriginX+this._cosAngle*e+this._sinAngle*t,r=this._graphicOriginY-this._sinAngle*e+this._cosAngle*t),this._internalPlacement.setTranslate(i,r),this._internalPlacement}}}class pe{static local(){return null===pe.instance&&(pe.instance=new pe),pe.instance}execute(e,t,i){return new fe(e,t,i)}}pe.instance=null;class fe extends w{constructor(e,t,i){super(e,!0,!0),this._curveHelper=new F,this._angleToLine=void 0===t.angleToLine||t.angleToLine,this._offset=void 0!==t.offset?t.offset*i:0,this._relativeTo=t.relativeTo,this._position=void 0!==t.startPointOffset?t.startPointOffset*i:0,this._epsilon=.001*i}processPath(e){const t=this._position;if("SegmentMidpoint"===this._relativeTo){for(this.iteratePath||(this._segmentCount=e.length,this._curSegment=1,this.iteratePath=!0);this._curSegment<this._segmentCount;){const t=this._curSegment;this._curSegment++;const i=e[t-1],r=e[t],s=this._curveHelper.calculateLength(i,r);if(s<this._epsilon)continue;const n=.5+this._position/s,[a,o]=this._curveHelper.getAngleCS(i,r,n),l=x(i,r,n);return this.internalPlacement.setTranslate(l[0]-this._offset*o,l[1]+this._offset*a),this._angleToLine&&this.internalPlacement.setRotateCS(a,o),this.internalPlacement}return this.iteratePath=!1,null}"LineEnd"===this._relativeTo&&_(e);const i=this.onLine(e,t);return"LineEnd"===this._relativeTo&&_(e),i}onLine(e,t){let i,r=!1;switch(this._relativeTo){case"LineMiddle":default:i=this._curveHelper.calculatePathLength(e)/2+t;break;case"LineBeginning":i=t;break;case"LineEnd":i=t,r=!0}const s=e.length;let n,a=0,o=e[0];for(let t=1;t<s;++t){n=o,o=e[t];const s=this._curveHelper.calculateLength(n,o);if(a+s>i){const e=(i-a)/s,[t,l]=this._curveHelper.getAngleCS(n,o,e),h=x(n,o,e),u=r?this._offset:-this._offset;return this.internalPlacement.setTranslate(h[0]-u*l,h[1]+u*t),this._angleToLine&&(r?this.internalPlacement.setRotateCS(-t,-l):this.internalPlacement.setRotateCS(t,l)),this.internalPlacement}a+=s}return null}}class ye{static local(){return null===ye.instance&&(ye.instance=new ye),ye.instance}execute(e,t,i){return new me(e,t,i)}}ye.instance=null;class me extends w{constructor(e,t,i){super(e,!0,!0),this._curveHelper=new F,this._angleToLine=void 0===t.angleToLine||t.angleToLine,this._offset=void 0!==t.offset?t.offset*i:0,this._endPoints=void 0===t.placeOnEndPoints||t.placeOnEndPoints,this._controlPoints=void 0===t.placeOnControlPoints||t.placeOnControlPoints,this._regularVertices=void 0===t.placeOnRegularVertices||t.placeOnRegularVertices,this._tags=[],this._tagIterator=0}processPath(e){if(this.iteratePath||(this._preparePath(e),this.iteratePath=!0),this._tagIterator>=this._tags.length)return this._tags.length=0,this._tagIterator=0,this.iteratePath=!1,null;const t=this._tags[this._tagIterator];this._angleToLine&&this.internalPlacement.setRotate(t[2]);let i=t[0],r=t[1];if(0!==this._offset){const e=Math.cos(t[2]),s=Math.sin(t[2]);i-=this._offset*s,r+=this._offset*e}return this.internalPlacement.setTranslate(i,r),this._tagIterator++,this.internalPlacement}_preparePath(e){this._tags.length=0,this._tagIterator=0;const t=function(e){return!(!e||0===e.length)&&e[0][0]===e[e.length-1][0]&&e[0][1]===e[e.length-1][1]}(e),i=e.length-1;let r,s,n=0,a=0,o=0,l=0,h=0;for(;n<i;){n++,r=e[n-1],s=e[n];const u=v(r),c=v(s);(this._angleToLine||0!==this._offset)&&(l=this._curveHelper.getAngle(r,s,0)),1===n?t?(a=l,o=u):this._endPoints&&this._tags.push([r[0],r[1],l]):1===u?this._controlPoints&&this._tags.push([r[0],r[1],ge(h,l)]):this._regularVertices&&this._tags.push([r[0],r[1],ge(h,l)]),(this._angleToLine||0!==this._offset)&&(h=this._curveHelper.getAngle(r,s,1)),n===i&&(t?1===c||1===o?this._controlPoints&&this._tags.push([s[0],s[1],ge(h,a)]):this._regularVertices&&this._tags.push([s[0],s[1],ge(h,a)]):this._endPoints&&this._tags.push([s[0],s[1],h]))}this._tagIterator=0}}function ge(e,t){const i=Math.PI;for(;Math.abs(t-e)>i+2e-15;)t-e>i?t-=2*i:t+=2*i;return(e+t)/2}class _e{static local(){return null===_e.instance&&(_e.instance=new _e),_e.instance}execute(e,t,i){return new xe(e,t,i)}}_e.instance=null;class xe{constructor(e,t,i){this._geometry=e,this._offsetX=void 0!==t.offsetX?t.offsetX*i:0,this._offsetY=void 0!==t.offsetY?t.offsetY*i:0,this._method=void 0!==t.method?t.method:"OnPolygon",this._internalPlacement=new h}next(){const e=this._geometry;return this._geometry=null,e&&function(e){return void 0!==e.rings}(e)?this._polygonCenter(e):null}_polygonCenter(e){let t=!1;switch(this._method){case"OnPolygon":default:case"CenterOfMass":case"BoundingBoxCenter":{const i=(0,a.i)();(0,o.c)(i,e),this._internalPlacement.setTranslate((i[2]+i[0])/2+this._offsetX,(i[3]+i[1])/2-this._offsetY),t=!0;break}}return t?this._internalPlacement:null}}function ve(e){if(!e)return null;switch(e.type){case"CIMGeometricEffectAddControlPoints":return C.local();case"CIMGeometricEffectArrow":return R.local();case"CIMGeometricEffectBuffer":return L.local();case"CIMGeometricEffectCut":return N.local();case"CIMGeometricEffectDashes":return G.local();case"CIMGeometricEffectDonut":return B.local();case"CIMGeometricEffectJog":return q.local();case"CIMGeometricEffectMove":return W.local();case"CIMGeometricEffectOffset":return Z.local();case"CIMGeometricEffectReverse":return J.local();case"CIMGeometricEffectRotate":return $.local();case"CIMGeometricEffectScale":return ee.local();case"CIMGeometricEffectWave":return ie.local()}return null}function be(e){if(!e)return null;switch(e.type){case"CIMMarkerPlacementAlongLineSameSize":return ne.local();case"CIMMarkerPlacementAtExtremities":return oe.local();case"CIMMarkerPlacementAtRatioPositions":return he.local();case"CIMMarkerPlacementInsidePolygon":return ce.local();case"CIMMarkerPlacementOnLine":return pe.local();case"CIMMarkerPlacementOnVertices":return ye.local();case"CIMMarkerPlacementPolygonCenter":return _e.local()}return null}class we{constructor(e=0,t=0,i=0,r=0){this.x=e,this.y=t,this.width=i,this.height=r}get isEmpty(){return this.width<=0||this.height<=0}union(e){this.x=Math.min(this.x,e.x),this.y=Math.min(this.y,e.y),this.width=Math.max(this.width,e.width),this.height=Math.max(this.height,e.height)}}const Se=Math.PI/180,Ie=s.n.getLogger("esri.symbols.cim.CIMSymbolDrawHelper");class Ce{constructor(e){this._t=e}static createIdentity(){return new Ce([1,0,0,0,1,0])}clone(){const e=this._t;return new Ce(e.slice())}transform(e){const t=this._t;return[t[0]*e[0]+t[1]*e[1]+t[2],t[3]*e[0]+t[4]*e[1]+t[5]]}static createScale(e,t){return new Ce([e,0,0,0,t,0])}scale(e,t){const i=this._t;return i[0]*=e,i[1]*=e,i[2]*=e,i[3]*=t,i[4]*=t,i[5]*=t,this}scaleRatio(){return Math.sqrt(this._t[0]*this._t[0]+this._t[1]*this._t[1])}static createTranslate(e,t){return new Ce([0,0,e,0,0,t])}translate(e,t){const i=this._t;return i[2]+=e,i[5]+=t,this}static createRotate(e){const t=Math.cos(e),i=Math.sin(e);return new Ce([t,-i,0,i,t,0])}rotate(e){return this.multiply(Ce.createRotate(e))}multiply(e){const t=this._t,i=e._t,r=t[0]*i[0]+t[3]*i[1],s=t[1]*i[0]+t[4]*i[1],n=t[2]*i[0]+t[5]*i[1]+i[2],a=t[0]*i[3]+t[3]*i[4],o=t[1]*i[3]+t[4]*i[4],l=t[2]*i[3]+t[5]*i[4]+i[5];return t[0]=r,t[1]=s,t[2]=n,t[3]=a,t[4]=o,t[5]=l,this}}class Me{constructor(e){this._transfos=[],this._sizeTransfos=[],this._transfos.push(e||Ce.createIdentity()),this._sizeTransfos.push(e?e.scaleRatio():1)}transformPt(e){return this._transfos[this._transfos.length-1].transform(e)}transformSize(e){return e*this._sizeTransfos[this._sizeTransfos.length-1]}back(){return this._transfos[this._transfos.length-1]}push(e,t){const i=t?e.scaleRatio():1;e.multiply(this.back()),this._transfos.push(e),this._sizeTransfos.push(this._sizeTransfos[this._sizeTransfos.length-1]*i)}pop(){this._transfos.splice(-1,1),this._sizeTransfos.splice(-1,1)}drawSymbol(e,t){if(e)switch(e.type){case"CIMPointSymbol":case"CIMLineSymbol":case"CIMPolygonSymbol":this.drawMultiLayerSymbol(e,t)}}drawMultiLayerSymbol(e,t){if(!e)return;const i=e.symbolLayers;if(!i)return;const r=e.effects;if(r){const e=this.executeEffects(r,t);if(e){let t=e.next();for(;t;)this.drawSymbolLayers(i,t),t=e.next()}}else this.drawSymbolLayers(i,t)}executeEffects(e,t){let i=new u(t);for(const t of e){const e=ve(t);e&&(i=e.execute(i,t,1))}return i}drawSymbolLayers(e,t){let i=e.length;for(;i--;){const r=e[i];if(!r||!1===r.enable)continue;const s=r.effects;if(s){const e=this.executeEffects(s,t);if(e){let t=e.next();for(;t;)this.drawSymbolLayer(r,t),t=e.next()}}else this.drawSymbolLayer(r,t)}}drawSymbolLayer(e,t){switch(e.type){case"CIMSolidFill":this.drawSolidFill(t,e.color);break;case"CIMHatchFill":this.drawHatchFill(e,t);break;case"CIMSolidStroke":this.drawSolidStroke(t,e.color,e.width,e.capStyle,e.joinStyle,e.miterLimit);break;case"CIMCharacterMarker":case"CIMPictureMarker":case"CIMVectorMarker":this.drawMarkerLayer(e,t)}}drawHatchFill(e,t){const i=this._buildHatchPolyline(e,t,1);i&&(this.pushClipPath(t),this.drawMultiLayerSymbol(e.lineSymbol,i),this.popClipPath())}drawMarkerLayer(e,t){const i=e.markerPlacement;if(i){const r=be(i);if(r){const s="CIMMarkerPlacementInsidePolygon"===i.type;s&&this.pushClipPath(t);const n=1,a=r.execute(t,i,n);if(a){let t=a.next();for(;t;)this.drawMarker(e,t),t=a.next()}s&&this.popClipPath()}}else{const i=new h;i.tx=t.x,i.ty=t.y,this.drawMarker(e,i)}}drawMarker(e,t){switch(e.type){case"CIMCharacterMarker":case"CIMPictureMarker":this.drawPictureMarker(e,t);break;case"CIMVectorMarker":this.drawVectorMarker(e,t)}}drawPictureMarker(e,t){if(!e)return;const i=e.size||10,r=Ce.createIdentity(),s=e.anchorPoint;if(s){let t=s.x,n=s.y;"Absolute"!==e.anchorPointUnits&&(t*=i,n*=i),r.translate(-t,-n)}e.rotation&&r.rotate(e.rotation*Se),r.translate(e.offsetX||0,e.offsetY||0),r.translate(t.tx,t.ty),this.push(r,!1),this.drawImage(e.url,i,e.scaleX),this.pop()}drawVectorMarker(e,t){if(!e)return;const i=e.markerGraphics;if(!i)return;const r=e.size,s=e.frame,n=s?s.ymax-s.ymin:0,a=r&&n?r/n:1,o=Ce.createIdentity();s&&o.translate(.5*-(s.xmax+s.xmin),.5*-(s.ymax+s.ymin));const l=e.anchorPoint;if(l){let t=l.x,i=l.y;"Absolute"!==e.anchorPointUnits?s&&(t*=s.xmax-s.xmin,i*=s.ymax-s.ymin):(t/=a,i/=a),o.translate(-t,-i)}1!==a&&o.scale(a,a),e.rotation&&o.rotate(e.rotation*Se),o.translate(e.offsetX||0,e.offsetY||0),o.translate(t.tx,t.ty),this.push(o,e.scaleSymbolsProportionally);for(const e of i)e&&e.symbol&&e.geometry||Ie.error("Invalid marker graphic",e),this.drawSymbol(e.symbol,e.geometry);this.pop()}_buildHatchPolyline(e,t,i){let r=(void 0!==e.separation?e.separation:4)*i,s=void 0!==e.rotation?e.rotation:0;if(0===r)return null;r<0&&(r=-r);let n=0;const l=.5*r;for(;n>l;)n-=r;for(;n<-l;)n+=r;const h=(0,a.i)();(0,o.c)(h,t),h[0]-=l,h[1]-=l,h[2]+=l,h[3]+=l;const u=[[h[0],h[1]],[h[0],h[3]],[h[2],h[3]],[h[2],h[1]]];for(;s>180;)s-=180;for(;s<0;)s+=180;const c=Math.cos(s*Se),d=Math.sin(s*Se),p=-r*d,f=r*c;let y,m,g,_;n=(void 0!==e.offsetX?e.offsetX*i:0)*d-(void 0!==e.offsetY?e.offsetY*i:0)*c,y=g=Number.MAX_VALUE,m=_=-Number.MAX_VALUE;for(const e of u){const t=e[0],i=e[1],r=c*t+d*i,s=-d*t+c*i;y=Math.min(y,r),g=Math.min(g,s),m=Math.max(m,r),_=Math.max(_,s)}g=Math.floor(g/r)*r;let x=c*y-d*g-p*n/r,v=d*y+c*g-f*n/r,b=c*m-d*g-p*n/r,w=d*m+c*g-f*n/r;const S=1+Math.round((_-g)/r),I=[];for(let e=0;e<S;e++)x+=p,v+=f,b+=p,w+=f,I.push([[x,v],[b,w]]);return{paths:I}}}class Te extends Me{constructor(){super(),this.reset()}reset(){this._xmin=this._ymin=1/0,this._xmax=this._ymax=-1/0,this._clipCount=0}envelope(){return new we(this._xmin,this._ymin,this._xmax-this._xmin,this._ymax-this._ymin)}drawSolidFill(e){if(e&&!(this._clipCount>0))if((0,l.y)(e))this._processPath(e.rings,0);else if((0,l.f)(e))this._processPath(e.paths,0);else if((0,l.u)(e)){const t=Fe(e);t&&this._processPath(t.rings,0)}}drawSolidStroke(e,t,i){if(!e||this._clipCount>0)return;const r=.5*this.transformSize(i);if((0,l.y)(e))this._processPath(e.rings,r);else if((0,l.f)(e))this._processPath(e.paths,r);else if((0,l.u)(e)){const t=Fe(e);t&&this._processPath(t.rings,r)}}pushClipPath(e){this.drawSolidFill(e),++this._clipCount}popClipPath(){--this._clipCount}drawImage(e,t,i){const r=t/2;this._merge(this.transformPt([0,0]),r)}_processPath(e,t){if(e)for(const i of e){const e=i?i.length:0;if(e>1){this._merge(this.transformPt(i[0]),t);for(let r=1;r<e;++r)this._merge(this.transformPt(i[r]),t)}}}_merge(e,t){e[0]-t<this._xmin&&(this._xmin=e[0]-t),e[0]+t>this._xmax&&(this._xmax=e[0]+t),e[1]-t<this._ymin&&(this._ymin=e[1]-t),e[1]+t>this._ymax&&(this._ymax=e[1]+t)}}class Ee extends Me{constructor(e,t){super(t),this._ctx=e}drawSolidFill(e,t){if(!e)return;if((0,l.y)(e))this._buildPath(e.rings,!0);else if((0,l.f)(e))this._buildPath(e.paths,!0);else{if(!(0,l.u)(e))return;this._buildPath(Fe(e).rings,!0)}const i=this._ctx;i.fillStyle="string"==typeof t?t:"rgba("+Math.round(t[0])+","+Math.round(t[1])+","+Math.round(t[2])+","+t[3]/255+")",i.fill("evenodd")}drawSolidStroke(e,t,i,r,s,n){if(!e||!t||0===i)return;if((0,l.y)(e))this._buildPath(e.rings,!0);else if((0,l.f)(e))this._buildPath(e.paths,!1);else{if(!(0,l.u)(e))return;this._buildPath(Fe(e).rings,!0)}const a=this._ctx;a.strokeStyle="string"==typeof t?t:"rgba("+Math.round(t[0])+","+Math.round(t[1])+","+Math.round(t[2])+","+t[3]/255+")",a.lineWidth=this.transformSize(i)+.5,this._setCapStyle(r),this._setJoinStyle(s),a.miterLimit=n,a.stroke()}pushClipPath(e){if(this._ctx.save(),(0,l.y)(e))this._buildPath(e.rings,!0);else if((0,l.f)(e))this._buildPath(e.paths,!0);else{if(!(0,l.u)(e))return;this._buildPath(Fe(e).rings,!0)}this._ctx.clip("evenodd")}popClipPath(){this._ctx.restore()}drawImage(e,t,i){}_buildPath(e,t){const i=this._ctx;if(i.beginPath(),e)for(const r of e){const e=r?r.length:0;if(e>1){let s=this.transformPt(r[0]);i.moveTo(s[0],s[1]);for(let t=1;t<e;++t)s=this.transformPt(r[t]),i.lineTo(s[0],s[1]);t&&i.closePath()}}}_setCapStyle(e){switch(e){case"Butt":this._ctx.lineCap="butt";break;case"Round":this._ctx.lineCap="round";break;case"Square":this._ctx.lineCap="square"}}_setJoinStyle(e){switch(e){case"Bevel":this._ctx.lineJoin="bevel";break;case"Round":this._ctx.lineJoin="round";break;case"Miter":this._ctx.lineJoin="miter"}}}const Fe=e=>e?{spatialReference:e.spatialReference,rings:[[[e.xmin,e.ymin],[e.xmin,e.ymax],[e.xmax,e.ymax],[e.xmax,e.ymin],[e.xmin,e.ymin]]]}:null,Ae=[1,256,65536,16777216],Re=[1/256,1/65536,1/16777216,1/4294967296],Pe=function(e,t=0){let i=0;for(let r=0;r<4;r++)i+=e[t+r]*Re[r];return i}(new Uint8ClampedArray([255,255,255,255]));function Le(e,t,i=0){const r=function(e,t,i){return e<0?0:e>i?i:e}(e,0,Pe);for(let e=0;e<4;e++)t[i+e]=Math.floor(256*De(r*Ae[e]))}function De(e){return e-Math.floor(e)}const Ne=Math.PI,Oe=Ne/2,ke=s.n.getLogger("esri.symbols.cim.CIMSymbolHelper");function Ve(e,t){switch(t.type){case"CIMSymbolReference":{const i={type:"point",x:0,y:0};e.drawSymbol(t.symbol,i);break}case"CIMPointSymbol":{const i={type:"point",x:0,y:0};e.drawSymbol(t,i);break}case"CIMTextSymbol":break;case"CIMVectorMarker":{const i=new h;e.drawMarker(t,i);break}}return e.envelope()}class Ue{static getEnvelope(e){const t=new Te;if(Array.isArray(e)){let i;for(const r of e)i?i.union(Ve(t,r)):i=Ve(t,r);return i}return Ve(t,e)}static getTextureAnchor(e){const t=this.getEnvelope(e);if(!t||t.width<=0||t.height<=0)return[0,0,0];const i=96/72,r=(t.x+.5*t.width)*i,s=-(t.y+.5*t.height)*i,n=t.width*i+2,a=t.height*i+2;return[r/n,s/a,a]}static rasterize(e,t,i,r=!0){const s=i||this.getEnvelope(t);if(!s||s.width<=0||s.height<=0)return[null,0,0,0,0];const n=96/72,a=(s.x+.5*s.width)*n,o=(s.y+.5*s.height)*n;e.width=s.width*n,e.height=s.height*n,i||(e.width+=2,e.height+=2);const l=e.getContext("2d"),u=Ce.createScale(n,-n);u.translate(.5*e.width-a,.5*e.height+o);const c=new Ee(l,u);switch(t.type){case"CIMPointSymbol":{const e={type:"point",x:0,y:0};c.drawSymbol(t,e);break}case"CIMVectorMarker":{const e=new h;c.drawMarker(t,e);break}}const d=l.getImageData(0,0,e.width,e.height),p=new Uint8Array(d.data);if(r){let e;for(let t=0;t<p.length;t+=4)e=p[t+3]/255,p[t]=p[t]*e,p[t+1]=p[t+1]*e,p[t+2]=p[t+2]*e}return[p,e.width,e.height,-a/e.width,-o/e.height]}static fromSimpleMarker(e){const t=50;let i,r;const s=e.style;if("circle"===s||"esriSMSCircle"===s){const e=.25;let s=Math.acos(1-e/t),n=Math.ceil(Ne/s/4);0===n&&(n=1),s=Oe/n,n*=4;const a=[];a.push([t,0]);for(let e=1;e<n;e++)a.push([t*Math.cos(e*s),-t*Math.sin(e*s)]);a.push([t,0]),i={rings:[a]},r={xmin:-t,ymin:-t,xmax:t,ymax:t}}else if("cross"===s||"esriSMSCross"===s){const e=0;i={rings:[[[e,t],[e,e],[t,e],[t,-e],[e,-e],[e,-t],[-e,-t],[-e,-e],[-t,-e],[-t,e],[-e,e],[-e,t],[e,t]]]},r={xmin:-t,ymin:-t,xmax:t,ymax:t}}else if("diamond"===s||"esriSMSDiamond"===s)i={rings:[[[-t,0],[0,t],[t,0],[0,-t],[-t,0]]]},r={xmin:-t,ymin:-t,xmax:t,ymax:t};else if("square"===s||"esriSMSSquare"===s)i={rings:[[[-t,-t],[-t,t],[t,t],[t,-t],[-t,-t]]]},r={xmin:-t,ymin:-t,xmax:t,ymax:t};else if("x"===s||"esriSMSX"===s){const e=0;i={rings:[[[0,e],[t-e,t],[t,t-e],[e,0],[t,e-t],[t-e,-t],[0,-e],[e-t,-t],[-t,e-t],[-e,0],[-t,t-e],[e-t,t],[0,e]]]},r={xmin:-t,ymin:-t,xmax:t,ymax:t}}else if("triangle"===s||"esriSMSTriangle"===s){const e=57.735026918962575,t=-e,s=2/3*100,n=s-100;i={rings:[[[t,n],[0,s],[e,n],[t,n]]]},r={xmin:t,ymin:n,xmax:e,ymax:s}}else"arrow"!==s&&"esriSMSArrow"!==s||(i={rings:[[[-50,50],[50,0],[-50,-50],[-33,-20],[-33,20],[-50,50]]]},r={xmin:-t,ymin:-t,xmax:t,ymax:t});let n;if(i&&r){const t=[{type:"CIMSolidFill",enable:!0,color:e.color}];e.outline&&t.push({type:"CIMSolidStroke",enable:!0,width:e.outline.width,color:e.outline.color});const s={type:"CIMPolygonSymbol",symbolLayers:t};n={type:"CIMPointSymbol",symbolLayers:[{type:"CIMVectorMarker",enable:!0,rotation:e.angle,size:e.size,offsetX:e.xoffset,offsetY:e.yoffset,frame:r,markerGraphics:[{type:"CIMMarkerGraphic",geometry:i,symbol:s}]}]}}return n}static fromCIMHatchFill(e){const t=void 0!==e.separation?e.separation:4,i=t/2;let r=this._getLineSymbolPeriod(e.lineSymbol)||4;for(;r<4;)r*=2;const s=r/2;return{type:"CIMVectorMarker",frame:{xmin:-s,xmax:s,ymin:-i,ymax:i},markerGraphics:[{type:"CIMMarkerGraphic",geometry:{paths:[[[-s,0],[s,0]]]},symbol:e.lineSymbol}],size:t}}static _getLineSymbolPeriod(e){if(e){const t=this._getEffectsRepeat(e.effects);if(t)return t;if(e.symbolLayers)for(const t of e.symbolLayers){const e=this._getEffectsRepeat(t.effects);if(e)return e;if(t){const e=this._getPlacementRepeat(t.markerPlacement);if(e)return e}}}return 0}static _getEffectsRepeat(e){if(e)for(const t of e)if(t)switch(t.type){case"CIMGeometricEffectDashes":{const e=t.dashTemplate;if(e&&e.length){let t=0;for(const i of e)t+=i;return 1&e.length&&(t*=2),t}break}case"CIMGeometricEffectWave":return t.period;default:ke.error(`unsupported geometric effect type ${t.type}`)}return 0}static _getPlacementRepeat(e){if(e)switch(e.type){case"CIMMarkerPlacementAlongLineSameSize":case"CIMMarkerPlacementAlongLineRandomSize":case"CIMMarkerPlacementAlongLineVariableSize":{const t=e.placementTemplate;if(t&&t.length){let e=0;for(const i of t)e+=i;return 1&t.length&&(e*=2),e}break}}return 0}static fromCIMInsidePolygon(e){const t=e.markerPlacement,i={type:e.type,...e};let r,s,n,a;return i.markerPlacement=null,i.anchorPoint=null,!0===t.shiftOddRows?(s=t.stepX/2,n=t.stepY,a=2*t.stepY,r=[{x:-s,y:0},{x:s,y:0},{x:0,y:n},{x:0,y:-n}].map((e=>({type:"CIMMarkerGraphic",geometry:e,symbol:{type:"CIMPointSymbol",symbolLayers:[i]}})))):(s=t.stepX/2,n=t.stepY/2,a=t.stepY,r=[{type:"CIMMarkerGraphic",geometry:{x:0,y:0},symbol:{type:"CIMPointSymbol",symbolLayers:[i]}}]),{type:"CIMVectorMarker",frame:{xmin:-s,xmax:s,ymin:-n,ymax:n},markerGraphics:r,size:a}}static getFillColor(e){if(!e)return null;switch(e.type){case"CIMPolygonSymbol":if(e.symbolLayers)for(const t of e.symbolLayers){const e=Ue.getFillColor(t);if(null!=e)return e}break;case"CIMTextSymbol":return Ue.getFillColor(e.symbol);case"CIMSolidFill":return e.color}}static getStrokeColor(e){if(e)switch(e.type){case"CIMPolygonSymbol":case"CIMLineSymbol":if(e.symbolLayers)for(const t of e.symbolLayers){const e=Ue.getStrokeColor(t);if(void 0!==e)return e}break;case"CIMTextSymbol":return Ue.getStrokeColor(e.symbol);case"CIMSolidStroke":return e.color}}static getStrokeWidth(e){if(e)switch(e.type){case"CIMPolygonSymbol":case"CIMLineSymbol":if(e.symbolLayers)for(const t of e.symbolLayers){const e=Ue.getStrokeWidth(t);if(void 0!==e)return e}break;case"CIMTextSymbol":return Ue.getStrokeWidth(e.symbol);case"CIMSolidStroke":case"CIMGradientStroke":case"CIMPictureStroke":return e.width}}static getSize(e){if(e)switch(e.type){case"CIMPointSymbol":case"CIMLineSymbol":case"CIMPolygonSymbol":{let t=0;if(e.symbolLayers)for(const i of e.symbolLayers){const e=Ue.getSize(i);e>t&&(t=e)}return t}case"CIMSolidStroke":case"CIMPictureStroke":case"CIMGradientStroke":return e.width;case"CIMCharacterMarker":case"CIMPictureMarker":case"CIMVectorMarker":return e.size}}static getMarkerScaleRatio(e){if(e)switch(e.type){case"CIMVectorMarker":if(!1!==e.scaleSymbolsProportionally&&e.frame){const t=e.frame.ymax-e.frame.ymin;return e.size/t}}return 1}}class Ge{static rasterizeSimpleFill(e,t,i){"solid"!==t&&"none"!==t&&"esriSFSSolid"!==t&&"esriSFSNull"!==t||console.error("Unexpected: style does not require rasterization");const r=(0,n.a7)(Math.ceil(i)),s=this._isHorizontalOrVertical(t)?8*r:16*r,a=2*r;e.width=s,e.height=s;const o=e.getContext("2d");o.strokeStyle="#FFFFFF",o.lineWidth=r,o.beginPath(),"vertical"!==t&&"cross"!==t&&"esriSFSCross"!==t&&"esriSFSVertical"!==t||(o.moveTo(s/2,-a),o.lineTo(s/2,s+a)),"horizontal"!==t&&"cross"!==t&&"esriSFSCross"!==t&&"esriSFSHorizontal"!==t||(o.moveTo(-a,s/2),o.lineTo(s+a,s/2)),"forward-diagonal"!==t&&"diagonal-cross"!==t&&"esriSFSDiagonalCross"!==t&&"esriSFSForwardDiagonal"!==t||(o.moveTo(-a,-a),o.lineTo(s+a,s+a),o.moveTo(s-a,-a),o.lineTo(s+a,a),o.moveTo(-a,s-a),o.lineTo(a,s+a)),"backward-diagonal"!==t&&"diagonal-cross"!==t&&"esriSFSBackwardDiagonal"!==t&&"esriSFSDiagonalCross"!==t||(o.moveTo(s+a,-a),o.lineTo(-a,s+a),o.moveTo(a,-a),o.lineTo(-a,a),o.moveTo(s+a,s-a),o.lineTo(s-a,s+a)),o.stroke();const l=o.getImageData(0,0,e.width,e.height),h=new Uint8Array(l.data);let u;for(let e=0;e<h.length;e+=4)u=h[e+3]/255,h[e]=h[e]*u,h[e+1]=h[e+1]*u,h[e+2]=h[e+2]*u;return[h,e.width,e.height]}static rasterizeSimpleLine(e,t){let i;switch(t){case"butt":i="Butt";break;case"square":i="Square";break;default:i="Round"}const r="Butt"===i;let s;switch(e){case"dash":case"esriSLSDash":s=r?[4,3]:[3,4];break;case"dash-dot":case"esriSLSDashDot":s=r?[4,3,1,3]:[3,4,0,4];break;case"dot":case"esriSLSDot":s=r?[1,3]:[0,4];break;case"long-dash":case"esriSLSLongDash":s=r?[8,3]:[7,4];break;case"long-dash-dot":case"esriSLSLongDashDot":s=r?[8,3,1,3]:[7,4,0,4];break;case"long-dash-dot-dot":case"esriSLSDashDotDot":s=r?[8,3,1,3,1,3]:[7,4,0,4,0,4];break;case"short-dash":case"esriSLSShortDash":s=r?[4,1]:[3,2];break;case"short-dash-dot":case"esriSLSShortDashDot":s=r?[4,1,1,1]:[3,2,0,2];break;case"short-dash-dot-dot":case"esriSLSShortDashDotDot":s=r?[4,1,1,1,1,1]:[3,2,0,2,0,2];break;case"short-dot":case"esriSLSShortDot":s=r?[1,1]:[0,2];break;case"solid":case"esriSLSSolid":case"none":ke.error("Unexpected: style does not require rasterization"),s=[0,0];break;default:ke.error(`Tried to rasterize SLS, but found an unexpected style: ${e}!`),s=[0,0]}return this.rasterizeDash(s,i)}static rasterizeDash(e,t){const i="Butt"===t,r="Square"===t,s=!i&&!r;e.length%2==1&&(e=[...e,...e]);const n=15.5;let a=0;for(const t of e)a+=t;const o=Math.round(a*n),l=new Float32Array(31*o),h=7.75;let u=0,c=0,d=.5,p=!0;for(const t of e){for(u=c,c+=t*n;d<=c;){let e=.5;for(;e<31;){const t=(e-.5)*o+d-.5,a=s?(e-n)*(e-n):Math.abs(e-n);l[t]=p?i?Math.max(Math.max(u+h-d,a),Math.max(d-c+h,a)):a:s?Math.min((d-u)*(d-u)+a,(d-c)*(d-c)+a):r?Math.min(Math.max(d-u,a),Math.max(c-d,a)):Math.min(Math.max(d-u+h,a),Math.max(c+h-d,a)),e++}d++}p=!p}const f=l.length,y=new Uint8Array(4*f);for(let e=0;e<f;++e)Le((s?Math.sqrt(l[e]):l[e])/n,y,4*e);return[y,o,31]}static _isHorizontalOrVertical(e){return"vertical"===e||"horizontal"===e||"cross"===e||"esriSFSCross"===e||"esriSFSVertical"===e||"esriSFSHorizontal"===e}}class ze{static findApplicableOverrides(e,t,i){if(t){if(e.primitiveName){let r=!1;for(const t of i)if(t.primitiveName===e.primitiveName){r=!0;break}if(!r)for(const r of t)r.primitiveName===e.primitiveName&&i.push(r)}switch(e.type){case"CIMPointSymbol":case"CIMLineSymbol":case"CIMPolygonSymbol":if(e.effects)for(const r of e.effects)ze.findApplicableOverrides(r,t,i);if(e.symbolLayers)for(const r of e.symbolLayers)ze.findApplicableOverrides(r,t,i);break;case"CIMTextSymbol":break;case"CIMSolidStroke":case"CIMPictureStroke":case"CIMGradientStroke":case"CIMSolidFill":case"CIMPictureFill":case"CIMHatchFill":case"CIMGradientFill":case"CIMVectorMarker":case"CIMCharacterMarker":case"CIMPictureMarker":if(e.effects)for(const r of e.effects)ze.findApplicableOverrides(r,t,i);if(e.markerPlacement&&ze.findApplicableOverrides(e.markerPlacement,t,i),"CIMVectorMarker"===e.type){if(e.markerGraphics)for(const r of e.markerGraphics)ze.findApplicableOverrides(r,t,i),ze.findApplicableOverrides(r.symbol,t,i)}else"CIMCharacterMarker"===e.type?ze.findApplicableOverrides(e.symbol,t,i):"CIMHatchFill"===e.type&&ze.findApplicableOverrides(e.lineSymbol,t,i)}}}static applyOverrides(e,t,i,r){if(!t)return;const s=e=>e?e.charAt(0).toLowerCase()+e.substr(1):e;if(e.primitiveName)for(const n of t)if(n.primitiveName===e.primitiveName){const t=s(n.propertyName);if(r&&r.push({cim:e,nocapPropertyName:t,value:e[t]}),n.expression&&(n.value=ze.toValue(n.propertyName,n.expression)),i){let t=!1;for(const r of i)r.primitiveName===e.primitiveName&&(t=!0);t||i.push(n)}e[t]=n.value}switch(e.type){case"CIMPointSymbol":case"CIMLineSymbol":case"CIMPolygonSymbol":if(e.effects)for(const s of e.effects)ze.applyOverrides(s,t,i,r);if(e.symbolLayers)for(const s of e.symbolLayers)ze.applyOverrides(s,t,i,r);break;case"CIMTextSymbol":break;case"CIMSolidStroke":case"CIMSolidFill":case"CIMVectorMarker":if(e.effects)for(const s of e.effects)ze.applyOverrides(s,t,i,r);if("CIMVectorMarker"===e.type&&e.markerGraphics)for(const s of e.markerGraphics)ze.applyOverrides(s,t,i,r),ze.applyOverrides(s.symbol,t,i,r)}}static restoreOverrides(e){for(const t of e)t.cim[t.nocapPropertyName]=t.value}static buildOverrideKey(e){let t="";for(const i of e)void 0!==i.value&&(t+=`${i.primitiveName}${i.propertyName}${JSON.stringify(i.value)}`);return t}static toValue(e,t){if("DashTemplate"===e)return t.split(" ").map((e=>Number(e)));if("Color"===e){const e=new r.o(t).toRgba();return e[3]*=255,e}return t}}},30466:(e,t,i)=>{"use strict";i.d(t,{s:()=>s});var r=i(80219);class s{constructor(e=Number.POSITIVE_INFINITY){this.size=0,this._start=0,this.maxSize=e,this._buffer=isFinite(e)?new Array(e):[]}get entries(){return this._buffer}enqueue(e){if(this.size===this.maxSize){const t=this._buffer[this._start];return this._buffer[this._start]=e,this._start=(this._start+1)%this.maxSize,t}return isFinite(this.maxSize)?this._buffer[(this._start+this.size++)%this.maxSize]=e:this._buffer[this._start+this.size++]=e,null}dequeue(){if(0===this.size)return null;const e=this._buffer[this._start];return this._buffer[this._start]=null,this.size--,this._start=(this._start+1)%this.maxSize,e}peek(){return 0===this.size?null:this._buffer[this._start]}find(e){if(0===this.size)return null;for(const t of this._buffer)if((0,r.r)(t)&&e(t))return t;return null}clear(e){let t=this.dequeue();for(;(0,r.r)(t);)e&&e(t),t=this.dequeue()}}},1045:(e,t,i)=>{"use strict";i.d(t,{r:()=>V,u:()=>P});var r=i(80219),s=i(75200),n=i(17762),a=i(20215),o=i(334),l=i(93242);class h{constructor(e,t,i){this.strength=e,this.radius=t,this.threshold=i,this.type="bloom"}interpolate(e,t,i){this.strength=y(e.strength,t.strength,i),this.radius=y(e.radius,t.radius,i),this.threshold=y(e.threshold,t.threshold,i)}clone(){return new h(this.strength,this.radius,this.threshold)}}class u{constructor(e){this.radius=e,this.type="blur"}interpolate(e,t,i){this.radius=Math.round(y(e.radius,t.radius,i))}clone(){return new u(this.radius)}}class c{constructor(e,t){this.type=e,this.amount=t,"invert"!==this.type&&"grayscale"!==this.type&&"sepia"!==this.type||(this.amount=Math.min(this.amount,1))}get colorMatrix(){return this._colorMatrix||this._updateMatrix(),this._colorMatrix}interpolate(e,t,i){this.amount=y(e.amount,t.amount,i),this._updateMatrix()}clone(){return new c(this.type,this.amount)}_updateMatrix(){const e=this._colorMatrix||(0,o.r)();switch(this.type){case"brightness":this._colorMatrix=((e,t)=>{const i=(0,l.s)(e,t,0,0,0,0,t,0,0,0,0,t,0,0,0,0,1);return(0,l.o)(i,i)})(e,this.amount);break;case"contrast":this._colorMatrix=((e,t)=>{const i=(0,l.s)(e,t,0,0,.5-.5*t,0,t,0,.5-.5*t,0,0,t,.5-.5*t,0,0,0,1);return(0,l.o)(i,i)})(e,this.amount);break;case"grayscale":this._colorMatrix=((e,t)=>{const i=1-this.amount,r=(0,l.s)(e,.2126+.7874*i,.7152-.7152*i,.0722-.0722*i,0,.2126-.2126*i,.7152+.2848*i,.0722-.0722*i,0,.2126-.2126*i,.7152-.7152*i,.0722+.9278*i,0,0,0,0,1);return(0,l.o)(r,r)})(e);break;case"invert":this._colorMatrix=((e,t)=>{const i=1-2*t,r=(0,l.s)(e,i,0,0,t,0,i,0,t,0,0,i,t,0,0,0,1);return(0,l.o)(r,r)})(e,this.amount);break;case"saturate":this._colorMatrix=((e,t)=>{const i=(0,l.s)(e,.213+.787*t,.715-.715*t,.072-.072*t,0,.213-.213*t,.715+.285*t,.072-.072*t,0,.213-.213*t,.715-.715*t,.072+.928*t,0,0,0,0,1);return(0,l.o)(i,i)})(e,this.amount);break;case"sepia":this._colorMatrix=((e,t)=>{const i=1-this.amount,r=(0,l.s)(e,.393+.607*i,.769-.769*i,.189-.189*i,0,.349-.349*i,.686+.314*i,.168-.168*i,0,.272-.272*i,.534-.534*i,.131+.869*i,0,0,0,0,1);return(0,l.o)(r,r)})(e)}}}class d{constructor(e,t,i,r){this.offsetX=e,this.offsetY=t,this.blurRadius=i,this.color=r,this.type="drop-shadow"}interpolate(e,t,i){this.offsetX=y(e.offsetX,t.offsetX,i),this.offsetY=y(e.offsetY,t.offsetY,i),this.blurRadius=y(e.blurRadius,t.blurRadius,i),this.color[0]=Math.round(y(e.color[0],t.color[0],i)),this.color[1]=Math.round(y(e.color[1],t.color[1],i)),this.color[2]=Math.round(y(e.color[2],t.color[2],i)),this.color[3]=y(e.color[3],t.color[3],i)}clone(){return new d(this.offsetX,this.offsetY,this.blurRadius,[...this.color])}}class p{constructor(e){this.angle=e,this.type="hue-rotate"}get colorMatrix(){return this._colorMatrix||this._updateMatrix(),this._colorMatrix}interpolate(e,t,i){this.angle=y(e.angle,t.angle,i),this._updateMatrix()}clone(){return new p(this.angle)}_updateMatrix(){const e=this._colorMatrix||(0,o.r)();this._colorMatrix=((e,t)=>{const i=Math.sin(t*Math.PI/180),r=Math.cos(t*Math.PI/180),s=(0,l.s)(e,.213+.787*r-.213*i,.715-.715*r-.715*i,.072-.072*r+.928*i,0,.213-.213*r+.143*i,.715+.285*r+.14*i,.072-.072*r-.283*i,0,.213-.213*r-.787*i,.715-.715*r+.715*i,.072+.928*r+.072*i,0,0,0,0,1);return(0,l.o)(s,s)})(e,this.angle)}}class f{constructor(e){this.amount=e,this.type="opacity",this.amount=Math.min(this.amount,1)}interpolate(e,t,i){this.amount=y(e.amount,t.amount,i)}clone(){return new f(this.amount)}}function y(e,t,i){return e+(t-e)*i}var m,g,_={exports:{}};function x(e){let t;try{t=e?_.exports.parse(e):[]}catch(t){return{input:e,parsedFunctions:[],effects:[],error:new a.s("effect:invalid-syntax","Invalid effect syntax",{input:e,error:t})}}const i={input:e,parsedFunctions:t,effects:[],error:null};try{for(const e of t)i.effects.push(v(e))}catch(e){i.effects.length=0,i.error=e}return i}function v(e){try{switch(e.name){case"grayscale":case"sepia":case"saturate":case"invert":case"brightness":case"contrast":return function(e){let t=1;return b(e.parameters,1),1===e.parameters.length&&(t=M(e.parameters[0])),new c(e.name,t)}(e);case"opacity":return function(e){let t=1;return b(e.parameters,1),1===e.parameters.length&&(t=M(e.parameters[0])),new f(t)}(e);case"hue-rotate":return function(e){let t=0;return b(e.parameters,1),1===e.parameters.length&&(t=function(e){return function(e){if("quantity"!==e.type||(0!==e.value||null!==e.unit)&&null==I[e.unit])throw new a.s("effect:type-error",`Expected <angle>, Actual: ${w(e)}`,{term:e})}(e),e.value*I[e.unit]||0}(e.parameters[0])),new p(t)}(e);case"blur":return function(e){let t=0;return b(e.parameters,1),1===e.parameters.length&&(t=T(e.parameters[0]),S(t,e.parameters[0])),new u(t)}(e);case"drop-shadow":return function(e){const t=[];let i;for(const r of e.parameters)if("color"===r.type){if(t.length&&Object.freeze(t),i)throw new a.s("effect:type-error","Accepts only one color",{});i=E(r)}else{const e=T(r);if(Object.isFrozen(t))throw new a.s("effect:type-error","<length> parameters not consecutive",{lengths:t});t.push(e),3===t.length&&S(e,r)}if(t.length<2||t.length>3)throw new a.s("effect:type-error",`Expected <length>{2,3}, Actual: <length>{${t.length}}`,{lengths:t});return new d(t[0],t[1],t[2]||0,i||F("black"))}(e);case"bloom":return function(e){let t=1,i=0,r=0;return b(e.parameters,3),e.parameters[0]&&(t=M(e.parameters[0])),e.parameters[1]&&(i=T(e.parameters[1]),S(i,e.parameters[1])),e.parameters[2]&&(r=M(e.parameters[2])),new h(t,i,r)}(e)}}catch(t){throw t.details.filter=e,t}throw new a.s("effect:unknown-effect",`Effect '${e.name}' is not supported`,{effect:e})}function b(e,t){if(e.length>t)throw new a.s("effect:type-error",`Function supports up to ${t} parameters, Actual: ${e.length}`,{parameters:e})}function w(e){return"color"===e.type?"<color>":C[e.unit]?"<length>":I[e.unit]?"<angle>":"%"===e.unit?"<percentage>":"<double>"}function S(e,t){if(e<0)throw new a.s("effect:type-error",`Negative values are not allowed, Actual: ${e}`,{term:t})}g=function(){function e(t,i,r,s){this.message=t,this.expected=i,this.found=r,this.location=s,this.name="SyntaxError","function"==typeof Error.captureStackTrace&&Error.captureStackTrace(this,e)}return function(e,t){function i(){this.constructor=e}i.prototype=t.prototype,e.prototype=new i}(e,Error),e.buildMessage=function(e,t){var i={literal:function(e){return'"'+s(e.text)+'"'},class:function(e){var t,i="";for(t=0;t<e.parts.length;t++)i+=e.parts[t]instanceof Array?n(e.parts[t][0])+"-"+n(e.parts[t][1]):n(e.parts[t]);return"["+(e.inverted?"^":"")+i+"]"},any:function(e){return"any character"},end:function(e){return"end of input"},other:function(e){return e.description}};function r(e){return e.charCodeAt(0).toString(16).toUpperCase()}function s(e){return e.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,(function(e){return"\\x0"+r(e)})).replace(/[\x10-\x1F\x7F-\x9F]/g,(function(e){return"\\x"+r(e)}))}function n(e){return e.replace(/\\/g,"\\\\").replace(/\]/g,"\\]").replace(/\^/g,"\\^").replace(/-/g,"\\-").replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,(function(e){return"\\x0"+r(e)})).replace(/[\x10-\x1F\x7F-\x9F]/g,(function(e){return"\\x"+r(e)}))}function a(e){return i[e.type](e)}return"Expected "+function(e){var t,i,r=new Array(e.length);for(t=0;t<e.length;t++)r[t]=a(e[t]);if(r.sort(),r.length>0){for(t=1,i=1;t<r.length;t++)r[t-1]!==r[t]&&(r[i]=r[t],i++);r.length=i}switch(r.length){case 1:return r[0];case 2:return r[0]+" or "+r[1];default:return r.slice(0,-1).join(", ")+", or "+r[r.length-1]}}(e)+" but "+function(e){return e?'"'+s(e)+'"':"end of input"}(t)+" found."},{SyntaxError:e,parse:function(t,i){i=void 0!==i?i:{};var r,s={},n={start:ae},a=ae,o=ie("none"),l="none",h=ee("none",!1),u=ee(")",!1),c=ee(",",!1),d=ie("whitespace"),p=/^[ \t\n\r]/,f=te([" ","\t","\n","\r"],!1,!1),y=ie("function"),m=ee("(",!1),g=ie("identifier"),_=/^[a-z\-]/,x=te([["a","z"],"-"],!1,!1),v=ie("percentage"),b=ee("%",!1),w=ie("length"),S=ee("px",!1),I=ee("cm",!1),C=ee("mm",!1),M=ee("in",!1),T=ee("pt",!1),E=ee("pc",!1),F=ie("angle"),A=ee("deg",!1),R=ee("rad",!1),P="grad",L=ee("grad",!1),D="turn",N=ee("turn",!1),O=ie("number"),k=ie("color"),V=ee("#",!1),U=/^[0-9a-fA-F]/,G=te([["0","9"],["a","f"],["A","F"]],!1,!1),z=/^[+\-]/,B=te(["+","-"],!1,!1),j=/^[0-9]/,q=te([["0","9"]],!1,!1),H=ee(".",!1),W=ee("e",!1),Q=0,Z=0,Y=[{line:1,column:1}],J=0,X=[],$=0;if("startRule"in i){if(!(i.startRule in n))throw new Error("Can't start parsing from rule \""+i.startRule+'".');a=n[i.startRule]}function K(){return t.substring(Z,Q)}function ee(e,t){return{type:"literal",text:e,ignoreCase:t}}function te(e,t,i){return{type:"class",parts:e,inverted:t,ignoreCase:i}}function ie(e){return{type:"other",description:e}}function re(e){var i,r=Y[e];if(r)return r;for(i=e-1;!Y[i];)i--;for(r={line:(r=Y[i]).line,column:r.column};i<e;)10===t.charCodeAt(i)?(r.line++,r.column=1):r.column++,i++;return Y[e]=r,r}function se(e,t){var i=re(e),r=re(t);return{start:{offset:e,line:i.line,column:i.column},end:{offset:t,line:r.line,column:r.column}}}function ne(e){Q<J||(Q>J&&(J=Q,X=[]),X.push(e))}function ae(){var e;return(e=oe())===s&&(e=function(){var e,t;if(e=[],(t=le())!==s)for(;t!==s;)e.push(t),t=le();else e=s;return e}()),e}function oe(){var e,i;return $++,e=Q,ue()!==s?(t.substr(Q,4)===l?(i=l,Q+=4):(i=s,0===$&&ne(h)),i!==s&&ue()!==s?(Z=e,e=[]):(Q=e,e=s)):(Q=e,e=s),$--,e===s&&0===$&&ne(o),e}function le(){var e,i,r,n;return e=Q,ue()!==s&&(i=function(){var e,i,r;return $++,e=Q,(i=ce())!==s?(40===t.charCodeAt(Q)?(r="(",Q++):(r=s,0===$&&ne(m)),r!==s?(Z=e,e=i=i):(Q=e,e=s)):(Q=e,e=s),$--,e===s&&(i=s,0===$&&ne(y)),e}())!==s&&ue()!==s?((r=function(){var e,i,r,n,a,o,l,h;if(e=Q,(i=he())!==s){for(r=[],n=Q,(a=ue())!==s?(44===t.charCodeAt(Q)?(o=",",Q++):(o=s,0===$&&ne(c)),o===s&&(o=null),o!==s&&(l=ue())!==s&&(h=he())!==s?n=a=[a,o,l,h]:(Q=n,n=s)):(Q=n,n=s);n!==s;)r.push(n),n=Q,(a=ue())!==s?(44===t.charCodeAt(Q)?(o=",",Q++):(o=s,0===$&&ne(c)),o===s&&(o=null),o!==s&&(l=ue())!==s&&(h=he())!==s?n=a=[a,o,l,h]:(Q=n,n=s)):(Q=n,n=s);r!==s?(Z=e,e=i=function(e,t){return t.length>0?function(e,t,i){return[e].concat(function(e,t){return e.map((function(e){return e[3]}))}(t))}(e,t):[e]}(i,r)):(Q=e,e=s)}else Q=e,e=s;return e}())===s&&(r=null),r!==s&&ue()!==s?(41===t.charCodeAt(Q)?(n=")",Q++):(n=s,0===$&&ne(u)),n!==s&&ue()!==s?(Z=e,e=function(e,t){return{type:"function",name:e,parameters:t||[]}}(i,r)):(Q=e,e=s)):(Q=e,e=s)):(Q=e,e=s),e}function he(){var e,t;return e=Q,(t=de())===s&&(t=pe())===s&&(t=fe())===s&&(t=function(){var e,t;return $++,e=Q,ue()!==s&&(t=me())!==s?(Z=e,e=function(e){return{value:e,unit:null}}(t)):(Q=e,e=s),$--,e===s&&0===$&&ne(O),e}()),t!==s&&(Z=e,t=function(e){return{type:"quantity",value:e.value,unit:e.unit}}(t)),(e=t)===s&&(e=Q,(t=ye())!==s&&(Z=e,t=function(e){return{type:"color",colorType:e.type,value:e.value}}(t)),e=t),e}function ue(){var e,i;for($++,e=[],p.test(t.charAt(Q))?(i=t.charAt(Q),Q++):(i=s,0===$&&ne(f));i!==s;)e.push(i),p.test(t.charAt(Q))?(i=t.charAt(Q),Q++):(i=s,0===$&&ne(f));return $--,e===s&&(i=s,0===$&&ne(d)),e}function ce(){var e,i,r;if($++,e=Q,i=[],_.test(t.charAt(Q))?(r=t.charAt(Q),Q++):(r=s,0===$&&ne(x)),r!==s)for(;r!==s;)i.push(r),_.test(t.charAt(Q))?(r=t.charAt(Q),Q++):(r=s,0===$&&ne(x));else i=s;return i!==s&&(Z=e,i=K()),$--,(e=i)===s&&(i=s,0===$&&ne(g)),e}function de(){var e,i,r;return $++,e=Q,ue()!==s&&(i=me())!==s?(37===t.charCodeAt(Q)?(r="%",Q++):(r=s,0===$&&ne(b)),r!==s?(Z=e,e=function(e){return{value:e,unit:"%"}}(i)):(Q=e,e=s)):(Q=e,e=s),$--,e===s&&0===$&&ne(v),e}function pe(){var e,i,r;return $++,e=Q,ue()!==s&&(i=me())!==s?("px"===t.substr(Q,2)?(r="px",Q+=2):(r=s,0===$&&ne(S)),r!==s?(Z=e,e=function(e){return{value:e,unit:"px"}}(i)):(Q=e,e=s)):(Q=e,e=s),e===s&&(e=Q,ue()!==s&&(i=me())!==s?("cm"===t.substr(Q,2)?(r="cm",Q+=2):(r=s,0===$&&ne(I)),r!==s?(Z=e,e=function(e){return{value:e,unit:"cm"}}(i)):(Q=e,e=s)):(Q=e,e=s),e===s&&(e=Q,ue()!==s&&(i=me())!==s?("mm"===t.substr(Q,2)?(r="mm",Q+=2):(r=s,0===$&&ne(C)),r!==s?(Z=e,e=function(e){return{value:e,unit:"mm"}}(i)):(Q=e,e=s)):(Q=e,e=s),e===s&&(e=Q,ue()!==s&&(i=me())!==s?("in"===t.substr(Q,2)?(r="in",Q+=2):(r=s,0===$&&ne(M)),r!==s?(Z=e,e=function(e){return{value:e,unit:"in"}}(i)):(Q=e,e=s)):(Q=e,e=s),e===s&&(e=Q,ue()!==s&&(i=me())!==s?("pt"===t.substr(Q,2)?(r="pt",Q+=2):(r=s,0===$&&ne(T)),r!==s?(Z=e,e=function(e){return{value:e,unit:"pt"}}(i)):(Q=e,e=s)):(Q=e,e=s),e===s&&(e=Q,ue()!==s&&(i=me())!==s?("pc"===t.substr(Q,2)?(r="pc",Q+=2):(r=s,0===$&&ne(E)),r!==s?(Z=e,e=function(e){return{value:e,unit:"pc"}}(i)):(Q=e,e=s)):(Q=e,e=s)))))),$--,e===s&&0===$&&ne(w),e}function fe(){var e,i,r;return $++,e=Q,(i=me())!==s?("deg"===t.substr(Q,3)?(r="deg",Q+=3):(r=s,0===$&&ne(A)),r!==s?(Z=e,e=i=function(e){return{value:e,unit:"deg"}}(i)):(Q=e,e=s)):(Q=e,e=s),e===s&&(e=Q,(i=me())!==s?("rad"===t.substr(Q,3)?(r="rad",Q+=3):(r=s,0===$&&ne(R)),r!==s?(Z=e,e=i=function(e){return{value:e,unit:"rad"}}(i)):(Q=e,e=s)):(Q=e,e=s),e===s&&(e=Q,(i=me())!==s?(t.substr(Q,4)===P?(r=P,Q+=4):(r=s,0===$&&ne(L)),r!==s?(Z=e,e=i=function(e){return{value:e,unit:"grad"}}(i)):(Q=e,e=s)):(Q=e,e=s),e===s&&(e=Q,(i=me())!==s?(t.substr(Q,4)===D?(r=D,Q+=4):(r=s,0===$&&ne(N)),r!==s?(Z=e,e=i=function(e){return{value:e,unit:"turn"}}(i)):(Q=e,e=s)):(Q=e,e=s)))),$--,e===s&&(i=s,0===$&&ne(F)),e}function ye(){var e,i,r,n;if($++,e=Q,35===t.charCodeAt(Q)?(i="#",Q++):(i=s,0===$&&ne(V)),i!==s){if(r=[],U.test(t.charAt(Q))?(n=t.charAt(Q),Q++):(n=s,0===$&&ne(G)),n!==s)for(;n!==s;)r.push(n),U.test(t.charAt(Q))?(n=t.charAt(Q),Q++):(n=s,0===$&&ne(G));else r=s;r!==s?(Z=e,e=i={type:"hex",value:K()}):(Q=e,e=s)}else Q=e,e=s;return e===s&&(e=Q,(i=le())!==s&&(Z=e,i=function(e){return{type:"function",value:e}}(i)),(e=i)===s&&(e=Q,(i=ce())!==s&&(Z=e,i={type:"named",value:K()}),e=i)),$--,e===s&&(i=s,0===$&&ne(k)),e}function me(){var e,i,r,n,a,o,l,h;if(e=Q,z.test(t.charAt(Q))?(i=t.charAt(Q),Q++):(i=s,0===$&&ne(B)),i===s&&(i=null),i!==s){for(r=Q,n=[],j.test(t.charAt(Q))?(a=t.charAt(Q),Q++):(a=s,0===$&&ne(q));a!==s;)n.push(a),j.test(t.charAt(Q))?(a=t.charAt(Q),Q++):(a=s,0===$&&ne(q));if(n!==s)if(46===t.charCodeAt(Q)?(a=".",Q++):(a=s,0===$&&ne(H)),a!==s){if(o=[],j.test(t.charAt(Q))?(l=t.charAt(Q),Q++):(l=s,0===$&&ne(q)),l!==s)for(;l!==s;)o.push(l),j.test(t.charAt(Q))?(l=t.charAt(Q),Q++):(l=s,0===$&&ne(q));else o=s;o!==s?r=n=[n,a,o]:(Q=r,r=s)}else Q=r,r=s;else Q=r,r=s;if(r===s)if(r=[],j.test(t.charAt(Q))?(n=t.charAt(Q),Q++):(n=s,0===$&&ne(q)),n!==s)for(;n!==s;)r.push(n),j.test(t.charAt(Q))?(n=t.charAt(Q),Q++):(n=s,0===$&&ne(q));else r=s;if(r!==s){if(n=Q,101===t.charCodeAt(Q)?(a="e",Q++):(a=s,0===$&&ne(W)),a!==s)if(z.test(t.charAt(Q))?(o=t.charAt(Q),Q++):(o=s,0===$&&ne(B)),o===s&&(o=null),o!==s){if(l=[],j.test(t.charAt(Q))?(h=t.charAt(Q),Q++):(h=s,0===$&&ne(q)),h!==s)for(;h!==s;)l.push(h),j.test(t.charAt(Q))?(h=t.charAt(Q),Q++):(h=s,0===$&&ne(q));else l=s;l!==s?n=a=[a,o,l]:(Q=n,n=s)}else Q=n,n=s;else Q=n,n=s;n===s&&(n=null),n!==s?(Z=e,e=i=parseFloat(K())):(Q=e,e=s)}else Q=e,e=s}else Q=e,e=s;return e}if((r=a())!==s&&Q===t.length)return r;throw r!==s&&Q<t.length&&ne({type:"end"}),function(t,i,r){return new e(e.buildMessage(t,i),t,i,r)}(X,J<t.length?t.charAt(J):null,J<t.length?se(J,J+1):se(J,J))}}},(m=_).exports&&(m.exports=g());const I={deg:1,grad:.9,rad:180/Math.PI,turn:360},C={px:1,cm:96/2.54,mm:96/2.54/10,in:96,pc:16,pt:96/73};function M(e){!function(e){if("quantity"!==e.type||null!==e.unit&&"%"!==e.unit)throw new a.s("effect:type-error",`Expected <double> or <percentage>, Actual: ${w(e)}`,{term:e})}(e);const t=e.value;return S(t,e),"%"===e.unit?.01*t:t}function T(e){return function(e){if("quantity"!==e.type||(0!==e.value||null!==e.unit)&&null==C[e.unit])throw new a.s("effect:type-error",`Expected <length>, Actual: ${w(e)}`,{term:e})}(e),e.value*C[e.unit]||0}function E(e){switch(e.colorType){case"hex":return(0,n.i)(e.value);case"named":return F(e.value);case"function":return function(e){if(b(e.parameters,4),A.test(e.name))return[M(e.parameters[0]),M(e.parameters[1]),M(e.parameters[2]),e.parameters[3]?M(e.parameters[3]):1];if(R.test(e.name))return(0,n.n)(function(e){return function(e){if("quantity"!==e.type||null!==e.unit)throw new a.s("effect:type-error",`Expected <double>, Actual: ${w(e)}`,{term:e})}(e),S(e.value,e),e.value}(e.parameters[0]),M(e.parameters[1]),M(e.parameters[2]),e.parameters[3]?M(e.parameters[3]):1);throw new a.s("effect:syntax-error",`Invalid color function '${e.name}'`,{colorFunction:e})}(e.value)}}function F(e){const t=(0,n.l)(e);if(!t)throw new a.s("effect:unknown-color",`color '${e}' isn't valid`,{namedColor:e});return t}const A=/^rgba?/i,R=/^hsla?/i;class P{constructor(e=200){this.duration=e,this._from=null,this._to=null,this._final=null,this._current=[],this._time=0,this._effect="",this._effects=[],this._scale=0}get effect(){return this._effect}set effect(e){if(e=e||"",this._effect===e)return;this._effect=e;const t=function(e){if(!e)return[];if("string"==typeof e){const t=x(e);return t.error?t.error:[{scale:-1,effects:t.effects}]}const t=[];for(const i of e){if(!isFinite(i.scale)||i.scale<=0)return new a.s("effect:invalid-scale","scale must be finite and greater than 0",{stop:i});const e=x(i.value);if(e.error)return e.error;t.push({scale:i.scale,effects:e.effects})}t.sort(((e,t)=>t.effects.length-e.effects.length));for(let e=0;e<t.length-1;e++){if(!D(t[e].effects,t[e+1].effects))return new a.s("effect:interpolation-impossible","Cannot interpolate by scale between 2 lists of mixed effects",{a:t[e].effects,b:t[e+1].effects});N(t[e].effects,t[e+1].effects)}return t.sort(((e,t)=>t.scale-e.scale)),t}(e);Array.isArray(t)?this._transitionTo(t):(this._transitionTo([]),r.n.getLogger("esri.views.layers.effects.EffectList").warn("Invalid Effect",{effect:e,error:t}))}get hasEffects(){return this.transitioning||!!this._effects.length}get effects(){return this._effects}get scale(){return this._scale}get transitioning(){return null!==this._to}transitionStep(e,t){this._applyTimeTransition(e),this._updateForScale(t)}_transitionTo(e){this.scale>0&&function(e,t,i){var r,s,n,a;return null==(r=e[0])||!r.effects||null==(s=t[0])||!s.effects||!((-1===(null==(n=e[0])?void 0:n.scale)||-1===(null==(a=t[0])?void 0:a.scale))&&(e.length>1||t.length>1)&&i<=0)&&D(e[0].effects,t[0].effects)}(this._current,e,this.scale)?(this._final=e,this._to=(0,r.y)(e),function(e,t,i){var r,s;const n=e.length>t.length?e:t,a=e.length>t.length?t:e,o=a[a.length-1],l=null!=(r=null==o?void 0:o.scale)?r:i,h=null!=(s=null==o?void 0:o.effects)?s:[];for(let e=a.length;e<n.length;e++)a.push({scale:l,effects:[...h]});for(let e=0;e<n.length;e++)a[e].scale=-1===a[e].scale?i:a[e].scale,n[e].scale=-1===n[e].scale?i:n[e].scale,N(a[e].effects,n[e].effects)}(this._current,this._to,this.scale),this._from=(0,r.y)(this._current),this._time=0):(this._from=this._to=this._final=null,this._current=e),this._effects=this._current[0]?(0,r.y)(this._current[0].effects):[]}_applyTimeTransition(e){if(!this._to)return;this._time+=e;const t=Math.min(1,this._time/this.duration);for(let e=0;e<this._current.length;e++){const i=this._current[e],r=this._from[e],s=this._to[e];i.scale=O(r.scale,s.scale,t);for(let e=0;e<i.effects.length;e++){const n=i.effects[e],a=r.effects[e],o=s.effects[e];n.interpolate(a,o,t)}}1===t&&(this._current=this._final,this._effects=this._current[0]?(0,r.y)(this._current[0].effects):[],this._from=this._to=this._final=null)}_updateForScale(e){if(0===this._current.length)return;this._scale=e;const t=this._current,i=this._current.length-1;let r,s,n=1;if(1===t.length||e>=t[0].scale)s=r=t[0].effects;else if(e<=t[i].scale)s=r=t[i].effects;else for(let a=0;a<i;a++){const i=t[a],o=t[a+1];if(i.scale>=e&&o.scale<=e){n=(e-i.scale)/(o.scale-i.scale),r=i.effects,s=o.effects;break}}for(let e=0;e<this._effects.length;e++)this._effects[e].interpolate(r[e],s[e],n)}}function L(e){switch(e.type){case"grayscale":case"sepia":case"invert":return new c(e.type,0);case"saturate":case"brightness":case"contrast":return new c(e.type,1);case"opacity":return new f(1);case"hue-rotate":return new p(0);case"blur":return new u(0);case"drop-shadow":return new d(0,0,0,[...(0,n.r)("transparent")]);case"bloom":return new h(0,0,0)}}function D(e,t){const i=e.length>t.length?e:t;return(e.length>t.length?t:e).every(((e,t)=>e.type===i[t].type))}function N(e,t){const i=e.length>t.length?e:t,r=e.length>t.length?t:e;for(let e=r.length;e<i.length;e++)r.push(L(i[e]))}function O(e,t,i){return e+(t-e)*i}const k=(0,r.c)("mapview-transitions-duration");class V extends s.a{constructor(){super(...arguments),this._childrenSet=new Set,this.children=[],this._effectList=null}get blendMode(){return this._blendMode}set blendMode(e){this._blendMode=e,this.requestRender()}get clips(){return this._clips}set clips(e){this._clips=e,this.children.forEach((t=>t.clips=e))}get computedEffects(){var e,t;return null!=(e=null==(t=this._effectList)?void 0:t.effects)?e:null}get effect(){var e,t;return null!=(e=null==(t=this._effectList)?void 0:t.effect)?e:""}set effect(e){(this._effectList||e)&&(this._effectList||(this._effectList=new P(k)),this._effectList.effect=e,this.requestRender())}updateTransitionProperties(e,t){super.updateTransitionProperties(e,t),this._effectList&&(this._effectList.transitionStep(e,t),this._effectList.transitioning&&this.requestRender())}doRender(e){const t=this.createRenderParams(e);this.renderChildren(t)}addChild(e){return this.addChildAt(e,this.children.length)}addChildAt(e,t=this.children.length){if(!e)return e;if(this.contains(e))return e;const i=e.parent;return i&&i!==this&&i.removeChild(e),t>=this.children.length?this.children.push(e):this.children.splice(t,0,e),this._childrenSet.add(e),e.parent=this,e.stage=this.stage,this!==this.stage&&(e.clips=this.clips),this.requestRender(),e}contains(e){return this._childrenSet.has(e)}removeAllChildren(){this._childrenSet.clear();for(const e of this.children)this!==this.stage&&(e.clips=null),e.stage=null,e.parent=null;this.children.length=0}removeChild(e){return this.contains(e)?this.removeChildAt(this.children.indexOf(e)):e}removeChildAt(e){if(e<0||e>=this.children.length)return null;const t=this.children.splice(e,1)[0];return this._childrenSet.delete(t),this!==this.stage&&(t.clips=null),t.stage=null,t.parent=null,t}sortChildren(e){return this.children.sort(e)}onAttach(){super.onAttach();const e=this.stage;for(const t of this.children)t.stage=e}onDetach(){super.onDetach();for(const e of this.children)e.stage=null}renderChildren(e){for(const t of this.children)t.beforeRender(e);for(const t of this.children)t.processRender(e);for(const t of this.children)t.afterRender(e)}createRenderParams(e){return{...e,blendMode:this.blendMode,effects:this.computedEffects,globalOpacity:e.globalOpacity*this.computedOpacity,inFadeTransition:this.inFadeTransition}}}},86125:(e,t,i)=>{"use strict";i.d(t,{p:()=>h});var r=i(78155),s=i(80219),n=i(88903),a=i(54622),o=i(47122);const l=s.n.getLogger("esri.views.3d.layers.support.DefinitionExpressionSceneLayerView"),h=e=>{let t=class extends e{constructor(){super(...arguments),this._definitionExpressionErrors=0,this._maxDefinitionExpressionErrors=20,this.logError=e=>{this._definitionExpressionErrors<this._maxDefinitionExpressionErrors&&l.error("Error while evaluating definitionExpression: "+e),this._definitionExpressionErrors++,this._definitionExpressionErrors===this._maxDefinitionExpressionErrors&&l.error("Further errors are ignored")}}get parsedDefinitionExpression(){if(!this.i3slayer||!this.i3slayer.definitionExpression)return null;try{const e=a.WhereClause.create(this.i3slayer.definitionExpression,this.i3slayer.fieldsIndex);if(!e.isStandardized)return l.error("definitionExpression is using non standard function"),null;const t=[],i=e.fieldNames;return(0,o.o)(i,this.i3slayer.fields,{missingFields:t}),t.length>0?(l.error(`definitionExpression references unknown fields: ${t.join(", ")}`),null):(this._definitionExpressionErrors=0,e)}catch(e){return l.error("Failed to parse definitionExpression: "+e),null}}get definitionExpressionFields(){return this.parsedDefinitionExpression?this.parsedDefinitionExpression.fieldNames:null}_evaluateClause(e,t){try{return e.testFeature(t)}catch(e){return this.logError(e),!1}}_addDefinitionExpressionToQuery(e){if(!this.parsedDefinitionExpression)return e;const t=this.i3slayer.definitionExpression,i=e.clone();return i.where?i.where=`(${t}) AND (${i.where})`:i.where=t,i}};return(0,r.e)([(0,n.y)()],t.prototype,"i3slayer",void 0),(0,r.e)([(0,n.y)({readOnly:!0})],t.prototype,"parsedDefinitionExpression",null),(0,r.e)([(0,n.y)({readOnly:!0})],t.prototype,"definitionExpressionFields",null),t=(0,r.e)([(0,n.n)("esri.views.3d.layers.support.DefinitionExpressionSceneLayerView")],t),t}},82750:(e,t,i)=>{"use strict";i.d(t,{V:()=>C}),i(33807);var r=i(78155),s=i(9612),n=i(80219),a=i(20215),o=i(36845),l=i(88903),h=i(98548),u=i(58404),c=i(32422),d=i(72105),p=i(74589),f=i(21142),y=i(50822),m=i(71391);function g(e){return c.q.createSquareGeometry([[e[0],e[1],-1],[e[2],e[1],-1],[e[2],e[3],-1],[e[0],e[3],-1]])}const _=[0,0,1];class x extends d.a6{constructor(e){super(e,b),this.supportsEdges=!0,this.techniqueConfig=new f.O}getTechniqueConfig(e,t){return this.techniqueConfig.output=e,this.techniqueConfig.cullFace=this.params.cullFace,this.techniqueConfig.slicePlaneEnabled=this.params.slicePlaneEnabled,this.techniqueConfig.transparent=this.params.transparent,this.techniqueConfig.writeDepth=this.params.writeDepth,this.techniqueConfig.sceneHasOcludees=this.params.sceneHasOcludees,this.techniqueConfig.transparencyPassType=t?t.transparencyPassType:3,this.techniqueConfig.enableOffset=!t||t.camera.relativeElevation<d.b8,this.techniqueConfig.multipassTerrainEnabled=!!t&&t.multipassTerrainEnabled,this.techniqueConfig.cullAboveGround=!!t&&t.cullAboveGround,this.techniqueConfig}intersect(e,t,i,r,s,n,a){(0,d.b9)(e,t,r,s,n,void 0,a)}getGLMaterial(e){return 0===e.output||7===e.output||4===e.output?new v(e):void 0}createBufferWriter(){return new c.s(c.t)}}class v extends d.ag{constructor(e){super({...e,...e.material.params}),this.updateParameters()}updateParameters(e){const t=this._material.params;this.updateTexture(t.textureId),this._technique=this._techniqueRep.releaseAndAcquire(f.E,this._material.getTechniqueConfig(this._output,e),this._technique)}beginSlot(e){return 4===this._output?3===e:e===(this._technique.configuration.transparent?this._technique.configuration.writeDepth?5:8:3)}_updateOccludeeState(e){e.hasOccludees!==this._material.params.sceneHasOcludees&&(this._material.setParameterValues({sceneHasOcludees:e.hasOccludees}),this.updateParameters(e))}ensureParameters(e){0!==this._output&&7!==this._output||this._updateOccludeeState(e),this.updateParameters(e)}bind(e){this.bindTextures(this._technique.program),this.bindTextureScale(this._technique.program),this._technique.bindPass(this._material.params,e)}getPipelineState(e,t){return this._technique.getPipelineState(t)}}const b={transparent:!1,writeDepth:!0,slicePlaneEnabled:!1,cullFace:0,sceneHasOcludees:!1,opacity:1,textureId:null,initTextureTransparent:!0,...d.ab},w=n.n.getLogger("esri.views.3d.layers.DynamicLayerView3D");let S=class extends((0,m.aa)((0,c.m)(y.d))){constructor(){super(...arguments),this.drapeSourceType=0,this.updatePolicy=1,this.fullExtentInLocalViewSpatialReference=null,this.maximumDataResolution=null,this._images=new Array,this._extents=new Array,this._overlayExtents=new Array,this.updateWhenStationary=!0}initialize(){this.addResolvingPromise((0,p.t)(this).then((e=>this._set("fullExtentInLocalViewSpatialReference",e)))),this.updatingHandles.add(this,"suspended",(()=>this._suspendedChangeHandler())),this.handles.add(this.view.resourceController.scheduler.registerIdleStateCallbacks((()=>{this._isScaleRangeActive()&&this.notifyChange("suspended")}),(()=>{}))),this._isScaleRangeLayer()&&this.updatingHandles.add(this.layer,"scaleRangeId",(()=>this.notifyChange("suspended"))),"local"===this.view.viewingMode&&this.updatingHandles.add(this.view.basemapTerrain,"extent",(()=>this._overlayExtents.forEach(((e,t)=>this._updateImageExtent(t)))))}destroy(){this.clear()}setDrapingExtent(e,t){this._overlayExtents[e.index]={extent:(0,u.i)(e.extent),spatialReference:t,resolution:e.resolution,renderLocalOrigin:e.renderLocalOrigin,pixelRatio:e.pixelRatio},this._updateImageExtent(e.index)}_updateImageExtent(e){const t=this._overlayExtents[e],i=this._clippedExtent(t.extent,I),r=function(e,t,i){const r=(0,u.x)(e)/(0,u.M)(e),s={width:i,height:i};return r>1.0001?s.height=i/r:r<.9999&&(s.width=i*r),s.width=Math.round(s.width/((0,u.x)(e)/(0,u.x)(t))),s.height=Math.round(s.height/((0,u.M)(e)/(0,u.M)(t))),s}(t.extent,i,t.resolution);let s=t.pixelRatio*this.view.pixelRatio;if("imageMaxWidth"in this.layer||"imageMaxHeight"in this.layer){const e=this.layer.imageMaxWidth,t=this.layer.imageMaxHeight;if(r.width>e){const t=e/r.width;r.height=Math.floor(r.height*t),r.width=e,s*=t}if(r.height>t){const e=t/r.height;r.width=Math.floor(r.width*e),r.height=t,s*=e}}const n=this._extents[e];n&&(0,u.G)(n.extent,i)&&!this._imageSizeDiffers(i,n.imageSize,r)||(this._extents[e]={extent:(0,u.i)(i),spatialReference:t.spatialReference,imageSize:r,pixelRatio:s},this.suspended||this._fetch(e).catch((e=>{(0,a.g)(e)||w.error(e)})))}clear(){for(let e=0;e<this._images.length;e++)this._clearImage(e)}async doRefresh(e){if(this.suspended)return;const t=[];for(let i=0;i<this._extents.length;i++)this._extents[i]&&t.push(this._fetch(i,e));await(0,a.A)(t)}canResume(){if(!super.canResume())return!1;if(this._isScaleRangeLayer()){const{minScale:e,maxScale:t}=this.layer;if(e>0||t>0){const i=this.view.scale;if(i<t||e>0&&i>e)return!1}}return!0}isUpdating(){return this._images.some((e=>!!e.loadingPromise))}async processResult(e,t,i){(t instanceof HTMLImageElement||t instanceof HTMLCanvasElement)&&(e.image=t)}findExtentInfoAt(e){for(const t of this._extents){const i=t.extent;if(new h.M(i[0],i[1],i[2],i[3],t.spatialReference).contains(e))return t}return null}getFetchOptions(){}async redraw(e,t){await(0,s.n)(this._images,(async(i,r)=>{i&&(await e(i,t),await this._createStageObjects(r,i.image))}))}_imageSizeDiffers(e,t,i){if(!this.maximumDataResolution||c.T.TESTS_DISABLE_UPDATE_THRESHOLDS)return!0;const r=(0,u.x)(e)/this.maximumDataResolution.x,s=(0,u.M)(e)/this.maximumDataResolution.y,n=r/t.width,a=s/t.height,o=r/i.width,l=s/i.height,h=Math.abs(n-o),d=Math.abs(a-l);return h>1.5||d>1.5}async _fetch(e,t){if(this.suspended)return;const i=this._extents[e],r=i.extent;this._images[e]||(this._images[e]={texture:null,material:null,renderGeometry:null,loadingPromise:null,loadingAbortController:null,image:null,pixelData:null,renderExtent:(0,u.i)(r)});const s=this._images[e];s.loadingAbortController&&(s.loadingAbortController.abort(),s.loadingAbortController=null);const n=new h.M(r[0],r[1],r[2],r[3],i.spatialReference);if(0===n.width||0===n.height)return void this._clearImage(e);const o=(0,a.h)();s.loadingAbortController=o,(0,a.v)(t,(()=>o.abort()));const l=o.signal,c=this._waitFetchReady(l).then((()=>{const t={requestAsImageElement:!0,pixelRatio:this._overlayExtents[e].pixelRatio,...this.getFetchOptions(),signal:l},{height:r,width:s}=i.imageSize;return t.timestamp=this.refreshTimestamp,this.layer.fetchImage(n,s,r,t)})).then((e=>{if((0,a.b)(l))throw w.warnOnce("A call to fetchImage resolved even though the request was aborted. fetchImage should not resolve if options.signal.aborted is true."),(0,a.m)();return this.processResult(s,e)})).then((()=>(0,u.A)(s.renderExtent,r)));s.loadingPromise=c,(0,a.F)(c,(()=>{c===s.loadingPromise&&(s.loadingPromise=null,s.loadingAbortController=null)}));const d=c.then((async()=>{await this._createStageObjects(e,s.image),this.notifyChange("updating")})).catch((e=>{throw e&&!(0,a.g)(e)&&w.error(e),this.notifyChange("updating"),e}));this.notifyChange("updating"),await d}_clearImage(e){const t=this._images[e];if(t){(0,n.r)(t.renderGeometry)&&(this.view.basemapTerrain.overlayManager.renderer.removeGeometries([t.renderGeometry],this,2),t.renderGeometry=null);const e=this.view._stage;e.remove(t.texture),t.texture=null,e.remove(t.material),t.material=null,t.loadingAbortController&&(t.loadingAbortController.abort(),t.loadingAbortController=null),t.loadingPromise=null,t.image=null,t.pixelData=null}}async _createStageObjects(e,t){const i=this.view._stage,r=this._images[e],a=this.view.basemapTerrain.overlayManager.renderer,o=()=>{i.remove(r.texture),r.texture=null,(0,n.r)(r.renderGeometry)&&(a.removeGeometries([r.renderGeometry],this,2),r.renderGeometry=null)};if(t){const l=new d.aT(t,{width:t.width,height:t.height,preMultiplyAlpha:!0,wrap:{s:33071,t:33071}});let h;if(await(0,s.a)(this._images[0===e?1:0].loadingPromise),0===e)h=g(r.renderExtent);else{const e=this._images[0].renderExtent;if(!e)return void o();h=function(e,t){if(!(0,u.F)(e,t))return g(t);const i=[e[1]-t[1],Math.min(e[3],t[3])-Math.max(e[1],t[1]),t[3]-e[3],123456],r=[e[0]-t[0],Math.min(e[2],t[2])-Math.max(e[0],t[0]),t[2]-e[2],123456],s=t[2]-t[0],n=t[3]-t[1],a=r[0]>0&&r[2]>0?3:2,o=i[0]>0&&i[2]>0?3:2,l=(o+1)*(a+1),h=new Float64Array(3*l),c=new Float32Array(2*l),p=new Uint32Array(6*(o*a-1));let f=0,y=0,m=0,x=0,v=0;for(let e=0;e<4;e++){const o=i[e];if(o<=0)continue;let l=0;for(let i=0;i<4;i++){const o=r[i];o<=0||(h[y++]=t[0]+l,h[y++]=t[1]+f,h[y++]=-1,c[m++]=l/s,c[m++]=f/n,i<3&&e<3&&(1!==i||1!==e)&&(p[v++]=x,p[v++]=x+1,p[v++]=x+a+1,p[v++]=x+1,p[v++]=x+a+2,p[v++]=x+a+1),x++,l+=o)}f+=o}const b=new Uint32Array(p.length);return new d.u([["position",{size:3,data:h,exclusive:!0}],["normal",{size:3,data:_,exclusive:!0}],["uv0",{size:2,data:c,exclusive:!0}]],[["position",p],["normal",b],["uv0",p]])}(e,r.renderExtent)}o(),i.add(l),r.texture=l,(0,n.t)(r.material)?(r.material=new x({transparent:!0,textureId:l.id}),i.add(r.material)):r.material.setParameterValues({textureId:l.id}),r.renderGeometry=new c.v(h,r.material),r.renderGeometry.origin=this._overlayExtents[e].renderLocalOrigin,a.addGeometries([r.renderGeometry],this,2)}else o(),i.remove(r.material),r.material=null}_isScaleRangeLayer(){return"minScale"in this.layer&&"maxScale"in this.layer}_isScaleRangeActive(){return!!this._isScaleRangeLayer()&&(this.layer.minScale>0||this.layer.maxScale>0)}_clippedExtent(e,t){if("local"!==this.view.viewingMode)return(0,u.A)(t,e);const i=this.view.basemapTerrain,r=i.extent;return i.ready&&r?(0,u.w)(e,r,t):(0,u.A)(t,e)}_suspendedChangeHandler(){this.suspended?this.clear():this.refresh()}async _waitFetchReady(e){await(0,o.j)(this.view,"stationary",e),(0,a.a)(e)}};(0,r.e)([(0,l.y)()],S.prototype,"layer",void 0),(0,r.e)([(0,l.y)()],S.prototype,"suspended",void 0),(0,r.e)([(0,l.y)({readOnly:!0})],S.prototype,"fullExtentInLocalViewSpatialReference",void 0),(0,r.e)([(0,l.y)()],S.prototype,"updating",void 0),S=(0,r.e)([(0,l.n)("esri.views.3d.layers.DynamicLayerView3D")],S);const I=(0,u.i)();var C=S},66532:(e,t,i)=>{"use strict";i.d(t,{E:()=>re,U:()=>G,_:()=>$,s:()=>se});var r=i(78155),s=i(20215),n=i(80219),a=i(36845),o=i(88903),l=i(32422),h=i(9612),u=i(40130),c=i(83731),d=i(80987),p=i(8725),f=i(41392),y=i(18143),m=i(71391),g=i(58404),_=i(30665),x=i(73574),v=i(98548),b=i(81135),w=i(32769),S=i(70448),I=i(74589);function C(e,t){if(e===t)return!0;if(null==e||null==t)return!1;if(e.length!==t.length)return!1;for(let i=0;i<e.length;i++){const r=e[i],s=t[i];if(r.length!==s.length)return!1;for(let e=0;e<r.length;e++)if(r[e]!==s[e])return!1}return!0}function M(e,t){if(e===t)return!0;if(null==e||null==t)return!1;if(e.length!==t.length)return!1;for(let i=0;i<e.length;i++)if(!C(e[i],t[i]))return!1;return!0}function T(e,t){return e.hasZ===t.hasZ&&e.hasM===t.hasM&&!!E(e.spatialReference,t.spatialReference)&&C(e.points,t.points)}function E(e,t){return e===t||e&&t&&e.equals(t)}function F(e,t){return e===t||null!=e&&null!=t&&e.objectId===t.objectId&&!!function(e,t){if(e===t)return!0;if((0,n.t)(e)||(0,n.t)(t))return!1;if(e.type!==t.type)return!1;switch(e.type){case"point":return function(e,t){return!!E(e.spatialReference,t.spatialReference)&&e.x===t.x&&e.y===t.y&&e.z===t.z&&e.m===t.m}(e,t);case"extent":return function(e,t){return e.hasZ===t.hasZ&&e.hasM===t.hasM&&!!E(e.spatialReference,t.spatialReference)&&e.xmin===t.xmin&&e.ymin===t.ymin&&e.zmin===t.zmin&&e.xmax===t.xmax&&e.ymax===t.ymax&&e.zmax===t.zmax}(e,t);case"polyline":return function(e,t){return e.hasZ===t.hasZ&&e.hasM===t.hasM&&!!E(e.spatialReference,t.spatialReference)&&M(e.paths,t.paths)}(e,t);case"polygon":return function(e,t){return e.hasZ===t.hasZ&&e.hasM===t.hasM&&!!E(e.spatialReference,t.spatialReference)&&M(e.rings,t.rings)}(e,t);case"multipoint":return T(e,t);case"mesh":return!1;default:return}}(e.geometry,t.geometry)&&!!function(e,t){if(e===t)return!0;if(!e||!t)return!1;const i=Object.keys(e),r=Object.keys(t);if(i.length!==r.length)return!1;for(const r of i)if(e[r]!==t[r])return!1;return!0}(e.attributes,t.attributes)}class A{constructor(e,t){this.highestResolutionVersion=null,this.versions=[],this.ref(e,t)}get isReferenced(){return 0!==this.versions.length}get isSingle(){return 1===this.versions.length&&1===this.versions[0].refCount}ref(e,t){const i=this.feature;P.oldVersion=i,this.feature&&Object.defineProperty(e,"uid",{value:this.feature.uid,configurable:!0});for(const r of this.versions)if(r.resolution===t){r.refCount++;const t=this.highestResolutionVersion===r&&!F(e,r.feature);return(t||this.highestResolutionVersion!==r)&&(r.feature=e),P.newVersion=t?e:i,P}const r={feature:e,resolution:t,refCount:1};return this.versions.push(r),!this.highestResolutionVersion||t<this.highestResolutionVersion.resolution?(P.newVersion=e,this.highestResolutionVersion=r):P.newVersion=i,P}unref(e){for(let t=0;t<this.versions.length;t++){const i=this.versions[t];if(i.resolution===e)return i.refCount--,P.oldVersion=this.feature,0===i.refCount&&(this.versions[t]=this.versions[this.versions.length-1],this.versions.length--,this.highestResolutionVersion===i&&(this.recalculateHighestResolutionVersion(),P.oldVersion=i.feature)),P.newVersion=this.feature,P}return null}get feature(){return this.highestResolutionVersion?this.highestResolutionVersion.feature:null}recalculateHighestResolutionVersion(){if(0===this.versions.length)return void(this.highestResolutionVersion=null);let e=this.versions[0];for(let t=1;t<this.versions.length;t++){const i=this.versions[t];i.resolution<e.resolution&&(e=i)}this.highestResolutionVersion=e}}class R{constructor(e){this._feature=e,this.refCount=1}get isReferenced(){return 0!==this.refCount}get isSingle(){return 1===this.refCount}ref(e){return++this.refCount,P.oldVersion=this._feature,this.feature&&Object.defineProperty(e,"uid",{value:this.feature.uid,configurable:!0}),F(this._feature,e)||(this._feature=e),P.newVersion=this._feature,P}unref(){return P.oldVersion=this._feature,this.refCount>0&&(this.refCount--,!this.isReferenced)?(P.newVersion=null,P):(P.newVersion=this._feature,P)}get feature(){return this._feature}}const P={oldVersion:null,newVersion:null},L=new Set;class D{constructor(e){this.descriptor=e,this.fetchStatus=0,this._features=null,this._numVertices=0,this._featureLimit=0,this.featuresMissing=!0,this._shuffled=!1,this._numFeatures=N,this._emptyFeatureRatio=0,this._estimatedSize=-1,this._estimatedUnusedSize=0,this._estimatedUnusedSizeDirty=!1,this._availableFields=L,this._displayingFeatures=null,this.alive=!0,this.filtered=!1}get displayingFeatures(){return this._displayingFeatures}set displayingFeatures(e){this._displayingFeatures=e,this.extentIncludingBorrowedFeatures=null}get perTileMaximumNumberOfFeaturesExceeded(){return!this.filtered&&(this.featuresMissing||this.features&&this.featureLimit!==this.features.length)}get features(){return this._features}get featureLimit(){return this._featureLimit}set featureLimit(e){this._featureLimit!==e&&(this._featureLimit=e,this._estimatedUnusedSizeDirty=!0)}get availableFields(){return this._availableFields}setFeatures(e,t,i){this._availableFields=(0,n.q)(i,L),this._features=e,this._shuffled=!1,this._estimatedSize=-1,this._estimatedUnusedSizeDirty=!0,e&&e.length>0?(this._emptyFeatureRatio=t/(e.length+t),this._numVertices=e.reduce(((e,t)=>e+(0,_.w)(t.geometry)),0)):(this._emptyFeatureRatio=0,this._numVertices=0)}get emptyFeatureRatio(){return this._emptyFeatureRatio}get numFeatures(){return this.hasPreciseFeatureCount?this._numFeatures:this._features?this._features.length:0}set numFeatures(e){this._numFeatures=e}get hasPreciseFeatureCount(){return this._numFeatures>N}get needsFeatureCount(){return this._numFeatures===N}get numVertices(){return this._numVertices}get id(){return this.descriptor.id}get estimatedSize(){return this.updateMemoryEstimates(),this._estimatedSize}get estimatedUnusedSize(){return this._estimatedUnusedSize}updateMemoryEstimates(){if(this._estimatedSize<0){if(this._estimatedSize=0,this._estimatedUnusedSize=0,this._features)for(let e=0;e<this._features.length;++e){const t=(0,_.A)(this._features[e]);this._estimatedSize+=t,e>=this.featureLimit&&(this._estimatedUnusedSize+=t)}return!0}if(this._estimatedUnusedSizeDirty){if(this._estimatedUnusedSize=0,this._estimatedUnusedSizeDirty=!1,this._features)for(let e=this.featureLimit;e<this._features.length;++e)this._estimatedUnusedSize+=(0,_.A)(this._features[e]);return!0}return!1}get isFetching(){return 2===this.fetchStatus||3===this.fetchStatus}get isRefetching(){return 3===this.fetchStatus}get needsFetching(){return 0===this.fetchStatus||1===this.fetchStatus}get needsRefetching(){return 1===this.fetchStatus}get isFetched(){return 4===this.fetchStatus||5===this.fetchStatus}resetFetching(){this.fetchStatus=3===this.fetchStatus?1:0}get needsDisplayUpdate(){return!!this._features&&!function(e,t,i){if((0,n.t)(t)||(0,n.t)(e)||i!==t.length||i>e.length)return!1;for(let r=0;r<i;++r)if(e[r]!==t[r])return!1;return!0}(this._features,this.displayingFeatures,this.featureLimit)}intersects(e){return!e||!this.descriptor.extent||((0,g.a)(e,O),(0,g.F)(this.descriptor.extent,O))}intersectionIncludingBorrowed(e,t){const i=(0,n.r)(this.extentIncludingBorrowedFeatures)?this.extentIncludingBorrowedFeatures:this.descriptor.extent;return e||i?(e?((0,g.a)(e,t),(0,g.w)(t,i,t)):(0,g.A)(t,i),t):((0,g.A)(t,g.I),t)}_shuffle(e){this._features.sort(((t,i)=>(0,_.O)(t,e)-(0,_.O)(i,e))),(0,r.Y)(this._features,16438),this._shuffled=!0,this._estimatedUnusedSizeDirty=!0}reduceFeatures(e,t,i){if(e<=0)return!1;if(!this._features)return this.featureLimit=0,!1;let r=!1;this.featureLimit=Math.ceil(this.numFeatures*e),this.featureLimit>this._features.length&&(this.featureLimit=this._features.length,4===this.fetchStatus&&this._features.length>0&&(this.fetchStatus=1,r=!0)),!this._shuffled&&e<1&&this._shuffle(i);const s=Math.max(this.featureLimit,Math.ceil(t*this.numFeatures));return this._features.length>s&&(this._features.length=s,this.featuresMissing=!0,5===this.fetchStatus&&(this.fetchStatus=4)),r}get cache(){return{availableFields:this._availableFields,features:this.features,numFeatures:this._numFeatures,emptyFeatureRatio:this._emptyFeatureRatio,fetchStatus:this.fetchStatus,featuresMissing:this.featuresMissing}}set cache(e){this.requestController=null,this._availableFields=e.availableFields,this._features=e.features,this._numFeatures=e.numFeatures,this._emptyFeatureRatio=e.emptyFeatureRatio,this.fetchStatus=e.fetchStatus,this.featuresMissing=e.featuresMissing,this._estimatedSize=-1,this._estimatedUnusedSizeDirty=!0}}const N=-1,O=(0,g.i)(),k=n.n.getLogger("esri.views.3d.layers.support.FeatureTileFetcher3D");let V=class extends r.p{constructor(e){super(e),this._useTileCount=!1,this.updating=!1,this.updatingTotal=0,this.updatingRemaining=0,this.expectedFeatureDiff=0,this.maximumNumberOfFeaturesExceeded=!1,this.maximumNumberOfFeaturesExceededThrottle=1e3,this._fullRatio=1,this._farRatio=1,this.changes={updates:{adds:new Array,removes:new Array},adds:new Array,removes:new Array},this.handles=new c.u,this._frameTask=l.y,this._dirty=!1,this.featureTiles=new Map,this.displayingFeatureReferences=new Map,this.numDisplayingFeatureReferences=0,this.suspended=!0,this.pendingEdits=null}set maximumNumberOfFeatures(e){e=e||1/0;const t=this._get("maximumNumberOfFeatures");e===t||e<1||(this._set("maximumNumberOfFeatures",e),this.maximumFeaturesUpdated(t,e))}set memoryFactor(e){this.memoryFactor!==e&&(this._set("memoryFactor",e),this.setDirty())}set lodFactor(e){this.lodFactor!==e&&(this._set("lodFactor",e),this.supportsResolution&&this.refetch())}get useTileCount(){return this._useTileCount&&(0,n.r)(this.context.query.queryFeatureCount)}set useTileCount(e){this._useTileCount=e,this.notifyChange("useTileCount")}get memoryForUnusedFeatures(){let e=0;return this.featureTiles.forEach((t=>e+=t.estimatedUnusedSize)),e}get totalVertices(){let e=0;return this.featureTiles.forEach((t=>e+=t.numVertices)),e}get totalFeatures(){let e=0;return this.featureTiles.forEach((t=>e+=t.numFeatures)),e}set filterExtent(e){if(e&&this.context.tilingScheme&&!e.spatialReference.equals(this.context.tilingScheme.spatialReference))return void k.error("#filterExtent=","extent needs to be in the same spatial reference as the tiling scheme");const t=this._get("filterExtent");if(t===e||t&&e&&t.equals(e))return;const i=e?e.clone():null;this._set("filterExtent",i),this.reclip(i,t)}initialize(){this.handles.add((0,a.C)(this,"tileDescriptors","change",(()=>this.setDirty()),(()=>this.setDirty()))),this.objectIdField=this.context.objectIdField,this.FeatureReferenceClass=this.context.capabilities.supportsMultipleResolutions?A:R;const e=this.context.scheduler;(0,n.r)(e)&&(this._frameTask=e.registerTask(l.p.FEATURE_TILE_FETCHER,this)),this.setDirty()}destroy(){this._frameTask.remove(),this.handles=(0,n.k)(this.handles),this.featureTiles.forEach((e=>{this.cancelFetchTile(e),this.removeTile(e)})),this.featureTiles.clear(),this.displayingFeatureReferences.clear(),this.pendingEdits&&(this.pendingEdits.controller.abort(),this.pendingEdits=null)}get paused(){return this.suspended||!!this.pendingEdits}restart(){this.featureTiles.forEach((e=>{this.cancelFetchTile(e),this.clearTile(e),this.resetFetchTile(e)})),(0,n.r)(this.context.memoryCache)&&this.context.memoryCache.clear(),this.setDirty()}refetch(){this.featureTiles.forEach((e=>{this.cancelFetchTile(e),this.resetFetchTile(e)})),(0,n.r)(this.context.memoryCache)&&this.context.memoryCache.clear(),this.setDirty()}suspend(){this.suspended||(this.suspended=!0,this.pause(),this.setDirty())}resume(){this.suspended&&(this.suspended=!1,this.unpause())}pause(){this.paused&&(this.featureTiles.forEach((e=>this.cancelFetchTile(e))),this.updated())}unpause(){this.paused||(this.setDirty(),this.updated())}get availableFields(){let e=null;return this.featureTiles.forEach((t=>{(0,n.t)(t.displayingFeatures)||0===t.displayingFeatures.length||((0,n.t)(e)?e=new Set(t.availableFields):e.forEach((i=>{t.availableFields.has(i)||(0,n.f)(e).delete(i)})))})),(0,n.r)(e)?e:new Set}applyEdits(e){this.pendingEdits||(this.pendingEdits={edits:Promise.resolve(),count:0,controller:(0,s.h)()},this.pause());const t=this.pendingEdits;t.count++;const i=t.edits.then((()=>e.result.catch((e=>{if((0,s.g)(e))throw e;return null})).then((e=>e?(this.applyEditsDeleteFeatures(e.deletedFeatures),this.applyEditsAddUpdateFeatures(e.addedFeatures,e.updatedFeatures,t.controller.signal).then((()=>e))):e)).then((e=>(0==--t.count&&(this.pendingEdits===t&&(this.pendingEdits=null),(0,n.r)(this.context.memoryCache)&&this.context.memoryCache.clear(),this.unpause(),this.updated()),e)))));return t.edits=i,this.updated(),i}applyEditsDeleteFeatures(e){if(0===e.length)return;const t=this.context.globalIdField,i=t&&this.availableFields.has(t),r=new Set,s=this.objectIdField;e.forEach((({objectId:e,globalId:n})=>{if((!e||e<0)&&t){i||k.errorOncePerTick(`Editing the specified service requires the layer's globalIdField, ${t} to be included the layer's outFields for updates to be reflected in the view`);const e=this.features.find((e=>e.attributes&&e.attributes[t]===n));e&&r.add((0,_.O)(e,s))}else r.add(e)})),this.featureTiles.forEach((e=>{if(!e.features)return;const t=e.features.filter((e=>!r.has((0,_.O)(e,this.objectIdField))));t.length!==e.features.length&&(e.setFeatures(t,0,e.availableFields),this.invalidateCounts())}))}async applyEditsAddUpdateFeatures(e,t,i){const r=[],n=new Set;if(e.forEach((e=>r.push(e.objectId))),t.forEach((e=>{r.push(e.objectId),n.add(e.objectId)})),0===r.length)return;const a=[];this.featureTiles.forEach((e=>{const t=this.applyEditsAddUpdateTile(e,r,n,i);t&&a.push(t)})),await(0,s.A)(a)}async applyEditsAddUpdateTile(e,t,i,r){if(!e.features)return;const s=this.createQuery(e);s.resultType=void 0,s.cacheHint=!1,s.objectIds=t;const n=await this.queryFeatures(s,r);let a=null;if(i.size>0){const t=e.features.filter((e=>!i.has((0,_.O)(e,this.objectIdField))));t.length!==e.features.length&&(a=t)}if(n.features.length>0){a||(a=e.features.slice());for(const e of n.features)a.push(e)}a&&(e.hasPreciseFeatureCount&&(e.numFeatures=Math.max(e.numFeatures,a.length)),e.setFeatures(a,0,j(e.availableFields,n.fields)),this.invalidateCounts())}queryFeatures(e,t){return this.context.query.queryFeaturesDehydrated(e,{signal:t,timeout:Q})}setDirty(){this._dirty=!0,this.updated()}get running(){return this.updating}runTask(e){if(this._frameTask.processQueue(e),!this._dirty||!this.constructed)return;this._dirty=!1;const t=this.getListOfTiles();if(this.markTilesNotAlive(t),!e.run((()=>this.addTiles(t,e)))||!e.run((()=>this.filterExtentTiles(t,e)))||!e.run((()=>this.removeTiles(t,e)))||e.done)return void this.setDirty();const i=this.sortTiles(t);e.run((()=>this.displayTiles(i,e)))&&e.run((()=>this.fetchTiles(i,e)))&&e.run((()=>this.updateMemoryEstimates(i,e)))||this.setDirty(),this.updated(),this.updating||this.updateMaximumNumberOfFeaturesExceeded()}markTilesNotAlive(e){for(const t of e)t.alive=!1}addTiles(e,t){return!this.suspended&&(this.tileDescriptors.forEach((i=>{const r=this.featureTiles.get(i.id);r?r.alive=!0:t.done||(e.push(this.addTile(i)),t.madeProgress())})),t.hasProgressed)}filterExtentTiles(e,t){for(const i of e){if(t.done)break;i.alive&&(i.filtered=!i.intersects(this.filterExtent),i.filtered&&(this.clearTile(i),t.madeProgress()))}return t.hasProgressed}removeTiles(e,t){for(let i=e.length-1;i>=0&&!t.done;i--){const r=e[i];r.alive||(this.removeTile(r),i!==e.length-1&&(e[i]=e[e.length-1]),e.pop(),t.madeProgress())}return t.hasProgressed}sortTiles(e){return e.sort(((e,t)=>e.descriptor.loadPriority-t.descriptor.loadPriority)),e}displayTiles(e,t){const i=this.updateRatio(e),r=e=>{const t=this._fullRatio<1?i(e)*this._farRatio:1;return e.reduceFeatures(t,this.memoryFactor,this.objectIdField)&&this.setDirty(),this.showTile(e)};for(const i of e)if(!t.run((()=>r(i)))){this.setDirty();break}return t.hasProgressed}fetchTiles(e,t){if(this.paused)return!1;let i=!1;for(const r of e){if(!r.needsFetching)continue;const e=(0,n.r)(this.context.memoryCache)?this.context.memoryCache.pop(r.id):null;if((0,n.r)(e))r.cache=e,this.setDirty(),this.scheduleUpdated(),t.madeProgress();else{if(this.needsNumFeatures(r)){const e=(0,s.h)(),n=this.fetchTileCount(r,e.signal);this._handleRequest(r,n,e,(()=>r.numFeatures=-2)),i=!0,t.madeProgress()}if(t.done)return!0}}if(i)return t.hasProgressed;for(const i of e)if(i.needsFetching){const e=(0,s.h)(),r=this.fetchTile(i,e.signal);if(this._handleRequest(i,r,e,(e=>{i.setFeatures([],0,null),this.invalidateCounts(),i.featuresMissing=!1,this.context.logFetchError(k,e)})),t.madeProgress(),t.done)return!0}return t.hasProgressed}updateMemoryEstimates(e,t){return e.some((e=>!t.run((()=>e.updateMemoryEstimates()))&&(this.setDirty(),!0))),t.hasProgressed}reclip(e,t){if(!this.constructed)return;const i=new Array;this.featureTiles.forEach((r=>{(0,n.t)(r.displayingFeatures)||0===r.displayingFeatures.length||(r.intersectionIncludingBorrowed(t,H),r.intersectionIncludingBorrowed(e,W),(0,g.G)(H,W)||i.push(r))})),this.refreshDisplayingFeatures(i),this.updated()}refreshDisplayingFeatures(e){const t=new Set,i=this.changes.updates;for(const r of e)if(!(0,n.t)(r.displayingFeatures))for(const e of r.displayingFeatures){const r=(0,_.O)(e,this.objectIdField);if(t.has(r))continue;t.add(r);const{feature:s}=this.displayingFeatureReferences.get(r);i.removes.push(s),i.adds.push(s)}this.applyChanges()}updated(){let e=0;this.paused||this.featureTiles.forEach((t=>t.isFetching?++e:0));const t=this._dirty||e>0||!!this.pendingEdits;if(this._set("updating",t),t){let t=0,i=0,r=0,s=0,a=0;const o=this.displayingFeatureReferences.size/this.numDisplayingFeatureReferences;this.featureTiles.forEach((e=>{if(++i,e.isFetching&&e.hasPreciseFeatureCount){const t=this.maximumFeaturesForTile(e)*(1-e.emptyFeatureRatio),i=(0,n.r)(e.displayingFeatures)?e.displayingFeatures.length*o:0;a+=t-i}e.needsFetching?++s:e.numFeatures>0&&(++r,t+=e.numFeatures)})),s+=e;let l=0,h=0;t?(h=t,l=Math.min(s*t/r,t)):(h=i,l=s),a=Math.min(this.maximumNumberOfFeatures-this.features.length,a),this._set("updatingTotal",h),this._set("updatingRemaining",l),this._set("expectedFeatureDiff",a)}else this._set("updatingTotal",0),this._set("updatingRemaining",0),this._set("expectedFeatureDiff",0);this.debugger&&this.debugger.update()}updateMaximumNumberOfFeaturesExceeded(){const e=(0,m.g)(this.featureTiles,(e=>e.perTileMaximumNumberOfFeaturesExceeded));this._set("maximumNumberOfFeaturesExceeded",e)}updateRatio(e){const t=function(e){let t=0;for(const i of e)i.features&&i.features.length>0&&i.alive&&(t=Math.max(t,i.descriptor.lij[0]));return t}(e),i=e=>1/(1<<Math.max(0,t-e.descriptor.lij[0]));let r=0,s=0;for(const t of e){const e=t.numFeatures;r+=e,s+=e*i(t)}return this._fullRatio=Math.min(1,this.maximumNumberOfFeatures/r),this._farRatio=this.maximumNumberOfFeatures/s,this.scheduleUpdated(),i}maximumFeaturesUpdated(e,t){e!==t&&(t>e&&this.featureTiles.forEach((e=>{if(!e.featuresMissing)return;const t=this.maximumFeaturesForTile(e);e.features&&(e.features.length>=t||5===e.fetchStatus)||(this.cancelFetchTile(e),this.resetFetchTile(e))})),this.setDirty())}addTile(e){const t=new D(e);return this.featureTiles.set(t.id,t),this.resetFetchTile(t),this.referenceDisplayingFeaturesFromRelatedTiles(t),t}referenceDisplayingFeaturesFromRelatedTiles(e){const t=e.descriptor.resolution;this.featureTiles.forEach((i=>{if(!((0,n.t)(i.displayingFeatures)||e===i||e.descriptor.lij&&i.descriptor.lij&&!(0,l._)(e.descriptor.lij,i.descriptor.lij))){(0,n.t)(e.displayingFeatures)&&(e.displayingFeatures=[]),e.descriptor.extent&&i.descriptor.extent&&((0,n.t)(e.extentIncludingBorrowedFeatures)&&(e.extentIncludingBorrowedFeatures=(0,g.e)(e.descriptor.extent)),(0,g.c)(e.extentIncludingBorrowedFeatures,i.descriptor.extent,e.extentIncludingBorrowedFeatures));for(const r of i.displayingFeatures){e.displayingFeatures.push(r);const i=this.displayingFeatureReferences.get((0,_.O)(r,this.objectIdField));i.ref(i.feature,t),this.numDisplayingFeatureReferences++}}})),e.featureLimit=(0,n.r)(e.displayingFeatures)?e.displayingFeatures.length:0}removeTile(e){this.clearTile(e),this.featureTiles.delete(e.id)}resetFetchTile(e){e.filtered=!e.intersects(this.filterExtent),e.filtered?e.needsFetching&&(e.fetchStatus=4):e.fetchStatus=0}cancelFetchTile(e){const t=e.requestController;(0,n.r)(t)&&(e.requestController=null,e.resetFetching(),t.abort())}async fetchTileCount(e,t){return e.numFeatures=await this.fetchCount(e,t),this.updateRatio(this.getListOfTiles()),3===e.fetchStatus?1:0}async fetchTile(e,t){const i=this.maximumFeaturesForTile(e);if(i<=0)return function(e){return e.setFeatures([],0,null),e.featuresMissing=!1,4}(e);const r=this.getMaxRecordCount(e),s=Math.ceil(i/r);if(U(e)||!this.context.capabilities.supportsMaxRecordCountFactor||e.numFeatures<=i&&s>y.b.MAX_MAX_RECORD_COUNT_FACTOR)return this.fetchPagedTile(e,t);const n=this.createQuery(e);if(n.maxRecordCountFactor=Math.ceil(i/r),e.isRefetching&&e.features&&e.features.length>0){const t=Math.ceil(e.features.length/(1-e.emptyFeatureRatio)/r);n.maxRecordCountFactor=Math.max(t+1,n.maxRecordCountFactor)}const{features:a,exceededTransferLimit:o,fields:l}=await this.queryFeatures(n,t),h=o?n.maxRecordCountFactor>=y.b.MAX_MAX_RECORD_COUNT_FACTOR?5:4:5;return await this._frameTask.schedule((()=>{e.featuresMissing=a.length<e.numFeatures||o;const t=this._removeEmptyFeatures(a);e.setFeatures(a,t,B(l))}),t),this.invalidateCounts(),h}async fetchCount(e,t){return this.context.query.queryFeatureCount(this.createFeatureCountQuery(e),{signal:t})}async fetchPagedTile(e,t){let i,r=0,s=0,a=0,o=this.maximumFeaturesForTile(e)-a;const l=this.getMaxRecordCount(e);let h=null;for(;;){const u=this.createQuery(e),c=this.setPagingParameters(u,r,o,l),{features:d,exceededTransferLimit:p,fields:f}=await this.queryFeatures(u,t);if(await this._frameTask.schedule((()=>{c&&(r+=(0,n.f)(u.num)),a+=d.length,s+=this._removeEmptyFeatures(d),e.featuresMissing=r<e.numFeatures||p,i=i?i.concat(d):d,h=j(h,f),e.setFeatures(i,s,h)}),t),this.invalidateCounts(),this.setDirty(),o=this.maximumFeaturesForTile(e)-a,!c||!p||o<=0)return p?4:5}}createFeatureCountQuery(e){const t=this.createQuery(e);return this.context.capabilities.supportsCacheHint&&(t.resultType=void 0,t.cacheHint=!0),t}createQuery(e){const t=this.context.createQuery(),i=e.descriptor.extent;if(i){const e=this.context.tilingScheme.spatialReference;t.geometry=(0,g.o)(i,e)}return this.setResolutionParams(t,e),this.useTileQuery(e)?t.resultType="tile":this.context.capabilities.supportsCacheHint&&(t.cacheHint=!0),t}setPagingParameters(e,t,i,r){return!!this.context.capabilities.supportsPagination&&(e.start=t,i>0&&this.context.capabilities.supportsMaxRecordCountFactor?(e.maxRecordCountFactor=Math.ceil(i/r),e.num=Math.min(e.maxRecordCountFactor*r,i)):e.num=Math.min(r),!0)}getEffectiveTileResolution(e){if(null==e.descriptor.resolution)return null;const t=1===this.context.viewingMode?this.context.tilingScheme.resolutionAtLevel(3):1/0;return Math.min(e.descriptor.resolution,t)/this.lodFactor}get supportsResolution(){return this.context.capabilities.supportsMultipleResolutions&&"point"!==this.context.geometryType}setResolutionParams(e,t){if(!this.supportsResolution)return;const i=this.getEffectiveTileResolution(t);null!=i&&(this.context.capabilities.supportsQuantization?e.quantizationParameters=new y.a({mode:"view",originPosition:"upper-left",tolerance:i,extent:this.context.fullExtent}):"polyline"===this.context.geometryType&&(e.maxAllowableOffset=i))}_removeEmptyFeatures(e){const t=e.length;for(let t=0;t<e.length;){const i=e[t];(0,_.S)(i.geometry)?++t:(e[t]=e[e.length-1],--e.length)}return t-e.length}needsNumFeatures(e){return this.useTileCount&&e.needsFeatureCount&&!U(e)}getMaxRecordCount(e){const{tileMaxRecordCount:t,maxRecordCount:i}=this.context;return this.useTileQuery(e)&&(0,n.r)(t)&&t>0&&this.context.capabilities.supportsResultType?t:(0,n.r)(i)&&i>0?i:q}useTileQuery(e){return(!U(e)||!this.context.capabilities.supportsCacheHint)&&this.context.capabilities.supportsResultType}_handleRequest(e,t,i,r){e.fetchStatus=e.needsRefetching?3:2,e.requestController=i;let n=!1;t.then((t=>{e.requestController=null,e.fetchStatus=t})).catch((t=>{e.requestController===i&&(e.requestController=null,e.fetchStatus=4),(0,s.g)(t)?n=!0:r(t)})).then((()=>{n||this.setDirty(),this.scheduleUpdated()}))}scheduleUpdated(){this.handles&&!this.handles.has("scheduleUpdated")&&this.handles.add((0,r.j)((()=>{this.handles.remove("scheduleUpdated"),this.updated()})),"scheduleUpdated")}showTile(e){if((0,n.r)(e.displayingFeatures)&&!e.needsDisplayUpdate)return!1;const t=e.features;if(0===e.featureLimit||!t){const t=(0,n.r)(e.displayingFeatures)&&e.displayingFeatures.length>0;return this.hideTileFeatures(e),e.displayingFeatures=[],t}const i=e.descriptor.resolution,r=this.changes.updates,s=this.changes.adds,a=Math.min(e.featureLimit,t.length);e.featureLimit=a;for(let e=0;e<a;++e){const n=t[e],a=(0,_.O)(n,this.objectIdField),o=this.displayingFeatureReferences.get(a);if(o){const e=o.ref(n,i);e.oldVersion!==e.newVersion&&(r.removes.push(e.oldVersion),r.adds.push(e.newVersion))}else this.displayingFeatureReferences.set(a,new this.FeatureReferenceClass(n,i)),s.push(n);this.numDisplayingFeatureReferences++}return this.hideTileFeatures(e),this.applyChanges(),e.displayingFeatures=t.slice(0,a),!0}hideTile(e){this.cancelFetchTile(e),this.hideTileFeatures(e)}hideTileFeatures(e){if((0,n.t)(e.displayingFeatures))return;const t=this.changes.updates,i=this.changes.removes;for(const r of e.displayingFeatures){const s=(0,_.O)(r,this.objectIdField),n=this.displayingFeatureReferences.get(s);if(!n)continue;const a=n.unref(e.descriptor.resolution);this.numDisplayingFeatureReferences--,a?a.oldVersion!==a.newVersion&&(null==a.newVersion?(this.displayingFeatureReferences.delete(s),i.push(a.oldVersion)):(t.adds.push(a.newVersion),t.removes.push(a.oldVersion))):console.error("Hiding unreferenced feature")}this.applyChanges(),e.displayingFeatures=null}applyChanges(){const e=this.changes.updates;e.removes.length>0&&(this.features.removeMany(e.removes),e.removes.length=0),e.adds.length>0&&(this.features.addMany(e.adds),e.adds.length=0);const t=this.changes.adds,i=this.changes.removes,r=Math.min(t.length,i.length);let s=0;for(;s<r;){const e=Math.min(s+Z,r);this.features.addMany(t.slice(s,e)),this.features.removeMany(i.slice(s,e)),s=e}t.length>r&&this.features.addMany(0===s?t:t.slice(s)),i.length>r&&this.features.removeMany(0===s?i:i.slice(s)),t.length=0,i.length=0}clearTile(e){if(this.hideTile(e),e.features&&(0,n.r)(this.context.memoryCache)){const t=16+e.estimatedSize;this.context.memoryCache.put(e.id,e.cache,t)}e.setFeatures(null,0,null),this.invalidateCounts()}invalidateCounts(){this.notifyChange("totalVertices"),this.notifyChange("totalFeatures"),this.notifyChange("memoryForUnusedFeatures")}getListOfTiles(){return Array.from(this.featureTiles.values())}get storedFeatures(){return this.getListOfTiles().reduce(((e,t)=>e+(t.features?t.features.length:0)),0)}maximumFeaturesForTile(e){const t=e.hasPreciseFeatureCount?e.numFeatures:1/0,i=e.hasPreciseFeatureCount?t:this.maximumNumberOfFeatures,r=this._fullRatio<1?this._farRatio:1;return Math.min(Math.ceil(i*r/(1-e.emptyFeatureRatio)),t)}get test(){return{process:e=>this.runTask(e),getFeatureTileById:e=>this.featureTiles.get(e),forEachFeatureTile:e=>this.featureTiles.forEach(e)}}};function U(e){return"dummy-tile-full-extent"===e.id}function G(e){const t=e.capabilities.query;return{supportsMultipleResolutions:z(e),supportsPagination:!(!t||!t.supportsPagination),supportsResultType:!(!t||!t.supportsResultType),supportsCacheHint:!(!t||!t.supportsCacheHint),supportsQuantization:!(!t||!t.supportsQuantization),supportsQuantizationEditMode:!(!t||!t.supportsQuantizationEditMode),supportsMaxRecordCountFactor:!(!t||!t.supportsMaxRecordCountFactor),supportsFormatPBF:!(!t||!t.supportsFormatPBF)}}function z(e){switch(e.geometryType){case"polyline":return!0;case"polygon":return e.capabilities&&e.capabilities.query&&e.capabilities.query.supportsQuantization;default:return!1}}function B(e){return(0,n.t)(e)?new Set:new Set(e.map((e=>e.name)))}function j(e,t){if((0,n.t)(e)||(0,n.t)(t))return B(t);const i=new Set;for(const{name:r}of t)e.has(r)&&i.add(r);return i}(0,r.e)([(0,o.y)({constructOnly:!0})],V.prototype,"features",void 0),(0,r.e)([(0,o.y)()],V.prototype,"tileDescriptors",void 0),(0,r.e)([(0,o.y)({value:1/0})],V.prototype,"maximumNumberOfFeatures",null),(0,r.e)([(0,o.y)({value:1})],V.prototype,"memoryFactor",null),(0,r.e)([(0,o.y)({value:1})],V.prototype,"lodFactor",null),(0,r.e)([(0,o.y)()],V.prototype,"useTileCount",null),(0,r.e)([(0,o.y)({readOnly:!0})],V.prototype,"updating",void 0),(0,r.e)([(0,o.y)({readOnly:!0})],V.prototype,"updatingTotal",void 0),(0,r.e)([(0,o.y)({readOnly:!0})],V.prototype,"updatingRemaining",void 0),(0,r.e)([(0,o.y)({readOnly:!0})],V.prototype,"expectedFeatureDiff",void 0),(0,r.e)([(0,o.y)({readOnly:!0})],V.prototype,"memoryForUnusedFeatures",null),(0,r.e)([(0,o.y)({readOnly:!0})],V.prototype,"maximumNumberOfFeaturesExceeded",void 0),(0,r.e)([(0,o.y)({constructOnly:!0})],V.prototype,"maximumNumberOfFeaturesExceededThrottle",void 0),(0,r.e)([(0,o.y)({readOnly:!0})],V.prototype,"totalVertices",null),(0,r.e)([(0,o.y)({readOnly:!0})],V.prototype,"totalFeatures",null),(0,r.e)([(0,o.y)()],V.prototype,"filterExtent",null),(0,r.e)([(0,o.y)({constructOnly:!0})],V.prototype,"context",void 0),V=(0,r.e)([(0,o.n)("esri.views.3d.layers.support.FeatureTileFetcher3D")],V);const q=2e3,H=(0,g.i)(),W=(0,g.i)(),Q=6e5,Z=200,Y=[[0,179,255],[117,62,128],[0,104,255],[215,189,166],[32,0,193],[98,162,206],[102,112,129],[52,125,0],[142,118,246],[138,83,0],[92,122,255],[122,55,83],[0,142,255],[81,40,179],[0,200,244],[13,24,127],[0,170,147],[19,58,241],[22,44,35]];class J{constructor(e,t,i){this.loadingGraphics=new Map,this.loadedGraphics=new Map,this.pendingGraphics=new Map,this._enabled=!0,this.tileFetcher=e,this.view=i,this.tilingScheme=new l.$(t),this.loadedSymbols=Y.map((e=>new b.a(new b.z({material:{color:[e[0],e[1],e[2],.6]},outline:{color:"black",size:1}})))),this.loadingSymbols=[new b.a(new b.z({material:{color:[200,200,200,.4]},outline:{color:[30,30,30],size:1}}))],this.pendingSymbols=[new b.a(new b.z({material:{color:[100,100,100,.4]},outline:{color:[30,30,30],size:1}}))],this.dataExtentSymbol=new b.a(new b.z({material:{color:[0,0,0,0]},outline:{color:"green",size:4}}))}destroy(){this.enabled=!1}get enabled(){return this._enabled}set enabled(e){this._enabled=e,this.update()}update(){this._enabled?(this.synchronizeMaps(this.loadingGraphics,{filter:e=>e.isFetching,symbols:this.loadingSymbols}),this.synchronizeMaps(this.loadedGraphics,{filter:e=>!e.isFetching,symbols:this.loadedSymbols}),this.synchronizeMaps(this.pendingGraphics,{filter:e=>!e.isFetching,symbols:this.pendingSymbols}),this.showDataExtent(this.tileFetcher.filterExtent)):(this.loadingGraphics.forEach((e=>{this.view.graphics.removeMany(e)})),this.loadingGraphics.clear(),this.loadedGraphics.forEach((e=>{this.view.graphics.removeMany(e)})),this.loadedGraphics.clear(),this.pendingGraphics.forEach((e=>{this.view.graphics.removeMany(e)})),this.pendingGraphics.clear(),this.dataExtentGraphic&&(this.view.graphics.remove(this.dataExtentGraphic),this.dataExtentGraphic=null))}showDataExtent(e){if(this.dataExtentGraphic&&(this.view.graphics.remove(this.dataExtentGraphic),this.dataExtentGraphic=null),!e)return;const t=v.j.fromExtent(e);this.dataExtentGraphic=new x.h({geometry:t,symbol:this.dataExtentSymbol}),this.view.graphics.add(this.dataExtentGraphic)}synchronizeMaps(e,t){const i=[];e.forEach(((e,r)=>{const s=this.tileFetcher.test.getFeatureTileById(r);s&&t.filter(s)||(this.view.graphics.removeMany(e),i.push(r))})),i.forEach((t=>e.delete(t))),this.tileFetcher.test.forEachFeatureTile((i=>{if(t.filter(i)&&!e.has(i.id)){const[r,s,n]=i.descriptor.lij;this.tilingScheme.ensureMaxLod(r);const a=this.tilingScheme.getExtentGeometry(r,s,n),o=[new x.h({geometry:a,symbol:t.symbols[r%t.symbols.length]}),new x.h({geometry:a.center,symbol:new b.k({verticalOffset:{screenLength:40/.75},callout:{type:"line",color:"white",border:{color:"black"}},symbolLayers:[new b.v({text:`${r}/${s}/${n}`,halo:{color:"white",size:1/.75},material:{color:"black"},size:16})]})})];e.set(i.id,o),this.view.graphics.addMany(o)}}))}}const X=n.n.getLogger("esri.layers.graphics.controllers.FeatureTileController3D");let $=class extends((0,d.d)(r.p)){constructor(e){super(e),this.type="feature-tile-3d",this.watchUpdatingTracking=new w.l,this.serviceDataExtent=null,this.serviceDataCount=te.NO_SERVICE_DATA_COUNT,this.vertexLimitExceeded=!1,this.displayFeatureLimit=null,this.suspended=!1,this.tileFetcher=null,this.handles=new c.u,this.fetchDataInfoPromise=null,this.fetchDataInfoAbortController=null,this.lifeCycleAbortController=(0,s.h)()}set extent(e){if(e&&!e.spatialReference.equals(this.layerView.view.spatialReference))return void X.error("#extent=","extent needs to be in the same spatial reference as the view");const t=this._get("extent");if(t===e)return;if(t&&e&&t.equals(e))return;const i=e?e.clone():null;this._set("extent",i)}get updating(){return!!((0,n.r)(this.tileFetcher)&&this.tileFetcher.updating||null!=this.fetchDataInfoPromise||"tiles"===this.mode&&this.layerView.view.featureTiles&&this.layerView.view.featureTiles.updating||this.watchUpdatingTracking&&this.watchUpdatingTracking.updating)}get updatingTotal(){return this.updating&&(0,n.r)(this.tileFetcher)?this.tileFetcher.updatingTotal:0}get updatingRemaining(){return this.updating&&(0,n.r)(this.tileFetcher)?this.tileFetcher.updatingRemaining:0}get expectedFeatureDiff(){return this.updating&&(0,n.r)(this.tileFetcher)?this.tileFetcher.expectedFeatureDiff:0}get memoryForUnusedFeatures(){return(0,n.r)(this.tileFetcher)?this.tileFetcher.memoryForUnusedFeatures:0}get maximumNumberOfFeaturesExceeded(){return!(!(0,n.r)(this.tileFetcher)||!this.tileFetcher.maximumNumberOfFeaturesExceeded)}get maximumNumberOfFeatures(){return(0,n.r)(this.displayFeatureLimit)?this.displayFeatureLimit.maximumNumberOfFeatures:0}set maximumNumberOfFeatures(e){e!==this.maximumNumberOfFeatures&&(null==e?this._clearOverride("maximumNumberOfFeatures"):this._override("maximumNumberOfFeatures",e))}get hasMaximumNumberOfFeaturesOverride(){return this._isOverridden("maximumNumberOfFeatures")}get mode(){const e=this.layerView.layer;if("feature"===e.type&&(0,n.r)(e.infoFor3D))return"snapshot";if(this.serviceDataCount===te.NO_SERVICE_DATA_COUNT||this.vertexLimitExceeded)return"tiles";const t=this.layerView.view,i=t&&t.featureTiles,r=i&&i.tilingScheme;if(e&&e.minScale&&this.serviceDataExtent&&r){const t=this.approximateExtentSizeAtScale(e.minScale,r);if((this.serviceDataExtent.width/t+this.serviceDataExtent.height/t)/2>te.MAX_SNAPSHOT_MIN_SCALE_FACTOR)return"tiles"}return!this.maximumNumberOfFeatures||this.serviceDataCount<=this.maximumNumberOfFeatures?"snapshot":"tiles"}get maxTotalSnapshotVertices(){const e=this._get("maxTotalSnapshotVertices")||0,t="snapshot"===this.mode&&(0,n.r)(this.tileFetcher)&&this.tileFetcher.totalVertices||0;return Math.max(e,t)}approximateExtentSizeAtScale(e,t){const i=this.layerView.view,r=Math.ceil((i.width/t.pixelSize+i.height/t.pixelSize)/2),s=t.levels[0];return r*((s.tileSize[0]/(s.scale/e)+s.tileSize[1]/(s.scale/e))/2)}get tileDescriptors(){return"snapshot"===this.mode?new u.L([{id:"dummy-tile-full-extent",lij:[0,0,0]}]):this.layerView.view.featureTiles?this.layerView.view.featureTiles.tiles:new u.L}get test(){return{fetchDataInfoPromise:this.fetchDataInfoPromise,tileFetcher:this.tileFetcher}}initialize(){this.watchUpdatingTracking.add(this,"vertexLimitInfo",(()=>this.watchUpdatingTracking.addPromise(this.updateVertexLimitExceeded(null,this.lifeCycleAbortController.signal)))),this.watchUpdatingTracking.add(this,"mode",(()=>this.modeChanged()),2),this.addResolvingPromise(Promise.resolve().then((()=>this.verifyCapabilities())).then((()=>this.watchUpdatingTracking.addPromise(this.fetchServiceDataInfo()))).then((()=>this.initializeTileFetcher())))}verifyCapabilities(){const e=this.layerView.layer;if(!e.get("capabilities.operations.supportsQuery"))throw new s.s("graphicscontroller:query-capability-required","Service requires query capabilities to be used as a feature layer",{layer:e})}destroy(){this.cancelFetchServiceDataInfo(),this.tileFetcher=(0,n.k)(this.tileFetcher),this.handles=(0,n.k)(this.handles),this.tilesHandle=(0,n.a)(this.tilesHandle),this.lifeCycleAbortController&&(this.lifeCycleAbortController.abort(),this.lifeCycleAbortController=null),this.watchUpdatingTracking.destroy(),this._set("watchUpdatingTracking",null)}suspend(){this.suspended||(this.suspended=!0,(0,n.r)(this.tileFetcher)&&this.tileFetcher.suspend())}resume(){this.suspended&&(this.suspended=!1,(0,n.r)(this.tileFetcher)&&this.tileFetcher.resume())}restart(){const e=()=>{(0,n.r)(this.tileFetcher)&&this.tileFetcher.restart()};this.watchUpdatingTracking.addPromise(this.fetchServiceDataInfo().then(e,e))}refetch(){const e=()=>{(0,n.r)(this.tileFetcher)&&this.tileFetcher.refetch()};this.watchUpdatingTracking.addPromise(this.fetchServiceDataInfo().then(e,e))}initializeTileFetcher(){const e=this.layerView.view;if(!e)return;const t=(0,a.j)(e.featureTiles,"tilingScheme",this.lifeCycleAbortController.signal);this.watchUpdatingTracking.addPromise(t),t.then((()=>{const{layerView:t,tileDescriptors:i}=this,r=t.layer,s=new V({context:this.context,filterExtent:this.extent,tileDescriptors:i,features:this.graphics});this.tileFetcher=s,this.suspended?this.tileFetcher.suspend():this.tileFetcher.resume();const n=this.layerView.view.resourceController;n&&(this.handles.add(n.memoryController.events.on("quality-changed",(e=>{s.memoryFactor=e}))),this.tileFetcher.memoryFactor=n.memoryController.memoryFactor);const o="polygon"===this.context.geometryType?"polygonLodFactor":"polyline"===this.context.geometryType?"polylineLodFactor":null;o&&this.handles.add((0,a.d)(this.layerView.view,"qualitySettings.graphics3D."+o,(e=>{s.lodFactor=e||1}))),this.watchUpdatingTracking.add(r,"createQueryVersion",(()=>this.dataFilterChanged())),this.watchUpdatingTracking.add(t,"availableFields",((e,t)=>this.availableFieldsChanged(t,e))),this.watchUpdatingTracking.add(t,"requiredFields",((e,t)=>this.requiredFieldsChanged(t,e))),this.handles.add([r.on("apply-edits",(e=>this.applyEdits(e))),this.watch("extent",(e=>s.filterExtent=e),!0),this.watch("tileDescriptors",(e=>s.tileDescriptors=e),!0),(0,a.d)(this,"maximumNumberOfFeatures",(e=>{s.maximumNumberOfFeatures=e,s.useTileCount=this.serviceDataCount>e}),!0),(0,a.d)(this,"serviceDataCount",(e=>s.useTileCount=e>this.maximumNumberOfFeatures),!0),(0,a.d)(l.T,"FEATURE_TILE_FETCH_SHOW_TILES",(t=>{t&&s&&!s.debugger?(s.debugger=new J(s,e.featureTiles.tilingScheme.toTileInfo(),e),s.debugger.update()):!t&&this.tileFetcher&&s.debugger&&(s.debugger.destroy(),s.debugger=null)}))]),this.supportsExceedsLimitQuery||this.watchUpdatingTracking.add(this,"maxTotalSnapshotVertices",(()=>this.watchUpdatingTracking.addPromise(this.updateVertexLimitExceeded(null,this.lifeCycleAbortController.signal))))})).catch((()=>{}))}modeChanged(){switch(this.mode){case"tiles":this.tilesHandle||(this.tilesHandle=this.layerView.view.featureTiles.addClient());break;default:X.warn("Unhandled feature layer mode "+this.mode);case"snapshot":(0,n.r)(this.tilesHandle)&&(this.tilesHandle.remove(),this.tilesHandle=null)}}dataFilterChanged(){this._set("maxTotalSnapshotVertices",0),this.notifyChange("maxTotalSnapshotVertices"),this.refetch()}applyEdits(e){(0,n.t)(this.tileFetcher)||this.tileFetcher.applyEdits(e).then((e=>{e&&(e.deletedFeatures.length||e.updatedFeatures.length||e.addedFeatures.length)&&this.watchUpdatingTracking.addPromise(this.updateServiceDataExtent(this.lifeCycleAbortController.signal))})).catch((e=>{if(!(0,s.g)(e))throw e}))}availableFieldsChanged(e,t){(0,n.r)(this.tileFetcher)&&ee(this.tileFetcher.availableFields,t)&&this.refetch()}requiredFieldsChanged(e,t){(0,n.r)(this.tileFetcher)&&ee(this.tileFetcher.availableFields,t)&&this.restart()}createVertexLimitExceededQuery(e){const t=this.layerView.layer,i=t.createQuery();return i.outStatistics=[new y.m({statisticType:"exceedslimit",maxVertexCount:e,outStatisticFieldName:"exceedslimit",maxPointCount:1e8,maxRecordCount:1e8})],t.capabilities.query.supportsCacheHint&&(i.cacheHint=!0),i}createDataInfoQuery(){const e=this.layerView.layer,t=e.createQuery();return t.outSpatialReference=this.layerView.view.spatialReference,e.capabilities.query.supportsCacheHint&&(t.cacheHint=!0),t}fullExtentIsAccurate(){const e=this.layerView.layer;if(e.definitionExpression)return!1;switch(e.type){case"feature":return(0,p.w)(e.url);case"csv":case"geojson":case"ogc-feature":case"wfs":return!0;default:return}}async updateServiceDataExtent(e){try{await this.tryUpdateServiceDataExtent(e)}catch(e){(0,s.g)(e)||this._set("serviceDataExtent",(0,n.y)(this.layerView.fullExtentInLocalViewSpatialReference))}}async tryUpdateServiceDataExtent(e){const t=this.layerView,i=t.layer,r=i.capabilities.query.supportsExtent,s=(0,n.y)(t.fullExtentInLocalViewSpatialReference),a=i.fullExtent,o=this.fullExtentIsAccurate(),l=this.serviceDataCount;if(r&&l<=te.MAX_FEATURE_COUNT_FOR_EXTENT&&(!s||!o)&&"queryExtent"in i){const t=this.createDataInfoQuery(),r=await i.queryExtent(t,{timeout:te.QUERY_EXTENT_TIMEOUT,signal:e});this._set("serviceDataExtent",r.extent)}else if(s)this._set("serviceDataExtent",s);else if(a){const r="portalItem"in i?i.portalItem:null,s=await(0,f.projectGeometry)(a,t.view.spatialReference,r,e);this._set("serviceDataExtent",s)}else this._set("serviceDataExtent",null)}async updateServiceDataCount(e){const t=this.layerView.layer;if(!("queryFeatureCount"in t))return void this._set("serviceDataCount",te.NO_SERVICE_DATA_COUNT);const i=await(0,h.a)(t.queryFeatureCount(this.createDataInfoQuery(),{timeout:te.QUERY_STATISTICS_TIMEOUT,signal:e}));if(!0===i.ok)this._set("serviceDataCount",i.value);else{if((0,s.g)(i.error))throw i.error;this._set("serviceDataCount",te.NO_SERVICE_DATA_COUNT)}}get vertexLimitInfo(){if((0,n.t)(this.displayFeatureLimit)||(0,n.t)(this.displayFeatureLimit.averageSymbolComplexity))return null;const{averageSymbolComplexity:e,maximumTotalNumberOfPrimitives:t}=this.displayFeatureLimit,{primitivesPerCoordinate:i,primitivesPerFeature:r}=e,s=this._get("vertexLimitInfo");return(0,n.t)(s)||s.maximumTotalNumberOfPrimitives!==t||s.primitivesPerCoordinate!==i||s.primitivesPerFeature!==r?{primitivesPerCoordinate:i,primitivesPerFeature:r,maximumTotalNumberOfPrimitives:t}:s}get supportsExceedsLimitQuery(){const e=this.layerView.layer;return e.capabilities&&e.capabilities.operations&&e.capabilities.operations.supportsExceedsLimitStatistics}get minimumNumberOfVerticesForGeometry(){switch(this.layerView.layer.geometryType){case"point":case"multipoint":return 1;case"polygon":return 4;case"polyline":return 2;case"multipatch":case"mesh":return 3;default:return 0}}async updateVertexLimitExceeded(e,t){const i=this.vertexLimitInfo;if((0,n.t)(i))return void this._set("vertexLimitExceeded",!1);const r=i.primitivesPerFeature<=0,a=this.minimumNumberOfVerticesForGeometry>1;if(!r&&!a)return void this._set("vertexLimitExceeded",!1);const{primitivesPerFeature:o,primitivesPerCoordinate:l,maximumTotalNumberOfPrimitives:u}=i;let c;0!==o&&(0,n.r)(e)&&await e;const d=this.serviceDataCount,p=d!==te.NO_SERVICE_DATA_COUNT;if(c=p?Math.ceil((u-d*o)/(l||1)):Math.ceil(u/(l||1)),a&&(c=Math.min(c,K)),p&&this.minimumNumberOfVerticesForGeometry*d>c)return void this._set("vertexLimitExceeded",!0);if(!this.supportsExceedsLimitQuery)return void this._set("vertexLimitExceeded",this.maxTotalSnapshotVertices>c);const f=await(0,h.a)(this.layerView.layer.queryFeatures(this.createVertexLimitExceededQuery(c),{timeout:te.QUERY_STATISTICS_TIMEOUT,signal:t}));if(!1===f.ok){if((0,s.g)(f.error))throw f.error;return void this._set("vertexLimitExceeded",!1)}const y=f.value.features[0];y&&y.attributes?this._set("vertexLimitExceeded",!!y.attributes.exceedslimit):this._set("vertexLimitExceeded",!1)}async fetchServiceDataInfo(){this.cancelFetchServiceDataInfo();let e=(0,s.h)();const t=e.signal,i=this.updateServiceDataCount(t),r=(0,s.A)([i,this.updateVertexLimitExceeded(i,t)]),n=r.then((()=>this.updateServiceDataExtent(t))).catch((e=>{(0,s.g)(e)||X.error("#fetchServiceDataInfo()",e)})).then((()=>{n===this.fetchDataInfoPromise&&(this.fetchDataInfoPromise=null,this.fetchDataInfoAbortController=null),e=null}));return e&&(this.fetchDataInfoPromise=n),this.fetchDataInfoAbortController=e,r.then((()=>{}),(()=>{}))}cancelFetchServiceDataInfo(){const e=this.fetchDataInfoAbortController;e&&(this.fetchDataInfoAbortController=null,this.fetchDataInfoPromise=null,e.abort())}get debug(){return{storedFeatures:(0,n.r)(this.tileFetcher)?this.tileFetcher.storedFeatures:0,totalFeatures:(0,n.r)(this.tileFetcher)?this.tileFetcher.totalFeatures:0,totalVertices:(0,n.r)(this.tileFetcher)?this.tileFetcher.totalVertices:0}}};(0,r.e)([(0,o.y)({readOnly:!0})],$.prototype,"type",void 0),(0,r.e)([(0,o.y)({constructOnly:!0})],$.prototype,"graphics",void 0),(0,r.e)([(0,o.y)({constructOnly:!0})],$.prototype,"layerView",void 0),(0,r.e)([(0,o.y)({constructOnly:!0})],$.prototype,"context",void 0),(0,r.e)([(0,o.y)()],$.prototype,"extent",null),(0,r.e)([(0,o.y)()],$.prototype,"updating",null),(0,r.e)([(0,o.y)({readOnly:!0})],$.prototype,"watchUpdatingTracking",void 0),(0,r.e)([(0,o.y)()],$.prototype,"updatingTotal",null),(0,r.e)([(0,o.y)()],$.prototype,"updatingRemaining",null),(0,r.e)([(0,o.y)()],$.prototype,"expectedFeatureDiff",null),(0,r.e)([(0,o.y)()],$.prototype,"memoryForUnusedFeatures",null),(0,r.e)([(0,o.y)()],$.prototype,"maximumNumberOfFeaturesExceeded",null),(0,r.e)([(0,o.y)({readOnly:!0})],$.prototype,"serviceDataExtent",void 0),(0,r.e)([(0,o.y)({readOnly:!0})],$.prototype,"serviceDataCount",void 0),(0,r.e)([(0,o.y)({readOnly:!0})],$.prototype,"vertexLimitExceeded",void 0),(0,r.e)([(0,o.y)()],$.prototype,"displayFeatureLimit",void 0),(0,r.e)([(0,o.y)({type:Number})],$.prototype,"maximumNumberOfFeatures",null),(0,r.e)([(0,o.y)({readOnly:!0})],$.prototype,"mode",null),(0,r.e)([(0,o.y)({readOnly:!0})],$.prototype,"maxTotalSnapshotVertices",null),(0,r.e)([(0,o.y)({readOnly:!0,dependsOn:["mode"]})],$.prototype,"tileDescriptors",null),(0,r.e)([(0,o.y)()],$.prototype,"tileFetcher",void 0),(0,r.e)([(0,o.y)()],$.prototype,"fetchDataInfoPromise",void 0),(0,r.e)([(0,o.y)({readOnly:!0})],$.prototype,"vertexLimitInfo",null),$=(0,r.e)([(0,o.n)("esri.layers.graphics.controllers.FeatureTileController3D")],$);const K=5e6;function ee(e,t){if(!t)return!1;for(const i of t)if(!e.has(i))return!0;return!1}var te,ie;(ie=te||(te={})).NO_SERVICE_DATA_COUNT=1/0,ie.MAX_SNAPSHOT_MIN_SCALE_FACTOR=5,ie.reset=function(){ie.MAX_FEATURE_COUNT_FOR_EXTENT=1e4,ie.QUERY_STATISTICS_TIMEOUT=12e3,ie.QUERY_EXTENT_TIMEOUT=1e4},te.reset();const re=e=>{let t=class extends e{constructor(){super(...arguments),this.controller=null,this.updatePolicy=1,this.suspendResumeExtentMode="computed",this.slicePlaneEnabled=!1,this.drapeSourceType=1,this.fullExtentInLocalViewSpatialReference=null,this.suspendResumeExtent=null,this._controllerCreated=!1,this.clippingExtent=null,this.supportsHeightUnitConversion=!0,this.pendingController=null,this.queryEngine=null}initialize(){const e=this.layer;"isTable"in e&&e.isTable?this.addResolvingPromise(Promise.reject(new s.s("featurelayerview:table-not-supported","table feature layer can't be displayed",{layer:e}))):(this._set("graphics3d",new S.v({owner:this,layer:e,frustumVisibilityEnabled:!0,scaleVisibilityEnabled:!0,filterVisibilityEnabled:!0,timeExtentVisibilityEnabled:!0,elevationAlignmentEnabled:!0,elevationFeatureExpressionEnabled:!0,preferredUpdatePolicy:this.updatePolicy,suspendResumeExtentMode:this.suspendResumeExtentMode,updateClippingExtent:e=>this.updateClippingExtent(e)})),this.updatingHandles.add(this,"updatePolicy",(e=>this.graphics3d.graphicsCore.preferredUpdatePolicy=e)),this.updatingHandles.add(this,"suspendResumeExtentMode",(e=>{this.graphics3d.suspendResumeExtentMode=e})),this.addResolvingPromise(this.graphics3d.setup().then((()=>this.validateGeometryType())).then((()=>this.queryEngine=new S.p({layerView:this,priority:l.p.FEATURE_QUERY_ENGINE}))).then((()=>(0,I.t)(this))).then((e=>this.fullExtentInLocalViewSpatialReference=e)).then((()=>this.initializeController()))),this.notifyChange("updating"))}destroy(){this.destroyPendingController(),this.controller=(0,n.k)(this.controller),this._set("graphics3d",(0,n.k)(this.graphics3d)),this.queryEngine=(0,n.k)(this.queryEngine),this.loadedGraphics=null}destroyPendingController(){this.pendingController&&(this.pendingController.destroy(),this.pendingController=null)}get legendEnabled(){var e,t;return this.canResume()&&!(null!=(e=this.graphics3d)&&null!=(t=e.frustumVisibility)&&t.suspended)}notifyGraphicGeometryChanged(e){this.graphics3d.graphicsCore.notifyGraphicGeometryChanged(e)}notifyGraphicVisibilityChanged(e){this.graphics3d.graphicsCore.notifyGraphicVisibilityChanged(e)}getRenderingInfo(e,t,i){const r=(0,l.a0)(e,{renderer:t,arcade:i});if((0,n.r)(r)&&r.color){const e=r.color;e[0]=e[0]/255,e[1]=e[1]/255,e[2]=e[2]/255}return r}async getRenderingInfoAsync(e,t,i,r){return(0,l.a1)(e,{renderer:t,arcade:i,...r})}getGraphicFromGraphicUid(e){var t;let i=null;return null==(t=this.loadedGraphics)||t.forEach((t=>{t.uid===e&&(i=(0,l.c)(t,this.layer))})),i}get graphics3DGraphics(){return this.graphics3d?this.graphics3d.graphicsCore.graphics3DGraphics:null}get graphics3DGraphicsByObjectID(){return this.graphics3d?this.graphics3d.graphicsCore.graphics3DGraphicsByObjectID:null}get symbolUpdateType(){return this.graphics3d?this.graphics3d.graphicsCore.symbolUpdateType:null}whenGraphicBounds(e,t){return this.graphics3d?this.graphics3d.graphicsCore.whenGraphicBounds(e,t):null}computeAttachmentOrigin(e,t){return this.graphics3d?this.graphics3d.graphicsCore.computeAttachmentOrigin(e,t):null}getSymbolLayerSize(e,t){return this.graphics3d?this.graphics3d.graphicsCore.getSymbolLayerSize(e,t):null}queryFeatures(e,t){return this.queryEngine.executeQuery(this._ensureQuery(e),(0,n.g)(t,"signal"))}queryObjectIds(e,t){return this.queryEngine.executeQueryForIds(this._ensureQuery(e),(0,n.g)(t,"signal"))}queryFeatureCount(e,t){return this.queryEngine.executeQueryForCount(this._ensureQuery(e),(0,n.g)(t,"signal"))}queryExtent(e,t){return this.queryEngine.executeQueryForExtent(this._ensureQuery(e),(0,n.g)(t,"signal"))}_ensureQuery(e){return(0,n.t)(e)?this.createQuery():y.b.from(e)}highlight(e){return this.graphics3d.highlight(e,this.layer.objectIdField)}maskOccludee(e){return this.graphics3d.maskOccludee(e)}canResume(){return super.canResume()&&(!this.graphics3d||!this.graphics3d.suspended)}getSuspendInfo(){const e=super.getSuspendInfo();return this.graphics3d?{...e,...this.graphics3d.suspendInfo}:e}isUpdating(){var e,t;return!(!this.graphics3d||this.graphics3d.destroyed||this._controllerCreated&&(null==(e=this.controller)||!e.updating)&&null!=(t=this.view.basemapTerrain)&&t.ready&&!this.graphics3d.updating)}async initializeController(){const e=this.createController();this.pendingController=e,await e.when(),this.setControllerWhenInitialized(e)}async setControllerWhenInitialized(e){try{await this.when()}catch(e){}this._controllerCreated=!0,this.notifyChange("updating"),this.isResolved()&&!this.destroyed?(await(0,a.x)(this.view,"basemapTerrain.ready"),this.beforeSetController(e),this.pendingController=null,this.controller=e,this.loadedGraphics=e.graphics,this.notifyChange("updating")):this.destroyPendingController()}updateClippingExtent(e){if(this.clippingExtent=e,!this.controller)return!1;switch(this.controller.type){case"stream":return!1;case"feature-tile-3d":return this.controller.extent=e,!0}}validateGeometryType(){switch(this.layer.geometryType){case"multipatch":case"multipoint":return Promise.reject(new s.s("featurelayerview3d:unsupported-geometry-type","Unsupported geometry type ${geometryType}",{geometryType:this.layer.geometryType}))}}_getResourceInfo(){const e=this.controller&&this.controller instanceof $?this.controller:null;return{displayedNumberOfFeatures:this.loadedGraphics.length,maximumNumberOfFeatures:e?e.maximumNumberOfFeatures:-1,totalNumberOfFeatures:e?e.serviceDataCount:-1,nodes:0,core:this.graphics3d.graphicsCore.performanceInfo,elevationUpdating:this.graphics3d.elevationAlignment.updating,visibilityFrustum:!this.graphics3d.frustumVisibility.suspended,visibilityScale:!this.graphics3d.scaleVisibility.suspended}}get performanceInfo(){return this._getResourceInfo()}};return(0,r.e)([(0,o.y)()],t.prototype,"loadedGraphics",void 0),(0,r.e)([(0,o.y)()],t.prototype,"suspended",void 0),(0,r.e)([(0,o.y)({readOnly:!0})],t.prototype,"legendEnabled",null),(0,r.e)([(0,o.y)()],t.prototype,"updating",void 0),(0,r.e)([(0,o.y)()],t.prototype,"controller",void 0),(0,r.e)([(0,o.y)()],t.prototype,"graphics3d",void 0),(0,r.e)([(0,o.y)({readOnly:!0})],t.prototype,"updatePolicy",void 0),(0,r.e)([(0,o.y)({readOnly:!0})],t.prototype,"suspendResumeExtentMode",void 0),(0,r.e)([(0,o.y)({type:Boolean})],t.prototype,"slicePlaneEnabled",void 0),(0,r.e)([(0,o.y)({readOnly:!0})],t.prototype,"suspendInfo",void 0),t=(0,r.e)([(0,o.n)("esri.views.3d.layers.FeatureLikeLayerView3D")],t),t};class se extends d.n{constructor(){super(...arguments),this._set=new Set}clear(){if(this._set.size>0){const e=this.toArray();this._set.clear(),this.emit("after-changes",{type:2}),this.emit("change",{added:[],removed:e})}}get length(){return this._set.size}addMany(e){if(0!==e.length){for(const t of e)this._set.add(t);this.emit("after-changes",{type:1}),this.emit("change",{added:e,removed:[]})}}remove(e){this._set.delete(e)&&(this.emit("after-changes",{type:2}),this.emit("change",{added:[],removed:[e]}))}removeMany(e){const t=[];for(const i of e)this._set.delete(i)&&t.push(i);t.length>0&&(this.emit("after-changes",{type:2}),this.emit("change",{added:[],removed:t}))}toArray(){return[...this._set]}find(e){let t;return(0,r.G)(this._set,(i=>!!e(i)&&(t=i,!0))),t}forEach(e){this._set.forEach((t=>e(t)))}}},88190:(e,t,i)=>{"use strict";i.d(t,{n:()=>h});var r=i(78155),s=i(32769),n=i(88903),a=(i(80219),i(13895)),o=i(15120);const l={visible:"visibleSublayers",definitionExpression:"layerDefs",labelingInfo:"hasDynamicLayers",labelsVisible:"hasDynamicLayers",opacity:"hasDynamicLayers",minScale:"visibleSublayers",maxScale:"visibleSublayers",renderer:"hasDynamicLayers",source:"hasDynamicLayers"};let h=class extends((0,s.a)(r.p)){constructor(e){super(e),this.scale=0}destroy(){this.layer=null}get dynamicLayers(){if(!this.hasDynamicLayers)return null;const e=this.visibleSublayers.map((e=>e.toExportImageJSON()));return e.length?JSON.stringify(e):null}get hasDynamicLayers(){return this.layer&&(0,o.n)(this.visibleSublayers,this.layer.serviceSublayers,this.layer)}set layer(e){this._get("layer")!==e&&(this._set("layer",e),this.handles.remove("layer"),e&&this.handles.add([e.allSublayers.on("change",(()=>this.notifyChange("visibleSublayers"))),e.on("sublayer-update",(e=>this.notifyChange(l[e.propertyName])))],"layer"))}get layers(){const e=this.visibleSublayers;return e?e.length?"show:"+e.map((e=>e.id)).join(","):"show:-1":null}get layerDefs(){const e=this.visibleSublayers.filter((e=>null!=e.definitionExpression));return e.length?JSON.stringify(e.reduce(((e,t)=>(e[t.id]=t.definitionExpression,e)),{})):null}get version(){this.commitProperty("layers"),this.commitProperty("layerDefs"),this.commitProperty("dynamicLayers"),this.commitProperty("timeExtent");const e=this.layer;return e&&(e.commitProperty("dpi"),e.commitProperty("imageFormat"),e.commitProperty("imageTransparency"),e.commitProperty("gdbVersion")),(this._get("version")||0)+1}get visibleSublayers(){const e=[];if(!this.layer)return e;const t=this.layer.sublayers,i=t=>{const r=this.scale,s=0===r,n=0===t.minScale||r<=t.minScale,a=0===t.maxScale||r>=t.maxScale;t.visible&&(s||n&&a)&&(t.sublayers?t.sublayers.forEach(i):e.unshift(t))};t&&t.forEach(i);const r=this._get("visibleSublayers");return!r||r.length!==e.length||r.some(((t,i)=>e[i]!==t))?e:r}toJSON(){const e=this.layer;let t={dpi:e.dpi,format:e.imageFormat,transparent:e.imageTransparency,gdbVersion:e.gdbVersion||null};return this.hasDynamicLayers&&this.dynamicLayers?t.dynamicLayers=this.dynamicLayers:t={...t,layers:this.layers,layerDefs:this.layerDefs},t}};(0,r.e)([(0,n.y)({readOnly:!0})],h.prototype,"dynamicLayers",null),(0,r.e)([(0,n.y)({readOnly:!0})],h.prototype,"hasDynamicLayers",null),(0,r.e)([(0,n.y)()],h.prototype,"layer",null),(0,r.e)([(0,n.y)({readOnly:!0})],h.prototype,"layers",null),(0,r.e)([(0,n.y)({readOnly:!0})],h.prototype,"layerDefs",null),(0,r.e)([(0,n.y)({type:Number})],h.prototype,"scale",void 0),(0,r.e)([(0,n.y)(a.u)],h.prototype,"timeExtent",void 0),(0,r.e)([(0,n.y)({readOnly:!0})],h.prototype,"version",null),(0,r.e)([(0,n.y)({readOnly:!0})],h.prototype,"visibleSublayers",null),h=(0,r.e)([(0,n.n)("esri.layers.mixins.ExportImageParameters")],h)},10594:(e,t,i)=>{"use strict";i.d(t,{S:()=>v});var r=i(78155),s=i(20215),n=i(88903),a=(i(80219),i(98548)),o=i(58404),l=i(92858),h=i(25290),u=i(12046),c=i(93443),d=i(29218);const p=Math.PI/180;function f(e){return e*p}function y(e,t){const i=f(t.rotation),r=Math.abs(Math.cos(i)),s=Math.abs(Math.sin(i)),[n,a]=t.size;return e[0]=Math.round(a*s+n*r),e[1]=Math.round(a*r+n*s),e}const m=(0,o.i)(),g=[0,0],_=new d.e(0,0,0,0);let x=class extends r.p{constructor(e){super(e),this._imagePromise=null,this.bitmaps=[],this.hidpi=false,this.imageMaxWidth=2048,this.imageMaxHeight=2048,this.imageRotationSupported=false,this.imageNormalizationSupported=false,this.update=(0,s.B)((async(e,t)=>{if(!e.stationary||this.destroyed)return null;const i=e.state,r=(0,l.S)(i.spatialReference),s=this.hidpi?e.pixelRatio:1,n=this.imageNormalizationSupported&&i.worldScreenWidth&&i.worldScreenWidth<i.size[0];n?(g[0]=i.worldScreenWidth,g[1]=i.size[1]):this.imageRotationSupported?(g[0]=i.size[0],g[1]=i.size[1]):y(g,i);const a=Math.floor(g[0]*s)>this.imageMaxWidth||Math.floor(g[1]*s)>this.imageMaxHeight,o=r&&(i.extent.xmin<r.valid[0]||i.extent.xmax>r.valid[1]),h=!this.imageNormalizationSupported&&o,u=!a&&!h,c=this.imageRotationSupported?i.rotation:0;if(u){const e=n?i.paddedViewState.center:i.center;this._imagePromise=this._singleExport(i,g,e,i.resolution,c,s,t)}else{let e=Math.min(this.imageMaxWidth,this.imageMaxHeight);h&&(e=Math.min(i.worldScreenWidth,e)),this._imagePromise=this._tiledExport(i,e,c,s,t)}return this._imagePromise.then((async e=>{if(this._imagePromise=null,!this.destroyed){this.bitmaps=null!=e?e:[];for(const t of this.container.children)e.includes(t)||t.fadeOut().then((()=>{t.remove()}));for(const t of e)this.container.addChild(t),t.fadeIn()}})).catch((e=>{throw this._imagePromise=null,e}))}),5e3)}destroy(){this.bitmaps=[]}get updating(){return!this.destroyed&&null!==this._imagePromise}updateExports(e){for(const t of this.container.children){if(!t.visible||!t.stage)return;e(t),t.invalidateTexture(),t.requestRender()}}async _export(e,t,i,r,s,n){const a=await this.fetchSource(e,Math.floor(t*s),Math.floor(i*s),{rotation:r,pixelRatio:s,signal:n}),o=new u.g(a,"additive");return o.x=e.xmin,o.y=e.ymax,o.resolution=e.width/t,o.rotation=r,o.pixelRatio=s,o}async _singleExport(e,t,i,r,s,n,o){!function(e,t,i,r){const[s,n]=t,[a,o]=r,l=.5*i;e[0]=s-l*a,e[1]=n-l*o,e[2]=s+l*a,e[3]=n+l*o}(m,i,r,t);const l=new a.M(m[0],m[1],m[2],m[3],e.spatialReference);return[await this._export(l,t[0],t[1],s,n,o)]}_tiledExport(e,t,i,r,s){const n=h.S.create({size:t,spatialReference:e.spatialReference,scales:[e.scale]}),o=new c.h(n),l=o.getTileCoverage(e);if(!l)return null;const u=[];return l.forEach(((n,l,h,c)=>{_.set(n,l,h,c),o.getTileBounds(m,_);const d=new a.M(m[0],m[1],m[2],m[3],e.spatialReference);u.push(this._export(d,t,t,i,r,s))})),Promise.all(u)}};(0,r.e)([(0,n.y)()],x.prototype,"_imagePromise",void 0),(0,r.e)([(0,n.y)()],x.prototype,"bitmaps",void 0),(0,r.e)([(0,n.y)()],x.prototype,"container",void 0),(0,r.e)([(0,n.y)()],x.prototype,"fetchSource",void 0),(0,r.e)([(0,n.y)()],x.prototype,"hidpi",void 0),(0,r.e)([(0,n.y)()],x.prototype,"imageMaxWidth",void 0),(0,r.e)([(0,n.y)()],x.prototype,"imageMaxHeight",void 0),(0,r.e)([(0,n.y)()],x.prototype,"imageRotationSupported",void 0),(0,r.e)([(0,n.y)()],x.prototype,"imageNormalizationSupported",void 0),(0,r.e)([(0,n.y)()],x.prototype,"requestUpdate",void 0),(0,r.e)([(0,n.y)()],x.prototype,"updating",null),x=(0,r.e)([(0,n.n)("esri.views.2d.layers.support.ExportStrategy")],x);var v=x},10662:(e,t,i)=>{"use strict";i.d(t,{l:()=>o});var r=i(78155),s=i(32769),n=i(88903);i(80219);const a={visible:"visibleSublayers"};let o=class extends((0,s.a)(r.p)){constructor(e){super(e),this.scale=0}set layer(e){this._get("layer")!==e&&(this._set("layer",e),this.handles.remove("layer"),e&&this.handles.add([e.sublayers.on("change",(()=>this.notifyChange("visibleSublayers"))),e.on("wms-sublayer-update",(e=>this.notifyChange(a[e.propertyName])))],"layer"))}get layers(){const{visibleSublayers:e}=this;return e.filter((e=>e.name)).map((e=>e.name)).join(",")}get version(){this.commitProperty("layers");const e=this.layer;return e&&e.commitProperty("imageTransparency"),(this._get("version")||0)+1}get visibleSublayers(){const{layer:e,scale:t}=this,i=null==e?void 0:e.sublayers,r=[],s=e=>{const{minScale:i,maxScale:n,sublayers:a,visible:o}=e;o&&(0===t||(0===i||t<=i)&&(0===n||t>=n))&&(a?a.forEach(s):r.unshift(e))};return null==i||i.forEach(s),r}toJSON(){const{layer:e,layers:t}=this,{imageFormat:i,imageTransparency:r,version:s}=e;return{format:i,request:"GetMap",service:"WMS",styles:"",transparent:r,version:s,layers:t}}};(0,r.e)([(0,n.y)()],o.prototype,"layer",null),(0,r.e)([(0,n.y)({readOnly:!0})],o.prototype,"layers",null),(0,r.e)([(0,n.y)({type:Number})],o.prototype,"scale",void 0),(0,r.e)([(0,n.y)({readOnly:!0})],o.prototype,"version",null),(0,r.e)([(0,n.y)({readOnly:!0})],o.prototype,"visibleSublayers",null),o=(0,r.e)([(0,n.n)("esri.layers.support.ExportWMSImageParameters")],o)},3805:(e,t,i)=>{"use strict";i.d(t,{o:()=>T,r:()=>_}),i(33807);var r=i(43356),s=i(6783),n=i(20215),a=i(13564),o=i(80219),l=i(93875),h=i(14215),u=i(5772),c=i(25894),d=i(79061),p=i(17762),f=i(94527),y=i(65352),m=i(4618),g=i(732);class _ extends s.r{constructor(e,t){super(e,t,[r.o,r.o])}}const x=o.n.getLogger("esri.views.2d.engine.webgl.AttributeStoreView"),v=(0,c.n)(c.l,x),b=e=>2147483647&e;class w{constructor(e,t,i){this._texture=null,this._lastTexture=null,this._fbos={},this.texelSize=4;const{buffer:r,pixelType:s,textureOnly:n}=e,a=(0,u.H)(s);this.shared=i,this.pixelType=s,this.size=t,this.textureOnly=n,n||(this.data=new a((0,o.f)(r))),this._resetRange()}destroy(){(0,o.A)(this._texture,(e=>e.dispose()));for(const e in this._fbos)(0,o.A)(this._fbos[e],(t=>{"0"===e&&t.detachColorTexture(),t.dispose()})),this._fbos[e]=null;this._texture=null}get _textureDesc(){return{target:3553,wrapMode:33071,pixelFormat:6408,dataType:this.pixelType,samplingMode:9728,width:this.size,height:this.size}}setData(e,t,i){const r=b(e),s=(0,o.f)(this.data),n=r*this.texelSize+t;!s||n>=s.length||(s[n]=i,this.dirtyStart=Math.min(this.dirtyStart,r),this.dirtyEnd=Math.max(this.dirtyEnd,r))}getData(e,t){if((0,o.t)(this.data))return null;const i=b(e)*this.texelSize+t;return!this.data||i>=this.data.length?null:this.data[i]}getTexture(e){return(0,o.q)(this._texture,(()=>this._initTexture(e)))}getFBO(e,t=0){if((0,o.t)(this._fbos[t])){const i={colorTarget:0,depthStencilTarget:0},r=0===t?this.getTexture(e):this._textureDesc;this._fbos[t]=new l.o(e,i,r)}return this._fbos[t]}get locked(){return!(5121!==this.pixelType||!this.shared||this.textureOnly||!(0,o.c)("esri-atomics")||!this.data)&&1===Atomics.load(this.data,0)}get hasDirty(){const e=this.dirtyStart;return this.dirtyEnd>=e}updateTexture(e,t){if(!this.locked){try{const t=this.dirtyStart,i=this.dirtyEnd;if(!this.hasDirty)return;this._resetRange();const r=(0,o.f)(this.data).buffer,s=this.getTexture(e),a=4,l=(t-t%this.size)/this.size,h=(i-i%this.size)/this.size,c=l,d=this.size,p=h,f=l*this.size*a,y=(d+p*this.size)*a-f,m=(0,u.H)(this.pixelType),g=new m(r,f*m.BYTES_PER_ELEMENT,y),_=this.size,v=p-c+1;if(v>this.size)return void x.error(new n.s("mapview-webgl","Out-of-bounds index when updating AttributeData"));s.updateData(0,0,c,_,v,g)}catch(e){}t()}}update(e){const{data:t,start:i,end:r}=e;if((0,o.r)(t)){const r=this.data,s=i*this.texelSize;for(let i=0;i<t.length;i++){const n=1<<i%this.texelSize;e.layout&n&&(r[s+i]=t[i])}}this.dirtyStart=Math.min(this.dirtyStart,i),this.dirtyEnd=Math.max(this.dirtyEnd,r)}resize(e,t){const i=this.size;if(this.size=t,this.textureOnly)return void(i!==this.size&&(this._lastTexture=this._texture,this._texture=null));const r=(0,u.H)(this.pixelType);this.destroy(),this.data=new r((0,o.f)(e.buffer))}_resetRange(){this.dirtyStart=2147483647,this.dirtyEnd=0}_initTexture(e){const t=new h.r(e,this._textureDesc,(0,o.q)(this.data,void 0));if((0,o.r)(this._lastTexture)&&this._fbos[0]){const i=this._lastTexture.descriptor.width,r=this._lastTexture.descriptor.height,s=this._lastTexture.descriptor.dataType,n=this._lastTexture.descriptor.pixelFormat,a=this.getFBO(e),o=(0,u.G)(s),l=new((0,u.H)(s))(new ArrayBuffer(i*r*o*this.texelSize)),h=e.getBoundFramebufferObject(),{x:c,y:d,width:p,height:f}=e.getViewport();e.bindFramebuffer(a),a.readPixels(0,0,i,r,n,s,l),t.updateData(0,0,0,2*i,r/2,l),e.setViewport(c,d,p,f),e.bindFramebuffer(h)}return this.destroy(),this._texture=t,this._texture}}class S{constructor(e){this._onUpdate=e,this._initialized=!1,this._forceNextUpload=!1,this._locked=!1}initialize(e){const{blocks:t,shared:i,size:r}=e;if(this.shared=i,this.size=r,v("Initializing AttributeStoreView",e),(0,o.t)(this._data))this._data=(0,o.P)(t,(e=>new w(e,r,i)));else for(let e=0;e<this._data.length;e++){const s=this._data[e],n=t[e];(0,o.r)(n)&&((0,o.t)(s)?this._data[e]=new w(n,r,i):s.resize(n,r))}this._initialized=!0}destroy(){(0,o.A)(this._data,(e=>(0,o.P)(e,(e=>e.destroy())))),(0,o.A)(this._defaultTexture,(e=>e.dispose()))}isUpdating(){const e=this._data;if((0,o.t)(e))return!0;const t=(0,o.r)(this._pendingAttributeUpdate),i=t;return(0,o.c)("esri-2d-log-updating")&&console.log(`Updating AttributeStoreView ${i}\n  -> hasPendingUpdate ${t}`),i}getBlock(e){return(0,o.t)(this._data)?null:this._data[e]}setLabelMinZoom(e,t){this.setData(e,0,1,t)}getLabelMinZoom(e){return this.getData(e,0,1,255)}getFilterFlags(e){return this.getData(e,0,0,0)}getVVSize(e){return this.getData(e,r.K,0,0)}getData(e,t,i,r){if(!this._data)return 0;const s=(0,o.f)(this._data)[t];if((0,o.t)(s))return 0;const n=s.getData(e,i);return(0,o.r)(n)?n:r}setData(e,t,i,r){const s=(0,o.f)(this._data)[t];(0,o.f)(s).setData(e,i,r)}lockTextureUpload(){this._locked=!0}unlockTextureUpload(){this._locked=!1}forceTextureUpload(){this._forceNextUpload=!0}async requestUpdate(e){if(this._pendingAttributeUpdate)return void x.error(new n.s("mapview-webgl","Tried to update attribute data with a pending update"));const t=(0,n.D)();return v("AttributeStoreView Update Requested",e),this._pendingAttributeUpdate={data:e,resolver:t},t.promise}update(){if(this._initialized&&(0,o.r)(this._pendingAttributeUpdate)){const{data:e,resolver:t}=this._pendingAttributeUpdate,i=(0,o.f)(this._data);for(let t=0;t<e.blocks.length;t++){const r=e.blocks[t],s=i[t];(0,o.A)(s,(e=>(0,o.A)(r,(i=>{v(`Updating block ${t}`,i),e.update(i)}))))}this._pendingAttributeUpdate=null,t(),this._onUpdate()}}bindTextures(e){this.update();const t=this._getDefaultTexture(e);if(!this._initialized)return e.bindTexture(t,r.A),e.bindTexture(t,r.B),e.bindTexture(t,r.C),void e.bindTexture(t,r.D);const i=(0,o.f)(this._data);this._locked&&!this._forceNextUpload||((0,o.Q)(i,(t=>t.updateTexture(e,(()=>this._onUpdate())))),this._forceNextUpload=!1),e.bindTexture((0,o.v)(i[0],t,(t=>t.getTexture(e))),r.A),e.bindTexture((0,o.v)(i[1],t,(t=>t.getTexture(e))),r.B),e.bindTexture((0,o.v)(i[2],t,(t=>t.getTexture(e))),r.C),e.bindTexture((0,o.v)(i[3],t,(t=>t.getTexture(e))),r.D)}_getDefaultTexture(e){if((0,o.t)(this._defaultTexture)){const t={wrapMode:33071,pixelFormat:6408,dataType:5121,samplingMode:9728,width:1,height:1};this._defaultTexture=new h.r(e,t,new Uint8Array(4))}return this._defaultTexture}}function I(e,t){const i=t.length;if(e<t[0].value||1===i)return t[0].size;for(let r=1;r<i;r++)if(e<t[r].value){const i=(e-t[r-1].value)/(t[r].value-t[r-1].value);return t[r-1].size+i*(t[r].size-t[r-1].size)}return t[i-1].size}function C(e,t,i=0){if((0,o.t)(t))return e[i+0]=0,e[i+1]=0,e[i+2]=0,void(e[i+3]=0);const{r,g:s,b:n,a}=t;e[i+0]=r*a/255,e[i+1]=s*a/255,e[i+2]=n*a/255,e[i+3]=a}class M{constructor(){this.symbolLevels=[],this.vvColorValues=new Float32Array(8),this.vvColors=new Float32Array(32),this.vvOpacityValues=new Float32Array(8),this.vvOpacities=new Float32Array(8),this.vvSizeMinMaxValue=new Float32Array(4),this.ddColors=new Float32Array(32),this.ddBackgroundColor=new Float32Array(4),this.ddActiveDots=new Float32Array(8),this._vvMaterialParameters={vvSizeEnabled:!1,vvColorEnabled:!1,vvRotationEnabled:!1,vvRotationType:"geographic",vvOpacityEnabled:!1}}getSizeVVFieldStops(e){const t=this._vvSizeFieldStops;switch(t.type){case"static":return t;case"level-dependent":return(0,o.q)(t.levels[e],(()=>{let i=1/0,r=0;for(const s in t.levels){const t=parseFloat(s),n=Math.abs(e-t);n<i&&(i=n,r=t)}if(i===1/0)return{sizes:new Float32Array([0,0,0,0,0,0]),values:new Float32Array([0,0,0,0,0,0])};const s=2**((e-r)/2),n=(0,o.f)(t.levels[r]),a=new Float32Array(n.values);return a[2]*=s,a[3]*=s,{sizes:(0,o.f)(n.sizes),values:a}}))}}get vvMaterialParameters(){return this._vvMaterialParameters}update(e){(0,o.r)(this._vvInfo)&&this._updateVisualVariables(this._vvInfo.vvRanges,e)}setInfo(e,t,i){switch((0,o.r)(i)&&i.forEach((e=>this._updateEffects(e))),this._vvInfo=t,e.type){case"dot-density":this._updateDotDensityInfo(e)}}getVariation(){return{ddDotBlending:this.ddDotBlending,outsideLabelsVisible:this.outsideLabelsVisible,oesTextureFloat:(0,g.r)().supportsTextureFloat}}getVariationHash(){return(this.ddDotBlending?1:0)|(this.outsideLabelsVisible?1:0)<<1}_updateEffects(e){(0,o.r)(e)&&e.filter&&e.filter.enabled&&(this.outsideLabelsVisible=e.excludedLabelsVisible)}_updateVisualVariables(e,t){const i=this._vvMaterialParameters;if(i.vvOpacityEnabled=!1,i.vvSizeEnabled=!1,i.vvColorEnabled=!1,i.vvRotationEnabled=!1,!e)return;const r=e.size;if(r){if(i.vvSizeEnabled=!0,r.minMaxValue){const e=r.minMaxValue;let i,s;if((0,u.N)(e.minSize)&&(0,u.N)(e.maxSize))if((0,u.K)(e.minSize)&&(0,u.K)(e.maxSize))i=(0,f.u)(e.minSize),s=(0,f.u)(e.maxSize);else{const r=t.scale;i=(0,f.u)(I(r,e.minSize.stops)),s=(0,f.u)(I(r,e.maxSize.stops))}this.vvSizeMinMaxValue.set([e.minDataValue,e.maxDataValue,i,s])}if(r.scaleStops&&(this.vvSizeScaleStopsValue=(0,f.u)(I(t.scale,r.scaleStops.stops))),r.unitValue){const e=(0,y.G)(t.spatialReference)/m.m[r.unitValue.unit];this.vvSizeUnitValueToPixelsRatio=e/t.resolution}r.fieldStops&&(this._vvSizeFieldStops=r.fieldStops)}const s=e.color;s&&(i.vvColorEnabled=!0,this.vvColorValues.set(s.values),this.vvColors.set(s.colors));const n=e.opacity;n&&(i.vvOpacityEnabled=!0,this.vvOpacityValues.set(n.values),this.vvOpacities.set(n.opacities));const a=e.rotation;a&&(i.vvRotationEnabled=!0,i.vvRotationType=a.type)}_updateDotDensityInfo(e){const t=e.attributes;this.ddDotValue=e.dotValue,this.ddDotScale=e.referenceScale,this.ddDotSize=e.dotSize,this.ddDotBlending=e.dotBlendingEnabled,this.ddSeed=e.seed;for(let e=0;e<r.r;e++){const i=e>=t.length?new p.o([0,0,0,0]):t[e].color;C(this.ddColors,i,4*e)}for(let t=0;t<8;t++)this.ddActiveDots[t]=t<e.attributes.length?1:0;C(this.ddBackgroundColor,e.backgroundColor)}}class T extends d.o{constructor(e){super(e),this._rendererInfo=new M,this._materialItemsRequestQueue=new a.e,this.attributeView=new S((()=>this.onAttributeStoreUpdate()))}destroy(){this.removeAllChildren(),this.children.forEach((e=>e.destroy())),this.attributeView.destroy(),this._materialItemsRequestQueue.clear()}setRendererInfo(e,t,i){this._rendererInfo.setInfo(e,t,i),this.requestRender()}async getMaterialItems(e,t){if(!e||0===e.length)return null;const i=(0,n.D)();return this._materialItemsRequestQueue.push({items:e,abortOptions:t,resolver:i}),this.requestRender(),i.promise}doRender(e){if(e.context.capabilities.enable("textureFloat"),e.context.capabilities.enable("vao"),this._materialItemsRequestQueue.length>0){let t=this._materialItemsRequestQueue.pop();for(;t;)this._processMaterialItemRequest(e,t),t=this._materialItemsRequestQueue.pop()}super.doRender(e)}renderChildren(e){for(const t of this.children)t.commit(e);this._rendererInfo.update(e.state),super.renderChildren(e)}createRenderParams(e){return{...super.createRenderParams(e),rendererInfo:this._rendererInfo,attributeView:this.attributeView}}onAttributeStoreUpdate(){}_processMaterialItemRequest(e,{items:t,abortOptions:i,resolver:r}){const{painter:s,pixelRatio:n}=e,a=t.map((e=>s.textureManager.rasterizeItem(e.symbol,n,e.glyphIds,i)));Promise.all(a).then((e=>{if(!this.stage)return void r.reject();const i=e.map(((e,i)=>({id:t[i].id,mosaicItem:e})));r.resolve(i)}),r.reject)}}},31393:(e,t,i)=>{"use strict";i.d(t,{y:()=>y});var r,s=i(78155),n=i(80987),a=i(91236),o=i(31531),l=i(80219),h=i(88903),u=i(89710),c=i(18143);const d=new o.o({esriSpatialRelIntersects:"intersects",esriSpatialRelContains:"contains",esriSpatialRelCrosses:"crosses",esriSpatialRelDisjoint:"disjoint",esriSpatialRelEnvelopeIntersects:"envelope-intersects",esriSpatialRelIndexIntersects:"index-intersects",esriSpatialRelOverlaps:"overlaps",esriSpatialRelTouches:"touches",esriSpatialRelWithin:"within",esriSpatialRelRelation:"relation"}),p=new o.o({esriSRUnit_Meter:"meters",esriSRUnit_Kilometer:"kilometers",esriSRUnit_Foot:"feet",esriSRUnit_StatuteMile:"miles",esriSRUnit_NauticalMile:"nautical-miles",esriSRUnit_USNauticalMile:"us-nautical-miles"});let f=r=class extends s.a{constructor(e){super(e),this.where=null,this.geometry=null,this.spatialRelationship="intersects",this.hiddenIds=new Set,this.distance=void 0,this.objectIds=null,this.units=null,this.timeExtent=null,this.enabled=!1}writeWhere(e,t){t.where=e||"1=1"}enable(){this._set("enabled",!0)}createQuery(e={}){const{where:t,geometry:i,spatialRelationship:r,timeExtent:s,objectIds:n,units:a,distance:o}=this;return new c.b({geometry:(0,l.y)(i),objectIds:(0,l.y)(n),spatialRelationship:r,timeExtent:(0,l.y)(s),where:t,units:a,distance:o,...e})}clone(){const{where:e,geometry:t,spatialRelationship:i,hiddenIds:s,timeExtent:n,objectIds:a,units:o,distance:h}=this,u=new Set;return s.forEach((e=>u.add(e))),new r({geometry:(0,l.y)(t),hiddenIds:u,objectIds:(0,l.y)(a),spatialRelationship:i,timeExtent:(0,l.y)(n),where:e,units:o,distance:h})}};(0,s.e)([(0,h.y)({type:String})],f.prototype,"where",void 0),(0,s.e)([(0,s.o)("where")],f.prototype,"writeWhere",null),(0,s.e)([(0,h.y)({types:n.e,json:{read:u.p,write:!0}})],f.prototype,"geometry",void 0),(0,s.e)([(0,h.y)({type:String,json:{read:{source:"spatialRel",reader:d.read},write:{target:"spatialRel",writer:d.write}}})],f.prototype,"spatialRelationship",void 0),(0,s.e)([(0,h.y)({json:{write:(e,t,i)=>t[i]=Array.from(e),read:e=>new Set(e)}})],f.prototype,"hiddenIds",void 0),(0,s.e)([(0,h.y)({type:Number,json:{write:{overridePolicy:e=>({enabled:e>0})}}})],f.prototype,"distance",void 0),(0,s.e)([(0,h.y)({type:[Number],json:{write:!0}})],f.prototype,"objectIds",void 0),(0,s.e)([(0,h.y)({type:String,json:{read:p.read,write:{writer:p.write,overridePolicy(e){return{enabled:e&&this.distance>0}}}}})],f.prototype,"units",void 0),(0,s.e)([(0,h.y)({type:a.y,json:{write:!0}})],f.prototype,"timeExtent",void 0),(0,s.e)([(0,h.y)({readOnly:!0})],f.prototype,"enabled",void 0),f=r=(0,s.e)([(0,h.n)("esri.views.layers.support.FeatureFilter")],f);var y=f},47473:(e,t,i)=>{"use strict";i.d(t,{R:()=>g,l:()=>y});var r,s=i(78155),n=i(20215),a=i(80219),o=i(36845),l=i(88903),h=i(13895),u=i(52957),c=i(18143),d=i(31393),p=i(81578);let f=r=class extends s.a{constructor(){super(...arguments),this.filter=null,this.includedEffect=null,this.excludedEffect=null,this.excludedLabelsVisible=!1}clone(){return new r({filter:this.filter&&this.filter.clone(),includedEffect:this.includedEffect,excludedEffect:this.excludedEffect,excludedLabelsVisible:this.excludedLabelsVisible})}};(0,s.e)([(0,l.y)({type:d.y,json:{write:!0}})],f.prototype,"filter",void 0),(0,s.e)([(0,l.y)({json:{write:!0}})],f.prototype,"includedEffect",void 0),(0,s.e)([(0,l.y)({json:{write:!0}})],f.prototype,"excludedEffect",void 0),(0,s.e)([(0,l.y)({type:Boolean,json:{write:!0}})],f.prototype,"excludedLabelsVisible",void 0),f=r=(0,s.e)([(0,l.n)("esri.views.layers.support.FeatureEffect")],f);var y=f;const m=a.n.getLogger("esri.views.layers.FeatureLayerView"),g=e=>{let t=class extends e{constructor(...e){super(...e),this._updatingRequiredFieldsPromise=null,this.effect=null,this.filter=null,this.timeExtent=null,this.layer=null,this.requiredFields=[],this.view=null}initialize(){(0,o.d)(this,["layer.renderer","layer.labelingInfo","layer.elevationInfo.featureExpressionInfo","layer.displayField","filter","effect","layer.timeInfo","layer.floorInfo","timeExtent"],(()=>this._handleRequiredFieldsChange()),!0),(0,o.C)(this,"view.floors","change",(()=>this._handleRequiredFieldsChange())),(0,o.C)(this,"layer.sublayer","change",(()=>this._handleRequiredFieldsChange()))}get availableFields(){const{layer:e,layer:{fieldsIndex:t},requiredFields:i}=this;return"outFields"in e&&e.outFields?(0,u.p)(t,[...(0,u.I)(t,e.outFields),...i]):(0,u.p)(t,i)}get maximumNumberOfFeatures(){return 0}set maximumNumberOfFeatures(e){m.error("#maximumNumberOfFeatures=","Setting maximum number of features is not supported")}get maximumNumberOfFeaturesExceeded(){return!1}highlight(e){throw new Error("missing implementation")}createQuery(){const e={outFields:["*"],returnGeometry:!0,outSpatialReference:this.view.spatialReference},t=(0,a.r)(this.filter)?this.filter.createQuery(e):new c.b(e);return(0,a.r)(this.timeExtent)&&(t.timeExtent=(0,a.r)(t.timeExtent)?t.timeExtent.intersection(this.timeExtent):this.timeExtent.clone()),t}queryFeatures(e,t){throw new Error("missing implementation")}queryObjectIds(e,t){throw new Error("missing implementation")}queryFeatureCount(e,t){throw new Error("missing implementation")}queryExtent(e,t){throw new Error("missing implementation")}_loadArcadeModules(e){if(e.get("expressionInfos.length"))return(0,u.a)()}_handleRequiredFieldsChange(){const e=this._updateRequiredFields();this._set("_updatingRequiredFieldsPromise",e),e.then((()=>{this._updatingRequiredFieldsPromise===e&&this._set("_updatingRequiredFieldsPromise",null)}))}async _updateRequiredFields(){if(!this.layer||!this.view)return;const e="3d"===this.view.type,{layer:t,layer:{fieldsIndex:i,objectIdField:r}}=this,s="renderer"in t&&t.renderer,o=t.featureReduction,l=new Set,h=await(0,n.A)([s?s.collectRequiredFields(l,i):null,(0,u.L)(l,t),e?(0,u.A)(l,t):null,(0,a.r)(this.filter)?(0,u.V)(l,t,this.filter):null,this.effect?(0,u.V)(l,t,this.effect.filter):null,o?(0,u.E)(l,t,o):null]);if(t.timeInfo&&this.timeExtent&&(0,u.g)(l,t.fieldsIndex,[t.timeInfo.startField,t.timeInfo.endField]),"feature"===t.type&&t.floorInfo&&(0,u.g)(l,t.fieldsIndex,[t.floorInfo.floorField]),"subtype-group"===t.type){(0,u.F)(l,i,t.subtypeField);const e=t.sublayers.map((e=>{var t;return Promise.all([null==(t=e.renderer)?void 0:t.collectRequiredFields(l,i),(0,u.L)(l,e)])}));await(0,n.A)(e)}for(const e of h)e.error&&m.error(e.error);(0,u.F)(l,i,r),e&&"displayField"in t&&t.displayField&&(0,u.F)(l,i,t.displayField);const c=Array.from(l).sort();this._set("requiredFields",c)}validateFetchPopupFeatures(e){if((0,a.t)(e))return null;for(const t of e.clientGraphics){const i=t.layer;if("popupEnabled"in i&&!i.popupEnabled)return new n.s("featurelayerview:fetchPopupFeatures","Popups are disabled",{layer:i});if("popupTemplate"in i&&!(0,p.d)(i,e))return new n.s("featurelayerview:fetchPopupFeatures","Layer does not define a popup template",{layer:i})}}async fetchClientPopupFeatures(e){const t=(0,a.r)(e)?e.clientGraphics:null;if(!t||0===t.length)return Promise.resolve([]);const i=[],r=[],s=await this.createPopupQuery(e);for(const n of t){const{layer:t}=n;if(!("popupEnabled"in t))continue;const o=(0,u.I)(this.layer.fieldsIndex,s.outFields),l=(0,p.d)(t,e);if(!(0,a.r)(l))continue;const h=await this._loadArcadeModules(l);h&&h.arcadeUtils.hasGeometryOperations(l)||!(0,u.f)(o,n)?r.push(n):i.push(n)}return"stream"===this.layer.type||0===r.length?Promise.resolve(i):(s.objectIds=r.map((e=>e.attributes[this.layer.objectIdField])),this.layer.queryFeatures(s).then((e=>i.concat(e.features))).catch((()=>r)))}async createPopupQuery(e){const t=this.layer.createQuery(),i=new Set;let r=!1;const s=(0,a.r)(e)&&e.clientGraphics?e.clientGraphics.map((e=>e.layer)):[this.layer];for(const t of s){if(!("popupEnabled"in t))continue;const s=(0,p.d)(t,e);if(!(0,a.r)(s))continue;const n=await this._loadArcadeModules(s),o=n&&n.arcadeUtils.hasGeometryOperations(s);r=!("point"!==this.layer.geometryType&&!o);const l=await(0,p.t)(this.layer,s);for(const e of l)i.add(e)}return t.returnGeometry=r,t.returnZ=r,t.returnM=r,t.outFields=Array.from(i),t.outSpatialReference=this.view.spatialReference,t}canResume(){return!(!super.canResume()||(0,a.r)(this.timeExtent)&&this.timeExtent.isEmpty)}};return(0,s.e)([(0,l.y)()],t.prototype,"_updatingRequiredFieldsPromise",void 0),(0,s.e)([(0,l.y)({readOnly:!0})],t.prototype,"availableFields",null),(0,s.e)([(0,l.y)({type:y})],t.prototype,"effect",void 0),(0,s.e)([(0,l.y)({type:d.y})],t.prototype,"filter",void 0),(0,s.e)([(0,l.y)(h.u)],t.prototype,"timeExtent",void 0),(0,s.e)([(0,l.y)()],t.prototype,"layer",void 0),(0,s.e)([(0,l.y)({type:Number})],t.prototype,"maximumNumberOfFeatures",null),(0,s.e)([(0,l.y)({readOnly:!0,type:Boolean})],t.prototype,"maximumNumberOfFeaturesExceeded",null),(0,s.e)([(0,l.y)({readOnly:!0})],t.prototype,"requiredFields",void 0),(0,s.e)([(0,l.y)()],t.prototype,"suspended",void 0),(0,s.e)([(0,l.y)()],t.prototype,"view",void 0),t=(0,s.e)([(0,l.n)("esri.views.layers.FeatureLayerView")],t),t}},7022:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>q});var r,s=i(78155),n=i(73574),a=i(88903),o=i(80219),l=i(80987),h=i(40130),u=i(20215),c=i(36845),d=i(8725),p=i(30337),f=i(52737),y=i(18143),m=i(43356),g=i(31280),_=i(83991),x=i(93443),v=i(26779),b=i(29218),w=i(47473),S=i(50822),I=i(71391),C=i(1045),M=i(31393),T=i(67390),E=i(732),F=i(98548);i(82906),i(20736),i(4169),i(92858),i(52957),i(29126),i(31531),i(6585),i(3621),i(63358),i(62121),i(81135),i(94527),i(17762),i(60816),i(61888),i(29832),i(31516),i(52109),i(89710),i(47365),i(67079),i(91236),i(34396),i(5250),i(49878),i(84271),i(48643),i(30316),i(4618),i(65352),i(80657),i(94449),i(97325),i(3629),i(5772),i(14215),i(78191),i(13513),i(50388),i(58404),i(24776),i(67726),i(71470),i(76119),i(60978),i(13564),i(13895),i(81578),i(32769),i(83731),i(55688),i(15015),i(95629),i(9612),i(76326),i(4807),i(18559),i(42296),i(17331),i(41290),i(82361),i(71394),i(95559),i(68631),i(56803),i(2903),i(85570),i(80136),i(91507),i(85289),i(98843),i(91790),i(29831),i(16040),i(79506),i(98420),i(54223),i(51218),i(21793),i(15576),i(28941),i(19438),i(15022),i(56416),i(92758),i(78435),i(53902),i(40481),i(78730),i(2570),i(71666),i(72257),i(41822),i(99987),i(11838),i(39068),i(95186),i(59312),i(75200),i(334),i(93242);let A=r=class extends n.h{constructor(){super(...arguments),this.isAggregate=!0}getEffectivePopupTemplate(e=!1){if(this.popupTemplate)return this.popupTemplate;const t=this.sourceLayer&&this.sourceLayer.featureReduction;return t&&"popupTemplate"in t&&t.popupEnabled?t.popupTemplate:null}getObjectId(){return this.objectId}clone(){return new r({objectId:this.objectId,...this.cloneProperties()})}};(0,s.e)([(0,a.y)({type:Boolean})],A.prototype,"isAggregate",void 0),(0,s.e)([(0,a.y)({type:Number,json:{read:!0}})],A.prototype,"objectId",void 0),A=r=(0,s.e)([(0,a.n)("esri.AggregateGraphic")],A);var R=A;function P(e){return e.some((e=>e.globalId))}function L(e){return e.filter((e=>!e.error)).map((e=>{var t;return null!=(t=e.objectId)?t:e.globalId}))}function D(e,t){const i=new Set(e);for(const e of t.values())i.add(e);return i}function N(e,t){const i=new Set(e);for(const e of t.values())i.delete(e);return i}let O=class extends s.p{constructor(e){super(),this._hasGlobalIds=!1,this._queueProcessor=new x._({concurrency:1,process:e.process})}destroy(){this._queueProcessor.clear()}get updating(){return this._queueProcessor.length>0}push(e){const t=this._queueProcessor,i=t.last();switch(e.type){case"update":case"refresh":if((null==i?void 0:i.type)===e.type)return;t.push(e).finally((()=>this.notifyChange("updating")));break;case"edit":{const r="processed-edit"===(null==i?void 0:i.type)?i:null;r&&t.popLast();const s=this._mergeEdits(r,e);for(const e of s)t.push(e).finally((()=>this.notifyChange("updating")));break}}this.notifyChange("updating")}_mergeEdits(e,t){var i,r;const{addedFeatures:s,deletedFeatures:n,updatedFeatures:a}=t.edits;if(this._hasGlobalIds=this._hasGlobalIds||P(s)||P(a)||P(n),this._hasGlobalIds)return[e,{type:"processed-edit",edits:{addOrModified:[...s,...a],removed:n}}];const o=new Set(L(null!=(i=null==e?void 0:e.edits.addOrModified)?i:[])),l=new Set(L(null!=(r=null==e?void 0:e.edits.removed)?r:[])),h=new Set([...L(s),...L(a)]),u=new Set(L(n));return[{type:"processed-edit",edits:{addOrModified:Array.from(D(N(o,u),h)).map((e=>({objectId:e}))),removed:Array.from(D(N(l,h),u)).map((e=>({objectId:e})))}}]}};(0,s.e)([(0,a.y)({readOnly:!0})],O.prototype,"updating",null),O=(0,s.e)([(0,a.n)("esri.views.2d.layers.support.FeatureCommandQueue")],O);var k=O;let V=class extends l.m{constructor(e){super(e),this._startupResolver=(0,u.D)(),this.isReady=!1}initialize(){this._controller=(0,u.h)(),this.addResolvingPromise(this._startWorker(this._controller.signal))}destroy(){this._controller.abort(),this._connection&&this._connection.close()}set tileRenderer(e){this.client.tileRenderer=e}get closed(){return this._connection.closed}async startup(e,t,i,r){await this.when();const s=this._controller.signal,n=function(e){return Array.isArray(e)}(i.source)?{transferList:i.source,signal:s}:void 0,a={service:i,config:t,tileInfo:e.tileInfo.toJSON(),tiles:r};await this._connection.invoke("startup",a,n),this._startupResolver.resolve(),this._set("isReady",!0)}async updateTiles(e){return await this._startupResolver.promise,(0,u.y)(this._connection.invoke("updateTiles",e))}async update(e){const t={config:e};return await this._startupResolver.promise,this._connection.invoke("update",t)}async applyUpdate(e){return await this._startupResolver.promise,this._connection.invoke("applyUpdate",e)}async setHighlight(e){return await this._startupResolver.promise,(0,u.y)(this._connection.invoke("controller.setHighlight",e))}async refresh(){return await this._startupResolver.promise,(0,u.y)(this._connection.invoke("controller.refresh"))}async querySummaryStatistics(e,t,i){return await this._startupResolver.promise,this._connection.invoke("controller.querySummaryStatistics",{query:e.toJSON(),params:t},i)}async queryFeatures(e,t){return await this._startupResolver.promise,this._connection.invoke("controller.queryFeatures",e.toJSON(),t)}async queryObjectIds(e,t){return await this._startupResolver.promise,this._connection.invoke("controller.queryObjectIds",e.toJSON(),t)}async queryFeatureCount(e,t){return await this._startupResolver.promise,this._connection.invoke("controller.queryFeatureCount",e.toJSON(),t)}async queryExtent(e,t){return this._connection.invoke("controller.queryExtent",e.toJSON(),t)}async queryLatestObservations(e,t){return await this._startupResolver.promise,this._connection.invoke("controller.queryLatestObservations",e.toJSON(),t)}async queryStatistics(e){return await this._startupResolver.promise,this._connection.invoke("controller.queryStatistics",e)}async getObjectId(e){return await this._startupResolver.promise,this._connection.invoke("controller.getObjectId",e)}async getDisplayId(e){return await this._startupResolver.promise,this._connection.invoke("controller.getDisplayId",e)}async getFeature(e){return await this._startupResolver.promise,this._connection.invoke("controller.getFeature",e)}async getAggregate(e){return await this._startupResolver.promise,this._connection.invoke("controller.getAggregate",e)}async getAggregateValueRanges(){return await this._startupResolver.promise,this._connection.invoke("controller.getAggregateValueRanges")}async mapValidDisplayIds(e){return await this._startupResolver.promise,this._connection.invoke("controller.mapValidDisplayIds",e)}async onEdits(e){return await this._startupResolver.promise,(0,u.y)(this._connection.invoke("controller.onEdits",e))}async enableEvent(e,t){return await this._startupResolver.promise,(0,u.y)(this._connection.invoke("controller.enableEvent",{name:e,value:t}))}async _startWorker(e){try{this._connection=await(0,v.p)("Pipeline",{client:this.client,strategy:"dedicated",signal:e})}catch(e){(0,u.j)(e)}}};(0,s.e)([(0,a.y)()],V.prototype,"isReady",void 0),(0,s.e)([(0,a.y)()],V.prototype,"client",void 0),(0,s.e)([(0,a.y)()],V.prototype,"tileRenderer",null),V=(0,s.e)([(0,a.n)("esri.views.2d.layers.support.FeatureLayerProxy")],V);var U=V;class G{constructor(e){this._tiles=new Map,this.buffer=0,this.acquireTile=e.acquireTile,this.releaseTile=e.releaseTile,this.tileInfoView=e.tileInfoView,this.buffer=e.buffer}destroy(){}clear(){this._tiles.forEach((e=>this._releaseTile(e)))}tileKeys(){const e=[];return this._tiles.forEach(((t,i)=>e.push(i))),e}update(e){const t=this.tileInfoView.getTileCoverage(e.state,this.buffer,"closest"),{spans:i,lodInfo:r}=t,{level:s}=r,n=[],a=[],o=new Set,l=new Set;for(const{row:e,colFrom:t,colTo:a}of i)for(let i=t;i<=a;i++){const t=b.e.getId(s,e,r.normalizeCol(i),r.getWorldForColumn(i)),a=this._getOrAcquireTile(n,t);o.add(t),a.isReady?a.visible=!0:l.add(a.key)}return l.forEach((e=>this._addPlaceholders(o,e))),this._tiles.forEach((e=>{o.has(e.key.id)||(a.push(e.key.id),this._releaseTile(e))})),x.l.pool.release(t),{hasMissingTiles:l.size>0,added:n,removed:a}}_getOrAcquireTile(e,t){if(!this._tiles.has(t)){const i=this.acquireTile(new b.e(t));e.push(t),this._tiles.set(t,i),i.visible=!1}return this._tiles.get(t)}_getTile(e){return this._tiles.get(e)}_releaseTile(e){this._tiles.delete(e.key.id),this.releaseTile(e)}_addPlaceholders(e,t){const i=this._addPlaceholderChildren(e,t);Math.abs(1-i)<1e-6||this._addPlaceholderParent(e,t)||(this._getTile(t.id).visible=!0)}_addPlaceholderChildren(e,t){let i=0;return this._tiles.forEach((r=>{i+=this._addPlaceholderChild(e,r,t)})),i}_addPlaceholderChild(e,t,i){return t.key.level<=i.level||!t.hasData||!i.contains(t.key)?0:(t.visible=!0,e.add(t.key.id),1/(1<<2*(t.key.level-i.level)))}_addPlaceholderParent(e,t){let i=t.getParentKey(),r=0,s=null;for(;(0,o.r)(i);){if(e.has(i.id))return!0;const t=this._getTile(i.id);if(null!=t&&t.isReady)return t.visible=!0,e.add(t.key.id),!0;null!=t&&t.hasData&&t.patchCount>r&&(r=t.patchCount,s=t),i=i.getParentKey()}return!!s&&(s.visible=!0,e.add(s.key.id),!0)}}function z(e){return e&&"openPorts"in e}const B=o.n.getLogger("esri.views.2d.layers.FeatureLayerView2D");let j=class extends((0,w.R)((0,I.aa)((0,g.l)(S.d)))){constructor(){super(...arguments),this._pipelineIsUpdating=!0,this._commandsQueue=new k({process:e=>{switch(e.type){case"processed-edit":return this._doEdit(e);case"refresh":return this._doRefresh();case"update":return this._doUpdate()}}}),this._visibilityOverrides=new Set,this._effect=null,this._highlightIds=new Map,this._lastPixelBuffer=0,this._updateHighlight=(0,u.B)((async()=>this._proxy.setHighlight(Array.from(this._highlightIds.keys())))),this._uploadsLocked=!1,this._needsClusterSizeUpdate=!1,this.filter=null,this.effectLists={included:new C.u,excluded:new C.u}}destroy(){var e,t;(0,o.A)(this._updateClusterSizeTask,(e=>e.remove())),null==(e=this._proxy)||e.destroy(),null==(t=this.tileRenderer)||t.destroy(),this._commandsQueue.destroy()}initialize(){this.addResolvingPromise(Promise.all([this._initProxy(),this._initServiceOptions()])),this.handles.add([this.on("valueRangesChanged",(e=>{this._set("_aggregateValueRanges",e.valueRanges)})),(0,c.d)(this,"effect",(e=>{this.effectLists.included.effect=null==e?void 0:e.includedEffect})),(0,c.d)(this,"effect",(e=>{this.effectLists.excluded.effect=null==e?void 0:e.excludedEffect}))])}async _initProxy(){if("isTable"in this.layer&&this.layer.isTable)throw new u.s("featurelayerview:table-not-supported","table feature layer can't be displayed",{layer:this.layer});this._proxy&&this._proxy.destroy();const e=this._createClientOptions();return this._set("_proxy",new U({client:e})),this._proxy.when()}async _initServiceOptions(){this._set("_serviceOptions",await this._createServiceOptions())}get labelsVisible(){const e="subtype-group"===this.layer.type?this.layer.sublayers.items:[this.layer];return!this.suspended&&e.some((e=>e.labelingInfo&&e.labelsVisible))}get effect(){return(0,o.q)(this._effect,null)}set effect(e){const t=this._effect;(0,o.r)(t)&&(0,o.r)(t.filter)&&t.filter.enabled&&(0,o.r)(e)&&(0,o.r)(e.filter)&&e.filter.enable(),this._effect=e,this.notifyChange("effect")}get effects(){return this.effect&&[this.effect]||[]}get queryMode(){return this._serviceOptions.type}get renderingConfigHash(){if(!this.layer)return null;const e=this.availableFields,t=this.layer,i=this.view.floors,{definitionExpression:r}=t,s="subtype-group"!==this.layer.type&&this.layer.labelsVisible&&this.layer.labelingInfo,n="renderer"in t&&t.renderer,a="feature"===t.type?t.gdbVersion:void 0,l="feature"===t.type&&t.historicMoment?t.historicMoment.getTime():void 0,{timeExtent:h}=this,u="stream"===t.type?`${JSON.stringify(t.geometryDefinition)}${t.definitionExpression}`:null,c=JSON.stringify(this.clips),d=t.featureReduction&&t.featureReduction.toJSON(),p="sublayers"in this.layer&&this.layer.sublayers.items.reduce(((e,t)=>e+`${t.visible?1:0}.${JSON.stringify(t.renderer)}.${t.labelsVisible}\n.${JSON.stringify(t.labelingInfo)}`),"");return JSON.stringify({sublayerHash:p,filterHash:(0,o.r)(this.filter)&&this.filter.toJSON(),effectHash:(0,o.r)(this.effect)&&this.effect.toJSON(),streamFilter:u,gdbVersion:a,definitionExpression:r,historicMoment:l,availableFields:e,renderer:n,labelingInfo:s,timeExtent:h,floors:i,clipsHash:c,featureReduction:d})}get hasEffects(){return this.effectLists.included.hasEffects||this.effectLists.excluded.hasEffects}highlight(e){let t;return e instanceof n.h?t=[e.getObjectId()]:"number"==typeof e||"string"==typeof e?t=[e]:h.L.isCollection(e)?t=e.map((e=>e&&e.getAttribute(this.layer.objectIdField))).toArray():Array.isArray(e)&&e.length>0&&(t="number"==typeof e[0]||"string"==typeof e[0]?e:e.map((e=>e&&e.getAttribute(this.layer.objectIdField)))),t&&t.length?(t=t.filter((e=>null!=e)),this._addHighlight(t),{remove:()=>this._removeHighlight(t)}):{remove:()=>{}}}hasHighlight(){return!!this._highlightIds.size}hitTest(e,t){return this._hitTest(e,t)}queryStatistics(){return this._proxy.queryStatistics()}async querySummaryStatistics(e,t,i){const r={...t};var s;return t.valueExpression&&(r.viewInfoParams={viewingMode:"map",scale:this.view.scale,spatialReference:null==(s=this.view.spatialReference)?void 0:s.toJSON()}),this._proxy.querySummaryStatistics(this._cleanUpQuery(e),r,i)}queryFeatures(e,t){return this.queryFeaturesJSON(e,t).then((e=>{const t=f.default.fromJSON(e);return t.features.forEach((e=>this._setLayersForFeature(e))),t}))}queryFeaturesJSON(e,t){return this._proxy.queryFeatures(this._cleanUpQuery(e),t)}queryObjectIds(e,t){return this._proxy.queryObjectIds(this._cleanUpQuery(e),t)}queryFeatureCount(e,t){return this._proxy.queryFeatureCount(this._cleanUpQuery(e),t)}queryExtent(e,t){return this._proxy.queryExtent(this._cleanUpQuery(e),t).then((e=>({count:e.count,extent:F.M.fromJSON(e.extent)})))}setVisibility(e,t){t?this._visibilityOverrides.delete(e):this._visibilityOverrides.add(e),this._update()}update(e){if(!this._tileStrategy||!this.tileRenderer)return;const{hasMissingTiles:t,added:i,removed:r}=this._tileStrategy.update(e);(i.length||r.length)&&this._proxy.updateTiles({added:i,removed:r}),t&&this.requestUpdate(),this.notifyChange("updating")}attach(){this.view.timeline.record(`${this.layer.title} (FeatureLayer) Attach`),this._tileStrategy=new G({acquireTile:e=>this._acquireTile(e),releaseTile:e=>this._releaseTile(e),tileInfoView:this.view.featuresTilingScheme,buffer:0}),this.handles.add((0,c.d)(this,"renderingConfigHash",(()=>this._update())),"attach"),"stream"!==this.layer.type&&this.handles.add(this.layer.on("edits",(e=>this._edit(e))),"attach")}detach(){this.container.removeAllChildren(),this.handles.remove("attach"),this.tileRenderer&&(this.tileRenderer.uninstall(this.container),this.tileRenderer=null),this._tileStrategy&&(this._tileStrategy.destroy(),this._tileStrategy=null),this._tileRendererHash=null}moveStart(){this.requestUpdate()}viewChange(){this.requestUpdate()}moveEnd(){this.requestUpdate()}async fetchPopupFeatures(e,t){if((0,o.r)(t)&&t.clientGraphics.length){const e=t.clientGraphics[0];if(e instanceof R)return[e];t.clientGraphics=t.clientGraphics.filter((e=>{const{layer:t}=e,i="popupEnabled"in t&&t.popupEnabled,r="popupTemplate"in t&&t.popupTemplate,s=this.view.popup.defaultPopupTemplateEnabled;return i&&(r||s)}))}const i=this.validateFetchPopupFeatures(t);if(i)throw i;if((0,o.r)(t)&&0===t.clientGraphics.length)return[];const r=this.fetchClientPopupFeatures(t);if(!e)return r;const n=this._fetchServicePopupFeatures(e,t);return(0,u.k)([r,n]).then(s.M)}async _fetchServicePopupFeatures(e,t){if("stream"===this.layer.type||"ogc-feature"===this.layer.type)return[];const i=await this.createPopupQuery(t),{layer:r}=this,s="renderer"in r&&r.renderer,n=(0,o.r)(t)?t.event:null,a=(0,p.s)({renderer:s,event:n});i.geometry=this.createFetchPopupFeaturesQueryGeometry(e,a);const l=new Set,{objectIdField:h}=r,u=(0,o.r)(t)?t.clientGraphics:null;if(u)for(const e of u)l.add(e.attributes[h]);return r.queryFeatures(i).then((e=>e.features.filter((e=>!l.has(e.attributes[h])))))}createFetchPopupFeaturesQueryGeometry(e,t){return(0,T.a)(e,t,this.view)}isUpdating(){var e;const t="renderer"in this.layer&&null!=this.layer.renderer,i=this._commandsQueue.updating,r=null!=this._updatingRequiredFieldsPromise,s=!this._proxy||!this._proxy.isReady,n=this._pipelineIsUpdating,a=null===this.tileRenderer||(null==(e=this.tileRenderer)?void 0:e.updating),l=t&&(i||r||s||n||a);return(0,o.c)("esri-2d-log-updating")&&console.log(`Updating FLV2D: ${l}\n  -> hasRenderer ${t}\n  -> hasPendingCommand ${i}\n  -> updatingRequiredFields ${r}\n  -> updatingProxy ${s}\n  -> updatingPipeline ${n}\n  -> updatingTileRenderer ${a}\n`),l}_createClientOptions(){return{setUpdating:e=>{this._set("_pipelineIsUpdating",e)},emitEvent:e=>{this.emit(e.name,e.event)}}}async _detectQueryMode(e){if("path"in e&&(0,d.w)(e.path)&&("feature"===this.layer.type||"subtype-group"===this.layer.type)&&"point"===this.layer.geometryType&&!this.layer.capabilities.operations.supportsEditing&&(0,o.c)("featurelayer-snapshot-enabled"))try{const e=await this.layer.queryFeatureCount();if(e<=(0,o.c)("featurelayer-snapshot-point-min-threshold"))return{mode:"snapshot",featureCount:e};const t=(0,o.c)("featurelayer-snapshot-point-max-threshold"),i=(0,o.c)("featurelayer-snapshot-point-coverage"),r=this.view.extent,s=this.layer.fullExtent,n=null==s?void 0:s.clone().intersection(r),a=(null==n?void 0:n.width)*(null==n?void 0:n.height),l=(null==s?void 0:s.width)*(null==s?void 0:s.height),h=0===l?0:a/l;if(e<=t&&h>=i)return{mode:"snapshot",featureCount:e}}catch(e){B.warn("mapview-feature-layer","Encountered an error when querying for featureCount",{error:e})}return{mode:"on-demand"}}async _createServiceOptions(){var e;const t=this.layer;if("stream"===t.type)return null;const{capabilities:i,objectIdField:r}=t,s=t.fields.map((e=>e.toJSON())),n=t.fullExtent&&t.fullExtent.toJSON(),a=(0,_.f)(t.geometryType),l=t.timeInfo&&t.timeInfo.toJSON()||null,h=t.spatialReference?t.spatialReference.toJSON():null,u={..."customParameters"in t?t.customParameters:void 0,token:"apiKey"in t?t.apiKey:void 0},c="feature"===t.type?t.globalIdField:null;let d;"ogc-feature"===t.type?d=t.source.getFeatureDefinition():z(t.source)?d=await t.source.openPorts():t.parsedUrl&&(d=(0,o.y)(t.parsedUrl),"dynamicDataSource"in t&&t.dynamicDataSource&&(d.query={layer:JSON.stringify({source:t.dynamicDataSource})}));const p=null!=(e="subtypeField"in this.layer&&this.layer.subtypeField)?e:null,{mode:f,featureCount:y}=await this._detectQueryMode(d);return{type:f,subtypeField:p,featureCount:y,globalIdField:c,maxRecordCount:i.query.maxRecordCount,tileMaxRecordCount:i.query.tileMaxRecordCount,capabilities:i,fields:s,fullExtent:n,geometryType:a,objectIdField:r,source:d,timeInfo:l,spatialReference:h,customParameters:u}}async _createMemoryServiceOptions(e){const t=await e.openPorts();return{...this._createServiceOptions(),type:"memory",source:t}}_cleanUpQuery(e){const t=y.b.from(e)||this.createQuery();return t.outSpatialReference||(t.outSpatialReference=this.view.spatialReference),t}async _update(){return this._commandsQueue.push({type:"update"})}async _edit(e){if(this._validateEdit(e))return this._commandsQueue.push({type:"edit",edits:e})}async doRefresh(){return this._commandsQueue.push({type:"refresh"})}_validateEdit(e){const t="globalIdField"in this.layer&&this.layer.globalIdField,i=e.deletedFeatures.some((e=>-1===e.objectId||!e.objectId)),r=t&&this.availableFields.includes(t);return i&&!r?(B.error(new u.s("mapview-apply-edits",`Editing the specified service requires the layer's globalIdField, ${t} to be included the layer's outFields for updates to be reflected on the map`)),null):e}async _doUpdate(){try{if(this.destroyed||!this._hasRequiredSupport(this.layer)||!this._tileStrategy)return;const{effect:e,filter:t}=this;await this._updateRequiredFields();const{renderer:i}=this._getEffectiveRenderer();this._set("_effectiveRenderer",i);const r=this._createSchemaConfig(),s=(0,_.f)(this.layer.geometryType),n=await(0,_.u)(i,s,this.layer.featureReduction),a=this._createConfiguration(r,t,e);this._lastPixelBuffer=0===n?0:Math.max(n,this._lastPixelBuffer),a.schema.source.pixelBuffer=this._lastPixelBuffer;const l=this._createTileRendererHash(i);if(l!==this._tileRendererHash){await this._initTileRenderer(i);const e=this._serviceOptions;this.effects.forEach((e=>(0,o.r)(e)&&(0,o.r)(e.filter)&&e.filter.enable())),this.tileRenderer.onConfigUpdate(i);const t={added:this._tileStrategy.tileKeys(),removed:[]},r=this.layer;"stream"!==r.type&&z(r.source)&&(e.source=await r.source.openPorts()),await this._proxy.startup(this.view.featuresTilingScheme,a,e,t),this.hasHighlight()&&await this._proxy.setHighlight(Array.from(this._highlightIds.keys())),await this._onceTilesUpdated(),this.tileRenderer.onConfigUpdate(i)}else{const e=await this._proxy.update(a);(e.mesh||e.targets.aggregate)&&this._lockGPUUploads();try{await this._proxy.applyUpdate(e)}catch(e){(0,u.g)(e)||B.error(e)}(e.mesh||e.targets.aggregate)&&this._unlockGPUUploads(),this.effects.forEach((e=>(0,o.r)(e)&&(0,o.r)(e.filter)&&e.filter.enable())),this.tileRenderer.onConfigUpdate(i),this._updateClusterSizeVariable(),this._forceAttributeTextureUpload()}this._tileRendererHash=l,this.tileRenderer.invalidateLabels(),this.requestUpdate()}catch(e){}}async _doEdit(e){try{await this._proxy.onEdits(e)}catch(e){(0,u.g)(e)}}async _doRefresh(){this._lockGPUUploads();try{await this._proxy.refresh()}catch(e){(0,u.g)(e)}this._unlockGPUUploads()}_updateClusterSizeVariable(){this._needsClusterSizeUpdate&&(this.tileRenderer.onConfigUpdate(this._effectiveRenderer),this._needsClusterSizeUpdate=!1)}_createUpdateClusterSizeTask(e,t){return this.watch("_aggregateValueRanges",(async i=>{this._updateClusterEffectiveRendererSizeVariable(e,t,i),this._needsClusterSizeUpdate=!0,this._uploadsLocked||this._updateClusterSizeVariable()}))}async _updateClusterEffectiveRendererSizeVariable(e,t,i){if(e.dynamicClusterSize&&"visualVariables"in e&&e.visualVariables){const r=(0,_.g)(e.visualVariables);if((0,o.r)(r)&&"cluster_count"===r.field){const s=e.visualVariables.indexOf(r);e.visualVariables[s]=(0,_.h)(t,i);const n=e.clone();n.dynamicClusterSize=!0,this._set("_effectiveRenderer",n)}}}_getEffectiveRenderer(){const e="renderer"in this.layer&&this.layer.renderer,t=this.layer.featureReduction;if((0,o.r)(this._updateClusterSizeTask)&&(this._updateClusterSizeTask.remove(),this._updateClusterSizeTask=null),t&&"cluster"===t.type&&(0,_.m)(e)){const i=t,r=[],s=(0,_.i)(r,e,i,this._aggregateValueRanges);return(0,o.A)(this._updateClusterSizeTask,(e=>e.remove())),this._updateClusterSizeTask=this._createUpdateClusterSizeTask(s,i),{renderer:s,aggregateFields:r,featureReduction:t}}return{renderer:e,aggregateFields:[],featureReduction:null}}_acquireTile(e){const t=this.tileRenderer.acquireTile(e);return t.once("attach",(()=>{this.requestUpdate()})),t}_releaseTile(e){this.tileRenderer.releaseTile(e)}async _initTileRenderer(e){const t=await async function(e,t){if(!e)return null;switch(e.type){case"class-breaks":case"simple":case"unique-value":case"dot-density":case"dictionary":return new((await Promise.all([i.e(918),i.e(9351),i.e(5968)]).then(i.bind(i,35968))).default)(t);case"heatmap":return new((await Promise.all([i.e(918),i.e(9351),i.e(6595)]).then(i.bind(i,76595))).default)(t)}}(e,{layerView:this,tileInfoView:this.view.featuresTilingScheme,layer:this.layer});return this.tileRenderer&&(this._tileStrategy.clear(),this.tileRenderer.uninstall(this.container),this.tileRenderer.destroy(),this.tileRenderer=null),this.destroyed?null:(this._proxy.tileRenderer=t,this._set("tileRenderer",t),this.tileRenderer.install(this.container),this.tileRenderer.onConfigUpdate(e),this.requestUpdate(),this.tileRenderer)}_createTileRendererHash(e){return`${"heatmap"===e.type?"heatmap":"symbol"}.${"dot-density"===e.type}`}_createFeatureDataHash(e,t,i){const r=e.getAttributeHash(),s=JSON.stringify(t),n=(0,o.r)(i)&&JSON.stringify(i.filter),a=JSON.stringify(this.timeExtent);let l="";return this._visibilityOverrides.forEach((e=>l+=e)),`${r}.${s}.${n}.${a}.${l}`}get hasFilter(){const e=!!("floorInfo"in this.layer&&this.layer.floorInfo&&this.view.floors&&this.view.floors.length);return!!this.filter||e||!!this._visibilityOverrides.size||!!this.timeExtent}_injectOverrides(e){const t=(0,o.r)(e)?e.timeExtent:null,i=(0,o.r)(this.timeExtent)&&(0,o.r)(t)?this.timeExtent.intersection(t):this.timeExtent||t;let r=null;const s="floorInfo"in this.layer&&this.layer.floorInfo;if(s){const t=(0,o.r)(e)&&e.where;r=this._addFloorFilterClause(t)}if(!this._visibilityOverrides.size&&!i&&!s)return e;const n=(0,o.r)(e)&&e.clone()||new M.y;return n.hiddenIds=this._visibilityOverrides,n.timeExtent=i,r&&(n.where=r),n}_addFloorFilterClause(e){const t=this.layer;let i=e||"";if("floorInfo"in t&&t.floorInfo){var r;let e=this.view.floors;if(!e||!e.length)return i;null!=(r=t.floorInfo.viewAllLevelIds)&&r.length&&(e=t.floorInfo.viewAllLevelIds);const s=e.filter((e=>""!==e)).map((e=>"'"+e+"'"));s.push("''");const n=t.floorInfo.floorField;let a="("+n+" IN ({ids}) OR "+n+" IS NULL)";if(a=a.replace("{ids}",s.join(", ")),(0,o.r)(i)&&i.includes(n)){let e=new RegExp("AND \\("+n+".*NULL\\)","g");i=i.replace(e,""),e=new RegExp("\\("+n+".*NULL\\)","g"),i=i.replace(e,""),i=i.replace(/\s+/g," ").trim()}i=""!==i?"("+i+") AND "+a:a}return""!==i?i:null}_createConfiguration(e,t,i){const r="feature"===this.layer.type&&this.layer.historicMoment?this.layer.historicMoment.getTime():void 0,s="feature"===this.layer.type?this.layer.gdbVersion:void 0,n=new Array(m.N),a=this._injectOverrides(t);n[0]=(0,o.r)(a)?a.toJSON():null,n[1]=(0,o.r)(i)&&i.filter?i.filter.toJSON():null;const l=(0,_.M)(e);if((0,o.t)(l))return null;const h=(0,E.r)();return{definitionExpression:this.layer.definitionExpression,availableFields:this.availableFields,gdbVersion:s,historicMoment:r,devicePixelRatio:window.devicePixelRatio||1,filters:n,schema:l,supportsTextureFloat:h.supportsTextureFloat,maxTextureSize:h.maxTextureSize}}_hasRequiredSupport(e){var t;return!("renderer"in e&&"dot-density"===(null==(t=e.renderer)?void 0:t.type)&&!(0,E.r)().supportsTextureFloat&&(B.error(new u.s("webgl-missing-extension","Missing WebGL extension OES_Texture_Float which is required for DotDensity")),1))}_onceTilesUpdated(){return this.requestUpdate(),(0,c.$)(this,"_pipelineIsUpdating",!1)}_lockGPUUploads(){this.tileRenderer&&(this._uploadsLocked=!0,this.tileRenderer.lockGPUUploads())}_unlockGPUUploads(){this.tileRenderer&&(this._uploadsLocked=!1,this.tileRenderer.unlockGPUUploads())}_forceAttributeTextureUpload(){this.tileRenderer&&this.tileRenderer.forceAttributeTextureUpload()}_createSchemaConfig(){const e="feature"===this.layer.type?this.layer.historicMoment:null,t="feature"===this.layer.type?this.layer.gdbVersion:null;return{renderer:"renderer"in this.layer&&this.layer.renderer,spatialReference:this.layer.spatialReference,timeExtent:this.layer.timeExtent,definitionExpression:this.layer.definitionExpression,featureReduction:this.layer.featureReduction,fields:this.layer.fields,geometryType:this.layer.geometryType,historicMoment:e,labelsVisible:"labelsVisible"in this.layer&&this.layer.labelsVisible,labelingInfo:"labelingInfo"in this.layer&&this.layer.labelingInfo,availableFields:this.availableFields,effect:this.effect,filter:this.filter,gdbVersion:t,pixelBuffer:0}}_addHighlight(e){for(const t of e)if(this._highlightIds.has(t)){const e=this._highlightIds.get(t);this._highlightIds.set(t,e+1)}else this._highlightIds.set(t,1);this._updateHighlight().catch((e=>{(0,u.g)(e)||B.error(e)}))}_removeHighlight(e){for(const t of e)if(this._highlightIds.has(t)){const e=this._highlightIds.get(t)-1;0===e?this._highlightIds.delete(t):this._highlightIds.set(t,e)}this._updateHighlight().catch((e=>{(0,u.g)(e)||B.error(e)}))}_setLayersForFeature(e){const t=this.layer;e.layer=t,e.sourceLayer=t}_createHittestResult(e){return this._setLayersForFeature(e),(0,o.r)(e.geometry)&&(e.geometry.spatialReference=this.view.spatialReference),e}async _hitTest(e,t){if(this.suspended||!this.tileRenderer)return null;const i=await this.tileRenderer.hitTest(e,t);if(0===i.length)return await(0,u.C)(1),null;const r=i[0];if(!(e=>(2147483648&e)>>>31==1)(r)){const e=await this._proxy.getFeature(r);return(0,o.A)(e,(e=>this._createHittestResult(n.h.fromJSON(e))))}const s=await this._proxy.getAggregate(r);if((0,o.t)(s))return null;if((0,o.r)(s.referenceId)){const e=await this._proxy.getFeature(s.referenceId);return(0,o.A)(e,(e=>this._createHittestResult(n.h.fromJSON(e))))}return this._createHittestResult(R.fromJSON(s))}};(0,s.e)([(0,a.y)()],j.prototype,"_serviceOptions",void 0),(0,s.e)([(0,a.y)()],j.prototype,"_proxy",void 0),(0,s.e)([(0,a.y)()],j.prototype,"_pipelineIsUpdating",void 0),(0,s.e)([(0,a.y)()],j.prototype,"_effectiveRenderer",void 0),(0,s.e)([(0,a.y)()],j.prototype,"_aggregateValueRanges",void 0),(0,s.e)([(0,a.y)()],j.prototype,"_commandsQueue",void 0),(0,s.e)([(0,a.y)()],j.prototype,"labelsVisible",null),(0,s.e)([(0,a.y)({type:M.y})],j.prototype,"filter",void 0),(0,s.e)([(0,a.y)({type:w.l})],j.prototype,"effect",null),(0,s.e)([(0,a.y)({readOnly:!0})],j.prototype,"effects",null),(0,s.e)([(0,a.y)({readOnly:!0})],j.prototype,"queryMode",null),(0,s.e)([(0,a.y)()],j.prototype,"renderingConfigHash",null),(0,s.e)([(0,a.y)()],j.prototype,"tileRenderer",void 0),(0,s.e)([(0,a.y)()],j.prototype,"updating",void 0),j=(0,s.e)([(0,a.n)("esri.views.2d.layers.FeatureLayerView2D")],j);const q=j},62691:(e,t,i)=>{"use strict";i.d(t,{x:()=>E});var r=i(78155),s=i(20215),n=i(80219),a=i(36845),o=i(88903),l=i(32422),h=i(66532),u=i(30665),c=i(85570),d=i(73574),p=i(49293),f=i(92858),y=i(47365),m=i(47473),g=i(50822),_=i(71391);class x{constructor(e){this._schedule=e,this._handle=new v(e)}destroy(){this._handle.destroy()}invoke(e,t){return e.buffer&&0!==e.buffer.byteLength?(e.options.sourceSpatialReference&&e.options.sourceSpatialReference instanceof f.k&&(e.options={...e.options,sourceSpatialReference:e.options.sourceSpatialReference.toJSON()}),this._handle.invoke(e,t).then((e=>this._schedule((()=>{if(e.spatialReference=f.k.fromJSON(e.spatialReference),e.fields)for(let t=0;t<e.fields.length;t++)e.fields[t]=y.y.fromJSON(e.fields[t]);const t=e.spatialReference;for(const i of e.features)i.uid=d.h.generateUID(),(0,n.r)(i.geometry)&&(i.geometry.spatialReference=t);return e}))))):Promise.resolve(null)}}class v extends p.a{constructor(e){super("PBFDecoderWorker","_parseFeatureQuery",e)}getTransferList(e){return[e.buffer]}}let b=class extends r.p{constructor(e){super(e)}get queryFeaturesDehydrated(){const e=this.layer.capabilities,t=e&&e.query;if(t&&t.supportsFormatPBF){var i,r;(0,n.t)(this._decoder)&&(this._decoder=new x(this.schedule));const e={sourceSpatialReference:null!=(i=null==(r=this.layer.spatialReference)?void 0:r.toJSON())?i:null,applyTransform:!0,maxStringAttributeLength:1024};return(t,i)=>(0,c.g)(this.layer.parsedUrl,t,"pbf",this._createRequestOptions(i)).then((t=>((0,s.a)(i),(0,n.r)(this._decoder)?this._decoder.invoke({buffer:t.data,options:e},i.signal):Promise.reject((0,s.m)()))))}return(e,t)=>(0,c.y)(this.layer.parsedUrl,e,this.layer.spatialReference,this._createRequestOptions(t)).then((e=>(0,u.z)(e.data)))}queryFeatureCount(e,t){return this.layer.queryFeatureCount(e,t)}destroy(){this._decoder=(0,n.k)(this._decoder)}_createRequestOptions(e){return{...e,query:{...this.layer.customParameters,token:this.layer.apiKey,...null==e?void 0:e.query}}}};(0,r.e)([(0,o.y)({constructOnly:!0})],b.prototype,"layer",void 0),(0,r.e)([(0,o.y)({constructOnly:!0})],b.prototype,"schedule",void 0),(0,r.e)([(0,o.y)({readOnly:!0})],b.prototype,"queryFeaturesDehydrated",null),b=(0,r.e)([(0,o.n)("esri.views.3d.layers.support.featureTileQuery3D.FeatureTileServiceQuery3D")],b);let w=class extends r.p{constructor(e){super(e)}queryFeaturesDehydrated(e,t){return this.layer.queryFeatures(e,t)}queryFeatureCount(e,t){return this.layer.queryFeatureCount(e,t)}};(0,r.e)([(0,o.y)({constructOnly:!0})],w.prototype,"layer",void 0),(0,r.e)([(0,o.y)({readOnly:!0})],w.prototype,"queryFeaturesDehydrated",null),w=(0,r.e)([(0,o.n)("esri.views.3d.layers.support.featureTileQuery3D.FeatureTileServiceMeshQuery3D")],w);let S=class extends r.p{constructor(e){super(e)}queryFeaturesDehydrated(e,t){return this.layer.queryFeatures(e,t)}};(0,r.e)([(0,o.y)({constructOnly:!0})],S.prototype,"layer",void 0),S=(0,r.e)([(0,o.n)("esri.views.3d.layers.support.featureTileQuery3D.FeatureTileServiceQuery3D")],S);let I=class extends r.p{constructor(e){super(e)}queryFeaturesDehydrated(e,t){return this.source.queryFeaturesJSON(e,t).then(u.z,(i=>{if(i&&"query-features-json:unsupported"===i.name)return this.layer.queryFeatures(e,t);throw i}))}queryFeatureCount(e,t){return this.layer.queryFeatureCount(e,t)}};(0,r.e)([(0,o.y)({constructOnly:!0})],I.prototype,"layer",void 0),(0,r.e)([(0,o.y)({constructOnly:!0})],I.prototype,"source",void 0),I=(0,r.e)([(0,o.n)("esri.views.3d.layers.support.featureTileQuery3D.FeatureTileClientQuery3D")],I);class C{constructor(e){this._memoryCache=null,this._capabilities=null;const t=e.layerView.layer;this.layerView=e.layerView,this.objectIdField=t.objectIdField,this.globalIdField="globalIdField"in t?t.globalIdField:null,this.returnZ=e.returnZ,this.returnM=e.returnM;const i=this.layerView.view.resourceController;this.query=function(e,t){return"feature"===e.type&&"feature-layer"===e.source.type?(0,n.r)(e.infoFor3D)?new w({layer:e}):new b({layer:e,schedule:e=>i.schedule(e)}):"feature"===e.type&&"memory"===e.source.type||"csv"===e.type||"geojson"===e.type||"wfs"===e.type?new I({layer:e,source:e.source}):"ogc-feature"===e.type?new S({layer:e}):null}(t),i&&this.memoryCacheEnabled&&(this._memoryCache=i.memoryController.getMemCache(t.uid))}get memoryCacheEnabled(){switch(this.layerView.layer.source.type){case"feature-layer":case"ogc-feature":return!0;case"csv":case"geojson":case"memory":case"wfs":return!1}}destroy(){this._memoryCache=(0,n.k)(this._memoryCache),this.query.destroy()}createQuery(){const e=this.layerView.layer.createQuery();return e.outFields=this.layerView.availableFields,e.returnZ=this.returnZ,e.returnM=this.returnM,e.outSpatialReference=this.tilingScheme.spatialReference,e}get memoryCache(){return this._memoryCache}get viewingMode(){return this.layerView.view.state.viewingMode}get tilingScheme(){return this.layerView.view.featureTiles.tilingScheme}get scheduler(){const e=this.layerView.view.resourceController;return e?e.scheduler:null}get geometryType(){return this.layerView.layer.geometryType}get fullExtent(){return this.layerView.layer.fullExtent}get tileMaxRecordCount(){return this.layerView.layer.capabilities.query.tileMaxRecordCount}get maxRecordCount(){return this.layerView.layer.capabilities.query.maxRecordCount}get capabilities(){return(0,n.r)(this._capabilities)||(this._capabilities=(0,h.U)(this.layerView.layer)),this._capabilities}logFetchError(e,t){e.error("#fetchTile()",this.layerView.layer,t&&t.message?t.message:t)}}let M=class extends((0,_.aa)((0,h.E)((0,m.R)((0,l.m)(g.d))))){constructor(e){super(e),this._controllerTotal=0,this._graphicsCoreTotal=0,this.suspendResumeExtentMode="data"}initialize(){this.updatingHandles.add(this,"view.floors",(()=>this.graphics3d.filterVisibility.filterChanged()))}destroy(){this.fetcherContext&&(this.fetcherContext.destroy(),this.fetcherContext=null)}get maximumNumberOfFeatures(){var e,t;return null!=(e=null==(t=this.controller)?void 0:t.maximumNumberOfFeatures)?e:this._get("maximumNumberOfFeatures")}set maximumNumberOfFeatures(e){this._set("maximumNumberOfFeatures",e),this.controller&&(this.controller.maximumNumberOfFeatures=e)}get maximumNumberOfFeaturesExceeded(){return!!this.controller&&!(this.suspended||!this.controller.maximumNumberOfFeaturesExceeded)}get updatingProgressValue(){var e,t,i;let r=0;if(null!=(e=this.controller)&&e.updating){const e=this.controller.updatingRemaining,t=Math.max(this.controller.updatingTotal,this._controllerTotal);t>0&&(r=(t-e)/t,this._controllerTotal=t)}let s=0;if(null!=(t=this.graphics3d)&&null!=(i=t.graphicsCore)&&i.updating){const e=this.graphics3d.graphicsCore.updatingRemaining,t=Math.max(e,this._graphicsCoreTotal);t>0&&(s=(t-e)/t,this._graphicsCoreTotal=t)}return.5*(r+s)}get updatePolicy(){if(!this.controller)return 0;switch(this.controller.mode){case"snapshot":{const e=T[this.layer.geometryType];return null==e||this.controller.serviceDataCount>e?0:1}case"tiles":return 0}}get hasZ(){const e=this.layer,t=e.capabilities&&e.capabilities.data;return!(!t||!t.supportsZ)&&("returnZ"in e&&null!=e.returnZ?e.returnZ:t.supportsZ)}get hasM(){const e=this.layer,t=e.capabilities&&e.capabilities.data;return!(!t||!t.supportsM)&&"returnM"in e&&null!=e.returnM&&e.returnM}async fetchPopupFeatures(e,t){const i=this.validateFetchPopupFeatures(t);return i?Promise.reject(i):this.fetchClientPopupFeatures(t)}setVisibility(e,t){this.graphics3d&&this.graphics3d.graphicsCore.setObjectIdVisibility(e,t)}createQuery(){return super.createQuery()}queryFeatures(e,t){const i=()=>super.queryFeatures(e,t);return"mesh"===this.layer.geometryType?this._queryFeaturesMesh(this._ensureQuery(e),i):i()}beforeSetController(e){e.maximumNumberOfFeatures=this.maximumNumberOfFeatures}createController(){this.fetcherContext=new C({layerView:this,returnZ:this.hasZ,returnM:this.hasM});const e=new h._({layerView:this,context:this.fetcherContext,graphics:new h.s,extent:this.clippingExtent});return this.updatingHandles.add(e,"serviceDataExtent",(e=>{this.graphics3d&&(this.graphics3d.dataExtent=e)}),2),this.handles.add((0,a.d)(this,"suspended",(t=>{t?e.suspend():e.resume()}),!0)),this.updatingHandles.add(this.graphics3d.graphicsCore,"displayFeatureLimit",(()=>this.updateDisplayFeatureLimit(e)),2),this.handles.add([this.view.resourceController.memoryController.events.on("quality-changed",(()=>this.updateDisplayFeatureLimit())),(0,a.O)(this,"updating",(()=>{this._controllerTotal=0,this._graphicsCoreTotal=0,this.notifyChange("updatingProgressValue")}))]),e}async doRefresh(){!this.suspended&&this.controller&&this.controller.refetch()}getUsedMemory(){const e=this.graphics3d&&this.graphics3d.graphicsCore;return(e?e.usedMemory:0)+(this.controller?this.controller.memoryForUnusedFeatures:0)}getUnloadedMemory(){const e=this.graphics3d&&this.graphics3d.graphicsCore;return(e?e.unprocessedMemoryEstimate:0)+(this.controller?this.controller.expectedFeatureDiff*e.usedMemoryPerGraphic:0)}ignoresMemoryFactor(){return this.controller&&this.controller.hasMaximumNumberOfFeaturesOverride}updateDisplayFeatureLimit(e=this.controller){if(!e||!this.graphics3d||!this.graphics3d.graphicsCore)return;const t=this.graphics3d.graphicsCore.displayFeatureLimit,i=this.view.resourceController.memoryController.memoryFactor;if(1===i)e.displayFeatureLimit=t;else{const r=Math.ceil(t.maximumNumberOfFeatures*i),s=Math.ceil(t.maximumTotalNumberOfFeatures*i),n=Math.ceil(t.minimumTotalNumberOfFeatures*i);e.displayFeatureLimit={...t,maximumNumberOfFeatures:r,maximumTotalNumberOfFeatures:s,minimumTotalNumberOfFeatures:n}}}async _queryFeaturesMesh(e,t){await this._validateQueryFeaturesMesh(e);const i=await t();if(e&&e.outStatistics)return i;const r=this.layer.objectIdField,s=this.graphics3d.graphicsCore.graphics3DGraphicsByObjectID,n=[];for(const e of i.features)if(e.geometry){const t=s.get(e.attributes[r]);t&&(e.geometry=(0,l.Z)(t.graphic.geometry),n.push(e))}else n.push(e);return i.features=n,i}async _validateQueryFeaturesMesh(e){if(!e)return;const t=e=>{throw new s.s("feature-layer-view:unsupported-query",`Queries on Mesh feature collection layers do not support '${e}'`)},i=["quantizationParameters","geometryPrecision","maxAllowableOffset"];for(const r of i)null!=e[r]&&t(r);"returnM"in e&&e.returnM&&t("returnM"),"returnCentroid"in e&&e.returnCentroid&&t("returnCentroid"),(0,n.r)(e.outSpatialReference)&&!e.outSpatialReference.equals(this.view.spatialReference)&&t("outSpatialReference")}get performanceInfo(){const e=this.controller&&this.controller.displayFeatureLimit,t=(0,n.r)(e)&&e.averageSymbolComplexity,i=(0,n.r)(t)?`f:${t.primitivesPerFeature},v:${t.primitivesPerCoordinate}`:"n/a",r={...this._getResourceInfo(),storedFeatures:0,totalVertices:0,partial:this.maximumNumberOfFeaturesExceeded,mode:this.controller?this.controller.mode:"n/a",symbolComplexity:i,nodes:this.controller?this.controller.tileDescriptors.length:0};if(this.controller&&r.displayedNumberOfFeatures){const e=this.controller.debug;r.storedFeatures=e.storedFeatures,r.totalVertices=e.totalVertices}return r}get test(){return{updatePolicy:this.updatePolicy,controller:this.controller}}};(0,r.e)([(0,o.y)()],M.prototype,"layer",void 0),(0,r.e)([(0,o.y)()],M.prototype,"controller",void 0),(0,r.e)([(0,o.y)()],M.prototype,"maximumNumberOfFeatures",null),(0,r.e)([(0,o.y)()],M.prototype,"maximumNumberOfFeaturesExceeded",null),(0,r.e)([(0,o.y)(l.z)],M.prototype,"updatingProgress",void 0),(0,r.e)([(0,o.y)({readOnly:!0,dependsOn:["controller.updatingRemaining","controller.updatingTotal","graphics3d.graphicsCore.updatingRemaining"]})],M.prototype,"updatingProgressValue",null),(0,r.e)([(0,o.y)({readOnly:!0})],M.prototype,"updatePolicy",null),(0,r.e)([(0,o.y)({readOnly:!0})],M.prototype,"hasZ",null),(0,r.e)([(0,o.y)({readOnly:!0})],M.prototype,"hasM",null),(0,r.e)([(0,o.y)()],M.prototype,"suspendResumeExtentMode",void 0),M=(0,r.e)([(0,o.n)("esri.views.3d.layers.FeatureLayerViewBase3D")],M);const T={point:5e3,polygon:500,polyline:1e3};var E=M},90258:(e,t,i)=>{"use strict";i.d(t,{h:()=>u,t:()=>l}),i(33807),i(80987);var r=i(80219),s=i(83618),n=i(29831),a=i(91728),o=i(89710);class l{constructor(e,t){this._mask=0,this._buf=e,this._mask=t}static fromBuffer(e,t){return new l(e,t)}static create(e,t=4294967295){const i=new Uint32Array(Math.ceil(e/32));return new l(i,t)}_getIndex(e){return Math.floor(e/32)}has(e){const t=this._mask&e;return!!(this._buf[this._getIndex(t)]&1<<t%32)}hasRange(e,t){let i=e,r=t;for(;i%32&&i!==r;){if(this.has(i))return!0;i++}for(;r%32&&i!==r;){if(this.has(i))return!0;r--}if(i===r)return!1;for(let e=i/32;e!==r/32;e++)if(this._buf[e])return!0;return!1}set(e){const t=this._mask&e,i=this._getIndex(t),r=1<<t%32;this._buf[i]|=r}setRange(e,t){let i=e,r=t;for(;i%32&&i!==r;)this.set(i++);for(;r%32&&i!==r;)this.set(r--);if(i!==r)for(let e=i/32;e!==r/32;e++)this._buf[e]=4294967295}unset(e){const t=this._mask&e,i=this._getIndex(t),r=1<<t%32;this._buf[i]&=4294967295^r}resize(e){const t=this._buf,i=new Uint32Array(Math.ceil(e/32));i.set(t),this._buf=i}or(e){for(let t=0;t<this._buf.length;t++)this._buf[t]|=e._buf[t];return this}and(e){for(let t=0;t<this._buf.length;t++)this._buf[t]&=e._buf[t];return this}xor(e){for(let t=0;t<this._buf.length;t++)this._buf[t]^=e._buf[t];return this}ior(e){for(let t=0;t<this._buf.length;t++)this._buf[t]|=~e._buf[t];return this}iand(e){for(let t=0;t<this._buf.length;t++)this._buf[t]&=~e._buf[t];return this}ixor(e){for(let t=0;t<this._buf.length;t++)this._buf[t]^=~e._buf[t];return this}any(){for(let e=0;e<this._buf.length;e++)if(this._buf[e])return!0;return!1}copy(e){for(let t=0;t<this._buf.length;t++)this._buf[t]=e._buf[t];return this}clone(){return new l(this._buf.slice(),this._mask)}clear(){for(let e=0;e<this._buf.length;e++)this._buf[e]=0}forEachSet(e){for(let t=0;t<this._buf.length;t++){let i=this._buf[t],r=32*t;if(i)for(;i;)1&i&&e(r),i>>>=1,r++}}countSet(){let e=0;return this.forEachSet((t=>{e++})),e}}let h=0;class u{constructor(e){this.type="FeatureSetReader",this.seen=!1,this.instance=0,this._tx=0,this._ty=0,this._sx=1,this._sy=1,this._deleted=null,this._joined=[],this._objectIdToIndex=null,this.instance=e}static createInstance(){return h++,h=h>65535?0:h,h}get isEmpty(){return(0,r.r)(this._deleted)&&this._deleted.countSet()===this.getSize()}setArcadeSpatialReference(e){this._arcadeSpatialReference=e}attachStorage(e){this._storage=e}getQuantizationTransform(){throw new Error("Unable to find transform for featureSet")}getStorage(){return this._storage}getComputedNumeric(e){return this.getComputedNumericAtIndex(0)}setComputedNumeric(e,t){return this.setComputedNumericAtIndex(t,0)}getComputedString(e){return this.getComputedStringAtIndex(0)}setComputedString(e,t){return this.setComputedStringAtIndex(0,t)}getComputedNumericAtIndex(e){return this._storage.getComputedNumericAtIndex(this.getDisplayId(),e)}setComputedNumericAtIndex(e,t){this._storage.setComputedNumericAtIndex(this.getDisplayId(),e,t)}getComputedStringAtIndex(e){return this._storage.getComputedStringAtIndex(this.getDisplayId(),e)}setComputedStringAtIndex(e,t){return this._storage.setComputedStringAtIndex(this.getDisplayId(),e,t)}transform(e,t,i,r){const s=this.copy();return s._tx+=e,s._ty+=t,s._sx*=i,s._sy*=r,s}readAttribute(e,t=!1){const i=this._readAttribute(e,t);if(void 0!==i)return i;for(const i of this._joined){i.setIndex(this.getIndex());const r=i._readAttribute(e,t);if(void 0!==r)return r}}readAttributes(){const e=this._readAttributes();for(const t of this._joined){t.setIndex(this.getIndex());const i=t._readAttributes();for(const t of Object.keys(i))e[t]=i[t]}return e}joinAttributes(e){this._joined.push(e)}readArcadeFeature(){return this}geometry(){const e=this.readHydratedGeometry(),t=(0,n.e)(e,this.geometryType,this.hasZ,this.hasM),i=(0,o.p)(t);return i&&(i.spatialReference=this._arcadeSpatialReference),i}field(e){return this.readAttribute(e,!0)}hasField(e){return!0}setField(e,t){}keys(){return[]}castToText(){return""}removeIds(e){if((0,r.t)(this._objectIdToIndex)){const e=new Map,t=this.getCursor();for(;t.next();)e.set(t.getObjectId(),t.getIndex());this._objectIdToIndex=e}const t=this._objectIdToIndex;for(const i of e)t.has(i)&&this.removeAtIndex(t.get(i))}removeAtIndex(e){(0,r.t)(this._deleted)&&(this._deleted=l.create(this.getSize())),this._deleted.set(e)}*features(){const e=this.getCursor();for(;e.next();)yield e.readOptimizedFeature()}_getExists(){return(0,r.t)(this._deleted)||!this._deleted.has(this.getIndex())}_computeCentroid(){if("esriGeometryPolygon"!==this.geometryType)return null;const e=this.readUnquantizedGeometry();if(!e||e.hasIndeterminateRingOrder)return null;const t=(0,r.q)(this.getQuantizationTransform(),null);return(0,s.t)(new a.a,e,this.hasM,this.hasZ,t)}copyInto(e){e.seen=this.seen,e._storage=this._storage,e._arcadeSpatialReference=this._arcadeSpatialReference,e._joined=this._joined,e._tx=this._tx,e._ty=this._ty,e._sx=this._sx,e._sy=this._sy,e._deleted=this._deleted,e._objectIdToIndex=this._objectIdToIndex}}},61164:(e,t,i)=>{"use strict";i.d(t,{e:()=>d,u:()=>p});var r=i(20215),s=i(80987),n=i(80219),a=i(53185),o=i(58404),l=i(29831),h=i(38624),u=i(66954);const c={minX:0,minY:0,maxX:0,maxY:0};class d{constructor(){this._indexInvalid=!1,this._boundsToLoad=[],this._boundsById=new Map,this._idByBounds=new Map,this._index=new h.h(9,(0,n.c)("csp-restrictions")?e=>({minX:e[0],minY:e[1],maxX:e[2],maxY:e[3]}):["[0]","[1]","[2]","[3]"]),this._loadIndex=()=>{if(this._indexInvalid){const e=new Array(this._idByBounds.size);let t=0;this._idByBounds.forEach(((i,r)=>{e[t++]=r})),this._indexInvalid=!1,this._index.clear(),this._index.load(e)}else this._boundsToLoad.length&&(this._index.load(this._boundsToLoad.filter((e=>this._idByBounds.has(e)))),this._boundsToLoad.length=0)}}clear(){this._indexInvalid=!1,this._boundsToLoad.length=0,this._boundsById.clear(),this._idByBounds.clear(),this._index.clear()}delete(e){const t=this._boundsById.get(e);this._boundsById.delete(e),t&&(this._idByBounds.delete(t),this._indexInvalid||this._index.remove(t))}forEachInBounds(e,t){this._loadIndex(),function(e,t,i){c.minX=t[0],c.minY=t[1],c.maxX=t[2],c.maxY=t[3],e.search(c,i)}(this._index,e,(e=>t(this._idByBounds.get(e))))}get(e){return this._boundsById.get(e)}has(e){return this._boundsById.has(e)}invalidateIndex(){this._indexInvalid||(this._indexInvalid=!0,this._boundsToLoad.length=0)}set(e,t){if(!this._indexInvalid){const t=this._boundsById.get(e);t&&(this._index.remove(t),this._idByBounds.delete(t))}this._boundsById.set(e,t),t&&(this._idByBounds.set(t,e),this._indexInvalid||(this._boundsToLoad.push(t),this._boundsToLoad.length>5e4&&this._loadIndex()))}}class p{constructor(e){this.geometryInfo=e,this._boundsStore=new d,this._featuresById=new Map,this._markedIds=new Set,this.events=new s.n,this.featureAdapter=u.o}get geometryType(){return this.geometryInfo.geometryType}get hasM(){return this.geometryInfo.hasM}get hasZ(){return this.geometryInfo.hasZ}get numFeatures(){return this._featuresById.size}get fullBounds(){if(!this.numFeatures)return null;const e=(0,o.i)(o.J);return this._featuresById.forEach((t=>{const i=this._boundsStore.get(t.objectId);i&&(e[0]=Math.min(i[0],e[0]),e[1]=Math.min(i[1],e[1]),e[2]=Math.max(i[2],e[2]),e[3]=Math.max(i[3],e[3]))})),e}get storeStatistics(){let e=0;return this._featuresById.forEach((t=>{t.geometry&&t.geometry.coords&&(e+=t.geometry.coords.length)})),{featureCount:this._featuresById.size,vertexCount:e/(this.hasZ?this.hasM?4:3:this.hasM?3:2)}}add(e){this._add(e),this._emitChanged()}addMany(e){for(const t of e)this._add(t);this._emitChanged()}clear(){this._featuresById.clear(),this._boundsStore.clear(),this._emitChanged()}removeById(e){const t=this._featuresById.get(e);return t?(this._remove(t),this._emitChanged(),t):null}removeManyById(e){this._boundsStore.invalidateIndex();for(const t of e){const e=this._featuresById.get(t);e&&this._remove(e)}this._emitChanged()}forEachBounds(e,t,i){for(const r of e){const e=this._boundsStore.get(r.objectId);e&&t((0,a.O)(i,e))}}getFeature(e){return this._featuresById.get(e)}has(e){return this._featuresById.has(e)}forEach(e){this._featuresById.forEach((t=>e(t)))}forEachInBounds(e,t){this._boundsStore.forEachInBounds(e,(e=>{t(this._featuresById.get(e))}))}startMarkingUsedFeatures(){this._boundsStore.invalidateIndex(),this._markedIds.clear()}sweep(){let e=!1;this._featuresById.forEach(((t,i)=>{this._markedIds.has(i)||(e=!0,this._remove(t))})),this._markedIds.clear(),e&&this._emitChanged()}_emitChanged(){this.events.emit("changed",void 0)}_add(e){if(!e)return;const t=e.objectId;if(null==t)return void n.n.getLogger("esri.layers.graphics.data.FeatureStore").error(new r.s("featurestore:invalid-feature","feature id is missing",{feature:e}));const i=this._featuresById.get(t);let s;if(this._markedIds.add(t),i?(e.displayId=i.displayId,s=this._boundsStore.get(t),this._boundsStore.delete(t)):(0,n.r)(this.onFeatureAdd)&&this.onFeatureAdd(e),!e.geometry||!e.geometry.coords||!e.geometry.coords.length)return this._boundsStore.set(t,null),void this._featuresById.set(t,e);s=(0,l.f)(s||(0,o.i)(),e.geometry,this.geometryInfo.hasZ,this.geometryInfo.hasM),this._boundsStore.set(t,s),this._featuresById.set(t,e)}_remove(e){return(0,n.r)(this.onFeatureRemove)&&this.onFeatureRemove(e),this._markedIds.delete(e.objectId),this._boundsStore.delete(e.objectId),this._featuresById.delete(e.objectId),e}}},13074:(e,t,i)=>{"use strict";i.d(t,{l:()=>_,o:()=>d,r:()=>p,u:()=>g});var r=i(30466),s=i(80987),n=i(80219),a=i(84352),o=i(53185),l=i(84271),h=i(52957),u=i(90258);const c=Promise.resolve().then(i.bind(i,84796));class d{constructor(e,t){this._canCacheExpressionValue=!1,this._sourceInfo=e,this._bitsets={computed:t.getBitset(t.createBitset())}}invalidate(){this._bitsets.computed.clear()}async updateSchema(e,t){const i=(0,l.m)(this._schema,t);if(this._schema=t,!t||(0,n.t)(i)||!(0,l.a)(i,"attributes"))return;(0,n.c)("esri-2d-update-debug")&&console.debug("Applying Update - Store:",i),this._bitsets.computed.clear(),e.targets[t.name]=!0;const r=t.attributes,s=[],a=[];for(const e in r){const t=r[e];switch(t.type){case"field":break;case"expression":s.push(this._createArcadeComputedField(t));break;case"label-expression":s.push(this._createLabelArcadeComputedField(t));break;case"statistic":a.push(t)}}this._computedFields=await Promise.all(s),this._canCacheExpressionValue=!this._computedFields.some((e=>"expression"===e.type&&e.expression.referencesScale())),this._statisticFields=a}setComputedAttributes(e,t,i,r){const s=this._bitsets.computed;if(!this._canCacheExpressionValue||!s.has(i)){s.set(i);for(const s of this._computedFields){const n=this._evaluateField(t,s,r);switch(s.resultType){case"numeric":e.setComputedNumericAtIndex(i,s.fieldIndex,n);break;case"string":e.setComputedStringAtIndex(i,s.fieldIndex,n)}}}}async _createArcadeComputedField(e){const t=this._sourceInfo.spatialReference,i=this._sourceInfo.fieldsIndex;return{...e,expression:await(0,h.j)(e.valueExpression,t,i)}}async _createLabelArcadeComputedField(e){const t=this._sourceInfo.spatialReference,i=this._sourceInfo.fieldsIndex,{createLabelFunction:r}=await c,s=await r(e.label,i,t);return{...e,builder:s}}_evaluateField(e,t,i){switch(t.type){case"label-expression":{const i=e.readArcadeFeature();return t.builder.evaluate(i)||""}case"expression":{const{expression:r}=t;return function(e,t,i){e.referencesGeometry();const r=t.readArcadeFeature();try{return e.evaluate({...i,$feature:r})}catch(e){return n.n.getLogger("esri.views.2d.support.arcadeOnDemand").warn("Feature arcade evaluation failed:",e),null}}(r,e,{$view:{scale:i}})}}}}class p extends u.h{constructor(e,t){super(u.h.createInstance()),this._currentIndex=-1,this._reader=e,this._indices=t}static from(e,t){return new p(e.copy(),t)}get hasNext(){return this._currentIndex+1<this._indices.length}getSize(){return this._indices.length}getCursor(){return this.copy()}copy(){const e=new p(this._reader.copy(),this._indices);return e._currentIndex=this._currentIndex,e}next(){for(;this._nextIndex()&&!this._reader._getExists(););return this._currentIndex<this._indices.length}_nextIndex(){return++this._currentIndex<this._indices.length&&(this._reader.setIndex(this._indices[this._currentIndex]),!0)}setArcadeSpatialReference(e){this._reader.setArcadeSpatialReference(e)}attachStorage(e){this._reader.attachStorage(e)}get geometryType(){return this._reader.geometryType}get hasFeatures(){return this._reader.hasFeatures}get exceededTransferLimit(){return this._reader.exceededTransferLimit}get hasZ(){return this._reader.hasZ}get hasM(){return this._reader.hasM}getStorage(){return this._reader.getStorage()}getComputedNumeric(e){return this._reader.getComputedNumericAtIndex(0)}setComputedNumeric(e,t){return this._reader.setComputedNumericAtIndex(t,0)}getComputedString(e){return this._reader.getComputedStringAtIndex(0)}setComputedString(e,t){return this._reader.setComputedStringAtIndex(0,t)}getComputedNumericAtIndex(e){return this._reader.getComputedNumericAtIndex(e)}setComputedNumericAtIndex(e,t){this._reader.setComputedNumericAtIndex(e,t)}getComputedStringAtIndex(e){return this._reader.getComputedStringAtIndex(e)}setComputedStringAtIndex(e,t){return this._reader.setComputedStringAtIndex(e,t)}transform(e,t,i,r){const s=this.copy();return s._reader=this._reader.transform(e,t,i,r),s}readAttribute(e,t=!1){return this._reader.readAttribute(e,t)}readAttributes(){return this._reader.readAttributes()}joinAttributes(e){return this._reader.joinAttributes(e)}readArcadeFeature(){return this._reader.readArcadeFeature()}geometry(){return this._reader.geometry()}field(e){return this.readAttribute(e,!0)}hasField(e){return this._reader.hasField(e)}setField(e,t){return this._reader.setField(e,t)}keys(){return this._reader.keys()}castToText(){return this._reader.castToText()}getQuantizationTransform(){return this._reader.getQuantizationTransform()}getAttributeHash(){return this._reader.getAttributeHash()}getObjectId(){return this._reader.getObjectId()}getDisplayId(){return this._reader.getDisplayId()}setDisplayId(e){return this._reader.setDisplayId(e)}getGroupId(){return this._reader.getGroupId()}setGroupId(e){return this._reader.setGroupId(e)}getXHydrate(){return this._reader.getXHydrate()}getYHydrate(){return this._reader.getYHydrate()}getX(){return this._reader.getX()}getY(){return this._reader.getY()}setIndex(e){return this._reader.setIndex(e)}getIndex(){return this._reader.getIndex()}readLegacyFeature(){return this._reader.readLegacyFeature()}readOptimizedFeature(){return this._reader.readOptimizedFeature()}readLegacyPointGeometry(){return this._reader.readLegacyPointGeometry()}readLegacyGeometry(){return this._reader.readLegacyGeometry()}readLegacyCentroid(){return this._reader.readLegacyCentroid()}readGeometryArea(){return this._reader.readGeometryArea()}readUnquantizedGeometry(){return this._reader.readUnquantizedGeometry()}readHydratedGeometry(){return this._reader.readHydratedGeometry()}readGeometry(){return this._reader.readGeometry()}readCentroid(){return this._reader.readCentroid()}_readAttribute(e,t){throw new Error("Error: Should not be called. Underlying _reader should be used instead")}_readAttributes(){throw new Error("Error: Should not be called. Underlying _reader should be used instead")}}function f(e,t){return e<<16|t}function y(e){return(4294901760&e)>>>16}function m(e){return 65535&e}const g={getObjectId:e=>e.getObjectId(),getAttributes:e=>e.readAttributes(),getAttribute:(e,t)=>e.readAttribute(t),cloneWithGeometry:(e,t)=>e,getGeometry:e=>e.readHydratedGeometry(),getCentroid:(e,t)=>e.readCentroid()};class _ extends d{constructor(e,t,i){super(e,t),this.featureAdapter=g,this.events=new s.n,this._featureSetsByInstance=new Map,this._objectIdToDisplayId=new Map,this._spatialIndexInvalid=!0,this._indexSearchCache=new r.s(50),this._index=(0,a.i)(9,(e=>({minX:this._storage.getXMin(e),minY:this._storage.getYMin(e),maxX:this._storage.getXMax(e),maxY:this._storage.getYMax(e)}))),this._storage=t,this.mode=i}get storage(){return this._storage}get storeStatistics(){return{featureCount:0,vertexCount:0}}hasInstance(e){return this._featureSetsByInstance.has(e)}onTileData(e,t){if((0,n.t)(t.addOrUpdate))return t;if(t.addOrUpdate.attachStorage(this._storage),"snapshot"===this.mode){const i=t.addOrUpdate.getCursor();for(;i.next();){const t=i.getDisplayId();this.setComputedAttributes(this._storage,i,t,e.scale)}return t}this._featureSetsByInstance.set(t.addOrUpdate.instance,t.addOrUpdate);const i=t.addOrUpdate.getCursor();for(;i.next();)this._insertFeature(i,e.scale);return this._spatialIndexInvalid=!0,this.events.emit("changed"),t}search(e){this._rebuildIndex();const t=e.id,i=this._indexSearchCache.find((e=>e.tileId===t));if((0,n.r)(i))return i.readers;const r=new Map,s=this._searchIndex(e.bounds),a=[];for(const e of s){const t=this._storage.getInstanceId(e),i=y(t),s=m(t);r.has(i)||r.set(i,[]),r.get(i).push(s)}return r.forEach(((e,t)=>{const i=this._featureSetsByInstance.get(t);a.push(p.from(i,e))})),this._indexSearchCache.enqueue({tileId:t,readers:a}),a}insert(e){const t=e.getCursor(),i=this._storage;for(;t.next();){var r;const e=f(t.instance,t.getIndex()),s=t.getObjectId(),n=null!=(r=this._objectIdToDisplayId.get(s))?r:this._storage.createDisplayId();t.setDisplayId(n),i.setInstanceId(n,e),this._objectIdToDisplayId.set(s,n)}this._featureSetsByInstance.set(e.instance,e),this._spatialIndexInvalid=!0}remove(e){const t=this._objectIdToDisplayId.get(e);if(!t)return;const i=this._storage.getInstanceId(t),r=m(i),s=y(i),n=this._featureSetsByInstance.get(s);this._objectIdToDisplayId.delete(e),this._storage.releaseDisplayId(t),n.removeAtIndex(r),n.isEmpty&&this._featureSetsByInstance.delete(s),this._spatialIndexInvalid=!0}forEach(e){this._objectIdToDisplayId.forEach((t=>{const i=this._storage.getInstanceId(t),r=this._lookupFeature(i);e(r)}))}forEachUnsafe(e){this._objectIdToDisplayId.forEach((t=>{const i=this._storage.getInstanceId(t),r=y(i),s=m(i),n=this._getFeatureSet(r);n.setIndex(s),e(n)}))}forEachInBounds(e,t){const i=this._searchIndex(e);for(const e of i){const i=this.lookupFeatureByDisplayId(e,this._storage);t((0,n.f)(i))}}forEachBounds(e,t,i){this._rebuildIndex();const r=[0,0,0,0];for(const s of e){if(!s.readGeometry())continue;const e=s.getDisplayId();r[0]=this._storage.getXMin(e),r[1]=this._storage.getYMin(e),r[2]=this._storage.getXMax(e),r[3]=this._storage.getYMax(e),t((0,o.O)(i,r))}}sweepFeatures(e,t,i){this._spatialIndexInvalid=!0,this._objectIdToDisplayId.forEach(((r,s)=>{e.has(r)||(t.releaseDisplayId(r),i&&i.unsetAttributeData(r),this._objectIdToDisplayId.delete(s))})),this.events.emit("changed")}sweepFeatureSets(e){this._spatialIndexInvalid=!0,this._featureSetsByInstance.forEach(((t,i)=>{e.has(i)||this._featureSetsByInstance.delete(i)}))}lookupObjectId(e,t){const i=this.lookupFeatureByDisplayId(e,t);return(0,n.t)(i)?null:i.getObjectId()}lookupDisplayId(e){return this._objectIdToDisplayId.get(e)}lookupFeatureByDisplayId(e,t){const i=t.getInstanceId(e);return this._lookupFeature(i)}lookupByDisplayIdUnsafe(e){const t=this._storage.getInstanceId(e),i=y(t),r=m(t),s=this._getFeatureSet(i);return s?(s.setIndex(r),s):null}_insertFeature(e,t){const i=this._storage,r=e.getObjectId(),s=f(e.instance,e.getIndex());i.getInstanceId(e.getDisplayId());let n=this._objectIdToDisplayId.get(r);n||(n=i.createDisplayId(),this._objectIdToDisplayId.set(r,n),this._spatialIndexInvalid=!0),e.setDisplayId(n),i.setInstanceId(n,s),this.setComputedAttributes(i,e,n,t)}_searchIndex(e){this._rebuildIndex();const t={minX:e[0],minY:e[1],maxX:e[2],maxY:e[3]};return this._index.search(t)}_rebuildIndex(){if(!this._spatialIndexInvalid)return;const e=[];"snapshot"===this.mode?this._featureSetsByInstance.forEach((t=>{const i=t.getCursor();for(;i.next();){const t=i.getDisplayId();this._storage.setBounds(t,i)&&e.push(t)}})):this._objectIdToDisplayId.forEach((t=>{const i=this._storage.getInstanceId(t);this._storage.setBounds(t,this._lookupFeature(i))&&e.push(t)})),this._index.clear(),this._index.load(e),this._indexSearchCache.clear(),this._spatialIndexInvalid=!1}_lookupFeature(e){const t=y(e),i=m(e),r=this._getFeatureSet(t);if(!r)return null;const s=r.getCursor();return s.setIndex(i),s}_getFeatureSet(e){return this._featureSetsByInstance.get(e)}}},55753:(e,t,i)=>{"use strict";i.d(t,{l:()=>h});var r=i(80987),s=i(80219),n=i(20215),a=i(16040),o=i(52109),l=i(76326);class h{constructor(e,t,i,r){this.parsedUrl=e,this.portalItem=t,this.apiKey=i,this.signal=r,this.rootDocument=null;const s=this.parsedUrl.path.match(/^(.*)\/SceneServer\/layers\/([\d]*)\/?$/i);s&&(this.urlParts={root:s[1],layerId:parseInt(s[2],10)})}async fetch(){var e;if(!this.urlParts)return null;const t=null!=(e=this.portalItem)?e:await this.portalItemFromServiceItemId();if((0,s.t)(t))return this.loadFromUrl();const i=await this.findAndLoadRelatedPortalItem(t);return(0,s.t)(i)?null:this.loadFeatureLayerFromPortalItem(i)}async fetchPortalItem(){var e;if(!this.urlParts)return null;const t=null!=(e=this.portalItem)?e:await this.portalItemFromServiceItemId();return(0,s.t)(t)?null:this.findAndLoadRelatedPortalItem(t)}async fetchRootDocument(){if((0,s.r)(this.rootDocument))return this.rootDocument;if((0,s.t)(this.urlParts))return this.rootDocument={},{};const e={query:{f:"json",token:this.apiKey},responseType:"json",signal:this.signal},t=`${this.urlParts.root}/SceneServer`;try{const i=await(0,r.L)(t,e);this.rootDocument=i.data}catch{this.rootDocument={}}return this.rootDocument}async fetchServiceOwningPortalUrl(){var e;const t=null==(e=r.a)?void 0:e.findServerInfo(this.parsedUrl.path);if(null!=t&&t.owningSystemUrl)return t.owningSystemUrl;const i=this.parsedUrl.path.replace(/(.*\/rest)\/.*/i,"$1")+"/info";try{const e=(await(0,r.L)(i,{query:{f:"json"},responseType:"json",signal:this.signal})).data.owningSystemUrl;if(e)return e}catch(e){(0,n.w)(e)}return null}async findAndLoadRelatedPortalItem(e){try{return(await e.fetchRelatedItems({relationshipType:"Service2Service",direction:"reverse"},{signal:this.signal})).find((e=>"Feature Service"===e.type))||null}catch(e){return(0,n.w)(e),null}}async loadFeatureLayerFromPortalItem(e){await e.load({signal:this.signal});const t=await this.findMatchingAssociatedSublayerUrl(e.url);return new a.W({url:t,portalItem:e}).load({signal:this.signal})}async loadFromUrl(){const e=await this.findMatchingAssociatedSublayerUrl(`${this.urlParts.root}/FeatureServer`);return new a.W({url:e}).load({signal:this.signal})}async findMatchingAssociatedSublayerUrl(e){const t=e.replace(/^(.*FeatureServer)(\/[\d]*\/?)?$/i,"$1"),i={query:{f:"json"},responseType:"json",authMode:"no-prompt",signal:this.signal},s=this.urlParts.layerId,n=this.fetchRootDocument(),a=(0,r.L)(t,i),[o,l]=await Promise.all([a,n]),h=l&&l.layers,u=o.data&&o.data.layers;if(!Array.isArray(u))throw new Error("expected layers array");if(Array.isArray(h)){for(let e=0;e<Math.min(h.length,u.length);e++)if(h[e].id===s)return`${t}/${u[e].id}`}else if(s<u.length)return`${t}/${u[s].id}`;throw new Error("could not find matching associated sublayer")}async portalItemFromServiceItemId(){const e=(await this.fetchRootDocument()).serviceItemId;if(!e)return null;const t=new l.default({id:e,apiKey:this.apiKey}),i=await this.fetchServiceOwningPortalUrl();(0,s.r)(i)&&(t.portal=new o.G({url:i}));try{return t.load({signal:this.signal})}catch(e){return(0,n.w)(e),null}}}},65990:(e,t,i)=>{"use strict";i.d(t,{a:()=>l});var r=i(78155),s=i(31531),n=i(88903);i(80219);const a=new s.o({esriJobMessageTypeInformative:"informative",esriJobMessageTypeProcessDefinition:"process-definition",esriJobMessageTypeProcessStart:"process-start",esriJobMessageTypeProcessStop:"process-stop",esriJobMessageTypeWarning:"warning",esriJobMessageTypeError:"error",esriJobMessageTypeEmpty:"empty",esriJobMessageTypeAbort:"abort"});let o=class extends r.a{constructor(e){super(e),this.description=null,this.type=null}};(0,r.e)([(0,n.y)({type:String,json:{write:!0}})],o.prototype,"description",void 0),(0,r.e)([(0,n.y)({type:String,json:{read:a.read,write:a.write}})],o.prototype,"type",void 0),o=(0,r.e)([(0,n.n)("esri.rest.support.GPMessage")],o);var l=o},2098:(e,t,i)=>{"use strict";i.d(t,{M:()=>o,P:()=>l,g:()=>h,h:()=>a});const r=128/Math.PI,s=1/Math.LN2;function n(e,t){return(e%=t)>=0?e:e+t}function a(e){return n(e*r,256)}function o(e){return n(.7111111111111111*e,256)}function l(e){return Math.log(e)*s}function h(e,t,i){return e>=t&&e<=i||e>=i&&e<=t}},68874:(e,t,i)=>{"use strict";i.d(t,{i:()=>n});var r=i(5772),s=i(68683);class n extends s.t{renderChildren(e){this.attributeView.bindTextures(e.context),this.children.some((e=>e.hasData))&&(super.renderChildren(e),e.drawPhase===r.I.MAP&&this._renderChildren(e),e.drawPhase===r.I.HIGHLIGHT&&this._renderHighlight(e))}_renderHighlight(e){const{painter:t}=e,i=t.effects.highlight;i.bind(e),this._renderChildren(e,i.defines),i.draw(e),i.unbind()}}},70448:(e,t,i)=>{"use strict";i.d(t,{p:()=>E,v:()=>P});var r=i(78155),s=i(73574),n=i(30316),a=i(83731),o=i(20215),l=i(36845),h=i(88903),u=i(80219),c=i(84271),d=i(20736),p=i(18143),f=i(32422),y=i(42413),m=i(54325),g=i(80987),_=i(98548),x=i(55807),v=i(52737),b=i(26554),w=i(31393),S=i(1357),I=i(6129),C=i(32769);const M=x.H;let T=class extends r.p{constructor(e){super(e),this._dataQueryEngineInstance=null}get queryGeometryType(){switch(this.layer.geometryType){case"multipoint":case"point":case"polygon":case"polyline":return this.layer.geometryType;case"mesh":return"polygon";default:return}}get defaultQueryJSON(){return new p.b({outSpatialReference:this.spatialReference}).toJSON()}get dataQueryEngine(){return this.ensureDataQueryEngine()}destroy(){this.clear()}clear(){return!!this._dataQueryEngineInstance&&(this._dataQueryEngineInstance.destroy(),this._dataQueryEngineInstance=null,!0)}async executeQueryForIdSet(e,t){return this.dataQueryEngine.executeQueryForIdSet(this._ensureQueryJSON(e),t)}async executeQueryForCount(e,t){return this.dataQueryEngine.executeQueryForCount(this._ensureQueryJSON(e),t)}async executeQueryForExtent(e,t){const{count:i,extent:r}=await this.dataQueryEngine.executeQueryForExtent(this._ensureQueryJSON(e),t);return{count:i,extent:_.M.fromJSON(r)}}async executeQueryForIds(e,t){return this.dataQueryEngine.executeQueryForIds(this._ensureQueryJSON(e),t)}async executeQueryForLatestObservations(e,t){const i=await this.dataQueryEngine.executeQueryForLatestObservations(this._ensureQueryJSON(e),t),r=v.default.fromJSON(i);return r.features.forEach((e=>{e.layer=this.layer,e.sourceLayer=this.layer})),r}async executeQuery(e,t){const i=await this.dataQueryEngine.executeQuery(this._ensureQueryJSON(e),t),r=v.default.fromJSON(i);return r.features.forEach((e=>{e.layer=this.layer,e.sourceLayer=this.layer})),r}_ensureQueryJSON(e){return(0,u.t)(e)?this.defaultQueryJSON:("outSpatialReference"in e&&!e.outSpatialReference&&(e.outSpatialReference=this.spatialReference),e.toJSON())}ensureDataQueryEngine(){if(this._dataQueryEngineInstance)return this._dataQueryEngineInstance;const e="timeInfo"in this.layer&&this.layer.timeInfo&&this.layer.timeInfo.toJSON()||null,t=this.layer.objectIdField,i=g.i.toJSON(this.queryGeometryType),r=this.layer.fields.map((e=>e.toJSON())),s=this.layerView.view.resourceController.scheduler,n=this.priority,a=this.spatialReference.toJSON(),o=this.layerView.graphics3d.graphicsCore.featureStore,{hasZ:l,hasM:h}=this.layerView;return this._dataQueryEngineInstance=new M({hasZ:l,hasM:h,geometryType:i,fields:r,timeInfo:e,spatialReference:a,objectIdField:t,featureStore:o,scheduler:s,priority:n}),this._dataQueryEngineInstance}};(0,r.e)([(0,h.y)({constructOnly:!0})],T.prototype,"layerView",void 0),(0,r.e)([(0,h.y)({constructOnly:!0})],T.prototype,"priority",void 0),(0,r.e)([(0,h.y)({readOnly:!0,aliasOf:"layerView.view.spatialReference"})],T.prototype,"spatialReference",void 0),(0,r.e)([(0,h.y)({readOnly:!0,aliasOf:"layerView.layer"})],T.prototype,"layer",void 0),(0,r.e)([(0,h.y)({readOnly:!0})],T.prototype,"queryGeometryType",null),(0,r.e)([(0,h.y)({readOnly:!0})],T.prototype,"defaultQueryJSON",null),T=(0,r.e)([(0,h.n)("esri.views.3d.layers.graphics.QueryEngine")],T);var E=T;const F=u.n.getLogger("esri.views.3d.layers.graphics.Graphics3DFilterVisibility");let A=class extends r.p{constructor(...e){super(...e),this.filter=null,this._dirty=!1,this._querying=!1,this._handles=new a.u}get updating(){return this._dirty||this._querying||null!=this._queryResult}setup(e,t){this._layerView=e,this._core=t,this._objectIdField=e.layer.objectIdField,this._queryEngine=new E({layerView:this._layerView,priority:f.p.FILTER_VISIBILITY});const i=this._layerView.view.resourceController.scheduler;this._handles.add(i.registerTask(f.p.FILTER_VISIBILITY,this)),this._handles.add((0,l.C)(t.owner,"loadedGraphics","after-changes",(e=>this._graphicsChanged(e)),(()=>this.dirty=!0))),this.filterChanged()}destroy(){this._handles.destroy(),this._handles=null,this.clear(),this._layerView=null,this._core=null}clear(){this._queryEngine.clear()&&(this._core.modifyGraphics3DGraphicVisibilities((e=>e.clearVisibilityFlag(2))),this._queryResult=null,this._querying=!1),this.dirty=!1,this.notifyChange("updating")}_graphicsChanged(e){this._queryEngine&&0==(1&e.type)||(this.dirty=!0)}updateVisibility(e){this.active&&(e.hasVisibilityFlag(2,0)||e.setVisibilityFlag(2,!1,0),this.dirty=!0)}filterChanged(){const e=this.recomputeFilter();e!==this.filter&&(this.filter=e,this.dirty=!0)}get active(){return this.filter&&this._core.graphics3DGraphics.size>0}recomputeFilter(){const e="filter"in this._layerView?this._layerView.filter:null,t="timeExtent"in this._layerView?this._layerView.timeExtent:null,i=(0,b.o)(this._layerView);if((0,u.t)(t)&&(0,u.t)(i))return e;const r=(0,u.r)(e)?e.clone():new w.y;if((0,u.r)(t)&&(r.timeExtent=(0,u.r)(r.timeExtent)?r.timeExtent.intersection(t):t),(0,u.r)(i)){const e=null==r.where||""===r.where;r.where=e?i:`(${r.where}) AND (${i})`}return r}get running(){return this._dirty&&!this._querying||null!=this._queryResult}runTask(e){this.active?(!this._dirty||this._querying||e.done||(this._querying=!0,this.dirty=!1,this._queryEngine.executeQueryForIdSet(this.filter).then((e=>{this._queryResult=e,this._querying=!1})).catch((e=>{(0,o.g)(e)||(F.warn("FeatureFilter query failed: "+e,{error:e}),this._queryResult=new Set,this._core.graphics3DGraphics.forEach((e=>this._queryResult.add(this._getFeatureId(e.graphic)))),this._querying=!1)})),e.madeProgress()),this._queryResult&&!e.done&&(this._core.modifyGraphics3DGraphicVisibilities((t=>{if(e.done)return!1;const i=this._queryResult.has(this._getFeatureId(t.graphic));return!!t.setVisibilityFlag(2,i,0)&&(e.madeProgress(),!0)})),e.done||(this._queryResult=null)),this.notifyChange("updating")):this.clear()}_getFeatureId(e){return null==e.objectId?e.attributes[this._objectIdField]:e.objectId}set dirty(e){this._dirty!==e&&(this._dirty=e,this.notifyChange("updating"))}};(0,r.e)([(0,h.y)({readOnly:!0})],A.prototype,"updating",null),A=(0,r.e)([(0,h.n)("esri.views.3d.layers.graphics.Graphics3DFilterVisibility")],A);let R=class extends r.p{constructor(e){super(e),this._handles=new a.u,this.watchUpdatingTracking=new C.l,this.suspendResumeExtentMode="computed",this.dataExtent=null,this.suspendResumeExtent=null}get suspended(){var e;return null==(e=this.scaleVisibility)?void 0:e.suspended}get suspendInfo(){var e,t;const i={};return null!=(e=this.scaleVisibility)&&e.suspended&&(i.outsideScaleRange=!0),null!=(t=this.frustumVisibility)&&t.suspended&&(i.outsideOfView=!0),i}get updating(){var e,t,i;return!!(null!=(e=this.graphicsCore)&&e.updating||null!=(t=this.frustumVisibility)&&t.updating||null!=(i=this.watchUpdatingTracking)&&i.updating)}normalizeCtorArgs(e){const t=e.frustumVisibilityEnabled?new S.p:null,i=e.scaleVisibilityEnabled?new y.y:null,r=(e.filterVisibilityEnabled||e.timeExtentVisibilityEnabled)&&"multipatch"!==e.layer.geometryType?new A:null,s=e.elevationAlignmentEnabled?new m.d:null,n=new y.O({owner:e.owner,layer:e.layer,preferredUpdatePolicy:e.preferredUpdatePolicy,elevationFeatureExpressionEnabled:e.elevationFeatureExpressionEnabled,graphicSymbolSupported:!1,hasZ:e.owner.hasZ,hasM:e.owner.hasM}),{updateClippingExtent:a,suspendResumeExtentMode:o,dataExtent:l}=e;return{graphicsCore:n,frustumVisibility:t,scaleVisibility:i,filterVisibility:r,elevationAlignment:s,updateClippingExtent:a,suspendResumeExtentMode:o,dataExtent:l}}initialize(){this.scaleVisibility&&this.watchUpdatingTracking.add(this.layer,"scaleRangeId",(()=>this.scaleVisibility.layerMinMaxScaleChangeHandler())),this.filterVisibility&&(this.watchUpdatingTracking.add(this.owner,"filter",(()=>this.filterVisibility.filterChanged())),this.watchUpdatingTracking.add(this.owner,"timeExtent",(()=>this.filterVisibility.filterChanged()))),this.elevationAlignment&&this.watchUpdatingTracking.add(this.layer,"elevationInfo",((e,t)=>{(0,c.m)(e,t)&&this.watchUpdatingTracking.addPromise(this.graphicsCore.elevationInfoChange())})),this.watchUpdatingTracking.add(this.layer,"labelsVisible",(()=>this.graphicsCore.updateVisibilityInfo())),this.watchUpdatingTracking.add(this.layer,"labelingInfo",((e,t)=>{(0,c.m)(e,t)&&this.graphicsCore.updateLabelingInfo()}))}async setup(){this.frustumVisibility&&this.frustumVisibility.setup(this.owner);const e=this.owner,t=this.owner.view.basemapTerrain,i=(e,t,i)=>this.graphicsCore.spatialIndex.queryGraphicUIDsInExtent(e,t,i);if(this.scaleVisibility&&this.scaleVisibility.setup(e,this.layer,i,this.graphicsCore,t),this.filterVisibility&&("filter"in e||"timeExtent"in e)&&this.filterVisibility.setup(e,this.graphicsCore),this.elevationAlignment){const t=e.view.elevationProvider;this.elevationAlignment.setup(e,i,this.graphicsCore,t)}this._set("objectStates",new m.s(this.graphicsCore)),this._set("labeling",this.owner.view.labeler.addGraphicsOwner(this.graphicsCore,this.scaleVisibility)),this._set("deconfliction",e.view.deconflictor.addGraphicsOwner(this.graphicsCore)),await(0,o.T)(this.graphicsCore.setup({elevationAlignment:this.elevationAlignment,scaleVisibility:this.scaleVisibility,filterVisibility:this.filterVisibility,deconflictor:this.deconfliction,labeler:this.labeling,objectStates:this.objectStates})),this.watchUpdatingTracking.add(this.layer,"renderer",(e=>this.watchUpdatingTracking.addPromise(this.graphicsCore.rendererChange(e)))),this.watchUpdatingTracking.add(e,"fullOpacity",(()=>this.graphicsCore.opacityChange())),this.setupSuspendResumeExtent(),this.updateClippingExtent&&(this.watchUpdatingTracking.add(e.view,"clippingArea",(()=>this._updateClippingExtent())),this._updateClippingExtent()),this.graphicsCore.startCreateGraphics(),this.graphicsCore.labelsEnabled&&await(0,o.T)(this.graphicsCore.updateLabelingInfo())}destroy(){this._handles&&(this._handles.destroy(),this._handles=null);const e=["watchUpdatingTracking","frustumVisibility","scaleVisibility","filterVisibility","elevationAlignment","objectStates","graphicsCore"];for(const t of e){const e=this[t];e&&(e.destroy(),this._set(t,null))}this._set("layer",null),this._set("owner",null)}maskOccludee(e){const{set:t,handle:i}=this.objectStates.acquireSet(1,null);return this.objectStates.setUid(t,e.uid),i}highlight(e,t){if(e instanceof p.b){const{set:i,handle:r}=this.objectStates.acquireSet(0,t);return this.owner.queryObjectIds(e).then((e=>this.objectStates.setObjectIds(i,e))),r}if("number"==typeof e||"string"==typeof e)return this.highlight([e],t);if(e instanceof s.h)return this.highlight([e],t);if("toArray"in e&&(e=e.toArray()),Array.isArray(e)&&e.length>0){if(e[0]instanceof s.h){const i=e;if(null==(0,I.n)(this.layer.fieldsIndex,i[0].attributes,t)){const e=i.map((e=>e.uid)),{set:t,handle:r}=this.objectStates.acquireSet(0,null);return this.objectStates.setUids(t,e),r}e=i.map((e=>(0,I.n)(this.layer.fieldsIndex,e.attributes,t)))}if("number"==typeof e[0]||"string"==typeof e[0]){const i=e,{set:r,handle:s}=this.objectStates.acquireSet(0,t);return this.objectStates.setObjectIds(r,i),s}}return D}_updateClippingExtent(){const e=this.owner.view.clippingArea;this.graphicsCore.setClippingExtent(e,this.owner.view.spatialReference)&&(this.updateClippingExtent(e)||this.graphicsCore.recreateAllGraphics())}setupSuspendResumeExtent(){(this.frustumVisibility||this.scaleVisibility)&&this._handles.add((0,l.d)(this,"suspendResumeExtentMode",(()=>{switch(this._handles.remove(L),this.suspendResumeExtentMode){case"computed":this._handles.add([(0,l.d)(this.graphicsCore,"computedExtent",(e=>this.updateSuspendResumeExtent(e))),this.graphicsCore.watch("extentPadding",(()=>this.updateSuspendResumeExtent(this.graphicsCore.computedExtent)))],L);break;case"data":this._handles.add([(0,l.d)(this,"dataExtent",(e=>this.updateSuspendResumeExtent(e))),this.graphicsCore.watch("extentPadding",(()=>this.updateSuspendResumeExtent(this.dataExtent)))],L);break;default:(0,n.n)(this.suspendResumeExtentMode)}})))}updateSuspendResumeExtent(e){e?this.suspendResumeExtentChanged(this.extentToSuspendResumeRect(e,this.suspendResumeExtent)):this.suspendResumeExtentChanged(null)}extentToSuspendResumeRect(e,t){const i=this.owner.view.spatialReference;if(!e.spatialReference.equals(i)){if(!(0,d.x)(e,i))return;e=(0,d.g)(e,i)}return(0,f.P)(e,t,f.r,this.graphicsCore.extentPadding)}suspendResumeExtentChanged(e){this.frustumVisibility&&this.frustumVisibility.setExtent(e),this.scaleVisibility&&this.scaleVisibility.setExtent(e)}};(0,r.e)([(0,h.y)({aliasOf:"graphicsCore.layer"})],R.prototype,"layer",void 0),(0,r.e)([(0,h.y)({aliasOf:"graphicsCore.owner"})],R.prototype,"owner",void 0),(0,r.e)([(0,h.y)({constructOnly:!0})],R.prototype,"updateClippingExtent",void 0),(0,r.e)([(0,h.y)({constructOnly:!0})],R.prototype,"graphicsCore",void 0),(0,r.e)([(0,h.y)({constructOnly:!0})],R.prototype,"scaleVisibility",void 0),(0,r.e)([(0,h.y)({constructOnly:!0})],R.prototype,"filterVisibility",void 0),(0,r.e)([(0,h.y)({constructOnly:!0})],R.prototype,"elevationAlignment",void 0),(0,r.e)([(0,h.y)({constructOnly:!0})],R.prototype,"frustumVisibility",void 0),(0,r.e)([(0,h.y)({readOnly:!0})],R.prototype,"deconfliction",void 0),(0,r.e)([(0,h.y)({readOnly:!0})],R.prototype,"labeling",void 0),(0,r.e)([(0,h.y)({readOnly:!0})],R.prototype,"objectStates",void 0),(0,r.e)([(0,h.y)({readOnly:!0})],R.prototype,"watchUpdatingTracking",void 0),(0,r.e)([(0,h.y)()],R.prototype,"suspendResumeExtentMode",void 0),(0,r.e)([(0,h.y)()],R.prototype,"dataExtent",void 0),(0,r.e)([(0,h.y)({readOnly:!0})],R.prototype,"suspended",null),(0,r.e)([(0,h.y)({readOnly:!0})],R.prototype,"suspendInfo",null),(0,r.e)([(0,h.y)({readOnly:!0,dependsOn:["graphicsCore.updating","frustumVisibility.updating","watchUpdatingTracking.updating"]})],R.prototype,"updating",null),R=(0,r.e)([(0,h.n)("esri.views.3d.layers.graphics.Graphics3DFeatureLikeLayerView")],R);var P=R;const L="suspendResumeExtentMode",D={remove(){},pause(){},resume(){}}},1357:(e,t,i)=>{"use strict";i.d(t,{p:()=>u});var r=i(78155),s=i(83731),n=i(36845),a=i(88903),o=(i(80219),i(65352)),l=i(32422);let h=class extends r.p{constructor(){super(...arguments),this.suspended=!1,this.extent=null,this.extentIntersectionDirty=!0,this._isVisibleBelowSurface=!1,this.handles=new s.u,this.layerView=null,this.updating=!0}setup(e){this.layerView=e,this.extentIntersection=new l.a2({renderCoordsHelper:e.view.renderCoordsHelper});const t=e.view,i=t.basemapTerrain,r=t.resourceController.scheduler;this.handles.add([t.on("resize",(()=>this.viewChange())),t.state.watch("camera",(()=>this.viewChange()),!0),r.registerTask(l.p.FRUSTUM_VISIBILITY,this),i.on("elevation-bounds-change",(()=>this.elevationBoundsChange()))]),"local"===t.viewingMode?this.isVisibleBelowSurface=!0:this.handles.add([(0,n.d)(i,["opacity","wireframe"],(()=>this.updateIsVisibleBelowSurface())),(0,n.d)(t,"map.ground.navigationConstraint.type",(()=>this.updateIsVisibleBelowSurface()))])}destroy(){this.layerView=null,this.extent=null,this.extentIntersection=null,this.handles&&(this.handles.destroy(),this.handles=null)}_setDirty(){this.updating||this._set("updating",!0)}setExtent(e){this.extent=e,this.extentIntersectionDirty=!0,this._setDirty()}viewChange(){this._setDirty()}elevationBoundsChange(){this._setDirty(),this.extentIntersectionDirty=!0}set isVisibleBelowSurface(e){this._isVisibleBelowSurface=e,this._setDirty(),this.extentIntersectionDirty=!0}updateIsVisibleBelowSurface(){const e=this.layerView.view,t=e.basemapTerrain,i="local"===e.viewingMode,r=e.map.ground&&e.map.ground.navigationConstraint&&"none"===e.map.ground.navigationConstraint.type;this.isVisibleBelowSurface=i||!t.opaque||r}updateExtentIntersection(){if(!this.extentIntersectionDirty)return;this.extentIntersectionDirty=!1;const e=this.layerView.view;let t;if(this._isVisibleBelowSurface)t=-.3*(0,o.p)(e.spatialReference).radius;else{const{min:i,max:r}=e.basemapTerrain.elevationBounds;t=i-Math.max(1,(r-i)*(1.2-1))}this.extentIntersection.update(this.extent,e.spatialReference,t)}get running(){return this.updating}runTask(){if(this._set("updating",!1),!this.extent)return void this._set("suspended",!1);this.updateExtentIntersection();const e=this.layerView.view.frustum,t=(0,o.p)(this.layerView.view.spatialReference).radius;this._set("suspended",!this.extentIntersection.isVisibleInFrustum(e,t))}};(0,r.e)([(0,a.y)({readOnly:!0})],h.prototype,"suspended",void 0),(0,r.e)([(0,a.y)({readOnly:!0})],h.prototype,"updating",void 0),h=(0,r.e)([(0,a.n)("esri.views.3d.layers.graphics.Graphics3DFrustumVisibility")],h);var u=h},14592:(e,t,i)=>{"use strict";i.d(t,{E:()=>v});var r=i(78155),s=i(73574),n=i(40130),a=i(83731),o=i(80219),l=i(20215),h=i(36845),u=i(88903),c=i(84271),d=i(41290),p=i(32422),f=i(18143),y=i(42413),m=i(54325),g=i(32769);let _=class extends r.p{constructor(e){super(e),this.graphicsCore=null,this.elevationAlignment=new m.d,this.watchUpdatingTracking=new g.l,this.handles=new a.u,this.suspendResumeExtent=null}normalizeCtorArgs(e){let t=null;e.scaleVisibilityEnabled&&(delete(e={...e}).scaleVisibilityEnabled,t=new y.y);const i=new y.O({owner:e.owner,layer:e.layer,preferredUpdatePolicy:1,graphicSymbolSupported:!0});return{...e,graphicsCore:i,scaleVisibility:t}}initialize(){const e=this.scaleVisibility;(0,o.r)(e)&&"minScale"in this.layer&&this.watchUpdatingTracking.add(this.layer,"scaleRangeId",(()=>e.layerMinMaxScaleChangeHandler())),"elevationInfo"in this.layer&&this.watchUpdatingTracking.add(this.layer,"elevationInfo",((e,t)=>{(0,c.m)(e,t)&&this.watchUpdatingTracking.addPromise(this.graphicsCore.elevationInfoChange())}))}async setup(){const e=(e,t,i)=>this.graphicsCore.spatialIndex.queryGraphicUIDsInExtent(e,t,i);if(this.elevationAlignment.setup(this.owner,e,this.graphicsCore,this.view.elevationProvider),(0,o.r)(this.scaleVisibility)&&"minScale"in this.layer){const t=this.owner.view.basemapTerrain;this.scaleVisibility.setup(this.owner,this.layer,e,this.graphicsCore,t)}this._set("objectStates",new m.s(this.graphicsCore));try{await this.graphicsCore.setup({elevationAlignment:this.elevationAlignment,scaleVisibility:this.scaleVisibility,objectStates:this.objectStates})}catch(e){if((0,l.g)(e))return;throw e}this.destroyed||(this.handles.add(this.view.watch("clippingArea",(()=>this.updateClippingExtent()),!0)),this.updateClippingExtent(),this.setupSuspendResumeExtent(),this.graphicsCore.startCreateGraphics())}destroy(){this.handles=(0,o.k)(this.handles),this.watchUpdatingTracking.destroy(),this._set("elevationAlignment",(0,o.k)(this.elevationAlignment)),this._set("scaleVisibility",(0,o.k)(this.scaleVisibility)),this._set("objectStates",(0,o.k)(this.objectStates)),this._set("graphicsCore",(0,o.k)(this.graphicsCore))}get suspended(){return!(!(0,o.r)(this.scaleVisibility)||!this.scaleVisibility.suspended)}get updating(){var e,t;return!!(null!=(e=this.graphicsCore)&&e.updating||(0,o.r)(this.scaleVisibility)&&this.scaleVisibility.updating||null!=(t=this.watchUpdatingTracking)&&t.updating)}getGraphicFromGraphicUid(e){if(this.owner.loadedGraphics){const t=this.owner.loadedGraphics.find((t=>t.uid===e));if(t){const e=this.layer instanceof d.b?this.layer:null;return(0,p.c)(t,e)}}}whenGraphicBounds(e,t){return this.graphicsCore?this.graphicsCore.whenGraphicBounds(e,t):Promise.reject()}computeAttachmentOrigin(e,t){return this.graphicsCore?this.graphicsCore.computeAttachmentOrigin(e,t):null}getSymbolLayerSize(e,t){return this.graphicsCore?this.graphicsCore.getSymbolLayerSize(e,t):null}maskOccludee(e){const{set:t,handle:i}=this.objectStates.acquireSet(1,null);return this.objectStates.setUid(t,e.uid),i}highlight(e){if(e instanceof f.b)return x;if("number"==typeof e)return this.highlight([e]);if(e instanceof s.h)return this.highlight([e]);if(e instanceof n.L&&(e=e.toArray()),Array.isArray(e)&&e.length>0){if(e[0]instanceof s.h){const t=e.map((e=>e.uid)),{set:i,handle:r}=this.objectStates.acquireSet(0,null);return this.objectStates.setUids(i,t),r}if("number"==typeof e[0]){const t=e,{set:i,handle:r}=this.objectStates.acquireSet(0,null);return this.objectStates.setObjectIds(i,t),r}}return x}updateClippingExtent(){const e=this.view.clippingArea;this.graphicsCore.setClippingExtent(e,this.view.spatialReference)&&this.graphicsCore.recreateAllGraphics()}updateSuspendResumeExtent(){(0,o.t)(this.scaleVisibility)||(this.suspendResumeExtent=(0,p.P)(this.graphicsCore.computedExtent,this.suspendResumeExtent,p.r,this.graphicsCore.extentPadding),this.scaleVisibility.setExtent(this.suspendResumeExtent))}setupSuspendResumeExtent(){(0,o.t)(this.scaleVisibility)||((0,h.d)(this.graphicsCore,"computedExtent",(e=>this.updateSuspendResumeExtent()),!0),this.graphicsCore.watch("extentPadding",(e=>this.updateSuspendResumeExtent())))}};(0,r.e)([(0,u.y)({constructOnly:!0})],_.prototype,"owner",void 0),(0,r.e)([(0,u.y)({constructOnly:!0})],_.prototype,"layer",void 0),(0,r.e)([(0,u.y)({readOnly:!0,aliasOf:"owner.view"})],_.prototype,"view",void 0),(0,r.e)([(0,u.y)({constructOnly:!0})],_.prototype,"graphicsCore",void 0),(0,r.e)([(0,u.y)({constructOnly:!0})],_.prototype,"scaleVisibility",void 0),(0,r.e)([(0,u.y)({readOnly:!0})],_.prototype,"elevationAlignment",void 0),(0,r.e)([(0,u.y)({readOnly:!0})],_.prototype,"objectStates",void 0),(0,r.e)([(0,u.y)({readOnly:!0})],_.prototype,"watchUpdatingTracking",void 0),(0,r.e)([(0,u.y)({readOnly:!0})],_.prototype,"suspended",null),(0,r.e)([(0,u.y)({readOnly:!0})],_.prototype,"updating",null),_=(0,r.e)([(0,u.n)("esri.views.3d.layers.graphics.Graphics3DGraphicLikeLayerView")],_);const x={remove(){},pause(){},resume(){}};var v=_},54325:(e,t,i)=>{"use strict";i.d(t,{d:()=>d,s:()=>y});var r=i(78155),s=i(80987),n=i(83731),a=i(80219),o=i(88903),l=i(58404),h=i(32422);class u{constructor(){this._extents=new r.f({allocator:e=>e||(0,l.i)()}),this._tmpExtent=(0,l.i)(),this._dirty=!1}get empty(){return 0===this._extents.length}get size(){return this._extents.length}clear(){this._extents.clear()}add(e){this.contains(e)||(this.removeContained(e),(0,l.A)(this._extents.pushNew(),e),this._dirty=!0)}pop(){return this._dirty&&this.mergeTight(),this._extents.pop()}merge(e){return this.mergeTight(e),e.hasProgressed}mergeTight(e=h.N){const t=this._extents,i=new Set;let r=0;for(;r!==t.length;){t.sort(((e,t)=>e[0]-t[0])),r=t.length,i.clear();for(let r=0;r<t.length;++r){if(e.done)return;const s=t.getItemAt(r);for(let e=r+1;e<t.length;++e){const r=t.getItemAt(e);if(r[0]>=s[2])break;i.add(r)}i.forEach((r=>{if(s===r)return;if(r[2]<=s[0])return void i.delete(r);const n=(0,l.l)(s),a=(0,l.l)(r),o=this._tmpExtent;(0,l.c)(s,r,o);const h=n+a;((0,l.l)(o)-h)/h<.05&&((0,l.A)(s,o),i.delete(r),t.remove(r),e.madeProgress())})),i.add(s)}}this._dirty=!1}contains(e){return this._extents.some((t=>(0,l.q)(t,e)))}removeContained(e){this._extents.filterInPlace((t=>!(0,l.q)(e,t)))}get test(){const e=this;return{containsPoint:t=>e._extents.some((e=>(0,l.g)(e,t)))}}}let c=class extends r.p{constructor(){super(...arguments),this.dirtyExtents=new u,this.globalDirty=!1,this.averageExtentUpdateSize=0,this.dirtyGraphicsSet=new Set,this.handles=new n.u,this.updateElevation=!1,this.layerView=null,this.graphicsCore=null,this.events=new s.n}setup(e,t,i,r){this.layerView=e,this.queryGraphicUIDsInExtent=t,this.graphicsCore=i,this.elevationProvider=r;const s=this.layerView.view.resourceController.scheduler;this.handles.add([r.on("elevation-change",(e=>this._elevationChanged(e))),this.layerView.watch("suspended",(()=>this.suspendedChange())),s.registerTask(h.p.ELEVATION_ALIGNMENT,this)])}destroy(){this.dirtyGraphicsSet.clear(),this.handles.destroy(),this.handles=null,this.layerView=null,this.graphicsCore=null,this.queryGraphicUIDsInExtent=null}clear(){this.dirtyGraphicsSet.clear(),this.notifyChange("updating")}suspendedChange(){!0===this.layerView.suspended?this.updateElevation=!1:!1===this.layerView.suspended&&this.updateElevation&&(this.globalDirty=!0,this.notifyChange("updating"))}elevationInfoChange(){this.globalDirty=!0,this.notifyChange("updating")}get updating(){return this.running}get running(){return this.dirtyGraphicsSet.size>0||this.dirtyExtents&&!this.dirtyExtents.empty||this.globalDirty}get updatingRemaining(){return this.dirtyGraphicsSet.size+this.dirtyExtents.size*this.averageExtentUpdateSize}runTask(e){for(this.globalDirty&&(this.markAllGraphicsElevationDirty(),this.globalDirty=!1,e.madeProgress()),e.run((()=>this.dirtyExtents.merge(e)));this.running&&!e.done;)this._updateDirtyGraphics(e),this._updateDirtyExtents(e);this.layerView.view.deconflictor.setDirty(),this.notifyChange("updating")}_updateDirtyGraphics(e){const t=this.layerView.view.renderCoordsHelper,i=0===this.graphicsCore.effectiveUpdatePolicy;for(const r of this.dirtyGraphicsSet.keys()){const s=this.graphicsCore.getGraphics3DGraphicById(r);if(this.dirtyGraphicsSet.delete(r),(0,a.r)(s)&&(s.alignWithElevation(this.elevationProvider,t,i),e.madeProgress()),e.done)return}}_updateDirtyExtents(e){for(;!this.dirtyExtents.empty&&!e.done;){const t=this.dirtyExtents.pop(),i=this.elevationProvider.spatialReference;this.events.emit("invalidate-elevation",{extent:t,spatialReference:i});const r=this.dirtyGraphicsSet.size;this.queryGraphicUIDsInExtent(t,i,(e=>{const t=this.graphicsCore.getGraphics3DGraphicById(e);(0,a.r)(t)&&t.needsElevationUpdates()&&this.dirtyGraphicsSet.add(e)})),this.averageExtentUpdateSize=.1*(this.dirtyGraphicsSet.size-r)+.9*this.averageExtentUpdateSize,e.madeProgress()}}markAllGraphicsElevationDirty(){this.dirtyExtents.clear(),this.dirtyGraphicsSet.clear(),this.graphicsCore.graphics3DGraphics.forEach(((e,t)=>this.dirtyGraphicsSet.add(t)))}_elevationChanged(e){if("scene"===e.context&&(!this.graphicsCore.layer.elevationInfo||"relative-to-scene"!==this.graphicsCore.layer.elevationInfo.mode))return;const{extent:t,spatialReference:i}=e;if(this.layerView.suspended){if(!this.updateElevation){const e=this.graphicsCore.computedExtent;e&&t[2]>e.xmin&&t[0]<e.xmax&&t[3]>e.ymin&&t[1]<e.ymax&&(this.updateElevation=!0)}this.events.emit("invalidate-elevation",{extent:t,spatialReference:i})}else t[0]===-1/0?this.globalDirty=!0:this.dirtyExtents.add(t),this.notifyChange("updating")}};(0,r.e)([(0,o.y)({readOnly:!0})],c.prototype,"updating",null),(0,r.e)([(0,o.y)({readOnly:!0})],c.prototype,"updatingRemaining",null),c=(0,r.e)([(0,o.n)("esri.views.3d.layers.graphics.Graphics3DElevationAlignment")],c);var d=c;class p{constructor(){this.items=[]}addObject(e,t){this.items.push({type:0,objectStateId:t,object:e})}addRenderGeometry(e,t,i){this.items.push({type:1,objectStateId:t,renderGeometry:e,owner:i})}addExternal(e,t){this.items.push({type:2,objectStateId:t,remove:e})}remove(e){for(let t=this.items.length-1;t>=0;--t){const i=this.items[t];i.objectStateId===e&&(this._removeObjectStateItem(i),this.items.splice(t,1))}}removeObject(e){for(let t=this.items.length-1;t>=0;--t){const i=this.items[t];0===i.type&&i.object===e&&(this._removeObjectStateItem(i),this.items.splice(t,1))}}removeRenderGeometry(e){for(let t=this.items.length-1;t>=0;--t){const i=this.items[t];1===i.type&&i.renderGeometry===e&&(this._removeObjectStateItem(i),this.items.splice(t,1))}}removeAll(){this.items.forEach((e=>{this._removeObjectStateItem(e)})),this.items=[]}_removeObjectStateItem(e){switch(e.type){case 0:0===e.objectStateId.channel?e.object.removeHighlight(e.objectStateId):1===e.objectStateId.channel&&e.object.removeOcclude(e.objectStateId);break;case 1:e.owner.removeRenderGeometryObjectState(e.renderGeometry,e.objectStateId);break;case 2:e.remove(e.objectStateId)}}}class f{constructor(e,t){this.stateType=e,this.objectIdField=t,this.objectStateSet=new p,this.ids=new Set,this.paused=!1}hasGraphic(e){if(this.objectIdField){const t=e.graphic.attributes[this.objectIdField];return this.ids.has(t)}return this.ids.has(e.graphic.uid)}}class y{constructor(e){this._graphicsCore=e,this._stateSets=new Array}destroy(){this._stateSets&&this._stateSets.forEach((e=>e.objectStateSet.removeAll())),this._stateSets=null}acquireSet(e,t){const i=new f(e,t);this._stateSets.push(i);const r=(0,o.A)((()=>this.releaseSet(i)));return{set:i,handle:r}}releaseSet(e){e.objectStateSet.removeAll();const t=this._stateSets?this._stateSets.indexOf(e):-1;-1!==t&&this._stateSets.splice(t,1)}_addObjectStateSet(e,t){e.addObjectStateSet(t.stateType,t.objectStateSet)}_removeObjectStateSet(e,t){e.removeObjectState(t.objectStateSet)}setUid(e,t){e.ids.add(t);const i=this._graphicsCore.graphics3DGraphics.get(t);i&&this._addObjectStateSet(i,e)}setUids(e,t){t.forEach((t=>this.setUid(e,t)))}setObjectIds(e,t){t.forEach((t=>e.ids.add(t))),this.initializeSet(e)}addGraphic(e){this._stateSets.forEach((t=>{!t.paused&&t.hasGraphic(e)&&this._addObjectStateSet(e,t)}))}removeGraphic(e){this._stateSets.forEach((t=>{t.hasGraphic(e)&&this._removeObjectStateSet(e,t)}))}allGraphicsDeleted(){this._stateSets&&this._stateSets.forEach((e=>e.objectStateSet.removeAll()))}initializeSet(e){const t=this._graphicsCore.graphics3DGraphics;e.objectIdField?t.forEach((t=>{t&&e.hasGraphic(t)&&this._addObjectStateSet(t,e)})):e.ids.forEach((i=>{const r=t.get(i);r&&this._addObjectStateSet(r,e)}))}get test(){return{states:this._stateSets}}}},42413:(e,t,i)=>{"use strict";i.d(t,{O:()=>le,y:()=>ge});var r=i(78155),s=i(80987),n=i(34396),a=(i(94449),i(81135)),o=i(80219),l=i(20215),h=i(83731),u=i(71391),c=i(60816),d=i(36845),p=i(88903),f=i(84271),y=i(7571),m=i(53185),g=i(58404),_=i(41290),x=i(30665),v=i(32422),b=i(5250),w=i(52957),S=i(40481),I=i(78730),C=i(91728),M=i(66954),T=i(9612),E=i(38624),F=i(65352),A=i(13895),R=i(98548),P=i(20736);function L(e){return(0,o.t)(e)||"simple"===e.type||"unique-value"===e.type||"class-breaks"===e.type||"dictionary"===e.type}function D(e){if((0,o.t)(e))return null;if(!L(e))return new l.s("renderer-conversion-3d:unsupported-renderer",`Unsupported renderer of type '${e.type||e.declaredClass}'`,{renderer:e});switch(e.type){case"simple":return function(e){return N(e,(0,b.p)(e.symbol).error)}(e);case"unique-value":return function(e){const t=e.uniqueValueInfos.map((e=>(0,b.p)(e.symbol).error)).filter((e=>!!e)),i=(0,b.p)(e.defaultSymbol);return i.error&&t.unshift(i.error),N(e,t)}(e);case"class-breaks":return function(e){const t=e.classBreakInfos.map((e=>(0,b.p)(e.symbol).error)).filter((e=>!!e)),i=(0,b.p)(e.defaultSymbol);return i.error&&t.unshift(i.error),N(e,t)}(e);case"dictionary":return null}return null}function N(e,t){if(!t)return null;let i;if(i=Array.isArray(t)?t:[t],i.length>0){const t=i.map((e=>e.details.symbol.type||e.details.symbol.declaredClass)).filter((e=>!!e));t.sort();const r=[];return t.forEach(((e,i)=>{0!==i&&e===t[i-1]||r.push(e)})),new l.s("renderer-conversion-3d:unsupported-symbols",`Renderer contains symbols (${r.join(", ")}) which are not supported in 3D`,{renderer:e,symbolErrors:i})}return null}const O=a.k.fromSimpleMarkerSymbol(S.c),k=a.l.fromSimpleLineSymbol(S.u),V=a.a.fromSimpleFillSymbol(S.a),U=new a.w({symbolLayers:[new a.z({material:{color:I.e},edges:{type:"solid",size:"1px",color:I.i}})]});function G(e){if((0,o.t)(e))return null;switch(e.type){case"mesh":return U;case"point":case"multipoint":return O;case"polyline":return k;case"polygon":case"extent":return V}return null}let z=class extends r.p{constructor(e){super(e),this.events=new s.n,this.hasZ=null,this.hasM=null,this.objectIdField=null,this.spatialReference=null,this.featureAdapter={getAttribute:(e,t)=>"graphic"in e?e.graphic.attributes[t]:M.o.getAttribute(e,t),getAttributes:e=>"graphic"in e?e.graphic.attributes:M.o.getAttributes(e),getObjectId:e=>"graphic"in e?(0,x.O)(e.graphic,this.objectIdField):M.o.getObjectId(e),getGeometry:e=>"graphic"in e?e.getAsOptimizedGeometry(this.hasZ,this.hasM):M.o.getGeometry(e),getCentroid:(e,t)=>{if("graphic"in e){let i=null;(0,o.r)(e.centroid)?i=e.centroid:"point"===e.graphic.geometry.type&&(0,y.l)(e.graphic.geometry,B,this.spatialReference)&&(i=B);const r=new Array(2+(t.hasZ?1:0)+(t.hasM?1:0));return(0,o.t)(i)?(r[0]=0,r[1]=0,r[2]=0,r[3]=0):(r[0]=i.x,r[1]=i.y,t.hasZ&&(r[2]=i.hasZ?i.z:0),t.hasM&&(r[t.hasZ?3:2]=i.hasM?i.m:0)),new C.a([],r)}return M.o.getCentroid(e,t)},cloneWithGeometry:(e,t)=>"graphic"in e?new C.t(t,this.featureAdapter.getAttributes(e),null,this.featureAdapter.getObjectId(e)):M.o.cloneWithGeometry(e,t)}}forEach(e){this.forAllGraphics((t=>{e(t)}))}forEachInBounds(e,t){this.getSpatialIndex().forEachInBounds(e,t)}forEachBounds(e,t,i){const r=this.getSpatialIndex();for(const s of e){const e=this.featureAdapter.getObjectId(s);(0,o.r)(r.getBounds(e,i))&&t(i)}}};(0,r.e)([(0,p.y)({constructOnly:!0})],z.prototype,"getSpatialIndex",void 0),(0,r.e)([(0,p.y)({constructOnly:!0})],z.prototype,"forAllGraphics",void 0),(0,r.e)([(0,p.y)({constructOnly:!0})],z.prototype,"hasZ",void 0),(0,r.e)([(0,p.y)({constructOnly:!0})],z.prototype,"hasM",void 0),(0,r.e)([(0,p.y)({constructOnly:!0})],z.prototype,"objectIdField",void 0),(0,r.e)([(0,p.y)({constructOnly:!0})],z.prototype,"spatialReference",void 0),z=(0,r.e)([(0,p.n)("esri.views.3d.layers.graphics.Graphics3DFeatureStore")],z);const B={type:"point",x:0,y:0,hasZ:!1,hasM:!1,spatialReference:null};var j=z;class q{constructor(e){this.schedule=e,this.sharedResources=null,this.streamDataRequester=null,this.elevationProvider=null,this.renderer=null,this.stage=null,this.clippingExtent=null,this.renderCoordsHelper=null,this.overlaySR=null,this.layer=null,this.layerView=null,this.localOriginFactory=null,this.featureExpressionInfoContext=null,this.screenSizePerspectiveEnabled=!0,this.slicePlaneEnabled=!1,this.physicalBasedRenderingEnabled=!1,this.isAsync=!1}}class H extends v.a{constructor(e,t,i){super(e,t,i),this.calloutSymbolLayer=null,this.symbol.hasVisibleCallout()&&(this.calloutSymbolLayer=(0,v.e)(this.symbol,t))}async doLoad(e){const t=this.calloutSymbolLayer?(0,T.a)(this.calloutSymbolLayer.load()):null;try{await super.doLoad(e)}catch(e){var i;throw null==(i=this.calloutSymbolLayer)||i.abortLoad(),e}var r;if((0,l.b)(e))throw null==(r=this.calloutSymbolLayer)||r.abortLoad(),(0,l.m)();t&&await t}destroy(){super.destroy(),this.calloutSymbolLayer&&this.calloutSymbolLayer.destroy()}createGraphics3DGraphic(e,t){const i=super.createGraphics3DGraphic(e,t);if(this.calloutSymbolLayer){const t=this.createCalloutGraphic(e);t&&i.addAuxiliaryGraphic(t)}return i}globalPropertyChanged(e,t){return!!super.globalPropertyChanged(e,t)&&(!this.calloutSymbolLayer||this.calloutSymbolLayer.globalPropertyChanged(e,t,(e=>this._getCalloutGraphicLayer(e))))}updateGeometry(e,t){const i=super.updateGeometry(e,t);if(i&&this.calloutSymbolLayer){const i=this._getCalloutGraphicLayer(e);if(i)return this.calloutSymbolLayer.updateGeometry(i,t)}return i}createCalloutGraphic(e){const t=e.renderingInfo,i={renderer:t.renderer,symbol:t.symbol,translation:[0,0,0],centerOffset:[0,0,0,0],screenOffset:[0,0],centerOffsetUnits:"world",elevationOffset:0,materialCollection:null};return e.renderingInfo=i,this.calloutSymbolLayer.createGraphics3DGraphic(e)}_getCalloutGraphicLayer(e){for(const t of e._auxiliaryGraphics)if(t.graphics3DSymbolLayer===this.calloutSymbolLayer)return t}}function W(e,t,i){let r;switch(e.type){case"point-3d":r=H;break;default:r=v.a}return new r(e,t,i)}class Q{constructor(e){this.graphicsCore=e,this.idToState=new Map,this.states=new Set;const t=e.owner.layer&&e.owner.layer.objectIdField;t?(this.getGraphicId=e=>(0,x.O)(e,t),this.getGraphics3DGraphicById=e=>this.graphicsCore.getGraphics3DGraphicByObjectId(e)):(this.getGraphicId=e=>e.uid,this.getGraphics3DGraphicById=e=>this.graphicsCore.getGraphics3DGraphicById(e))}destroy(){this.idToState.clear(),this.states.forEach(((e,t)=>this.remove(t)))}add(e){const t={remove:()=>this.remove(e)};if(this.states.has(e))return t;const i=this.getGraphicId(e.graphic),r=this.getGraphics3DGraphicById(i);return this.states.has(e)||this.states.add(e),this.ensureStateList(i).push(e),e.displaying=!!(0,o.r)(r)&&r.isVisible(),e.isDraped=!!(0,o.r)(r)&&r.isDraped,e.tracking=!0,(0,o.r)(r)&&e.emit("changed",{}),t}remove(e){if(this.states.has(e)){if(this.idToState.size){const t=this.getGraphicId(e.graphic),i=this.idToState.get(t);i&&((0,r.C)(i,e),0===i.length&&this.idToState.delete(t))}this.states.delete(e),e.tracking=!1,e.displaying=!1}}addGraphic(e){this.forEachState(e,(t=>{t.displaying=e.isVisible(),t.isDraped=e.isDraped,t.emit("changed",{})}))}removeGraphic(e){this.forEachState(e,(e=>{e.displaying=!1,e.isDraped=!1}))}updateGraphicGeometry(e){this.forEachState(e,(e=>{e.emit("changed",{})}))}updateGraphicVisibility(e){this.forEachState(e,(t=>{t.displaying=e.isVisible()}))}allGraphicsDeleted(){this.states.forEach((e=>{e.displaying=!1}))}ensureStateList(e){const t=this.idToState.get(e);if(t)return t;const i=new Array;return this.idToState.set(e,i),i}forEachState(e,t){if(0===this.states.size||0===this.idToState.size)return;const i=this.getGraphicId(e.graphic),r=this.idToState.get(i);null!=r&&r.forEach(t)}}let Z=class extends r.p{constructor(e){super(e),this._index=new E.h(9,(0,o.c)("csp-restrictions")?e=>({minX:e.extent[0],minY:e.extent[1],maxX:e.extent[2],maxY:e.extent[3]}):[".extent[0]",".extent[1]",".extent[2]",".extent[3]"]),this._missing=new Set,this._boundsByFeature=new Map,this.spatialReference=null,this.hasZ=null,this.hasM=null,this.objectIdField=null,this.updating=!1}setup(e){this._addMany(e)}destroy(){this._missing.clear(),this._index.destroy(),this._index=null,this._boundsByFeature.clear(),this._boundsByFeature=null}update(){this._missing.size>0&&(this._addMany(Array.from(this._missing.values())),this.updating=!1,this._missing.clear())}get updatingRemaining(){return this._missing.size}queryGraphicUIDsInExtent(e,t,i){t.equals(this.spatialReference)&&(Y.minX=e[0],Y.minY=e[1],Y.maxX=e[2],Y.maxY=e[3],this.update(),this._index.search(Y,(e=>i(e.graphic.uid))))}add(e){this._missing.add(e),this.updating=!0}remove(e){if(this._missing.delete(e))return void(this.updating=this._missing.size>0);this._index.remove(e);const t=(0,x.O)(e.graphic,this._get("objectIdField"));null!=t&&this._boundsByFeature.delete(t)}_addMany(e){if(0===e.length)return;const t=this._get("objectIdField");for(const i of e){i.computeExtent(this.spatialReference);const e=(0,x.O)(i.graphic,t);null!=e&&this._boundsByFeature.set(e,i.extent)}this._index.load(e)}clear(){this._index.clear(),this._missing.clear(),this._boundsByFeature.clear(),this.updating=!1}forEachInBounds(e,t){Y.minX=e[0],Y.minY=e[1],Y.maxX=e[2],Y.maxY=e[3],this.update(),this._index.search(Y,(e=>{t(e)}))}getBounds(e,t){this.update();const i=this._boundsByFeature.get(e);return i?(0,m.O)(t,i):null}};(0,r.e)([(0,p.y)({constructOnly:!0})],Z.prototype,"spatialReference",void 0),(0,r.e)([(0,p.y)({constructOnly:!0})],Z.prototype,"hasZ",void 0),(0,r.e)([(0,p.y)({constructOnly:!0})],Z.prototype,"hasM",void 0),(0,r.e)([(0,p.y)({constructOnly:!0})],Z.prototype,"objectIdField",void 0),(0,r.e)([(0,p.y)()],Z.prototype,"updating",void 0),(0,r.e)([(0,p.y)({readOnly:!0})],Z.prototype,"updatingRemaining",null),Z=(0,r.e)([(0,p.n)("esri.views.3d.layers.graphics.SpatialIndex2D")],Z);const Y={minX:0,minY:0,maxX:0,maxY:0},J=o.n.getLogger("esri.views.3d.layers.support.StageLayerElevationProvider");let X=class extends(s.n.EventedMixin(r.p)){constructor(e){super(e),this.elevationOffset=0,this._layerHandes=new h.u}initialize(){this.renderCoordsHelper=this.view.renderCoordsHelper,this.intersectLayers=[this.stageLayer],this.intersector=new v.u(this.view.state.viewingMode),this.intersector.options.store=0;const e=this.computeLayerExtent(this.stageLayer);this.zmin=e[2],this.zmax=e[5];const t=this.stageLayer.events;this._layerHandes.add([t.on("layerObjectAdded",(e=>this.objectChanged(e.object))),t.on("layerObjectRemoved",(e=>this.objectChanged(e.object))),t.on("objectGeometryAdded",(e=>this.objectChanged(e.object))),t.on("objectGeometryRemoved",(e=>this.objectChanged(e.object))),t.on("vertexAttrsUpdated",(e=>this.objectChanged(e.object))),t.on("objectTransformation",(e=>this.objectChanged(e)))])}dispose(){this._layerHandes.destroy()}elevationInfoChanged(){const e=null!=this.layer?this.layer.elevationInfo:null;if(null!=e&&"on-the-ground"!==e.mode){const t=(0,F.T)(this.layer.spatialReference),i=(0,A.r)(e.unit);this.elevationOffset=(0,o.q)(e.offset,0)*i/t}else this.elevationOffset=0}getElevation(e,t,i,r){if(te[0]=e,te[1]=t,te[2]=i,!this.renderCoordsHelper.toRenderCoords(te,r,te))return J.error("could not project point for elevation alignment"),null;const s=this.elevationOffset,n=this.zmin+s,a=this.zmax+s;return this.renderCoordsHelper.setAltitude(ie,a,te),this.renderCoordsHelper.setAltitude(re,n,te),this.intersector.reset(ie,re),this.intersector.intersect(this.intersectLayers,null,null,1,null,(e=>e.metadata&&e.metadata.isElevationSource)),this.intersector.results.min.getIntersectionPoint(te)?this.renderCoordsHelper.getAltitude(te):null}objectChanged(e){var t;if(null==(t=e.metadata)||!t.isElevationSource||!this.spatialReference)return;(0,m.B)($),e.metadata.lastValidElevationBB.isEmpty()||this.expandExtent(e.metadata.lastValidElevationBB.min,e.metadata.lastValidElevationBB.max,$);const i=e.boundingVolumeWorldSpace.min,r=e.boundingVolumeWorldSpace.max;this.expandExtent(i,r,$),(0,m.G)($,K),this.zmin=Math.min(this.zmin,$[2]),this.zmax=Math.max(this.zmax,$[5]),ee.extent=K,ee.spatialReference=this.spatialReference,this.emit("elevation-change",ee),(0,c.h)(e.metadata.lastValidElevationBB.min,i),(0,c.h)(e.metadata.lastValidElevationBB.max,r)}computeLayerExtent(e){return(0,m.B)($),e.objects.forAll((e=>this.expandExtent(e.boundingVolumeWorldSpace.min,e.boundingVolumeWorldSpace.max,$))),$}expandExtent(e,t,i){for(let r=0;r<8;++r)te[0]=1&r?e[0]:t[0],te[1]=2&r?e[1]:t[1],te[2]=4&r?e[2]:t[2],this.renderCoordsHelper.fromRenderCoords(te,te,this.spatialReference),(0,m.h)(i,te);return i}};(0,r.e)([(0,p.y)({constructOnly:!0})],X.prototype,"layer",void 0),(0,r.e)([(0,p.y)({constructOnly:!0})],X.prototype,"stageLayer",void 0),(0,r.e)([(0,p.y)({constructOnly:!0})],X.prototype,"view",void 0),(0,r.e)([(0,p.y)({readOnly:!0,aliasOf:"view.spatialReference"})],X.prototype,"spatialReference",void 0),X=(0,r.e)([(0,p.n)("esri.views.3d.layers.support.StageLayerElevationProvider")],X);const $=(0,m.B)(),K=(0,g.B)(),ee={spatialReference:null,extent:K,context:"scene"},te=(0,c.n)(),ie=(0,c.n)(),re=(0,c.n)();var se;const ne=(0,c.n)(),ae=(0,m.a)(),oe=o.n.getLogger("esri.views.3d.layers.graphics.Graphics3DCore");let le=se=class extends r.p{constructor(e){super(e),this.propertiesPool=new v.o({computedExtent:R.M},this),this.computedExtent=null,this.currentRenderer=null,this.rendererHasGeometryOperations=!1,this.graphicStateTracking=null,this.symbolCreationContext=new q(((e,t)=>this._frameTask.schedule(e,t))),this.graphics3DGraphics=new Map,this.stageLayer=null,this.stage=null,this.graphicsDrapedUids=new Set,this.graphicsBySymbol=new Map,this.symbolConversionCache=new Map,this.symbols=new Map,this.graphicsWithoutSymbol=new Map,this.graphicsWaitingForSymbol=new Set,this._handles=new h.u,this._frameTask=v.y,this.suspendSymbolCleanup=!1,this._spatialReference=null,this.arcadeOnDemand=null,this.rendererChangeAbortController=null,this.elevationInfoChangeAbortController=null,this.setupAbortController=null,this.elevationAlignment=null,this.scaleVisibility=null,this.filterVisibility=null,this._spatialIndex=null,this.extentPadding=0,this._updatingPendingLoadedGraphicsChange=null,this.featureStore=null,this.deconflictor=null,this.labeler=null,this.objectStates=null,this.viewElevationProvider=null,this.stageLayerElevationProvider=null,this.sharedSymbolResourcesOwnerHandle=null,this.whenGraphics3DGraphicRequests={},this.pendingUpdates=new Map,this.numberOfGraphics=0,this.numberOfGraphicsProvidingElevation=0,this.pendingAdds=0,this.pendingRemoves=0,this.pendingUpdatesPool=new r.f({allocator:e=>e||new he,deallocator:e=>(e.clear(),e)}),this.symbolWarningLogged=!1,this.geometryWarningLogged=!1,this.objectIdInvisibleSet=new Set,this._whenSymbolRemoved=new r.f,this.preferredUpdatePolicy=1,this.forcedUpdatePolicy=null,this.elevationFeatureExpressionEnabled=!0,this.owner=null,this.layer=null,this.graphicSymbolSupported=!0,this.getRenderingInfoWithoutRenderer=!1,this.hasZ=null,this.hasM=null,this._usedMemory=0,this._visible=void 0,this._startCreateGraphics=!1}get spatialIndex(){return this._spatialIndex||(this._spatialIndex=new Z({objectIdField:this.owner.layer&&this.owner.layer.objectIdField,spatialReference:this._spatialReference,hasZ:this.hasZ,hasM:this.hasM}),this._spatialIndex.setup(Array.from(this.graphics3DGraphics.values()))),this._spatialIndex.update(),this._spatialIndex}get effectiveUpdatePolicy(){return(0,o.r)(this.currentRenderer)&&"dictionary"===this.currentRenderer.type?0:(0,o.q)(this.forcedUpdatePolicy,this.preferredUpdatePolicy)}get updating(){var e,t;return!!(this.graphicsWaitingForSymbol.size>0||this.running||null!=(e=this.elevationAlignment)&&e.updating||(0,o.r)(this.scaleVisibility)&&this.scaleVisibility.updating||null!=(t=this.filterVisibility)&&t.updating||this.rendererChangeAbortController||this.elevationInfoChangeAbortController||this._updatingPendingLoadedGraphicsChange||this._frameTask.updating)}get running(){var e;return this.pendingUpdates.size>0||!(null==(e=this._spatialIndex)||!e.updating)}get suspendedOrOutsideOfView(){var e;return this.owner.suspended||(null==(e=this.owner.suspendInfo)?void 0:e.outsideOfView)}get updatingRemaining(){var e,t;return this.updating?this.pendingUpdates.size+.1*((null==(e=this._spatialIndex)?void 0:e.updatingRemaining)||0)+.1*((null==(t=this.elevationAlignment)?void 0:t.updatingRemaining)||0):0}get displayFeatureLimit(){const e=this.owner&&this.owner.view&&this.owner.view.qualitySettings,t=e?e.graphics3D.minTotalNumberOfFeatures:0,i=e?e.graphics3D.maxTotalNumberOfFeatures:0,r=e?e.graphics3D.maxTotalNumberOfPrimitives:0,s=this.averageSymbolComplexity,n=Math.max(1,(0,o.r)(s)?s.primitivesPerFeature:1),a=(0,o.r)(s)&&s.drawCallsPerFeature>0?i/s.drawCallsPerFeature*.3:i,l=Math.ceil(r/n),h=Math.max(t,Math.min(i,l,a)),u=this._get("displayFeatureLimit");return u&&u.minimumTotalNumberOfFeatures===t&&u.maximumTotalNumberOfFeatures===i&&u.maximumTotalNumberOfPrimitives===r&&u.averageSymbolComplexity===s&&u.maximumNumberOfFeatures===h?u:{minimumTotalNumberOfFeatures:t,maximumTotalNumberOfFeatures:i,maximumTotalNumberOfPrimitives:r,averageSymbolComplexity:s,maximumNumberOfFeatures:h}}get averageSymbolComplexity(){const e=(0,v.d)(this.symbolComplexities),t=this._get("averageSymbolComplexity");return 0===e.numComplexities||(0,o.r)(t)&&(e.estimated&&(t.primitivesPerFeature>=e.primitivesPerFeature||t.primitivesPerCoordinate>=e.primitivesPerCoordinate||t.drawCallsPerFeature>=e.drawCallsPerFeature)||t.primitivesPerFeature===e.primitivesPerFeature&&t.primitivesPerCoordinate===e.primitivesPerCoordinate&&t.drawCallsPerFeature===e.drawCallsPerFeature)?t:e}get spatialReference(){return this._spatialReference}get usedMemory(){const e=(0,o.r)(this.averageSymbolComplexity)&&this.labelsEnabled?this.averageSymbolComplexity.memory.bytesPerFeatureLabel*this.numberOfGraphics:0;return this._usedMemory+e}get usedMemoryPerGraphic(){if(this._usedMemory&&this.numberOfGraphics)return Math.abs(this.pendingAdds-this.pendingRemoves)/this.numberOfGraphics>30?0:this._usedMemory/this.numberOfGraphics;if((0,o.r)(this.averageSymbolComplexity)){const e=this.labelsEnabled?this.averageSymbolComplexity.memory.bytesPerFeatureLabel:0;return this.averageSymbolComplexity.memory.bytesPerFeature+e}return 0}get unprocessedMemoryEstimate(){return Math.max(0,(this.pendingAdds-this.pendingRemoves)*this.usedMemoryPerGraphic)}get symbolComplexities(){return this.currentRenderer?this.getSymbolComplexitiesUsedOrRenderer(this.currentRenderer):this.getSymbolComplexitiesUsed()}getConvertedSymbol(e){if("web-style"===e.type)return e.clone();const t=this.symbolConversionCache.get(e.id);if(void 0!==t)return t;const i=(0,b.p)(e,!0,!1,this.hasLabelingContext(e)),r=i.symbol||null;return r||i.error&&oe.error(i.error.message),this.symbolConversionCache.set(e.id,r),r}getSymbolComplexitiesUsedOrRenderer(e){if((0,o.t)(e))return[];const t=e.getSymbols(),i="backgroundFillSymbol"in e&&e.backgroundFillSymbol;if(!(i||t&&t.length))return[];const r=[],s=this.getSymbolComplexityUsedOrRenderer(i);(0,o.r)(s)&&r.push(s);for(const e of t){const t=this.getSymbolComplexityUsedOrRenderer(e);(0,o.r)(t)&&r.push(t)}return r}getSymbolComplexityUsedOrRenderer(e){if((0,o.t)(e))return null;const t=this.symbols.get(e.id);if((0,o.r)(t))return t.complexity;const i=this.getConvertedSymbol(e);return i?(0,v.b)(i):null}getSymbolComplexitiesUsed(){const e=[];return this.symbols.forEach((t=>{(0,o.r)(t)&&e.push(t.complexity)})),e}initialize(){this._spatialReference=this.owner.view.spatialReference,this._set("featureStore",new j({objectIdField:this.owner.layer&&this.owner.layer.objectIdField,hasZ:this.hasZ,hasM:this.hasM,spatialReference:this._spatialReference,getSpatialIndex:()=>this.spatialIndex,forAllGraphics:e=>this.graphics3DGraphics.forEach(e)}))}async setup(e){this.setupAbortController=(0,l.h)();const t=this.setupAbortController.signal;this._set("elevationAlignment",e.elevationAlignment),this._set("scaleVisibility",e.scaleVisibility),this._set("filterVisibility",e.filterVisibility),this._set("deconflictor",e.deconflictor),this._set("labeler",e.labeler),this._set("objectStates",e.objectStates);const i=this.owner.view;this.viewElevationProvider=new v.f(this._spatialReference,i),this.initializeStage(i,this.layer.uid),this.symbolCreationContext.sharedResources=i.sharedSymbolResources,this.sharedSymbolResourcesOwnerHandle=i.sharedSymbolResources.addGraphicsOwner(this.owner),(0,o.r)(this.currentRenderer)&&(this.symbolCreationContext.renderer=this.currentRenderer),this.symbolCreationContext.stage=this.stage,this.symbolCreationContext.streamDataRequester=i.sharedSymbolResources.streamDataRequester,this.symbolCreationContext.renderCoordsHelper=i.renderCoordsHelper,this.symbolCreationContext.layer=this.layer,this.symbolCreationContext.layerView=this.owner,this.symbolCreationContext.localOriginFactory=new v.g(i.renderSpatialReference),this.symbolCreationContext.elevationProvider=i.elevationProvider,this.symbolCreationContext.notifyGraphicGeometryChanged=e=>this.notifyGraphicGeometryChanged(e),this.symbolCreationContext.notifyGraphicVisibilityChanged=e=>this.notifyGraphicVisibilityChanged(e);const r=(0,v.i)(this.layer.elevationInfo,this.elevationFeatureExpressionEnabled);this.symbolCreationContext.featureExpressionInfoContext=await(0,v.h)(r,this._spatialReference,oe),(0,l.a)(t),this.symbolCreationContext.screenSizePerspectiveEnabled=i.screenSizePerspectiveEnabled&&this.layer.screenSizePerspectiveEnabled,this.symbolCreationContext.slicePlaneEnabled=!!this.owner.slicePlaneEnabled,this.symbolCreationContext.physicalBasedRenderingEnabled=!!this.owner.view.qualitySettings.physicallyBasedRenderingEnabled;const s="layer"in this.owner?["layer.screenSizePerspectiveEnabled,view.screenSizePerspectiveEnabled"]:"view.screenSizePerspectiveEnabled";this._handles.add([this.watch("suspendedOrOutsideOfView",(()=>this._frameTask.reschedule((()=>this.updateLayerVisibility())))),this.owner.watch(s,(()=>{const e=i.screenSizePerspectiveEnabled&&this.layer.screenSizePerspectiveEnabled;e!==this.symbolCreationContext.screenSizePerspectiveEnabled&&(this.symbolCreationContext.screenSizePerspectiveEnabled=e,this.recreateAllGraphics())})),this.owner.watch("slicePlaneEnabled",(e=>this.slicePlaneEnabledChange(!!e))),this.owner.view.watch("pixelRatio",(()=>this.pixelRatioChange())),this.owner.view.watch("qualitySettings.physicallyBasedRenderingEnabled",(e=>this.physicalBasedRenderingChange(e))),(0,d.y)(i.basemapTerrain,"tilingScheme",(e=>{e.spatialReference.equals(this.symbolCreationContext.overlaySR)||(this.symbolCreationContext.overlaySR=i.basemapTerrain.spatialReference),this._handles.has("loaded-graphics")?this.recreateAllGraphics():this._handles.add([(0,d.C)(this.owner,"loadedGraphics","change",(e=>this.graphicsCollectionChanged(e)),(()=>this.recreateAllGraphics())),(0,d.C)(this.owner,"loadedGraphics","after-changes",(()=>this._signalUpdatingDuringAsyncLoadedGraphicsChange()),(()=>this._signalUpdatingDuringAsyncLoadedGraphicsChange()))],"loaded-graphics")})),(0,d.O)(this,"asyncUpdates",(()=>this.runTask(v.N)),!0),(0,d.d)(this,"effectiveUpdatePolicy",(e=>{(0,o.r)(this.stageLayer)&&(this.stageLayer.updatePolicy=e),this.symbolCreationContext.isAsync=0===this.effectiveUpdatePolicy,1===e&&this.runTask(v.N)}),!0)]),this._frameTask=i.resourceController.scheduler.registerTask(v.p.GRAPHICS_CORE,this),this.owner.layer&&"featureReduction"in this.owner.layer&&this._handles.add(this.owner.watch("layer.featureReduction",(()=>this.deconflictor.featureReductionChange()))),this.notifyChange("averageSymbolComplexity");try{await this.rendererChange(this.layer.renderer)}catch{}(0,l.a)(t),this.setupAbortController=null}abortSetup(){this.setupAbortController&&(this.setupAbortController.abort(),this.setupAbortController=null)}destroy(){this.abortSetup(),this.abortRendererChange(),this.abortElevationInfoChange(),this.owner.view.deconflictor.removeGraphicsOwner(this),this.owner.view.labeler.removeGraphicsOwner(this),this._updatingPendingLoadedGraphicsChange&&(this._updatingPendingLoadedGraphicsChange.remove(),this._updatingPendingLoadedGraphicsChange=null),this.clear(),(0,o.r)(this.graphicStateTracking)&&(this.graphicStateTracking.destroy(),this.graphicStateTracking=null),this.stage&&(this.stage.remove(this.stageLayer),this.stageLayer=null,this.stage=null),this._handles=(0,o.k)(this._handles),this._frameTask.remove(),this._frameTask=v.y,this._spatialReference=null,this._set("owner",null);for(const e in this.whenGraphics3DGraphicRequests)this.whenGraphics3DGraphicRequests[e].reject(new l.s("graphic:layer-destroyed","Layer has been destroyed"));this.whenGraphics3DGraphicRequests=null,this.sharedSymbolResourcesOwnerHandle=(0,o.a)(this.sharedSymbolResourcesOwnerHandle),this.propertiesPool=(0,o.k)(this.propertiesPool),this.pendingUpdatesPool=null,this.symbolConversionCache.clear(),this.objectIdInvisibleSet.clear(),this._spatialIndex=(0,o.k)(this._spatialIndex),this.featureStore&&(this.featureStore.destroy(),this._set("featureStore",null))}clear(){var e;this.objectStates&&this.objectStates.allGraphicsDeleted(),(0,o.r)(this.graphicStateTracking)&&this.graphicStateTracking.allGraphicsDeleted(),this.graphics3DGraphics.forEach((e=>e.destroy())),null==(e=this._spatialIndex)||e.clear(),this.graphics3DGraphics.clear(),this.numberOfGraphics=0,this._usedMemory=0,this.updateLayerVisibility(),this.symbols.forEach((e=>{(0,o.r)(e)&&e.destroy()})),this.symbols.clear(),this.graphicsBySymbol.clear(),this.graphicsWithoutSymbol.clear(),this.graphicsWaitingForSymbol.clear(),this.pendingUpdates.clear(),this.pendingUpdatesPool.clear(),this.pendingAdds=0,this.pendingRemoves=0,this.notifyChange("updating"),this.notifyChange("running"),this.notifyChange("updatingRemaining"),this.featureStore.events.emit("changed")}initializeStage(e,t){this.stage=e._stage,this.stageLayer=new v.n({isPickable:!this.suspendedOrOutsideOfView,updatePolicy:this.effectiveUpdatePolicy},t),this.stage.add(this.stageLayer);const i=this.stageLayer.events;i.on("objectTransformation",(e=>this.notifyGraphicGeometryChanged(e.metadata.graphicUid))),i.on("visibilityChanged",(e=>this.notifyGraphicVisibilityChanged(e.metadata.graphicUid))),i.on("objectGeometryAdded",(e=>this.notifyGraphicGeometryChanged(e.object.metadata.graphicUid))),i.on("objectGeometryRemoved",(e=>this.notifyGraphicGeometryChanged(e.object.metadata.graphicUid))),i.on("vertexAttrsUpdated",(e=>this.notifyGraphicGeometryChanged(e.object.metadata.graphicUid)))}notifyGraphicGeometryChanged(e){if((0,o.t)(this.graphicStateTracking))return;const t=this.graphics3DGraphics.get(e);t&&this.graphicStateTracking.updateGraphicGeometry(t)}notifyGraphicVisibilityChanged(e){if((0,o.t)(this.graphicStateTracking))return;const t=this.graphics3DGraphics.get(e);t&&this.graphicStateTracking.updateGraphicVisibility(t)}updateLayerVisibility(){const e=this.displayFeatureLimit.maximumNumberOfFeatures,t=this.numberOfGraphics>e*ue,i=!this.suspendedOrOutsideOfView&&!t;i!==this._visible&&(this._visible=i,i?(this.stageLayer.isPickable=!0,this.updateAllGraphicsVisibility()):(this.stageLayer.isPickable=!1,this.hideAllGraphics()),this.updateStageLayerVisibility())}updateStageLayerVisibility(){this.stageLayer.isVisible=this._visible&&(null==this.layer.opacity||this.layer.opacity>0)}getGraphics3DGraphicById(e){return this.graphics3DGraphics.get(e)}getGraphics3DGraphicByObjectId(e){var t;return null!=(t=this.owner.layer)&&t.objectIdField?this._findGraphics3DGraphicByObjectId(e):null}_getGraphicObjectID(e,t=this.owner.layer&&this.owner.layer.objectIdField){return(0,x.O)(e,t)}get graphics3DGraphicsByObjectID(){const e=this.owner.layer&&this.owner.layer.objectIdField;if(!e)return null;const t=new Map;return this.graphics3DGraphics.forEach((i=>{if(!i)return;const r=i.graphic,s=this._getGraphicObjectID(r,e);(0,o.r)(s)&&t.set(s,i)})),t}get labelsEnabled(){return!(!this.labeler||!this.labeler.layerLabelsEnabled())}async updateLabelingInfo(e){const t=this.deconflictor&&this.deconflictor.labelingInfoChange(e),i=this.labeler&&this.labeler.labelingInfoChange(e);await(0,l.A)([t,i])}updateVisibilityInfo(){this.deconflictor&&this.deconflictor.labelingInfoChange(),this.labeler&&this.labeler.visibilityInfoChange()}get symbolUpdateType(){if(this.pendingUpdates.size>0)return"unknown";let e=0,t=0;return(0,u.g)(this.symbols,((i,r)=>{if((0,o.r)(i)){const s=i.getFastUpdateStatus();if(s.loading>0)return!0;this.graphicsBySymbol.has(r)&&(t+=s.fast,e+=s.slow)}return!1}))?"unknown":t>=0&&0===e?"fast":e>=0&&0===t?"slow":"mixed"}runTask(e){this._frameTask.processQueue(e),this._applyPendingUpdates(e),this.notifyChange("running"),this.running||this.notifyChange("updating"),this.notifyChange("updatingRemaining")}setObjectIdVisibility(e,t){t?this.objectIdInvisibleSet.delete(e):this.objectIdInvisibleSet.add(e);const i=this._findGraphics3DGraphicByObjectId(e);(0,o.r)(i)&&this._updateUserVisibility(i)}_findGraphics3DGraphicByObjectId(e){return(0,u.ac)(this.graphics3DGraphics,(t=>this._getGraphicObjectID(t.graphic)===e))}_updateUserVisibility(e){if((0,o.t)(e))return!1;const t=e.graphic,i=this._getGraphicObjectID(t),r=t.visible&&!this.owner.suspended&&((0,o.t)(i)||!this.objectIdInvisibleSet.has(i));return e.setVisibilityFlag(0,r,0)}whenGraphics3DGraphic(e){const t=this.graphics3DGraphics.get(e.uid);if(t)return Promise.resolve(t);const i=this.whenGraphics3DGraphicRequests[e.uid];if(i)return i.promise;const r=(0,l.E)();return this.whenGraphics3DGraphicRequests[e.uid]=r,r.promise}async boundsForGraphics3DGraphic(e,t){const i=this._spatialReference,r=this.owner.view.renderSpatialReference,s=this.owner.view.basemapTerrain.spatialReference,n=this.viewElevationProvider?{service:this.viewElevationProvider,useViewElevation:(0,o.r)(t)&&t.useViewElevation,minDemResolution:(0,o.r)(t)&&t.minDemResolution,minDemResolutionForPoints:this.owner.view.resolution}:null,a=await e.getProjectedBoundingBox(((e,t,s)=>(0,y.x)(e,r,t,e,i,t,s)),((e,t,r)=>(0,y.x)(e,s,t,e,i,t,r)),n,(0,o.g)(t,"signal"));if(!a)return null;const l=a.boundingBox;if(a.requiresDrapedElevation){const e=this.symbolCreationContext.elevationProvider;if(e){(0,m.p)(l,ne);const t=(0,o.q)(e.getElevation(ne[0],ne[1],0,i,"ground"),0);l[2]=Math.min(l[2],t),l[5]=Math.max(l[5],t)}}return{boundingBox:l,screenSpaceObjects:a.screenSpaceObjects}}whenGraphicBounds(e,t){return(0,d.j)(this.owner,"loadedGraphics").then((()=>{const t=this.owner.layer&&this.owner.layer.objectIdField,i=this.owner.loadedGraphics.find((i=>i===e||t&&i.attributes&&e.attributes&&i.attributes[t]===e.attributes[t]));if(i)return this.whenGraphics3DGraphic(i);throw new l.s("internal:graphic-not-part-of-view","Graphic is not part of this view")})).then((e=>this.boundsForGraphics3DGraphic(e,t)))}computeAttachmentOrigin(e,t){const i=this.graphics3DGraphics.get(e.uid);if(!i)return null;const r=i.computeAttachmentOrigin();if(0===r.render.num&&0===r.draped.num)return null;(0,c.a)(ce,0,0,0);let s=0;if(r.render.num>0){if(!(0,y.w)(r.render.origin,this.symbolCreationContext.renderCoordsHelper.spatialReference,de,t))return null;(0,c.u)(ce,ce,de),s++}if(r.draped.num>0){const[e,i]=r.draped.origin,n=(0,o.q)(this.viewElevationProvider.getElevation(e,i,"ground"),0);if((0,c.a)(de,e,i,n),!(0,y.w)(de,this.viewElevationProvider.spatialReference,de,t))return null;(0,c.u)(ce,ce,de),s++}return s>1&&(0,c.d)(ce,ce,1/s),new P.b({x:ce[0],y:ce[1],z:ce[2],spatialReference:t})}getSymbolLayerSize(e,t){const i=this.symbols.get(e.id);if((0,o.t)(i))throw new l.s("internal:symbol-not-part-of-view","Symbol is not part of this view");const r=e.symbolLayers.indexOf(t);if(-1===r)throw new l.s("internal:missing-symbol-layer","Symbol layer is not in symbol");const s=i.getSymbolLayerSize(r);if(null==s)throw new l.s("internal:missing-size","Symbol layer has no valid size");return s}graphicsCollectionChanged(e){this._startCreateGraphics&&(this.add(e.added),this.remove(e.removed))}graphicUpdateHandler(e){const t=e.graphic.uid,i=this.graphics3DGraphics.get(t),r=this.graphicsWithoutSymbol.get(t);if(i||r)switch(e.property){case"visible":this.graphicUpdateVisibleHandler(i);break;case"geometry":this.graphicUpdateGeometryHandler(i,e);break;case"symbol":this.graphicUpdateSymbolHandler(i,e)}}graphicUpdateGeometryHandler(e,t){const i=t.graphic.geometry;if((0,o.t)(i))return void this.recreateGraphic(t.graphic);if((0,o.t)(e)){const e=t.graphic.symbol&&t.graphic.symbol.id;if(e){const t=this.symbols.get(e);if((0,o.r)(t)&&0===t.loadStatus)return}return void this.recreateGraphic(t.graphic)}const r=e.graphics3DSymbol;!(0,o.t)(t.newValue)&&r.updateGeometry(e,t.newValue)||this.recreateGraphic(e.graphic),this.expandComputedExtent(i)}graphicUpdateSymbolHandler(e,t){const i=t.graphic,r=(0,o.r)(e)?e.graphics3DSymbol:(0,o.r)(t.oldValue)?this.symbols.get(t.oldValue.id):null;if((0,o.t)(r)||(0,o.t)(t.newValue))return void this.recreateGraphic(i);const s=r.symbol,n=this.getConvertedSymbol(t.newValue);if(n.type!==s.type||"web-style"===n.type||"web-style"===s.type)return void this.recreateGraphic(i);const a=this.graphicsBySymbol.get(s.id);if(a&&1!==a.size)return void this.recreateGraphic(i);const l=(0,f.m)(s,n);if((0,o.t)(l))return void this.updateSymbolMapping(s.id,n);const h={diff:l,graphics3DGraphicPatches:[],symbolStatePatches:[]};if(r.prepareSymbolPatch(h),!(0,f.d)(h.diff))return void this.recreateGraphic(i);const u=this._getRenderingInfo(i);if((0,o.t)(u))return void this.recreateGraphic(i);const c=r.extentPadding;for(const e of h.symbolStatePatches)e();if(c!==r.extentPadding&&this.recomputeExtentPadding(),(0,o.r)(e))for(const t of h.graphics3DGraphicPatches)t(e,u);this.updateSymbolMapping(s.id,n)}graphicUpdateVisibleHandler(e){this._updateUserVisibility(e)&&(this.labeler&&this.owner.view.labeler.setDirty(),this.owner.view.deconflictor.setDirty())}recreateGraphics(e){this.suspendSymbolCleanup=!0,this.remove(e),this.add(e),this.suspendSymbolCleanup=!1,1===this.effectiveUpdatePolicy&&this._cleanupSymbols()}recreateGraphic(e){this.recreateGraphics([e])}_beginGraphicUpdate(e){this.graphicsWaitingForSymbol.add(e.uid),1===this.graphicsWaitingForSymbol.size&&this.notifyChange("updating")}_endGraphicUpdate(e){e&&(this.graphicsWaitingForSymbol.delete(e.uid),0===this.graphicsWaitingForSymbol.size&&(this._cleanupSymbols(),this.notifyChange("updating")))}recomputeExtentPadding(){let e=0;this.symbols.forEach((t=>{(0,o.r)(t)&&(e=Math.max(e,t.extentPadding))})),this._set("extentPadding",e)}expandComputedExtent(e){const t=ae,i=e.spatialReference;(0,x.T)(e,t);const r=this._spatialReference,s=se.tmpVec;if(i.equals(r)||(0,y.j)(t[0],t[1],0,i,s,r)&&(t[0]=s[0],t[1]=s[1],(0,y.j)(t[3],t[4],0,i,s,r),t[3]=s[0],t[4]=s[1]),!((0,c.K)(t[0])&&(0,c.K)(t[3])&&(0,c.K)(t[1])&&(0,c.K)(t[4])))return;const n=this.computedExtent;let a=null;const o=(0,c.K)(t[2])&&(0,c.K)(t[5]),l=o&&(!n||null==n.zmin||t[2]<n.zmin),h=o&&(!n||null==n.zmax||t[5]>n.zmax);n?(t[0]<n.xmin||t[1]<n.ymin||t[3]>n.xmax||t[4]>n.ymax||l||h)&&(a=this.propertiesPool.get("computedExtent"),a.xmin=Math.min(t[0],n.xmin),a.ymin=Math.min(t[1],n.ymin),a.xmax=Math.max(t[3],n.xmax),a.ymax=Math.max(t[4],n.ymax),a.spatialReference=r):(a=this.propertiesPool.get("computedExtent"),a.xmin=t[0],a.ymin=t[1],a.xmax=t[3],a.ymax=t[4],a.spatialReference=r),a&&(l&&(a.zmin=t[2]),h&&(a.zmax=t[5]),this._set("computedExtent",a))}abortElevationInfoChange(){this.elevationInfoChangeAbortController&&(this.elevationInfoChangeAbortController.abort(),this.elevationInfoChangeAbortController=null)}async elevationInfoChange(){this.abortElevationInfoChange();const e=(0,l.h)();this.elevationInfoChangeAbortController=e;const t=(0,v.i)(this.layer.elevationInfo,this.elevationFeatureExpressionEnabled);this.symbolCreationContext.featureExpressionInfoContext=await(0,v.h)(t,this._spatialReference,oe),(0,l.a)(e),this.elevationInfoChangeAbortController=null,this.labeler&&this.labeler.elevationInfoChange(),this.forEachGraphics3DSymbol(((e,t,i)=>{e.globalPropertyChanged("elevationInfo",t)?t.forEach((e=>{const t=e.graphic,i=e.labelGraphics;for(const e of i)e.graphics3DSymbolLayer.updateGraphicElevationContext(t,e)})):this._recreateSymbol(i)})),this.updateStageLayerElevationProvider(),this.elevationAlignment&&this.elevationAlignment.elevationInfoChange()}updateStageLayerElevationProvider(){this.stageLayerElevationProvider?(this.layer.elevationInfo&&"relative-to-scene"===this.layer.elevationInfo.mode||0===this.numberOfGraphicsProvidingElevation)&&(this.owner.view.elevationProvider.unregister(this.stageLayerElevationProvider),this.stageLayerElevationProvider.dispose(),this.stageLayerElevationProvider=null):(!this.layer.elevationInfo||this.layer.elevationInfo&&"relative-to-scene"!==this.layer.elevationInfo.mode)&&this.numberOfGraphicsProvidingElevation>0&&(this.stageLayerElevationProvider=new X({layer:this.layer,stageLayer:this.stageLayer,view:this.owner.view}),this.owner.view.elevationProvider.register("scene",this.stageLayerElevationProvider))}clearSymbolsAndGraphics(){this.clear(),this.filterVisibility&&this.filterVisibility.clear(),this.labeler&&this.labeler.reset(),this.deconflictor&&this.deconflictor.clear(),this.elevationAlignment&&this.elevationAlignment.clear(),this.stageLayer&&this.stageLayer.invalidateSpatialQueryAccelerator(),this.stageLayerElevationProvider&&(this.owner.view.elevationProvider.unregister(this.stageLayerElevationProvider),this.stageLayerElevationProvider.dispose(),this.stageLayerElevationProvider=null)}startCreateGraphics(){this._startCreateGraphics=!0,this.recreateAllGraphics()}recreateAllGraphics(){this._startCreateGraphics&&(this.clearSymbolsAndGraphics(),this._set("computedExtent",null),this.symbolCreationContext.screenSizePerspectiveEnabled=this.owner.view.screenSizePerspectiveEnabled&&this.layer.screenSizePerspectiveEnabled,this.symbolCreationContext.slicePlaneEnabled=!!this.owner.slicePlaneEnabled,this.owner.loadedGraphics&&this.owner.loadedGraphics.length&&this.owner.view.basemapTerrain.tilingScheme&&this.add(this.owner.loadedGraphics.toArray()))}_recreateSymbol(e){const t=this.graphicsBySymbol.get(e),i=[];t&&(t.forEach(((e,t)=>{var r;const s=e.usedMemory;this._conditionalRemove(e,t),null==(r=this._spatialIndex)||r.remove(e),i.push(e.graphic),e.destroy(),this.removeGraphics3DGraphic(t,s),this.updateLayerVisibility(),this.featureStore.events.emit("changed")})),this.graphicsBySymbol.set(e,new Map));const r=this.symbols.get(e);(0,o.r)(r)&&r.destroy(),this.symbols.delete(e),this.add(i)}_conditionalRemove(e,t){e.isDraped&&this.graphicsDrapedUids.delete(t),this.objectStates&&this.objectStates.removeGraphic(e),this.labeler&&this.labeler.removeGraphic(e),this.deconflictor&&this.deconflictor.removeGraphic(e),(0,o.r)(this.graphicStateTracking)&&this.graphicStateTracking.removeGraphic(e)}add(e){e&&0!==e.length&&(this.owner.view.basemapTerrain&&this.owner.view.basemapTerrain.tilingScheme?(0===this._updatePolicyForGraphics(e)?this._addDelayed(e):this._addImmediate(e),this.notifyChange("updating")):oe.error("#add()","Cannot add graphics before terrain surface has been initialized"))}_updatePolicyForGraphics(e){if(1===this.effectiveUpdatePolicy&&("mesh"===this.layer.geometryType||null==this.layer.geometryType))for(const t of e)if((0,o.r)(t.geometry)&&"mesh"===t.geometry.type&&!t.geometry.loaded)return 0;return this.effectiveUpdatePolicy}_addImmediate(e){this.geometryWarningLogged=!1,this.symbolWarningLogged=!1;for(const t of e)this._addGraphic(t,this._getRenderingInfo(t,oe),1);this._cleanupSymbols(),this.labeler&&(this.owner.view.labeler.setDirty(),this._cleanupSymbols()),this.owner.view.deconflictor.setDirty()}_addDelayed(e){for(const t of e){const e=t.uid;let i=this.pendingUpdates.get(e);i?i.add?0!==i.state&&i.abortController.abort():this.pendingAdds++:(i=this.pendingUpdatesPool.pushNew(),this.pendingAdds++,this.pendingUpdates.set(e,i)),i.add=t}this.notifyChange("running"),this.notifyChange("updatingRemaining")}remove(e){0===this.effectiveUpdatePolicy?this._removeDelayed(e):this._removeImmediate(e),this.notifyChange("updating")}_removeImmediate(e){for(const t of e)this._removeGraphic(t);this._cleanupSymbols(),this.labeler&&this.owner.view.labeler.setDirty(),this.owner.view.deconflictor.setDirty()}_removeDelayed(e){for(const t of e){const e=t.uid,i=this.pendingUpdates.get(e);if(i)i.add&&(i.remove?i.add=null:this.pendingUpdates.delete(e),1===i.state&&i.abortController.abort(),this.pendingAdds--);else{const i=this.pendingUpdatesPool.pushNew();i.remove=t,this.pendingUpdates.set(e,i),this.pendingRemoves++}}0===this.pendingUpdates.size&&this._finishPendingUpdates(),this.notifyChange("running"),this.notifyChange("updatingRemaining")}_finishPendingUpdates(){this.pendingUpdatesPool.clear(),this._cleanupSymbols(),(this.pendingAdds||this.pendingRemoves)&&oe.warn("pendingAdds/Removes in inconsistent state!"),this.pendingAdds=0,this.pendingRemoves=0}_applyPendingUpdates(e){var t;if(this.geometryWarningLogged=!1,this.symbolWarningLogged=!1,0===this.pendingUpdates.size&&null!=(t=this._spatialIndex)&&t.updating)this._spatialIndex.update();else{for(const[t,i]of this.pendingUpdates){if(e.done)break;i.add&&0===i.state&&this._processPendingUpdateNew(i);let r=this.effectiveUpdatePolicy;if(!i.remove||i.add&&2!==i.state||(this.pendingRemoves--,e.madeProgress(),this._removeGraphic(i.remove),i.remove=null,r=1),i.add)switch(i.state){case 2:this._addGraphic(i.add,i.renderingInfo,r),i.add=null,this.pendingAdds--,e.madeProgress();break;case 3:i.add=null,this.pendingAdds--}null==i.remove&&null==i.add&&this.pendingUpdates.delete(t)}0===this.pendingUpdates.size&&(this._finishPendingUpdates(),this.notifyChange("running"))}}_processPendingUpdateNew(e){if(!e.add)return void(e.state=2);const t=e.add.geometry;(0,o.r)(t)&&"mesh"===t.type&&!t.loaded?this._processPendingUpdateNewMesh(e,t):this._processPendingUpdateNewRenderingInfo(e)}_processPendingUpdateNewMesh(e,t){e.state=1,e.abortController=(0,l.h)();const i=e.abortController.signal;t.load({signal:i}).then((()=>{e.abortController=null,this._processPendingUpdateNewRenderingInfo(e)}),(t=>this._processPendingUpdateNewError(e,t)))}_processPendingUpdateNewError(e,t){e.abortController=null,(0,l.g)(t)?e.state=0:e.state=3}_processPendingUpdateNewRenderingInfo(e){if((0,o.t)(this.layer.renderer)||"dictionary"!==this.layer.renderer.type)return e.renderingInfo=this._getRenderingInfo(e.add,oe),void(e.state=2);e.state=1,e.abortController=(0,l.h)(),this._getRenderingInfoAsync(e.add,{signal:e.abortController.signal}).then((t=>{(0,o.t)(t)||(0,o.t)(t.symbol)?(oe&&!this.symbolWarningLogged&&(this.symbolWarningLogged=!0,oe.warn(`Graphic in layer ${this.layer.id} has no symbol and will not render`)),e.renderingInfo=null):e.renderingInfo=t,e.state=2}),(t=>{e.abortController=null,(0,l.g)(t)?e.state=0:e.state=3}))}_addGraphic(e,t,i){if(this.graphicsWithoutSymbol.set(e.uid,e),(0,o.t)(t)||(0,o.t)(t.symbol)||!(0,x.M)(e))return;const r=t.symbol,s=this.getOrCreateGraphics3DSymbol(r,t.renderer);if((0,o.t)(s))return;this.expandComputedExtent(e.geometry),this._beginGraphicUpdate(e);const n=new v.j(e,t,this.layer);let a=!1;const h=e=>{e===s.symbol.id&&(a=!0)};this._whenSymbolRemoved.push(h);const u=()=>{if(!this.destroyed){if(this._whenSymbolRemoved.removeUnordered(h),!(a||s.destroyed||this.graphicSymbolSupported&&e.symbol&&e.symbol.id!==s.symbol.id)){if(this.graphicsWaitingForSymbol.has(e.uid)){const e=this.createGraphics3DGraphic(s,n);this._spatialIndex&&(0,o.r)(e)&&this._spatialIndex.add(e)}this._endGraphicUpdate(e)}--s.referenced,this.featureStore.events.emit("changed"),this.labeler&&this.owner.view.labeler.setDirty()}},c=t=>{this.destroyed||(this._whenSymbolRemoved.removeUnordered(h),a||((0,l.g)(t)?this.add([e]):s.destroyed||this._endGraphicUpdate(e)))};0===i?s.load((()=>this._frameTask.schedule(u)),(e=>this._frameTask.schedule((()=>c(e))))):s.load(u,c)}_removeGraphic(e){const t=e.uid,i=this.graphics3DGraphics.get(t);if(i){var r;i.graphics3DSymbol.onRemoveGraphic(i);const e=i.usedMemory,s=i.isElevationSource;this._conditionalRemove(i,t),null==(r=this._spatialIndex)||r.remove(i);const n=i.graphics3DSymbol.symbol.id;this.graphicsBySymbol.get(n).delete(t),this.graphicsWithoutSymbol.delete(t),this.removeGraphics3DGraphic(t,e,s),i.destroy(),this.featureStore.events.emit("changed")}else this.graphicsWithoutSymbol.delete(t),this.graphicsWaitingForSymbol.delete(t),0===this.graphicsWaitingForSymbol.size&&(this._cleanupSymbols(),this.notifyChange("updating"))}hasLabelingContext(e){if(e instanceof a.m||e instanceof a.i){const t=this.symbolCreationContext.layer;return!!t.labelingInfo&&t.labelingInfo.some((t=>t.symbol===e))}return!1}hasValidSymbolCreationContext(e){return!(e instanceof a.m&&!this.hasLabelingContext(e)&&(oe.error("LabelSymbol3D is only valid as part of a LabelClass. Using LabelSymbol3D as a renderer symbol is not supported."),1))}_getRenderingInfo(e,t){const i=e.geometry;if((0,o.t)(i))return t&&!this.geometryWarningLogged&&(this.geometryWarningLogged=!0,t.warn(`Graphic in layer ${this.layer.id} has no geometry and will not render`)),null;if(!(0,y.n)(i.spatialReference,this._spatialReference))return t&&!this.geometryWarningLogged&&(this.geometryWarningLogged=!0,t.warn(`Graphic in layer ${this.layer.id} has incompatible spatial reference and will not render`)),null;if(!this.graphicSymbolSupported&&(0,o.r)(e.symbol))return t&&!this.symbolWarningLogged&&(this.symbolWarningLogged=!0,t.warn(`Graphic in layer ${this.layer.id} is not allowed to have a symbol, use a renderer instead`)),null;const r=this.rendererHasGeometryOperations?(0,v.c)(e,this.layer):e;let s;return s=this.owner.getRenderingInfo&&(this.getRenderingInfoWithoutRenderer||(0,o.r)(this.currentRenderer))?this.owner.getRenderingInfo(r,this.currentRenderer,(0,o.f)(this.arcadeOnDemand)):{symbol:r.symbol||G(r.geometry)},(0,o.t)(s)||(0,o.t)(s.symbol)?(t&&!this.symbolWarningLogged&&(this.symbolWarningLogged=!0,t.warn(`Graphic in layer ${this.layer.id} has no symbol and will not render`)),null):s}_getRenderingInfoAsync(e,t){const i=e.geometry;if((0,o.t)(i))return oe&&!this.geometryWarningLogged&&(this.geometryWarningLogged=!0,oe.warn(`Graphic in layer ${this.layer.id} has no geometry and will not render`)),null;if(!this.graphicSymbolSupported&&(0,o.r)(e.symbol))return oe&&!this.symbolWarningLogged&&(this.symbolWarningLogged=!0,oe.warn(`Graphic in layer ${this.layer.id} is not allowed to have a symbol, use a renderer instead`)),null;const r=this.rendererHasGeometryOperations?(0,v.c)(e,this.layer):e;return this.owner.getRenderingInfoAsync(r,(0,o.f)(this.currentRenderer),(0,o.f)(this.arcadeOnDemand),t)}createGraphics3DSymbol(e,t){if(!this.hasValidSymbolCreationContext(e))return null;const i=this.getConvertedSymbol(e);if(!i)return null;let r;if((0,o.r)(t)&&"backgroundFillSymbol"in t&&t.backgroundFillSymbol){const e=(0,b.p)(t.backgroundFillSymbol,!1,!0);e.symbol&&"web-style"!==e.symbol.type&&(r=e.symbol.symbolLayers)}const s=W(i,this.symbolCreationContext,r);return s.load((()=>{const e=s.extentPadding;e>this.extentPadding&&this._set("extentPadding",e),this.notifyChange("averageSymbolComplexity")}),(()=>{})),s}getOrCreateGraphics3DSymbol(e,t){let i=this.symbols.get(e.id);return void 0===i&&(i=e instanceof a.b?new v.k(e,(e=>this._frameTask.schedule(e)),(e=>this.createGraphics3DSymbol(e,t))):this.createGraphics3DSymbol(e,t),this.symbols.set(e.id,i)),(0,o.r)(i)&&++i.referenced,i}trackGraphicState(e){return(0,o.t)(this.graphicStateTracking)&&(this.graphicStateTracking=new Q(this)),this.graphicStateTracking.add(e)}addGraphics3DGraphic(e){this._usedMemory+=e.usedMemory,this.graphics3DGraphics.set(e.graphic.uid,e),this.numberOfGraphics++,e.isElevationSource&&(this.numberOfGraphicsProvidingElevation++,this.updateStageLayerElevationProvider()),this.updateLayerVisibility()}removeGraphics3DGraphic(e,t,i=!1){this._usedMemory-=t,this.graphics3DGraphics.delete(e),this.numberOfGraphics--,i&&(this.numberOfGraphicsProvidingElevation--,this.updateStageLayerElevationProvider()),this.updateLayerVisibility()}createGraphics3DGraphic(e,t){const i=t.graphic;if(this.graphicsWithoutSymbol.delete(i.uid),!this.symbols.has(e.symbol.id))return this.add([i]),null;if(this.graphics3DGraphics.has(i.uid))return null;const r=e.createGraphics3DGraphic(t);if((0,o.t)(r))return null;this.addGraphics3DGraphic(r);const s=e.symbol.id;this.graphicsBySymbol.has(s)||this.graphicsBySymbol.set(s,new Map),this.graphicsBySymbol.get(s).set(i.uid,r),r.isDraped&&this.graphicsDrapedUids.add(i.uid),r.centroid=null,(0,o.r)(i.geometry)&&"point"!==i.geometry.type&&r instanceof v.S&&(r.centroid=(0,v.R)(i.geometry,this._spatialReference)),this._updateUserVisibility(r),(0,o.r)(this.scaleVisibility)&&this.scaleVisibility.updateVisibility(r),this.filterVisibility&&this.filterVisibility.updateVisibility(r),this.deconflictor&&this.deconflictor.addGraphic(r),this.labeler&&this.labeler.addGraphic(r),this.objectStates&&this.objectStates.addGraphic(r),this.deconflictor&&this.owner.view.deconflictor.setInitialIconVisibilityFlag(this,r),r.initialize(this.stage,this.stageLayer,this.owner),(0,o.r)(this.graphicStateTracking)&&this.graphicStateTracking.addGraphic(r);const n=this.whenGraphics3DGraphicRequests[i.uid];return n&&(delete this.whenGraphics3DGraphicRequests[i.uid],n.resolve(r)),r}abortRendererChange(){this.rendererChangeAbortController&&(this.rendererChangeAbortController.abort(),this.rendererChangeAbortController=null)}async rendererChange(e){if(this.abortRendererChange(),e!==this.currentRenderer)if(this.validateRenderer(e),(0,o.t)(e)&&this.currentRendererChange(null,!1),L(e))if((0,o.r)(e)&&e.arcadeRequired){const t=(0,l.h)();this.rendererChangeAbortController=t;const{arcadeUtils:i}=await this.ensureArcade();(0,l.a)(t),i.hasGeometryOperations(e)&&(await i.enableGeometryOperations(),(0,l.a)(t)),0===this.effectiveUpdatePolicy?await this._frameTask.schedule((()=>this.currentRendererChange(e,!0)),t.signal):this.currentRendererChange(e,!0),this.rendererChangeAbortController=null}else if(0===this.effectiveUpdatePolicy){const t=(0,l.h)();this.rendererChangeAbortController=t,await this._frameTask.schedule((()=>this.currentRendererChange(e,!1)),t.signal),this.rendererChangeAbortController=null}else this.currentRendererChange(e,!1);else this.currentRendererChange(e,!1)}async ensureArcade(){return(0,o.t)(this.arcadeOnDemand)?(this.arcadeOnDemand=await(0,w.a)(),this.arcadeOnDemand):this.arcadeOnDemand}currentRendererChange(e,t){this.currentRenderer=e,this.rendererHasGeometryOperations=t,this.symbolCreationContext.arcade=(0,o.f)(this.arcadeOnDemand);const i=this.symbolCreationContext.renderer;if(e===i)return;if(this.symbolConversionCache.clear(),(0,o.t)(e))return this.symbolCreationContext.renderer=null,void this.recreateAllGraphics();const r=(0,f.m)(i,e);this.updateUnchangedSymbolMappings(r,e,i),this.symbolCreationContext.renderer=e,(0,o.t)(r)||("complete"===r.type?this.recreateAllGraphics():"partial"===r.type&&(this.applyRendererDiff(r,e,i)?this.volatileGraphicsUpdated():this.recreateAllGraphics()),this.notifyChange("averageSymbolComplexity"))}diffHasSymbolChange(e){for(const t in e.diff)switch(t){case"visualVariables":case"defaultSymbol":case"uniqueValueInfos":break;case"authoringInfo":case"fieldDelimiter":delete e.diff[t];break;default:return!0}return!1}applySymbolSetDiff(e,t,i){e=e||[],t=t||[];const r=[];for(const s of t){const t=this.graphicsBySymbol.get(s.id);t&&t.forEach(((n,a)=>{const l=n.graphic,h=this.layer instanceof _.b?this.layer:null,u=(0,o.f)(this.arcadeOnDemand);if(s===i.defaultSymbol&&i.getSymbol((0,v.c)(l,h),{arcade:u})===i.defaultSymbol)return;const c=n.usedMemory;e.length||i.defaultSymbol?r.push(l):this.graphicsWithoutSymbol.set(a,l);const d=this.graphics3DGraphics.get(a);this._conditionalRemove(d,a),n.destroy(),t.delete(a),this.removeGraphics3DGraphic(a,c),this.updateLayerVisibility()})),this._whenSymbolRemoved.forAll((e=>e(s.id)))}(e.length||r.length)&&(this.graphicsWithoutSymbol.forEach((e=>r.push(e))),this.graphicsWithoutSymbol.clear(),this.add(r)),this._cleanupSymbols(),this.labeler&&this.owner.view.labeler.setDirty(),this.owner.view.deconflictor.setDirty()}applyUniqueValueRendererDiff(e,t,i){const r=e.diff.defaultSymbol,s=e.diff.uniqueValueInfos;if(r||s){const n=s?s.added.map((e=>e.symbol)):[],a=s?s.removed.map((e=>e.symbol)):[];if(s)for(let e=0;e<s.changed.length;e++)n.push(s.changed[e].newValue.symbol),a.push(s.changed[e].oldValue.symbol);return r?(i.defaultSymbol&&a.push(i.defaultSymbol),t.defaultSymbol&&n.push(t.defaultSymbol)):i.defaultSymbol&&n.length&&a.push(t.defaultSymbol),this.applySymbolSetDiff(n,a,t),delete e.diff.defaultSymbol,delete e.diff.uniqueValueInfos,!0}return!1}calculateUnchangedSymbolMapping(e,t,i){const r=e=>(0,o.r)(e)?e.id:null;if(t instanceof n.P&&i instanceof n.P&&((0,o.t)(e)||"partial"===e.type)){const s=e&&e.diff,n=s&&s.defaultSymbol,a=s&&s.uniqueValueInfos;let o;return o=a?a.unchanged.map((e=>({oldId:r(e.oldValue.symbol),newId:r(e.newValue.symbol)}))):i.uniqueValueInfos.map(((e,i)=>({oldId:r(e.symbol),newId:r(t.uniqueValueInfos[i].symbol)}))),!n&&i.defaultSymbol&&o.push({oldId:r(i.defaultSymbol),newId:r(t.defaultSymbol)}),o}return[]}updateSymbolMapping(e,t){const i=t?"string"==typeof t?t:t.id:null,r="string"==typeof t?null:t;if(!e||e===i)return;const s=this.graphicsBySymbol.get(e);this.graphicsBySymbol.delete(e),void 0!==s&&this.graphicsBySymbol.set(i,s);const n=this.symbols.get(e);void 0!==n&&(this.symbols.delete(e),this.symbols.set(i,n),(0,o.r)(n)&&((0,o.r)(r)?n.symbol=r:n.symbol.id=i))}updateUnchangedSymbolMappings(e,t,i){const r=this.calculateUnchangedSymbolMapping(e,t,i);for(const{oldId:e,newId:t}of r)this.updateSymbolMapping(e,t)}applyRendererDiff(e,t,i){if(this.diffHasSymbolChange(e))return!1;if(t instanceof n.P&&i instanceof n.P&&this.applyUniqueValueRendererDiff(e,t,i)&&0===Object.keys(e.diff).length)return!0;for(const[i]of this.graphicsBySymbol){const r=this.symbols.get(i);if((0,o.r)(r)&&!r.applyRendererDiff(e,t))return!1}return!0}opacityChange(){this.forEachGraphics3DSymbol(((e,t)=>e.globalPropertyChanged("opacity",t))),this.updateStageLayerVisibility()}slicePlaneEnabledChange(e){e!==this.symbolCreationContext.slicePlaneEnabled&&(this.symbolCreationContext.slicePlaneEnabled=e,this.stageLayer.isSliceable=e,this.forEachGraphics3DSymbol(((e,t)=>e.globalPropertyChanged("slicePlaneEnabled",t))),this.deconflictor&&this.deconflictor.slicePlaneEnabledChange(),this.labeler&&this.labeler.slicePlaneEnabledChange())}physicalBasedRenderingChange(e){e!==this.symbolCreationContext.physicalBasedRenderingEnabled&&(this.symbolCreationContext.physicalBasedRenderingEnabled=e,this.forEachGraphics3DSymbol(((e,t,i)=>{e.globalPropertyChanged("physicalBasedRenderingEnabled",t)||this._recreateSymbol(i)})))}pixelRatioChange(){this.forEachGraphics3DSymbol(((e,t,i)=>{e.globalPropertyChanged("pixelRatio",t)||this._recreateSymbol(i)}))}_signalUpdatingDuringAsyncLoadedGraphicsChange(){this._updatingPendingLoadedGraphicsChange&&this._updatingPendingLoadedGraphicsChange.remove(),this._updatingPendingLoadedGraphicsChange=(0,r.j)((()=>{this._updatingPendingLoadedGraphicsChange=null}))}setClippingExtent(e,t){const i=this.symbolCreationContext.clippingExtent,r=(0,g.i)();return(0,v.x)(e,r,t)?this.symbolCreationContext.clippingExtent=(0,m.O)((0,m.a)(),r):this.symbolCreationContext.clippingExtent=null,!(0,m.k)(this.symbolCreationContext.clippingExtent,i)}modifyGraphics3DGraphicVisibilities(e){let t=!1;this.graphics3DGraphics.forEach((i=>{e(i)&&(t=!0)})),t&&(this.labeler&&this.owner.view.labeler.setDirty(),this.owner.view.deconflictor.setDirty())}forEachGraphics3DSymbol(e){for(const[t,i]of this.symbols){if((0,o.t)(i))return;e(i,this.graphicsBySymbol.get(t)||pe,t)}}updateAllGraphicsVisibility(){this.filterVisibility&&(this.filterVisibility.dirty=!0),this.modifyGraphics3DGraphicVisibilities((e=>{const t=this._updateUserVisibility(e),i=(0,o.r)(this.scaleVisibility)&&this.scaleVisibility.updateVisibility(e);return t||i}))}hideAllGraphics(){this.modifyGraphics3DGraphicVisibilities((e=>e.setVisibilityFlag(0,!1,0)))}validateRenderer(e){const t=D(e);if(t){const e=`Renderer for layer '${this.layer.title?`${this.layer.title}, `:""}, id:${this.layer.id}' is not supported in a SceneView`;oe.warn(e,t.message)}}volatileGraphicsUpdated(){this.labeler&&this.labeler.reset(),this.stageLayer.shaderTransformationChanged(),this.notifyChange("updating")}_cleanupSymbols(){if(this.graphicsWaitingForSymbol.size>0||this.suspendSymbolCleanup)return;let e=!1;this.symbols.forEach(((t,i)=>{if((0,o.t)(t)||t.referenced>0)return;const r=this.graphicsBySymbol.get(i);r&&0!==r.size||(this.graphicsBySymbol.delete(i),this.symbols.delete(i),t&&t.destroy(),e=!0)})),e&&(this.recomputeExtentPadding(),this.notifyChange("averageSymbolComplexity"))}snapshotInternals(){return{graphics:[...this.graphics3DGraphics.keys()].sort(),symbols:[...this.symbols.keys()].sort(),graphicsBySymbol:[...this.graphicsBySymbol.keys()].sort().map((e=>({symbolId:e,graphics:[...this.graphicsBySymbol.get(e).keys()].sort()}))),graphicsWithoutSymbol:[...this.graphicsWithoutSymbol.keys()].sort(),graphicsDrapedUids:[...this.graphicsDrapedUids].sort(),pendingUpdates:this.pendingUpdates}}get test(){return{symbols:this.symbols,filterVisibility:this.filterVisibility,numPending:this.pendingUpdates.size,forceUpdatePolicy:e=>{this.forcedUpdatePolicy=e}}}get performanceInfo(){return{visible:this.graphics3DGraphics.size,missing:this.graphicsWithoutSymbol.size,pending:this.pendingUpdates.size}}};le.tmpVec=(0,c.n)(),(0,r.e)([(0,p.y)({readOnly:!0})],le.prototype,"computedExtent",void 0),(0,r.e)([(0,p.y)()],le.prototype,"currentRenderer",void 0),(0,r.e)([(0,p.y)()],le.prototype,"rendererHasGeometryOperations",void 0),(0,r.e)([(0,p.y)()],le.prototype,"_frameTask",void 0),(0,r.e)([(0,p.y)()],le.prototype,"rendererChangeAbortController",void 0),(0,r.e)([(0,p.y)()],le.prototype,"elevationInfoChangeAbortController",void 0),(0,r.e)([(0,p.y)()],le.prototype,"setupAbortController",void 0),(0,r.e)([(0,p.y)({readOnly:!0})],le.prototype,"elevationAlignment",void 0),(0,r.e)([(0,p.y)({readOnly:!0})],le.prototype,"scaleVisibility",void 0),(0,r.e)([(0,p.y)({readOnly:!0})],le.prototype,"filterVisibility",void 0),(0,r.e)([(0,p.y)()],le.prototype,"_spatialIndex",void 0),(0,r.e)([(0,p.y)({readOnly:!0})],le.prototype,"extentPadding",void 0),(0,r.e)([(0,p.y)()],le.prototype,"_updatingPendingLoadedGraphicsChange",void 0),(0,r.e)([(0,p.y)({readOnly:!0})],le.prototype,"featureStore",void 0),(0,r.e)([(0,p.y)({readOnly:!0})],le.prototype,"deconflictor",void 0),(0,r.e)([(0,p.y)({readOnly:!0})],le.prototype,"labeler",void 0),(0,r.e)([(0,p.y)({readOnly:!0})],le.prototype,"objectStates",void 0),(0,r.e)([(0,p.y)()],le.prototype,"preferredUpdatePolicy",void 0),(0,r.e)([(0,p.y)()],le.prototype,"forcedUpdatePolicy",void 0),(0,r.e)([(0,p.y)({readOnly:!0})],le.prototype,"effectiveUpdatePolicy",null),(0,r.e)([(0,p.y)({constructOnly:!0})],le.prototype,"elevationFeatureExpressionEnabled",void 0),(0,r.e)([(0,p.y)({constructOnly:!0})],le.prototype,"owner",void 0),(0,r.e)([(0,p.y)({constructOnly:!0})],le.prototype,"layer",void 0),(0,r.e)([(0,p.y)({constructOnly:!0})],le.prototype,"graphicSymbolSupported",void 0),(0,r.e)([(0,p.y)({constructOnly:!0})],le.prototype,"getRenderingInfoWithoutRenderer",void 0),(0,r.e)([(0,p.y)({readOnly:!0})],le.prototype,"updating",null),(0,r.e)([(0,p.y)({readOnly:!0})],le.prototype,"running",null),(0,r.e)([(0,p.y)({readOnly:!0})],le.prototype,"suspendedOrOutsideOfView",null),(0,r.e)([(0,p.y)({readOnly:!0,dependsOn:[]})],le.prototype,"updatingRemaining",null),(0,r.e)([(0,p.y)({readOnly:!0,dependsOn:["owner.view.qualitySettings.graphics3D.maxTotalNumberOfPrimitives","owner.view.qualitySettings.graphics3D.maxTotalNumberOfFeatures","averageSymbolComplexity"]})],le.prototype,"displayFeatureLimit",null),(0,r.e)([(0,p.y)({readOnly:!0,dependsOn:[]})],le.prototype,"averageSymbolComplexity",null),(0,r.e)([(0,p.y)({constructOnly:!0})],le.prototype,"hasZ",void 0),(0,r.e)([(0,p.y)({constructOnly:!0})],le.prototype,"hasM",void 0),le=se=(0,r.e)([(0,p.n)("esri.views.3d.layers.graphics.Graphics3DCore")],le);class he{constructor(){this.add=null,this.renderingInfo=null,this.state=0,this.remove=null}clear(){this.add=null,this.renderingInfo=null,this.state=0,this.abortController=null,this.remove=null}}const ue=10,ce=(0,c.n)(),de=(0,c.n)(),pe=new Map;let fe=class extends r.p{constructor(){super(...arguments),this._scaleRangeActive=!1,this.layerScaleRangeVisibilityQuery=!1,this.handles=new h.u,this.layerView=null,this.layer=null,this.queryGraphicUIDsInExtent=null,this.extent=null,this.graphicsCore=null,this.basemapTerrain=null,this.layerScaleEnabled=!0,this.suspended=!1,this.updating=!0}setup(e,t,i,r,s){this.layerView=e,this.layer=t,this.queryGraphicUIDsInExtent=i,this.graphicsCore=r,this.basemapTerrain=s,this.updateScaleRangeActive();const n=this.layerView.view.resourceController.scheduler;this.handles.add(n.registerTask(v.p.SCALE_VISIBILITY,this))}destroy(){this.handles.destroy(),this.handles=null,this.layerView=null,this.extent=null,this.queryGraphicUIDsInExtent=null,this.graphicsCore=null}_setDirty(){this.updating||this._set("updating",!0)}setExtent(e){this.extent=e,this._setDirty()}scaleRangeActive(){return this._scaleRangeActive}updateScaleRangeActive(){const e=this.layer;let t=this.layerScaleEnabled&&ye(e.minScale,e.maxScale);e.labelingInfo&&!t&&(t=e.labelingInfo.some((e=>e&&ye(e.minScale,e.maxScale))));const i=this._scaleRangeActive!==t;return this._scaleRangeActive=t,t&&!this.handles.has(me)&&this.basemapTerrain?(this.handles.add(this.basemapTerrain.on("scale-change",(e=>this.scaleUpdateHandler(e))),me),this.layerScaleEnabled&&this.handles.add(this.basemapTerrain.on("tiles-visibility-changed",(()=>this._setDirty())),me)):!t&&this.handles.has(me)&&this.handles.remove(me),i}get running(){return!(!this.layerView.view.basemapTerrain||!this.updating)}runTask(){const e=this.layerView.view.basemapTerrain;this.extent&&e&&e.ready&&this._scaleRangeActive&&this.layerScaleEnabled?this.layerScaleRangeVisibilityQuery||(this.layerScaleRangeVisibilityQuery=!0,e.queryVisibleScaleRange(this.extent,this.layer.minScale,this.layer.maxScale,(e=>this.finishUpdate(e)))):this.finishUpdate(!0)}finishUpdate(e){this.layerScaleRangeVisibilityQuery=!1,this._set("suspended",!e),this._set("updating",!1)}visibleAtLayerScale(e){return!this.layerScaleEnabled||(0,u.ad)(e,this.layer.minScale||0,this.layer.maxScale||0)}visibleAtLabelScale(e,t){return(0,u.ad)(e,t.minScale||0,t.maxScale||0)}graphicScale(e){let t;return(0,o.r)(e.centroid)?t=e.centroid:(0,o.r)(e.graphic.geometry)&&"point"===e.graphic.geometry.type&&(t=e.graphic.geometry),t?this.layerView.view.basemapTerrain?this.layerView.view.basemapTerrain.getScale(t):1:null}graphicVisible(e){if(!this.layerScaleEnabled)return!0;const t=this.graphicScale(e);return this.visibleAtLayerScale(t)}updateVisibility(e){if(this._scaleRangeActive){const t=this.graphicVisible(e);return e.setVisibilityFlag(1,t,0)}return!1}updateGraphicLabelScaleVisibility(e){if(!this._scaleRangeActive)return!1;if(!e.labelGraphics||0===e.labelGraphics.length)return!1;const t=this.graphicScale(e),i=this.updateLabelScaleVisibility(e,t);return i&&(this.layerView.view.deconflictor.setDirty(),this.layerView.view.labeler.setDirty()),i}updateLabelScaleVisibility(e,t){if(!e.labelGraphics||0===e.labelGraphics.length)return!1;const i=e.labelGraphics[0]._labelClass;if(i&&null!=i.minScale&&null!=i.maxScale){const r=this.visibleAtLabelScale(t,i);if(e.setVisibilityFlag(1,r,1))return!0}return!1}scaleUpdateHandler(e){if(this._setDirty(),this.layerView.suspended)return;const t=e.extent,i=e.scale,r=this.visibleAtLayerScale(i);let s=!1;this.queryGraphicUIDsInExtent(t,e.spatialReference,(e=>{const n=this.graphicsCore.getGraphics3DGraphicById(e);if((0,o.t)(n))return;const a=n.centroid;(0,o.r)(a)&&(t[0]>a.x||t[1]>a.y||t[2]<a.x||t[3]<a.y)||(n.setVisibilityFlag(1,r,0)&&(s=!0),this.updateLabelScaleVisibility(n,i)&&(s=!0))})),s&&(this.layerView.view.deconflictor.setDirty(),this.layerView.view.labeler.setDirty())}layerMinMaxScaleChangeHandler(){this.updateScaleRangeActive()&&!this._scaleRangeActive?this.graphicsCore.modifyGraphics3DGraphicVisibilities((e=>e.clearVisibilityFlag(1))):this._scaleRangeActive&&this.graphicsCore.updateAllGraphicsVisibility(),this._setDirty()}};function ye(e,t){return e>0||t>0}(0,r.e)([(0,p.y)({constructOnly:!0})],fe.prototype,"layerScaleEnabled",void 0),(0,r.e)([(0,p.y)({readOnly:!0})],fe.prototype,"suspended",void 0),(0,r.e)([(0,p.y)({readOnly:!0})],fe.prototype,"updating",void 0),fe=(0,r.e)([(0,p.n)("esri.views.3d.layers.graphics.Graphics3DScaleVisibility")],fe);const me="terrain-events";var ge=fe},33180:(e,t,i)=>{"use strict";i.d(t,{t:()=>a});var r=i(78155),s=i(62121),n=i(88903);i(80219);const a=e=>{let t=class extends((0,s.r)(e)){constructor(){super(...arguments),this.graphics=null,this.renderer=null}};return(0,r.e)([(0,n.y)()],t.prototype,"graphics",void 0),(0,r.e)([(0,n.y)()],t.prototype,"renderer",void 0),(0,r.e)([(0,n.y)()],t.prototype,"updating",void 0),(0,r.e)([(0,n.y)()],t.prototype,"view",void 0),t=(0,r.e)([(0,n.n)("esri.views.layers.GraphicsView")],t),t}},2695:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>h});var r=i(78155),s=i(40130),n=i(31516),a=i(88903),o=(i(80219),i(50822));i(20215),i(80987),i(98548),i(20736),i(4169),i(92858),i(31531),i(32769),i(83731),i(36845),i(62121);let l=class extends o.d{constructor(e){super(e),this.type="group",this.layerViews=new s.L}initialize(){this.handles.add([this.layerViews.on("change",(e=>this._layerViewsChangeHandler(e))),this.layerViews.on("after-changes",(()=>this._layerViewsAfterChangesHandler())),this.layer.watch("visibilityMode",(()=>this._visibilityModeHandler()),!0),this.watch("visible",(()=>this._visibleHandler()),!0)],"grouplayerview"),this._layerViewsChangeHandler({target:null,added:this.layerViews.toArray(),removed:[],moved:[]}),this._layerViewsAfterChangesHandler()}set layerViews(e){this._set("layerViews",(0,n.n)(e,this._get("layerViews")))}isUpdating(){return this.layerViews.some((e=>e.updating))}get updatingProgress(){return 0===this.layerViews.length?1:this.layerViews.reduce(((e,t)=>e+t.updatingProgress),0)/this.layerViews.length}_hasLayerViewVisibleOverrides(){return this.layerViews.some((e=>e._isOverridden("visible")))}_findLayerViewForLayer(e){return e&&this.layerViews.find((t=>t.layer===e))}_firstVisibleOnLayerOrder(){const e=this.layer.layers.find((e=>{const t=this._findLayerViewForLayer(e);return t&&t.visible}));return e&&this._findLayerViewForLayer(e)}_enforceExclusiveVisibility(e){this._hasLayerViewVisibleOverrides()&&(e||!(e=this._firstVisibleOnLayerOrder())&&this.layerViews.length>0&&(e=this._findLayerViewForLayer(this.layer.layers.getItemAt(0))),this.layerViews.forEach((t=>{t.visible=t===e})))}_layerViewsChangeHandler(e){this.handles.remove("grouplayerview:visible"),this.handles.add(this.layerViews.map((e=>e.watch("visible",(t=>this._layerViewVisibleHandler(t,e)),!0))).toArray(),"grouplayerview:visible");const t=e.added[e.added.length-1];let i=null;t&&t.visible&&(i=t),this._enforceVisibility(i)}_layerViewsAfterChangesHandler(){this.handles.remove("grouplayerview:updating"),this.handles.add(this.layerViews.map((e=>e.watch("updating",(()=>this._updateUpdating()),!0))).toArray(),"grouplayerview:updating"),this._updateUpdating()}_enforceVisibility(e){if(this._hasLayerViewVisibleOverrides())switch(this.layer.visibilityMode){case"inherited":{const e=this.visible;this.layerViews.forEach((t=>{t.visible=e}));break}case"exclusive":this._enforceExclusiveVisibility(e)}}_visibilityModeHandler(){this._enforceVisibility()}_layerViewVisibleHandler(e,t){if(this._hasLayerViewVisibleOverrides())switch(this.layer.visibilityMode){case"inherited":e!==this.visible&&(t.visible=this.visible);break;case"exclusive":this._enforceExclusiveVisibility(e&&t)}}_visibleHandler(){var e;this._hasLayerViewVisibleOverrides()&&"inherited"===(null==(e=this.layer)?void 0:e.visibilityMode)&&this._enforceVisibility()}_updateUpdating(){this.notifyChange("updating")}};(0,r.e)([(0,a.y)({cast:n.t})],l.prototype,"layerViews",null),(0,r.e)([(0,a.y)()],l.prototype,"view",void 0),(0,r.e)([(0,a.y)({readOnly:!0})],l.prototype,"updatingProgress",null),l=(0,r.e)([(0,a.n)("esri.views.layers.GroupLayerView")],l);const h=l},63114:(e,t,i)=>{"use strict";i.d(t,{C:()=>he,F:()=>oe,J:()=>Se,T:()=>le,f:()=>se,s:()=>Ie,y:()=>Fe});var r=i(78155),s=i(83731),n=i(80219),a=i(80987),o=i(20215),l=i(36845),h=i(88903),u=i(7571),c=i(53185),d=i(58404),p=i(30665),f=i(37191),y=i(32422),m=i(60816),g=i(79679),_=i(47122),x=i(9612),v=i(14754),b=i(72105),w=i(92858),S=i(15346),I=i(65352),C=i(71391),M=i(7121),T=i(6585),E=i(18143);class F{constructor(e){this.referenceCount=0,this.callbacks=[],this.runIndex=0,this.handle=e.registerTask(y.p.I3S_CONTROLLER,this)}destroy(){this.handle&&(this.handle.remove(),this.handle=null)}get running(){for(const e of this.callbacks)if(e.needsUpdate())return!0;return!1}runTask(e){this.sort();const t=this.callbacks,i={numIndexLoading:0,numNodesLoading:0};for(let r=0;r<t.length&&!e.done;++r)t[r].priority=t[r].update(e,i),this.runIndex=r}sort(){const e=this.callbacks;let t=e.length;for(let i=this.runIndex;i>0;i--){const r=e[i-1];let s=i;for(;s<e.length&&r.priority<=e[s].priority&&(s!==t||r.priority<e[s].priority);)e[s-1]=e[s],s++;e[s-1]=r,t=s-1}this.runIndex=0}add(e){this.sort(),e.priority=1/0,this.callbacks.unshift(e)}remove(e){(0,r.v)(this.callbacks,e),this.runIndex=this.callbacks.length,this.sort()}}const A=new Map;function R(e,t){let i=A.get(e);return null==i&&(i=new F(e),A.set(e,i)),i.add(t),{remove:()=>{null!=i&&(i.remove(t),i.callbacks.length>0||(A.delete(e),i.destroy()),i=null)}}}class P{constructor(e,t){this.id=e,this.mbs=t,this.renderMbs=(0,g.e)([0,0,0,-1]),this.imModificationImpact=4}}class L extends P{constructor(e,t,i,r,s,n,a,o,l,h){super(e,i),this.index=t,this.childCount=r,this.level=s,this.resources=n,this.version=a,this.lodMetric=o,this.maxError=l,this.numFeatures=h,this.failed=!1,this.hasModifications=!1,this.cacheState=0,this.vertexCount=0,this.memory=0}}class D{constructor(e,t,i,r){this.nodeHasLOD=e,this.isChosen=t,this.lodLevel=i,this.version=r}}class N{constructor(e,t,i,r,s){this.childOffset=e,this.childCount=t,this.visibilityCache=i,this.ref=r,this.node=s,this.useAsHole=0,this.filterImpact=2}}class O{constructor(e,t,i,s,n,a,o,l,h,u,c,d,p,f){this.streamDataController=i,this.viewportQueries=s,this.logger=n,this.holeFilling=a,this._isLoaded=o,this._isReloading=l,this._isSelected=h,this._enable=u,this._needsUpdate=c,this._canRequest=d,this._computeVisibilityObb=p,this._computeNodeFiltering=f,this._dirty=!0,this._nodePages=[],this.nodeCount=0,this.nodesPerPage=0,this.rootIndex=0,this.lodMetric=0,this.lodConversion=e=>e,this.urlPrefix="",this._loading=new Set,this._failedNodes=new Set,this._failedPages=new Set,this._indexMissing=1,this._maxUnloadedPrio=Number.NEGATIVE_INFINITY,this._maxProcessingPrio=Number.POSITIVE_INFINITY,this._nodeTraversalState=new Map,this._version=z(0),this._visibilityCacheVersion=z(0),this._maxLevel=1,this._featureEstimate={estimate:0,leavesReached:!1},this._unloadedMemoryEstimate=0,this._missing=new r.f({deallocator:null}),this._prefetch=new r.f({deallocator:null}),this._updates=new V,this._imModificationUncategorized=new r.f({deallocator:null}),this.ignoreServiceObb=!1,this.progressiveLoadPenalty=0,this.layerHasModifications=!1,this._layerHasFilter=!1,this.logLayer=e,e.serviceUpdateTimeStamp&&e.serviceUpdateTimeStamp.lastUpdate&&(this.lastUpdate=`${e.serviceUpdateTimeStamp.lastUpdate}`),this._maxLodLevel=this.viewportQueries?this.viewportQueries.maxLodLevel:1,this.init(t)}init(e){if("page"===e.type){switch(this.urlPrefix=e.urlPrefix,this.nodesPerPage=e.pageSize,this.rootIndex=e.rootIndex,e.lodMetric){case"maxScreenThreshold":this.lodMetric=1;break;case"maxScreenThresholdSQ":this.lodMetric=1,this.lodConversion=Y}this.addPage(H(this.rootIndex,this.nodesPerPage),e.rootPage)}else if("node"===e.type){this.urlPrefix=e.urlPrefix,this._nodePages.push({nodes:[],children:[],parents:[]}),this.makeRefNode(new P(e.rootNode.id,null),-1);const t=this._validateNode(e.rootNode.id,e.rootNode);t&&this.addNode(t,0)}}loadPage(e){this._loading.add(e);const t=this.urlPrefix+e;this.streamDataController.request(t,"json").then((t=>{this._loading.delete(e),this.addPage(e,t)})).catch((t=>{this._loading.delete(e),(0,o.g)(t)||(this._failedPages.add(e),this.logger.error("#loadPage()",this.logLayer,`Error when loading page ${e}`,t))}))}addPage(e,t){for(let t=this._nodePages.length;t<e;t++)this._nodePages[t]=null;const i=[],r=[],s=t.nodes.map(((t,s)=>{const n=i.length,a=t.children?t.children.length:0;r.push(-1);for(let e=0;e<a;e++)i.push(t.children[e]);const o=`${t.index}`,l=(0,y.H)(t.obb),h=(0,g.e)([l.center[0],l.center[1],l.center[2],(0,m.s)(l.halfSize)]),u=t.mesh&&t.mesh.attribute,c=t.mesh&&t.mesh.geometry,d=t.mesh&&t.mesh.material,p={hasSharedResource:!1,hasFeatureData:!!c,attributes:u&&null!=u.resource?`${u.resource}`:null,geometry:c&&null!=c.resource?`${c.resource}`:null,texture:d&&null!=d.resource?`${d.resource}`:null,geometryDefinition:c?c.definition:-1,materialDefinition:d?d.definition:-1},f=new L(o,e*this.nodesPerPage+s,h,a,0,p,this.lastUpdate,this.lodMetric,this.lodConversion(t.lodThreshold),c?c.featureCount:null);return f.serviceObb=l,f.visibilityObb=this._computeVisibilityObb(f),f.vertexCount=c?c.vertexCount:0,new N(n,a,G(this._visibilityCacheVersion),null,f)}));this._nodePages[e]={nodes:s,children:i,parents:r},this.nodeCount+=s.length,this.updateParentsAndLevel()}updateParentsAndLevel(){const e=new Array,t=(t,i,r)=>{const s=this.getPage(t);if((0,n.r)(s)){const a=W(t,this.nodesPerPage);s.parents[a]=i;const o=s.nodes[a].node;(0,n.r)(o)&&(o.level=r,e.push(t))}};for(t(this.rootIndex,-1,0);e.length;){const i=e.pop(),r=this.getNode(i);if((0,n.r)(r))for(let e=0;e<r.childCount;e++)t(this.getChildIndex(r,e),i,r.level+1),this._maxLevel=Math.max(this._maxLevel,r.level+1)}}getPage(e){return this._nodePages[H(e,this.nodesPerPage)]}getNodeInternal(e){const t=this.getPage(e);return(0,n.t)(t)?null:t.nodes[W(e,this.nodesPerPage)]}addNode(e,t){null!=e.children&&this.populateChildren(t,e.children);const i=this.getParent(t),r=(0,n.r)(i)?i.level+1:0;this._maxLevel=Math.max(this._maxLevel,e.children?r+1:r);const{lodMetric:s,maxError:a}=function(e){if(e)for(let t=0;t<e.length;t++)for(const i of Q)if(i[0]===e[t].metricType)return{lodMetric:i[1],maxError:e[t].maxError};return{lodMetric:0,maxError:0}}(e.lodSelection),o=(0,n.f)(this.getNodeInternal(t));return o.node=new L(e.id,t,(0,g.e)(e.mbs),o.childCount,r,e.resources,e.version,s,a,e.numFeatures),e.obb&&(o.node.serviceObb=(0,y.H)(e.obb)),o.node.visibilityObb=this._computeVisibilityObb(o.node),(0,n.r)(o.ref)&&(null==o.ref.mbs&&(o.ref.mbs=e.mbs),o.node.renderMbs=o.ref.renderMbs,o.node.serviceObbInRenderSR=o.ref.serviceObbInRenderSR,o.ref.visibilityObb=o.node.visibilityObb),o.node}makeRefNode(e,t){const i=this._nodePages[0],r=i.nodes.length;return i.nodes.push(new N(0,0,G(this._visibilityCacheVersion),e,null)),this.nodeCount++,i.parents.push(t),e.renderMbs[3]=-1,(0,n.r)(e.serviceObbInRenderSR)&&(e.serviceObbInRenderSR.halfSize[0]=-1),r}populateChildren(e,t){const i=(0,n.f)(this.getNodeInternal(e)),r=(0,n.f)(this.getPage(e));i.childOffset=r.children.length,i.childCount=t.length;for(let i=0;i<t.length;i++){const s=this.makeRefNode(t[i],e);r.children.push(s)}}getNode(e){const t=this.getNodeInternal(e);return(0,n.r)(t)?t.node:null}getIndexById(e){let t;return this.forAllNodes(((i,r)=>{((0,n.r)(i.node)&&i.node.id===e||(0,n.r)(i.ref)&&i.ref.id===e)&&(t=r)})),t}getNodeById(e){const t=this.getIndexById(e);return t>=0?this.getNode(t):null}getChildIndex(e,t){const i=this.getPage(e.index);if((0,n.t)(i))return-1;const r=i.nodes[W(e.index,this.nodesPerPage)];return i.children[r.childOffset+t]}getParentIndex(e){const t=this.getPage(e);return(0,n.r)(t)?t.parents[W(e,this.nodesPerPage)]:-1}getParent(e){return(e=this.getParentIndex(e))>=0?this.getNode(e):null}isLeaf(e){const t=this.getNodeInternal(e);return(0,n.r)(t)&&0===t.childCount}get rootNode(){return this.getNode(this.rootIndex)}get size(){return this.nodeCount}invalidateVisibilityCache(){this._visibilityCacheVersion=z(this._visibilityCacheVersion)}invalidateNodeVisibilityCache(e){const t=this.getNodeInternal(e);(0,n.r)(t)&&this.invalidateNodeVisibilityCacheInternal(t)}invalidateNodeVisibilityCacheInternal(e){e.visibilityCache=G(this._visibilityCacheVersion)}invalidateBoundingVolumeCache(e){const t=this.getNodeInternal(e);(0,n.r)(t)&&(U(t),this.invalidateNodeVisibilityCacheInternal(t))}invalidateGeometryVisibility(e){const t=this.getNodeInternal(e);(0,n.r)(t)&&(0,n.r)(t.node)&&(t.node.geometryObb=null,t.node.renderMbs[3]=-1,(0,n.r)(t.node.serviceObbInRenderSR)&&(t.node.serviceObbInRenderSR.halfSize[0]=-1))}invalidateVisibilityObbs(){(0,n.t)(this.rootNode)||this.traverse(this.rootNode,(e=>(e.visibilityObb=this._computeVisibilityObb(e),e.geometryObb=null,!0)))}isNodeVisible(e){const t=this.getNodeInternal(e);if((0,n.t)(t)||(0,n.r)(t.ref)&&!t.ref.mbs)return!0;if(!j(t.visibilityCache,this._visibilityCacheVersion)){const e=t.node,i=(0,n.r)(e)&&((0,n.t)(t.ref)||(0,n.r)(e.visibilityObb))?e:(0,n.r)(t.ref)?t.ref:null;if(this._layerHasFilter&&this._computeNodeFiltering&&((0,n.r)(e)||(0,n.r)(t.ref))&&2===t.filterImpact){const i=(0,n.r)(e)?e.mbs:(0,n.r)(t.ref)?t.ref.mbs:null;t.filterImpact=null!=i?this._computeNodeFiltering(i):0}const r=(0,n.r)(e)&&1===t.filterImpact,s=!((0,n.r)(e)&&2===e.imModificationImpact)&&(!i||this.viewportQueries.isNodeVisible(i))&&!r;return t.visibilityCache=B(s,this._visibilityCacheVersion),s}return q(t.visibilityCache)}isGeometryVisible(e){if(!this.isNodeVisible(e))return!1;const t=this.getNodeInternal(e);return!((0,n.r)(t)&&(0,n.r)(t.node)&&(0,n.r)(t.node.geometryObb)&&(!this.layerHasModifications||4!==t.node.imModificationImpact))||this.viewportQueries.isGeometryVisible(t.node)}_traverseCoverage(e,t,i,r,s){const a=this.getPage(e);if((0,n.t)(a)||0===t.childCount)return;const o=t.childOffset+t.childCount,l=new Array;for(let e=t.childOffset;e<o;++e){const t=a.children[e],i=this.getNodeInternal(t);(0,n.r)(i)&&(0,n.r)(i.node)&&this.isGeometryVisible(t)&&l.push(i)}r/=l.length;for(const e of l){const t=(0,n.f)(e.node).index;this._isLoaded(t)||this._isReloading(t)?(s.delta=Math.max(s.delta,i),s.coverage+=r):this._traverseCoverage(t,e,i+1,r,s)}}useNodeAsHole(e){if("off"===this.holeFilling)return!1;const t=this.getNodeInternal(e);if((0,n.t)(t))return!1;if("always"===this.holeFilling)return!0;if(j(t.useAsHole,this._version))return q(t.useAsHole);const i={delta:0,coverage:0};this._traverseCoverage(e,t,0,1,i);const r=i.delta*i.coverage<=.5;return t.useAsHole=B(r,this._version),r}get maxLevel(){return this._maxLevel}get dirty(){return this._dirty}destroy(){this._updates.add.prune(),this._updates.update.prune()}requestUpdate(){this._dirty=!0,this._indexMissing=1,this._version=z(this._version)}imModificationsChanged(e){this.layerHasModifications=e,this.forAllNodes((({node:e})=>{(0,n.r)(e)&&(e.imModificationImpact=4,e.visibilityObb=this._computeVisibilityObb(e),e.hasModifications&&this.invalidateGeometryVisibility(e.index))})),this.invalidateVisibilityCache()}layerFilterChanged(e){this._layerHasFilter=e,this.forAllNodes((e=>{if((0,n.r)(e)){e.filterImpact=2;const t=e.node;(0,n.r)(t)&&this.invalidateNodeVisibilityCache(t.index)}})),this.invalidateVisibilityCache()}update(e,t,i){if(!this._dirty)return;this._maxUnloadedPrio=Number.NEGATIVE_INFINITY,this._maxProcessingPrio=Number.NEGATIVE_INFINITY,this._missing.clear(),this._prefetch.clear(),this._updates.reset(e,this._missing),k.clear();let r=!0;const s=new Z,a=new Z,o=this._imModificationUncategorized;o.clear();const l=new Set;this.traverseVisible(((h,u,c)=>{if((0,n.t)(u)){let e=this.entryPriority(h);e===1/0&&(e=this.entryPriority(c));const t=H(h,this.nodesPerPage);return k.set(t,Math.max(e,k.get(t)||0)),this._loading.has(t)||this._failedPages.has(t)||this._missing.push(t),void(this._maxProcessingPrio=Math.max(this._maxProcessingPrio,e))}const d=u.node;if(this._updateNodeFeatureEstimate(d,a),(0,n.t)(d)){const e=this.entryPriority(h);return this._loading.has(h)||this._failedNodes.has(h)||(this._missing.push(h),k.set(h,e)),void(this._maxProcessingPrio=Math.max(this._maxProcessingPrio,e))}const p=(0,n.f)(this.getPage(h));if(0===this._missing.length&&0===this.nodesPerPage)for(let e=0;e<u.childCount;e++){const t=p.children[u.childOffset+e],i=this.getNodeInternal(t);!(0,n.r)(i)||i.node||this._loading.has(t)||this._failedNodes.has(t)||(k.set(t,this.entryPriority(t)),this._prefetch.push(t))}if(d.failed||!d.resources.hasFeatureData)return;if(l.add(d.id),this._isLoaded(h)){if(s.known+=d.memory,++s.knownNodes,this._isSelected(d)?u.childCount>0&&(r=!1):(s.unremoved+=d.memory,r=!1),this._needsUpdate(d)){const e=this.entryPriority(h);k.set(h,e),this._maxProcessingPrio=Math.max(this._maxProcessingPrio,e),this._updates.update.push(h)}return}if(d.memory&&(s.known+=d.memory,++s.knownNodes),!this._isSelected(d))return void(this._isReloading(h)&&this._updates.remove.push(h));if(u.childCount>0&&(r=!1),d.memory?(s.missing+=d.memory,s.known+=d.memory,++s.knownNodes):++s.missingNodes,e.indexOf(d.index)>=0)return this._maxProcessingPrio=Math.max(this._maxProcessingPrio,this.entryPriority(h)),void(this._updates.cancel=this._updates.cancel.filter((e=>e!==d.index)));if(!t.done&&this._enable(d))return void t.madeProgress();const f=this.entryPriority(h);k.set(h,f),this._maxProcessingPrio=Math.max(this._maxProcessingPrio,f),this._updates.add.push(h),this.layerHasModifications&&i&&(0,n.r)(d)&&4===d.imModificationImpact&&o.push(h)}));const h=this._updates.add;h.length>0&&this.layerHasModifications&&(o.length>0&&i(o),h.filterInPlace((e=>{const t=this.getNodeInternal(e),i=(0,n.t)(t)||(0,n.t)(t.node)||2!==t.node.imModificationImpact;return i||this.invalidateNodeVisibilityCache(e),i}))),this._unloadedMemoryEstimate=s.missing-s.unremoved,s.knownNodes>3&&s.missingNodes>0&&(this._unloadedMemoryEstimate+=s.known/s.knownNodes*s.missingNodes),this._unloadedMemoryEstimate=.8*Math.max(0,this._unloadedMemoryEstimate),this._featureEstimate.estimate=this._computeFeatureEstimate(a),this._featureEstimate.leavesReached=r,this._missing.sort(((e,t)=>e-t)),this._missing.filterInPlace(((e,t)=>t<1||this._missing.data[t-1]!==e)),this._missing.sort(((e,t)=>k.get(e)-k.get(t))),this._missing.length>0&&(this._maxUnloadedPrio=k.get(this._missing.back()),this._prefetch.clear()),this._updates.add.filterInPlace((e=>k.get(e)>=this._maxUnloadedPrio)).sort(((e,t)=>k.get(e)-k.get(t))),this._updates.update.sort(((e,t)=>k.get(e)-k.get(t))),this._indexMissing=this._loading.size+this._missing.length,this._dirty=this._indexMissing>0,k.clear()}checkFeatureTarget(e,t){const i=this.viewportQueries.updateScreenSpaceErrorBias(t);let r=t,s=t,n=i,a=10;for(;a--;){const i=new Z;if(this._updateFeatureEstimate(r,i),this._computeFeatureEstimate(i)<=e){if(r>=t||i.missingNodes>0||0===a)break;n=r,r=.5*(r+s)}else s=r,r=.5*(r+n)}return this._version=z(this._version),this.viewportQueries.updateScreenSpaceErrorBias(i),Math.min(t,r)}_updateFeatureEstimate(e,t){this._version=z(this._version),this.viewportQueries.updateScreenSpaceErrorBias(e),this.traverseVisible(((e,i)=>this._updateNodeFeatureEstimate((0,n.r)(i)&&i.node,t)))}_updateNodeFeatureEstimate(e,t){if(!((0,n.t)(e)||e.failed||(0,n.t)(e.numFeatures)))return this._isLoaded(e.index)?(t.known+=e.numFeatures,++t.knownNodes,void(this._isSelected(e)||(t.unremoved+=e.numFeatures))):void(this._isSelected(e)&&((0,n.r)(e.numFeatures)?(t.missing+=e.numFeatures,t.known+=e.numFeatures,++t.knownNodes):++t.missingNodes))}_computeFeatureEstimate(e){let t=e.known-e.unremoved;return e.knownNodes>3&&e.missingNodes>0&&(t+=e.known/e.knownNodes*e.missingNodes),Math.max(0,t)}load(){return this._load(this._missing)}prefetch(){return this._prefetch.sort(((e,t)=>k.get(e)-k.get(t))),this._load(this._prefetch)}_load(e){if(0===e.length||!this._canRequest())return!1;for(;e.length>0&&this._canRequest();)0===this.nodesPerPage?this._loadNode(e.pop()):this.loadPage(e.pop());return!0}isLoading(){return this._indexMissing>0}getIndexLoading(){return this._loading.size}getIndexMissing(){return this._indexMissing}getUnloadedMemoryEstimate(){return this._unloadedMemoryEstimate}get updates(){return this._updates}get featureEstimate(){return this._featureEstimate}nodeTraversalState(e){if((0,n.t)(e))return null;let t=this._nodeTraversalState.get(e.index);if(t&&j(t.version,this._version))return t;const i=this.viewportQueries.getLodLevel(e),r=this.viewportQueries.hasLOD(e);let s=!0;if(r){const t=this.getParentIndex(e.index);if(t>=0){const e=this._nodeTraversalState.get(t);s=e&&i>e.lodLevel}else s=i>0}else s=0===e.childCount;return t?(t.lodLevel=i,t.isChosen=s,t.version=B(!0,this._version),t):(t=new D(r,s,i,B(!0,this._version)),this._nodeTraversalState.set(e.index,t),t)}_loadNode(e){this._loading.add(e);const t=(0,n.f)(this.getNodeInternal(e)).ref;if((0,n.t)(t))return void this._failedNodes.add(e);const i=t.id,r=this.urlPrefix+i,s=()=>{this._loading.delete(e),0===this._missing.length&&0===this._loading.size&&this.requestUpdate()};this.streamDataController.request(r,"json").then((t=>{s();const r=this._validateNode(i,t);if(null==r)return;r.obb&&this.invalidateNodeVisibilityCache(e);const n=this.addNode(r,e);this.nodeTraversalState(n)}),(t=>{s(),(0,o.g)(t)||(this.logger.error("#loadNode()",this.logLayer,"Error loading node: "+r),this._failedNodes.add(e))}))}_validateNode(e,t){if(null==t||"object"!=typeof t||t.id!==e)return this.logger.error("#validateNode()",this.logLayer,`Invalid node. Wrong type or wrong id "${e}"`),null;if(!Array.isArray(t.mbs))return this.logger.error("#validateNode()",this.logLayer,`Invalid bounding volume on node ${e}.`),null;t.sharedResource&&"./shared"!==t.sharedResource.href&&"./shared/"!==t.sharedResource.href&&this.logger.warn("#validateNode()",this.logLayer,`Invalid shared resource href on node "${e}"`),null==t.geometryData||Array.isArray(t.geometryData)&&1===t.geometryData.length&&"./geometries/0"===t.geometryData[0].href||this.logger.warn("#validateNode()",this.logLayer,`Invalid geometry data on node "${e}"`),null==t.attributeData||Array.isArray(t.attributeData)&&!t.attributeData.some(((e,t)=>e.href!==`./attributes/f_${t}/0`))||this.logger.warn("#validateNode()",this.logLayer,`Invalid attribute data on node "${e}"`),t.featureData&&t.featureData.length>1&&this.logger.warn("#validateNode()",this.logLayer,`Node ${e} has ${t.featureData.length} bundles. Only the first bundle will be loaded.`);const i=t.hasOwnProperty("obb")&&!this.ignoreServiceObb?t.obb:null,r=t.featureData&&1===t.featureData.length&&t.featureData[0].featureRange?t.featureData[0].featureRange[1]-t.featureData[0].featureRange[0]+1:null,s=Array.isArray(t.children)?t.children.map((t=>{if(null==t)return null;const i=t=>this.logger.error("#validateNode()",this.logLayer,`Invalid node reference on node ${e}: ${t}`);if("number"==typeof t.id)i(`id ${t.id} is a number instead of a string.`);else if("string"!=typeof t.id||!Array.isArray(t.mbs))return i("Missing or invalid id."),null;if(!Array.isArray(t.mbs))return i(`Invalid bounding volume on reference ${t.id}.`),null;t.href&&t.href!=="../"+t.id&&this.logger.error("#validateNode()",this.logLayer,`Invalid node href on node "${e}"`);const r=t.hasOwnProperty("obb")&&!this.ignoreServiceObb?t.obb:null,s=new P(`${t.id}`,t.mbs);return s.serviceObb=r,s.visibilityObb=this._computeVisibilityObb(s),s})).filter((e=>null!=e)):null;return{id:e,mbs:t.mbs,obb:i,children:s,resources:{hasFeatureData:t.featureData&&t.featureData.length>0,hasSharedResource:null!=t.sharedResource,attributes:t.attributeData?e:null,texture:t.textureData&&t.textureData.length>0?e:null,geometry:null!=t.geometryData?e:null},version:"string"==typeof t.version?t.version:null,lodSelection:Array.isArray(t.lodSelection)?t.lodSelection:null,numFeatures:r}}resetFailedNodes(){this._failedNodes.clear(),this._failedPages.clear(),this.forAllNodes((e=>{(0,n.r)(e.node)&&(e.node.failed=!1)}))}entryPriority(e){const t=this.getNodeInternal(e),i=this.getParentIndex(e);if((0,n.t)(t)||i<0&&null==t.node)return i<0?1/0:this.entryPriority(i);let r=0;if(t.node&&i>=0){const e=this._nodeTraversalState.get(i);null!=e&&(r=e.lodLevel)}let s=this.progressiveLoadPenalty;for(let t=e;t>=0;t=this.getParentIndex(t))if(this._isLoaded(t)){s=0;break}const a=(0,n.r)(t.ref)?this.viewportQueries.distToPOI(t.ref):(0,n.r)(t.node)?this.viewportQueries.distToPOI(t.node):0;return-a-r*(a+this.progressiveLoadPenalty)+s}traverseVisible(e){const t=this.getNodeInternal(this.rootIndex);(0,n.t)(t)?e(this.rootIndex,null,null):this._traverseVisible(this.rootIndex,-1,t,e)}_traverseVisible(e,t,i,r){if(i.node&&0===i.childCount)return void(this.isGeometryVisible(e)&&r(e,i,t));if(!this.isNodeVisible(e))return;if(r(e,i,t),null==i.node)return;const s=this.nodeTraversalState(i.node);if(s.nodeHasLOD&&s.lodLevel===this._maxLodLevel)return;const a=(0,n.f)(this.getPage(e));for(let t=0;t<i.childCount;t++){const s=a.children[i.childOffset+t],o=this.getNodeInternal(s);(0,n.r)(o)?this._traverseVisible(s,e,o,r):r(s,null,e)}}traverse(e,t){t(e)&&this.traverseChildren(e,t)}traverseChildren(e,t){const i=e.index,r=this.getNodeInternal(i);(0,n.r)(r)&&this._traverseChildren(i,r,t)}_traverseChildren(e,t,i){const r=this.getPage(e);if((0,n.t)(r))return;const s=t.childOffset+t.childCount;for(let e=t.childOffset;e<s;++e){const t=r.children[e],s=this.getNodeInternal(t);(0,n.r)(s)&&(0,n.r)(s.node)&&i(s.node)&&this._traverseChildren(t,s,i)}}updateStats(e){if(this._updates.add.length>0&&(e.nodes+=" + "+this._updates.add.length),(this._indexMissing||this._prefetch.length>0)&&(e.index+=" + "+this._indexMissing||0),e.prio=this._maxProcessingPrio,this._featureEstimate.estimate){const t=this._featureEstimate.estimate-e.features;t>0?e.features+=" + "+t:t<0&&(e.features+=" - "+-t)}}getPriority(){return Math.max(this._maxProcessingPrio,this._maxUnloadedPrio)}updateElevationInfo(e){this.forAllNodes(U),this.viewportQueries.updateElevationInfo(e)}forAllNodes(e){for(let t=0;t<this._nodePages.length;t++){const i=this._nodePages[t];if(i){const r=t*this.nodesPerPage;for(let t=0;t<i.nodes.length;t++)e(i.nodes[t],r+t)}}}get test(){return{addNode:(e,t)=>this.addNode(e,t)}}}const k=new Map;class V{constructor(){this.update=new r.f({deallocator:null}),this.add=new r.f({deallocator:null}),this.remove=new r.f({deallocator:null}),this.cancel=[]}reset(e,t){this.add.clear(),this.update.clear(),this.cancel=e,this.missing=t}}function U(e){(0,n.r)(e.node)&&(e.node.renderMbs[3]=-1,(0,n.r)(e.node.serviceObbInRenderSR)&&(e.node.serviceObbInRenderSR.halfSize[0]=-1)),(0,n.r)(e.ref)&&(e.ref.renderMbs[3]=-1,(0,n.r)(e.ref.serviceObbInRenderSR)&&(e.ref.serviceObbInRenderSR.halfSize[0]=-1))}function G(e){return(0,_.z)(e,-2)}function z(e){return(0,_.z)(e,2)}function B(e,t){return t+(e?1:0)}function j(e,t){return(-2&e)===t}function q(e){return 1==(1&e)}function H(e,t){return 0===t?0:e/t|0}function W(e,t){return 0===t?e:e%t}const Q=[["maxScreenThreshold",1],["screenSpaceRelative",2],["removedFeatureDiameter",3],["distanceRangeFromDefaultCamera",4]];class Z{constructor(){this.known=0,this.knownNodes=0,this.missing=0,this.missingNodes=0,this.unremoved=0}}function Y(e){return Math.sqrt(e*(4/Math.PI))}class J{constructor(e){this.layerView=e,this._lodGlobalDirty=!1}startNodeLoading(e,t,i,r){this._maxLodLevel=r.maxLodLevel,this._index=i,this._isNodeInScaleBounds=e,this._removeNodes=t}shouldLoadNode(e){if((0,n.t)(e))return!1;const t=this._index.nodeTraversalState(e);return!!this.isChosenMaxLOD(t)||!!t.isChosen&&this._childrenRequireLoading(e)}setLodGlobalDirty(){this._lodGlobalDirty=!0}get requiresLODGlobalHandling(){return null!=this._index&&!0===this._lodGlobalDirty}lodGlobalHandling(e){if(!this.requiresLODGlobalHandling)return!1;this._lodGlobalDirty=!1;const t=this.layerView.view.resourceController.memoryController.usedMemory,i=Math.max(0,Math.floor(10*(t-1)));X.clear(),this._lodGlobalHandling(this._index.rootNode,i,!1);const r=X.length;this._removeNodes(X,e);const s=X.length<r;return 0!==X.length&&(this._lodGlobalDirty=!0),X.clear(),s}_lodGlobalHandling(e,t,i){if((0,n.t)(e))return!1;const r=e.index,s=this._index,a=this.layerView,o=s.nodeTraversalState(e),l=this.isChosenMaxLOD(o),h=a.isNodeLoaded(r),u=a.nodeCrossfadingEnabled;if(u&&h&&l){const t=!i&&this.hasNoVisibleChildren(e);a.fadeNode(r,0,!t)}const c=h&&(!a.isNodeFullyFadedIn||a.isNodeFullyFadedIn(r));if(h&&(a.updateNodeState(r,l?1:0),l))return c&&this._removeChildrenRecursive(e),c;const d=e.childCount>0;let p=d;if(d)for(let r=0;r<e.childCount;r++){const a=s.getChildIndex(e,r),o=s.getNode(a);(0,n.r)(o)?s.isGeometryVisible(a)&&!this._lodGlobalHandling(o,t,i||c)&&this._isNodeInScaleBounds(o)&&(p=!1):s.isNodeVisible(a)&&(p=!1)}const f=h&&!l&&(p||X.length<t);f&&X.push(r),!u||f||!h||i||p||a.fadeNode(r,0,!1);const y=!e.resources.hasFeatureData;return p||c&&!f||y}_removeChildrenRecursive(e){this._index.traverseChildren(e,(e=>((this.layerView.isNodeLoaded(e.index)||this.layerView.isNodeReloading(e.index))&&X.push(e.index),!0)))}hasNoVisibleChildren(e){let t=!0;return this._index.traverseChildren(e,(e=>!(!t||!this._index.isNodeVisible(e.index)||this.layerView.isNodeLoaded(e.index)&&(t=!1,1)))),t}_childrenRequireLoading(e){let t=!1,i=!0;return this._index.traverseChildren(e,(e=>{if(!i||!this._index.isNodeVisible(e.index))return!1;const r=this._index.nodeTraversalState(e);return this.isChosenMaxLOD(r)&&this._index.isGeometryVisible(e.index)&&(t=!0),!this.layerView.isNodeLoaded(e.index)||(i=!1,!1)})),i&&t}isChosenMaxLOD(e){return e.isChosen&&(!e.nodeHasLOD||e.lodLevel===this._maxLodLevel)}}const X=new r.f({deallocator:null});class ${constructor(e,t){this._textureRep=e,this._textureId=t,this._textureRef=(0,n.x)(this._textureId,(e=>this._textureRep.acquire(e)))}dispose(){this._textureRef=(0,n.x)(this._textureId,(e=>{this._textureRep.release(e)}))}bind(e,t,i){if((0,n.r)(this._textureRef)){const r=this._textureRef.glTexture;e.bindTexture(r,t),e.setUniform2f(i,r.descriptor.width,r.descriptor.height)}}}function K(e){return e.sort(((e,t)=>e.encoding-t.encoding))}const ee={ktx2:1,basis:2,dds:4,png:8,jpg:16,"ktx-etc2":32},te={[b.aT.KTX2_ENCODING]:2,[b.aT.BASIS_ENCODING]:2,[b.aT.DDS_ENCODING]:4,"image/png":8,"image/jpg":16,"image/jpeg":16,"image/ktx":32};function ie(e){const t=e&&e.materialDefinitions?Object.keys(e.materialDefinitions)[0]:null,i=e&&e.textureDefinitions?Object.keys(e.textureDefinitions)[0]:null,r=t&&e.materialDefinitions[t],s=i&&e.textureDefinitions[i],n=re();if(null!=r){const e=r.params;e.diffuse&&(n.metallicRoughness.baseColorFactor=[e.diffuse[0],e.diffuse[1],e.diffuse[2],1]),null!=e.doubleSided&&(n.doubleSided=e.doubleSided,n.cullFace=e.doubleSided?0:2),"none"!==e.cullFace&&"front"!==e.cullFace&&"back"!==e.cullFace||(n.cullFace="none"===e.cullFace?0:"back"===e.cullFace?2:1),e.transparency&&(n.metallicRoughness.baseColorFactor[3]=(0,m.o)(1-e.transparency,0,1)),(e.useVertexColorAlpha||n.metallicRoughness.baseColorFactor[3]<1)&&(n.alphaMode="blend")}const a=[];if(null!=s){const e=0;!s.wrap||"repeat"!==s.wrap[0]&&"repeat"!==s.wrap[1]||(n.wrapTextures=!0);let t=1;"rgba"===s.channels&&(n.alphaMode="blend",t|=32);const i=s.images.length-1,r=s.images[i],o=e=>e&&e.split("/").pop(),l=Array.isArray(s.encoding)?K(s.encoding.map(((e,t)=>({name:o(r.href[t]),encoding:te[e]||0})))):[{name:o(r.href),encoding:te[s.encoding]||0}];a.push({id:e,usage:t,encodings:l}),n.metallicRoughness.baseColorTextureId=e}return{material:n,textures:a}}const re=()=>({alphaMode:"opaque",alphaCutoff:b.R,doubleSided:!0,cullFace:0,normalTextureId:-1,emissiveTextureId:-1,occlusionTextureId:-1,emissiveFactor:[0,0,0],metallicRoughness:{baseColorFactor:[.8,.8,.8,1],baseColorTextureId:-1,metallicRoughnessTextureId:-1,metallicFactor:0,roughnessFactor:.6},wrapTextures:!1,hasParametersFromSource:!0});function se(e,t,i,r){if((0,n.t)(e)||null==e.data)return null;const s=e.data,a=!(s instanceof HTMLImageElement)||(0,m.a4)(s.width)&&(0,m.a4)(s.height),o=r.renderingContext.parameters.maxMaxAnisotropy,l=i&&!r.has(2)?1:o,h=a&&!e.downsampled&&l>1,u=i||!t.wrapTextures?ne:ae,c=function(e){switch(e){case 1:return b.aT.KTX2_ENCODING;case 2:return b.aT.BASIS_ENCODING;case 4:return b.aT.DDS_ENCODING;case 8:return"image/png";case 16:return"image/jpeg";case 32:return"image/ktx";default:return""}}(e.encoding),d=1&e.usage?"opaque"===t.alphaMode?3:4:3;return new b.aT(s,{mipmap:h,maxAnisotropy:l,encoding:c,wrap:u,components:d,noUnpackFlip:!0})}const ne={s:33071,t:33071},ae={s:10497,t:10497};function oe(e,t,i,r,s,a){const o=a.rendererTextureUsage,l=e=>function(e,t,i){if((0,n.t)(e)||0===i)return null;for(let r=0;r<e.length;r++){const s=e[r];if((0,n.r)(s)&&0!=(s.usage&i))return t[r].id}return null}(r,i,e&o),h=t.metallicRoughness.baseColorFactor,u=(0,m.o)(t.metallicRoughness.baseColorFactor[3],0,1);e.baseColor=[h[0],h[1],h[2],u],e.hasParametersFromSource=!!t.hasParametersFromSource,e.usePBR=a.usePBR,e.mrrFactors=[t.metallicRoughness.metallicFactor,t.metallicRoughness.roughnessFactor,t.hasParametersFromSource?.2:.5],e.emissiveFactor=t.emissiveFactor,e.isIntegratedMesh=a.isIntegratedMesh,e.alphaCutoff="mask"===t.alphaMode?t.alphaCutoff:b.R,e.alphaDiscardMode="opaque"===t.alphaMode?1:"mask"===t.alphaMode?2:3;const c=l(33);c&&(e.baseColorTexture=new $(s,c));const d=l(2);d&&(e.metallicRoughnessTexture=new $(s,d));const p=l(16);p&&(e.emissionTexture=new $(s,p));const f=l(8);f&&(e.occlusionTexture=new $(s,f));const y=l(4);y&&(e.normalTexture=new $(s,y)),e.commonMaterialParameters.slicePlaneEnabled=a.slicePlaneEnabled,e.commonMaterialParameters.doubleSided=t.doubleSided,e.commonMaterialParameters.cullFace=t.cullFace,e.ellipsoidMode=function(e){return e&&(0,w.a)(e)?2:e&&(0,w.P)(e)?3:1}(a.viewSpatialReference)}function le(e){const t=e.has(1),i=e.has(0),r=(0,n.c)("disable-feature:i3s-basis")?0:3;return 24|(t?4|r:0)|(i?r:0)}function he(e,t){return e.find((e=>0!=(e.encoding&t)))}class ue{constructor(e,t,i,r,s,a){if(this.streamDataController=t,this.logger=i,this.defaultGeometrySchema=r,this.requiredAttributes=s,this.options=a,this.logLayer=e,this.layerUrl=e.parsedUrl.path,this.geometryDefinitions=e.geometryDefinitions,e.materialDefinitions){const t=e.textureSetDefinitions;this.materialAndTextures=e.materialDefinitions.map((e=>function(e,t){const i=new Map,r=(e,t)=>{if((0,n.t)(e))return-1;if(i.has(e.id)){const r=i.get(e.id);return r.usage|=t,r.id}const r=i.size;return i.set(e.id,{id:r,usage:t}),r},s=t.pbrMetallicRoughness,a=s&&s.baseColorFactor,o=t.emissiveFactor,l=null==t.normalTexture&&null==t.emissiveTexture&&null==t.occlusionTexture&&(!s||null==s.metallicRoughnessTexture&&1===s.roughnessFactor&&(1===s.metallicFactor||0===s.metallicFactor)),h=l?b.bR[0]:s?s.metallicFactor:1,u=l?b.bR[1]:s?s.roughnessFactor:1,c="mask"===t.alphaMode?33:1,d={baseColorFactor:a?[a[0],a[1],a[2],a[3]]:[1,1,1,1],baseColorTextureId:r(s&&s.baseColorTexture,c),metallicRoughnessTextureId:r(s&&s.metallicRoughnessTexture,2),metallicFactor:h,roughnessFactor:u},p={alphaMode:t.alphaMode,alphaCutoff:t.alphaCutoff,doubleSided:t.doubleSided,cullFace:"none"===t.cullFace?0:"back"===t.cullFace?2:"front"===t.cullFace?1:void 0,normalTextureId:r(t.normalTexture,4),emissiveTextureId:r(t.emissiveTexture,16),occlusionTextureId:r(t.occlusionTexture,8),emissiveFactor:o?[o[0],o[1],o[2]]:[0,0,0],metallicRoughness:d,wrapTextures:!1,hasParametersFromSource:l},f=[];return i.forEach((({usage:t},i)=>{const r=(0,n.r)(e)&&e[i]&&e[i].formats,s=r?K(r.map((({name:e,format:t})=>({name:e,encoding:ee[t]})))):[];f.push({id:i,usage:t,encodings:s})})),{material:p,textures:f}}(t,e)))}}load(e,t,i){return this.streamDataController.request(e,t,i)}loadAttribute(e,t,i){const r=`${this.layerUrl}/nodes/${e.resources.attributes}/attributes/${t.key}/0`;return this.load(r,"binary",i).then((e=>(0,v.C)(t,e)))}loadAttributes(e,t,i){return(0,o.A)(t.map((t=>this.loadAttribute(e,t.attributeStorageInfo,i)))).then((i=>{const r={};for(let s=0;s<t.length;++s)if(i[s].value)r[t[s].name]=i[s].value;else{if((0,o.g)(i[s].error))throw i[s].error;this.logger.error("#loadAttributes",this.logLayer,`Failed to load attributeData for '${t[s].name}' on node '${e.id}'`,i[s].error)}return r}))}async loadNodeData(e,t){const i=null!=this.requiredAttributes&&e.resources.attributes?(0,x.a)(this.loadAttributes(e,this.requiredAttributes,t)):null,{bufferDefinition:r,bufferIndex:s}=function(e,t){const i={bufferDefinition:null,bufferIndex:0};if(null==e||t.resources.geometryDefinition<0)return i;const r=t.resources.geometryDefinition>=0?e[t.resources.geometryDefinition].geometryBuffers:null;if(null==r)return i;for(let e=0;e<r.length;e++){const t=r[e];if(null==t.compressedAttributes)i.bufferIndex=e,i.bufferDefinition=r[e];else if("draco"===t.compressedAttributes.encoding&&!(0,n.c)("disable-feature:i3s-draco"))return i.bufferIndex=e,i.bufferDefinition=t,i}return i}(this.geometryDefinitions,e),a=!!e.resources.geometry,o=a?(0,x.a)(this.loadGeometry(e.resources.geometry,s,t)):null,l=e.resources.hasSharedResource?await this.loadShared(e,t):null,h=this.materialAndTextures&&e.resources.materialDefinition>=0?this.materialAndTextures[e.resources.materialDefinition]:null!=l?ie(l):null,u=h&&h.material,c=h&&h.textures,d=`${e.id}`,p=!a&&this.options.loadFeatureData,f=p?await this.loadFeatureData(d,t):null,y=p?function(e){for(const t of e.featureData){const e=t.geometries;if(null!=e)for(const i of e)return{featureIds:[t.id],featureDataPosition:t.position,geometries:[i]}}return null}(f):function(e){return{featureIds:[],geometries:[{type:"ArrayBufferView",params:{material:e}}],featureDataPosition:[0,0,0]}}(u),m=(0,n.t)(y)&&function(e){const t=new Array;for(const i of e.featureData)null!=i.position&&t.push({featureIds:[i.id],featureDataPosition:i.position,geometries:null});return t}(f),g=null!=c&&c.length>0?(0,x.a)(this.loadTextures(e,c,t)):null;let _=null,b=null;if(o){_=(0,x.i)(await o);const e=function(e,t){if(!e||!t||!t.materialDefinitions)return e;const i=Object.keys(t.materialDefinitions)[0];return!t.materialDefinitions[i].params.vertexRegions&&e.vertexAttributes.region&&delete(e=(0,n.y)(e)).vertexAttributes.region,e}(this.defaultGeometrySchema,l);b=(0,v.g)(r,e)}const w=g?(0,x.i)(await g):null,S=i?(0,x.i)(await i):{},I=S?{attributeData:S,loadedAttributes:this.requiredAttributes}:null;return(0,n.r)(y)?{geometryData:y,attributeDataInfo:I,geometryBuffer:_,geometryDescriptor:b,requiredTextures:c,textureData:w}:(0,n.r)(m)?{pointData:m,attributeDataInfo:I,geometryBuffer:_,geometryDescriptor:b,requiredTextures:c,textureData:w}:Promise.reject()}static addAbsoluteHrefTexture(e,t){const i=e.textureDefinitions;if(null!=i)for(const e of Object.keys(i))for(const r of i[e].images)Array.isArray(r.href)?r.hrefConcat=r.href.map((e=>(0,a.T)(e,t))):r.hrefConcat=(0,a.T)(r.href,t)}static fixTextureEncodings(e){const t=e.textureDefinitions;if(null!=t)for(const e in t){const i=t[e];if(Array.isArray(i.encoding))for(let e=0;e<i.encoding.length;e++){const t=i.encoding[e];"data:"===t.substring(0,5)&&(i.encoding[e]=t.substring(5))}else{const e=i.encoding;"data:"===e.substring(0,5)&&(i.encoding=e.substring(5))}}}loadShared(e,t){const i=`${this.layerUrl}/nodes/${e.resources.geometry}/shared`;return this.load(i,"json",t).then((e=>(ue.fixTextureEncodings(e),ue.addAbsoluteHrefTexture(e,i),e)))}loadTexture(e,t,i,r,s,n){let a=!1;return 4===s||1===s||2===s?this.load(e,"binary",n).then((e=>({id:t,usage:i,data:e,encoding:s,downsampled:a}))):this.load(e,"image",n).then((e=>{let n=e;if(r&&e.width*e.height>=4096){const t=Math.ceil(e.width/2),i=Math.ceil(e.height/2),r=document.createElement("canvas");r.width=t,r.height=i,r.getContext("2d").drawImage(e,0,0,t,i),n=r,a=!0}return{id:t,usage:i,data:n,encoding:s,downsampled:a}}))}loadTextures(e,t,i){const r=this.options.uncompressedTextureDownsamplingEnabled,s=this.options.textureUsageMask;return Promise.all(t.map((t=>{if(0==(t.usage&s))return null;const n=he(t.encodings,this.options.textureEncodings);if(null==n)return this.logger.error("#loadTextures",this.logLayer,`No known encoding for texture found on node ${e.id}`),Promise.reject();const a=e.resources.texture||e.id,o=`${this.layerUrl}/nodes/${a}/textures/${n.name}`;return this.loadTexture(o,t.id,t.usage,r,n.encoding,i)})))}loadFeatureData(e,t){const i=`${this.layerUrl}/nodes/${e}/features/0`;return this.load(i,"json",t)}loadGeometry(e,t,i){const r=`${this.layerUrl}/nodes/${e}/geometries/${t}`;return this.load(r,"binary",i)}}class ce{constructor(e,t){this.requester=e,this.apiKey=t,this.activeRequests=new Set}get busy(){return this.requester.busy}request(e,t,i){const r=(0,o.h)(),s=(0,o.P)(i,(()=>r.abort())),n={signal:r.signal,query:{token:this.apiKey}},a=this.requester.request(e,t,n),l={response:a,abortController:r,abortHandle:s};return this.activeRequests.add(l),(0,o.F)(a,(()=>{var e;l.abortController=null,null==(e=l.abortHandle)||e.remove(),l.abortHandle=null,this.activeRequests.delete(l)})),a}cancelAll(){this.activeRequests.forEach((e=>{var t,i;null==(t=e.abortController)||t.abort(),e.abortController=null,null==(i=e.abortHandle)||i.remove()})),this.activeRequests.clear()}}const de=1e5;class pe{constructor(e,t,i,r,s,n,a,o={}){this.indexSR=e,this._renderCoordsHelper=t,this.extent=s,this.elevationProvider=n,this.options=o,this._frustum=(0,y.K)(),this._useFrustumCulling=!1,this._poi=(0,m.n)(),this.minDistance=1/0,this.maxDistance=0,this.maxLodLevel=2,this._tmp1=(0,m.n)(),this._tmp2=(0,m.n)(),this._tmp3=(0,m.n)(),this._tmp0=(0,m.n)(),this.screenspaceErrorBias=o.screenspaceErrorBias||1,this.progressiveLoadFactor=o.progressiveLoadFactor||1,this.updateCamera(i,r),this.engineSR=this._renderCoordsHelper.spatialReference,this.updateElevationInfo(a),this.tmpPoint=(0,p.v)(0,0,0,e)}updateElevationInfo(e){null!=e?(this._elevationContext=y.L.fromElevationInfo(e),this._elevationContext.updateFeatureExpressionInfoContext((0,y.M)((0,y.i)(e,!1)))):this._elevationContext=null}updateCamera(e,t){this._useFrustumCulling=t,t&&(0,y.Q)(e.viewMatrix,e.projectionMatrix,this._frustum),this._screenSizeFactor=1/(e.perScreenPixelRatio/2),this._camPos=e.eye,this.minDistance=1/0,this.maxDistance=0}setPointOfInterest(e){this._poi=e}updateScreenSpaceErrorBias(e){const t=this.screenspaceErrorBias;return this.screenspaceErrorBias=e,t}updateExtent(e){this.extent=e}getRenderMbs(e){const t=e.renderMbs;return t[3]<0&&((0,S.a)(t,e.mbs),this._elevationContext&&t[3]<de&&(this.tmpPoint.x=t[0],this.tmpPoint.y=t[1],this.tmpPoint.z=t[2],t[2]=(0,y.V)(this.tmpPoint,this.elevationProvider,this._elevationContext,this._renderCoordsHelper)),(0,u.T)(t,this.indexSR,t,this.engineSR)),t}getVisibilityObb(e){if((0,n.r)(e.visibilityObb))return e.visibilityObb;const t=e.serviceObb;return(0,n.t)(t)||t.halfSize[0]<0?void 0:(e.serviceObbInRenderSR=this._computeRenderObb(t,e.serviceObbInRenderSR,e.mbs[3]),e.serviceObbInRenderSR)}_computeRenderObb(e,t,i){if((0,n.t)(t)&&(t=(0,y.D)()),t.halfSize[0]<0){let r=0;this._elevationContext&&i<de&&(this.tmpPoint.x=e.center[0],this.tmpPoint.y=e.center[1],this.tmpPoint.z=e.center[2],r=(0,y.V)(this.tmpPoint,this.elevationProvider,this._elevationContext,this._renderCoordsHelper)-e.center[2]),(0,_.F)(e,this.indexSR,t,this.engineSR,r)}return t}isNodeVisible(e){const t=this.getRenderMbs(e);if(!this.isMBSinExtent(t))return!1;if(!this._useFrustumCulling)return!0;const i=this.getVisibilityObb(e);return(0,n.r)(i)?(0,y.W)(i,this._frustum):(0,y.X)(this._frustum,(0,b.aX)(t))}isGeometryVisible(e){if(!this._useFrustumCulling)return!0;const t=e.geometryObb;return(0,n.r)(t)?(0,y.W)(t,this._frustum):this.isNodeVisible(e)}isMBSinExtent(e){return!this.extent||0!==(0,_.r)(this.extent,e)}screenSpaceDiameterMbs(e,t){const i=this.getRenderMbs(e),r=Math.sqrt((0,m.D)(i,this._camPos)),s=r-i[3];return this._updateMinMaxDistance(r),s<0?.5*Number.MAX_VALUE:t/s*this._screenSizeFactor}calcCameraDistance(e){return this.calcCameraDistanceToCenter(e)-this.getRenderMbs(e)[3]}calcCameraDistanceToCenter(e){const t=this.getRenderMbs(e),i=(0,m.q)(t,this._camPos);return this._updateMinMaxDistance(i),i}calcAngleDependentLoD(e){const t=this.getRenderMbs(e),i=t[3],r=(Math.abs(t[0]*(t[0]-this._camPos[0])+t[1]*(t[1]-this._camPos[1])+t[2]*(t[2]-this._camPos[2]))/(0,m.s)(t)+i)/(0,m.q)(t,this._camPos);return Math.min(1,r)}hasLOD(e){return 0!==e.lodMetric}getDistancePlanarMode(e,t){const i=e[0]-t[0],r=e[1]-t[1],s=e[2]-t[2],n=i*i+r*r,a=t[3];if(n<=a*a)return Math.abs(s);const o=Math.sqrt(n)-a;return Math.sqrt(s*s+o*o)}getDistanceGlobeMode(e,t){const i=(0,m.s)(t),r=(0,m.s)(e)-i;(0,m.d)(this._tmp0,e,(0,m.z)(e,t)/(0,m.m)(e));const s=(0,m.D)(t,this._tmp0),n=t[3];if(s<=n*n)return Math.abs(r);{const s=(0,m.d)(this._tmp0,t,1/i),a=i,o=n*n/2/a,l=(0,m.d)(this._tmp1,s,a-o),h=e,u=(0,m.c)(this._tmp2,h,l),c=(0,m.c)(this._tmp2,u,(0,m.d)(this._tmp3,s,(0,m.z)(s,u))),d=(0,m.u)(this._tmp2,l,(0,m.d)(this._tmp2,c,n/(0,m.s)(c)));let p=(0,m.q)(h,d);if(r>=2e5){const e=(0,m.c)(this._tmp1,h,d);let t=(0,m.z)(e,s)/(0,m.s)(e);t<.08&&(t=1e-4),p/=t}return p}}getDistance(e,t){return this.engineSR===(0,I.e)(this.engineSR)?this.getDistanceGlobeMode(e,t):this.getDistancePlanarMode(e,t)}_updateMinMaxDistance(e){e>0?(this.minDistance=Math.min(this.minDistance,e),this.maxDistance=Math.max(this.maxDistance,e)):(this.minDistance=0,this.maxDistance=Math.max(this.maxDistance,-e))}getLodLevel(e){if(0===e.lodMetric||!e.resources.hasFeatureData)return 0;if(0===e.childCount)return this.maxLodLevel;if(this._useFrustumCulling&&this.progressiveLoadFactor<1){const t=this.progressiveLoadFactor*this.screenspaceErrorBias,i=this.screenspaceErrorBias;return this.evaluateLODmetric(e,t)?this.evaluateLODmetric(e,i)?2:1:0}return this.evaluateLODmetric(e,this.screenspaceErrorBias)?this.maxLodLevel:0}evaluateLODmetric(e,t){switch(e.lodMetric){case 2:{const i=this.getRenderMbs(e),r=this.getDistance(this._camPos,i),s=2*r/this._screenSizeFactor,n=r+i[3];return this._updateMinMaxDistance(n),e.maxError*t<=s}case 1:{let i=this.screenSpaceDiameterMbs(e,e.mbs[3]*t);return this.options.angleDependentLoD&&(i*=this.calcAngleDependentLoD(e)),i<e.maxError}case 3:return this.screenSpaceDiameterMbs(e,e.maxError)*t<10;case 4:return this.calcCameraDistance(e)>e.maxError*t}return!1}distToPOI(e){const t=this.getRenderMbs(e);return(0,m.q)(t,this._poi)-t[3]}distCameraToPOI(){return(0,m.q)(this._camPos,this._poi)}}const fe=n.n.getLogger("esri.layers.graphics.controllers.I3SOnDemandController"),ye=1e-4;let me=class extends((0,a.d)(r.p)){constructor(e){super(e),this.screenSizeFactor=0,this.featureTarget=5e4,this.fixedFeatureTarget=!1,this.updating=!0,this.updatingProgress=1,this.leavesReached=!1,this.scaleVisibilityEnabled=!0,this._featureLOD=1,this._stableFeatureLOD=!1,this._isIdle=!1,this._cameraDirty=!0,this._invisibleDirty=!1,this._newLoadingNodes=new r.f({deallocator:null}),this._loadedNodeScales=new Map,this._modificationsNodeFilteringArray=new r.f,this._downloadingCount=0,this._loadingNodes=new Map,this._updatingNodes=new Map,this._progressMaxNumNodes=1,this._requiredAttributes=new Array,this._requiredAttributesDirty=!0,this._updatesDisabled=!1,this.disableIDBCache=!1,this._disableMemCache=!1,this._restartNodeLoading=!1,this._fields=null,this._attributeStorageInfo=null,this._handles=new s.u,this._idleQueue=new f.r,this._elevationUpdateNodes=new r.f({deallocator:null}),this._errorCount=0}get isMeshPyramid(){return"mesh-pyramids"===this.layer.profile||"MeshPyramid"===this.layer.store.lodType}get isGraphics3D(){return"points"===this.layer.profile}get indexStreamController(){const e=this.layerView.view.resourceController.createStreamDataRequester(2);return new ce(e,this.layer.apiKey)}get dataStreamController(){const e=this.layerView.view.resourceController.createStreamDataRequester(3);return new ce(e,this.layer.apiKey)}get crsVertex(){return(0,_.m)(this.layer)}get crsIndex(){return(0,_.p)(this.layer)}get rootNodeVisible(){if((0,n.r)(this._index)){const e=this._index.rootNode;if((0,n.r)(e))return this._updateViewData(),this._index.isNodeVisible(e.index)}return!0}initialize(){this._disableMemCache=!this.layerView.loadCachedGPUData||!this.layerView.addCachedGPUData,this._lodHandling=new J(this.layerView);const e=this.layerView.i3slayer;this.layer=e,this._defaultGeometrySchema=e.store.defaultGeometrySchema,this.disableIDBCache=(0,n.c)("disable-feature:idb-cache"),"fields"in e&&(this._fields=e.fields,this._attributeStorageInfo=e.attributeStorageInfo),this.addResolvingPromise(Promise.all([this.layer.indexInfo,this.layer.when(),this.layerView.when()]).then((([t])=>{var i;if(this.destroyed||!this.layerView||this.layerView.destroyed)return;const r=this.layerView.view;this._setClippingArea(r.clippingArea);const s=this.layerView.view.resourceController;this._handles.add([(0,l.d)(r,"pointsOfInterest.focus.renderLocation",(e=>this._pointOfInterestChanged(e))),s.memoryController.events.on("quality-changed",(()=>this._setCameraDirty())),(0,l.d)(this.layerView,"suspended",(e=>{const t=e?()=>this._updateViewData():()=>this._updateIdleState(!0),i=e?()=>{}:()=>this._updateIdleState(!1);this._idleStateCallbacks?(e&&this.cancelNodeLoading(),this.restartNodeLoading(),this._idleStateCallbacks.idleBegin=t,this._idleStateCallbacks.idleEnd=i):this._idleStateCallbacks=s.scheduler.registerIdleStateCallbacks(t,i)})),R(this.layerView.view.resourceController.scheduler,{update:(e,t)=>this._frame(e,t),needsUpdate:()=>this.updating}),this.watch("uncompressedTextureDownsamplingEnabled",(()=>this.restartNodeLoading())),this.watch(["featureTarget","fixedFeatureTarget"],(()=>{this._setCameraDirty(),this._stableFeatureLOD=!1})),r.state.watch("contentCamera",(()=>this._setCameraDirty())),this.layer.watch("elevationInfo",(()=>this._elevationInfoChanged())),this.layer.watch(["minScale","maxScale"],(()=>this._scaleBoundsChanged())),this.layerView.watch("lodFactor",(()=>this._setCameraDirty())),this.layerView.watch("availableFields?",(()=>this._requiredFieldsChange())),this.layerView.watch("holeFilling",(e=>(0,n.r)(this._index)&&(this._index.holeFilling=e)))]),this._updateScaleHandles(),this._viewportQueries=new pe(this.crsIndex,r.renderCoordsHelper,r.state.contentCamera,!r.state.fixedContentCamera||this.isGraphics3D,this._clippingArea,r.elevationProvider,this.layer.elevationInfo,{progressiveLoadFactor:this._getProgressiveLoadFactor(),screenspaceErrorBias:this.lod,angleDependentLoD:this.lod<.5}),this._index=new O(e,t,this.indexStreamController,this._viewportQueries,fe,this.layerView.holeFilling,(e=>this.layerView.isNodeLoaded(e)),(e=>this.layerView.isNodeReloading(e)),(e=>this._shouldLoadNode(e)),(e=>this._enableFromGPUCache(e,1)),(e=>this._needsUpdate(e)),(()=>!this.indexStreamController.busy),(e=>this.layerView.computeVisibilityObb?this.layerView.computeVisibilityObb(e):null),null!=(i=this.layerView)&&i.computeNodeFiltering?e=>this.layerView.computeNodeFiltering(e):void 0);const a=(0,n.r)(this.layer.modifications)&&this.layer.modifications&&this.layer.modifications.length>0;this._index.imModificationsChanged(a),this._startNodeLoading()}))),this._tmpPoint=(0,p.v)(0,0,0,this.crsIndex)}updateNodeModificationStatus(e){const t=this._index,i=this.layerView;(0,n.r)(t)&&i&&i.updateNodeModificationStatus&&(this._modificationsNodeFilteringArray.clear(),e.forAll((e=>{const i=t.getNode(e);(0,n.r)(i)&&this._modificationsNodeFilteringArray.push(i)})),i.updateNodeModificationStatus(this._modificationsNodeFilteringArray),this._invisibleDirty=!0)}destroy(){this.cancelNodeLoading(),this._idleStateCallbacks&&(this._isIdle=!1,this._idleStateCallbacks.remove(),this._idleStateCallbacks=null),this._handles.destroy(),this._nodeLoader=null,ge.prune(),(0,n.r)(_e)&&(_e.remove(),_e=null)}_getRequiredAttributes(){if(null==this._attributeStorageInfo||!this._fields||!this.layerView.availableFields)return[];const e=this._attributeStorageInfo,t=this._fields,i=this.layer.objectIdField;return this.layerView.availableFields.map((i=>{const r=ve(e,i),s=ve(t,i);return r>=0&&s>=0?{index:r,name:t[s].name,field:t[s],attributeStorageInfo:e[r]}:null})).filter((e=>null!=e&&e.name!==i))}_requiredFieldsChange(){const e=this._getRequiredAttributes();xe(this._requiredAttributes,e)||(this._requiredAttributes=e,this._requiredAttributesDirty=!1,this.restartNodeLoading())}requestUpdate(){this._requiredAttributesDirty=!0,this.restartNodeLoading()}_setClippingArea(e){const t=(0,c.a)();(0,y.I)(e,t,this.layerView.view.renderSpatialReference)?this._clippingArea=t:this._clippingArea=null}_pointOfInterestChanged(e){(0,n.r)(this._viewportQueries)&&(this._viewportQueries.setPointOfInterest(e),(0,n.r)(this._index)&&(this._index.progressiveLoadPenalty=be.distancePenalty*this._viewportQueries.distCameraToPOI(),this._index.requestUpdate()))}updateClippingArea(e){this._setClippingArea(e),(0,n.r)(this._viewportQueries)&&(0,n.r)(this._index)&&(this._viewportQueries.updateExtent(this._clippingArea),this._index.invalidateVisibilityCache()),this._setCameraDirty()}_setCameraDirty(){this._cameraDirty=!0,this.notifyChange("rootNodeVisible"),this._lodHandling.setLodGlobalDirty(),this._evaluateUpdating()}updateElevationChanged(e,t){const i=this._index;if((0,n.t)(i))return;const r=i.rootNode;if((0,n.t)(r))return;const s=this._elevationUpdateNodes;s.clear(),(0,_.N)(e,t,r,this.crsIndex,i,(e=>s.push(e.index))),s.forAll((e=>{i.invalidateBoundingVolumeCache(e),e===r.index&&this.notifyChange("rootNodeVisible")})),s.length&&this.restartNodeLoading()}getParentIndex(e){return(0,n.r)(this._index)&&this._index.getParentIndex(e)}_elevationInfoChanged(){(0,n.r)(this._index)&&this._index.updateElevationInfo(this.layer.elevationInfo),this._setCameraDirty()}_updateScaleHandles(){const e="scale-bounds";this._handles.remove(e),this.areScaleBoundsActive&&this._handles.add(this.layerView.view.basemapTerrain.on("scale-change",(e=>this._scaleUpdateHandler(e))),e)}_scaleBoundsChanged(){this.areScaleBoundsActive||this._loadedNodeScales.clear(),this._updateScaleHandles(),this._setCameraDirty()}_scaleUpdateHandler(e){this._updateScaleInBoundingRect(e.scale,e.extent,e.spatialReference),this._setCameraDirty()}_updateScaleInBoundingRect(e,t,i){const r=this._index;if((0,n.t)(r))return;const s=r.rootNode;!(0,n.t)(s)&&(0,u.C)(t,i,we,this.crsIndex)&&this._loadedNodeScales.forEach(((t,i)=>{const s=r.getNode(i);(0,n.r)(s)&&(0,d.g)(we,s.mbs)&&this._loadedNodeScales.set(i,e)}))}restartNodeLoading(){this._restartNodeLoading=!0,this.cancelNodeLoading(),this._evaluateUpdating()}schedule(e,t){return this._idleQueue.push(e,t)}reschedule(e,t){return this._idleQueue.unshift(e,t)}get isIntegratedMesh(){return"integrated-mesh"===this.layer.type}get areScaleBoundsActive(){const{minScale:e,maxScale:t}=(0,C.ae)(this.layer);return this.scaleVisibilityEnabled&&(e>0||t>0)}get unloadedMemoryEstimate(){return(0,n.t)(this._index)||this.layerView.suspended?0:this._index.getUnloadedMemoryEstimate()*this.lodDropFactor}get indexDepth(){return(0,n.r)(this._index)?this._index.maxLevel:0}set disableMemCache(e){this.layerView.loadCachedGPUData&&this.layerView.addCachedGPUData||(this._disableMemCache=!0),this._disableMemCache=e}_frame(e,t){return this.layerView.suspended?(this._updateViewData(),this._evaluateUpdating(),-1/0):!this.layerView.visible||(0,n.t)(this._index)?-1/0:(this._processLogError(e,t),this._index.getPriority())}_processLogError(e,t){try{this._process(e,t)}catch(e){this._errorCount<50?fe.error("Error during processing: "+e):50===this._errorCount&&fe.error("Too many errors for this layer. Further errors will not be displayed."),this._errorCount++}}_process(e,t){if(this._restartNodeLoading&&this._startNodeLoading(),null!=this._nodeLoader&&!(0,n.t)(this._index)){for(this._updateViewData(),this._invisibleDirty&&this._removeInvisibleNodes(e)&&(this._invisibleDirty=!1),this.isIntegratedMesh&&(e.enabled=!1),e.run((()=>this._processIndex(e))),this._updateFeatureLOD(),e.run((()=>this._processCache(e))),this.isIntegratedMesh&&(e.enabled=!0),e.run((()=>this._processNodes(e,t)));!e.done&&this._idleQueue.process();)e.madeProgress();e.run((()=>this._prefetchIndex())),t.numIndexLoading+=this._index.getIndexLoading(),t.numNodesLoading+=this._downloadingCount,e.run((()=>this._lodHandling.lodGlobalHandling(e))),this._evaluateUpdating()}}_processIndex(e){if((0,n.t)(this._index))return!1;if(this._index.dirty){this._newLoadingNodes.clear(),this._index.update([...this._loadingNodes.keys()],e,(e=>this.updateNodeModificationStatus(e))),this._disableMemCache||(this._newLoadingNodes.pushArray(this._index.updates.add.data,this._index.updates.add.length),this._newLoadingNodes.pushArray(this._index.updates.missing.data,this._index.updates.missing.length));const t=this._index.featureEstimate.leavesReached;this._index.isLoading()||t===this._get("leavesReached")||this._set("leavesReached",t)}return this._index.load()}_prefetchIndex(){return!((0,n.t)(this._index)||this._loadingNodes.size>0||this._index.updates.add.length>0)&&this._index.prefetch()}_updateFeatureLOD(){if(!this.isGraphics3D||(0,n.t)(this._index)||(0,n.t)(this._viewportQueries))return;const e=!this._index.isLoading(),t=this.featureTarget*this.baseLOD,i=this._index.featureEstimate;if(i.estimate=i.estimate||t/2,this._index.getIndexMissing()>500){if(this._featureLOD<=ye)return;this._featureLOD/=1.5,this._stableFeatureLOD=!1}else if(e&&i.estimate<t){if(i.leavesReached||this._featureLOD>=1e4||this._stableFeatureLOD)return;const e=Math.min(10,Math.max(t/i.estimate,1.001));this._featureLOD*=e;const r=this.lod,s=this._index.checkFeatureTarget(t,r);s!==r&&(this._featureLOD=s/this.baseLOD,this._stableFeatureLOD=!0)}else{if(!(i.estimate>1.2*t||e&&i.estimate>t))return;if(this._featureLOD<=ye)return;this._featureLOD/=1+.25*(i.estimate/t-1),this._stableFeatureLOD=!1}this._featureLOD=Math.min(1e4,Math.max(ye,this._featureLOD)),this._viewportQueries.updateScreenSpaceErrorBias(this.lod),this._index.requestUpdate()}_processCache(e){const t=this._index;if((0,n.t)(t))return!1;for(;this._newLoadingNodes.length>0&&!e.done;){const i=this._newLoadingNodes.pop();for(let r=t.getParent(i);(0,n.r)(r)&&!this.layerView.isNodeLoaded(r.index)&&this._isNodeInScaleBounds(r);r=t.getParent(r.index))if(this._enableFromGPUCache(r,0)){e.madeProgress();break}}return e.hasProgressed}_processNodes(e,t){if((0,n.t)(this._index))return!1;let i=(this._isIdle?100:2)-this._loadingNodes.size;const r=this._index.updates;for(r.cancel.forEach(this._cancelNode,this),r.cancel=[];r.remove.length>0&&!e.done;)this.layerView.removeNode(r.remove.pop()),e.madeProgress();for(;r.update.length>0&&!e.done;){const t=this._index.getNode(r.update.pop());(0,n.r)(t)&&(this._updateLoadedNode(t),e.madeProgress())}for(;r.add.length>0&&!e.done&&i>0;){--i;const s=this._index.getNode(r.add.back());if((0,n.t)(s)||2!==s.cacheState&&!this._hasNodeLoadToken(t))break;r.add.pop(),this._loadNode(s),e.madeProgress()}return e.hasProgressed}_cancelAllNodes(){this._loadingNodes.forEach((e=>e.abort())),this._loadingNodes.clear(),this._updatingNodes.forEach((e=>e.abort())),this._updatingNodes.clear()}_cancelNode(e){const t=this._loadingNodes.get(e);t&&(t.abort(),this._loadingNodes.delete(e))}_hasNodeLoadToken(e){return!(!this._isIdle&&e.numNodesLoading+this._loadingNodes.size>=2)&&this._downloadingCount<y.Y&&!this.dataStreamController.busy}_evaluateUpdating(){let e=!1,t=0;if(this.layerView.suspended)e=this._cameraDirty,t=e?0:1;else{const i=((0,n.r)(this._index)?this._index.getIndexMissing():0)+3*((0,n.r)(this._index)?this._index.updates.add.length:0)+2*this._loadingNodes.size;e=!!(i>0||this._updatingNodes.size>0||this._restartNodeLoading||this._cameraDirty||this._idleQueue.length>0||this._lodHandling&&this._lodHandling.requiresLODGlobalHandling),0===i&&(this._progressMaxNumNodes=1),this._progressMaxNumNodes=Math.max(i,this._progressMaxNumNodes),t=1-i/this._progressMaxNumNodes}this.updating=e,this.updatingProgress=t}_updateViewData(){if(!this._cameraDirty||(0,n.t)(this._index)||(0,n.t)(this._viewportQueries))return;const e=this.layerView.view,{contentCamera:t,fixedContentCamera:i}=e.state;this.screenSizeFactor=1/(t.perScreenPixelRatio/2),this._viewportQueries.updateCamera(t,!i||this.isGraphics3D),this._viewportQueries.setPointOfInterest(e.pointsOfInterest.focus.renderLocation),this._viewportQueries.updateScreenSpaceErrorBias(this.lod),this._index.invalidateVisibilityCache(),this._index.progressiveLoadPenalty=be.distancePenalty*this._viewportQueries.distCameraToPOI(),this._index.requestUpdate(),this._stableFeatureLOD=!1,this._invisibleDirty=!0,this._cameraDirty=!1,this.notifyChange("rootNodeVisible")}_getProgressiveLoadFactor(){return this.layerView.view.resourceController.memoryController.memoryFactor<1?1:this.layerView.progressiveLoadFactor}get lod(){return this._featureLOD*this.baseLOD}get baseLOD(){const e=this.layerView.lodFactor,t=this.layerView.view.resourceController.memoryController.memoryFactor;return this.fixedFeatureTarget?1:(e>0?e:1)*t}get lodDropFactor(){if(this.fixedFeatureTarget)return 1;const e=this.layerView.view.resourceController.memoryController;return(Math.min(e.memoryFactor,.5)-e.minQuality)/(.5-e.minQuality)}isGeometryVisible(e){return(0,n.r)(this._index)&&this._index.isGeometryVisible(e.index)}updateVisibility(e){(0,n.r)(this._index)&&this._index.invalidateNodeVisibilityCache(e)}updateBoundingVolume(e){(0,n.r)(this._index)&&this._index.invalidateBoundingVolumeCache(e)}invalidateGeometryVisibility(e){(0,n.r)(this._index)&&this._index.invalidateGeometryVisibility(e)}invalidateVisibilityObbs(){(0,n.r)(this._index)&&this._index.invalidateVisibilityObbs()}modificationsChanged(){if((0,n.r)(this._index)){const e=(0,n.r)(this.layer.modifications)&&this.layer.modifications&&this.layer.modifications.length>0;this._index.imModificationsChanged(e)}this._invisibleDirty=!0}_shouldLoadNode(e){return!(!this._lodHandling.shouldLoadNode(e)||this._shouldDropNode(e)||!this._isNodeInScaleBounds(e))&&!!(0,n.r)(this._index)&&this._index.isGeometryVisible(e.index)}_shouldDropNode(e){if((0,n.t)(this._viewportQueries))return!1;const t=this.lodDropFactor;return!(t>=1||!this._lodHandling.hasNoVisibleChildren(e))&&Math.abs(this._viewportQueries.calcCameraDistanceToCenter(e))-this._viewportQueries.minDistance>(this._viewportQueries.maxDistance-this._viewportQueries.minDistance)*t}_startNodeLoading(){this._restartNodeLoading=!1;const e=this._index;if(this._updatesDisabled||(0,n.t)(e)||(0,n.t)(this._viewportQueries))return;this._updateViewData(),this._requiredAttributesDirty&&(this._requiredAttributes=this._getRequiredAttributes(),this._requiredAttributesDirty=!1);const t={textureEncodings:this.layerView.supportedTextureEncodings,uncompressedTextureDownsamplingEnabled:this.layerView.uncompressedTextureDownsamplingEnabled,textureUsageMask:this.layerView.rendererTextureUsage,loadFeatureData:!this.isMeshPyramid};this._nodeLoader=new ue(this.layer,this.dataStreamController,fe,this._defaultGeometrySchema,this._requiredAttributes,t),e.requestUpdate(),this._lodHandling.startNodeLoading((e=>this._isNodeInScaleBounds(e)),((e,t)=>this._removeNodes(e,t,1)),e,{maxLodLevel:this._viewportQueries.maxLodLevel}),this._evaluateUpdating()}isNodeLoading(){return null!=this._nodeLoader&&null!=this._index}cancelNodeLoading(){this.isNodeLoading()&&(this.indexStreamController.cancelAll(),this.dataStreamController.cancelAll(),this._idleQueue.cancelAll(),this._cancelAllNodes(),this._nodeLoader=null,this._evaluateUpdating())}_removeInvisibleNodes(e){const t=this._index;if((0,n.t)(t)||(0,n.t)(this._viewportQueries))return!1;ge.clear(),this.layerView.getLoadedNodeIndices(ge);const i=0===this._viewportQueries.maxDistance,r=i?()=>!1:e=>this._shouldDropNode(e);return ge.filterInPlace((e=>{const i=t.getNode(e);return(0,n.t)(i)||!t.isGeometryVisible(e)||r(i)||!this._isNodeInScaleBounds(i)})),ge.length>0&&this._lodHandling.setLodGlobalDirty(),this._removeNodes(ge,e,0),!(i&&this.lodDropFactor<1||0!==ge.length&&(ge.clear(),1))}markNodeToRemove(e){ge.push(e)}removeMarkedNodes(){this._removeNodes(ge,y.N,0)}_removeNodes(e,t,i){const r=e.length;if(0!==r&&!t.done){for((0,n.r)(this._index)&&this._index.requestUpdate();e.length>0&&!t.done;){const r=e.pop(),s=this._index;1===i&&this.layerView.nodeFadeoutEnabled&&(0,n.r)(s)&&s.isGeometryVisible(r)?this.layerView.fadeNode(r,1,!0):this.layerView.removeNode(r),t.madeProgress()}if(this._loadedNodeScales.size>0)for(let t=e.length;t<r;t++){const i=e.data[t];this._loadedNodeScales.delete(i)}}}_needsUpdate(e){if(!e.resources.hasFeatureData||this._updatingNodes.has(e.index))return!1;const t=this.layerView.getLoadedAttributes(e.index);return null!=t&&t!==this._requiredAttributes}_updateLoadedNode(e){const t=(0,o.h)();this._updatingNodes.set(e.index,t),(xe(this.layerView.getLoadedAttributes(e.index),this._requiredAttributes)?Promise.resolve(this.layerView.getAttributeData(e.index)):this._nodeLoader.loadAttributes(e,this._requiredAttributes,t.signal)).then((i=>this.schedule((()=>this.layerView.updateAttributes(e.index,{loadedAttributes:this._requiredAttributes,attributeData:i},t.signal)),t.signal))).catch((i=>{if(!(0,o.g)(i))return this.layerView.updateAttributes(e.index,{loadedAttributes:this._requiredAttributes,attributeData:{}},t.signal)})).catch((()=>{})).then((()=>{this._updatingNodes.delete(e.index),this._evaluateUpdating()})),this._evaluateUpdating()}_loadNode(e){if(this._loadingNodes.has(e.index))return void fe.error("already loading node "+e.index);const t=(0,o.h)();this._loadingNodes.set(e.index,t);const i=()=>{this._loadingNodes.get(e.index)===t&&this._loadingNodes.delete(e.index),this._evaluateUpdating()};this._evaluateUpdating(),this._loadAndAddNode(e,t.signal).then(i).catch((e=>{if(i(),!(0,o.g)(e))throw e}))}_loadAndAddNode(e,t){return 1===e.cacheState?this._loadUncached(e,t):this._loadCached(e,t).then((t=>{t||(e.cacheState=1,(0,n.r)(this._index)&&this._index.updates.add.push(e.index))})).catch((t=>{if(!(0,o.g)(t))throw e.cacheState=1,t}))}_enableFromGPUCache(e,t){if(this._disableMemCache||(0,n.t)(this._index))return!1;if(0===t&&!this._index.useNodeAsHole(e.index))return!0;const i=this._loadCachedGPUData(e);return!!i&&(this.layerView.addCachedGPUData(e,i,t),this._nodeAdded(),!0)}_loadCachedGPUData(e){const t=this.layerView.loadCachedGPUData(e);return(0,n.r)(t)&&(0,n.r)(t.attributeInfo)&&xe(t.attributeInfo.loadedAttributes,this._requiredAttributes)?t:(this.layerView.deleteCachedGPUData(t),null)}_nodeAdded(){(0,n.r)(this._index)&&this._index.requestUpdate(),this._lodHandling.setLodGlobalDirty(),this._evaluateUpdating()}_loadCached(e,t){if(this._enableFromGPUCache(e,1))return Promise.resolve(!0);const i=this.layerView;return!this.disableIDBCache&&i.loadCachedNodeData&&i.addCachedNodeData?this.schedule((()=>i.loadCachedNodeData(e,t,((t,i)=>this._nodeLoader.loadTextures(e,t,i)))),t).then((r=>{if((0,n.t)(r))return!1;const s=this._requiredAttributes;return this.reschedule((()=>this._nodeLoader.loadAttributes(e,s,t)),t).then((n=>this.reschedule((()=>i.addCachedNodeData(e,r,{loadedAttributes:s,attributeData:n},t)),t))).then((()=>(this._nodeAdded(),!0)))})):Promise.resolve(!1)}_loadUncached(e,t){return this._downloadingCount++,this._nodeLoader.loadNodeData(e,t).catch((e=>{throw this._downloadingCount--,e})).then((i=>(this._downloadingCount--,this.schedule((()=>this.layerView.addNode(e,i,t)),t)))).then((()=>{this._nodeAdded(),e.cacheState=2})).catch((t=>{if(!(0,o.g)(t))throw fe.error("#loadNodeData()",this.layer,`Failed to load node '${e.id}'`,t),e.failed=!0,(0,n.r)(this._index)&&this._index.requestUpdate(),t}))}_updateIdleState(e){e!==this._isIdle&&(this._isIdle=e,this._evaluateUpdating(),e&&this._index&&(0,n.r)(this._index)&&this._index.resetFailedNodes())}_getScale(e){if(this._loadedNodeScales.has(e.index))return this._loadedNodeScales.get(e.index);this._tmpPoint.x=e.mbs[0],this._tmpPoint.y=e.mbs[1],this._tmpPoint.z=e.mbs[2];const t=this.layerView.view.basemapTerrain.getScale(this._tmpPoint);return this.layerView.isNodeLoaded(e.index)&&this._loadedNodeScales.set(e.index,t),t}_isNodeInScaleBounds(e){if(!this.areScaleBoundsActive)return!0;const t=this._getScale(e),{minScale:i,maxScale:r}=(0,C.ae)(this.layer);return(0,C.ad)(t,i,r)}updateStats(e){e.index=(0,n.r)(this._index)?this._index.size:0,this.isGraphics3D&&(e.detail=this._featureLOD,e.target=this.featureTarget*this.baseLOD),(0,n.r)(this._index)&&this._index.updateStats(e)}get test(){const e=this;return{index:this._index,set disableUpdates(t){e._updatesDisabled=t,t?e.cancelNodeLoading():e.requestUpdate()},set disableIDBCache(t){e.disableIDBCache=t},set ignoreServiceObb(t){(0,n.r)(e._index)&&(e._index.ignoreServiceObb=t)},shouldLoadNode:t=>e._shouldLoadNode(t)}}notifyLODUpdate(){this._lodHandling.setLodGlobalDirty(),this._evaluateUpdating(),(0,n.r)(this._index)&&this._index.requestUpdate()}geometryFilterChanged(e){const t=this._index;(0,n.r)(t)&&t.layerFilterChanged(e),this.requestUpdate()}};(0,r.e)([(0,h.y)({readOnly:!0})],me.prototype,"isMeshPyramid",null),(0,r.e)([(0,h.y)({readOnly:!0})],me.prototype,"isGraphics3D",null),(0,r.e)([(0,h.y)({readOnly:!0})],me.prototype,"indexStreamController",null),(0,r.e)([(0,h.y)({readOnly:!0})],me.prototype,"dataStreamController",null),(0,r.e)([(0,h.y)({readOnly:!0})],me.prototype,"crsVertex",null),(0,r.e)([(0,h.y)({readOnly:!0})],me.prototype,"crsIndex",null),(0,r.e)([(0,h.y)()],me.prototype,"screenSizeFactor",void 0),(0,r.e)([(0,h.y)()],me.prototype,"featureTarget",void 0),(0,r.e)([(0,h.y)()],me.prototype,"fixedFeatureTarget",void 0),(0,r.e)([(0,h.y)()],me.prototype,"layerView",void 0),(0,r.e)([(0,h.y)()],me.prototype,"layer",void 0),(0,r.e)([(0,h.y)({})],me.prototype,"updating",void 0),(0,r.e)([(0,h.y)({})],me.prototype,"updatingProgress",void 0),(0,r.e)([(0,h.y)({readOnly:!0})],me.prototype,"leavesReached",void 0),(0,r.e)([(0,h.y)({constructOnly:!0})],me.prototype,"scaleVisibilityEnabled",void 0),(0,r.e)([(0,h.y)({readOnly:!0,dependsOn:[]})],me.prototype,"rootNodeVisible",null),me=(0,r.e)([(0,h.n)("esri.layers.graphics.controllers.I3SOnDemandController")],me);const ge=new r.f({deallocator:null});let _e;function xe(e,t){return(0,n.r)(e)&&e.length===t.length&&e.every((e=>ve(t,e.name)>=0))}function ve(e,t){const i=t.toLowerCase();for(let t=0;t<e.length;t++)if(e[t].name.toLowerCase()===i)return t;return-1}const be={factorIM:.2,factor3dObject:.05,distancePenalty:10},we=(0,d.i)();var Se=me;class Ie extends a.n{constructor(){super(...arguments),this._map=new Map}clear(){if(this._map.size>0){const e=this.toArray();this._map.clear(),this.emit("change",{added:[],removed:e})}}get length(){return this._map.size}get(e){return this._map.get(e)}addMany(e){if(0===e.length)return;const t=new Set;for(let i=0;i<e.length;i++){const r=e[i],s=r.objectId,n=this._map.get(s);n?(t.add(s),r!==n&&(e[i]=n),++n.refCount):(r.refCount=1,this._map.set(s,r))}const i=t.size>0?e.filter((e=>!t.has(e.objectId))):e;i.length>0&&this.emit("change",{added:i,removed:[]})}removeMany(e){const t=[];for(const i of e){const e=i.objectId,r=this._map.get(e);null!=r&&--r.refCount<=0&&(this._map.delete(e),t.push(i))}t.length>0&&this.emit("change",{added:[],removed:t})}removeManyByObjectId(e){const t=[];for(const i of e){const e=this._map.get(i);null!=e&&--e.refCount<=0&&(this._map.delete(i),t.push(e))}t.length>0&&this.emit("change",{added:[],removed:t})}toArray(){return[...this._map.values()]}find(e){let t;return(0,C.g)(this._map,(i=>!!e(i)&&(t=i,!0))),t}forEach(e){this._map.forEach((t=>e(t)))}}async function Ce(e,t,i){t=t.clone(),e.capabilities.query.supportsMaxRecordCountFactor&&(t.maxRecordCountFactor=Te(e));const r=Me(e),s=e.capabilities.query.supportsPagination;t.start=0,t.num=r;let a=null;for(;;){const o=await e.source.queryFeaturesJSON(t,i);if((0,n.t)(a)?a=o:a.features=a.features.concat(o.features),a.exceededTransferLimit=o.exceededTransferLimit,!s||!o.exceededTransferLimit)break;t.start+=r}return a}function Me(e){return Te(e)*function(e){return e.capabilities.query.maxRecordCount||2e3}(e)}function Te(e){return e.capabilities.query.supportsMaxRecordCountFactor?E.b.MAX_MAX_RECORD_COUNT_FACTOR:1}const Ee=n.n.getLogger("esri.views.3d.layers.i3s.I3SAttributeOverrides");class Fe{constructor(e,t){this.layer=e,this.warnMaximumChangedObjectsExceeded=!1,this.changedObjectIds=new Set,this.pendingFetchAbortController=(0,o.h)(),this.interactiveEditingSessions=null,this._maximumNumberOfEditOVerrides=Pe,this.memCache=t.getMemCache(`${e.uid}-attribute-overrides`),this.pendingFetchChangedObjectIds=this.fetchChangedObjectIds(this.pendingFetchAbortController.signal),this.pendingFetchChangedObjectIds.then((()=>this.pendingFetchAbortController=null))}destroy(){this.layer=null,this.memCache.destroy(),this.memCache=null,this.pendingFetchAbortController&&(this.pendingFetchAbortController.abort(),this.pendingFetchAbortController=null),this.pendingFetchChangedObjectIds=null}createInteractiveEditSession(e){this.changedObjectIds.add(e),(0,n.t)(this.interactiveEditingSessions)&&(this.interactiveEditingSessions=[]);const t=this.interactiveEditingSessions,i=new Ae(e,{rollback:()=>{(0,r.C)(t,i),0===t.length&&(this.interactiveEditingSessions=null)},commit:t=>{for(const[i,r]of t)this.updateValue(e,i,r)}});return t.unshift(i),i}async apply(e,t,i){if((0,n.t)(t))return;const{loadedAttributes:r,attributeData:s}=t;if((0,n.t)(r)||0===r.length||(0,n.t)(s))return;if(await(0,o.d)(this.pendingFetchChangedObjectIds,i),0===this.changedObjectIds.size)return;const a={loadedAttributes:r,attributeData:s},l=this.getOverridesFromCache(e,a,this.changedObjectIds),{objectIds:h,fieldNames:u}=l,c=await this.queryOverridesFromAssociatedLayer(h,u,i);(0,n.t)(c)||this.processOverridesFromAssociatedLayer(e,c,u,a)}updateValue(e,t,i){this.changedObjectIds.add(e),this.cacheValue(e,t,i)}cacheValue(e,t,i){this.memCache.put(this.getCacheKey(e,t),i,this.memCacheValueSize(i))}getOverridesFromCache(e,{loadedAttributes:t,attributeData:i},r){const s=new Set,n=new Array;for(const e of t)n[e.index]=i[e.name];const a=new Set;for(let i=0;i<e.length;i++){const o=e[i];if(r.has(o))for(const e of t){const t=this.fromCache(o,e.index);void 0===t?(s.add(o),a.add(e.name)):n[e.index][i]=t}}return{objectIds:Array.from(s),fieldNames:Array.from(a)}}fromCache(e,t){const i=this.fromInteractiveEditingSession(e,t);if(void 0!==i)return i;const r=this.getCacheKey(e,t);return this.memCache.get(r)}fromInteractiveEditingSession(e,t){if(!(0,n.t)(this.interactiveEditingSessions))for(const i of this.interactiveEditingSessions){if(i.objectId!==e)continue;const r=i.get(t);if(void 0!==r)return r}}getCacheKey(e,t){return`${e}-${t}`}async queryOverridesFromAssociatedLayer(e,t,i){if(0===e.length||0===t.length)return null;e=e.sort(((e,t)=>e-t)),this.warnMaximumChangedObjectsExceeded&&(this.warnMaximumChangedObjectsExceeded=!1,this.logMaximumObjectsExceededWarning());const s=(0,n.f)(this.layer.associatedLayer),a=s.createQuery();a.where="1=1",a.returnGeometry=!1,a.outFields=[s.objectIdField,...t],a.cacheHint=!0,a.objectIds=e;const o=Me(s),l=e.length>o?(0,r.X)(e,o).map((e=>{const t=a.clone();return t.objectIds=e,(0,x.p)(Ce(s,t,{signal:i}))})):[(0,x.p)(Ce(s,a,{signal:i}))];return(await Promise.all(l)).reduce(((e,t)=>e.concat(t.ok?t.value.features:[])),[])}logMaximumObjectsExceededWarning(){let e=`The number of edited objects that are not yet cached in the scene service exceeds the maximum limit. Attribute changes will only be available for the first ${(0,T.m)(this._maximumNumberOfEditOVerrides)} objects. Please consider re-caching the scene service`;const t=this.layer.portalItem;t&&t.loaded?e+=` (${t.portal.url}/home/item.html?id=${t.id}#settings)`:e+=` (${this.layer.parsedUrl.path})`,Ee.warn("#queryOverrides()",this.layer.title,`${e}.`)}processOverridesFromAssociatedLayer(e,t,i,{loadedAttributes:r,attributeData:s}){const a=(0,n.f)(this.layer.associatedLayer).objectIdField,o=i.map((e=>s[e])),l=new Map(r.map((e=>[e.name,e.index]))),h=i.map((e=>l.get(e))),u=new Map(Array.from(e,((e,t)=>[e,t])));for(const e of t){const t=e.attributes[a];for(let r=0;r<i.length;r++){const s=h[r],n=u.get(t),a=e.attributes[i[r]];o[r][n]=a,this.cacheValue(t,s,a)}}}memCacheValueSize(e){return"string"==typeof e?(0,M.n)(e):(0,M.t)()}async fetchChangedObjectIds(e){var t,i,r;const s=this.layer;if(await s.load({signal:e}),this.changedObjectIds.clear(),(0,n.t)(s.associatedLayer)||null==(t=s.associatedLayer.capabilities)||null==(i=t.operations)||!i.supportsChangeTracking)return;const o=this.getFetchChangedObjectIdsServerGen();if((0,n.t)(o))return null;const l=s.associatedLayer.layerId,h=await(0,x.a)((0,a.L)(`${s.associatedLayer.url}/extractChanges`,{method:"post",query:{f:"json",returnIdsOnly:!0,layers:`${l}`,returnUpdates:!0,returnDeletes:!1,returnInserts:!1,layerServerGens:JSON.stringify([{id:l,serverGen:o}])},timeout:Re,signal:e})),u=h.ok&&null!=(r=h.value.data)&&r.edits?(0,n.g)(h.value.data.edits[0],"objectIds","updates"):null;if((0,n.r)(u)){const e=Math.min(this._maximumNumberOfEditOVerrides,u.length);e<u.length&&(this.warnMaximumChangedObjectsExceeded=!0);const t=u.sort(((e,t)=>e-t));for(let i=0;i<e;i++)this.changedObjectIds.add(t[i])}}getFetchChangedObjectIdsServerGen(){const e=this.layer;if((0,n.r)(e.serviceUpdateTimeStamp)&&(0,n.r)(e.serviceUpdateTimeStamp.lastUpdate))return e.serviceUpdateTimeStamp.lastUpdate;const t=e.associatedLayer;return(0,n.r)(t)&&(0,n.r)(t.serverGens)&&(0,n.r)(t.serverGens.minServerGen)?t.serverGens.minServerGen:null}get test(){const e=Array.from(this.changedObjectIds),t=this.pendingFetchChangedObjectIds,i=this;return{changedObjectIds:e,pendingFetchChangedObjectIds:t,get maximumNumberOfEditOVerrides(){return i._maximumNumberOfEditOVerrides},set maximumNumberOfEditOVerrides(e){i._maximumNumberOfEditOVerrides=e}}}}class Ae{constructor(e,t){this.objectId=e,this.options=t,this.updates=new Map,this.state=0}get(e){return this.updates.get(e)}set(e,t){this.isActive&&this.updates.set(e,t)}rollback(){this.isActive&&(this.state=2,this.options.rollback())}commit(){this.isActive&&(this.state=1,this.options.commit(this.updates),this.updates.clear())}get isActive(){return 0===this.state}}const Re=1e4,Pe=5e4},14754:(e,t,i)=>{"use strict";i.d(t,{C:()=>S,a:()=>l,c:()=>g,g:()=>b,y:()=>v}),i(33807);var r=i(20215),s=i(80219);const n=!0;function a(e,t,i){return{identifier:String.fromCharCode.apply(null,new Uint8Array(e,i+0,10)),version:t.getUint16(i+10,n),checksum:t.getUint32(i+12,n)}}function o(e,t){return{sizeLo:e.getUint32(t+0,n),sizeHi:e.getUint32(t+4,n),minX:e.getFloat64(t+8,n),minY:e.getFloat64(t+16,n),minZ:e.getFloat64(t+24,n),maxX:e.getFloat64(t+32,n),maxY:e.getFloat64(t+40,n),maxZ:e.getFloat64(t+48,n),errorX:e.getFloat64(t+56,n),errorY:e.getFloat64(t+64,n),errorZ:e.getFloat64(t+72,n),count:e.getUint32(t+80,n),reserved:e.getUint32(t+84,n)}}function l(e){const t=new DataView(e,0);let i=0;const{identifier:s,version:n}=a(e,t,i);if(i+=16,"LEPCC     "!==s)throw new r.s("lepcc-decode-error","Bad identifier");if(n>1)throw new r.s("lepcc-decode-error","Unknown version");const l=o(t,i);if(i+=88,l.sizeHi*2**32+l.sizeLo!==e.byteLength)throw new r.s("lepcc-decode-error","Bad size");const u=new Float64Array(3*l.count),c=[],d=[],p=[],f=[];if(i=h(e,i,c),i=h(e,i,d),i=h(e,i,p),i=h(e,i,f),i!==e.byteLength)throw new r.s("lepcc-decode-error","Bad length");let y=0,m=0;for(let e=0;e<c.length;e++){m+=c[e];let t=0;for(let i=0;i<d[e];i++){t+=p[y];const e=f[y];u[3*y]=Math.min(l.maxX,l.minX+2*l.errorX*t),u[3*y+1]=Math.min(l.maxY,l.minY+2*l.errorY*m),u[3*y+2]=Math.min(l.maxZ,l.minZ+2*l.errorZ*e),y++}}return{errorX:l.errorX,errorY:l.errorY,errorZ:l.errorZ,result:u}}function h(e,t,i){const r=[];t=u(e,t,r);const s=[];for(let n=0;n<r.length;n++){s.length=0,t=u(e,t,s);for(let e=0;e<s.length;e++)i.push(s[e]+r[n])}return t}function u(e,t,i){const s=new DataView(e,t),a=s.getUint8(0),o=31&a,l=!!(32&a),h=(192&a)>>6;let u=0;if(0===h)u=s.getUint32(1,n),t+=5;else if(1===h)u=s.getUint16(1,n),t+=3;else{if(2!==h)throw new r.s("lepcc-decode-error","Bad count type");u=s.getUint8(1),t+=2}if(l)throw new r.s("lepcc-decode-error","LUT not implemented");const c=Math.ceil(u*o/8),d=new Uint8Array(e,t,c);let p=0,f=0,y=0;const m=-1>>>32-o;for(let e=0;e<u;e++){for(;f<o;)p|=d[y]<<f,f+=8,y+=1;i[e]=p&m,p>>>=o,f-=o,f+o>32&&(p|=d[y-1]>>8-f)}return t+y}function c(e,t){return{sizeLo:e.getUint32(t+0,n),sizeHi:e.getUint32(t+4,n),count:e.getUint32(t+8,n),colorMapCount:e.getUint16(t+12,n),lookupMethod:e.getUint8(t+14),compressionMethod:e.getUint8(t+15)}}function d(e,t){return{sizeLo:e.getUint32(t+0,n),sizeHi:e.getUint32(t+4,n),count:e.getUint32(t+8,n),scaleFactor:e.getUint16(t+12,n),bitsPerPoint:e.getUint8(t+14),reserved:e.getUint8(t+15)}}const p=s.n.getLogger("esri.views.3d.layers.i3s.I3SBinaryReader");function f(e,t,i){let s="",n=0;for(;n<i;){const a=e[t+n];if(a<128)s+=String.fromCharCode(a),n++;else if(a>=192&&a<224){if(n+1>=i)throw new r.s("utf8-decode-error","UTF-8 Decode failed. Two byte character was truncated.");const o=(31&a)<<6|63&e[t+n+1];s+=String.fromCharCode(o),n+=2}else if(a>=224&&a<240){if(n+2>=i)throw new r.s("utf8-decode-error","UTF-8 Decode failed. Multi byte character was truncated.");const o=(15&a)<<12|(63&e[t+n+1])<<6|63&e[t+n+2];s+=String.fromCharCode(o),n+=3}else{if(!(a>=240&&a<248))throw new r.s("utf8-decode-error","UTF-8 Decode failed. Invalid multi byte sequence.");{if(n+3>=i)throw new r.s("utf8-decode-error","UTF-8 Decode failed. Multi byte character was truncated.");const o=(7&a)<<18|(63&e[t+n+1])<<12|(63&e[t+n+2])<<6|63&e[t+n+3];if(o>=65536){const e=55296+(o-65536>>10),t=56320+(1023&o);s+=String.fromCharCode(e,t)}else s+=String.fromCharCode(o);n+=4}}}return s}function y(e,t){const i={byteOffset:0,byteCount:0,fields:Object.create(null)};let r=0;for(let s=0;s<t.length;s++){const n=t[s],a=n.valueType||n.type,o=C[a];i.fields[n.property]=o(e,r),r+=I[a].BYTES_PER_ELEMENT}return i.byteCount=r,i}function m(e,t,i){const s=[];let n,a,o=0;for(a=0;a<e;a+=1){if(n=t[a],n>0){if(s.push(f(i,o,n-1)),0!==i[o+n-1])throw new r.s("string-array-error","Invalid string array: missing null termination.")}else s.push(null);o+=n}return s}function g(e,t){return new I[t.valueType](e,t.byteOffset,t.count*t.valuesPerElement)}function _(e,t,i){const n=null!=t.header?y(e,t.header):{byteOffset:0,byteCount:0,fields:{count:i}},a={header:n,byteOffset:n.byteCount,byteCount:0,entries:Object.create(null)};let o=n.byteCount;for(let e=0;e<t.ordering.length;e++){const i=t.ordering[e],l=(0,s.y)(t[i]);if(l.count=n.fields.count,"String"===l.valueType){if(l.byteOffset=o,l.byteCount=n.fields[i+"ByteCount"],"UTF-8"!==l.encoding)throw new r.s("unsupported-encoding","Unsupported String encoding.",{encoding:l.encoding})}else{if(!M(l.valueType))throw new r.s("unsupported-value-type","Unsupported binary valueType",{valueType:l.valueType});{const e=T(l.valueType);o+=o%e!=0?e-o%e:0,l.byteOffset=o,l.byteCount=e*l.valuesPerElement*l.count}}o+=l.byteCount,a.entries[i]=l}return a.byteCount=o-a.byteOffset,a}function x(e,t,i){if(t!==e&&p.error(`Invalid ${i} buffer size\n expected: ${e}, actual: ${t})`),t<e)throw new r.s("buffer-too-small","Binary buffer is too small",{expectedSize:e,actualSize:t})}function v(e,t){const i=y(e,t&&t.header);let r=i.byteCount;const s={isDraco:!1,header:i,byteOffset:i.byteCount,byteCount:0,vertexAttributes:{}},n=i.fields,a=null!=n.vertexCount?n.vertexCount:n.count;for(const e of t.ordering){if(!t.vertexAttributes[e])continue;const i={...t.vertexAttributes[e],byteOffset:r,count:a},n=w[e]?w[e]:"_"+e;s.vertexAttributes[n]=i,r+=T(i.valueType)*i.valuesPerElement*a}const o=n.faceCount;if(t.faces&&o){s.faces={};for(const e of t.ordering){if(!t.faces[e])continue;const i={...t.faces[e],byteOffset:r,count:o};s.faces[e]=i,r+=T(i.valueType)*i.valuesPerElement*o}}const l=n.featureCount;if(t.featureAttributes&&t.featureAttributeOrder&&l){s.featureAttributes={};for(const e of t.featureAttributeOrder){if(!t.featureAttributes[e])continue;const i={...t.featureAttributes[e],byteOffset:r,count:l};s.featureAttributes[e]=i,r+=("UInt64"===i.valueType?8:T(i.valueType))*i.valuesPerElement*l}}return x(r,e.byteLength,"geometry"),s.byteCount=r-s.byteOffset,s}function b(e,t){return e&&e.compressedAttributes&&"draco"===e.compressedAttributes.encoding?function(e){const t={isDraco:!0,isLegacy:!1,color:!1,normal:!1,uv0:!1,uvRegion:!1,featureIndex:!1};for(const i of e)switch(i){case"position":break;case"normal":t.normal=!0;break;case"uv0":t.uv0=!0;break;case"color":t.color=!0;break;case"uv-region":t.uvRegion=!0;break;case"feature-index":t.featureIndex=!0}return t}(e.compressedAttributes.attributes):e?function(e){return{isDraco:!1,isLegacy:!1,color:null!=e.color,normal:null!=e.normal,uv0:null!=e.uv0,uvRegion:null!=e.uvRegion,featureIndex:null!=e.faceRange&&null!=e.featureId}}(e):function(e){const t={isDraco:!1,isLegacy:!0,color:!1,normal:!1,uv0:!1,uvRegion:!1,featureIndex:!1};for(const i of e.ordering)if(e.vertexAttributes[i])switch(i){case"position":break;case"normal":t.normal=!0;break;case"color":t.color=!0;break;case"uv0":t.uv0=!0;break;case"region":t.uvRegion=!0}return e.featureAttributes&&e.featureAttributeOrder&&(t.featureIndex=!0),t}(t)}const w={position:"position",normal:"normal",color:"color",uv0:"uv0",region:"uvRegion"};function S(e,t,i){if("lepcc-rgb"===e.encoding)return function(e){const t=new DataView(e,0);let i=0;const{identifier:s,version:n}=a(e,t,i);if(i+=16,"ClusterRGB"!==s)throw new r.s("lepcc-decode-error","Bad identifier");if(n>1)throw new r.s("lepcc-decode-error","Unknown version");const o=c(t,i);if(i+=16,o.sizeHi*2**32+o.sizeLo!==e.byteLength)throw new r.s("lepcc-decode-error","Bad size");if((2===o.lookupMethod||1===o.lookupMethod)&&0===o.compressionMethod){if(3*o.colorMapCount+o.count+i!==e.byteLength||o.colorMapCount>256)throw new r.s("lepcc-decode-error","Bad count");const t=new Uint8Array(e,i,3*o.colorMapCount),s=new Uint8Array(e,i+3*o.colorMapCount,o.count),n=new Uint8Array(3*o.count);for(let e=0;e<o.count;e++){const i=s[e];n[3*e]=t[3*i],n[3*e+1]=t[3*i+1],n[3*e+2]=t[3*i+2]}return n}if(0===o.lookupMethod&&0===o.compressionMethod){if(3*o.count+i!==e.byteLength||0!==o.colorMapCount)throw new r.s("lepcc-decode-error","Bad count");return new Uint8Array(e,i).slice()}if(o.lookupMethod<=2&&1===o.compressionMethod){if(i+3!==e.byteLength||1!==o.colorMapCount)throw new r.s("lepcc-decode-error","Bad count");const s=t.getUint8(i),n=t.getUint8(i+1),a=t.getUint8(i+2),l=new Uint8Array(3*o.count);for(let e=0;e<o.count;e++)l[3*e]=s,l[3*e+1]=n,l[3*e+2]=a;return l}throw new r.s("lepcc-decode-error","Bad method "+o.lookupMethod+","+o.compressionMethod)}(t);if("lepcc-intensity"===e.encoding)return function(e){const t=new DataView(e,0);let i=0;const{identifier:s,version:n}=a(e,t,i);if(i+=16,"Intensity "!==s)throw new r.s("lepcc-decode-error","Bad identifier");if(n>1)throw new r.s("lepcc-decode-error","Unknown version");const o=d(t,i);if(i+=16,o.sizeHi*2**32+o.sizeLo!==e.byteLength)throw new r.s("lepcc-decode-error","Bad size");const l=new Uint16Array(o.count);if(8===o.bitsPerPoint){if(o.count+i!==e.byteLength)throw new r.s("lepcc-decode-error","Bad size");const t=new Uint8Array(e,i,o.count);for(let e=0;e<o.count;e++)l[e]=t[e]*o.scaleFactor}else if(16===o.bitsPerPoint){if(2*o.count+i!==e.byteLength)throw new r.s("lepcc-decode-error","Bad size");const t=new Uint16Array(e,i,o.count);for(let e=0;e<o.count;e++)l[e]=t[e]*o.scaleFactor}else{const t=[];if(u(e,i,t)!==e.byteLength)throw new r.s("lepcc-decode-error","Bad size");for(let e=0;e<o.count;e++)l[e]=t[e]*o.scaleFactor}return l}(t);if(null!=e.encoding&&""!==e.encoding)throw new r.s("unknown-attribute-storage-info-encoding","Unknown Attribute Storage Info Encoding");e["attributeByteCounts "]&&!e.attributeByteCounts&&(p.warn("Warning: Trailing space in 'attributeByteCounts '."),e.attributeByteCounts=e["attributeByteCounts "]),"ObjectIds"===e.ordering[0]&&e.hasOwnProperty("objectIds")&&(p.warn("Warning: Case error in objectIds"),e.ordering[0]="objectIds");const s=_(t,e,i);x(s.byteOffset+s.byteCount,t.byteLength,"attribute");const n=s.entries.attributeValues||s.entries.objectIds;if(n){if("String"===n.valueType){const e=s.entries.attributeByteCounts,i=g(t,e),r=function(e,t){return new Uint8Array(e,t.byteOffset,t.byteCount)}(t,n);return m(e.count,i,r)}return g(t,n)}throw new r.s("bad-attribute-storage-info","Bad attributeStorageInfo specification.")}const I={Float32:Float32Array,Float64:Float64Array,UInt8:Uint8Array,Int8:Int8Array,UInt16:Uint16Array,Int16:Int16Array,UInt32:Uint32Array,Int32:Int32Array},C={Float32:(e,t)=>new DataView(e,0).getFloat32(t,!0),Float64:(e,t)=>new DataView(e,0).getFloat64(t,!0),UInt8:(e,t)=>new DataView(e,0).getUint8(t),Int8:(e,t)=>new DataView(e,0).getInt8(t),UInt16:(e,t)=>new DataView(e,0).getUint16(t,!0),Int16:(e,t)=>new DataView(e,0).getInt16(t,!0),UInt32:(e,t)=>new DataView(e,0).getUint32(t,!0),Int32:(e,t)=>new DataView(e,0).getInt32(t,!0)};function M(e){return I.hasOwnProperty(e)}function T(e){return M(e)?I[e].BYTES_PER_ELEMENT:0}},71409:(e,t,i)=>{"use strict";i.d(t,{n:()=>a});var r=i(80987),s=i(20215),n=i(80219);async function a(e,t,i,a,o,l){let h=null;if((0,n.r)(i)){const t=`${e}/nodepages/`,s=t+Math.floor(i.rootIndex/i.nodesPerPage);try{return{type:"page",rootPage:(await(0,r.L)(s,{query:{f:"json",token:a},responseType:"json",signal:l})).data,rootIndex:i.rootIndex,pageSize:i.nodesPerPage,lodMetric:i.lodSelectionMetricType,urlPrefix:t}}catch(e){(0,n.r)(o)&&o.warn("#fetchIndexInfo()","Failed to load root node page. Falling back to node documents.",s,e),h=e}}if(!t)return null;const u=`${e}/nodes/`,c=u+(t&&t.split("/").pop());try{return{type:"node",rootNode:(await(0,r.L)(c,{query:{f:"json",token:a},responseType:"json",signal:l})).data,urlPrefix:u}}catch(e){throw new s.s("sceneservice:root-node-missing","Root node missing.",{pageError:h,nodeError:e,url:c})}}},65862:(e,t,i)=>{"use strict";i.d(t,{l:()=>h,m:()=>y,s:()=>a,u:()=>c});var r=i(78155),s=i(88903),n=(i(80219),i(29126));let a=class extends r.a{constructor(){super(...arguments),this.nodesPerPage=null,this.rootIndex=0,this.lodSelectionMetricType=null}};(0,r.e)([(0,s.y)({type:Number})],a.prototype,"nodesPerPage",void 0),(0,r.e)([(0,s.y)({type:Number})],a.prototype,"rootIndex",void 0),(0,r.e)([(0,s.y)({type:String})],a.prototype,"lodSelectionMetricType",void 0),a=(0,r.e)([(0,s.n)("esri.layer.support.I3SNodePageDefinition")],a);let o=class extends r.a{constructor(){super(...arguments),this.factor=1}};(0,r.e)([(0,s.y)({type:Number,json:{read:{source:"textureSetDefinitionId"}}})],o.prototype,"id",void 0),(0,r.e)([(0,s.y)({type:Number})],o.prototype,"factor",void 0),o=(0,r.e)([(0,s.n)("esri.layer.support.I3SMaterialTexture")],o);let l=class extends r.a{constructor(){super(...arguments),this.baseColorFactor=[1,1,1,1],this.baseColorTexture=null,this.metallicRoughnessTexture=null,this.metallicFactor=1,this.roughnessFactor=1}};(0,r.e)([(0,s.y)({type:[Number]})],l.prototype,"baseColorFactor",void 0),(0,r.e)([(0,s.y)({type:o})],l.prototype,"baseColorTexture",void 0),(0,r.e)([(0,s.y)({type:o})],l.prototype,"metallicRoughnessTexture",void 0),(0,r.e)([(0,s.y)({type:Number})],l.prototype,"metallicFactor",void 0),(0,r.e)([(0,s.y)({type:Number})],l.prototype,"roughnessFactor",void 0),l=(0,r.e)([(0,s.n)("esri.layer.support.I3SMaterialPBRMetallicRoughness")],l);let h=class extends r.a{constructor(){super(...arguments),this.alphaMode="opaque",this.alphaCutoff=.25,this.doubleSided=!1,this.cullFace="none",this.normalTexture=null,this.occlusionTexture=null,this.emissiveTexture=null,this.emissiveFactor=null,this.pbrMetallicRoughness=null}};(0,r.e)([(0,n.r)({opaque:"opaque",mask:"mask",blend:"blend"})],h.prototype,"alphaMode",void 0),(0,r.e)([(0,s.y)({type:Number})],h.prototype,"alphaCutoff",void 0),(0,r.e)([(0,s.y)({type:Boolean})],h.prototype,"doubleSided",void 0),(0,r.e)([(0,n.r)({none:"none",back:"back",front:"front"})],h.prototype,"cullFace",void 0),(0,r.e)([(0,s.y)({type:o})],h.prototype,"normalTexture",void 0),(0,r.e)([(0,s.y)({type:o})],h.prototype,"occlusionTexture",void 0),(0,r.e)([(0,s.y)({type:o})],h.prototype,"emissiveTexture",void 0),(0,r.e)([(0,s.y)({type:[Number]})],h.prototype,"emissiveFactor",void 0),(0,r.e)([(0,s.y)({type:l})],h.prototype,"pbrMetallicRoughness",void 0),h=(0,r.e)([(0,s.n)("esri.layer.support.I3SMaterialDefinition")],h);let u=class extends r.a{};(0,r.e)([(0,s.y)({type:String,json:{read:{source:["name","index"],reader:(e,t)=>null!=e?e:`${t.index}`}}})],u.prototype,"name",void 0),(0,r.e)([(0,n.r)({jpg:"jpg",png:"png",dds:"dds","ktx-etc2":"ktx-etc2",ktx2:"ktx2",basis:"basis"})],u.prototype,"format",void 0),u=(0,r.e)([(0,s.n)("esri.layer.support.I3STextureFormat")],u);let c=class extends r.a{constructor(){super(...arguments),this.atlas=!1}};(0,r.e)([(0,s.y)({type:[u]})],c.prototype,"formats",void 0),(0,r.e)([(0,s.y)({type:Boolean})],c.prototype,"atlas",void 0),c=(0,r.e)([(0,s.n)("esri.layer.support.I3STextureSetDefinition")],c);let d=class extends r.a{};(0,r.e)([(0,n.r)({Float32:"Float32",UInt64:"UInt64",UInt32:"UInt32",UInt16:"UInt16",UInt8:"UInt8"})],d.prototype,"type",void 0),(0,r.e)([(0,s.y)({type:Number})],d.prototype,"component",void 0),d=(0,r.e)([(0,s.n)("esri.layer.support.I3SGeometryAttribute")],d);let p=class extends r.a{};(0,r.e)([(0,n.r)({draco:"draco"})],p.prototype,"encoding",void 0),(0,r.e)([(0,s.y)({type:[String]})],p.prototype,"attributes",void 0),p=(0,r.e)([(0,s.n)("esri.layer.support.I3SGeometryCompressedAttributes")],p);let f=class extends r.a{constructor(){super(...arguments),this.offset=0}};(0,r.e)([(0,s.y)({type:Number})],f.prototype,"offset",void 0),(0,r.e)([(0,s.y)({type:d})],f.prototype,"position",void 0),(0,r.e)([(0,s.y)({type:d})],f.prototype,"normal",void 0),(0,r.e)([(0,s.y)({type:d})],f.prototype,"uv0",void 0),(0,r.e)([(0,s.y)({type:d})],f.prototype,"color",void 0),(0,r.e)([(0,s.y)({type:d})],f.prototype,"uvRegion",void 0),(0,r.e)([(0,s.y)({type:d})],f.prototype,"featureId",void 0),(0,r.e)([(0,s.y)({type:d})],f.prototype,"faceRange",void 0),(0,r.e)([(0,s.y)({type:p})],f.prototype,"compressedAttributes",void 0),f=(0,r.e)([(0,s.n)("esri.layer.support.I3SGeometryBuffer")],f);let y=class extends r.a{};(0,r.e)([(0,n.r)({triangle:"triangle"})],y.prototype,"topology",void 0),(0,r.e)([(0,s.y)()],y.prototype,"geometryBuffers",void 0),y=(0,r.e)([(0,s.n)("esri.layer.support.I3SGeometryDefinition")],y)},15870:(e,t,i)=>{"use strict";i.d(t,{u:()=>G,z:()=>ve}),i(33807);var r=i(78155),s=i(17762),n=i(73574),a=i(40130),o=i(80219),l=i(71391),h=i(20215),u=i(65352),c=i(36845),d=i(88903),p=i(95186),f=i(93242),y=i(71542),m=i(60816),g=i(15346),_=i(7571),x=i(53185),v=i(63114),b=i(52957),w=i(32422),S=i(35123),I=i(48643),C=i(81135),M=i(13895),T=i(83731),E=i(84271),F=i(30665),A=i(42413),R=i(80987),P=i(49293),L=i(26852),D=i(58404),N=i(72105),O=i(47122),k=i(6129),V=i(7552);function U(e,t,i,r){const s=t.getComponentAabb(i,e,B),n=t.getObjectTransform(i);for(let e=0;e<8;++e)j[0]=1&e?s[0]:s[3],j[1]=2&e?s[1]:s[4],j[2]=4&e?s[2]:s[5],(0,m.L)(j,j,n.rotationScale),(0,m.u)(j,j,n.position),r[3*e]=j[0],r[3*e+1]=j[1],r[3*e+2]=j[2];return r}function G(e,t,i){const r=new Float64Array(24);return s=>{let n=s.meta.featureExtents;if((0,o.t)(n)){n=new Float64Array(6*s.meta.featureIds.length),s.meta.featureExtents=n;for(let e=0;e<n.length;e+=6)n[e]=Number.POSITIVE_INFINITY}const a=new Float64Array(n.buffer,6*s.index*Float64Array.BYTES_PER_ELEMENT,6);return a[0]===Number.POSITIVE_INFINITY&&(U(s.index,i,s.meta.objectHandle,r),(0,_.x)(r,t,0,r,e,0,8)?((0,x.A)(a,x.D),(0,x.M)(a,r,0,8)):(0,x.A)(a,x.H)),a}}function z(e,t,i,r){const s=t.getComponentAabb(i,e,B),n=t.getObjectTransform(i);r[0]=0,r[1]=0,r[2]=0;for(let e=0;e<8;++e)j[0]=1&e?s[0]:s[3],j[1]=2&e?s[1]:s[4],j[2]=s[5],(0,m.L)(j,j,n.rotationScale),(0,m.u)(j,j,n.position),r[0]+=j[0],r[1]+=j[1],r[2]+=j[2];return r[0]/=8,r[1]/=8,r[2]/=8,r}const B=(0,x.a)(),j=(0,m.n)();class q extends R.n{constructor(e){super(),this._limit=e,this._all=new v.s,this._active=new W(this),this._pending=new Map,this._handle=this._all.on("change",(e=>this._handleChanges(e)))}destroy(){this._handle.remove()}get length(){return this._active.length}toArray(){return this._active.toArray()}find(e){return this._active.find(e)}forEach(e){this._active.forEach(e)}addMany(e){this._all.addMany(e)}removeManyByObjectId(e){this._all.removeManyByObjectId(e)}_handleChanges(e){let t=e.removed;if(this._pending.size>0){t=new Array;for(const i of e.removed)this._pending.delete(i.objectId)||t.push(i)}let i=this._limit-this._active.length+t.length;i<e.added.length&&(this._active.removeMany(t),t=[],H.reset(1-this._limit/(this._active.length+e.added.length)),this._active.forEach((e=>{H.sample()&&(t.push(e),this._pending.set(e.objectId,e))})),i=this._limit-this._active.length+t.length);let r=e.added;if(i<e.added.length){r=new Array,H.reset(i/e.added.length);for(const t of e.added)H.sample()?r.push(t):this._pending.set(t.objectId,t)}const s=i-r.length;s>0&&this._pending.size>0&&(H.reset(s/this._pending.size),this._pending.forEach((e=>{H.sample()&&(r.push(e),this._pending.delete(e.objectId))}))),this._active.addAndRemove(r,t)}}const H=new class{constructor(){this.percentage=1,this.last=-1,this.index=0}reset(e){this.percentage=e,this.last=-1}sample(){const e=Math.floor(this.index*this.percentage);return++this.index,e!==this.last&&(this.last=e,!0)}};class W{constructor(e){this._parent=e,this._map=new Map}get length(){return this._map.size}forEach(e){this._map.forEach((t=>e(t)))}find(e){let t;return(0,l.g)(this._map,(i=>!!e(i)&&(t=i,!0))),t}toArray(){return[...this._map.values()]}addAndRemove(e,t){for(const t of e)this._map.set(t.objectId,t);for(const e of t)this._map.delete(e.objectId);(e.length>0||t.length>0)&&this._parent.emit("change",{added:e,removed:t})}removeMany(e){for(const t of e)this._map.delete(t.objectId);e.length>0&&this._parent.emit("change",{added:[],removed:e})}}let Q=class extends r.p{constructor(e){super(e),this.loadedGraphics=new q(5e4),this.slicePlaneEnabled=!1,this._renderingInfo={symbol:new C.k},this._handles=new T.u,this._graphicsByNode=new Map,this._scaleVisibility=null}initialize(){this._graphicsCore=new A.O({owner:this,layer:this.layer,preferredUpdatePolicy:0,elevationFeatureExpressionEnabled:!1,graphicSymbolSupported:!1,getRenderingInfoWithoutRenderer:!0,hasZ:!0,hasM:!1});const e=this.view.basemapTerrain;this._scaleVisibility=new A.y({layerScaleEnabled:!1}),this._scaleVisibility.setup(this,this.layer,((e,t,i)=>this._graphicsCore.spatialIndex.queryGraphicUIDsInExtent(e,t,i)),this._graphicsCore,e);const t=this.view.labeler.addGraphicsOwner(this._graphicsCore,this._scaleVisibility,{emptySymbolLabelSupported:!0,elevationInfoOverride:{mode:"absolute-height",offset:0},disablePlacement:{logEntityDescription:"3D Object Scene Layer features"}}),i=this.view.deconflictor.addGraphicsOwner(this._graphicsCore);this._graphicsCore.setup({labeler:t,deconflictor:i,scaleVisibility:this._scaleVisibility}).then((()=>{this._graphicsCore.startCreateGraphics()})).catch((()=>{})),this._handles.add([this.layer.watch("labelingInfo",((e,t)=>{(0,E.m)(e,t)&&this._graphicsCore.updateLabelingInfo()}))])}destroy(){this._handles&&(this._handles.destroy(),this._handles=null),null!=this._scaleVisibility&&(this._scaleVisibility.destroy(),this._scaleVisibility=null),null!=this._graphicsCore&&(this._graphicsCore.destroy(),this._graphicsCore=null),this.loadedGraphics.destroy(),this.view=null}addNodeMeta(e,t){let i=0;const r=e.filteredIds,s=e.featureIds.map(((s,a)=>{z(a,this.collection,e.objectHandle,Y);const l=(0,F.v)(0,0,0,this.view.spatialReference);this.view.renderCoordsHelper.fromRenderCoords(Y,l);const h=t(a,e);let u=!1;return(0,o.t)(r)?u=!0:i<r.length&&s===r[i]&&(u=!0,i++),{objectId:s,uid:n.h.generateUID(),attributes:h,visible:u,geometry:l}}));this.loadedGraphics.addMany(s),this._graphicsByNode.set(e.node.index,s)}setNodeMetaAttributes(e,t){const i=this._graphicsByNode.get(e.node.index),r=new Array(i.length);for(let s=0;s<i.length;s++){const n=i[s];n.attributes=t(s,e),r[s]=n.uid}this._graphicsCore.updateLabelingInfo(r)}applyFilterChange(e){const t=this._graphicsByNode.get(e.node.index);if(t)if((0,o.t)(e.filteredIds))for(const e of t)e.visible||(e.visible=!0,Z.graphic=e,Z.property="visible",Z.oldValue=!1,Z.newValue=!0,this._graphicsCore.graphicUpdateHandler(Z));else{let i=0;for(const r of t){const t=r.visible;i<e.filteredIds.length&&r.objectId===e.filteredIds[i]?(r.visible=!0,i++):r.visible=!1,t!==r.visible&&(Z.graphic=r,Z.property="visible",Z.oldValue=t,Z.newValue=r.visible,this._graphicsCore.graphicUpdateHandler(Z))}}}removeNodeMeta(e){this.loadedGraphics.removeManyByObjectId(e.featureIds)}getRenderingInfo(){return this._renderingInfo}notifyGraphicGeometryChanged(){}notifyGraphicVisibilityChanged(){}get updatePolicy(){return this._graphicsCore.effectiveUpdatePolicy}get usedMemory(){return this._graphicsCore.usedMemory}get unloadedMemoryEstimate(){return this._graphicsCore.unprocessedMemoryEstimate}get test(){return{graphicsCore:this._graphicsCore}}};(0,r.e)([(0,d.y)()],Q.prototype,"view",void 0),(0,r.e)([(0,d.y)()],Q.prototype,"layer",void 0),(0,r.e)([(0,d.y)()],Q.prototype,"collection",void 0),(0,r.e)([(0,d.y)()],Q.prototype,"loadedGraphics",void 0),(0,r.e)([(0,d.y)({aliasOf:"_graphicsCore.updating"})],Q.prototype,"updating",void 0),(0,r.e)([(0,d.y)()],Q.prototype,"slicePlaneEnabled",void 0),(0,r.e)([(0,d.y)()],Q.prototype,"_graphicsCore",void 0),Q=(0,r.e)([(0,d.n)("esri.views.3d.layers.I3SMeshViewLabeler")],Q);const Z={graphic:null,property:null,oldValue:null,newValue:null},Y=(0,m.n)();var J=Q;const X=o.n.getLogger("esri.views.3d.layers.I3SMeshWorkerHandle");class $ extends P.a{constructor(e){super("SceneLayerWorker","process",e,{hasInitialize:!0})}getTransferList(e){return[e.geometryBuffer]}setModifications(e,t,i){const r={context:e,modifications:te(t,i),isGeodetic:i.isGeographic};this.broadcast(r,"setModifications")}setLegacySchema(e,t){const i=JSON.stringify(t);this.broadcast({context:e,jsonSchema:i},"setLegacySchema")}destroyContext(e){return this.broadcast(e,"destroyContext")}}const K=new r.f({deallocator:null}),ee=[0,0,0];function te(e,t){K.clear();for(const i of e){const e="clip"===i.type?2:"mask"===i.type?1:0,r=i.geometry;let s=e=>e;if(r.spatialReference){if(!(0,_.n)(r.spatialReference,t)){X.warn("Can't project modification polygon into layer spatial reference, ignoring modification");continue}s=e=>((0,_.w)(e,r.spatialReference,ee,t),ee)}else r.hasZ||(ee[2]=0,s=e=>(ee[0]=e[0],ee[1]=e[1],ee));K.push(e),K.push(r.rings.length);for(const e of r.rings){K.push(e.length);for(const t of e){const e=s(t);K.push(e[0]),K.push(e[1]),K.push(e[2])}}}K.push(3);const i=new Float64Array(K.length);for(let e=0;e<K.length;++e)i[e]=K.getItemAt(e);return i}class ie{constructor(){this.ids=new Set,this.paused=!1}}class re{constructor({collection:e,forAllFeatures:t,forAllFeaturesOfNode:i}){this.highlights=[],this.collection=e,this.forAllFeatures=t,this.forAllFeaturesOfNode=i}destroy(){this.highlights.forEach((e=>this.releaseSet(e))),this.highlights=null}acquireSet(){const e=new ie;this.highlights.push(e);const t={remove:()=>{this.releaseSet(e),(0,r.v)(this.highlights,e)},pause:()=>{this.releaseSet(e),e.paused=!0},resume:()=>{e.paused=!1,this.initializeSet(e)}};return{set:e,handle:t}}setFeatureIds(e,t){t.forEach((t=>e.ids.add(t))),this.initializeSet(e)}initializeSet(e){this.forAllFeatures(((t,i,r)=>(e.ids.has(t)&&this.collection.addComponentHighlight(r.objectHandle,i),1)))}releaseSet(e){this.forAllFeatures(((t,i,r)=>(e.ids.has(t)&&this.collection.removeComponentHighlight(r.objectHandle,i),1)))}objectCreated(e){this.highlights.forEach((t=>{t.paused||this.forAllFeaturesOfNode(e,((i,r)=>(t.ids.has(i)&&this.collection.addComponentHighlight(e.objectHandle,r),1)))}))}objectDeleted(e){this.collection.clearHighlights(e.objectHandle)}}class se{constructor(e){this.view=e,this._preRenderFrameTaskHandle=null,this._currentFrameStartTime=null,this._numFadingNodes=0}get updating(){return this._numFadingNodes>0}stopNodeFading(e){null!=e.lodCrossfadeProgress&&(this._numFadingNodes--,e.lodCrossfadeProgress=null,0===this._numFadingNodes&&(null!=this._preRenderFrameTaskHandle&&(this._preRenderFrameTaskHandle=(0,o.a)(this._preRenderFrameTaskHandle)),this.view.notifyLODUpdate(),this.view.notifyUpdate()))}_startNodeFading(e,t,i){0===this._numFadingNodes&&(this._preRenderFrameTaskHandle=(0,r.A)({preRender:e=>this._updateAllNodeFading(e)}),this.view.notifyLODUpdate()),null==e.lodCrossfadeProgress&&(this._numFadingNodes++,this.view.notifyUpdate()),e.lodCrossfadeSignedDuration=i,e.lodCrossfadeProgress=t}_updateAllNodeFading(e){const t=this.view.nodeCrossfadingEnabled;this.view.foreachCrossfadeNode(((i,r)=>{if((0,o.r)(r)&&(0,o.r)(r.lodCrossfadeProgress)){const s=r.lodCrossfadeSignedDuration,n=s>0?this.view.fullOpacity:0,a=e.deltaTime/s,o=r.lodCrossfadeProgress+Math.abs(a),l=!t||o>=1||0===s,h=n-(l?0:s>0?1:-1)*(1-o);l?(this.stopNodeFading(r),s<0&&this.view.markNodeToRemove(i)):r.lodCrossfadeProgress=o,this.view.setNodeOpacityByIndex(i,h)}})),this.view.removeMarkedNodes()}stopAllNodeFading(){this.view.foreachCrossfadeNode(((e,t)=>{if((0,o.r)(t)&&(0,o.r)(t.lodCrossfadeProgress)){this.stopNodeFading(t);const i=t.lodCrossfadeSignedDuration;i<0&&this.view.markNodeToRemove(e);const r=i>0?this.view.fullOpacity:0;this.view.setNodeOpacityByIndex(e,r)}})),this.view.removeMarkedNodes()}fadeNode(e,t,i,r){null==this._currentFrameStartTime&&(this._currentFrameStartTime=Date.now());const s=this.view,n=s.nodeCrossfadingEnabled,a=0===i?s.fullOpacity:0,o=n?r?0===i?s.lodCrossfadeinDuration:s.lodCrossfadeoutDuration:s.lodCrossfadeUncoveredDuration:0,l=this.view.getNodeOpacityByIndex(e);if(n&&l!==a&&o>0){const e=1-Math.abs(a-l);this._startNodeFading(t,e,function(e){return 0===e?1:-1}(i)*o)}else this.stopNodeFading(t),this.view.setNodeOpacityByIndex(e,a),1===i&&this.view.removeNode(e)}isNodeFullyFadedIn(e){const t=this.view.getNodeCrossfadeMetaData(e);return(0,o.r)(t)&&null==t.lodCrossfadeProgress&&this.view.getNodeOpacityByIndex(e)===this.view.fullOpacity}}const ne=(0,D.B)(),ae=(0,y.e)(),oe=(0,m.n)(),le=(0,m.n)(),he=(0,m.n)(),ue=o.n.getLogger("esri.views.3d.layers.i3s.I3SElevationProvider");let ce=class extends(R.n.EventedMixin(r.p)){constructor(e){super(e),this.tmpEvent={spatialReference:null,extent:ne,context:"scene"}}initialize(){this.view=this.layerView.view,this.renderCoordsHelper=this.view.renderCoordsHelper,this.intersector=new w.u(this.view.state.viewingMode),this.intersector.options.store=0;const e=this.layerView.i3slayer.fullExtent;this.zmin=e.zmin,this.zmax=e.zmax,this.tmpEvent.context=this.intersectionHandler.isGround?"ground":"scene"}getElevation(e,t,i,r){if(oe[0]=e,oe[1]=t,oe[2]=i,!this.renderCoordsHelper.toRenderCoords(oe,r,oe))return ue.error("could not project point to compute elevation"),null;const s=this.layerView.elevationOffset,n=this.zmin+s,a=this.zmax+s;return this.renderCoordsHelper.setAltitude(le,a,oe),this.renderCoordsHelper.setAltitude(he,n,oe),this.intersector.reset(le,he),this.intersectionHandler.intersect(this.intersector,null,le,he),this.intersector.results.min.getIntersectionPoint(oe)?this.renderCoordsHelper.getAltitude(oe):null}layerChanged(){this.spatialReference&&(this.tmpEvent.extent=this.computeLayerExtent(),this.tmpEvent.spatialReference=this.spatialReference,this.emit("elevation-change",this.tmpEvent))}objectChanged(e){this.spatialReference&&(this.tmpEvent.extent=this.computeObjectExtent(e),this.tmpEvent.spatialReference=this.spatialReference,this.emit("elevation-change",this.tmpEvent))}computeObjectExtent(e){return(0,D.B)(ne),this._expandExtent(e,ne),ne}computeLayerExtent(){(0,D.B)(ne);for(const e of this.layerView.getVisibleNodes())this._expandExtent(e,ne);return ne}_expandExtent(e,t){const i=e.visibilityObb||e.serviceObbInRenderSR;if((0,o.r)(i)){(0,f.P)(ae,i.quaternion),ae[12]=i.center[0],ae[13]=i.center[1],ae[14]=i.center[2];for(let e=0;e<8;++e)oe[0]=1&e?i.halfSize[0]:-i.halfSize[0],oe[1]=2&e?i.halfSize[1]:-i.halfSize[1],oe[2]=4&e?i.halfSize[2]:-i.halfSize[2],(0,m.I)(oe,oe,ae),this.renderCoordsHelper.fromRenderCoords(oe,oe,this.spatialReference),(0,D.c)(t,oe)}else{const i=e.renderMbs[3],r=(0,m.h)(le,e.renderMbs);r[0]-=i,r[1]-=i,r[2]-=i;const s=(0,m.h)(he,e.renderMbs);s[0]+=i,s[1]+=i,s[2]+=i;for(let e=0;e<8;++e)oe[0]=1&e?r[0]:s[0],oe[1]=2&e?r[1]:s[1],oe[2]=4&e?r[2]:s[2],this.renderCoordsHelper.fromRenderCoords(oe,oe,this.spatialReference),(0,D.c)(t,oe)}}};(0,r.e)([(0,d.y)({constructOnly:!0})],ce.prototype,"layerView",void 0),(0,r.e)([(0,d.y)({constructOnly:!0})],ce.prototype,"intersectionHandler",void 0),(0,r.e)([(0,d.y)()],ce.prototype,"view",void 0),(0,r.e)([(0,d.y)({readOnly:!0,aliasOf:"view.elevationProvider.spatialReference"})],ce.prototype,"spatialReference",void 0),ce=(0,r.e)([(0,d.n)("esri.views.3d.layers.i3s.I3SElevationProvider")],ce);var de=ce;class pe{constructor(e){this.type="I3S",this.layerUid=e.layerUid,this.sublayerUid=e.sublayerUid,this.collection=e.collection,this.forEach=e.forEach,this.slicePlane=e.slicePlaneEnabled,this.isGround=e.isGround}intersect(e,t,i,r){const s=e.results,n=2===e.options.store,a=e.ray.direction,l=e.tolerance;let h=e=>e,u=e=>e;const c=(0,N.bP)(e.verticalOffset);(0,o.r)(c)&&(h=e=>c.applyToMbs(e),u=e=>c.applyToObb(e)),this.forEach(((d,p)=>{if((0,o.r)(d.geometryObb)){if(!(0,w.O)(u(d.geometryObb),i,a,l))return}else if((0,o.r)(d.serviceObbInRenderSR)){if(!(0,w.O)(u(d.serviceObbInRenderSR),i,a,l))return}else if(!function(e,t,i,r=0){const s=e[3]+r,n=t[0]-e[0],a=t[1]-e[1],o=t[2]-e[2],l=i[0],h=i[1],u=i[2],c=l*n+h*a+u*o;return c*c-(l*l+h*h+u*u)*(n*n+a*a+o*o-s*s)>=0}(h(d.renderMbs),i,a,l))return;this.collection.intersect(p,i,r,l,c,((a,o,l,h)=>{if(o>=0){if(null!=t&&!t(i,r,o))return;const u=e=>{e.intersector=this.type,e.target={type:"external",metadata:{layerUid:this.layerUid,sublayerUid:this.sublayerUid,nodeIndex:d.index,componentIndex:a}},e.dist=o,(0,m.h)(e.normal,l),e.triangleNr=h};if(this.isGround&&(null==s.ground.dist||o<s.ground.dist)&&u(s.ground),e.options.isFiltered)return;if((null==s.min.dist||o<s.min.dist)&&u(s.min),(null==s.max.dist||o>s.max.dist)&&u(s.max),n){const t=new w.C(e.ray);u(t),e.results.all.push(t)}}}))}))}get intersectionHandlerId(){return this.layerUid}}class fe{constructor(e,t,i=14){this._version=i,this._db=null,this._quotaReductionPromise=null,this._gcCounter=0,this._hit=0,this._miss=0,this._destroyed=!1,this.gcFrequency=50,this.maxByteSize=1073741824,this.quotaReductionFactor=.2,this._dbName=e,this._storeName=t}init(){return Promise.resolve().then((()=>{const e=indexedDB.open(this._dbName,this._version);return e.onupgradeneeded=t=>{const i=e.result,r=e.transaction,s=i.objectStoreNames.contains(this._storeName)?r.objectStore(this._storeName):i.createObjectStore(this._storeName),n=i.objectStoreNames.contains("last_access")?r.objectStore("last_access"):i.createObjectStore("last_access");n.indexNames.contains("date")||n.createIndex("date","date",{unique:!1}),n.indexNames.contains("byteSize")||n.createIndex("byteSize","byteSize",{unique:!1}),t.oldVersion<this._version&&(s.clear(),n.clear())},me(e)})).then((e=>{this._destroyed?e.close():this._db=e}))}destroy(){this._db&&(this._db.close(),this._db=null),this._destroyed=!0}get initialized(){return null!=this._db}getHitRate(){return this._hit/(this._hit+this._miss)}put(e,t){return null==this._db?Promise.reject(new h.s("indexedb:not-initialized","IndexedDB Cache is not initialized")):(null!=this._quotaReductionPromise?this._quotaReductionPromise:Promise.resolve()).then((()=>this._put(e,t))).catch((i=>{if(i&&"QuotaExceededError"===i.name)return null==this._quotaReductionPromise&&(this._quotaReductionPromise=this._getCacheSize().then((e=>this._removeLeastRecentlyAccessed(t.byteSize+Math.ceil(e*this.quotaReductionFactor)))),this._quotaReductionPromise.then((()=>this._quotaReductionPromise=null),(()=>this._quotaReductionPromise=null))),this._quotaReductionPromise.then((()=>this._put(e,t)));throw i})).then((()=>{this._gcCounter--,this._gcCounter<0&&null!=this._db&&(this._gcCounter=this.gcFrequency,this._getCacheSize().then((e=>this._removeLeastRecentlyAccessed(e-this.maxByteSize))))}))}get(e,t){if(null==this._db)return Promise.resolve(null);let i=null;return Promise.resolve().then((()=>{const r=this._db.transaction(this._storeName,"readonly");return i=(0,h.v)(t,(()=>{r.abort()})),me(r.objectStore(this._storeName).get(e))})).then((t=>(null==t?++this._miss:this._db&&(++this._hit,this._db.transaction("last_access","readwrite").objectStore("last_access").put({date:Date.now(),byteSize:t.byteSize},e)),(0,o.r)(i)&&i.remove(),t))).catch((()=>(++this._miss,(0,h.a)(t),(0,o.r)(i)&&i.remove(),null)))}remove(e){return null==this._db?Promise.resolve():Promise.resolve().then((async()=>{const t=this._db.transaction([this._storeName,"last_access"],"readwrite"),i=t.objectStore(this._storeName),r=t.objectStore("last_access"),s=i.delete(e),n=r.delete(e);await Promise.all([me(s),me(n),ye(t)])}))}_put(e,t){const i=this._db.transaction([this._storeName,"last_access"],"readwrite"),r=i.objectStore(this._storeName),s=i.objectStore("last_access"),n=r.put(t,e),a=s.put({date:Date.now(),byteSize:t.byteSize},e);return Promise.all([me(n),me(a),ye(i)])}_removeLeastRecentlyAccessed(e){if(e<=0)return;const t=this._db.transaction([this._storeName,"last_access"],"readwrite"),i=t.objectStore(this._storeName),r=t.objectStore("last_access");let s=0;const n=r.index("date").openCursor(null,"next");return n.onsuccess=()=>{const t=n.result;null!=t&&(null!=t.value.byteSize&&(s+=t.value.byteSize),i.delete(t.primaryKey),r.delete(t.primaryKey),s<e&&t.continue())},ye(t)}_getCacheSize(){const e=this._db.transaction("last_access"),t=e.objectStore("last_access");let i=0;const r=t.index("byteSize").openKeyCursor();return r.onsuccess=()=>{const e=r.result;if(!e)return;const t=e.key;null!=t&&(i+=t),e.continue()},ye(e).then((()=>i))}}function ye(e){return new Promise(((t,i)=>{e.oncomplete=()=>t(),e.onerror=()=>i(e.error),e.onabort=()=>i(e.error)}))}function me(e){return new Promise(((t,i)=>{"done"===e.readyState?null!=e.error?i(e.error):t(e.result):(e.onsuccess=()=>t(e.result),e.onerror=()=>i(e.error))}))}const ge=o.n.getLogger("esri.views.3d.layers.SceneLayerView3D"),_e=[1,1,1,1];class xe extends class{constructor(){this.lodCrossfadeSignedDuration=0}}{constructor(e,t,i,r,s,n,a){super(),this.node=e,this.featureIds=t,this.objectHandle=i,this.cachedRendererVersion=r,this.attributeInfo=s,this.material=n,this.textures=a,this.cachedEdgeMaterials=new Array,this.cachedSymbology=null}}const ve=e=>{var t;let s=t=class extends e{constructor(...e){super(e),this._elevationProvider=null,this._intersectionHandler=null,this._nodeId2Meta=new Map,this._nodeId2MetaReloading=new Map,this._i3sWasmLoaded=!1,this._hasLoadedPBRTextures=!1,this._asyncModuleLoading=0,this._addTasks=new Map,this._rendererVersion=0,this._colorVariable=null,this._opacityVariable=null,this._rendererFields=null,this._symbologyFields=null,this._symbologyOverride=null,this._symbologyOverrideFields=null,this._symbolInfos=new Map,this._idbCache=new fe("esri-scenelayer-cache","geometries"),this.holeFilling="auto",this._hasColors=!1,this._hasTextures=!1,this._hasData=!1,this.slicePlaneEnabled=!1,this._modifications=new Array,this._layerUrl="",this._cacheKeySuffix=null,this._arcade=null,this._tmpAttributeOnlyGraphic=new n.h(null,null,{}),this._crossfadeHelper=new se(this),this.index=t.lastIndex++}get lodCrossfadeoutDuration(){return 0}get lodCrossfadeinDuration(){return 0}get lodCrossfadeUncoveredDuration(){return 0}get layerUid(){return this.i3slayer&&this.i3slayer.uid}get sublayerUid(){return null}get hasTexturesOrVertexColors(){return this._hasData?this._hasTextures||this._hasColors?"yes":"probably-not":"unknown"}get rendererTextureUsage(){return(0,O.R)(this._currentRenderer)?this._usePBR()||this._hasLoadedPBRTextures?63:37:this._usePBR()||this._hasLoadedPBRTextures?44:36}get elevationOffset(){const e=null!=this.i3slayer?this.i3slayer.elevationInfo:null;if(null!=e&&"absolute-height"===e.mode){const t=(0,u.T)(this.i3slayer.spatialReference),i=(0,M.r)(e.unit);return(0,o.q)(e.offset,0)*i/t}return 0}get supportedTextureEncodings(){return(0,v.T)(this.view._stage.renderView)}get uncompressedTextureDownsamplingEnabled(){var e;const t=null==(e=this.view)?void 0:e.qualitySettings.sceneService.uncompressedTextureDownsamplingEnabled,i=0==(4&this.supportedTextureEncodings);return t&&i}initialize(){this.preLoadBasis(),this.addResolvingPromise(this.i3slayer.indexInfo);const e=this.view.resourceController;if(this.attributeOverrides=new v.y(this.i3slayer,e.memoryController),this._worker=new $((t=>e.schedule(t))),this.addResolvingPromise(this._worker.promise),this._worker.setLegacySchema(this.layerUid,this.i3slayer.store.defaultGeometrySchema),(0,O.b)(this.i3slayer),(0,O.w)(this.i3slayer,this.view),this._layerUrl=this.i3slayer.parsedUrl.path,this._controller=new v.J({layerView:this}),this.gpuMemoryEstimate=0,this.texMemoryEstimate=0,this.geoMemoryEstimate=0,this._stage=this.view._stage,this._collection=this._stage.renderView.componentObjectCollection,this._highlights=new re({collection:this._collection,forAllFeatures:e=>this._forAllFeatures(e,null,1),forAllFeaturesOfNode:(e,t)=>this._forAllFeaturesOfNode(e,t)}),this._isIntegratedMesh||!this.i3slayer.store.defaultGeometrySchema)this._hasSymbolColors=!1;else{const e=this.i3slayer.store.defaultGeometrySchema.featureAttributes;this._hasSymbolColors=!!(e&&e.faceRange&&e.id)}this._hasVertexColors=null!=this.i3slayer.store.defaultGeometrySchema.vertexAttributes.color&&(null==this.i3slayer.cachedDrawingInfo||!this.i3slayer.cachedDrawingInfo.color),this._isIntegratedMesh||(this._edgeView=this._stage.renderView.ensureEdgeView()),this._memCache=this.view.resourceController.memoryController.getMemCache(this.i3slayer.uid,(e=>this._deleteComponentObject(e))),this._intersectionHandler=new pe({layerUid:this.layerUid,sublayerUid:this.sublayerUid,collection:this._collection,slicePlaneEnabled:this.slicePlaneEnabled,isGround:this._isIntegratedMesh,forEach:e=>{this._nodeId2Meta.forEach((t=>(0,o.r)(t)&&e(t.node,t.objectHandle))),this._nodeId2MetaReloading.forEach((t=>(0,o.r)(t)&&e(t.node,t.objectHandle)))}}),this._elevationProvider=new de({layerView:this,intersectionHandler:this._intersectionHandler}),this._hasLoadedPBRTextures=this._usePBR(),this.updatingHandles.add(this,"view.clippingArea",(()=>this._clippingAreaChanged()),2),this.updatingHandles.add(this,"fullOpacity",(e=>this._opacityChange(e))),this.updatingHandles.add(this,"slicePlaneEnabled",(e=>this._slicePlaneEnabledChange(e))),this.updatingHandles.add(this,"elevationOffset",((e,t)=>{this._reloadAll(t),this._controller.invalidateVisibilityObbs()})),this.updatingHandles.add(this,"filter",(()=>this._filterChange()),2),this.updatingHandles.add(this,"view.qualitySettings.physicallyBasedRenderingEnabled",(()=>this._updatePBR()));const t=()=>{this._reloadAll(),this.clearMemCache()};this.updatingHandles.add(this,"rendererTextureUsage",t),this.updatingHandles.add(this,"uncompressedTextureDownsamplingEnabled",t),this.updatingHandles.add(this,"suspended",(e=>this._suspendedChange(e)),2),this.updatingHandles.add(this.i3slayer,"labelsVisible",(()=>this._labelingChanged()),2),this.updatingHandles.add(this.i3slayer,"labelingInfo",(()=>this._labelingChanged()),2),this.updatingHandles.add(this,"_modifications",(()=>this._modificationsChanged()),2),this.handles.add([(0,c.d)(w.T,"I3S_TREE_SHOW_TILES",(e=>{if(e&&!this._treeDebugger){const e=this._controller.crsIndex;Promise.all([i.e(9351),i.e(1470)]).then(i.bind(i,51470)).then((({I3STreeDebugger:t})=>{!this._treeDebugger&&w.T.I3S_TREE_SHOW_TILES&&(this._treeDebugger=new t({lv:this,view:this.view,nodeSR:e}))}))}else e||w.T.I3S_TREE_SHOW_TILES||(this._treeDebugger=(0,o.k)(this._treeDebugger))})),(0,c.d)(w.T,"I3S_SHOW_MODIFICATIONS",(()=>this._showModifications()))]),this._cacheKeySuffix=(0,O.h)(this.i3slayer.spatialReference,this.view.renderSpatialReference),this._idbCache.init().catch((e=>ge.warn(`Failed to initialize IndexedDB cache: ${e}`)))}destroy(){this._clearAddTasks(),this.attributeOverrides=(0,o.k)(this.attributeOverrides),this._elevationProvider&&(this._elevationProvider.layerChanged(),this.view.elevationProvider.unregister(this._elevationProvider),this._elevationProvider=null),this._intersectionHandler&&(this._stage.sceneIntersectionHelper.removeIntersectionHandler(this._intersectionHandler),this._intersectionHandler=null);const e=this._worker;e&&(e.destroyContext(this.i3slayer.uid).then((()=>e.destroy())),this._worker=null),this._removeAllNodeDataFromStage(),this._memCache=(0,o.k)(this._memCache),this._collection=null,this._stage=null,this._edgeView=null,this._labeler=(0,o.k)(this._labeler),this._treeDebugger=(0,o.k)(this._treeDebugger),this._controller=(0,o.k)(this._controller),this._highlights.destroy(),this._nodeId2Meta.clear(),this._nodeId2MetaReloading.clear(),this.emit("visible-geometry-changed"),this._visibleGeometryChangedSchedulerHandle&&(this._visibleGeometryChangedSchedulerHandle.remove(),this._visibleGeometryChangedSchedulerHandle=null)}memEstimateTextureAdded(e){const t=e.estimatedTexMemRequired;return this.gpuMemoryEstimate+=t,this.texMemoryEstimate+=t,t}memEstimateTextureRemoved(e){const t=e.estimatedTexMemRequired;this.gpuMemoryEstimate-=t,this.texMemoryEstimate-=t}memEstimateGeometryAdded(e){const t=this._collection.getObjectGPUMemoryUsage(e);return this.gpuMemoryEstimate+=t,this.geoMemoryEstimate+=t,t}memEstimateGeometryRemoved(e){const t=this._collection.getObjectGPUMemoryUsage(e);this.gpuMemoryEstimate-=t,this.geoMemoryEstimate-=t}isNodeLoaded(e){return this._nodeId2Meta.has(e)}isNodeReloading(e){return this._nodeId2MetaReloading.has(e)}getUsedMemory(){let e=(0,o.r)(this._labeler)?this._labeler.usedMemory:0;return this._nodeId2Meta.forEach((t=>e+=(0,o.r)(t)?t.node.memory:0)),this._nodeId2MetaReloading.forEach((t=>e+=(0,o.r)(t)?t.node.memory:0)),e}getUnloadedMemory(){return((0,o.r)(this._controller)?this._controller.unloadedMemoryEstimate:0)+((0,o.r)(this._labeler)?this._labeler.unloadedMemoryEstimate:0)}ignoresMemoryFactor(){return!1}_labelingChanged(){if(!(0,w.E)(this.i3slayer)||!this._supportsLabeling)return void((0,o.r)(this._labeler)&&(this._labeler.destroy(),this._labeler=null));if((0,o.r)(this._labeler))return;const e=new J({view:this.view,layer:this.i3slayer,collection:this._collection});this._nodeId2Meta.forEach((t=>(0,o.r)(t)&&this._addMetaToLabeler(e,t))),this._labeler=e}_loadAsyncModule(e){return++this._asyncModuleLoading,e.then((e=>(--this._asyncModuleLoading,e)),(e=>{throw--this._asyncModuleLoading,e}))}_modificationsChanged(){if(!this._i3sWasmLoaded&&this._hasModifications)return this._i3sWasmLoaded=(0,L.initialize)().then((()=>{this._i3sWasmLoaded=!0,this._modificationsChanged(),this.notifyUpdate()})),void this.notifyUpdate();if(!0!==this._i3sWasmLoaded)return;const e=this.i3slayer.uid,t=this.i3slayer.spatialReference;this._worker.setModifications(e,this._modifications,t);const i=te(this._modifications,t);(0,L.setModificationsSync)({context:e,modifications:i,isGeodetic:t.isGeographic}),this._controller.modificationsChanged();const s=this._hasModifications?new r.f:null;this._nodeId2Meta.forEach(((e,t)=>{(0,o.t)(e)?this._nodeId2Meta.delete(t):e.node.hasModifications?(this._nodeId2Meta.delete(t),this._nodeId2MetaReloading.set(t,e)):(0,o.r)(s)&&s.push(e.node)})),(0,o.r)(s)&&this._nodeId2MetaReloading.forEach((e=>s.push(e.node))),(0,o.r)(s)&&s.length>0&&(this.updateNodeModificationStatus(s),s.forAll((e=>{if(2!==e.imModificationImpact){const t=this._nodeId2Meta.get(e.index);this._controller.invalidateGeometryVisibility(e.index),this._nodeId2Meta.delete(e.index),(0,o.r)(t)&&this._nodeId2MetaReloading.set(e.index,t)}}))),this.clearMemCache(),this._controller.restartNodeLoading(),this._showModifications()}_showModifications(){if((0,o.r)(this._modificationGraphics)&&(this.view.graphics.removeMany(this._modificationGraphics),this._modificationGraphics=null),!w.T.I3S_SHOW_MODIFICATIONS||0===this._modifications.length)return;const e={clip:[227,227,79,.8],mask:[227,139,79,.8],replace:[139,227,79,.8]},t={type:"simple-fill",outline:{color:[255,255,255],width:1}};this._modificationGraphics=new Array;for(const i of this._modifications){i.geometry.spatialReference=this.i3slayer.spatialReference;const r={...t,color:e[i.type]};this._modificationGraphics.push(new n.h({geometry:i.geometry,symbol:r}))}this.view.graphics.addMany(this._modificationGraphics)}_addMetaToLabeler(e,t){e.addNodeMeta(t,((e,t)=>this._createAttributes(e,t)))}_suspendedChange(e){e?(this._removeAllNodeDataFromStage(),this.view.elevationProvider&&this.view.elevationProvider.unregister(this._elevationProvider),this._stage.sceneIntersectionHelper.removeIntersectionHandler(this._intersectionHandler)):(this.view.elevationProvider.register(this._elevationContext,this._elevationProvider),this._stage.sceneIntersectionHelper.addIntersectionHandler(this._intersectionHandler))}getLoadedAttributes(e){const t=this._nodeId2Meta.get(e);if((0,o.r)(t)&&(0,o.r)(t.attributeInfo))return t.attributeInfo.loadedAttributes}getAttributeData(e){const t=this._nodeId2Meta.get(e);if((0,o.r)(t)&&(0,o.r)(t.attributeInfo))return t.attributeInfo.attributeData}setAttributeData(e,t){const i=this._nodeId2Meta.get(e);(0,o.r)(i)&&(0,o.r)(i.attributeInfo)&&(i.attributeInfo.attributeData=t,this._attributeValuesChanged(i))}async updateAttributes(e,t,i){const r=this._nodeId2Meta.get(e);(0,o.r)(r)&&(await this.attributeOverrides.apply(r.featureIds,t,i),r.attributeInfo=t,this._attributeValuesChanged(r))}_attributeValuesChanged(e){e.cachedRendererVersion=this._getInvalidRendererVersion(),e.filteredIds=null,(0,o.r)(this._labeler)&&this._labeler.setNodeMetaAttributes(e,((e,t)=>this._createAttributes(e,t))),this._updateEngineObject(e)}clearMemCache(){(0,o.r)(this._memCache)&&this._memCache.clear()}getVisibleNodes(){const e=new Array;return this._nodeId2Meta.forEach((t=>(0,o.r)(t)&&e.push(t.node))),e}getLoadedNodeIndices(e){this._nodeId2Meta.forEach(((t,i)=>e.push(i))),this._nodeId2MetaReloading.forEach(((t,i)=>e.push(i)))}preLoadBasis(){!(0,o.c)("disable-feature:i3s-basis")&&0!=(2&this.supportedTextureEncodings)&&(0,o.x)(this.i3slayer.textureSetDefinitions,(e=>e.some((e=>e.formats.some((e=>"basis"===e.format||"ktx2"===e.format))))))&&(0,N.bQ)()}_getVertexBufferLayout(e,t){const i={hasTexture:Te(e.params.material),hasNormals:t.normal,hasRegions:t.uvRegion};return(0,V.t)((0,w.F)(this._getGeometryParameters(i)))}_getObjectIdField(){return this.i3slayer.objectIdField||"OBJECTID"}_findGraphicNodeAndIndex(e){const t=(0,k.n)(this.i3slayer.fieldsIndex,e.attributes,this._getObjectIdField());let i=null;return(0,l.g)(this._nodeId2Meta,(e=>{if((0,o.t)(e))return!1;const r=e.featureIds.indexOf(t);return-1!==r&&(i={node:e.node,index:r},!0)})),i}_getGraphicIndices(e,t){const i=this._nodeId2Meta.get(e.index);if((0,o.t)(i))return[];const r=[],s=this._getObjectIdField(),n=this.i3slayer.fieldsIndex;for(const e of t){const t=(0,k.n)(n,e.attributes,s),a=i.featureIds.indexOf(t);-1!==a&&r.push(a)}return r}whenGraphicBounds(e){const t=this._findGraphicNodeAndIndex(e);if(!t)return Promise.reject();const i=this._nodeId2Meta.get(t.node.index);if((0,o.t)(i))return Promise.reject();const r=i.objectHandle,s=U(t.index,this._collection,r,new Float64Array(24)),n=this.view.renderSpatialReference,a=this.view.spatialReference;if((0,_.x)(s,n,0,s,a,0,8)){const e=(0,x.B)();return(0,x.M)(e,s,0,8),Promise.resolve({boundingBox:e,screenSpaceObjects:[]})}}whenGraphicAttributes(e,t){return(0,O.n)(this.i3slayer,e,this._getObjectIdField(),t,(()=>[...this._nodeId2Meta.values()].filter(o.r)))}getGraphicFromIntersectorMetadata(e){if(null==e.nodeIndex||null==e.componentIndex)return null;const t=this._nodeId2Meta.get(e.nodeIndex);return(0,o.t)(t)||null==t.featureIds||e.componentIndex>=t.featureIds.length?null:this._createGraphic(e.componentIndex,t)}_getCacheKey(e){return`${this._layerUrl}/v18/${e.id}${this._cacheKeySuffix}`}_getMemCacheKey(e,t=this.elevationOffset){return e+"#"+t}get _idbCacheEnabled(){return!this._controller.disableIDBCache&&0===this._modifications.length&&0===this.elevationOffset&&null!=this._cacheKeySuffix}loadCachedGPUData(e){return(0,o.r)(this._memCache)?this._memCache.pop(this._getMemCacheKey(e.index)):null}deleteCachedGPUData(e){(0,o.r)(e)&&this._deleteComponentObject(e)}_cacheGPUData(e,t=this.elevationOffset){if((0,o.t)(this._memCache))return void this._deleteComponentObject(e);const i=this._controller.indexDepth-e.node.level;this._memCache.put(this._getMemCacheKey(e.node.index,t),e,e.node.memory,i)}loadMissingTextures(e,t,i,r){const s=e.filter(((e,i)=>{if(0==(e.usage&this.rendererTextureUsage))return!1;if((0,o.t)(t))return!0;const r=(0,v.C)(e.encodings,this.supportedTextureEncodings),s=t[i];return!!((0,o.t)(s)||null==s.data||r&&s.encoding!==r.encoding)}));return 0===s.length?Promise.resolve(!1):i(s,r).then((i=>{let r=0;for(let s=0;s<e.length;s++)r<i.length&&i[r].id===e[s].id&&(t[s]=i[r],r++);return!0}))}loadCachedNodeData(e,t,i){return this._idbCacheEnabled?this._idbCache.get(this._getCacheKey(e),t).then((r=>null==r?null:r.nodeVersion!==e.version?(this._idbCache.remove(this._getCacheKey(e)),null):(e.geometryObb=r.geometryObb,this.loadMissingTextures(r.requiredTextures,r.textureData,i,t).then((i=>(i&&this._idbCache.initialized&&(0,o.r)(r.textureData)&&(r.byteSize=Fe(r.transformedGeometry,r.textureData),r.textureData.every(Ee)&&Ae(e,r)&&this._idbCache.put(this._getCacheKey(e),r).catch((t=>ge.warn(`Failed to update node with textures in IndexedDB cache: ${e.id}: ${t}`)))),(0,h.a)(t),r)))))):Promise.resolve(null)}addNode(e,t,i){return function(e){return"geometryData"in e}(t)?this._addData(e,t.attributeDataInfo,(()=>this._transformNode(e,t,i).then((r=>this._safeReschedule((()=>{if((0,o.t)(r))return e.hasModifications=!1,this._addCachedNodeData(e,null,i);e.hasModifications=r.transformedGeometry.hasModifications;const{obb:s,componentOffsets:n,featureIds:a,transformedGeometry:l}=r,h=this._controller.crsIndex,u=this.view.renderSpatialReference,c=(0,O.a)(e.mbs,this.elevationOffset,h,u);e.geometryObb=(0,w.D)([s.center.x,s.center.y,s.center.z],[s.extents.x,s.extents.y,s.extents.z],[s.orientation.x,s.orientation.y,s.orientation.z,s.orientation.w]),(0,m.I)(e.geometryObb.center,e.geometryObb.center,c),t.geometryData.componentOffsets=n,a&&(t.geometryData.featureIds=Array.prototype.slice.call(a));const d={nodeVersion:e.version,geometryData:t.geometryData,requiredTextures:t.requiredTextures,textureData:t.textureData,transformedGeometry:l,globalTrafo:c,geometryObb:e.geometryObb,byteSize:Fe(l,t.textureData)};if(this._idbCacheEnabled&&this._idbCache.initialized&&Ae(e,d)){const t=(0,o.r)(d.textureData)?d.textureData.map((e=>Ee(e)?e:null)):null;this._idbCache.put(this._getCacheKey(e),{...d,textureData:t}).catch((t=>ge.warn(`Failed to store node in IndexedDB cache: ${e.id}: ${t}`)))}return this._addCachedNodeData(e,d,i)}),i))))):Promise.reject()}computeVisibilityObb(e){return(0,O.C)(e,this.view.renderSpatialReference,this._controller.crsIndex,this.i3slayer.spatialReference,this.elevationOffset,this._modifications)}_transformNode(e,t,i){const r=t.geometryData.geometries,s=new Array(r.length);for(let e=0;e<r.length;++e)s[e]=this._getVertexBufferLayout(r[e],t.geometryDescriptor);const n=e.mbs,a=this.elevationOffset,l=this._controller.crsIndex,h=this._controller.crsVertex,u=this.view.renderSpatialReference,c=(0,O.c)(n,a,l),d=(0,O.a)(n,a,l,u),p=(0,_.t)(l,h),f=(0,_.t)(h,u);if((0,o.t)(p)||(0,o.t)(f))return Promise.resolve(null);const y={context:this.i3slayer.uid,geometryBuffer:t.geometryBuffer,geometryData:t.geometryData,geometryDescriptor:t.geometryDescriptor,layouts:s,localOrigin:c,globalTrafo:d,mbs:n,obb:e.serviceObb,elevationOffset:a,needNormals:!this._isIntegratedMesh&&this._controller.isMeshPyramid,normalReferenceFrame:this.i3slayer.normalReferenceFrame||"none",indexToVertexProjector:p,vertexToRenderProjector:f};return this._worker.invoke(y,i)}get supportsNodeCrossFading(){var e,t;return!(null!=(e=this.view)&&null!=(t=e._stage)&&t.renderView.has(3))}get nodeCrossfadingEnabled(){return this.supportsNodeCrossFading&&(this.lodCrossfadeinDuration>0||this.lodCrossfadeoutDuration>0||this.lodCrossfadeUncoveredDuration>0)}get nodeFadeoutEnabled(){return this.supportsNodeCrossFading&&this.lodCrossfadeoutDuration>0}_setNewNodeOpacity(e){const t=this.nodeCrossfadingEnabled?0:this.fullOpacity;this._setNodeOpacity(e,t)}addCachedGPUData(e,t,i){if(e.geometryObb=(0,w.H)(this._collection.getComponentObb(t.objectHandle)),!this._controller.isGeometryVisible(e))return void this._cacheGPUData(t);(0,o.r)(this._labeler)&&this._addMetaToLabeler(this._labeler,t);const r=e.index;this._addNodeMeta(r,t),this.updateNodeState(r,i),this._collection.setObjectVisibility(t.objectHandle,!0),this._updateMaterial(t),this._setNewNodeOpacity(t),this._updateEngineObject(t),this._highlights.objectCreated(t),(0,o.r)(this._treeDebugger)&&this._treeDebugger.update()}addCachedNodeData(e,t,i,r){return this._addData(e,i,(()=>this._addCachedNodeData(e,t,r)))}async _addCachedNodeData(e,t,i){if(this.suspended||!this._controller.isGeometryVisible(e))return void this._removeNodeStageData(e.index,this.elevationOffset,this._nodeId2MetaReloading);if((0,o.t)(t))return void this._addNodeMeta(e.index,null);const r=this._addTasks.get(e.index),{geometryData:s,transformedGeometry:n,globalTrafo:a}=t;await this.attributeOverrides.apply(s.featureIds,r.attributeInfo,i);const h=(0,o.r)(t.textureData)?t.textureData.filter((e=>(0,o.r)(e)&&0!=(e.usage&this.rendererTextureUsage))):[];!(0,o.c)("disable-feature:i3s-basis")&&h.some((e=>(0,o.r)(e)&&(2===e.encoding||1===e.encoding)))&&await(0,N.bQ)(),e.memory=0;const{componentOffsets:u,geometries:c,featureIds:d}=s,g=this._collection,x=c[0],{layout:v,indices:b,interleavedVertexData:w,positionData:S,hasColors:I}=n,C=this._materialParameters(x,v),M=u||new Uint32Array([0,b?b.length:w.byteLength/v[0].stride]),T={vertices:{data:w,count:w.byteLength/v[0].stride,layoutParameters:C.geometryParams},positionData:{positions:S.data,indices:S.indices},indices:b,componentOffsets:M},E=x.transformation?(0,y.r)(x.transformation):(0,y.e)();(0,f.e)(E,a,E);const F=(0,f.y)((0,m.n)(),E),A=(0,p.a)((0,l.a0)(),E),R=this.view.renderSpatialReference,P=this.view.basemapTerrain.spatialReference,L=(0,m.n)(),D=[1,1,1];(0,_.F)(F,R,D,P),(0,_.w)(F,R,L,P);const O=g.createObject({toMapSpace:[L[0],L[1],D[0],D[1]],geometry:T,obb:(0,o.f)(e.geometryObb),transform:{position:F,rotationScale:A},visible:!1}),k=2===C.geometryParams.textureCoordinates,V=this._initMaterialAndTextures(O,C.material,h,k);e.memory+=this.memEstimateGeometryAdded(O),e.memory+=V.reduce(((e,t)=>e+((0,o.r)(t)?this.memEstimateTextureAdded(t):0)),0);const U=!!C.material.hasParametersFromSource,G="blend"!==C.material.alphaMode&&C.material.metallicRoughness.baseColorFactor[3]>=1,z=new xe(e,d,O,this._getInvalidRendererVersion(),r.attributeInfo,{hasParametersFromSource:U,isOpaque:G},V);r.meta=z,!this._hasTextures&&t.requiredTextures.some((({usage:e})=>0!=(19&e)))&&(this._hasTextures=!0),this._hasData=!0,this._hasColors=this._hasColors||I,this._hasTextures=this._hasTextures||!!e.resources.texture,this.notifyChange("hasTexturesOrVertexColors");const B=this.slicePlaneEnabled;return this._addOrUpdateEdgeRendering(z).then((t=>((0,o.r)(t)&&t.updateObjectVisibility(z.objectHandle,!1),this._safeReschedule((()=>{const i=this._addTasks.get(e.index);if(!i)return;if((0,o.r)(this._labeler)&&this._addMetaToLabeler(this._labeler,z),this._addNodeMeta(e.index,z),i.meta=null,this.suspended)return void this._removeNodeStageData(e.index,this.elevationOffset);g.setObjectVisibility(O,!0),(0,o.r)(t)&&t.updateObjectVisibility(z.objectHandle,!0),z.attributeInfo=i.attributeInfo;const r=z.cachedRendererVersion!==this._rendererVersion,s=B!==this.slicePlaneEnabled;this._setObjectSymbolColors(z);const n=this._applyFiltersToNode(z);(r||(0,o.r)(t)&&(s||n))&&this._addOrUpdateEdgeRendering(z),this._visibleGeometryChanged(z),this._highlights.objectCreated(z),this._updateMaterial(z),this._setNewNodeOpacity(z),(0,o.r)(this._treeDebugger)&&this._treeDebugger.update()}),i)))).catch((e=>{throw(0,o.r)(r.meta)&&(this._deleteComponentObject(r.meta),r.meta=null),e}))}_addNodeMeta(e,t){if(this._removeNodeStageData(e,this.elevationOffset,this._nodeId2MetaReloading),this._nodeId2Meta.has(e)){ge.error("Removing duplicated node");const t=this._nodeId2Meta.get(e);(0,o.r)(t)&&this._deleteComponentObject(t)}(0,o.r)(t)&&(t.lodCrossfadeProgress=null,this.nodeCrossfadingEnabled&&Pe(t.cachedEdgeMaterials,0)),this._nodeId2Meta.set(e,t)}_safeReschedule(e,t){return(0,h.a)(t),this._controller.reschedule(e,t)}_materialParameters(e,t){const i=e.params.material,r=t.some((e=>"uvRegion"===e.name)),s=t.some((e=>"normalCompressed"===e.name)),n=Te(i);return{geometryParams:this._getGeometryParameters({hasTexture:n,hasNormals:s,hasRegions:r}),material:i}}_initMaterialAndTextures(e,t,i,r){const s=this._stage.renderView,n=i.map((e=>(0,v.f)(e,t,r,s)));for(const e of n)(0,o.r)(e)&&this._stage.add(e);return this._collection.updateMaterial(e,(e=>{(0,v.F)(e,t,n,i,this.view._stage.renderView.textureRepository,{rendererTextureUsage:this.rendererTextureUsage,usePBR:this._usePBR(),isIntegratedMesh:this._isIntegratedMesh,slicePlaneEnabled:this.slicePlaneEnabled,viewSpatialReference:this.view.spatialReference}),this._updateMaterialOverlay(e)})),n}_getGeometryParameters(e){return{textureCoordinates:e.hasTexture?e.hasRegions?2:1:0,colors:this._hasVertexColors,normals:e.hasNormals&&!this._isIntegratedMesh}}_addData(e,t,i){let r=this._addTasks.get(e.index);return r?r.attributeInfo=t:(r={...(0,h.D)(),attributeInfo:t,meta:null},this._addTasks.set(e.index,r),i().then(r.resolve,r.reject).then((()=>this._addTasks.delete(e.index))).catch((t=>{throw this._addTasks.delete(e.index),t}))),r.promise}_clearAddTasks(){this._addTasks.forEach((e=>{(0,o.r)(e.meta)&&(this._deleteComponentObject(e.meta),e.meta=null)})),this._addTasks.clear()}_clippingAreaChanged(){const e=(0,x.a)();(0,w.I)(this.view.clippingArea,e,this.view.renderSpatialReference)?this._clippingArea=e:this._clippingArea=null,this._filterChange(),this._controller&&this._controller.updateClippingArea(this.view.clippingArea)}_geometryFilterChange(){this._controller.geometryFilterChanged(this.hasGeometryFilter)}get hasGeometryFilter(){return!1}_filterChange(){this._applyFilters(!1)}_applyFilters(e){this._filters=this.getFilters(),e?this._controller&&this._controller.requestUpdate():this._nodeId2Meta.forEach((e=>{(0,o.r)(e)&&this._applyFiltersToNode(e)&&(this._addOrUpdateEdgeRendering(e),this._visibleGeometryChanged(e))}))}getFilters(){const e=[];return this._clippingArea&&e.push(((e,t)=>this._boundingboxFilter(e,t,this._clippingArea))),e}addSqlFilter(e,t,i){if((0,o.r)(t)){const r=t.fieldNames;e.push(((e,s)=>this._sqlFilter(e,s,t,r,i)))}}_sqlFilter(e,t,i,r,s){const n={},a=this._createLayerGraphic(n),l=this.i3slayer.objectIdField,h=t.featureIds,u=(0,o.r)(t.attributeInfo)&&t.attributeInfo.attributeData;r.every((e=>null!=u[e]||e===l))&&(0,O.V)(e,h,(e=>{n[l]=h[e];for(const t of r)t!==l&&(n[t]=(0,O.f)(u[t],e));try{return i.testFeature(a)}catch(e){return s(e),!1}}))}_boundingboxNodeTest(e,t){return(0,_.T)(e.node.mbs,this._controller.crsIndex,Me,this.view.renderSpatialReference),(0,O.r)(t,Me)}_boundingboxFeatureTest(e,t,i){return(0,x.j)(i,this._collection.getComponentAabb(e.objectHandle,t,be))}_boundingboxFilter(e,t,i){const r=this._collection,s=this._boundingboxNodeTest(t,i);if(3===s)return;if(0===s)return void(e.length=0);const n=r.getComponentCount(t.objectHandle);if(n.invisible+n.visible!==t.featureIds.length)return;const a=this._transformAABB(we,i,t.objectHandle);(0,O.V)(e,t.featureIds,(e=>this._boundingboxFeatureTest(t,e,a)))}_transformAABB(e,t,i){const r=this._collection.getObjectTransform(i),s=r.position,n=r.rotationScale;return e[0]=(t[0]-s[0])/n[0],e[1]=(t[1]-s[1])/n[4],e[2]=(t[2]-s[2])/n[8],e[3]=(t[3]-s[0])/n[0],e[4]=(t[4]-s[1])/n[4],e[5]=(t[5]-s[2])/n[8],e}_addOrUpdateEdgeRendering(e,t=!0){if((0,o.t)(this._edgeView))return Promise.resolve(null);const i=e.objectHandle,r=this._edgeView.hasObject(i),{hasEdges:s,perFeatureEdgeMaterials:n}=this._getFilteredEdgeMaterials(e),a={slicePlaneEnabled:this.slicePlaneEnabled};return s?r?(this.nodeCrossfadingEnabled&&Pe(n,this.getNodeOpacity(e)),this._edgeView.updateAllComponentMaterials(i,n,a,t),this._edgeView.updateObjectVisibility(i,!0),Promise.resolve(this._edgeView)):this._collection.addEdges(i,this._edgeView,n,a).then((()=>this._edgeView)):(r&&this._edgeView.removeObject(i),Promise.resolve(null))}_removeEdgeRendering(e){(0,o.r)(this._edgeView)&&this._edgeView.hasObject(e.objectHandle)&&this._edgeView.removeObject(e.objectHandle)}_applyFiltersToNode(e){return!!this._applyFiltersToNodeComponents(e)&&((0,o.r)(this._labeler)&&this._labeler.applyFilterChange(e),!0)}_applyFiltersToNodeComponents(e){const t=this._collection,i=0===t.getComponentCount(e.objectHandle).invisible;if(t.setAllComponentVisibilities(e.objectHandle,"all"),0===this._filters.length)return e.filteredIds=null,!i;if(this._updateCachedFilteredIds(e),e.filteredIds===e.featureIds)return!i;const r=this._computeFilteredComponentIndices(e);return t.setAllComponentVisibilities(e.objectHandle,r),!0}_updateCachedFilteredIds(e){null!=e.filteredIds&&e.appliedFilters===this._filters||(e.filteredIds=this._computeFilteredIds(e),e.appliedFilters=this._filters)}_computeFilteredIds(e){const t=e.featureIds.slice();for(const i of this._filters)if(i(t,e),0===t.length)break;return t.length===e.featureIds.length?e.featureIds:t}_computeFilteredComponentIndices(e){const t=new Array;return e.featureIds.forEach(((i,r)=>{e.filteredIds[t.length]===i&&t.push(r)})),t}_removeAllNodeDataFromStage(e=this.elevationOffset){this._nodeId2Meta.forEach(((t,i)=>this._removeNodeStageData(i,e))),this._nodeId2MetaReloading.forEach(((t,i)=>this._removeNodeStageData(i,e,this._nodeId2MetaReloading)))}removeNode(e){const t=this.elevationOffset;this._removeNodeStageData(e,t),this._removeNodeStageData(e,t,this._nodeId2MetaReloading)}_removeNodeStageData(e,t,i=this._nodeId2Meta){const r=i.get(e);(0,o.t)(r)?i.delete(e):(this._collection.setObjectVisibility(r.objectHandle,!1),this._visibleGeometryChanged(r),this._removeEdgeRendering(r),(0,o.r)(this._labeler)&&this._labeler.removeNodeMeta(r),i.delete(e),this._highlights.objectDeleted(r),i===this._nodeId2Meta?(this._cacheGPUData(r,t),this.nodeCrossfadingEnabled&&this._crossfadeHelper.stopNodeFading(r)):this._deleteComponentObject(r),(0,o.r)(this._treeDebugger)&&this._treeDebugger.update())}_deleteComponentObject(e){if((0,o.r)(this._edgeView)&&this._edgeView.removeObject(e.objectHandle),this.memEstimateGeometryRemoved(e.objectHandle),this._collection.destroyObject(e.objectHandle),e.textures)for(const t of e.textures)this.memEstimateTextureRemoved(t),this._stage.remove(t)}updateNodeState(e,t){const i=this._nodeId2Meta.get(e);(0,o.r)(i)&&this._collection.updateMaterial(i.objectHandle,(e=>e.polygonOffsetEnabled=0===t))}_invalidateAllSymbols(){this._rendererVersion=(0,O.z)(this._rendererVersion,1),this._controller&&this._controller.requestUpdate()}_getInvalidRendererVersion(){return(0,O.z)(this._rendererVersion,-1)}async _rendererChange(e){if(this._currentRenderer=e,this.notifyChange("rendererTextureUsage"),this._rendererVersion=(0,O.z)(this._rendererVersion,1),this._rendererFields=null,this._colorVariable=null,this._opacityVariable=null,this._invalidateAllSymbols(),e&&(this._rendererFields=await e.getRequiredFields(this.i3slayer.fieldsIndex)),this._updateSymbologyFields(),!this._arcade&&e&&"arcadeRequired"in e&&e.arcadeRequired&&(this._arcade=await(0,b.a)()),e&&"visualVariables"in e&&e.visualVariables)for(const t of e.visualVariables)"color"===t.type?this._colorVariable=t:"opacity"===t.type?this._opacityVariable=t:ge.warn(`Unsupported visual variable type for 3D Object Scene Services: ${t.type}`);if(e)for(const t of e.getSymbols())"mesh-3d"!==t.type&&ge.error(`Symbols of type '${t.type}' are not supported for 3D Object Scene Services.`);this._controller&&this._controller.requestUpdate()}_getCachedEdgeMaterials(e){return this._hasSymbolColors&&e.cachedRendererVersion!==this._rendererVersion&&this._updateCachedRendererData(e),e.cachedEdgeMaterials}_getSymbolColors(e){this._hasSymbolColors&&e.cachedRendererVersion!==this._rendererVersion&&this._updateCachedRendererData(e);const t=e.cachedSymbology;return(e,i)=>{const r=5*e;(0,g.r)(i.externalColor,t[r+0]/255,t[r+1]/255,t[r+2]/255,t[r+3]/255),i.externalColorMixMode=15&t[r+4],i.castShadows=0!=(16&t[r+4]),i.pickable=0!=(32&t[r+4])}}_getSymbolInfo(e,t){const i=e&&e.getSymbol(t,{arcade:this._arcade});if(!(i instanceof C.A))return null;const r=i.id;if(this._symbolInfos.has(r))return this._symbolInfos.get(r);const s=(0,O.k)(i);return this._symbolInfos.set(r,s),s}_setSymbologyOverride(e,t){this._symbologyOverride!==e&&(this._symbologyOverride=e,this._symbologyOverrideFields=t,this._invalidateAllSymbols(),this._updateSymbologyFields())}_updateSymbologyFields(){this._symbologyFields=(0,o.r)(this._symbologyOverrideFields)&&this._symbologyOverrideFields.length>0?(0,o.r)(this._rendererFields)&&this._rendererFields.length>0?(0,b.p)(this.i3slayer.fieldsIndex,[...this._rendererFields,...this._symbologyOverrideFields]):this._symbologyOverrideFields:this._rendererFields}_updateCachedRendererData(e){if(e.cachedRendererVersion=this._rendererVersion,!this._hasSymbolColors)return;const t=this._tmpAttributeOnlyGraphic,i={};t.attributes=i;const r=this._currentRenderer,s=(0,o.r)(e.attributeInfo)&&e.attributeInfo.attributeData,n=null!=e.featureIds?this.i3slayer.objectIdField:null,a=null!=s&&(0,o.r)(this._symbologyFields)&&this._symbologyFields.length>0,l=a?[]:null,h=a?[]:null;if(a&&(0,o.r)(this._symbologyFields))for(const e of this._symbologyFields){const t=s[e];t&&(l.push(e),h.push(t))}e.cachedSymbology||(e.cachedSymbology=new Uint8Array(5*e.featureIds.length));const u={color:Ie,castShadows:!0,pickable:!0,colorMixMode:1,edgeMaterial:null},c=this.fullOpacity,d=this.nodeCrossfadingEnabled?this.getNodeOpacity(e):c;let p=null,f=2,y=O.q,m=0;for(let s=0;s<e.featureIds.length;s++){if(null!=n&&(i[n]=e.featureIds[s]),a)for(let e=0;e<l.length;e++)i[l[e]]=(0,O.f)(h[e],s);const c=this._getSymbolInfo(r,t);let g=null,_=null;if(r&&"visualVariables"in r){if(this._colorVariable){const e=(0,I.getColor)(this._colorVariable,t,{color:Ce,arcade:this._arcade});e&&(g=Ie,g[0]=e.r/255,g[1]=e.g/255,g[2]=e.b/255,this._opacityVariable||null===e.a||(_=e.a))}this._opacityVariable&&(_=(0,I.getOpacity)(this._opacityVariable,t,{arcade:this._arcade}))}if(c&&c.material){const e=c.material;g=(0,o.t)(g)||(0,o.t)(_)?(0,w.J)(g,_,e.color,e.alpha,_e,Ie):(0,w.J)(g,_,null,null,_e,Ie)}if((0,o.t)(g)&&(g=Ie,g[0]=1,g[1]=1,g[2]=1,g[3]=1),u.pickable=!0,u.castShadows=!c||c.castShadows,u.colorMixMode=c&&c.material?c.material.colorMixMode:1,u.edgeMaterial=c?c.edgeMaterial:null,(0,o.r)(this._symbologyOverride)&&(u.color=g,this._symbologyOverride(t,u),g=u.color),(0,o.r)(u.edgeMaterial)){const t=g[3]<=0?0:g[3]>=1&&(e.material.isOpaque||3===u.colorMixMode)?2:1;u.edgeMaterial===p&&t===f||(y={...u.edgeMaterial,opacity:d,objectTransparency:t},p=u.edgeMaterial,f=t),e.cachedEdgeMaterials[s]=y}else e.cachedEdgeMaterials[s]=O.q;e.cachedSymbology[m+0]=Math.round(255*g[0]),e.cachedSymbology[m+1]=Math.round(255*g[1]),e.cachedSymbology[m+2]=Math.round(255*g[2]),e.cachedSymbology[m+3]=Math.round(255*g[3]),e.cachedSymbology[m+4]=u.colorMixMode|+u.castShadows<<4|+u.pickable<<5,m+=5}}_getFilteredEdgeMaterials(e){const t=this._getCachedEdgeMaterials(e);if(this.nodeCrossfadingEnabled||Pe(t,this.fullOpacity),(0,o.t)(e.filteredIds))return{hasEdges:t.some((e=>e!==O.q)),perFeatureEdgeMaterials:t};let i=0,r=!1;const s=t.map(((t,s)=>e.featureIds[s]!==e.filteredIds[i]?O.q:(r=r||t!==O.q,i++,t)));return{hasEdges:r,perFeatureEdgeMaterials:s}}_setObjectSymbolColors(e){if(!this._hasSymbolColors)return;const t=e.objectHandle,i=this._getSymbolColors(e);this._collection.setComponentData(t,i),this._stage.renderView.setNeedsRender()}_reloadAll(e=this.elevationOffset){this._removeAllNodeDataFromStage(e),null!=this._controller&&this._controller.restartNodeLoading()}_opacityChange(e){this.nodeCrossfadingEnabled&&this._crossfadeHelper.stopAllNodeFading(),this._nodeId2Meta.forEach((t=>{(0,o.t)(t)||(this._collection.updateMaterial(t.objectHandle,(t=>t.objectOpacity=e)),Pe(t.cachedEdgeMaterials,e),this._updateEdgeRendering(t))}))}_updateMaterial(e){this._collection.updateMaterial(e.objectHandle,(e=>{e.commonMaterialParameters.slicePlaneEnabled=this.slicePlaneEnabled,e.usePBR=this._usePBR(),this._updateMaterialOverlay(e)}))}_updateMaterialOverlay(e){}_updateEngineObject(e){this._setObjectSymbolColors(e),this._applyFiltersToNode(e),this._addOrUpdateEdgeRendering(e),this._visibleGeometryChanged(e)}_slicePlaneEnabledChange(e){this._intersectionHandler&&(this._intersectionHandler.slicePlane=e),(0,o.r)(this._labeler)&&(this._labeler.slicePlaneEnabled=e),this._nodeId2Meta.forEach((t=>{(0,o.t)(t)||(this._collection.updateMaterial(t.objectHandle,(t=>{t.commonMaterialParameters.slicePlaneEnabled=e})),this._updateEdgeRendering(t,!1))}))}_updatePBR(){this._nodeId2Meta.forEach((e=>{(0,o.t)(e)||this._collection.updateMaterial(e.objectHandle,(e=>{e.usePBR=this._usePBR()}))})),this._hasLoadedPBRTextures=!0}_usePBR(){return!this._isIntegratedMesh&&this.view.qualitySettings.physicallyBasedRenderingEnabled}_updateEdgeRendering(e,t=!0){(0,o.r)(this._edgeView)&&this._edgeView.hasObject(e.objectHandle)&&this._addOrUpdateEdgeRendering(e,t)}_forAllNodes(e){this._nodeId2Meta.forEach(e)}_forAllFeatures(e,t,i=0){(0,l.g)(this._nodeId2Meta,(r=>{if((0,o.t)(r))return!1;if((0,o.r)(t))switch(t(r)){case 0:return!0;case 2:return!1}let s=1;switch(i){case 1:s=this._forAllFeaturesOfNode(r,e);break;case 0:s=this._forVisibleFeaturesOfNode(r,e);break;case 2:s=this._forAllFeaturesOfNodeInClippingArea(r,e)}return 0===s}))}_forAllFeaturesOfNode(e,t){let i=1;const r=e.featureIds;for(let s=0;s<r.length;s++)if(i=t(r[s],s,e),0===i)return i;return i}_forVisibleFeaturesOfNode(e,t){let i=1;const r=e.featureIds;return this._collection.forEachVisibleComponent(e.objectHandle,(s=>(i=t(r[s],s,e),1===i))),i}_forAllFeaturesOfNodeInClippingArea(e,t){if(null==this._clippingArea)return this._forAllFeaturesOfNode(e,t);const i=this._boundingboxNodeTest(e,this._clippingArea);if(0===i)return 1;if(3===i)return this._forAllFeaturesOfNode(e,t);const r=e.featureIds,s=e.objectHandle,n=(0,O._)(this._clippingArea,this._collection.getObjectTransform(s));for(let i=0;i<r.length;i++){if(!this._boundingboxFeatureTest(e,i,n))continue;const s=t(r[i],i,e);if(0===s)return s}return 1}_createAttributes(e,t){const i={};null!=t.featureIds&&(i[this._getObjectIdField()]=t.featureIds[e]);const r=(0,o.r)(t.attributeInfo)&&t.attributeInfo.attributeData;if((0,o.r)(r))for(const t of Object.keys(r))i[t]=(0,O.f)(r[t],e);return i}_createGraphic(e,t){return this._createLayerGraphic(this._createAttributes(e,t))}highlight(e){const t=this._highlights;if("number"==typeof e||e instanceof n.h?e=[e]:e instanceof a.L&&(e=e.toArray()),Array.isArray(e)&&e.length>0){if(e[0]instanceof n.h){const i=e,r=this.i3slayer.fieldsIndex,s=this._getObjectIdField(),n=i.map((e=>(0,k.n)(r,e.attributes,s))),{set:a,handle:o}=t.acquireSet();return t.setFeatureIds(a,n),o}if("number"==typeof e[0]){const i=e,{set:r,handle:s}=t.acquireSet();return t.setFeatureIds(r,i),s}}return Re}_visibleGeometryChanged(e){this._elevationProvider&&(this._elevationProvider.objectChanged(e.node),null==this._visibleGeometryChangedSchedulerHandle&&(this._visibleGeometryChangedSchedulerHandle=(0,r.j)((()=>{this.emit("visible-geometry-changed"),this._visibleGeometryChangedSchedulerHandle=null}))))}get performanceInfo(){const e={displayedNumberOfFeatures:0,maximumNumberOfFeatures:0,totalNumberOfFeatures:0,core:null,index:0,nodes:this._nodeId2Meta.size,"Total GPU Memory Estimate":(this.gpuMemoryEstimate/1048576).toFixed(1)+"MB","Geometry Memory Estimate":(this.geoMemoryEstimate/1048576).toFixed(1)+"MB","Texture Memory Estimate":(this.texMemoryEstimate/1048576).toFixed(1)+"MB","Unloaded Memory Estimate":(this.getUnloadedMemory()/1048576).toFixed(1)+"MB",...this._collection?this._collection.performanceInfo:{shown:0,hidden:0}};return(0,o.r)(this._memCache)&&(e.MemCache=Math.round(100*this._memCache.hitRate)+"% hit"),this._controller&&(this._idbCacheEnabled&&(e.IDBCache=Math.round(100*this._idbCache.getHitRate())+"% hit"),this._controller.updateStats(e)),e}get test(){const e=this;return{controller:this._controller,labeler:this._labeler,get visibleObjectIds(){const t=[];return e._forAllFeatures((e=>(t.push(e),1)),null,0),t.sort(((e,t)=>e-t)),t},get numNodes(){return e._nodeId2Meta.size}}}getNodeOpacityByIndex(e){const t=this._nodeId2Meta.get(e);return this.getNodeOpacity(t)}getNodeOpacity(e){return(0,o.r)(e)?this._collection.getMaterial(e.objectHandle).objectOpacity:0}isNodeFullyFadedIn(e){return this._crossfadeHelper.isNodeFullyFadedIn(e)}getNodeCrossfadeMetaData(e){return this._nodeId2Meta.get(e)}markNodeToRemove(e){this._controller&&this._controller.markNodeToRemove(e)}removeMarkedNodes(){this._controller&&this._controller.removeMarkedNodes()}foreachCrossfadeNode(e){this._nodeId2Meta.forEach(((t,i)=>e(i,t)))}fadeNode(e,t,i){if(!this.nodeCrossfadingEnabled)return;const r=this._nodeId2Meta.get(e);(0,o.r)(r)&&this._crossfadeHelper.fadeNode(e,r,t,i)}setNodeOpacityByIndex(e,t){const i=this._nodeId2Meta.get(e);(0,o.r)(i)&&this._setNodeOpacity(i,t)}_setNodeOpacity(e,t){this._collection.updateMaterial(e.objectHandle,(e=>e.objectOpacity=t)),this._setNodeEdgeOpacity(e,t)}_setNodeEdgeOpacity(e,t){if(!(0,o.r)(this._edgeView)||!e.cachedEdgeMaterials)return;Pe(e.cachedEdgeMaterials,t);const i=e.objectHandle;this._edgeView.hasObject(i)&&this._edgeView.updateAllComponentOpacities(i,t)}get _hasModifications(){return this._modifications&&this._modifications.length>0}updateNodeModificationStatus(e){const t=e.length;if(!this._hasModifications||t<=0||!0!==this._i3sWasmLoaded)return;const i=this.i3slayer.uid,r=function(e){if(0===e.length)return null;const t=10*e.length,i=new Float64Array(t);return e.forAll(((e,t)=>{let r=e.serviceObb;(0,o.t)(r)&&(r=Se,(0,m.h)(r.center,e.mbs),r.halfSize[0]=r.halfSize[1]=r.halfSize[2]=e.mbs[3]);const s=10*t;i[s+0]=r.center[0],i[s+1]=r.center[1],i[s+2]=r.center[2],i[s+3]=r.halfSize[0],i[s+4]=r.halfSize[1],i[s+5]=r.halfSize[2],i[s+6]=r.quaternion[0],i[s+7]=r.quaternion[1],i[s+8]=r.quaternion[2],i[s+9]=r.quaternion[3]})),i}(e);if((0,o.r)(r)){const t={context:i,buffer:r.buffer};(0,L.filterObbsForModificationsSync)(t);const s=new Float64Array(r.buffer);e.forAll(((e,t)=>{const i=s[t],r=(0,L.interpretObbModificationResults)(i);e.imModificationImpact=r,0!==r&&this._controller.invalidateGeometryVisibility(e.index)}))}}notifyUpdate(){this.notifyChange("updating")}notifyLODUpdate(){this._controller.notifyLODUpdate()}isUpdating(){return!(!this._controller||!this._controller.updating)||!!this._visibleGeometryChangedSchedulerHandle||(0,o.r)(this._labeler)&&this._labeler.updating||this._crossfadeHelper.updating||this._i3sWasmLoaded instanceof Promise||this._asyncModuleLoading>0}};return s.lastIndex=0,(0,r.e)([(0,d.y)()],s.prototype,"_hasLoadedPBRTextures",void 0),(0,r.e)([(0,d.y)()],s.prototype,"_asyncModuleLoading",void 0),(0,r.e)([(0,d.y)()],s.prototype,"_visibleGeometryChangedSchedulerHandle",void 0),(0,r.e)([(0,d.y)()],s.prototype,"view",void 0),(0,r.e)([(0,d.y)()],s.prototype,"i3slayer",void 0),(0,r.e)([(0,d.y)()],s.prototype,"_controller",void 0),(0,r.e)([(0,d.y)()],s.prototype,"_labeler",void 0),(0,r.e)([(0,d.y)()],s.prototype,"updating",void 0),(0,r.e)([(0,d.y)()],s.prototype,"suspended",void 0),(0,r.e)([(0,d.y)()],s.prototype,"holeFilling",void 0),(0,r.e)([(0,d.y)(w.z)],s.prototype,"updatingProgress",void 0),(0,r.e)([(0,d.y)({readOnly:!0,aliasOf:"_controller.updatingProgress"})],s.prototype,"updatingProgressValue",void 0),(0,r.e)([(0,d.y)({readOnly:!0})],s.prototype,"hasTexturesOrVertexColors",null),(0,r.e)([(0,d.y)({readOnly:!0})],s.prototype,"rendererTextureUsage",null),(0,r.e)([(0,d.y)({readOnly:!0})],s.prototype,"elevationOffset",null),(0,r.e)([(0,d.y)({type:Boolean})],s.prototype,"slicePlaneEnabled",void 0),(0,r.e)([(0,d.y)()],s.prototype,"supportedTextureEncodings",null),(0,r.e)([(0,d.y)()],s.prototype,"uncompressedTextureDownsamplingEnabled",null),(0,r.e)([(0,d.y)({type:[S.f]})],s.prototype,"_modifications",void 0),s=t=(0,r.e)([(0,d.n)("esri.views.3d.layers.I3SMeshView3D")],s),s},be=(0,x.a)(),we=(0,x.a)(),Se=(0,w.D)(),Ie=[0,0,0,0],Ce=new s.o([0,0,0,0]),Me=[0,0,0,0];function Te(e){const t=e.metallicRoughness;return t&&t.baseColorTextureId>=0||t&&t.metallicRoughnessTextureId>=0||e.normalTextureId>=0||e.emissiveTextureId>=0||e.occlusionTextureId>=0}function Ee(e){return(0,o.r)(e)&&(0,o.J)(e.data)}function Fe(e,t){let i=1024+e.interleavedVertexData.byteLength+(e.indices?e.indices.byteLength:0)+e.positionData.data.byteLength+e.positionData.indices.byteLength;if((0,o.r)(t))for(const e of t)(0,o.r)(e)&&(0,o.J)(e.data)&&(i+=e.data.byteLength);return i}function Ae(e,t){return t.byteSize>104857600?(ge.warn(`Node is too big to store in IndexedDB cache: ${e.id} (${t.byteSize} bytes)`),!1):t.byteSize>0}const Re={remove(){},pause(){},resume(){}};function Pe(e,t){e.forEach((e=>e.opacity=t))}},15876:(e,t,i)=>{"use strict";i.d(t,{d:()=>z,k:()=>F,n:()=>B,y:()=>Z}),i(33807);var r=i(78155),s=i(80987),n=i(80219),a=i(65352),o=i(36845),l=i(88903),h=i(60816),u=i(54622),c=i(7571),d=i(53185),p=i(58404),f=i(20736),y=i(47122),m=i(31393),g=i(92858),_=i(20215),x=i(83731),v=i(98548),b=i(55807),w=i(52737),S=i(18143),I=i(83618),C=i(91728),M=i(79679);const T=n.n.getLogger("esri.views.3d.layers.i3s.I3SMeshViewFilter");let E,F=class extends r.p{constructor(e){super(e),this._projectionEngineLoaded=!1}initialize(){(0,o.j)(this,"filter.geometry").then((()=>this.loadAsyncModule(async function(){return!!E||(E=await Promise.all([i.e(1337),i.e(9351)]).then(i.bind(i,13263))),E}().then((e=>{this.destroyed||(this._geometryEngine=e,this.applyFilters())})))))}get sortedObjectIds(){if((0,n.t)(this.filter.objectIds))return null;const e=new Float64Array(this.filter.objectIds);return e.sort(),e}get parsedWhereClause(){const e=(0,n.r)(this.filter)?this.filter.where:null;if((0,n.t)(e)||!e)return null;try{return u.WhereClause.create(e,this.layerFieldsIndex)}catch(e){T.error(`Failed to parse filter where clause: ${e}`)}return null}addFilters(e,t,i,r){const s=this.sortedObjectIds;(0,n.r)(s)&&e.push((e=>(0,y.X)(s,!0,e))),this.addSqlFilter(e,this.parsedWhereClause);const a=this.parsedGeometry;if((0,n.r)(a)){const s=this.spatialRelationship;e.push(((e,n)=>function(e,t,i,r,s,n,a){const o=n[0].spatialReference||r.spatialReference;if(!(0,c.T)(t.node.mbs,s,P,o))return void T.warnOnce("SceneLayerView.filter.geometry is using unsupported SpatialReference, skipping geometry filter");const l=L(P,o),h=function(e,t,i,r,s){const n=t.renderSpatialReference,a=new Map,o={rings:[[[0,0,0],[0,0,0],[0,0,0],[0,0,0]]],hasZ:!1,hasM:!1,type:"polygon",spatialReference:i};o.rings[0][3]=o.rings[0][0];let l,h;switch(e){case"intersects":l=(e,t)=>E.intersects(e,t)?0:2,h=N;break;case"contains":l=(e,t)=>E.contains(e,t)?2:1,h=N;break;case"disjoint":default:l=(e,t)=>E.disjoint(e,t)?2:1,h=O}return{collection:r,object:s,type:e,maskSR:i,renderSR:n,aabbCache:a,triangle:o,positions:{indices:null,data:null,stride:0,startIndex:0,endIndex:0},triangleTest:l,geometryTest:h}}(a,r,o,i,t.objectHandle);for(const i of n){if(0===e.length)return;switch(D(i,l,a)){case 1:return void(e.length=0);case 0:continue}(0,y.V)(e,t.featureIds,(e=>k(i,e,h)))}}(e,n,r,t,i,a,s)))}}isMBSGeoemtryVisible(e,t,i){const r=this.parsedGeometry;if((0,n.r)(r)){const s=this.spatialRelationship,n=r[0].spatialReference||t;return(0,c.T)(e,i,P,n)?function(e,t,i,r){const s=L(e,i);return t.every((e=>1!==D(e,s,r)))}(P,r,n,s):(T.warnOnce("SceneLayerView.filter.geometry is using unsupported SpatialReference, skipping geometry filter for MBS"),!0)}return!0}get parsedGeometry(){if((0,n.t)(this.filter))return null;if(!this._geometryEngine)return null;const{geometry:e}=this.filter;if((0,n.t)(e))return null;const{distance:t,units:i}=this.filter,r=this.spatialRelationship,s="mesh"===e.type?e.extent:e;if((0,n.t)(t)||0===t)return R(s,r);const o=i||(0,a.L)(s.spatialReference);if(s.spatialReference.isWGS84)return R(this._geometryEngine.geodesicBuffer(s,t,o),r);if((0,f.x)(s,g.k.WGS84))return R((0,f.g)(this._geometryEngine.geodesicBuffer((0,f.g)(s,g.k.WGS84),t,o),s.spatialReference),r);if(!this._projectionEngineLoaded&&(this.loadAsyncModule((0,c.D)().then((()=>this._projectionEngineLoaded=!0))),!this._projectionEngineLoaded))return null;let l=null;try{l=(0,c.H)(s,g.k.WGS84)}catch(e){}if(l)try{l=(0,c.H)(this._geometryEngine.geodesicBuffer(l,t,o),s.spatialReference)}catch(e){l=null}return l||T.error(`Filter by geodesic buffer (distance) unsupported, failed to project input geometry (${s.spatialReference.wkid}) to WGS84.`),R(l,r)}get spatialRelationship(){return(0,n.r)(this.filter)?this.filter.spatialRelationship:"intersects"}static checkSupport(e){return e.timeExtent?(T.warn("Filters with a timeExtent are not supported for mesh scene layers"),!1):!!function(e){return null!=e&&A.indexOf(e)>=0}(e.spatialRelationship)||(T.warn(`Filters with spatialRelationship other than ${A.join(", ")} are not supported for mesh scene layers`),!1)}};(0,r.e)([(0,l.y)({type:m.y})],F.prototype,"filter",void 0),(0,r.e)([(0,l.y)()],F.prototype,"layerFieldsIndex",void 0),(0,r.e)([(0,l.y)()],F.prototype,"loadAsyncModule",void 0),(0,r.e)([(0,l.y)()],F.prototype,"applyFilters",void 0),(0,r.e)([(0,l.y)()],F.prototype,"addSqlFilter",void 0),(0,r.e)([(0,l.y)({readOnly:!0})],F.prototype,"sortedObjectIds",null),(0,r.e)([(0,l.y)({readOnly:!0})],F.prototype,"parsedWhereClause",null),(0,r.e)([(0,l.y)({readOnly:!0})],F.prototype,"parsedGeometry",null),(0,r.e)([(0,l.y)({readOnly:!0})],F.prototype,"spatialRelationship",null),(0,r.e)([(0,l.y)()],F.prototype,"_projectionEngineLoaded",void 0),(0,r.e)([(0,l.y)()],F.prototype,"_geometryEngine",void 0),F=(0,r.e)([(0,l.n)("esri.views.3d.layers.i3s.I3SMeshViewFilter")],F);const A=["contains","intersects","disjoint"];function R(e,t){if(!e)return null;if("disjoint"===t&&"polygon"===e.type){const t=new Array(e.rings.length);for(let i=0;i<e.rings.length;++i){const r=(0,p.u)(1/0,1/0,-1/0,-1/0);(0,p.m)(r,e.rings[i]),t[i]={type:"polygon",rings:[e.rings[i]],spatialReference:e.spatialReference,aabr:r}}t.sort(((e,t)=>e.aabr[0]-t.aabr[0]));const i=new Set,s=new r.V;for(let e=0;e<t.length;++e){const n=t[e];for(let r=e+1;r<t.length;++r){const e=t[r];if(e.aabr[0]>=n.aabr[2])break;i.add(e)}i.forEach((e=>{if(n!==e)if(e.aabr[2]<=n.aabr[0])i.delete(e);else if(E.intersects(n,e)){n.rings=n.rings.concat(e.rings),(0,p.c)(n.aabr,e.aabr),delete n._geVersion,i.delete(e);const a=(0,r.U)(t,e,t.length,s);t.splice(a,1)}})),i.add(n)}for(const e of t)delete e.aabr;return t}return[e]}const P=[0,0,0,0];function L(e,t){const i={x:e[0],y:e[1],hasZ:!1,hasM:!1,type:"point",spatialReference:t},r=t.isWGS84||t.isWebMercator?E.geodesicBuffer(i,e[3],1):E.buffer(i,e[3],1);return r.type="polygon",r}function D(e,t,i){switch(i){case"intersects":case"contains":return N(e,t);case"disjoint":return O(e,t)}}function N(e,t){return E.intersects(e,t)?E.contains(e,t)?0:2:1}function O(e,t){return E.intersects(e,t)?E.contains(e,t)?1:2:0}function k(e,t,i){const{collection:r,object:s,renderSR:n,maskSR:a,geometryTest:o,aabbCache:l}=i;let u=l.get(t);if(!u){const e=r.getObjectTransform(s);r.getComponentAabb(s,t,V);const i=[[V[0],V[1],0],[V[0],V[4],0],[V[3],V[4],0],[V[3],V[1],0]];for(let t=0;t<4;++t)(0,h.L)(i[t],i[t],e.rotationScale),(0,h.u)(i[t],i[t],e.position),(0,c.w)(i[t],n,i[t],a);u={rings:[i],hasZ:!1,hasM:!1,type:"polygon",spatialReference:a},u.rings[0][4]=u.rings[0][0],l.set(t,u)}switch(o(e,u)){case 1:return!1;case 0:return!0}const{triangle:d,triangleTest:p,positions:f}=i,y=d.rings[0][0],m=d.rings[0][1],g=d.rings[0][2],_=r.getObjectTransform(s);r.getComponentPositions(s,t,f);const{indices:x,data:v,stride:b,startIndex:w,endIndex:S}=f;for(let t=w;t<S;t+=3){const i=b*x[t+0],r=b*x[t+1],s=b*x[t+2];(0,h.a)(y,v[i+0],v[i+1],v[i+2]),(0,h.a)(m,v[r+0],v[r+1],v[r+2]),(0,h.a)(g,v[s+0],v[s+1],v[s+2]),(0,h.L)(y,y,_.rotationScale),(0,h.L)(m,m,_.rotationScale),(0,h.L)(g,g,_.rotationScale),(0,h.u)(y,y,_.position),(0,h.u)(m,m,_.position),(0,h.u)(g,g,_.position),(0,c.w)(y,n,y,a),(0,c.w)(m,n,m,a),(0,c.w)(g,n,g,a);const o=m[0]-y[0],l=m[1]-y[1],u=g[0]-y[0],f=g[1]-y[1];if(!(Math.abs(o*f-l*u)<2.3283064365386963e-10))switch(delete d._geVersion,p(e,d)){case 1:return!1;case 0:return!0}}switch(i.type){case"intersects":return!1;case"contains":case"disjoint":default:return!0}}const V=(0,d.a)(),U=b.H;let G=class extends r.p{constructor(e){super(e),this._dataQueryEngineInstance=null,this._handles=new x.u}get defaultQueryJSON(){return new S.b({outSpatialReference:this.spatialReference}).toJSON()}get dataQueryEngine(){return this.ensureDataQueryEngine()}initialize(){this._handles.add(this.layerView.on("visible-geometry-changed",(()=>this.spatialIndex.events.emit("changed"))))}destroy(){this._dataQueryEngineInstance&&(this._dataQueryEngineInstance.destroy(),this._dataQueryEngineInstance=null),this._handles&&(this._handles.destroy(),this._handles=null),this._set("layerView",null)}async executeQueryForCount(e,t){return this.dataQueryEngine.executeQueryForCount(this._ensureQueryJSON(e),t)}async executeQueryForExtent(e,t){const{count:i,extent:r}=await this.dataQueryEngine.executeQueryForExtent(this._ensureQueryJSON(e),t);return{count:i,extent:v.M.fromJSON(r)}}async executeQueryForIds(e,t){return this.dataQueryEngine.executeQueryForIds(this._ensureQueryJSON(e),t)}async executeQuery(e,t){const i=this._ensureQueryJSON(e);if(i.returnGeometry)throw new _.s("feature-store:unsupported-query","returnGeometry is not yet supported for mesh scene layer queries");if(i.returnCentroid)throw new _.s("feature-store:unsupported-query","returnCentroid is not yet supported for mesh scene layer queries");const r=await this.dataQueryEngine.executeQuery(i,t),s=w.default.fromJSON(r);return s.features.forEach((e=>{e.geometry=null})),s}_ensureQueryJSON(e){if((0,n.t)(e))return this.defaultQueryJSON;const t=e.toJSON();return t.outSpatialReference||(e.outSpatialReference=this.spatialReference),t}ensureDataQueryEngine(){if(this._dataQueryEngineInstance)return this._dataQueryEngineInstance;const e=this.layer.objectIdField||"OBJECTID",t=this.layer.fields.map((e=>e.toJSON())),i=this.layerView.view.resourceController.scheduler,r=this.spatialReference.toJSON(),s=this.priority,n=this.spatialIndex;return this._dataQueryEngineInstance=new U({hasZ:!0,hasM:!1,geometryType:"esriGeometryPolygon",fields:t,timeInfo:null,spatialReference:r,objectIdField:e,featureStore:n,scheduler:i,priority:s}),this._dataQueryEngineInstance}};(0,r.e)([(0,l.y)({constructOnly:!0})],G.prototype,"layerView",void 0),(0,r.e)([(0,l.y)({constructOnly:!0})],G.prototype,"priority",void 0),(0,r.e)([(0,l.y)({constructOnly:!0})],G.prototype,"spatialIndex",void 0),(0,r.e)([(0,l.y)({readOnly:!0,aliasOf:"layerView.view.spatialReference"})],G.prototype,"spatialReference",void 0),(0,r.e)([(0,l.y)({readOnly:!0,aliasOf:"layerView.i3slayer"})],G.prototype,"layer",void 0),(0,r.e)([(0,l.y)({readOnly:!0})],G.prototype,"defaultQueryJSON",null),G=(0,r.e)([(0,l.n)("esri.views.3d.layers.i3s.I3SQueryEngine")],G);var z=G;class B{constructor(e){this.objectIdField=e.objectIdField,this.getFeatureExtent=e.getFeatureExtent}getObjectId(e){return e.id}getAttributes(e){const{meta:t,index:i}=e,r={};this.objectIdField&&(r[this.objectIdField]=e.id);const s=(0,n.r)(t.attributeInfo)&&t.attributeInfo.attributeData;if((0,n.r)(s))for(const e of Object.keys(s))r[e]=(0,y.f)(s[e],i);return r}getAttribute(e,t){if(t===this.objectIdField)return e.id;const{meta:i,index:r}=e,s=(0,n.r)(i.attributeInfo)&&i.attributeInfo.attributeData;return(0,n.r)(s)?(0,y.f)(s[t],r):null}getGeometry(e){if(e.geometry)return e.geometry;const[t,i,r,s,n]=this.getFeatureExtent(e,j);return new C.a([5],[t,i,r,s,i,r,s,n,r,t,n,r,t,i,r])}getCentroid(e,t){if(e.geometry)return(0,I.t)(new C.a,e.geometry,t.hasZ,t.hasM);const[i,r,s,n,a,o]=this.getFeatureExtent(e,j);return new C.a([0],[(i+n)/2,(r+a)/2,(s+o)/2])}cloneWithGeometry(e,t){const{id:i,index:r,meta:s}=e;return{id:i,index:r,meta:s,geometry:t}}}const j=(0,d.a)();let q=class extends r.p{constructor(e){super(e),this.events=new s.n}destroy(){}forEach(e){this.forAllFeatures((t=>(e(t),1)))}forEachBounds(e,t,i){const r=this.getFeatureExtent;for(const s of e)t(r(s,i))}forEachInBounds(e,t){this.forAllFeatures((i=>{const r=this.getFeatureExtent(i,W);return(0,p.F)(e,(0,d.G)(r,Q))&&t(i),1}),(t=>{if((0,c.T)(t.node.mbs,this.sourceSpatialReference,H,this.viewSpatialReference),H[0]>=e[0]&&H[2]<=e[2]&&H[1]>=e[1]&&H[3]<=e[3])return 1;const i=Math.max(e[0],Math.min(H[0],e[2])),r=Math.max(e[1],Math.min(H[1],e[3])),s=H[0]-i,n=H[1]-r;return s*s+n*n<=H[3]*H[3]?1:2}))}};(0,r.e)([(0,l.y)({constructOnly:!0})],q.prototype,"featureAdapter",void 0),(0,r.e)([(0,l.y)({constructOnly:!0})],q.prototype,"forAllFeatures",void 0),(0,r.e)([(0,l.y)({constructOnly:!0})],q.prototype,"getFeatureExtent",void 0),(0,r.e)([(0,l.y)({constructOnly:!0})],q.prototype,"sourceSpatialReference",void 0),(0,r.e)([(0,l.y)({constructOnly:!0})],q.prototype,"viewSpatialReference",void 0),q=(0,r.e)([(0,l.n)("esri.views.3d.layers.i3s.I3SQueryFeatureStore")],q);const H=(0,M.n)(),W=(0,d.a)(),Q=(0,p.i)();var Z=q},47122:(e,t,i)=>{"use strict";i.d(t,{C:()=>K,F:()=>$,J:()=>C,M:()=>H,N:()=>M,R:()=>Q,S:()=>q,V:()=>T,X:()=>E,_:()=>A,a:()=>w,b:()=>B,c:()=>S,d:()=>G,f:()=>O,h:()=>U,k:()=>J,m:()=>V,n:()=>D,o:()=>L,p:()=>k,q:()=>Z,r:()=>P,w:()=>j,y:()=>z,z:()=>X});var r=i(80987),s=i(78155),n=i(20215),a=i(80219),o=i(93242),l=i(71542),h=i(62654),u=i(30494),c=i(60816),d=i(79679),p=i(7571),f=i(65352),y=i(92858),m=i(53185),g=i(58404),_=i(20736),x=i(18143),v=i(14754),b=i(32422);function w(e,t,i,r){const s=S(e,t,i),n=(0,l.e)();return(0,p.S)(i,s,n,r),n}function S(e,t,i){const r=(0,c.n)(),s=e[3],n=2**(4*Math.ceil(Math.log(s)*Math.LOG2E/4)+1);if(i.isGeographic){const t=n/(0,f.p)(i).radius*180/Math.PI,s=Math.round(e[1]/t),a=Math.max(-90,Math.min(90,s*t)),o=t/Math.cos((Math.abs(a)-t/2)/180*Math.PI),l=Math.round(e[0]/o)*o;r[0]=l,r[1]=a}else{const t=Math.round(e[0]/n),i=Math.round(e[1]/n);r[0]=t*n,r[1]=i*n}const a=e[2]+t,o=Math.round(a/n);return r[2]=o*n,r}function I(e){return e&&parseInt(e.substring(e.lastIndexOf("/")+1,e.length),10)}function C(e){if((0,a.c)("disable-feature:i3s-draco")||!e)return!1;for(const t of e)for(const e of t.geometryBuffers)if("draco"===e.compressedAttributes.encoding)return!0;return!1}function M(e,t,i,r,s,n){s.traverse(i,(i=>{let s=i.mbs;t!==r&&(s=R,(0,p.T)(i.mbs,r,s,t));const a=function(e,t){const i=t[0],r=t[1],s=t[3],n=e[0]-i,a=i-e[2],o=e[1]-r,l=r-e[3],h=Math.max(n,a,0),u=Math.max(o,l,0),c=h*h+u*u;return c>s*s?0:c>0?1:-Math.max(n,a,o,l)>s?3:2}(e,s);return 0!==a&&(n(i,a),!0)}))}function T(e,t,i){let r=0,s=0;for(let n=0;n<t.length&&r<e.length;n++)e[r]===t[n]&&(i(n)&&(e[s]=e[r],s++),r++);e.length=s}function E(e,t,i){let r=0,n=0;for(;r<i.length;)(0,s.O)(e,i[r])>=0===t&&(i[n]=i[r],n++),r++;i.length=n}const F=(0,m.a)();function A(e,t){if(0===t.rotationScale[1]&&0===t.rotationScale[2]&&0===t.rotationScale[3]&&0===t.rotationScale[5]&&0===t.rotationScale[6]&&0===t.rotationScale[7])return F[0]=(e[0]-t.position[0])/t.rotationScale[0],F[1]=(e[1]-t.position[1])/t.rotationScale[4],F[2]=(e[2]-t.position[2])/t.rotationScale[8],F[3]=(e[3]-t.position[0])/t.rotationScale[0],F[4]=(e[4]-t.position[1])/t.rotationScale[4],F[5]=(e[5]-t.position[2])/t.rotationScale[8],F}const R=(0,d.n)();function P(e,t){const i=t[0],r=t[1],s=t[2],n=t[3],a=e[0]-i,o=i-e[3],l=e[1]-r,h=r-e[4],u=e[2]-s,c=s-e[5],d=Math.max(a,o,0),p=Math.max(l,h,0),f=Math.max(u,c,0),y=d*d+p*p+f*f;return y>n*n?0:y>0?1:-Math.max(a,o,l,h,u,c)>n?3:2}function L(e,t,i){const r=[],s=i&&i.missingFields,n=i&&i.originalFields;for(const i of e){const e=i.toLowerCase();let a=!1;for(const s of t)if(e===s.name.toLowerCase()){r.push(s.name),a=!0,n&&n.push(i);break}!a&&s&&s.push(i)}return r}async function D(e,t,i,o,l){if(0===t.length)return[];const h=e.attributeStorageInfo;if((0,a.r)(e.associatedLayer))try{return await async function(e,t,i,r){t.sort(((e,t)=>e.attributes[i]-t.attributes[i]));const s=t.map((e=>e.attributes[i])),n=[],a=L(r,e.fields,{originalFields:n}),o=await N(e,s,a);for(let e=0;e<t.length;e++){const i=t[e],r=o[e],s={};if(i.attributes)for(const e in i.attributes)s[e]=i.attributes[e];for(let e=0;e<n.length;e++)s[n[e]]=r[a[e]];i.attributes=s}return t}(e.associatedLayer,t,i,o)}catch(t){if(e.associatedLayer.loaded)throw t}if(h){const u=function(e,t,i){const r=new Map,s=[],n=i();for(const i of e){const e=i.attributes[t];for(let t=0;t<n.length;t++){const a=n[t],o=a.featureIds.indexOf(e);if(o>=0){let e=r.get(a.node);e||(e={node:a.node,indices:[],graphics:[]},s.push(e),r.set(a.node,e)),e.indices.push(o),e.graphics.push(i);for(let e=t;e>0;e--)n[e]=n[e-1];n[0]=a;break}}}return s}(t,i,l);if((0,a.t)(u))throw new n.s("scenelayer:features-not-loaded","Tried to query attributes for unloaded features");const c=e.parsedUrl.path,d=await Promise.all(u.map((e=>function(e,t,i,s,a){const o=[];for(const r of t)if(r&&-1!==a.indexOf(r.name)){const t=`${e}/nodes/${i.resources.attributes}/attributes/${r.key}/0`;o.push({url:t,storageInfo:r})}return(0,n.A)(o.map((e=>(0,r.L)(e.url,{responseType:"array-buffer"}).then((t=>(0,v.C)(e.storageInfo,t.data)))))).then((e=>{const t=[];for(const i of s){const r={};for(let t=0;t<e.length;t++)null!=e[t].value&&(r[o[t].storageInfo.name]=O(e[t].value,i));t.push(r)}return t}))}(c,h,e.node,e.indices,o).then((t=>{for(let i=0;i<e.graphics.length;i++){const r=e.graphics[i],s=t[i];if(r.attributes)for(const e in r.attributes)e in s||(s[e]=r.attributes[e]);r.attributes=s}return e.graphics})))));return(0,s.M)(d)}throw new n.s("scenelayer:no-attribute-source","This scene layer does not have a source for attributes available")}function N(e,t,i){const r=e.capabilities.query.maxRecordCount;if(null!=r&&t.length>r){const n=(0,s.X)(t,r);return Promise.all(n.map((t=>N(e,t,i)))).then(s.M)}const a=new x.b({objectIds:t,outFields:i,orderByFields:[e.objectIdField]});return e.queryFeatures(a).then((e=>{if(e&&e.features&&e.features.length===t.length)return e.features.map((e=>e.attributes));throw new n.s("scenelayer:feature-not-in-associated-layer","Feature not found in associated feature layer")}))}function O(e,t){if(!e)return null;const i=e[t];return(0,a.S)(e)?-32768===i?null:i:(0,a.T)(e)?-2147483648===i?null:i:i!=i?null:i}function k(e){const t=e.store.indexCRS||e.store.geographicCRS,i=void 0===t?e.store.indexWKT:void 0;if(i){if(!e.spatialReference)throw new n.s("layerview:no-store-spatial-reference-wkt-index-and-no-layer-spatial-reference","Found indeWKT in the scene layer store but no layer spatial reference",{});if(i!==e.spatialReference.wkt)throw new n.s("layerview:store-spatial-reference-wkt-index-incompatible","The indeWKT of the scene layer store does not match the WKT of the layer spatial reference",{})}const r=t?new y.k(I(t)):e.spatialReference;return r.equals(e.spatialReference)?e.spatialReference:r}function V(e){const t=e.store.vertexCRS||e.store.projectedCRS,i=void 0===t?e.store.vertexWKT:void 0;if(i){if(!e.spatialReference)throw new n.s("layerview:no-store-spatial-reference-wkt-vertex-and-no-layer-spatial-reference","Found vertexWKT in the scene layer store but no layer spatial reference",{});if(i!==e.spatialReference.wkt)throw new n.s("layerview:store-spatial-reference-wkt-vertex-incompatible","The vertexWKT of the scene layer store does not match the WKT of the layer spatial reference",{})}const r=t?new y.k(I(t)):e.spatialReference;return r.equals(e.spatialReference)?e.spatialReference:r}function U(e,t){return(0,a.t)(t)?"@null":t===(0,f.e)(t)?"@ECEF":e.equals(t)?"":null!=t.wkid?"@"+t.wkid:null}function G(e,t,i){if(!(0,_.x)(e,t))throw new n.s("layerview:spatial-reference-incompatible","The spatial reference of this scene layer is incompatible with the spatial reference of the view",{});if("local"===i&&e.isGeographic)throw new n.s("layerview:local-gcs-not-supported","Geographic coordinate systems are not supported in local scenes",{})}function z(e,t,i){const r=k(e),s=V(e);G(r,t,i),G(s,t,i)}function B(e){if(null==e.store||null==e.store.defaultGeometrySchema||!function(e){return!(null!=e.geometryType&&"triangles"!==e.geometryType||null!=e.topology&&"PerAttributeArray"!==e.topology||null==e.vertexAttributes||null==e.vertexAttributes.position)}(e.store.defaultGeometrySchema))throw new n.s("scenelayer:unsupported-geometry-schema","The geometry schema of this scene layer is not supported.",{url:e.parsedUrl.path})}function j(e,t){z(e,t.spatialReference,t.viewingMode)}function q(e){if(null==e.store||null==e.store.defaultGeometrySchema||!function(e){return!(null==e.geometryType||"points"!==e.geometryType||null!=e.topology&&"PerAttributeArray"!==e.topology||null!=e.encoding&&""!==e.encoding&&"lepcc-xyz"!==e.encoding||null==e.vertexAttributes||null==e.vertexAttributes.position)}(e.store.defaultGeometrySchema))throw new n.s("pointcloud:unsupported-geometry-schema","The geometry schema of this point cloud scene layer is not supported.",{})}function H(e,t){G(e.spatialReference,t.spatialReference,t.viewingMode)}function W(e){return"mesh-3d"===e.type}function Q(e){if(null==e||!function(e){return"simple"===e.type||"class-breaks"===e.type||"unique-value"===e.type}(e))return!0;if(("unique-value"===e.type||"class-breaks"===e.type)&&null==e.defaultSymbol)return!0;const t=e.getSymbols();if(0===t.length)return!0;for(const e of t){if(!W(e)||0===e.symbolLayers.length)return!0;for(const t of e.symbolLayers.items)if("fill"!==t.type||(0,a.t)(t.material)||(0,a.t)(t.material.color)||"replace"!==t.material.colorMixMode)return!0}return!1}const Z=(0,b.A)({color:[0,0,0,0],opacity:0});class Y{constructor(){this.edgeMaterial=null,this.material=null,this.castShadows=!0}}function J(e){const t=new Y;let i=!1,r=!1;for(const s of e.symbolLayers.items)if("fill"===s.type&&s.enabled){const e=s.material,n=s.edges;if((0,a.r)(e)&&!i){const r=e.color,n=(0,b.B)(e.colorMixMode);(0,a.r)(r)?t.material={color:[r.r/255,r.g/255,r.b/255],alpha:r.a,colorMixMode:n}:t.material={color:[1,1,1],alpha:1,colorMixMode:1},t.castShadows=s.castShadows,i=!0}(0,a.r)(n)&&!r&&(t.edgeMaterial=(0,b.w)(n,{}),r=!0)}return t.material||(t.material={color:[1,1,1],alpha:1,colorMixMode:1}),t}function X(e,t){return(0|e)+(0|t)|0}function $(e,t,i,r,s=0){r===(0,f.e)(r)?t.isGeographic?function(e,t,i,r){const s=(0,f.p)(i),n=1+Math.max(0,r)/(s.radius+e.center[2]);(0,c.a)(t.center,e.center[0],e.center[1],e.center[2]+r),(0,p.x)(t.center,i,0,t.center,(0,f.e)(i),0,1),(0,h.F)(t.quaternion,e.quaternion),(0,h.w)(te,e.quaternion),(0,c.a)(ae,0,0,1),(0,c.W)(ae,ae,te),(0,c.a)(ae,e.halfSize[0]*Math.abs(ae[0]),e.halfSize[1]*Math.abs(ae[1]),e.halfSize[2]*Math.abs(ae[2])),(0,c.d)(ae,ae,s.inverseFlattening),(0,c.u)(t.halfSize,e.halfSize,ae),(0,c.d)(t.halfSize,t.halfSize,n)}(e,i,t,s):function(e,t,i,r){(0,b.U)(e,ie),(0,c.a)(t.center,e.center[0],e.center[1],e.center[2]+r),(0,p.S)(i,t.center,ee,(0,f.e)(i)),(0,c.a)(t.center,ee[12],ee[13],ee[14]);const s=2*Math.sqrt(1+ee[0]+ee[5]+ee[10]);te[0]=(ee[6]-ee[9])/s,te[1]=(ee[8]-ee[2])/s,te[2]=(ee[1]-ee[4])/s,te[3]=.25*s,(0,h.P)(t.quaternion,te,e.quaternion),(0,h.w)(te,t.quaternion);let n=0,a=0,o=0;for(const e of ie)e[2]+=r,(0,p.x)(e,i,0,e,(0,f.e)(i),0,1),(0,c.J)(ae,e,t.center),(0,c.W)(ae,ae,te),n=Math.max(n,Math.abs(ae[0])),a=Math.max(a,Math.abs(ae[1])),o=Math.max(o,Math.abs(ae[2]));(0,c.a)(t.halfSize,n,a,o)}(e,i,t,s):e===i?(i.center[2]+=s,(0,p.x)(i.center,t,0,i.center,r,0,1)):((0,c.a)(i.center,e.center[0],e.center[1],e.center[2]+s),(0,p.x)(i.center,t,0,i.center,r,0,1),(0,h.F)(i.quaternion,e.quaternion),(0,c.h)(i.halfSize,e.halfSize))}function K(e,t,i,r,s,n){if(!n||0===n.length||(0,a.t)(t))return null;const l=w(e.mbs,s,i,t);let h;(0,o.h)(le,l);const u=()=>{if(!h)if(h=ie,(0,g.B)(se),(0,a.r)(e.serviceObb)){$(e.serviceObb,i,ne,t,s),(0,b.U)(ne,h);for(const e of h)(0,c.I)(e,e,le),(0,g.f)(se,e)}else{const r=e.mbs,n=r[3];(0,p.w)(r,i,ae,t),(0,c.I)(ae,ae,le),ae[2]+=s;for(let e=0;e<8;++e){const t=1&e?n:-n,i=2&e?n:-n,r=4&e?n:-n,s=h[e];(0,c.h)(s,[ae[0]+t,ae[1]+i,ae[2]+r]),(0,g.f)(se,s)}}};let d=1/0,f=-1/0;if(n.forEach((e=>(e=>{if("replace"!==e.type)return;const i=e.geometry;if(!i.hasZ)return;(0,g.B)(re);const s=i.spatialReference||r,n=i.rings.reduce(((e,i)=>i.reduce(((e,i)=>((0,p.w)(i,s,ae,t),(0,c.I)(ae,ae,le),(0,g.f)(re,ae),Math.min(ae[2],e))),e)),1/0);u(),(0,g.F)(se,re)&&(d=Math.min(d,n),f=Math.max(f,n))})(e))),d===1/0)return null;const y=(e,t,i)=>{(0,c.I)(ae,i,l),e[t+0]=ae[0],e[t+1]=ae[1],e[t+2]=ae[2],t+=24,i[2]=d,(0,c.I)(ae,i,l),e[t+0]=ae[0],e[t+1]=ae[1],e[t+2]=ae[2],t+=24,i[2]=f,(0,c.I)(ae,i,l),e[t+0]=ae[0],e[t+1]=ae[1],e[t+2]=ae[2]};for(let e=0;e<8;++e)y(oe.data,3*e,h[e]);return(0,b.G)(oe)}const ee=(0,l.e)(),te=(0,u.r)(),ie=[[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0]],re=(0,g.i)(),se=(0,g.i)(),ne=(0,b.D)(),ae=[0,0,0],oe={data:new Array(72),size:3},le=(0,l.e)()},21142:(e,t,i)=>{"use strict";i.d(t,{E:()=>l,O:()=>u,s:()=>a});var r=i(78155),s=i(72105),n=i(93875);function a(e){const t=new s.n;return t.include(s.r,{linearDepth:!1}),t.vertex.uniforms.add("proj","mat4").add("view","mat4"),t.attributes.add("position","vec3"),t.attributes.add("uv0","vec2"),t.varyings.add("vpos","vec3"),e.multipassTerrainEnabled&&t.varyings.add("depth","float"),t.vertex.uniforms.add("textureCoordinateScaleFactor","vec2"),t.vertex.code.add(s.t`
    void main(void) {
      vpos = position;
      ${e.multipassTerrainEnabled?"depth = (view * vec4(vpos, 1.0)).z;":""}
      vTexCoord = uv0 * textureCoordinateScaleFactor;
      gl_Position = transformPosition(proj, view, vpos);
    }
  `),t.include(s.N,e),e.multipassTerrainEnabled&&(t.fragment.include(s.L),t.include(s.ap,e)),t.fragment.uniforms.add("tex","sampler2D"),t.fragment.uniforms.add("opacity","float"),t.varyings.add("vTexCoord","vec2"),7===e.output?t.fragment.code.add(s.t`
    void main() {
      discardBySlice(vpos);
      ${e.multipassTerrainEnabled?"terrainDepthTest(gl_FragCoord, depth);":""}

      float alpha = texture2D(tex, vTexCoord).a * opacity;
      if (alpha  < ${s.t.float(s.R)}) {
        discard;
      }

      gl_FragColor = vec4(alpha);
    }
    `):(t.fragment.include(s.j),t.fragment.code.add(s.t`
    void main() {
      discardBySlice(vpos);
      ${e.multipassTerrainEnabled?"terrainDepthTest(gl_FragCoord, depth);":""}
      gl_FragColor = texture2D(tex, vTexCoord) * opacity;

      if (gl_FragColor.a < ${s.t.float(s.R)}) {
        discard;
      }

      gl_FragColor = highlightSlice(gl_FragColor, vpos);
      ${e.OITEnabled?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""}
    }
    `)),t}var o=Object.freeze({__proto__:null,build:a});class l extends s.c{initializeProgram(e){const t=l.shader.get(),i=this.configuration,r=t.build({output:i.output,slicePlaneEnabled:i.slicePlaneEnabled,sliceHighlightDisabled:!1,sliceEnabledForVertexPrograms:!1,OITEnabled:0===i.transparencyPassType,multipassTerrainEnabled:i.multipassTerrainEnabled,cullAboveGround:i.cullAboveGround});return new s.d(e.rctx,r,s.o)}bindPass(e,t){(0,s.h)(this.program,t.camera.projectionMatrix),this.program.setUniform1f("opacity",e.opacity),t.multipassTerrainEnabled&&(this.program.setUniform2fv("cameraNearFar",t.camera.nearFar),this.program.setUniform2fv("inverseViewport",t.inverseViewport),(0,s.Y)(this.program,t))}bindDraw(e){(0,s.a2)(this.program,e),(0,s.a4)(this.program,this.configuration,e),this.program.rebindTextures()}setPipelineState(e,t){const i=this.configuration,r=3===e,a=2===e;return(0,n.g)({blending:0!==i.output&&7!==i.output||!i.transparent?null:r?h:(0,s.a5)(e),culling:(0,n.d)(i.cullFace),depthTest:{func:(0,s.as)(e)},depthWrite:r?i.writeDepth&&n.l:(0,s.at)(e),colorWrite:n.r,stencilWrite:i.sceneHasOcludees?s.au:null,stencilTest:i.sceneHasOcludees?t?s.av:s.aw:null,polygonOffset:r||a?null:(0,s.aI)(i.enableOffset)})}initializePipeline(){return this._occludeePipelineState=this.setPipelineState(this.configuration.transparencyPassType,!0),this.setPipelineState(this.configuration.transparencyPassType,!1)}getPipelineState(e){return e?this._occludeePipelineState:this.pipeline}}l.shader=new s.f(o,(()=>i.e(8364).then(i.bind(i,48364))));const h=(0,n.t)(1,771);class u extends s.b{constructor(){super(...arguments),this.output=0,this.cullFace=0,this.slicePlaneEnabled=!1,this.transparent=!1,this.enableOffset=!0,this.writeDepth=!0,this.sceneHasOcludees=!1,this.transparencyPassType=3,this.multipassTerrainEnabled=!1,this.cullAboveGround=!1}}(0,r.e)([(0,s.a)({count:8})],u.prototype,"output",void 0),(0,r.e)([(0,s.a)({count:3})],u.prototype,"cullFace",void 0),(0,r.e)([(0,s.a)()],u.prototype,"slicePlaneEnabled",void 0),(0,r.e)([(0,s.a)()],u.prototype,"transparent",void 0),(0,r.e)([(0,s.a)()],u.prototype,"enableOffset",void 0),(0,r.e)([(0,s.a)()],u.prototype,"writeDepth",void 0),(0,r.e)([(0,s.a)()],u.prototype,"sceneHasOcludees",void 0),(0,r.e)([(0,s.a)({count:4})],u.prototype,"transparencyPassType",void 0),(0,r.e)([(0,s.a)()],u.prototype,"multipassTerrainEnabled",void 0),(0,r.e)([(0,s.a)()],u.prototype,"cullAboveGround",void 0)},76944:(e,t,i)=>{"use strict";i.d(t,{u:()=>c});var r=i(78155),s=i(20215),n=i(80219),a=i(88903),o=i(20736),l=i(13895),h=i(18143),u=i(81578);const c=e=>{let t=class extends e{constructor(){super(...arguments),this.view=null}async fetchPopupFeatures(e,t){const{layer:i}=this;if(!e)throw new s.s("imagerylayerview:fetchPopupFeatures","Nothing to fetch without area",{layer:i});const{popupEnabled:r}=i,a=(0,u.d)(i,t);if(!r||!(0,n.r)(a))throw new s.s("imagerylayerview:fetchPopupFeatures","Missing required popupTemplate or popupEnabled",{popupEnabled:r,popupTemplate:a});const l=await a.getRequiredFields(),c=new h.b;c.timeExtent=this.timeExtent,c.geometry=e,c.outFields=l,c.outSpatialReference=e.spatialReference;const d=this.view.resolution,p="2d"===this.view.type?new o.b(d,d,this.view.spatialReference):new o.b(.5*d,.5*d,this.view.spatialReference),{returnTopmostRaster:f,showNoDataRecords:y}=a.layerOptions||{returnTopmostRaster:!0,showNoDataRecords:!1},m={returnDomainValues:!0,returnTopmostRaster:f,pixelSize:p,showNoDataRecords:y,signal:(0,n.r)(t)?t.signal:null};return i.queryVisibleRasters(c,m).then((e=>e))}canResume(){var e;return!(!super.canResume()||null!=(e=this.timeExtent)&&e.isEmpty)}};return(0,r.e)([(0,a.y)()],t.prototype,"layer",void 0),(0,r.e)([(0,a.y)()],t.prototype,"suspended",void 0),(0,r.e)([(0,a.y)(l.u)],t.prototype,"timeExtent",void 0),(0,r.e)([(0,a.y)()],t.prototype,"view",void 0),t=(0,r.e)([(0,a.n)("esri.views.layers.ImageryLayerView")],t),t}},47910:(e,t,i)=>{"use strict";i.d(t,{p:()=>u});var r=i(78155),s=i(73574),n=i(20215),a=i(80219),o=i(88903),l=i(43231),h=i(81578);const u=e=>{let t=class extends e{constructor(){super(...arguments),this._rasterFieldPrefix="Raster.",this.layer=null,this.view=null,this.fullExtent=null,this.tileInfo=null,this.datumTransformation=null}get hasTilingEffects(){return this.layer.renderer&&"dynamicRangeAdjustment"in this.layer.renderer&&this.layer.renderer.dynamicRangeAdjustment}async fetchPopupFeatures(e,t){const{layer:i}=this;if(!e)return Promise.reject(new n.s("imageryTileLayerView:fetchPopupFeatures","Nothing to fetch without area",{layer:i}));const{popupEnabled:r}=i,o=(0,h.d)(i,t);if(!r||!(0,a.r)(o))throw new n.s("imageryTileLayerView:fetchPopupFeatures","Missing required popupTemplate or popupEnabled",{popupEnabled:r,popupTemplate:o});const l=[],{value:u}=await i.identify(e);let c="";if(u&&u.length){var d,p;c="imagery-tile"===i.type&&i.hasStandardTime()&&null!=u[0]?u.map((e=>i.getStandardTimeValue(e))).join(", "):u.join(", ");const e={ObjectId:0},t="Raster.ServicePixelValue";e[t]=this._formatAttributeValue(c,t);const r=null==(d=i.rasterInfo)||null==(p=d.attributeTable)?void 0:p.features;if(r&&r.length>0){const t=r.filter((e=>{const t=e.attributes.value||e.attributes.Value||e.attributes.VALUE;return String(t)===c}));if(t.length>0){const i=t[0];if(i)for(const t in i.attributes)if(i.attributes.hasOwnProperty(t)){const r=this._rasterFieldPrefix+t;e[r]=this._formatAttributeValue(i.attributes[t],r)}}}const n=new s.h(this.fullExtent.clone(),null,e);n.layer=i,n.sourceLayer=n.layer,l.push(n)}return l}updateFullExtent(){const e=this.layer.tileInfo;let t;e&&e.spatialReference||(t=new n.s("layerview:tiling-information-missing","The layer doesn't provide tiling information",{layer:this.layer}));const i=(0,l.M)(this.layer.fullExtent,this.view.spatialReference,!1),r=(0,l.j)(this.layer.fullExtent,this.view.spatialReference,i);return null==r&&(t=new n.s("layerview:projection-not-supported","The layer extent cannot be projected to the view's spatial reference",{layer:this.layer})),this._set("fullExtent",r),this.datumTransformation||(this.datumTransformation=(0,l.M)(this.layer.fullExtent,this.view.spatialReference,!0)),t?Promise.reject(t):Promise.resolve()}_formatAttributeValue(e,t){if("string"==typeof e){const i=this.layer.popupTemplate&&this.layer.popupTemplate.fieldInfos,r=this._getFieldInfo(i,t),s=r&&r.format;if(s){let t,i;return e.trim().indexOf(",")>-1?(t=",",i=t+" ",this._formatDelimitedString(e,t,i,s)):e.trim().indexOf(" ")>-1?(t=i=" ",this._formatDelimitedString(e,t,i,s)):this._formatNumberFromString(e,s)}}return e}_getFieldInfo(e,t){if(!e||!e.length||!t)return;const i=t.toLowerCase();let r;return e.some((e=>!(!e.fieldName||e.fieldName.toLowerCase()!==i&&e.fieldName.toLowerCase()!==i.replace(/ /g,"_")||(r=e,0)))),r}_formatDelimitedString(e,t,i,r){return e&&t&&i&&r?e.trim().split(t).map((e=>this._formatNumberFromString(e,r))).join(i):e}_formatNumberFromString(e,t){if(!e||!t)return e;const i=Number(e);return isNaN(i)?e:t.format(i)}};return(0,r.e)([(0,o.y)()],t.prototype,"layer",void 0),(0,r.e)([(0,o.y)()],t.prototype,"view",void 0),(0,r.e)([(0,o.y)()],t.prototype,"fullExtent",void 0),(0,r.e)([(0,o.y)()],t.prototype,"tileInfo",void 0),(0,r.e)([(0,o.y)({readOnly:!0})],t.prototype,"hasTilingEffects",null),t=(0,r.e)([(0,o.n)("esri.views.layers.ImageryTileLayerView")],t),t}},31280:(e,t,i)=>{"use strict";i.d(t,{l:()=>I});var r=i(78155),s=i(40130),n=i(31516),a=i(36845),o=i(88903),l=(i(80219),i(1045)),h=(i(80987),i(20736)),u=i(89710),c=i(98548);let d=class extends r.a{};d=(0,r.e)([(0,o.n)("esri.views.layers.support.ClipArea")],d);var p,f=d;let y=p=class extends f{constructor(){super(...arguments),this.type="rect",this.left=null,this.right=null,this.top=null,this.bottom=null}clone(){return new p({left:this.left,right:this.right,top:this.top,bottom:this.bottom})}get version(){return(this._get("version")||0)+1}};(0,r.e)([(0,o.y)({type:[Number,String],json:{write:!0}})],y.prototype,"left",void 0),(0,r.e)([(0,o.y)({type:[Number,String],json:{write:!0}})],y.prototype,"right",void 0),(0,r.e)([(0,o.y)({type:[Number,String],json:{write:!0}})],y.prototype,"top",void 0),(0,r.e)([(0,o.y)({type:[Number,String],json:{write:!0}})],y.prototype,"bottom",void 0),(0,r.e)([(0,o.y)({readOnly:!0})],y.prototype,"version",null),y=p=(0,r.e)([(0,o.n)("esri.views.layers.support.ClipRect")],y);var m,g=y;const _={base:h.p,key:"type",typeMap:{extent:c.M,polygon:c.j}};let x=m=class extends f{constructor(){super(...arguments),this.type="geometry",this.geometry=null}get version(){return(this._get("version")||0)+1}clone(){return new m({geometry:this.geometry.clone()})}};(0,r.e)([(0,o.y)({types:_,json:{read:u.p,write:!0}})],x.prototype,"geometry",void 0),(0,r.e)([(0,o.y)({readOnly:!0})],x.prototype,"version",null),x=m=(0,r.e)([(0,o.n)("esri.views.layers.support.Geometry")],x);var v=x;let b=class extends f{constructor(){super(...arguments),this.type="path",this.path=[]}get version(){return(this._get("version")||0)+1}};(0,r.e)([(0,o.y)({type:[[[Number]]],json:{write:!0}})],b.prototype,"path",void 0),(0,r.e)([(0,o.y)({readOnly:!0})],b.prototype,"version",null),b=(0,r.e)([(0,o.n)("esri.views.layers.support.Path")],b);var w=b;const S=s.L.ofType({key:"type",base:f,typeMap:{rect:g,path:w,geometry:v}}),I=e=>{let t=class extends e{constructor(){super(...arguments),this.clips=new S,this.moving=!1,this.attached=!1,this.lastUpdateId=-1,this.updateRequested=!1}initialize(){var e;this.container||(this.container=new l.r),this.container.fadeTransitionEnabled=!0,this.container.opacity=0,this.container.clips=this.clips,this.handles.add([(0,a.d)(this,"suspended",(e=>{this.container&&(this.container.visible=!e),this.view&&!e&&this.updateRequested&&this.view.requestUpdate()}),!0),(0,a.d)(this,["layer.opacity","container"],(()=>{var e,t;this.container&&(this.container.opacity=null!=(e=null==(t=this.layer)?void 0:t.opacity)?e:1)}),!0),(0,a.d)(this,["layer.blendMode"],(e=>{this.container&&(this.container.blendMode=e)}),!0),(0,a.d)(this,["layer.effect"],(e=>{this.container&&(this.container.effect=e)}),!0),this.clips.on("change",(()=>{this.container.clips=this.clips,this.notifyChange("clips")}))]),null!=(e=this.view)&&e.whenLayerView?this.view.whenLayerView(this.layer).then((e=>{e!==this||this.attached||this.destroyed||(this.attach(),this.requestUpdate(),this.attached=!0)}),(()=>{})):this.when().then((()=>{this.attached||this.destroyed||(this.attach(),this.requestUpdate(),this.attached=!0)}),(()=>{}))}destroy(){this.attached&&(this.detach(),this.attached=!1),this.handles.remove("initialize"),this.updateRequested=!1}get updating(){return!this.attached||!this.suspended&&(this.updateRequested||this.isUpdating())}isVisibleAtScale(e){let t=!0;const i=this.layer,r=i.minScale,s=i.maxScale;if(null!=r&&null!=s){let i=!r,n=!s;!i&&e<=r&&(i=!0),!n&&e>=s&&(n=!0),t=i&&n}return t}requestUpdate(){this.destroyed||this.updateRequested||(this.updateRequested=!0,this.suspended||this.view.requestUpdate())}processUpdate(e){!this.isFulfilled()||this.isResolved()?(this._set("updateParameters",e),this.updateRequested&&!this.suspended&&(this.updateRequested=!1,this.update(e))):this.updateRequested=!1}isUpdating(){return!1}isRendering(){return!1}canResume(){return!!super.canResume()&&this.isVisibleAtScale(this.view.scale)}};return(0,r.e)([(0,o.y)({type:S,set(e){const t=(0,n.n)(e,this._get("clips"),S);this._set("clips",t)}})],t.prototype,"clips",void 0),(0,r.e)([(0,o.y)()],t.prototype,"moving",void 0),(0,r.e)([(0,o.y)()],t.prototype,"attached",void 0),(0,r.e)([(0,o.y)()],t.prototype,"container",void 0),(0,r.e)([(0,o.y)()],t.prototype,"suspended",void 0),(0,r.e)([(0,o.y)({readOnly:!0})],t.prototype,"updateParameters",void 0),(0,r.e)([(0,o.y)()],t.prototype,"updateRequested",void 0),(0,r.e)([(0,o.y)()],t.prototype,"updating",null),(0,r.e)([(0,o.y)()],t.prototype,"view",void 0),t=(0,r.e)([(0,o.n)("esri.views.2d.layers.LayerView2D")],t),t}},77606:(e,t,i)=>{"use strict";i.d(t,{m:()=>p}),i(33807);const r=new Float32Array(1);function s(e){return n(Math.max(-a,Math.min(e,a)))}function n(e){return r[0]=e,r[0]}const a=n(34028234663852886e22);var o={};o.defaultNoDataValue=s(-1/0),o.decode=function(e,t){var i=(t=t||{}).encodedMaskData||null===t.encodedMaskData,r=c(e,t.inputOffset||0,i),n=null!=t.noDataValue?s(t.noDataValue):o.defaultNoDataValue,a=l(r,t.pixelType||Float32Array,t.encodedMaskData,n,t.returnMask),d={width:r.width,height:r.height,pixelData:a.resultPixels,minValue:r.pixels.minValue,maxValue:r.pixels.maxValue,noDataValue:n};return a.resultMask&&(d.maskData=a.resultMask),t.returnEncodedMask&&r.mask&&(d.encodedMaskData=r.mask.bitset?r.mask.bitset:null),t.returnFileInfo&&(d.fileInfo=h(r,n),t.computeUsedBitDepths&&(d.fileInfo.bitDepths=u(r))),d};var l=function(e,t,i,r,s){var n,a,o=0,l=e.pixels.numBlocksX,h=e.pixels.numBlocksY,u=Math.floor(e.width/l),c=Math.floor(e.height/h),p=2*e.maxZError;i=i||(e.mask?e.mask.bitset:null),n=new t(e.width*e.height),s&&i&&(a=new Uint8Array(e.width*e.height));for(var f,y,m=new Float32Array(u*c),g=0;g<=h;g++){var _=g!==h?c:e.height%h;if(0!==_)for(var x=0;x<=l;x++){var v=x!==l?u:e.width%l;if(0!==v){var b,w,S,I,C=g*e.width*c+x*u,M=e.width-v,T=e.pixels.blocks[o];if(T.encoding<2?(0===T.encoding?b=T.rawData:(d(T.stuffedData,T.bitsPerPixel,T.numValidPixels,T.offset,p,m,e.pixels.maxValue),b=m),w=0):S=2===T.encoding?0:T.offset,i)for(y=0;y<_;y++){for(7&C&&(I=i[C>>3],I<<=7&C),f=0;f<v;f++)7&C||(I=i[C>>3]),128&I?(a&&(a[C]=1),n[C++]=T.encoding<2?b[w++]:S):(a&&(a[C]=0),n[C++]=r),I<<=1;C+=M}else if(T.encoding<2)for(y=0;y<_;y++){for(f=0;f<v;f++)n[C++]=b[w++];C+=M}else for(y=0;y<_;y++)if(n.fill)n.fill(S,C,C+v),C+=v+M;else{for(f=0;f<v;f++)n[C++]=S;C+=M}if(1===T.encoding&&w!==T.numValidPixels)throw"Block and Mask do not match";o++}}}return{resultPixels:n,resultMask:a}},h=function(e,t){return{fileIdentifierString:e.fileIdentifierString,fileVersion:e.fileVersion,imageType:e.imageType,height:e.height,width:e.width,maxZError:e.maxZError,eofOffset:e.eofOffset,mask:e.mask?{numBlocksX:e.mask.numBlocksX,numBlocksY:e.mask.numBlocksY,numBytes:e.mask.numBytes,maxValue:e.mask.maxValue}:null,pixels:{numBlocksX:e.pixels.numBlocksX,numBlocksY:e.pixels.numBlocksY,numBytes:e.pixels.numBytes,maxValue:e.pixels.maxValue,minValue:e.pixels.minValue,noDataValue:t}}},u=function(e){for(var t=e.pixels.numBlocksX*e.pixels.numBlocksY,i={},r=0;r<t;r++){var s=e.pixels.blocks[r];0===s.encoding?i.float32=!0:1===s.encoding?i[s.bitsPerPixel]=!0:i[0]=!0}return Object.keys(i)},c=function(e,t,i){var r={},s=new Uint8Array(e,t,10);if(r.fileIdentifierString=String.fromCharCode.apply(null,s),"CntZImage"!=r.fileIdentifierString.trim())throw"Unexpected file identifier string: "+r.fileIdentifierString;t+=10;var n=new DataView(e,t,24);if(r.fileVersion=n.getInt32(0,!0),r.imageType=n.getInt32(4,!0),r.height=n.getUint32(8,!0),r.width=n.getUint32(12,!0),r.maxZError=n.getFloat64(16,!0),t+=24,!i)if(n=new DataView(e,t,16),r.mask={},r.mask.numBlocksY=n.getUint32(0,!0),r.mask.numBlocksX=n.getUint32(4,!0),r.mask.numBytes=n.getUint32(8,!0),r.mask.maxValue=n.getFloat32(12,!0),t+=16,r.mask.numBytes>0){var a=new Uint8Array(Math.ceil(r.width*r.height/8)),o=(n=new DataView(e,t,r.mask.numBytes)).getInt16(0,!0),l=2,h=0;do{if(o>0)for(;o--;)a[h++]=n.getUint8(l++);else{var u=n.getUint8(l++);for(o=-o;o--;)a[h++]=u}o=n.getInt16(l,!0),l+=2}while(l<r.mask.numBytes);if(-32768!==o||h<a.length)throw"Unexpected end of mask RLE encoding";r.mask.bitset=a,t+=r.mask.numBytes}else 0==(r.mask.numBytes|r.mask.numBlocksY|r.mask.maxValue)&&(a=new Uint8Array(Math.ceil(r.width*r.height/8)),r.mask.bitset=a);n=new DataView(e,t,16),r.pixels={},r.pixels.numBlocksY=n.getUint32(0,!0),r.pixels.numBlocksX=n.getUint32(4,!0),r.pixels.numBytes=n.getUint32(8,!0),r.pixels.maxValue=n.getFloat32(12,!0),t+=16;var c=r.pixels.numBlocksX,d=r.pixels.numBlocksY,p=c+(r.width%c>0?1:0),f=d+(r.height%d>0?1:0);r.pixels.blocks=new Array(p*f);for(var y=1e9,m=0,g=0;g<f;g++)for(var _=0;_<p;_++){var x=0,v=e.byteLength-t;n=new DataView(e,t,Math.min(10,v));var b={};r.pixels.blocks[m++]=b;var w=n.getUint8(0);if(x++,b.encoding=63&w,b.encoding>3)throw"Invalid block encoding ("+b.encoding+")";if(2!==b.encoding){if(0!==w&&2!==w){if(w>>=6,b.offsetType=w,2===w)b.offset=n.getInt8(1),x++;else if(1===w)b.offset=n.getInt16(1,!0),x+=2;else{if(0!==w)throw"Invalid block offset type";b.offset=n.getFloat32(1,!0),x+=4}if(y=Math.min(b.offset,y),1===b.encoding)if(w=n.getUint8(x),x++,b.bitsPerPixel=63&w,w>>=6,b.numValidPixelsType=w,2===w)b.numValidPixels=n.getUint8(x),x++;else if(1===w)b.numValidPixels=n.getUint16(x,!0),x+=2;else{if(0!==w)throw"Invalid valid pixel count type";b.numValidPixels=n.getUint32(x,!0),x+=4}}var S;if(t+=x,3!=b.encoding)if(0===b.encoding){var I=(r.pixels.numBytes-1)/4;if(I!==Math.floor(I))throw"uncompressed block has invalid length";S=new ArrayBuffer(4*I),new Uint8Array(S).set(new Uint8Array(e,t,4*I));for(var C=new Float32Array(S),M=0;M<C.length;M++)y=Math.min(y,C[M]);b.rawData=C,t+=4*I}else if(1===b.encoding){var T=Math.ceil(b.numValidPixels*b.bitsPerPixel/8),E=Math.ceil(T/4);S=new ArrayBuffer(4*E),new Uint8Array(S).set(new Uint8Array(e,t,T)),b.stuffedData=new Uint32Array(S),t+=T}}else t++,y=Math.min(y,0)}return r.pixels.minValue=y,r.eofOffset=t,r},d=function(e,t,i,r,s,n,a){var o,l,h,u=(1<<t)-1,c=0,d=0,p=Math.ceil((a-r)/s),f=4*e.length-Math.ceil(t*i/8);for(e[e.length-1]<<=8*f,o=0;o<i;o++){if(0===d&&(h=e[c++],d=32),d>=t)l=h>>>d-t&u,d-=t;else{var y=t-d;l=(h&u)<<y&u,l+=(h=e[c++])>>>(d=32-y)}n[o]=l<p?r+l*s:a}return n};const p=o.decode},58275:(e,t,i)=>{"use strict";i.d(t,{c:()=>c,m:()=>d,t:()=>u}),i(33807);var r=i(80219),s=i(93242),n=i(71542),a=i(60816),o=i(15346),l=i(86897),h=i(32422);class u{constructor(e){this._attached=!1,this._resourcesCreated=!1,this._visible=!0,this.view=e,this.view.watch("ready",(e=>{this._resourcesCreated&&(e?this._createResources():this._destroyResources())}))}applyProps(e){let t=!1;for(const i in e)i in this?"attached"===i?t=e[i]:this[i]=e[i]:console.error("Cannot set unknown property",i);this.attached=t}destroy(){this.attached=!1}get attached(){return this._attached}set attached(e){e!==this._attached&&this.view._stage&&(this._attached=e,this._attached&&!this._resourcesCreated?this._createResources():!this._attached&&this._resourcesCreated&&this._destroyResources())}get visible(){return this._visible}set visible(e){e!==this._visible&&(this._visible=e,this.attached&&this.updateVisibility(e))}_createResources(){this.createResources(),this._resourcesCreated=!0,this.visible||this.updateVisibility(!1)}_destroyResources(){this.destroyResources(),this._resourcesCreated=!1}}class c extends u{constructor(e){super(e.view),this._resources=null,this._transform=(0,n.e)()}get object(){return(0,r.r)(this._resources)?this._resources.object:null}get transform(){return this._transform}set transform(e){(0,s.n)(this._transform,e),(0,r.r)(this._resources)&&(this._resources.object.transformation=this._transform)}recreate(){this.attached&&this.createResources()}recreateGeometry(){if((0,r.t)(this._resources))return;const e=this._resources.object,t=this.view._stage;t.removeMany(e.geometries),e.removeAllGeometries(),this.createGeometries(e),this.visible||e.setVisible(this.visible),t.addMany(e.geometries)}createResources(){this.destroyResources();const e=this.view._stage;if(!e)return;const t=new h.n({isPickable:!1,updatePolicy:1});e.add(t);const i=new h.a6({castShadow:!1});i.transformation=this._transform,this.createExternalResources(),this.createGeometries(i),e.addMany(i.geometries),this.forEachExternalMaterial((t=>e.add(t))),e.add(i),t.add(i),this.visible||i.setVisible(!1),this._resources={layer:t,object:i}}destroyResources(){const e=this.view._stage;!(0,r.t)(this._resources)&&e&&(e.remove(this._resources.object),e.remove(this._resources.layer),this.forEachExternalMaterial((t=>{e.remove(t),t.dispose()})),e.removeMany(this._resources.object.geometries),this._resources.object.dispose(),this.destroyExternalResources(),this._resources=null)}updateVisibility(e){(0,r.t)(this._resources)||this._resources.object.setVisible(e)}}class d extends c{constructor(e){super(e),this._renderOccluded=4,this._width=1,this._color=(0,l.t)(1,0,1,1),this._innerWidth=1,this._innerColor=null,this._stipplePattern=null,this._stippleOffColor=null,this._stippleIntegerRepeats=!1,this._writeDepthEnabled=!0,this._falloff=0,this._polygonOffset=!1,this.applyProps(e)}setGeometryFromExtent(e){const t=this.view.spatialReference,i=(0,a.n)(),r=(0,a.n)(),s=100,n=[];(0,a.a)(i,e[0],e[1],s),this.view.renderCoordsHelper.toRenderCoords(i,t,r),n.push([r[0],r[1],r[2]]),(0,a.a)(i,e[2],e[1],s),this.view.renderCoordsHelper.toRenderCoords(i,t,r),n.push([r[0],r[1],r[2]]),(0,a.a)(i,e[2],e[3],s),this.view.renderCoordsHelper.toRenderCoords(i,t,r),n.push([r[0],r[1],r[2]]),(0,a.a)(i,e[0],e[3],s),this.view.renderCoordsHelper.toRenderCoords(i,t,r),n.push([r[0],r[1],r[2]]),(0,a.a)(i,e[0],e[1],s),this.view.renderCoordsHelper.toRenderCoords(i,t,r),n.push([r[0],r[1],r[2]]),(0,a.a)(i,e[0],e[1],s),this.view.renderCoordsHelper.toRenderCoords(i,t,r),n.push([r[0],r[1],r[2]]),this.geometry=[n]}setGeometryFromFrustum(e){const t=[];e.lines.forEach((e=>{t.push([e.origin[0],e.origin[1],e.origin[2]]),t.push([e.endpoint[0],e.endpoint[1],e.endpoint[2]])})),this.geometry=[t]}setGeometryFromBoundedPlane(e){const t=[],i=e.origin,r=e.basis1,s=e.basis2,n=.5,o=(0,a.n)(),l=(0,a.n)(),h=(0,a.n)(),u=(0,a.n)();o[0]=i[0]-r[0]*n-s[0]*n,o[1]=i[1]-r[1]*n-s[1]*n,o[2]=i[2]-r[2]*n-s[2]*n,l[0]=i[0]-r[0]*n+s[0]*n,l[1]=i[1]-r[1]*n+s[1]*n,l[2]=i[2]-r[2]*n+s[2]*n,h[0]=i[0]+r[0]*n+s[0]*n,h[1]=i[1]+r[1]*n+s[1]*n,h[2]=i[2]+r[2]*n+s[2]*n,u[0]=i[0]+r[0]*n-s[0]*n,u[1]=i[1]+r[1]*n-s[1]*n,u[2]=i[2]+r[2]*n-s[2]*n,t.push([o[0],o[1],o[2]]),t.push([l[0],l[1],l[2]]),t.push([h[0],h[1],h[2]]),t.push([u[0],u[1],u[2]]),t.push([o[0],o[1],o[2]]),this.geometry=[t]}setGeometryFromSegment(e){const t=e.endRenderSpace;(0,s.r)(p),(0,s.c)(p,p,t),this.transform=p;const{points:i}=e.createRenderGeometry(t,this.view.renderCoordsHelper);this.geometry=[i]}setGeometryFromSegments(e,t=a.G){(0,s.r)(p),(0,s.c)(p,p,t),this.transform=p,this.geometry=e.map((e=>e.createRenderGeometry(t,this.view.renderCoordsHelper).points))}get renderOccluded(){return this._renderOccluded}set renderOccluded(e){e!==this._renderOccluded&&(this._renderOccluded=e,this._updateMaterial())}get geometry(){return this._geometry}set geometry(e){this._geometry=e,this.recreateGeometry()}get width(){return this._width}set width(e){e!==this._width&&(this._width=e,this._updateMaterial())}get color(){return this._color}set color(e){(0,o.D)(e,this._color)||((0,o.a)(this._color,e),this._updateMaterial())}get innerWidth(){return this._innerWidth}set innerWidth(e){e!==this._innerWidth&&(this._innerWidth=e,this._updateMaterial())}get innerColor(){return this._innerColor}set innerColor(e){(0,r.r)(e)?!(0,r.t)(this._innerColor)&&(0,o.D)(e,this._innerColor)||(this._innerColor=(0,o.a)((0,l.a)(),e),this._updateMaterial()):(0,r.r)(this._innerColor)&&(this._innerColor=null,this._updateMaterial())}get stipplePattern(){return this._stipplePattern}set stipplePattern(e){const t=(0,r.r)(e)!==(0,r.r)(this._stipplePattern);this._stipplePattern=e,t?this.recreate():this._updateMaterial()}get stippleOffColor(){return this._stippleOffColor}set stippleOffColor(e){((0,r.t)(e)||(0,r.t)(this._stippleOffColor)||!(0,o.D)(e,this._stippleOffColor))&&(this._stippleOffColor=(0,r.r)(e)?(0,l.b)(e):null,this._updateMaterial())}get stippleIntegerRepeats(){return this._stippleIntegerRepeats}set stippleIntegerRepeats(e){this._stippleIntegerRepeats!==e&&(this._stippleIntegerRepeats=e,this._updateMaterial())}get writeDepthEnabled(){return this._writeDepthEnabled}set writeDepthEnabled(e){this._writeDepthEnabled!==e&&(this._writeDepthEnabled=e,this._updateMaterial())}get falloff(){return this._falloff}set falloff(e){e!==this._falloff&&(this._falloff=e,this._updateMaterial())}get polygonOffset(){return this._polygonOffset}set polygonOffset(e){e!==this._polygonOffset&&(this._polygonOffset=e,this._updateMaterial())}createExternalResources(){this._material=new h.a4(this.materialParameters)}destroyExternalResources(){this._material=null}createGeometries(e){const t=this._createLineGeometries();if(0!==t.length)for(let i=0;i<t.length;++i){const r=(0,h.a7)(t[i]);e.addGeometry(r,this._material)}}forEachExternalMaterial(e){e(this._material)}get materialParameters(){return{width:this._width,color:this._color,stippleOffColor:this._stippleOffColor,stipplePattern:this._stipplePattern,isClosed:!1,falloff:this._falloff,innerColor:this._innerColor,innerWidth:this._innerWidth,stippleIntegerRepeats:this._stippleIntegerRepeats,polygonOffset:this._polygonOffset,renderOccluded:this._renderOccluded,writeDepth:this._writeDepthEnabled}}_updateMaterial(){this.attached&&this._material.setParameterValues(this.materialParameters)}_createLineGeometries(){const e=this.geometry;if((0,r.t)(e)||0===e.length)return[];const t=[];return e.forEach((e=>{const i=e.length,r=new Float64Array(3*i);e.forEach(((e,t)=>{r[3*t+0]=e[0],r[3*t+1]=e[1],r[3*t+2]=e[2]}));const s={attributeData:{position:r},removeDuplicateStartEnd:0};t.push(s)})),t}}const p=(0,n.e)()},60978:(e,t,i)=>{"use strict";i.d(t,{n:()=>r,x:()=>c});const r={Base64:0,Hex:1,String:2,Raw:3};function s(e,t){const i=(65535&e)+(65535&t);return(e>>16)+(t>>16)+(i>>16)<<16|65535&i}function n(e,t,i,r,n,a){return s(function(e,t){return e<<t|e>>>32-t}(s(s(t,e),s(r,a)),n),i)}function a(e,t,i,r,s,a,o){return n(t&i|~t&r,e,t,s,a,o)}function o(e,t,i,r,s,a,o){return n(t&r|i&~r,e,t,s,a,o)}function l(e,t,i,r,s,a,o){return n(t^i^r,e,t,s,a,o)}function h(e,t,i,r,s,a,o){return n(i^(t|~r),e,t,s,a,o)}function u(e,t){e[t>>5]|=128<<t%32,e[14+(t+64>>>9<<4)]=t;let i=1732584193,r=-271733879,n=-1732584194,u=271733878;for(let t=0;t<e.length;t+=16){const c=i,d=r,p=n,f=u;i=a(i,r,n,u,e[t+0],7,-680876936),u=a(u,i,r,n,e[t+1],12,-389564586),n=a(n,u,i,r,e[t+2],17,606105819),r=a(r,n,u,i,e[t+3],22,-1044525330),i=a(i,r,n,u,e[t+4],7,-176418897),u=a(u,i,r,n,e[t+5],12,1200080426),n=a(n,u,i,r,e[t+6],17,-1473231341),r=a(r,n,u,i,e[t+7],22,-45705983),i=a(i,r,n,u,e[t+8],7,1770035416),u=a(u,i,r,n,e[t+9],12,-1958414417),n=a(n,u,i,r,e[t+10],17,-42063),r=a(r,n,u,i,e[t+11],22,-1990404162),i=a(i,r,n,u,e[t+12],7,1804603682),u=a(u,i,r,n,e[t+13],12,-40341101),n=a(n,u,i,r,e[t+14],17,-1502002290),r=a(r,n,u,i,e[t+15],22,1236535329),i=o(i,r,n,u,e[t+1],5,-165796510),u=o(u,i,r,n,e[t+6],9,-1069501632),n=o(n,u,i,r,e[t+11],14,643717713),r=o(r,n,u,i,e[t+0],20,-373897302),i=o(i,r,n,u,e[t+5],5,-701558691),u=o(u,i,r,n,e[t+10],9,38016083),n=o(n,u,i,r,e[t+15],14,-660478335),r=o(r,n,u,i,e[t+4],20,-405537848),i=o(i,r,n,u,e[t+9],5,568446438),u=o(u,i,r,n,e[t+14],9,-1019803690),n=o(n,u,i,r,e[t+3],14,-187363961),r=o(r,n,u,i,e[t+8],20,1163531501),i=o(i,r,n,u,e[t+13],5,-1444681467),u=o(u,i,r,n,e[t+2],9,-51403784),n=o(n,u,i,r,e[t+7],14,1735328473),r=o(r,n,u,i,e[t+12],20,-1926607734),i=l(i,r,n,u,e[t+5],4,-378558),u=l(u,i,r,n,e[t+8],11,-2022574463),n=l(n,u,i,r,e[t+11],16,1839030562),r=l(r,n,u,i,e[t+14],23,-35309556),i=l(i,r,n,u,e[t+1],4,-1530992060),u=l(u,i,r,n,e[t+4],11,1272893353),n=l(n,u,i,r,e[t+7],16,-155497632),r=l(r,n,u,i,e[t+10],23,-1094730640),i=l(i,r,n,u,e[t+13],4,681279174),u=l(u,i,r,n,e[t+0],11,-358537222),n=l(n,u,i,r,e[t+3],16,-722521979),r=l(r,n,u,i,e[t+6],23,76029189),i=l(i,r,n,u,e[t+9],4,-640364487),u=l(u,i,r,n,e[t+12],11,-421815835),n=l(n,u,i,r,e[t+15],16,530742520),r=l(r,n,u,i,e[t+2],23,-995338651),i=h(i,r,n,u,e[t+0],6,-198630844),u=h(u,i,r,n,e[t+7],10,1126891415),n=h(n,u,i,r,e[t+14],15,-1416354905),r=h(r,n,u,i,e[t+5],21,-57434055),i=h(i,r,n,u,e[t+12],6,1700485571),u=h(u,i,r,n,e[t+3],10,-1894986606),n=h(n,u,i,r,e[t+10],15,-1051523),r=h(r,n,u,i,e[t+1],21,-2054922799),i=h(i,r,n,u,e[t+8],6,1873313359),u=h(u,i,r,n,e[t+15],10,-30611744),n=h(n,u,i,r,e[t+6],15,-1560198380),r=h(r,n,u,i,e[t+13],21,1309151649),i=h(i,r,n,u,e[t+4],6,-145523070),u=h(u,i,r,n,e[t+11],10,-1120210379),n=h(n,u,i,r,e[t+2],15,718787259),r=h(r,n,u,i,e[t+9],21,-343485551),i=s(i,c),r=s(r,d),n=s(n,p),u=s(u,f)}return[i,r,n,u]}function c(e,t=r.Hex){const i=t||r.Base64,s=u(function(e){const t=[];for(let i=0,r=8*e.length;i<r;i+=8)t[i>>5]|=(255&e.charCodeAt(i/8))<<i%32;return t}(e),8*e.length);switch(i){case r.Raw:return s;case r.Hex:return function(e){const t="0123456789abcdef",i=[];for(let r=0,s=4*e.length;r<s;r++)i.push(t.charAt(e[r>>2]>>r%4*8+4&15)+t.charAt(e[r>>2]>>r%4*8&15));return i.join("")}(s);case r.String:return function(e){const t=[];for(let i=0,r=32*e.length;i<r;i+=8)t.push(String.fromCharCode(e[i>>5]>>>i%32&255));return t.join("")}(s);case r.Base64:return function(e){const t=[];for(let i=0,r=4*e.length;i<r;i+=3){const r=(e[i>>2]>>i%4*8&255)<<16|(e[i+1>>2]>>(i+1)%4*8&255)<<8|e[i+2>>2]>>(i+2)%4*8&255;for(let s=0;s<4;s++)8*i+6*s>32*e.length?t.push("="):t.push("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(r>>6*(3-s)&63))}return t.join("")}(s)}}},80497:(e,t,i)=>{"use strict";i.d(t,{c:()=>d});var r=i(78155),s=i(20215),n=i(80219),a=i(88903),o=i(13895),l=i(88190),h=i(30337),u=i(52957),c=i(81578);const d=e=>{let t=class extends e{initialize(){this.exportImageParameters=new l.n({layer:this.layer})}destroy(){this.exportImageParameters.destroy(),this.exportImageParameters=null}get exportImageVersion(){var e;return null==(e=this.exportImageParameters)||e.commitProperty("version"),this.commitProperty("timeExtent"),(this._get("exportImageVersion")||0)+1}async fetchPopupFeatures(e,t){const{layer:i}=this;if(!e)return Promise.reject(new s.s("mapimagelayerview:fetchPopupFeatures","Nothing to fetch without area",{layer:i}));const r=this.get("view.scale"),a=[],o=async e=>{const i=0===e.minScale||r<=e.minScale,s=0===e.maxScale||r>=e.maxScale;if(e.visible&&i&&s)if(e.sublayers)e.sublayers.forEach(o);else if(e.popupEnabled){const i=(0,c.d)(e,{...t,defaultPopupTemplateEnabled:!1});(0,n.r)(i)&&a.unshift({sublayer:e,popupTemplate:i})}},l=i.sublayers.toArray().reverse().map(o);await Promise.all(l);const u=a.map((async({sublayer:i,popupTemplate:r})=>{await i.load().catch((()=>{}));const s=i.createQuery(),a=(0,n.r)(t)?t.event:null,o=(0,h.s)({renderer:i.renderer,event:a}),l=this.createFetchPopupFeaturesQueryGeometry(e,o);s.geometry=l,s.outFields=await(0,c.t)(i,r);const u=await this._loadArcadeModules(r);return u&&u.arcadeUtils.hasGeometryOperations(r)||(s.maxAllowableOffset=l.width/o),(await i.queryFeatures(s)).features}));return(await(0,s.A)(u)).reduce(((e,t)=>t.value?[...e,...t.value]:e),[]).filter((e=>null!=e))}canResume(){var e;return!(!super.canResume()||null!=(e=this.timeExtent)&&e.isEmpty)}_loadArcadeModules(e){if(e.get("expressionInfos.length"))return(0,u.a)()}};return(0,r.e)([(0,a.y)()],t.prototype,"exportImageParameters",void 0),(0,r.e)([(0,a.y)({readOnly:!0})],t.prototype,"exportImageVersion",null),(0,r.e)([(0,a.y)()],t.prototype,"layer",void 0),(0,r.e)([(0,a.y)()],t.prototype,"suspended",void 0),(0,r.e)([(0,a.y)(o.u)],t.prototype,"timeExtent",void 0),t=(0,r.e)([(0,a.n)("esri.views.layers.MapImageLayerView")],t),t}},2566:(e,t,i)=>{"use strict";i.d(t,{E:()=>B,a:()=>V,b:()=>k,c:()=>at,e:()=>E,i:()=>_t,k:()=>gt,r:()=>A,t:()=>L,u:()=>vt}),i(33807);var r=i(80219),s=i(43356),n=(i(85774),i(93443),i(29218)),a=i(5772),o=i(84352),l=i(13838),h=i(20215),u=i(60816),c=i(94527),d=i(83991),p=i(25894),f=i(78191),y=i(29831),m=i(50388),g=i(24776),_=i(67726),x=i(40481),v=i(2098),b=(i(87405),i(91728)),w=i(11107),S=i(98128),I=i(97325),C=i(52957),M=i(81135),T=i(97431);function E(e,t){if(e&&"name"in e){const i=e;return t&&t.error(new h.s(i.name,i.message,i.details)),!1}return!0}const F=2147483647;class A{constructor(e){this._head=e,this._cursor=e}static from(e,t=0,i=e.byteLength/R.BYTES_PER_RECORD-t){const r=new R(new Int32Array(e,t*R.BYTES_PER_RECORD,i*R.ELEMENTS_PER_RECORD));return new A(r)}size(){var e,t;return null!=(e=null==(t=this._cursor)?void 0:t.size())?e:0}get id(){return this._cursor.id}set id(e){this._cursor.id=e}get materialKey(){return this._cursor.materialKey}set materialKey(e){this._cursor.materialKey=e}get insertAfter(){return this._cursor.insertAfter}get indexFrom(){return this._cursor.indexFrom}set indexFrom(e){this._cursor.indexFrom=e}get indexCount(){return this._cursor.indexCount}set indexCount(e){this._cursor.indexCount=e}get vertexFrom(){return this._cursor.vertexFrom}set vertexFrom(e){this._cursor.vertexFrom=e}get vertexCount(){return this._cursor.vertexCount}set vertexCount(e){this._cursor.vertexCount=e}get index(){return this._cursor._index}link(e){if(!this._head)return void(this._head=e._head);let t=this._head;for(;t._link;)t=t._link;t._link=e._head}getCursor(){return this.copy()}lookup(e){for(this._cursor=this._head;this._cursor&&!this._cursor.lookup(e);){if(!this._cursor._link)return!1;this._cursor=this._cursor._link}return!!this._cursor}copy(){var e;const t=new A(null==(e=this._head)?void 0:e.copy());if(!t._head)return t;let i=t._head,r=t._head._link;for(;r;)i._link=r.copy(),i=r,r=i._link;return t}next(){return!!this._cursor&&(!!this._cursor.next()||!!this._cursor._link&&(this._cursor=this._cursor._link,this.next()))}peekId(){var e;return null!=(e=this._cursor.peekId())?e:this._cursor._link.peekId()}delete(e){let t=this._head,i=null;for(;t;){if(t.delete(e))return t.isEmpty()&&((0,r.r)(i)&&(i._link=t._link),t===this._head&&(this._head=t._link),t===this._cursor&&(this._cursor=t._link)),!0;i=t,t=t._link}return!1}}A.ELEMENTS_PER_RECORD=s.Z,A.BYTES_PER_RECORD=A.ELEMENTS_PER_RECORD*Int32Array.BYTES_PER_ELEMENT;class R{constructor(e){this._link=null,this._index=-1,this._deletedCount=0,this._offsets={instance:null},this._packedRecords=e}static from(e,t=0,i=e.byteLength/this.BYTES_PER_RECORD-t){return new R(new Int32Array(e,t*this.BYTES_PER_RECORD,i*this.ELEMENTS_PER_RECORD))}delete(e){const t=this._index,i=this.lookup(e);if(i)for(this.id=F,++this._deletedCount;this.next()&&this.id===e;)this.id=F,++this._deletedCount;return this._index=t,i}isEmpty(){return this._deletedCount===this.size()}link(e){this._link?this._link.link(e):this._link=e}lookup(e){if((0,r.t)(this._offsets.instance)){this._offsets.instance=new Map;const e=this.copy();e._index=-1;let t=0;for(;e.next();)e.id!==t&&(this._offsets.instance.set(e.id,e._index),t=e.id)}if(!this._offsets.instance.has(e))return!1;const t=this._index;return this._index=this._offsets.instance.get(e),this.id!==F||(this._index=t,!1)}get id(){return this._packedRecords[this._index*R.ELEMENTS_PER_RECORD]}set id(e){this._packedRecords[this._index*R.ELEMENTS_PER_RECORD]=e}get materialKey(){return this._packedRecords[this._index*R.ELEMENTS_PER_RECORD+1]}set materialKey(e){this._packedRecords[this._index*R.ELEMENTS_PER_RECORD+1]=e}get insertAfter(){return this._packedRecords[this._index*R.ELEMENTS_PER_RECORD+2]}get indexFrom(){return this._packedRecords[this._index*R.ELEMENTS_PER_RECORD+3]}set indexFrom(e){this._packedRecords[this._index*R.ELEMENTS_PER_RECORD+3]=e}get indexCount(){return this._packedRecords[this._index*R.ELEMENTS_PER_RECORD+4]}set indexCount(e){this._packedRecords[this._index*R.ELEMENTS_PER_RECORD+4]=e}get vertexFrom(){return this._packedRecords[this._index*R.ELEMENTS_PER_RECORD+5]}set vertexFrom(e){this._packedRecords[this._index*R.ELEMENTS_PER_RECORD+5]=e}get vertexCount(){return this._packedRecords[this._index*R.ELEMENTS_PER_RECORD+6]}set vertexCount(e){this._packedRecords[this._index*R.ELEMENTS_PER_RECORD+6]=e}get index(){return this._index}size(){return this._packedRecords.length/R.ELEMENTS_PER_RECORD}next(){for(;++this._index<this.size()&&this.id===F;);return this._index<this.size()}peekId(){const e=(this._index+1)*R.ELEMENTS_PER_RECORD;return e>=this._packedRecords.length?0:this._packedRecords[e]}getCursor(){return this.copy()}copy(){const e=new R(this._packedRecords);return e._link=this._link,e._index=this._index,e._offsets=this._offsets,e._deletedCount=this._deletedCount,e}}R.ELEMENTS_PER_RECORD=s.Z,R.BYTES_PER_RECORD=R.ELEMENTS_PER_RECORD*Int32Array.BYTES_PER_ELEMENT;const P=new Map;function L(e){return P.get(e)}P.set(a.E.MARKER,{multiplier:1,indicesPerRecord:6,verticesPerRecord:4}),P.set(a.E.LINE,{multiplier:1,indicesPerRecord:24,verticesPerRecord:8}),P.set(a.E.FILL,{multiplier:1,indicesPerRecord:10,verticesPerRecord:10}),P.set(a.E.TEXT,{multiplier:8,indicesPerRecord:6,verticesPerRecord:4}),P.set(a.E.LABEL,{multiplier:8,indicesPerRecord:6,verticesPerRecord:4});const D={marker:a.E.MARKER,fill:a.E.FILL,line:a.E.LINE,text:a.E.TEXT};class N{constructor(e,t,i,r){const s={minScale:null==t?void 0:t.minScale,maxScale:null==t?void 0:t.maxScale},n=function(e){return e.minScale||e.maxScale?e.minScale+"-"+e.maxScale:""}(s);this.layers=e,this.data=t,this.hash=this._createHash()+n,this.rendererKey=i;for(const t of e){const e=D[t.type];t.materialKey=(0,f.A)(e,this.rendererKey,!1,!1),t.maxVVSize=r,t.scaleInfo=s,t.templateHash+=n}}get type(){return"expanded-cim"}_createHash(){let e="";for(const t of this.layers)e+=t.templateHash;return e}}const O=async(e,t)=>new N(await(0,S.k)(e.data,t),e.data,e.rendererKey,e.maxVVSize),k=async(e,t,i)=>{if(!e)return null;if("cim"===e.type)return O(e,t);if("web-style"===e.type){const r=M.b.fromJSON(e),s={type:"cim",data:(await r.fetchCIMSymbol(i)).data,rendererKey:e.rendererKey,maxVVSize:e.maxVVSize};return O(s,t)}return e};class V{constructor(e,t){this._pos=0;const i=t?this._roundToNearest(t,e.BYTES_PER_ELEMENT):40;this._array=new ArrayBuffer(i),this._buffer=new e(this._array),this._ctor=e,this._i16View=new Int16Array(this._array)}get length(){return this._pos}_roundToNearest(e,t){const i=Math.round(e);return i+(t-i%t)}_ensureSize(e){if(this._pos+e>=this._buffer.length){const t=this._roundToNearest(1.5*(this._array.byteLength+e*this._buffer.BYTES_PER_ELEMENT),this._buffer.BYTES_PER_ELEMENT),i=new ArrayBuffer(t),r=new this._ctor(i);r.set(this._buffer,0),this._array=i,this._buffer=r,this._i16View=new Int16Array(this._array)}}writeF32(e){this._ensureSize(1);const t=this._pos;return new Float32Array(this._array,4*this._pos,1)[0]=e,this._pos++,t}push(e){this._ensureSize(1);const t=this._pos;return this._buffer[this._pos++]=e,t}writeFixed(e){this._buffer[this._pos++]=e}setValue(e,t){this._buffer[e]=t}i1616Add(e,t,i){this._i16View[2*e]+=t,this._i16View[2*e+1]+=i}getValue(e){return this._buffer[e]}incr(e){if(this._buffer.length<e)throw new Error("Increment index overflows the target buffer");this._buffer[e]++}decr(e){this._buffer[e]--}writeRegion(e){this._ensureSize(e.length);const t=this._pos;return this._buffer.set(e,this._pos),this._pos+=e.length,t}writeManyFrom(e,t,i){this._ensureSize(i-t);for(let r=t;r!==i;r++)this.writeFixed(e._buffer[r])}buffer(){const e=this._array.slice(0,4*this._pos);return this.destroy(),e}toArray(){const e=this._array,t=[];for(let i=0;i<e.byteLength/4;i++)t.push(e[i]);return t}seek(e){this._pos=e}destroy(){this._array=null,this._buffer=null}}class U{constructor(e,t,i){this._start={index:0,vertex:0};const r=function(e,t,i){const{indicesPerRecord:r,multiplier:n,verticesPerRecord:a}=P.get(e);return{recordBytes:i*s.Z*Uint32Array.BYTES_PER_ELEMENT,indexBytes:n*r*i*Uint32Array.BYTES_PER_ELEMENT,vertexBytes:n*a*i*t}}(e,t,i),n=t/4;this.geometryType=e,this._records=new V(Int32Array,r.recordBytes),this._indices=new V(Uint32Array,r.indexBytes),this._vertices=new V(Uint32Array,r.vertexBytes),this._metrics=new V(Float32Array,0),this._strideInt=n}serialize(e){const t=this._records.buffer(),i=this._indices.buffer(),r=this._vertices.buffer(),s=this._metrics.length?this._metrics.buffer():null,n=4*this._strideInt;return e.push(t,i,r),{stride:n,records:t,indices:i,vertices:r,metrics:s}}get strideInt(){return this._strideInt}get recordCount(){return this._records.length/s.Z}get vertexCount(){return this._vertices.length/this._strideInt}get indexCount(){return this._indices.length}get indexWriter(){return this._indices}get vertexWriter(){return this._vertices}get metricWriter(){return this._metrics}recordStart(){this._start.index=this._indices.length,this._start.vertex=this._vertices.length}recordEnd(e,t,i,r,s,n,a){this._records.push(e),this._records.push(t),this._records.push(i),this._records.push(r),this._records.push(s),this._records.push(n),this._records.push(a)}writeIndex(e){this._indices.push(e)}writeVertex(e){this._vertices.push(e)}writeVertexF32(e){this._vertices.writeF32(e)}copyLastFrom(e,t,i){const r=e._records.length-7,s=e._records.getValue(r),n=e._records.getValue(r+1),a=e._records.getValue(r+2),o=e._records.getValue(r+4),l=e._records.getValue(r+6),h=this._vertices.length,u=(e._start.vertex-this._vertices.length)/this._strideInt,c=this._indices.length,d=this.vertexCount;for(let t=e._start.index;t!==e._indices.length;t++){const i=e._indices.getValue(t);this._indices.push(i-u)}for(let t=e._start.vertex;t!==e._vertices.length;t++){const i=e._vertices.getValue(t);this._vertices.push(i)}for(let e=h;e<=this._vertices.length;e+=this._strideInt)this._vertices.i1616Add(e,t,i);this._records.push(s),this._records.push(n),this._records.push(a),this._records.push(c),this._records.push(o),this._records.push(d),this._records.push(l)}}function G(e){switch(e){case 1:case 8:case 32:return-1;case 2:case 64:return 0;case 4:case 16:case 128:return 1}}function z(e){switch(e){case 1:case 2:case 4:return-1;case 8:case 16:return 0;case 32:case 64:case 128:return 1}}class B{constructor(e,t,i,r,s){this._hasDotDensity=!1,this._hasAggregate=!1,this.hasRecords=!1,this._data={self:new Map,neighbors:new Array},this._current={geometryType:0,writer:null,overlaps:0,start:0,insertAfter:0,id:0,materialKey:0,indexStart:0,vertStart:0,isDotDensity:!1,bufferingEnabled:!1,metricBoxLenPointer:0},this.hint=t,this.tileKey=e,this._hasDotDensity=i,this._hasAggregate=r,this._pixelBufferEnabled=s}get hasAggregates(){return this._hasAggregate}get hasPixelBufferEnabled(){return this._pixelBufferEnabled}serialize(e){const t=[];return t.push(this._serializeTileVertexData(this.tileKey,this._data.self)),this._data.neighbors.forEach(((i,r)=>{const s=1<<r,a=G(s),o=z(s),h=(0,l.l)(new n.e(this.tileKey),a,o,e);t.push(this._serializeTileVertexData(h.id,i))})),t}_serializeTileVertexData(e,t){var i,r,s,n,o;const l=new Array;return{message:{tileKey:e,data:{[a.E.MARKER]:null==(i=t.get(a.E.MARKER))?void 0:i.serialize(l),[a.E.FILL]:null==(r=t.get(a.E.FILL))?void 0:r.serialize(l),[a.E.LINE]:null==(s=t.get(a.E.LINE))?void 0:s.serialize(l),[a.E.TEXT]:null==(n=t.get(a.E.TEXT))?void 0:n.serialize(l),[a.E.LABEL]:null==(o=t.get(a.E.LABEL))?void 0:o.serialize(l)}},transferList:l}}featureStart(e=0){this._current.insertAfter=e}featureEnd(){}recordStart(e,t,i,r,s){this._current.writer=this._getVertexWriter(i,r),this._current.overlaps=0,this._current.indexStart=this._current.writer.indexCount,this._current.vertStart=this._current.writer.vertexCount,this._current.bufferingEnabled=s,this._current.id=e,this._current.materialKey=t,this._current.geometryType=i,this._current.isDotDensity=!1,this._current.writer.recordStart()}recordCount(){return this._current.writer.recordCount}vertexCount(){return this._current.writer.vertexCount}indexCount(){return this._current.writer.indexCount}vertexBounds(e,t,i,r){this._current.bufferingEnabled&&this._addOverlap(e,t,i,r)}vertexWrite(e){this._current.writer.writeVertex(e)}vertexWriteF32(e){this._current.writer.writeVertexF32(e)}vertexEnd(){}vertexWriter(){return this._current.writer.vertexWriter}indexWrite(e){this._current.writer.writeIndex(e)}indexWriter(){return this._current.writer.indexWriter}metricWriter(){return this._current.writer.metricWriter}metricStart(e,t,i,r,s,n,l,h){this._current.writer=this._getVertexWriter(a.E.LABEL,!1);const u=this._current.writer.metricWriter;u.push((0,o.M)(e)),u.push(t),u.push(i),u.push(r),u.push(s),u.push(n),u.push(l),u.push(h),u.push(255),this._current.metricBoxLenPointer=u.push(0)}metricEnd(){const e=this._current.writer.metricWriter;0===e.getValue(this._current.metricBoxLenPointer)&&e.seek(e.length-10)}metricBoxWrite(e,t,i,r){const s=this._current.writer.metricWriter;s.incr(this._current.metricBoxLenPointer),s.push(0),s.push(0),s.push(e),s.push(t),s.push(i),s.push(r)}recordEnd(){const e=this._current.indexStart,t=this._current.writer.indexCount;if(e===t)return!1;this.hasRecords=!0;const i=t-e,r=this._current.vertStart,n=this._current.writer.vertexCount-r;if(this._current.writer.recordEnd(this._current.id,this._current.materialKey,this._current.insertAfter,e,i,r,n),!this._pixelBufferEnabled||this._hasAggregate||0===this._current.overlaps||this._current.geometryType===a.E.LABEL)return!0;const o=this._current.writer;for(let e=0;e<8;e++){const t=1<<e;if(this._current.overlaps&t){if(!this._data.neighbors[e]){const t=new Map;this._data.neighbors[e]=t}const i=this._data.neighbors[e],r=this._current.geometryType;if(!i.has(r)){const e=(0,a.T)(r,this._current.isDotDensity).geometry;i.set(r,new U(r,e,s.$))}const n=i.get(this._current.geometryType),l=8,h=512*-G(t)*l,u=512*-z(t)*l;n.copyLastFrom(o,h,u)}}return!0}_addOverlap(e,t,i,r){const n=255^((e<0+i?148:e>=s.o-i?41:189)|(t<0+r?224:t>=s.o-r?7:231));this._current.overlaps|=n}_getVertexWriter(e,t){if(!this._data.self.has(e)){const t=this._data.self,i=(0,a.T)(e,this._hasDotDensity).geometry;t.set(e,new U(e,i,8e3))}return this._data.self.get(e)}}const j=100;function q(e,t,i){return e[0]=t[0]-i[0],e[1]=t[1]-i[1],e}function H(e,t){return Math.sqrt(e*e+t*t)}function W(e){const t=H(e[0],e[1]);e[0]/=t,e[1]/=t}function Q(e,t){return H(e[0]-t[0],e[1]-t[1])}function Z(e){return"function"==typeof e}function Y(e=2){return 1/Math.max(e,1)}function J(e,t){return[!!e.minScale&&t.scaleToZoom(e.minScale)||0,!!e.maxScale&&t.scaleToZoom(e.maxScale)||j]}function X(e){return e.length-1}function $(e,t,i=1){const[r,s]=function(e,t){return e[t+1]}(e,t);return Math.sqrt(r*r+s*s)*i}class K{constructor(e,t,i,r,s){this._segments=e,this._index=t,this._distance=i,this._xStart=r,this._yStart=s,this._done=!1}static create(e){return new K(e,0,0,e[0][0],e[0][1])}clone(){return new K(this._segments,this._index,this._distance,this.xStart,this.yStart)}equals(e){return this._index===e._index||e._index===this._index-1&&(0===this._distance||1===e._distance)||e._index===this._index+1&&(1===this._distance||0===e._distance)}leq(e){return this._index<e._index||this._index===e._index&&this._distance<=e._distance}geq(e){return this._index>e._index||this._index===e._index&&this._distance>=e._distance}get _segment(){return this._segments[this._index+1]}get angle(){const e=this.dy,t=(0*e+-1*-this.dx)/(1*this.length);let i=Math.acos(t);return e>0&&(i=2*Math.PI-i),i}get xStart(){return this._xStart}get yStart(){return this._yStart}get x(){return this.xStart+this.distance*this.dx}get y(){return this.yStart+this.distance*this.dy}get dx(){return this._segment[0]}get dy(){return this._segment[1]}get xMidpoint(){return this.xStart+.5*this.dx}get yMidpoint(){return this.yStart+.5*this.dy}get xEnd(){return this.xStart+this.dx}get yEnd(){return this.yStart+this.dy}get length(){const{dx:e,dy:t}=this;return Math.sqrt(e*e+t*t)}get remainingLength(){return this.length*(1-this._distance)}get backwardLength(){return this.length*this._distance}get distance(){return this._distance}get done(){return this._done}hasPrev(){return this._index-1>=0}hasNext(){return this._index+1<X(this._segments)}next(){return this.hasNext()?(this._xStart+=this.dx,this._yStart+=this.dy,this._distance=0,this._index+=1,this):null}prev(){return this.hasPrev()?(this._index-=1,this._xStart-=this.dx,this._yStart-=this.dy,this._distance=1,this):(this._done=!0,null)}_seekBackwards(e,t){const i=this.backwardLength;if(e<=i)return this._distance=(i-e)/this.length,this;let r=this.backwardLength;for(;this.prev();){if(r+this.length>e)return this._seekBackwards(e-r);r+=this.length}return this._distance=0,t?this:null}seek(e,t=!1){if(e<0)return this._seekBackwards(Math.abs(e),t);if(e<=this.remainingLength)return this._distance=(this.backwardLength+e)/this.length,this;let i=this.remainingLength;for(;this.next();){if(i+this.length>e)return this.seek(e-i,t);i+=this.length}return this._distance=1,t?this:null}}function ee(e,t,i){const r=function(e){let t=0;for(let i=0;i<X(e);i++)t+=$(e,i);return t}(e),s=K.create(e),n=r/2,a=(r-t)/2,o=Math.floor(a/t),l=n-o*t;s.seek(l);for(let e=-o;e<=o;e++)s.x<512&&s.x>=0&&s.y<512&&s.y>=0&&i(s.clone(),e,n+e*t,r),s.seek(t)}function te(e,t){const i=1e-6;if(t<=0)return;const r=e.length;if(r<3)return;const s=[];let n=0;s.push(0);for(let t=1;t<r;t++)n+=Q(e[t],e[t-1]),s.push(n);t=Math.min(t,.2*n);const a=[];a.push(e[0][0]),a.push(e[0][1]);const o=e[r-1][0],l=e[r-1][1],h=q([0,0],e[0],e[1]);W(h),e[0][0]+=t*h[0],e[0][1]+=t*h[1],q(h,e[r-1],e[r-2]),W(h),e[r-1][0]+=t*h[0],e[r-1][1]+=t*h[1];for(let e=1;e<r;e++)s[e]+=t;s[r-1]+=t;const u=.5*t;for(let n=1;n<r-1;n++){let o=0,l=0,h=0;for(let r=n-1;r>=0&&!(s[r+1]<s[n]-u);r--){const a=u+s[r+1]-s[n],c=s[r+1]-s[r],d=s[n]-s[r]<u?1:a/c;if(Math.abs(d)<i)break;const p=d*d,f=d*a-.5*p*c,y=d*c/t,m=e[r+1],g=e[r][0]-m[0],_=e[r][1]-m[1];o+=y/f*(m[0]*d*a+.5*p*(a*g-c*m[0])-p*d*c*g/3),l+=y/f*(m[1]*d*a+.5*p*(a*_-c*m[1])-p*d*c*_/3),h+=y}for(let a=n+1;a<r&&!(s[a-1]>s[n]+u);a++){const r=u-s[a-1]+s[n],c=s[a]-s[a-1],d=s[a]-s[n]<u?1:r/c;if(Math.abs(d)<i)break;const p=d*d,f=d*r-.5*p*c,y=d*c/t,m=e[a-1],g=e[a][0]-m[0],_=e[a][1]-m[1];o+=y/f*(m[0]*d*r+.5*p*(r*g-c*m[0])-p*d*c*g/3),l+=y/f*(m[1]*d*r+.5*p*(r*_-c*m[1])-p*d*c*_/3),h+=y}a.push(o/h),a.push(l/h)}a.push(o),a.push(l);for(let t=0,i=0;t<r;t++)e[t][0]=a[i++],e[t][1]=a[i++]}class ie{static getPlacement(e,t,i){const r=(0,m.A)(t);if(!r)return null;const s=(0,m.o)(e);return r.execute(s,t,i)}}const re=e=>class extends e{constructor(...e){super(...e),this._isCIM=!1,this._vertexBoundsScale=1,this.geometryType=a.E.TEXT,this._aux=(0,a.w)(0,0,this._referenceSize,this._bitset)}bindTextInfo(e,t){e&&e.length?this._shapingInfo=(0,r.A)(e,(e=>(0,d.b)(e,t,{scale:this._scale,angle:this._angle,xOffset:this._xOffset,yOffset:this._yOffset,hAlign:this._xAlignD,vAlign:this._yAlignD,maxLineWidth:Math.max(32,Math.min(this._lineWidth,512)),lineHeight:s.s*Math.max(.25,Math.min(this._lineHeight,4)),decoration:this._decoration,isCIM:this._isCIM}))):this._shapingInfo=null}_write(e,t,i){const r=t.getDisplayId();this._writeGeometry(e,t,r,i)}_writeGeometry(e,t,i,s){const n=this._shapingInfo;if((0,r.t)(n))return;if((0,r.r)(this._textPlacement)){const r=null!=s?s:t.readLegacyGeometry();return this._writePlacedText(e,i,r,n)}const a=s?(0,y.b)((0,y.X)(s),2):"esriGeometryPolygon"===t.geometryType?t.readCentroid():t.readUnquantizedGeometry();if(a){if(a.isPoint){const[t,r]=a.coords;return this._writeGlyphs(e,i,{x:t,y:r},n)}a.forEachVertex(((t,r)=>this._writeGlyphs(e,i,{x:t,y:r},n)))}}_writePlacedText(e,t,i,s){const n=(0,r.f)(this._textPlacement),a=ie.getPlacement(i,n,(0,c.u)(1));if(!a)return;let o=a.next();for(;null!=o;){const i=o.getAngle();s.setRotation(i),this._writeGlyphs(e,t,{x:o.tx,y:o.ty},s),s.setRotation(-i),o=a.next()}}_writeGlyphs(e,t,i,r){const s=f._.load(this._materialKey),n=(0,a.m)(Math.round(8*i.x),Math.round(8*i.y));for(const i of r.glyphs){s.textureBinding=i.textureBinding,e.recordStart(t,s.data,this.geometryType,!1,!0);const r=i.bounds,a=this._vertexBoundsScale;e.vertexBounds(r.x*a,r.y*a,r.width*a,r.height*a),this._writeVertices(e,t,n,i),e.recordEnd()}}_writeGlyph(e,t,i,r,s){const n=f._.load(this._materialKey),o=(0,a.m)(Math.round(8*i),Math.round(8*r));n.textureBinding=s.textureBinding,e.recordStart(t,n.data,this.geometryType,!1,!0);const l=s.bounds,h=this._vertexBoundsScale;e.vertexBounds(l.x*h,l.y*h,l.width*h,l.height*h),this._writeVertices(e,t,o,s),e.recordEnd()}_writeVertices(e,t,i,r){const s=e.vertexCount();this._writeVertexCommon(e,t,i,r),e.vertexWrite(r.offsets.upperLeft),e.vertexWrite(r.texcoords.upperLeft),e.vertexEnd(),this._writeVertexCommon(e,t,i,r),e.vertexWrite(r.offsets.upperRight),e.vertexWrite(r.texcoords.upperRight),e.vertexEnd(),this._writeVertexCommon(e,t,i,r),e.vertexWrite(r.offsets.lowerLeft),e.vertexWrite(r.texcoords.lowerLeft),e.vertexEnd(),this._writeVertexCommon(e,t,i,r),e.vertexWrite(r.offsets.lowerRight),e.vertexWrite(r.texcoords.lowerRight),e.vertexEnd(),e.indexWrite(s+0),e.indexWrite(s+1),e.indexWrite(s+2),e.indexWrite(s+1),e.indexWrite(s+3),e.indexWrite(s+2)}_writeVertexCommon(e,t,i,r){const s=this._color,n=this._haloColor,o=(0,a.w)(0,0,this._referenceSize,this._bitset),l=(0,a.w)(0,0,this._size,this._haloSize);e.vertexWrite(i),e.vertexWrite(t),e.vertexWrite(s),e.vertexWrite(n),e.vertexWrite(l),e.vertexWrite(o),e.vertexWrite(this._minMaxZoom)}};class se{static executeEffects(e,t){const i=(0,m.o)(t);let r=new m.r(i);for(const t of e){const e=(0,m.G)(t);e&&(r=e.execute(r,t,1.3333333333333333))}return r}static next(e){const t=e.next();return(0,m.p)(t),t}}class ne{bindFeature(e,t,i){}write(e,t,i){if((0,r.t)(this._effects))return this._write(e,t);const s=se.executeEffects(this._effects,t.readLegacyGeometry());let n=se.next(s);for(;n;)this._write(e,t,n),n=se.next(s)}_write(e,t,i){}}class ae extends(re(ne)){constructor(e,t,i,r,n,o,l,h,u,p,y,m,g,_,x,v,b,w=!1,S,I){super(),this._xOffset=(0,c.u)(m),this._yOffset=(0,c.u)(g),this._decoration=u||"none",this._color=r,this._haloColor=n,this._haloSize=Math.min(Math.floor(5*(0,c.u)((0,c.o)(i))),127),this._size=Math.min(Math.round((0,c.u)(t)),127);const C=Math.min(Math.round((0,c.u)(t)),127);this._referenceSize=Math.round(Math.sqrt(256*C)),this._scale=this._size/24,this._angle=y,this._justify=(0,d.s)(o||"center"),this._xAlignD=(0,d.r)(o||"center"),this._yAlignD=(0,d.c)(l||"baseline"),this._baseline="baseline"===(l||"baseline"),this._bitset=(1===h?1:0)|(p?1:0)<<1;const M=f._.load(e);M.sdf=!0,this._materialKey=M.data,this._lineWidth=(0,c.u)(_)||512,this._lineHeight=x||1,this._textPlacement=v,this._effects=b,this._isCIM=w,this._minMaxZoom=(0,a.m)(Math.round(S*s.e),Math.round(I*s.e))}static fromText(e,t){const i=new ae(e.materialKey,e.font.size,e.haloSize||0,e.color&&(0,p.f)(e.color)||0,e.haloColor&&(0,p.f)(e.haloColor)||0,e.horizontalAlignment,e.verticalAlignment,0,e.font.decoration,!1,e.angle||0,e.xoffset,e.yoffset,e.lineWidth,e.lineHeight,null,null,!1,0,j),[,r]=(0,d.n)(e.text);return i.bindTextInfo(t,r),i._vertexBoundsScale=e.maxVVSize?e.maxVVSize/e.font.size:1,i}static fromCIMText(e,t,i){const r=e.scaleFactor||1,s=e.size*e.sizeRatio*r,[n,a]=J(e.scaleInfo,i),o=new ae(e.materialKey,s,e.outlineSize*e.sizeRatio,(0,p.i)(e.color),(0,p.i)(e.outlineColor),e.horizontalAlignment,e.verticalAlignment,e.alignment,e.decoration,e.colorLocked,e.angle,e.offsetX*e.sizeRatio*r,e.offsetY*e.sizeRatio*r,512,1,e.markerPlacement,e.effects,!0,n,a),[,l]=(0,d.n)(e.text);return o.bindTextInfo(t,l),o._vertexBoundsScale=e.maxVVSize?e.maxVVSize/s:1,o}}const oe=r.n.getLogger("esri.views.2d.engine.webgl.WGLLabelTemplate"),le=function(e){const t=new Map;return e=>(t.has(e)||t.set(e,(e=>{let t=0;if(0===e)return 1/0;for(;!(e%2);)t++,e/=2;return t})(e)),t.get(e))}(),he=e=>Math.floor(127*e+127),ue=e=>Math.floor(10*e),ce=e=>Math.round(e*(254/360));class de extends ae{constructor(e,t,i,r){super(e,i.font.size,i.haloSize||0,i.color&&(0,p.f)(i.color)||0,i.haloColor&&(0,p.f)(i.haloColor)||0,i.horizontalAlignment,i.verticalAlignment,(0,f.e)(t.labelPlacement)?1:0,i.font.decoration,!1,i.angle||0,i.xoffset,i.yoffset,i.lineWidth,i.lineHeight,null,null,null,null,null),this._outLineLabelAngle=0,this._refPlacementPadding=0,this._refPlacementDirX=0,this._refPlacementDirY=0,this._refOffsetX=0,this._refOffsetY=0,this._zoomLevel=0,this.geometryType=a.E.LABEL;const n=function(e,t){const i=!!e.minScale&&t.scaleToZoom(e.minScale)||0;return(0,u.o)(i,0,25.5)}(t,r),o=function(e,t){const i=!!e.maxScale&&t.scaleToZoom(e.maxScale)||255;return(0,u.o)(i,0,25.5)}(t,r),l=t.labelPlacement,[h,y]=(0,d.d)(l);this._xAlignD=h,this._yAlignD=y,this._minZoom=n,this._maxZoom=o,this._refPlacementPadding=(0,c.u)(i.haloSize)+s.j;const m=f.N.load(e);m.sdf=!0,this._materialKey=m.data}static fromLabelClass(e,t){if("esriServerLinePlacementCenterAlong"===e.labelPlacement){const t=e.symbol;t.xoffset=0,t.yoffset=0,t.angle=0,t.font.decoration="none"}return new de(e.materialKey,e,e.symbol,t)}get _shapedBox(){return(0,r.f)(this._shapingInfo).bounds}setZoomLevel(e){this._zoomLevel=e}bindReferenceTemplate(e){let t=(0,d.e)(this._xAlignD),i=(0,d.o)(this._yAlignD);if(this._refOffsetX=0,this._refOffsetY=0,(0,r.t)(e))return void(this._refSymbolAndPlacementOffset=(0,a.w)(0,0,he(t),he(i)));if("circle"===e.boundsType&&(t||i)){const e=Math.sqrt(t*t+i*i);t/=e,i/=e}const s=Math.max(e.height,e.width),n=4*this._refPlacementPadding;this._refSymbolAndPlacementOffset=(0,a.w)(n,s,he(t),he(i)),this._referenceSize=s,this._refPlacementDirX=t,this._refPlacementDirY=i,this._refOffsetX=e.xOffset,this._refOffsetY=e.yOffset}_write(e,t){if((0,r.t)(this._shapingInfo))return;const i=this._shapingInfo,s=t.getDisplayId(),n="esriGeometryPolygon"===t.geometryType?t.readLegacyCentroid():t.readLegacyGeometry();if(n)switch(this.current={out:e,inId:s,inShaping:i,zoomLevel:this._zoomLevel},t.geometryType){case"esriGeometryPolyline":this._placeLineLabels(n);break;case"esriGeometryPoint":case"esriGeometryPolygon":this._placePointLabels(n);break;default:((e,t="mapview-labeling")=>{oe.error(new h.s(t,e))})("mapview-labeling",`Geometry of type ${t.geometryType} is not supported`)}}_isVisible(e,t){const i=ue(this.current.zoomLevel);return ue(e)<=i&&i<=ue(t)}_placePointLabels(e){const{out:t,inId:i,inShaping:r}=this.current;this._writeGlyphs(t,i,e,r)}_placeLineLabels(e){const t=function(e,t){const i=t;for(let t=0;t<e.length;t++){let r=e[t];const s=[];s.push(r[0]);for(let e=1;e<r.length;e++){let[t,i]=s[e-1];t+=r[e][0],i+=r[e][1],s.push([t,i])}te(s,i);const n=[];n.push(s[0]);for(let e=1;e<s.length;e++){const[t,i]=s[e-1],[r,a]=s[e],o=Math.round(r-t),l=Math.round(a-i);n.push([o,l])}e[t]=n,r=n}return e}(e.paths,this.current.inShaping.bounds.width),i=this._placeSubdivGlyphs.bind(this),r=(this._shapedBox.width+128)/2;for(const e of t)ee(e,r,i)}_placeSubdivGlyphs(e,t,i,r){const s=le(t),n=this._shapedBox.width/2,a=Math.min(i,r-i),o=(0,u.V)(a/(8+n/2)),l=0===t?o:Math.min(s,o),h=Math.max(this._minZoom,this.current.zoomLevel+1-l),c=this.current.zoomLevel-h,d=this._shapedBox.width/2*2**c;this.current.inShaping.isMultiline?0===t&&this._placeStraight(e,h):this._placeCurved(e,h,d)}_placeStraight(e,t){const{out:i,inId:r,inShaping:s}=this.current;this._writeGlyphs(i,r,e,s,t)}_placeCurved(e,t,i){const{out:r,inId:s}=this.current;r.metricStart(s,t,e.x,e.y,0,0,0,0);const n=e.clone(),a=e.angle*(180/Math.PI)%360,o=(e.angle*(180/Math.PI)+180)%360;this._outLineLabelAngle=ce(a),this._placeFirst(n,t,1),this._placeBack(e,n,t,i,1),this._placeForward(e,n,t,i,1),this._outLineLabelAngle=ce(o),this._placeFirst(n,t,0),this._placeBack(e,n,t,i,0),this._placeForward(e,n,t,i,0),r.metricEnd()}_placeBack(e,t,i,r,s){const n=e.clone();let a=e.backwardLength+0;for(;n.prev()&&!(a>=r);)this._placeOnSegment(n,t,a,i,-1,s),a+=n.length+0}_placeForward(e,t,i,r,s){const n=e.clone();let a=e.remainingLength+0;for(;n.next()&&!(a>=r);)this._placeOnSegment(n,t,a,i,1,s),a+=n.length+0}_placeFirst(e,t,i){const r=e,s=this.current.inShaping,n=s.glyphs,a=this.current.zoomLevel,{out:o,inId:l}=this.current;for(const h of n){const n=h.x>s.bounds.x?i:1-i,c=n*e.remainingLength+(1-n)*e.backwardLength,d=Math.abs(h.x+h.width/2-s.bounds.x),p=Math.max(0,a+(0,u.V)(d/(c+0))),f=Math.max(t,p);if(h.maxZoom=25,h.angle=e.angle+(1-i)*Math.PI,h.minZoom=f,!(r.x<0||r.x>=512||r.y<0||r.y>=512)&&(this._writeGlyph(o,l,r.x,r.y,h),i&&this._isVisible(h.minZoom,h.maxZoom))){const e=h.bounds;o.metricBoxWrite(e.center[0],e.center[1],e.width,e.height)}}}_placeOnSegment(e,t,i,r,s,n){const a=this.current.inShaping.glyphs,{out:o,inId:l}=this.current,h=this.current.inShaping,c=this.current.zoomLevel,d=e.dx/e.length,p=e.dy/e.length,f={x:e.x+i*-s*d,y:e.y+i*-s*p};for(const d of a){const a=d.x>h.bounds.x?n:1-n;if(!(a&&1===s||!a&&-1===s))continue;const p=Math.abs(d.x+d.width/2-h.bounds.x),y=Math.max(0,c+(0,u.V)(p/i)-.1),m=Math.max(r,c+(0,u.V)(p/(i+e.length+0)));if(0!==y&&(d.angle=e.angle+(1-n)*Math.PI,d.minZoom=m,d.maxZoom=y,!(f.x<0||f.x>=512||f.y<0||f.y>=512)&&(this._writeGlyph(o,l,f.x,f.y,d),n&&this._isVisible(d.minZoom,d.maxZoom)))){const i=d.bounds,r=e.x-t.x,s=e.y-t.y;o.metricBoxWrite(i.center[0]+r,i.center[1]+s,i.width,i.height)}}}_writeGlyphs(e,t,i,r,s=this._minZoom){if(i.x<0||i.x>=512||i.y<0||i.y>=512)return;const n=i.x+this._refOffsetX,a=i.y-this._refOffsetY;for(const i of r.glyphs)i.minZoom=s,i.maxZoom=this._maxZoom,this._writeGlyph(e,t,n,a,i);const o=this._refPlacementDirX,l=this._refPlacementDirY,h=r.boundsT;e.metricStart(t,s,n,a,o,l,this._referenceSize,this._materialKey),e.metricBoxWrite(h.center[0],h.center[1],h.width,h.height),e.metricEnd()}_writeVertexCommon(e,t,i,r){const s=this._color,n=this._haloColor,o=(0,a.w)(0,0,this._size,this._haloSize),l=Math.max(r.minZoom,this._minZoom),h=Math.min(r.maxZoom,this._maxZoom),u=(0,a.w)(ue(l),ue(h),this._outLineLabelAngle,0);e.vertexWrite(i),e.vertexWrite(t),e.vertexWrite(s),e.vertexWrite(n),e.vertexWrite(o),e.vertexWrite(this._refSymbolAndPlacementOffset),e.vertexWrite(u)}}const pe=3.14159265359/180,fe=e=>class extends e{constructor(...e){super(...e),this.angle=0,this.xOffset=0,this.yOffset=0,this.width=0,this.height=0,this.boundsType="square",this._anchorX=0,this._anchorY=0,this._computedWidth=0,this._computedHeight=0,this._vertexBoundsScaleX=1,this._vertexBoundsScaleY=1,this._offsets={xUpperLeft:0,yUpperLeft:0,xUpperRight:0,yUpperRight:0,xBottomLeft:0,yBottomLeft:0,xBottomRight:0,yBottomRight:0},this.geometryType=a.E.MARKER}_write(e,t,i){const r=t.getDisplayId();e.recordStart(r,this._materialKey,this.geometryType,!1,!0),this._writeGeometry(e,t,r,i),e.recordEnd()}_writeGeometry(e,t,i,s){if((0,r.r)(this._markerPlacement))return this._writePlacedMarkers(e,t,s);const n=s?(0,y.b)((0,y.X)(s),2):"esriGeometryPolygon"===t.geometryType?t.readCentroid():t.readUnquantizedGeometry();if(n){if(n.isPoint){const[t,r]=n.coords;if(!e.hasAggregates&&e.hasPixelBufferEnabled&&(t<-1||t>=513||r<-1||r>=513))return;return this._writeVertices(e,i,this._getPos(t,r),t,r)}n.forEachVertex(((t,r)=>this._writeVertices(e,i,this._getPos(t,r),t,r)))}}_writePlacedMarkers(e,t,i){const s=null!=i?i:t.readLegacyGeometry(),n=ie.getPlacement(s,(0,r.f)(this._markerPlacement),(0,c.u)(1));if(!n)return;const a=t.getDisplayId(),o=(0,g.b)(),l=(0,g.a)();let h=n.next();for(;null!=h;){const{tx:t,ty:i}=h;t>=-128&&t<=640&&i>=-128&&i<=640&&(this._applyTransformation(l,o,h.getAngle()/pe),this._writeVertices(e,a,this._getPos(t,i),t,i)),h=n.next()}}_writeVertices(e,t,i,r,s){const n=e.vertexCount();e.vertexBounds(r+this.xOffset,s-this.yOffset,this._computedWidth*this._vertexBoundsScaleX,this._computedHeight*this._vertexBoundsScaleY),e.vertexWrite(i),e.vertexWrite(this._offsetUpperLeft),e.vertexWrite(this._texUpperLeft),e.vertexWrite(this._bitestAndDistRatio),e.vertexWrite(t),e.vertexWrite(this._fillColor),e.vertexWrite(this._outlineColor),e.vertexWrite(this._sizeOutlineWidth),e.vertexWrite(this._minMaxZoom),e.vertexEnd(),e.vertexWrite(i),e.vertexWrite(this._offsetUpperRight),e.vertexWrite(this._texUpperRight),e.vertexWrite(this._bitestAndDistRatio),e.vertexWrite(t),e.vertexWrite(this._fillColor),e.vertexWrite(this._outlineColor),e.vertexWrite(this._sizeOutlineWidth),e.vertexWrite(this._minMaxZoom),e.vertexEnd(),e.vertexWrite(i),e.vertexWrite(this._offsetBottomLeft),e.vertexWrite(this._texBottomLeft),e.vertexWrite(this._bitestAndDistRatio),e.vertexWrite(t),e.vertexWrite(this._fillColor),e.vertexWrite(this._outlineColor),e.vertexWrite(this._sizeOutlineWidth),e.vertexWrite(this._minMaxZoom),e.vertexEnd(),e.vertexWrite(i),e.vertexWrite(this._offsetBottomRight),e.vertexWrite(this._texBottomRight),e.vertexWrite(this._bitestAndDistRatio),e.vertexWrite(t),e.vertexWrite(this._fillColor),e.vertexWrite(this._outlineColor),e.vertexWrite(this._sizeOutlineWidth),e.vertexWrite(this._minMaxZoom),e.vertexEnd(),e.indexWrite(n+0),e.indexWrite(n+1),e.indexWrite(n+2),e.indexWrite(n+1),e.indexWrite(n+3),e.indexWrite(n+2)}_applyTransformation(e,t,i=0){(0,g.n)(e),(0,g.i)(e,e,(0,g.t)(this.xOffset,-this.yOffset)),this.angle+i!==0&&(0,g.c)(e,e,pe*(this.angle+i));const r=this._computedWidth,s=this._computedHeight,n=(this._anchorX-.5)*r,o=(this._anchorY-.5)*s;(0,_.r)(t,n,o),(0,_.D)(t,t,e),this._offsetUpperLeft=(0,a.m)(16*t[0],16*t[1]),this._offsets.xUpperLeft=t[0],this._offsets.yUpperLeft=t[1],(0,_.r)(t,n+r,o),(0,_.D)(t,t,e),this._offsetUpperRight=(0,a.m)(16*t[0],16*t[1]),this._offsets.xUpperRight=t[0],this._offsets.yUpperRight=t[1],(0,_.r)(t,n,o+s),(0,_.D)(t,t,e),this._offsetBottomLeft=(0,a.m)(16*t[0],16*t[1]),this._offsets.xBottomLeft=t[0],this._offsets.yBottomLeft=t[1],(0,_.r)(t,n+r,o+s),(0,_.D)(t,t,e),this._offsetBottomRight=(0,a.m)(16*t[0],16*t[1]),this._offsets.xBottomRight=t[0],this._offsets.yBottomRight=t[1]}_getPos(e,t){return(0,a.m)(Math.round(8*e),Math.round(8*t))}};class ye extends(fe(ne)){constructor(e,t,i,r,n,o,l,h,u,c,d,p,y,m,_,x,v,b,w,S,I,C,M){super(),this.angle=r,this.height=l,this.width=o,this.xOffset=t*w,this.yOffset=i*w,this._markerPlacement=S,this._effects=I,this._anchorX=.5-(.5+x)*_.width/_.width,this._anchorY=.5-(.5+v)*_.height/_.height,this._minMaxZoom=(0,a.m)(Math.round(C*s.e),Math.round(M*s.e));const T=(1===m?1:0)|(d?1:0)<<1|(y?1:0)<<2|(p?1:0)<<3,E=_&&_.sdf,F=f.w.load(e);F.sdf=E,F.pattern=!0,F.textureBinding=_.textureBinding,this._materialKey=F.data,this._fillColor=n,this._outlineColor=u,this._sizeOutlineWidth=(0,a.w)(Math.round(Math.min(Math.sqrt(128*o),255)),Math.round(Math.min(Math.sqrt(128*l),255)),Math.round(Math.min(Math.sqrt(128*c),255)),Math.round(Math.min(Math.sqrt(128*h),255)));const A=_.rect.x+s.Y,R=_.rect.y+s.Y,P=A+_.width,L=R+_.height;this._offsets.xUpperLeft=A,this._offsets.yUpperLeft=R,this._offsets.xUpperRight=P,this._offsets.yUpperRight=R,this._offsets.xBottomLeft=A,this._offsets.yBottomLeft=L,this._offsets.xBottomRight=P,this._offsets.yBottomRight=L,this._texUpperLeft=(0,a.m)(A,R),this._texUpperRight=(0,a.m)(P,R),this._texBottomLeft=(0,a.m)(A,L),this._texBottomRight=(0,a.m)(P,L),o*=b,l*=b,o*=w,l*=w;const D=Math.round(64*b);this._bitestAndDistRatio=(0,a.m)(T,D),this._computedWidth=o,this._computedHeight=l;const N=(0,g.b)(),O=(0,g.a)();this._applyTransformation(O,N)}static fromCIMMarker(e,t,i){const s=t&&t.width||1,n=t&&t.height||1,a=e.size,o=s/n*e.scaleX,l=e.scaleSymbolsProportionally&&e.frameHeight?a/e.frameHeight:1,h=(0,p.i)(e.color),u=(0,p.i)(e.outlineColor),d=(0,c.u)(a),f=d*o,y=(0,c.u)(e.offsetX||0),m=(0,c.u)(e.offsetY||0),g=(0,c.u)(e.outlineWidth||0)*l,_=e.alignment||0,x=(0,c.u)(e.referenceSize),[v,b]=J(e.scaleInfo,i);let w=e.rotation||0;e.rotateClockwise||(w=-w);let S=0,I=0;const C=e.anchorPoint;C&&(e.isAbsoluteAnchorPoint?a&&(S=-C.x/(a*o),I=C.y/a):(S=C.x,I=C.y));const M=new ye(e.materialKey,y,m,w,h,f,d,x,u,g,e.colorLocked,e.scaleSymbolsProportionally,!1,_,t,S,I,e.sizeRatio,(0,r.q)(e.scaleFactor,1),e.markerPlacement,e.effects,v,b);return M._vertexBoundsScaleX=e.maxVVSize?e.maxVVSize/f:1,M._vertexBoundsScaleY=e.maxVVSize?e.maxVVSize/d:1,M}static fromPictureMarker(e,t){const i=Math.round((0,c.u)(e.width)),r=Math.round((0,c.u)(e.height)),n=s.i,a=Math.round((0,c.u)(e.xoffset||0)),o=Math.round((0,c.u)(e.yoffset||0)),l=new ye(e.materialKey,a,o,e.angle,n,i,r,r,0,0,!1,!1,!1,0,t,0,0,1,1,null,null,0,j);return l._vertexBoundsScaleX=e.maxVVSize?e.maxVVSize/e.width:1,l._vertexBoundsScaleY=e.maxVVSize?e.maxVVSize/e.height:1,l}static fromSimpleMarker(e,t){const i=(0,p.f)(e.color),r=Math.round((0,c.u)(e.size)),s=r,n=Math.round((0,c.u)(e.xoffset||0)),a=Math.round((0,c.u)(e.yoffset||0)),o=e.style,l=e.outline,h=0|(l&&l.color&&(0,p.f)(l.color)),u=0|(l&&l.width&&Math.round((0,c.u)(l.width))),d=new ye(e.materialKey,n,a,e.angle,i,r,s,s,h,u,!1,!1,"esriSMSCross"===o||"esriSMSX"===o,0,t,0,0,126/64,1,null,null,0,j);return d.boundsType="esriSMSCircle"===o?"circle":"square",d._vertexBoundsScaleX=e.maxVVSize?e.maxVVSize/e.size:1,d._vertexBoundsScaleY=e.maxVVSize?e.maxVVSize/e.size:1,d}static fromLineSymbolMarker(e,t){const i=(0,p.f)(e.color),r=Math.round((0,c.u)(6*e.lineWidth)),s=r,n="cross"===e.style||"x"===e.style;let a;switch(e.placement){case"begin-end":a="Both";break;case"begin":a="JustBegin";break;case"end":a="JustEnd";break;default:a="None"}const o={type:"CIMMarkerPlacementAtExtremities",angleToLine:!0,offset:0,extremityPlacement:a,offsetAlongLine:0},l=new ye(e.materialKey,0,0,0,i,r,s,s/6,i,n?Math.round((0,c.u)(e.lineWidth)):0,!1,!1,n,1,t,0,0,126/64,1,o,null,0,j);return l.boundsType="circle"===e.style?"circle":"square",l}}function me(e,t,i,r,s,n,a){Ge=0;const o=(r-i)*n,l=s&&s.length,h=l?(s[0]-i)*n:o;let u,c,d,p,f,y=ge(t,i,0,0,h,n,!0);if(y&&y.next!==y.prev){if(l&&(y=function(e,t,i,r,s,n){const a=new Array;for(let s=0,o=r.length;s<o;s++){const l=ge(e,t,0,r[s]*n,s<o-1?r[s+1]*n:i*n,n,!1);l===l.next&&(l.steiner=!0),a.push(Ie(l))}a.sort(Le);for(const e of a)Ce(e,s),s=_e(s,s.next);return s}(t,i,r,s,y,n)),o>80*n){u=d=t[0+i*n],c=p=t[1+i*n];for(let e=n;e<h;e+=n){const r=t[e+i*n],s=t[e+1+i*n];u=Math.min(u,r),c=Math.min(c,s),d=Math.max(d,r),p=Math.max(p,s)}f=Math.max(d-u,p-c),f=0!==f?1/f:0}xe(y,e,n,u,c,f,a,0)}}function ge(e,t,i,r,s,n,a){let o;if(a===function(e,t,i,r,s,n){let a=0;for(let i=r,o=s-n;i<s;i+=n)a+=(e[o+t*n]-e[i+t*n])*(e[i+1+t*n]+e[o+1+t*n]),o=i;return a}(e,t,0,r,s,n)>0)for(let i=r;i<s;i+=n)o=we(i+t*n,e[i+t*n],e[i+1+t*n],o);else for(let i=s-n;i>=r;i-=n)o=we(i+t*n,e[i+t*n],e[i+1+t*n],o);return o&&Pe(o,o.next)&&(Se(o),o=o.next),o}function _e(e,t=e){if(!e)return e;let i,r=e;do{if(i=!1,r.steiner||!Pe(r,r.next)&&0!==Te(r.prev,r,r.next))r=r.next;else{if(Se(r),r=t=r.prev,r===r.next)break;i=!0}}while(i||r!==t);return t}function xe(e,t,i,r,s,n,a,o){if(!e)return;!o&&n&&(e=Me(e,r,s,n));let l=e;for(;e.prev!==e.next;){const h=e.prev,u=e.next;if(n?be(e,r,s,n):ve(e))t.push(h.index/i+a),t.push(e.index/i+a),t.push(u.index/i+a),Se(e),e=u.next,l=u.next;else if((e=u)===l){o?1===o?xe(e=De(e,t,i,a),t,i,r,s,n,a,2):2===o&&Ne(e,t,i,r,s,n,a):xe(_e(e),t,i,r,s,n,a,1);break}}}function ve(e){const t=e.prev,i=e,r=e.next;if(Te(t,i,r)>=0)return!1;let s=e.next.next;const n=s;let a=0;for(;s!==e.prev&&(0===a||s!==n);){if(a++,Fe(t.x,t.y,i.x,i.y,r.x,r.y,s.x,s.y)&&Te(s.prev,s,s.next)>=0)return!1;s=s.next}return!0}function be(e,t,i,r){const s=e.prev,n=e,a=e.next;if(Te(s,n,a)>=0)return!1;const o=s.x<n.x?s.x<a.x?s.x:a.x:n.x<a.x?n.x:a.x,l=s.y<n.y?s.y<a.y?s.y:a.y:n.y<a.y?n.y:a.y,h=s.x>n.x?s.x>a.x?s.x:a.x:n.x>a.x?n.x:a.x,u=s.y>n.y?s.y>a.y?s.y:a.y:n.y>a.y?n.y:a.y,c=Re(o,l,t,i,r),d=Re(h,u,t,i,r);let p=e.prevZ,f=e.nextZ;for(;p&&p.z>=c&&f&&f.z<=d;){if(p!==e.prev&&p!==e.next&&Fe(s.x,s.y,n.x,n.y,a.x,a.y,p.x,p.y)&&Te(p.prev,p,p.next)>=0)return!1;if(p=p.prevZ,f!==e.prev&&f!==e.next&&Fe(s.x,s.y,n.x,n.y,a.x,a.y,f.x,f.y)&&Te(f.prev,f,f.next)>=0)return!1;f=f.nextZ}for(;p&&p.z>=c;){if(p!==e.prev&&p!==e.next&&Fe(s.x,s.y,n.x,n.y,a.x,a.y,p.x,p.y)&&Te(p.prev,p,p.next)>=0)return!1;p=p.prevZ}for(;f&&f.z<=d;){if(f!==e.prev&&f!==e.next&&Fe(s.x,s.y,n.x,n.y,a.x,a.y,f.x,f.y)&&Te(f.prev,f,f.next)>=0)return!1;f=f.nextZ}return!0}function we(e,t,i,r){const s=Ve.create(e,t,i);return r?(s.next=r.next,s.prev=r,r.next.prev=s,r.next=s):(s.prev=s,s.next=s),s}function Se(e){e.next.prev=e.prev,e.prev.next=e.next,e.prevZ&&(e.prevZ.nextZ=e.nextZ),e.nextZ&&(e.nextZ.prevZ=e.prevZ)}function Ie(e){let t=e,i=e;do{(t.x<i.x||t.x===i.x&&t.y<i.y)&&(i=t),t=t.next}while(t!==e);return i}function Ce(e,t){if(t=function(e,t){let i=t;const r=e.x,s=e.y;let n,a=-1/0;do{if(s<=i.y&&s>=i.next.y&&i.next.y!==i.y){const e=i.x+(s-i.y)*(i.next.x-i.x)/(i.next.y-i.y);if(e<=r&&e>a){if(a=e,e===r){if(s===i.y)return i;if(s===i.next.y)return i.next}n=i.x<i.next.x?i:i.next}}i=i.next}while(i!==t);if(!n)return null;if(r===a)return n.prev;const o=n,l=n.x,h=n.y;let u,c=1/0;for(i=n.next;i!==o;)r>=i.x&&i.x>=l&&r!==i.x&&Fe(s<h?r:a,s,l,h,s<h?a:r,s,i.x,i.y)&&(u=Math.abs(s-i.y)/(r-i.x),(u<c||u===c&&i.x>n.x)&&Ae(i,e)&&(n=i,c=u)),i=i.next;return n}(e,t)){const i=ke(t,e);_e(i,i.next)}}function Me(e,t,i,r){for(let s;s!==e;s=s.next){if(s=s||e,null===s.z&&(s.z=Re(s.x,s.y,t,i,r)),s.prev.next!==s||s.next.prev!==s)return s.prev.next=s,s.next.prev=s,Me(e,t,i,r);s.prevZ=s.prev,s.nextZ=s.next}return e.prevZ.nextZ=null,e.prevZ=null,function(e){let t,i=1;for(;;){let r,s=e;e=null,t=null;let n=0;for(;s;){n++,r=s;let a=0;for(;a<i&&r;a++)r=r.nextZ;let o=i;for(;a>0||o>0&&r;){let i;0===a?(i=r,r=r.nextZ,o--):0!==o&&r?s.z<=r.z?(i=s,s=s.nextZ,a--):(i=r,r=r.nextZ,o--):(i=s,s=s.nextZ,a--),t?t.nextZ=i:e=i,i.prevZ=t,t=i}s=r}if(t.nextZ=null,i*=2,n<2)return e}}(e)}function Te(e,t,i){return(t.y-e.y)*(i.x-t.x)-(t.x-e.x)*(i.y-t.y)}function Ee(e,t,i,r){return!!(Pe(e,t)&&Pe(i,r)||Pe(e,r)&&Pe(i,t))||Te(e,t,i)>0!=Te(e,t,r)>0&&Te(i,r,e)>0!=Te(i,r,t)>0}function Fe(e,t,i,r,s,n,a,o){return(s-a)*(t-o)-(e-a)*(n-o)>=0&&(e-a)*(r-o)-(i-a)*(t-o)>=0&&(i-a)*(n-o)-(s-a)*(r-o)>=0}function Ae(e,t){return Te(e.prev,e,e.next)<0?Te(e,t,e.next)>=0&&Te(e,e.prev,t)>=0:Te(e,t,e.prev)<0||Te(e,e.next,t)<0}function Re(e,t,i,r,s){return(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=32767*(e-i)*s)|e<<8))|e<<4))|e<<2))|e<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-r)*s)|t<<8))|t<<4))|t<<2))|t<<1))<<1}function Pe(e,t){return e.x===t.x&&e.y===t.y}function Le(e,t){return e.x-t.x}function De(e,t,i,r){let s=e;do{const n=s.prev,a=s.next.next;!Pe(n,a)&&Ee(n,s,s.next,a)&&Ae(n,a)&&Ae(a,n)&&(t.push(n.index/i+r),t.push(s.index/i+r),t.push(a.index/i+r),Se(s),Se(s.next),s=e=a),s=s.next}while(s!==e);return s}function Ne(e,t,i,r,s,n,a){let o=e;do{let e=o.next.next;for(;e!==o.prev;){if(o.index!==e.index&&Oe(o,e)){let l=ke(o,e);return o=_e(o,o.next),l=_e(l,l.next),xe(o,t,i,r,s,n,a,0),void xe(l,t,i,r,s,n,a,0)}e=e.next}o=o.next}while(o!==e)}function Oe(e,t){return e.next.index!==t.index&&e.prev.index!==t.index&&!function(e,t){let i=e;do{if(i.index!==e.index&&i.next.index!==e.index&&i.index!==t.index&&i.next.index!==t.index&&Ee(i,i.next,e,t))return!0;i=i.next}while(i!==e);return!1}(e,t)&&Ae(e,t)&&Ae(t,e)&&function(e,t){let i=e,r=!1;const s=(e.x+t.x)/2,n=(e.y+t.y)/2;do{i.y>n!=i.next.y>n&&i.next.y!==i.y&&s<(i.next.x-i.x)*(n-i.y)/(i.next.y-i.y)+i.x&&(r=!r),i=i.next}while(i!==e);return r}(e,t)}function ke(e,t){const i=Ve.create(e.index,e.x,e.y),r=Ve.create(t.index,t.x,t.y),s=e.next,n=t.prev;return e.next=t,t.prev=e,i.next=s,s.prev=i,r.next=i,i.prev=r,n.next=r,r.prev=n,r}class Ve{constructor(){this.index=0,this.x=0,this.y=0,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1}static create(e,t,i){const r=Ge<Ue.length?Ue[Ge++]:new Ve;return r.index=e,r.x=t,r.y=i,r.prev=null,r.next=null,r.z=null,r.prevZ=null,r.nextZ=null,r.steiner=!1,r}}const Ue=new Array;let Ge=0;for(let e=0;e<8096;e++)Ue.push(new Ve);const ze=new w.o,Be=new w.n(0,0,0,1,0),je=new w.n(0,0,0,1,0);function qe(e,t,i){let r=0;for(let s=1;s<i;s++){const i=e[2*(t+s-1)],n=e[2*(t+s-1)+1];r+=(e[2*(t+s)]-i)*(e[2*(t+s)+1]+n)}return r}function He(e,t,i,r,s){let n=0;for(let a=i;a<r;a+=3){const i=2*(e.getValue(a)-s),r=2*(e.getValue(a+1)-s),o=2*(e.getValue(a+2)-s);n+=Math.abs((t[i]-t[o])*(t[r+1]-t[i+1])-(t[i]-t[r])*(t[o+1]-t[i+1]))}return n}Be.setExtent(s.o),je.setExtent(s.o);const We=e=>class extends e{constructor(...e){super(...e),this.forceLibtess=!1,this.geometryType=a.E.FILL}_write(e,t,i){const r="esriGeometryPoint"===t.geometryType,s=f.C.load(this._materialKey);e.recordStart(t.getDisplayId(),this._materialKey,this.geometryType,s.dotDensity,r),this._writeGeometry(e,t,s,i,r),e.recordEnd()}_writeGeometry(e,t,i,s,n){const a=this._getGeometry(t,s,n);if((0,r.t)(a))return;const o=e.indexCount();if(!(a.lengths[0]>1e3)&&!this.forceLibtess&&function(e,t){const{coords:i,lengths:r,hasIndeterminateRingOrder:s}=t,n=e.indexWriter(),a=e.vertexCount();if(s)return!1;const o=n.length;let l=0;for(let e=0;e<r.length;){let t=e,s=r[e],h=qe(i,l,s);const u=[];for(;++t<r.length;){const e=r[t],n=qe(i,l+s,e);if(!(n>0))break;h+=n,u.push(l+s),s+=e}const c=n.length;me(n,i,l,l+s,u,2,a);const d=He(n,i,c,n.length,a),p=Math.abs(h);if(Math.abs((d-p)/Math.max(1e-7,p))>1e-5)return n.seek(o),!1;e=t,l+=s}return!0}(e,a))return void(!(o===e.indexCount())&&this._writeVertices(e,t,a.coords,a.lengths,i));const l=function(e,t){const i=[],r=[],s=e.indexWriter(),n=e.vertexCount(),{coords:a,lengths:o}=t;ze.beginPolygon(i,r);let l=0;for(let e=0;e<o.length;e++){const i=t.lengths[e];ze.beginContour();for(let e=0;e<i;e++){const t=[a[2*(l+e)],a[2*(l+e)+1],0];ze.addVertex(t,t)}ze.endContour(),l+=i}ze.endPolygon();for(let e=0;e<r.length;e++)s.push(r[e]+n);return i}(e,a);o!==e.indexCount()&&this._writeVertices(e,t,l,[l.length/2],i)}_writeVertices(e,t,i,r,s){const n=t.getDisplayId();let o=0;for(const l of r){const r=l+o;for(let l=o;l<r;l++){const r=i[2*l],o=i[2*l+1],h=(0,a.m)(1*r,1*o);e.vertexBounds(r,o,0,0),e.vertexWrite(h),e.vertexWrite(n),s.dotDensity?e.vertexWriteF32(1/Math.abs(t.readGeometryArea())):(e.vertexWrite(this.fillColor),e.vertexWrite(this.tl),e.vertexWrite(this.br),e.vertexWrite(this.aux1),e.vertexWrite(this.aux2),e.vertexWrite(this.aux3),e.vertexWrite(this._minMaxZoom))}o+=l}}_getGeometry(e,t,i){const r=t?(0,y.b)((0,y.X)(t),2):e.readUnquantizedGeometry();return r?function(e,t){if(!function(e,t,i){let r=0;for(let t=0;t<e.lengths.length;t++){const s=e.lengths[t];for(let t=0;t<s;t++){const s=e.coords[2*(t+r)],n=e.coords[2*(t+r)+1];if(s<-128||s>i||n<-128||n>i)return!0}r+=s}return!1}(e,0,s.o+128))return e;Be.setPixelMargin(t),Be.reset(3);let i=0;for(let t=0;t<e.lengths.length;t++){const r=e.lengths[t];let s=e.coords[2*(0+i)],n=e.coords[2*(0+i)+1];Be.moveTo(s,n);for(let t=1;t<r;t++)s=e.coords[2*(t+i)],n=e.coords[2*(t+i)+1],Be.lineTo(s,n);Be.close(),i+=r}const r=Be.result(!1);if(!r)return null;const n=[],a=[];for(const e of r){let t=0;for(const i of e)a.push(i.x),a.push(i.y),t++;n.push(t)}return new b.a(n,a)}(r,i?256:128):null}},Qe=r.n.getLogger("esri.views.2d.engine.webgl.WGLDynamicMeshTemplate");class Ze extends ne{constructor(e){super(),this._ongoingMaterialRequestMap=new Map,this._materialCache=new Map,this._dynamicPropertyMap=new Map,this._cimLayer=e}analyze(e,t,i,r){const s=t.readLegacyFeature(),n=this._materialCache,a=this._cimLayer.materialHash;if(!a)return Qe.error("A Dynamic mesh template must have a material hash value or function!"),Promise.reject(null);const o="function"==typeof a?a(s,i,r):a;if(n.has(o)){const e=n.get(o);return Promise.resolve(e)}if(this._ongoingMaterialRequestMap.has(o))return this._ongoingMaterialRequestMap.get(o);const l=(0,S.T)(this._cimLayer.cim,this._cimLayer.materialOverrides);l.mosaicHash=o;const h=e.getMosaicItem(l).then((e=>(this._ongoingMaterialRequestMap.delete(o),n.set(o,e),e))).catch((e=>(this._ongoingMaterialRequestMap.delete(o),Qe.error(".analyze()",e.message),null)));return this._ongoingMaterialRequestMap.set(o,h),h}}const Ye=128;class Je extends(We(Ze)){constructor(e,t,i){var r;if(super(e),this._minMaxZoom=(0,a.m)(Math.round(t*s.e),Math.round(i*s.e)),Z(e.color)){const t=(t,i,r)=>{const s=e.color(t,i,r);return s&&(0,p.i)(s)||0};this._dynamicPropertyMap.set("fillColor",t)}else{const t=e.color;this.fillColor=t&&(0,p.i)(t)||0}let n=0;Z(e.height)||(n=e.height||0);const o="CIMMarkerPlacementInsidePolygon"===(null==(r=e.cim.placement)?void 0:r.type)&&e.cim.placement.shiftOddRows?2:1;this._dynamicPropertyMap.set("_height",((t,i,r)=>Z(e.height)?e.height(t,i,r)*o:n*o));let l=0;Z(e.offsetX)||(l=(0,c.u)(e.offsetX||0)+Ye,l>255&&(l=255)),this._dynamicPropertyMap.set("_offsetX",((t,i,r)=>{if(Z(e.offsetX)){let s=(0,c.u)(e.offsetX(t,i,r))+Ye;return s>255&&(s=255),s}return l}));let h=1;Z(e.scaleX)||(h=e.scaleX||1),this._dynamicPropertyMap.set("_scaleX",((t,i,r)=>Z(e.scaleX)?e.scaleX(t,i,r):h));let u=0;Z(e.offsetY)||(u=(0,c.u)(-e.offsetY||0)+Ye,u>255&&(u=255)),this._dynamicPropertyMap.set("_offsetY",((t,i,r)=>{if(Z(e.offsetY)){let s=(0,c.u)(-e.offsetY(t,i,r))+Ye;return s>255&&(s=255),s}return u}));let d=0;Z(e.angle)||(d=(0,v.h)(e.angle)||0),this._dynamicPropertyMap.set("_angle",((t,i,r)=>Z(e.angle)?(0,v.h)(e.angle(t,i,r)):d)),this._effects=e.effects,this._cimFillLayer=e,this._fillMaterialKey=f.C.load(e.materialKey)}static fromCIMFill(e,t){const[i,r]=J(e.scaleInfo,t);return new Je(e,i,r)}bindFeature(e,t,i){const r=e.readLegacyFeature();this._dynamicPropertyMap.forEach(((e,s)=>{this[s]=e(r,t,i)}));const n=this._fillMaterialKey,o=this._materialCache,l=this._cimFillLayer;this.aux3=(0,a.w)(0,0,this._angle,l.colorLocked?1:0);const h=(0,l.materialHash)(r,t,i),d=o.get(h);let p=null;if(d&&E(d.spriteMosaicItem)&&(p=d.spriteMosaicItem),p){const{rect:e,width:t,height:i}=p,r=e.x+s.Y,o=e.y+s.Y,l=r+t,h=o+i;let d=(0,u.O)((0,c.u)(this._height));d>255?d=255:d<=0&&(d=(0,u.O)(h-o));let f=(0,u.O)((0,c.u)(this._height/i*t||0));f>255?f=255:f<=0&&(f=(0,u.O)(l-r));const y=this._scaleX,m=1;this.tl=(0,a.m)(r,o),this.br=(0,a.m)(l,h),this.aux1=(0,a.w)(f,d,this._offsetX,this._offsetY),this.aux2=(0,a.m)(Ye*y,Ye*m),n.sdf=p.sdf,n.pattern=!0,n.textureBinding=p.textureBinding}else this.tl=0,this.br=0,this.aux1=0,this.aux2=0,n.sdf=!1,n.pattern=!1,n.textureBinding=0;this._materialKey=n.data}}const Xe=31,$e=e=>class extends e{constructor(...e){super(...e),this.tessellationProperties={},this._tessellationOptions={halfWidth:0,pixelCoordRatio:1,offset:0},this.geometryType=a.E.LINE}_initializeTessellator(e){const t=f.b.load(this._materialKey),i=this._tessellationOptions,r=t.vvSizeFieldStops||t.vvSizeMinMaxValue||t.vvSizeScaleStops||t.vvSizeUnitValue,n=this.tessellationProperties._halfWidth<s.S;this.tessellationProperties.minMaxZoom=this._minMaxZoom;const a=n&&!e&&!r;i.wrapDistance=65535,i.textured=this._isDashed||this._hasPattern,i.offset=this.tessellationProperties.offset,i.halfWidth=this.tessellationProperties._halfWidth;const o=a?0:1;this._lineTessellator=new w.a(Ke(this.tessellationProperties,o,o),et(this.tessellationProperties),a)}_write(e,t,i){const r="esriGeometryPoint"===t.geometryType;e.recordStart(t.getDisplayId(),this._materialKey,this.geometryType,!1,r),this._writeGeometry(e,t,i,r),e.recordEnd()}_writeGeometry(e,t,i,s){const n=null!=i?i:t.readLegacyGeometry(),a=this._getLines(n,s);(0,r.t)(a)||this._writeVertices(e,t,a)}_getLines(e,t){if((0,r.t)(e))return null;const i=e.paths||e.rings;return(0,r.t)(i)?null:function(e,t){je.setPixelMargin(t);const i=je,r=-t,n=s.o+t;let a=[],o=!1,l=0;for(;l<e.length;){const t=[],s=e[l];i.reset(2);let[h,u]=s[0];if(o)i.moveTo(h,u);else{if(h<r||h>n||u<r||u>n){o=!0;continue}t.push({x:h,y:u})}let c=!1;const d=s.length;for(let e=1;e<d;++e)if(h+=s[e][0],u+=s[e][1],o)i.lineTo(h,u);else{if(h<r||h>n||u<r||u>n){c=!0;break}t.push({x:h,y:u})}if(c)o=!0;else{if(o){const e=i.resultWithStarts();if(e)for(const t of e)a.push(t)}else a.push({line:t,start:0});l++,o=!1}}return a=a.filter((e=>e.line.length>1)),0===a.length?null:a}(i,t?256:16)}_writeVertices(e,t,i){const r=t.getDisplayId(),s=e.vertexCount(),n=this.tessellationProperties,a=this._tessellationOptions;n.out=e,n.id=r,n.indexCount=0,n.vertexCount=0,n.offset=s,a.capType=this._capType,a.joinType=this._joinType;for(const{line:e,start:t}of i)a.initialDistance=t%65535,this._lineTessellator.tessellate(e,a)}},Ke=(e,t,i)=>(r,s,n,o,l,h,u,c,d,p,f)=>{const y=(0,a.m)(f,Math.ceil(1024*e._halfWidth)),m=(0,a.w)(Math.round(Xe*u),Math.round(Xe*c),Math.round(Xe*d),Math.round(Xe*p)),g=(0,a.w)(Xe*l,Xe*h,0,e._bitset),_=e.out;return _.vertexBounds(r,s,t,i),_.vertexWrite((0,a.m)(8*r,8*s)),_.vertexWrite(e.id),_.vertexWrite(e._fillColor),_.vertexWrite(m),_.vertexWrite(y),_.vertexWrite(e._tl),_.vertexWrite(e._br),_.vertexWrite(g),_.vertexWrite((0,a.m)(Math.ceil(1024*e._halfReferenceWidth),0)),_.vertexWrite(e.minMaxZoom),_.vertexEnd(),e.offset+e.vertexCount++},et=e=>(t,i,r)=>{const s=e.out;s.indexWrite(t),s.indexWrite(i),s.indexWrite(r),e.indexCount+=3};class tt extends($e(Ze)){constructor(e,t,i){super(e),this._minMaxZoom=(0,a.m)(Math.round(t*s.e),Math.round(i*s.e)),this._cimLineLayer=e;let r=0;if(Z(e.width)||(r=.5*(0,c.u)(e.width)),this._dynamicPropertyMap.set("_halfWidth",((t,i,s)=>Z(e.width)?.5*(0,c.u)(e.width(t,i,s)):r)),Z(e.cap)?this._dynamicPropertyMap.set("_capType",e.cap):this._capType=e.cap,Z(e.join)?this._dynamicPropertyMap.set("_joinType",e.join):this._joinType=e.join,Z(e.color)){const t=(t,i,r)=>{const s=e.color(t,i,r);return s&&(0,p.i)(s)||0};this._dynamicPropertyMap.set("_fillColor",t)}else{const t=e.color;this._fillColor=t&&(0,p.i)(t)||0}if(Z(e.miterLimit)){const t=(t,i,r)=>Y(e.miterLimit(t,i,r));this._dynamicPropertyMap.set("_miterLimitCosine",t)}else this._miterLimitCosine=Y(e.miterLimit);this._scaleFactor=e.scaleFactor||1,this._isDashed=e.isDashed,this._effects=e.effects,this.tessellationProperties._bitset=e.colorLocked?1:0,this._materialKey=e.materialKey,this._initializeTessellator(!0)}static fromCIMLine(e,t){const[i,r]=J(e.scaleInfo,t);return new tt(e,i,r)}bindFeature(e,t,i){const r=e.readLegacyFeature();this._dynamicPropertyMap.forEach(((e,s)=>{this[s]=e(r,t,i)})),this._halfWidth*=this._scaleFactor;const n=this._materialCache,o=(0,this._cimLineLayer.materialHash)(r,t,i),l=n.get(o);let h=null;if(l&&E(l.spriteMosaicItem)&&(h=l.spriteMosaicItem),h){this._hasPattern=!0;const{rect:e,width:t,height:i}=h,r=e.x+s.Y,n=e.y+s.Y,o=r+t,l=n+i;this.tessellationProperties._tl=(0,a.m)(r,n),this.tessellationProperties._br=(0,a.m)(o,l)}else this._hasPattern=!1,this.tessellationProperties._tl=0,this.tessellationProperties._br=0;this.tessellationProperties._fillColor=this._fillColor,this.tessellationProperties._halfWidth=this._halfWidth,this.tessellationProperties.offset=0,this.tessellationProperties._halfReferenceWidth=this.tessellationProperties._halfWidth;const u=f.b.load(this._materialKey);h&&(u.sdf=h.sdf,u.pattern=!0,u.textureBinding=h.textureBinding),this._materialKey=u.data}}const it=(0,g.b)(),rt=(0,g.a)(),st=r.n.getLogger("esri.views.2d.engine.webgl.WGLDynamicMarkerTemplate");class nt extends(fe(Ze)){constructor(e,t,i){if(super(e),this._cimMarkerLayer=e,this._minMaxZoom=(0,a.m)(Math.round(t*s.e),Math.round(i*s.e)),Z(e.color)){const t=(t,i,r)=>(0,p.i)(e.color(t,i,r));this._dynamicPropertyMap.set("_fillColor",t)}else this._fillColor=(0,p.i)(e.color);if(Z(e.outlineColor)){const t=(t,i,r)=>(0,p.i)(e.outlineColor(t,i,r));this._dynamicPropertyMap.set("_outlineColor",t)}else this._outlineColor=(0,p.i)(e.outlineColor);if(Z(e.size)){const t=(t,i,r)=>(0,c.u)(e.size(t,i,r));this._dynamicPropertyMap.set("_size",t)}else this._size=(0,c.u)(e.size);if(Z(e.scaleX)?this._dynamicPropertyMap.set("_scaleX",e.scaleX):this._scaleX=e.scaleX,Z(e.offsetX)){const t=(t,i,r)=>(0,c.u)(e.offsetX(t,i,r));this._dynamicPropertyMap.set("xOffset",t)}else this.xOffset=(0,c.u)(e.offsetX);if(Z(e.offsetY)){const t=(t,i,r)=>(0,c.u)(e.offsetY(t,i,r));this._dynamicPropertyMap.set("yOffset",t)}else this.yOffset=(0,c.u)(e.offsetY);if(Z(e.outlineWidth)){const t=(t,i,r)=>(0,c.u)(e.outlineWidth(t,i,r));this._dynamicPropertyMap.set("_outlineWidth",t)}else this._outlineWidth=(0,c.u)(e.outlineWidth);Z(e.rotation)?this._dynamicPropertyMap.set("_angle",e.rotation):this._angle=e.rotation,this._scaleFactor=(0,r.q)(e.scaleFactor,1),this._markerPlacement=e.markerPlacement,this._effects=e.effects,this._bitSet=(1===e.alignment?1:0)|(e.colorLocked?1:0)<<1|(e.scaleSymbolsProportionally?1:0)<<3,this._materialKey=e.materialKey}static fromCIMMarker(e,t){const[i,r]=J(e.scaleInfo,t);return new nt(e,i,r)}bindFeature(e,t,i){const r=e.readLegacyFeature();this._dynamicPropertyMap.forEach(((e,s)=>{this[s]=e(r,t,i)}));const n=this._cimMarkerLayer.materialHash,o="function"==typeof n?n(r,t,i):n,l=this._materialCache.get(o);if(!l||!E(l.spriteMosaicItem)||!l.spriteMosaicItem)return void st.error(new h.s("mapview-cim","Encountered an error when binding feature"));const u=l.spriteMosaicItem,d=this._cimMarkerLayer.sizeRatio,p=u.width/u.height*this._scaleX,y=this._cimMarkerLayer.rotateClockwise?this._angle:-this._angle;let m=this._size,g=m*p;const _=this.xOffset,x=this.yOffset;this.xOffset*=this._scaleFactor,this.yOffset*=this._scaleFactor;const v=this._cimMarkerLayer.scaleSymbolsProportionally&&this._cimMarkerLayer.frameHeight?this._size/(0,c.u)(this._cimMarkerLayer.frameHeight):1,b=this._outlineWidth*v,w=(0,c.u)(this._cimMarkerLayer.referenceSize);let S=0,I=0;const C=this._cimMarkerLayer.anchorPoint;C&&(this._cimMarkerLayer.isAbsoluteAnchorPoint?this._size&&(S=-C.x/(this._size*p),I=C.y/this._size):(S=C.x,I=C.y)),this._sizeOutlineWidth=(0,a.w)(Math.round(Math.min(Math.sqrt(128*g),255)),Math.round(Math.min(Math.sqrt(128*m),255)),Math.round(Math.min(Math.sqrt(128*b),255)),Math.round(Math.min(Math.sqrt(128*w),255))),this.angle=y;const M=Math.round(64*d);this._bitestAndDistRatio=(0,a.m)(this._bitSet,M);const T=u.rect.x+s.Y,F=u.rect.y+s.Y,A=T+u.width,R=F+u.height;this._texUpperLeft=(0,a.m)(T,F),this._texUpperRight=(0,a.m)(A,F),this._texBottomLeft=(0,a.m)(T,R),this._texBottomRight=(0,a.m)(A,R);const P=f.w.load(this._materialKey);P.sdf=u.sdf,P.pattern=!0,P.textureBinding=u.textureBinding,this._materialKey=P.data,this._anchorX=.5-(.5+S)*u.width/u.width,this._anchorY=.5-(.5+I)*u.height/u.height,g*=d,m*=d,g*=this._scaleFactor,m*=this._scaleFactor,g*=u.rect.width/u.width,m*=u.rect.height/u.height,this._computedWidth=g,this._computedHeight=m,this._applyTransformation(rt,it),this.xOffset=_,this.yOffset=x}}function at(e){const t=new Array(e.length);for(let i=0;i<e.length;i++)t[i]=e.charCodeAt(i);return t}class ot extends(re(Ze)){constructor(e,t,i){super(e),this._horizontalAlignment="center",this._verticalAlignment="middle",this._textToGlyphs=new Map,this._minMaxZoom=(0,a.m)(Math.round(t*s.e),Math.round(i*s.e));const r=e.scaleFactor||1;if(this._cimTextLayer=e,Z(e.color)){const t=(t,i,r)=>(0,p.i)(e.color(t,i,r));this._dynamicPropertyMap.set("_color",t)}else this._color=(0,p.i)(e.color);if(Z(e.color)){const t=(t,i,r)=>(0,p.i)(e.outlineColor(t,i,r));this._dynamicPropertyMap.set("_haloColor",t)}else this._haloColor=(0,p.i)(e.outlineColor);let n,o,l;if(Z(e.size)||(n=Math.min(Math.round((0,c.u)(e.size*e.sizeRatio)),127)),this._dynamicPropertyMap.set("_size",((t,i,r)=>Z(e.size)?Math.min(Math.round((0,c.u)(e.size(t,i,r)*e.sizeRatio)),127):n)),Z(e.outlineSize)){const t=(t,i,r)=>Math.min(Math.floor(5*(0,c.u)(e.outlineSize(t,i,r)*e.sizeRatio)),127);this._dynamicPropertyMap.set("_haloSize",t)}else this._haloSize=Math.min(Math.floor(5*(0,c.u)(e.outlineSize*e.sizeRatio)),127);Z(e.offsetX)||(o=Math.round((0,c.u)(e.offsetX*e.sizeRatio))),this._dynamicPropertyMap.set("_xOffset",((t,i,r)=>Z(e.offsetX)?Math.round((0,c.u)(e.offsetX(t,i,r)*e.sizeRatio)):o)),Z(e.offsetY)||(l=Math.round((0,c.u)(e.offsetY*e.sizeRatio))),this._dynamicPropertyMap.set("_yOffset",((t,i,r)=>Z(e.offsetY)?Math.round((0,c.u)(e.offsetY(t,i,r)*e.sizeRatio)):l)),Z(e.angle)?this._dynamicPropertyMap.set("_angle",e.angle):this._angle=e.angle,Z(e.horizontalAlignment)?this._dynamicPropertyMap.set("_horizontalAlignment",e.horizontalAlignment):this._horizontalAlignment=e.horizontalAlignment,Z(e.verticalAlignment)?this._dynamicPropertyMap.set("_verticalAlignment",e.verticalAlignment):this._verticalAlignment=e.verticalAlignment,this._scaleFactor=r,Z(e.text)?this._dynamicPropertyMap.set("_text",e.text):this._text=e.text;const h=Math.min(Math.round((0,c.u)(e.referenceSize*e.sizeRatio)),127);this._referenceSize=Math.round(Math.sqrt(256*h)),this._materialKey=e.materialKey;const u=f.F.load(this._materialKey);u.sdf=!0,this._bitset=(1===e.alignment?1:0)|(e.colorLocked?1:0)<<1,this._materialKey=u.data,this._decoration="none",this._lineHeight=1,this._lineWidth=512,this._textPlacement=e.markerPlacement,this._effects=e.effects,this._isCIM=!0}static fromCIMText(e,t){const[i,r]=J(e.scaleInfo,t);return new ot(e,i,r)}async analyze(e,t,i,r){const s=t.readLegacyFeature(),n=function(e,t,i,r){return"string"==typeof e.text?e.text:"function"==typeof e.text?e.text(t,i,r):""}(this._cimTextLayer,s,i,r),a=await e.getMosaicItem(this._cimTextLayer.cim,at(n));return this._textToGlyphs.set(n,a.glyphMosaicItems),a}bindFeature(e,t,i){const r=e.readLegacyFeature();if(this._dynamicPropertyMap.forEach(((e,s)=>{this[s]=e(r,t,i)})),!this._text||0===this._text.length)return void(this._shapingInfo=null);this._size*=this._scaleFactor,this._scale=this._size/24,this._xOffset*=this._scaleFactor,this._yOffset*=this._scaleFactor,this._xAlignD=(0,d.r)(this._horizontalAlignment||"center"),this._yAlignD=(0,d.c)(this._verticalAlignment||"baseline");const s=this._textToGlyphs.get(this._text);this.bindTextInfo(s,!1)}}const lt=128;class ht extends(We(ne)){constructor(e,t,i,r,n,o,l,h,u,c,d){super(),this._effects=u;const p=f.C.load(e);t&&(p.sdf=t.sdf,p.pattern=!0,p.textureBinding=t.textureBinding),this.fillColor=i,this.tl=r,this.br=n,this.aux1=o,this.aux2=l,this.aux3=h,this._minMaxZoom=(0,a.m)(Math.round(c*s.e),Math.round(d*s.e)),this._materialKey=p.data}static fromCIMFill(e,t,i){const r=e.color,n=r&&(0,p.i)(r)||0,o=e.materialKey,[l,h]=J(e.scaleInfo,i);if(!t){const t=(0,a.w)(0,0,0,e.colorLocked?1:0);return new ht(o,null,n,0,0,0,0,t,e.effects,l,h)}const{rect:d,width:f,height:y}=t,m=d.x+s.Y,g=d.y+s.Y,_=m+f,x=g+y;let b=(0,u.O)(y);b>255?b=255:b<=0&&(b=(0,u.O)(x-g));let w=(0,u.O)(f||0);w>255?w=255:w<=0&&(w=(0,u.O)(_-m));let S=(0,c.u)(e.offsetX||0)+lt;S>255&&(S=255);let I=(0,c.u)(-e.offsetY||0)+lt;I>255&&(I=255);const C=e.scaleX||1,M=(0,a.m)(m,g),T=(0,a.m)(_,x),E=(0,a.w)(w,b,S,I),F=(0,a.m)(lt*C,128),A=(0,a.w)(0,0,(0,v.M)(e.angle),e.colorLocked?1:0);return new ht(o,t,n,M,T,E,F,A,e.effects,l,h)}static fromSimpleFill(e,t,i=!1){const{color:r}=e,n=r&&"esriSFSNull"!==e.style&&(0,p.f)(r)||0,o=(0,a.w)(0,0,0,i?255:0),l=e.materialKey;if(!t)return new ht(l,null,n,0,0,0,0,o,null,0,j);const{rect:h,width:c,height:d}=t,f=h.x+s.Y,y=h.y+s.Y,m=f+c,g=y+d,_=(0,a.m)(f,y),x=(0,a.m)(m,g),v=(0,a.w)((0,u.O)(m-f),(0,u.O)(g-y),0,0),b=(0,a.m)(lt,lt);return new ht(l,t,n,_,x,v,b,o,null,0,j)}static fromPictureFill(e,t,i=!1){const r=s.i,{rect:n,width:o,height:l}=t,h=n.x+s.Y,d=n.y+s.Y,p=h+o,f=d+l,y=(0,a.m)(h,d),m=(0,a.m)(p,f);let g=(0,u.O)((0,c.u)(e.width));g>255&&(g=255);let _=(0,u.O)((0,c.u)(e.height));_>255&&(_=255);let x=(0,c.u)(e.xoffset)+lt;x>255&&(x=255);let v=(0,c.u)(-e.yoffset)+lt;v>255&&(v=255);const b=(0,a.w)(g,_,x,v),w=(0,a.m)(lt*e.xscale,lt*e.yscale),S=(0,a.w)(0,0,0,i?255:0),I=e.materialKey;return new ht(I,t,r,y,m,b,w,S,null,0,j)}}const ut=r.n.getLogger("esri.views.2d.engine.webgl.WGLLineTemplate");class ct extends($e(ne)){constructor(e,t,i,r,n,o,l,h,u,c,d,p,y,m,g,_,x){super();const v=f.b.load(e);t&&(v.sdf=t.sdf,v.pattern=!0,v.textureBinding=t.textureBinding),this._capType=r,this._joinType=n,this._miterLimitCosine=Y(o),this.tessellationProperties._fillColor=l,this.tessellationProperties._tl=h,this.tessellationProperties._br=u,this._hasPattern=c,this._isDashed=d,this._isColorLocked=p,this._zOrder=m,this._effects=g,this._minMaxZoom=(0,a.m)(Math.round(_*s.e),Math.round(x*s.e)),this._materialKey=v.data,this.tessellationProperties._bitset=p?1:0,this.tessellationProperties._halfWidth=.5*i,this.tessellationProperties._halfReferenceWidth=.5*y,this.tessellationProperties.offset=0,this._initializeTessellator(!1)}static fromCIMLine(e,t,i){const r=e.color,n=e.scaleFactor||1,o=e.isDashed;let l=e.cap;o&&1===l&&(l=2);const h=e.join,u=(0,c.u)(e.width)*n,d=(0,c.u)(e.referenceWidth),f=(0,c.u)(e.miterLimit),y=r&&(0,p.i)(r)||0,[m,g]=J(e.scaleInfo,i);if(!t)return new ct(e.materialKey,t,u,l,h,f,y,0,0,!1,o,e.colorLocked,d,e.zOrder,e.effects,m,g);const{rect:_,width:x,height:v}=t,b=_.x+s.Y,w=_.y+s.Y,S=b+x,I=w+v,C=(0,a.m)(b,w),M=(0,a.m)(S,I);return new ct(e.materialKey,t,u,l,h,f,y,C,M,!0,o,e.colorLocked,d,e.zOrder,e.effects,m,g)}static fromSimpleLine(e,t){const{color:i}=e,r="esriSLSSolid"!==e.style&&"esriSLSNull"!==e.style,n=(0,a.P)(e.cap||"round"),o=(0,a.S)(e.join||"round");let l=i&&"esriSLSNull"!==e.style&&(0,p.f)(i)||0;"esriSLSNull"===e.style&&(l=0);const h=(0,c.u)(e.width),u=e.miterLimit;if(!t)return new ct(e.materialKey,t,h,n,o,u,l,0,0,!1,r,!1,h,0,null,0,j);const{rect:d,width:f,height:y}=t,m=d.x+s.Y,g=d.y+s.Y,_=m+f,x=g+y,v=(0,a.m)(m,g),b=(0,a.m)(_,x);return new ct(e.materialKey,t,h,n,o,u,l,v,b,!0,r,!1,h,0,null,0,j)}static fromPictureLineSymbol(e,t,i,r){return ut.error("PictureLineSymbol support does not exist!"),null}}class dt{constructor(){this._resolver=null}isHeld(){return!!this._resolver}async acquire(){if(!this._resolver)return this._resolver=(0,h.D)(),Promise.resolve();await this._resolver.promise,await this.acquire()}release(){const e=this._resolver;this._resolver=null,e.resolve()}}const pt=r.n.getLogger("esri.views.2d.engine.webgl.mesh.templates.WGLTemplateStore"),ft=new Array;function yt(e,t){const i=e.length;return e.push(null),t.then((t=>e[i]=t)),e}function mt(e){return!!(1&e)}class gt{constructor(e,t){this._idCounter=1,this._templateIdCounter=1,this._idToTemplateGroup=new Map,this._symbolToTemplate=new Map,this._fetchQueue=[],this._idToResolver=new Map,this._cimTemplateCache=new Map,this._cimAnalyses=[],this._lock=new dt,this._fetchResource=e,this._tileInfo=t}get _markerError(){return this._errorTemplates.marker[0]}get _fillError(){return this._errorTemplates.fill[0]}get _lineError(){return this._errorTemplates.line[0]}get _textError(){return this._errorTemplates.line[0]}createTemplateGroup(e,t){this._initErrorTemplates();const i=e.hash;if(this._symbolToTemplate.has(i))return this._symbolToTemplate.get(i);const r=new Array;t&&this._createMeshTemplates(r,t,!0),this._createMeshTemplates(r,e,!1);const s=this._createGroupId("expanded-cim"===e.type);return this._idToTemplateGroup.set(s,r),this._symbolToTemplate.set(i,s),s}getTemplateGroup(e){return this._idToTemplateGroup.has(e)?this._idToTemplateGroup.get(e):ft}getDynamicTemplateGroup(e){return this._idToTemplateGroup.has(e)?(mt(e)||pt.error("mapview-template-store",`Id ${e} does not refer to a dynamic template`),this._idToTemplateGroup.get(e)):ft}getMosaicItem(e,t){const i=this._createTemplateId(),r=new Promise((e=>this._idToResolver.set(i,e)));return this._fetchQueue.push({symbol:e,id:i,glyphIds:t}),r}finalize(e){return this._fetchQueue.length||this._lock.isHeld()?async function(e,t,i){try{await e.acquire(),await t(i),e.release()}catch(t){throw e.release(),t}}(this._lock,this._fetchAllQueuedResources.bind(this),e):Promise.resolve()}_initErrorTemplates(){this._errorTemplates||(this._errorTemplates={fill:this._createMeshTemplates([],(0,d.S)(x.j),!1),marker:this._createMeshTemplates([],(0,d.S)(x.N),!1),line:this._createMeshTemplates([],(0,d.S)(x.O),!1)})}_fetchAllQueuedResources(e){if(!this._fetchQueue.length)return Promise.resolve();const t=this._fetchQueue,i=this._cimAnalyses;return this._fetchQueue=[],this._cimAnalyses=[],Promise.all(i).then((()=>this._fetchResource(t,e).then((e=>{for(const{id:t,mosaicItem:i}of e)this._idToResolver.get(t)(i),this._idToResolver.delete(t)})))).catch((e=>{(0,h.g)(e)?this._fetchQueue=this._fetchQueue.concat(t):function(e){return"worker:port-closed"===e.name}(e)||pt.error(new h.s("mapview-template-store","Unable to fetch requested texture resources",e))}))}_createGroupId(e){return this._idCounter++<<1|(e?1:0)}_createTemplateId(){return this._templateIdCounter++}async _createSMS(e){const{spriteMosaicItem:t}=await this.getMosaicItem(e);return E(t,pt)?ye.fromSimpleMarker(e,t):this._markerError}async _createPMS(e){const{spriteMosaicItem:t}=await this.getMosaicItem(e);return E(t,pt)?ye.fromPictureMarker(e,t):this._markerError}async _createSFS(e,t){const{spriteMosaicItem:i}=await this.getMosaicItem(e);return E(i,pt)?ht.fromSimpleFill(e,i,t):this._fillError}async _createPFS(e,t){const{spriteMosaicItem:i}=await this.getMosaicItem(e);return E(i,pt)?ht.fromPictureFill(e,i,t):this._fillError}async _createSLS(e,t){const{spriteMosaicItem:i}=await this.getMosaicItem(e);return E(i,pt)?ct.fromSimpleLine(e,i):this._lineError}async _createLMS(e){const{spriteMosaicItem:t}=await this.getMosaicItem(e);return E(t,pt)?ye.fromLineSymbolMarker(e,t):this._markerError}async _createTS(e){const{glyphMosaicItems:t}=await this.getMosaicItem(e);return ae.fromText(e,t)}async _createCIMText(e){const{glyphMosaicItems:t}=await this.getMosaicItem(e.cim,at(e.text));return E(t,pt)?ae.fromCIMText(e,t,this._tileInfo):this._textError}async _createCIMFill(e){const{spriteMosaicItem:t}=await this.getMosaicItem(e.cim);return E(t,pt)?ht.fromCIMFill(e,t,this._tileInfo):this._fillError}async _createCIMLine(e){const{spriteMosaicItem:t}=await this.getMosaicItem(e.cim);return E(t,pt)?ct.fromCIMLine(e,t,this._tileInfo):this._lineError}async _createCIMMarker(e){const{spriteMosaicItem:t}=await this.getMosaicItem(e.cim);return E(t,pt)?ye.fromCIMMarker(e,t,this._tileInfo):this._markerError}async _createCIM(e){const t=e.templateHash;if(this._cimTemplateCache.has(t))return this._cimTemplateCache.get(t);const i={...e,cim:{...e.cim,mosaicHash:e.materialHash}};let r;switch(i.type){case"marker":r=this._createCIMMarker(i);break;case"line":r=this._createCIMLine(i);break;case"fill":r=this._createCIMFill(i);break;case"text":r=this._createCIMText(i)}return r.then((e=>this._cimTemplateCache.set(t,e))),r}_createDynamicCIM(e){const t=e.templateHash;if(this._cimTemplateCache.has(t))return this._cimTemplateCache.get(t);let i;switch(e.type){case"marker":i=nt.fromCIMMarker(e,this._tileInfo);break;case"line":i=tt.fromCIMLine(e,this._tileInfo);break;case"fill":i=Je.fromCIMFill(e,this._tileInfo);break;case"text":i=ot.fromCIMText(e,this._tileInfo)}return this._cimTemplateCache.set(t,i),i}_createPrimitiveMeshTemplates(e,t,i){switch(t.type){case"esriSMS":return yt(e,this._createSMS(t));case"esriPMS":return yt(e,this._createPMS(t));case"esriSFS":return yt(e,this._createSFS(t,i));case"line-marker":return yt(e,this._createLMS(t));case"esriPFS":return yt(e,this._createPFS(t,i));case"esriSLS":return yt(e,this._createSLS(t,!1));case"esriTS":return yt(e,this._createTS(t));default:return pt.error("Unable to create mesh template for unknown symbol type {: $ }{symbol.type}"),e}}_createMeshTemplates(e,t,i){if(-1!==t.type.indexOf("3d"))return pt.error("3D symbols are not supported with MapView"),e;if("expanded-cim"===t.type){for(const i of t.layers)"function"==typeof i.materialHash?e.push(this._createDynamicCIM(i)):yt(e,this._createCIM(i));return e}if("composite-symbol"===t.type){for(const r of t.layers)this._createPrimitiveMeshTemplates(e,r,i);return e}return"cim"===t.type||"label"===t.type||"web-style"===t.type?e:this._createPrimitiveMeshTemplates(e,t,i)}}class _t{constructor(e,t,i){this._geometryType=e,this._idField=t,this._templateStore=i}update(e,t){(0,r.r)(e.mesh.labels)&&(this._labelTemplates=this._createLabelTemplates(e.mesh.labels,t))}_createLabelTemplates(e,t){const i=new Map;if("simple"===e.type){for(const r of e.classes){const e=de.fromLabelClass(r,t);i.set(r.index,e)}return i}for(const r in e.classes){const s=e.classes[r];for(const e of s){const r=de.fromLabelClass(e,t);i.set(e.index,r)}}return i}get templates(){return this._templateStore}async analyze(e,t,i,s,n,a){if((0,h.b)(a))return;let l;"dictionary"===t.type&&(l=await t.analyze(this._idField,e.copy(),s,n,a));let u=0;for(;e.next();){let a;if(a=l?l[u++]:(0,r.r)(i)&&(0,o.v)(e.getDisplayId())&&1!==e.readAttribute("cluster_count")?i.match(this._idField,e,this._geometryType,s,n):t.match(this._idField,e,this._geometryType,s,n),e.setGroupId(a),mt(a)){const t=this._templateStore.getDynamicTemplateGroup(a);for(const i of t)i&&i.analyze&&i.analyze(this._templateStore,e,s,n)}}return this._templateStore.finalize(a)}async analyzeGraphics(e,t,i,r,s){if((0,h.b)(s))return;const n=e.getCursor();for(t&&await t.analyze(this._idField,n.copy(),i,r,s);n.next();){let e=n.getGroupId();if(null!=e&&-1!==e||(e=t.match(this._idField,n,n.geometryType,i,r),n.setGroupId(e)),mt(e)){const t=this._templateStore.getDynamicTemplateGroup(e);for(const e of t)e&&e.analyze&&e.analyze(this._templateStore,n,i,r)}n.setGroupId(e)}return this._templateStore.finalize(s)}writeGraphic(e,t,i){const r=t.getGroupId(),s=t.getDisplayId(),n=this._templateStore.getTemplateGroup(r);if(e.featureStart(t.insertAfter),null!=s){if(mt(r))for(const e of n)e.bindFeature(t,null,null);if(n){for(const r of n)r&&r.write(e,t,i);e.featureEnd()}}}writeCursor(e,t,i,s,n,a){const o=t.getGroupId(),l=t.getDisplayId(),h=this._templateStore.getTemplateGroup(o);if(t.getObjectId(),null!=l&&h){if(mt(o))for(const e of h)e.bindFeature(t,i,s);for(const i of h)i.write(e,t,n);if((0,r.r)(a)&&e.hasRecords){const i=a&&this._findLabelRef(h);this._writeLabels(e,t,a,i,n)}}}_findLabelRef(e){for(const t of e)if(t instanceof ye)return t;return null}_writeLabels(e,t,i,s,n){for(const a of i)if((0,r.r)(a)&&a){const{glyphs:i,rtl:r,index:o}=a,l=this._labelTemplates.get(o);l.setZoomLevel(n),l.bindReferenceTemplate(s),l.bindTextInfo(i,r),l.write(e,t,null)}}}const xt=r.n.getLogger("esri/views/2d/engine/webgl/util/Matcher");async function vt(e,t,i){switch(e.type){case"simple":return bt.fromBasicRenderer(e,t,i);case"map":return It.fromUVRenderer(e,t,i);case"interval":return St.fromCBRenderer(e,t,i);case"dictionary":return Ct.fromDictionaryRenderer(e,t,i);case"subtype":return wt.fromSubtypes(e,t,i)}}class bt{constructor(){this.type="feature",this._defaultResult=null}static async fromBasicRenderer(e,t,i){const r=new bt;if(e.symbol){const s=await k(e.symbol,i),n=t.createTemplateGroup(s,null);r.setDefault(n)}return r}size(){return 1}getDefault(){return this._defaultResult}setDefault(e){this._defaultResult=e}match(e,t,i,r,s){return this.getDefault()}async analyze(e,t,i,r,s){return null}}class wt extends bt{constructor(e,t){super(),this._subMatchers=e,this._subtypeField=t}static async fromSubtypes(e,t,i){const r=new Map,s=[];for(const n in e.renderers){const a=parseInt(n,10),o=vt(e.renderers[n],t,i).then((e=>r.set(a,e)));s.push(o)}return await Promise.all(s),new wt(r,e.subtypeField)}match(e,t,i,r,s){const n=t.readAttribute(this._subtypeField),a=this._subMatchers.get(n);return a?a.match(e,t,i,r,s):null}}class St extends bt{constructor(e,t,i,r){super(),this.type="interval",this._intervals=[],this._isMaxInclusive=t,this._fieldIndex=r,this._field=e,this._normalizationInfo=i}static async fromCBRenderer(e,t,i){const{isMaxInclusive:r,normalizationField:s,normalizationTotal:n,normalizationType:a}=e,o=e.field,l=new St(o,r,{normalizationField:s,normalizationTotal:n,normalizationType:a},e.fieldIndex),h=await k(e.backgroundFillSymbol,i);await Promise.all(e.intervals.map((async e=>{const r=await k(e.symbol,i),s=await t.createTemplateGroup(r,h),n={min:e.min,max:e.max};l.add(n,s)})));const u=await k(e.defaultSymbol,i);if(u){const e=await t.createTemplateGroup(u,h);l.setDefault(e)}return l}add(e,t){this._intervals.push({interval:e,result:t}),this._intervals.sort(((e,t)=>e.interval.min-t.interval.min))}size(){return super.size()+this._intervals.length}match(e,t,i,r,s){if(null==this._fieldIndex&&!this._field)return this.getDefault();const n=null!=this._fieldIndex?t.getComputedNumericAtIndex(this._fieldIndex):this._getValueFromField(t);if(!n&&(null==n||isNaN(n)))return this.getDefault();for(let e=0;e<this._intervals.length;e++){const{interval:t,result:i}=this._intervals[e],r=n>=t.min,s=this._isMaxInclusive?n<=t.max:n<t.max;if(r&&s)return i}return this.getDefault()}_needsNormalization(){const e=this._normalizationInfo;return e&&(e.normalizationField||e.normalizationTotal||e.normalizationType)}_getValueFromField(e){const t=e.readAttribute(this._field);if(!this._needsNormalization()||null==t)return t;const{normalizationField:i,normalizationTotal:r,normalizationType:s}=this._normalizationInfo,n=!!i&&e.readAttribute(i);if(s)switch(s){case"esriNormalizeByField":return n?t/n:void 0;case"esriNormalizeByLog":return Math.log(t)*Math.LOG10E;case"esriNormalizeByPercentOfTotal":return t/r*100;default:return void xt.error(`Found unknown normalization type: ${s}`)}else xt.error("Normalization is required, but no type was set!")}}class It extends bt{constructor(e,t,i){super(),this.type="map",this._nullResult=null,this._resultsMap=new Map,this._fieldsIndex=i,this._fields=e,this._seperator=t||""}static async fromUVRenderer(e,t,i){const r=e.fieldDelimiter,s=[e.field];e.field2&&s.push(e.field2),e.field3&&s.push(e.field3);const n=await k(e.backgroundFillSymbol,i),a=new It(s,r,e.fieldIndex);await Promise.all(e.map.map((async e=>{const r=await k(e.symbol,i),s=await t.createTemplateGroup(r,n);"<Null>"===e.value?a.setNullResult(s):a.add(e.value,s)})));const o=await k(e.defaultSymbol,i);if(o){const e=await t.createTemplateGroup(o,n);a.setDefault(e)}return a}setNullResult(e){this._nullResult=e}add(e,t){this._resultsMap.set(e.toString(),t)}size(){return super.size()+this._resultsMap.size}match(e,t,i,r,s){if(null==this._fieldsIndex&&!this._fields)return this.getDefault();const n=null!=this._fieldsIndex?t.getComputedStringAtIndex(this._fieldsIndex):this._getValueFromFields(t);if(null!==this._nullResult&&(null==n||""===n||"<Null>"===n))return this._nullResult;if(!n&&null==n)return this.getDefault();const a=n.toString();return this._resultsMap.has(a)?this._resultsMap.get(a):this.getDefault()}_getValueFromFields(e){const t=[];for(const i of this._fields){const r=e.readAttribute(i);null==r||""===r?t.push("<Null>"):t.push(r)}return t.join(this._seperator)}}class Ct extends bt{constructor(e,t,i,r){super(),this.type="dictionary",this._groupIdCache=new I.e(100),this._renderer=e,this._fieldMap=e.fieldMap,this._symbolFields=e.getSymbolFields(),this._templates=t,this._info=i,this._scaleFn=r}static async fromDictionaryRenderer(e,t,r){const s=(await Promise.resolve().then(i.bind(i,94449)).then((function(e){return e.D}))).default.fromJSON(e.renderer);await s.fetchResources({spatialReference:r.spatialReference,fields:r.fields});const n=await async function(e,t){const i=e||1;if("number"==typeof i)return(e,t,r)=>i;const r=await(0,C.j)(i,t.spatialReference,t.fields);return(e,i,s)=>(0,T.s)(r,e,{$view:s},t.geometryType,i)||1}(s.scaleExpression,r);return new Ct(s,t,r,n)}async _analyzeFeature(e,t,i,r){const s=e.readLegacyFeature(),n=this._scaleFn(s,t,i),a=this._attributeHash(s)+"-"+n,o=this._groupIdCache.get(a);if(o)return o;const l={...i,spatialReference:this._info.spatialReference,abortOptions:r,fields:this._info.fields},u=await this._renderer.getSymbolAsync(s,l),c=(0,d.S)(u,this._renderer),p=k(c,this._info,r).then((e=>{if("expanded-cim"!==e.type)return xt.error(new h.s("mapview-bad-type",`Found unexpected type ${e.type} in dictionary response`)),null;e.hash+="-"+n;for(const t of e.layers)t.scaleFactor=n,t.templateHash+="-"+n,"text"===t.type&&"string"==typeof t.text&&t.text.indexOf("[")>-1&&(t.text=(0,S.n)(this._fieldMap,t.text,t.cim.textCase));return this._templates.createTemplateGroup(e,null)}));return this._groupIdCache.put(a,p,1),p}async analyze(e,t,i,r,s){const n=t.getCursor(),a=[];for(;n.next();)a.push(this._analyzeFeature(n,i,r,s));return Promise.all(a)}match(e,t,i,r,s){return null}_attributeHash(e){let t="";for(const i of this._symbolFields){const r=this._fieldMap[i];r&&(t+=e.attributes[r]+"-")}return t}}},78191:(e,t,i)=>{"use strict";i.d(t,{A:()=>a,C:()=>p,F:()=>m,N:()=>g,_:()=>l,b:()=>y,e:()=>n,f:()=>o,w:()=>f});var r=i(20215),s=i(5772);function n(e){switch(e){case"above-along":case"below-along":case"center-along":case"esriServerLinePlacementAboveAlong":case"esriServerLinePlacementBelowAlong":case"esriServerLinePlacementCenterAlong":return!0;default:return!1}}function a(e,t,i,r,n){switch(e){case s.E.FILL:return p.from(t,r);case s.E.LINE:return y.from(t,i);case s.E.MARKER:return f.from(t);case s.E.TEXT:return m.from(t);case s.E.LABEL:return g.from(t,n);default:throw new Error(`Unable to createMaterialKey for unknown geometryType ${e}`)}}function o(e){switch(l.load(e).geometryType){case s.E.MARKER:return new f(e);case s.E.FILL:return new p(e);case s.E.LINE:return new y(e);case s.E.TEXT:return new m(e);case s.E.LABEL:return new g(e)}}class l{constructor(e){this._data=0,this._data=e}static load(e){const t=this.shared;return t.data=e,t}set data(e){this._data=e}get data(){return this._data}get geometryType(){return this.bits(8,11)}set geometryType(e){this.setBits(e,8,11)}get mapAligned(){return!!this.bit(20)}set mapAligned(e){this.setBit(20,e)}get sdf(){return!!this.bit(11)}set sdf(e){this.setBit(11,e)}get pattern(){return!!this.bit(12)}set pattern(e){this.setBit(12,e)}get textureBinding(){return this.bits(0,8)}set textureBinding(e){this.setBits(e,0,8)}get geometryTypeString(){switch(this.geometryType){case s.E.FILL:return"fill";case s.E.MARKER:return"marker";case s.E.LINE:return"line";case s.E.TEXT:return"text";case s.E.LABEL:return"label";default:throw new r.s(`Unable to handle unknown geometryType: ${this.geometryType}`)}}setBit(e,t){const i=1<<e;t?this._data|=i:this._data&=~i}bit(e){return(this._data&1<<e)>>e}setBits(e,t,i){for(let r=t,s=0;r<i;r++,s++)this.setBit(r,0!=(e&1<<s))}bits(e,t){let i=0;for(let r=e,s=0;r<t;r++,s++)i|=this.bit(r)<<s;return i}hasVV(){return!1}setVV(e,t){}getVariation(){return{mapAligned:this.mapAligned,pattern:this.pattern,sdf:this.sdf}}getVariationHash(){return this._data&~(7&this.textureBinding)}}l.shared=new l(0);const h=e=>class extends e{get vvSizeMinMaxValue(){return 0!==this.bit(16)}set vvSizeMinMaxValue(e){this.setBit(16,e)}get vvSizeScaleStops(){return 0!==this.bit(17)}set vvSizeScaleStops(e){this.setBit(17,e)}get vvSizeFieldStops(){return 0!==this.bit(18)}set vvSizeFieldStops(e){this.setBit(18,e)}get vvSizeUnitValue(){return 0!==this.bit(19)}set vvSizeUnitValue(e){this.setBit(19,e)}hasVV(){return super.hasVV()||this.vvSizeMinMaxValue||this.vvSizeScaleStops||this.vvSizeFieldStops||this.vvSizeUnitValue}setVV(e,t){super.setVV(e,t);const i=function(e,t=!1){const i=s.A.SIZE_FIELD_STOPS|s.A.SIZE_MINMAX_VALUE|s.A.SIZE_SCALE_STOPS|s.A.SIZE_UNIT_VALUE,r=(e&(s.b.FIELD_TARGETS_OUTLINE|s.b.MINMAX_TARGETS_OUTLINE|s.b.SCALE_TARGETS_OUTLINE|s.b.UNIT_TARGETS_OUTLINE))>>>4;return t?i&r:i&~r}(e,t)&e;this.vvSizeMinMaxValue=!!(i&s.A.SIZE_MINMAX_VALUE),this.vvSizeFieldStops=!!(i&s.A.SIZE_FIELD_STOPS),this.vvSizeUnitValue=!!(i&s.A.SIZE_UNIT_VALUE),this.vvSizeScaleStops=!!(i&s.A.SIZE_SCALE_STOPS)}},u=e=>class extends e{get vvRotation(){return 0!==this.bit(15)}set vvRotation(e){this.setBit(15,e)}hasVV(){return super.hasVV()||this.vvRotation}setVV(e,t){super.setVV(e,t),this.vvRotation=!t&&!!(e&s.A.ROTATION)}},c=e=>class extends e{get vvColor(){return 0!==this.bit(13)}set vvColor(e){this.setBit(13,e)}hasVV(){return super.hasVV()||this.vvColor}setVV(e,t){super.setVV(e,t),this.vvColor=!t&&!!(e&s.A.COLOR)}},d=e=>class extends e{get vvOpacity(){return 0!==this.bit(14)}set vvOpacity(e){this.setBit(14,e)}hasVV(){return super.hasVV()||this.vvOpacity}setVV(e,t){super.setVV(e,t),this.vvOpacity=!t&&!!(e&s.A.OPACITY)}};class p extends(c(d(l))){static load(e){const t=this.shared;return t.data=e,t}static from(e,t){const i=this.load(0);return i.geometryType=s.E.FILL,t?i.dotDensity=!0:i.setVV(e,!1),i.data}getVariation(){return{...super.getVariation(),dotDensity:this.dotDensity,vvColor:this.vvColor,vvOpacity:this.vvOpacity}}get dotDensity(){return!!this.bit(15)}set dotDensity(e){this.setBit(15,e)}}p.shared=new p(0);class f extends(c(d(u(h(l))))){static load(e){const t=this.shared;return t.data=e,t}static from(e){const t=this.load(0);return t.geometryType=s.E.MARKER,t.setVV(e,!1),t.data}getVariation(){return{...super.getVariation(),vvColor:this.vvColor,vvRotation:this.vvRotation,vvOpacity:this.vvOpacity,vvSizeFieldStops:this.vvSizeFieldStops,vvSizeMinMaxValue:this.vvSizeMinMaxValue,vvSizeScaleStops:this.vvSizeScaleStops,vvSizeUnitValue:this.vvSizeUnitValue}}}f.shared=new f(0);class y extends(c(d(h(l)))){static load(e){const t=this.shared;return t.data=e,t}static from(e,t){const i=this.load(0);return i.geometryType=s.E.LINE,i.setVV(e,t),i.data}getVariation(){return{...super.getVariation(),vvColor:this.vvColor,vvOpacity:this.vvOpacity,vvSizeFieldStops:this.vvSizeFieldStops,vvSizeMinMaxValue:this.vvSizeMinMaxValue,vvSizeScaleStops:this.vvSizeScaleStops,vvSizeUnitValue:this.vvSizeUnitValue}}}y.shared=new y(0);class m extends(c(d(u(h(l))))){static load(e){const t=this.shared;return t.data=e,t}static from(e){const t=this.load(e);return t.geometryType=s.E.TEXT,t.setVV(e,!1),t.data}getVariation(){return{...super.getVariation(),vvColor:this.vvColor,vvOpacity:this.vvOpacity,vvRotation:this.vvRotation,vvSizeFieldStops:this.vvSizeFieldStops,vvSizeMinMaxValue:this.vvSizeMinMaxValue,vvSizeScaleStops:this.vvSizeScaleStops,vvSizeUnitValue:this.vvSizeUnitValue}}}m.shared=new m(0);class g extends(h(l)){static load(e){const t=this.shared;return t.data=e,t}static from(e,t){const i=this.load(0);return i.geometryType=s.E.LABEL,i.setVV(e,!1),i.mapAligned=n(t),i.data}getVariation(){return{...super.getVariation(),vvSizeFieldStops:this.vvSizeFieldStops,vvSizeMinMaxValue:this.vvSizeMinMaxValue,vvSizeScaleStops:this.vvSizeScaleStops,vvSizeUnitValue:this.vvSizeUnitValue}}}g.shared=new g(0)},40509:(e,t,i)=>{"use strict";i.d(t,{t:()=>a});var r=i(78155),s=i(20215),n=i(88903);i(80219);const a=e=>{let t=class extends e{initialize(){const{layer:e,view:t}=this;e.source.supportsSpatialReference(t.spatialReference)||this.addResolvingPromise(Promise.reject(new s.s("layerview:spatial-reference-incompatible","The spatial references supported by this OGC layer are incompatible with the spatial reference of the view",{layer:e})))}get availableFields(){return this.layer.fieldsIndex.fields.map((e=>e.name))}};return(0,r.e)([(0,n.y)()],t.prototype,"layer",void 0),(0,r.e)([(0,n.y)({readOnly:!0})],t.prototype,"availableFields",null),t=(0,r.e)([(0,n.n)("esri.views.layers.OGCFeatureLayerView")],t),t}},29081:(e,t,i)=>{"use strict";i.d(t,{a:()=>U,b:()=>D,c:()=>C,d:()=>R});var r,s=i(78155),n=i(80219),a=i(88903),o=i(29126),l=i(49878),h=i(17762),u=i(31531);let c=r=class extends s.a{constructor(){super(...arguments),this.field=null,this.minValue=0,this.maxValue=255}clone(){return new r({field:this.field,minValue:this.minValue,maxValue:this.maxValue})}};(0,s.e)([(0,a.y)({type:String,json:{write:!0}})],c.prototype,"field",void 0),(0,s.e)([(0,a.y)({type:Number,nonNullable:!0,json:{write:!0}})],c.prototype,"minValue",void 0),(0,s.e)([(0,a.y)({type:Number,nonNullable:!0,json:{write:!0}})],c.prototype,"maxValue",void 0),c=r=(0,s.e)([(0,a.n)("esri.renderers.support.pointCloud.ColorModulation")],c);var d=c;const p=new u.o({pointCloudFixedSizeAlgorithm:"fixed-size",pointCloudSplatAlgorithm:"splat"});let f=class extends s.a{};(0,s.e)([(0,a.y)({type:p.apiValues,readOnly:!0,nonNullable:!0,json:{type:p.jsonValues,read:!1,write:p.write}})],f.prototype,"type",void 0),f=(0,s.e)([(0,a.n)("esri.renderers.support.pointCloud.PointSizeAlgorithm")],f);var y,m=f;let g=y=class extends m{constructor(){super(...arguments),this.type="fixed-size",this.size=0,this.useRealWorldSymbolSizes=null}clone(){return new y({size:this.size,useRealWorldSymbolSizes:this.useRealWorldSymbolSizes})}};(0,s.e)([(0,o.r)({pointCloudFixedSizeAlgorithm:"fixed-size"})],g.prototype,"type",void 0),(0,s.e)([(0,a.y)({type:Number,nonNullable:!0,json:{write:!0}})],g.prototype,"size",void 0),(0,s.e)([(0,a.y)({type:Boolean,json:{write:!0}})],g.prototype,"useRealWorldSymbolSizes",void 0),g=y=(0,s.e)([(0,a.n)("esri.renderers.support.pointCloud.PointSizeFixedSizeAlgorithm")],g);var _,x=g;let v=_=class extends m{constructor(){super(...arguments),this.type="splat",this.scaleFactor=1}clone(){return new _({scaleFactor:this.scaleFactor})}};(0,s.e)([(0,o.r)({pointCloudSplatAlgorithm:"splat"})],v.prototype,"type",void 0),(0,s.e)([(0,a.y)({type:Number,value:1,nonNullable:!0,json:{write:!0}})],v.prototype,"scaleFactor",void 0),v=_=(0,s.e)([(0,a.n)("esri.renderers.support.pointCloud.PointSizeSplatAlgorithm")],v);const b={key:"type",base:m,typeMap:{"fixed-size":x,splat:v}},w=(0,u.s)()({pointCloudClassBreaksRenderer:"point-cloud-class-breaks",pointCloudRGBRenderer:"point-cloud-rgb",pointCloudStretchRenderer:"point-cloud-stretch",pointCloudUniqueValueRenderer:"point-cloud-unique-value"});let S=class extends s.a{constructor(e){super(e),this.type=void 0,this.pointSizeAlgorithm=null,this.colorModulation=null,this.pointsPerInch=10}clone(){return console.warn(".clone() is not implemented for "+this.declaredClass),null}cloneProperties(){return{pointSizeAlgorithm:(0,n.y)(this.pointSizeAlgorithm),colorModulation:(0,n.y)(this.colorModulation),pointsPerInch:(0,n.y)(this.pointsPerInch)}}};(0,s.e)([(0,a.y)({type:w.apiValues,readOnly:!0,nonNullable:!0,json:{type:w.jsonValues,read:!1,write:w.write}})],S.prototype,"type",void 0),(0,s.e)([(0,a.y)({types:b,json:{write:!0}})],S.prototype,"pointSizeAlgorithm",void 0),(0,s.e)([(0,a.y)({type:d,json:{write:!0}})],S.prototype,"colorModulation",void 0),(0,s.e)([(0,a.y)({json:{write:!0},nonNullable:!0,type:Number})],S.prototype,"pointsPerInch",void 0),S=(0,s.e)([(0,a.n)("esri.renderers.PointCloudRenderer")],S),(S||(S={})).fieldTransformTypeKebabDict=new u.o({none:"none",lowFourBit:"low-four-bit",highFourBit:"high-four-bit",absoluteValue:"absolute-value",moduloTen:"modulo-ten"});var I,C=S;let M=I=class extends s.a{constructor(){super(...arguments),this.description=null,this.label=null,this.minValue=0,this.maxValue=0,this.color=null}clone(){return new I({description:this.description,label:this.label,minValue:this.minValue,maxValue:this.maxValue,color:(0,n.y)(this.color)})}};(0,s.e)([(0,a.y)({type:String,json:{write:!0}})],M.prototype,"description",void 0),(0,s.e)([(0,a.y)({type:String,json:{write:!0}})],M.prototype,"label",void 0),(0,s.e)([(0,a.y)({type:Number,json:{read:{source:"classMinValue"},write:{target:"classMinValue"}}})],M.prototype,"minValue",void 0),(0,s.e)([(0,a.y)({type:Number,json:{read:{source:"classMaxValue"},write:{target:"classMaxValue"}}})],M.prototype,"maxValue",void 0),(0,s.e)([(0,a.y)({type:h.o,json:{type:[a.N],write:!0}})],M.prototype,"color",void 0),M=I=(0,s.e)([(0,a.n)("esri.renderers.support.pointCloud.ColorClassBreakInfo")],M);var T,E=M;let F=T=class extends C{constructor(e){super(e),this.type="point-cloud-class-breaks",this.field=null,this.legendOptions=null,this.fieldTransformType=null,this.colorClassBreakInfos=null}clone(){return new T({...this.cloneProperties(),field:this.field,fieldTransformType:this.fieldTransformType,colorClassBreakInfos:(0,n.y)(this.colorClassBreakInfos),legendOptions:(0,n.y)(this.legendOptions)})}};(0,s.e)([(0,o.r)({pointCloudClassBreaksRenderer:"point-cloud-class-breaks"})],F.prototype,"type",void 0),(0,s.e)([(0,a.y)({json:{write:!0},type:String})],F.prototype,"field",void 0),(0,s.e)([(0,a.y)({type:l.c,json:{write:!0}})],F.prototype,"legendOptions",void 0),(0,s.e)([(0,a.y)({type:C.fieldTransformTypeKebabDict.apiValues,json:{type:C.fieldTransformTypeKebabDict.jsonValues,read:C.fieldTransformTypeKebabDict.read,write:C.fieldTransformTypeKebabDict.write}})],F.prototype,"fieldTransformType",void 0),(0,s.e)([(0,a.y)({type:[E],json:{write:!0}})],F.prototype,"colorClassBreakInfos",void 0),F=T=(0,s.e)([(0,a.n)("esri.renderers.PointCloudClassBreaksRenderer")],F);var A,R=F;let P=A=class extends C{constructor(e){super(e),this.type="point-cloud-stretch",this.field=null,this.legendOptions=null,this.fieldTransformType=null,this.stops=null}clone(){return new A({...this.cloneProperties(),field:(0,n.y)(this.field),fieldTransformType:(0,n.y)(this.fieldTransformType),stops:(0,n.y)(this.stops),legendOptions:(0,n.y)(this.legendOptions)})}};(0,s.e)([(0,o.r)({pointCloudStretchRenderer:"point-cloud-stretch"})],P.prototype,"type",void 0),(0,s.e)([(0,a.y)({json:{write:!0},type:String})],P.prototype,"field",void 0),(0,s.e)([(0,a.y)({type:l.c,json:{write:!0}})],P.prototype,"legendOptions",void 0),(0,s.e)([(0,a.y)({type:C.fieldTransformTypeKebabDict.apiValues,json:{type:C.fieldTransformTypeKebabDict.jsonValues,read:C.fieldTransformTypeKebabDict.read,write:C.fieldTransformTypeKebabDict.write}})],P.prototype,"fieldTransformType",void 0),(0,s.e)([(0,a.y)({type:[l.a],json:{write:!0}})],P.prototype,"stops",void 0),P=A=(0,s.e)([(0,a.n)("esri.renderers.PointCloudStretchRenderer")],P);var L,D=P;let N=L=class extends s.a{constructor(){super(...arguments),this.description=null,this.label=null,this.values=null,this.color=null}clone(){return new L({description:this.description,label:this.label,values:(0,n.y)(this.values),color:(0,n.y)(this.color)})}};(0,s.e)([(0,a.y)({type:String,json:{write:!0}})],N.prototype,"description",void 0),(0,s.e)([(0,a.y)({type:String,json:{write:!0}})],N.prototype,"label",void 0),(0,s.e)([(0,a.y)({type:[String],json:{write:!0}})],N.prototype,"values",void 0),(0,s.e)([(0,a.y)({type:h.o,json:{type:[a.N],write:!0}})],N.prototype,"color",void 0),N=L=(0,s.e)([(0,a.n)("esri.renderers.support.pointCloud.ColorUniqueValueInfo")],N);var O,k=N;let V=O=class extends C{constructor(e){super(e),this.type="point-cloud-unique-value",this.field=null,this.fieldTransformType=null,this.colorUniqueValueInfos=null,this.legendOptions=null}clone(){return new O({...this.cloneProperties(),field:(0,n.y)(this.field),fieldTransformType:(0,n.y)(this.fieldTransformType),colorUniqueValueInfos:(0,n.y)(this.colorUniqueValueInfos),legendOptions:(0,n.y)(this.legendOptions)})}};(0,s.e)([(0,o.r)({pointCloudUniqueValueRenderer:"point-cloud-unique-value"})],V.prototype,"type",void 0),(0,s.e)([(0,a.y)({json:{write:!0},type:String})],V.prototype,"field",void 0),(0,s.e)([(0,a.y)({type:C.fieldTransformTypeKebabDict.apiValues,json:{type:C.fieldTransformTypeKebabDict.jsonValues,read:C.fieldTransformTypeKebabDict.read,write:C.fieldTransformTypeKebabDict.write}})],V.prototype,"fieldTransformType",void 0),(0,s.e)([(0,a.y)({type:[k],json:{write:!0}})],V.prototype,"colorUniqueValueInfos",void 0),(0,s.e)([(0,a.y)({type:l.c,json:{write:!0}})],V.prototype,"legendOptions",void 0),V=O=(0,s.e)([(0,a.n)("esri.renderers.PointCloudUniqueValueRenderer")],V);var U=V},55878:(e,t,i)=>{"use strict";i.d(t,{a:()=>l,c:()=>o,d:()=>h,m:()=>u,u:()=>a}),i(33807);var r=i(80219),s=i(29081),n=i(14754);function a(e,t,i,r){const{rendererJSON:n,isRGBRenderer:a}=e;let o=null,l=null;if(t&&a)o=t;else if(t&&"pointCloudUniqueValueRenderer"===n.type){l=s.a.fromJSON(n);const e=l.colorUniqueValueInfos;o=new Uint8Array(3*r);const i=c(l.fieldTransformType);for(let s=0;s<r;s++){const r=(i?i(t[s]):t[s])+"";for(let t=0;t<e.length;t++)if(e[t].values.indexOf(r)>=0){o[3*s]=e[t].color.r,o[3*s+1]=e[t].color.g,o[3*s+2]=e[t].color.b;break}}}else if(t&&"pointCloudStretchRenderer"===n.type){l=s.b.fromJSON(n);const e=l.stops;o=new Uint8Array(3*r);const i=c(l.fieldTransformType);for(let s=0;s<r;s++){const r=i?i(t[s]):t[s],n=e.length-1;if(r<e[0].value)o[3*s]=e[0].color.r,o[3*s+1]=e[0].color.g,o[3*s+2]=e[0].color.b;else if(r>=e[n].value)o[3*s]=e[n].color.r,o[3*s+1]=e[n].color.g,o[3*s+2]=e[n].color.b;else for(let t=1;t<e.length;t++)if(r<e[t].value){const i=(r-e[t-1].value)/(e[t].value-e[t-1].value);o[3*s]=e[t].color.r*i+e[t-1].color.r*(1-i),o[3*s+1]=e[t].color.g*i+e[t-1].color.g*(1-i),o[3*s+2]=e[t].color.b*i+e[t-1].color.b*(1-i);break}}}else if(t&&"pointCloudClassBreaksRenderer"===n.type){l=s.d.fromJSON(n);const e=l.colorClassBreakInfos;o=new Uint8Array(3*r);const i=c(l.fieldTransformType);for(let s=0;s<r;s++){const r=i?i(t[s]):t[s];for(let t=0;t<e.length;t++)if(r>=e[t].minValue&&r<=e[t].maxValue){o[3*s]=e[t].color.r,o[3*s+1]=e[t].color.g,o[3*s+2]=e[t].color.b;break}}}else{o=new Uint8Array(3*r);for(let e=0;e<o.length;e++)o[e]=255}if(i&&l&&l.colorModulation){const e=l.colorModulation.minValue,t=l.colorModulation.maxValue,s=.3;for(let n=0;n<r;n++){const r=i[n],a=r>=t?1:r<=e?s:s+(1-s)*(r-e)/(t-e);o[3*n]=a*o[3*n],o[3*n+1]=a*o[3*n+1],o[3*n+2]=a*o[3*n+2]}}return o}function o(e,t){if(null==e.encoding||""===e.encoding){const i=(0,n.y)(t,e);if((0,r.t)(i.vertexAttributes.position))return;const s=(0,n.c)(t,i.vertexAttributes.position),a=i.header.fields,o=[a.offsetX,a.offsetY,a.offsetZ],l=[a.scaleX,a.scaleY,a.scaleZ],h=s.length/3,u=new Float64Array(3*h);for(let e=0;e<h;e++)u[3*e]=s[3*e]*l[0]+o[0],u[3*e+1]=s[3*e+1]*l[1]+o[1],u[3*e+2]=s[3*e+2]*l[2]+o[2];return u}if("lepcc-xyz"===e.encoding)return(0,n.a)(t).result}function l(e,t,i){return(0,r.r)(e)&&e.attributeInfo.useElevation?h(t,i):(0,r.r)(e)?(0,n.C)(e.attributeInfo.storageInfo,e.buffer,i):null}function h(e,t){const i=new Float64Array(t);for(let r=0;r<t;r++)i[r]=e[3*r+2];return i}function u(e,t,i,r,s){const n=e.length/3;let a=0;for(let o=0;o<n;o++){let n=!0;for(let e=0;e<r.length&&n;e++){const{filterJSON:t}=r[e],i=s[e].values[o];switch(t.type){case"pointCloudValueFilter":{const e="exclude"===t.mode;-1!==t.values.indexOf(i)===e&&(n=!1);break}case"pointCloudBitfieldFilter":{const e=d(t.requiredSetBits),r=d(t.requiredClearBits);(i&e)===e&&0==(i&r)||(n=!1);break}case"pointCloudReturnFilter":{const e=15&i,r=i>>>4&15,s=r>1,a=1===e,o=e===r;let l=!1;for(const e of t.includedReturns)if("last"===e&&o||"firstOfMany"===e&&a&&s||"lastOfMany"===e&&o&&s||"single"===e&&!s){l=!0;break}l||(n=!1);break}}}n&&(i[a]=o,e[3*a]=e[3*o],e[3*a+1]=e[3*o+1],e[3*a+2]=e[3*o+2],t[3*a]=t[3*o],t[3*a+1]=t[3*o+1],t[3*a+2]=t[3*o+2],a++)}return a}function c(e){return null==e||"none"===e?null:"low-four-bit"===e?e=>15&e:"high-four-bit"===e?e=>(240&e)>>4:"absolute-value"===e?e=>Math.abs(e):"modulo-ten"===e?e=>e%10:null}function d(e){let t=0;for(const i of e||[])t|=1<<i;return t}},38624:(e,t,i)=>{"use strict";i.d(t,{h:()=>a});var r=i(78155),s=i(80219),n=i(57424);class a{constructor(e=9,t){this.compareMinX=u,this.compareMinY=c,this.toBBox=function(e){return e},this._maxEntries=Math.max(4,e||9),this._minEntries=Math.max(2,Math.ceil(.4*this._maxEntries)),t&&("function"==typeof t?this.toBBox=t:this._initFormat(t)),this.clear()}destroy(){this.clear(),x.prune(),v.prune(),b.prune(),w.prune()}all(e){this._all(this.data,e)}search(e,t){let i=this.data;const r=this.toBBox;if(g(e,i))for(x.clear();i;){for(let s=0,n=i.children.length;s<n;s++){const n=i.children[s],a=i.leaf?r(n):n;g(e,a)&&(i.leaf?t(n):m(e,a)?this._all(n,t):x.push(n))}i=x.pop()}}collides(e){let t=this.data;const i=this.toBBox;if(!g(e,t))return!1;for(x.clear();t;){for(let r=0,s=t.children.length;r<s;r++){const s=t.children[r],n=t.leaf?i(s):s;if(g(e,n)){if(t.leaf||m(e,n))return!0;x.push(s)}}t=x.pop()}return!1}load(e){if(!e.length)return this;if(e.length<this._minEntries){for(let t=0,i=e.length;t<i;t++)this.insert(e[t]);return this}let t=this._build(e.slice(0,e.length),0,e.length-1,0);if(this.data.children.length)if(this.data.height===t.height)this._splitRoot(this.data,t);else{if(this.data.height<t.height){const e=this.data;this.data=t,t=e}this._insert(t,this.data.height-t.height-1,!0)}else this.data=t;return this}insert(e){return e&&this._insert(e,this.data.height-1),this}clear(){return this.data=new I([]),this}remove(e){if(!e)return this;let t,i=this.data,n=null,a=0,o=!1;const l=this.toBBox(e);for(b.clear(),w.clear();i||b.length>0;){var h;if(i||(i=(0,s.m)(b.pop()),n=b.data[b.length-1],a=null!=(h=w.pop())?h:0,o=!0),i.leaf&&(t=(0,r.U)(i.children,e,i.children.length,i.indexHint),-1!==t))return i.children.splice(t,1),b.push(i),this._condense(b),this;o||i.leaf||!m(i,l)?n?(a++,i=n.children[a],o=!1):i=null:(b.push(i),w.push(a),a=0,n=i,i=i.children[0])}return this}toJSON(){return this.data}fromJSON(e){return this.data=e,this}_all(e,t){let i=e;for(v.clear();i;){var r;if(!0===i.leaf)for(const e of i.children)t(e);else v.pushArray(i.children);i=null!=(r=v.pop())?r:null}}_build(e,t,i,r){const s=i-t+1;let n=this._maxEntries;if(s<=n){const r=new I(e.slice(t,i+1));return o(r,this.toBBox),r}r||(r=Math.ceil(Math.log(s)/Math.log(n)),n=Math.ceil(s/n**(r-1)));const a=new C([]);a.height=r;const l=Math.ceil(s/n),h=l*Math.ceil(Math.sqrt(n));_(e,t,i,h,this.compareMinX);for(let s=t;s<=i;s+=h){const t=Math.min(s+h-1,i);_(e,s,t,l,this.compareMinY);for(let i=s;i<=t;i+=l){const s=Math.min(i+l-1,t);a.children.push(this._build(e,i,s,r-1))}}return o(a,this.toBBox),a}_chooseSubtree(e,t,i,r){for(;r.push(t),!0!==t.leaf&&r.length-1!==i;){let i,r=1/0,s=1/0;for(let n=0,a=t.children.length;n<a;n++){const a=t.children[n],o=d(a),l=f(e,a)-o;l<s?(s=l,r=o<r?o:r,i=a):l===s&&o<r&&(r=o,i=a)}t=i||t.children[0]}return t}_insert(e,t,i){const r=this.toBBox,s=i?e:r(e);b.clear();const n=this._chooseSubtree(s,this.data,t,b);for(n.children.push(e),h(n,s);t>=0&&b.data[t].children.length>this._maxEntries;)this._split(b,t),t--;this._adjustParentBBoxes(s,b,t)}_split(e,t){const i=e.data[t],r=i.children.length,s=this._minEntries;this._chooseSplitAxis(i,s,r);const n=this._chooseSplitIndex(i,s,r);if(!n)return void console.log("  Error: assertion failed at PooledRBush._split: no valid split index");const a=i.children.splice(n,i.children.length-n),l=i.leaf?new I(a):new C(a);l.height=i.height,o(i,this.toBBox),o(l,this.toBBox),t?e.data[t-1].children.push(l):this._splitRoot(i,l)}_splitRoot(e,t){this.data=new C([e,t]),this.data.height=e.height+1,o(this.data,this.toBBox)}_chooseSplitIndex(e,t,i){let r,s,n;r=s=1/0;for(let a=t;a<=i-t;a++){const t=l(e,0,a,this.toBBox),o=l(e,a,i,this.toBBox),h=y(t,o),u=d(t)+d(o);h<r?(r=h,n=a,s=u<s?u:s):h===r&&u<s&&(s=u,n=a)}return n}_chooseSplitAxis(e,t,i){const r=e.leaf?this.compareMinX:u,s=e.leaf?this.compareMinY:c;this._allDistMargin(e,t,i,r)<this._allDistMargin(e,t,i,s)&&e.children.sort(r)}_allDistMargin(e,t,i,r){e.children.sort(r);const s=this.toBBox,n=l(e,0,t,s),a=l(e,i-t,i,s);let o=p(n)+p(a);for(let r=t;r<i-t;r++){const t=e.children[r];h(n,e.leaf?s(t):t),o+=p(n)}for(let r=i-t-1;r>=t;r--){const t=e.children[r];h(a,e.leaf?s(t):t),o+=p(a)}return o}_adjustParentBBoxes(e,t,i){for(let r=i;r>=0;r--)h(t.data[r],e)}_condense(e){for(let t=e.length-1;t>=0;t--){const i=e.data[t];if(0===i.children.length)if(t>0){const s=e.data[t-1],n=s.children;n.splice((0,r.U)(n,i,n.length,s.indexHint),1)}else this.clear();else o(i,this.toBBox)}}_initFormat(e){const t=["return a"," - b",";"];this.compareMinX=new Function("a","b",t.join(e[0])),this.compareMinY=new Function("a","b",t.join(e[1])),this.toBBox=new Function("a","return {minX: a"+e[0]+", minY: a"+e[1]+", maxX: a"+e[2]+", maxY: a"+e[3]+"};")}}function o(e,t){l(e,0,e.children.length,t,e)}function l(e,t,i,r,s){s||(s=new I([])),s.minX=1/0,s.minY=1/0,s.maxX=-1/0,s.maxY=-1/0;for(let n,a=t;a<i;a++)n=e.children[a],h(s,e.leaf?r(n):n);return s}function h(e,t){e.minX=Math.min(e.minX,t.minX),e.minY=Math.min(e.minY,t.minY),e.maxX=Math.max(e.maxX,t.maxX),e.maxY=Math.max(e.maxY,t.maxY)}function u(e,t){return e.minX-t.minX}function c(e,t){return e.minY-t.minY}function d(e){return(e.maxX-e.minX)*(e.maxY-e.minY)}function p(e){return e.maxX-e.minX+(e.maxY-e.minY)}function f(e,t){return(Math.max(t.maxX,e.maxX)-Math.min(t.minX,e.minX))*(Math.max(t.maxY,e.maxY)-Math.min(t.minY,e.minY))}function y(e,t){const i=Math.max(e.minX,t.minX),r=Math.max(e.minY,t.minY),s=Math.min(e.maxX,t.maxX),n=Math.min(e.maxY,t.maxY);return Math.max(0,s-i)*Math.max(0,n-r)}function m(e,t){return e.minX<=t.minX&&e.minY<=t.minY&&t.maxX<=e.maxX&&t.maxY<=e.maxY}function g(e,t){return t.minX<=e.maxX&&t.minY<=e.maxY&&t.maxX>=e.minX&&t.maxY>=e.minY}function _(e,t,i,r,a){const o=[t,i];for(;o.length;){const t=(0,s.m)(o.pop()),i=(0,s.m)(o.pop());if(t-i<=r)continue;const l=i+Math.ceil((t-i)/r/2)*r;(0,n.a)(e,l,i,t,a),o.push(i,l,l,t)}}const x=new r.f,v=new r.f,b=new r.f,w=new r.f({deallocator:void 0});class S extends class{constructor(){this.minX=1/0,this.minY=1/0,this.maxX=-1/0,this.maxY=-1/0}}{constructor(){super(...arguments),this.height=1,this.indexHint=new r.V}}class I extends S{constructor(e){super(),this.children=e,this.leaf=!0}}class C extends S{constructor(e){super(),this.children=e,this.leaf=!1}}},55725:(e,t,i)=>{"use strict";i.d(t,{c:()=>h});var r=i(78155),s=i(20215),n=i(80219),a=i(88903),o=i(52957),l=i(81578);const h=e=>{let t=class extends e{_validateFetchPopupFeatures(e){const{layer:t}=this,{popupEnabled:i}=t;return i?(0,l.d)(t,e)?void 0:new s.s("scenelayerview3d:fetchPopupFeatures","Layer does not define a popup template",{layer:t}):new s.s("scenelayerview3d:fetchPopupFeatures","Popups are disabled",{layer:t})}async prepareFetchPopupFeatures(e){}async fetchPopupFeatures(e,t){const i=this._validateFetchPopupFeatures(t);if(i)return Promise.reject(i);const r=(0,n.r)(t)?t.clientGraphics:null;if(!r||0===r.length)return Promise.resolve([]);const s=[],a=[],h="scene"===this.layer.type&&(0,n.r)(this.layer.associatedLayer)?this.layer.associatedLayer:this.layer,u=(0,o.I)(this.layer.fieldsIndex,await(0,l.t)(h,(0,l.d)(this.layer,t)));await this.prepareFetchPopupFeatures(u);const c=new Set;for(const e of r)(0,o.r)(u,e,c)?a.push(e):s.push(e);return 0===a.length?Promise.resolve(s):this.whenGraphicAttributes(a,[...c]).catch((()=>a)).then((e=>s.concat(e)))}};return t=(0,r.e)([(0,a.n)("esri.views.3d.layers.support.PopupSceneLayerView")],t),t}},23597:(e,t,i)=>{"use strict";i.d(t,{t:()=>s});var r=i(79766);class s{constructor(e){this._programCacheByTemplate=new Map,this._rctx=e}dispose(){this._programCacheByTemplate.forEach((e=>e.programs.forEach((e=>e.dispose())))),this._programCacheByTemplate=null}getProgram(e,t){return this._programCacheByTemplate.has(e)||this.addProgramTemplate(e,(t=>(0,r.t)(this._rctx,e,t))),this.getProgramTemplateInstance(e,t)}addProgramTemplate(e,t){this._programCacheByTemplate.set(e,{constructor:t,programs:new Map})}getProgramTemplateInstance(e,t){const i=this._programCacheByTemplate.get(e);if(i){const e=t?JSON.stringify(t):"default";if(!i.programs.has(e)){const r=i.constructor(t);i.programs.set(e,r)}return i.programs.get(e)}return null}}},55807:(e,t,i)=>{"use strict";i.d(t,{H:()=>Q});var r=i(20215),s=i(80219),n=i(3629),a=i(65352),o=i(53185),l=i(58404),h=i(98548),u=i(89710),c=i(71470),d=i(92858),p=i(39068),f=i(54622),y=i(29986),m=i(16408),g=i(28090),_=i(29831),x=i(32553),v=i(60255),b=i(52957),w=i(2502),S=i(37191);i(42296);const I=new class{constructor(e,t){this._cache=new p.e(e),this._invalidCache=new p.e(t)}get(e,t){const i=`${t.uid}:${e}`,r=this._cache.get(i);if(r)return r;if(void 0!==this._invalidCache.get(i))return null;try{const r=f.WhereClause.create(e,t);return this._cache.put(i,r),r}catch{return this._invalidCache.put(i,null),null}}}(50,500),C="feature-store:unsupported-query",M=" as ",T=new Set(["esriFieldTypeOID","esriFieldTypeSmallInteger","esriFieldTypeInteger","esriFieldTypeSingle","esriFieldTypeDouble","esriFieldTypeLong","esriFieldTypeDate"]);function E(e,t){if(!t)return!0;const i=I.get(t,e);if(!i)throw new r.s(C,"invalid SQL expression",{where:t});if(!i.isStandardized)throw new r.s(C,"where clause is not standard",{where:t});return R(e,i.fieldNames,"where clause contains missing fields"),!0}function F(e,t,i){if(!t)return!0;const s=I.get(t,e);if(!s)throw new r.s(C,"invalid SQL expression",{having:t});if(!s.isAggregate)throw new r.s(C,"having does not contain a valid aggregate function",{having:t});const n=s.fieldNames;if(R(e,n,"having contains missing fields"),!s.getExpressions().every((t=>{const{aggregateType:r,field:s}=t,n=e.has(s)&&e.get(s).name;return i.some((t=>{const{onStatisticField:i,statisticType:s}=t;return(e.has(i)&&e.get(i).name)===n&&s.toLowerCase().trim()===r}))})))throw new r.s(C,"expressions in having should also exist in outStatistics",{having:t});return!0}function A(e,t){return e?I.get(e,t):null}function R(e,t,i,s=!0){const n=[];for(const i of t)if("*"!==i&&!e.has(i))if(s){const t=P(i);try{const i=A(t,e);if(!i)throw new r.s(C,"invalid SQL expression",{where:t});if(!i.isStandardized)throw new r.s(C,"expression is not standard",{clause:i});R(e,i.fieldNames,"expression contains missing fields")}catch(e){const t=e&&e.details;if(t&&(t.clause||t.where))throw e;t&&t.missingFields?n.push(...t.missingFields):n.push(i)}}else n.push(i);if(n.length)throw new r.s(C,i,{missingFields:n})}function P(e){return e.split(M)[0]}function L(e){return e.split(M)[1]}function D(e,t){const i=t.get(e);return!!i&&!T.has(i.type)}class N{constructor(e,t,i){this._fieldDataCache=new Map,this._returnDistinctMap=new Map,this.returnDistinctValues=e.returnDistinctValues,this.fieldsIndex=i,this.featureAdapter=t;const r=e.outFields;if(r&&-1===r.indexOf("*")){this.outFields=r;let e=0;for(const t of r){const r=P(t),s=this.fieldsIndex.get(r),n=s?null:A(r,i),a=s?s.name:L(t)||"FIELD_EXP_"+e++;this._fieldDataCache.set(t,{alias:a,clause:n})}}}countDistinctValues(e){return this.returnDistinctValues?(e.forEach((e=>this.getAttributes(e))),this._returnDistinctMap.size):e.length}getAttributes(e){const t=this._processAttributesForOutFields(e);return this._processAttributesForDistinctValues(t)}getFieldValue(e,t,i){const r=i?i.name:t;let s=null;return this._fieldDataCache.has(r)?s=this._fieldDataCache.get(r).clause:i||(s=A(t,this.fieldsIndex),this._fieldDataCache.set(r,{alias:r,clause:s})),i?this.featureAdapter.getAttribute(e,r):s.calculateValue(e,this.featureAdapter)}getNormalizedValue(e,t){const i=t.normalizationType,r=t.normalizationTotal;let s=this.getFieldValue(e,t.field,t.fieldInfo);if(i&&Number.isFinite(s)){const n=this.getFieldValue(e,t.normalizationField,t.normalizationFieldInfo);s=(0,x.s)(s,i,n,r)}return s}getExpressionValue(e,t,i){const r={attributes:this.featureAdapter.getAttributes(e)},s=i.createExecContext(r,t.viewInfo);return i.executeFunction(t.compiledFunc,s)}validateItem(e,t){return this._fieldDataCache.has(t)||this._fieldDataCache.set(t,{alias:t,clause:A(t,this.fieldsIndex)}),this._fieldDataCache.get(t).clause.testFeature(e,this.featureAdapter)}validateItems(e,t){return this._fieldDataCache.has(t)||this._fieldDataCache.set(t,{alias:t,clause:A(t,this.fieldsIndex)}),this._fieldDataCache.get(t).clause.testSet(e,this.featureAdapter)}_processAttributesForOutFields(e){const t=this.outFields;if(!t||!t.length)return this.featureAdapter.getAttributes(e);const i={};for(const r of t){const{alias:t,clause:s}=this._fieldDataCache.get(r);i[t]=s?s.calculateValue(e,this.featureAdapter):this.featureAdapter.getAttribute(e,t)}return i}_processAttributesForDistinctValues(e){if((0,s.t)(e)||!this.returnDistinctValues)return e;const t=this.outFields,i=[];if(t)for(const r of t){const{alias:t}=this._fieldDataCache.get(r);i.push(e[t])}else for(const t in e)i.push(e[t]);const r=`${(t||["*"]).join(",")}=${i.join(",")}`;let n=this._returnDistinctMap.get(r)||0;return this._returnDistinctMap.set(r,++n),n>1?null:e}}function O(e){return e.substr(24,12)+e.substr(19,4)+e.substr(16,2)+e.substr(14,2)+e.substr(11,2)+e.substr(9,2)+e.substr(6,2)+e.substr(4,2)+e.substr(2,2)+e.substr(0,2)}function k(e,t,i){return(i?e>t:e<t)?-1:(i?e<t:e>t)?1:0}function V(e,t,i){return i?t-e:e-t}function U(e,t,i,r){if(i&&"esriFieldTypeDate"===i.type){const i=new Date(e).getTime(),s=new Date(t).getTime();if(!isNaN(i)&&!isNaN(s))return V(i,s,r)}if("number"==typeof e&&"number"==typeof t)return V(e,t,r);if("string"==typeof e&&"string"==typeof t){const s=e.toUpperCase(),n=t.toUpperCase();return!i||"esriFieldTypeGUID"!==i.type&&"esriFieldTypeGlobalID"!==i.type?k(s,n,r):k(O(s),O(n),r)}return r?1:-1}class G{constructor(e,t,i){this.items=e,this.queryGeometry=t,this.definitionExpression=i.definitionExpression,this.geometryType=i.geometryType,this.hasM=i.hasM,this.hasZ=i.hasZ,this.objectIdField=i.objectIdField,this.spatialReference=i.spatialReference,this.fieldsIndex=i.fieldsIndex,this.timeInfo=i.timeInfo,this.featureAdapter=i.featureAdapter,this.aggregateAdapter=i.aggregateAdapter}get size(){return this.items.length}createQueryResponseForCount(e){const t=new N(e,this.featureAdapter,this.fieldsIndex);if(!e.outStatistics)return t.countDistinctValues(this.items);const{groupByFieldsForStatistics:i,having:r}=e;if(!(null==i?void 0:i.length))return 1;const s=new Map,n=new Map,a=new Set,o=e.outStatistics;for(const e of o){const{statisticType:o}=e,l="exceedslimit"!==o?e.onStatisticField:void 0;if(!n.has(l)){const e=[];for(const r of i){const i=this._getAttributeValues(t,r,s);e.push(i)}n.set(l,this._calculateUniqueValues(e))}const h=n.get(l);for(const e in h){const{data:i,items:s}=h[e],n=i.join(",");r&&!t.validateItems(s,r)||a.add(n)}}return a.size}createQueryResponse(e){let t;return t=e.outStatistics?e.outStatistics.some((e=>"exceedslimit"===e.statisticType))?this._createExceedsLimitQueryResponse(e):this._createStatisticsQueryResponse(e):this._createFeatureQueryResponse(e),e.returnQueryGeometry&&((0,d.s)(e.outSR)&&!(0,d.d)(this.queryGeometry.spatialReference,e.outSR)?t.queryGeometry=(0,v.x)({spatialReference:e.outSR,...(0,y.y)(this.queryGeometry,this.queryGeometry.spatialReference,e.outSR)}):t.queryGeometry=(0,v.x)({spatialReference:e.outSR,...this.queryGeometry})),t}createSnappingResponse(e,t){const i=this.featureAdapter,r=function(e,t){return e?t?4:3:t?3:2}(this.hasZ,this.hasM),{x:s,y:n}=e.point,a="number"==typeof e.distance?e.distance:e.distance.x,o="number"==typeof e.distance?e.distance:e.distance.y,l={candidates:[]},h="esriGeometryPolygon"===this.geometryType,u=this.getPointCreator(e.point,this.spatialReference,t);for(const t of this.items){const c=i.getGeometry(t);if(!c)continue;const{coords:d,lengths:p}=c;if(1&e.types){let e=0;for(let h=0;h<p.length;h++){const c=p[h];for(let h=0;h<c;h++,e+=r){const p=d[e],f=d[e+1];if(h!==c-1){const h=d[e+r],c=d[e+r+1],{x:y,y:m}=z(s,n,p,f,h,c),g=(s-y)/a,_=(n-m)/o,x=g*g+_*_;x<=1&&l.candidates.push({type:"edge",objectId:i.getObjectId(t),distance:Math.sqrt(x),target:u(y,m),start:u(p,f),end:u(h,c)})}}}}if(2&e.types){const e=h?d.length-r:d.length;for(let h=0;h<e;h+=r){const e=d[h],r=d[h+1],c=(s-e)/a,p=(n-r)/o,f=c*c+p*p;f<=1&&l.candidates.push({type:"vertex",objectId:i.getObjectId(t),distance:Math.sqrt(f),target:u(e,r)})}}}return l.candidates.sort(((e,t)=>e.distance-t.distance)),l}getPointCreator(e,t,i){const r=(0,s.r)(i)&&!(0,d.d)(t,i)?e=>(0,y.y)(e,t,i):e=>e;return null!=e.z&&null!=e.m?(t,i)=>r({x:t,y:i,z:e.z,m:e.m}):null!=e.z?(t,i)=>r({x:t,y:i,z:e.z}):null!=e.m?(t,i)=>r({x:t,y:i,m:e.m}):(e,t)=>r({x:e,y:t})}executeAttributesQuery(e){const t=A(e.where,this.fieldsIndex);if(!t)return Promise.resolve(this);if(t.isStandardized){let i=0;const r=[];for(const e of this.items)t.testFeature(e,this.featureAdapter)&&(r[i++]=e);const s=new G(r,this.queryGeometry,this);return s.definitionExpression=e.where,Promise.resolve(s)}return Promise.reject(new TypeError("Where clause is not standardized"))}executeAggregateIdsQuery(e){if(!e.aggregateIds||!e.aggregateIds.length||(0,s.t)(this.aggregateAdapter))return Promise.resolve(this);const t=new Set;for(const i of e.aggregateIds)this.aggregateAdapter.getFeatureObjectIds(i).forEach((e=>t.add(e)));const i=this.featureAdapter.getObjectId;return Promise.resolve(new G(this.items.filter((e=>t.has(i(e)))),this.queryGeometry,this))}executeObjectIdsQuery(e){if(!e.objectIds||!e.objectIds.length)return Promise.resolve(this);const t=new Set(e.objectIds),i=this.featureAdapter.getObjectId;return Promise.resolve(new G(this.items.filter((e=>t.has(i(e)))),this.queryGeometry,this))}executeTimeQuery(e){const t=(0,v.n)(this.timeInfo,e.timeExtent,this.featureAdapter);if(!(0,s.r)(t))return Promise.resolve(this);const i=this.items.filter(t);return Promise.resolve(new G(i,this.queryGeometry,this))}filterLatest(){const{trackIdField:e,startTimeField:t,endTimeField:i}=this.timeInfo,r=i||t,s=new Map,n=this.featureAdapter.getAttribute;for(const t of this.items){const i=n(t,e),a=n(t,r),o=s.get(i);(!o||a>n(o,r))&&s.set(i,t)}const a=Array.from(s.values());return Promise.resolve(new G(a,this.queryGeometry,this))}async project(e){if(!e||(0,d.d)(this.spatialReference,e))return this;const t=this.featureAdapter,i=(await(0,y.j)(this.items.map((e=>(0,v._)(this.geometryType,this.hasZ,this.hasM,t.getGeometry(e)))),this.spatialReference,e)).map(((e,i)=>t.cloneWithGeometry(this.items[i],(0,_.X)(e,this.hasZ,this.hasM))));return new G(i,this.queryGeometry,{definitionExpression:this.definitionExpression,geometryType:this.geometryType,hasM:this.hasM,hasZ:this.hasZ,objectIdField:this.objectIdField,spatialReference:e,fieldsIndex:this.fieldsIndex,timeInfo:this.timeInfo,featureAdapter:this.featureAdapter})}async createSummaryStatisticsResponse(e,t){const{field:i,normalizationField:r,normalizationType:s,normalizationTotal:n,minValue:a,maxValue:o}=t,l=new N(e,this.featureAdapter,this.fieldsIndex),h=this.fieldsIndex.isDateField(i),u=t.valueExpression?await this._getAttributeExpressionValues(l,t.valueExpression,t.viewInfoParams):this._getAttributeNormalizedValues(l,{field:i,normalizationField:r,normalizationType:s,normalizationTotal:n}),c=(0,x.o)({normalizationType:s,normalizationField:r,minValue:a,maxValue:o}),d=(0,b.X)(this.fieldsIndex.get(i))?(0,x.i)({values:u,supportsNullCount:c}):(0,x.r)({values:u,minValue:a,maxValue:o,useSampleStdDev:!s,supportsNullCount:c});return(0,x.u)(d,h)}_sortFeatures(e,t,i){if(e.length>1&&t&&t.length)for(const r of t.reverse()){const t=r.split(" "),s=t[0],n=this.fieldsIndex.get(s),a=t[1]&&"desc"===t[1].toLowerCase();e.sort(((e,t)=>U(i(e,s,n),i(t,s,n),n,a)))}}_createFeatureQueryResponse(e){const t=this.items,{geometryType:i,hasM:r,hasZ:s,objectIdField:n,spatialReference:a}=this,{outFields:o,outSR:l,quantizationParameters:h,resultRecordCount:u,resultOffset:c,returnZ:d,returnM:p}=e,f=null!=u&&t.length>(c||0)+u,y=o&&(o.indexOf("*")>-1?[...this.fieldsIndex.fields]:o.map((e=>this.fieldsIndex.get(e))));return{exceededTransferLimit:f,features:this._createFeatures(e,t),fields:y,geometryType:i,hasM:r&&p,hasZ:s&&d,objectIdFieldName:n,spatialReference:(0,v.x)(l||a),transform:h&&(0,g.m)(h)||null}}_createFeatures(e,t){const i=new N(e,this.featureAdapter,this.fieldsIndex),{hasM:r,hasZ:s}=this,{orderByFields:n,quantizationParameters:a,returnGeometry:o,returnCentroid:l,maxAllowableOffset:h,resultOffset:u,resultRecordCount:c,returnZ:d=!1,returnM:p=!1}=e,f=s&&d,y=r&&p;let m=[],_=0;const x=[...t];if(this._sortFeatures(x,n,((e,t,r)=>i.getFieldValue(e,t,r))),o||l){const e=(0,g.m)(a);if(o&&!l)for(const t of x)m[_++]={attributes:i.getAttributes(t),geometry:(0,v._)(this.geometryType,this.hasZ,this.hasM,this.featureAdapter.getGeometry(t),h,e,f,y)};else if(!o&&l)for(const t of x)m[_++]={attributes:i.getAttributes(t),centroid:(0,v.N)(this,this.featureAdapter.getCentroid(t,this),e)};else for(const t of x)m[_++]={attributes:i.getAttributes(t),centroid:(0,v.N)(this,this.featureAdapter.getCentroid(t,this),e),geometry:(0,v._)(this.geometryType,this.hasZ,this.hasM,this.featureAdapter.getGeometry(t),h,e,f,y)}}else for(const e of x){const t=i.getAttributes(e);t&&(m[_++]={attributes:t})}const b=u||0;if(null!=c){const e=b+c;m=m.slice(b,Math.min(m.length,e))}return m}_createExceedsLimitQueryResponse(e){let t=!1,i=Number.POSITIVE_INFINITY,r=Number.POSITIVE_INFINITY,s=Number.POSITIVE_INFINITY;for(const t of e.outStatistics)if("exceedslimit"===t.statisticType){i=null!=t.maxPointCount?t.maxPointCount:Number.POSITIVE_INFINITY,r=null!=t.maxRecordCount?t.maxRecordCount:Number.POSITIVE_INFINITY,s=null!=t.maxVertexCount?t.maxVertexCount:Number.POSITIVE_INFINITY;break}if("esriGeometryPoint"===this.geometryType)t=this.items.length>i;else if(this.items.length>r)t=!0;else{const e=this.hasZ?this.hasM?4:3:this.hasM?3:2,i=this.featureAdapter;t=this.items.reduce(((e,t)=>{const r=i.getGeometry(t);return e+(r&&r.coords.length||0)}),0)/e>s}return{fields:[{name:"exceedslimit",type:"esriFieldTypeInteger",alias:"exceedslimit",sqlType:"sqlTypeInteger",domain:null,defaultValue:null}],features:[{attributes:{exceedslimit:Number(t)}}]}}_createStatisticsQueryResponse(e){const t={attributes:{}},i=[],r=new Map,s=new Map,n=new Map,a=new Map,o=new N(e,this.featureAdapter,this.fieldsIndex),l=e.outStatistics,{groupByFieldsForStatistics:h,having:u,orderByFields:c}=e,d=h&&h.length,p=!!d,f=p&&h[0],y=p&&!this.fieldsIndex.get(f);for(const e of l){const{outStatisticFieldName:l,statisticType:c}=e,m=e,g="exceedslimit"!==c?e.onStatisticField:void 0,_="percentile_disc"===c||"percentile_cont"===c,x=p&&1===d&&(g===f||y)&&"count"===c;if(p){if(!n.has(g)){const e=[];for(const t of h){const i=this._getAttributeValues(o,t,r);e.push(i)}n.set(g,this._calculateUniqueValues(e,o.returnDistinctValues))}const e=n.get(g);for(const t in e){const{count:i,data:s,items:n,itemPositions:c}=e[t],d=s.join(",");if(!u||o.validateItems(n,u)){const e=a.get(d)||{attributes:{}};let t=null;if(x)t=i;else{const e=this._getAttributeValues(o,g,r),i=c.map((t=>e[t]));t=_&&"statisticParameters"in m?this._getPercentileValue(m,i):this._getStatisticValue(m,i)}e.attributes[l]=t,h.forEach(((t,i)=>e.attributes[this.fieldsIndex.get(t)?t:`EXPR_${i+1}`]=s[i])),a.set(d,e)}}}else{const e=this._getAttributeValues(o,g,r);t.attributes[l]=_&&"statisticParameters"in m?this._getPercentileValue(m,e):this._getStatisticValue(m,e,s)}i.push({name:l,alias:l,type:"esriFieldTypeDouble"})}const m=p?Array.from(a.values()):[t];return this._sortFeatures(m,c,((e,t)=>e.attributes[t])),{fields:i,features:m}}_getStatisticValue(e,t,i){const{onStatisticField:r,statisticType:s}=e;let n=null;return n=null!=i&&i.has(r)?i.get(r):(0,b.X)(this.fieldsIndex.get(r))?(0,x.i)({values:t}):(0,x.r)({values:t,minValue:null,maxValue:null,useSampleStdDev:!0}),i&&i.set(r,n),n["var"===s?"variance":s]}_getPercentileValue(e,t){const{onStatisticField:i,statisticParameters:r,statisticType:s}=e,{value:n,orderBy:a}=r,o="desc"===a,l=this.fieldsIndex.get(i),h=[...t].filter((e=>null!=e)).sort(((e,t)=>U(e,t,l,o)));return this._calculatePercentile(h,n,"percentile_disc"===s)}_getAttributeValues(e,t,i){if(i.has(t))return i.get(t);const r=this.fieldsIndex.get(t),s=this.items.map((i=>e.getFieldValue(i,t,r)));return i.set(t,s),s}_getAttributeNormalizedValues(e,t){return this.items.map((i=>e.getNormalizedValue(i,{field:t.field,fieldInfo:this.fieldsIndex.get(t.field),normalizationField:t.normalizationField,normalizationFieldInfo:this.fieldsIndex.get(t.normalizationField),normalizationType:t.normalizationType,normalizationTotal:t.normalizationTotal})))}async _getAttributeExpressionValues(e,t,i){const{arcadeUtils:r}=await(0,b.a)(),s=r.createFunction(t),n=i&&r.getViewInfo(i);return this.items.map((t=>e.getExpressionValue(t,{compiledFunc:s,viewInfo:n},r)))}_calculateUniqueValues(e,t){const i={},r=this.items,s=r.length;for(let n=0;n<s;n++){const s=r[n],a=[];for(const t of e)a.push(t[n]);const o=a.join(",");t?null==i[o]&&(i[o]={count:1,data:a,items:[s],itemPositions:[n]}):null==i[o]?i[o]={count:1,data:a,items:[s],itemPositions:[n]}:(i[o].count++,i[o].items.push(s),i[o].itemPositions.push(n))}return i}_calculatePercentile(e,t,i){if(0===e.length)return null;if(t<=0)return e[0];if(t>=1)return e[e.length-1];const r=(e.length-1)*t,s=Math.floor(r),n=s+1,a=r%1,o=e[s],l=e[n];return n>=e.length||i||"string"==typeof o||"string"==typeof l?o:o*(1-a)+l*a}}function z(e,t,i,r,s,n){const a=s-i,o=n-r,l=a*a+o*o,h=(e-i)*a+(t-r)*o,u=Math.min(1,Math.max(0,h/l));return{x:i+a*u,y:r+o*u}}let B=null;const j="feature-store:unsupported-query",q=new Set,H=new n.i(2e6);let W=0;class Q{constructor(e){this.capabilities={query:m.t},this.geometryType=e.geometryType,this.hasM=e.hasM,this.hasZ=e.hasZ,this.objectIdField=e.objectIdField,this.spatialReference=e.spatialReference,this.definitionExpression=e.definitionExpression,this.featureStore=e.featureStore,this.aggregateAdapter=e.aggregateAdapter,this._changeHandle=this.featureStore.events.on("changed",(()=>this.clearCache())),this.timeInfo=e.timeInfo,e.cacheSpatialQueries&&(this._geometryQueryCache=new n.s(W+++"$$",H)),this.fieldsIndex=new w.e(e.fields),e.scheduler&&e.priority&&(this._frameQueue=new S.r,this._frameTask=e.scheduler.registerTask(e.priority,this))}destroy(){this._frameTask&&(this._frameTask.remove(),this._frameTask=null,this._frameQueue.cancelAll(),this._frameQueue=null),this.clearCache(),this._geometryQueryCache&&this._geometryQueryCache.destroy(),this._changeHandle&&(this._changeHandle.remove(),this._changeHandle=null),this.fieldsIndex.destroy()}get featureAdapter(){return this.featureStore.featureAdapter}get fullExtent(){const e=this.featureStore.fullBounds;return e?{xmin:e[0],ymin:e[1],xmax:e[2],ymax:e[3],spatialReference:(0,v.x)(this.spatialReference)}:null}get timeExtent(){return this.timeInfo?(this._timeExtent||(this._timeExtent=(0,v.t)(this.timeInfo,this.featureStore)),this._timeExtent):null}clearCache(){this._geometryQueryCache&&this._geometryQueryCache.clear(),this._allItems=null,this._timeExtent=null}async executeQuery(e={},t){let i,r=(0,s.y)(e);try{r=await this._schedule((()=>(0,v.J)(r,this.definitionExpression,this.spatialReference)),t),r=await this._reschedule((()=>this._checkQuerySupport(r)),t),i=await this._reschedule((()=>this._executeGeometryQuery(r,t)),t),i=await this._reschedule((()=>i.executeAggregateIdsQuery(r)),t),i=await this._reschedule((()=>i.executeObjectIdsQuery(r)),t),i=await this._reschedule((()=>i.executeTimeQuery(r)),t),i=await this._reschedule((()=>i.executeAttributesQuery(r)),t)}catch(e){if(e!==v.j)throw e;i=new G([],null,this)}return i.createQueryResponse(r)}async executeQueryForCount(e={},t){let i,r=(0,s.y)(e);r.returnGeometry=!1,r.returnCentroid=!1,r.outSR=null;try{r=await this._schedule((()=>(0,v.J)(r,this.definitionExpression,this.spatialReference)),t),r=await this._reschedule((()=>this._checkQuerySupport(r)),t),i=await this._reschedule((()=>this._executeGeometryQuery(r,t)),t),i=await this._reschedule((()=>i.executeAggregateIdsQuery(r)),t),i=await this._reschedule((()=>i.executeObjectIdsQuery(r)),t),i=await this._reschedule((()=>i.executeTimeQuery(r)),t),i=await this._reschedule((()=>i.executeAttributesQuery(r)),t)}catch(e){if(e!==v.j)throw e;return 0}return i.createQueryResponseForCount(r)}async executeQueryForExtent(e={},t){let i,r=(0,s.y)(e);const n=r.outSR;try{r=await this._schedule((()=>(0,v.J)(r,this.definitionExpression,this.spatialReference)),t),r=await this._reschedule((()=>this._checkQuerySupport(r)),t),r.returnGeometry=!0,r.returnCentroid=!1,r.outSR=null,i=await this._reschedule((()=>this._executeGeometryQuery(r,t)),t),i=await this._reschedule((()=>i.executeAggregateIdsQuery(r)),t),i=await this._reschedule((()=>i.executeObjectIdsQuery(r)),t),i=await this._reschedule((()=>i.executeTimeQuery(r)),t),i=await this._reschedule((()=>i.executeAttributesQuery(r)),t);const e=i.size;if(!e)return{count:e,extent:null};(0,o.A)(Y,o.D),this.featureStore.forEachBounds(i.items,(e=>(0,o.f)(Y,e)),Z);const s={xmin:Y[0],ymin:Y[1],xmax:Y[3],ymax:Y[4],spatialReference:(0,v.x)(this.spatialReference)};this.hasZ&&isFinite(Y[2])&&isFinite(Y[5])&&(s.zmin=Y[2],s.zmax=Y[5]);const l=(0,y.y)(s,i.spatialReference,n);if(l.spatialReference=(0,v.x)(n||this.spatialReference),l.xmax-l.xmin==0){const e=(0,a.G)(l.spatialReference);l.xmin-=e,l.xmax+=e}if(l.ymax-l.ymin==0){const e=(0,a.G)(l.spatialReference);l.ymin-=e,l.ymax+=e}if(this.hasZ&&null!=l.zmin&&null!=l.zmax&&l.zmax-l.zmin==0){const e=(0,a.G)(l.spatialReference);l.zmin-=e,l.zmax+=e}return{count:e,extent:l}}catch(e){if(e===v.j)return{count:0,extent:null};throw e}}async executeQueryForIds(e={},t){return this.executeQueryForIdSet(e,t).then((e=>Array.from(e)))}async executeQueryForIdSet(e={},t){let i,r=(0,s.y)(e);r.returnGeometry=!1,r.returnCentroid=!1,r.outSR=null;try{r=await this._schedule((()=>(0,v.J)(r,this.definitionExpression,this.spatialReference)),t),r=await this._reschedule((()=>this._checkQuerySupport(r)),t),i=await this._reschedule((()=>this._executeGeometryQuery(r,t)),t),i=await this._reschedule((()=>i.executeAggregateIdsQuery(r)),t),i=await this._reschedule((()=>i.executeObjectIdsQuery(r)),t),i=await this._reschedule((()=>i.executeTimeQuery(r)),t),i=await this._reschedule((()=>i.executeAttributesQuery(r)),t);const e=i.items,s=new Set;return await this._reschedule((()=>{for(const t of e)s.add(i.featureAdapter.getObjectId(t))}),t),s}catch(e){if(e===v.j)return new Set;throw e}}async executeQueryForSnapping(e,t){const{point:i,distance:r,types:n}=e;if(0===n)return{candidates:[]};const a=await this._reschedule((()=>this._checkQuerySupport(e.query)),t),o=!(0,d.d)(i.spatialReference,this.spatialReference);o&&await(0,y.p)(i.spatialReference,this.spatialReference);const l="number"==typeof r?r:r.x,h="number"==typeof r?r:r.y,p={xmin:i.x-l,xmax:i.x+l,ymin:i.y-h,ymax:i.y+h,spatialReference:i.spatialReference},f=o?(0,y.y)(p,this.spatialReference):p;if(!f)return{candidates:[]};const m=(await(0,c.L)((0,u.p)(i),null,{signal:t}))[0],g=(await(0,c.L)((0,u.p)(f),null,{signal:t}))[0];if((0,s.t)(m)||(0,s.t)(g))return{candidates:[]};let _=new G(this._searchFeatures(this._getQueryBBoxes(g.toJSON())),null,this);_=await this._reschedule((()=>_.executeObjectIdsQuery(a)),t),_=await this._reschedule((()=>_.executeTimeQuery(a)),t),_=await this._reschedule((()=>_.executeAttributesQuery(a)),t);const x=m.toJSON(),v=o?(0,y.y)(x,this.spatialReference):x,b=o?Math.max(f.xmax-f.xmin,f.ymax-f.ymin)/2:r;return _.createSnappingResponse({...e,point:v,distance:b},i.spatialReference)}async executeQueryForLatestObservations(e={},t){if(!this.timeInfo||!this.timeInfo.trackIdField)throw new r.s(j,"Missing timeInfo or timeInfo.trackIdField",{query:e,timeInfo:this.timeInfo});let i,n=(0,s.y)(e);try{n=await this._schedule((()=>(0,v.J)(n,this.definitionExpression,this.spatialReference)),t),n=await this._reschedule((()=>this._checkQuerySupport(n)),t),i=await this._reschedule((()=>this._executeGeometryQuery(n,t)),t),i=await this._reschedule((()=>i.executeAggregateIdsQuery(n)),t),i=await this._reschedule((()=>i.executeObjectIdsQuery(n)),t),i=await this._reschedule((()=>i.executeTimeQuery(n)),t),i=await this._reschedule((()=>i.executeAttributesQuery(n)),t),i=await this._reschedule((()=>i.filterLatest()),t)}catch(e){if(e!==v.j)throw e;i=new G([],null,this)}return i.createQueryResponse(n)}async executeQueryForSummaryStatistics(e={},t,i){let r;e=(0,s.y)(e);try{e=await this._schedule((()=>(0,v.J)(e,this.definitionExpression,this.spatialReference)),i),e=await this._reschedule((()=>this._checkSummaryStatisticsSupport(e,t)),i),r=await this._reschedule((()=>this._executeGeometryQuery(e,i)),i),r=await this._reschedule((()=>r.executeAggregateIdsQuery(e)),i),r=await this._reschedule((()=>r.executeObjectIdsQuery(e)),i),r=await this._reschedule((()=>r.executeTimeQuery(e)),i),r=await this._reschedule((()=>r.executeAttributesQuery(e)),i)}catch(e){if(e!==v.j)throw e;r=new G([],null,this)}return r.createSummaryStatisticsResponse(e,t)}async _schedule(e,t){return this._frameQueue?this._frameQueue.push(e,t):e()}async _reschedule(e,t){return this._frameQueue?this._frameQueue.unshift(e,t):e()}get running(){return this._frameQueue.length>0}runTask(e){for(this._budget=e;!e.done&&this._frameQueue&&this._frameQueue.process();)e.madeProgress();this._budget=null}_getAll(){if(!this._allItems){const e=[];this.featureStore.forEach((t=>e.push(t))),this._allItems=new G(e,null,this)}return this._allItems}async _executeGeometryQuery(e,t){const{geometry:i,outSR:r,spatialRel:n,returnGeometry:a,returnCentroid:o}=e,l=a||o,h=(0,d.s)(r)&&!(0,d.d)(this.spatialReference,r),u=this._geometryQueryCache?h&&l?JSON.stringify({geometry:i,spatialRelationship:n,outSpatialReference:r}):JSON.stringify({geometry:i,spatialRelationship:n}):null;if(u){const e=this._geometryQueryCache.get(u);if(!(0,s.O)(e))return e}const c=async e=>{if(h&&l){const t=await e.project(r);return u&&this._geometryQueryCache.put(u,t,t.size||1),t}return u&&this._geometryQueryCache.put(u,e,e.size||1),e};if(!i)return c(this._getAll());const p=this.featureAdapter;if("esriSpatialRelDisjoint"===n){const e=this._searchFeatures(this._getQueryBBoxes(i));if(!e.length)return c(this._getAll());let r,s;const a=new Set;for(const t of e)a.add(p.getObjectId(t));return await this._reschedule((()=>{let e=0;r=new Array(a.size),this.featureStore.forEach((t=>r[e++]=t)),s=a}),t),c(await this._reschedule((async()=>{const e=await(0,v.v)(n,i,this.geometryType,this.hasZ,this.hasM);return new G(await this._runSpatialFilter(r,(t=>!s.has(p.getObjectId(t))||e(p.getGeometry(t))),t),i,this)}),t))}const f=this._searchFeatures(this._getQueryBBoxes(i));if(!f.length){const e=new G([],i,this);return u&&this._geometryQueryCache.put(u,e,e.size||1),e}if(this._canExecuteSoloPass(i,e))return c(new G(f,i,this));const y=await(0,v.v)(n,i,this.geometryType,this.hasZ,this.hasM),m=await this._runSpatialFilter(f,(e=>y(p.getGeometry(e))),t);return c(new G(m,i,this))}async _runSpatialFilter(e,t,i){if(!t)return e;if(!this._budget)return e.filter((e=>t(e)));let r=0;const s=new Array,n=async()=>{for(;r<e.length;){const a=e[r];t(a)&&s.push(a),this._budget.done&&await this._reschedule((()=>n()),i),++r}};return this._reschedule((()=>n()),i).then((()=>s))}_canExecuteSoloPass(e,t){const{geometryType:i}=this,{spatialRel:r}=t;return(0,v.I)(e)&&("esriSpatialRelEnvelopeIntersects"===r||"esriGeometryPoint"===i&&("esriSpatialRelIntersects"===r||"esriSpatialRelContains"===r||"esriSpatialRelWithin"===r))}_getQueryBBoxes(e){if((0,v.I)(e)){if((0,u.u)(e))return[(0,l.u)(e.xmin,e.ymin,e.xmax,e.ymax)];if((0,u.y)(e))return e.rings.map((e=>(0,l.u)(Math.min(e[0][0],e[2][0]),Math.min(e[0][1],e[2][1]),Math.max(e[0][0],e[2][0]),Math.max(e[0][1],e[2][1]))))}return[(0,h.c)((0,l.i)(),e)]}_searchFeatures(e){for(const t of e)this.featureStore.forEachInBounds(t,(e=>{q.add(e)}));const t=new Array(q.size);let i=0;return q.forEach((e=>t[i++]=e)),q.clear(),t}async _checkSummaryStatisticsSupport(e,t){if(e.distance<0||null!=e.geometryPrecision||e.multipatchOption||e.pixelSize||e.relationParam||e.text||e.outStatistics||e.groupByFieldsForStatistics||e.having||e.orderByFields)throw new r.s(j,"Unsupported query options",{query:e});return Promise.all([this._checkAttributesQuerySupport(e),this._checkSummaryStatisticsParamsSupport(t),(0,v.P)(e,this.geometryType,this.spatialReference),(0,y.p)(this.spatialReference,e.outSR)]).then((()=>e))}async _checkSummaryStatisticsParamsSupport(e){const t=await async function(e){const t=e.field,i=e.normalizationField,r=e.valueExpression;let s=[];if(r){if(!B){const{arcadeUtils:e}=await(0,b.a)();B=e}s=B.extractFieldNames(r)}return t&&s.push(t),i&&s.push(i),s}({field:e.field,normalizationField:e.normalizationField,valueExpression:e.valueExpression});if(!t.length)throw new r.s(j,"params should have atleast a field or valueExpression",{params:e});R(this.fieldsIndex,t,"params contains missing fields")}async _checkQuerySupport(e){if(e.distance<0||null!=e.geometryPrecision||e.multipatchOption||e.pixelSize||e.relationParam||e.text)throw new r.s(j,"Unsupported query options",{query:e});return Promise.all([this._checkAttributesQuerySupport(e),this._checkStatisticsQuerySupport(e),(0,v.P)(e,this.geometryType,this.spatialReference),(0,y.p)(this.spatialReference,e.outSR)]).then((()=>e))}_checkAttributesQuerySupport(e){const{outFields:t,orderByFields:i,returnDistinctValues:s,outStatistics:n}=e,a=n?n.map((e=>e.outStatisticFieldName&&e.outStatisticFieldName.toLowerCase())):[];if(i&&i.length>0){const e=" asc",t=" desc",r=i.map((i=>{const r=i.toLowerCase();return r.indexOf(e)>-1?r.split(e)[0]:r.indexOf(t)>-1?r.split(t)[0]:i})).filter((e=>-1===a.indexOf(e)));R(this.fieldsIndex,r,"orderByFields contains missing fields")}if(t&&t.length>0)R(this.fieldsIndex,t,"outFields contains missing fields");else if(s)throw new r.s(j,"outFields should be specified for returnDistinctValues",{query:e});E(this.fieldsIndex,e.where)}async _checkStatisticsQuerySupport(e){const{outStatistics:t,groupByFieldsForStatistics:i,having:s}=e,n=i&&i.length,a=t&&t.length;if(s){if(!n||!a)throw new r.s(j,"outStatistics and groupByFieldsForStatistics should be specified with having",{query:e});F(this.fieldsIndex,s,t)}if(a){if(!t.every((e=>"exceedslimit"!==e.statisticType)))return;const s=t.map((e=>e.onStatisticField));R(this.fieldsIndex,s,"onStatisticFields contains missing fields"),n&&R(this.fieldsIndex,i,"groupByFieldsForStatistics contains missing fields");for(const i of t){const{onStatisticField:t,statisticType:s}=i;if("percentile_disc"!==s&&"percentile_cont"!==s||!("statisticParameters"in i)){if("count"!==s&&t&&D(t,this.fieldsIndex))throw new r.s(j,"outStatistics contains non-numeric fields",{definition:i,query:e})}else{const{statisticParameters:t}=i;if(!t)throw new r.s(j,"statisticParamters should be set for percentile type",{definition:i,query:e})}}}}}const Z=(0,o.a)(),Y=(0,o.a)()},16408:(e,t,i)=>{"use strict";i.d(t,{t:()=>r});const r={supportsStatistics:!0,supportsPercentileStatistics:!0,supportsCentroid:!0,supportsCacheHint:!1,supportsDistance:!0,supportsDistinct:!0,supportsExtent:!0,supportsGeometryProperties:!1,supportsHavingClause:!0,supportsOrderBy:!0,supportsPagination:!0,supportsQuantization:!0,supportsQuantizationEditMode:!1,supportsQueryGeometry:!0,supportsResultType:!1,supportsSqlExpression:!0,supportsMaxRecordCountFactor:!1,supportsStandardizedQueriesOnly:!0,supportsTopFeaturesQuery:!1,supportsQueryByOthers:!0,supportsHistoricMoment:!1,supportsFormatPBF:!1,supportsDisjointSpatialRelationship:!0,maxRecordCountFactor:void 0,maxRecordCount:void 0,standardMaxRecordCount:void 0,tileMaxRecordCount:void 0}},38088:(e,t,i)=>{"use strict";i.d(t,{o:()=>n}),i(33807);var r=i(50388),s=i(98128);class n{dispose(){this._rasterizationCanvas=null}rasterizeJSONResource(e,t,i){if(this._rasterizationCanvas||(this._rasterizationCanvas=document.createElement("canvas")),"simple-fill"===e.type||"esriSFS"===e.type){const[i,s,n]=r.b.rasterizeSimpleFill(this._rasterizationCanvas,e.style,t);return{size:[s,n],image:new Uint32Array(i.buffer),sdf:!1,simplePattern:!0,anchorX:0,anchorY:0}}if("simple-line"===e.type||"esriSLS"===e.type){const[t,i,s]=r.b.rasterizeSimpleLine(e.style,e.cap);return{size:[i,s],image:new Uint32Array(t.buffer),sdf:!0,simplePattern:!0,anchorX:0,anchorY:0}}let n,a,o;if("simple-marker"===e.type||"esriSMS"===e.type||"line-marker"===e.type?(n=r.h.fromSimpleMarker(e),o=(0,s.r)(n)):"CIMHatchFill"===e.type?(n=r.h.fromCIMHatchFill(e),a=new r.t(n.frame.xmin,-n.frame.ymax,n.frame.xmax-n.frame.xmin,n.frame.ymax-n.frame.ymin)):e.markerPlacement&&"CIMMarkerPlacementInsidePolygon"===e.markerPlacement.type?(n=r.h.fromCIMInsidePolygon(e),a=new r.t(n.frame.xmin,-n.frame.ymax,n.frame.xmax-n.frame.xmin,n.frame.ymax-n.frame.ymin)):(n=e,o=(0,s.r)(n)),o&&!i){const[e,t,i]=(0,s.a)(o);return e?{size:[t,i],image:new Uint32Array(e.buffer),sdf:!0,simplePattern:!0,anchorX:0,anchorY:0}:null}const[l,h,u,c,d]=r.h.rasterize(this._rasterizationCanvas,n,a,!i);return l?{size:[h,u],image:new Uint32Array(l.buffer),sdf:!1,simplePattern:!1,anchorX:c,anchorY:d}:null}rasterizeImageResource(e,t,i,r){this._rasterizationCanvas||(this._rasterizationCanvas=document.createElement("canvas")),this._rasterizationCanvas.width=e,this._rasterizationCanvas.height=t;const n=this._rasterizationCanvas.getContext("2d");i instanceof ImageData?n.putImageData(i,0,0):(i.setAttribute("width",`${e}px`),i.setAttribute("height",`${t}px`),n.drawImage(i,0,0,e,t));const a=n.getImageData(0,0,e,t),o=new Uint8Array(a.data);if(r)for(const e of r)if(e&&e.oldColor&&4===e.oldColor.length&&e.newColor&&4===e.newColor.length){const[t,i,r,s]=e.oldColor,[n,a,l,h]=e.newColor;if(t===n&&i===a&&r===l&&s===h)continue;for(let e=0;e<o.length;e+=4)t===o[e]&&i===o[e+1]&&r===o[e+2]&&s===o[e+3]&&(o[e]=n,o[e+1]=a,o[e+2]=l,o[e+3]=h)}let l;for(let e=0;e<o.length;e+=4)l=o[e+3]/255,o[e]=o[e]*l,o[e+1]=o[e+1]*l,o[e+2]=o[e+2]*l;let h=o,u=e,c=t;const d=512;if(u>=d||c>=d){const i=u/c;i>1?(u=d,c=Math.round(d/i)):(c=d,u=Math.round(d*i)),h=new Uint8Array(4*u*c);const r=new Uint8ClampedArray(h.buffer);(0,s.i)(o,e,t,r,u,c,!1)}return{size:[u,c],image:new Uint32Array(h.buffer),sdf:!1,simplePattern:!1,anchorX:0,anchorY:0}}}},69284:(e,t,i)=>{"use strict";i.d(t,{d:()=>f,g:()=>m,h:()=>c,i:()=>l,m:()=>d,s:()=>h,u:()=>u,x:()=>p}),i(80987);var r=i(80219),s=i(43231),n=i(20736);const a=new Map,o=new class{constructor(e=15e3,t=5e3){this._timer=null,this._cachedBlocks=new Map,this._size=-1,this._duration=e,this._interval=Math.min(e,t)}decreaseRefCount(e,t){const i=e+"/"+t,r=this._cachedBlocks;if(r.has(i)){const e=r.get(i);return e.refCount--,e.refCount<=0&&(r.delete(i),e.controller&&e.controller.abort()),e.refCount}return 0}getBlock(e,t){const i=e+"/"+t,r=this._cachedBlocks;if(r.has(i)){const e=r.get(i);return e.ts=Date.now(),e.refCount++,r.delete(i),r.set(i,e),e.block}return null}putBlock(e,t,i,r=null){const s=this._cachedBlocks,n=e+"/"+t;if(s.has(n)){const e=s.get(n);e.ts=Date.now(),e.refCount++}else s.set(n,{block:i,ts:Date.now(),refCount:1,controller:r});this.trim(),this.updateTimer()}deleteBlock(e,t){const i=this._cachedBlocks,r=e+"/"+t;i.has(r)&&i.delete(r)}updateMaxSize(e){this._size=e,this.trim()}empty(){this._cachedBlocks.clear(),this.clearTimer()}getCurrentSize(){return this._cachedBlocks.size}updateTimer(){if(null!=this._timer)return;const e=this._cachedBlocks;this._timer=setInterval((()=>{const t=Array.from(e),i=Date.now();for(let r=0;r<t.length&&t[r][1].ts<=i-this._duration;r++)e.delete(t[r][0]);0===e.size&&this.clearTimer()}),this._interval)}trim(){const e=this._cachedBlocks;if(-1===this._size||this._size>=e.size)return;const t=Array.from(e);for(let i=0;i<t.length-this._size;i++)e.delete(t[i][0])}clearTimer(){null!=this._timer&&(clearInterval(this._timer),this._timer=null)}};function l(e,t){return null==t?e:`${e}?sliceId=${t}`}function h(e,t){const i={extent:null,rasterInfo:t,cache:new Map};if(a.has(e)){const t=a.get(e);return t.push(i),t.length-1}return a.set(e,[i]),0}function u(e,t){if(a.has(e)){const i=a.get(e);i[t]=null,i.some((e=>null!=e))||a.delete(e)}}function c(e,t,i){if(!a.has(e))return null==t?o.decreaseRefCount(e,i):0;const r=a.get(e);if(null==r[t])return o.decreaseRefCount(e,i);const s=r[t].cache;if(s.has(i)){const e=s.get(i);if(e.refCount--,0===e.refCount){s.delete(i);for(let e=0;e<r.length;e++)r[e]&&r[e].cache.has(i)&&r[e].cache.delete(i);e.controller&&e.controller.abort()}return e.refCount}return 0}function d(e,t,i){if(!a.has(e))return null==t?o.getBlock(e,i):null;const r=a.get(e);if(null==r[t]){for(let e=0;e<r.length;e++)if(r[e]&&r[e].cache.has(i)){const t=r[e].cache.get(i);return t.refCount++,t.block}return o.getBlock(e,i)}const s=r[t].cache;if(s.has(i)){const e=s.get(i);return e.refCount++,e.block}for(let e=0;e<r.length;e++)if(e!==t&&r[e]&&r[e]&&r[e].cache.has(i)){const t=r[e].cache.get(i);return t.refCount++,s.set(i,t),t.block}return null}function p(e,t,i,r,s=null){if(!a.has(e))return void(null==t&&o.putBlock(e,i,r,s));const n=a.get(e);if(null==n[t])return void o.putBlock(e,i,r,s);const l={refCount:1,block:r,isResolved:!1,isRejected:!1,controller:s};r.then((()=>l.isResolved=!0)).catch((()=>l.isRejected=!0)),n[t].cache.set(i,l)}function f(e,t,i){if(!a.has(e))return void(null==t&&o.deleteBlock(e,i));const r=a.get(e);null!=r[t]?r[t].cache.delete(i):o.deleteBlock(e,i)}function y(e,t){if(!a.has(e))return null;const i=a.get(e);return null==i[t]?null:i[t]}function m(e,t,i,a,o,l,h=null){const u=y(e,t),c=u.extent,{cache:d,rasterInfo:p}=u;if(c&&c.xmin===i.xmin&&c.xmax===i.xmax&&c.ymin===i.ymin&&c.ymax===i.ymax)return;const f=i.clone().normalize(),{spatialReference:m,transform:g}=p,_=new Set;for(let e=0;e<f.length;e++){const t=f[e];if(t.xmax-t.xmin<=a||t.ymax-t.ymin<=a)continue;let i=(0,s.j)(t,m,h);(0,r.r)(g)&&(i=g.inverseTransform(i));const u=new n.b({x:a,y:a,spatialReference:t.spatialReference});if(null==o&&!(o=(0,s.g)(u,m,t,h)))return;const{pyramidLevel:c,pyramidResolution:d,excessiveReading:y}=(0,s.C)(o,p,l||"closest");if(y)return;const{storageInfo:x}=p,{origin:v}=x,b={x:Math.max(0,Math.floor((i.xmin-v.x)/d.x)),y:Math.max(0,Math.floor((v.y-i.ymax)/d.y))},w=Math.ceil((i.xmax-i.xmin)/d.x-.1),S=Math.ceil((i.ymax-i.ymin)/d.y-.1),I=c>0?x.pyramidBlockWidth:x.blockWidth,C=c>0?x.pyramidBlockHeight:x.blockHeight,M=1,T=Math.max(0,Math.floor(b.x/I)-M),E=Math.max(0,Math.floor(b.y/C)-M),F=Math.floor((b.x+w-1)/I)+M,A=Math.floor((b.y+S-1)/C)+M;for(let e=E;e<=A;e++)for(let t=T;t<=F;t++)_.add(`${c}/${e}/${t}`)}d.forEach(((e,t)=>{if(!_.has(t)){const e=d.get(t);(null==e||e.isResolved||e.isRejected)&&d.delete(t)}})),u.extent={xmin:i.xmin,ymin:i.ymin,xmax:i.xmax,ymax:i.ymax}}},15541:(e,t,i)=>{"use strict";i.d(t,{t:()=>r});class r{constructor(e=0,t=0,i=0,r=0){this.x=e,this.y=t,this.width=i,this.height=r}get isEmpty(){return this.width<=0||this.height<=0}union(e){this.x=Math.min(this.x,e.x),this.y=Math.min(this.y,e.y),this.width=Math.max(this.width,e.width),this.height=Math.max(this.height,e.height)}}},87572:(e,t,i)=>{"use strict";i.d(t,{a:()=>m,c:()=>v,i:()=>d,o:()=>w,s:()=>c});var r=i(80219),s=i(6129),n=i(52957),a=i(78155),o=i(88903),l=i(32769),h=i(50822);const u={setAttribute(){},rollback(){},commit(){}};function c(e,t){const i=t.attributes[e.objectIdField],s=e.sessions.get(i);if(s)return s;const n=(0,r.y)(t.attributes),a=new Set;if(null==i)return u;const o=e.attributeOverrides.createInteractiveEditSession(i),l=new Map,h=(e,t)=>{const r=l.get(e);if(null==r){const r=t.indexOf(i);return l.set(e,r),r}return r};let c=0;const d={setAttribute(i,s){if(0!==c)return;const n=e.fieldsIndex.get(i);if((0,r.t)(n))return;const l=e.attributeStorageInfo.findIndex((e=>e.name===n.name));if(l<0)return;o.set(l,s);const u=e.attributeStorageInfo[l];let d=!1;a.add(i),e.forEachNode(((i,r)=>{const n=h(i,r);if(-1===n)return;const a=e.getAttributeData(i.index);if(a){const r=a[u.name];r&&(r[n]=s,e.setAttributeData(i.index,a,t),d=!0)}})),d&&e.clearMemCache()},rollback(){if(0===c){for(const e of a)this.setAttribute(e,n[e]);o.rollback(),c=1,e.sessions.delete(i)}},commit(){0===c&&(o.commit(),c=2,e.sessions.delete(i))}};return e.sessions.set(i,d),d}function d(e,t){const i=function(e,t){const i=t.edits.updateFeatures;if(!i||0===i.length)return new y;const r=function(e){const t=new Set;if(!e.updatedFeatures)return t;for(const i of e.updatedFeatures)null!=i.objectId&&null==i.error&&t.add(i.objectId);return t}(t),n=new y,a=new Map;for(let t=0;t<e.attributeStorageInfo.length;t++)a.set(e.attributeStorageInfo[t].name,t);const o=e.fieldsIndex,l=e.objectIdField,h=i.filter((e=>{const t=(0,s.n)(o,e.attributes,l);return r.has(t)}));return e.forEachNode(((t,i)=>{const r=new Set(i);for(const a of h){const h=(0,s.n)(o,a.attributes,l);if(!r.has(h))continue;const u=i.indexOf(h);for(const i in a.attributes){const r=e.fieldsIndex.normalizeFieldName(i),s=p(n,t.index,r),o=a.attributes[i];s.push({featureIndex:u,featureId:h,value:o})}}})),n}(e,t);if(0===i.size)return;const n=new Map;for(let t=0;t<e.attributeStorageInfo.length;t++)n.set(e.attributeStorageInfo[t].name,t);let a=!1;i.forEach(((t,i)=>{const s=e.getAttributeData(i);let o=!1;t.forEach(((t,i)=>{const l=(0,r.r)(s)?s[i]:null,h=n.get(i);for(const{featureIndex:i,value:r,featureId:s}of t)l&&(l[i]=r,o=!0,a=!0),e.attributeOverrides.updateValue(s,h,r)})),o&&e.setAttributeData(i,s,null)})),a&&e.clearMemCache()}function p(e,t,i){const r=function(e,t){const i=e.get(t);if(i)return i;const r=new f;return e.set(t,r),r}(e,t),s=r.get(i);if(s)return s;const n=new Array;return r.set(i,n),n}const f=Map,y=Map;function m(){return{requiredFields:{type:[String],readOnly:!0},availableFields:{type:[String],readOnly:!0,get:function(){const{layer:e,layer:{fieldsIndex:t},requiredFields:i}=this;return e.outFields?(0,n.p)(t,[...(0,n.I)(t,e.outFields),...i]):(0,n.p)(t,i)}}}}const g=e=>{let t=class extends e{constructor(){super(...arguments),this.asyncUpdateState=new Map}autoUpdateAsync(e,t){return function(e,t){const i=()=>{if(!r||s)return t();r.clear(),s=!0;const e=(0,o.a)(r,t);return s=!1,e};let r=new a.z((()=>{r&&!s&&e(i)})),s=!1;return e(i),{remove:()=>{r&&(r.destroy(),r=null)}}}((t=>this.updateAsync(e,t)),t)}async updateAsync(e,t){if(!this.startAsyncUpdate(e)){try{const i=await t();this._set(e,i)}catch(t){r.n.getLogger(this.declaredClass).warn(`Async update of "${e}" failed. Async update functions should not throw exceptions.`)}this.endAsyncUpdate(e)&&this.updateAsync(e,t)}}startAsyncUpdate(e){var t;const i=null!=(t=this.asyncUpdateState.get(e))?t:0;return 1&i?(this.asyncUpdateState.set(e,2|i),!0):(this.asyncUpdateState.set(e,1|i),!1)}endAsyncUpdate(e){var t;const i=-2&(null!=(t=this.asyncUpdateState.get(e))?t:0);return 2&i?(this.asyncUpdateState.set(e,-3&i),!0):(this.asyncUpdateState.set(e,i),!1)}};return t=(0,a.e)([(0,o.n)("esri.core.AsyncUpdate")],t),t};let _=class extends(g(a.p)){};_=(0,a.e)([(0,o.n)("esri.core.AsyncUpdate")],_);const x=r.n.getLogger("esri.views.3d.layers.support.SceneLayerViewRequiredFields");let v=class extends(g(l.d)){constructor(e){super(e)}get requiredFields(){const{layerView:{layer:{fieldsIndex:e},definitionExpressionFields:t},rendererFields:i,labelingFields:s,viewFilterFields:a}=this;return(0,n.p)(e,[...(0,r.q)(t,[]),...(0,r.q)(i,[]),...(0,r.q)(s,[]),...(0,r.q)(a,[])])}initialize(){const e=this.layerView.layer;this.layer=e,this.handles.add([this.autoUpdateAsync("rendererFields",(()=>{const{fieldsIndex:e,renderer:t}=this.layer;return t?b((i=>t.collectRequiredFields(i,e))):null})),this.autoUpdateAsync("labelingFields",(()=>{const{layer:e}=this;return e.labelsVisible?b((t=>(0,n.L)(t,e))):null})),this.autoUpdateAsync("viewFilterFields",(()=>{const{layer:e,filter:t}=this.layerView;return b((i=>(0,n.V)(i,e,t)))}))])}};async function b(e){const t=new Set;try{return await e(t),Array.from(t).sort()}catch(e){return x.error(e),null}}(0,a.e)([(0,o.y)()],v.prototype,"layerView",void 0),(0,a.e)([(0,o.y)()],v.prototype,"layer",void 0),(0,a.e)([(0,o.y)()],v.prototype,"requiredFields",null),(0,a.e)([(0,o.y)()],v.prototype,"rendererFields",void 0),(0,a.e)([(0,o.y)()],v.prototype,"labelingFields",void 0),(0,a.e)([(0,o.y)()],v.prototype,"viewFilterFields",void 0),v=(0,a.e)([(0,o.n)("esri.views.3d.layers.support.SceneLayerViewRequiredFields")],v);class w extends h.d{constructor(){super(...arguments),this.layer=null,this.filter=null}get availableFields(){return[]}get maximumNumberOfFeatures(){return 0}set maximumNumberOfFeatures(e){throw new Error("Not implemented")}get maximumNumberOfFeaturesExceeded(){return!1}highlight(e){throw new Error("Not implemented")}queryFeatures(e,t){throw new Error("Not implemented")}queryObjectIds(e,t){throw new Error("Not implemented")}queryFeatureCount(e,t){throw new Error("Not implemented")}createQuery(){throw new Error("Not implemented")}queryExtent(e,t){throw new Error("Not implemented")}}(0,a.e)([(0,o.y)()],w.prototype,"layer",void 0),(0,a.e)([(0,o.y)()],w.prototype,"availableFields",null),(0,a.e)([(0,o.y)()],w.prototype,"maximumNumberOfFeatures",null),(0,a.e)([(0,o.y)({readOnly:!0})],w.prototype,"maximumNumberOfFeaturesExceeded",null),(0,a.e)([(0,o.y)()],w.prototype,"filter",void 0)},26852:(e,t,i)=>{"use strict";i.r(t),i.d(t,{destroyContext:()=>f,dracoDecompressPointCloudData:()=>u,filterObbsForModifications:()=>c,filterObbsForModificationsSync:()=>_,initialize:()=>b,interpretObbModificationResults:()=>g,process:()=>h,setLegacySchema:()=>p,setModifications:()=>d,setModificationsSync:()=>y,test:()=>w}),i(33807);var r=i(80219),s=i(63358);function n(e){return(0,s.a)(`esri/libs/i3s/${e}`)}let a,o,l;async function h(e){await b();const t=[e.geometryBuffer];return{result:m(e,t),transferList:t}}async function u(e){var t;await b();const i=[e.geometryBuffer],{geometryBuffer:s}=e,n=s.byteLength,a=l._malloc(n),o=new Uint8Array(l.HEAPU8.buffer,a,n);o.set(new Uint8Array(s));const h=l.dracoDecompressPointCloudData(a,o.byteLength);if(l._free(a),h.error.length>0)throw`i3s.wasm: ${h.error}`;const u=(null==(t=h.featureIds)?void 0:t.length)>0?(0,r.F)(h.featureIds):null,c=(0,r.F)(h.positions);return u&&i.push(u.buffer),i.push(c.buffer),{result:{positions:c,featureIds:u},transferList:i}}async function c(e){await b(),_(e);const t={buffer:e.buffer};return{result:t,transferList:[t.buffer]}}async function d(e){await b(),y(e)}async function p(e){await b(),l.setLegacySchema(e.context,e.jsonSchema)}function f(e){x(e)}function y(e){const t=e.modifications,i=l._malloc(8*t.length),r=new Float64Array(l.HEAPU8.buffer,i,t.length);for(let e=0;e<t.length;++e)r[e]=t[e];l.setModifications(e.context,i,t.length,e.isGeodetic),l._free(i)}function m(e,t){if(!l)return null;const{context:i,localOrigin:s,globalTrafo:n,mbs:a,obb:o,elevationOffset:h,geometryBuffer:u,geometryDescriptor:c,indexToVertexProjector:d,vertexToRenderProjector:p}=e,f=l._malloc(u.byteLength),y=l._malloc(33*Float64Array.BYTES_PER_ELEMENT),m=new Uint8Array(l.HEAPU8.buffer,f,u.byteLength);m.set(new Uint8Array(u));const g=new Float64Array(l.HEAPU8.buffer,y,33);v(g,s);let _=g.byteOffset+3*g.BYTES_PER_ELEMENT,x=new Float64Array(g.buffer,_);v(x,n),_+=16*g.BYTES_PER_ELEMENT,x=new Float64Array(g.buffer,_),v(x,a),_+=4*g.BYTES_PER_ELEMENT,(0,r.r)(o)&&(x=new Float64Array(g.buffer,_),v(x,o.center),_+=3*g.BYTES_PER_ELEMENT,x=new Float64Array(g.buffer,_),v(x,o.halfSize),_+=3*g.BYTES_PER_ELEMENT,x=new Float64Array(g.buffer,_),v(x,o.quaternion));const b=c,w={isDraco:!1,isLegacy:!1,color:e.layouts.some((e=>e.some((e=>"color"===e.name)))),normal:e.needNormals&&e.layouts.some((e=>e.some((e=>"normalCompressed"===e.name)))),uv0:e.layouts.some((e=>e.some((e=>"uv0"===e.name)))),uvRegion:e.layouts.some((e=>e.some((e=>"uvRegion"===e.name)))),featureIndex:b.featureIndex},S=l.process(i,!!e.obb,f,m.byteLength,b,w,y,h,d,p,e.normalReferenceFrame);if(l._free(y),l._free(f),S.error.length>0)throw`i3s.wasm: ${S.error}`;if(S.discarded)return null;const I=S.componentOffsets.length>0?(0,r.F)(S.componentOffsets):null,C=S.featureIds.length>0?(0,r.F)(S.featureIds):null,M=(0,r.F)(S.interleavedVertedData).buffer,T=1===S.indicesType?(0,r.F)(new Uint16Array(S.indices.buffer,S.indices.byteOffset,S.indices.byteLength/2)):(0,r.F)(new Uint32Array(S.indices.buffer,S.indices.byteOffset,S.indices.byteLength/4)),E=(0,r.F)(S.positions),F=1===S.positionIndicesType?(0,r.F)(new Uint16Array(S.positionIndices.buffer,S.positionIndices.byteOffset,S.positionIndices.byteLength/2)):(0,r.F)(new Uint32Array(S.positionIndices.buffer,S.positionIndices.byteOffset,S.positionIndices.byteLength/4)),A={layout:e.layouts[0],interleavedVertexData:M,indices:T,hasColors:S.hasColors,hasModifications:S.hasModifications,positionData:{data:E,indices:F}};return C&&t.push(C.buffer),I&&t.push(I.buffer),t.push(M),t.push(T.buffer),t.push(E.buffer),t.push(F.buffer),{componentOffsets:I,featureIds:C,transformedGeometry:A,obb:S.obb}}function g(e){return 0===e?0:1===e?1:2===e?2:3}function _(e){const{context:t,buffer:i}=e,r=l._malloc(i.byteLength),s=i.byteLength/Float64Array.BYTES_PER_ELEMENT,n=new Float64Array(l.HEAPU8.buffer,r,s),a=new Float64Array(i);n.set(a),l.filterOBBs(t,r,s),a.set(n),l._free(r)}function x(e){l&&l.destroy(e)}function v(e,t){for(let i=0;i<t.length;++i)e[i]=t[i]}function b(){return l?Promise.resolve():(o||(o=(a||(a=new Promise((e=>Promise.all([i.e(9351),i.e(1596)]).then(i.bind(i,31596)).then((function(e){return e.i})).then((({default:t})=>{const i=t({locateFile:n,onRuntimeInitialized:()=>e(i)});delete i.then})))).catch((e=>Promise.reject(e)))),a).then((e=>{l=e,o=null}))),o)}i(80987),i(88903),i(98548),i(78155),i(20215),i(20736),i(4169),i(92858),i(31531);const w={transform:m,destroy:x}},35123:(e,t,i)=>{"use strict";i.d(t,{f:()=>c});var r,s=i(78155),n=(i(80987),i(80219)),a=i(88903),o=i(58576),l=i(7571),h=i(98548);let u=r=class extends s.a{constructor(e){super(e),this.geometry=null,this.type="clip"}writeGeometry(e,t,i,r){if(r.layer&&r.layer.spatialReference&&!r.layer.spatialReference.equals(this.geometry.spatialReference)){if(!(0,l.n)(e.spatialReference,r.layer.spatialReference))return void(r&&r.messages&&r.messages.push(new a.z("scenemodification:unsupported","Scene modifications with incompatible spatial references are not supported",{modification:this,spatialReference:r.layer.spatialReference,context:r})));const s=new h.j;(0,l.f)(e,s,r.layer.spatialReference),t[i]=s.toJSON(r)}else t[i]=e.toJSON(r);delete t[i].spatialReference}clone(){return new r({geometry:(0,n.y)(this.geometry),type:this.type})}};(0,s.e)([(0,a.y)({type:h.j}),(0,o.g)()],u.prototype,"geometry",void 0),(0,s.e)([(0,s.o)(["web-scene","portal-item"],"geometry")],u.prototype,"writeGeometry",null),(0,s.e)([(0,a.y)({type:["clip","mask","replace"],nonNullable:!0}),(0,o.g)()],u.prototype,"type",void 0),u=r=(0,s.e)([(0,a.n)("esri.layers.support.SceneModification")],u);var c=u},86315:(e,t,i)=>{"use strict";i.d(t,{R:()=>M});var r=i(78155),s=i(80987),n=i(20215),a=i(80219),o=i(88903),l=i(4169),h=i(79229),u=i(98548),c=i(82361),d=i(92858),p=i(8725),f=i(13895),y=i(71409),m=i(52109),g=i(76326),_=i(9612),x=i(68631),v=i(80962);function b(e){e&&e.writtenProperties&&e.writtenProperties.forEach((e=>{const t=e.target;e.newOrigin&&e.oldOrigin!==e.newOrigin&&(0,h.i)(t)&&t.updateOrigin(e.propName,e.newOrigin)}))}async function w(e,t,i){if(!t||!t.resources)return;const r=t.portalItem===e.portalItem?new Set(e.paths):new Set;e.paths.length=0,e.portalItem=t.portalItem;const s=new Set(t.resources.toKeep.map((e=>e.resource.path))),a=new Set,o=[];s.forEach((t=>{r.delete(t),e.paths.push(t)}));for(const n of t.resources.toUpdate)if(r.delete(n.resource.path),s.has(n.resource.path)||a.has(n.resource.path)){const{resource:t,content:r,finish:s,error:a}=n,l=(0,v.getSiblingOfSameTypeI)(t,(0,x.o)());e.paths.push(l.path),o.push(S({resource:l,content:r,finish:s,error:a},i))}else e.paths.push(n.resource.path),o.push(I(n,i)),a.add(n.resource.path);for(const r of t.resources.toAdd)o.push(S(r,i)),e.paths.push(r.resource.path);if(r.forEach((e=>{const i=t.portalItem.resourceFromPath(e);o.push(i.portalItem.removeResource(i).catch((()=>{})))})),0===o.length)return;const l=await(0,n.A)(o);(0,n.a)(i);const h=l.filter((e=>"error"in e)).map((e=>e.error));if(h.length>0)throw new n.s("save:resources","Failed to save one or more resources",{errors:h})}async function S(e,t){const i=await(0,_.a)(e.resource.portalItem.addResource(e.resource,e.content,t));if(!0!==i.ok)throw e.error&&e.error(i.error),i.error;e.finish&&e.finish(e.resource)}async function I(e,t){const i=await(0,_.a)(e.resource.update(e.content,t));if(!0!==i.ok)throw e.error(i.error),i.error;e.finish(e.resource)}const C=a.n.getLogger("esri.layers.mixins.SceneService"),M=e=>{let t=class extends e{constructor(){super(...arguments),this.spatialReference=null,this.fullExtent=null,this.heightModelInfo=null,this.minScale=0,this.maxScale=0,this.version={major:Number.NaN,minor:Number.NaN,versionString:""},this.copyright=null,this.sublayerTitleMode="item-title",this.title=null,this.layerId=null,this.indexInfo=null,this._debouncedSaveOperations=(0,n.B)((async(e,t,i)=>{switch(e){case 0:return this._save(t);case 1:return this._saveAs(i,t)}}))}readSpatialReference(e,t){return this._readSpatialReference(t)}_readSpatialReference(e){if(null!=e.spatialReference)return d.k.fromJSON(e.spatialReference);{const t=e.store,i=t.indexCRS||t.geographicCRS,r=i&&parseInt(i.substring(i.lastIndexOf("/")+1,i.length),10);return null!=r?new d.k(r):null}}readFullExtent(e,t,i){if(null!=e&&"object"==typeof e)return u.M.fromJSON(e,i);const r=t.store,s=this._readSpatialReference(t);return null==s||null==r||null==r.extent||!Array.isArray(r.extent)||r.extent.some((e=>e<T))?null:new u.M({xmin:r.extent[0],ymin:r.extent[1],xmax:r.extent[2],ymax:r.extent[3],spatialReference:s})}readVersion(e,t){const i=t.store,r=null!=i.version?i.version.toString():"",s={major:Number.NaN,minor:Number.NaN,versionString:r},n=r.split(".");return n.length>=2&&(s.major=parseInt(n[0],10),s.minor=parseInt(n[1],10)),s}readTitlePortalItem(e){return"item-title"!==this.sublayerTitleMode?void 0:e}readTitleService(e,t){const i=this.portalItem&&this.portalItem.title;if("item-title"===this.sublayerTitleMode)return(0,p.h)(this.url,t.name);let r=t.name;if(!r&&this.url){const e=(0,p.d)(this.url);(0,a.r)(e)&&(r=e.title)}return"item-title-and-service-name"===this.sublayerTitleMode&&i&&(r=i+" - "+r),(0,p.v)(r)}set url(e){const t=(0,p.g)({layer:this,url:e,nonStandardUrlAllowed:!1,logger:C});this._set("url",t.url),null!=t.layerId&&this._set("layerId",t.layerId)}writeUrl(e,t,i,r){(0,p.O)(this,e,"layers",t,r)}get parsedUrl(){const e=this._get("url");if(!e)return null;const t=(0,s.U)(e);return null!=this.layerId&&(t.path=`${t.path}/layers/${this.layerId}`),t}async _fetchIndexAndUpdateExtent(e,t){this.indexInfo=(0,y.n)(this.parsedUrl.path,this.rootNode,e,this.apiKey,C,t),null==this.fullExtent||this.fullExtent.hasZ||this._updateExtent(await this.indexInfo)}_updateExtent(e){if("page"===(null==e?void 0:e.type)){var t,i;const r=e.rootIndex%e.pageSize,s=null==(t=e.rootPage)||null==(i=t.nodes)?void 0:i[r];if(null==s||null==s.obb||null==s.obb.center||null==s.obb.halfSize)throw new n.s("sceneservice:invalid-node-page","Invalid node page.");if(s.obb.center[0]<T||null==this.fullExtent||this.fullExtent.hasZ)return;const a=s.obb.halfSize,o=s.obb.center[2],l=Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2]);this.fullExtent.zmin=o-l,this.fullExtent.zmax=o+l}else if("node"===(null==e?void 0:e.type)){var r;const t=null==(r=e.rootNode)?void 0:r.mbs;if(!Array.isArray(t)||4!==t.length||t[0]<T)return;const i=t[2],s=t[3];this.fullExtent.zmin=i-s,this.fullExtent.zmax=i+s}}async _fetchService(e){if(null==this.url)throw new n.s("sceneservice:url-not-set","Scene service can not be loaded without valid portal item or url");if(null==this.layerId&&/SceneServer\/*$/i.test(this.url)){const t=await this._fetchFirstLayerId(e);null!=t&&(this.layerId=t)}return this._fetchServiceLayer(e)}async _fetchFirstLayerId(e){const t=await(0,s.L)(this.url,{query:{f:"json",token:this.apiKey},responseType:"json",signal:e});if(t.data&&Array.isArray(t.data.layers)&&t.data.layers.length>0)return t.data.layers[0].id}async _fetchServiceLayer(e){const t=await(0,s.L)(this.parsedUrl.path,{query:{f:"json",token:this.apiKey},responseType:"json",signal:e});t.ssl&&(this.url=this.url.replace(/^http:/i,"https:"));const i=t.data;this.read(i,{origin:"service",url:this.parsedUrl}),this.validateLayer(i)}async _ensureLoadBeforeSave(){await this.load(),"beforeSave"in this&&"function"==typeof this.beforeSave&&await this.beforeSave()}validateLayer(e){}_updateTypeKeywords(e,t,i){e.typeKeywords||(e.typeKeywords=[]);const r=t.getTypeKeywords();for(const t of r)e.typeKeywords.push(t);e.typeKeywords&&(e.typeKeywords=e.typeKeywords.filter(((e,t,i)=>i.indexOf(e)===t)),1===i&&(e.typeKeywords=e.typeKeywords.filter((e=>"Hosted Service"!==e))))}async _saveAs(e,t){const i={...A,...t};let r=g.default.from(e);r||(C.error("_saveAs(): requires a portal item parameter"),await Promise.reject(new n.s("sceneservice:portal-item-required","_saveAs() requires a portal item to save to"))),r.id&&(r=r.clone(),r.id=null);const s=r.portal||m.G.getDefault();await this._ensureLoadBeforeSave(),r.type=F,r.portal=s;const a={origin:"portal-item",url:null,messages:[],portal:s,portalItem:r,writtenProperties:[],blockedRelativeUrls:[],resources:{toAdd:[],toUpdate:[],toKeep:[],pendingOperations:[]}},o={layers:[this.write(null,a)]};return await Promise.all(a.resources.pendingOperations),await this._validateAgainstJSONSchema(o,a,i),r.url=this.url,r.title||(r.title=this.title),this._updateTypeKeywords(r,i,1),await s._signIn(),await s.user.addItem({item:r,folder:i&&i.folder,data:o}),await w(this.resourceReferences,a,null),this.portalItem=r,b(a),a.portalItem=r,r}async _save(e){const t={...A,...e};this.portalItem||(C.error("_save(): requires the .portalItem property to be set"),await Promise.reject(new n.s("sceneservice:portal-item-not-set","Portal item to save to has not been set on this SceneService"))),this.portalItem.type!==F&&(C.error("_save(): Non-matching portal item type. Got "+this.portalItem.type+", expected "+F),await Promise.reject(new n.s("sceneservice:portal-item-wrong-type",`Portal item needs to have type "${F}"`))),await this._ensureLoadBeforeSave();const i={origin:"portal-item",url:this.portalItem.itemUrl&&(0,s.U)(this.portalItem.itemUrl),messages:[],portal:this.portalItem.portal||m.G.getDefault(),portalItem:this.portalItem,writtenProperties:[],blockedRelativeUrls:[],resources:{toAdd:[],toUpdate:[],toKeep:[],pendingOperations:[]}},r={layers:[this.write(null,i)]};return await Promise.all(i.resources.pendingOperations),await this._validateAgainstJSONSchema(r,i,t),this.portalItem.url=this.url,this.portalItem.title||(this.portalItem.title=this.title),this._updateTypeKeywords(this.portalItem,t,0),await this.portalItem.update({data:r}),await w(this.resourceReferences,i,null),b(i),this.portalItem}async _validateAgainstJSONSchema(e,t,r){let s=t.messages.filter((e=>"error"===e.type)).map((e=>new n.s(e.name,e.message,e.details)));if(r&&r.validationOptions.ignoreUnsupported&&(s=s.filter((e=>"layer:unsupported"!==e.name&&"symbol:unsupported"!==e.name&&"symbol-layer:unsupported"!==e.name&&"property:unsupported"!==e.name&&"url:unsupported"!==e.name&&"scenemodification:unsupported"!==e.name))),r.validationOptions.enabled||E){const t=(await Promise.all([i.e(8866),i.e(9351)]).then(i.bind(i,54949))).validate(e,r.portalItemLayerType);if(t.length>0){const e=`Layer item did not validate:\n${t.join("\n")}`;if(C.error(`_validateAgainstJSONSchema(): ${e}`),"throw"===r.validationOptions.failPolicy){const e=t.map((e=>new n.s("sceneservice:schema-validation",e))).concat(s);throw new n.s("sceneservice-validate:error","Failed to save layer item due to schema validation, see `details.errors`.",{combined:e})}}}if(s.length>0)throw new n.s("sceneservice:save","Failed to save SceneService due to unsupported or invalid content. See 'details.errors' for more detailed information",{errors:s})}};return(0,r.e)([(0,o.y)(f.g)],t.prototype,"id",void 0),(0,r.e)([(0,o.y)({type:d.k})],t.prototype,"spatialReference",void 0),(0,r.e)([(0,l.e)("spatialReference",["spatialReference","store.indexCRS","store.geographicCRS"])],t.prototype,"readSpatialReference",null),(0,r.e)([(0,o.y)({type:u.M})],t.prototype,"fullExtent",void 0),(0,r.e)([(0,l.e)("fullExtent",["fullExtent","store.extent","spatialReference","store.indexCRS","store.geographicCRS"])],t.prototype,"readFullExtent",null),(0,r.e)([(0,o.y)({readOnly:!0,type:c.v})],t.prototype,"heightModelInfo",void 0),(0,r.e)([(0,o.y)({type:Number,json:{name:"layerDefinition.minScale",write:!0,origins:{service:{read:{source:"minScale"},write:!1}}}})],t.prototype,"minScale",void 0),(0,r.e)([(0,o.y)({type:Number,json:{name:"layerDefinition.maxScale",write:!0,origins:{service:{read:{source:"maxScale"},write:!1}}}})],t.prototype,"maxScale",void 0),(0,r.e)([(0,o.y)({readOnly:!0})],t.prototype,"version",void 0),(0,r.e)([(0,l.e)("version",["store.version"])],t.prototype,"readVersion",null),(0,r.e)([(0,o.y)({type:String,json:{read:{source:"copyrightText"}}})],t.prototype,"copyright",void 0),(0,r.e)([(0,o.y)({type:String,json:{read:!1}})],t.prototype,"sublayerTitleMode",void 0),(0,r.e)([(0,o.y)({type:String})],t.prototype,"title",void 0),(0,r.e)([(0,l.e)("portal-item","title")],t.prototype,"readTitlePortalItem",null),(0,r.e)([(0,l.e)("service","title",["name"])],t.prototype,"readTitleService",null),(0,r.e)([(0,o.y)({type:Number,json:{origins:{service:{read:{source:"id"}},"portal-item":{write:{target:"id",isRequired:!0,ignoreOrigin:!0},read:!1}}}})],t.prototype,"layerId",void 0),(0,r.e)([(0,o.y)(f.p)],t.prototype,"url",null),(0,r.e)([(0,r.o)("url")],t.prototype,"writeUrl",null),(0,r.e)([(0,o.y)()],t.prototype,"parsedUrl",null),(0,r.e)([(0,o.y)({readOnly:!0})],t.prototype,"store",void 0),(0,r.e)([(0,o.y)({type:String,readOnly:!0,json:{read:{source:"store.rootNode"}}})],t.prototype,"rootNode",void 0),t=(0,r.e)([(0,o.n)("esri.layers.mixins.SceneService")],t),t},T=-1e38,E=!1,F="Scene Service",A={getTypeKeywords:()=>[],portalItemLayerType:"unknown",validationOptions:{enabled:!0,ignoreUnsupported:!1,failPolicy:"throw"}}},6488:(e,t,i)=>{"use strict";i.d(t,{t:()=>s});var r=i(25290);class s{constructor(e,t){this.lockedSchemaPixelSize=e,this.isGCS=t}getLevelRowColumn(e){return this.isGCS?[e[0],e[1]>>1,e[2]>>1]:256===this.lockedSchemaPixelSize&&e[0]>0?[e[0]-1,e[1]>>1,e[2]>>1]:e}adjustLevel(e){return this.isGCS?e:256===this.lockedSchemaPixelSize?e>0?e-1:0:e}getShift(e,t){let i=0,r=0;return(256===this.lockedSchemaPixelSize||this.isGCS)&&(e[2]%2&&(i=t),e[1]%2&&(r=t)),[i,r]}getScale(e){if(this.isGCS){if(512===this.lockedSchemaPixelSize)return 4}else if(256===this.lockedSchemaPixelSize&&0===e)return 1;return 2}static create256x256CompatibleTileInfo(e){if(!e)return null;if(256===e.size[0]&&256===e.size[1])return e;const t=e.spatialReference.isGeographic,i=[],s=e.lods.length;for(let n=0;n<s;n++){const s=e.lods[n],a=t?s.resolution:2*s.resolution;i.push(new r.i({level:s.level,scale:s.scale,resolution:a}))}return new r.S({size:[256,256],dpi:e.dpi,format:e.format,compressionQuality:e.compressionQuality,origin:e.origin,spatialReference:e.spatialReference,lods:i})}static create512x512CompatibleTileInfo(e){if(!e)return null;if(256===e.size[0]||256===e.size[1])return null;const t=[],i=e.lods.length;for(let s=0;s<i;s++){const i=e.lods[s],n=.5*i.resolution;t.push(new r.i({level:i.level,scale:i.scale,resolution:n}))}return new r.S({size:[512,512],dpi:e.dpi,format:e.format,compressionQuality:e.compressionQuality,origin:e.origin,spatialReference:e.spatialReference,lods:t})}}},79766:(e,t,i)=>{"use strict";i.d(t,{e:()=>a,n:()=>s,t:()=>n});var r=i(93875);function s(e){let t="";for(const i in e){const r=e[i];if("boolean"==typeof r)r&&(t+=`#define ${i}\n`);else if("number"==typeof r)t+=`#define ${i} ${r.toFixed()}\n`;else if("object"==typeof r){const e=r.options;let s=0;for(const i in e)t+=`#define ${e[i]} ${(s++).toFixed()}\n`;t+=`#define ${i} ${e[r.value]}\n`}}return t}function n(e,t,i,s){i=i||{},s=s||"";const n="function"==typeof t.shaders?t.shaders(i):t.shaders;return new r.p(e,s+n.vertexShader,s+n.fragmentShader,t.attributes)}class a{constructor(e){this.readFile=e}resolveIncludes(e){return this.resolve(e)}resolve(e,t=new Map){if(t.has(e))return t.get(e);const i=this.read(e);if(!i)throw new Error(`cannot find shader file ${e}`);const r=/^[^\S\n]*#include\s+<(\S+)>[^\S\n]?/gm;let s=r.exec(i);const n=[];for(;null!=s;)n.push({path:s[1],start:s.index,length:s[0].length}),s=r.exec(i);let a=0,o="";return n.forEach((e=>{o+=i.slice(a,e.start),o+=t.has(e.path)?"":this.resolve(e.path,t),a=e.start+e.length})),o+=i.slice(a),t.set(e,o),o}read(e){return this.readFile(e)}}},67098:(e,t,i)=>{"use strict";i.d(t,{E:()=>C,a:()=>p,b:()=>c,c:()=>G,f:()=>v,g:()=>z,h:()=>I,i:()=>x,l:()=>g,m:()=>L,n:()=>d,o:()=>y,p:()=>D,s:()=>f,t:()=>u,u:()=>_,v:()=>U,w:()=>E});var r=i(20215),s=i(9389),n=i(54622),a=i(6770),o=i(92858),l=i(2502);class h{constructor(e,t){this._lastId=-1,this._progress=t,this._parent=e}reset(){this._lastId=-1}nextBatch(e){if(null!==this._parent._mainSetInUse)return this._parent._mainSetInUse.then((t=>this.nextBatch(e)),(t=>this.nextBatch(e)));const t={returnpromise:null,hasset:!1},i=[];return t.returnpromise=(0,r.l)(((r,s)=>{this._parent._getSet(this._progress).then((n=>{let a=n._known.length-1;if("GETPAGES"===n._known[n._known.length-1]&&(a-=1),this._lastId+e>a&&n._known.length>0&&"GETPAGES"===n._known[n._known.length-1])this._parent._expandPagedSet(n,this._parent._maxQueryRate(),0,0,this._progress).then((i=>{t.hasset=!0,this._parent._mainSetInUse=null,this.nextBatch(e).then(r,s)}),(e=>{t.hasset=!0,this._parent._mainSetInUse=null,s(e)}));else{if(a>=this._lastId+e||0===n._candidates.length){for(let t=0;t<e;t++){const e=t+this._lastId+1;if(e>=n._known.length)break;i[t]=n._known[e]}return this._lastId+=i.length,0===i.length&&(t.hasset=!0,this._parent._mainSetInUse=null,r([])),void this._parent._getFeatureBatch(i,this._progress).then((e=>{t.hasset=!0,this._parent._mainSetInUse=null,r(e)}),(e=>{t.hasset=!0,this._parent._mainSetInUse=null,s(e)}))}this._parent._refineSetBlock(n,this._parent._maxProcessingRate(),this._progress).then((()=>{t.hasset=!0,this._parent._mainSetInUse=null,this.nextBatch(e).then(r,s)}),(e=>{t.hasset=!0,this._parent._mainSetInUse=null,s(e)}))}}),(e=>{t.hasset=!0,this._parent._mainSetInUse=null,s(e)}))})),!1===t.hasset&&(this._parent._mainSetInUse=t.returnpromise,t.hasset=!0),t.returnpromise}next(){if(null!==this._parent._mainSetInUse)return this._parent._mainSetInUse.then((e=>this.next()),(e=>this.next()));const e={returnpromise:null,hasset:!1};return e.returnpromise=(0,r.l)(((t,i)=>{this._parent._getSet(this._progress).then((r=>{this._lastId<r._known.length-1?"GETPAGES"===r._known[this._lastId+1]?this._parent._expandPagedSet(r,this._parent._maxQueryRate(),0,0,this._progress).then((t=>(e.hasset=!0,this._parent._mainSetInUse=null,this.next()))).then(t,i):(this._lastId+=1,this._parent._getFeature(r,r._known[this._lastId],this._progress).then((i=>{e.hasset=!0,this._parent._mainSetInUse=null,t(i)}),(t=>{e.hasset=!0,this._parent._mainSetInUse=null,i(t)}))):r._candidates.length>0?this._parent._refineSetBlock(r,this._parent._maxProcessingRate(),this._progress).then((()=>{e.hasset=!0,this._parent._mainSetInUse=null,this.next().then(t,i)}),(t=>{e.hasset=!0,this._parent._mainSetInUse=null,i(t)})):(e.hasset=!0,this._parent._mainSetInUse=null,t(null))}),(t=>{e.hasset=!0,this._parent._mainSetInUse=null,i(t)}))})),!1===e.hasset&&(this._parent._mainSetInUse=e.returnpromise,e.hasset=!0),e.returnpromise}count(){return-1!==this._parent._totalCount?(0,r.x)(this._parent._totalCount):this._parent._getSet(this._progress).then((e=>this._refineAllSets(e))).then((e=>(this._parent._totalCount=e._known.length,(0,r.x)(this._parent._totalCount))))}_refineAllSets(e){return e._known.length>0&&"GETPAGES"===e._known[e._known.length-1]?this._parent._expandPagedSet(e,this._parent._maxQueryRate(),0,1,this._progress).then((t=>this._refineAllSets(e))).then((e=>(0,r.x)(e))):e._candidates.length>0?"GETPAGES"===e._known[e._candidates.length-1]?this._parent._expandPagedSet(e,this._parent._maxQueryRate(),0,2,this._progress).then((t=>this._refineAllSets(e))).then((e=>(0,r.x)(e))):this._parent._refineSetBlock(e,this._parent._maxProcessingRate(),this._progress).then((e=>e._candidates.length>0?this._refineAllSets(e):(0,r.x)(e))):(0,r.x)(e)}}class u{constructor(e,t,i,r){this._candidates=null,this._known=null,this._lastFetchedIndex=0,this._ordered=!1,this.pagesDefinition=null,this._candidates=e,this._known=t,this._ordered=i,this.pagesDefinition=r}}class c{constructor(){this._databaseTypeMetaData={},this._layerInfo={}}clearDatabaseType(e){void 0===this._databaseTypeMetaData[e]&&delete this._databaseTypeMetaData[e]}getDatabaseType(e){return"MUSTBESET"===e||void 0===this._databaseTypeMetaData[e]?null:this._databaseTypeMetaData[e]}setDatabaseType(e,t){this._databaseTypeMetaData[e]=t}getLayerInfo(e){return void 0===this._layerInfo[e]?null:this._layerInfo[e]}setLayerInfo(e,t){this._layerInfo[e]=t}clearLayerInfo(e){void 0!==this._layerInfo[e]&&delete this._layerInfo[e]}}function d(e,t){return m(e.parseTree,t,e.parameters)}function p(e,t,i){return m(e,t,i)}function f(e,t,i,r){return n.WhereClause.create(m(e.parseTree,s.a3.Standardised,e.parameters,t,i),r)}function y(e,t,i="AND"){return n.WhereClause.create("(("+d(e,s.a3.Standardised)+")"+i+"("+d(t,s.a3.Standardised)+"))",e.fieldsIndex)}function m(e,t,i,r=null,s=null){let n,a,o,l;switch(e.type){case"interval":return E(m(e.value,t,i,r,s),e.qualifier,e.op);case"case_expression":{let n=" CASE ";"simple"===e.format&&(n+=m(e.operand,t,i,r,s));for(let a=0;a<e.clauses.length;a++)n+=" WHEN "+m(e.clauses[a].operand,t,i,r,s)+" THEN "+m(e.clauses[a].value,t,i,r,s);return null!==e.else&&(n+=" ELSE "+m(e.else,t,i,r,s)),n+=" END ",n}case"param":{const r=i[e.value.toLowerCase()];if("string"==typeof r)return"'"+i[e.value.toLowerCase()].toString().replace(/'/g,"''")+"'";if(r instanceof Date)return _(r,t);if(r instanceof Array){const e=[];for(let i=0;i<r.length;i++)"string"==typeof r[i]?e.push("'"+r[i].toString().replace(/'/g,"''")+"'"):r[i]instanceof Date?e.push(_(r[i],t)):e.push(r[i].toString());return e}return r.toString()}case"expr_list":a=[];for(const n of e.value)a.push(m(n,t,i,r,s));return a;case"unary_expr":return" ( NOT "+m(e.expr,t,i,r,s)+" ) ";case"binary_expr":switch(e.operator){case"AND":return" ("+m(e.left,t,i,r,s)+" AND "+m(e.right,t,i,r,s)+") ";case"OR":return" ("+m(e.left,t,i,r,s)+" OR "+m(e.right,t,i,r,s)+") ";case"IS":if("null"!==e.right.type)throw new Error("Unsupported RHS for IS");return" ("+m(e.left,t,i,r,s)+" IS NULL )";case"ISNOT":if("null"!==e.right.type)throw new Error("Unsupported RHS for IS");return" ("+m(e.left,t,i,r,s)+" IS NOT NULL )";case"IN":return n=[],"expr_list"===e.right.type?(n=m(e.right,t,i,r,s)," ("+m(e.left,t,i,r,s)+" IN ("+n.join(",")+")) "):(l=m(e.right,t,i,r,s),l instanceof Array?" ("+m(e.left,t,i,r,s)+" IN ("+l.join(",")+")) ":" ("+m(e.left,t,i,r,s)+" IN ("+l+")) ");case"NOT IN":return n=[],"expr_list"===e.right.type?(n=m(e.right,t,i,r,s)," ("+m(e.left,t,i,r,s)+" NOT IN ("+n.join(",")+")) "):(l=m(e.right,t,i,r,s),l instanceof Array?" ("+m(e.left,t,i,r,s)+" NOT IN ("+l.join(",")+")) ":" ("+m(e.left,t,i,r,s)+" NOT IN ("+l+")) ");case"BETWEEN":return o=m(e.right,t,i,r,s)," ("+m(e.left,t,i,r,s)+" BETWEEN "+o[0]+" AND "+o[1]+" ) ";case"NOTBETWEEN":return o=m(e.right,t,i,r,s)," ("+m(e.left,t,i,r,s)+" NOT BETWEEN "+o[0]+" AND "+o[1]+" ) ";case"LIKE":return""!==e.escape?" ("+m(e.left,t,i,r,s)+" LIKE "+m(e.right,t,i,r,s)+" ESCAPE '"+e.escape+"') ":" ("+m(e.left,t,i,r,s)+" LIKE "+m(e.right,t,i,r,s)+") ";case"NOT LIKE":return""!==e.escape?" ("+m(e.left,t,i,r,s)+" NOT LIKE "+m(e.right,t,i,r,s)+" ESCAPE '"+e.escape+"') ":" ("+m(e.left,t,i,r,s)+" NOT LIKE "+m(e.right,t,i,r,s)+") ";case"<>":case"<":case">":case">=":case"<=":case"=":case"*":case"-":case"+":case"/":return" ("+m(e.left,t,i,r,s)+" "+e.operator+" "+m(e.right,t,i,r,s)+") "}throw new Error("Not Supported Operator "+e.operator);case"null":return"null";case"bool":return!0===e.value?"1":"0";case"string":return"'"+e.value.toString().replace(/'/g,"''")+"'";case"timestamp":case"date":return _(e.value,t);case"number":return e.value.toString();case"current_time":return x("date"===e.mode,t);case"column_ref":return r&&r.toLowerCase()===e.column.toLowerCase()?"("+s+")":e.column;case"function":{const n=m(e.args,t,i,r,s);return g(e.name,n,t)}}throw new Error("Unsupported sql syntax "+e.type)}function g(e,t,i){switch(e.toLowerCase().trim()){case"abs":if(1!==t.length)throw new Error("Invalid Parameter for call to ABS");return"abs("+t[0]+")";case"ceiling":case"ceil":if(1!==t.length)throw new Error("Invalid Parameter for call to CEILING");switch(i){case s.a3.Standardised:case s.a3.StandardisedNoInterval:default:return"CEILING("+t[0]+")"}case"floor":if(1!==t.length)throw new Error("Invalid Parameter for call to Floor");return"FLOOR("+t[0]+")";case"log":if(1!==t.length)throw new Error("Invalid Parameter for call to LOG");return"LOG("+t[0]+")";case"log10":if(1!==t.length)throw new Error("Invalid Parameter for call to LOG10");return"LOG10("+t[0]+")";case"power":if(2!==t.length)throw new Error("Invalid Parameter for call to POWER");return"POWER("+t[0]+","+t[1]+")";case"round":if(2===t.length)return"ROUND("+t[0]+","+t[1]+")";if(1===t.length)return"ROUND("+t[0]+")";throw new Error("Invalid Parameter for call to ROUND");case"truncate":if(t.length<1||t.length>2)throw new Error("Invalid Parameter for TRUNCATE function");switch(i){case s.a3.SqlServer:return"ROUND("+t[0]+(1===t.length?"0":","+t[1])+",1)";default:return"TRUNCATE("+t[0]+(1===t.length?")":","+t[1]+")")}case"char_length":case"len":if(1!==t.length)throw new Error("Invalid Parameter for CHAR_LENGTH function");switch(i){case s.a3.SqlServer:return"LEN("+t[0]+")";case s.a3.Oracle:return"LENGTH("+t[0]+")";default:return"CHAR_LENGTH("+t[0]+")"}case"concat":if(t.length<1)throw new Error("Invalid Parameter for CONCAT function");{let e="CONCAT(";for(let i=0;i<t.length;i++)0!==i&&(e+=","),e+=t[i];return e+=")",e}case"lower":case"lcase":if(1!==t.length)throw new Error("Invalid Parameter for Lower function");return"LOWER("+t[0]+")";case"upper":case"ucase":if(1!==t.length)throw new Error("Invalid Parameter for Upper function");return"UPPER("+t[0]+")";case"substring":{let e="";switch(i){case s.a3.Oracle:return e="SUBSTR("+t[0]+","+t[1],3===t.length&&(e+=","+t[2]),e+=")",e;case s.a3.SqlServer:return e=3===t.length?"SUBSTRING("+t[0]+","+t[1]+","+t[2]+")":"SUBSTRING("+t[0]+",  "+t[1]+", LEN("+t[0]+") - "+t[1]+")",e;default:return e="SUBSTRING("+t[0]+" FROM "+t[1],3===t.length&&(e+=" FOR "+t[2]),e+=")",e}}case"extract":return"EXTRACT("+t[0].replace(/\'/g,"")+" FROM "+t[1]+")"}throw new Error("Function Not Recognised")}function _(e,t){const i=s.a8.Moment(e),r=0===i.minute()&&0===i.hour()&&0===i.second()&&0===i.millisecond();switch(t){case s.a3.FILEGDB:case s.a3.Standardised:case s.a3.StandardisedNoInterval:return r?"date '"+i.format("YYYY-MM-DD")+"'":"date '"+i.format("YYYY-MM-DD HH:mm:ss")+"'";case s.a3.Oracle:return r?"TO_DATE('"+i.format("YYYY-MM-DD")+"','YYYY-MM-DD')":"TO_DATE('"+i.format("YYYY-MM-DD HH:mm:ss")+"','YYYY-MM-DD HH24:MI:SS')";case s.a3.SqlServer:return"'"+i.format(r?"YYYY-MM-DD":"YYYY-MM-DD HH:mm:ss")+"'";case s.a3.PGDB:return"#"+i.format(r?"MM-DD-YYYY":"MM-DD-YYYY HH:mm:ss")+"#";case s.a3.Postgres:return"TIMESTAMP '"+i.format(r?"YYYY-MM-DD":"YYYY-MM-DD HH:mm:ss")+"'";default:return"date '"+i.format("YYYY-MM-DD HH:mm:ss")+"'"}}function x(e,t){switch(t){case s.a3.FILEGDB:case s.a3.Standardised:case s.a3.StandardisedNoInterval:case s.a3.Oracle:return e?"CURRENT_DATE":"CURRENT_TIMESTAMP";case s.a3.SqlServer:return e?"CAST(GETDATE() AS DATE)":"GETDATE()";case s.a3.PGDB:case s.a3.Postgres:default:return e?"CURRENT_DATE":"CURRENT_TIMESTAMP"}}function v(e,t,i={}){const r={},s={},n={esriFieldTypeSmallInteger:"integer",esriFieldTypeInteger:"integer",esriFieldTypeSingle:"double",esriFieldTypeDouble:"double",esriFieldTypeString:"string",esriFieldTypeDate:"date",esriFieldTypeOID:"integer",oid:"integer",long:"integer","small-integer":"integer",integer:"integer",single:"double",double:"double",date:"date",string:"string"};for(const e of t){const t=n[e.type];r[e.name.toLowerCase()]=void 0===t?"":t}for(const e in i){const t=n[i[e]];s[e.toLowerCase()]=void 0===t?"":t}switch(b(r,e.parseTree,e.parameters,s)){case"double":return"double";case"integer":return"integer";case"double":return"double";case"date":return"date";case"string":return"string"}return""}function b(e,t,i,r){let s;switch(t.type){case"interval":return"integer";case"case_expression":{const s=[];if("simple"===t.format){for(let n=0;n<t.clauses.length;n++)s.push(b(e,t.clauses[n].value,i,r));null!==t.else&&s.push(b(e,t.else,i,r))}else{for(let n=0;n<t.clauses.length;n++)s.push(b(e,t.else,i,r));null!==t.else&&s.push(b(e,t.else,i,r))}return S(s)}case"param":{const e=r[t.value.toLowerCase()];if(void 0===e&&i){const e=i[t.value.toLowerCase()];if(void 0===e)return"";if(null===e)return"";if("string"==typeof e||e instanceof String)return"string";if("boolean"==typeof e)return"boolean";if(e instanceof Date)return"date";if("number"==typeof e)return e%1==0?"integer":"double"}return void 0===e?"":e}case"expr_list":{const s=[];for(const n of t.value)s.push(b(e,n,i,r));return s}case"unary_expr":return"boolean";case"binary_expr":switch(t.operator){case"AND":case"OR":return"boolean";case"IS":case"ISNOT":if("null"!==t.right.type)throw new Error("Unsupported RHS for IS");return"boolean";case"IN":case"NOT IN":case"BETWEEN":case"NOTBETWEEN":case"LIKE":case"NOT LIKE":return"boolean";case"<>":case"<":case">":case">=":case"<=":case"=":return"boolean";case"*":case"-":case"+":case"/":return S([b(e,t.left,i,r),b(e,t.right,i,r)]);default:throw new Error("Not Supported Operator "+t.operator)}case"null":return"";case"bool":return"boolean";case"string":return"string";case"number":return null===t.value?"":t.value%1==0?"integer":"double";case"date":case"timestamp":case"current_time":return"date";case"column_ref":{const i=e[t.column.toLowerCase()];return void 0===i?"":i}case"function":switch(t.name.toLowerCase()){case"position":case"extract":case"char_length":return"integer";case"round":return s=b(e,t.args,i,r),s instanceof Array?s.length>0?s[0]:"":s;case"sign":return s=b(e,t.args,i,r),s instanceof Array&&(s=S(s)),"integer"===s||"double"===s?s:"double";case"ceiling":case"floor":case"abs":{const s=b(e,t.args,i,r);return s instanceof Array?S(s):s}case"area":case"length":case"log":case"log10":case"sin":case"cos":case"tan":case"asin":case"acos":case"atan":case"power":return"double";case"substring":case"trim":case"concat":case"lower":case"upper":return"string";case"truncate":return"double";case"round":return s=b(e,t.args,i,r),s instanceof Array?s.length>0?s[0]:"":s}return""}throw new Error("Unsupported sql syntax "+t.type)}c.applicationCache=null;const w={boolean:1,string:2,integer:3,double:4,date:5};function S(e){if(e){let t="";for(const i of e)""!==i&&(t=""===t||w[t]<w[i]?i:t);return t}return""}function I(e,t){return M(e.parseTree,t)}function C(e){return"column_ref"===e.parseTree.type}function M(e,t){if(null==e)return!1;switch(e.type){case"when_clause":return M(e.operand,t)||M(e.value,t);case"case_expression":for(const i of e.clauses)if(M(i,t))return!0;return!("simple"!==e.format||!M(e.operand,t))||!(null===e.else||!M(e.else,t));case"param":return!1;case"expr_list":for(const i of e.value)if(M(i,t))return!0;return!1;case"unary_expr":return M(e.expr,t);case"binary_expr":return M(e.left,t)||M(e.right,t);case"null":case"bool":case"date":case"timestamp":case"string":case"number":return!1;case"column_ref":return t.toLowerCase()===e.column.toLowerCase();case"function":return M(e.args,t)}return!1}function T(e){let t="";return t+=e.period.toUpperCase(),t}function E(e,t,i){let r="";return r="interval-period"===t.type?T(t):T(t.start)+" TO "+T(t.end),"INTERVAL "+i+" "+e+" "+r}function F(e){let t=0;for(let i=0;i<e.length;i++)t+=e[i];return t/e.length}function A(e){const t=F(e);let i=0;for(let r=0;r<e.length;r++)i+=(t-e[r])**2;return i/e.length}function R(e){const t=F(e);let i=0;for(let r=0;r<e.length;r++)i+=(t-e[r])**2;return i/(e.length-1)}function P(e){let t=0;for(let i=0;i<e.length;i++)t+=e[i];return t}function L(e){switch(e.toLowerCase()){case"distinct":return"distinct";case"avg":case"mean":return"avg";case"min":return"min";case"sum":return"sum";case"max":return"max";case"stdev":case"stddev":return"stddev";case"var":case"variance":return"var";case"count":return"count"}return""}function D(e,t,i=1e3){switch(e.toLowerCase()){case"distinct":return function(e,t){const i=[],r={},n=[];for(let a=0;a<e.length;a++){if(void 0!==e[a]&&null!==e[a]){const t=e[a];if((0,s.a9)(t)||(0,s.aa)(t))void 0===r[t]&&(i.push(t),r[t]=1);else{let e=!1;for(let i=0;i<n.length;i++)!0===(0,s.ab)(n[i],t)&&(e=!0);!1===e&&(n.push(t),i.push(t))}}if(i.length>=t&&-1!==t)return i}return i}(t,i);case"avg":case"mean":return F(t);case"min":return Math.min.apply(Math,t);case"sum":return P(t);case"max":return Math.max.apply(Math,t);case"stdev":case"stddev":return Math.sqrt(A(t));case"var":case"variance":return A(t);case"count":return t.length}return 0}function N(e,t,i,s=!1){try{const n=e.iterator(i);return(0,r.l)(((e,i)=>{O(n,[],t,s,e,i)}))}catch(e){return(0,r.L)(e)}}function O(e,t,i,r,n,a){(0,s.a4)(e.next().then((s=>{try{if(null!==s){const o=i.calculateValue(s);return null===o?!1===r&&(t[t.length]=o):t[t.length]=o,O(e,t,i,r,n,a)}n(t)}catch(e){a(e)}}),a))}function k(e,t,i=1e3,s=null){return function(e,t,i,s){try{return V(e.iterator(s),{},[],t,i)}catch(e){return(0,r.L)(e)}}(e,t,i,s)}function V(e,t,i,r,s){return e.next().then((n=>{if(null!==n){const a=r.calculateValue(n);return null!=a&&void 0===t[a]&&(i.push(a),t[a]=1),i.length>=s&&-1!==s?i:V(e,t,i,r,s)}return i}))}class U{constructor(e){this.recentlyUsedQueries=null,this.featureSetQueryInterceptor=null,this._idstates=[],this._parent=null,this._wset=null,this._mainSetInUse=null,this._maxProcessing=200,this._maxQuery=500,this._totalCount=-1,this._databaseType=s.a3.NotEvaluated,this._databaseTypeProbed=null,this.declaredRootClass="esri.arcade.featureset.support.FeatureSet",this._featureCache=[],this.types=null,this.fields=null,this.geometryType="",this.objectIdField="",this.globalIdField="",this.spatialReference=null,this.hasM=!1,this.hasZ=!1,this._transparent=!1,this.loaded=!1,this._loadPromise=null,this._fieldsIndex=null,e&&e.lrucache&&(this.recentlyUsedQueries=e.lrucache),e&&e.interceptor&&(this.featureSetQueryInterceptor=e.interceptor)}optimisePagingFeatureQueries(e){this._parent&&this._parent.optimisePagingFeatureQueries(e)}_hasMemorySource(){return!0}prop(e,t){return void 0===t?this[e]:(void 0!==this[e]&&(this[e]=t),this)}end(){return null!==this._parent&&!0===this._parent._transparent?this._parent.end():this._parent}_ensureLoaded(){return this.load()}load(){return null===this._loadPromise&&(this._loadPromise=(0,r.l)(((e,t)=>{if(!0===this._parent.loaded)return this._initialiseFeatureSet(),void e(this);this._parent.load().then((()=>{try{this._initialiseFeatureSet(),e(this)}catch(e){t(e)}}),t)}))),this._loadPromise}_initialiseFeatureSet(){null!==this._parent?(this.fields=this._parent.fields.slice(0),this.geometryType=this._parent.geometryType,this.objectIdField=this._parent.objectIdField,this.globalIdField=this._parent.globalIdField,this.spatialReference=this._parent.spatialReference,this.hasM=this._parent.hasM,this.hasZ=this._parent.hasZ,this.typeIdField=this._parent.typeIdField,this.types=this._parent.types):(this.fields=[],this.typeIdField="",this.objectIdField="",this.globalIdField="",this.spatialReference=new o.k({wkid:4326}),this.geometryType=s.a0.point)}getField(e,t){let i;return(t=t||this.fields)&&(e=e.toLowerCase(),t.some((t=>(t&&t.name.toLowerCase()===e&&(i=t),!!i)))),i}getFieldsIndex(){return null===this._fieldsIndex&&(this._fieldsIndex=new l.e(this.fields)),this._fieldsIndex}_maxProcessingRate(){return null!==this._parent?Math.min(this._maxProcessing,this._parent._maxProcessingRate()):Math.min(this._maxProcessing,this._maxQueryRate())}_maxQueryRate(){return null!==this._parent?Math.max(this._maxQuery,this._parent._maxQueryRate()):this._maxQuery}_checkCancelled(e){if(null!==e&&e.aborted)throw new Error("Operation has been cancelled.")}nativeCapabilities(){return this._parent.nativeCapabilities()}_canDoAggregates(e,t,i,s,n){return null===this._parent?(0,r.x)(!1):this._parent._canDoAggregates(e,t,i,s,n)}_getAggregatePagesDataSourceDefinition(e,t,i,s,n,a,o){return null===this._parent?(0,r.L)(new Error("Should never be called")):this._parent._getAggregatePagesDataSourceDefinition(e,t,i,s,n,a,o)}_getAgregagtePhysicalPage(e,t,i){return null===this._parent?(0,r.L)(new Error("Should never be called")):this._parent._getAgregagtePhysicalPage(e,t,i)}databaseType(){if(this._databaseType===s.a3.NotEvaluated){if(null!==c.applicationCache){const e=c.applicationCache.getDatabaseType(this._cacheableFeatureSetSourceKey());if(null!==e)return e}if(null!==this._databaseTypeProbed)return this._databaseTypeProbed;const e=[{thetype:s.a3.SqlServer,testwhere:"(CAST( '2015-01-01' as DATETIME) = CAST( '2015-01-01' as DATETIME)) AND OBJECTID<0"},{thetype:s.a3.Oracle,testwhere:"(TO_DATE('2003-11-18','YYYY-MM-DD') = TO_DATE('2003-11-18','YYYY-MM-DD')) AND OBJECTID<0"},{thetype:s.a3.StandardisedNoInterval,testwhere:"(date '2015-01-01 10:10:10' = date '2015-01-01 10:10:10') AND OBJECTID<0"}];let t=(0,r.l)(((t,i)=>{this._getDatabaseTypeImpl(e,0).then((e=>{this._databaseType=e,t(this._databaseType)}),(e=>{i(e)}))}));return null!==c.applicationCache&&(c.applicationCache.setDatabaseType(this._cacheableFeatureSetSourceKey(),t),t=t.catch((e=>{throw c.applicationCache.clearDatabaseType(this._cacheableFeatureSetSourceKey()),e}))),this._databaseTypeProbed=t,this._databaseTypeProbed}return(0,r.x)(this._databaseType)}_cacheableFeatureSetSourceKey(){return"MUSTBESET"}_getDatabaseTypeImpl(e,t){return t>=e.length?(0,r.x)(s.a3.StandardisedNoInterval):this._runDatabaseProbe(e[t].testwhere).then((i=>!0===i?e[t].thetype:this._getDatabaseTypeImpl(e,t+1)))}_runDatabaseProbe(e){return null!==this._parent?this._parent._runDatabaseProbe(e):(0,r.L)(new Error("Not Implemented"))}isTable(){return this._parent.isTable()}_featureFromCache(e){if(void 0!==this._featureCache[e])return this._featureCache[e]}_isInFeatureSet(e){return s.a1.Unknown}_getSet(e){throw new Error("Not implemented in abstract class")}_getFeature(e,t,i){try{return this._checkCancelled(i),void 0!==this._featureFromCache(t)?(0,r.x)(this._featureFromCache(t)):this._getFeatures(e,t,this._maxProcessingRate(),i).then((()=>(this._checkCancelled(i),void 0!==this._featureFromCache(t)?this._featureFromCache(t):(0,r.L)(new Error("Feature Not Found")))))}catch(e){return(0,r.L)(e)}}_getFeatureBatch(e,t){try{this._checkCancelled(t);const i=new u([],e,!1,null),r=[];return this._getFeatures(i,-1,e.length,t).then((()=>{this._checkCancelled(t);for(const t of e)void 0!==this._featureFromCache(t)&&r.push(this._featureFromCache(t));return r}))}catch(e){return(0,r.L)(e)}}_getFeatures(e,t,i,s){return(0,r.x)("success")}_getFilteredSet(e,t,i,r,s){throw new Error("Not implemented in abstract class")}_refineSetBlock(e,t,i){try{if(!0===this._checkIfNeedToExpandCandidatePage(e,this._maxQueryRate()))return this._expandPagedSet(e,this._maxQueryRate(),0,0,i).then((()=>this._refineSetBlock(e,t,i)));this._checkCancelled(i);const s=e._candidates.length;this._refineKnowns(e,t);let n=s-e._candidates.length;return 0===e._candidates.length||n>=t?(0,r.x)(e):this._refineIfParentKnown(e,t-n,i).then((()=>{if(this._checkCancelled(i),this._refineKnowns(e,t-n),n=s-e._candidates.length,n<t&&e._candidates.length>0){const r=t-n,s=this._prepareFetchAndRefineSet(e._candidates);return this._fetchAndRefineFeatures(s,s.length>r?r:e._candidates.length,i).then((()=>(this._checkCancelled(i),this._refineKnowns(e,t-n),e)))}return e}))}catch(e){return(0,r.L)(e)}}_fetchAndRefineFeatures(e,t,i){return null}_prepareFetchAndRefineSet(e){const t=[];for(let i=0;i<e.length;i++)this._isPhysicalFeature(e[i])&&t.push(e[i]);return t}_isPhysicalFeature(e){return null===this._parent||this._parent._isPhysicalFeature(e)}_refineKnowns(e,t){let i=0,r=null;const n=[];t=this._maxQueryRate();for(let a=0;a<e._candidates.length&&"GETPAGES"!==e._candidates[a];a++){let o=!1;const l=this._candidateIdTransform(e._candidates[a]);l!==e._candidates[a]&&(o=!0);const h=this._isInFeatureSet(l);if(h===s.a1.InFeatureSet)!0===o?e._known.indexOf(l)<0&&(e._known.push(l),i+=1):(e._known.push(e._candidates[a]),i+=1),null===r?r={start:a,end:a}:r.end===a-1?r.end=a:(n.push(r),r={start:a,end:a});else if(h===s.a1.NotInFeatureSet)null===r?r={start:a,end:a}:r.end===a-1?r.end=a:(n.push(r),r={start:a,end:a}),i+=1;else if(h===s.a1.Unknown&&(i+=1,!0===e._ordered))break;if(i>=t)break}null!==r&&n.push(r);for(let t=n.length-1;t>=0;t--)e._candidates.splice(n[t].start,n[t].end-n[t].start+1)}_refineIfParentKnown(e,t,i){const r=new u([],[],e._ordered,null);return r._candidates=e._candidates.slice(0),this._parent._refineSetBlock(r,t,i)}_candidateIdTransform(e){return this._parent._candidateIdTransform(e)}_checkIfNeedToExpandKnownPage(e,t){if(null===e.pagesDefinition)return!1;let i=0;for(let r=e._lastFetchedIndex;r<e._known.length;r++){if("GETPAGES"===e._known[r])return!0;if(void 0===this._featureCache[e._known[r]]&&(i+=1,i>=t))break}return!1}_checkIfNeedToExpandCandidatePage(e,t){if(null===e.pagesDefinition)return!1;let i=0;for(let r=0;r<e._candidates.length;r++){if("GETPAGES"===e._candidates[r])return!0;if(i+=1,i>=t)break}return!1}_expandPagedSet(e,t,i,s,n){return null===this._parent?(0,r.L)(new Error("Parent Paging not implemented")):this._parent._expandPagedSet(e,t,i,s,n)}_expandPagedSetFeatureSet(e,t,i,s,n){return e._known.length>0&&"GETPAGES"===e._known[e._known.length-1]&&(s=1),0===s&&e._candidates.length>0&&"GETPAGES"===e._candidates[e._candidates.length-1]&&(s=2),0===s?(0,r.x)("finished"):this._getPage(e,s,n).then((r=>i+r<t?this._expandPagedSet(e,t,i+r,0,n):"success"))}_getPage(e,t,i){const s=1===t?e._known:e._candidates;if(e.pagesDefinition.internal.set.length>e.pagesDefinition.resultOffset||!0===e.pagesDefinition.internal.fullyResolved){s.length=s.length-1;let t=0;for(let i=0;i<e.pagesDefinition.resultRecordCount&&!(e.pagesDefinition.resultOffset+i>=e.pagesDefinition.internal.set.length);i++)s[s.length]=e.pagesDefinition.internal.set[e.pagesDefinition.resultOffset+i],t++;e.pagesDefinition.resultOffset+=t;let i=!1;return!0===e.pagesDefinition.internal.fullyResolved&&e.pagesDefinition.internal.set.length<=e.pagesDefinition.resultOffset&&(i=!0),!1===i&&s.push("GETPAGES"),(0,r.x)(t)}return this._getPhysicalPage(e,t,i).then((()=>this._getPage(e,t,i)))}_getPhysicalPage(e,t,i){return null}_clonePageDefinition(e){return null===this._parent?null:this._parent._clonePageDefinition(e)}_first(e){return this.iterator(e).next()}first(e){return this._first(e)}calculateStatistic(e,t,i,r){return this._ensureLoaded().then((()=>this._stat(e,t,"",null,null,i,r).then((s=>!1===s.calculated?this._manualStat(e,t,i,r).then((e=>e.result)):s.result))))}_manualStat(e,t,i,s){switch(e.toLowerCase()){case"count":return function(e,t){try{return e.iterator(t).count()}catch(e){return(0,r.L)(e)}}(this,s).then((e=>({calculated:!0,result:e})));case"distinct":return k(this,t,i).then((e=>({calculated:!0,result:e})));case"avg":case"mean":return function(e,t,i){let r="";return!1===C(t)&&(r=v(t,e.fields,null)),N(e,t,i,!0).then((e=>{if(0===e.length)return null;const t=F(e);return null===t?t:"integer"===r?function(e){return e=+e,isFinite(e)?e-e%1||(e<0?-0:0===e?e:0):e}(t):t}))}(this,t,s).then((e=>({calculated:!0,result:e})));case"stdev":return function(e,t,i){return N(e,t,i,!0).then((e=>0===e.length?null:Math.sqrt(R(e))))}(this,t,s).then((e=>({calculated:!0,result:e})));case"variance":return function(e,t,i){return N(e,t,i,!0).then((e=>0===e.length?null:R(e)))}(this,t,s).then((e=>({calculated:!0,result:e})));case"sum":return function(e,t,i){return N(e,t,i,!0).then((e=>0===e.length?null:P(e)))}(this,t,s).then((e=>({calculated:!0,result:e})));case"min":return function(e,t,i){return N(e,t,i,!0).then((e=>0===e.length?null:Math.min.apply(Math,e)))}(this,t,s).then((e=>({calculated:!0,result:e})));case"max":return function(e,t,i){return N(e,t,i,!0).then((e=>0===e.length?null:Math.max.apply(Math,e)))}(this,t,s).then((e=>({calculated:!0,result:e})));default:return(0,r.x)({calculated:!0,result:0})}}_stat(e,t,i,r,s,n,a){return this._parent._stat(e,t,i,r,s,n,a).then((o=>!1===o.calculated?null===s&&""===i&&null===r?this._manualStat(e,t,n,a):{calculated:!1}:o))}_unionAllGeomSelf(e){const t=this.iterator(this._defaultTracker(e)),i=[];return(0,r.l)(((e,r)=>{this._unionShapeInBatches(i,t,e,r)}))}_unionAllGeom(e){return(0,r.l)(((t,i)=>{const r=this.iterator(this._defaultTracker(e));this._unionShapeInBatches([],r,t,i)}))}_unionShapeInBatches(e,t,i,r){t.next().then((s=>{try{null!==s&&null!==s.geometry&&e.push(s.geometry),e.length>30||null===s&&e.length>1?(0,a.k)(e).then((n=>{try{null===s?i(n):(e=[n],this._unionShapeInBatches(e,t,i,r))}catch(e){r(e)}}),r):null===s?1===e.length?i(e[0]):i(null):this._unionShapeInBatches(e,t,i,r)}catch(e){r(e)}}),r)}iterator(e){return new h(this,e)}intersection(e,t=!1){return U._featuresetFunctions.intersection.bind(this)(e,t)}difference(e,t=!1,i=!0){return U._featuresetFunctions.difference.bind(this)(e,t,i)}symmetricDifference(e,t=!1,i=!0){return U._featuresetFunctions.symmetricDifference.bind(this)(e,t,i)}morphShape(e,t,i="unknown",r=null){return U._featuresetFunctions.morphShape.bind(this)(e,t,i,r)}morphShapeAndAttributes(e,t,i="unknown"){return U._featuresetFunctions.morphShapeAndAttributes.bind(this)(e,t,i)}union(e,t=!1){return U._featuresetFunctions.union.bind(this)(e,t)}intersects(e){return U._featuresetFunctions.intersects.bind(this)(e)}envelopeIntersects(e){return U._featuresetFunctions.envelopeIntersects.bind(this)(e)}contains(e){return U._featuresetFunctions.contains.bind(this)(e)}overlaps(e){return U._featuresetFunctions.overlaps.bind(this)(e)}relate(e,t){return U._featuresetFunctions.relate.bind(this)(e,t)}within(e){return U._featuresetFunctions.within.bind(this)(e)}touches(e){return U._featuresetFunctions.touches.bind(this)(e)}top(e){return U._featuresetFunctions.top.bind(this)(e)}crosses(e){return U._featuresetFunctions.crosses.bind(this)(e)}buffer(e,t,i,r=!0){return U._featuresetFunctions.buffer.bind(this)(e,t,i,r)}filter(e,t=null){return U._featuresetFunctions.filter.bind(this)(e,t)}orderBy(e){return U._featuresetFunctions.orderBy.bind(this)(e)}dissolve(e,t){return U._featuresetFunctions.dissolve.bind(this)(e,t)}groupby(e,t){return U._featuresetFunctions.groupby.bind(this)(e,t)}reduce(e,t=null,i){return(0,r.l)(((r,s)=>{this._reduceImpl(this.iterator(this._defaultTracker(i)),e,t,0,r,s,0)}))}_reduceImpl(e,t,i,s,n,a,o){try{if(++o>1e3)return void setTimeout((()=>{o=0,this._reduceImpl(e,t,i,s,n,a,o)}));e.next().then((l=>{try{if(null===l)n(i);else{const h=t(i,l,s,this);(0,r.U)(h)?h.then((i=>{this._reduceImpl(e,t,i,s+1,n,a,o)}),a):this._reduceImpl(e,t,h,s+1,n,a,o)}}catch(e){a(e)}}),a)}catch(e){a(e)}}removeField(e){return U._featuresetFunctions.removeField.bind(this)(e)}addField(e,t,i=null){return U._featuresetFunctions.addField.bind(this)(e,t,i)}sumArea(e,t=!1,i){const r=(0,s.ac)(e);return this.reduce(((e,i)=>null===i.geometry?0:t?(0,a.K)(i.geometry,r).then((t=>e+t)):(0,a.W)(i.geometry,r).then((t=>e+t))),0,i)}sumLength(e,t=!1,i){const r=(0,s.ad)(e);return this.reduce(((e,i)=>null===i.geometry?0:t?(0,a.M)(i.geometry,r).then((t=>e+t)):(0,a.F)(i.geometry,r).then((t=>e+t))),0,i)}_substituteVars(e,t){if(null!==t){const i={};for(const e in t)i[e.toLowerCase()]=t[e];e.parameters=i}}distinct(e,t=1e3,i=null,r){return this.load().then((()=>{const s=n.WhereClause.create(e,this.getFieldsIndex());return this._substituteVars(s,i),this.calculateStatistic("distinct",s,t,this._defaultTracker(r))}))}min(e,t=null,i){return this.load().then((()=>{const r=n.WhereClause.create(e,this.getFieldsIndex());return this._substituteVars(r,t),this.calculateStatistic("min",r,-1,this._defaultTracker(i))}))}max(e,t=null,i){return this.load().then((()=>{const r=n.WhereClause.create(e,this.getFieldsIndex());return this._substituteVars(r,t),this.calculateStatistic("max",r,-1,this._defaultTracker(i))}))}avg(e,t=null,i){return this.load().then((()=>{const r=n.WhereClause.create(e,this.getFieldsIndex());return this._substituteVars(r,t),this.calculateStatistic("avg",r,-1,this._defaultTracker(i))}))}sum(e,t=null,i){return this.load().then((()=>{const r=n.WhereClause.create(e,this.getFieldsIndex());return this._substituteVars(r,t),this.calculateStatistic("sum",r,-1,this._defaultTracker(i))}))}stdev(e,t=null,i){return this.load().then((()=>{const r=n.WhereClause.create(e,this.getFieldsIndex());return this._substituteVars(r,t),this.calculateStatistic("stdev",r,-1,this._defaultTracker(i))}))}variance(e,t=null,i){return this.load().then((()=>{const r=n.WhereClause.create(e,this.getFieldsIndex());return this._substituteVars(r,t),this.calculateStatistic("variance",r,-1,this._defaultTracker(i))}))}count(e){return this.load().then((()=>this.calculateStatistic("count",n.WhereClause.create("1",this.getFieldsIndex()),-1,this._defaultTracker(e))))}_defaultTracker(e){return e||{aborted:!1}}forEach(e,t){return(0,r.l)(((i,r)=>{this._forEachImpl(this.iterator(this._defaultTracker(t)),e,this,i,r,0)}))}_forEachImpl(e,t,i,s,n,a){try{if(++a>1e3)return void setTimeout((()=>{a=0,this._forEachImpl(e,t,i,s,n,a)}),0);e.next().then((o=>{try{if(null===o)s(i);else{const l=t(o);null==l?this._forEachImpl(e,t,i,s,n,a):(0,r.U)(l)?l.then((()=>{try{this._forEachImpl(e,t,i,s,n,a)}catch(e){n(e)}}),n):this._forEachImpl(e,t,i,s,n,a)}}catch(e){n(e)}}),n)}catch(e){n(e)}}convertToJSON(e){const t={layerDefinition:{geometryType:this.geometryType,fields:[]},featureSet:{features:[],geometryType:this.geometryType}};for(let e=0;e<this.fields.length;e++)t.layerDefinition.fields.push((0,s.ae)(this.fields[e]));return this.reduce(((e,i)=>{const r={geometry:i.geometry&&i.geometry.toJSON(),attributes:{}};for(const e in i.attributes)r.attributes[e]=i.attributes[e];return t.featureSet.features.push(r),1}),0,e).then((()=>t))}castToText(){return"object, FeatureSet"}queryAttachments(e,t,i,r){return this._parent.queryAttachments(e,t,i,r)}serviceUrl(){return this._parent.serviceUrl()}subtypes(){return this.typeIdField?{subtypeField:this.typeIdField,subtypes:this.types?this.types.map((e=>({name:e.name,code:e.id}))):[]}:null}relationshipMetaData(){return this._parent.relationshipMetaData()}get gdbVersion(){return this._parent?this._parent.gdbVersion:""}schema(){const e=[];for(const t of this.fields)e.push((0,s.ae)(t));return{objectIdField:this.objectIdField,globalIdField:this.globalIdField,geometryType:void 0===s.af[this.geometryType]?"":s.af[this.geometryType],fields:e}}convertToText(e,t){return"schema"===e?this._ensureLoaded().then((()=>JSON.stringify(this.schema()))):"featureset"===e?this._ensureLoaded().then((()=>{const e=[];return this.reduce(((t,i)=>{const r={geometry:i.geometry?i.geometry.toJSON():null,attributes:i.attributes};return null!==r.geometry&&r.geometry.spatialReference&&delete r.geometry.spatialReference,e.push(r),1}),0,t).then((()=>{const t=this.schema();return t.features=e,t.spatialReference=this.spatialReference.toJSON(),JSON.stringify(t)}))})):(0,r.x)(this.castToText())}getFeatureByObjectId(e,t){return this._parent.getFeatureByObjectId(e,t)}getOwningSystemUrl(){return this._parent.getOwningSystemUrl()}getIdentityUser(){return this._parent.getIdentityUser()}}U._featuresetFunctions={};class G extends U{constructor(e){super(e),this.declaredClass="esri.layers.featureset.sources.Empty",this._maxProcessing=1e3,this._wset=new u([],[],!1,null),this._parent=e.parentfeatureset,this._databaseType=s.a3.Standardised}_getSet(){return(0,r.x)(this._wset)}optimisePagingFeatureQueries(){}_isInFeatureSet(){return s.a1.NotInFeatureSet}_getFeature(){return(0,r.L)(new Error("No Feature Found in EmptySet"))}queryAttachments(){return(0,r.x)([])}_getFeatures(){return(0,r.x)("success")}_featureFromCache(){return null}_fetchAndRefineFeatures(){return(0,r.L)(new Error("Fetch and Refine should not be called in this featureset"))}_getFilteredSet(){return(0,r.x)(new u([],[],!1,null))}_stat(e,t,i,r,s,n,a){return this._manualStat(e,t,n,a)}_canDoAggregates(){return(0,r.x)(!1)}}class z extends U{constructor(e){super(e),this._relation="",this._relationGeom=null,this._relationString="",this.declaredClass="esri.arcade.featureset.actions.SpatialFilter",this._relationString=e.relationString,this._parent=e.parentfeatureset,this._maxProcessing=40,this._relation=e.relation,this._relationGeom=e.relationGeom}_getSet(e){return null===this._wset?this._ensureLoaded().then((()=>this._parent._getFilteredSet("esriSpatialRelRelation"!==this._relation?this._relation:this._relation+":"+this._relationString,this._relationGeom,null,null,e))).then((t=>(this._checkCancelled(e),this._wset=new u(t._candidates.slice(0),t._known.slice(0),t._ordered,this._clonePageDefinition(t.pagesDefinition)),this._wset))):(0,r.x)(this._wset)}_isInFeatureSet(e){let t=this._parent._isInFeatureSet(e);return t===s.a1.NotInFeatureSet?t:(t=this._idstates[e],void 0===t?s.a1.Unknown:t)}_getFeature(e,t,i){return this._parent._getFeature(e,t,i)}_getFeatures(e,t,i,r){return this._parent._getFeatures(e,t,i,r)}_featureFromCache(e){return this._parent._featureFromCache(e)}executeSpatialRelationTest(e){if(null===e.geometry)return(0,r.x)(!1);switch(this._relation){case"esriSpatialRelEnvelopeIntersects":{const t=(0,s.ag)(this._relationGeom),i=(0,s.ag)(e.geometry);return(0,a.g)(t,i)}case"esriSpatialRelIntersects":return(0,a.g)(this._relationGeom,e.geometry);case"esriSpatialRelContains":return(0,a.p)(this._relationGeom,e.geometry);case"esriSpatialRelOverlaps":return(0,a.O)(this._relationGeom,e.geometry);case"esriSpatialRelWithin":return(0,a.x)(this._relationGeom,e.geometry);case"esriSpatialRelTouches":return(0,a.A)(this._relationGeom,e.geometry);case"esriSpatialRelCrosses":return(0,a.w)(this._relationGeom,e.geometry);case"esriSpatialRelRelation":return(0,a.h)(this._relationGeom,e.geometry,this._relationString)}}_fetchAndRefineFeatures(e,t,i){const n=new u([],e,!1,null),a=Math.min(t,e.length);return this._parent._getFeatures(n,-1,a,i).then((()=>{this._checkCancelled(i);const t=[];for(let i=0;i<a;i++){const r=this._parent._featureFromCache(e[i]);t.push(this.executeSpatialRelationTest(r))}return(0,r.c)(t)})).then((i=>{for(let r=0;r<t;r++)!0===i[r]?this._idstates[e[r]]=s.a1.InFeatureSet:this._idstates[e[r]]=s.a1.NotInFeatureSet;return"success"}))}_getFilteredSet(e,t,i,r,s){return this._ensureLoaded().then((()=>this._parent._getFilteredSet("esriSpatialRelRelation"!==this._relation?this._relation:this._relation+":"+this._relationString,this._relationGeom,i,r,s))).then((e=>{let i;return this._checkCancelled(s),i=null!==t?new u(e._candidates.slice(0).concat(e._known.slice(0)),[],e._ordered,this._clonePageDefinition(e.pagesDefinition)):new u(e._candidates.slice(0),e._known.slice(0),e._ordered,this._clonePageDefinition(e.pagesDefinition)),i}))}_stat(e,t,i,s,n,a,o){return""!==i?(0,r.x)({calculated:!1}):this._parent._stat(e,t,"esriSpatialRelRelation"!==this._relation?this._relation:this._relation+":"+this._relationString,this._relationGeom,n,a,o).then((r=>!1===r.calculated?null===n&&""===i&&null===s?this._manualStat(e,t,a,o):{calculated:!1}:r))}_canDoAggregates(e,t,i,s,n){return""!==i||null!==s||null===this._parent?(0,r.x)(!1):this._parent._canDoAggregates(e,t,"esriSpatialRelRelation"!==this._relation?this._relation:this._relation+":"+this._relationString,this._relationGeom,n)}_getAggregatePagesDataSourceDefinition(e,t,i,s,n,a,o){return null===this._parent?(0,r.L)(new Error("Should never be called")):this._parent._getAggregatePagesDataSourceDefinition(e,t,"esriSpatialRelRelation"!==this._relation?this._relation:this._relation+":"+this._relationString,this._relationGeom,n,a,o)}static registerAction(){U._featuresetFunctions.intersects=function(e){return null==e?new G({parentfeatureset:this}):new z({parentfeatureset:this,relation:"esriSpatialRelIntersects",relationGeom:e})},U._featuresetFunctions.envelopeIntersects=function(e){return null==e?new G({parentfeatureset:this}):new z({parentfeatureset:this,relation:"esriSpatialRelEnvelopeIntersects",relationGeom:e})},U._featuresetFunctions.contains=function(e){return null==e?new G({parentfeatureset:this}):new z({parentfeatureset:this,relation:"esriSpatialRelContains",relationGeom:e})},U._featuresetFunctions.overlaps=function(e){return null==e?new G({parentfeatureset:this}):new z({parentfeatureset:this,relation:"esriSpatialRelOverlaps",relationGeom:e})},U._featuresetFunctions.within=function(e){return null==e?new G({parentfeatureset:this}):new z({parentfeatureset:this,relation:"esriSpatialRelWithin",relationGeom:e})},U._featuresetFunctions.touches=function(e){return null==e?new G({parentfeatureset:this}):new z({parentfeatureset:this,relation:"esriSpatialRelTouches",relationGeom:e})},U._featuresetFunctions.crosses=function(e){return null==e?new G({parentfeatureset:this}):new z({parentfeatureset:this,relation:"esriSpatialRelCrosses",relationGeom:e})},U._featuresetFunctions.relate=function(e,t){return null==e?new G({parentfeatureset:this}):new z({parentfeatureset:this,relation:"esriSpatialRelRelation",relationGeom:e,relationString:t})}}}},82030:(e,t,i)=>{"use strict";i.d(t,{P:()=>m,a:()=>f,b:()=>_,c:()=>Ve,d:()=>ke,e:()=>g,f:()=>d,g:()=>Ue,h:()=>y,n:()=>l,r:()=>u,t:()=>h}),i(33807);var r=i(80219),s=i(17762),n=i(62295),a=i(34534),o=i(43356);const l=Number.POSITIVE_INFINITY,h=Math.PI,u=2*h,c=128/h,d=h/180,p=1/Math.LN2;function f(e,t){return(e%=t)>=0?e:e+t}function y(e){return f(e*c,256)}function m(e){return Math.log(e)*p}function g(e,t,i){return e*(1-i)+t*i}class _{constructor(e){this._array=[],e<=0&&console.error("strideInBytes must be positive!"),this._stride=e}get array(){return this._array}get index(){return 4*this._array.length/this._stride}get itemSize(){return this._stride}get sizeInBytes(){return 4*this._array.length}reset(){this.array.length=0}toBuffer(){return new Uint32Array(this._array).buffer}static i1616to32(e,t){return 65535&e|t<<16}static i8888to32(e,t,i,r){return 255&e|(255&t)<<8|(255&i)<<16|r<<24}static i8816to32(e,t,i){return 255&e|(255&t)<<8|i<<16}}class x{constructor(e){this._locations=new Map,this._key=e}get key(){return this._key}get type(){return 7&this._key}defines(){return[]}getStride(){return this._layoutInfo||this._buildAttributesInfo(),this._stride}getAttributeLocations(){return 0===this._locations.size&&this._buildAttributesInfo(),this._locations}getLayoutInfo(){return this._layoutInfo||this._buildAttributesInfo(),this._layoutInfo}getEncodingInfos(){return this._propertyEncodingInfo||this._buildAttributesInfo(),this._propertyEncodingInfo}getUniforms(){return this._uniforms||this._buildAttributesInfo(),this._uniforms}getShaderHeader(){return this._shaderHeader||this._buildAttributesInfo(),this._shaderHeader}getShaderMain(){return this._shaderMain||this._buildAttributesInfo(),this._shaderMain}setDataUniforms(e,t,i,r,s){const n=this.getUniforms();for(const a of n){const{name:n,type:o,getValue:l}=a,h=l(i,t,r,s);if(null!==h)switch(o){case"float":e.setUniform1f(n,h);break;case"vec2":e.setUniform2fv(n,h);break;case"vec4":e.setUniform4fv(n,h)}}}encodeAttributes(e,t,i,r){const s=this.attributesInfo(),n=this.getEncodingInfos(),a=[];let o=0,l=0;for(const u of Object.keys(n)){var h;const c=n[u],{type:d,precisionFactor:p,isLayout:f}=s[u],y=f?i.getLayoutProperty(u):i.getPaintProperty(u),m=null==(h=y.interpolator)?void 0:h.getInterpolationRange(t);let g=0;for(const i of c){const{offset:s,bufferElementsToAdd:n}=i;if(n>0){for(let e=0;e<n;e++)a.push(0);o+=l,l=i.bufferElementsToAdd}const h=null!=r?r:y.getValue(m?m[g]:t,e);switch(d){case 0:case 1:a[o]|=this._encodeByte(h*(p||1),8*s);break;case 2:case 3:a[o]|=this._encodeShort(h*(p||1),8*s);break;case 4:case 5:a[o]|=this._encodeByte(h*(p||1),8*s),a[o]|=this._encodeByte(h*(p||1),8*s+8);break;case 6:case 7:a[o]|=this._encodeShort(h*(p||1),8*s),a[o]|=this._encodeShort(h*(p||1),8*s+16);break;case 8:case 9:a[o]|=this._encodeByte(h*(p||1),8*s),a[o]|=this._encodeByte(h*(p||1),8*s+8),a[o]|=this._encodeByte(h*(p||1),8*s+16),a[o]|=this._encodeByte(h*(p||1),8*s+24);break;case 10:a[o]=this._encodeColor(h);break;case 11:case 12:this._encodePattern(o,a,h);break;default:throw new Error("Unsupported encoding type")}g++}}return a}getAtributeState(e){let t=0;const i=3+2*e;return t|=this._bit(i),t|=this._bit(i+1)<<1,t}_buildAttributesInfo(){const e=[],t={},i={};let r=-1;const s=this.attributesInfo(),n=this.attributes();let a=-1;for(const o of n){a++;const n=this.getAtributeState(a);if(0===n||3===n)continue;const l=s[o],h=[];t[o]=h;const u=l.type;for(let t=0;t<n;t++){const{dataType:t,bytesPerElement:s,count:n,normalized:a}=x._encodingInfo[u],o=s*n;let l=i[t],c=0;if(!l||l.count+n>4)r++,l={dataIndex:r,count:0,offset:0},4!==n&&(i[t]=l),e.push({location:-1,name:"a_data_"+r,count:n,type:t,normalized:a}),c=Math.ceil(Math.max(o/4,1));else{const t=e[l.dataIndex];t.count+=n,c=Math.ceil(Math.max(t.count*s/4,1))-Math.ceil(Math.max(l.offset/4,1))}h.push({dataIndex:l.dataIndex,offset:l.offset,bufferElementsToAdd:c}),l.offset+=o,l.count+=n}}for(const t of e)switch(t.type){case 5120:case 5121:t.count=4;case 5122:case 5123:t.count+=t.count%2}this._buildVertexBufferLayout(e);let o=0;const l=this._layoutInfo.geometry;for(const e of l)this._locations.set(e.name,o++);const h=this._layoutInfo.opacity;if(h)for(const e of h)this._locations.set(e.name,o++);this._buildShaderInfo(e,t),this._propertyEncodingInfo=t}_buildVertexBufferLayout(e){const t={},i=this.geometryInfo();let r=i[0].stride;if(0===e.length)t.geometry=i;else{const s=[];let n=r;for(const t of e)r+=v(t.type)*t.count;for(const e of i){const t={...e};t.stride=r,s.push(t)}for(const t of e)s.push({name:t.name,count:t.count,type:t.type,offset:n,stride:r,normalized:t.normalized||!1,divisor:0}),n+=v(t.type)*t.count;t.geometry=s}this.opacityInfo()&&(t.opacity=this.opacityInfo()),this._layoutInfo=t,this._stride=r}_buildShaderInfo(e,t){let i="\n",s="\n";const n=[];for(const t of e)i+=`attribute ${this._getType(t.count)} ${t.name};\n`;const a=this.attributes(),o=this.attributesInfo();let l=-1;for(const e of a){l++;const{name:a,type:h,precisionFactor:u,isLayout:c}=o[e],d=u&&1!==u?" * "+1/u:"",{bytesPerElement:p,count:f}=x._encodingInfo[h],y=e=>`a_data_${e.dataIndex}${b(f,e.offset,p)}`;switch(this.getAtributeState(l)){case 0:{const t=this._getType(f),o=`u_${a}`;n.push({name:o,type:t,getValue:(t,i,s,n)=>{const a=c?t.getLayoutValue(e,i):t.getPaintValue(e,i);if(11===h){const e=t.getDashKey(a,t.getLayoutValue("line-cap",i)),s=n.getMosaicItemPosition(e,!1);if((0,r.t)(s))return null;const{tl:o,br:l}=s;return[o[0],l[1],l[0],o[1]]}if(12===h){const t=n.getMosaicItemPosition(a,-1===e.indexOf("line-"));if((0,r.t)(t))return null;const{tl:i,br:s}=t;return[i[0],s[1],s[0],i[1]]}if(10===h){const e=a[3];return[e*a[0],e*a[1],e*a[2],e]}return a}}),i+=`uniform ${t} ${o};\n`,s+=`${t} ${a} = ${o};\n`}break;case 1:{const i=y(t[e][0]);s+=`${this._getType(f)} ${a} = ${i}${d};\n`}break;case 2:{const r=`u_t_${a}`;n.push({name:r,type:"float",getValue:(t,i,r,s)=>(c?t.getLayoutProperty(e):t.getPaintProperty(e)).interpolator.interpolationUniformValue(r,i)}),i+=`uniform float ${r};\n`;const o=y(t[e][0]),l=y(t[e][1]);s+=`${this._getType(f)} ${a} = mix(${o}${d}, ${l}${d}, ${r});\n`}}}this._shaderHeader=i,this._shaderMain=s,this._uniforms=n}_bit(e){return(this._key&1<<e)>>e}_getType(e){switch(e){case 1:return"float";case 2:return"vec2";case 3:return"vec3";case 4:return"vec4"}throw new Error("Invalid count")}_encodeColor(e){const t=255*e[3];return _.i8888to32(e[0]*t,e[1]*t,e[2]*t,t)}_encodePattern(e,t,i){if(!i||!i.rect)return;const r=i.rect,s=i.width,n=i.height;t[e]=this._encodeShort(r.x+2,0),t[e]|=this._encodeShort(r.y+2+n,16),t[e+1]=this._encodeShort(r.x+2+s,0),t[e+1]|=this._encodeShort(r.y+2,16)}_encodeByte(e,t){return(255&e)<<t}_encodeShort(e,t){return(65535&e)<<t}}x._encodingInfo={0:{dataType:5120,bytesPerElement:1,count:1,normalized:!1},1:{dataType:5121,bytesPerElement:1,count:1,normalized:!1},2:{dataType:5122,bytesPerElement:2,count:1,normalized:!1},3:{dataType:5123,bytesPerElement:2,count:1,normalized:!1},4:{dataType:5120,bytesPerElement:1,count:2,normalized:!1},5:{dataType:5121,bytesPerElement:1,count:2,normalized:!1},6:{dataType:5122,bytesPerElement:2,count:2,normalized:!1},7:{dataType:5123,bytesPerElement:2,count:2,normalized:!1},8:{dataType:5120,bytesPerElement:1,count:4,normalized:!1},9:{dataType:5121,bytesPerElement:1,count:4,normalized:!1},10:{dataType:5121,bytesPerElement:1,count:4,normalized:!0},11:{dataType:5123,bytesPerElement:2,count:4,normalized:!1},12:{dataType:5123,bytesPerElement:2,count:4,normalized:!1}};const v=e=>{switch(e){case 5126:case 5124:case 5125:return 4;case 5122:case 5123:return 2;case 5120:case 5121:return 1}},b=(e,t,i)=>{const r=t/i;if(1===e)switch(r){case 0:return".x";case 1:return".y";case 2:return".z";case 3:return".w"}else if(2===e)switch(r){case 0:return".xy";case 1:return".yz";case 2:return".zw"}else if(3===e)switch(r){case 0:return".xyz";case 1:return".yzw"}return""};class w extends x{constructor(e){super(e)}geometryInfo(){return w.GEOMETRY_LAYOUT}opacityInfo(){return null}attributes(){return w.ATTRIBUTES}attributesInfo(){return w.ATTRIBUTES_INFO}}w.ATTRIBUTES=[],w.GEOMETRY_LAYOUT=[{name:"a_pos",count:2,type:5120,offset:0,stride:2,normalized:!1,divisor:0}],w.ATTRIBUTES_INFO={};class S extends x{constructor(e){super(e)}geometryInfo(){return S.GEOMETRY_LAYOUT}opacityInfo(){return null}attributes(){return S.ATTRIBUTES}attributesInfo(){return S.ATTRIBUTES_INFO}}S.ATTRIBUTES=["circle-radius","circle-color","circle-opacity","circle-stroke-width","circle-stroke-color","circle-stroke-opacity","circle-blur"],S.GEOMETRY_LAYOUT=[{name:"a_pos",count:2,type:5122,offset:0,stride:4,normalized:!1,divisor:0}],S.ATTRIBUTES_INFO={"circle-radius":{name:"radius",type:1},"circle-color":{name:"color",type:10},"circle-opacity":{name:"opacity",type:1,precisionFactor:100},"circle-stroke-width":{name:"stroke_width",type:1,precisionFactor:4},"circle-stroke-color":{name:"stroke_color",type:10},"circle-stroke-opacity":{name:"stroke_opacity",type:1,precisionFactor:100},"circle-blur":{name:"blur",type:1,precisionFactor:32}};class I extends x{constructor(e){super(e)}geometryInfo(){return I.GEOMETRY_LAYOUT}opacityInfo(){return null}attributes(){return I.ATTRIBUTES}attributesInfo(){return I.ATTRIBUTES_INFO}}I.ATTRIBUTES=["fill-color","fill-opacity","fill-pattern"],I.GEOMETRY_LAYOUT=[{name:"a_pos",count:2,type:5122,offset:0,stride:4,normalized:!1,divisor:0}],I.ATTRIBUTES_INFO={"fill-color":{name:"color",type:10},"fill-opacity":{name:"opacity",type:1,precisionFactor:100},"fill-pattern":{name:"tlbr",type:12,isOptional:!0}};class C extends x{constructor(e,t){super(e),this.usefillColor=t}geometryInfo(){return C.GEOMETRY_LAYOUT}opacityInfo(){return null}attributes(){return this.usefillColor?C.ATTRIBUTES_FILL:C.ATTRIBUTES_OUTLINE}attributesInfo(){return this.usefillColor?C.ATTRIBUTES_INFO_FILL:C.ATTRIBUTES_INFO_OUTLINE}}C.ATTRIBUTES_OUTLINE=["fill-outline-color","fill-opacity"],C.ATTRIBUTES_FILL=["fill-color","fill-opacity"],C.GEOMETRY_LAYOUT=[{name:"a_pos",count:2,type:5122,offset:0,stride:8,normalized:!1,divisor:0},{name:"a_offset",count:2,type:5120,offset:4,stride:8,normalized:!1,divisor:0},{name:"a_xnormal",count:2,type:5120,offset:6,stride:8,normalized:!1,divisor:0}],C.ATTRIBUTES_INFO_OUTLINE={"fill-outline-color":{name:"color",type:10},"fill-opacity":{name:"opacity",type:1,precisionFactor:100}},C.ATTRIBUTES_INFO_FILL={"fill-color":{name:"color",type:10},"fill-opacity":{name:"opacity",type:1,precisionFactor:100}};class M extends x{constructor(e){super(e)}geometryInfo(){return M.GEOMETRY_LAYOUT}opacityInfo(){return null}attributes(){return M.ATTRIBUTES}attributesInfo(){return M.ATTRIBUTES_INFO}}M.ATTRIBUTES=["line-blur","line-color","line-gap-width","line-offset","line-opacity","line-width","line-pattern","line-dasharray"],M.GEOMETRY_LAYOUT=[{name:"a_pos",count:2,type:5122,offset:0,stride:16,normalized:!1,divisor:0},{name:"a_extrude_offset",count:4,type:5120,offset:4,stride:16,normalized:!1,divisor:0},{name:"a_dir_normal",count:4,type:5120,offset:8,stride:16,normalized:!1,divisor:0},{name:"a_accumulatedDistance",count:2,type:5123,offset:12,stride:16,normalized:!1,divisor:0}],M.ATTRIBUTES_INFO={"line-width":{name:"width",type:1,precisionFactor:2},"line-gap-width":{name:"gap_width",type:1,precisionFactor:2},"line-offset":{name:"offset",type:0,precisionFactor:2},"line-color":{name:"color",type:10},"line-opacity":{name:"opacity",type:1,precisionFactor:100},"line-blur":{name:"blur",type:1,precisionFactor:4},"line-pattern":{name:"tlbr",type:12,isOptional:!0},"line-dasharray":{name:"tlbr",type:11,isOptional:!0}};const T=[{name:"a_pos",count:2,type:5122,offset:0,stride:16,normalized:!1,divisor:0},{name:"a_vertexOffset",count:2,type:5122,offset:4,stride:16,normalized:!1,divisor:0},{name:"a_texAngleRange",count:4,type:5121,offset:8,stride:16,normalized:!1,divisor:0},{name:"a_levelInfo",count:4,type:5121,offset:12,stride:16,normalized:!1,divisor:0}],E=[{name:"a_opacityInfo",count:1,type:5121,offset:0,stride:1,normalized:!1,divisor:0}];class F extends x{constructor(e){super(e)}geometryInfo(){return T}opacityInfo(){return E}attributes(){return F.ATTRIBUTES}attributesInfo(){return F.ATTRIBUTES_INFO}}F.ATTRIBUTES=["icon-color","icon-opacity","icon-halo-blur","icon-halo-color","icon-halo-width","icon-size"],F.ATTRIBUTES_INFO={"icon-color":{name:"color",type:10},"icon-opacity":{name:"opacity",type:1,precisionFactor:100},"icon-halo-color":{name:"halo_color",type:10},"icon-halo-width":{name:"halo_width",type:1,precisionFactor:4},"icon-halo-blur":{name:"halo_blur",type:1,precisionFactor:4},"icon-size":{name:"size",type:1,precisionFactor:32,isLayout:!0}};class A extends x{constructor(e){super(e)}geometryInfo(){return T}opacityInfo(){return E}attributes(){return A.ATTRIBUTES}attributesInfo(){return A.ATTRIBUTES_INFO}}A.ATTRIBUTES=["text-color","text-opacity","text-halo-blur","text-halo-color","text-halo-width","text-size"],A.ATTRIBUTES_INFO={"text-color":{name:"color",type:10},"text-opacity":{name:"opacity",type:1,precisionFactor:100},"text-halo-color":{name:"halo_color",type:10},"text-halo-width":{name:"halo_width",type:1,precisionFactor:4},"text-halo-blur":{name:"halo_blur",type:1,precisionFactor:4},"text-size":{name:"size",type:1,isLayout:!0}};const R={kind:"null"},P={kind:"number"},L={kind:"string"},D={kind:"boolean"},N={kind:"color"},O={kind:"object"},k={kind:"value"};function V(e,t){return{kind:"array",itemType:e,n:t}}const U=[R,P,L,D,N,O,V(k)];function G(e){if("array"===e.kind){const t=G(e.itemType);return"number"==typeof e.n?`array<${t}, ${e.n}>`:"value"===e.itemType.kind?"array":`array<${t}>`}return e.kind}function z(e){if(null===e)return R;if("string"==typeof e)return L;if("boolean"==typeof e)return D;if("number"==typeof e)return P;if(e instanceof s.o)return N;if(Array.isArray(e)){let t;for(const i of e){const e=z(i);if(t){if(t!==e){t=k;break}}else t=e}return V(t||k,e.length)}return"object"==typeof e?O:k}function B(e,t){if("array"===t.kind)return"array"===e.kind&&(0===e.n&&"value"===e.itemType.kind||B(e.itemType,t.itemType))&&("number"!=typeof t.n||t.n===e.n);if("value"===t.kind)for(const t of U)if(B(e,t))return!0;return t.kind===e.kind}function j(e){if(null===e)return"";const t=typeof e;return"string"===t?e:"number"===t||"boolean"===t?String(e):e instanceof s.o?e.toString():JSON.stringify(e)}class q{constructor(e){this.parent=e,this.vars={}}add(e,t){this.vars[e]=t}get(e){return this.vars[e]?this.vars[e]:this.parent?this.parent.get(e):null}}class H{constructor(){this.type=k}static parse(e){if(e.length>1)throw new Error('"id" does not expect arguments');return new H}evaluate(e,t){return null==e?void 0:e.id}}class W{constructor(){this.type=L}static parse(e){if(e.length>1)throw new Error('"geometry-type" does not expect arguments');return new W}evaluate(e,t){if(!e)return null;switch(e.type){case 1:return"Point";case 2:return"LineString";case 3:return"Polygon";default:return null}}}class Q{constructor(){this.type=O}static parse(e){if(e.length>1)throw new Error('"properties" does not expect arguments');return new Q}evaluate(e,t){return null==e?void 0:e.values}}class Z{constructor(){this.type=P}static parse(e){if(e.length>1)throw new Error('"zoom" does not expect arguments');return new Z}evaluate(e,t){return t}}class Y{constructor(e,t,i){this.lhs=e,this.rhs=t,this.compare=i,this.type=D}static parse(e,t,i){if(3!==e.length&&4!==e.length)throw new Error(`"${e[0]}" expects 2 or 3 arguments`);if(4===e.length)throw new Error(`"${e[0]}" collator not supported`);return new Y(Me(e[1],t),Me(e[2],t),i)}evaluate(e,t){return this.compare(this.lhs.evaluate(e,t),this.rhs.evaluate(e,t))}}class J{constructor(e){this.arg=e,this.type=D}static parse(e,t){if(2!==e.length)throw new Error('"!" expects 1 argument');return new J(Me(e[1],t))}evaluate(e,t){return!this.arg.evaluate(e,t)}}class X{constructor(e){this.args=e,this.type=D}static parse(e,t){const i=[];for(let r=1;r<e.length;r++)i.push(Me(e[r],t));return new X(i)}evaluate(e,t){for(const i of this.args)if(!i.evaluate(e,t))return!1;return!0}}class ${constructor(e){this.args=e,this.type=D}static parse(e,t){const i=[];for(let r=1;r<e.length;r++)i.push(Me(e[r],t));return new $(i)}evaluate(e,t){for(const i of this.args)if(i.evaluate(e,t))return!0;return!1}}class K{constructor(e){this.args=e,this.type=D}static parse(e,t){const i=[];for(let r=1;r<e.length;r++)i.push(Me(e[r],t));return new K(i)}evaluate(e,t){for(const i of this.args)if(i.evaluate(e,t))return!1;return!0}}class ee{constructor(e,t,i){this.type=e,this.args=t,this.fallback=i}static parse(e,t,i){if(e.length<4)throw new Error('"case" expects at least 3 arguments');if(e.length%2==1)throw new Error('"case" expects an odd number of arguments');let r;const s=[];for(let n=1;n<e.length-1;n+=2){const a=Me(e[n],t),o=Me(e[n+1],t,i);r||(r=o.type),s.push({condition:a,output:o})}const n=Me(e[e.length-1],t,i);return r||(r=n.type),new ee(r,s,n)}evaluate(e,t){for(const i of this.args)if(i.condition.evaluate(e,t))return i.output.evaluate(e,t);return this.fallback.evaluate(e,t)}}class te{constructor(e,t){this.type=e,this.args=t}static parse(e,t){if(e.length<2)throw new Error('"coalesce" expects at least 1 argument');let i;const r=[];for(let s=1;s<e.length;s++){const n=Me(e[s],t);i||(i=n.type),r.push(n)}return new te(i,r)}evaluate(e,t){for(const i of this.args){const r=i.evaluate(e,t);if(null!==r)return r}return null}}class ie{constructor(e,t,i,r,s){this.type=e,this.input=t,this.labels=i,this.outputs=r,this.fallback=s}static parse(e,t){if(e.length<3)throw new Error('"match" expects at least 3 arguments');if(e.length%2==0)throw new Error('"case" expects an even number of arguments');let i;const r=Me(e[1],t),s=[],n={};let a;for(let r=2;r<e.length-1;r+=2){let o=e[r];Array.isArray(o)||(o=[o]);for(const e of o){const t=typeof e;if("string"!==t&&"number"!==t)throw new Error('"match" requires string or number literal as labels');if(a){if(t!==a)throw new Error('"match" requires labels to have the same type')}else a=t;n[e]=s.length}const l=Me(e[r+1],t);i||(i=l.type),s.push(l)}return new ie(i,r,n,s,Me(e[e.length-1],t))}evaluate(e,t){const i=this.input.evaluate(e,t);return(this.outputs[this.labels[i]]||this.fallback).evaluate(e,t)}}class re{constructor(e,t,i,r,s){this.operator=e,this.type=t,this.interpolation=i,this.input=r,this.stops=s}static parse(e,t,i){const r=e[0];if(e.length<5)throw new Error(`"${r}" expects at least 4 arguments`);const s=e[1];if(!Array.isArray(s)||0===s.length)throw new Error(`"${s}" is not a valid interpolation`);switch(s[0]){case"linear":if(1!==s.length)throw new Error("Linear interpolation cannot have parameters");break;case"exponential":if(2!==s.length||"number"!=typeof s[1])throw new Error("Exponential interpolation requires one numeric argument");break;case"cubic-bezier":if(5!==s.length)throw new Error("Cubic bezier interpolation requires four numeric arguments with values between 0 and 1");for(let e=1;e<5;e++){const t=s[e];if("number"!=typeof t||t<0||t>1)throw new Error("Cubic bezier interpolation requires four numeric arguments with values between 0 and 1")}break;default:throw new Error(`"${e[0]}" unknown interpolation type "${s[0]}"`)}if(e.length%2!=1)throw new Error(`"${r}" expects an even number of arguments`);const n=Me(e[2],t,P);let a;"interpolate-hcl"===r||"interpolate-lab"===r?a=N:i&&"value"!==i.kind&&(a=i);const o=[];for(let i=3;i<e.length;i+=2){const s=e[i];if("number"!=typeof s)throw new Error(`"${r}" requires stop inputs as literal numbers`);if(o.length&&o[o.length-1][0]>=s)throw new Error(`"${r}" requires strictly ascending stop inputs`);const n=Me(e[i+1],t,a);a||(a=n.type),o.push([s,n])}if(a&&a!==N&&a!==P&&("array"!==a.kind||a.itemType!==P))throw new Error(`"${r}" cannot interpolate type ${G(a)}`);return new re(r,a,s,n,o)}evaluate(e,t){const i=this.stops;if(1===i.length)return i[0][1].evaluate(e,t);const r=this.input.evaluate(e,t);if(r<=i[0][0])return i[0][1].evaluate(e,t);if(r>=i[i.length-1][0])return i[i.length-1][1].evaluate(e,t);let a=0;for(;++a<i.length&&!(r<i[a][0]););const o=i[a-1][0],l=i[a][0],h=re.interpolationRatio(this.interpolation,r,o,l),u=i[a-1][1].evaluate(e,t),c=i[a][1].evaluate(e,t);if("interpolate"===this.operator){if("array"===this.type.kind&&Array.isArray(u)&&Array.isArray(c))return u.map(((e,t)=>g(e,c[t],h)));if("color"===this.type.kind&&u instanceof s.o&&c instanceof s.o){const e=new s.o(u),t=new s.o(c);return new s.o([g(e.r,t.r,h),g(e.g,t.g,h),g(e.b,t.b,h),g(e.a,t.a,h)])}if("number"===this.type.kind&&"number"==typeof u&&"number"==typeof c)return g(u,c,h);throw new Error(`"${this.operator}" cannot interpolate type ${G(this.type)}`)}if("interpolate-hcl"===this.operator){const e=(0,n.v)(u),t=(0,n.v)(c),i=t.h-e.h,r=(0,n.p)({h:e.h+h*(i>180||i<-180?i-360*Math.round(i/360):i),c:g(e.c,t.c,h),l:g(e.l,t.l,h)});return new s.o({a:g(u.a,c.a,h),...r})}if("interpolate-lab"===this.operator){const e=(0,n.z)(u),t=(0,n.z)(c),i=(0,n.p)({l:g(e.l,t.l,h),a:g(e.a,t.a,h),b:g(e.b,t.b,h)});return new s.o({a:g(u.a,c.a,h),...i})}throw new Error(`Unexpected operator "${this.operator}"`)}interpolationUniformValue(e,t){const i=this.stops;if(1===i.length)return 0;if(e>=i[i.length-1][0])return 0;let r=0;for(;++r<i.length&&!(e<i[r][0]););const s=i[r-1][0],n=i[r][0];return re.interpolationRatio(this.interpolation,t,s,n)}getInterpolationRange(e){const t=this.stops;if(1===t.length){const e=t[0][0];return[e,e]}const i=t[t.length-1][0];if(e>=i)return[i,i];let r=0;for(;++r<t.length&&!(e<t[r][0]););return[t[r-1][0],t[r][0]]}static interpolationRatio(e,t,i,r){let s=0;return"linear"===e[0]?s=re.exponentialInterpolationRatio(t,1,i,r):"exponential"===e[0]?s=re.exponentialInterpolationRatio(t,e[1],i,r):"cubic-bezier"===e[0]&&(s=(0,a.e)(e[1],e[2],e[3],e[4])(re.exponentialInterpolationRatio(t,1,i,r),1e-5)),s<0?s=0:s>1&&(s=1),s}static exponentialInterpolationRatio(e,t,i,r){const s=r-i;if(0===s)return 0;const n=e-i;return 1===t?n/s:(t**n-1)/(t**s-1)}}class se{constructor(e,t,i){this.type=e,this.input=t,this.stops=i}static parse(e,t){if(e.length<5)throw new Error('"step" expects at least 4 arguments');if(e.length%2!=1)throw new Error('"step" expects an even number of arguments');const i=Me(e[1],t,P);let r;const s=[];s.push([-1/0,Me(e[2],t)]);for(let i=3;i<e.length;i+=2){const n=e[i];if("number"!=typeof n)throw new Error('"step" requires stop inputs as literal numbers');if(s.length&&s[s.length-1][0]>=n)throw new Error('"step" requires strictly ascending stop inputs');const a=Me(e[i+1],t);r||(r=a.type),s.push([n,a])}return new se(r,i,s)}evaluate(e,t){const i=this.stops;if(1===i.length)return i[0][1].evaluate(e,t);const r=this.input.evaluate(e,t);let s=0;for(;++s<i.length&&!(r<i[s][0]););return this.stops[s-1][1].evaluate(e,t)}}class ne{constructor(e,t){this.type=e,this.output=t}static parse(e,t,i){if(e.length<4)throw new Error('"let" expects at least 3 arguments');if(e.length%2==1)throw new Error('"let" expects an odd number of arguments');const r=new q(t);for(let i=1;i<e.length-1;i+=2){const s=e[i];if("string"!=typeof s)throw new Error(`"let" requires a string to define variable names - found ${s}`);r.add(s,Me(e[i+1],t))}const s=Me(e[e.length-1],r,i);return new ne(s.type,s)}evaluate(e,t){return this.output.evaluate(e,t)}}class ae{constructor(e,t){this.type=e,this.output=t}static parse(e,t,i){if(2!==e.length||"string"!=typeof e[1])throw new Error('"var" requires just one literal string argument');const r=t.get(e[1]);if(!r)throw new Error(`${e[1]} must be defined before being used in a "var" expression`);return new ae(i||k,r)}evaluate(e,t){return this.output.evaluate(e,t)}}class oe{constructor(e,t,i){this.type=e,this.index=t,this.array=i}static parse(e,t){if(3!==e.length)throw new Error('"at" expects 2 arguments');const i=Me(e[1],t,P),r=Me(e[2],t);return new oe(r.type.itemType,i,r)}evaluate(e,t){const i=this.index.evaluate(e,t),r=this.array.evaluate(e,t);if(i<0||i>=r.length)throw new Error('"at" index out of bounds');if(i!==Math.floor(i))throw new Error('"at" index must be an integer');return r[i]}}class le{constructor(e,t){this.key=e,this.obj=t,this.type=k}static parse(e,t){let i,r;switch(e.length){case 2:return i=Me(e[1],t),new le(i);case 3:return i=Me(e[1],t),r=Me(e[2],t),new le(i,r);default:throw new Error('"get" expects 1 or 2 arguments')}}evaluate(e,t){const i=this.key.evaluate(e,t);return this.obj?this.obj.evaluate(e,t)[i]:null==e?void 0:e.values[i]}}class he{constructor(e,t){this.key=e,this.obj=t,this.type=D}static parse(e,t){let i,r;switch(e.length){case 2:return i=Me(e[1],t),new he(i);case 3:return i=Me(e[1],t),r=Me(e[2],t),new he(i,r);default:throw new Error('"has" expects 1 or 2 arguments')}}evaluate(e,t){const i=this.key.evaluate(e,t);return this.obj?i in this.obj.evaluate(e,t):!(null==e||!e.values[i])}}class ue{constructor(e,t){this.key=e,this.vals=t,this.type=D}static parse(e,t){if(3!==e.length)throw new Error('"in" expects 2 arguments');return new ue(Me(e[1],t),Me(e[2],t))}evaluate(e,t){const i=this.key.evaluate(e,t);return-1!==this.vals.evaluate(e,t).indexOf(i)}}class ce{constructor(e,t,i){this.item=e,this.array=t,this.from=i,this.type=P}static parse(e,t){if(e.length<3||e.length>4)throw new Error('"index-of" expects 3 or 4 arguments');const i=Me(e[1],t),r=Me(e[2],t);if(4===e.length){const s=Me(e[3],t,P);return new ce(i,r,s)}return new ce(i,r)}evaluate(e,t){const i=this.item.evaluate(e,t),r=this.array.evaluate(e,t);if(this.from){const s=this.from.evaluate(e,t);if(s!==Math.floor(s))throw new Error('"index-of" index must be an integer');return r.indexOf(i,s)}return r.indexOf(i)}}class de{constructor(e){this.arg=e,this.type=P}static parse(e,t){if(2!==e.length)throw new Error('"length" expects 2 arguments');const i=Me(e[1],t);return new de(i)}evaluate(e,t){const i=this.arg.evaluate(e,t);if("string"==typeof i)return i.length;if(Array.isArray(i))return i.length;throw new Error('"length" expects string or array')}}class pe{constructor(e,t,i,r){this.type=e,this.array=t,this.from=i,this.to=r}static parse(e,t){if(e.length<3||e.length>4)throw new Error('"slice" expects 2 or 3 arguments');const i=Me(e[1],t),r=Me(e[2],t,P);if(r.type!==P)throw new Error('"slice" index must return a number');if(4===e.length){const s=Me(e[3],t,P);if(s.type!==P)throw new Error('"slice" index must return a number');return new pe(i.type,i,r,s)}return new pe(i.type,i,r)}evaluate(e,t){const i=this.array.evaluate(e,t);if(!Array.isArray(i)&&"string"!=typeof i)throw new Error('"slice" input must be an array or a string');const r=this.from.evaluate(e,t);if(r<0||r>=i.length)throw new Error('"slice" index out of bounds');if(r!==Math.floor(r))throw new Error('"slice" index must be an integer');if(this.to){const s=this.to.evaluate(e,t);if(s<0||s>=i.length)throw new Error('"slice" index out of bounds');if(s!==Math.floor(s))throw new Error('"slice" index must be an integer');return i.slice(r,s)}return i.slice(r)}}class fe{constructor(){this.type=D}static parse(e){if(1!==e.length)throw new Error('"has-id" expects no arguments');return new fe}evaluate(e,t){return e&&void 0!==e.id}}class ye{constructor(e,t){this.args=e,this.calculate=t,this.type=P}static parse(e,t,i){const r=e.slice(1).map((e=>Me(e,t)));return new ye(r,i)}evaluate(e,t){let i;return this.args&&(i=this.args.map((i=>i.evaluate(e,t)))),this.calculate(i)}}class me{constructor(e,t){this.args=e,this.calculate=t,this.type=P}static parse(e,t){const i=e.slice(1).map((e=>Me(e,t)));return new me(i,me.ops[e[0]])}evaluate(e,t){let i;return this.args&&(i=this.args.map((i=>i.evaluate(e,t)))),this.calculate(i)}}me.ops={abs:e=>Math.abs(e[0]),acos:e=>Math.acos(e[0]),asin:e=>Math.asin(e[0]),atan:e=>Math.atan(e[0]),ceil:e=>Math.ceil(e[0]),cos:e=>Math.cos(e[0]),e:()=>Math.E,floor:e=>Math.floor(e[0]),ln:e=>Math.log(e[0]),ln2:()=>Math.LN2,log10:e=>Math.log(e[0])/Math.LN10,log2:e=>Math.log(e[0])/Math.LN2,max:e=>Math.max(...e),min:e=>Math.min(...e),pi:()=>Math.PI,round:e=>Math.round(e[0]),sin:e=>Math.sin(e[0]),sqrt:e=>Math.sqrt(e[0]),tan:e=>Math.tan(e[0])};class ge{constructor(e){this.args=e,this.type=L}static parse(e,t){return new ge(e.slice(1).map((e=>Me(e,t))))}evaluate(e,t){return this.args.map((i=>i.evaluate(e,t))).join("")}}class _e{constructor(e,t){this.arg=e,this.calculate=t,this.type=L}static parse(e,t){if(2!==e.length)throw new Error(`${e[0]} expects 1 argument`);const i=Me(e[1],t);return new _e(i,_e.ops[e[0]])}evaluate(e,t){return this.calculate(this.arg.evaluate(e,t))}}_e.ops={downcase:e=>e.toLowerCase(),upcase:e=>e.toUpperCase()};class xe{constructor(e){this.args=e,this.type=N}static parse(e,t){if(4!==e.length)throw new Error('"rgb" expects 3 arguments');const i=e.slice(1).map((e=>Me(e,t)));return new xe(i)}evaluate(e,t){const i=this._validate(this.args[0].evaluate(e,t)),r=this._validate(this.args[1].evaluate(e,t)),n=this._validate(this.args[2].evaluate(e,t));return new s.o({r:i,g:r,b:n})}_validate(e){if("number"!=typeof e||e<0||e>255)throw new Error(`${e}: invalid color component`);return Math.round(e)}}class ve{constructor(e){this.args=e,this.type=N}static parse(e,t){if(5!==e.length)throw new Error('"rgba" expects 4 arguments');const i=e.slice(1).map((e=>Me(e,t)));return new ve(i)}evaluate(e,t){const i=this._validate(this.args[0].evaluate(e,t)),r=this._validate(this.args[1].evaluate(e,t)),n=this._validate(this.args[2].evaluate(e,t)),a=this._validateAlpha(this.args[3].evaluate(e,t));return new s.o({r:i,g:r,b:n,a})}_validate(e){if("number"!=typeof e||e<0||e>255)throw new Error(`${e}: invalid color component`);return Math.round(e)}_validateAlpha(e){if("number"!=typeof e||e<0||e>1)throw new Error(`${e}: invalid alpha color component`);return e}}class be{constructor(e){this.color=e,this.type=V(P,4)}static parse(e,t){if(2!==e.length)throw new Error('"to-rgba" expects 1 argument');const i=Me(e[1],t);return new be(i)}evaluate(e,t){return new s.o(this.color.evaluate(e,t)).toRgba()}}class we{constructor(e,t){this.type=e,this.args=t}static parse(e,t){const i=e[0];if(e.length<2)throw new Error(`${i} expects at least one argument`);let r,s=1;if("array"===i){if(e.length>2){switch(e[1]){case"string":r=L;break;case"number":r=P;break;case"boolean":r=D;break;default:throw new Error('"array" type argument must be string, number or boolean')}s++}else r=k;let t;if(e.length>3){if(t=e[2],null!==t&&("number"!=typeof t||t<0||t!==Math.floor(t)))throw new Error('"array" length argument must be a positive integer literal');s++}r=V(r,t)}else switch(i){case"string":r=L;break;case"number":r=P;break;case"boolean":r=D;break;case"object":r=O}const n=[];for(;s<e.length;s++){const i=Me(e[s],t);n.push(i)}return new we(r,n)}evaluate(e,t){let i;for(const r of this.args){const s=r.evaluate(e,t);if(i=z(s),B(i,this.type))return s}throw new Error(`Expected ${G(this.type)} but got ${G(i)}`)}}class Se{constructor(e,t){this.type=e,this.args=t}static parse(e,t){const i=e[0],r=Se.types[i];if(r===D||r===L){if(2!==e.length)throw new Error(`${i} expects one argument`)}else if(e.length<2)throw new Error(`${i} expects at least one argument`);const s=[];for(let i=1;i<e.length;i++){const r=Me(e[i],t);s.push(r)}return new Se(r,s)}evaluate(e,t){if(this.type===D)return Boolean(this.args[0].evaluate(e,t));if(this.type===L)return j(this.args[0].evaluate(e,t));if(this.type===P){for(const i of this.args){const r=Number(i.evaluate(e,t));if(!isNaN(r))return r}return null}if(this.type===N){for(const i of this.args)try{const r=Se.toColor(i.evaluate(e,t));if(r instanceof s.o)return r}catch{}return null}}static toBoolean(e){return Boolean(e)}static toString(e){return j(e)}static toNumber(e){const t=Number(e);if(isNaN(t))throw new Error(`"${e}" is not a number`);return t}static toColor(e){if(e instanceof s.o)return e;if("string"==typeof e){const t=s.o.fromString(e);if(t)return t;throw new Error(`"${e}" is not a color`)}if(Array.isArray(e))return s.o.fromArray(e);throw new Error(`"${e}" is not a color`)}}Se.types={"to-boolean":D,"to-color":N,"to-number":P,"to-string":L};class Ie{constructor(e){this.val=e,this.type=z(e)}static parse(e){if(2!==e.length)throw new Error('"literal" expects 1 argument');return new Ie(e[1])}evaluate(e,t){return this.val}}class Ce{constructor(e){this.arg=e,this.type=L}static parse(e,t){if(2!==e.length)throw new Error('"typeof" expects 1 argument');return new Ce(Me(e[1],t))}evaluate(e,t){return G(z(this.arg.evaluate(e,t)))}}function Me(e,t,i){const r=typeof e;if("string"===r||"boolean"===r||"number"===r||null===e){if(i)switch(i.kind){case"string":"string"!==r&&(e=Se.toString(e));break;case"number":"number"!==r&&(e=Se.toNumber(e));break;case"color":e=Se.toColor(e)}e=["literal",e]}if(!Array.isArray(e)||0===e.length)throw new Error("Expression must be a non empty array");const s=e[0];if("string"!=typeof s)throw new Error("First element of expression must be a string");const n=Te[s];if(void 0===n)throw new Error(`Invalid expression operator "${s}"`);if(!n)throw new Error(`Unimplemented expression operator "${s}"`);return n.parse(e,t,i)}const Te={array:we,boolean:we,collator:null,format:null,image:null,literal:Ie,number:we,"number-format":null,object:we,string:we,"to-boolean":Se,"to-color":Se,"to-number":Se,"to-string":Se,typeof:Ce,accumulated:null,"feature-state":null,"geometry-type":W,id:H,"line-progress":null,properties:Q,at:oe,get:le,has:he,in:ue,"index-of":ce,length:de,slice:pe,"!":J,"!=":class extends Y{static parse(e,t){return Y.parse(e,t,((e,t)=>e!==t))}},"<":class extends Y{static parse(e,t){return Y.parse(e,t,((e,t)=>e<t))}},"<=":class extends Y{static parse(e,t){return Y.parse(e,t,((e,t)=>e<=t))}},"==":class extends Y{static parse(e,t){return Y.parse(e,t,((e,t)=>e===t))}},">":class extends Y{static parse(e,t){return Y.parse(e,t,((e,t)=>e>t))}},">=":class extends Y{static parse(e,t){return Y.parse(e,t,((e,t)=>e>=t))}},all:X,any:$,case:ee,coalesce:te,match:ie,within:null,interpolate:re,"interpolate-hcl":re,"interpolate-lab":re,step:se,let:ne,var:ae,concat:ge,downcase:_e,"is-supported-script":null,"resolved-locale":null,upcase:_e,rgb:xe,rgba:ve,"to-rgba":be,"-":class extends ye{static parse(e,t){switch(e.length){case 2:return ye.parse(e,t,(e=>-e[0]));case 3:return ye.parse(e,t,(e=>e[0]-e[1]));default:throw new Error('"-" expects 1 or 2 arguments')}}},"*":class extends ye{static parse(e,t){return ye.parse(e,t,(e=>{let t=1;for(const i of e)t*=i;return t}))}},"/":class extends ye{static parse(e,t){if(3===e.length)return ye.parse(e,t,(e=>e[0]/e[1]));throw new Error('"/" expects 2 arguments')}},"%":class extends ye{static parse(e,t){if(3===e.length)return ye.parse(e,t,(e=>e[0]%e[1]));throw new Error('"%" expects 2 arguments')}},"^":class extends ye{static parse(e,t){if(3===e.length)return ye.parse(e,t,(e=>e[0]**e[1]));throw new Error('"^" expects 1 or 2 arguments')}},"+":class extends ye{static parse(e,t){return ye.parse(e,t,(e=>{let t=0;for(const i of e)t+=i;return t}))}},abs:me,acos:me,asin:me,atan:me,ceil:me,cos:me,e:me,floor:me,ln:me,ln2:me,log10:me,log2:me,max:me,min:me,pi:me,round:me,sin:me,sqrt:me,tan:me,zoom:Z,"heatmap-density":null,"has-id":fe,none:K};class Ee{constructor(e){this._expression=e}filter(e,t){if(!this._expression)return!0;try{return this._expression.evaluate(e,t)}catch(e){return console.log(e.message),!0}}static createFilter(e){if(!e)return null;this.isLegacyFilter(e)&&(e=this.convertLegacyFilter(e));try{const t=Me(e,null,D);return new Ee(t)}catch(e){return console.log(e.message),null}}static isLegacyFilter(e){if(!Array.isArray(e))return!0;if(0===e.length)return!0;switch(e[0]){case"==":case"!=":case">":case"<":case">=":case"<=":return 3===e.length&&"string"==typeof e[1]&&!Array.isArray(e[2]);case"in":return e.length>=3&&"string"==typeof e[1]&&!Array.isArray(e[2]);case"!in":return!0;case"any":case"all":for(let t=1;t<e.length;t++)if(!this.isLegacyFilter(e[1]))return!1;return!0;case"none":return!0;case"has":return 2===e.length&&("$id"===e[1]||"$type"===e[1]);case"!has":return!0;default:return!1}}static convertLegacyFilter(e){if(!Array.isArray(e)||0===e.length)return!0;const t=e[0];if(1===e.length)return"any"!==t;switch(t){case"==":return Ee.convertComparison("==",e[1],e[2]);case"!=":return Ee.negate(Ee.convertComparison("==",e[1],e[2]));case">":case"<":case">=":case"<=":return Ee.convertComparison(t,e[1],e[2]);case"in":return Ee.convertIn(e[1],e.slice(2));case"!in":return Ee.negate(Ee.convertIn(e[1],e.slice(2)));case"any":case"all":case"none":return Ee.convertCombining(t,e.slice(1));case"has":return Ee.convertHas(e[1]);case"!has":return Ee.negate(Ee.convertHas(e[1]));default:throw new Error("Unexpected legacy filter.")}}static convertComparison(e,t,i){switch(t){case"$type":return[e,["geometry-type"],i];case"$id":return[e,["id"],i];default:return[e,["get",t],i]}}static convertIn(e,t){switch(e){case"$type":return["in",["geometry-type"],["literal",t]];case"$id":return["in",["id"],["literal",t]];default:return["in",["get",e],["literal",t]]}}static convertHas(e){switch(e){case"$type":return!0;case"$id":return["has-id"];default:return["has",e]}}static convertCombining(e,t){return[e].concat(t.map(this.convertLegacyFilter))}static negate(e){return["!",e]}}class Fe{}Fe.backgroundLayoutDefinition={visibility:{type:"enum",values:["visible","none"],default:0}},Fe.fillLayoutDefinition={visibility:{type:"enum",values:["visible","none"],default:0}},Fe.lineLayoutDefinition={visibility:{type:"enum",values:["visible","none"],default:0},"line-cap":{type:"enum",values:["butt","round","square"],default:0},"line-join":{type:"enum",values:["bevel","round","miter"],default:2},"line-miter-limit":{type:"number",default:2},"line-round-limit":{type:"number",default:1.05}},Fe.symbolLayoutDefinition={visibility:{type:"enum",values:["visible","none"],default:0},"symbol-avoid-edges":{type:"boolean",default:!1},"symbol-placement":{type:"enum",values:["point","line","line-center"],default:0},"symbol-sort-key":{type:"number",default:-1},"symbol-spacing":{type:"number",minimum:1,default:250},"icon-allow-overlap":{type:"boolean",default:!1},"icon-anchor":{type:"enum",values:["center","left","right","top","bottom","top-left","top-right","bottom-left","bottom-right"],default:0},"icon-ignore-placement":{type:"boolean",default:!1},"icon-image":{type:"string"},"icon-keep-upright":{type:"boolean",default:!1},"icon-offset":{type:"array",value:"number",length:2,default:[0,0]},"icon-optional":{type:"boolean",default:!1},"icon-padding":{type:"number",minimum:0,default:2},"icon-rotate":{type:"number",default:0},"icon-rotation-alignment":{type:"enum",values:["map","viewport","auto"],default:2},"icon-size":{type:"number",minimum:0,default:1},"text-allow-overlap":{type:"boolean",default:!1},"text-anchor":{type:"enum",values:["center","left","right","top","bottom","top-left","top-right","bottom-left","bottom-right"],default:0},"text-field":{type:"string"},"text-font":{type:"array",value:"string",default:["Open Sans Regular","Arial Unicode MS Regular"]},"text-ignore-placement":{type:"boolean",default:!1},"text-justify":{type:"enum",values:["auto","left","center","right"],default:2},"text-keep-upright":{type:"boolean",default:!0},"text-letter-spacing":{type:"number",default:0},"text-line-height":{type:"number",default:1.2},"text-max-angle":{type:"number",minimum:0,default:45},"text-max-width":{type:"number",minimum:0,default:10},"text-offset":{type:"array",value:"number",length:2,default:[0,0]},"text-optional":{type:"boolean",default:!1},"text-padding":{type:"number",minimum:0,default:2},"text-rotate":{type:"number",default:0},"text-rotation-alignment":{type:"enum",values:["map","viewport","auto"],default:2},"text-size":{type:"number",minimum:0,default:16},"text-transform":{type:"enum",values:["none","uppercase","lowercase"],default:0},"text-writing-mode":{type:"array",value:"enum",values:["horizontal","vertical"],default:[0]}},Fe.circleLayoutDefinition={visibility:{type:"enum",values:["visible","none"],default:0}},Fe.backgroundPaintDefinition={"background-color":{type:"color",default:[0,0,0,1]},"background-opacity":{type:"number",minimum:0,maximum:1,default:1},"background-pattern":{type:"string"}},Fe.fillPaintDefinition={"fill-antialias":{type:"boolean",default:!0},"fill-color":{type:"color",default:[0,0,0,1]},"fill-opacity":{type:"number",minimum:0,maximum:1,default:1},"fill-outline-color":{type:"color",default:[0,0,0,0]},"fill-pattern":{type:"string"},"fill-translate":{type:"array",value:"number",length:2,default:[0,0]},"fill-translate-anchor":{type:"enum",values:["map","viewport"],default:0}},Fe.linePaintDefinition={"line-blur":{type:"number",minimum:0,default:0},"line-color":{type:"color",default:[0,0,0,1]},"line-dasharray":{type:"array",value:"number",default:[]},"line-gap-width":{type:"number",minimum:0,default:0},"line-offset":{type:"number",default:0},"line-opacity":{type:"number",minimum:0,maximum:1,default:1},"line-pattern":{type:"string"},"line-translate":{type:"array",value:"number",length:2,default:[0,0]},"line-translate-anchor":{type:"enum",values:["map","viewport"],default:0},"line-width":{type:"number",minimum:0,default:1}},Fe.symbolPaintDefinition={"icon-color":{type:"color",default:[0,0,0,1]},"icon-halo-blur":{type:"number",minimum:0,default:0},"icon-halo-color":{type:"color",default:[0,0,0,0]},"icon-halo-width":{type:"number",minimum:0,default:0},"icon-opacity":{type:"number",minimum:0,maximum:1,default:1},"icon-translate":{type:"array",value:"number",length:2,default:[0,0]},"icon-translate-anchor":{type:"enum",values:["map","viewport"],default:0},"text-color":{type:"color",default:[0,0,0,1]},"text-halo-blur":{type:"number",minimum:0,default:0},"text-halo-color":{type:"color",default:[0,0,0,0]},"text-halo-width":{type:"number",minimum:0,default:0},"text-opacity":{type:"number",minimum:0,maximum:1,default:1},"text-translate":{type:"array",value:"number",length:2,default:[0,0]},"text-translate-anchor":{type:"enum",values:["map","viewport"],default:0}},Fe.rasterPaintDefinition={"raster-opacity":{type:"number",minimum:0,maximum:1,default:1},"raster-hue-rotate":{type:"number",default:0},"raster-brightness-min":{type:"number",minimum:0,maximum:1,default:0},"raster-brightness-max":{type:"number",minimum:0,maximum:1,default:1},"raster-saturation":{type:"number",minimum:-1,maximum:1,default:0},"raster-contrast":{type:"number",minimum:-1,maximum:1,default:0},"raster-fade-duration":{type:"number",minimum:0,default:300}},Fe.circlePaintDefinition={"circle-blur":{type:"number",minimum:0,default:0},"circle-color":{type:"color",default:[0,0,0,1]},"circle-opacity":{type:"number",minimum:0,maximum:1,default:1},"circle-radius":{type:"number",minimum:0,default:5},"circle-stroke-color":{type:"color",default:[0,0,0,1]},"circle-stroke-opacity":{type:"number",minimum:0,maximum:1,default:1},"circle-stroke-width":{type:"number",minimum:0,default:0},"circle-translate":{type:"array",value:"number",length:2,default:[0,0]},"circle-translate-anchor":{type:"enum",values:["map","viewport"],default:0}};class Ae{constructor(e,t){let i;switch(this.isDataDriven=!1,this.interpolator=null,e.type){case"number":case"color":i=!0;break;case"array":i="number"===e.value;break;default:i=!1}if(null==t&&(t=e.default),Array.isArray(t)&&t.length>0&&Te[t[0]]){const i={number:P,color:N,string:L,boolean:D,enum:L};try{const r=Me(t,null,"array"===e.type?V(i[e.value]||k,e.length):i[e.type]);this.getValue=this._buildExpression(r,e),this.isDataDriven=!0,r instanceof re&&r.input instanceof Z&&(this.interpolator=r)}catch(t){console.log(t.message),this.getValue=this._buildSimple(e.default)}return}i&&"interval"===t.type&&(i=!1);const r=t&&t.stops&&t.stops.length>0;if(r)for(const i of t.stops)i[1]=this._validate(i[1],e);if(this.isDataDriven=!!t&&!!t.property,this.isDataDriven)if(void 0!==t.default&&(t.default=this._validate(t.default,e)),r)switch(t.type){case"identity":this.getValue=this._buildIdentity(t,e);break;case"categorical":this.getValue=this._buildCategorical(t,e);break;default:this.getValue=i?this._buildInterpolate(t,e):this._buildInterval(t,e)}else this.getValue=this._buildIdentity(t,e);else r?this.getValue=i?this._buildZoomInterpolate(t):this._buildZoomInterval(t):(t=this._validate(t,e),this.getValue=this._buildSimple(t))}_validate(e,t){if("number"===t.type){if(e<t.minimum)return t.minimum;if(e>t.maximum)return t.maximum}else"color"===t.type?e=Ae._parseColor(e):"enum"===t.type?"string"==typeof e&&(e=t.values.indexOf(e)):"array"===t.type&&"enum"===t.value?e=e.map((i=>"string"==typeof e?t.values.indexOf(i):i)):"string"===t.type&&(e=j(e));return e}_buildSimple(e){return()=>e}_buildExpression(e,t){return(i,r)=>{try{const s=e.evaluate(r,i);return void 0===s?t.default:this._validate(s,t)}catch(e){return console.log(e.message),t.default}}}_buildIdentity(e,t){return(i,r)=>{let s;return r&&(s=r.values[e.property]),void 0!==s?this._validate(s,t):void 0!==e.default?e.default:t.default}}_buildCategorical(e,t){return(i,r)=>{let s;return r&&(s=r.values[e.property]),s=this._categorical(s,e.stops),void 0!==s?s:void 0!==e.default?e.default:t.default}}_buildInterval(e,t){return(i,r)=>{let s;return r&&(s=r.values[e.property]),"number"==typeof s?this._interval(s,e.stops):void 0!==e.default?e.default:t.default}}_buildInterpolate(e,t){return(i,r)=>{let s;return r&&(s=r.values[e.property]),"number"==typeof s?this._interpolate(s,e.stops,e.base||1):void 0!==e.default?e.default:t.default}}_buildZoomInterpolate(e){return t=>this._interpolate(t,e.stops,e.base||1)}_buildZoomInterval(e){return t=>this._interval(t,e.stops)}_categorical(e,t){const i=t.length;for(let r=0;r<i;r++)if(t[r][0]===e)return t[r][1]}_interval(e,t){const i=t.length;let r=0;for(let s=0;s<i&&t[s][0]<=e;s++)r=s;return t[r][1]}_interpolate(e,t,i){let r,s;const n=t.length;for(let i=0;i<n;i++){const n=t[i];if(!(n[0]<=e)){s=n;break}r=n}if(r&&s){const t=s[0]-r[0],n=e-r[0],a=1===i?n/t:(i**n-1)/(i**t-1);if(Array.isArray(r[1])){const e=r[1],t=s[1],i=[];for(let r=0;r<e.length;r++)i.push(g(e[r],t[r],a));return i}return g(r[1],s[1],a)}return r?r[1]:s?s[1]:void 0}static _isEmpty(e){for(const t in e)if(e.hasOwnProperty(t))return!1;return!0}static _parseColor(e){return Array.isArray(e)?e:("string"==typeof e&&(e=new s.o(e)),e instanceof s.o?this._isEmpty(e)?void 0:s.o.toUnitRGBA(e):e)}}class Re{constructor(e,t,i,r){switch(this.type=e,this.typeName=t.type,this.id=t.id,this.source=t.source,this.sourceLayer=t["source-layer"],this.minzoom=t.minzoom,this.maxzoom=t.maxzoom,this.filter=t.filter,this.layout=t.layout,this.paint=t.paint,this.z=i,this.uid=r,e){case 0:this._layoutDefinition=Fe.backgroundLayoutDefinition,this._paintDefinition=Fe.backgroundPaintDefinition;break;case 1:this._layoutDefinition=Fe.fillLayoutDefinition,this._paintDefinition=Fe.fillPaintDefinition;break;case 2:this._layoutDefinition=Fe.lineLayoutDefinition,this._paintDefinition=Fe.linePaintDefinition;break;case 3:this._layoutDefinition=Fe.symbolLayoutDefinition,this._paintDefinition=Fe.symbolPaintDefinition;break;case 4:this._layoutDefinition=Fe.circleLayoutDefinition,this._paintDefinition=Fe.circlePaintDefinition}this._layoutProperties=this._parseLayout(this.layout),this._paintProperties=this._parsePaint(this.paint)}getFeatureFilter(){return void 0!==this._featureFilter?this._featureFilter:this._featureFilter=Ee.createFilter(this.filter)}getLayoutProperty(e){return this._layoutProperties[e]}getPaintProperty(e){return this._paintProperties[e]}getLayoutValue(e,t,i){let r;const s=this._layoutProperties[e];return s&&(r=s.getValue(t,i)),void 0===r&&(r=this._layoutDefinition[e].default),r}getPaintValue(e,t,i){let r;const s=this._paintProperties[e];return s&&(r=s.getValue(t,i)),void 0===r&&(r=this._paintDefinition[e].default),r}isPainterDataDriven(){const e=this._paintProperties;if(e)for(const t in e)if(e[t].isDataDriven)return!0;return!1}_parseLayout(e){const t={};for(const i in e){const r=this._layoutDefinition[i];r&&(t[i]=new Ae(r,e[i]))}return t}_parsePaint(e){const t={};for(const i in e){const r=this._paintDefinition[i];r&&(t[i]=new Ae(r,e[i]))}return t}computeAttributesKey(e,t,i,r){let s=0,n=0;for(const e of t){let t=3;if(!e||e!==r){const r=i[e],{isLayout:s,isOptional:n}=r,a=s?this.getLayoutProperty(e):this.getPaintProperty(e);t=null!=a&&a.interpolator?2:null!=a&&a.isDataDriven?1:n&&!a?3:0}n|=t<<s,s+=2}return n<<3|e}}class Pe extends Re{constructor(e,t,i,r){super(e,t,i,r),this.backgroundMaterial=new w(this.computeAttributesKey(0,w.ATTRIBUTES,w.ATTRIBUTES_INFO))}}class Le extends Re{constructor(e,t,i,r){super(e,t,i,r);const s=this.getPaintProperty("fill-color"),n=this.getPaintProperty("fill-opacity"),a=this.getPaintProperty("fill-pattern");this.hasDataDrivenColor=null==s?void 0:s.isDataDriven,this.hasDataDrivenOpacity=null==n?void 0:n.isDataDriven,this.hasDataDrivenFill=this.hasDataDrivenColor||this.hasDataDrivenOpacity||(null==a?void 0:a.isDataDriven);const o=this.getPaintProperty("fill-outline-color");this.outlineUsesFillColor=!o,this.hasDataDrivenOutlineColor=null==o?void 0:o.isDataDriven,this.hasDataDrivenOutline=o?o.isDataDriven:!!s&&s.isDataDriven,this.hasDataDrivenOutline=(o?this.hasDataDrivenOutlineColor:this.hasDataDrivenColor)||this.hasDataDrivenOpacity,this.fillMaterial=new I(this.computeAttributesKey(1,I.ATTRIBUTES,I.ATTRIBUTES_INFO)),this.outlineMaterial=new C(this.computeAttributesKey(2,this.outlineUsesFillColor?C.ATTRIBUTES_FILL:C.ATTRIBUTES_OUTLINE,this.outlineUsesFillColor?C.ATTRIBUTES_INFO_FILL:C.ATTRIBUTES_INFO_OUTLINE),this.outlineUsesFillColor)}}class De extends Re{constructor(e,t,i,r){var s,n,a,l,h,u,c,d,p;super(e,t,i,r);const f=this.getPaintProperty("line-pattern");if(this.lineMaterial=new M(this.computeAttributesKey(3,M.ATTRIBUTES,M.ATTRIBUTES_INFO,f?"line-dasharray":"")),this.hasDataDrivenLine=(null==(s=this.getPaintProperty("line-blur"))?void 0:s.isDataDriven)||(null==(n=this.getPaintProperty("line-color"))?void 0:n.isDataDriven)||(null==(a=this.getPaintProperty("line-gap-width"))?void 0:a.isDataDriven)||(null==(l=this.getPaintProperty("line-offset"))?void 0:l.isDataDriven)||(null==(h=this.getPaintProperty("line-opacity"))?void 0:h.isDataDriven)||(null==(u=this.getPaintProperty("line-pattern"))?void 0:u.isDataDriven)||(null==(c=this.getPaintProperty("line-dasharray"))?void 0:c.isDataDriven)||(null==(d=this.getLayoutProperty("line-cap"))?void 0:d.isDataDriven)||(null==(p=this.getPaintProperty("line-width"))?void 0:p.isDataDriven),this.canUseThinTessellation=!1,!this.hasDataDrivenLine){const e=this.getPaintProperty("line-width");if(!e||"number"==typeof e&&.5*e<o.S){const e=this.getPaintProperty("line-offset");(!e||"number"==typeof e&&0===e)&&(this.canUseThinTessellation=!0)}}}getDashKey(e,t){let i;switch(t){case 0:i="Butt";break;case 1:i="Round";break;case 2:i="Square";break;default:i="Butt"}return`dasharray-[${e.toString()}]-${i}`}}class Ne extends Re{constructor(e,t,i,r){var s,n,a,o,l,h,u,c,d,p,f,y;super(e,t,i,r),this.iconMaterial=new F(this.computeAttributesKey(4,F.ATTRIBUTES,F.ATTRIBUTES_INFO)),this.textMaterial=new A(this.computeAttributesKey(6,A.ATTRIBUTES,A.ATTRIBUTES_INFO)),this.hasDataDrivenIcon=(null==(s=this.getPaintProperty("icon-color"))?void 0:s.isDataDriven)||(null==(n=this.getPaintProperty("icon-halo-blur"))?void 0:n.isDataDriven)||(null==(a=this.getPaintProperty("icon-halo-color"))?void 0:a.isDataDriven)||(null==(o=this.getPaintProperty("icon-halo-width"))?void 0:o.isDataDriven)||(null==(l=this.getPaintProperty("icon-opacity"))?void 0:l.isDataDriven)||(null==(h=this.getLayoutProperty("icon-size"))?void 0:h.isDataDriven),this.hasDataDrivenText=(null==(u=this.getPaintProperty("text-color"))?void 0:u.isDataDriven)||(null==(c=this.getPaintProperty("text-halo-blur"))?void 0:c.isDataDriven)||(null==(d=this.getPaintProperty("text-halo-color"))?void 0:d.isDataDriven)||(null==(p=this.getPaintProperty("text-halo-width"))?void 0:p.isDataDriven)||(null==(f=this.getPaintProperty("text-opacity"))?void 0:f.isDataDriven)||(null==(y=this.getLayoutProperty("text-size"))?void 0:y.isDataDriven)}}class Oe extends Re{constructor(e,t,i,r){super(e,t,i,r),this.circleMaterial=new S(this.computeAttributesKey(5,S.ATTRIBUTES,S.ATTRIBUTES_INFO))}}class ke{constructor(e,t,i){var r,s,n,a,o;let l;this.allowOverlap=e.getLayoutValue("icon-allow-overlap",t),this.ignorePlacement=e.getLayoutValue("icon-ignore-placement",t),this.keepUpright=e.getLayoutValue("icon-keep-upright",t),this.optional=e.getLayoutValue("icon-optional",t),this.rotationAlignment=e.getLayoutValue("icon-rotation-alignment",t),2===this.rotationAlignment&&(this.rotationAlignment=i?0:1),l=e.getLayoutProperty("icon-anchor"),null!=(r=l)&&r.isDataDriven?this._anchorProp=l:this.anchor=e.getLayoutValue("icon-anchor",t),l=e.getLayoutProperty("icon-offset"),null!=(s=l)&&s.isDataDriven?this._offsetProp=l:this.offset=e.getLayoutValue("icon-offset",t),l=e.getLayoutProperty("icon-padding"),null!=(n=l)&&n.isDataDriven?this._paddingProp=l:this.padding=e.getLayoutValue("icon-padding",t),l=e.getLayoutProperty("icon-rotate"),null!=(a=l)&&a.isDataDriven?this._rotateProp=l:this.rotate=e.getLayoutValue("icon-rotate",t),l=e.getLayoutProperty("icon-size"),null!=(o=l)&&o.isDataDriven?this._sizeProp=l:this.size=e.getLayoutValue("icon-size",t)}update(e,t){this._anchorProp&&(this.anchor=this._anchorProp.getValue(e,t)),this._offsetProp&&(this.offset=this._offsetProp.getValue(e,t)),this._paddingProp&&(this.padding=this._paddingProp.getValue(e,t)),this._rotateProp&&(this.rotate=this._rotateProp.getValue(e,t)),this._sizeProp&&(this.size=this._sizeProp.getValue(e,t))}}class Ve{constructor(e,t,i){var r,s,n,a,o,l,h,u,c,d,p;let f;this.allowOverlap=e.getLayoutValue("text-allow-overlap",t),this.ignorePlacement=e.getLayoutValue("text-ignore-placement",t),this.keepUpright=e.getLayoutValue("text-keep-upright",t),this.optional=e.getLayoutValue("text-optional",t),this.rotationAlignment=e.getLayoutValue("text-rotation-alignment",t),2===this.rotationAlignment&&(this.rotationAlignment=i?0:1),f=e.getLayoutProperty("text-anchor"),null!=(r=f)&&r.isDataDriven?this._anchorProp=f:this.anchor=e.getLayoutValue("text-anchor",t),f=e.getLayoutProperty("text-justify"),null!=(s=f)&&s.isDataDriven?this._justifyProp=f:this.justify=e.getLayoutValue("text-justify",t),f=e.getLayoutProperty("text-letter-spacing"),null!=(n=f)&&n.isDataDriven?this._letterSpacingProp=f:this.letterSpacing=e.getLayoutValue("text-letter-spacing",t),f=e.getLayoutProperty("text-line-height"),null!=(a=f)&&a.isDataDriven?this._lineHeightProp=f:this.lineHeight=e.getLayoutValue("text-line-height",t),f=e.getLayoutProperty("text-max-angle"),null!=(o=f)&&o.isDataDriven?this._maxAngleProp=f:this.maxAngle=e.getLayoutValue("text-max-angle",t),f=e.getLayoutProperty("text-max-width"),null!=(l=f)&&l.isDataDriven?this._maxWidthProp=f:this.maxWidth=e.getLayoutValue("text-max-width",t),f=e.getLayoutProperty("text-offset"),null!=(h=f)&&h.isDataDriven?this._offsetProp=f:this.offset=e.getLayoutValue("text-offset",t),f=e.getLayoutProperty("text-padding"),null!=(u=f)&&u.isDataDriven?this._paddingProp=f:this.padding=e.getLayoutValue("text-padding",t),f=e.getLayoutProperty("text-rotate"),null!=(c=f)&&c.isDataDriven?this._rotateProp=f:this.rotate=e.getLayoutValue("text-rotate",t),f=e.getLayoutProperty("text-size"),null!=(d=f)&&d.isDataDriven?this._sizeProp=f:this.size=e.getLayoutValue("text-size",t),f=e.getLayoutProperty("text-writing-mode"),null!=(p=f)&&p.isDataDriven?this._writingModeProp=f:this.writingMode=e.getLayoutValue("text-writing-mode",t)}update(e,t){this._anchorProp&&(this.anchor=this._anchorProp.getValue(e,t)),this._justifyProp&&(this.justify=this._justifyProp.getValue(e,t)),this._letterSpacingProp&&(this.letterSpacing=this._letterSpacingProp.getValue(e,t)),this._lineHeightProp&&(this.lineHeight=this._lineHeightProp.getValue(e,t)),this._maxAngleProp&&(this.maxAngle=this._maxAngleProp.getValue(e,t)),this._maxWidthProp&&(this.maxWidth=this._maxWidthProp.getValue(e,t)),this._offsetProp&&(this.offset=this._offsetProp.getValue(e,t)),this._paddingProp&&(this.padding=this._paddingProp.getValue(e,t)),this._rotateProp&&(this.rotate=this._rotateProp.getValue(e,t)),this._sizeProp&&(this.size=this._sizeProp.getValue(e,t)),this._writingModeProp&&(this.writingMode=this._writingModeProp.getValue(e,t))}}class Ue{constructor(e,t){if(this._style=e,this.backgroundBucketIds=[],this._uidToLayer=new Map,this._layerByName={},this._runningId=0,e.layers||(e.layers=[]),this.version=parseFloat(e.version),this.sprite=t?t.spriteUrl:e.sprite,this.glyphs=t?t.glyphsUrl:e.glyphs,this.layers=e.layers.map(((e,t,i)=>this._create(e,t,i))),this.layers){let e;for(let t=0;t<this.layers.length;t++)e=this.layers[t],this._layerByName[e.id.toLowerCase()]=e,this._uidToLayer.set(e.uid,e),0===e.type&&this.backgroundBucketIds.push(e.id)}this._identifyRefLayers()}isPainterDataDriven(e){const t=this._layerByName[e.toLowerCase()];return!!t&&t.isPainterDataDriven()}getStyleLayerId(e){return e>=this.layers.length?null:this.layers[e].id}getStyleLayerByUID(e){const t=this._uidToLayer.get(e);return null!=t?t:null}getStyleLayerIndex(e){const t=this._layerByName[e.toLowerCase()];return t?this.layers.indexOf(t):-1}setStyleLayer(e,t){if(!e||!e.id)return;const i=this._style;null!=t&&t>=this.layers.length&&(t=this.layers.length-1);let r,s=!0;const n=this._layerByName[e.id.toLowerCase()];if(n){const a=this.layers.indexOf(n);t||(t=a),t===a?(s=!1,r=Ue._recreateLayer(e,n),this.layers[t]=r,i.layers[t]=e):(this.layers.splice(a,1),i.layers.splice(a,1),r=this._create(e,t,this.layers),this.layers.splice(t,0,r),i.layers.splice(t,0,e))}else r=this._create(e,t,this.layers),!t||t>=this.layers.length?(this.layers.push(r),i.layers.push(e)):(this.layers.splice(t,0,r),i.layers.splice(t,0,e));this._layerByName[e.id.toLowerCase()]=r,this._uidToLayer.set(r.uid,r),s&&this._recomputeZValues(),this._identifyRefLayers()}getStyleLayer(e){const t=this._layerByName[e.toLowerCase()];return t?{type:t.typeName,id:t.id,source:t.source,"source-layer":t.sourceLayer,minzoom:t.minzoom,maxzoom:t.maxzoom,filter:t.filter,layout:t.layout,paint:t.paint}:null}deleteStyleLayer(e){const t=this._layerByName[e.toLowerCase()];if(t){delete this._layerByName[e.toLowerCase()],this._uidToLayer.delete(t.uid);const i=this.layers.indexOf(t);this.layers.splice(i,1),this._style.layers.splice(i,1),this._recomputeZValues(),this._identifyRefLayers()}}getLayerById(e){return this._layerByName[e.toLowerCase()]}getLayoutProperties(e){const t=this._layerByName[e.toLowerCase()];return t?t.layout:null}getPaintProperties(e){const t=this._layerByName[e.toLowerCase()];return t?t.paint:null}setPaintProperties(e,t){const i=this._layerByName[e.toLowerCase()];if(!i)return;const r={type:i.typeName,id:i.id,source:i.source,"source-layer":i.sourceLayer,minzoom:i.minzoom,maxzoom:i.maxzoom,filter:i.filter,layout:i.layout,paint:t},s=Ue._recreateLayer(r,i),n=this.layers.indexOf(i);this.layers[n]=s,this._style.layers[n].paint=t,this._layerByName[i.id.toLowerCase()]=s,this._uidToLayer.set(i.uid,s)}setLayoutProperties(e,t){const i=this._layerByName[e.toLowerCase()];if(!i)return;const r={type:i.typeName,id:i.id,source:i.source,"source-layer":i.sourceLayer,minzoom:i.minzoom,maxzoom:i.maxzoom,filter:i.filter,layout:t,paint:i.paint},s=Ue._recreateLayer(r,i),n=this.layers.indexOf(i);this.layers[n]=s,this._style.layers[n].layout=t,this._layerByName[i.id.toLowerCase()]=s,this._uidToLayer.set(i.uid,s)}setStyleLayerVisibility(e,t){const i=this._layerByName[e.toLowerCase()];if(!i)return;const r=i.layout||{};r.visibility=t;const s={type:i.typeName,id:i.id,source:i.source,"source-layer":i.sourceLayer,minzoom:i.minzoom,maxzoom:i.maxzoom,filter:i.filter,layout:r,paint:i.paint},n=Ue._recreateLayer(s,i),a=this.layers.indexOf(i);this.layers[a]=n,this._style.layers[a].layout=r,this._layerByName[i.id.toLowerCase()]=n,this._uidToLayer.set(i.uid,n)}getStyleLayerVisibility(e){var t;const i=this._layerByName[e.toLowerCase()];if(!i)return"none";const r=i.layout;return null!=(t=null==r?void 0:r.visibility)?t:"visible"}_recomputeZValues(){const e=this.layers,t=1/(e.length+1);for(let i=0;i<e.length;i++)e[i].z=1-(1+i)*t}_identifyRefLayers(){const e=[],t=[];let i=0;for(const n of this.layers){const a=n.layout;if(1===n.type){var r;const t=n;let s=n.source+"|"+n.sourceLayer;s+=null!=(r="|"+(null==a?void 0:a.visibility))?r:"",s+="|"+n.minzoom,s+="|"+n.maxzoom,s+="|"+JSON.stringify(n.filter),(t.hasDataDrivenFill||t.hasDataDrivenOutline)&&(s+="|"+i),e.push({key:s,layer:n})}else if(2===n.type){var s;const e=n;let r=n.source+"|"+n.sourceLayer;r+=null!=(s="|"+(null==a?void 0:a.visibility))?s:"",r+="|"+n.minzoom,r+="|"+n.maxzoom,r+="|"+JSON.stringify(n.filter),r+="|"+(void 0!==a?a["line-cap"]:""),r+="|"+(void 0!==a?a["line-join"]:""),e.hasDataDrivenLine&&(r+="|"+i),t.push({key:r,layer:n})}++i}this._assignRefLayers(e),this._assignRefLayers(t)}_assignRefLayers(e){let t,i;e.sort(((e,t)=>e.key<t.key?-1:e.key>t.key?1:0));const r=e.length;for(let s=0;s<r;s++){const n=e[s];if(n.key===t)n.layer.refLayerId=i;else if(t=n.key,i=n.layer.id,1===n.layer.type){if(!n.layer.getPaintProperty("fill-outline-color"))for(let a=s+1;a<r;a++){const r=e[a];if(r.key!==t)break;if(r.layer.getPaintProperty("fill-outline-color")){e[s]=r,e[a]=n,i=r.layer.id;break}}}else if(2===n.layer.type){let a=n.layer;for(let o=s+1;o<r;o++){const r=e[o];if(r.key!==t)break;const l=r.layer;(a.canUseThinTessellation&&!l.canUseThinTessellation||!a.canUseThinTessellation&&(l.getPaintProperty("line-pattern")||l.getPaintProperty("line-dasharray")))&&(a=l,e[s]=r,e[o]=n,i=r.layer.id)}}}}_create(e,t,i){const r=1-(1+t)*(1/(i.length+1)),s=this._runningId++;switch(e.type){case"background":return new Pe(0,e,r,s);case"fill":return new Le(1,e,r,s);case"line":return new De(2,e,r,s);case"symbol":return new Ne(3,e,r,s);case"raster":throw new Error("Unsupported vector tile raster layer");case"circle":return new Oe(4,e,r,s)}throw new Error("Unknown vector tile layer")}static _recreateLayer(e,t){switch(e.type){case"background":return new Pe(0,e,t.z,t.uid);case"fill":return new Le(1,e,t.z,t.uid);case"line":return new De(2,e,t.z,t.uid);case"symbol":return new Ne(3,e,t.z,t.uid);case"raster":throw new Error("Unsupported vector tile raster layer");case"circle":return new Oe(4,e,t.z,t.uid)}}}},22064:(e,t,i)=>{"use strict";i.d(t,{Q:()=>G,f:()=>q,y:()=>F});var r=i(78155),s=i(80987),n=i(20215),a=i(43194),o=i(88903),l=i(80219),h=i(4169),u=i(98548),c=i(92858),d=i(13895),p=i(40130),f=i(18559),y=i(82906),m=(i(34396),i(94449)),g=i(81135),_=i(32769),x=i(62121),v=i(79506),b=i(20736),w=i(71666),S=i(47365),I=i(2502),C=i(78435),M=i(18143),T=i(99987),E=i(15120);const F=e=>{let t=class extends e{constructor(){super(...arguments),this.capabilities=void 0,this.copyright=null,this.fullExtent=null,this.legendEnabled=!0,this.spatialReference=null,this.version=null}readCapabilities(e,t){const i=t.capabilities&&t.capabilities.split(",").map((e=>e.toLowerCase().trim()));if(!i)return{operations:{supportsQuery:!1,supportsExportMap:!1,supportsExportTiles:!1,supportsTileMap:!1},exportMap:null,exportTiles:null};const r=this.type,s=-1!==i.indexOf("query"),n=-1!==i.indexOf("map"),o=!!t.exportTilesAllowed,l=-1!==i.indexOf("tilemap"),h="tile"!==r&&!!t.supportsDynamicLayers,u="tile"!==r&&(!t.tileInfo||h),c="tile"!==r&&(!t.tileInfo||h),d="tile"!==r,p=!!t.cimVersion&&a.r.parse(t.cimVersion).since(1,4);return{operations:{supportsQuery:s,supportsExportMap:n,supportsExportTiles:o,supportsTileMap:l},exportMap:n?{supportsArcadeExpressionForLabeling:p,supportsSublayersChanges:d,supportsDynamicLayers:h,supportsSublayerVisibility:u,supportsSublayerDefinitionExpression:c}:null,exportTiles:o?{maxExportTilesCount:+t.maxExportTilesCount}:null}}readVersion(e,t){let i=t.currentVersion;return i||(i=t.hasOwnProperty("capabilities")||t.hasOwnProperty("tables")?10:t.hasOwnProperty("supportedImageFormatTypes")?9.31:9.3),i}async fetchSublayerInfo(e,t){return await this.fetchAllLayersAndTables(t),this._allLayersAndTablesMap.get(e)}async fetchAllLayersAndTables(e){await this.load(e),this._allLayersAndTablesPromise||(this._allLayersAndTablesPromise=(0,s.L)((0,s.U)(this.url).path+"/layers",{responseType:"json",query:{f:"json",...this.customParameters,token:this.apiKey}}).then((e=>{this._allLayersAndTablesMap=new Map;for(const t of e.data.layers)this._allLayersAndTablesMap.set(t.id,t);return{result:e.data}}),(e=>({error:e}))));const t=await this._allLayersAndTablesPromise;if((0,n.a)(e),"result"in t)return t.result;throw t.error}};return(0,r.e)([(0,o.y)({readOnly:!0})],t.prototype,"capabilities",void 0),(0,r.e)([(0,h.e)("service","capabilities",["capabilities","exportTilesAllowed","maxExportTilesCount","supportsDynamicLayers","tileInfo"])],t.prototype,"readCapabilities",null),(0,r.e)([(0,o.y)({json:{read:{source:"copyrightText"}}})],t.prototype,"copyright",void 0),(0,r.e)([(0,o.y)({type:u.M})],t.prototype,"fullExtent",void 0),(0,r.e)([(0,o.y)(d.g)],t.prototype,"id",void 0),(0,r.e)([(0,o.y)({type:Boolean,json:{origins:{service:{read:{enabled:!1}}},read:{source:"showLegend"},write:{target:"showLegend"}}})],t.prototype,"legendEnabled",void 0),(0,r.e)([(0,o.y)(d.s)],t.prototype,"popupEnabled",void 0),(0,r.e)([(0,o.y)({type:c.k})],t.prototype,"spatialReference",void 0),(0,r.e)([(0,o.y)()],t.prototype,"version",void 0),(0,r.e)([(0,h.e)("version",["currentVersion","capabilities","tables","supportedImageFormatTypes"])],t.prototype,"readVersion",null),t=(0,r.e)([(0,o.n)("esri.layers.mixins.ArcGISMapService")],t),t};var A;function R(e){return e&&"esriSMS"===e.type}function P(e,t,i){var s;const n=this.originIdOf(t)>=(0,r.t)(i.origin);return{ignoreOrigin:!0,allowNull:n,enabled:!!i&&"map-image"===(null==(s=i.layer)?void 0:s.type)&&(i.writeSublayerStructure||n)}}function L(e,t,i){var r;return{enabled:!!i&&"tile"===(null==(r=i.layer)?void 0:r.type)&&this._isOverridden(t)}}function D(e,t,i){return{ignoreOrigin:!0,enabled:i&&i.writeSublayerStructure||!1}}function N(e,t,i){return{ignoreOrigin:!0,enabled:!!i&&(i.writeSublayerStructure||this.originIdOf(t)>=(0,r.t)(i.origin))}}const O=l.n.getLogger("esri.layers.support.Sublayer");let k=0;const V=new Set;V.add("layer"),V.add("parent"),V.add("loaded"),V.add("loadStatus"),V.add("loadError"),V.add("loadWarnings");let U=A=class extends((0,_.a)((0,v.l)((0,x.r)(s.f)))){constructor(e){super(e),this.capabilities=void 0,this.fields=null,this.fullExtent=null,this.globalIdField=null,this.legendEnabled=!0,this.objectIdField=null,this.popupEnabled=!0,this.popupTemplate=null,this.sourceJSON=null,this.title=null,this.typeIdField=null,this.types=null}async load(e){return this.addResolvingPromise((async()=>{var t;if(!this.layer&&!this.url)throw new n.s("sublayer:missing-layer","Sublayer can't be loaded without being part of a layer",{sublayer:this});let i=null;if(!this.layer||this.originIdOf("url")>2||"data-layer"===(null==(t=this.source)?void 0:t.type))i=(await(0,s.L)(this.url,{responseType:"json",query:{f:"json"},...e})).data;else{var r;let t=this.id;"map-layer"===(null==(r=this.source)?void 0:r.type)&&(t=this.source.mapLayerId),i=await this.layer.fetchSublayerInfo(t,e)}i&&(this.sourceJSON=i,this.read({layerDefinition:i},{origin:"service"}))})()),this}readCapabilities(e,t){const i=(e=(t=t.layerDefinition||t).capabilities||e)?e.toLowerCase().split(",").map((e=>e.trim())):[];return{exportMap:{supportsModification:!!t.canModifyLayer},operations:{supportsQuery:-1!==i.indexOf("query")}}}set definitionExpression(e){this._setAndNotifyLayer("definitionExpression",e)}get fieldsIndex(){return new I.e(this.fields||[])}readGlobalIdFieldFromService(e,t){if((t=t.layerDefinition||t).globalIdField)return t.globalIdField;if(t.fields)for(const e of t.fields)if("esriFieldTypeGlobalID"===e.type)return e.name}get id(){const e=this._get("id");return null==e?k++:e}set id(e){this._get("id")!==e&&(!1!==this.get("layer.capabilities.exportMap.supportsDynamicLayers")?this._set("id",e):this._logLockedError("id","capability not available 'layer.capabilities.exportMap.supportsDynamicLayers'"))}set labelingInfo(e){this._setAndNotifyLayer("labelingInfo",e)}writeLabelingInfo(e,t,i,r){e&&e.length&&(t.layerDefinition={drawingInfo:{labelingInfo:e.map((e=>e.write({},r)))}})}set labelsVisible(e){this._setAndNotifyLayer("labelsVisible",e)}set layer(e){this._set("layer",e),this.sublayers&&this.sublayers.forEach((t=>t.layer=e))}set listMode(e){this._set("listMode",e)}set minScale(e){this._setAndNotifyLayer("minScale",e)}readMinScale(e,t){return t.minScale||t.layerDefinition&&t.layerDefinition.minScale||0}set maxScale(e){this._setAndNotifyLayer("maxScale",e)}readMaxScale(e,t){return t.maxScale||t.layerDefinition&&t.layerDefinition.maxScale||0}readObjectIdFieldFromService(e,t){if((t=t.layerDefinition||t).objectIdField)return t.objectIdField;if(t.fields)for(const e of t.fields)if("esriFieldTypeOID"===e.type)return e.name}set opacity(e){this._setAndNotifyLayer("opacity",e)}readOpacity(e,t){const i=t.layerDefinition;return 1-.01*(null!=i.transparency?i.transparency:i.drawingInfo.transparency)}writeOpacity(e,t,i,r){t.layerDefinition={drawingInfo:{transparency:100-100*e}}}writeParent(e,t){this.parent&&this.parent!==this.layer?t.parentLayerId=(0,o.C)(this.parent.id):t.parentLayerId=-1}get defaultPopupTemplate(){return this.createPopupTemplate()}set renderer(e){if(e)for(const t of e.getSymbols())if((0,g.c)(t)){O.warn("Sublayer renderer should use 2D symbols");break}this._setAndNotifyLayer("renderer",e)}get source(){return this._get("source")||new M.c({mapLayerId:this.id})}set source(e){this._setAndNotifyLayer("source",e)}set sublayers(e){this._handleSublayersChange(e,this._get("sublayers")),this._set("sublayers",e)}castSublayers(e){return(0,o.d)(p.L.ofType(A),e)}writeSublayers(e,t,i){this.get("sublayers.length")&&(t[i]=this.sublayers.map((e=>e.id)).toArray().reverse())}readTypeIdField(e,t){let i=(t=t.layerDefinition||t).typeIdField;if(i&&t.fields){i=i.toLowerCase();const e=t.fields.find((e=>e.name.toLowerCase()===i));e&&(i=e.name)}return null}get url(){var e,t;const i=null!=(e=null==(t=this.layer)?void 0:t.parsedUrl)?e:this._lastParsedUrl,r=this.source;if(!i)return null;if(this._lastParsedUrl=i,"map-layer"===(null==r?void 0:r.type))return`${i.path}/${r.mapLayerId}`;const n={layer:JSON.stringify({source:this.source})};return`${i.path}/dynamicLayer?${(0,s.C)(n)}`}set url(e){e?this._override("url",e):this._clearOverride("url")}set visible(e){this._setAndNotifyLayer("visible",e)}writeVisible(e,t,i,r){t[i]=this.getAtOrigin("defaultVisibility","service")||e}clone(){const{store:e}=(0,o.e)(this),t=new A;return(0,o.e)(t).store=e.clone(V),this.commitProperty("url"),t._lastParsedUrl=this._lastParsedUrl,t}createPopupTemplate(e){return(0,T.a)(this,e)}createQuery(){return new M.b({returnGeometry:!0,where:this.definitionExpression||"1=1"})}async createFeatureLayer(){var e,t;if(this.hasOwnProperty("sublayers"))return null;const r=null==(e=this.layer)?void 0:e.parsedUrl,s=new((await Promise.resolve().then(i.bind(i,16040)).then((function(e){return e.F}))).default)({url:r.path});return r&&this.source&&("map-layer"===this.source.type?s.layerId=this.source.mapLayerId:s.dynamicDataSource=this.source),null!=this.layer.refreshInterval&&(s.refreshInterval=this.layer.refreshInterval),this.definitionExpression&&(s.definitionExpression=this.definitionExpression),this.originIdOf("labelingInfo")>2&&(s.labelingInfo=(0,l.y)(this.labelingInfo)),this.originIdOf("labelsVisible")>0&&(s.labelsVisible=this.labelsVisible),this.originIdOf("legendEnabled")>0&&(s.legendEnabled=this.legendEnabled),this.originIdOf("visible")>0&&(s.visible=this.visible),this.originIdOf("minScale")>0&&(s.minScale=this.minScale),this.originIdOf("maxScale")>0&&(s.maxScale=this.maxScale),this.originIdOf("opacity")>0&&(s.opacity=this.opacity),this.originIdOf("popupTemplate")>0&&(s.popupTemplate=(0,l.y)(this.popupTemplate)),this.originIdOf("renderer")>2&&(s.renderer=(0,l.y)(this.renderer)),"data-layer"===(null==(t=this.source)?void 0:t.type)&&(s.dynamicDataSource=this.source.clone()),this.originIdOf("title")>0&&(s.title=this.title),"map-image"===this.layer.type&&this.layer.originIdOf("customParameters")>0&&(s.customParameters=this.layer.customParameters),"tile"===this.layer.type&&this.layer.originIdOf("customParameters")>0&&(s.customParameters=this.layer.customParameters),s}getFeatureType(e){const{typeIdField:t,types:i}=this;if(!t||!e)return null;const r=e.attributes?e.attributes[t]:void 0;if(null==r)return null;let s=null;return i.some((e=>{const{id:t}=e;return null!=t&&(t.toString()===r.toString()&&(s=e),!!s)})),s}getFieldDomain(e,t){const i=t&&t.feature,r=this.getFeatureType(i);if(r){const t=r.domains&&r.domains[e];if(t&&"inherited"!==t.type)return t}return this._getLayerDomain(e)}async queryFeatures(e=this.createQuery(),t){var r,s,a,o;if(await this.load(),!this.get("capabilities.operations.supportsQuery"))throw new n.s("Sublayer.queryFeatures","this layer doesn't support queries.");const[{executeQuery:l},{default:h}]=await Promise.all([Promise.resolve().then(i.bind(i,85570)).then((function(e){return e.q})),Promise.resolve().then(i.bind(i,52737))]),u=await l(this.url,M.b.from(e),null!=(r=null==(s=this.layer)?void 0:s.spatialReference)?r:null,{...t,query:{...null==(a=this.layer)?void 0:a.customParameters,token:null==(o=this.layer)?void 0:o.apiKey}}),c=h.fromJSON(u.data);if(null!=c&&c.features)for(const e of c.features)e.sourceLayer=this;return c}toExportImageJSON(){var e;const t={id:this.id,source:(null==(e=this.source)?void 0:e.toJSON())||{mapLayerId:this.id,type:"mapLayer"}};this.definitionExpression&&(t.definitionExpression=this.definitionExpression);const i=["renderer","labelingInfo","opacity","labelsVisible"].reduce(((e,t)=>(e[t]=this.originIdOf(t),e)),{});if(Object.keys(i).some((e=>i[e]>2))){const e=t.drawingInfo={};i.renderer>2&&(e.renderer=this.renderer?this.renderer.toJSON():null),i.labelsVisible>2&&(e.showLabels=this.labelsVisible),this.labelsVisible&&i.labelingInfo>2&&(e.labelingInfo=this.labelingInfo?this.labelingInfo.map((e=>e.write({},{origin:"service",layer:this.layer}))):null,e.showLabels=!0),i.opacity>2&&(e.transparency=100-100*this.opacity),this._assignDefaultSymbolColors(e.renderer)}return t}_assignDefaultSymbolColors(e){this._forEachSimpleMarkerSymbols(e,(e=>{e.color||"esriSMSX"!==e.style&&"esriSMSCross"!==e.style||(e.outline&&e.outline.color?e.color=e.outline.color:e.color=[0,0,0,0])}))}_forEachSimpleMarkerSymbols(e,t){if(e){const i="uniqueValueInfos"in e?e.uniqueValueInfos:"classBreakInfos"in e?e.classBreakInfos:[];for(const e of i)R(e.symbol)&&t(e.symbol);"symbol"in e&&R(e.symbol)&&t(e.symbol),"defaultSymbol"in e&&R(e.defaultSymbol)&&t(e.defaultSymbol)}}_setAndNotifyLayer(e,t){const i=this.layer,r=this._get(e);let s,n;switch(e){case"definitionExpression":s="supportsSublayerDefinitionExpression";case"minScale":case"maxScale":case"visible":s="supportsSublayerVisibility";break;case"labelingInfo":case"labelsVisible":case"opacity":case"renderer":case"source":s="supportsDynamicLayers",n="supportsModification"}const a=(0,o.e)(this).getDefaultOrigin();if("service"!==a){if(s&&!1===this.get(`layer.capabilities.exportMap.${s}`))return void this._logLockedError(e,`capability not available 'layer.capabilities.exportMap.${s}'`);if(n&&!1===this.get(`capabilities.exportMap.${n}`))return void this._logLockedError(e,`capability not available 'capabilities.exportMap.${n}'`)}"source"!==e||"not-loaded"===this.loadStatus?(this._set(e,t),"service"!==a&&r!==t&&i&&i.emit&&i.emit("sublayer-update",{propertyName:e,target:this})):this._logLockedError(e,"'source' can't be changed after calling sublayer.load()")}_handleSublayersChange(e,t){t&&(t.forEach((e=>{e.parent=null,e.layer=null})),this.handles.removeAll()),e&&(e.forEach((e=>{e.parent=this,e.layer=this.layer})),this.handles.add([e.on("after-add",(({item:e})=>{e.parent=this,e.layer=this.layer})),e.on("after-remove",(({item:e})=>{e.parent=null,e.layer=null})),e.on("before-changes",(e=>{const t=this.get("layer.capabilities.exportMap.supportsSublayersChanges");null==t||t||(O.error(new n.s("sublayer:sublayers-non-modifiable","Sublayer can't be added, moved, or removed from the layer's sublayers",{sublayer:this,layer:this.layer})),e.preventDefault())}))]))}_logLockedError(e,t){O.error(new n.s("sublayer:locked",`Property '${e}' can't be changed on Sublayer from the layer '${this.layer.id}'`,{reason:t,sublayer:this,layer:this.layer}))}_getLayerDomain(e){const t=this.fieldsIndex.get(e);return t?t.domain:null}};U.test={isMapImageLayerOverridePolicy:e=>e===D||e===P,isTileImageLayerOverridePolicy:e=>e===L},(0,r.e)([(0,o.y)({readOnly:!0})],U.prototype,"capabilities",void 0),(0,r.e)([(0,h.e)("service","capabilities",["layerDefinition.canModifyLayer","layerDefinition.capabilities"])],U.prototype,"readCapabilities",null),(0,r.e)([(0,o.y)({type:String,value:null,json:{name:"layerDefinition.definitionExpression",write:{overridePolicy:P}}})],U.prototype,"definitionExpression",null),(0,r.e)([(0,o.y)({type:[S.y],json:{origins:{service:{read:{source:"layerDefinition.fields"}}}}})],U.prototype,"fields",void 0),(0,r.e)([(0,o.y)({readOnly:!0})],U.prototype,"fieldsIndex",null),(0,r.e)([(0,o.y)({type:u.M,json:{read:{source:"layerDefinition.extent"}}})],U.prototype,"fullExtent",void 0),(0,r.e)([(0,o.y)({type:String})],U.prototype,"globalIdField",void 0),(0,r.e)([(0,h.e)("service","globalIdField",["layerDefinition.globalIdField","layerDefinition.fields"])],U.prototype,"readGlobalIdFieldFromService",null),(0,r.e)([(0,o.y)({type:o.N,json:{write:{ignoreOrigin:!0}}})],U.prototype,"id",null),(0,r.e)([(0,o.y)({value:null,type:[C.E],json:{read:{source:"layerDefinition.drawingInfo.labelingInfo"},write:{target:"layerDefinition.drawingInfo.labelingInfo",overridePolicy:D}}})],U.prototype,"labelingInfo",null),(0,r.e)([(0,r.o)("labelingInfo")],U.prototype,"writeLabelingInfo",null),(0,r.e)([(0,o.y)({type:Boolean,value:!0,json:{read:{source:"layerDefinition.drawingInfo.showLabels"},write:{target:"layerDefinition.drawingInfo.showLabels",overridePolicy:D}}})],U.prototype,"labelsVisible",null),(0,r.e)([(0,o.y)({value:null})],U.prototype,"layer",null),(0,r.e)([(0,o.y)({type:Boolean,value:!0,json:{origins:{service:{read:{enabled:!1}}},read:{source:"showLegend"},write:{target:"showLegend",overridePolicy:N}}})],U.prototype,"legendEnabled",void 0),(0,r.e)([(0,o.y)({type:["show","hide","hide-children"],value:"show",json:{read:!1,write:!1,origins:{"web-scene":{read:!0,write:!0}}}})],U.prototype,"listMode",null),(0,r.e)([(0,o.y)({type:Number,value:0,json:{write:{overridePolicy:D}}})],U.prototype,"minScale",null),(0,r.e)([(0,h.e)("minScale",["minScale","layerDefinition.minScale"])],U.prototype,"readMinScale",null),(0,r.e)([(0,o.y)({type:Number,value:0,json:{write:{overridePolicy:D}}})],U.prototype,"maxScale",null),(0,r.e)([(0,h.e)("maxScale",["maxScale","layerDefinition.maxScale"])],U.prototype,"readMaxScale",null),(0,r.e)([(0,o.y)({type:String})],U.prototype,"objectIdField",void 0),(0,r.e)([(0,h.e)("service","objectIdField",["layerDefinition.objectIdField","layerDefinition.fields"])],U.prototype,"readObjectIdFieldFromService",null),(0,r.e)([(0,o.y)({type:Number,value:1,json:{write:{target:"layerDefinition.drawingInfo.transparency",overridePolicy:D}}})],U.prototype,"opacity",null),(0,r.e)([(0,h.e)("opacity",["layerDefinition.drawingInfo.transparency","layerDefinition.transparency"])],U.prototype,"readOpacity",null),(0,r.e)([(0,r.o)("opacity")],U.prototype,"writeOpacity",null),(0,r.e)([(0,o.y)({json:{type:o.N,write:{target:"parentLayerId",allowNull:!0,overridePolicy:D}}})],U.prototype,"parent",void 0),(0,r.e)([(0,r.o)("parent")],U.prototype,"writeParent",null),(0,r.e)([(0,o.y)({type:Boolean,value:!0,json:{read:{source:"disablePopup",reader:(e,t)=>!t.disablePopup},write:{target:"disablePopup",overridePolicy:N,writer(e,t,i){t[i]=!e}}}})],U.prototype,"popupEnabled",void 0),(0,r.e)([(0,o.y)({type:y.M,json:{read:{source:"popupInfo"},write:{target:"popupInfo",overridePolicy:N}}})],U.prototype,"popupTemplate",void 0),(0,r.e)([(0,o.y)({readOnly:!0})],U.prototype,"defaultPopupTemplate",null),(0,r.e)([(0,o.y)({types:m.a,value:null,json:{name:"layerDefinition.drawingInfo.renderer",write:{overridePolicy:D},origins:{"web-scene":{types:m.n,name:"layerDefinition.drawingInfo.renderer",write:{overridePolicy:D}}}}})],U.prototype,"renderer",null),(0,r.e)([(0,o.y)({types:{key:"type",base:null,typeMap:{"data-layer":M.K,"map-layer":M.c}},cast(e){if(e){if("mapLayerId"in e)return(0,o.B)(M.c,e);if("dataSource"in e)return(0,o.B)(M.K,e)}return e},json:{name:"layerDefinition.source",write:{overridePolicy:D}}})],U.prototype,"source",null),(0,r.e)([(0,o.y)()],U.prototype,"sourceJSON",void 0),(0,r.e)([(0,o.y)({value:null,json:{type:[o.N],write:{target:"subLayerIds",allowNull:!0,overridePolicy:D}}})],U.prototype,"sublayers",null),(0,r.e)([(0,b.c)("sublayers")],U.prototype,"castSublayers",null),(0,r.e)([(0,r.o)("sublayers")],U.prototype,"writeSublayers",null),(0,r.e)([(0,o.y)({type:String,json:{read:{source:"name"},write:{target:"name",allowNull:!0,overridePolicy:N}}})],U.prototype,"title",void 0),(0,r.e)([(0,o.y)({type:String})],U.prototype,"typeIdField",void 0),(0,r.e)([(0,h.e)("typeIdField",["layerDefinition.typeIdField"])],U.prototype,"readTypeIdField",null),(0,r.e)([(0,o.y)({type:[w.d],json:{origins:{service:{read:{source:"layerDefinition.types"}}}}})],U.prototype,"types",void 0),(0,r.e)([(0,o.y)({type:String,json:{read:{source:"layerUrl"},write:{target:"layerUrl",overridePolicy:L}}})],U.prototype,"url",null),(0,r.e)([(0,o.y)({type:Boolean,value:!0,json:{read:{source:"defaultVisibility"},write:{target:"defaultVisibility",overridePolicy:D}}})],U.prototype,"visible",null),(0,r.e)([(0,r.o)("visible")],U.prototype,"writeVisible",null),U=A=(0,r.e)([(0,o.n)("esri.layers.support.Sublayer")],U);var G=U;const z=l.n.getLogger("esri.layers.TileLayer"),B=p.L.ofType(G);function j(e,t){e&&e.forEach((e=>{t(e),e.sublayers&&e.sublayers.length&&j(e.sublayers,t)}))}const q=e=>{let t=class extends e{constructor(...e){super(...e),this.allSublayers=new f.p({getCollections:()=>[this.sublayers],getChildrenFunction:e=>e.sublayers}),this.sublayersSourceJSON={2:{},3:{},4:{},5:{}},this.handles.add(this.watch("sublayers",((e,t)=>this._handleSublayersChange(e,t)),!0))}readSublayers(e,t){if(!t||!e)return;const{sublayersSourceJSON:i}=this,s=(0,r.t)(t.origin);if(s<2)return;if(i[s]={context:t,visibleLayers:e.visibleLayers||i[s].visibleLayers,layers:e.layers||i[s].layers},s>2)return;this._set("serviceSublayers",this.createSublayersForOrigin("service").sublayers);const{sublayers:n,origin:a}=this.createSublayersForOrigin("web-document"),l=(0,o.e)(this);l.setDefaultOrigin(a),this._set("sublayers",new B(n)),l.setDefaultOrigin("user")}findSublayerById(e){return this.allSublayers.find((t=>t.id===e))}createServiceSublayers(){return this.createSublayersForOrigin("service").sublayers}createSublayersForOrigin(e){const t=(0,r.t)("web-document"===e?"web-map":e);let i=2,s=this.sublayersSourceJSON[2].layers,n=this.sublayersSourceJSON[2].context,a=null;const o=[3,4,5].filter((e=>e<=t));for(const e of o){const t=this.sublayersSourceJSON[e];(0,E.i)(t.layers)&&(i=e,s=t.layers,n=t.context,t.visibleLayers&&(a={visibleLayers:t.visibleLayers,context:t.context}))}const l=[3,4,5].filter((e=>e>i&&e<=t));let h=null;for(const e of l){const{layers:t,visibleLayers:i,context:r}=this.sublayersSourceJSON[e];t&&(h={layers:t,context:r}),i&&(a={visibleLayers:i,context:r})}const u=function(e,t){const i=[],r={};return e?(e.forEach((e=>{const s=new G;if(s.read(e,t),r[s.id]=s,null!=e.parentLayerId&&-1!==e.parentLayerId){const t=r[e.parentLayerId];t.sublayers||(t.sublayers=[]),t.sublayers.unshift(s)}else i.unshift(s)})),i):i}(s,n),c=new Map,d=new Set;if(h)for(const e of h.layers)c.set(e.id,e);if(a)for(const e of a.visibleLayers)d.add(e);return j(u,(e=>{h&&e.read(c.get(e.id),h.context),a&&e.read({defaultVisibility:d.has(e.id)},a.context)})),{origin:(0,r.n)(i),sublayers:new B({items:u})}}read(e,t){super.read(e,t),this.readSublayers(e,t)}_handleSublayersChange(e,t){t&&(t.forEach((e=>{e.parent=null,e.layer=null})),this.handles.remove("sublayers-owner")),e&&(e.forEach((e=>{e.parent=this,e.layer=this})),this.handles.add([e.on("after-add",(({item:e})=>{e.parent=this,e.layer=this})),e.on("after-remove",(({item:e})=>{e.parent=null,e.layer=null}))],"sublayers-owner"),"tile"===this.type&&this.handles.add(e.on("before-changes",(e=>{z.error(new n.s("tilelayer:sublayers-non-modifiable","ISublayer can't be added, moved, or removed from the layer's sublayers",{layer:this})),e.preventDefault()})),"sublayers-owner"))}};return(0,r.e)([(0,o.y)({readOnly:!0})],t.prototype,"allSublayers",void 0),(0,r.e)([(0,o.y)({readOnly:!0,type:p.L.ofType(G)})],t.prototype,"serviceSublayers",void 0),(0,r.e)([(0,o.y)({value:null,type:B,json:{read:!1,write:{allowNull:!0,ignoreOrigin:!0}}})],t.prototype,"sublayers",void 0),(0,r.e)([(0,o.y)({readOnly:!0})],t.prototype,"sublayersSourceJSON",void 0),t=(0,r.e)([(0,o.n)("esri.layers.mixins.SublayersOwner")],t),t}},78185:(e,t,i)=>{"use strict";i.d(t,{a:()=>R,f:()=>F,i:()=>L,n:()=>C,o:()=>M,r:()=>N}),i(33807);var r=i(80987),s=i(80219),n=i(39068),a=i(20215),o=i(26779),l=(i(93875),i(14215)),h=i(15541),u=i(91507),c=i(50388),d=i(36542),p=i(29218),f=i(71391),y=i(87682),m=i(6660);class g{constructor(e,t){this._width=0,this._height=0,this._free=[],this._width=e,this._height=t,this._free.push(new h.t(0,0,e,t))}get width(){return this._width}get height(){return this._height}allocate(e,t){if(e>this._width||t>this._height)return new h.t;let i=null,r=-1;for(let s=0;s<this._free.length;++s){const n=this._free[s];e<=n.width&&t<=n.height&&(null===i||n.y<=i.y&&n.x<=i.x)&&(i=n,r=s)}return null===i?new h.t:(this._free.splice(r,1),i.width<i.height?(i.width>e&&this._free.push(new h.t(i.x+e,i.y,i.width-e,t)),i.height>t&&this._free.push(new h.t(i.x,i.y+t,i.width,i.height-t))):(i.width>e&&this._free.push(new h.t(i.x+e,i.y,i.width-e,i.height)),i.height>t&&this._free.push(new h.t(i.x,i.y+t,e,i.height-t))),new h.t(i.x,i.y,e,t))}release(e){for(let t=0;t<this._free.length;++t){const i=this._free[t];if(i.y===e.y&&i.height===e.height&&i.x+i.width===e.x)i.width+=e.width;else if(i.x===e.x&&i.width===e.width&&i.y+i.height===e.y)i.height+=e.height;else if(e.y===i.y&&e.height===i.height&&e.x+e.width===i.x)i.x=e.x,i.width+=e.width;else{if(e.x!==i.x||e.width!==i.width||e.y+e.height!==i.y)continue;i.y=e.y,i.height+=e.height}this._free.splice(t,1),this.release(e)}this._free.push(e)}}class _{constructor(e,t,i){this.width=0,this.height=0,this._dirties=[],this._glyphData=[],this._currentPage=0,this._glyphIndex={},this._textures=[],this._rangePromises=new Map,this.width=e,this.height=t,this._glyphSource=i,this._binPack=new g(e-4,t-4),this._glyphData.push(new Uint8Array(e*t)),this._dirties.push(!0),this._textures.push(void 0)}getGlyphItems(e,t){const i=[],r=this._glyphSource,s=new Set;for(const e of t){const t=Math.floor(.00390625*e);s.add(t)}const n=[];return s.forEach((t=>{if(t<=256){const i=e+t;if(this._rangePromises.has(i))n.push(this._rangePromises.get(i));else{const s=r.getRange(e,t).then((()=>{this._rangePromises.delete(i)}),(()=>{this._rangePromises.delete(i)}));this._rangePromises.set(i,s),n.push(s)}}})),Promise.all(n).then((()=>{let s=this._glyphIndex[e];s||(s={},this._glyphIndex[e]=s);for(const n of t){const t=s[n];if(t){i[n]={sdf:!0,rect:t.rect,metrics:t.metrics,page:t.page,code:n};continue}const a=r.getGlyph(e,n);if(!a||!a.metrics)continue;const o=a.metrics;let l;if(0===o.width)l=new h.t(0,0,0,0);else{const e=3,t=o.width+2*e,i=o.height+2*e;let r=t%4?4-t%4:4,s=i%4?4-i%4:4;1===r&&(r=5),1===s&&(s=5),l=this._binPack.allocate(t+r,i+s),l.isEmpty&&(this._dirties[this._currentPage]||(this._glyphData[this._currentPage]=null),this._currentPage=this._glyphData.length,this._glyphData.push(new Uint8Array(this.width*this.height)),this._dirties.push(!0),this._textures.push(void 0),this._binPack=new g(this.width-4,this.height-4),l=this._binPack.allocate(t+r,i+s));const n=this._glyphData[this._currentPage],h=a.bitmap;let u,c;if(h)for(let e=0;e<i;e++){u=t*e,c=this.width*(l.y+e+1)+l.x;for(let e=0;e<t;e++)n[c+e+1]=h[u+e]}}s[n]={rect:l,metrics:o,tileIDs:null,page:this._currentPage},i[n]={sdf:!0,rect:l,metrics:o,page:this._currentPage,code:n},this._dirties[this._currentPage]=!0}return i}))}removeGlyphs(e){for(const t in this._glyphIndex){const i=this._glyphIndex[t];if(!i)continue;let r;for(const t in i)if(r=i[t],r.tileIDs.delete(e),0===r.tileIDs.size){const e=this._glyphData[r.page],s=r.rect;let n,a;for(let t=0;t<s.height;t++)for(n=this.width*(s.y+t)+s.x,a=0;a<s.width;a++)e[n+a]=0;delete i[t],this._dirties[r.page]=!0}}}bind(e,t,i,r=0){this._textures[i]||(this._textures[i]=new l.r(e,{pixelFormat:6406,dataType:5121,width:this.width,height:this.height},new Uint8Array(this.width*this.height)));const s=this._textures[i];s.setSamplingMode(t),this._dirties[i]&&s.setData(this._glyphData[i]),e.bindTexture(s,r),this._dirties[i]=!1}dispose(){this._binPack=null;for(const e of this._textures)e&&e.dispose();this._textures.length=0}}class x{constructor(e){if(this._metrics=[],this._bitmaps=[],e)for(;e.next();)switch(e.tag()){case 1:{const t=e.getMessage();for(;t.next();)switch(t.tag()){case 3:{const e=t.getMessage();let i,r,s,n,a,o,l;for(;e.next();)switch(e.tag()){case 1:i=e.getUInt32();break;case 2:r=e.getBytes();break;case 3:s=e.getUInt32();break;case 4:n=e.getUInt32();break;case 5:a=e.getSInt32();break;case 6:o=e.getSInt32();break;case 7:l=e.getUInt32();break;default:e.skip()}e.release(),i&&(this._metrics[i]={width:s,height:n,left:a,top:o,advance:l},this._bitmaps[i]=r);break}default:t.skip()}t.release();break}default:e.skip()}}getMetrics(e){return this._metrics[e]}getBitmap(e){return this._bitmaps[e]}}class v{constructor(){this._ranges=[]}getRange(e){return this._ranges[e]}addRange(e,t){this._ranges[e]=t}}class b{constructor(e){this._glyphInfo={},this._baseURL=e}getRange(e,t){const i=this._getFontStack(e);if(i.getRange(t))return Promise.resolve();const s=256*t,n=s+255,a=this._baseURL.replace("{fontstack}",e).replace("{range}",s+"-"+n);return(0,r.L)(a,{responseType:"array-buffer"}).then((e=>{i.addRange(t,new x(new u.n(new Uint8Array(e.data),new DataView(e.data))))})).catch((()=>{i.addRange(t,new x)}))}getGlyph(e,t){const i=this._getFontStack(e);if(!i)return;const r=Math.floor(t/256);if(r>256)return;const s=i.getRange(r);return s?{metrics:s.getMetrics(t),bitmap:s.getBitmap(t)}:void 0}_getFontStack(e){let t=this._glyphInfo[e];return t||(t=this._glyphInfo[e]=new v),t}}class w{constructor(e,t,i=0){this._size=[],this._mosaicsData=[],this._textures=[],this._dirties=[],this._maxItemSize=0,this._currentPage=0,this._pageWidth=0,this._pageHeight=0,this._mosaicRects={},this.pixelRatio=1,(e<=0||t<=0)&&console.error("Sprites mosaic defaultWidth and defaultHeight must be greater than zero!"),this._pageWidth=e,this._pageHeight=t,i>0&&(this._maxItemSize=i),this._binPack=new g(e-4,t-4)}dispose(){this._binPack=null,this._mosaicRects={};for(const e of this._textures)e&&e.dispose();this._textures.length=0}getWidth(e){return e>=this._size.length?-1:this._size[e][0]}getHeight(e){return e>=this._size.length?-1:this._size[e][1]}getPageSize(e){return e>=this._size.length?null:this._size[e]}setSpriteSource(e){if(this.dispose(),this.pixelRatio=e.devicePixelRatio,0===this._mosaicsData.length){this._binPack=new g(this._pageWidth-4,this._pageHeight-4);const e=Math.floor(this._pageWidth),t=Math.floor(this._pageHeight),i=new Uint32Array(e*t);this._mosaicsData[0]=i,this._dirties.push(!0),this._size.push([this._pageWidth,this._pageHeight]),this._textures.push(void 0)}this._sprites=e}getSpriteItem(e,t=!1){let i,r,s=this._mosaicRects[e];if(s)return s;if(!this._sprites||"loaded"!==this._sprites.loadStatus)return null;if(e&&e.startsWith("dasharray-")?([i,r]=this._rasterizeDash(e),t=!0):i=this._sprites.getSpriteInfo(e),!i||!i.width||!i.height||i.width<0||i.height<0)return null;const n=i.width,a=i.height,[o,l,h]=this._allocateImage(n,a);return o.width<=0?null:(this._copy(o,i,l,h,t,r),s={rect:o,width:n,height:a,sdf:i.sdf,simplePattern:!1,pixelRatio:i.pixelRatio,page:l},this._mosaicRects[e]=s,s)}getSpriteItems(e){const t={};for(const i of e)t[i.name]=this.getSpriteItem(i.name,i.repeat);return t}getMosaicItemPosition(e,t){const i=this.getSpriteItem(e,t),r=i&&i.rect;if(!r)return null;r.width=i.width,r.height=i.height;const s=i.width,n=i.height;return{tl:[r.x+2,r.y+2],br:[r.x+2+s,r.y+2+n],page:i.page}}bind(e,t,i=0,r=0){this._textures[i]||(this._textures[i]=new l.r(e,{pixelFormat:6408,dataType:5121,wrapMode:33071,width:this._size[i][0],height:this._size[i][1]},new Uint8Array(this._mosaicsData[i].buffer)));const s=this._textures[i];s.setSamplingMode(t),this._dirties[i]&&s.setData(new Uint8Array(this._mosaicsData[i].buffer)),e.bindTexture(s,r),this._dirties[i]=!1}static _copyBits(e,t,i,r,s,n,a,o,l,h,u){let c=r*t+i,d=o*n+a;if(u){d-=n;for(let a=-1;a<=h;a++,c=((a+h)%h+r)*t+i,d+=n)for(let t=-1;t<=l;t++)s[d+t]=e[c+(t+l)%l]}else for(let i=0;i<h;i++){for(let t=0;t<l;t++)s[d+t]=e[c+t];c+=t,d+=n}}_copy(e,t,i,r,s,n){if(!this._sprites||"loaded"!==this._sprites.loadStatus||i>=this._mosaicsData.length)return;const a=new Uint32Array(n?n.buffer:this._sprites.image.buffer),o=this._mosaicsData[i];o&&a||console.error("Source or target images are uninitialized!");const l=n?t.width:this._sprites.width;w._copyBits(a,l,t.x,t.y,o,r[0],e.x+2,e.y+2,t.width,t.height,s),this._dirties[i]=!0}_allocateImage(e,t){e+=2,t+=2;const i=Math.max(e,t);if(this._maxItemSize&&this._maxItemSize<i){const i=new h.t(0,0,e,t);return this._mosaicsData.push(new Uint32Array(e*t)),this._dirties.push(!0),this._size.push([e,t]),this._textures.push(void 0),[i,this._mosaicsData.length-1,[e,t]]}let r=e%4?4-e%4:4,s=t%4?4-t%4:4;1===r&&(r=5),1===s&&(s=5);const n=this._binPack.allocate(e+r,t+s);return n.width<=0?(this._dirties[this._currentPage]||(this._mosaicsData[this._currentPage]=null),this._currentPage=this._mosaicsData.length,this._mosaicsData.push(new Uint32Array(this._pageWidth*this._pageHeight)),this._dirties.push(!0),this._size.push([this._pageWidth,this._pageHeight]),this._textures.push(void 0),this._binPack=new g(this._pageWidth-4,this._pageHeight-4),this._allocateImage(e,t)):[n,this._currentPage,[this._pageWidth,this._pageHeight]]}_rasterizeDash(e){const t=e.match(/\[(.*?)\]/);if(!t)return null;const i=t[1].split(",").map(Number),r=e.slice(e.lastIndexOf("-")+1),[s,n,a]=c.b.rasterizeDash(i,r);return[{x:0,y:0,width:n,height:a,sdf:!0,pixelRatio:1},new Uint8Array(s.buffer)]}}function S(e,t,i,r,s,n){e.fillStyle=t,e.fillRect(i,r,s,n)}function I(e,t,i,r,s,n){e.strokeStyle=t,e.strokeRect(i,r,s,n)}function C(e,t){e.strokeStyle="black";const i=t.cellSize,r=t.rows,s=t.columns;for(let n=0;n<r;n++){const r=t.cells[n],a=n*i,o=(n+1)*i;for(let t=0;t<s;t++){const s=r[t],n=t*i,l=(t+1)*i;e.strokeRect(n,a,l-n,o-a),e.fillText(`cells:${s.length}`,n+4,a+12)}}}function M(e,t){const i=window.COLLISION_XRAY;for(let r=0;r<t.length;++r){const s=!t[r].unique.show;if(i||!s)for(const n of t[r].colliders){if(!n.enabled)continue;const a=!t[r].unique.parts[n.partIndex].show;if(!i&&a)continue;const o=n.xScreen,l=n.yScreen,h=n.dxScreen,u=n.dyScreen;e.globalAlpha=s||a?.2:1,S(e,"green",o-1,l-1,3,3),I(e,"red",o+h,l+u,n.width,n.height),S(e,"blue",o+h-1,l+u-1,3,3),e.globalAlpha=1}}}const T=new n.e(10),E=new Map;class F{constructor(e,t,i){this._vectorTileLayer=e,this._styleRepository=t,this.devicePixelRatio=i,this._spriteMosaic=null,this._glyphMosaic=null,this._connection=null}destroy(){this._connection&&(this._connection.close(),this._connection=null),this._styleRepository=null,this._vectorTileLayer=null,this._spriteMosaic&&(this._spriteMosaic=null),this._glyphMosaic&&(this._glyphMosaic=null)}get spriteMosaic(){return this._spriteSourcePromise.then((()=>this._spriteMosaic))}get glyphMosaic(){return this._glyphMosaic}async start(e){const t=this._vectorTileLayer,i=t.sourceNameToSource,r=[];for(const t in i)r.push(this._fetchTileMap(i[t],e));this._spriteSourcePromise=this._vectorTileLayer.loadSpriteSource(this.devicePixelRatio,e),this._spriteSourcePromise.then((e=>{this._spriteMosaic=new w(1024,1024,250),this._spriteMosaic.setSpriteSource(e)}));const n=this._styleRepository,a=new b(n.glyphs);return this._glyphMosaic=new _(1024,1024,a),this._broadcastPromise=(0,o.p)("WorkerTileHandler",{client:this,schedule:e.schedule,signal:e.signal}).then((i=>(this._connection=i,Promise.all(this._connection.broadcast("setStyle",{style:t.currentStyleInfo.style,vectorTileLayerMaxBuffers:(0,s.c)("vectortilelayer-max-buffers")},e))))),Promise.all(r)}async updateStyle(e){return await this._broadcastPromise,this._broadcastPromise=new Promise(((t,i)=>{Promise.all(this._connection.broadcast("updateStyle",e)).then(t,i)})),this._broadcastPromise}async setStyle(e,t){await this._broadcastPromise,this._styleRepository=e;const i=this._vectorTileLayer.sourceNameToSource,r=[];for(const e in i)r.push(this._fetchTileMap(i[e],null));this._spriteSourcePromise=this._vectorTileLayer.loadSpriteSource(this.devicePixelRatio,null),this._spriteSourcePromise.then((e=>{this._spriteMosaic=new w(1024,1024,250),this._spriteMosaic.setSpriteSource(e)}));const n=new b(e.glyphs);return this._glyphMosaic=new _(1024,1024,n),this._broadcastPromise=new Promise(((e,i)=>{Promise.all(this._connection.broadcast("setStyle",{style:t,vectorTileLayerMaxBuffers:(0,s.c)("vectortilelayer-max-buffers")})).then(e,i)})),r.push(this._broadcastPromise),Promise.all(r)}fetchTileData(e,t){return this._getRefKeys(e,t).then((e=>{const i=this._vectorTileLayer.sourceNameToSource,r=[];for(const e in i)r.push(e);return this._getSourcesData(r,e,t)}))}parseTileData(e,t){const i=e&&e.data;if(!i)return Promise.resolve(null);const{sourceName2DataAndRefKey:r,transferList:s}=i;return 0===Object.keys(r).length?Promise.resolve(null):this._broadcastPromise.then((()=>this._connection.getAvailableClient().then((i=>i.invoke("createTileAndParse",{key:e.key.id,sourceName2DataAndRefKey:r,styleLayerUIDs:e.styleLayerUIDs},{...t,transferList:s}).then((e=>({tileData:e})))))))}async getSprites(e){return await this._spriteSourcePromise,this._spriteMosaic.getSpriteItems(e)}getGlyphs(e){return this._glyphMosaic.getGlyphItems(e.font,e.codePoints)}perfReport({key:e,milliseconds:t}){!function(e,t,i){if(!window.PERFORMANCE_RECORDING_STORAGE)return;const r=window.PERFORMANCE_RECORDING_STORAGE;r.perf=r.perf||{};const s=r.perf;s[e]=s[e]||{start:null,time:0,min:void 0,max:void 0,samples:[],unit:"ms"},s[e].time+=t,s[e].samples.push(t),(null==s[e].min||t<s[e].min)&&(s[e].min=t),(null==s[e].max||t>s[e].max)&&(s[e].max=t)}(e,t)}async _getTilePayload(e,t,i){const r=p.e.pool.acquire(e.id),s=this._vectorTileLayer.sourceNameToSource[t].getSourceTileUrl(r.level,r.row,r.col);p.e.pool.release(r);try{return{protobuff:await this.request(s,i),sourceName:t}}catch(e){if((0,a.g)(e))throw e;return{protobuff:null,sourceName:t}}}request(e,t){return(0,r.L)(e,{responseType:"array-buffer",...t}).then((({data:e})=>e))}async _fetchTileMap(e,t){if(e.capabilities.operations.supportsTileMap&&e.tileIndex)return Promise.resolve();if(!e.tileMapURL)return;const i=T.get(e.tileMapURL);if(i)return void(e.tileIndex=i);let s;if(E.has(e.tileMapURL)){try{s=await E.get(e.tileMapURL),e.tileIndex=new d.r(s.data)}catch(e){if((0,a.g)(e))throw e}return}const n=(0,r.L)(e.tileMapURL,t);E.set(e.tileMapURL,n);try{s=await n,E.delete(e.tileMapURL),T.put(e.tileMapURL,e.tileIndex),e.tileIndex=new d.r(s.data)}catch(t){if(E.delete(e.tileMapURL),(0,a.g)(t))throw t}}_getRefKeys(e,t){const i=this._vectorTileLayer.sourceNameToSource,r=new Array;for(const s in i){const n=i[s].getRefKey(e,t);r.push(n)}return(0,a.A)(r)}_getSourcesData(e,t,i){const r=[];for(let s=0;s<t.length;s++)if(null==t[s].value||null==e[s])r.push(null);else{const n=this._getTilePayload(t[s].value,e[s],i);r.push(n)}return(0,a.A)(r).then((e=>{const i={},r=[];for(let s=0;s<e.length;s++)if(e[s].value&&e[s].value&&e[s].value.protobuff&&e[s].value.protobuff.byteLength>0){const n=t[s].value.id;i[e[s].value.sourceName]={refKey:n,protobuff:e[s].value.protobuff},r.push(e[s].value.protobuff)}return{sourceName2DataAndRefKey:i,transferList:r}}))}}function A(e,t,i,r,s,n){const{iconRotationAlignment:a,textRotationAlignment:o,iconTranslate:l,iconTranslateAnchor:h,textTranslate:u,textTranslateAnchor:c}=r;let d=0;for(const r of e.colliders){const[e,p]=0===r.partIndex?l:u,f=0===r.partIndex?h:c,y=r.minLod<=n&&n<=r.maxLod;d+=y?0:1,r.enabled=y,r.xScreen=r.xTile*s[0]+r.yTile*s[3]+s[6],r.yScreen=r.xTile*s[1]+r.yTile*s[4]+s[7],0===f?(r.xScreen+=i*e-t*p,r.yScreen+=t*e+i*p):(r.xScreen+=e,r.yScreen+=p),1===(0===r.partIndex?a:o)?(r.dxScreen=r.dxPixels,r.dyScreen=r.dyPixels):(r.dxScreen=i*(r.dxPixels+r.width/2)-t*(r.dyPixels+r.height/2)-r.width/2,r.dyScreen=t*(r.dxPixels+r.width/2)+i*(r.dyPixels+r.height/2)-r.height/2)}e.colliders.length>0&&d===e.colliders.length&&(e.unique.show=!1)}class R{constructor(e,t,i,r,s,n){this._symbols=e,this._styleRepository=r,this._zoom=s,this._currentLayerCursor=0,this._currentSymbolCursor=0,this._styleProps=new Map,this._allNeededMatrices=new Map,this._gridIndex=new m.o(t,i,y.t),this._si=Math.sin(Math.PI*n/180),this._co=Math.cos(Math.PI*n/180);for(const t of e)for(const e of t.symbols)this._allNeededMatrices.has(e.tile)||this._allNeededMatrices.set(e.tile,(0,f.a1)(e.tile.transforms.tileUnitsToPixels))}work(e){const t=this._gridIndex;function i(e){const i=e.xScreen+e.dxScreen,r=e.yScreen+e.dyScreen,s=i+e.width,n=r+e.height,[a,o,l,h]=t.getCellSpan(i,r,s,n);for(let e=o;e<=h;e++)for(let o=a;o<=l;o++){const a=t.cells[e][o];for(const e of a){const t=e.xScreen+e.dxScreen,a=e.yScreen+e.dyScreen,o=t+e.width,l=a+e.height;if(!(s<t||i>o||n<a||r>l))return!0}}return!1}const r=performance.now();for(;this._currentLayerCursor<this._symbols.length;this._currentLayerCursor++,this._currentSymbolCursor=0){const t=this._symbols[this._currentLayerCursor],s=this._getProperties(t.styleLayerUID);for(;this._currentSymbolCursor<t.symbols.length;this._currentSymbolCursor++){if(this._currentSymbolCursor%100==99&&performance.now()-r>e)return!1;const n=t.symbols[this._currentSymbolCursor];if(!n.unique.show)continue;A(n,this._si,this._co,s,this._allNeededMatrices.get(n.tile),this._zoom);const a=n.unique;if(!a.show)continue;const{iconAllowOverlap:o,iconIgnorePlacement:l,textAllowOverlap:h,textIgnorePlacement:u}=s;for(const e of n.colliders){if(!e.enabled)continue;const t=a.parts[e.partIndex];t.show&&!(e.partIndex?h:o)&&i(e)&&(e.hard?a.show=!1:t.show=!1)}if(a.show)for(const e of n.colliders){if(!e.enabled)continue;if(e.partIndex?u:l)continue;if(!a.parts[e.partIndex].show)continue;const t=e.xScreen+e.dxScreen,i=e.yScreen+e.dyScreen,r=t+e.width,s=i+e.height,[n,o,h,c]=this._gridIndex.getCellSpan(t,i,r,s);for(let t=o;t<=c;t++)for(let i=n;i<=h;i++)this._gridIndex.cells[t][i].push(e)}}}return!0}_getProperties(e){const t=this._styleProps.get(e);if(t)return t;const i=this._zoom,r=this._styleRepository.getStyleLayerByUID(e),s=0!==r.getLayoutValue("symbol-placement",i);let n=r.getLayoutValue("icon-rotation-alignment",i);2===n&&(n=s?0:1);let a=r.getLayoutValue("text-rotation-alignment",i);2===a&&(a=s?0:1);const o=r.getPaintValue("icon-translate",i),l=r.getPaintValue("icon-translate-anchor",i),h=r.getPaintValue("text-translate",i),u=r.getPaintValue("text-translate-anchor",i),c={iconAllowOverlap:r.getLayoutValue("icon-allow-overlap",i),iconIgnorePlacement:r.getLayoutValue("icon-ignore-placement",i),textAllowOverlap:r.getLayoutValue("text-allow-overlap",i),textIgnorePlacement:r.getLayoutValue("text-ignore-placement",i),iconRotationAlignment:n,textRotationAlignment:a,iconTranslateAnchor:l,iconTranslate:o,textTranslateAnchor:u,textTranslate:h};return this._styleProps.set(e,c),c}}function P(e,t){if(e.priority-t.priority)return e.priority-t.priority;const i=e.tile.key,r=t.tile.key;return i.world-r.world?i.world-r.world:i.level-r.level?i.level-r.level:i.row-r.row?i.row-r.row:i.col-r.col?i.col-r.col:e.xTile-t.xTile?e.xTile-t.xTile:e.yTile-t.yTile}class L{constructor(e,t,i,r,s,n){this._visibleTiles=e,this._symbolRepository=t,this._createCollisionJob=i,this._assignTileSymbolsOpacity=r,this._symbolLayerSorter=s,this._isLayerVisible=n,this._selectionJob=null,this._selectionJobCompleted=!1,this._collisionJob=null,this._collisionJobCompleted=!1,this._opacityJob=null,this._opacityJobCompleted=!1,this._running=!0}get running(){return this._running}setScreenSize(e,t){this._screenWidth===e&&this._screenHeight===t||this.restart(),this._screenWidth=e,this._screenHeight=t}restart(){this._selectionJob=null,this._selectionJobCompleted=!1,this._collisionJob=null,this._collisionJobCompleted=!1,this._opacityJob=null,this._opacityJobCompleted=!1,this._running=!0}continue(e){if(this._selectionJob||(this._selectionJob=this._createSelectionJob()),!this._selectionJobCompleted){const t=performance.now();if(!this._selectionJob.work(e))return!1;if(this._selectionJobCompleted=!0,0===(e=Math.max(0,e-(performance.now()-t))))return!1}if(this._collisionJob||(this._collisionJob=this._createCollisionJob(this._selectionJob.sortedSymbols,this._screenWidth,this._screenHeight)),!this._collisionJobCompleted){const t=performance.now();if(!this._collisionJob.work(e))return!1;if(this._collisionJobCompleted=!0,0===(e=Math.max(0,e-(performance.now()-t))))return!1}if(this._opacityJob||(this._opacityJob=this._createOpacityJob()),!this._opacityJobCompleted){const t=performance.now();if(!this._opacityJob.work(e))return!1;if(this._opacityJobCompleted=!0,0===(e=Math.max(0,e-(performance.now()-t))))return!1}return this._running=!1,!0}_createSelectionJob(){const e=this._symbolRepository.uniqueSymbols,t=[];let i=0,r=0;const s=this._isLayerVisible,n=this._symbolLayerSorter;return{work:function(n){let a;const o=performance.now();for(;r<e.length;r++,i=0){const l=e[r],h=l.styleLayerUID;if(!s(h)){t[r]||(t[r]={styleLayerUID:h,symbols:[]});continue}t[r]=t[r]||{styleLayerUID:h,symbols:[]};const u=t[r];for(;i<l.uniqueSymbols.length;i++){if(a=l.uniqueSymbols[i],i%100==99&&performance.now()-o>n)return!1;let e=null,t=!1,r=!1;for(const i of a.tileSymbols)if(i.selectedForRendering=!1,!r||!t){const s=i.tile;(!e||s.isCoverage||s.neededForCoverage&&!t)&&(e=i,(s.neededForCoverage||s.isCoverage)&&(r=!0),s.isCoverage&&(t=!0))}if(e.selectedForRendering=!0,r){u.symbols.push(e),a.show=!0;for(const e of a.parts)e.show=!0}else a.show=!1}}for(const e of t)e.symbols.sort(P);return!0},get sortedSymbols(){return t.sort(n)}}}_createOpacityJob(){const e=this._assignTileSymbolsOpacity,t=this._visibleTiles;let i=0;function r(t,i){const s=t.symbols;for(const[e,t]of s)D(t,i);e(t,i);for(const e of t.childrenTiles)r(e,i)}return{work(e){const n=performance.now();for(;i<t.length;i++){if(performance.now()-n>e)return!1;const a=t[i];(0,s.r)(a.parentTile)||r(a,performance.now())}return!0}}}}function D(e,t){for(const i of e){const e=i.unique;for(const i of e.parts){const r=i.targetOpacity>.5?1:-1;i.startOpacity+=r*((t-i.startTime)/y.e),i.startOpacity=Math.min(Math.max(i.startOpacity,0),1),i.startTime=t,i.targetOpacity=e.show&&i.show?1:0}}}class N{constructor(e,t,i){this.tileCoordRange=e,this._visibleTiles=t,this._createUnique=i,this._tiles=new Map,this._uniqueSymbolsReferences=new Map}get uniqueSymbols(){return(0,s.t)(this._uniqueSymbolLayerArray)&&(this._uniqueSymbolLayerArray=this._createUniqueSymbolLayerArray()),this._uniqueSymbolLayerArray}add(e,t){this._uniqueSymbolLayerArray=null;let i=this._tiles.get(e.id);i||(i={symbols:new Map},this._tiles.set(e.id,i));const r=new Map;if(t)for(const e of t)i.symbols.has(e)&&(r.set(e,i.symbols.get(e)),i.symbols.delete(e));else for(const[t,s]of e.layerData)i.symbols.has(t)&&(r.set(t,i.symbols.get(t)),i.symbols.delete(t));this._removeSymbols(r);const s=e.symbols,n=new Map;for(const[e,t]of s){let r=t.length;if(r>=32){let s=this.tileCoordRange;do{s/=2,r/=4}while(r>8&&s>64);const a=new m.o(this.tileCoordRange,this.tileCoordRange,s);n.set(e,{flat:t,index:a}),i.symbols.set(e,{flat:t,index:a});for(const e of t)a.getCell(e.xTile,e.yTile).push(e)}else n.set(e,{flat:t}),i.symbols.set(e,{flat:t})}this._addSymbols(e.key,s)}deleteStyleLayers(e){this._uniqueSymbolLayerArray=null;for(const[t,i]of this._tiles){const r=new Map;for(const t of e)i.symbols.has(t)&&(r.set(t,i.symbols.get(t)),i.symbols.delete(t));this._removeSymbols(r),0===i.symbols.size&&this._tiles.delete(t)}}removeTile(e){this._uniqueSymbolLayerArray=null;const t=this._tiles.get(e.id);if(!t)return;const i=new Map;for(const[r,s]of e.symbols)t.symbols.has(r)&&(i.set(r,t.symbols.get(r)),t.symbols.delete(r));this._removeSymbols(i),0===t.symbols.size&&this._tiles.delete(e.id)}_removeSymbols(e){for(const[t,{flat:i}]of e)for(const e of i){const i=e.unique,r=i.tileSymbols,s=r.length-1;for(let t=0;t<s;t++)if(r[t]===e){r[t]=r[s];break}if(r.length=s,0===s){const e=this._uniqueSymbolsReferences.get(t);e.delete(i),0===e.size&&this._uniqueSymbolsReferences.delete(t)}e.unique=null}}_addSymbols(e,t){if(0===t.size)return;const i=this._visibleTiles;for(const r of i)r.parentTile||r.key.world!==e.world||r.key.level===e.level&&!r.key.equals(e)||this._matchSymbols(r,e,t);for(const[e,i]of t)for(const t of i)if((0,s.t)(t.unique)){const i=this._createUnique();t.unique=i,i.tileSymbols.push(t);let r=this._uniqueSymbolsReferences.get(e);r||(r=new Set,this._uniqueSymbolsReferences.set(e,r)),r.add(i)}}_matchSymbols(e,t,i){if(e.key.level>t.level){const i=e.key.level-t.level;if(e.key.row>>i!==t.row||e.key.col>>i!==t.col)return}if(t.level>e.key.level){const i=t.level-e.key.level;if(t.row>>i!==e.key.row||t.col>>i!==e.key.col)return}if(t.equals(e.key)){for(const r of e.childrenTiles)this._matchSymbols(r,t,i);return}const r=new Map;for(const[n,a]of i){const i=[];for(const r of a){const s=(0,m.l)(this.tileCoordRange,r.xTile,t.level,t.col,e.key.level,e.key.col),n=(0,m.l)(this.tileCoordRange,r.yTile,t.level,t.row,e.key.level,e.key.row);s>=0&&s<this.tileCoordRange&&n>=0&&n<this.tileCoordRange&&i.push({symbol:r,xTransformed:s,yTransformed:n})}const o=[],l=e.key.level<t.level?1:1<<e.key.level-t.level,h=this._tiles.get(e.id).symbols.get(n);if(h){const e=h.flat;for(const t of i){let i,r=!1;const n=t.xTransformed,a=t.yTransformed;i=(0,s.r)(h.index)?h.index.getCell(n,a):e;const u=t.symbol,c=u.hash;for(const e of i)if(c===e.hash&&Math.abs(n-e.xTile)<=l&&Math.abs(a-e.yTile)<=l){const t=e.unique;u.unique=t,t.tileSymbols.push(u),r=!0;break}r||o.push(u)}}o.length>0&&r.set(n,o)}for(const i of e.childrenTiles)this._matchSymbols(i,t,r)}_createUniqueSymbolLayerArray(){const e=this._uniqueSymbolsReferences,t=new Array(e.size);let i,r=0;for(const[s,n]of e){const e=new Array(n.size);i=0;for(const t of n)e[i++]=t;t[r]={styleLayerUID:s,uniqueSymbols:e},r++}return t}}},11107:(e,t,i)=>{"use strict";i.d(t,{a:()=>b,e:()=>I,n:()=>S,o:()=>c,t:()=>a});var r=i(80219),s=i(43356),n=i(2098);class a{constructor(e,t){this.x=e,this.y=t}clone(){return new a(this.x,this.y)}equals(e,t){return e===this.x&&t===this.y}isEqual(e){return e.x===this.x&&e.y===this.y}setCoords(e,t){this.x=e,this.y=t}normalize(){const e=this.x,t=this.y,i=Math.sqrt(e*e+t*t);this.x/=i,this.y/=i}rightPerpendicular(){const e=this.x;this.x=this.y,this.y=-e}move(e,t){this.x+=e,this.y+=t}assign(e){this.x=e.x,this.y=e.y}assignAdd(e,t){this.x=e.x+t.x,this.y=e.y+t.y}assignSub(e,t){this.x=e.x-t.x,this.y=e.y-t.y}rotate(e,t){const i=this.x,r=this.y;this.x=i*e-r*t,this.y=i*t+r*e}scale(e){this.x*=e,this.y*=e}length(){const e=this.x,t=this.y;return Math.sqrt(e*e+t*t)}static distance(e,t){const i=t.x-e.x,r=t.y-e.y;return Math.sqrt(i*i+r*r)}static add(e,t){return new a(e.x+t.x,e.y+t.y)}static sub(e,t){return new a(e.x-t.x,e.y-t.y)}}var o,l,h={exports:{}};o=h,void 0!==(l=function(){var e={DEBUG:!1,assert:function(t,i){if(e.DEBUG&&!t)throw new Error("Assertion failed"+(i?": "+i:""))},GLU_TESS_MAX_COORD:1e150,TRUE_PROJECT:!1,GLU_TESS_DEFAULT_TOLERANCE:0,windingRule:{GLU_TESS_WINDING_ODD:100130,GLU_TESS_WINDING_NONZERO:100131,GLU_TESS_WINDING_POSITIVE:100132,GLU_TESS_WINDING_NEGATIVE:100133,GLU_TESS_WINDING_ABS_GEQ_TWO:100134},primitiveType:{GL_LINE_LOOP:2,GL_TRIANGLES:4,GL_TRIANGLE_STRIP:5,GL_TRIANGLE_FAN:6},errorType:{GLU_TESS_MISSING_BEGIN_POLYGON:100151,GLU_TESS_MISSING_END_POLYGON:100153,GLU_TESS_MISSING_BEGIN_CONTOUR:100152,GLU_TESS_MISSING_END_CONTOUR:100154,GLU_TESS_COORD_TOO_LARGE:100155,GLU_TESS_NEED_COMBINE_CALLBACK:100156},gluEnum:{GLU_TESS_BEGIN:100100,GLU_TESS_VERTEX:100101,GLU_TESS_END:100102,GLU_TESS_ERROR:100103,GLU_TESS_EDGE_FLAG:100104,GLU_TESS_COMBINE:100105,GLU_TESS_BEGIN_DATA:100106,GLU_TESS_VERTEX_DATA:100107,GLU_TESS_END_DATA:100108,GLU_TESS_ERROR_DATA:100109,GLU_TESS_EDGE_FLAG_DATA:100110,GLU_TESS_COMBINE_DATA:100111,GLU_TESS_MESH:100112,GLU_TESS_TOLERANCE:100142,GLU_TESS_WINDING_RULE:100140,GLU_TESS_BOUNDARY_ONLY:100141,GLU_INVALID_ENUM:100900,GLU_INVALID_VALUE:100901},geom:{}};return e.geom.vertEq=function(e,t){return e.s===t.s&&e.t===t.t},e.geom.vertLeq=function(e,t){return e.s<t.s||e.s===t.s&&e.t<=t.t},e.geom.edgeEval=function(t,i,r){e.assert(e.geom.vertLeq(t,i)&&e.geom.vertLeq(i,r));var s=i.s-t.s,n=r.s-i.s;return s+n>0?s<n?i.t-t.t+(t.t-r.t)*(s/(s+n)):i.t-r.t+(r.t-t.t)*(n/(s+n)):0},e.geom.edgeSign=function(t,i,r){e.assert(e.geom.vertLeq(t,i)&&e.geom.vertLeq(i,r));var s=i.s-t.s,n=r.s-i.s;return s+n>0?(i.t-r.t)*s+(i.t-t.t)*n:0},e.geom.transLeq=function(e,t){return e.t<t.t||e.t===t.t&&e.s<=t.s},e.geom.transEval=function(t,i,r){e.assert(e.geom.transLeq(t,i)&&e.geom.transLeq(i,r));var s=i.t-t.t,n=r.t-i.t;return s+n>0?s<n?i.s-t.s+(t.s-r.s)*(s/(s+n)):i.s-r.s+(r.s-t.s)*(n/(s+n)):0},e.geom.transSign=function(t,i,r){e.assert(e.geom.transLeq(t,i)&&e.geom.transLeq(i,r));var s=i.t-t.t,n=r.t-i.t;return s+n>0?(i.s-r.s)*s+(i.s-t.s)*n:0},e.geom.edgeGoesLeft=function(t){return e.geom.vertLeq(t.dst(),t.org)},e.geom.edgeGoesRight=function(t){return e.geom.vertLeq(t.org,t.dst())},e.geom.vertL1dist=function(e,t){return Math.abs(e.s-t.s)+Math.abs(e.t-t.t)},e.geom.vertCCW=function(e,t,i){return e.s*(t.t-i.t)+t.s*(i.t-e.t)+i.s*(e.t-t.t)>=0},e.geom.interpolate_=function(e,t,i,r){return(e=e<0?0:e)<=(i=i<0?0:i)?0===i?(t+r)/2:t+e/(e+i)*(r-t):r+i/(e+i)*(t-r)},e.geom.edgeIntersect=function(t,i,r,s,n){var a,o,l;e.geom.vertLeq(t,i)||(l=t,t=i,i=l),e.geom.vertLeq(r,s)||(l=r,r=s,s=l),e.geom.vertLeq(t,r)||(l=t,t=r,r=l,l=i,i=s,s=l),e.geom.vertLeq(r,i)?e.geom.vertLeq(i,s)?((a=e.geom.edgeEval(t,r,i))+(o=e.geom.edgeEval(r,i,s))<0&&(a=-a,o=-o),n.s=e.geom.interpolate_(a,r.s,o,i.s)):((a=e.geom.edgeSign(t,r,i))+(o=-e.geom.edgeSign(t,s,i))<0&&(a=-a,o=-o),n.s=e.geom.interpolate_(a,r.s,o,s.s)):n.s=(r.s+i.s)/2,e.geom.transLeq(t,i)||(l=t,t=i,i=l),e.geom.transLeq(r,s)||(l=r,r=s,s=l),e.geom.transLeq(t,r)||(l=t,t=r,r=l,l=i,i=s,s=l),e.geom.transLeq(r,i)?e.geom.transLeq(i,s)?((a=e.geom.transEval(t,r,i))+(o=e.geom.transEval(r,i,s))<0&&(a=-a,o=-o),n.t=e.geom.interpolate_(a,r.t,o,i.t)):((a=e.geom.transSign(t,r,i))+(o=-e.geom.transSign(t,s,i))<0&&(a=-a,o=-o),n.t=e.geom.interpolate_(a,r.t,o,s.t)):n.t=(r.t+i.t)/2},e.mesh={},e.mesh.makeEdge=function(t){var i=e.mesh.makeEdgePair_(t.eHead);return e.mesh.makeVertex_(i,t.vHead),e.mesh.makeVertex_(i.sym,t.vHead),e.mesh.makeFace_(i,t.fHead),i},e.mesh.meshSplice=function(t,i){var r=!1,s=!1;t!==i&&(i.org!==t.org&&(s=!0,e.mesh.killVertex_(i.org,t.org)),i.lFace!==t.lFace&&(r=!0,e.mesh.killFace_(i.lFace,t.lFace)),e.mesh.splice_(i,t),s||(e.mesh.makeVertex_(i,t.org),t.org.anEdge=t),r||(e.mesh.makeFace_(i,t.lFace),t.lFace.anEdge=t))},e.mesh.deleteEdge=function(t){var i=t.sym,r=!1;t.lFace!==t.rFace()&&(r=!0,e.mesh.killFace_(t.lFace,t.rFace())),t.oNext===t?e.mesh.killVertex_(t.org,null):(t.rFace().anEdge=t.oPrev(),t.org.anEdge=t.oNext,e.mesh.splice_(t,t.oPrev()),r||e.mesh.makeFace_(t,t.lFace)),i.oNext===i?(e.mesh.killVertex_(i.org,null),e.mesh.killFace_(i.lFace,null)):(t.lFace.anEdge=i.oPrev(),i.org.anEdge=i.oNext,e.mesh.splice_(i,i.oPrev())),e.mesh.killEdge_(t)},e.mesh.addEdgeVertex=function(t){var i=e.mesh.makeEdgePair_(t),r=i.sym;return e.mesh.splice_(i,t.lNext),i.org=t.dst(),e.mesh.makeVertex_(r,i.org),i.lFace=r.lFace=t.lFace,i},e.mesh.splitEdge=function(t){var i=e.mesh.addEdgeVertex(t).sym;return e.mesh.splice_(t.sym,t.sym.oPrev()),e.mesh.splice_(t.sym,i),t.sym.org=i.org,i.dst().anEdge=i.sym,i.sym.lFace=t.rFace(),i.winding=t.winding,i.sym.winding=t.sym.winding,i},e.mesh.connect=function(t,i){var r=!1,s=e.mesh.makeEdgePair_(t),n=s.sym;return i.lFace!==t.lFace&&(r=!0,e.mesh.killFace_(i.lFace,t.lFace)),e.mesh.splice_(s,t.lNext),e.mesh.splice_(n,i),s.org=t.dst(),n.org=i.org,s.lFace=n.lFace=t.lFace,t.lFace.anEdge=n,r||e.mesh.makeFace_(s,t.lFace),s},e.mesh.zapFace=function(t){var i,r=t.anEdge,s=r.lNext;do{if(s=(i=s).lNext,i.lFace=null,null===i.rFace()){i.oNext===i?e.mesh.killVertex_(i.org,null):(i.org.anEdge=i.oNext,e.mesh.splice_(i,i.oPrev()));var n=i.sym;n.oNext===n?e.mesh.killVertex_(n.org,null):(n.org.anEdge=n.oNext,e.mesh.splice_(n,n.oPrev())),e.mesh.killEdge_(i)}}while(i!==r);var a=t.prev,o=t.next;o.prev=a,a.next=o},e.mesh.meshUnion=function(e,t){var i=e.fHead,r=e.vHead,s=e.eHead,n=t.fHead,a=t.vHead,o=t.eHead;return n.next!==n&&(i.prev.next=n.next,n.next.prev=i.prev,n.prev.next=i,i.prev=n.prev),a.next!==a&&(r.prev.next=a.next,a.next.prev=r.prev,a.prev.next=r,r.prev=a.prev),o.next!==o&&(s.sym.next.sym.next=o.next,o.next.sym.next=s.sym.next,o.sym.next.sym.next=s,s.sym.next=o.sym.next),e},e.mesh.deleteMesh=function(e){},e.mesh.makeEdgePair_=function(t){var i=new e.GluHalfEdge,r=new e.GluHalfEdge,s=t.sym.next;return r.next=s,s.sym.next=i,i.next=t,t.sym.next=r,i.sym=r,i.oNext=i,i.lNext=r,r.sym=i,r.oNext=r,r.lNext=i,i},e.mesh.splice_=function(e,t){var i=e.oNext,r=t.oNext;i.sym.lNext=t,r.sym.lNext=e,e.oNext=r,t.oNext=i},e.mesh.makeVertex_=function(t,i){var r=i.prev,s=new e.GluVertex(i,r);r.next=s,i.prev=s,s.anEdge=t;var n=t;do{n.org=s,n=n.oNext}while(n!==t)},e.mesh.makeFace_=function(t,i){var r=i.prev,s=new e.GluFace(i,r);r.next=s,i.prev=s,s.anEdge=t,s.inside=i.inside;var n=t;do{n.lFace=s,n=n.lNext}while(n!==t)},e.mesh.killEdge_=function(e){var t=e.next,i=e.sym.next;t.sym.next=i,i.sym.next=t},e.mesh.killVertex_=function(e,t){var i=e.anEdge,r=i;do{r.org=t,r=r.oNext}while(r!==i);var s=e.prev,n=e.next;n.prev=s,s.next=n},e.mesh.killFace_=function(e,t){var i=e.anEdge,r=i;do{r.lFace=t,r=r.lNext}while(r!==i);var s=e.prev,n=e.next;n.prev=s,s.next=n},e.normal={},e.normal.S_UNIT_X_=1,e.normal.S_UNIT_Y_=0,e.normal.projectPolygon=function(t,i,r,s){var n=!1,a=[i,r,s];0===i&&0===r&&0===s&&(e.normal.computeNormal_(t,a),n=!0);var o,l=e.normal.longAxis_(a),h=t.mesh.vHead;if(e.TRUE_PROJECT){e.normal.normalize_(a);var u=[0,0,0],c=[0,0,0];u[l]=0,u[(l+1)%3]=e.normal.S_UNIT_X_,u[(l+2)%3]=e.normal.S_UNIT_Y_;var d=e.normal.dot_(u,a);for(u[0]-=d*a[0],u[1]-=d*a[1],u[2]-=d*a[2],e.normal.normalize_(u),c[0]=a[1]*u[2]-a[2]*u[1],c[1]=a[2]*u[0]-a[0]*u[2],c[2]=a[0]*u[1]-a[1]*u[0],e.normal.normalize_(c),o=h.next;o!==h;o=o.next)o.s=e.normal.dot_(o.coords,u),o.t=e.normal.dot_(o.coords,c)}else{var p=(l+1)%3,f=(l+2)%3,y=a[l]>0?1:-1;for(o=h.next;o!==h;o=o.next)o.s=o.coords[p],o.t=y*o.coords[f]}n&&e.normal.checkOrientation_(t)},e.normal.dot_=function(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]},e.normal.normalize_=function(t){var i=t[0]*t[0]+t[1]*t[1]+t[2]*t[2];e.assert(i>0),i=Math.sqrt(i),t[0]/=i,t[1]/=i,t[2]/=i},e.normal.longAxis_=function(e){var t=0;return Math.abs(e[1])>Math.abs(e[0])&&(t=1),Math.abs(e[2])>Math.abs(e[t])&&(t=2),t},e.normal.computeNormal_=function(t,i){var r,s=[-2*e.GLU_TESS_MAX_COORD,-2*e.GLU_TESS_MAX_COORD,-2*e.GLU_TESS_MAX_COORD],n=[2*e.GLU_TESS_MAX_COORD,2*e.GLU_TESS_MAX_COORD,2*e.GLU_TESS_MAX_COORD],a=[],o=[],l=t.mesh.vHead;for(r=l.next;r!==l;r=r.next)for(var h=0;h<3;++h){var u=r.coords[h];u<n[h]&&(n[h]=u,o[h]=r),u>s[h]&&(s[h]=u,a[h]=r)}var c=0;if(s[1]-n[1]>s[0]-n[0]&&(c=1),s[2]-n[2]>s[c]-n[c]&&(c=2),n[c]>=s[c])return i[0]=0,i[1]=0,void(i[2]=1);var d=0,p=o[c],f=a[c],y=[0,0,0],m=[p.coords[0]-f.coords[0],p.coords[1]-f.coords[1],p.coords[2]-f.coords[2]],g=[0,0,0];for(r=l.next;r!==l;r=r.next){g[0]=r.coords[0]-f.coords[0],g[1]=r.coords[1]-f.coords[1],g[2]=r.coords[2]-f.coords[2],y[0]=m[1]*g[2]-m[2]*g[1],y[1]=m[2]*g[0]-m[0]*g[2],y[2]=m[0]*g[1]-m[1]*g[0];var _=y[0]*y[0]+y[1]*y[1]+y[2]*y[2];_>d&&(d=_,i[0]=y[0],i[1]=y[1],i[2]=y[2])}d<=0&&(i[0]=i[1]=i[2]=0,i[e.normal.longAxis_(m)]=1)},e.normal.checkOrientation_=function(e){for(var t=0,i=e.mesh.fHead,r=i.next;r!==i;r=r.next){var s=r.anEdge;if(!(s.winding<=0))do{t+=(s.org.s-s.dst().s)*(s.org.t+s.dst().t),s=s.lNext}while(s!==r.anEdge)}if(t<0)for(var n=e.mesh.vHead,a=n.next;a!==n;a=a.next)a.t=-a.t},e.render={},e.render.renderMesh=function(t,i,r){for(var s=!1,n=-1,a=i.fHead.prev;a!==i.fHead;a=a.prev)if(a.inside){s||(t.callBeginCallback(e.primitiveType.GL_TRIANGLES),s=!0);var o=a.anEdge;e.assert(o.lNext.lNext.lNext===o,"renderMesh called with non-triangulated mesh");do{if(r){var l=o.rFace().inside?0:1;n!==l&&(n=l,t.callEdgeFlagCallback(!!n))}t.callVertexCallback(o.org.data),o=o.lNext}while(o!==a.anEdge)}s&&t.callEndCallback()},e.render.renderBoundary=function(t,i){for(var r=i.fHead.next;r!==i.fHead;r=r.next)if(r.inside){t.callBeginCallback(e.primitiveType.GL_LINE_LOOP);var s=r.anEdge;do{t.callVertexCallback(s.org.data),s=s.lNext}while(s!==r.anEdge);t.callEndCallback()}},e.sweep={},e.sweep.SENTINEL_COORD_=4*e.GLU_TESS_MAX_COORD,e.sweep.TOLERANCE_NONZERO_=!1,e.sweep.computeInterior=function(t){var i;for(t.fatalError=!1,e.sweep.removeDegenerateEdges_(t),e.sweep.initPriorityQ_(t),e.sweep.initEdgeDict_(t);null!==(i=t.pq.extractMin());){for(;;){var r=t.pq.minimum();if(null===r||!e.geom.vertEq(r,i))break;r=t.pq.extractMin(),e.sweep.spliceMergeVertices_(t,i.anEdge,r.anEdge)}e.sweep.sweepEvent_(t,i)}var s=t.dict.getMin().getKey();t.event=s.eUp.org,e.sweep.doneEdgeDict_(t),e.sweep.donePriorityQ_(t),e.sweep.removeDegenerateFaces_(t.mesh),t.mesh.checkMesh()},e.sweep.addWinding_=function(e,t){e.winding+=t.winding,e.sym.winding+=t.sym.winding},e.sweep.edgeLeq_=function(t,i,r){var s=t.event,n=i.eUp,a=r.eUp;return n.dst()===s?a.dst()===s?e.geom.vertLeq(n.org,a.org)?e.geom.edgeSign(a.dst(),n.org,a.org)<=0:e.geom.edgeSign(n.dst(),a.org,n.org)>=0:e.geom.edgeSign(a.dst(),s,a.org)<=0:a.dst()===s?e.geom.edgeSign(n.dst(),s,n.org)>=0:e.geom.edgeEval(n.dst(),s,n.org)>=e.geom.edgeEval(a.dst(),s,a.org)},e.sweep.deleteRegion_=function(t,i){i.fixUpperEdge&&e.assert(0===i.eUp.winding),i.eUp.activeRegion=null,t.dict.deleteNode(i.nodeUp),i.nodeUp=null},e.sweep.fixUpperEdge_=function(t,i){e.assert(t.fixUpperEdge),e.mesh.deleteEdge(t.eUp),t.fixUpperEdge=!1,t.eUp=i,i.activeRegion=t},e.sweep.topLeftRegion_=function(t){var i=t.eUp.org;do{t=t.regionAbove()}while(t.eUp.org===i);if(t.fixUpperEdge){var r=e.mesh.connect(t.regionBelow().eUp.sym,t.eUp.lNext);e.sweep.fixUpperEdge_(t,r),t=t.regionAbove()}return t},e.sweep.topRightRegion_=function(e){var t=e.eUp.dst();do{e=e.regionAbove()}while(e.eUp.dst()===t);return e},e.sweep.addRegionBelow_=function(t,i,r){var s=new e.ActiveRegion;return s.eUp=r,s.nodeUp=t.dict.insertBefore(i.nodeUp,s),r.activeRegion=s,s},e.sweep.isWindingInside_=function(t,i){switch(t.windingRule){case e.windingRule.GLU_TESS_WINDING_ODD:return 0!=(1&i);case e.windingRule.GLU_TESS_WINDING_NONZERO:return 0!==i;case e.windingRule.GLU_TESS_WINDING_POSITIVE:return i>0;case e.windingRule.GLU_TESS_WINDING_NEGATIVE:return i<0;case e.windingRule.GLU_TESS_WINDING_ABS_GEQ_TWO:return i>=2||i<=-2}return e.assert(!1),!1},e.sweep.computeWinding_=function(t,i){i.windingNumber=i.regionAbove().windingNumber+i.eUp.winding,i.inside=e.sweep.isWindingInside_(t,i.windingNumber)},e.sweep.finishRegion_=function(t,i){var r=i.eUp,s=r.lFace;s.inside=i.inside,s.anEdge=r,e.sweep.deleteRegion_(t,i)},e.sweep.finishLeftRegions_=function(t,i,r){for(var s=i,n=i.eUp;s!==r;){s.fixUpperEdge=!1;var a=s.regionBelow(),o=a.eUp;if(o.org!==n.org){if(!a.fixUpperEdge){e.sweep.finishRegion_(t,s);break}o=e.mesh.connect(n.lPrev(),o.sym),e.sweep.fixUpperEdge_(a,o)}n.oNext!==o&&(e.mesh.meshSplice(o.oPrev(),o),e.mesh.meshSplice(n,o)),e.sweep.finishRegion_(t,s),n=a.eUp,s=a}return n},e.sweep.addRightEdges_=function(t,i,r,s,n,a){var o=!0,l=r;do{e.assert(e.geom.vertLeq(l.org,l.dst())),e.sweep.addRegionBelow_(t,i,l.sym),l=l.oNext}while(l!==s);null===n&&(n=i.regionBelow().eUp.rPrev());for(var h,u=i,c=n;(l=(h=u.regionBelow()).eUp.sym).org===c.org;)l.oNext!==c&&(e.mesh.meshSplice(l.oPrev(),l),e.mesh.meshSplice(c.oPrev(),l)),h.windingNumber=u.windingNumber-l.winding,h.inside=e.sweep.isWindingInside_(t,h.windingNumber),u.dirty=!0,!o&&e.sweep.checkForRightSplice_(t,u)&&(e.sweep.addWinding_(l,c),e.sweep.deleteRegion_(t,u),e.mesh.deleteEdge(c)),o=!1,u=h,c=l;u.dirty=!0,e.assert(u.windingNumber-l.winding===h.windingNumber),a&&e.sweep.walkDirtyRegions_(t,u)},e.sweep.callCombine_=function(t,i,r,s,n){var a=[i.coords[0],i.coords[1],i.coords[2]];i.data=null,i.data=t.callCombineCallback(a,r,s),null===i.data&&(n?t.fatalError||(t.callErrorCallback(e.errorType.GLU_TESS_NEED_COMBINE_CALLBACK),t.fatalError=!0):i.data=r[0])},e.sweep.spliceMergeVertices_=function(t,i,r){var s=[null,null,null,null];s[0]=i.org.data,s[1]=r.org.data,e.sweep.callCombine_(t,i.org,s,[.5,.5,0,0],!1),e.mesh.meshSplice(i,r)},e.sweep.vertexWeights_=function(t,i,r,s,n){var a=e.geom.vertL1dist(i,t),o=e.geom.vertL1dist(r,t),l=n,h=n+1;s[l]=.5*o/(a+o),s[h]=.5*a/(a+o),t.coords[0]+=s[l]*i.coords[0]+s[h]*r.coords[0],t.coords[1]+=s[l]*i.coords[1]+s[h]*r.coords[1],t.coords[2]+=s[l]*i.coords[2]+s[h]*r.coords[2]},e.sweep.getIntersectData_=function(t,i,r,s,n,a){var o=[0,0,0,0],l=[r.data,s.data,n.data,a.data];i.coords[0]=i.coords[1]=i.coords[2]=0,e.sweep.vertexWeights_(i,r,s,o,0),e.sweep.vertexWeights_(i,n,a,o,2),e.sweep.callCombine_(t,i,l,o,!0)},e.sweep.checkForRightSplice_=function(t,i){var r=i.regionBelow(),s=i.eUp,n=r.eUp;if(e.geom.vertLeq(s.org,n.org)){if(e.geom.edgeSign(n.dst(),s.org,n.org)>0)return!1;e.geom.vertEq(s.org,n.org)?s.org!==n.org&&(t.pq.remove(s.org.pqHandle),e.sweep.spliceMergeVertices_(t,n.oPrev(),s)):(e.mesh.splitEdge(n.sym),e.mesh.meshSplice(s,n.oPrev()),i.dirty=r.dirty=!0)}else{if(e.geom.edgeSign(s.dst(),n.org,s.org)<0)return!1;i.regionAbove().dirty=i.dirty=!0,e.mesh.splitEdge(s.sym),e.mesh.meshSplice(n.oPrev(),s)}return!0},e.sweep.checkForLeftSplice_=function(t,i){var r,s=i.regionBelow(),n=i.eUp,a=s.eUp;if(e.assert(!e.geom.vertEq(n.dst(),a.dst())),e.geom.vertLeq(n.dst(),a.dst())){if(e.geom.edgeSign(n.dst(),a.dst(),n.org)<0)return!1;i.regionAbove().dirty=i.dirty=!0,r=e.mesh.splitEdge(n),e.mesh.meshSplice(a.sym,r),r.lFace.inside=i.inside}else{if(e.geom.edgeSign(a.dst(),n.dst(),a.org)>0)return!1;i.dirty=s.dirty=!0,r=e.mesh.splitEdge(a),e.mesh.meshSplice(n.lNext,a.sym),r.rFace().inside=i.inside}return!0},e.sweep.checkForIntersect_=function(t,i){var r=i.regionBelow(),s=i.eUp,n=r.eUp,a=s.org,o=n.org,l=s.dst(),h=n.dst(),u=new e.GluVertex;if(e.assert(!e.geom.vertEq(h,l)),e.assert(e.geom.edgeSign(l,t.event,a)<=0),e.assert(e.geom.edgeSign(h,t.event,o)>=0),e.assert(a!==t.event&&o!==t.event),e.assert(!i.fixUpperEdge&&!r.fixUpperEdge),a===o)return!1;if(Math.min(a.t,l.t)>Math.max(o.t,h.t))return!1;if(e.geom.vertLeq(a,o)){if(e.geom.edgeSign(h,a,o)>0)return!1}else if(e.geom.edgeSign(l,o,a)<0)return!1;e.geom.edgeIntersect(l,a,h,o,u),e.assert(Math.min(a.t,l.t)<=u.t),e.assert(u.t<=Math.max(o.t,h.t)),e.assert(Math.min(h.s,l.s)<=u.s),e.assert(u.s<=Math.max(o.s,a.s)),e.geom.vertLeq(u,t.event)&&(u.s=t.event.s,u.t=t.event.t);var c=e.geom.vertLeq(a,o)?a:o;if(e.geom.vertLeq(c,u)&&(u.s=c.s,u.t=c.t),e.geom.vertEq(u,a)||e.geom.vertEq(u,o))return e.sweep.checkForRightSplice_(t,i),!1;if(!e.geom.vertEq(l,t.event)&&e.geom.edgeSign(l,t.event,u)>=0||!e.geom.vertEq(h,t.event)&&e.geom.edgeSign(h,t.event,u)<=0){if(h===t.event)return e.mesh.splitEdge(s.sym),e.mesh.meshSplice(n.sym,s),s=(i=e.sweep.topLeftRegion_(i)).regionBelow().eUp,e.sweep.finishLeftRegions_(t,i.regionBelow(),r),e.sweep.addRightEdges_(t,i,s.oPrev(),s,s,!0),!0;if(l===t.event){e.mesh.splitEdge(n.sym),e.mesh.meshSplice(s.lNext,n.oPrev()),r=i;var d=(i=e.sweep.topRightRegion_(i)).regionBelow().eUp.rPrev();return r.eUp=n.oPrev(),n=e.sweep.finishLeftRegions_(t,r,null),e.sweep.addRightEdges_(t,i,n.oNext,s.rPrev(),d,!0),!0}return e.geom.edgeSign(l,t.event,u)>=0&&(i.regionAbove().dirty=i.dirty=!0,e.mesh.splitEdge(s.sym),s.org.s=t.event.s,s.org.t=t.event.t),e.geom.edgeSign(h,t.event,u)<=0&&(i.dirty=r.dirty=!0,e.mesh.splitEdge(n.sym),n.org.s=t.event.s,n.org.t=t.event.t),!1}return e.mesh.splitEdge(s.sym),e.mesh.splitEdge(n.sym),e.mesh.meshSplice(n.oPrev(),s),s.org.s=u.s,s.org.t=u.t,s.org.pqHandle=t.pq.insert(s.org),e.sweep.getIntersectData_(t,s.org,a,l,o,h),i.regionAbove().dirty=i.dirty=r.dirty=!0,!1},e.sweep.walkDirtyRegions_=function(t,i){for(var r=i.regionBelow();;){for(;r.dirty;)i=r,r=r.regionBelow();if(!i.dirty&&(r=i,null===(i=i.regionAbove())||!i.dirty))return;i.dirty=!1;var s=i.eUp,n=r.eUp;if(s.dst()!==n.dst()&&e.sweep.checkForLeftSplice_(t,i)&&(r.fixUpperEdge?(e.sweep.deleteRegion_(t,r),e.mesh.deleteEdge(n),n=(r=i.regionBelow()).eUp):i.fixUpperEdge&&(e.sweep.deleteRegion_(t,i),e.mesh.deleteEdge(s),s=(i=r.regionAbove()).eUp)),s.org!==n.org)if(s.dst()===n.dst()||i.fixUpperEdge||r.fixUpperEdge||s.dst()!==t.event&&n.dst()!==t.event)e.sweep.checkForRightSplice_(t,i);else if(e.sweep.checkForIntersect_(t,i))return;s.org===n.org&&s.dst()===n.dst()&&(e.sweep.addWinding_(n,s),e.sweep.deleteRegion_(t,i),e.mesh.deleteEdge(s),i=r.regionAbove())}},e.sweep.connectRightVertex_=function(t,i,r){var s,n=r.oNext,a=i.regionBelow(),o=i.eUp,l=a.eUp,h=!1;o.dst()!==l.dst()&&e.sweep.checkForIntersect_(t,i),e.geom.vertEq(o.org,t.event)&&(e.mesh.meshSplice(n.oPrev(),o),n=(i=e.sweep.topLeftRegion_(i)).regionBelow().eUp,e.sweep.finishLeftRegions_(t,i.regionBelow(),a),h=!0),e.geom.vertEq(l.org,t.event)&&(e.mesh.meshSplice(r,l.oPrev()),r=e.sweep.finishLeftRegions_(t,a,null),h=!0),h?e.sweep.addRightEdges_(t,i,r.oNext,n,n,!0):(s=e.geom.vertLeq(l.org,o.org)?l.oPrev():o,s=e.mesh.connect(r.lPrev(),s),e.sweep.addRightEdges_(t,i,s,s.oNext,s.oNext,!1),s.sym.activeRegion.fixUpperEdge=!0,e.sweep.walkDirtyRegions_(t,i))},e.sweep.connectLeftDegenerate_=function(t,i,r){var s=i.eUp;if(e.geom.vertEq(s.org,r))return e.assert(e.sweep.TOLERANCE_NONZERO_),void(e.sweep.TOLERANCE_NONZERO_&&e.sweep.spliceMergeVertices_(t,s,r.anEdge));if(!e.geom.vertEq(s.dst(),r))return e.mesh.splitEdge(s.sym),i.fixUpperEdge&&(e.mesh.deleteEdge(s.oNext),i.fixUpperEdge=!1),e.mesh.meshSplice(r.anEdge,s),void e.sweep.sweepEvent_(t,r);if(e.assert(e.sweep.TOLERANCE_NONZERO_),e.sweep.TOLERANCE_NONZERO_){var n=(i=e.sweep.topRightRegion_(i)).regionBelow(),a=n.eUp.sym,o=a.oNext,l=o;n.fixUpperEdge&&(e.assert(o!==a),e.sweep.deleteRegion_(t,n),e.mesh.deleteEdge(a),a=o.oPrev()),e.mesh.meshSplice(r.anEdge,a),e.geom.edgeGoesLeft(o)||(o=null),e.sweep.addRightEdges_(t,i,a.oNext,l,o,!0)}},e.sweep.connectLeftVertex_=function(t,i){var r=new e.ActiveRegion;r.eUp=i.anEdge.sym;var s=t.dict.search(r).getKey(),n=s.regionBelow(),a=s.eUp,o=n.eUp;if(0!==e.geom.edgeSign(a.dst(),i,a.org)){var l,h=e.geom.vertLeq(o.dst(),a.dst())?s:n;s.inside||h.fixUpperEdge?(l=h===s?e.mesh.connect(i.anEdge.sym,a.lNext):e.mesh.connect(o.dNext(),i.anEdge).sym,h.fixUpperEdge?e.sweep.fixUpperEdge_(h,l):e.sweep.computeWinding_(t,e.sweep.addRegionBelow_(t,s,l)),e.sweep.sweepEvent_(t,i)):e.sweep.addRightEdges_(t,s,i.anEdge,i.anEdge,null,!0)}else e.sweep.connectLeftDegenerate_(t,s,i)},e.sweep.sweepEvent_=function(t,i){t.event=i;for(var r=i.anEdge;null===r.activeRegion;)if((r=r.oNext)===i.anEdge)return void e.sweep.connectLeftVertex_(t,i);var s=e.sweep.topLeftRegion_(r.activeRegion),n=s.regionBelow(),a=n.eUp,o=e.sweep.finishLeftRegions_(t,n,null);o.oNext===a?e.sweep.connectRightVertex_(t,s,o):e.sweep.addRightEdges_(t,s,o.oNext,a,a,!0)},e.sweep.addSentinel_=function(t,i){var r=new e.ActiveRegion,s=e.mesh.makeEdge(t.mesh);s.org.s=e.sweep.SENTINEL_COORD_,s.org.t=i,s.dst().s=-e.sweep.SENTINEL_COORD_,s.dst().t=i,t.event=s.dst(),r.eUp=s,r.windingNumber=0,r.inside=!1,r.fixUpperEdge=!1,r.sentinel=!0,r.dirty=!1,r.nodeUp=t.dict.insert(r)},e.sweep.initEdgeDict_=function(t){t.dict=new e.Dict(t,e.sweep.edgeLeq_),e.sweep.addSentinel_(t,-e.sweep.SENTINEL_COORD_),e.sweep.addSentinel_(t,e.sweep.SENTINEL_COORD_)},e.sweep.doneEdgeDict_=function(t){for(var i,r=0;null!==(i=t.dict.getMin().getKey());)i.sentinel||(e.assert(i.fixUpperEdge),e.assert(1==++r)),e.assert(0===i.windingNumber),e.sweep.deleteRegion_(t,i);t.dict=null},e.sweep.removeDegenerateEdges_=function(t){for(var i,r=t.mesh.eHead,s=r.next;s!==r;s=i){i=s.next;var n=s.lNext;e.geom.vertEq(s.org,s.dst())&&s.lNext.lNext!==s&&(e.sweep.spliceMergeVertices_(t,n,s),e.mesh.deleteEdge(s),n=(s=n).lNext),n.lNext===s&&(n!==s&&(n!==i&&n!==i.sym||(i=i.next),e.mesh.deleteEdge(n)),s!==i&&s!==i.sym||(i=i.next),e.mesh.deleteEdge(s))}},e.sweep.initPriorityQ_=function(t){var i=new e.PriorityQ;t.pq=i;var r,s=t.mesh.vHead;for(r=s.next;r!==s;r=r.next)r.pqHandle=i.insert(r);i.init()},e.sweep.donePriorityQ_=function(e){e.pq.deleteQ(),e.pq=null},e.sweep.removeDegenerateFaces_=function(t){for(var i,r=t.fHead.next;r!==t.fHead;r=i){i=r.next;var s=r.anEdge;e.assert(s.lNext!==s),s.lNext.lNext===s&&(e.sweep.addWinding_(s.oNext,s),e.mesh.deleteEdge(s))}},e.tessmono={},e.tessmono.tessellateMonoRegion_=function(t){var i=t.anEdge;for(e.assert(i.lNext!==i&&i.lNext.lNext!==i);e.geom.vertLeq(i.dst(),i.org);i=i.lPrev());for(;e.geom.vertLeq(i.org,i.dst());i=i.lNext);for(var r,s=i.lPrev();i.lNext!==s;)if(e.geom.vertLeq(i.dst(),s.org)){for(;s.lNext!==i&&(e.geom.edgeGoesLeft(s.lNext)||e.geom.edgeSign(s.org,s.dst(),s.lNext.dst())<=0);)s=(r=e.mesh.connect(s.lNext,s)).sym;s=s.lPrev()}else{for(;s.lNext!==i&&(e.geom.edgeGoesRight(i.lPrev())||e.geom.edgeSign(i.dst(),i.org,i.lPrev().org)>=0);)r=e.mesh.connect(i,i.lPrev()),i=r.sym;i=i.lNext}for(e.assert(s.lNext!==i);s.lNext.lNext!==i;)s=(r=e.mesh.connect(s.lNext,s)).sym},e.tessmono.tessellateInterior=function(t){for(var i,r=t.fHead.next;r!==t.fHead;r=i)i=r.next,r.inside&&e.tessmono.tessellateMonoRegion_(r)},e.tessmono.discardExterior=function(t){for(var i,r=t.fHead.next;r!==t.fHead;r=i)i=r.next,r.inside||e.mesh.zapFace(r)},e.tessmono.setWindingNumber=function(t,i,r){for(var s,n=t.eHead.next;n!==t.eHead;n=s)s=n.next,n.rFace().inside!==n.lFace.inside?n.winding=n.lFace.inside?i:-i:r?e.mesh.deleteEdge(n):n.winding=0},e.Dict=function(t,i){this.head_=new e.DictNode,this.frame_=t,this.leq_=i},e.Dict.prototype.deleteDict_=function(){},e.Dict.prototype.insertBefore=function(t,i){do{t=t.prev}while(null!==t.key&&!this.leq_(this.frame_,t.key,i));var r=new e.DictNode(i,t.next,t);return t.next.prev=r,t.next=r,r},e.Dict.prototype.insert=function(e){return this.insertBefore(this.head_,e)},e.Dict.prototype.deleteNode=function(e){e.next.prev=e.prev,e.prev.next=e.next},e.Dict.prototype.search=function(e){var t=this.head_;do{t=t.next}while(null!==t.key&&!this.leq_(this.frame_,e,t.key));return t},e.Dict.prototype.getMin=function(){return this.head_.next},e.Dict.prototype.getMax=function(){return this.head_.prev},e.DictNode=function(e,t,i){this.key=e||null,this.next=t||this,this.prev=i||this},e.DictNode.prototype.getKey=function(){return this.key},e.DictNode.prototype.getSuccessor=function(){return this.next},e.DictNode.prototype.getPredecessor=function(){return this.prev},e.GluTesselator=function(){this.state_=e.GluTesselator.tessState_.T_DORMANT,this.lastEdge_=null,this.mesh=null,this.errorCallback_=null,this.normal_=[0,0,0],this.windingRule=e.windingRule.GLU_TESS_WINDING_ODD,this.fatalError=!1,this.dict=null,this.pq=null,this.event=null,this.combineCallback_=null,this.boundaryOnly_=!1,this.beginCallback_=null,this.edgeFlagCallback_=null,this.vertexCallback_=null,this.endCallback_=null,this.meshCallback_=null,this.polygonData_=null},e.GluTesselator.tessState_={T_DORMANT:0,T_IN_POLYGON:1,T_IN_CONTOUR:2},e.GluTesselator.prototype.gluDeleteTess=function(){this.requireState_(e.GluTesselator.tessState_.T_DORMANT)},e.GluTesselator.prototype.gluTessProperty=function(t,i){switch(t){case e.gluEnum.GLU_TESS_TOLERANCE:return;case e.gluEnum.GLU_TESS_WINDING_RULE:var r=i;switch(r){case e.windingRule.GLU_TESS_WINDING_ODD:case e.windingRule.GLU_TESS_WINDING_NONZERO:case e.windingRule.GLU_TESS_WINDING_POSITIVE:case e.windingRule.GLU_TESS_WINDING_NEGATIVE:case e.windingRule.GLU_TESS_WINDING_ABS_GEQ_TWO:return void(this.windingRule=r)}break;case e.gluEnum.GLU_TESS_BOUNDARY_ONLY:return void(this.boundaryOnly_=!!i);default:return void this.callErrorCallback(e.gluEnum.GLU_INVALID_ENUM)}this.callErrorCallback(e.gluEnum.GLU_INVALID_VALUE)},e.GluTesselator.prototype.gluGetTessProperty=function(t){switch(t){case e.gluEnum.GLU_TESS_TOLERANCE:return 0;case e.gluEnum.GLU_TESS_WINDING_RULE:var i=this.windingRule;return e.assert(i===e.windingRule.GLU_TESS_WINDING_ODD||i===e.windingRule.GLU_TESS_WINDING_NONZERO||i===e.windingRule.GLU_TESS_WINDING_POSITIVE||i===e.windingRule.GLU_TESS_WINDING_NEGATIVE||i===e.windingRule.GLU_TESS_WINDING_ABS_GEQ_TWO),i;case e.gluEnum.GLU_TESS_BOUNDARY_ONLY:return e.assert(!0===this.boundaryOnly_||!1===this.boundaryOnly_),this.boundaryOnly_;default:this.callErrorCallback(e.gluEnum.GLU_INVALID_ENUM)}return!1},e.GluTesselator.prototype.gluTessNormal=function(e,t,i){this.normal_[0]=e,this.normal_[1]=t,this.normal_[2]=i},e.GluTesselator.prototype.gluTessCallback=function(t,i){var r=i||null;switch(t){case e.gluEnum.GLU_TESS_BEGIN:case e.gluEnum.GLU_TESS_BEGIN_DATA:return void(this.beginCallback_=r);case e.gluEnum.GLU_TESS_EDGE_FLAG:case e.gluEnum.GLU_TESS_EDGE_FLAG_DATA:return void(this.edgeFlagCallback_=r);case e.gluEnum.GLU_TESS_VERTEX:case e.gluEnum.GLU_TESS_VERTEX_DATA:return void(this.vertexCallback_=r);case e.gluEnum.GLU_TESS_END:case e.gluEnum.GLU_TESS_END_DATA:return void(this.endCallback_=r);case e.gluEnum.GLU_TESS_ERROR:case e.gluEnum.GLU_TESS_ERROR_DATA:return void(this.errorCallback_=r);case e.gluEnum.GLU_TESS_COMBINE:case e.gluEnum.GLU_TESS_COMBINE_DATA:return void(this.combineCallback_=r);case e.gluEnum.GLU_TESS_MESH:return void(this.meshCallback_=r);default:return void this.callErrorCallback(e.gluEnum.GLU_INVALID_ENUM)}},e.GluTesselator.prototype.gluTessVertex=function(t,i){var r=!1,s=[0,0,0];this.requireState_(e.GluTesselator.tessState_.T_IN_CONTOUR);for(var n=0;n<3;++n){var a=t[n];a<-e.GLU_TESS_MAX_COORD&&(a=-e.GLU_TESS_MAX_COORD,r=!0),a>e.GLU_TESS_MAX_COORD&&(a=e.GLU_TESS_MAX_COORD,r=!0),s[n]=a}r&&this.callErrorCallback(e.errorType.GLU_TESS_COORD_TOO_LARGE),this.addVertex_(s,i)},e.GluTesselator.prototype.gluTessBeginPolygon=function(t){this.requireState_(e.GluTesselator.tessState_.T_DORMANT),this.state_=e.GluTesselator.tessState_.T_IN_POLYGON,this.mesh=new e.GluMesh,this.polygonData_=t},e.GluTesselator.prototype.gluTessBeginContour=function(){this.requireState_(e.GluTesselator.tessState_.T_IN_POLYGON),this.state_=e.GluTesselator.tessState_.T_IN_CONTOUR,this.lastEdge_=null},e.GluTesselator.prototype.gluTessEndContour=function(){this.requireState_(e.GluTesselator.tessState_.T_IN_CONTOUR),this.state_=e.GluTesselator.tessState_.T_IN_POLYGON},e.GluTesselator.prototype.gluTessEndPolygon=function(){if(this.requireState_(e.GluTesselator.tessState_.T_IN_POLYGON),this.state_=e.GluTesselator.tessState_.T_DORMANT,e.normal.projectPolygon(this,this.normal_[0],this.normal_[1],this.normal_[2]),e.sweep.computeInterior(this),!this.fatalError){var t=this.mesh;if(this.boundaryOnly_?e.tessmono.setWindingNumber(t,1,!0):e.tessmono.tessellateInterior(t),this.mesh.checkMesh(),this.beginCallback_||this.endCallback_||this.vertexCallback_||this.edgeFlagCallback_)if(this.boundaryOnly_)e.render.renderBoundary(this,this.mesh);else{var i=!!this.edgeFlagCallback_;e.render.renderMesh(this,this.mesh,i)}if(this.meshCallback_)return e.tessmono.discardExterior(this.mesh),this.meshCallback_(this.mesh),this.mesh=null,void(this.polygonData_=null)}e.mesh.deleteMesh(this.mesh),this.polygonData_=null,this.mesh=null},e.GluTesselator.prototype.requireState_=function(e){this.state_!==e&&this.gotoState_(e)},e.GluTesselator.prototype.gotoState_=function(t){for(;this.state_!==t;)if(this.state_<t)switch(this.state_){case e.GluTesselator.tessState_.T_DORMANT:this.callErrorCallback(e.errorType.GLU_TESS_MISSING_BEGIN_POLYGON),this.gluTessBeginPolygon(null);break;case e.GluTesselator.tessState_.T_IN_POLYGON:this.callErrorCallback(e.errorType.GLU_TESS_MISSING_BEGIN_CONTOUR),this.gluTessBeginContour()}else switch(this.state_){case e.GluTesselator.tessState_.T_IN_CONTOUR:this.callErrorCallback(e.errorType.GLU_TESS_MISSING_END_CONTOUR),this.gluTessEndContour();break;case e.GluTesselator.tessState_.T_IN_POLYGON:this.callErrorCallback(e.errorType.GLU_TESS_MISSING_END_POLYGON),this.gluTessEndPolygon()}},e.GluTesselator.prototype.addVertex_=function(t,i){var r=this.lastEdge_;null===r?(r=e.mesh.makeEdge(this.mesh),e.mesh.meshSplice(r,r.sym)):(e.mesh.splitEdge(r),r=r.lNext),r.org.data=i,r.org.coords[0]=t[0],r.org.coords[1]=t[1],r.org.coords[2]=t[2],r.winding=1,r.sym.winding=-1,this.lastEdge_=r},e.GluTesselator.prototype.callBeginCallback=function(e){this.beginCallback_&&this.beginCallback_(e,this.polygonData_)},e.GluTesselator.prototype.callVertexCallback=function(e){this.vertexCallback_&&this.vertexCallback_(e,this.polygonData_)},e.GluTesselator.prototype.callEdgeFlagCallback=function(e){this.edgeFlagCallback_&&this.edgeFlagCallback_(e,this.polygonData_)},e.GluTesselator.prototype.callEndCallback=function(){this.endCallback_&&this.endCallback_(this.polygonData_)},e.GluTesselator.prototype.callCombineCallback=function(e,t,i){return this.combineCallback_&&this.combineCallback_(e,t,i,this.polygonData_)||null},e.GluTesselator.prototype.callErrorCallback=function(e){this.errorCallback_&&this.errorCallback_(e,this.polygonData_)},e.GluFace=function(e,t){this.next=e||this,this.prev=t||this,this.anEdge=null,this.inside=!1},e.GluHalfEdge=function(e){this.next=e||this,this.sym=null,this.oNext=null,this.lNext=null,this.org=null,this.lFace=null,this.activeRegion=null,this.winding=0},e.GluHalfEdge.prototype.rFace=function(){return this.sym.lFace},e.GluHalfEdge.prototype.dst=function(){return this.sym.org},e.GluHalfEdge.prototype.oPrev=function(){return this.sym.lNext},e.GluHalfEdge.prototype.lPrev=function(){return this.oNext.sym},e.GluHalfEdge.prototype.dPrev=function(){return this.lNext.sym},e.GluHalfEdge.prototype.rPrev=function(){return this.sym.oNext},e.GluHalfEdge.prototype.dNext=function(){return this.rPrev().sym},e.GluHalfEdge.prototype.rNext=function(){return this.oPrev().sym},e.GluMesh=function(){this.vHead=new e.GluVertex,this.fHead=new e.GluFace,this.eHead=new e.GluHalfEdge,this.eHeadSym=new e.GluHalfEdge,this.eHead.sym=this.eHeadSym,this.eHeadSym.sym=this.eHead},e.GluMesh.prototype.checkMesh=function(){if(e.DEBUG){var t,i,r,s=this.fHead,n=this.vHead,a=this.eHead,o=s;for(o=s;(i=o.next)!==s;o=i){e.assert(i.prev===o),t=i.anEdge;do{e.assert(t.sym!==t),e.assert(t.sym.sym===t),e.assert(t.lNext.oNext.sym===t),e.assert(t.oNext.sym.lNext===t),e.assert(t.lFace===i),t=t.lNext}while(t!==i.anEdge)}e.assert(i.prev===o&&null===i.anEdge);var l=n;for(l=n;(r=l.next)!==n;l=r){e.assert(r.prev===l),t=r.anEdge;do{e.assert(t.sym!==t),e.assert(t.sym.sym===t),e.assert(t.lNext.oNext.sym===t),e.assert(t.oNext.sym.lNext===t),e.assert(t.org===r),t=t.oNext}while(t!==r.anEdge)}e.assert(r.prev===l&&null===r.anEdge&&null===r.data);var h=a;for(h=a;(t=h.next)!==a;h=t)e.assert(t.sym.next===h.sym),e.assert(t.sym!==t),e.assert(t.sym.sym===t),e.assert(null!==t.org),e.assert(null!==t.dst()),e.assert(t.lNext.oNext.sym===t),e.assert(t.oNext.sym.lNext===t);e.assert(t.sym.next===h.sym&&t.sym===this.eHeadSym&&t.sym.sym===t&&null===t.org&&null===t.dst()&&null===t.lFace&&null===t.rFace())}},e.GluVertex=function(e,t){this.next=e||this,this.prev=t||this,this.anEdge=null,this.data=null,this.coords=[0,0,0],this.s=0,this.t=0,this.pqHandle=0},e.PriorityQ=function(){this.verts_=[],this.order_=null,this.size_=0,this.initialized_=!1,this.heap_=new e.PriorityQHeap},e.PriorityQ.prototype.deleteQ=function(){this.heap_=null,this.order_=null,this.verts_=null},e.PriorityQ.prototype.init=function(){this.order_=[];for(var t=0;t<this.size_;t++)this.order_[t]=t;var i,r=(i=this.verts_,function(t,r){return e.geom.vertLeq(i[t],i[r])?1:-1});if(this.order_.sort(r),this.initialized_=!0,this.heap_.init(),e.DEBUG){var s=0+this.size_-1;for(t=0;t<s;++t)e.assert(e.geom.vertLeq(this.verts_[this.order_[t+1]],this.verts_[this.order_[t]]))}},e.PriorityQ.prototype.insert=function(e){if(this.initialized_)return this.heap_.insert(e);var t=this.size_++;return this.verts_[t]=e,-(t+1)},e.PriorityQ.prototype.extractMin=function(){if(0===this.size_)return this.heap_.extractMin();var t=this.verts_[this.order_[this.size_-1]];if(!this.heap_.isEmpty()){var i=this.heap_.minimum();if(e.geom.vertLeq(i,t))return this.heap_.extractMin()}do{--this.size_}while(this.size_>0&&null===this.verts_[this.order_[this.size_-1]]);return t},e.PriorityQ.prototype.minimum=function(){if(0===this.size_)return this.heap_.minimum();var t=this.verts_[this.order_[this.size_-1]];if(!this.heap_.isEmpty()){var i=this.heap_.minimum();if(e.geom.vertLeq(i,t))return i}return t},e.PriorityQ.prototype.remove=function(t){if(t>=0)this.heap_.remove(t);else for(t=-(t+1),e.assert(t<this.verts_.length&&null!==this.verts_[t]),this.verts_[t]=null;this.size_>0&&null===this.verts_[this.order_[this.size_-1]];)--this.size_},e.PriorityQHeap=function(){this.heap_=e.PriorityQHeap.reallocNumeric_([0],e.PriorityQHeap.INIT_SIZE_+1),this.verts_=[null,null],this.handles_=[0,0],this.size_=0,this.max_=e.PriorityQHeap.INIT_SIZE_,this.freeList_=0,this.initialized_=!1,this.heap_[1]=1},e.PriorityQHeap.INIT_SIZE_=32,e.PriorityQHeap.reallocNumeric_=function(e,t){for(var i=new Array(t),r=0;r<e.length;r++)i[r]=e[r];for(;r<t;r++)i[r]=0;return i},e.PriorityQHeap.prototype.init=function(){for(var e=this.size_;e>=1;--e)this.floatDown_(e);this.initialized_=!0},e.PriorityQHeap.prototype.insert=function(t){var i,r=++this.size_;return 2*r>this.max_&&(this.max_*=2,this.handles_=e.PriorityQHeap.reallocNumeric_(this.handles_,this.max_+1)),0===this.freeList_?i=r:(i=this.freeList_,this.freeList_=this.handles_[this.freeList_]),this.verts_[i]=t,this.handles_[i]=r,this.heap_[r]=i,this.initialized_&&this.floatUp_(r),i},e.PriorityQHeap.prototype.isEmpty=function(){return 0===this.size_},e.PriorityQHeap.prototype.minimum=function(){return this.verts_[this.heap_[1]]},e.PriorityQHeap.prototype.extractMin=function(){var e=this.heap_,t=this.verts_,i=this.handles_,r=e[1],s=t[r];return this.size_>0&&(e[1]=e[this.size_],i[e[1]]=1,t[r]=null,i[r]=this.freeList_,this.freeList_=r,--this.size_>0&&this.floatDown_(1)),s},e.PriorityQHeap.prototype.remove=function(t){var i=this.heap_,r=this.verts_,s=this.handles_;e.assert(t>=1&&t<=this.max_&&null!==r[t]);var n=s[t];if(i[n]=i[this.size_],s[i[n]]=n,n<=--this.size_)if(n<=1)this.floatDown_(n);else{var a=r[i[n]],o=r[i[n>>1]];e.geom.vertLeq(o,a)?this.floatDown_(n):this.floatUp_(n)}r[t]=null,s[t]=this.freeList_,this.freeList_=t},e.PriorityQHeap.prototype.floatDown_=function(t){for(var i=this.heap_,r=this.verts_,s=this.handles_,n=t,a=i[n];;){var o=n<<1;o<this.size_&&e.geom.vertLeq(r[i[o+1]],r[i[o]])&&(o+=1),e.assert(o<=this.max_);var l=i[o];if(o>this.size_||e.geom.vertLeq(r[a],r[l]))return i[n]=a,void(s[a]=n);i[n]=l,s[l]=n,n=o}},e.PriorityQHeap.prototype.floatUp_=function(t){for(var i=this.heap_,r=this.verts_,s=this.handles_,n=t,a=i[n];;){var o=n>>1,l=i[o];if(0===o||e.geom.vertLeq(r[l],r[a]))return i[n]=a,void(s[a]=n);i[n]=l,s[l]=n,n=o}},e.ActiveRegion=function(){this.eUp=null,this.nodeUp=null,this.windingNumber=0,this.inside=!1,this.sentinel=!1,this.dirty=!1,this.fixUpperEdge=!1},e.ActiveRegion.prototype.regionBelow=function(){return this.nodeUp.getPredecessor().getKey()},e.ActiveRegion.prototype.regionAbove=function(){return this.nodeUp.getSuccessor().getKey()},e}())&&(o.exports=l);const u=r.n.getLogger("esri.views.2d.engine.webgl.mesh.templates.Tesselator");class c{constructor(){this._currentVertexIndex=0,this._indexCounter=0,this._triangleIndices=[-1,-1,-1],this.glu=new h.exports.GluTesselator,this.glu.gluTessCallback(h.exports.gluEnum.GLU_TESS_BEGIN,this._begincallback.bind(this)),this.glu.gluTessCallback(h.exports.gluEnum.GLU_TESS_VERTEX_DATA,this._vertexCallback.bind(this)),this.glu.gluTessCallback(h.exports.gluEnum.GLU_TESS_END,this._endcallback.bind(this)),this.glu.gluTessCallback(h.exports.gluEnum.GLU_TESS_COMBINE,this._combinecallback.bind(this)),this.glu.gluTessCallback(h.exports.gluEnum.GLU_TESS_ERROR,this._errorcallback.bind(this)),this.glu.gluTessCallback(h.exports.gluEnum.GLU_TESS_EDGE_FLAG,this._edgeCallback.bind(this)),this.glu.gluTessProperty(h.exports.gluEnum.GLU_TESS_WINDING_RULE,h.exports.windingRule.GLU_TESS_WINDING_ODD)}beginPolygon(e,t){this._triangleIndices[0]=-1,this._triangleIndices[1]=-1,this._triangleIndices[2]=-1,this._currentVertexIndex=0,this._indexCounter=0,this.glu.gluTessBeginPolygon(e),this._indices=t}endPolygon(){this.glu.gluTessEndPolygon()}beginContour(){this.glu.gluTessBeginContour()}endContour(){this.glu.gluTessEndContour()}addVertex(e,t){this.glu.gluTessVertex(e,t)}_vertexCallback(e,t){if(t[t.length]=e[0],t[t.length]=e[1],this._triangleIndices[this._currentVertexIndex]=-1,this._currentVertexIndex>=2){for(let e=0;e<3;e++)-1===this._triangleIndices[e]&&(this._triangleIndices[e]=this._indexCounter++),this._indices[this._indices.length]=this._triangleIndices[e];this._currentVertexIndex=0}else this._currentVertexIndex++}_begincallback(){this._triangleIndices[0]=-1,this._triangleIndices[1]=-1,this._triangleIndices[2]=-1,this._currentVertexIndex=0}_endcallback(){this._currentVertexIndex=0}_errorcallback(e){u.error(`Encountered error during tesselation: ${e}`)}_combinecallback(e){return[e[0],e[1],e[2]]}_edgeCallback(){}}function d(e,t){return e.x===t.x&&e.y===t.y}function p(e,t){return e.x=t.y,e.y=-t.x,e}function f(e,t){return e.x=-t.y,e.y=t.x,e}function y(e,t){return e.x=t.x,e.y=t.y,e}function m(e,t){return e.x=-t.x,e.y=-t.y,e}function g(e){return Math.sqrt(e.x*e.x+e.y*e.y)}function _(e,t){return e.x*t.y-e.y*t.x}function x(e,t){return e.x*t.x+e.y*t.y}function v(e,t,i,r){return e.x=t.x*i+t.y*r,e.y=t.x*r-t.y*i,e}class b{constructor(e,t,i){this.writeVertex=e,this.writeTriangle=t,this.canUseThinTessellation=i,this.prevNormal={x:void 0,y:void 0},this.nextNormal={x:void 0,y:void 0},this.textureNormalLeft={x:0,y:1},this.textureNormalRight={x:0,y:-1},this.textureNormal={x:void 0,y:void 0},this.joinNormal={x:void 0,y:void 0},this.inner={x:void 0,y:void 0},this.outer={x:void 0,y:void 0},this.roundStart={x:void 0,y:void 0},this.roundEnd={x:void 0,y:void 0},this.startBreak={x:void 0,y:void 0},this.endBreak={x:void 0,y:void 0},this.innerPrev={x:void 0,y:void 0},this.innerNext={x:void 0,y:void 0},this.bevelStart={x:void 0,y:void 0},this.bevelEnd={x:void 0,y:void 0},this.bevelMiddle={x:void 0,y:void 0}}tessellate(e,t){(function(e){if(!e)return;const t=e.length;if(t<=1)return;let i=0;for(let r=1;r<t;r++)d(e[r],e[i])||++i===r||(e[i]=e[r]);e.length=i+1})(e),this.canUseThinTessellation&&t.halfWidth<s.S&&!t.offset?this.tessellateThin_(e,t):this.tessellate_(e,t)}tessellateThin_(e,t){if(e.length<2)return;const i=t.wrapDistance||65535;let r=t.initialDistance||0,s=!1,n=e[0].x,a=e[0].y;const o=e.length;for(let t=1;t<o;++t){s&&(s=!1,r=0);let o=e[t].x,l=e[t].y,h=o-n,u=l-a,c=Math.sqrt(h*h+u*u);if(h/=c,u/=c,r+c>i){s=!0;const e=(i-r)/c;c=i-r,o=(1-e)*n+e*o,l=(1-e)*a+e*l,--t}const d=this.writeVertex(n,a,0,0,h,u,u,-h,0,-1,r),p=this.writeVertex(n,a,0,0,h,u,-u,h,0,1,r);r+=c;const f=this.writeVertex(o,l,0,0,h,u,u,-h,0,-1,r),y=this.writeVertex(o,l,0,0,h,u,-u,h,0,1,r);this.writeTriangle(d,p,f),this.writeTriangle(p,f,y),n=o,a=l}}tessellate_(e,t){const i=e[0],r=e[e.length-1],s=d(i,r),n=s?3:2;if(e.length<n)return;const a=t.pixelCoordRatio,o=null!=t.capType?t.capType:0,l=null!=t.joinType?t.joinType:2,h=null!=t.miterLimit?Math.min(t.miterLimit,4):2,u=null!=t.roundLimit?Math.min(t.roundLimit,1.05):1.05,c=null!=t.halfWidth?t.halfWidth:2,b=!!t.textured;let w,S,I=null,C=null;const M=this.prevNormal,T=this.nextNormal;let E=-1,F=-1;const A=this.joinNormal;let R,P;const L=this.textureNormalLeft,D=this.textureNormalRight,N=this.textureNormal;let O=-1,k=-1;const V=t.wrapDistance||65535;let U=t.initialDistance||0;const G=this.writeVertex,z=this.writeTriangle,B=function(e,t,i,r,s,n){const a=G(w,S,R,P,i,r,e,t,s,n,U);return O>=0&&k>=0&&a>=0&&z(O,k,a),O=k,k=a,a};s&&(I=e[e.length-2],T.x=r.x-I.x,T.y=r.y-I.y,F=g(T),T.x/=F,T.y/=F);let j=!1;for(let t=0;t<e.length;++t){if(j&&(j=!1,U=0),I&&(M.x=-T.x,M.y=-T.y,E=F,U+E>V&&(j=!0)),j){const i=(V-U)/E;E=V-U,I={x:(1-i)*I.x+i*e[t].x,y:(1-i)*I.y+i*e[t].y},--t}else I=e[t];w=I.x,S=I.y;const i=t<=0&&!j,r=t===e.length-1;if(i||(U+=E),C=r?s?e[1]:null:e[t+1],C?(T.x=C.x-w,T.y=C.y-S,F=g(T),T.x/=F,T.y/=F):(T.x=void 0,T.y=void 0),!s){if(i){f(A,T),R=A.x,P=A.y,2===o&&(B(-T.y-T.x,T.x-T.y,T.x,T.y,0,-1),B(T.y-T.x,-T.x-T.y,T.x,T.y,0,1)),1===o&&(B(-T.y-T.x,T.x-T.y,T.x,T.y,-1,-1),B(T.y-T.x,-T.x-T.y,T.x,T.y,-1,1)),1!==o&&0!==o||(B(-T.y,T.x,T.x,T.y,0,-1),B(T.y,-T.x,T.x,T.y,0,1));continue}if(r){p(A,M),R=A.x,P=A.y,1!==o&&0!==o||(B(M.y,-M.x,-M.x,-M.y,0,-1),B(-M.y,M.x,-M.x,-M.y,0,1)),2===o&&(B(M.y-M.x,-M.x-M.y,-M.x,-M.y,0,-1),B(-M.y-M.x,M.x-M.y,-M.x,-M.y,0,1)),1===o&&(B(M.y-M.x,-M.x-M.y,-M.x,-M.y,1,-1),B(-M.y-M.x,M.x-M.y,-M.x,-M.y,1,1));continue}}let n,d,G=-_(M,T);if(Math.abs(G)<.01)x(M,T)>0?(A.x=M.x,A.y=M.y,G=1,n=Number.MAX_VALUE,d=!0):(f(A,T),G=1,n=1,d=!1);else{A.x=(M.x+T.x)/G,A.y=(M.y+T.y)/G,n=g(A);const e=(n-1)*c*a;d=n>4||e>E&&e>F}R=A.x,P=A.y;let z=l;switch(l){case 0:n<1.05&&(z=2);break;case 1:n<u&&(z=2);break;case 2:n>h&&(z=0)}switch(z){case 2:if(B(A.x,A.y,-M.x,-M.y,0,-1),B(-A.x,-A.y,-M.x,-M.y,0,1),r)break;if(b){const e=j?0:U;O=this.writeVertex(w,S,R,P,T.x,T.y,A.x,A.y,0,-1,e),k=this.writeVertex(w,S,R,P,T.x,T.y,-A.x,-A.y,0,1,e)}break;case 0:{const e=G<0;let t,i,s,n;if(e){const e=O;O=k,k=e,t=L,i=D}else t=D,i=L;if(d)s=e?f(this.innerPrev,M):p(this.innerPrev,M),n=e?p(this.innerNext,T):f(this.innerNext,T);else{const t=e?m(this.inner,A):y(this.inner,A);s=t,n=t}const a=e?p(this.bevelStart,M):f(this.bevelStart,M);B(s.x,s.y,-M.x,-M.y,t.x,t.y);const o=B(a.x,a.y,-M.x,-M.y,i.x,i.y);if(r)break;const l=e?f(this.bevelEnd,T):p(this.bevelEnd,T);if(d){const e=this.writeVertex(w,S,R,P,-M.x,-M.y,0,0,0,0,U);O=this.writeVertex(w,S,R,P,T.x,T.y,n.x,n.y,t.x,t.y,U),k=this.writeVertex(w,S,R,P,T.x,T.y,l.x,l.y,i.x,i.y,U),this.writeTriangle(o,e,k)}else{if(b){const e=this.bevelMiddle;e.x=(a.x+l.x)/2,e.y=(a.y+l.y)/2,v(N,e,-M.x,-M.y),B(e.x,e.y,-M.x,-M.y,N.x,N.y),v(N,e,T.x,T.y),O=this.writeVertex(w,S,R,P,T.x,T.y,e.x,e.y,N.x,N.y,U),k=this.writeVertex(w,S,R,P,T.x,T.y,n.x,n.y,t.x,t.y,U)}else{const e=O;O=k,k=e}B(l.x,l.y,T.x,T.y,i.x,i.y)}if(e){const e=O;O=k,k=e}break}case 1:{const e=G<0;let t,i;if(e){const e=O;O=k,k=e,t=L,i=D}else t=D,i=L;const s=e?m(this.inner,A):y(this.inner,A);let a,o;d?(a=e?f(this.innerPrev,M):p(this.innerPrev,M),o=e?p(this.innerNext,T):f(this.innerNext,T)):(a=s,o=s);const l=e?p(this.roundStart,M):f(this.roundStart,M),h=e?f(this.roundEnd,T):p(this.roundEnd,T),u=B(a.x,a.y,-M.x,-M.y,t.x,t.y),c=B(l.x,l.y,-M.x,-M.y,i.x,i.y);if(r)break;const g=this.writeVertex(w,S,R,P,-M.x,-M.y,0,0,0,0,U);d||this.writeTriangle(O,k,g);const _=m(this.outer,s),I=this.writeVertex(w,S,R,P,T.x,T.y,h.x,h.y,i.x,i.y,U);let C,E;const F=n>2;if(F){let t;n!==Number.MAX_VALUE?(_.x/=n,_.y/=n,t=x(M,_),t=(n*(t*t-1)+1)/t):t=-1,C=e?p(this.startBreak,M):f(this.startBreak,M),C.x+=M.x*t,C.y+=M.y*t,E=e?f(this.endBreak,T):p(this.endBreak,T),E.x+=T.x*t,E.y+=T.y*t}v(N,_,-M.x,-M.y);const V=this.writeVertex(w,S,R,P,-M.x,-M.y,_.x,_.y,N.x,N.y,U);v(N,_,T.x,T.y);const z=b?this.writeVertex(w,S,R,P,T.x,T.y,_.x,_.y,N.x,N.y,U):V,j=g,q=b?this.writeVertex(w,S,R,P,T.x,T.y,0,0,0,0,U):g;let H=-1,W=-1;if(F&&(v(N,C,-M.x,-M.y),H=this.writeVertex(w,S,R,P,-M.x,-M.y,C.x,C.y,N.x,N.y,U),v(N,E,T.x,T.y),W=this.writeVertex(w,S,R,P,T.x,T.y,E.x,E.y,N.x,N.y,U)),b?F?(this.writeTriangle(j,c,H),this.writeTriangle(j,H,V),this.writeTriangle(q,z,W),this.writeTriangle(q,W,I)):(this.writeTriangle(j,c,V),this.writeTriangle(q,z,I)):F?(this.writeTriangle(g,c,H),this.writeTriangle(g,H,W),this.writeTriangle(g,W,I)):(this.writeTriangle(g,c,V),this.writeTriangle(g,z,I)),d?(O=this.writeVertex(w,S,R,P,T.x,T.y,o.x,o.y,t.x,t.y,U),k=I):(O=b?this.writeVertex(w,S,R,P,T.x,T.y,o.x,o.y,t.x,t.y,U):u,this.writeTriangle(O,q,I),k=I),e){const e=O;O=k,k=e}break}}}}}class w{constructor(e,t,i){this.ratio=e,this.x=t,this.y=i}}class S{constructor(e,t,i,r=8,n=8){this.lines=[],this.starts=[],this.validateTessellation=!0,this.pixelRatio=r,this.pixelMargin=n,this.tileSize=s.o*r,this.dz=e,this.yPos=t,this.xPos=i}setPixelMargin(e){e!==this.pixelMargin&&(this.pixelMargin=e,this.setExtent(this._extent))}setExtent(e){this._extent=e,this.finalRatio=this.tileSize/e*(1<<this.dz);let t=this.pixelRatio*this.pixelMargin;t/=this.finalRatio;const i=e>>this.dz;t>i&&(t=i),this.margin=t,this.xmin=i*this.xPos-t,this.ymin=i*this.yPos-t,this.xmax=this.xmin+i+2*t,this.ymax=this.ymin+i+2*t}reset(e){this.type=e,this.lines=[],this.starts=[],this.line=null,this.start=0}moveTo(e,t){this._pushLine(),this._prevIsIn=this._isIn(e,t),this._moveTo(e,t,this._prevIsIn),this._prevPt=new a(e,t),this._firstPt=new a(e,t),this._dist=0}lineTo(e,t){const i=this._isIn(e,t),r=new a(e,t),s=a.distance(this._prevPt,r);let n,o,l,h,u,c,d,p;if(i)this._prevIsIn?this._lineTo(e,t,!0):(n=this._prevPt,o=r,l=this._intersect(o,n),this.start=this._dist+s*(1-this._r),this._lineTo(l.x,l.y,!0),this._lineTo(o.x,o.y,!0));else if(this._prevIsIn)o=this._prevPt,n=r,l=this._intersect(o,n),this._lineTo(l.x,l.y,!0),this._lineTo(n.x,n.y,!1);else{const e=this._prevPt,t=r;if(e.x<=this.xmin&&t.x<=this.xmin||e.x>=this.xmax&&t.x>=this.xmax||e.y<=this.ymin&&t.y<=this.ymin||e.y>=this.ymax&&t.y>=this.ymax)this._lineTo(t.x,t.y,!1);else{const i=[];if((e.x<this.xmin&&t.x>this.xmin||e.x>this.xmin&&t.x<this.xmin)&&(h=(this.xmin-e.x)/(t.x-e.x),p=e.y+h*(t.y-e.y),p<=this.ymin?c=!1:p>=this.ymax?c=!0:i.push(new w(h,this.xmin,p))),(e.x<this.xmax&&t.x>this.xmax||e.x>this.xmax&&t.x<this.xmax)&&(h=(this.xmax-e.x)/(t.x-e.x),p=e.y+h*(t.y-e.y),p<=this.ymin?c=!1:p>=this.ymax?c=!0:i.push(new w(h,this.xmax,p))),(e.y<this.ymin&&t.y>this.ymin||e.y>this.ymin&&t.y<this.ymin)&&(h=(this.ymin-e.y)/(t.y-e.y),d=e.x+h*(t.x-e.x),d<=this.xmin?u=!1:d>=this.xmax?u=!0:i.push(new w(h,d,this.ymin))),(e.y<this.ymax&&t.y>this.ymax||e.y>this.ymax&&t.y<this.ymax)&&(h=(this.ymax-e.y)/(t.y-e.y),d=e.x+h*(t.x-e.x),d<=this.xmin?u=!1:d>=this.xmax?u=!0:i.push(new w(h,d,this.ymax))),0===i.length)u?c?this._lineTo(this.xmax,this.ymax,!0):this._lineTo(this.xmax,this.ymin,!0):c?this._lineTo(this.xmin,this.ymax,!0):this._lineTo(this.xmin,this.ymin,!0);else if(i.length>1&&i[0].ratio>i[1].ratio)this.start=this._dist+s*i[1].ratio,this._lineTo(i[1].x,i[1].y,!0),this._lineTo(i[0].x,i[0].y,!0);else{this.start=this._dist+s*i[0].ratio;for(let e=0;e<i.length;e++)this._lineTo(i[e].x,i[e].y,!0)}this._lineTo(t.x,t.y,!1)}}this._dist+=s,this._prevIsIn=i,this._prevPt=r}close(){if(this.line.length>2){const e=this._firstPt,t=this._prevPt;e.x===t.x&&e.y===t.y||this.lineTo(e.x,e.y);const i=this.line;let r=i.length;for(;r>=4&&(i[0].x===i[1].x&&i[0].x===i[r-2].x||i[0].y===i[1].y&&i[0].y===i[r-2].y);)i.pop(),i[0].x=i[r-2].x,i[0].y=i[r-2].y,--r}}result(e=!0){return this._pushLine(),0===this.lines.length?null:(3===this.type&&e&&C.simplify(this.tileSize,this.margin*this.finalRatio,this.lines),this.lines)}resultWithStarts(){if(2!==this.type)throw new Error("Only valid for lines");this._pushLine();const e=this.lines,t=e.length;if(0===t)return null;const i=[];for(let r=0;r<t;r++)i.push({line:e[r],start:this.starts[r]||0});return i}_isIn(e,t){return e>=this.xmin&&e<=this.xmax&&t>=this.ymin&&t<=this.ymax}_intersect(e,t){let i,r,s;if(t.x>=this.xmin&&t.x<=this.xmax)r=t.y<=this.ymin?this.ymin:this.ymax,s=(r-e.y)/(t.y-e.y),i=e.x+s*(t.x-e.x);else if(t.y>=this.ymin&&t.y<=this.ymax)i=t.x<=this.xmin?this.xmin:this.xmax,s=(i-e.x)/(t.x-e.x),r=e.y+s*(t.y-e.y);else{r=t.y<=this.ymin?this.ymin:this.ymax,i=t.x<=this.xmin?this.xmin:this.xmax;const n=(i-e.x)/(t.x-e.x),a=(r-e.y)/(t.y-e.y);n<a?(s=n,r=e.y+n*(t.y-e.y)):(s=a,i=e.x+a*(t.x-e.x))}return this._r=s,new a(i,r)}_pushLine(){this.line&&(1===this.type?this.line.length>0&&(this.lines.push(this.line),this.starts.push(this.start)):2===this.type?this.line.length>1&&(this.lines.push(this.line),this.starts.push(this.start)):3===this.type&&this.line.length>3&&(this.lines.push(this.line),this.starts.push(this.start))),this.line=[],this.start=0}_moveTo(e,t,i){3!==this.type?i&&(e=Math.round((e-(this.xmin+this.margin))*this.finalRatio),t=Math.round((t-(this.ymin+this.margin))*this.finalRatio),this.line.push(new a(e,t))):(i||(e<this.xmin&&(e=this.xmin),e>this.xmax&&(e=this.xmax),t<this.ymin&&(t=this.ymin),t>this.ymax&&(t=this.ymax)),e=Math.round((e-(this.xmin+this.margin))*this.finalRatio),t=Math.round((t-(this.ymin+this.margin))*this.finalRatio),this.line.push(new a(e,t)),this._is_h=!1,this._is_v=!1)}_lineTo(e,t,i){let r,s;if(3!==this.type)if(i){if(e=Math.round((e-(this.xmin+this.margin))*this.finalRatio),t=Math.round((t-(this.ymin+this.margin))*this.finalRatio),this.line.length>0&&(r=this.line[this.line.length-1],r.equals(e,t)))return;this.line.push(new a(e,t))}else this.line&&this.line.length>0&&this._pushLine();else if(i||(e<this.xmin&&(e=this.xmin),e>this.xmax&&(e=this.xmax),t<this.ymin&&(t=this.ymin),t>this.ymax&&(t=this.ymax)),e=Math.round((e-(this.xmin+this.margin))*this.finalRatio),t=Math.round((t-(this.ymin+this.margin))*this.finalRatio),this.line&&this.line.length>0){r=this.line[this.line.length-1];const i=r.x===e,n=r.y===t;if(i&&n)return;this._is_h&&i||this._is_v&&n?(r.x=e,r.y=t,s=this.line[this.line.length-2],s.x===e&&s.y===t?(this.line.pop(),this.line.length<=1?(this._is_h=!1,this._is_v=!1):(s=this.line[this.line.length-2],this._is_h=s.x===e,this._is_v=s.y===t)):(this._is_h=s.x===e,this._is_v=s.y===t)):(this.line.push(new a(e,t)),this._is_h=i,this._is_v=n)}else this.line.push(new a(e,t))}}class I{setExtent(e){this._ratio=4096===e?1:4096/e}get validateTessellation(){return this._ratio<1}reset(e){this.lines=[],this.line=null}moveTo(e,t){this.line&&this.lines.push(this.line),this.line=[];const i=this._ratio;this.line.push(new a(e*i,t*i))}lineTo(e,t){const i=this._ratio;this.line.push(new a(e*i,t*i))}close(){const e=this.line;e&&!e[0].isEqual(e[e.length-1])&&e.push(e[0])}result(){return this.line&&this.lines.push(this.line),0===this.lines.length?null:this.lines}}class C{static simplify(e,t,i){if(!i)return;const r=-t,s=e+t,n=-t,a=e+t,o=[],l=[],h=i.length;for(let e=0;e<h;++e){const t=i[e];if(!t||t.length<2)continue;let h,u=t[0];const c=t.length;for(let i=1;i<c;++i)h=t[i],u.x===h.x&&(u.x<=r&&(u.y>h.y?(o.push(e),o.push(i),o.push(0),o.push(-1)):(l.push(e),l.push(i),l.push(0),l.push(-1))),u.x>=s&&(u.y<h.y?(o.push(e),o.push(i),o.push(1),o.push(-1)):(l.push(e),l.push(i),l.push(1),l.push(-1)))),u.y===h.y&&(u.y<=n&&(u.x<h.x?(o.push(e),o.push(i),o.push(2),o.push(-1)):(l.push(e),l.push(i),l.push(2),l.push(-1))),u.y>=a&&(u.x>h.x?(o.push(e),o.push(i),o.push(3),o.push(-1)):(l.push(e),l.push(i),l.push(3),l.push(-1)))),u=h}if(0===o.length||0===l.length)return;C.fillParent(i,l,o),C.fillParent(i,o,l);const u=[];C.calcDeltas(u,l,o),C.calcDeltas(u,o,l),C.addDeltas(u,i)}static fillParent(e,t,i){const r=i.length,s=t.length;for(let a=0;a<s;a+=4){const s=t[a],o=t[a+1],l=t[a+2],h=e[s][o-1],u=e[s][o];let c=8092,d=-1;for(let t=0;t<r;t+=4){if(i[t+2]!==l)continue;const r=i[t],s=i[t+1],a=e[r][s-1],o=e[r][s];switch(l){case 0:case 1:if((0,n.g)(h.y,a.y,o.y)&&(0,n.g)(u.y,a.y,o.y)){const e=Math.abs(o.y-a.y);e<c&&(c=e,d=t)}break;case 2:case 3:if((0,n.g)(h.x,a.x,o.x)&&(0,n.g)(u.x,a.x,o.x)){const e=Math.abs(o.x-a.x);e<c&&(c=e,d=t)}}}t[a+3]=d}}static calcDeltas(e,t,i){const r=t.length;for(let s=0;s<r;s+=4){const r=[],n=C.calcDelta(s,t,i,r);e.push(t[s]),e.push(t[s+1]),e.push(t[s+2]),e.push(n)}}static calcDelta(e,t,i,r){const s=t[e+3];if(-1===s)return 0;const n=r.length;return n>1&&r[n-2]===s?0:(r.push(s),C.calcDelta(s,i,t,r)+1)}static addDeltas(e,t){const i=e.length;let r=0;for(let t=0;t<i;t+=4){const i=e[t+3];i>r&&(r=i)}for(let s=0;s<i;s+=4){const i=t[e[s]],n=e[s+1],a=r-e[s+3];switch(e[s+2]){case 0:i[n-1].x-=a,i[n].x-=a,1===n&&(i[i.length-1].x-=a),n===i.length-1&&(i[0].x-=a);break;case 1:i[n-1].x+=a,i[n].x+=a,1===n&&(i[i.length-1].x+=a),n===i.length-1&&(i[0].x+=a);break;case 2:i[n-1].y-=a,i[n].y-=a,1===n&&(i[i.length-1].y-=a),n===i.length-1&&(i[0].y-=a);break;case 3:i[n-1].y+=a,i[n].y+=a,1===n&&(i[i.length-1].y+=a),n===i.length-1&&(i[0].y+=a)}}}}},79061:(e,t,i)=>{"use strict";i.d(t,{o:()=>l});var r=i(80219),s=i(5772),n=i(80163),a=i(26799);const o=(e,t)=>e.key.level-t.key.level!=0?e.key.level-t.key.level:e.key.row-t.key.row!=0?e.key.row-t.key.row:e.key.col-t.key.col;class l extends n.o{constructor(e){super(),this._tileInfoView=e}get requiresDedicatedFBO(){return!1}renderChildren(e){this.sortChildren(o),this.setStencilReference(),super.renderChildren(e)}createRenderParams(e){const{state:t}=e;return{...super.createRenderParams(e),requiredLevel:this._tileInfoView.getClosestInfoForScale(t.scale).level,displayLevel:this._tileInfoView.tileInfo.scaleToZoom(t.scale)}}prepareRenderPasses(e){const t=super.prepareRenderPasses(e);return t.push(e.registerRenderPass({name:"stencil",brushes:[a.a],drawPhase:s.I.DEBUG|s.I.MAP|s.I.HIGHLIGHT,target:()=>this.getStencilTarget()})),(0,r.c)("esri-tiles-debug")&&t.push(e.registerRenderPass({name:"tileInfo",brushes:[a.m],drawPhase:s.I.DEBUG,target:()=>this.children})),t}getStencilTarget(){return this.children}updateTransforms(e){for(const t of this.children){const i=this._tileInfoView.getTileResolution(t.key);t.setTransform(e,i)}}setStencilReference(){let e=1;for(const t of this.children)t.stencilRef=e++}}},36542:(e,t,i)=>{"use strict";i.d(t,{r:()=>a});var r=i(20215),s=i(21779),n=i(29218);class a{constructor(e){if(e instanceof s.j)this._tilemapCache=e;else{if(!e||!("index"in e))throw new Error("Invalid tilemap!");this._tilemap=e.index}}dataKey(e,t){if(this._tilemapCache){const{level:i,row:s,col:a}=e,o=new n.e(e);return this._tilemapCache.fetchAvailabilityUpsample(i,s,a,o,t).then((()=>(o.world=e.world,o))).catch((e=>{if((0,r.g)(e))throw e;return null}))}return this._getIndexedDataKey(e)}forEach(e,t,i,r,s){this._callback=s,this._maxLevel=t+e,this._forEach(this._tilemap,t,i,r)}_forEach(e,t,i,r){0!==e&&(this._callback(t,i,r),t!==this._maxLevel&&"object"==typeof e&&(this._forEach(e[0],t+1,2*i,2*r),this._forEach(e[1],t+1,2*i,2*r+1),this._forEach(e[2],t+1,2*i+1,2*r),this._forEach(e[3],t+1,2*i+1,2*r+1)))}_getIndexedDataKey(e){const t=[e];if(e.level<0||e.row<0||e.col<0||e.row>>e.level>0||e.col>>e.level>0)return Promise.resolve(null);let i=e;for(;0!==i.level;)i=new n.e(i.level-1,i.row>>1,i.col>>1,i.world),t.push(i);let r,s,a=this._tilemap,o=t.pop();if(1===a)return Promise.resolve(o);for(;t.length;)if(r=t.pop(),s=(1&r.col)+((1&r.row)<<1),a){if(0===a[s]){o=null;break}if(1===a[s]){o=r;break}o=r,a=a[s]}return Promise.resolve(o)}}},49038:(e,t,i)=>{"use strict";i.d(t,{i:()=>l});var r=i(78155),s=i(20215),n=i(80219),a=i(88903),o=i(30337);const l=e=>{let t=class extends e{async fetchPopupFeatures(e,t){const{layer:i}=this;if(!e)return Promise.reject(new s.s("tilelayerview:fetchPopupFeatures","Nothing to fetch without area",{layer:i}));if("tile"!==i.type)return Promise.reject(new s.s("tilelayerview:fetchPopupFeatures","Layer type should be 'tile'",{type:i.type}));const r=this.get("view.scale"),a=i.allSublayers.toArray().filter((e=>{const t=0===e.minScale||r<=e.minScale,i=0===e.maxScale||r>=e.maxScale;return e.popupTemplate&&e.popupEnabled&&e.visible&&t&&i}));return(0,s.A)(a.map((async i=>{const r=i.createQuery(),s=(0,n.r)(t)?t.event:null,a=(0,o.s)({renderer:i.renderer,event:s});return r.geometry=this.createFetchPopupFeaturesQueryGeometry(e,a),r.outFields=await i.popupTemplate.getRequiredFields(),(await i.queryFeatures(r)).features}))).then((e=>[].concat(...e.map((e=>e.value)).filter(Boolean))))}};return(0,r.e)([(0,a.y)()],t.prototype,"layer",void 0),t=(0,r.e)([(0,a.n)("esri.layers.mixins.TileLayerView")],t),t}},84352:(e,t,i)=>{"use strict";i.d(t,{M:()=>G,O:()=>H,c:()=>O,i:()=>b,l:()=>ee,u:()=>Y,v:()=>z});var r=i(80219),s=i(29831),n=i(90258),a=i(20215),o=i(60816),l=i(84271),h=i(2502),u=i(43356),c=i(5772),d=i(25894),p=i(80987),f=i(57424),y=i(78155),m=i(98548),g=i(58404),_=i(18143),x=i(29218),v=i(93443);function b(e,t){if(!(this instanceof b))return new b(e,t);this._maxEntries=Math.max(4,e||9),this._minEntries=Math.max(2,Math.ceil(.4*this._maxEntries)),t&&("function"==typeof t?this.toBBox=t:this._initFormat(t)),this.clear()}function w(e,t,i){if(!i)return t.indexOf(e);for(var r=0;r<t.length;r++)if(i(e,t[r]))return r;return-1}function S(e,t){I(e,0,e.children.length,t,e)}function I(e,t,i,r,s){s||(s=D(null)),s.minX=1/0,s.minY=1/0,s.maxX=-1/0,s.maxY=-1/0;for(var n,a=t;a<i;a++)n=e.children[a],C(s,e.leaf?r(n):n);return s}function C(e,t){return e.minX=Math.min(e.minX,t.minX),e.minY=Math.min(e.minY,t.minY),e.maxX=Math.max(e.maxX,t.maxX),e.maxY=Math.max(e.maxY,t.maxY),e}function M(e,t){return e.minX-t.minX}function T(e,t){return e.minY-t.minY}function E(e){return(e.maxX-e.minX)*(e.maxY-e.minY)}function F(e){return e.maxX-e.minX+(e.maxY-e.minY)}function A(e,t){return(Math.max(t.maxX,e.maxX)-Math.min(t.minX,e.minX))*(Math.max(t.maxY,e.maxY)-Math.min(t.minY,e.minY))}function R(e,t){var i=Math.max(e.minX,t.minX),r=Math.max(e.minY,t.minY),s=Math.min(e.maxX,t.maxX),n=Math.min(e.maxY,t.maxY);return Math.max(0,s-i)*Math.max(0,n-r)}function P(e,t){return e.minX<=t.minX&&e.minY<=t.minY&&t.maxX<=e.maxX&&t.maxY<=e.maxY}function L(e,t){return t.minX<=e.maxX&&t.minY<=e.maxY&&t.maxX>=e.minX&&t.maxY>=e.minY}function D(e){return{children:e,height:1,leaf:!0,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}function N(e,t,i,r,s){for(var n,a=[t,i];a.length;)(i=a.pop())-(t=a.pop())<=r||(n=t+Math.ceil((i-t)/r/2)*r,(0,f.a)(e,n,t,i,s),a.push(t,n,n,i))}b.prototype={all:function(){return this._all(this.data,[])},search:function(e){var t=this.data,i=[],r=this.toBBox;if(!L(e,t))return i;for(var s,n,a,o,l=[];t;){for(s=0,n=t.children.length;s<n;s++)a=t.children[s],L(e,o=t.leaf?r(a):a)&&(t.leaf?i.push(a):P(e,o)?this._all(a,i):l.push(a));t=l.pop()}return i},collides:function(e){var t=this.data,i=this.toBBox;if(!L(e,t))return!1;for(var r,s,n,a,o=[];t;){for(r=0,s=t.children.length;r<s;r++)if(n=t.children[r],L(e,a=t.leaf?i(n):n)){if(t.leaf||P(e,a))return!0;o.push(n)}t=o.pop()}return!1},load:function(e){if(!e||!e.length)return this;if(e.length<this._minEntries){for(var t=0,i=e.length;t<i;t++)this.insert(e[t]);return this}var r=this._build(e.slice(),0,e.length-1,0);if(this.data.children.length)if(this.data.height===r.height)this._splitRoot(this.data,r);else{if(this.data.height<r.height){var s=this.data;this.data=r,r=s}this._insert(r,this.data.height-r.height-1,!0)}else this.data=r;return this},insert:function(e){return e&&this._insert(e,this.data.height-1),this},clear:function(){return this.data=D([]),this},remove:function(e,t){if(!e)return this;for(var i,r,s,n,a=this.data,o=this.toBBox(e),l=[],h=[];a||l.length;){if(a||(a=l.pop(),r=l[l.length-1],i=h.pop(),n=!0),a.leaf&&-1!==(s=w(e,a.children,t)))return a.children.splice(s,1),l.push(a),this._condense(l),this;n||a.leaf||!P(a,o)?r?(i++,a=r.children[i],n=!1):a=null:(l.push(a),h.push(i),i=0,r=a,a=a.children[0])}return this},toBBox:function(e){return e},compareMinX:M,compareMinY:T,toJSON:function(){return this.data},fromJSON:function(e){return this.data=e,this},_all:function(e,t){for(var i=[];e;)e.leaf?t.push.apply(t,e.children):i.push.apply(i,e.children),e=i.pop();return t},_build:function(e,t,i,r){var s,n=i-t+1,a=this._maxEntries;if(n<=a)return S(s=D(e.slice(t,i+1)),this.toBBox),s;r||(r=Math.ceil(Math.log(n)/Math.log(a)),a=Math.ceil(n/Math.pow(a,r-1))),(s=D([])).leaf=!1,s.height=r;var o,l,h,u,c=Math.ceil(n/a),d=c*Math.ceil(Math.sqrt(a));for(N(e,t,i,d,this.compareMinX),o=t;o<=i;o+=d)for(N(e,o,h=Math.min(o+d-1,i),c,this.compareMinY),l=o;l<=h;l+=c)u=Math.min(l+c-1,h),s.children.push(this._build(e,l,u,r-1));return S(s,this.toBBox),s},_chooseSubtree:function(e,t,i,r){for(var s,n,a,o,l,h,u,c;r.push(t),!t.leaf&&r.length-1!==i;){for(u=c=1/0,s=0,n=t.children.length;s<n;s++)l=E(a=t.children[s]),(h=A(e,a)-l)<c?(c=h,u=l<u?l:u,o=a):h===c&&l<u&&(u=l,o=a);t=o||t.children[0]}return t},_insert:function(e,t,i){var r=this.toBBox,s=i?e:r(e),n=[],a=this._chooseSubtree(s,this.data,t,n);for(a.children.push(e),C(a,s);t>=0&&n[t].children.length>this._maxEntries;)this._split(n,t),t--;this._adjustParentBBoxes(s,n,t)},_split:function(e,t){var i=e[t],r=i.children.length,s=this._minEntries;this._chooseSplitAxis(i,s,r);var n=this._chooseSplitIndex(i,s,r),a=D(i.children.splice(n,i.children.length-n));a.height=i.height,a.leaf=i.leaf,S(i,this.toBBox),S(a,this.toBBox),t?e[t-1].children.push(a):this._splitRoot(i,a)},_splitRoot:function(e,t){this.data=D([e,t]),this.data.height=e.height+1,this.data.leaf=!1,S(this.data,this.toBBox)},_chooseSplitIndex:function(e,t,i){var r,s,n,a,o,l,h,u;for(l=h=1/0,r=t;r<=i-t;r++)a=R(s=I(e,0,r,this.toBBox),n=I(e,r,i,this.toBBox)),o=E(s)+E(n),a<l?(l=a,u=r,h=o<h?o:h):a===l&&o<h&&(h=o,u=r);return u},_chooseSplitAxis:function(e,t,i){var r=e.leaf?this.compareMinX:M,s=e.leaf?this.compareMinY:T;this._allDistMargin(e,t,i,r)<this._allDistMargin(e,t,i,s)&&e.children.sort(r)},_allDistMargin:function(e,t,i,r){e.children.sort(r);var s,n,a=this.toBBox,o=I(e,0,t,a),l=I(e,i-t,i,a),h=F(o)+F(l);for(s=t;s<i-t;s++)n=e.children[s],C(o,e.leaf?a(n):n),h+=F(o);for(s=i-t-1;s>=t;s--)n=e.children[s],C(l,e.leaf?a(n):n),h+=F(l);return h},_adjustParentBBoxes:function(e,t,i){for(var r=i;r>=0;r--)C(t[r],e)},_condense:function(e){for(var t,i=e.length-1;i>=0;i--)0===e[i].children.length?i>0?(t=e[i-1].children).splice(t.indexOf(e[i]),1):this.clear():S(e[i],this.toBBox)},_initFormat:function(e){var t=["return a"," - b",";"];this.compareMinX=new Function("a","b",t.join(e[0])),this.compareMinY=new Function("a","b",t.join(e[1])),this.toBBox=new Function("a","return {minX: a"+e[0]+", minY: a"+e[1]+", maxX: a"+e[2]+", maxY: a"+e[3]+"};")}};class O extends n.h{constructor(e,t,i){super(e),this._featureIndex=-1,this._dateFields=new Set,this._geometryType=i,this._features=t}static fromFeatures(e,t,i){const r=(0,s.K)([],e,t,!1,!1,i);for(let t=0;t<r.length;t++)r[t].displayId=e[t].displayId;return O.fromOptimizedFeatures(r,t)}static fromFeatureSet(e,t){const i=(0,s.o)(e,t);return O.fromOptimizedFeatureSet(i)}static fromOptimizedFeatureSet(e){const{features:t,geometryType:i}=e,r=O.fromOptimizedFeatures(t,i);r._exceededTransferLimit=e.exceededTransferLimit,r._transform=e.transform;for(const t of e.fields)"esriFieldTypeDate"===t.type&&r._dateFields.add(t.name);return r}static fromOptimizedFeatures(e,t,i){const r=n.h.createInstance(),s=new O(r,e,t);return s._transform=i,s}get _current(){return this._features[this._featureIndex]}get geometryType(){return this._geometryType}get hasFeatures(){return!!this._features.length}get hasNext(){return this._featureIndex+1<this._features.length}get exceededTransferLimit(){return this._exceededTransferLimit}get hasZ(){return!1}get hasM(){return!1}removeIds(e){const t=new Set(e);this._features=this._features.filter((e=>!t.has(e.objectId)))}append(e){for(const t of e)this._features.push(t)}getSize(){return this._features.length}getCursor(){return this.copy()}getQuantizationTransform(){return this._transform}getAttributeHash(){let e="";for(const t in this._current.attributes)e+=this._current.attributes[t];return e}getIndex(){return this._featureIndex}setIndex(e){this._featureIndex=e}getObjectId(){return this._current.objectId}getDisplayId(){return this._current.displayId}setDisplayId(e){this._current.displayId=e}getGroupId(){return this._current.groupId}setGroupId(e){this._current.groupId=e}copy(){const e=new O(this.instance,this._features,this.geometryType);return this.copyInto(e),e}next(){for(;++this._featureIndex<this._features.length&&!this._getExists(););return this._featureIndex<this._features.length}readLegacyFeature(){return(0,s.W)(this._current,this.geometryType,this.hasZ,this.hasM)}readOptimizedFeature(){return this._current}readLegacyPointGeometry(){return this.readGeometry()?{x:this.getX(),y:this.getY()}:null}readLegacyGeometry(){const e=this.readGeometry();return(0,s.e)(e,this.geometryType,this.hasZ,this.hasM)}readLegacyCentroid(){const e=this.readCentroid();return e?{x:e.coords[0]*this._sx+this._tx,y:e.coords[1]*this._sy+this._ty}:null}readGeometryArea(){return(0,s.y)(this._current.geometry,2)}readUnquantizedGeometry(){const e=this.readGeometry();if("esriGeometryPoint"===this.geometryType||!e)return e;const t=e.clone();return function({coords:e,lengths:t}){let i=0;for(const r of t){for(let t=1;t<r;t++)e[2*(i+t)]+=e[2*(i+t)-2],e[2*(i+t)+1]+=e[2*(i+t)-1];i+=r}}(t),t}readHydratedGeometry(){const e=this._current.geometry;if(!e)return null;const t=e.clone();return(0,r.r)(this._transform)&&(0,s.a)(t,t,this.hasZ,this.hasM,this._transform),t}getXHydrate(){const e=this._current.geometry.coords[0],t=this.getQuantizationTransform();return(0,r.t)(t)?e:e*t.scale[0]+t.translate[0]}getYHydrate(){const e=this._current.geometry.coords[1],t=this.getQuantizationTransform();return(0,r.t)(t)?e:t.translate[1]-e*t.scale[1]}getX(){return this._current.geometry.coords[0]*this._sx+this._tx}getY(){return this._current.geometry.coords[1]*this._sy+this._ty}readGeometry(){if(!this._current.hasGeometry)return null;const e=this._current.geometry.clone();if(e.isPoint)return e.coords[0]=e.coords[0]*this._sx+this._tx,e.coords[1]=e.coords[1]*this._sy+this._ty,e;let t=0;for(const i of e.lengths)e.coords[2*t]=e.coords[2*t]*this._sx+this._tx,e.coords[2*t+1]=e.coords[2*t+1]*this._sy+this._ty,t+=i;return e}readCentroid(){if(!this._current.hasGeometry)return null;if(!this._current.centroid){const e=this._computeCentroid();if(!e)return null;e.coords[0]=(e.coords[0]-this._tx)/this._sx,e.coords[1]=(e.coords[1]-this._ty)/this._sy,this._current.centroid=e}const e=this._current.centroid.clone();return e.coords[0]=e.coords[0]*this._sx+this._tx,e.coords[1]=e.coords[1]*this._sx+this._ty,e}_readAttribute(e,t){const i=this._current.attributes[e];if(void 0!==i)return null!=i&&t&&this._dateFields.has(e)?new Date(i):i;const r=this.readAttributes(),s=e.toLocaleLowerCase().trim();for(const e in r)if(e.toLocaleLowerCase().trim()===s){const i=this._current.attributes[e];return null!=i&&t&&this._dateFields.has(e)?new Date(i):i}}copyInto(e){super.copyInto(e),e._featureIndex=this._featureIndex,e._transform=this._transform,e._dateFields=this._dateFields}_readAttributes(){return this._current.attributes}}const k=r.n.getLogger("esri.views.layers.2d.features.support.AttributeStore"),V=(0,d.n)(d.l,k),U=e=>(2147483648&e)>>>31,G=e=>2147483647&e;function z(e){return 1===U(e)}const B={sharedArrayBuffer:(0,r.c)("esri-shared-array-buffer"),atomics:(0,r.c)("esri-atomics")};function j(e,t){return i=>t(e(i))}class q{constructor(e,t,i,r){this.size=0,this.texelSize=4;const{pixelType:s,layout:n,textureOnly:a}=r;this.textureOnly=a||!1,this.pixelType=s,this._ctype=t,this.layout=n,this._resetRange(),this._shared=e,this.size=i,a||(this.data=this._initData(s,i,e,t))}get buffer(){return(0,r.A)(this.data,(e=>e.buffer))}unsetComponentAllTexels(e,t){const i=(0,r.f)(this.data);for(let r=0;r<this.size*this.size;r++)i[r*this.texelSize+e]&=~t;this.dirtyStart=0,this.dirtyEnd=this.size*this.size-1}setComponentAllTexels(e,t){const i=(0,r.f)(this.data);for(let r=0;r<this.size*this.size;r++)i[r*this.texelSize+e]|=255&t;this.dirtyStart=0,this.dirtyEnd=this.size*this.size-1}setComponent(e,t,i){const s=(0,r.f)(this.data);for(const r of i)s[r*this.texelSize+e]|=t,this.dirtyStart=Math.min(this.dirtyStart,r),this.dirtyEnd=Math.max(this.dirtyEnd,r)}setComponentTexel(e,t,i){(0,r.f)(this.data)[i*this.texelSize+e]|=t,this.dirtyStart=Math.min(this.dirtyStart,i),this.dirtyEnd=Math.max(this.dirtyEnd,i)}unsetComponentTexel(e,t,i){(0,r.f)(this.data)[i*this.texelSize+e]&=~t,this.dirtyStart=Math.min(this.dirtyStart,i),this.dirtyEnd=Math.max(this.dirtyEnd,i)}getData(e,t){const i=G(e);return(0,r.f)(this.data)[i*this.texelSize+t]}setData(e,t,i){const r=G(e),s=1<<t;0!=(this.layout&s)?(this.data[r*this.texelSize+t]=i,this.dirtyStart=Math.min(this.dirtyStart,r),this.dirtyEnd=Math.max(this.dirtyEnd,r)):k.error("mapview-attributes-store","Tried to set a value for a texel's readonly component")}lock(){5121===this.pixelType&&this._shared&&B.atomics&&"local"!==this._ctype&&Atomics.store(this.data,0,1)}unlock(){5121===this.pixelType&&this._shared&&B.atomics&&"local"!==this._ctype&&Atomics.store(this.data,0,0)}expand(e){if(this.size=e,!this.textureOnly){const t=this._initData(this.pixelType,e,this._shared,this._ctype),i=(0,r.f)(this.data);t.set(i),this.data=t}}toMessage(){const e=this.dirtyStart,t=this.dirtyEnd,i=this.texelSize;if(e>t)return null;this._resetRange();const s=!(this._shared||"local"===this._ctype),n=this.pixelType,a=this.layout,o=(0,r.f)(this.data);return{start:e,end:t,data:s&&o.slice(e*i,(t+1)*i)||null,pixelType:n,layout:a}}_initData(e,t,i,r){const s=i&&"local"!==r?SharedArrayBuffer:ArrayBuffer,n=(0,c.H)(e),a=new n(new s(t*t*4*n.BYTES_PER_ELEMENT));for(let e=0;e<a.length;e+=4)a[e+1]=255;return a}_resetRange(){this.dirtyStart=2147483647,this.dirtyEnd=0}}class H{constructor(e,t){this._client=e,this.config=t,this._attributeComputeMap=new Map,this._blocks=new Array,this._filters=new Array(u.N),this._targetType=0,this._abortController=(0,a.h)(),this._hasScaleExpr=!1,this._size=32,this._idsToHighlight=new Set;const i=t.supportsTextureFloat?5126:5121;V(`Creating AttributeStore ${B.sharedArrayBuffer?"with":"without"} shared memory`),this._blockDescriptors=[{pixelType:5121,layout:1},{pixelType:5121,layout:15,textureOnly:!0},{pixelType:i,layout:15},{pixelType:i,layout:15}],this._blocks=this._blockDescriptors.map((()=>null))}destroy(){this._abortController.abort()}get hasScaleExpr(){return this._hasScaleExpr}get _signal(){return this._abortController.signal}update(e,t){this.config=t;const i=t.schema.processors[0].storage,s=(0,l.m)(this._schema,i);if((e.targets.feature||e.targets.aggregate)&&(e.storage.data=!0),s&&((0,r.c)("esri-2d-update-debug")&&console.debug("Applying Update - AttributeStore:",s),e.storage.data=!0,this._schema=i,this._attributeComputeMap.clear(),!(0,r.t)(i))){switch(i.target){case"feature":this._targetType=0;break;case"aggregate":this._targetType=1}if("subtype"===i.type)for(const e in i.mapping){const t=i.mapping[e];if((0,r.r)(t))for(const e of t.mapping)this._bindAttribute(e)}else for(const e of i.mapping)this._bindAttribute(e)}}onTileData(e,t){if((0,r.t)(t.addOrUpdate))return;const i=t.addOrUpdate.getCursor();for(;i.next();){const e=i.getDisplayId();this.setAttributeData(e,i)}}invalidateResources(){this._createResourcesPromise=null,this._abortController.abort(),this._abortController=(0,a.h)()}async setHighlight(e,t){const i=this._getBlock(0),r=t.map((e=>G(e)));i.lock(),i.unsetComponentAllTexels(0,1),i.setComponent(0,1,r),i.unlock(),this._idsToHighlight.clear();for(const t of e)this._idsToHighlight.add(t);await this.sendUpdates()}async updateFilters(e,t){const{config:i,service:s,spatialReference:n}=t,{filters:a}=i,o=a.map(((e,t)=>this._updateFilter(e,t,s,n)));(await Promise.all(o)).some((e=>e))&&(e.storage.filters=!0,(0,r.c)("esri-2d-update-debug")&&console.debug("Applying Update - AttributeStore:","Filters changed"))}setData(e,t,i,r){const s=G(e);this._ensureSizeForTexel(s),this._getBlock(t).setData(e,i,r)}getData(e,t,i){return this._getBlock(t).getData(e,i)}getHighlightFlag(e){return this._idsToHighlight.has(e)?u.O:0}unsetAttributeData(e){const t=G(e);this._getBlock(0).setData(t,0,0)}setAttributeData(e,t){const i=G(e);if(this._ensureSizeForTexel(i),this._getBlock(0).setData(i,0,this.getFilterFlags(t)),this._targetType!==U(e))return;const r=this._attributeComputeMap,s=this.config.supportsTextureFloat?1:2;r.size&&r.forEach(((e,r)=>{const n=r*s%4,a=Math.floor(r*s/4),l=this._getBlock(a+u.K),h=e(t);if(this.config.supportsTextureFloat)l.setData(i,n,h);else if(h===u.c)l.setData(i,n,255),l.setData(i,n+1,255);else{const e=(0,o.o)(Math.round(h),-32767,32766)+32768,t=255&e,r=(65280&e)>>8;l.setData(i,n,t),l.setData(i,n+1,r)}}))}sendUpdates(){if(this._nextUpdate)return this._nextUpdate.promise;if(this._currUpdate)return this._nextUpdate=(0,a.D)(),this._nextUpdate.promise;const e={blocks:this._blocks.map((e=>(0,r.r)(e)?e.toMessage():null))};return this._currUpdate=this._createResources().then((()=>{const t=()=>{if(this._currUpdate=null,this._nextUpdate){const e=this._nextUpdate;this._nextUpdate=null,this.sendUpdates().then((()=>e.resolve()))}},i=this._client.update(e,this._signal).then(t).catch(t);return this._client.render(this._signal),i})).catch((e=>(0,a.g)(e)?(this._createResourcesPromise=null,this._createResources()):(k.error(new a.s("mapview-attribute-store","Encountered an error during client update",e)),Promise.resolve()))),this._currUpdate}_ensureSizeForTexel(e){for(;e>=this._size*this._size;)if(this._expand())return}_bindAttribute(e){let t;if(null!=e.fieldIndex)e.normalizationField&&k.warn("mapview-arcade","Ignoring normalizationField specified with an arcade expression which is not supported."),t=t=>t.getComputedNumericAtIndex(e.fieldIndex);else{if(!e.field)return;t=e.normalizationField?t=>{const i=t.readAttribute(e.normalizationField);return i?t.readAttribute(e.field)/i:null}:t=>t.readAttribute(e.field)}e.valueRepresentation&&(t=j(t,(t=>(0,d.r)(t,e.valueRepresentation)))),this._attributeComputeMap.set(e.binding,j(t,(e=>null===e||isNaN(e)||e===1/0?u.c:e)))}_createResources(){if((0,r.r)(this._createResourcesPromise))return this._createResourcesPromise;this._getBlock(u.J),V("Initializing AttributeStore");const e={shared:B.sharedArrayBuffer&&!("local"===this._client.type),size:this._size,blocks:(0,r.P)(this._blocks,(e=>({textureOnly:e.textureOnly,buffer:e.buffer,pixelType:e.pixelType})))},t=this._client.initialize(e,this._signal).catch((e=>{(0,a.g)(e)?this._createResourcesPromise=null:k.error(new a.s("mapview-attribute-store","Encountered an error during client initialization",e))}));return this._createResourcesPromise=t,t.then((()=>(0,r.t)(this._createResourcesPromise)?this._createResources():void 0)),t}_getBlock(e){const t=this._blocks[e];if((0,r.r)(t))return t;V(`Initializing AttributeBlock at index ${e}`);const i=B.sharedArrayBuffer,s=this._client.type,n=new q(i,s,this._size,this._blockDescriptors[e]);return this._blocks[e]=n,this._createResourcesPromise=null,n}_expand(){if(this._size<this.config.maxTextureSize){const e=this._size<<=1;return V("Expanding block size to",e,this._blocks),(0,r.Q)(this._blocks,(t=>t.expand(e))),this._createResourcesPromise=null,this._size=e,0}return k.error(new a.s("mapview-limitations","Maximum number of onscreen features exceeded.")),-1}async _updateFilter(e,t,i,s){const n=this._filters[t],a=(0,r.r)(n)&&n.hash;if(!n&&!e)return!1;if(a===JSON.stringify(e))return!1;if((0,r.t)(e)){if(!n)return!1;const e=1<<t+1,i=this._getBlock(0);return this._filters[t]=null,i.setComponentAllTexels(0,e),this.sendUpdates(),!0}const o=await this._getFilter(t,i);return await o.update(e,s),!0}async _getFilter(e,t){const s=this._filters[e];if((0,r.r)(s))return s;const{default:n}=await Promise.all([i.e(9351),i.e(3334)]).then(i.bind(i,53334)),a=new n({geometryType:t.geometryType,hasM:!1,hasZ:!1,timeInfo:t.timeInfo,fieldsIndex:new h.e(t.fields)});return this._filters[e]=a,a}isVisible(e){return!!(2&this._getBlock(0).getData(e,0))}getFilterFlags(e){let t=0;const i=(e=>1===U(e)?254:255)(e.getDisplayId());for(let s=0;s<this._filters.length;s++){const n=!!(i&1<<s),a=this._filters[s];t|=(!n||(0,r.t)(a)||a.check(e)?1:0)<<s}let s=0;if(this._idsToHighlight.size){const t=e.getObjectId();s=this.getHighlightFlag(t)}return t<<1|s}}class W{constructor(){this._freeIds=[],this._idCounter=1}createId(e=!1){return function(e,t){return((t?2147483648:0)|e)>>>0}(this._getFreeId(),e)}releaseId(e){this._freeIds.push(e)}_getFreeId(){return this._freeIds.length?this._freeIds.pop():this._idCounter++}}function Q(e,t,i){if(!(e.length>t))for(;e.length<=t;)e.push(i)}const Z=2147483647;class Y{constructor(){this._numerics=[],this._strings=[],this._idGenerator=new W,this._allocatedSize=256,this._bitsets=[],this._instanceIds=[],this._bounds=[]}createBitset(){const e=this._bitsets.length;return this._bitsets.push(n.t.create(this._allocatedSize,Z)),e+1}getBitset(e){return this._bitsets[e-1]}_expand(){this._allocatedSize<<=1;for(const e of this._bitsets)e.resize(this._allocatedSize)}_ensureNumeric(e,t){this._numerics[e]||(this._numerics[e]=[]),Q(this._numerics[e],t,0)}_ensureInstanceId(e){Q(this._instanceIds,e,0)}_ensureString(e,t){this._strings[e]||(this._strings[e]=[]),Q(this._strings[e],t,null)}createDisplayId(e=!1){const t=this._idGenerator.createId();return t>this._allocatedSize&&this._expand(),((e,t)=>((t?2147483648:0)|e)>>>0)(t,e)}releaseDisplayId(e){for(const t of this._bitsets)t.unset(e);return this._idGenerator.releaseId(e&Z)}getComputedNumeric(e,t){return this.getComputedNumericAtIndex(e&Z,0)}setComputedNumeric(e,t,i){return this.setComputedNumericAtIndex(e&Z,i,0)}getComputedString(e,t){return this.getComputedStringAtIndex(e&Z,0)}setComputedString(e,t,i){return this.setComputedStringAtIndex(e&Z,0,i)}getComputedNumericAtIndex(e,t){const i=e&Z;return this._ensureNumeric(t,i),this._numerics[t][i]}setComputedNumericAtIndex(e,t,i){const r=e&Z;this._ensureNumeric(t,r),this._numerics[t][r]=i}getInstanceId(e){const t=e&Z;return this._ensureInstanceId(t),this._instanceIds[t]}setInstanceId(e,t){const i=e&Z;this._ensureInstanceId(i),this._instanceIds[i]=t}getComputedStringAtIndex(e,t){const i=e&Z;return this._ensureString(t,i),this._strings[t][i]}setComputedStringAtIndex(e,t,i){const r=e&Z;this._ensureString(t,r),this._strings[t][r]=i}getXMin(e){return this._bounds[4*(e&Z)]}getYMin(e){return this._bounds[4*(e&Z)+1]}getXMax(e){return this._bounds[4*(e&Z)+2]}getYMax(e){return this._bounds[4*(e&Z)+3]}setBounds(e,t){const i=t.readHydratedGeometry();if(!i||!i.coords.length)return!1;let r=1/0,s=1/0,n=-1/0,a=-1/0;i.forEachVertex(((e,t)=>{r=Math.min(r,e),s=Math.min(s,t),n=Math.max(n,e),a=Math.max(a,t)}));const o=e&Z;return Q(this._bounds,4*o+4,0),this._bounds[4*o]=r,this._bounds[4*o+1]=s,this._bounds[4*o+2]=n,this._bounds[4*o+3]=a,!0}}class J{constructor(e,t){this.key=new x.e(0,0,0,0),this.bounds=(0,g.i)(),this.objectIds=new Set,this.key.set(t);const i=e.getLODInfoAt(this.key);this.tileInfoView=e,this.tileInfoView.getTileBounds(this.bounds,this.key,!0),this.resolution=i.resolution,this.scale=i.scale,this.level=i.level,this.needsClear=!0}get id(){return this.key.id}get extent(){return m.M.fromBounds(this.bounds,this.tileInfoView.tileInfo.spatialReference)}get transform(){return{originPosition:"upperLeft",scale:[this.resolution,this.resolution],translate:[this.bounds[0],this.bounds[3]]}}get bbox(){const e=this.bounds;return{minX:e[0],minY:e[1],maxX:e[2],maxY:e[3]}}clone(){return new J(this.tileInfoView,this.key)}createChildTiles(){const e=this.key.getChildKeys(),t=y.k.acquire();for(let i=0;i<e.length;i++)t[i]=new J(this.tileInfoView,e[i]);return t}getQuantizationParameters(){return _.a.fromJSON({mode:"view",originPosition:"upperLeft",tolerance:this.resolution,extent:{xmin:this.bounds[0],ymin:this.bounds[1],xmax:this.bounds[2],ymax:this.bounds[3],spatialReference:this.tileInfoView.tileInfo.spatialReference}})}}const X={added:[],removed:[]},$=new Set,K=new x.e(0,0,0,0);class ee extends p.n{constructor(e){super(),this._tiles=new Map,this._index=b(9,(0,r.c)("csp-restrictions")?e=>({minX:e.bounds[0],minY:e.bounds[1],maxX:e.bounds[2],maxY:e.bounds[3]}):[".bounds[0]",".bounds[1]",".bounds[2]",".bounds[3]"]),this.tiles=[],this.tileScheme=e}destroy(){this.clear()}clear(){this.tiles.length=0,this._tiles.clear(),this._index.clear()}has(e){return this._tiles.has(e)}get(e){return this._tiles.get(e)}boundsIntersections(e){return this._index.search({minX:e[0],minY:e[1],maxX:e[2],maxY:e[3]})}updateTiles(e){const t={added:[],removed:[]};for(const i of e.added)if(!this.has(i)){const e=new J(this.tileScheme,i);this._tiles.set(i,e),this._index.insert(e),t.added.push(e)}for(const i of e.removed)if(this.has(i)){const e=this.get(i);this._tiles.delete(i),this._index.remove(e),t.removed.push(e)}this.tiles.length=0,this._tiles.forEach((e=>this.tiles.push(e))),(t.added.length||t.removed.length)&&this.emit("update",t)}setViewState(e){const t=this.tileScheme.getTileCoverage(e,0);if(!t)return;const{spans:i,lodInfo:r}=t,{level:s}=r;if(i.length>0)for(const{row:e,colFrom:t,colTo:n}of i)for(let i=t;i<=n;i++){const t=K.set(s,e,r.normalizeCol(i),r.getWorldForColumn(i)).id;if($.add(t),!this.has(t)){const e=new J(this.tileScheme,t);this._tiles.set(t,e),this._index.insert(e),this.tiles.push(e),X.added.push(e)}}for(let e=this.tiles.length-1;e>=0;e--){const t=this.tiles[e];$.has(t.id)||(this._tiles.delete(t.id),this.tiles.splice(e,1),this._index.remove(t),X.removed.push(t))}(X.added.length||X.removed.length)&&this.emit("update",X),v.l.pool.release(t),$.clear(),X.added.length=0,X.removed.length=0}}},40218:(e,t,i)=>{"use strict";i.d(t,{b:()=>c});var r=i(78155),s=i(17762),n=i(73574),a=i(60816),o=i(80219),l=i(88903),h=i(81135);const u=[[0,179,255],[117,62,128],[0,104,255],[215,189,166],[32,0,193],[98,162,206],[102,112,129],[52,125,0],[142,118,246],[138,83,0],[92,122,255],[122,55,83],[0,142,255],[81,40,179],[0,200,244],[13,24,127],[0,170,147],[19,58,241],[22,44,35]];let c=class extends r.p{constructor(e){super(e),this.updating=!1,this.enablePolygons=!0,this.enableLabels=!0,this._polygons=new Map,this._labels=new Map,this._enabled=!0}initialize(){this._symbols=u.map((e=>new h.S({color:[e[0],e[1],e[2],.6],outline:{color:"black",width:1}}))),this.update()}destroy(){this._enabled=!1,this.clear()}get enabled(){return this._enabled}set enabled(e){this._enabled!==e&&(this._enabled=e,this.update())}update(){if(!this._enabled)return void this.clear();const e=this.getTiles(),t=new Array,i=new Set((this._labels.size,this._labels.keys()));e.forEach(((r,l)=>{const u=r.lij.toString();i.delete(u);const c=r.lij[0],d=r.geometry;if(this.enablePolygons&&!this._polygons.has(u)){const e=new n.h({geometry:d,symbol:this._symbols[c%this._symbols.length]});this._polygons.set(u,e),t.push(e)}if(this.enableLabels){const i=(e=>{if((0,o.r)(e.label))return e.label;let t=e.lij.toString();return(0,o.r)(e.loadPriority)&&(t+=` (${e.loadPriority})`),t})(r),c=l/(e.length-1),p=(0,a.C)(0,200,c),f=(0,a.C)(20,6,c)/.75,y=(0,o.r)(r.loadPriority)&&r.loadPriority>=e.length,m=new s.o([p,y?0:p,y?0:p]),g="3d"===this.view.type?()=>new h.k({verticalOffset:{screenLength:40/.75},callout:{type:"line",color:"white",border:{color:"black"}},symbolLayers:[new h.v({text:i,halo:{color:"white",size:1/.75},material:{color:m},size:f})]}):()=>new h.i({text:i,haloColor:"white",haloSize:1/.75,color:m,size:f});if(this._labels.has(u)){const e=this._labels.get(u),t=g();((0,o.t)(e.symbol)||JSON.stringify(t)!==JSON.stringify(e.symbol))&&(e.symbol=t)}else{const e=new n.h({geometry:d.extent.center,symbol:g()});this._labels.set(u,e),t.push(e)}}}));const r=new Array;i.forEach((e=>{this._polygons.has(e)&&(r.push(this._polygons.get(e)),this._polygons.delete(e)),this._labels.has(e)&&(r.push(this._labels.get(e)),this._labels.delete(e))})),this.view.graphics.removeMany(r),this.view.graphics.addMany(t)}clear(){this.view.graphics.removeMany(Array.from(this._polygons.values())),this.view.graphics.removeMany(Array.from(this._labels.values())),this._polygons.clear(),this._labels.clear()}};(0,r.e)([(0,l.y)({constructOnly:!0})],c.prototype,"view",void 0),(0,r.e)([(0,l.y)({readOnly:!0})],c.prototype,"updating",void 0),(0,r.e)([(0,l.y)()],c.prototype,"enabled",null),c=(0,r.e)([(0,l.n)("esri.views.support.TileTreeDebugger")],c)},5772:(e,t,i)=>{"use strict";i.d(t,{A:()=>o,C:()=>V,D:()=>Z,E:()=>r,G:()=>J,H:()=>X,I:()=>n,K:()=>B,M:()=>p,N:()=>z,O:()=>h,P:()=>j,R:()=>U,S:()=>q,T:()=>R,X:()=>H,_:()=>W,a:()=>G,b:()=>l,m:()=>f,q:()=>Q,r:()=>ie,t:()=>te,w:()=>y}),i(33807);var r,s,n,a,o,l,h,u=i(20215),c=i(80219),d=(i(60816),i(78155));function p(e){return[255&e,(65280&e)>>>8,(16711680&e)>>>16,(4278190080&e)>>>24]}function f(e,t){return 65535&e|t<<16}function y(e,t,i,r){return 255&e|(255&t)<<8|(255&i)<<16|r<<24}i(14215),function(e){e[e.FILL=0]="FILL",e[e.LINE=1]="LINE",e[e.MARKER=2]="MARKER",e[e.TEXT=3]="TEXT",e[e.LABEL=4]="LABEL"}(r||(r={})),function(e){e[e.SUCCEEDED=0]="SUCCEEDED",e[e.FAILED_OUT_OF_MEMORY=1]="FAILED_OUT_OF_MEMORY"}(s||(s={})),function(e){e[e.NONE=0]="NONE",e[e.MAP=1]="MAP",e[e.LABEL=2]="LABEL",e[e.LABEL_ALPHA=4]="LABEL_ALPHA",e[e.HITTEST=8]="HITTEST",e[e.HIGHLIGHT=16]="HIGHLIGHT",e[e.CLIP=32]="CLIP",e[e.DEBUG=64]="DEBUG",e[e.NUM_DRAW_PHASES=9]="NUM_DRAW_PHASES"}(n||(n={})),function(e){e[e.SIZE=0]="SIZE",e[e.COLOR=1]="COLOR",e[e.OPACITY=2]="OPACITY",e[e.ROTATION=3]="ROTATION"}(a||(a={})),function(e){e[e.NONE=0]="NONE",e[e.OPACITY=1]="OPACITY",e[e.COLOR=2]="COLOR",e[e.ROTATION=4]="ROTATION",e[e.SIZE_MINMAX_VALUE=8]="SIZE_MINMAX_VALUE",e[e.SIZE_SCALE_STOPS=16]="SIZE_SCALE_STOPS",e[e.SIZE_FIELD_STOPS=32]="SIZE_FIELD_STOPS",e[e.SIZE_UNIT_VALUE=64]="SIZE_UNIT_VALUE"}(o||(o={})),function(e){e[e.MINMAX_TARGETS_OUTLINE=128]="MINMAX_TARGETS_OUTLINE",e[e.SCALE_TARGETS_OUTLINE=256]="SCALE_TARGETS_OUTLINE",e[e.FIELD_TARGETS_OUTLINE=512]="FIELD_TARGETS_OUTLINE",e[e.UNIT_TARGETS_OUTLINE=1024]="UNIT_TARGETS_OUTLINE"}(l||(l={})),function(e){e[e.SPRITE=0]="SPRITE",e[e.GLYPH=1]="GLYPH"}(h||(h={}));class m{constructor(){this.color=[0,0,0,0],this.haloColor=[0,0,0,0],this.haloSize=0,this.size=12,this.angle=0,this.offsetX=0,this.offsetY=0,this.hAnchor=0,this.vAnchor=0}acquire(e,t,i,r,s,n,a,o,l){this.color=e,this.haloColor=t,this.haloSize=i,this.size=r,this.angle=s,this.offsetX=n,this.offsetY=a,this.hAnchor=o,this.vAnchor=l}release(){this.color[0]=this.color[1]=this.color[2]=this.color[3]=0,this.haloColor[0]=this.haloColor[1]=this.haloColor[2]=this.haloColor[3]=0,this.haloSize=0,this.size=0,this.angle=0,this.offsetX=0,this.offsetY=0,this.hAnchor=0,this.vAnchor=0}}m.pool=new d.h(m);const g=c.n.getLogger("esri.views.2d.engine.webgl.Utils"),_="geometry",x=[{name:_,strideInBytes:36,divisor:0}],v=[{name:_,strideInBytes:12,divisor:0}],b=[{name:_,strideInBytes:40,divisor:0}],w=[{name:_,strideInBytes:36,divisor:0}],S=[{name:_,strideInBytes:36,divisor:0}];function I(e){const t={};for(const i of e)t[i.name]=i.strideInBytes;return t}const C=I([{name:_,strideInBytes:36,divisor:0}]),M=I(x),T=I(v),E=I(b),F=I(w),A=I(S);function R(e,t){switch(e){case r.MARKER:return C;case r.FILL:return t?T:M;case r.LINE:return E;case r.TEXT:return F;case r.LABEL:return A}}const P=[_],L=[_],D=[_],N=[_],O=[_];function k(e){switch(e){case r.MARKER:return P;case r.FILL:return L;case r.LINE:return D;case r.TEXT:return N;case r.LABEL:return O}}function V(e){switch(e%4){case 0:case 2:return 4;case 1:case 3:return 1}}function U(e,t){switch(t%4){case 0:case 2:return new Uint32Array(Math.floor(e*t/4));case 1:case 3:return new Uint8Array(e*t)}}function G(e,t){switch(t%4){case 0:case 2:return new Uint32Array(e);case 1:case 3:return new Uint8Array(e)}}function z(e){return null!=e}function B(e){return"number"==typeof e}function j(e){switch(e){case"butt":return 0;case"round":return 1;case"square":return 2;default:return g.error(new u.s("mapview-invalid-type",`Cap type ${e} is not a valid option. Defaulting to round`)),1}}function q(e){switch(e){case"miter":return 2;case"bevel":return 0;case"round":return 1;default:return g.error(new u.s("mapview-invalid-type",`Join type ${e} is not a valid option. Defaulting to round`)),1}}function H(e){switch(e){case"opacity":return a.OPACITY;case"color":return a.COLOR;case"rotation":return a.ROTATION;case"size":return a.SIZE;default:return g.error(`Cannot interpret unknown vv: ${e}`),null}}function W(e,t,i,r,s,n,a){for(const t in n){const r=n[t].stride,a=V(r),o=n[t].data,l=i[t].data,h=r*s.vertexCount/a,u=r*e/a,c=r*s.vertexFrom/a;for(let e=0;e<h;++e)l[e+u]=o[e+c]}const o=s.indexCount;for(let i=0;i<o;++i)r[i+t]=a[i+s.indexFrom]-s.vertexFrom+e}const Q={[_]:35044};function Z(e,t){const i=[];for(let r=0;r<5;++r){const s=k(r),n={};for(const e of s)n[e]={data:t(r,e)};i.push({data:e(r),buffers:n})}return i}function Y(e){switch(e){case 5120:case 5121:return 1;case 5122:case 5123:return 2;case 5126:case 5124:case 5125:return 4}}function J(e){switch(e){case 5121:return 1;case 32819:return 2;case 5126:return 4;default:return void g.error(new u.s("webgl-utils",`Unable to handle type ${e}`))}}function X(e){switch(e){case 5121:return Uint8Array;case 32819:return Uint16Array;case 5126:return Float32Array;default:return void g.error(new u.s("webgl-utils",`Unable to handle type ${e}`))}}const $=e=>{const t=new Map;for(const i in e)for(const r of e[i])t.set(r.name,r.location);return t},K=e=>{const t={};for(const i in e){const r=e[i];t[i]=r.length?r[0].stride:0}return t},ee=new Map,te=(e,t)=>{if(!ee.has(e)){const i=function(e){const t={};for(const i in e){const r=e[i];let s=0;t[i]=r.map((e=>{const t={...e,normalized:e.normalized||!1,divisor:e.divisor||0,offset:s,stride:0};return s+=e.count*Y(e.type),t})),t[i].forEach((e=>e.stride=s))}return t}(t),r={strides:K(i),bufferLayouts:i,attributes:$(t)};ee.set(e,r)}return ee.get(e)};function ie(e){e(r.FILL),e(r.LINE),e(r.MARKER),e(r.TEXT),e(r.LABEL)}},84585:(e,t,i)=>{"use strict";i.d(t,{c:()=>w});var r=i(93875),s=(i(14215),i(80219),i(79766)),n={background:{"background.frag":"#ifdef PATTERN\nuniform lowp float u_opacity;\nuniform lowp sampler2D u_texture;\nvarying mediump vec4 v_tlbr;\nvarying mediump vec2 v_tileTextureCoord;\n#else\nuniform lowp vec4 u_color;\n#endif\n#ifdef ID\nvarying mediump vec4 v_id;\n#endif\nvoid main() {\n#ifdef PATTERN\nmediump vec2 normalizedTextureCoord = mod(v_tileTextureCoord, 1.0);\nmediump vec2 samplePos = mix(v_tlbr.xy, v_tlbr.zw, normalizedTextureCoord);\nlowp vec4 color = texture2D(u_texture, samplePos);\ngl_FragColor = u_opacity * color;\n#else\ngl_FragColor = u_color;\n#endif\n#ifdef ID\nif (gl_FragColor.a < 1.0 / 255.0) {\ndiscard;\n}\ngl_FragColor = v_id;\n#endif\n}","background.vert":"precision mediump float;\nattribute vec2 a_pos;\n#ifdef ID\nuniform mediump vec4 u_id;\nvarying mediump vec4 v_id;\n#endif\nuniform highp mat3 u_dvsMat3;\nuniform mediump float u_coord_range;\nuniform mediump float u_depth;\n#ifdef PATTERN\nuniform mediump mat3 u_pattern_matrix;\nvarying mediump vec2 v_tileTextureCoord;\nuniform mediump vec4 u_tlbr;\nuniform mediump vec2 u_mosaicSize;\nvarying mediump vec4 v_tlbr;\n#endif\nvoid main() {\ngl_Position = vec4((u_dvsMat3 * vec3(u_coord_range * a_pos, 1.0)).xy, u_depth, 1.0);\n#ifdef PATTERN\nv_tileTextureCoord = (u_pattern_matrix * vec3(a_pos, 1.0)).xy;\nv_tlbr             = u_tlbr / u_mosaicSize.xyxy;\n#endif\n#ifdef ID\nv_id = u_id / 255.0;\n#endif\n}"},circle:{"circle.frag":"precision lowp float;\nvarying lowp vec4 v_color;\nvarying lowp vec4 v_stroke_color;\nvarying mediump float v_blur;\nvarying mediump float v_stroke_width;\nvarying mediump float v_radius;\nvarying mediump vec2 v_offset;\n#ifdef ID\nvarying mediump vec4 v_id;\n#endif\nvoid main()\n{\nmediump float dist = length(v_offset);\nmediump float alpha = smoothstep(0.0, -v_blur, dist - 1.0);\nlowp float color_mix_ratio = v_stroke_width < 0.01 ? 0.0 : smoothstep(-v_blur, 0.0, dist - v_radius / (v_radius + v_stroke_width));\ngl_FragColor = alpha * mix(v_color, v_stroke_color, color_mix_ratio);\n#ifdef ID\nif (gl_FragColor.a < 1.0 / 255.0) {\ndiscard;\n}\ngl_FragColor = v_id;\n#endif\n}","circle.vert":"precision mediump float;\nattribute vec2 a_pos;\n#pragma header\nvarying lowp vec4 v_color;\nvarying lowp vec4 v_stroke_color;\nvarying mediump float v_blur;\nvarying mediump float v_stroke_width;\nvarying mediump float v_radius;\nvarying mediump vec2 v_offset;\n#ifdef ID\nuniform mediump vec4 u_id;\nvarying mediump vec4 v_id;\n#endif\nuniform highp mat3 u_dvsMat3;\nuniform highp mat3 u_displayMat3;\nuniform mediump vec2 u_circleTranslation;\nuniform mediump float u_depth;\nuniform mediump float u_antialiasingWidth;\nvoid main()\n{\n#pragma main\nv_color = color * opacity;\nv_stroke_color = stroke_color * stroke_opacity;\nv_stroke_width = stroke_width;\nv_radius = radius;\nv_blur = max(blur, u_antialiasingWidth / (radius + stroke_width));\nmediump vec2 offset = vec2(mod(a_pos, 2.0) * 2.0 - 1.0);\nv_offset = offset;\n#ifdef ID\nv_id = u_id / 255.0;\n#endif\nmediump vec3 pos = u_dvsMat3 * vec3(a_pos * 0.5, 1.0) + u_displayMat3 * vec3((v_radius + v_stroke_width) * offset + u_circleTranslation, 0.0);\ngl_Position = vec4(pos.xy, u_depth, 1.0);\n}"},fill:{"fill.frag":"precision lowp float;\n#ifdef PATTERN\nuniform lowp sampler2D u_texture;\nvarying mediump vec2 v_tileTextureCoord;\nvarying mediump vec4 v_tlbr;\n#endif\n#ifdef ID\nvarying mediump vec4 v_id;\n#endif\nvarying lowp vec4 v_color;\nvec4 mixColors(vec4 color1, vec4 color2) {\nfloat compositeAlpha = color2.a + color1.a * (1.0 - color2.a);\nvec3 compositeColor = color2.rgb + color1.rgb * (1.0 - color2.a);\nreturn vec4(compositeColor, compositeAlpha);\n}\nvoid main()\n{\n#ifdef PATTERN\nmediump vec2 normalizedTextureCoord = fract(v_tileTextureCoord);\nmediump vec2 samplePos = mix(v_tlbr.xy, v_tlbr.zw, normalizedTextureCoord);\nlowp vec4 color = texture2D(u_texture, samplePos);\ngl_FragColor = v_color[3] * color;\n#else\ngl_FragColor = v_color;\n#endif\n#ifdef ID\nif (gl_FragColor.a < 1.0 / 255.0) {\ndiscard;\n}\ngl_FragColor = v_id;\n#endif\n}","fill.vert":"precision mediump float;\nattribute vec2 a_pos;\n#pragma header\nuniform highp mat3 u_dvsMat3;\nuniform highp mat3 u_displayMat3;\nuniform mediump float u_depth;\nuniform mediump vec2 u_fillTranslation;\n#ifdef PATTERN\n#include <util/util.glsl>\nuniform mediump vec2 u_mosaicSize;\nuniform mediump float u_patternFactor;\nvarying mediump vec2 v_tileTextureCoord;\nvarying mediump vec4 v_tlbr;\n#endif\n#ifdef ID\nuniform mediump vec4 u_id;\nvarying mediump vec4 v_id;\n#endif\nvarying lowp vec4 v_color;\nvoid main()\n{\n#pragma main\nv_color = color * opacity;\n#ifdef ID\nv_id = u_id / 255.0;\n#endif\n#ifdef PATTERN\nfloat patternWidth = nextPOT(tlbr.z - tlbr.x);\nfloat patternHeight = nextPOT(tlbr.w - tlbr.y);\nfloat scaleX = 1.0 / (patternWidth * u_patternFactor);\nfloat scaleY = 1.0 / (patternHeight * u_patternFactor);\nmat3 patterMat = mat3(scaleX, 0.0,    0.0,\n0.0,    -scaleY, 0.0,\n0.0,    0.0,    1.0);\nv_tileTextureCoord = (patterMat * vec3(a_pos, 1.0)).xy;\nv_tlbr             = tlbr / u_mosaicSize.xyxy;\n#endif\nvec3 pos = u_dvsMat3 * vec3(a_pos, 1.0) + u_displayMat3 * vec3(u_fillTranslation, 0.0);\ngl_Position = vec4(pos.xy, u_depth, 1.0);\n}"},icon:{"icon.frag":"precision mediump float;\nuniform lowp sampler2D u_texture;\n#ifdef SDF\nuniform lowp vec4 u_color;\nuniform lowp vec4 u_outlineColor;\n#endif\nvarying mediump vec2 v_tex;\nvarying lowp float v_opacity;\nvarying mediump vec2 v_size;\nvarying lowp vec4 v_color;\n#ifdef SDF\nvarying mediump flaot v_halo_width;\n#endif\n#ifdef ID\nvarying mediump vec4 v_id;\n#endif\n#include <util/encoding.glsl>\nvec4 mixColors(vec4 color1, vec4 color2) {\nfloat compositeAlpha = color2.a + color1.a * (1.0 - color2.a);\nvec3 compositeColor = color2.rgb + color1.rgb * (1.0 - color2.a);\nreturn vec4(compositeColor, compositeAlpha);\n}\nvoid main()\n{\n#ifdef SDF\nlowp vec4 fillPixelColor = v_color;\nfloat d = rgba2float(texture2D(u_texture, v_tex)) - 0.5;\nconst float softEdgeRatio = 0.248062016;\nfloat size = max(v_size.x, v_size.y);\nfloat dist = d * softEdgeRatio * size;\nfillPixelColor *= clamp(0.5 - dist, 0.0, 1.0);\nif (v_halo_width > 0.25) {\nlowp vec4 outlinePixelColor = u_outlineColor;\nconst float outlineLimitRatio = (16.0 / 86.0);\nfloat clampedOutlineSize = softEdgeRatio * min(v_halo_width, outlineLimitRatio * max(v_size.x, v_size.y));\noutlinePixelColor *= clamp(0.5 - (abs(dist) - clampedOutlineSize), 0.0, 1.0);\ngl_FragColor = v_opacity * mixColors(fillPixelColor, outlinePixelColor);\n}\nelse {\ngl_FragColor = v_opacity * fillPixelColor;\n}\n#else\nlowp vec4 texColor = texture2D(u_texture, v_tex);\ngl_FragColor = v_opacity * texColor;\n#endif\n#ifdef ID\nif (gl_FragColor.a < 1.0 / 255.0) {\ndiscard;\n}\ngl_FragColor = v_id;\n#endif\n}","icon.vert":"attribute vec2 a_pos;\nattribute vec2 a_vertexOffset;\nattribute vec4 a_texAngleRange;\nattribute vec4 a_levelInfo;\nattribute float a_opacityInfo;\n#pragma header\n#ifdef ID\nuniform mediump vec4 u_id;\nvarying mediump vec4 v_id;\n#endif\nvarying lowp vec4 v_color;\n#ifdef SDF\nvarying mediump float v_halo_width;\n#endif\nuniform highp mat3 u_dvsMat3;\nuniform highp mat3 u_displayMat3;\nuniform highp mat3 u_displayViewMat3;\nuniform mediump vec2 u_iconTranslation;\nuniform vec2 u_mosaicSize;\nuniform mediump float u_depth;\nuniform mediump float u_mapRotation;\nuniform mediump float u_level;\nuniform lowp float u_keepUpright;\nuniform mediump float u_fadeDuration;\nvarying mediump vec2 v_tex;\nvarying lowp float v_opacity;\nvarying mediump vec2 v_size;\nconst float C_OFFSET_PRECISION = 1.0 / 8.0;\nconst float C_256_TO_RAD = 3.14159265359 / 128.0;\nconst float C_DEG_TO_RAD = 3.14159265359 / 180.0;\nconst float tileCoordRatio = 1.0 / 8.0;\nuniform highp float u_time;\nvoid main()\n{\n#pragma main\nv_color = color;\nv_opacity = opacity;\n#ifdef SDF\nv_halo_width = halo_width;\n#endif\nfloat modded = mod(a_opacityInfo, 128.0);\nfloat targetOpacity = (a_opacityInfo - modded) / 128.0;\nfloat startOpacity = modded / 127.0;\nfloat interpolatedOpacity = clamp(startOpacity + 2.0 * (targetOpacity - 0.5) * u_time / u_fadeDuration, 0.0, 1.0);\nv_opacity *= interpolatedOpacity;\nmediump float a_angle         = a_levelInfo[1];\nmediump float a_minLevel      = a_levelInfo[2];\nmediump float a_maxLevel      = a_levelInfo[3];\nmediump vec2 a_tex            = a_texAngleRange.xy;\nmediump float delta_z = 0.0;\nmediump float rotated = mod(a_angle + u_mapRotation, 256.0);\ndelta_z += (1.0 - step(u_keepUpright, 0.0)) * step(64.0, rotated) * (1.0 - step(192.0, rotated));\ndelta_z += 1.0 - step(a_minLevel, u_level);\ndelta_z += step(a_maxLevel, u_level);\ndelta_z += step(v_opacity, 0.0);\nvec2 offset = C_OFFSET_PRECISION * a_vertexOffset;\nv_size = abs(offset);\n#ifdef SDF\noffset = (120.0 / 86.0) * offset;\n#endif\nmediump vec3 pos = u_dvsMat3 * vec3(a_pos, 1.0) + u_displayViewMat3 * vec3(size * offset, 0.0) + u_displayMat3 * vec3(u_iconTranslation, 0.0);\ngl_Position = vec4(pos.xy, u_depth + delta_z, 1.0);\n#ifdef ID\nv_id = u_id / 255.0;\n#endif\nv_tex = a_tex.xy / u_mosaicSize;\n}"},line:{"line.frag":"precision lowp float;\nvarying mediump vec2 v_normal;\nvarying highp float v_accumulatedDistance;\nvarying mediump float v_lineHalfWidth;\nvarying lowp vec4 v_color;\nvarying mediump float v_blur;\n#if defined (PATTERN) || defined(SDF)\nvarying mediump vec4 v_tlbr;\nvarying mediump vec2 v_patternSize;\nuniform sampler2D u_texture;\nuniform mediump float u_antialiasing;\n#endif\n#ifdef SDF\n#include <util/encoding.glsl>\nconst mediump float sdfPatternHalfWidth = 15.5;\n#endif\n#ifdef ID\nvarying mediump vec4 v_id;\n#endif\nvoid main()\n{\nmediump float fragDist = length(v_normal) * v_lineHalfWidth;\nlowp float alpha = clamp((v_lineHalfWidth - fragDist) / v_blur, 0.0, 1.0);\n#ifdef PATTERN\nmediump float relativeTexX = mod(v_accumulatedDistance / v_patternSize.x, 1.0);\nmediump float relativeTexY = 0.5 + (v_normal.y * v_lineHalfWidth / v_patternSize.y);\nmediump vec2 texCoord = mix(v_tlbr.xy, v_tlbr.zw, vec2(relativeTexX, relativeTexY));\nlowp vec4 color = texture2D(u_texture, texCoord);\ngl_FragColor = alpha * v_color[3] * color;\n#elif defined(SDF)\nmediump float lineHalfWidth = v_lineHalfWidth - 0.5 * u_antialiasing;\nmediump float lineWidthRatio = lineHalfWidth / sdfPatternHalfWidth;\nmediump float relativeTexX = mod((v_accumulatedDistance * 0.5) / (lineWidthRatio * v_patternSize.x), 1.0);\nmediump float relativeTexY =  0.5 + 0.25 * v_normal.y;\nmediump vec2 texCoord = mix(v_tlbr.xy, v_tlbr.zw, vec2(relativeTexX, relativeTexY));\nmediump float d = rgba2float(texture2D(u_texture, texCoord)) - 0.5;\nfloat dist = d * lineHalfWidth;\ngl_FragColor = alpha * clamp(0.5 - dist, 0.0, 1.0) * v_color;\n#else\ngl_FragColor = alpha * v_color;\n#endif\n#ifdef ID\nif (gl_FragColor.a < 1.0 / 255.0) {\ndiscard;\n}\ngl_FragColor = v_id;\n#endif\n}","line.vert":"precision mediump float;\nattribute vec2 a_pos;\nattribute vec4 a_extrude_offset;\nattribute vec4 a_dir_normal;\nattribute vec2 a_accumulatedDistance;\n#pragma header\nuniform highp mat3 u_dvsMat3;\nuniform highp mat3 u_displayMat3;\nuniform highp mat3 u_displayViewMat3;\nuniform mediump float u_zoomFactor;\nuniform mediump vec2 u_lineTranslation;\nuniform mediump float u_antialiasing;\nuniform mediump float u_depth;\nvarying mediump vec2 v_normal;\nvarying highp float v_accumulatedDistance;\nconst float scale = 1.0 / 31.0;\nconst mediump float tileCoordRatio = 8.0;\n#if defined (PATTERN) || defined(SDF)\nuniform mediump vec2 u_mosaicSize;\nvarying mediump vec4 v_tlbr;\nvarying mediump vec2 v_patternSize;\n#endif\n#ifdef ID\nuniform mediump vec4 u_id;\nvarying mediump vec4 v_id;\n#endif\nvarying lowp vec4 v_color;\nvarying mediump float v_lineHalfWidth;\nvarying mediump float v_blur;\nvoid main()\n{\n#pragma main\nv_color = color * opacity;\nv_blur = blur + u_antialiasing;\nv_normal = a_dir_normal.zw * scale;\n#if defined (PATTERN) || defined(SDF)\nv_tlbr          = tlbr / u_mosaicSize.xyxy;\nv_patternSize   = vec2(tlbr.z - tlbr.x, tlbr.y - tlbr.w);\n#endif\nv_lineHalfWidth = (width + u_antialiasing) * 0.5;\nmediump vec2 dir = a_dir_normal.xy * scale;\nmediump vec2 offset_ = a_extrude_offset.zw * scale * offset;\nmediump vec2 dist = v_lineHalfWidth * scale * a_extrude_offset.xy;\nmediump vec3 pos = u_dvsMat3 * vec3(a_pos + offset_ * tileCoordRatio / u_zoomFactor, 1.0) + u_displayViewMat3 * vec3(dist, 0.0) + u_displayMat3 * vec3(u_lineTranslation, 0.0);\ngl_Position = vec4(pos.xy, u_depth, 1.0);\n#if defined (PATTERN) || defined(SDF)\nv_accumulatedDistance = a_accumulatedDistance.x * u_zoomFactor / tileCoordRatio + dot(dir, dist + offset_);\n#endif\n#ifdef ID\nv_id = u_id / 255.0;\n#endif\n}"},outline:{"outline.frag":"varying lowp vec4 v_color;\nvarying mediump vec2 v_normal;\n#ifdef ID\nvarying mediump vec4 v_id;\n#endif\nvoid main()\n{\nlowp float dist = abs(v_normal.y);\nlowp float alpha = smoothstep(1.0, 0.0, dist);\ngl_FragColor = alpha * v_color;\n#ifdef ID\nif (gl_FragColor.a < 1.0 / 255.0) {\ndiscard;\n}\ngl_FragColor = v_id;\n#endif\n}","outline.vert":"attribute vec2 a_pos;\nattribute vec2 a_offset;\nattribute vec2 a_xnormal;\n#pragma header\nvarying lowp vec4 v_color;\n#ifdef ID\nuniform mediump vec4 u_id;\nvarying mediump vec4 v_id;\n#endif\nuniform highp mat3 u_dvsMat3;\nuniform highp mat3 u_displayMat3;\nuniform mediump vec2 u_fillTranslation;\nuniform mediump float u_depth;\nuniform mediump float u_outline_width;\nvarying lowp vec2 v_normal;\nconst float scale = 1.0 / 15.0;\nvoid main()\n{\n#pragma main\nv_color = color * opacity;\n#ifdef ID\nv_id = u_id / 255.0;\n#endif\nv_normal = a_xnormal;\nmediump vec2 dist = u_outline_width * scale * a_offset;\nmediump vec3 pos = u_dvsMat3 * vec3(a_pos, 1.0) + u_displayMat3 * vec3(dist + u_fillTranslation, 0.0);\ngl_Position = vec4(pos.xy, u_depth, 1.0);\n}"},text:{"text.frag":"uniform lowp sampler2D u_texture;\nvarying lowp vec2 v_tex;\nvarying lowp vec4 v_color;\nvarying mediump float v_edgeWidth;\nvarying mediump float v_edgeDistance;\n#ifdef ID\nvarying mediump vec4 v_id;\n#endif\nvoid main()\n{\nlowp float dist = texture2D(u_texture, v_tex).a;\nmediump float alpha = smoothstep(v_edgeDistance - v_edgeWidth, v_edgeDistance + v_edgeWidth, dist);\ngl_FragColor = alpha * v_color;\n#ifdef ID\nif (gl_FragColor.a < 1.0 / 255.0) {\ndiscard;\n}\ngl_FragColor = v_id;\n#endif\n}","text.vert":"attribute vec2 a_pos;\nattribute vec2 a_vertexOffset;\nattribute vec4 a_texAngleRange;\nattribute vec4 a_levelInfo;\nattribute float a_opacityInfo;\n#pragma header\nvarying lowp vec4 v_color;\n#ifdef ID\nuniform mediump vec4 u_id;\nvarying mediump vec4 v_id;\n#endif\nuniform highp mat3 u_dvsMat3;\nuniform highp mat3 u_displayMat3;\nuniform highp mat3 u_displayViewMat3;\nuniform mediump vec2 u_textTranslation;\nuniform vec2 u_mosaicSize;\nuniform mediump float u_depth;\nuniform mediump float u_mapRotation;\nuniform mediump float u_level;\nuniform lowp float u_keepUpright;\nuniform mediump float u_fadeDuration;\nvarying lowp vec2 v_tex;\nconst float offsetPrecision = 1.0 / 8.0;\nconst mediump float edgePos = 0.75;\nuniform mediump float u_antialiasingWidth;\nvarying mediump float v_edgeDistance;\nvarying mediump float v_edgeWidth;\nuniform lowp float u_halo;\nconst float sdfFontScale = 1.0 / 24.0;\nconst float sdfPixel = 3.0;\nuniform highp float u_time;\nvoid main()\n{\n#pragma main\nif (u_halo > 0.5)\n{\nv_color = halo_color * opacity;\nhalo_width *= sdfPixel;\nhalo_blur *= sdfPixel;\n}\nelse\n{\nv_color = color * opacity;\nhalo_width = 0.0;\nhalo_blur = 0.0;\n}\nfloat modded = mod(a_opacityInfo, 128.0);\nfloat targetOpacity = (a_opacityInfo - modded) / 128.0;\nfloat startOpacity = modded / 127.0;\nfloat interpolatedOpacity = clamp(startOpacity + 2.0 * (targetOpacity - 0.5) * u_time / u_fadeDuration, 0.0, 1.0);\nv_color *= interpolatedOpacity;\nmediump float a_angle       = a_levelInfo[1];\nmediump float a_minLevel    = a_levelInfo[2];\nmediump float a_maxLevel    = a_levelInfo[3];\nmediump vec2 a_tex          = a_texAngleRange.xy;\nmediump float a_visMinAngle    = a_texAngleRange.z;\nmediump float a_visMaxAngle    = a_texAngleRange.w;\nmediump float delta_z = 0.0;\nmediump float angle = mod(a_angle + u_mapRotation, 256.0);\nif (a_visMinAngle < a_visMaxAngle)\n{\ndelta_z += (1.0 - step(u_keepUpright, 0.0)) * (step(a_visMaxAngle, angle) + (1.0 - step(a_visMinAngle, angle)));\n}\nelse\n{\ndelta_z += (1.0 - step(u_keepUpright, 0.0)) * (step(a_visMaxAngle, angle) * (1.0 - step(a_visMinAngle, angle)));\n}\ndelta_z += 1.0 - step(a_minLevel, u_level);\ndelta_z += step(a_maxLevel, u_level);\ndelta_z += step(v_color[3], 0.0);\nv_tex = a_tex.xy / u_mosaicSize;\n#ifdef ID\nv_id = u_id / 255.0;\n#endif\nv_edgeDistance = edgePos - halo_width / size;\nv_edgeWidth = (u_antialiasingWidth + halo_blur) / size;\nmediump vec3 pos = u_dvsMat3 * vec3(a_pos, 1.0) + sdfFontScale * u_displayViewMat3 * vec3(offsetPrecision * size * a_vertexOffset, 0.0) + u_displayMat3 * vec3(u_textTranslation, 0.0);\ngl_Position = vec4(pos.xy, u_depth + delta_z, 1.0);\n}"},util:{"encoding.glsl":"const vec4 rgba2float_factors = vec4(\n255.0 / (256.0),\n255.0 / (256.0 * 256.0),\n255.0 / (256.0 * 256.0 * 256.0),\n255.0 / (256.0 * 256.0 * 256.0 * 256.0)\n);\nfloat rgba2float(vec4 rgba) {\nreturn dot(rgba, rgba2float_factors);\n}","util.glsl":"float nextPOT(in float x) {\nreturn pow(2.0, ceil(log2(abs(x))));\n}"}};const a=new s.e((function(e){let t=n;return e.split("/").forEach((e=>{t&&(t=t[e])})),t}));function o(e){return a.resolveIncludes(e)}const l=e=>(0,s.n)({ID:e.id,PATTERN:e.pattern}),h={shaders:e=>({vertexShader:l(e)+o("background/background.vert"),fragmentShader:l(e)+o("background/background.frag")})},u=e=>(0,s.n)({ID:e.id}),c={shaders:e=>({vertexShader:u(e)+o("circle/circle.vert"),fragmentShader:u(e)+o("circle/circle.frag")})},d=e=>(0,s.n)({ID:e.id,PATTERN:e.pattern}),p={shaders:e=>({vertexShader:d(e)+o("fill/fill.vert"),fragmentShader:d(e)+o("fill/fill.frag")})},f=e=>(0,s.n)({ID:e.id}),y={shaders:e=>({vertexShader:f(e)+o("outline/outline.vert"),fragmentShader:f(e)+o("outline/outline.frag")})},m=e=>(0,s.n)({ID:e.id,SDF:e.sdf}),g={shaders:e=>({vertexShader:m(e)+o("icon/icon.vert"),fragmentShader:m(e)+o("icon/icon.frag")})},_=e=>(0,s.n)({ID:e.id,PATTERN:e.pattern,SDF:e.sdf}),x={shaders:e=>({vertexShader:_(e)+o("line/line.vert"),fragmentShader:_(e)+o("line/line.frag")})},v=e=>(0,s.n)({ID:e.id}),b={shaders:e=>({vertexShader:v(e)+o("text/text.vert"),fragmentShader:v(e)+o("text/text.frag")})};class w{constructor(){this._programByKey=new Map}dispose(){this._programByKey.forEach((e=>e.dispose())),this._programByKey.clear()}getMaterialProgram(e,t,i){const s=t.key<<3|this._getMaterialOptionsValue(t.type,i);if(this._programByKey.has(s))return this._programByKey.get(s);const n=this._getProgramTemplate(t.type),{shaders:a}=n,{vertexShader:o,fragmentShader:l}=a(i),h=t.getShaderHeader(),u=t.getShaderMain(),c=o.replace("#pragma header",h).replace("#pragma main",u),d=new r.p(e,c,l,t.getAttributeLocations());return this._programByKey.set(s,d),d}_getMaterialOptionsValue(e,t){switch(e){case 0:{const e=t;return(e.pattern?1:0)<<1|(e.id?1:0)}case 1:{const e=t;return(e.pattern?1:0)<<1|(e.id?1:0)}case 2:return t.id?1:0;case 3:{const e=t;return(e.sdf?1:0)<<2|(e.pattern?1:0)<<1|(e.id?1:0)}case 4:{const e=t;return(e.sdf?1:0)<<1|(e.id?1:0)}case 5:case 6:return t.id?1:0;default:return 0}}_getProgramTemplate(e){switch(e){case 0:return h;case 5:return c;case 1:return p;case 4:return g;case 3:return x;case 2:return y;case 6:return b;default:return null}}}},80163:(e,t,i)=>{"use strict";i.d(t,{o:()=>w}),i(33807);var r=i(80219),s=i(26799),n=i(1045),a=i(20215),o=i(75200),l=i(87405),h=i(67726),u=i(59312),c=i(29831),d=i(91728),p=i(5772),f=i(93875);const y=r.n.getLogger("esri.views.2d.engine.webgl.Mesh2D"),m=(e,t,i,r)=>{let s=0;for(let r=1;r<i;r++){const i=e[2*(t+r-1)],n=e[2*(t+r-1)+1];s+=(e[2*(t+r)]-i)*(e[2*(t+r)+1]+n)}return r?s>0:s<0},g=({coords:e,lengths:t},i)=>{const r=[];for(let s=0,n=0;s<t.length;n+=t[s],s+=1){const a=n,o=[];for(;s<t.length-1&&m(e,n+t[s],t[s+1],i);s+=1,n+=t[s])o.push(n+t[s]-a);const h=e.slice(2*a,2*(n+t[s])),u=(0,l.r)(h,o,2);for(const e of u)r.push(e+a)}return r};class _{constructor(e,t,i,r=!1){this._cache={},this.vertices=e,this.indices=t,this.primitiveType=i,this.isMapSpace=r}static fromRect({x:e,y:t,width:i,height:r}){const s=e,n=t,a=s+i,o=n+r;return _.fromScreenExtent({xmin:s,ymin:n,xmax:a,ymax:o})}static fromPath(e){const t=(0,c.B)(new d.a,e.path,!1,!1),i=t.coords,r=new Uint32Array(g(t,!0)),s=new Uint32Array(i.length/2);for(let e=0;e<s.length;e++)s[e]=(0,p.m)(Math.floor(i[2*e]),Math.floor(i[2*e+1]));return new _({geometry:s},r,4)}static fromGeometry(e,t){const i=t.geometry.type;switch(i){case"polygon":return _.fromPolygon(e,t.geometry);case"extent":return _.fromMapExtent(e,t.geometry);default:return y.error(new a.s("mapview-bad-type",`Unable to create a mesh from type ${i}`,t)),_.fromRect({x:0,y:0,width:1,height:1})}}static fromPolygon(e,t){const i=(0,c.C)(new d.a,t,!1,!1),r=i.coords,s=new Uint32Array(g(i,!1)),n=new Uint32Array(r.length/2),a=(0,u.n)(),o=(0,u.n)();for(let t=0;t<n.length;t++)(0,h.r)(a,r[2*t],r[2*t+1]),e.toScreen(o,a),n[t]=(0,p.m)(Math.floor(o[0]),Math.floor(o[1]));return new _({geometry:n},s,4,!0)}static fromScreenExtent({xmin:e,xmax:t,ymin:i,ymax:r}){const s={geometry:new Uint32Array([(0,p.m)(e,i),(0,p.m)(t,i),(0,p.m)(e,r),(0,p.m)(e,r),(0,p.m)(t,i),(0,p.m)(t,r)])},n=new Uint32Array([0,1,2,3,4,5]);return new _(s,n,4)}static fromMapExtent(e,t){const[i,r]=e.toScreen([0,0],[t.xmin,t.ymin]),[s,n]=e.toScreen([0,0],[t.xmax,t.ymax]),a={geometry:new Uint32Array([(0,p.m)(i,r),(0,p.m)(s,r),(0,p.m)(i,n),(0,p.m)(i,n),(0,p.m)(s,r),(0,p.m)(s,n)])},o=new Uint32Array([0,1,2,3,4,5]);return new _(a,o,4)}destroy(){(0,r.r)(this._cache.indexBuffer)&&this._cache.indexBuffer.dispose();for(const e in this._cache.vertexBuffers)(0,r.r)(this._cache.vertexBuffers[e])&&this._cache.vertexBuffers[e].dispose()}get elementType(){return(e=>{switch(this.indices.BYTES_PER_ELEMENT){case 1:return 5121;case 2:return 5123;case 4:return 5125;default:throw new a.s("Cannot get DataType of array")}})()}getIndexBuffer(e,t=35044){return this._cache.indexBuffer||(this._cache.indexBuffer=f.h.createIndex(e,t,this.indices)),this._cache.indexBuffer}getVertexBuffers(e,t=35044){return this._cache.vertexBuffers||(this._cache.vertexBuffers=Object.keys(this.vertices).reduce(((i,r)=>({...i,[r]:f.h.createVertex(e,t,this.vertices[r])})),{})),this._cache.vertexBuffers}}const x=r.n.getLogger("esri.views.2d.engine.webgl.ClippingInfo"),v=e=>parseFloat(e)/100;class b extends o.a{constructor(e,t){super(),this._clip=t,this._cache={},this.stage=e,this._handle=t.watch("version",(()=>this._invalidate())),this.ready()}static fromClipArea(e,t){return new b(e,t)}_destroyGL(){(0,r.r)(this._cache.mesh)&&(this._cache.mesh.destroy(),this._cache.mesh=null),(0,r.r)(this._cache.vao)&&(this._cache.vao.dispose(),this._cache.vao=null)}destroy(){this._destroyGL(),this._handle.remove()}getVAO(e,t,i,s){const[n,a]=t.size;if("geometry"!==this._clip.type&&this._lastWidth===n&&this._lastHeight===a||(this._lastWidth=n,this._lastHeight=a,this._destroyGL()),(0,r.t)(this._cache.vao)){const r=this._createMesh(t,this._clip),n=r.getIndexBuffer(e),a=r.getVertexBuffers(e);this._cache.mesh=r,this._cache.vao=new f.f(e,i,s,a,n)}return this._cache.vao}_invalidate(){this._destroyGL(),this.requestRender()}_createScreenRect(e,t){const[i,r]=e.size,s="string"==typeof t.left?v(t.left)*i:t.left,n="string"==typeof t.right?v(t.right)*i:t.right,a="string"==typeof t.top?v(t.top)*r:t.top,o="string"==typeof t.bottom?v(t.bottom)*r:t.bottom,l=s,h=a;return{x:l,y:h,width:Math.max(i-n-l,0),height:Math.max(r-o-h,0)}}_createMesh(e,t){switch(t.type){case"rect":return _.fromRect(this._createScreenRect(e,t));case"path":return _.fromPath(t);case"geometry":return _.fromGeometry(e,t);default:return x.error(new a.s("mapview-bad-type","Unable to create ClippingInfo mesh from clip of type: ${clip.type}")),_.fromRect({x:0,y:0,width:1,height:1})}}}class w extends n.r{constructor(){super(...arguments),this.name=this.constructor.name}set clips(e){this._clips=e,this.children.forEach((t=>t.clips=e)),this._updateClippingInfo()}doRender(e){const t=this.createRenderParams(e),{painter:i,globalOpacity:r,profiler:s,drawPhase:n}=t,a=n===p.I.LABEL?1:r*this.computedOpacity;s.recordContainerStart(this.name),i.beforeRenderLayer(t,this._clippingInfos?255:0,a),this.updateTransforms(e.state),this.renderChildren(t),i.compositeLayer(t,a),s.recordContainerEnd()}renderChildren(e){(0,r.t)(this._renderPasses)&&(this._renderPasses=this.prepareRenderPasses(e.painter));for(const t of this.children)t.beforeRender(e);for(const t of this._renderPasses)try{t.render(e)}catch(e){}for(const t of this.children)t.afterRender(e)}createRenderParams(e){return{...e,requireFBO:this.requiresDedicatedFBO}}prepareRenderPasses(e){return[e.registerRenderPass({name:"clip",brushes:[s.g.clip],target:()=>this._clippingInfos,drawPhase:p.I.MAP|p.I.LABEL|p.I.LABEL_ALPHA|p.I.DEBUG|p.I.HIGHLIGHT})]}updateTransforms(e){for(const t of this.children)t.setTransform(e)}onAttach(){super.onAttach(),this._updateClippingInfo()}onDetach(){super.onDetach(),this._updateClippingInfo()}_updateClippingInfo(){if((0,r.r)(this._clippingInfos)&&(this._clippingInfos.forEach((e=>e.destroy())),this._clippingInfos=null),!this.stage)return;const e=this._clips;(0,r.r)(e)&&e.length&&(this._clippingInfos=e.items.map((e=>b.fromClipArea(this.stage,e)))),this.requestRender()}}},9591:(e,t,i)=>{"use strict";i.d(t,{a:()=>l});var r=i(78155),s=i(20215),n=i(88903),a=(i(80219),i(13895)),o=i(10662);const l=e=>{let t=class extends e{initialize(){this.exportImageParameters=new o.l({layer:this.layer})}destroy(){this.exportImageParameters.destroy(),this.exportImageParameters=null}get exportImageVersion(){var e;return null==(e=this.exportImageParameters)||e.commitProperty("version"),this.commitProperty("timeExtent"),(this._get("exportImageVersion")||0)+1}fetchPopupFeatures(e){const{layer:t}=this;if(!e)return Promise.reject(new s.s("wmslayerview:fetchPopupFeatures","Nothing to fetch without area",{layer:t}));const{popupEnabled:i}=t;if(!i)return Promise.reject(new s.s("wmslayerview:fetchPopupFeatures","popupEnabled should be true",{popupEnabled:i}));const r=this.createFetchPopupFeaturesQuery(e);if(!r)return Promise.resolve([]);const{extent:n,width:a,height:o,x:l,y:h}=r;if(!(n&&a&&o))throw new s.s("wmslayerview:fetchPopupFeatures","WMSLayer does not support fetching features.",{extent:n,width:a,height:o});const u=t.fetchFeatureInfo(n,a,o,l,h);return Promise.resolve(u?[u]:[])}};return(0,r.e)([(0,n.y)()],t.prototype,"exportImageParameters",void 0),(0,r.e)([(0,n.y)({readOnly:!0})],t.prototype,"exportImageVersion",null),(0,r.e)([(0,n.y)()],t.prototype,"layer",void 0),(0,r.e)([(0,n.y)(a.u)],t.prototype,"timeExtent",void 0),t=(0,r.e)([(0,n.n)("esri.layers.mixins.WMSLayerView")],t),t}},42132:(e,t,i)=>{"use strict";i.r(t),i.d(t,{W:()=>C,a:()=>w,x:()=>I});var r,s=i(78155),n=i(80987),a=i(20215),o=i(79506),l=i(80219),h=i(88903),u=i(4169),c=i(41290),d=i(51218),p=i(13895),f=i(15576),y=i(28941),m=i(19438),g=i(25290),_=i(98548),x=i(92858),v=i(20736);let b=r=class extends s.a{constructor(e){super(e)}clone(){return new r({customLayerParameters:(0,l.y)(this.customLayerParameters),customParameters:(0,l.y)(this.customParameters),layerIdentifier:this.layerIdentifier,tileMatrixSet:this.tileMatrixSet,url:this.url})}};(0,s.e)([(0,h.y)({json:{type:Object,write:!0}})],b.prototype,"customLayerParameters",void 0),(0,s.e)([(0,h.y)({json:{type:Object,write:!0}})],b.prototype,"customParameters",void 0),(0,s.e)([(0,h.y)({type:String,json:{write:!0}})],b.prototype,"layerIdentifier",void 0),(0,s.e)([(0,h.y)({type:String,json:{write:!0}})],b.prototype,"tileMatrixSet",void 0),(0,s.e)([(0,h.y)({type:String,json:{write:!0}})],b.prototype,"url",void 0),b=r=(0,s.e)([(0,h.n)("esri.layer.support.WMTSLayerInfo")],b);var w=b;let S=class extends((0,d.t)((0,y.o)((0,m.s)((0,p.l)((0,f.w)((0,o.l)(c.b))))))){constructor(...e){super(...e),this.copyright="",this.fullExtent=new _.M(-20037508.342787,-20037508.34278,20037508.34278,20037508.342787,x.k.WebMercator),this.legendEnabled=!1,this.isReference=null,this.popupEnabled=!1,this.spatialReference=x.k.WebMercator,this.subDomains=null,this.tileInfo=new g.S({size:[256,256],dpi:96,format:"png8",compressionQuality:0,origin:new v.b({x:-20037508.342787,y:20037508.342787,spatialReference:x.k.WebMercator}),spatialReference:x.k.WebMercator,lods:[new g.i({level:0,scale:591657527.591555,resolution:156543.033928}),new g.i({level:1,scale:295828763.795777,resolution:78271.5169639999}),new g.i({level:2,scale:147914381.897889,resolution:39135.7584820001}),new g.i({level:3,scale:73957190.948944,resolution:19567.8792409999}),new g.i({level:4,scale:36978595.474472,resolution:9783.93962049996}),new g.i({level:5,scale:18489297.737236,resolution:4891.96981024998}),new g.i({level:6,scale:9244648.868618,resolution:2445.98490512499}),new g.i({level:7,scale:4622324.434309,resolution:1222.99245256249}),new g.i({level:8,scale:2311162.217155,resolution:611.49622628138}),new g.i({level:9,scale:1155581.108577,resolution:305.748113140558}),new g.i({level:10,scale:577790.554289,resolution:152.874056570411}),new g.i({level:11,scale:288895.277144,resolution:76.4370282850732}),new g.i({level:12,scale:144447.638572,resolution:38.2185141425366}),new g.i({level:13,scale:72223.819286,resolution:19.1092570712683}),new g.i({level:14,scale:36111.909643,resolution:9.55462853563415}),new g.i({level:15,scale:18055.954822,resolution:4.77731426794937}),new g.i({level:16,scale:9027.977411,resolution:2.38865713397468}),new g.i({level:17,scale:4513.988705,resolution:1.19432856685505}),new g.i({level:18,scale:2256.994353,resolution:.597164283559817}),new g.i({level:19,scale:1128.497176,resolution:.298582141647617})]}),this.type="web-tile",this.urlTemplate=null,this.wmtsInfo=null}normalizeCtorArgs(e,t){return"string"==typeof e?{urlTemplate:e,...t}:e}load(e){const t=this.loadFromPortal({supportedTypes:["WMTS"]},e).then((()=>{let e="";if(this.urlTemplate)if(this.spatialReference.equals(this.tileInfo.spatialReference)){const t=new n.$(this.urlTemplate);this.subDomains&&this.subDomains.length>0||-1===t.authority.indexOf("{subDomain}")||(e="is missing 'subDomains' property")}else e="spatialReference must match tileInfo.spatialReference";else e="is missing the required 'urlTemplate' property value";if(e)throw new a.s("web-tile-layer:load",`WebTileLayer (title: '${this.title}', id: '${this.id}') ${e}`)}));return this.addResolvingPromise(t),Promise.resolve(this)}get levelValues(){const e=[];if(!this.tileInfo)return null;for(const t of this.tileInfo.lods)e[t.level]=t.levelValue||t.level;return e}readSpatialReference(e,t){return e||t.fullExtent&&t.fullExtent.spatialReference&&x.k.fromJSON(t.fullExtent.spatialReference)}get tileServers(){if(!this.urlTemplate)return null;const e=[],{urlTemplate:t,subDomains:i}=this,r=new n.$(t),s=r.scheme?r.scheme+"://":"//",a=s+r.authority+"/";if(-1===r.authority.indexOf("{subDomain}"))e.push(a);else if(i&&i.length>0&&r.authority.split(".").length>1)for(const t of i)e.push(s+r.authority.replace(/\{subDomain\}/gi,t)+"/");return e.map((e=>("/"!==e.charAt(e.length-1)&&(e+="/"),e)))}get urlPath(){if(!this.urlTemplate)return null;const e=this.urlTemplate,t=new n.$(e),i=(t.scheme?t.scheme+"://":"//")+t.authority+"/";return e.substring(i.length)}readUrlTemplate(e,t){return e||t.templateUrl}writeUrlTemplate(e,t){e&&(0,n.j)(e)&&(e="https:"+e),e&&(e=e.replace(/\{z\}/gi,"{level}").replace(/\{x\}/gi,"{col}").replace(/\{y\}/gi,"{row}"),e=(0,n.z)(e)),t.templateUrl=e}fetchTile(e,t,i,r={}){const{signal:s,timestamp:a}=r,o=this.getTileUrl(e,t,i),l={responseType:"image",signal:s};return null!=a&&(l.query={_ts:r.timestamp}),(0,n.L)(o,l).then((e=>e.data))}getTileUrl(e,t,i){const r=this.levelValues[e];return this.tileServers[t%this.tileServers.length]+(0,l.b)(this.urlPath,{level:r,z:r,col:i,x:i,row:t,y:t})}};(0,s.e)([(0,h.y)({type:String,value:"",json:{write:!0}})],S.prototype,"copyright",void 0),(0,s.e)([(0,h.y)({type:_.M,json:{write:!0}})],S.prototype,"fullExtent",void 0),(0,s.e)([(0,h.y)({readOnly:!0,json:{read:!1,write:!1}})],S.prototype,"legendEnabled",void 0),(0,s.e)([(0,h.y)({type:["show","hide"]})],S.prototype,"listMode",void 0),(0,s.e)([(0,h.y)()],S.prototype,"levelValues",null),(0,s.e)([(0,h.y)({type:Boolean,json:{read:!1,write:{enabled:!0,overridePolicy:()=>({enabled:!1})}}})],S.prototype,"isReference",void 0),(0,s.e)([(0,h.y)({type:["WebTiledLayer"],value:"WebTiledLayer"})],S.prototype,"operationalLayerType",void 0),(0,s.e)([(0,h.y)({readOnly:!0,json:{read:!1,write:!1}})],S.prototype,"popupEnabled",void 0),(0,s.e)([(0,h.y)({type:x.k})],S.prototype,"spatialReference",void 0),(0,s.e)([(0,u.e)("spatialReference",["spatialReference","fullExtent.spatialReference"])],S.prototype,"readSpatialReference",null),(0,s.e)([(0,h.y)({type:[String],json:{write:!0}})],S.prototype,"subDomains",void 0),(0,s.e)([(0,h.y)({type:g.S,json:{write:!0}})],S.prototype,"tileInfo",void 0),(0,s.e)([(0,h.y)({readOnly:!0})],S.prototype,"tileServers",null),(0,s.e)([(0,h.y)({json:{read:!1}})],S.prototype,"type",void 0),(0,s.e)([(0,h.y)()],S.prototype,"urlPath",null),(0,s.e)([(0,h.y)({type:String,json:{origins:{"portal-item":{read:{source:"url"}}}}})],S.prototype,"urlTemplate",void 0),(0,s.e)([(0,u.e)("urlTemplate",["urlTemplate","templateUrl"])],S.prototype,"readUrlTemplate",null),(0,s.e)([(0,s.o)("urlTemplate",{templateUrl:{type:String}})],S.prototype,"writeUrlTemplate",null),(0,s.e)([(0,h.y)({type:w,json:{write:!0}})],S.prototype,"wmtsInfo",void 0),S=(0,s.e)([(0,h.n)("esri.layers.WebTileLayer")],S);var I=S,C=Object.freeze({__proto__:null,default:I})},54622:(e,t,i)=>{"use strict";i.r(t),i.d(t,{WhereClause:()=>w,defaultAttributeAdapter:()=>k});var r=i(80219);const s={min:{minParams:1,maxParams:1,evaluate:e=>null==e[0]?null:Math.min.apply(Math,e[0])},max:{minParams:1,maxParams:1,evaluate:e=>null==e[0]?null:Math.max.apply(Math,e[0])},avg:{minParams:1,maxParams:1,evaluate:e=>null==e[0]?null:n(e[0])},sum:{minParams:1,maxParams:1,evaluate:e=>null==e[0]?null:function(e){let t=0;for(let i=0;i<e.length;i++)t+=e[i];return t}(e[0])},stddev:{minParams:1,maxParams:1,evaluate:e=>null==e[0]?null:Math.sqrt(a(e[0]))},count:{minParams:1,maxParams:1,evaluate:e=>null==e[0]?null:e[0].length},var:{minParams:1,maxParams:1,evaluate:e=>null==e[0]?null:a(e[0])}};function n(e){let t=0;for(let i=0;i<e.length;i++)t+=e[i];return t/e.length}function a(e){const t=n(e),i=e.length;let r=0;for(const i of e)r+=(i-t)**2;return i>1?r/(i-1):0}class o{constructor(){this.op="+",this.day=0,this.second=0,this.hour=0,this.month=0,this.year=0,this.minute=0}static fixDefaults(e){if(null!==e.precision||null!==e.secondary)throw new Error("Primary and Secondary SqlInterval qualifiers not supported")}static createFromMilliseconds(e){const t=new o;return t.second=e/1e3,t}static createFromValueAndQualifer(e,t,i){let r=null;const s=new o;if(s.op="-"===i?"-":"+","interval-period"===t.type){o.fixDefaults(t);const i=new RegExp("^[0-9]{1,}$");if("year"===t.period||"month"===t.period)throw new Error("Year-Month Intervals not supported");if(!i.test(e))throw new Error("Illegal Interval");s[t.period]=parseFloat(e)}else{if(o.fixDefaults(t.start),o.fixDefaults(t.end),"year"===t.start.period||"month"===t.start.period)throw new Error("Year-Month Intervals not supported");if("year"===t.end.period||"month"===t.end.period)throw new Error("Year-Month Intervals not supported");switch(t.start.period){case"day":switch(t.end.period){case"hour":if(r=new RegExp("^[0-9]{1,} [0-9]{1,}$"),!r.test(e))throw new Error("Illegal Interval");s[t.start.period]=parseFloat(e.split(" ")[0]),s[t.end.period]=parseFloat(e.split(" ")[1]);break;case"minute":if(r=new RegExp("^[0-9]{1,} [0-9]{1,2}:[0-9]{1,}$"),!r.test(e))throw new Error("Illegal Interval");{s[t.start.period]=parseFloat(e.split(" ")[0]);const i=e.split(" ")[1].split(":");s.hour=parseFloat(i[0]),s.minute=parseFloat(i[1])}break;case"second":if(r=new RegExp("^[0-9]{1,} [0-9]{1,2}:[0-9]{1,2}:[0-9]{1,}([.]{1}[0-9]{1,}){0,1}$"),!r.test(e))throw new Error("Illegal Interval");{s[t.start.period]=parseFloat(e.split(" ")[0]);const i=e.split(" ")[1].split(":");s.hour=parseFloat(i[0]),s.minute=parseFloat(i[1]),s.second=parseFloat(i[2])}break;default:throw"Invalid Interval."}break;case"hour":switch(t.end.period){case"minute":if(r=new RegExp("^[0-9]{1,}:[0-9]{1,}$"),!r.test(e))throw new Error("Illegal Interval");s.hour=parseFloat(e.split(":")[0]),s.minute=parseFloat(e.split(":")[1]);break;case"second":if(r=new RegExp("^[0-9]{1,}:[0-9]{1,2}:[0-9]{1,}([.]{1}[0-9]{1,}){0,1}$"),!r.test(e))throw new Error("Illegal Interval");{const t=e.split(":");s.hour=parseFloat(t[0]),s.minute=parseFloat(t[1]),s.second=parseFloat(t[2])}break;default:throw"Invalid Interval."}break;case"minute":switch(t.end.period){case"second":if(r=new RegExp("^[0-9]{1,}:[0-9]{1,}([.]{1}[0-9]{1,}){0,1}$"),!r.test(e))throw new Error("Illegal Interval");{const t=e.split(":");s.minute=parseFloat(t[0]),s.second=parseFloat(t[1])}break;default:throw"Invalid Interval."}break;default:throw"Invalid Interval."}}return s}valueInMilliseconds(){return("-"===this.op?-1:1)*(1e3*this.second+60*this.minute*1e3+60*this.hour*60*1e3+24*this.day*60*60*1e3+this.month*(365/12)*24*60*60*1e3+365*this.year*24*60*60*1e3)}}function l(e,t){const i=h[e.toLowerCase()];if(null==i)throw new Error("Function Not Recognised");if(t.length<i.minParams||t.length>i.maxParams)throw new Error(`Invalid Parameter count for call to ${e.toUpperCase()}`);return i.evaluate(t)}const h={extract:{minParams:2,maxParams:2,evaluate:([e,t])=>{if(null==t)return null;if(t instanceof Date)switch(e.toUpperCase()){case"SECOND":return t.getSeconds();case"MINUTE":return t.getMinutes();case"HOUR":return t.getHours();case"DAY":return t.getDate();case"MONTH":return t.getMonth()+1;case"YEAR":return t.getFullYear()}throw new Error("Invalid Parameter for call to EXTRACT")}},substring:{minParams:2,maxParams:3,evaluate:e=>{if(2===e.length){const[t,i]=e;return null==t||null==i?null:t.toString().substring(i-1)}if(3===e.length){const[t,i,r]=e;return null==t||null==i||null==r?null:r<=0?"":t.toString().substring(i-1,i+r-1)}}},position:{minParams:2,maxParams:2,evaluate:([e,t])=>null==e||null==t?null:t.indexOf(e)+1},trim:{minParams:2,maxParams:3,evaluate:e=>{const t=3===e.length,i=t?e[1]:" ",s=t?e[2]:e[1];if(null==i||null==s)return null;const n=`(${(0,r.N)(i)})`;switch(e[0]){case"BOTH":return s.replace(new RegExp(`^${n}*|${n}*$`,"g"),"");case"LEADING":return s.replace(new RegExp(`^${n}*`,"g"),"");case"TRAILING":return s.replace(new RegExp(`${n}*$`,"g"),"")}throw new Error("Invalid Parameter for call to TRIM")}},abs:{minParams:1,maxParams:1,evaluate:e=>null==e[0]?null:Math.abs(e[0])},ceiling:{minParams:1,maxParams:1,evaluate:e=>null==e[0]?null:Math.ceil(e[0])},floor:{minParams:1,maxParams:1,evaluate:e=>null==e[0]?null:Math.floor(e[0])},log:{minParams:1,maxParams:1,evaluate:e=>null==e[0]?null:Math.log(e[0])},log10:{minParams:1,maxParams:1,evaluate:e=>null==e[0]?null:Math.log(e[0])*Math.LOG10E},sin:{minParams:1,maxParams:1,evaluate:e=>null==e[0]?null:Math.sin(e[0])},cos:{minParams:1,maxParams:1,evaluate:e=>null==e[0]?null:Math.cos(e[0])},tan:{minParams:1,maxParams:1,evaluate:e=>null==e[0]?null:Math.tan(e[0])},asin:{minParams:1,maxParams:1,evaluate:e=>null==e[0]?null:Math.asin(e[0])},acos:{minParams:1,maxParams:1,evaluate:e=>null==e[0]?null:Math.acos(e[0])},atan:{minParams:1,maxParams:1,evaluate:e=>null==e[0]?null:Math.atan(e[0])},sign:{minParams:1,maxParams:1,evaluate:e=>null==e[0]?null:e[0]>0?1:e[1]<0?-1:0},power:{minParams:2,maxParams:2,evaluate:e=>null==e[0]||null==e[1]?null:e[0]**e[1]},mod:{minParams:2,maxParams:2,evaluate:e=>null==e[0]||null==e[1]?null:e[0]%e[1]},round:{minParams:1,maxParams:2,evaluate:e=>{const t=e[0],i=2===e.length?10**e[1]:1;return null==t?null:Math.round(t*i)/i}},truncate:{minParams:1,maxParams:2,evaluate:e=>null==e[0]?null:1===e.length?parseInt(e[0].toFixed(0),10):parseFloat(e[0].toFixed(e[1]))},char_length:{minParams:1,maxParams:1,evaluate:e=>"string"==typeof e[0]||e[0]instanceof String?e[0].length:0},concat:{minParams:1,maxParams:1/0,evaluate:e=>{let t="";for(let i=0;i<e.length;i++){if(null==e[i])return null;t+=e[i].toString()}return t}},lower:{minParams:1,maxParams:1,evaluate:e=>null==e[0]?null:e[0].toString().toLowerCase()},upper:{minParams:1,maxParams:1,evaluate:e=>null==e[0]?null:e[0].toString().toUpperCase()}};var u,c,d={exports:{}};c=function(){function e(t,i,r,s){this.message=t,this.expected=i,this.found=r,this.location=s,this.name="SyntaxError","function"==typeof Error.captureStackTrace&&Error.captureStackTrace(this,e)}return function(e,t){function i(){this.constructor=e}i.prototype=t.prototype,e.prototype=new i}(e,Error),e.buildMessage=function(e,t){var i={literal:function(e){return'"'+s(e.text)+'"'},class:function(e){var t,i="";for(t=0;t<e.parts.length;t++)i+=e.parts[t]instanceof Array?n(e.parts[t][0])+"-"+n(e.parts[t][1]):n(e.parts[t]);return"["+(e.inverted?"^":"")+i+"]"},any:function(e){return"any character"},end:function(e){return"end of input"},other:function(e){return e.description}};function r(e){return e.charCodeAt(0).toString(16).toUpperCase()}function s(e){return e.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,(function(e){return"\\x0"+r(e)})).replace(/[\x10-\x1F\x7F-\x9F]/g,(function(e){return"\\x"+r(e)}))}function n(e){return e.replace(/\\/g,"\\\\").replace(/\]/g,"\\]").replace(/\^/g,"\\^").replace(/-/g,"\\-").replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,(function(e){return"\\x0"+r(e)})).replace(/[\x10-\x1F\x7F-\x9F]/g,(function(e){return"\\x"+r(e)}))}function a(e){return i[e.type](e)}return"Expected "+function(e){var t,i,r=new Array(e.length);for(t=0;t<e.length;t++)r[t]=a(e[t]);if(r.sort(),r.length>0){for(t=1,i=1;t<r.length;t++)r[t-1]!==r[t]&&(r[i]=r[t],i++);r.length=i}switch(r.length){case 1:return r[0];case 2:return r[0]+" or "+r[1];default:return r.slice(0,-1).join(", ")+", or "+r[r.length-1]}}(e)+" but "+function(e){return e?'"'+s(e)+'"':"end of input"}(t)+" found."},{SyntaxError:e,parse:function(t,i){i=void 0!==i?i:{};var r,s={},n={start:He},a=He,o=function(e,t){return fi(e,t)},l=Ge("!",!1),h=Ge("=",!1),u=Ge(">=",!1),c=Ge(">",!1),d=Ge("<=",!1),p=Ge("<>",!1),f=Ge("<",!1),y=Ge("!=",!1),m=function(e){return e[0]+" "+e[2]},g=Ge("+",!1),_=Ge("-",!1),x=Ge("*",!1),v=Ge("/",!1),b=function(e,t){return e+t.join("")},w=/^[A-Za-z_\x80-\uFFFF]/,S=ze([["A","Z"],["a","z"],"_",["","￿"]],!1,!1),I=/^[A-Za-z0-9_]/,C=ze([["A","Z"],["a","z"],["0","9"],"_"],!1,!1),M=/^[A-Za-z0-9_.\x80-\uFFFF]/,T=ze([["A","Z"],["a","z"],["0","9"],"_",".",["","￿"]],!1,!1),E=Ge("@",!1),F=function(e){return{type:"interval-period",period:e.value,precision:null,secondary:null}},A=function(e,t){return{type:"interval-period",period:"second",precision:e,secondary:t}},R=function(e){return parseFloat(e)},P=Ge("'",!1),L=Ge("N'",!1),D="''",N=Ge("''",!1),O=/^[^']/,k=ze(["'"],!0,!1),V=function(e,t){return{type:"when_clause",operand:e,value:t}},U=Ge(".",!1),G=/^[0-9]/,z=ze([["0","9"]],!1,!1),B=/^[eE]/,j=ze(["e","E"],!1,!1),q=/^[+\-]/,H=ze(["+","-"],!1,!1),W=Ge("NULL",!0),Q=Ge("TRUE",!0),Z=Ge("FALSE",!0),Y=Ge("IN",!0),J=Ge("IS",!0),X=Ge("LIKE",!0),$=Ge("ESCAPE",!0),K=Ge("NOT",!0),ee=Ge("AND",!0),te=Ge("OR",!0),ie=Ge("BETWEEN",!0),re=Ge("FROM",!0),se=Ge("FOR",!0),ne=Ge("SUBSTRING",!0),ae=Ge("EXTRACT",!0),oe=Ge("TRIM",!0),le=Ge("POSITION",!0),he=Ge("TIMESTAMP",!0),ue=Ge("DATE",!0),ce=Ge("LEADING",!0),de=Ge("TRAILING",!0),pe=Ge("BOTH",!0),fe=Ge("TO",!0),ye=Ge("INTERVAL",!0),me=Ge("YEAR",!0),ge=Ge("MONTH",!0),_e=Ge("DAY",!0),xe=Ge("HOUR",!0),ve=Ge("MINUTE",!0),be=Ge("SECOND",!0),we=Ge("CASE",!0),Se=Ge("END",!0),Ie=Ge("WHEN",!0),Ce=Ge("THEN",!0),Me=Ge("ELSE",!0),Te=Ge(",",!1),Ee=Ge("(",!1),Fe=Ge(")",!1),Ae=/^[ \t\n\r]/,Re=ze([" ","\t","\n","\r"],!1,!1),Pe=Ge("`",!1),Le=/^[^`]/,De=ze(["`"],!0,!1),Ne=0,Oe=[{line:1,column:1}],ke=0,Ve=[],Ue=0;if("startRule"in i){if(!(i.startRule in n))throw new Error("Can't start parsing from rule \""+i.startRule+'".');a=n[i.startRule]}function Ge(e,t){return{type:"literal",text:e,ignoreCase:t}}function ze(e,t,i){return{type:"class",parts:e,inverted:t,ignoreCase:i}}function Be(e){var i,r=Oe[e];if(r)return r;for(i=e-1;!Oe[i];)i--;for(r={line:(r=Oe[i]).line,column:r.column};i<e;)10===t.charCodeAt(i)?(r.line++,r.column=1):r.column++,i++;return Oe[e]=r,r}function je(e,t){var i=Be(e),r=Be(t);return{start:{offset:e,line:i.line,column:i.column},end:{offset:t,line:r.line,column:r.column}}}function qe(e){Ne<ke||(Ne>ke&&(ke=Ne,Ve=[]),Ve.push(e))}function He(){var e,t;return e=Ne,ui()!==s&&(t=Qe())!==s&&ui()!==s?e=t:(Ne=e,e=s),e}function We(){var e,t,i,r,n,a,o,l;if(e=Ne,(t=Qe())!==s){for(i=[],r=Ne,(n=ui())!==s&&(a=oi())!==s&&(o=ui())!==s&&(l=Qe())!==s?r=n=[n,a,o,l]:(Ne=r,r=s);r!==s;)i.push(r),r=Ne,(n=ui())!==s&&(a=oi())!==s&&(o=ui())!==s&&(l=Qe())!==s?r=n=[n,a,o,l]:(Ne=r,r=s);i!==s?e=t=function(e,t){var i={type:"expr_list"},r=function(e,t,i){return function(e,t){for(var i=[e],r=0;r<t.length;r++)i.push(t[r][3]);return i}(e,t)}(e,t);return i.value=r,i}(t,i):(Ne=e,e=s)}else Ne=e,e=s;return e}function Qe(){var e,t,i,r,n,a,l,h;if(e=Ne,(t=Ze())!==s){for(i=[],r=Ne,(n=ui())!==s&&(a=Nt())!==s&&(l=ui())!==s&&(h=Ze())!==s?r=n=[n,a,l,h]:(Ne=r,r=s);r!==s;)i.push(r),r=Ne,(n=ui())!==s&&(a=Nt())!==s&&(l=ui())!==s&&(h=Ze())!==s?r=n=[n,a,l,h]:(Ne=r,r=s);i!==s?e=t=o(t,i):(Ne=e,e=s)}else Ne=e,e=s;return e}function Ze(){var e,t,i,r,n,a,l,h;if(e=Ne,(t=Ye())!==s){for(i=[],r=Ne,(n=ui())!==s&&(a=Dt())!==s&&(l=ui())!==s&&(h=Ye())!==s?r=n=[n,a,l,h]:(Ne=r,r=s);r!==s;)i.push(r),r=Ne,(n=ui())!==s&&(a=Dt())!==s&&(l=ui())!==s&&(h=Ye())!==s?r=n=[n,a,l,h]:(Ne=r,r=s);i!==s?e=t=o(t,i):(Ne=e,e=s)}else Ne=e,e=s;return e}function Ye(){var e,i,r,n,a;return e=Ne,(i=Lt())===s&&(i=Ne,33===t.charCodeAt(Ne)?(r="!",Ne++):(r=s,0===Ue&&qe(l)),r!==s?(n=Ne,Ue++,61===t.charCodeAt(Ne)?(a="=",Ne++):(a=s,0===Ue&&qe(h)),Ue--,a===s?n=void 0:(Ne=n,n=s),n!==s?i=r=[r,n]:(Ne=i,i=s)):(Ne=i,i=s)),i!==s&&(r=ui())!==s&&(n=Ye())!==s?e=i=function(e){return function(e,t){return{type:"unary_expr",operator:"NOT",expr:t}}(0,e)}(n):(Ne=e,e=s),e===s&&(e=function(){var e,t,i;return e=Ne,(t=Ke())!==s&&ui()!==s?((i=function(){var e;return(e=function(){var e,t,i,r,n,a;if(e=[],t=Ne,(i=ui())!==s&&(r=Je())!==s&&(n=ui())!==s&&(a=Ke())!==s?t=i=[i,r,n,a]:(Ne=t,t=s),t!==s)for(;t!==s;)e.push(t),t=Ne,(i=ui())!==s&&(r=Je())!==s&&(n=ui())!==s&&(a=Ke())!==s?t=i=[i,r,n,a]:(Ne=t,t=s);else e=s;return e!==s&&(e=function(e){return{type:"arithmetic",tail:e}}(e)),e}())===s&&(e=function(){var e,t,i,r;return e=Ne,(t=$e())!==s&&ui()!==s&&(i=li())!==s&&ui()!==s&&(r=We())!==s&&ui()!==s&&hi()!==s?e=t=function(e,t){return{op:e,right:t}}(t,r):(Ne=e,e=s),e===s&&(e=Ne,(t=$e())!==s&&ui()!==s&&(i=li())!==s&&ui()!==s&&(r=hi())!==s?e=t=function(e){return{op:e,right:{type:"expr_list",value:[]}}}(t):(Ne=e,e=s),e===s&&(e=Ne,(t=$e())!==s&&ui()!==s&&(i=lt())!==s?e=t=function(e,t){return{op:e,right:t}}(t,i):(Ne=e,e=s))),e}())===s&&(e=function(){var e,t,i,r,n,a;return e=Ne,(t=Lt())!==s&&ui()!==s&&(i=Ot())!==s&&ui()!==s&&(r=Ke())!==s&&ui()!==s&&(n=Dt())!==s&&ui()!==s&&(a=Ke())!==s?e=t=function(e,t,i){return{op:"NOT"+e,right:{type:"expr_list",value:[t,i]}}}(i,r,a):(Ne=e,e=s),e===s&&(e=Ne,(t=Ot())!==s&&ui()!==s&&(i=Ke())!==s&&ui()!==s&&(r=Dt())!==s&&ui()!==s&&(n=Ke())!==s?e=t=function(e,t,i){return{op:e,right:{type:"expr_list",value:[t,i]}}}(t,i,n):(Ne=e,e=s)),e}())===s&&(e=function(){var e,t,i,r;return e=Ne,(t=At())!==s&&ui()!==s&&(i=Lt())!==s&&ui()!==s&&(r=Ke())!==s?e=t=function(e,t){return{op:e+"NOT",right:t}}(t,r):(Ne=e,e=s),e===s&&(e=Ne,(t=At())!==s&&ui()!==s&&(i=Ke())!==s?e=t=function(e,t){return{op:e,right:t}}(t,i):(Ne=e,e=s)),e}())===s&&(e=function(){var e,t,i,r;return e=Ne,(t=Xe())!==s&&ui()!==s&&(i=yt())!==s&&ui()!==s&&Pt()!==s&&ui()!==s&&(r=mt())!==s?e=t=function(e,t,i){return{op:e,right:t,escape:i.value}}(t,i,r):(Ne=e,e=s),e===s&&(e=Ne,(t=Xe())!==s&&ui()!==s&&(i=yt())!==s?e=t=function(e,t){return{op:e,right:t,escape:""}}(t,i):(Ne=e,e=s)),e}()),e}())===s&&(i=null),i!==s?e=t=function(e,t){return""==t||null==t||null==t?e:"arithmetic"==t.type?fi(e,t.tail):pi(t.op,e,t.right,t.escape)}(t,i):(Ne=e,e=s)):(Ne=e,e=s),e}()),e}function Je(){var e;return">="===t.substr(Ne,2)?(e=">=",Ne+=2):(e=s,0===Ue&&qe(u)),e===s&&(62===t.charCodeAt(Ne)?(e=">",Ne++):(e=s,0===Ue&&qe(c)),e===s&&("<="===t.substr(Ne,2)?(e="<=",Ne+=2):(e=s,0===Ue&&qe(d)),e===s&&("<>"===t.substr(Ne,2)?(e="<>",Ne+=2):(e=s,0===Ue&&qe(p)),e===s&&(60===t.charCodeAt(Ne)?(e="<",Ne++):(e=s,0===Ue&&qe(f)),e===s&&(61===t.charCodeAt(Ne)?(e="=",Ne++):(e=s,0===Ue&&qe(h)),e===s&&("!="===t.substr(Ne,2)?(e="!=",Ne+=2):(e=s,0===Ue&&qe(y)))))))),e}function Xe(){var e,t,i,r,n;return e=Ne,t=Ne,(i=Lt())!==s&&(r=ui())!==s&&(n=Rt())!==s?t=i=[i,r,n]:(Ne=t,t=s),t!==s&&(t=m(t)),(e=t)===s&&(e=Rt()),e}function $e(){var e,t,i,r,n;return e=Ne,t=Ne,(i=Lt())!==s&&(r=ui())!==s&&(n=Ft())!==s?t=i=[i,r,n]:(Ne=t,t=s),t!==s&&(t=m(t)),(e=t)===s&&(e=Ft()),e}function Ke(){var e,t,i,r,n,a,l,h;if(e=Ne,(t=tt())!==s){for(i=[],r=Ne,(n=ui())!==s&&(a=et())!==s&&(l=ui())!==s&&(h=tt())!==s?r=n=[n,a,l,h]:(Ne=r,r=s);r!==s;)i.push(r),r=Ne,(n=ui())!==s&&(a=et())!==s&&(l=ui())!==s&&(h=tt())!==s?r=n=[n,a,l,h]:(Ne=r,r=s);i!==s?e=t=o(t,i):(Ne=e,e=s)}else Ne=e,e=s;return e}function et(){var e;return 43===t.charCodeAt(Ne)?(e="+",Ne++):(e=s,0===Ue&&qe(g)),e===s&&(45===t.charCodeAt(Ne)?(e="-",Ne++):(e=s,0===Ue&&qe(_))),e}function tt(){var e,t,i,r,n,a,o,l;if(e=Ne,(t=rt())!==s){for(i=[],r=Ne,(n=ui())!==s&&(a=it())!==s&&(o=ui())!==s&&(l=rt())!==s?r=n=[n,a,o,l]:(Ne=r,r=s);r!==s;)i.push(r),r=Ne,(n=ui())!==s&&(a=it())!==s&&(o=ui())!==s&&(l=rt())!==s?r=n=[n,a,o,l]:(Ne=r,r=s);i!==s?e=t=function(e,t){return fi(e,t)}(t,i):(Ne=e,e=s)}else Ne=e,e=s;return e}function it(){var e;return 42===t.charCodeAt(Ne)?(e="*",Ne++):(e=s,0===Ue&&qe(x)),e===s&&(47===t.charCodeAt(Ne)?(e="/",Ne++):(e=s,0===Ue&&qe(v))),e}function rt(){var e,t;return(e=function(){var e;return(e=mt())===s&&(e=function(){var e,t,i,r;return e=Ne,(t=function(){var e,t,i,r;return e=Ne,(t=vt())!==s&&(i=bt())!==s&&(r=wt())!==s?e=t=function(e,t,i){return parseFloat(e+t+i)}(t,i,r):(Ne=e,e=s),e===s&&(e=Ne,(t=vt())!==s&&(i=bt())!==s?e=t=function(e,t){return parseFloat(e+t)}(t,i):(Ne=e,e=s),e===s&&(e=Ne,(t=vt())!==s&&(i=wt())!==s?e=t=function(e,t){return parseFloat(e+t)}(t,i):(Ne=e,e=s),e===s&&(e=Ne,(t=vt())!==s&&(t=function(e){return parseFloat(e)}(t)),e=t))),e}())!==s?(i=Ne,Ue++,r=nt(),Ue--,r===s?i=void 0:(Ne=i,i=s),i!==s?e=t=function(e){return{type:"number",value:e}}(t):(Ne=e,e=s)):(Ne=e,e=s),e}())===s&&(e=function(){var e,t;return e=Ne,(t=Tt())!==s&&(t={type:"bool",value:!0}),(e=t)===s&&(e=Ne,(t=Et())!==s&&(t={type:"bool",value:!1}),e=t),e}())===s&&(e=function(){var e;return(e=Mt())!==s&&(e={type:"null",value:null}),e}())===s&&(e=function(){var e,t;return e=Ne,qt()!==s&&ui()!==s&&(t=yt())!==s?e=function(e){return{type:"date",value:e.value}}(t):(Ne=e,e=s),e}())===s&&(e=function(){var e,t;return e=Ne,jt()!==s&&ui()!==s&&(t=yt())!==s?e=function(e){return{type:"timestamp",value:e.value}}(t):(Ne=e,e=s),e}())===s&&(e=ut()),e}())===s&&(e=function(){var e,t,i;return e=Ne,Gt()!==s&&ui()!==s&&li()!==s&&ui()!==s&&(t=function(){var e;return(e=Jt())===s&&(e=Xt())===s&&(e=$t())===s&&(e=Kt())===s&&(e=ei())===s&&(e=ti()),e}())!==s&&ui()!==s&&kt()!==s&&ui()!==s&&(i=Qe())!==s&&ui()!==s&&hi()!==s?e=function(e,t){return{type:"function",name:"extract",args:{type:"expr_list",value:[{type:"string",value:e},t]}}}(t,i):(Ne=e,e=s),e}())===s&&(e=function(){var e,t,i,r,n,a,o,l;return e=Ne,Ut()!==s&&ui()!==s&&li()!==s&&ui()!==s&&(t=Qe())!==s&&ui()!==s&&kt()!==s&&ui()!==s&&(i=Qe())!==s&&ui()!==s?(r=Ne,(n=Vt())!==s&&(a=ui())!==s&&(o=Qe())!==s&&(l=ui())!==s?r=n=[n,a,o,l]:(Ne=r,r=s),r===s&&(r=null),r!==s&&(n=hi())!==s?e=function(e,t,i){return{type:"function",name:"substring",args:{type:"expr_list",value:i?[e,t,i[2]]:[e,t]}}}(t,i,r):(Ne=e,e=s)):(Ne=e,e=s),e}())===s&&(e=function(){var e,t,i,r;return e=Ne,zt()!==s&&ui()!==s&&li()!==s&&ui()!==s?((t=ht())===s&&(t=null),t!==s&&ui()!==s&&(i=Qe())!==s&&ui()!==s&&kt()!==s&&ui()!==s&&(r=Qe())!==s&&ui()!==s&&hi()!==s?e=function(e,t,i){return{type:"function",name:"trim",args:{type:"expr_list",value:[{type:"string",value:null==e?"BOTH":e},t,i]}}}(t,i,r):(Ne=e,e=s)):(Ne=e,e=s),e===s&&(e=Ne,zt()!==s&&ui()!==s&&li()!==s&&ui()!==s?((t=ht())===s&&(t=null),t!==s&&ui()!==s&&(i=Qe())!==s&&ui()!==s&&hi()!==s?e=function(e,t){return{type:"function",name:"trim",args:{type:"expr_list",value:[{type:"string",value:null==e?"BOTH":e},t]}}}(t,i):(Ne=e,e=s)):(Ne=e,e=s)),e}())===s&&(e=function(){var e,t,i;return e=Ne,Bt()!==s&&ui()!==s&&li()!==s&&ui()!==s&&(t=Qe())!==s&&ui()!==s&&Ft()!==s&&ui()!==s&&(i=Qe())!==s&&ui()!==s&&hi()!==s?e=function(e,t){return{type:"function",name:"position",args:{type:"expr_list",value:[e,t]}}}(t,i):(Ne=e,e=s),e}())===s&&(e=function(){var e,t,i;return e=Ne,(t=di())!==s&&ui()!==s&&li()!==s&&ui()!==s?((i=We())===s&&(i=null),i!==s&&ui()!==s&&hi()!==s?e=t=function(e,t){return{type:"function",name:e,args:t||{type:"expr_list",value:[]}}}(t,i):(Ne=e,e=s)):(Ne=e,e=s),e}())===s&&(e=function(){var e;return(e=function(){var e,t,i,r,n;if(e=Ne,ii()!==s)if(ui()!==s)if((t=Qe())!==s)if(ui()!==s){for(i=[],r=_t();r!==s;)i.push(r),r=_t();i!==s&&(r=ui())!==s&&(n=ri())!==s?e=function(e,t){return{type:"case_expression",format:"simple",operand:e,clauses:t,else:null}}(t,i):(Ne=e,e=s)}else Ne=e,e=s;else Ne=e,e=s;else Ne=e,e=s;else Ne=e,e=s;if(e===s)if(e=Ne,ii()!==s)if(ui()!==s)if((t=Qe())!==s)if(ui()!==s){for(i=[],r=_t();r!==s;)i.push(r),r=_t();i!==s&&(r=ui())!==s&&(n=xt())!==s&&ui()!==s&&ri()!==s?e=function(e,t,i){return{type:"case_expression",format:"simple",operand:e,clauses:t,else:i.value}}(t,i,n):(Ne=e,e=s)}else Ne=e,e=s;else Ne=e,e=s;else Ne=e,e=s;else Ne=e,e=s;return e}())===s&&(e=function(){var e,t,i,r;if(e=Ne,ii()!==s)if(ui()!==s){for(t=[],i=gt();i!==s;)t.push(i),i=gt();t!==s&&(i=ui())!==s&&(r=ri())!==s?e=function(e){return{type:"case_expression",format:"searched",clauses:e,else:null}}(t):(Ne=e,e=s)}else Ne=e,e=s;else Ne=e,e=s;if(e===s)if(e=Ne,ii()!==s)if(ui()!==s){for(t=[],i=gt();i!==s;)t.push(i),i=gt();t!==s&&(i=ui())!==s&&(r=xt())!==s&&ui()!==s&&ri()!==s?e=function(e,t){return{type:"case_expression",format:"searched",clauses:e,else:t.value}}(t,r):(Ne=e,e=s)}else Ne=e,e=s;else Ne=e,e=s;return e}()),e}())===s&&(e=function(){var e;return(e=function(){var e;return(e=function(){var e,t,i,r;if(e=Ne,(t=nt())!==s){for(i=[],r=ot();r!==s;)i.push(r),r=ot();i!==s?e=t=b(t,i):(Ne=e,e=s)}else Ne=e,e=s;return e}())!==s&&(e=e),e}())!==s&&(e=function(e){return/^CURRENT_DATE$/i.test(e)?{type:"current_time",mode:"date"}:/^CURRENT_TIMESTAMP$/i.test(e)?{type:"current_time",mode:"timestamp"}:{type:"column_ref",table:"",column:e}}(e)),e}())===s&&(e=lt())===s&&(e=Ne,li()!==s&&ui()!==s&&(t=Qe())!==s&&ui()!==s&&hi()!==s?e=function(e){return e.paren=!0,e}(t):(Ne=e,e=s)),e}function st(){var e,t,i,r;if(e=Ne,(t=nt())!==s){for(i=[],r=at();r!==s;)i.push(r),r=at();i!==s?e=t=b(t,i):(Ne=e,e=s)}else Ne=e,e=s;return e}function nt(){var e;return w.test(t.charAt(Ne))?(e=t.charAt(Ne),Ne++):(e=s,0===Ue&&qe(S)),e}function at(){var e;return I.test(t.charAt(Ne))?(e=t.charAt(Ne),Ne++):(e=s,0===Ue&&qe(C)),e}function ot(){var e;return M.test(t.charAt(Ne))?(e=t.charAt(Ne),Ne++):(e=s,0===Ue&&qe(T)),e}function lt(){var e,i,r;return e=Ne,64===t.charCodeAt(Ne)?(i="@",Ne++):(i=s,0===Ue&&qe(E)),i!==s&&(r=st())!==s?e=i=[i,r]:(Ne=e,e=s),e!==s&&(e=function(e){return{type:"param",value:e[1]}}(e)),e}function ht(){var e;return(e=Ht())===s&&(e=Wt())===s&&(e=Qt()),e}function ut(){var e,i,r,n;return e=Ne,Yt()!==s&&ui()!==s?(45===t.charCodeAt(Ne)?(i="-",Ne++):(i=s,0===Ue&&qe(_)),i===s&&(43===t.charCodeAt(Ne)?(i="+",Ne++):(i=s,0===Ue&&qe(g))),i!==s&&ui()!==s&&(r=yt())!==s&&ui()!==s&&(n=ct())!==s?e=function(e,t,i){return{type:"interval",value:t,qualifier:i,op:e}}(i,r,n):(Ne=e,e=s)):(Ne=e,e=s),e===s&&(e=Ne,Yt()!==s&&ui()!==s&&(i=yt())!==s&&ui()!==s&&(r=ct())!==s?e=function(e,t){return{type:"interval",value:e,qualifier:t,op:""}}(i,r):(Ne=e,e=s)),e}function ct(){var e,t,i;return e=Ne,(t=function(){var e,t,i;return e=Ne,(t=dt())!==s&&ui()!==s&&li()!==s&&ui()!==s&&(i=ft())!==s&&ui()!==s&&hi()!==s?e=t=function(e,t){return{type:"interval-period",period:e.value,precision:t,secondary:null}}(t,i):(Ne=e,e=s),e===s&&(e=Ne,(t=dt())!==s&&(t=F(t)),e=t),e}())!==s&&ui()!==s&&Zt()!==s&&ui()!==s&&(i=function(){var e,t,i,r;return e=Ne,(t=dt())!==s&&(t=function(e){return{type:"interval-period",period:e.value,precision:null,secondary:null}}(t)),(e=t)===s&&(e=Ne,(t=ti())!==s&&ui()!==s&&li()!==s&&ui()!==s&&(i=ft())!==s&&ui()!==s&&oi()!==s&&ui()!==s&&(r=pt())!==s&&ui()!==s&&hi()!==s?e=t=A(i,r):(Ne=e,e=s),e===s&&(e=Ne,(t=ti())!==s&&ui()!==s&&li()!==s&&ui()!==s&&(i=ft())!==s&&ui()!==s&&hi()!==s?e=t=function(e){return{type:"interval-period",period:"second",precision:e,secondary:null}}(i):(Ne=e,e=s),e===s&&(e=Ne,(t=ti())!==s&&(t={type:"interval-period",period:"second",precision:null,secondary:null}),e=t))),e}())!==s?e=t=function(e,t){return{type:"interval-qualifier",start:e,end:t}}(t,i):(Ne=e,e=s),e===s&&(e=function(){var e,t,i,r;return e=Ne,(t=dt())!==s&&ui()!==s&&li()!==s&&ui()!==s&&(i=pt())!==s&&ui()!==s&&hi()!==s?e=t=function(e,t){return{type:"interval-period",period:e.value,precision:t,secondary:null}}(t,i):(Ne=e,e=s),e===s&&(e=Ne,(t=dt())!==s&&(t=F(t)),(e=t)===s&&(e=Ne,(t=ti())!==s&&ui()!==s&&li()!==s&&ui()!==s&&(i=ft())!==s&&ui()!==s&&oi()!==s&&ui()!==s&&(r=pt())!==s&&ui()!==s&&hi()!==s?e=t=A(i,r):(Ne=e,e=s),e===s&&(e=Ne,(t=ti())!==s&&ui()!==s&&li()!==s&&ui()!==s&&(i=pt())!==s&&ui()!==s&&hi()!==s?e=t=function(e){return{type:"interval-period",period:"second",precision:e,secondary:null}}(i):(Ne=e,e=s),e===s&&(e=Ne,(t=ti())!==s&&(t={type:"interval-period",period:"second",precision:null,secondary:null}),e=t)))),e}()),e}function dt(){var e,t;return e=Ne,(t=$t())!==s&&(t={type:"string",value:"day"}),(e=t)===s&&(e=Ne,(t=Kt())!==s&&(t={type:"string",value:"hour"}),(e=t)===s&&(e=Ne,(t=ei())!==s&&(t={type:"string",value:"minute"}),(e=t)===s&&(e=Ne,(t=Xt())!==s&&(t={type:"string",value:"month"}),(e=t)===s&&(e=Ne,(t=Jt())!==s&&(t={type:"string",value:"year"}),e=t)))),e}function pt(){var e;return(e=St())!==s&&(e=R(e)),e}function ft(){var e;return(e=St())!==s&&(e=R(e)),e}function yt(){var e;return(e=mt())===s&&(e=lt()),e}function mt(){var e,i,r,n,a;if(e=Ne,39===t.charCodeAt(Ne)?(i="'",Ne++):(i=s,0===Ue&&qe(P)),i===s&&("N'"===t.substr(Ne,2)?(i="N'",Ne+=2):(i=s,0===Ue&&qe(L))),i!==s){for(r=[],n=Ne,t.substr(Ne,2)===D?(a=D,Ne+=2):(a=s,0===Ue&&qe(N)),a!==s&&(a="'"),(n=a)===s&&(O.test(t.charAt(Ne))?(n=t.charAt(Ne),Ne++):(n=s,0===Ue&&qe(k)));n!==s;)r.push(n),n=Ne,t.substr(Ne,2)===D?(a=D,Ne+=2):(a=s,0===Ue&&qe(N)),a!==s&&(a="'"),(n=a)===s&&(O.test(t.charAt(Ne))?(n=t.charAt(Ne),Ne++):(n=s,0===Ue&&qe(k)));r!==s?(39===t.charCodeAt(Ne)?(n="'",Ne++):(n=s,0===Ue&&qe(P)),n!==s?e=i=function(e){return{type:"string",value:e.join("")}}(r):(Ne=e,e=s)):(Ne=e,e=s)}else Ne=e,e=s;return e}function gt(){var e,t,i;return e=Ne,si()!==s&&ui()!==s&&(t=Qe())!==s&&ui()!==s&&ni()!==s&&ui()!==s&&(i=Qe())!==s?e=V(t,i):(Ne=e,e=s),e}function _t(){var e,t,i;return e=Ne,si()!==s&&ui()!==s&&(t=Qe())!==s&&ui()!==s&&ni()!==s&&ui()!==s&&(i=Qe())!==s?e=V(t,i):(Ne=e,e=s),e}function xt(){var e,t;return e=Ne,ai()!==s&&ui()!==s&&(t=Qe())!==s?e=function(e){return{type:"else_clause",value:e}}(t):(Ne=e,e=s),e}function vt(){var e,i,r;return(e=St())===s&&(e=Ne,45===t.charCodeAt(Ne)?(i="-",Ne++):(i=s,0===Ue&&qe(_)),i===s&&(43===t.charCodeAt(Ne)?(i="+",Ne++):(i=s,0===Ue&&qe(g))),i!==s&&(r=St())!==s?e=i=function(e,t){return e[0]+t}(i,r):(Ne=e,e=s)),e}function bt(){var e,i,r;return e=Ne,46===t.charCodeAt(Ne)?(i=".",Ne++):(i=s,0===Ue&&qe(U)),i!==s?((r=St())===s&&(r=null),r!==s?e=i=function(e){return"."+(null!=e?e:"")}(r):(Ne=e,e=s)):(Ne=e,e=s),e}function wt(){var e,t,i;return e=Ne,(t=Ct())!==s&&(i=St())!==s?e=t=function(e,t){return e+t}(t,i):(Ne=e,e=s),e}function St(){var e,t;if(e=[],(t=It())!==s)for(;t!==s;)e.push(t),t=It();else e=s;return e!==s&&(e=function(e){return e.join("")}(e)),e}function It(){var e;return G.test(t.charAt(Ne))?(e=t.charAt(Ne),Ne++):(e=s,0===Ue&&qe(z)),e}function Ct(){var e,i,r;return e=Ne,B.test(t.charAt(Ne))?(i=t.charAt(Ne),Ne++):(i=s,0===Ue&&qe(j)),i!==s?(q.test(t.charAt(Ne))?(r=t.charAt(Ne),Ne++):(r=s,0===Ue&&qe(H)),r===s&&(r=null),r!==s?e=i=function(e,t){return"e"+(null===t?"":t)}(0,r):(Ne=e,e=s)):(Ne=e,e=s),e}function Mt(){var e,i,r,n;return e=Ne,"null"===t.substr(Ne,4).toLowerCase()?(i=t.substr(Ne,4),Ne+=4):(i=s,0===Ue&&qe(W)),i!==s?(r=Ne,Ue++,n=at(),Ue--,n===s?r=void 0:(Ne=r,r=s),r!==s?e=i=[i,r]:(Ne=e,e=s)):(Ne=e,e=s),e}function Tt(){var e,i,r,n;return e=Ne,"true"===t.substr(Ne,4).toLowerCase()?(i=t.substr(Ne,4),Ne+=4):(i=s,0===Ue&&qe(Q)),i!==s?(r=Ne,Ue++,n=at(),Ue--,n===s?r=void 0:(Ne=r,r=s),r!==s?e=i=[i,r]:(Ne=e,e=s)):(Ne=e,e=s),e}function Et(){var e,i,r,n;return e=Ne,"false"===t.substr(Ne,5).toLowerCase()?(i=t.substr(Ne,5),Ne+=5):(i=s,0===Ue&&qe(Z)),i!==s?(r=Ne,Ue++,n=at(),Ue--,n===s?r=void 0:(Ne=r,r=s),r!==s?e=i=[i,r]:(Ne=e,e=s)):(Ne=e,e=s),e}function Ft(){var e,i,r,n;return e=Ne,"in"===t.substr(Ne,2).toLowerCase()?(i=t.substr(Ne,2),Ne+=2):(i=s,0===Ue&&qe(Y)),i!==s?(r=Ne,Ue++,n=at(),Ue--,n===s?r=void 0:(Ne=r,r=s),r!==s?e=i="IN":(Ne=e,e=s)):(Ne=e,e=s),e}function At(){var e,i,r,n;return e=Ne,"is"===t.substr(Ne,2).toLowerCase()?(i=t.substr(Ne,2),Ne+=2):(i=s,0===Ue&&qe(J)),i!==s?(r=Ne,Ue++,n=at(),Ue--,n===s?r=void 0:(Ne=r,r=s),r!==s?e=i="IS":(Ne=e,e=s)):(Ne=e,e=s),e}function Rt(){var e,i,r,n;return e=Ne,"like"===t.substr(Ne,4).toLowerCase()?(i=t.substr(Ne,4),Ne+=4):(i=s,0===Ue&&qe(X)),i!==s?(r=Ne,Ue++,n=at(),Ue--,n===s?r=void 0:(Ne=r,r=s),r!==s?e=i="LIKE":(Ne=e,e=s)):(Ne=e,e=s),e}function Pt(){var e,i,r,n;return e=Ne,"escape"===t.substr(Ne,6).toLowerCase()?(i=t.substr(Ne,6),Ne+=6):(i=s,0===Ue&&qe($)),i!==s?(r=Ne,Ue++,n=at(),Ue--,n===s?r=void 0:(Ne=r,r=s),r!==s?e=i="ESCAPE":(Ne=e,e=s)):(Ne=e,e=s),e}function Lt(){var e,i,r,n;return e=Ne,"not"===t.substr(Ne,3).toLowerCase()?(i=t.substr(Ne,3),Ne+=3):(i=s,0===Ue&&qe(K)),i!==s?(r=Ne,Ue++,n=at(),Ue--,n===s?r=void 0:(Ne=r,r=s),r!==s?e=i="NOT":(Ne=e,e=s)):(Ne=e,e=s),e}function Dt(){var e,i,r,n;return e=Ne,"and"===t.substr(Ne,3).toLowerCase()?(i=t.substr(Ne,3),Ne+=3):(i=s,0===Ue&&qe(ee)),i!==s?(r=Ne,Ue++,n=at(),Ue--,n===s?r=void 0:(Ne=r,r=s),r!==s?e=i="AND":(Ne=e,e=s)):(Ne=e,e=s),e}function Nt(){var e,i,r,n;return e=Ne,"or"===t.substr(Ne,2).toLowerCase()?(i=t.substr(Ne,2),Ne+=2):(i=s,0===Ue&&qe(te)),i!==s?(r=Ne,Ue++,n=at(),Ue--,n===s?r=void 0:(Ne=r,r=s),r!==s?e=i="OR":(Ne=e,e=s)):(Ne=e,e=s),e}function Ot(){var e,i,r,n;return e=Ne,"between"===t.substr(Ne,7).toLowerCase()?(i=t.substr(Ne,7),Ne+=7):(i=s,0===Ue&&qe(ie)),i!==s?(r=Ne,Ue++,n=at(),Ue--,n===s?r=void 0:(Ne=r,r=s),r!==s?e=i="BETWEEN":(Ne=e,e=s)):(Ne=e,e=s),e}function kt(){var e,i,r,n;return e=Ne,"from"===t.substr(Ne,4).toLowerCase()?(i=t.substr(Ne,4),Ne+=4):(i=s,0===Ue&&qe(re)),i!==s?(r=Ne,Ue++,n=at(),Ue--,n===s?r=void 0:(Ne=r,r=s),r!==s?e=i="FROM":(Ne=e,e=s)):(Ne=e,e=s),e}function Vt(){var e,i,r,n;return e=Ne,"for"===t.substr(Ne,3).toLowerCase()?(i=t.substr(Ne,3),Ne+=3):(i=s,0===Ue&&qe(se)),i!==s?(r=Ne,Ue++,n=at(),Ue--,n===s?r=void 0:(Ne=r,r=s),r!==s?e=i="FOR":(Ne=e,e=s)):(Ne=e,e=s),e}function Ut(){var e,i,r,n;return e=Ne,"substring"===t.substr(Ne,9).toLowerCase()?(i=t.substr(Ne,9),Ne+=9):(i=s,0===Ue&&qe(ne)),i!==s?(r=Ne,Ue++,n=at(),Ue--,n===s?r=void 0:(Ne=r,r=s),r!==s?e=i="SUBSTRING":(Ne=e,e=s)):(Ne=e,e=s),e}function Gt(){var e,i,r,n;return e=Ne,"extract"===t.substr(Ne,7).toLowerCase()?(i=t.substr(Ne,7),Ne+=7):(i=s,0===Ue&&qe(ae)),i!==s?(r=Ne,Ue++,n=at(),Ue--,n===s?r=void 0:(Ne=r,r=s),r!==s?e=i="EXTRACT":(Ne=e,e=s)):(Ne=e,e=s),e}function zt(){var e,i,r,n;return e=Ne,"trim"===t.substr(Ne,4).toLowerCase()?(i=t.substr(Ne,4),Ne+=4):(i=s,0===Ue&&qe(oe)),i!==s?(r=Ne,Ue++,n=at(),Ue--,n===s?r=void 0:(Ne=r,r=s),r!==s?e=i="TRIM":(Ne=e,e=s)):(Ne=e,e=s),e}function Bt(){var e,i,r,n;return e=Ne,"position"===t.substr(Ne,8).toLowerCase()?(i=t.substr(Ne,8),Ne+=8):(i=s,0===Ue&&qe(le)),i!==s?(r=Ne,Ue++,n=at(),Ue--,n===s?r=void 0:(Ne=r,r=s),r!==s?e=i="POSITION":(Ne=e,e=s)):(Ne=e,e=s),e}function jt(){var e,i,r,n;return e=Ne,"timestamp"===t.substr(Ne,9).toLowerCase()?(i=t.substr(Ne,9),Ne+=9):(i=s,0===Ue&&qe(he)),i!==s?(r=Ne,Ue++,n=at(),Ue--,n===s?r=void 0:(Ne=r,r=s),r!==s?e=i="TIMESTAMP":(Ne=e,e=s)):(Ne=e,e=s),e}function qt(){var e,i,r,n;return e=Ne,"date"===t.substr(Ne,4).toLowerCase()?(i=t.substr(Ne,4),Ne+=4):(i=s,0===Ue&&qe(ue)),i!==s?(r=Ne,Ue++,n=at(),Ue--,n===s?r=void 0:(Ne=r,r=s),r!==s?e=i="DATE":(Ne=e,e=s)):(Ne=e,e=s),e}function Ht(){var e,i,r,n;return e=Ne,"leading"===t.substr(Ne,7).toLowerCase()?(i=t.substr(Ne,7),Ne+=7):(i=s,0===Ue&&qe(ce)),i!==s?(r=Ne,Ue++,n=at(),Ue--,n===s?r=void 0:(Ne=r,r=s),r!==s?e=i="LEADING":(Ne=e,e=s)):(Ne=e,e=s),e}function Wt(){var e,i,r,n;return e=Ne,"trailing"===t.substr(Ne,8).toLowerCase()?(i=t.substr(Ne,8),Ne+=8):(i=s,0===Ue&&qe(de)),i!==s?(r=Ne,Ue++,n=at(),Ue--,n===s?r=void 0:(Ne=r,r=s),r!==s?e=i="TRAILING":(Ne=e,e=s)):(Ne=e,e=s),e}function Qt(){var e,i,r,n;return e=Ne,"both"===t.substr(Ne,4).toLowerCase()?(i=t.substr(Ne,4),Ne+=4):(i=s,0===Ue&&qe(pe)),i!==s?(r=Ne,Ue++,n=at(),Ue--,n===s?r=void 0:(Ne=r,r=s),r!==s?e=i="BOTH":(Ne=e,e=s)):(Ne=e,e=s),e}function Zt(){var e,i,r,n;return e=Ne,"to"===t.substr(Ne,2).toLowerCase()?(i=t.substr(Ne,2),Ne+=2):(i=s,0===Ue&&qe(fe)),i!==s?(r=Ne,Ue++,n=at(),Ue--,n===s?r=void 0:(Ne=r,r=s),r!==s?e=i="TO":(Ne=e,e=s)):(Ne=e,e=s),e}function Yt(){var e,i,r,n;return e=Ne,"interval"===t.substr(Ne,8).toLowerCase()?(i=t.substr(Ne,8),Ne+=8):(i=s,0===Ue&&qe(ye)),i!==s?(r=Ne,Ue++,n=at(),Ue--,n===s?r=void 0:(Ne=r,r=s),r!==s?e=i="INTERVAL":(Ne=e,e=s)):(Ne=e,e=s),e}function Jt(){var e,i,r,n;return e=Ne,"year"===t.substr(Ne,4).toLowerCase()?(i=t.substr(Ne,4),Ne+=4):(i=s,0===Ue&&qe(me)),i!==s?(r=Ne,Ue++,n=at(),Ue--,n===s?r=void 0:(Ne=r,r=s),r!==s?e=i="YEAR":(Ne=e,e=s)):(Ne=e,e=s),e}function Xt(){var e,i,r,n;return e=Ne,"month"===t.substr(Ne,5).toLowerCase()?(i=t.substr(Ne,5),Ne+=5):(i=s,0===Ue&&qe(ge)),i!==s?(r=Ne,Ue++,n=at(),Ue--,n===s?r=void 0:(Ne=r,r=s),r!==s?e=i="MONTH":(Ne=e,e=s)):(Ne=e,e=s),e}function $t(){var e,i,r,n;return e=Ne,"day"===t.substr(Ne,3).toLowerCase()?(i=t.substr(Ne,3),Ne+=3):(i=s,0===Ue&&qe(_e)),i!==s?(r=Ne,Ue++,n=at(),Ue--,n===s?r=void 0:(Ne=r,r=s),r!==s?e=i="DAY":(Ne=e,e=s)):(Ne=e,e=s),e}function Kt(){var e,i,r,n;return e=Ne,"hour"===t.substr(Ne,4).toLowerCase()?(i=t.substr(Ne,4),Ne+=4):(i=s,0===Ue&&qe(xe)),i!==s?(r=Ne,Ue++,n=at(),Ue--,n===s?r=void 0:(Ne=r,r=s),r!==s?e=i="HOUR":(Ne=e,e=s)):(Ne=e,e=s),e}function ei(){var e,i,r,n;return e=Ne,"minute"===t.substr(Ne,6).toLowerCase()?(i=t.substr(Ne,6),Ne+=6):(i=s,0===Ue&&qe(ve)),i!==s?(r=Ne,Ue++,n=at(),Ue--,n===s?r=void 0:(Ne=r,r=s),r!==s?e=i="MINUTE":(Ne=e,e=s)):(Ne=e,e=s),e}function ti(){var e,i,r,n;return e=Ne,"second"===t.substr(Ne,6).toLowerCase()?(i=t.substr(Ne,6),Ne+=6):(i=s,0===Ue&&qe(be)),i!==s?(r=Ne,Ue++,n=at(),Ue--,n===s?r=void 0:(Ne=r,r=s),r!==s?e=i="SECOND":(Ne=e,e=s)):(Ne=e,e=s),e}function ii(){var e,i,r,n;return e=Ne,"case"===t.substr(Ne,4).toLowerCase()?(i=t.substr(Ne,4),Ne+=4):(i=s,0===Ue&&qe(we)),i!==s?(r=Ne,Ue++,n=at(),Ue--,n===s?r=void 0:(Ne=r,r=s),r!==s?e=i="CASE":(Ne=e,e=s)):(Ne=e,e=s),e}function ri(){var e,i,r,n;return e=Ne,"end"===t.substr(Ne,3).toLowerCase()?(i=t.substr(Ne,3),Ne+=3):(i=s,0===Ue&&qe(Se)),i!==s?(r=Ne,Ue++,n=at(),Ue--,n===s?r=void 0:(Ne=r,r=s),r!==s?e=i="END":(Ne=e,e=s)):(Ne=e,e=s),e}function si(){var e,i,r,n;return e=Ne,"when"===t.substr(Ne,4).toLowerCase()?(i=t.substr(Ne,4),Ne+=4):(i=s,0===Ue&&qe(Ie)),i!==s?(r=Ne,Ue++,n=at(),Ue--,n===s?r=void 0:(Ne=r,r=s),r!==s?e=i="WHEN":(Ne=e,e=s)):(Ne=e,e=s),e}function ni(){var e,i,r,n;return e=Ne,"then"===t.substr(Ne,4).toLowerCase()?(i=t.substr(Ne,4),Ne+=4):(i=s,0===Ue&&qe(Ce)),i!==s?(r=Ne,Ue++,n=at(),Ue--,n===s?r=void 0:(Ne=r,r=s),r!==s?e=i="THEN":(Ne=e,e=s)):(Ne=e,e=s),e}function ai(){var e,i,r,n;return e=Ne,"else"===t.substr(Ne,4).toLowerCase()?(i=t.substr(Ne,4),Ne+=4):(i=s,0===Ue&&qe(Me)),i!==s?(r=Ne,Ue++,n=at(),Ue--,n===s?r=void 0:(Ne=r,r=s),r!==s?e=i="ELSE":(Ne=e,e=s)):(Ne=e,e=s),e}function oi(){var e;return 44===t.charCodeAt(Ne)?(e=",",Ne++):(e=s,0===Ue&&qe(Te)),e}function li(){var e;return 40===t.charCodeAt(Ne)?(e="(",Ne++):(e=s,0===Ue&&qe(Ee)),e}function hi(){var e;return 41===t.charCodeAt(Ne)?(e=")",Ne++):(e=s,0===Ue&&qe(Fe)),e}function ui(){var e,t;for(e=[],t=ci();t!==s;)e.push(t),t=ci();return e}function ci(){var e;return Ae.test(t.charAt(Ne))?(e=t.charAt(Ne),Ne++):(e=s,0===Ue&&qe(Re)),e}function di(){var e,i,r,n;if(e=Ne,(i=st())!==s&&(i=i),(e=i)===s)if(e=Ne,96===t.charCodeAt(Ne)?(i="`",Ne++):(i=s,0===Ue&&qe(Pe)),i!==s){if(r=[],Le.test(t.charAt(Ne))?(n=t.charAt(Ne),Ne++):(n=s,0===Ue&&qe(De)),n!==s)for(;n!==s;)r.push(n),Le.test(t.charAt(Ne))?(n=t.charAt(Ne),Ne++):(n=s,0===Ue&&qe(De));else r=s;r!==s?(96===t.charCodeAt(Ne)?(n="`",Ne++):(n=s,0===Ue&&qe(Pe)),n!==s?e=i=function(e){return e.join("")}(r):(Ne=e,e=s)):(Ne=e,e=s)}else Ne=e,e=s;return e}function pi(e,t,i,r){var s={type:"binary_expr",operator:e,left:t,right:i};return void 0!==r&&(s.escape=r),s}function fi(e,t){for(var i=e,r=0;r<t.length;r++)i=pi(t[r][1],i,t[r][3]);return i}if((r=a())!==s&&Ne===t.length)return r;throw r!==s&&Ne<t.length&&qe({type:"end"}),function(t,i,r){return new e(e.buildMessage(t,i),t,i,r)}(Ve,ke<t.length?t.charAt(ke):null,ke<t.length?je(ke,ke+1):je(ke,ke))}}},(u=d).exports&&(u.exports=c());class p{static parse(e){return d.exports.parse(e)}}const f=/^(\d{4})-(\d{1,2})-(\d{1,2})$/,y=/^(\d{4})-(\d{1,2})-(\d{1,2}) (\d{1,2}):(\d{1,2}):(\d{1,2}(\.[0-9]+)?)$/,m=/^(\d{4})-(\d{1,2})-(\d{1,2}) (\d{1,2}):(\d{1,2}):(\d{1,2}(\.[0-9]+)?)(\+|\-)(\d{1,2}):(\d{1,2})$/,g=/^(\d{4})-(\d{1,2})-(\d{1,2}) (\d{1,2}):(\d{1,2})(\+|\-)(\d{1,2}):(\d{1,2})$/,_=/^(\d{4})-(\d{1,2})-(\d{1,2}) (\d{1,2}):(\d{1,2})$/;function x(e,t){return(e+="").length>=t?e:new Array(t-e.length+1).join("0")+e}function v(e,t,i="0",r="0",s="0",n="0",a="",o="0",l="0"){if("+"===a||"-"===a){const h=`${x(parseInt(e,10),4)}-${x(parseInt(t,10),2)}-${x(parseInt(i,10),2)}`;let u="";parseFloat(n)<10&&(u="0");const c=`${x(parseInt(r,10),2)}:${x(parseInt(s,10),2)}:${u+parseFloat(n).toString()}`,d=`${a}${x(parseInt(o,10),2)}:${x(parseInt(l,10),2)}`;return new Date(h+"T"+c+d)}return new Date(parseInt(e,10),parseInt(t,10)-1,parseInt(i,10),parseInt(r,10),parseInt(s,10),parseFloat(n))}class b{static makeBool(e){return C(e)}static featureValue(e,t,i,r){return O(e,t,i,r)}static equalsNull(e){return null===e}static applyLike(e,t,i){return R(e,t,i)}static ensureArray(e){return M(e)}static applyIn(e,t){return A(e,t)}static currentDate(){const e=new Date;return e.setHours(0,0,0,0),e}static makeSqlInterval(e,t,i){return o.createFromValueAndQualifer(e,t,i)}static convertInterval(e){return e instanceof o?e.valueInMilliseconds():e}static currentTimestamp(){return new Date}static compare(e,t,i){return L(e,t,i)}static calculate(e,t,i){return N(e,t,i)}static makeComparable(e){return P(e)}static evaluateFunction(e,t){return l(e,t)}static lookup(e,t){const i=t[e];return void 0===i?null:i}static between(e,t){return null==e||null==t[0]||null==t[1]?null:e>=t[0]&&e<=t[1]}static notbetween(e,t){return null==e||null==t[0]||null==t[1]?null:e<t[0]||e>t[1]}static ternaryNot(e){return T(e)}static ternaryAnd(e,t){return E(e,t)}static ternaryOr(e,t){return F(e,t)}}class w{constructor(e,t){this.fieldsIndex=t,this.datefields={},this.parameters={},this.parseTree=p.parse(e);const{isStandardized:i,isAggregate:r,referencedFieldNames:s}=this.extractExpressionInfo(t);this.referencedFieldNames=s,this.isStandardized=i,this.isAggregate=r}static create(e,t){return new w(e,t)}get fieldNames(){return this.referencedFieldNames}testSet(e,t=k){const i={};for(const r of this.fieldNames)i[r]=e.map((e=>t.getAttribute(e,r)));return!!this.evaluateNode(this.parseTree,{attributes:i},k)}calculateValue(e,t=k){const i=this.evaluateNode(this.parseTree,e,t);return i instanceof o?i.valueInMilliseconds()/864e5:i}calculateValueCompiled(e,t=k){return null!=this.parseTree._compiledVersion?this.parseTree._compiledVersion(e,this.parameters,t,this.datefields):(0,r.c)("csp-restrictions")?this.calculateValue(e,t):(this.compileMe(),this.parseTree._compiledVersion(e,this.parameters,t,this.datefields))}testFeature(e,t=k){return!!this.evaluateNode(this.parseTree,e,t)}testFeatureCompiled(e,t=k){return null!=this.parseTree._compiledVersion?!!this.parseTree._compiledVersion(e,this.parameters,t,this.datefields):(0,r.c)("csp-restrictions")?this.testFeature(e,t):(this.compileMe(),!!this.parseTree._compiledVersion(e,this.parameters,t,this.datefields))}getFunctions(){const e=[];return this.visitAll(this.parseTree,(t=>{"function"===t.type&&e.push(t.name.toLowerCase())})),D(e)}getExpressions(){const e=new Map;return this.visitAll(this.parseTree,(t=>{if("function"===t.type){const i=t.name.toLowerCase(),r=t.args.value[0];if("column_ref"===r.type){const t=r.column,s=`${i}-${t}`;e.has(s)||e.set(s,{aggregateType:i,field:t})}}})),[...e.values()]}getVariables(){const e=[];return this.visitAll(this.parseTree,(t=>{"param"===t.type&&e.push(t.value.toLowerCase())})),D(e)}compileMe(){const e="return this.convertInterval("+this.evaluateNodeToJavaScript(this.parseTree)+")";this.parseTree._compiledVersion=new Function("feature","lookups","attributeAdapter","datefields",e).bind(b)}extractExpressionInfo(e){const t=[];let i=!0,r=!0;return this.visitAll(this.parseTree,(n=>{switch(n.type){case"column_ref":{const i=e.get(n.column),r=i&&i.name;!i||"date"!==i.type&&"esriFieldTypeDate"!==i.type||(this.datefields[i.name]=1),void 0!==r?(t.push(r),n.column=r):t.push(n.column);break}case"function":{const{name:e,args:t}=n,a=t.value.length;i&&(i=function(e,t){const i=h[e.toLowerCase()];return null!=i&&t>=i.minParams&&t<=i.maxParams}(e,a)),r&&(r=function(e,t){const i=s[e.toLowerCase()];return null!=i&&t>=i.minParams&&t<=i.maxParams}(e,a));break}}})),{referencedFieldNames:D(t),isStandardized:i,isAggregate:r}}visitAll(e,t){if(null!=e)switch(t(e),e.type){case"when_clause":this.visitAll(e.operand,t),this.visitAll(e.value,t);break;case"case_expression":for(const i of e.clauses)this.visitAll(i,t);"simple"===e.format&&this.visitAll(e.operand,t),null!==e.else&&this.visitAll(e.else,t);break;case"expr_list":for(const i of e.value)this.visitAll(i,t);break;case"unary_expr":this.visitAll(e.expr,t);break;case"binary_expr":this.visitAll(e.left,t),this.visitAll(e.right,t);break;case"function":this.visitAll(e.args,t)}}evaluateNodeToJavaScript(e){switch(e.type){case"interval":return"this.makeSqlInterval("+this.evaluateNodeToJavaScript(e.value)+", "+JSON.stringify(e.qualifier)+","+JSON.stringify(e.op)+")";case"case_expression":{let t="";if("simple"===e.format){const i="this.makeComparable("+this.evaluateNodeToJavaScript(e.operand)+")";t="( ";for(let r=0;r<e.clauses.length;r++)t+=" ("+i+" === this.makeComparable("+this.evaluateNodeToJavaScript(e.clauses[r].operand)+")) ? ("+this.evaluateNodeToJavaScript(e.clauses[r].value)+") : ";null!==e.else?t+=this.evaluateNodeToJavaScript(e.else):t+="null",t+=" )"}else{t="( ";for(let i=0;i<e.clauses.length;i++)t+=" this.makeBool("+this.evaluateNodeToJavaScript(e.clauses[i].operand)+")===true ? ("+this.evaluateNodeToJavaScript(e.clauses[i].value)+") : ";null!==e.else?t+=this.evaluateNodeToJavaScript(e.else):t+="null",t+=" )"}return t}case"param":return"this.lookup("+JSON.stringify(e.value.toLowerCase())+",lookups)";case"expr_list":{let t="[";for(const i of e.value)"["!==t&&(t+=","),t+=this.evaluateNodeToJavaScript(i);return t+="]",t}case"unary_expr":return"this.ternaryNot("+this.evaluateNodeToJavaScript(e.expr)+")";case"binary_expr":switch(e.operator){case"AND":return"this.ternaryAnd("+this.evaluateNodeToJavaScript(e.left)+","+this.evaluateNodeToJavaScript(e.right)+" )";case"OR":return"this.ternaryOr("+this.evaluateNodeToJavaScript(e.left)+","+this.evaluateNodeToJavaScript(e.right)+" )";case"IS":if("null"!==e.right.type)throw new Error("Unsupported RHS for IS");return"this.equalsNull("+this.evaluateNodeToJavaScript(e.left)+")";case"ISNOT":if("null"!==e.right.type)throw new Error("Unsupported RHS for IS");return"(!(this.equalsNull("+this.evaluateNodeToJavaScript(e.left)+")))";case"IN":return"this.applyIn("+this.evaluateNodeToJavaScript(e.left)+",this.ensureArray("+this.evaluateNodeToJavaScript(e.right)+"))";case"NOT IN":return"this.ternaryNot(this.applyIn("+this.evaluateNodeToJavaScript(e.left)+",this.ensureArray("+this.evaluateNodeToJavaScript(e.right)+")))";case"BETWEEN":return"this.between("+this.evaluateNodeToJavaScript(e.left)+","+this.evaluateNodeToJavaScript(e.right)+")";case"NOTBETWEEN":return"this.notbetween("+this.evaluateNodeToJavaScript(e.left)+","+this.evaluateNodeToJavaScript(e.right)+")";case"LIKE":return"this.applyLike("+this.evaluateNodeToJavaScript(e.left)+","+this.evaluateNodeToJavaScript(e.right)+","+JSON.stringify(e.escape)+")";case"NOT LIKE":return"this.ternaryNot(this.applyLike("+this.evaluateNodeToJavaScript(e.left)+","+this.evaluateNodeToJavaScript(e.right)+","+JSON.stringify(e.escape)+"))";case"<>":case"<":case">":case">=":case"<=":case"=":return"this.compare("+JSON.stringify(e.operator)+","+this.evaluateNodeToJavaScript(e.left)+","+this.evaluateNodeToJavaScript(e.right)+")";case"*":case"-":case"+":case"/":return"this.calculate("+JSON.stringify(e.operator)+","+this.evaluateNodeToJavaScript(e.left)+","+this.evaluateNodeToJavaScript(e.right)+")"}throw new Error("Not Supported Operator "+e.operator);case"null":case"bool":case"string":case"number":return JSON.stringify(e.value);case"date":return"(new Date("+I(e.value).getTime().toString()+"))";case"timestamp":return"(new Date("+S(e.value).getTime().toString()+"))";case"current_time":return"date"===e.mode?"this.currentDate()":"this.currentTimestamp()";case"column_ref":return"this.featureValue(feature,"+JSON.stringify(e.column)+",datefields,attributeAdapter)";case"function":return"this.evaluateFunction("+JSON.stringify(e.name)+","+this.evaluateNodeToJavaScript(e.args)+")"}throw new Error("Unsupported sql syntax "+e.type)}evaluateNode(e,t,i){switch(e.type){case"interval":{const r=this.evaluateNode(e.value,t,i);return o.createFromValueAndQualifer(r,e.qualifier,e.op)}case"case_expression":if("simple"===e.format){const r=P(this.evaluateNode(e.operand,t,i));for(let s=0;s<e.clauses.length;s++)if(r===P(this.evaluateNode(e.clauses[s].operand,t,i)))return this.evaluateNode(e.clauses[s].value,t,i);if(null!==e.else)return this.evaluateNode(e.else,t,i)}else{for(let r=0;r<e.clauses.length;r++)if(C(this.evaluateNode(e.clauses[r].operand,t,i)))return this.evaluateNode(e.clauses[r].value,t,i);if(null!==e.else)return this.evaluateNode(e.else,t,i)}return null;case"param":return this.parameters[e.value.toLowerCase()];case"expr_list":{const r=[];for(const s of e.value)r.push(this.evaluateNode(s,t,i));return r}case"unary_expr":return T(this.evaluateNode(e.expr,t,i));case"binary_expr":switch(e.operator){case"AND":return E(this.evaluateNode(e.left,t,i),this.evaluateNode(e.right,t,i));case"OR":return F(this.evaluateNode(e.left,t,i),this.evaluateNode(e.right,t,i));case"IS":if("null"!==e.right.type)throw new Error("Unsupported RHS for IS");return null===this.evaluateNode(e.left,t,i);case"ISNOT":if("null"!==e.right.type)throw new Error("Unsupported RHS for IS");return null!==this.evaluateNode(e.left,t,i);case"IN":{const r=M(this.evaluateNode(e.right,t,i));return A(this.evaluateNode(e.left,t,i),r)}case"NOT IN":{const r=M(this.evaluateNode(e.right,t,i));return T(A(this.evaluateNode(e.left,t,i),r))}case"BETWEEN":{const r=this.evaluateNode(e.left,t,i),s=this.evaluateNode(e.right,t,i);return null==r||null==s[0]||null==s[1]?null:r>=P(s[0])&&r<=P(s[1])}case"NOTBETWEEN":{const r=this.evaluateNode(e.left,t,i),s=this.evaluateNode(e.right,t,i);return null==r||null==s[0]||null==s[1]?null:r<P(s[0])||r>P(s[1])}case"LIKE":return R(this.evaluateNode(e.left,t,i),this.evaluateNode(e.right,t,i),e.escape);case"NOT LIKE":return T(R(this.evaluateNode(e.left,t,i),this.evaluateNode(e.right,t,i),e.escape));case"<>":case"<":case">":case">=":case"<=":case"=":return L(e.operator,this.evaluateNode(e.left,t,i),this.evaluateNode(e.right,t,i));case"-":case"+":case"*":case"/":return N(e.operator,this.evaluateNode(e.left,t,i),this.evaluateNode(e.right,t,i))}case"null":case"bool":case"string":case"number":return e.value;case"date":return I(e.value);case"timestamp":return S(e.value);case"current_time":{const t=new Date;return"date"===e.mode&&t.setHours(0,0,0,0),t}case"column_ref":return O(t,e.column,this.datefields,i);case"function":{const r=this.evaluateNode(e.args,t,i);return this.isAggregate?function(e,t){const i=s[e.toLowerCase()];if(null==i)throw new Error("Function Not Recognised");if(t.length<i.minParams||t.length>i.maxParams)throw new Error(`Invalid Parameter count for call to ${e.toUpperCase()}`);return i.evaluate(t)}(e.name,r):l(e.name,r)}}throw new Error("Unsupported sql syntax "+e.type)}}function S(e){let t=y.exec(e);if(null!==t){const[,e,i,r,s,n,a]=t;return v(e,i,r,s,n,a)}if(t=m.exec(e),null!==t){const[,e,i,r,s,n,a,o,l,h]=t;return v(e,i,r,s,n,a,o,l,h)}if(t=g.exec(e),null!==t){const[,e,i,r,s,n,a,o,l]=t;return v(e,i,r,s,n,"0",a,o,l)}if(t=_.exec(e),null!==t){const[,e,i,r,s,n]=t;return v(e,i,r,s,n)}if(t=f.exec(e),null!==t){const[,e,i,r]=t;return v(e,i,r)}throw new Error("SQL Invalid Timestamp")}function I(e){const t=f.exec(e);if(null===t)throw new Error("SQL Invalid Date");const[,i,r,s]=t;return new Date(parseInt(i,10),parseInt(r,10)-1,parseInt(s,10))}function C(e){return!0===e}function M(e){return Array.isArray(e)?e:[e]}function T(e){return null!==e?!0!==e:null}function E(e,t){return null!=e&&null!=t?!0===e&&!0===t:!1!==e&&!1!==t&&null}function F(e,t){return null!=e&&null!=t?!0===e||!0===t:!0===e||!0===t||null}function A(e,t){if(null==e)return null;let i=!1;for(const r of t)if(null==r)i=null;else if(e===r){i=!0;break}return i}function R(e,t,i){if(null==e)return null;const r=t,s=i;let n="";const a="-[]/{}()*+?.\\^$|";let o=0;for(let e=0;e<r.length;e++){const t=r.charAt(e);switch(o){case 0:t===s?o=1:a.indexOf(t)>=0?n+="\\"+t:n+="%"===t?".*":"_"===t?".":t;break;case 1:a.indexOf(t)>=0?n+="\\"+t:n+=t,o=0}}return new RegExp("^"+n+"$").test(e)}function P(e){return e instanceof Date?e.valueOf():e}function L(e,t,i){if(null==t||null==i)return null;const r=P(t),s=P(i);switch(e){case"<>":return r!==s;case"=":return r===s;case">":return r>s;case"<":return r<s;case">=":return r>=s;case"<=":return r<=s}}function D(e){const t=[],i={};for(const r of e){const e=r.toLowerCase();void 0===i[e]&&(t.push(r),i[e]=1)}return t}function N(e,t,i){if(t instanceof o)if(i instanceof Date)switch(e){case"+":return new Date(t.valueInMilliseconds()+i.getTime());case"-":return t.valueInMilliseconds()-i.getTime();case"*":return t.valueInMilliseconds()*i.getTime();case"/":return t.valueInMilliseconds()/i.getTime()}else if(i instanceof o)switch(e){case"+":return o.createFromMilliseconds(t.valueInMilliseconds()+i.valueInMilliseconds());case"-":return o.createFromMilliseconds(t.valueInMilliseconds()-i.valueInMilliseconds());case"*":return t.valueInMilliseconds()*i.valueInMilliseconds();case"/":return t.valueInMilliseconds()/i.valueInMilliseconds()}else t=t.valueInMilliseconds();else if(i instanceof o)if(t instanceof Date)switch(e){case"+":return new Date(i.valueInMilliseconds()+t.getTime());case"-":return new Date(t.getTime()-i.valueInMilliseconds());case"*":return t.getTime()*i.valueInMilliseconds();case"/":return t.getTime()/i.valueInMilliseconds()}else i=i.valueInMilliseconds();else if(t instanceof Date&&"number"==typeof i)switch(i=24*i*60*60*1e3,t=t.getTime(),e){case"+":return new Date(t+i);case"-":return new Date(t-i);case"*":return new Date(t*i);case"/":return new Date(t/i)}else if(i instanceof Date&&"number"==typeof t)switch(t=24*t*60*60*1e3,i=i.getTime(),e){case"+":return new Date(t+i);case"-":return new Date(t-i);case"*":return new Date(t*i);case"/":return new Date(t/i)}switch(e){case"+":return t+i;case"-":return t-i;case"*":return t*i;case"/":return t/i}}function O(e,t,i,r){const s=r.getAttribute(e,t);return null!=s&&1===i[t]?new Date(s):s}const k={getAttribute:(e,t)=>(function(e){return e&&"object"==typeof e.attributes}(e)?e.attributes:e)[t]}},96273:(e,t,i)=>{"use strict";i.d(t,{e:()=>r,n:()=>n,o:()=>s});var r="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:void 0!==i.g?i.g:"undefined"!=typeof self?self:{};function s(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}function n(e){throw new Error('Could not dynamically require "'+e+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}},66618:(e,t,i)=>{"use strict";i.d(t,{p:()=>r});var r={}},81008:(e,t,i)=>{"use strict";function r(){r=function(e,t){return new i(e,void 0,t)};var e=RegExp.prototype,t=new WeakMap;function i(e,r,s){var a=new RegExp(e,r);return t.set(a,s||t.get(e)),n(a,i.prototype)}function a(e,i){var r=t.get(i);return Object.keys(r).reduce((function(t,i){return t[i]=e[r[i]],t}),Object.create(null))}return s(i,RegExp),i.prototype.exec=function(t){var i=e.exec.call(this,t);return i&&(i.groups=a(i,this)),i},i.prototype[Symbol.replace]=function(i,r){if("string"==typeof r){var s=t.get(this);return e[Symbol.replace].call(this,i,r.replace(/\$<([^>]+)>/g,(function(e,t){return"$"+s[t]})))}if("function"==typeof r){var n=this;return e[Symbol.replace].call(this,i,(function(){var e=arguments;return"object"!=typeof e[e.length-1]&&(e=[].slice.call(e)).push(a(e,n)),r.apply(this,e)}))}return e[Symbol.replace].call(this,i,r)},r.apply(this,arguments)}function s(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&n(e,t)}function n(e,t){return(n=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}i.d(t,{t:()=>r})},6129:(e,t,i)=>{"use strict";function r(e,t,i){if(!i||null==t)return null;if(!e)return function(e,t){const i=t.toLowerCase();for(const t in e)if(t.toLowerCase()===i)return e[t];return null}(t,i);const r=e.get(i);return r?t[r.name]:null}i.d(t,{n:()=>r})},51962:(e,t,i)=>{"use strict";i.d(t,{s:()=>r});const r={attachment:{supportsContentType:!1,supportsExifInfo:!1,supportsKeywords:!1,supportsName:!1,supportsSize:!1},data:{isVersioned:!1,supportsAttachment:!1,supportsM:!1,supportsZ:!1},editing:{supportsDeleteByAnonymous:!1,supportsDeleteByOthers:!1,supportsGeometryUpdate:!1,supportsGlobalId:!1,supportsReturnServiceEditsInSourceSpatialReference:!1,supportsRollbackOnFailure:!1,supportsUpdateByAnonymous:!1,supportsUpdateByOthers:!1,supportsUpdateWithoutM:!1,supportsUploadWithItemId:!1},metadata:{supportsAdvancedFieldProperties:!1},operations:{supportsCalculate:!1,supportsTruncate:!1,supportsValidateSql:!1,supportsAdd:!1,supportsDelete:!1,supportsEditing:!1,supportsChangeTracking:!1,supportsQuery:!1,supportsQueryAttachments:!1,supportsResizeAttachments:!1,supportsSync:!1,supportsUpdate:!1,supportsExceedsLimitStatistics:!1},queryRelated:{supportsCount:!1,supportsOrderBy:!1,supportsPagination:!1},query:{maxRecordCount:0,maxRecordCountFactor:0,standardMaxRecordCount:0,supportsCacheHint:!1,supportsCentroid:!1,supportsDisjointSpatialRelationship:!1,supportsDistance:!1,supportsDistinct:!1,supportsExtent:!1,supportsFormatPBF:!1,supportsGeometryProperties:!1,supportsHavingClause:!1,supportsHistoricMoment:!1,supportsMaxRecordCountFactor:!1,supportsOrderBy:!1,supportsPagination:!1,supportsPercentileStatistics:!1,supportsQuantization:!1,supportsQuantizationEditMode:!1,supportsQueryByOthers:!1,supportsQueryGeometry:!1,supportsResultType:!1,supportsSqlExpression:!1,supportsStandardizedQueriesOnly:!1,supportsTopFeaturesQuery:!1,supportsStatistics:!1,tileMaxRecordCount:0}}},83618:(e,t,i)=>{"use strict";function r(e,t){return e?t?4:3:t?3:2}function s(e,t,i,s,o){if(!t||!t.lengths.length)return null;const l="upperLeft"===(null==o?void 0:o.originPosition)?-1:1;e.lengths.length&&(e.lengths.length=0),e.coords.length&&(e.coords.length=0);const h=e.coords,u=[],c=i?[Number.POSITIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.POSITIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.POSITIVE_INFINITY,Number.NEGATIVE_INFINITY]:[Number.POSITIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.POSITIVE_INFINITY,Number.NEGATIVE_INFINITY],{lengths:d,coords:p}=t,f=r(i,s);let y=0;for(const e of d){const t=n(c,p,y,e,i,s,l);t&&u.push(t),y+=e*f}if(u.sort(((e,t)=>{let r=l*e[2]-l*t[2];return 0===r&&i&&(r=e[4]-t[4]),r})),u.length){let e=6*u[0][2];h[0]=u[0][0]/e,h[1]=u[0][1]/e,i&&(e=6*u[0][4],h[2]=0!==e?u[0][3]/e:0),(h[0]<c[0]||h[0]>c[1]||h[1]<c[2]||h[1]>c[3]||i&&(h[2]<c[4]||h[2]>c[5]))&&(h.length=0)}if(!h.length){const e=t.lengths[0]?a(p,0,d[0],i,s):null;if(!e)return null;h[0]=e[0],h[1]=e[1],i&&e.length>2&&(h[2]=e[2])}return e}function n(e,t,i,s,n,a,o=1){const l=r(n,a);let h=i,u=i+l,c=0,d=0,p=0,f=0,y=0;for(let i=0,r=s-1;i<r;i++,h+=l,u+=l){const i=t[h],r=t[h+1],s=t[h+2],a=t[u],o=t[u+1],l=t[u+2];let m=i*o-a*r;f+=m,c+=(i+a)*m,d+=(r+o)*m,n&&(m=i*l-a*s,p+=(s+l)*m,y+=m),i<e[0]&&(e[0]=i),i>e[1]&&(e[1]=i),r<e[2]&&(e[2]=r),r>e[3]&&(e[3]=r),n&&(s<e[4]&&(e[4]=s),s>e[5]&&(e[5]=s))}if(f*o>0&&(f*=-1),y*o>0&&(y*=-1),!f)return null;const m=[c,d,.5*f];return n&&(m[3]=p,m[4]=.5*y),m}function a(e,t,i,s,n){const a=r(s,n);let c=t,d=t+a,p=0,f=0,y=0,m=0;for(let t=0,r=i-1;t<r;t++,c+=a,d+=a){const t=e[c],i=e[c+1],r=e[c+2],n=e[d],a=e[d+1],g=e[d+2],_=s?l(t,i,r,n,a,g):o(t,i,n,a);if(_)if(p+=_,s){const e=u(t,i,r,n,a,g);f+=_*e[0],y+=_*e[1],m+=_*e[2]}else{const e=h(t,i,n,a);f+=_*e[0],y+=_*e[1]}}return p>0?s?[f/p,y/p,m/p]:[f/p,y/p]:i>0?s?[e[t],e[t+1],e[t+2]]:[e[t],e[t+1]]:null}function o(e,t,i,r){const s=i-e,n=r-t;return Math.sqrt(s*s+n*n)}function l(e,t,i,r,s,n){const a=r-e,o=s-t,l=n-i;return Math.sqrt(a*a+o*o+l*l)}function h(e,t,i,r){return[e+.5*(i-e),t+.5*(r-t)]}function u(e,t,i,r,s,n){return[e+.5*(r-e),t+.5*(s-t),i+.5*(n-i)]}i.d(t,{t:()=>s})},98128:(e,t,i)=>{"use strict";i.d(t,{T:()=>Z,a:()=>b,b:()=>c,e:()=>u,i:()=>f,k:()=>A,n:()=>d,r:()=>g,s:()=>m}),i(33807);var r=i(17762),s=i(80219),n=i(94527),a=i(52957),o=i(50388),l=i(89710),h=i(97431);function u(e,t,i,r){return"function"==typeof e?e(t,i,r):e}function c(e){return[e.r,e.g,e.b,e.a]}function d(e,t,i){const r=e=>{let t=e.length;for(;t--;)if(-1===" /-,\n".indexOf(e.charAt(t)))return!1;return!0},s=[];let n=0,a=-1;do{if(a=t.indexOf("[",n),a>=n){if(a>n){const e=t.substr(n,a-n);s.push([e,null,r(e)])}if(n=a+1,a=t.indexOf("]",n),a>=n){if(a>n){const i=e[t.substr(n,a-n)];i&&s.push([null,i,!1])}n=a+1}}}while(-1!==a);if(n<t.length-1){const e=t.substr(n);s.push([e,null,r(e)])}return e=>{let t="",r=null;for(const i of s){const[s,n,a]=i;if(s)a?r=s:(r&&(t+=r,r=null),t+=s);else{const i=e.attributes[n];i&&(r&&(t+=r,r=null),t+=i)}}return p(t,i)}}function p(e,t){switch("string"!=typeof e&&(e=String(e)),t){case"LowerCase":return e.toLowerCase();case"Allcaps":return e.toUpperCase();default:return e}}function f(e,t,i,r,s,n,a=!0){const o=t/s,l=i/n,h=Math.ceil(o/2),u=Math.ceil(l/2);for(let i=0;i<n;i++)for(let c=0;c<s;c++){const d=4*(c+(a?n-i-1:i)*s);let p=0,f=0,y=0,m=0,g=0,_=0,x=0;const v=(i+.5)*l;for(let r=Math.floor(i*l);r<(i+1)*l;r++){const i=Math.abs(v-(r+.5))/u,s=(c+.5)*o,n=i*i;for(let i=Math.floor(c*o);i<(c+1)*o;i++){let a=Math.abs(s-(i+.5))/h;const o=Math.sqrt(n+a*a);o>=-1&&o<=1&&(p=2*o*o*o-3*o*o+1,p>0&&(a=4*(i+r*t),x+=p*e[a+3],y+=p,e[a+3]<255&&(p=p*e[a+3]/250),m+=p*e[a],g+=p*e[a+1],_+=p*e[a+2],f+=p))}}r[d]=m/f,r[d+1]=g/f,r[d+2]=_/f,r[d+3]=x/y}}function y(e){return e?{r:e[0],g:e[1],b:e[2],a:e[3]/255}:{r:0,g:0,b:0,a:0}}function m(e){return"CIMMarkerPlacementAlongLineRandomSize"===e.type||"CIMMarkerPlacementAlongLineSameSize"===e.type||"CIMMarkerPlacementAlongLineVariableSize"===e.type||"CIMMarkerPlacementAtExtremities"===e.type||"CIMMarkerPlacementAtMeasuredUnits"===e.type||"CIMMarkerPlacementAtRatioPositions"===e.type||"CIMMarkerPlacementOnLine"===e.type||"CIMMarkerPlacementOnVertices"===e.type}function g(e){if(!e)return null;switch(e.type){case"CIMPointSymbol":{const t=e.symbolLayers;return t&&1===t.length?g(t[0]):null}case"CIMVectorMarker":{const t=e.markerGraphics;if(!t||1!==t.length)return null;const i=t[0];if(!i)return null;const r=i.geometry;if(!r)return null;const s=i.symbol;return!s||"CIMPolygonSymbol"!==s.type&&"CIMLineSymbol"!==s.type?null:{geom:r,asFill:"CIMPolygonSymbol"===s.type}}case"sdf":return{geom:e.geom,asFill:e.asFill}}return null}function _(e){let t=1/0,i=-1/0,r=1/0,s=-1/0;for(const n of e)for(const e of n)e[0]<t&&(t=e[0]),e[0]>i&&(i=e[0]),e[1]<r&&(r=e[1]),e[1]>s&&(s=e[1]);return[t,r,i,s]}function x(e){return e?e.rings?_(e.rings):e.paths?_(e.paths):(0,l.u)(e)?[e.xmin,e.ymin,e.xmax,e.ymax]:null:null}function v(e,t,i,r,s){const[n,a,o,l]=e;if(o<n||l<a)return[0,0,0];const h=o-n,u=l-a,c=Math.floor(31.5),d=(128-2*(c+1))/Math.max(h,u),p=Math.round(h*d)+2*c,f=Math.round(u*d)+2*c;let y=1;t&&(y=f/d/(t.ymax-t.ymin));let m=0,g=0;if(r)if(s){if(t&&i&&t.ymax-t.ymin>0){const e=(t.xmax-t.xmin)/(t.ymax-t.ymin);m=r.x/(i*e),g=r.y/i}}else m=r.x,g=r.y;return m=.5*(t.xmax+t.xmin)+m*(t.xmax-t.xmin),g=.5*(t.ymax+t.ymin)+g*(t.ymax-t.ymin),m-=n,g-=a,m*=d,g*=d,m+=c,g+=c,[y,m/p-.5,-(g/f-.5)]}function b(e){const t=function(e){return e?e.rings?e.rings:e.paths?e.paths:void 0!==e.xmin&&void 0!==e.ymin&&void 0!==e.xmax&&void 0!==e.ymax?[[[e.xmin,e.ymin],[e.xmin,e.ymax],[e.xmax,e.ymax],[e.xmax,e.ymin],[e.xmin,e.ymin]]]:null:null}(e.geom),i=function(e){let t=1/0,i=-1/0,r=1/0,s=-1/0;for(const n of e)for(const e of n)e[0]<t&&(t=e[0]),e[0]>i&&(i=e[0]),e[1]<r&&(r=e[1]),e[1]>s&&(s=e[1]);return new o.t(t,r,i-t,s-r)}(t),r=Math.floor(31.5),s=(128-2*(r+1))/Math.max(i.width,i.height),n=Math.round(i.width*s)+2*r,a=Math.round(i.height*s)+2*r,l=[];for(const n of t)if(n&&n.length>1){const t=[];for(const e of n){let[n,a]=e;n-=i.x,a-=i.y,n*=s,a*=s,n+=r-.5,a+=r-.5,t.push([n,a])}if(e.asFill){const e=t.length-1;t[0][0]===t[e][0]&&t[0][1]===t[e][1]||t.push(t[0])}l.push(t)}const h=function(e,t,i,r){const s=t*i,n=new Array(s),a=r*r+1;for(let e=0;e<s;++e)n[e]=a;for(const s of e){const e=s.length;for(let a=1;a<e;++a){const e=s[a-1],o=s[a];let l,h,u,c;e[0]<o[0]?(l=e[0],h=o[0]):(l=o[0],h=e[0]),e[1]<o[1]?(u=e[1],c=o[1]):(u=o[1],c=e[1]);let d=Math.floor(l)-r,p=Math.floor(h)+r,f=Math.floor(u)-r,y=Math.floor(c)+r;d<0&&(d=0),p>t&&(p=t),f<0&&(f=0),y>i&&(y=i);const m=o[0]-e[0],g=o[1]-e[1],_=m*m+g*g;for(let r=d;r<p;r++)for(let s=f;s<y;s++){let a,l,h=(r-e[0])*m+(s-e[1])*g;h<0?(a=e[0],l=e[1]):h>_?(a=o[0],l=o[1]):(h/=_,a=e[0]+h*m,l=e[1]+h*g);const u=(r-a)*(r-a)+(s-l)*(s-l),c=(i-s-1)*t+r;u<n[c]&&(n[c]=u)}}}for(let e=0;e<s;++e)n[e]=Math.sqrt(n[e]);return n}(l,n,a,r);return e.asFill&&function(e,t,i,r,s){for(const n of e){const e=n.length;for(let a=1;a<e;++a){const e=n[a-1],o=n[a];let l,h,u,c;e[0]<o[0]?(l=e[0],h=o[0]):(l=o[0],h=e[0]),e[1]<o[1]?(u=e[1],c=o[1]):(u=o[1],c=e[1]);let d=Math.floor(l),p=Math.floor(h)+1,f=Math.floor(u),y=Math.floor(c)+1;d<r&&(d=r),p>t-r&&(p=t-r),f<r&&(f=r),y>i-r&&(y=i-r);for(let n=f;n<y;++n){if(e[1]>n==o[1]>n)continue;const a=(i-n-1)*t;for(let t=d;t<p;++t)t<(o[0]-e[0])*(n-e[1])/(o[1]-e[1])+e[0]&&(s[a+t]=-s[a+t]);for(let e=r;e<d;++e)s[a+e]=-s[a+e]}}}}(l,n,a,r,h),[w(h,r),n,a]}function w(e,t){const i=2*t,r=e.length,s=new Uint8Array(4*r);for(let t=0;t<r;++t){const r=.5-e[t]/i;(0,o.a)(r,s,4*t)}return s}const S=s.n.getLogger("esri.symbols.cim.cimAnalyzer");function I(e){switch(e){case"Butt":return 0;case"Square":return 2;case"Round":default:return 1}}function C(e){switch(e){case"Bevel":return 0;case"Miter":return 2;case"Round":default:return 1}}function M(e){switch(e){case"Left":default:return"left";case"Right":return"right";case"Center":return"center";case"Justify":return"justify"}}function T(e){switch(e){case"Top":default:return"top";case"Center":return"middle";case"Baseline":return"baseline";case"Bottom":return"bottom"}}function E(e,t,i,r){let s;e[t]?s=e[t]:(s={},e[t]=s),s[i]=r}function F(e){const t=e.markerPlacement;return t&&t.angleToLine?1:0}async function A(e,t,i,r){const s=null!=i?i:[];if(!e)return s;let n,l;const h={};if("CIMSymbolReference"!==e.type)return S.error("Expect cim type to be 'CIMSymbolReference'"),s;if(n=e.symbol,l=e.primitiveOverrides,l){const e=[];for(const i of l){const r=i.valueExpressionInfo;if(r&&t){const s=r.expression,n=(0,a.j)(s,t.spatialReference,t.fields).then((e=>{e&&E(h,i.primitiveName,i.propertyName,e)}));e.push(n)}else null!=i.value&&E(h,i.primitiveName,i.propertyName,i.value)}await Promise.all(e)}switch(n.type){case"CIMPointSymbol":case"CIMLineSymbol":case"CIMPolygonSymbol":!function(e,t,i,r,s,n){if(!e)return;const a=e.symbolLayers;if(!a)return;let l;const h=o.h.getSize(e);"CIMPointSymbol"===e.type&&"Map"===e.angleAlignment&&(l=1);let u=a.length;for(;u--;){const c=a[u];if(!c||!1===c.enable)continue;const d=[];switch(o.S.findApplicableOverrides(c,t,d),c.type){case"CIMSolidFill":R(c,i,d,r,s);break;case"CIMPictureFill":P(c,i,d,r,s);break;case"CIMHatchFill":L(c,i,d,r,s);break;case"CIMGradientFill":D(c,i,d,r,s);break;case"CIMSolidStroke":N(c,i,d,r,s,"CIMPolygonSymbol"===e.type,h);break;case"CIMPictureStroke":O(c,i,d,r,s,"CIMPolygonSymbol"===e.type,h);break;case"CIMGradientStroke":k(c,i,d,r,s,"CIMPolygonSymbol"===e.type,h);break;case"CIMCharacterMarker":if(V(c,i,d,r,s))break;break;case"CIMPictureMarker":if(V(c,i,d,r,s))break;"CIMLineSymbol"===e.type&&(l=F(c)),U(c,i,d,r,s,l,h);break;case"CIMVectorMarker":if(V(c,i,d,r,s))break;"CIMLineSymbol"===e.type&&(l=F(c)),G(c,i,d,r,s,l,h,n);break;default:S.error("Cannot analyze CIM layer",c.type)}}}(n,l,h,t,s,r)}return s}function R(e,t,i,r,n){const a=e.primitiveName,o=y(e.color),[l,h]=Y(i,a),u=(0,s.w)(JSON.stringify(e)+h).toString();n.push({type:"fill",templateHash:u,materialHash:l?()=>u:u,cim:e,materialOverrides:null,colorLocked:e.colorLocked,color:W(a,t,"Color",r,o,H),height:0,angle:0,offsetX:0,offsetY:0,scaleX:1,effects:e.effects})}function P(e,t,i,r,n){const a=e.primitiveName,o=e.tintColor?y(e.tintColor):{r:255,g:255,b:255,a:1},[l,h]=Y(i,a),u=(0,s.w)(JSON.stringify(e)+h).toString(),c=(0,s.w)(`${e.url}${JSON.stringify(e.colorSubstitutions)}`).toString();n.push({type:"fill",templateHash:u,materialHash:l?()=>c:c,cim:e,materialOverrides:null,colorLocked:e.colorLocked,effects:e.effects,color:W(a,t,"TintColor",r,o,H),height:W(a,t,"Height",r,e.height),scaleX:W(a,t,"ScaleX",r,e.scaleX),angle:W(a,t,"Rotation",r,e.rotation),offsetX:W(a,t,"OffsetX",r,e.offsetX),offsetY:W(a,t,"OffsetY",r,e.offsetY)})}function L(e,t,i,r,n){const a=["Rotation","OffsetX","OffsetY"],o=i.filter((t=>t.primitiveName!==e.primitiveName&&-1===a.indexOf(t.propertyName))),l=e.primitiveName,[h,u]=Y(i,l),c=(0,s.w)(JSON.stringify(e)+u).toString(),d=(0,s.w)(`${e.separation}${JSON.stringify(e.lineSymbol)}`).toString();n.push({type:"fill",templateHash:c,materialHash:h?Q(d,t,o,r):d,cim:e,materialOverrides:o,colorLocked:e.colorLocked,effects:e.effects,color:{r:255,g:255,b:255,a:1},height:W(l,t,"Separation",r,e.separation),scaleX:1,angle:W(l,t,"Rotation",r,e.rotation),offsetX:W(l,t,"OffsetX",r,e.offsetX),offsetY:W(l,t,"OffsetY",r,e.offsetY)})}function D(e,t,i,r,n){const a=e.primitiveName,[o,l]=Y(i,a),h=(0,s.w)(JSON.stringify(e)+l).toString();n.push({type:"fill",templateHash:h,materialHash:o?Q(h,t,i,r):h,cim:e,materialOverrides:null,colorLocked:e.colorLocked,effects:e.effects,color:{r:128,g:128,b:128,a:1},height:0,angle:0,offsetX:0,offsetY:0,scaleX:1})}function N(e,t,i,r,n,a,o){const l=e.primitiveName,h=y(e.color),u=void 0!==e.width?e.width:4,c=I(e.capStyle),d=C(e.joinStyle),p=e.miterLimit,[f,m]=Y(i,l),g=(0,s.w)(JSON.stringify(e)+m).toString();n.push({type:"line",templateHash:g,materialHash:f?()=>g:g,cim:e,materialOverrides:null,isOutline:a,colorLocked:e.colorLocked,effects:e.effects,color:W(l,t,"Color",r,h,H),width:W(l,t,"Width",r,u),cap:W(l,t,"CapStyle",r,c),join:W(l,t,"JoinStyle",r,d),miterLimit:W(l,t,"MiterLimit",r,p),referenceWidth:o,zOrder:q(e.name),isDashed:!1})}function O(e,t,i,r,n,a,o){const l=(0,s.w)(`${e.url}${JSON.stringify(e.colorSubstitutions)}`).toString(),h=e.primitiveName,u=y(e.tintColor),c=void 0!==e.width?e.width:4,d=I(e.capStyle),p=C(e.joinStyle),f=e.miterLimit,[m,g]=Y(i,h),_=(0,s.w)(JSON.stringify(e)+g).toString();n.push({type:"line",templateHash:_,materialHash:m?()=>l:l,cim:e,materialOverrides:null,isOutline:a,colorLocked:e.colorLocked,effects:e.effects,color:W(h,t,"TintColor",r,u,H),width:W(h,t,"Width",r,c),cap:W(h,t,"CapStyle",r,d),join:W(h,t,"JoinStyle",r,p),miterLimit:W(h,t,"MiterLimit",r,f),referenceWidth:o,zOrder:q(e.name),isDashed:!1})}function k(e,t,i,r,n,a,o){const l=e.primitiveName,h=void 0!==e.width?e.width:4,u=I(e.capStyle),c=C(e.joinStyle),d=e.miterLimit,[p,f]=Y(i,l),y=(0,s.w)(JSON.stringify(e)+f).toString();n.push({type:"line",templateHash:y,materialHash:p?Q(y,t,i,r):y,cim:e,materialOverrides:null,isOutline:a,colorLocked:e.colorLocked,effects:e.effects,color:{r:128,g:128,b:128,a:1},width:W(l,t,"Width",r,h),cap:W(l,t,"CapStyle",r,u),join:W(l,t,"JoinStyle",r,c),miterLimit:W(l,t,"MiterLimit",r,d),referenceWidth:o,zOrder:q(e.name),isDashed:!1})}function V(e,t,i,r,n){const a=e.markerPlacement;if(!a||"CIMMarkerPlacementInsidePolygon"!==a.type)return!1;const o=a,l=["Rotation","OffsetX","OffsetY"],h=i.filter((t=>t.primitiveName!==e.primitiveName&&-1===l.indexOf(t.propertyName))),[u,c]=Y(i,o.primitiveName),d=(0,s.w)(JSON.stringify(e)+c).toString();return n.push({type:"fill",templateHash:d,materialHash:u?Q(d,t,h,r):d,cim:e,materialOverrides:h,colorLocked:e.colorLocked,effects:e.effects,color:{r:255,g:255,b:255,a:1},height:W(o.primitiveName,t,"StepY",r,o.stepY),scaleX:1,angle:W(o.primitiveName,t,"GridAngle",r,o.gridAngle),offsetX:W(o.primitiveName,t,"OffsetX",r,o.offsetX),offsetY:W(o.primitiveName,t,"OffsetY",r,o.offsetY)}),!0}function U(e,t,i,r,n,a,o){const l=e.primitiveName,h=e.size,u=e.scaleX,c=e.rotation,d=e.offsetX,p=e.offsetY,f=y(e.tintColor),m=(0,s.w)(`${e.url}${JSON.stringify(e.colorSubstitutions)}`).toString(),[g,_]=Y(i,l),x=(0,s.w)(JSON.stringify(e)+_).toString();n.push({type:"marker",templateHash:x,materialHash:g?()=>m:m,cim:e,materialOverrides:null,colorLocked:e.colorLocked,effects:e.effects,scaleSymbolsProportionally:!1,alignment:a,size:W(l,t,"Size",r,h),scaleX:W(l,t,"ScaleX",r,u),rotation:W(l,t,"Rotation",r,c),offsetX:W(l,t,"OffsetX",r,d),offsetY:W(l,t,"OffsetY",r,p),color:W(l,t,"TintColor",r,f,H),anchorPoint:e.anchorPoint,isAbsoluteAnchorPoint:"Relative"!==e.anchorPointUnits,outlineColor:{r:0,g:0,b:0,a:0},outlineWidth:0,frameHeight:0,rotateClockwise:e.rotateClockwise,referenceSize:o,sizeRatio:1,markerPlacement:e.markerPlacement})}function G(e,t,i,r,s,n,a,o){const l=e.markerGraphics;if(!l)return;let h=0;if(e.scaleSymbolsProportionally){const t=e.frame;t&&(h=t.ymax-t.ymin)}for(const u of l)if(u){const l=u.symbol;if(!l)continue;switch(l.type){case"CIMPointSymbol":case"CIMLineSymbol":case"CIMPolygonSymbol":B(e,u,i,t,r,s,n,a,h,o);break;case"CIMTextSymbol":z(e,u,t,i,r,s,n,a,h)}}}function z(e,t,i,r,n,a,l,h,u){o.S.findApplicableOverrides(t,r,[]);const c=t.geometry;if(!("x"in c)||!("y"in c))return;const d=t.symbol,f=function(e){return e.underline?"underline":e.strikethrough?"line-through":"none"}(d),m=function(e){let t="normal",i="normal";if(e){const r=e.toLowerCase();-1!==r.indexOf("italic")?t="italic":-1!==r.indexOf("oblique")&&(t="oblique"),-1!==r.indexOf("bold")?i="bold":-1!==r.indexOf("light")&&(i="lighter")}return{style:t,weight:i}}(d.fontStyleName);d.font={family:d.fontFamilyName,decoration:f,...m};const g=e.frame,_=c.x-.5*(g.xmin+g.xmax),x=c.y-.5*(g.ymin+g.ymax),v=e.size/u,b=e.primitiveName,w=(d.height||0)*v,S=d.angle||0,I=((d.offsetX||0)+_)*v,C=((d.offsetY||0)+x)*v,E=y(o.h.getFillColor(d));let F=y(o.h.getStrokeColor(d)),A=o.h.getStrokeWidth(d);A||(F=y(o.h.getFillColor(d.haloSymbol)),A=d.haloSize*v);let R="";for(const e of r)e.primitiveName===b&&void 0!==e.value&&(R+=`-${e.primitiveName}-${e.propertyName}-${JSON.stringify(e.value)}`);const P=JSON.stringify(e.effects)+Number(e.colorLocked)+JSON.stringify(e.anchorPoint)+e.anchorPointUnits+JSON.stringify(e.markerPlacement),L=(0,s.w)(JSON.stringify(t)+P+R).toString();a.push({type:"text",templateHash:L,materialHash:()=>(0,s.w)(JSON.stringify(d.font)).toString(),cim:d,materialOverrides:null,colorLocked:e.colorLocked,effects:e.effects,alignment:l,anchorPoint:{x:e.anchorPoint?e.anchorPoint.x:0,y:e.anchorPoint?e.anchorPoint.y:0},isAbsoluteAnchorPoint:"Relative"!==e.anchorPointUnits,fontName:d.fontFamilyName,decoration:"none",weight:"normal",style:"normal",size:W(b,i,"Size",n,w),angle:W(b,i,"Rotation",n,S),offsetX:W(b,i,"OffsetX",n,I),offsetY:W(b,i,"OffsetY",n,C),horizontalAlignment:M(d.horizontalAlignment),verticalAlignment:T(d.verticalAlignment),text:W(t.primitiveName,i,"TextString",n,t.textString,p,d.textCase),color:E,outlineColor:F,outlineSize:A,referenceSize:h,sizeRatio:1,markerPlacement:e.markerPlacement})}function B(e,t,i,r,n,a,l,h,u,c){const d=t.symbol,p=t.geometry;if(!p)return;const f=d.symbolLayers;if(!f)return;if(c)return void j(e,t,r,i,n,a,l,h,u);let m=f.length;for(;m--;){const c=f[m];if(c&&!1!==c.enable)switch(c.type){case"CIMSolidFill":case"CIMSolidStroke":{const d=x(p);if(!d)continue;const[f,m,g]=v(d,e.frame,e.size,e.anchorPoint,"Relative"!==e.anchorPointUnits),_="CIMSolidFill"===c.type,b={type:"sdf",geom:p,asFill:_},w=e.primitiveName,S=e.size,I=e.rotation||0,C=e.offsetX,M=e.offsetY,T=c.primitiveName,E=y(_?o.h.getFillColor(c):o.h.getStrokeColor(c)),F=_?{r:0,g:0,b:0,a:0}:y(o.h.getStrokeColor(c)),A=o.h.getStrokeWidth(c);if(!_&&!A)break;let R=!1,P="";for(const e of i)e.primitiveName!==T&&e.primitiveName!==w||(void 0!==e.value?P+=`-${e.primitiveName}-${e.propertyName}-${JSON.stringify(e.value)}`:e.valueExpressionInfo&&(R=!0));const L=JSON.stringify({...e,markerGraphics:null}),D=(0,s.w)(JSON.stringify(b)).toString(),N={type:"marker",templateHash:(0,s.w)(JSON.stringify(t)+JSON.stringify(c)+L+P).toString(),materialHash:R?()=>D:D,cim:b,materialOverrides:null,colorLocked:e.colorLocked,effects:e.effects,scaleSymbolsProportionally:e.scaleSymbolsProportionally,alignment:l,anchorPoint:{x:m,y:g},isAbsoluteAnchorPoint:!1,size:W(e.primitiveName,r,"Size",n,S),rotation:W(e.primitiveName,r,"Rotation",n,I),offsetX:W(e.primitiveName,r,"OffsetX",n,C),offsetY:W(e.primitiveName,r,"OffsetY",n,M),scaleX:1,frameHeight:u,rotateClockwise:e.rotateClockwise,referenceSize:h,sizeRatio:f,color:W(T,r,"Color",n,E,H),outlineColor:W(T,r,"Color",n,F,H),outlineWidth:W(T,r,"Width",n,A),markerPlacement:e.markerPlacement};a.push(N);break}default:j(e,t,r,i,n,a,l,h,u)}}}function j(e,t,i,r,a,l,h,u,c){const d=function(e,t){return{type:e.type,enable:!0,name:e.name,colorLocked:e.colorLocked,primitiveName:e.primitiveName,anchorPoint:e.anchorPoint,anchorPointUnits:e.anchorPointUnits,offsetX:0,offsetY:0,rotateClockwise:e.rotateClockwise,rotation:0,size:e.size,billboardMode3D:e.billboardMode3D,depth3D:e.depth3D,frame:e.frame,markerGraphics:[t],scaleSymbolsProportionally:e.scaleSymbolsProportionally,respectFrame:e.respectFrame,clippingPath:e.clippingPath,effects:e.effects}}(e,t);let p=[];const f=["Rotation","OffsetX","OffsetY"];p=r.filter((t=>t.primitiveName!==e.primitiveName||-1===f.indexOf(t.propertyName)));let y="";for(const e of r)void 0!==e.value&&(y+=`-${e.primitiveName}-${e.propertyName}-${JSON.stringify(e.value)}`);const[m,g,_]=o.h.getTextureAnchor(d),x=e.primitiveName,v=e.rotation||0,b=e.offsetX||0,w=e.offsetY||0,S=(0,s.w)(JSON.stringify(d)+y).toString(),I={type:"marker",templateHash:S,materialHash:0===p.length?S:Q(S,i,p,a),cim:d,materialOverrides:p,colorLocked:e.colorLocked,effects:e.effects,scaleSymbolsProportionally:e.scaleSymbolsProportionally,alignment:h,anchorPoint:{x:m,y:g},isAbsoluteAnchorPoint:!1,size:e.size,rotation:W(x,i,"Rotation",a,v),offsetX:W(x,i,"OffsetX",a,b),offsetY:W(x,i,"OffsetY",a,w),color:{r:0,g:0,b:0,a:0},outlineColor:{r:0,g:0,b:0,a:0},outlineWidth:0,scaleX:1,frameHeight:c,rotateClockwise:e.rotateClockwise,referenceSize:u,sizeRatio:_/(0,n.u)(e.size),markerPlacement:e.markerPlacement};l.push(I)}function q(e){if(e&&0===e.indexOf("Level_")){const t=parseInt(e.substr(6),10);if(NaN!==t)return t}return 0}function H(e){if(!e||0===e.length)return null;const t=new r.o(e).toRgba();return{r:t[0],g:t[1],b:t[2],a:t[3]}}function W(e,t,i,r,s,n,o){const l=t[e];if(l){const e=l[i];if("string"==typeof e||"number"==typeof e||e instanceof Array)return n?n.call(null,e,o):e;if(null!=e&&e instanceof a.q)return(t,i,a)=>{let l=(0,h.s)(e,t,{$view:a},r.geometryType,i);return null!==l&&n&&(l=n.call(null,l,o)),null!==l?l:s}}return s}function Q(e,t,i,r){for(const e of i)if(e.valueExpressionInfo){const i=t[e.primitiveName]&&t[e.primitiveName][e.propertyName];i instanceof a.q&&(e.fn=(e,t,s)=>(0,h.s)(i,e,{$view:s},r.geometryType,t))}return(t,r,n)=>{for(const e of i)e.fn&&(e.value=e.fn(t,r,n));return(0,s.w)(e+o.S.buildOverrideKey(i)).toString()}}function Z(e,t){if(!t||0===t.length)return e;const i=JSON.parse(JSON.stringify(e));return o.S.applyOverrides(i,t),i}function Y(e,t){let i=!1,r="";for(const s of e)s.primitiveName===t&&(void 0!==s.value?r+=`-${s.primitiveName}-${s.propertyName}-${JSON.stringify(s.value)}`:s.valueExpressionInfo&&(i=!0));return[i,r]}},30337:(e,t,i)=>{"use strict";function r(e,t){return t?"xoffset"in t&&t.xoffset?Math.max(e,Math.abs(t.xoffset)):"yoffset"in t&&t.yoffset?Math.max(e,Math.abs(t.yoffset||0)):e:e}function s(e,t){return"number"==typeof e?e:e&&e.stops&&e.stops.length?function(e){let t=0,i=0;for(let r=0;r<e.length;r++){const s=e[r].size;"number"==typeof s&&(t+=s,i++)}return t/i}(e.stops):t}function n(e,t){if(!t)return e;const i=t.filter((e=>"size"===e.type)).map((t=>{const{maxSize:i,minSize:r}=t;return(s(i,e)+s(r,e))/2}));let r=0;const n=i.length;if(0===n)return e;for(let e=0;e<n;e++)r+=i[e];const a=Math.floor(r/n);return Math.max(a,e)}function a(e){const t=e&&e.renderer,i="touch"===(e&&e.event&&e.event.pointerType)?9:6;if(!t)return i;const s="visualVariables"in t?n(i,t.visualVariables):i;if("simple"===t.type)return r(s,t.symbol);if("unique-value"===t.type){let e=s;return t.uniqueValueInfos.forEach((t=>{e=r(e,t.symbol)})),e}if("class-breaks"===t.type){let e=s;return t.classBreakInfos.forEach((t=>{e=r(e,t.symbol)})),e}return t.type,s}i.d(t,{s:()=>a})},93028:(e,t,i)=>{"use strict";i.d(t,{a:()=>h,i:()=>l,n:()=>o,u:()=>a});var r=i(80219),s=i(16408),n=i(78730);function a(e){return{renderer:{type:"simple",symbol:"esriGeometryPoint"===e||"esriGeometryMultipoint"===e?n.l:"esriGeometryPolyline"===e?n.o:n.S}}}function o(e,t){if((0,r.c)("csp-restrictions"))return()=>({[t]:null,...e});try{let i=`this.${t} = null;`;for(const t in e)i+=`this${t.indexOf(".")?`["${t}"]`:`.${t}`} = ${JSON.stringify(e[t])};`;const r=new Function(i);return()=>new r}catch(i){return()=>({[t]:null,...e})}}function l(e={}){return[{name:"New Feature",description:"",prototype:{attributes:(0,r.y)(e)}}]}function h(e,t){return{attachment:null,data:{isVersioned:!1,supportsAttachment:!1,supportsM:!1,supportsZ:e},metadata:{supportsAdvancedFieldProperties:!1},operations:{supportsCalculate:!1,supportsTruncate:!1,supportsValidateSql:!1,supportsAdd:t,supportsDelete:t,supportsEditing:t,supportsChangeTracking:!1,supportsQuery:!0,supportsQueryAttachments:!1,supportsResizeAttachments:!1,supportsSync:!1,supportsUpdate:t,supportsExceedsLimitStatistics:!0},query:s.t,queryRelated:{supportsCount:!0,supportsOrderBy:!0,supportsPagination:!0},editing:{supportsGeometryUpdate:t,supportsGlobalId:!1,supportsReturnServiceEditsInSourceSpatialReference:!1,supportsRollbackOnFailure:!1,supportsUpdateWithoutM:!1,supportsUploadWithItemId:!1,supportsDeleteByAnonymous:!1,supportsDeleteByOthers:!1,supportsUpdateByAnonymous:!1,supportsUpdateByOthers:!1}}}},62295:(e,t,i)=>{"use strict";function r(e){return"h"in e&&"s"in e&&"v"in e}function s(e){return"l"in e&&"a"in e&&"b"in e}function n(e){return"l"in e&&"c"in e&&"h"in e}i.d(t,{p:()=>p,v:()=>m,y:()=>f,z:()=>y});const a=[[.4124,.3576,.1805],[.2126,.7152,.0722],[.0193,.1192,.9505]],o=[[3.2406,-1.5372,-.4986],[-.9689,1.8758,.0415],[.0557,-.204,1.057]];function l(e,t){const i=[];let r,s;if(e[0].length!==t.length)throw"dimensions do not match";const n=e.length,a=e[0].length;let o=0;for(r=0;r<n;r++){for(o=0,s=0;s<a;s++)o+=e[r][s]*t[s];i.push(o)}return i}function h(e){const t=[e.r/255,e.g/255,e.b/255].map((e=>e<=.04045?e/12.92:((e+.055)/1.055)**2.4)),i=l(a,t);return{x:100*i[0],y:100*i[1],z:100*i[2]}}function u(e){const t=l(o,[e.x/100,e.y/100,e.z/100]).map((e=>{const t=e<=.0031308?12.92*e:1.055*e**(1/2.4)-.055;return Math.min(1,Math.max(t,0))}));return{r:Math.round(255*t[0]),g:Math.round(255*t[1]),b:Math.round(255*t[2])}}function c(e){const t=[e.x/95.047,e.y/100,e.z/108.883].map((e=>e>(6/29)**3?e**(1/3):1/3*(29/6)**2*e+4/29));return{l:116*t[1]-16,a:500*(t[0]-t[1]),b:200*(t[1]-t[2])}}function d(e){const t=e.l,i=[(t+16)/116+e.a/500,(t+16)/116,(t+16)/116-e.b/200].map((e=>e>6/29?e**3:3*(6/29)**2*(e-4/29)));return{x:95.047*i[0],y:100*i[1],z:108.883*i[2]}}function p(e){return"r"in(t=e)&&"g"in t&&"b"in t?e:n(e)?function(e){return u(d(function(e){const t=e.l,i=e.c,r=e.h;return{l:t,a:i*Math.cos(r),b:i*Math.sin(r)}}(e)))}(e):s(e)?function(e){return u(d(e))}(e):function(e){return"x"in e&&"y"in e&&"z"in e}(e)?u(e):r(e)?function(e){const t=(e.h+360)%360/60,i=e.s/100,r=e.v/100*255,s=r*i,n=s*(1-Math.abs(t%2-1));let a;switch(Math.floor(t)){case 0:a={r:s,g:n,b:0};break;case 1:a={r:n,g:s,b:0};break;case 2:a={r:0,g:s,b:n};break;case 3:a={r:0,g:n,b:s};break;case 4:a={r:n,g:0,b:s};break;case 5:case 6:a={r:s,g:0,b:n};break;default:a={r:0,g:0,b:0}}return a.r=Math.round(a.r+r-s),a.g=Math.round(a.g+r-s),a.b=Math.round(a.b+r-s),a}(e):e;var t}function f(e){return r(e)?e:function(e){const t=e.r,i=e.g,r=e.b,s=Math.max(t,i,r),n=s-Math.min(t,i,r);let a=s,o=0===n?0:s===t?(i-r)/n%6:s===i?(r-t)/n+2:(t-i)/n+4,l=0===n?0:n/a;return o<0&&(o+=6),o*=60,l*=100,a*=100/255,{h:o,s:l,v:a}}(p(e))}function y(e){return s(e)?e:function(e){return c(h(e))}(p(e))}function m(e){return n(e)?e:function(e){return function(e){const t=e.l,i=e.a,r=e.b,s=Math.sqrt(i*i+r*r);let n=Math.atan2(r,i);return n=n>0?n:n+2*Math.PI,{l:t,c:s,h:n}}(c(h(e)))}(p(e))}},33897:(e,t,i)=>{"use strict";i.d(t,{h:()=>g,t:()=>E});var r=i(30466),s=i(60816),n=i(80219),a=i(78155),o=i(80987),l=i(20215),h=i(88903),u=i(32769),c=i(98843),d=i(85570),p=i(18143),f=i(89710),y=i(92858);const m="__esri_timestamp__";class g{constructor(e,t,i,r,s=128){this._trackIdToObservations=new Map,this._idCounter=0,this._lastPurge=performance.now(),this._addOrUpdated=new Map,this._removed=[],this._maxAge=0,this._timeInfo=i,this._purgeOptions=r,this.store=e,this.objectIdField=t,this.purgeInterval=s,this._useGeneratedIds="__esri_stream_id__"===this.objectIdField}add(e){if(this._useGeneratedIds){const t=this._nextId();e.attributes[this.objectIdField]=t,e.objectId=t}else e.objectId=e.attributes[this.objectIdField];if(this._addOrUpdated.set(e.objectId,e),this._maxAge=Math.max(this._maxAge,e.attributes[this._timeInfo.startTimeField]),!this._timeInfo.trackIdField)return(0,n.t)(this._trackIdLessObservations)&&(this._trackIdLessObservations=new r.s(1e5)),void this._trackIdLessObservations.enqueue(e.objectId);const t=e.attributes[this._timeInfo.trackIdField];if(!this._trackIdToObservations.has(t)){const e=(0,n.r)(this._purgeOptions)&&null!=this._purgeOptions.maxObservations?this._purgeOptions.maxObservations:1e3,i=(0,s.o)(e,0,1e3);this._trackIdToObservations.set(t,new r.s(i))}const i=this._trackIdToObservations.get(t).enqueue(e.objectId);(0,n.r)(i)&&(this._addOrUpdated.has(i)?this._addOrUpdated.delete(i):this._removed.push(i))}checkForUpdates(){const e=this._getToAdd(),t=this._getToRemove(),i=performance.now();i-this._lastPurge>=this.purgeInterval&&(this._purge(i),this._lastPurge=i);const r=[];if((0,n.r)(t))for(const e of t){const t=this.store.removeById(e);(0,n.r)(t)&&r.push(t)}if((0,n.r)(e))for(const t of e)t.attributes[m]=i,this.store.add(t);(e||r)&&this.store.update(e,r)}_getToAdd(){if(!this._addOrUpdated.size)return null;const e=new Array(this._addOrUpdated.size);let t=0;return this._addOrUpdated.forEach((i=>e[t++]=i)),this._addOrUpdated.clear(),e}_getToRemove(){const e=this._removed;return this._removed.length?(this._removed=[],e):null}_nextId(){const e=this._idCounter;return this._idCounter=(this._idCounter+1)%4294967294+1,e}_purge(e){const t=this._purgeOptions;(0,n.r)(t)&&(this._purgeSomeByDisplayCount(t),this._purgeByAge(t),this._purgeByAgeReceived(e,t),this._purgeTracks())}_purgeSomeByDisplayCount(e){if(!e.displayCount)return;let t=this.store.size;if(t>e.displayCount){if(this._timeInfo.trackIdField)for(const i of this._trackIdToObservations.values())if(t>e.displayCount&&i.size){const e=(0,n.f)(i.dequeue());this._removed.push(e),t--}if((0,n.r)(this._trackIdLessObservations)){let i=t-e.displayCount;for(;i-- >0;){const e=this._trackIdLessObservations.dequeue();(0,n.r)(e)&&this._removed.push(e)}}}}_purgeByAge(e){var t;if(!e.age||null==(t=this._timeInfo)||!t.startTimeField)return;const i=60*e.age*1e3,r=this._maxAge-i;this.store.forEach((e=>{e.attributes[this._timeInfo.startTimeField]<r&&this._removed.push(e.objectId)}))}_purgeByAgeReceived(e,t){if(!t.ageReceived)return;const i=e-60*t.ageReceived*1e3;this.store.forEach((e=>{e.attributes[m]<i&&this._removed.push(e.objectId)}))}_purgeTracks(){this._trackIdToObservations.forEach(((e,t)=>{0===e.size&&this._trackIdToObservations.delete(t)}))}}let _=class extends(o.n.EventedMixin(u.d)){onFeature(e){this.emit("feature",e)}};_=(0,a.e)([(0,h.n)("esri.layers.graphics.sources.connections.StreamConnection")],_);var x=_;const v=n.n.getLogger("esri.layers.graphics.sources.connections.WebSocketConnection");var b,w;(w=b||(b={}))[w.CONNECTING=0]="CONNECTING",w[w.OPEN=1]="OPEN",w[w.CLOSING=2]="CLOSING",w[w.CLOSED=3]="CLOSED";let S=class extends x{constructor(e){super(),this.errorString=null;const{geometryType:t,spatialReference:i,sourceSpatialReference:r}=e;this._config=e,this._featureZScaler=(0,c.t)(t,r,i),this._open()}async _open(){await this._tryCreateWebSocket(),this.destroyed||await this._handshake()}destroy(){(0,n.r)(this._websocket)&&(this._websocket.onopen=null,this._websocket.onclose=null,this._websocket.onerror=null,this._websocket.onmessage=null,this._websocket.close()),this._websocket=null}get connectionStatus(){if((0,n.t)(this._websocket))return"disconnected";switch(this._websocket.readyState){case b.CONNECTING:case b.OPEN:return"connected";case b.CLOSING:case b.CLOSED:return"disconnected"}}async _tryCreateWebSocket(e=this._config.source.path,t=1e3,i=0){try{if(this.destroyed)return;this._websocket=await this._createWebSocket(e),this.notifyChange("connectionStatus")}catch(r){const s=t/1e3;return this._config.maxReconnectionAttempts&&i>=this._config.maxReconnectionAttempts?(v.error(new l.s("websocket-connection","Exceeded maxReconnectionAttempts attempts. No further attempts will be made")),void this.destroy()):(v.error(new l.s("websocket-connection",`Failed to connect. Attempting to reconnect in ${s}s`,r)),await(0,l.C)(t),this._tryCreateWebSocket(e,Math.min(1.5*t,1e3*this._config.maxReconnectionInterval),i+1))}}_createWebSocket(e){const t=new WebSocket(e),i=new Promise(((e,i)=>{t.onopen=()=>e(t),t.onclose=e=>i(e)}));return i.then((()=>{if(this.destroyed)return t.onclose=()=>{},void t.close();t.onclose=e=>this._onClose(e),t.onerror=e=>this._onError(e),t.onmessage=e=>this._onMessage(e)})),i}async _handshake(e=1e4){const t=this._websocket;if((0,n.t)(t))return;const i=(0,l.D)(),r=t.onmessage,{filter:s,outFields:a,spatialReference:o}=this._config;return i.timeout(e),t.onmessage=e=>{var n;let h=null;try{h=JSON.parse(e.data)}catch(e){}h&&"object"==typeof h||(v.error(new l.s("websocket-connection","Protocol violation. Handshake failed - malformed message",e.data)),i.reject(),this.destroy()),(null==(n=h.spatialReference)?void 0:n.wkid)!==(null==o?void 0:o.wkid)&&(v.error(new l.s("websocket-connection",`Protocol violation. Handshake failed - expected wkid of ${o.wkid}`,e.data)),i.reject(),this.destroy()),"json"!==h.format&&(v.error(new l.s("websocket-connection","Protocol violation. Handshake failed - format is not set",e.data)),i.reject(),this.destroy()),s&&h.filter!==s&&v.error(new l.s("websocket-connection","Tried to set filter, but server doesn't support it")),a&&h.outFields!==a&&v.error(new l.s("websocket-connection","Tried to set outFields, but server doesn't support it")),t.onmessage=r,i.resolve()},t.send(JSON.stringify({filter:s,outFields:a,format:"json",spatialReference:{wkid:o.wkid}})),i.promise}_onMessage(e){try{const t=JSON.parse(e.data);if("featureResult"!==t.type)throw new l.s("websocket-connection","Protocol violation - Expected to find message of type 'featureResult'",t);for(const e of t.features)this._featureZScaler&&this._featureZScaler(e.geometry),this.onFeature(e)}catch(e){return v.error(new l.s("websocket-connection","Failed to parse message",e)),void this.destroy()}}_onError(e){const t="Encountered an error over WebSocket connection";this._set("errorString",t),v.error("websocket-connection",t)}_onClose(e){this._websocket=null,this.notifyChange("connectionStatus"),1e3!==e.code&&v.error("websocket-connection",`WebSocket closed unexpectedly with error code ${e.code}`),this.destroyed||this._open()}};(0,a.e)([(0,h.y)()],S.prototype,"connectionStatus",null),(0,a.e)([(0,h.y)()],S.prototype,"errorString",void 0),S=(0,a.e)([(0,h.n)("esri.layers.graphics.sources.connections.WebSocketConnection")],S);const I=n.n.getLogger("esri.layers.graphics.sources.connections.GeoEventConnection"),C={maxQueryDepth:5,maxRecordCountFactor:3};let M=class extends S{constructor(e){super({...C,...e})}async _open(){const e=await this._fetchServiceDefinition(this._config.source);e.timeInfo.trackIdField||I.warn("GeoEvent service was configured without a TrackIdField. This may result in certain functionality being disabled. The purgeOptions.maxObservations property will have no effect.");const t=await this._fetchWebSocketUrl(e.streamUrls,this._config.spatialReference);this._buddyServicesQuery||(this._buddyServicesQuery=this._queryBuddyServices()),await this._buddyServicesQuery,await this._tryCreateWebSocket(t);const{filter:i,outFields:r}=this._config;this.destroyed||this._setFilter(i,r)}_onMessage(e){let t;try{t=this._enrich(JSON.parse(e.data)),this._featureZScaler&&this._featureZScaler(t.geometry)}catch(e){return void I.error(new l.s("geoevent-connection","Failed to parse message",e))}this.onFeature(t)}async _fetchServiceDefinition(e){const t=(0,o.L)(e.path,{query:{f:"json"},responseType:"json"}),i=(await t).data;return this._serviceDefinition=i,i}async _fetchWebSocketUrl(e,t){const i=e[0],{urls:r,token:s}=i;return`${this._inferWebSocketBaseUrl(r)}/subscribe?outSR=${t.wkid}${s?"&token="+s:""}`}_inferWebSocketBaseUrl(e){if(1===e.length)return e[0];for(const t of e)if(-1!==t.indexOf("wss"))return t;return I.error(new l.s("geoevent-connection","Unable to infer WebSocket url",e)),null}async _setFilter(e,t){const i=this._websocket;if((0,n.t)(i)||(0,n.t)(e)&&(0,n.t)(t))return;const r=JSON.stringify({filter:this._serializeFilter(e,t)});let s=!1;const a=(0,l.D)();return i.onmessage=e=>{const t=JSON.parse(e.data);t.filter&&(t.error&&(I.error(new l.s("geoevent-connection","Failed to set service filter",t.error)),this._set("errorString",`Could not set service filter - ${t.error}`),a.reject(t.error)),i.onmessage=this._onMessage.bind(this),s=!0,a.resolve())},i.send(r),setTimeout((()=>{s||(this.destroyed||this._websocket!==i||I.error(new l.s("geoevent-connection","Server timed out when setting filter")),a.reject())}),1e4),a.promise}_serializeFilter(e,t){const i={};if((0,n.t)(e)&&(0,n.t)(t))return i;if((0,n.r)(e)&&e.geometry)try{const t=(0,f.p)(e.geometry);if("extent"!==t.type)throw new l.s(`Expected extent but found type ${t.type}`);i.geometry=JSON.stringify(t.shiftCentralMeridian())}catch(e){I.error(new l.s("geoevent-connection","Encountered an error when setting connection geometryDefinition",e))}return(0,n.r)(e)&&e.where&&"1 = 1"!==e.where&&(i.where=e.where),(0,n.r)(t)&&(i.outFields=t.join(",")),i}_enrich(e){if(!this._relatedFeatures)return e;const t=this._serviceDefinition.relatedFeatures.joinField,i=e.attributes[t];if(!this._relatedFeatures.has(i))return I.warn("geoevent-connection","Feature join failed. Is the join field configured correctly?",e),e;const{attributes:r,geometry:s}=this._relatedFeatures.get(i);for(const t in r)e.attributes[t]=r[t];return s&&(e.geometry=s),e.geometry||e.centroid||I.error(new l.s("geoevent-connection","Found malformed feature - no geometry found",e)),e}async _queryBuddyServices(){try{const{relatedFeatures:e,keepLatestArchive:t}=this._serviceDefinition,i=this._queryRelatedFeatures(e),r=this._queryArchive(t);await i;const s=await r;if(!s)return;for(const e of s.features)this.onFeature(this._enrich(e))}catch(e){I.error(new l.s("geoevent-connection","Encountered an error when querying buddy services",{error:e}))}}async _queryRelatedFeatures(e){if(!e)return;const t=await this._queryBuddy(e.featuresUrl);this._addRelatedFeatures(t)}async _queryArchive(e){if(e)return this._queryBuddy(e.featuresUrl)}async _queryBuddy(e){const t=new((await Promise.resolve().then(i.bind(i,16040)).then((function(e){return e.F}))).default)({url:e}),{capabilities:r}=await t.load(),s=r.query.supportsMaxRecordCountFactor,a=r.query.supportsPagination,o=r.query.supportsCentroid,l=this._config.maxRecordCountFactor,h=t.capabilities.query.maxRecordCount,u=s?h*l:h,c=new p.b;if(c.outFields=(0,n.q)(this._config.outFields,["*"]),c.where=(0,n.q)((0,n.g)(this._config.filter,"where"),"1=1"),c.returnGeometry=!0,c.returnExceededLimitFeatures=!0,c.outSpatialReference=y.k.fromJSON(this._config.spatialReference),o&&(c.returnCentroid=!0),s&&(c.maxRecordCountFactor=l),a)return c.num=u,t.destroy(),this._queryPages(e,c);const f=await(0,d.y)(e,c,this._config.sourceSpatialReference);return t.destroy(),f.data}async _queryPages(e,t,i=[],r=0){t.start=(0,n.r)(t.num)?r*t.num:null;const{data:s}=await(0,d.y)(e,t,this._config.sourceSpatialReference);return s.exceededTransferLimit&&r<this._config.maxQueryDepth?(s.features.forEach((e=>i.push(e))),this._queryPages(e,t,i,r+1)):(i.forEach((e=>s.features.push(e))),s)}_addRelatedFeatures(e){const t=new Map,i=e.features,r=this._serviceDefinition.relatedFeatures.joinField;for(const e of i){const i=e.attributes[r];t.set(i,e)}this._relatedFeatures=t}};M=(0,a.e)([(0,h.n)("esri.layers.graphics.sources.connections.GeoEventConnection")],M);var T=M;function E(e,t,i,r,s,n,a){const o=0===e.path.indexOf("wss://")||0===e.path.indexOf("ws://"),l={source:e,sourceSpatialReference:t,spatialReference:i,geometryType:r,filter:s,maxReconnectionAttempts:n,maxReconnectionInterval:a};return o?new S(l):new T(l)}},43356:(e,t,i)=>{"use strict";i.d(t,{$:()=>D,A:()=>p,B:()=>f,C:()=>y,D:()=>m,E:()=>g,F:()=>_,G:()=>x,H:()=>v,J:()=>b,K:()=>w,N:()=>S,O:()=>I,P:()=>C,Q:()=>M,S:()=>T,T:()=>E,U:()=>F,V:()=>A,W:()=>R,Y:()=>P,Z:()=>L,c:()=>r,e:()=>O,i:()=>s,j:()=>l,k:()=>h,o:()=>n,r:()=>a,s:()=>o,t:()=>N,u:()=>u,y:()=>c,z:()=>d});const r=1e-30,s=4294967295,n=512,a=8,o=29,l=8,h={metrics:{width:15,height:17,left:0,top:-7,advance:14}},u=0,c=0,d=0,p=1,f=2,y=3,m=4,g=5,_=6,x=5,v=6,b=1,w=2,S=2,I=1,C=2,M=4,T=1.05,E=6,F=5,A=6,R=1.15,P=2,L=7,D=500,N=128,O=10},67390:(e,t,i)=>{"use strict";i.d(t,{a:()=>a}),i(80987);var r=i(80219),s=i(65352),n=i(98548);function a(e,t,i,a=new n.M){let o;if("2d"===i.type)o=t*i.resolution;else if("3d"===i.type){const n=i.overlayPixelSizeInMapUnits(e),a=i.basemapSpatialReference;o=(0,r.r)(a)&&!a.equals(i.spatialReference)?(0,s.G)(a)/(0,s.G)(i.spatialReference):t*n}const l=e.x-o,h=e.y-o,u=e.x+o,c=e.y+o,{spatialReference:d}=i;return a.xmin=Math.min(l,u),a.ymin=Math.min(h,c),a.xmax=Math.max(l,u),a.ymax=Math.max(h,c),a.spatialReference=d,a}new n.M},50985:(e,t,i)=>{"use strict";i.r(t),i.d(t,{A:()=>W,C:()=>R,D:()=>K,E:()=>L,T:()=>H,_:()=>T,a:()=>O,b:()=>$,c:()=>G,d:()=>P,e:()=>N,f:()=>te,j:()=>Y,k:()=>Z,q:()=>ee,r:()=>M,v:()=>A,w:()=>F,y:()=>B});var r=i(80987),s=i(20215),n=i(67098),a=i(9389),o=i(54622),l=i(92858),h=i(73574),u=i(60978),c=i(47365),d=i(2502),p=i(89710),f=i(16040),y=i(29831),m=i(80136),g=i(52737),_=i(18143),x=i(56803),v=i(85570),b=i(20736),w=i(71666),S=i(91790),I=i(52109),C=i(76326);class M{constructor(){this.declaredRootClass="esri.arcade.featureSetCollection",this._layerById={},this._layerByName={}}add(e,t,i){this._layerById[t]=i,this._layerByName[e]=i}featureSetByName(e,t=!0,i=["*"]){return void 0===this._layerByName[e]?this.resolvePromise(null):this.resolvePromise(this._layerByName[e])}featureSetById(e,t=!0,i=["*"]){return void 0===this._layerById[e]?this.resolvePromise(null):this.resolvePromise(this._layerById[e])}castToText(){return"object, FeatureSetCollection"}resolvePromise(e){return(0,s.x)(e)}}class T extends n.v{constructor(e){super(e),this.declaredClass="esri.arcade.featureset.actions.AttributeFilter",this._maxProcessing=1e3,this._parent=e.parentfeatureset,e.whereclause instanceof o.WhereClause?(this._whereclause=e.whereclause,this._whereClauseFunction=null):(this._whereClauseFunction=e.whereclause,this._whereclause=null)}_initialiseFeatureSet(){null!==this._parent?(this.fields=this._parent.fields.slice(0),this.geometryType=this._parent.geometryType,this.objectIdField=this._parent.objectIdField,this.globalIdField=this._parent.globalIdField,this.spatialReference=this._parent.spatialReference,this.hasM=this._parent.hasM,this.hasZ=this._parent.hasZ,this.typeIdField=this._parent.typeIdField,this.types=this._parent.types):(this.fields=[],this.typeIdField="",this.objectIdField="",this.globalIdField="",this.spatialReference=new l.k({wkid:4326}),this.geometryType=a.a0.point)}_getSet(e){return null===this._wset?this._ensureLoaded().then((()=>this._parent._getFilteredSet("",null,this._whereclause,null,e))).then((t=>(this._checkCancelled(e),null!==this._whereClauseFunction?this._wset=new n.t(t._candidates.slice(0).concat(t._known.slice(0)),[],t._ordered,this._clonePageDefinition(t.pagesDefinition)):this._wset=new n.t(t._candidates.slice(0),t._known.slice(0),t._ordered,this._clonePageDefinition(t.pagesDefinition)),this._wset))):(0,s.x)(this._wset)}_isInFeatureSet(e){let t=this._parent._isInFeatureSet(e);return t===a.a1.NotInFeatureSet?t:(t=this._idstates[e],void 0===t?a.a1.Unknown:t)}_getFeature(e,t,i){return this._parent._getFeature(e,t,i)}_getFeatures(e,t,i,r){return this._parent._getFeatures(e,t,i,r)}_featureFromCache(e){return this._parent._featureFromCache(e)}executeWhereClause(e){return this._whereclause.testFeature(e)}executeWhereClauseDeferred(e){if(null!==this._whereClauseFunction)try{const t=this._whereClauseFunction(e);return(0,s.U)(t)?t:(0,s.x)(t)}catch(e){return(0,s.L)(e)}return(0,s.x)(this.executeWhereClause(e))}_fetchAndRefineFeatures(e,t,i){const r=new n.t([],e,!1,null),o=Math.min(t,e.length);return this._parent._getFeatures(r,-1,o,i).then((()=>{if(this._checkCancelled(i),null==this._whereClauseFunction){for(let t=0;t<o;t++){const i=this._parent._featureFromCache(e[t]);!0===this.executeWhereClause(i)?this._idstates[e[t]]=a.a1.InFeatureSet:this._idstates[e[t]]=a.a1.NotInFeatureSet}return"success"}const r=[];for(let t=0;t<o;t++){const i=this._parent._featureFromCache(e[t]);r.push(this.executeWhereClauseDeferred(i))}return(0,s.c)(r).then((i=>{for(let r=0;r<t;r++)!0===i[r]?this._idstates[e[r]]=a.a1.InFeatureSet:this._idstates[e[r]]=a.a1.NotInFeatureSet;return"success"}))}))}_getFilteredSet(e,t,i,r,s){return null!==this._whereClauseFunction||(null!==i?null!==this._whereclause&&(i=(0,n.o)(this._whereclause,i)):i=this._whereclause),this._ensureLoaded().then((()=>this._parent._getFilteredSet(e,t,i,r,s))).then((e=>{let t;return this._checkCancelled(s),t=null!==this._whereClauseFunction?new n.t(e._candidates.slice(0).concat(e._known.slice(0)),[],e._ordered,this._clonePageDefinition(e.pagesDefinition)):new n.t(e._candidates.slice(0),e._known.slice(0),e._ordered,this._clonePageDefinition(e.pagesDefinition)),t}))}_stat(e,t,i,r,a,o,l){if(null!==this._whereClauseFunction)return null===a&&""===i&&null===r?this._manualStat(e,t,o,l):(0,s.x)({calculated:!1});let h=this._whereclause;return null!==a&&null!==this._whereclause&&(h=(0,n.o)(this._whereclause,a)),this._parent._stat(e,t,i,r,h,o,l).then((s=>!1===s.calculated?null===a&&""===i&&null===r?this._manualStat(e,t,o,l):{calculated:!1}:s))}_canDoAggregates(e,t,i,r,a){return null!==this._whereClauseFunction?(0,s.x)(!1):(null!==a?null!==this._whereclause&&(a=(0,n.o)(this._whereclause,a)):a=this._whereclause,null===this._parent?(0,s.x)(!1):this._parent._canDoAggregates(e,t,i,r,a))}_getAggregatePagesDataSourceDefinition(e,t,i,r,a,o,l){return null===this._parent?(0,s.L)(new Error("Should never be called")):(null!==a?null!==this._whereclause&&(a=(0,n.o)(this._whereclause,a)):a=this._whereclause,this._parent._getAggregatePagesDataSourceDefinition(e,t,i,r,a,o,l))}static registerAction(){n.v._featuresetFunctions.filter=function(e){if("function"==typeof e)return new T({parentfeatureset:this,whereclause:e});let t=null;return e instanceof o.WhereClause&&(t=e),new T({parentfeatureset:this,whereclause:t})}}}class E{constructor(){this.sqlRewritable=!1}postInitialization(e,t){}}class F extends E{constructor(e){super(),this.field=e,this.sqlRewritable=!0}extractValue(e){return e.attributes[this.field.name]}rewriteSql(e){return{rewritten:this.sqlRewritable,where:e}}}class A extends E{constructor(e,t,i){super(),this.originalField=e,this.sqlRewritable=!0,this.field=(0,a.a2)(e),this.field.name=t,this.field.alias=i}rewriteSql(e,t){return{rewritten:this.sqlRewritable,where:(0,n.s)(e,this.field.name,this.originalField.name,t.getFieldsIndex())}}extractValue(e){return e.attributes[this.originalField.name]}}class R extends E{constructor(e,t,i){super(),this.field=e,this.codefield=t,this.lkp=i,this.reverseLkp={};for(const e in i)this.reverseLkp[i[e]]=e;this.sqlRewritable=!0}rewriteSql(e,t){const i=this.evaluateNodeToWhereClause(e.parseTree,a.a3.Standardised,this.field.name,this.codefield instanceof o.WhereClause?(0,n.n)(this.codefield,a.a3.Standardised):this.codefield,e.parameters);return i.indexOf(R.BADNESS)>=0?{rewritten:!1,where:e}:{rewritten:this.sqlRewritable,where:o.WhereClause.create(i,t._parent.getFieldsIndex())}}evaluateNodeToWhereClause(e,t,i=null,r=null,s){let a,o,l,h;switch(e.type){case"interval":return(0,n.w)(this.evaluateNodeToWhereClause(e.value,t,i,r,s),e.qualifier,e.op);case"case_expression":{let r=" CASE ";"simple"===e.format&&(r+=this.evaluateNodeToWhereClause(e.operand,t,i,R.BADNESS,s));for(let n=0;n<e.clauses.length;n++)r+=" WHEN "+this.evaluateNodeToWhereClause(e.clauses[n].operand,t,i,R.BADNESS,s)+" THEN "+this.evaluateNodeToWhereClause(e.clauses[n].value,t,i,R.BADNESS,s);return null!==e.else&&(r+=" ELSE "+this.evaluateNodeToWhereClause(e.else,t,i,R.BADNESS,s)),r+=" END ",r}case"param":{const i=s[e.value.toLowerCase()];if("string"==typeof i)return"'"+s[e.value.toLowerCase()].toString().replace(/'/g,"''")+"'";if(i instanceof Date)return(0,n.u)(i,t);if(i instanceof Array){const e=[];for(let r=0;r<i.length;r++)"string"==typeof i[r]?e.push("'"+i[r].toString().replace(/'/g,"''")+"'"):i[r]instanceof Date?e.push((0,n.u)(i[r],t)):e.push(i[r].toString());return e}return i.toString()}case"expr_list":o=[];for(const n of e.value)o.push(this.evaluateNodeToWhereClause(n,t,i,r,s));return o;case"unary_expr":return" ( NOT "+this.evaluateNodeToWhereClause(e.expr,t,i,R.BADNESS,s)+" ) ";case"binary_expr":switch(e.operator){case"AND":return" ("+this.evaluateNodeToWhereClause(e.left,t,i,r,s)+" AND "+this.evaluateNodeToWhereClause(e.right,t,i,r,s)+") ";case"OR":return" ("+this.evaluateNodeToWhereClause(e.left,t,i,r,s)+" OR "+this.evaluateNodeToWhereClause(e.right,t,i,r,s)+") ";case"IS":if("null"!==e.right.type)throw new Error("Unsupported RHS for IS");return" ("+this.evaluateNodeToWhereClause(e.left,t,i,r,s)+" IS NULL )";case"ISNOT":if("null"!==e.right.type)throw new Error("Unsupported RHS for IS");return" ("+this.evaluateNodeToWhereClause(e.left,t,i,r,s)+" IS NOT NULL )";case"IN":if(a=[],"expr_list"===e.right.type){if("column_ref"===e.left.type&&e.left.column.toUpperCase()===this.field.name.toUpperCase()){const n=[];let a=!0;for(const t of e.right.value){if("string"!==t.type){a=!1;break}if(void 0===this.lkp[t.value]){a=!1;break}n.push(this.lkp[t.value].toString())}if(a)return" ("+this.evaluateNodeToWhereClause(e.left,t,i,r,s)+" IN ("+n.join(",")+")) "}return a=this.evaluateNodeToWhereClause(e.right,t,i,r,s)," ("+this.evaluateNodeToWhereClause(e.left,t,i,r,s)+" IN ("+a.join(",")+")) "}return h=this.evaluateNodeToWhereClause(e.right,t,i,r,s),h instanceof Array?" ("+this.evaluateNodeToWhereClause(e.left,t,i,r,s)+" IN ("+h.join(",")+")) ":" ("+this.evaluateNodeToWhereClause(e.left,t,i,r,s)+" IN ("+h+")) ";case"NOT IN":if(a=[],"expr_list"===e.right.type){if("column_ref"===e.left.type&&e.left.column.toUpperCase()===this.field.name.toUpperCase()){const n=[];let a=!0;for(const t of e.right.value){if("string"!==t.type){a=!1;break}if(void 0===this.lkp[t.value]){a=!1;break}n.push(this.lkp[t.value].toString())}if(a)return" ("+this.evaluateNodeToWhereClause(e.left,t,i,r,s)+" NOT IN ("+n.join(",")+")) "}return a=this.evaluateNodeToWhereClause(e.right,t,i,r,s)," ("+this.evaluateNodeToWhereClause(e.left,t,i,r,s)+" NOT IN ("+a.join(",")+")) "}return h=this.evaluateNodeToWhereClause(e.right,t,i,r,s),h instanceof Array?" ("+this.evaluateNodeToWhereClause(e.left,t,i,r,s)+" NOT IN ("+h.join(",")+")) ":" ("+this.evaluateNodeToWhereClause(e.left,t,i,r,s)+" NOT IN ("+h+")) ";case"BETWEEN":return l=this.evaluateNodeToWhereClause(e.right,t,i,R.BADNESS,s)," ("+this.evaluateNodeToWhereClause(e.left,t,i,R.BADNESS,s)+" BETWEEN "+l[0]+" AND "+l[1]+" ) ";case"NOTBETWEEN":return l=this.evaluateNodeToWhereClause(e.right,t,i,R.BADNESS,s)," ("+this.evaluateNodeToWhereClause(e.left,t,i,R.BADNESS,s)+" NOT BETWEEN "+l[0]+" AND "+l[1]+" ) ";case"LIKE":return""!==e.escape?" ("+this.evaluateNodeToWhereClause(e.left,t,i,R.BADNESS,s)+" LIKE "+this.evaluateNodeToWhereClause(e.right,t,i,R.BADNESS,s)+" ESCAPE '"+e.escape+"') ":" ("+this.evaluateNodeToWhereClause(e.left,t,i,R.BADNESS,s)+" LIKE "+this.evaluateNodeToWhereClause(e.right,t,i,R.BADNESS,s)+") ";case"NOT LIKE":return""!==e.escape?" ("+this.evaluateNodeToWhereClause(e.left,t,i,R.BADNESS,s)+" NOT LIKE "+this.evaluateNodeToWhereClause(e.right,t,i,R.BADNESS,s)+" ESCAPE '"+e.escape+"') ":" ("+this.evaluateNodeToWhereClause(e.left,t,i,R.BADNESS,s)+" NOT LIKE "+this.evaluateNodeToWhereClause(e.right,t,i,R.BADNESS,s)+") ";case"<>":case"=":if("column_ref"===e.left.type&&"string"===e.right.type){if(e.left.column.toUpperCase()===this.field.name.toUpperCase()&&void 0!==this.lkp[e.right.value.toString()])return" ("+r+" "+e.operator+" "+this.lkp[e.right.value.toString()].toString()+") "}else if("column_ref"===e.right.type&&"string"===e.left.type&&e.right.column.toUpperCase()===this.field.name.toUpperCase())return" ("+this.lkp[e.right.value.toString()].toString()+" "+e.operator+" "+r+") ";return" ("+this.evaluateNodeToWhereClause(e.left,t,i,R.BADNESS,s)+" "+e.operator+" "+this.evaluateNodeToWhereClause(e.right,t,i,R.BADNESS,s)+") ";case"<":case">":case">=":case"<=":case"*":case"-":case"+":case"/":return" ("+this.evaluateNodeToWhereClause(e.left,t,i,R.BADNESS,s)+" "+e.operator+" "+this.evaluateNodeToWhereClause(e.right,t,i,R.BADNESS,s)+") "}throw new Error("Not Supported Operator "+e.operator);case"null":return"null";case"bool":return!0===e.value?"1":"0";case"string":return"'"+e.value.toString().replace(/'/g,"''")+"'";case"timestamp":case"date":return(0,n.u)(e.value,t);case"number":return e.value.toString();case"current_time":return(0,n.i)("date"===e.mode,t);case"column_ref":return i&&i.toLowerCase()===e.column.toLowerCase()?"("+r+")":e.column;case"function":{const r=this.evaluateNodeToWhereClause(e.args,t,i,R.BADNESS,s);return(0,n.l)(e.name,r,t)}}throw new Error("Unsupported sql syntax "+e.type)}extractValue(e){return this.codefield instanceof o.WhereClause?this.reverseLkp[this.codefield.calculateValueCompiled(e)]:this.reverseLkp[e.attributes[this.codefield]]}}R.BADNESS="_!!!_BAD_LKP_!!!!";class P extends E{constructor(e,t){super(),this.field=e,this.sql=t}rewriteSql(e,t){return{rewritten:!0,where:(0,n.s)(e,this.field.name,(0,n.n)(this.sql,a.a3.Standardised),t.getFieldsIndex())}}extractValue(e){return this.sql.calculateValueCompiled(e)}}class L extends n.v{constructor(e){super(e),this._calcFunc=null,this.declaredClass="esri.arcade.featureset.actions.Adapted",this.adaptedFields=null,this._extraFilter=null,this._extraFilter=e.extraFilter,this._parent=e.parentfeatureset,this._maxProcessing=30,this.adaptedFields=e.adaptedFields}static findField(e,t){for(const i of e)if(i.name.toLowerCase()===t.toString().toLowerCase())return i;return null}_initialiseFeatureSet(){null!==this._parent?(this.geometryType=this._parent.geometryType,this.objectIdField=this._parent.objectIdField,this.globalIdField=this._parent.globalIdField,this.spatialReference=this._parent.spatialReference,this.hasM=this._parent.hasM,this.hasZ=this._parent.hasZ,this.typeIdField=this._parent.typeIdField,this.types=this._parent.types):(this.spatialReference=new l.k({wkid:4326}),this.objectIdField="",this.globalIdField="",this.geometryType=a.a0.point,this.typeIdField="",this.types=null),this.fields=[];for(const e of this.adaptedFields)e.postInitialization(this,this._parent),this.fields.push(e.field)}_getSet(e){return null===this._wset?this._ensureLoaded().then((()=>this._extraFilter?this._getFilteredSet("",null,null,null,e):this._parent._getSet(e))).then((t=>(this._checkCancelled(e),this._wset=new n.t(t._candidates.slice(0),t._known.slice(0),t._ordered,this._clonePageDefinition(t.pagesDefinition)),this._wset))):(0,s.x)(this._wset)}_isInFeatureSet(e){return this._parent._isInFeatureSet(e)}_getFeatures(e,t,i,r){const o=[];-1!==t&&void 0===this._featureCache[t]&&o.push(t);const l=this._maxQueryRate();if(!0===this._checkIfNeedToExpandKnownPage(e,l))return this._expandPagedSet(e,l,0,0,r).then((()=>this._getFeatures(e,t,i,r)));let u=0;for(let r=e._lastFetchedIndex;r<e._known.length&&(u++,u<=i&&(e._lastFetchedIndex+=1),!(void 0===this._featureCache[e._known[r]]&&(e._known[r]!==t&&o.push(e._known[r]),o.length>=l)));r++);if(0===o.length)return(0,s.x)("success");e=new n.t([],o,e._ordered,null);const c=Math.min(o.length,i);return this._parent._getFeatures(e,-1,c,r).then((()=>{this._checkCancelled(r);const e=[];for(let t=0;t<c;t++){const i=this._parent._featureFromCache(o[t]);void 0!==i&&e.push({geometry:i.geometry,attributes:i.attributes,id:o[t]})}for(const t of e){const e=[];for(const i of this.adaptedFields)e[i.field.name]=i.extractValue(t);this._featureCache[t.id]=new h.h({attributes:e,geometry:(0,a.H)(t.geometry)})}return"success"}))}_fetchAndRefineFeatures(){return(0,s.L)(new Error("Fetch and Refine should not be called in this featureset"))}_getFilteredSet(e,t,i,r,s){let a=!1;const o=this.reformulateWithoutAdaptions(i);a=o.cannot,i=o.where;let l=!1;if(null!==r){l=!0;const e=[];for(const t of this.adaptedFields)if(!(t instanceof F)&&!0===r.scanForField(t.field.name)){if(!(t instanceof A)){r=null,l=!1;break}e.push({field:t.field.name,newfield:t.originalField.name})}r&&e.length>0&&(r=r.replaceFields(e))}return null!==i?null!==this._extraFilter&&(i=(0,n.o)(this._extraFilter,i)):i=this._extraFilter,this._ensureLoaded().then((()=>this._parent._getFilteredSet(e,t,i,r,s))).then((e=>{let t;return this._checkCancelled(s),t=!0===a?new n.t(e._candidates.slice(0).concat(e._known.slice(0)),[],!0===l&&e._ordered,this._clonePageDefinition(e.pagesDefinition)):new n.t(e._candidates.slice(0),e._known.slice(0),!0===l&&e._ordered,this._clonePageDefinition(e.pagesDefinition)),t}))}reformulateWithoutAdaptions(e){const t={cannot:!1,where:e};if(null!==e)for(const i of this.adaptedFields)if(!0===(0,n.h)(e,i.field.name)){const r=i.rewriteSql(e,this);if(!0!==r.rewritten){t.cannot=!0,t.where=null;break}t.where=r.where}return t}_stat(e,t,i,r,a,o,l){let h=!1,u=this.reformulateWithoutAdaptions(t);return h=u.cannot,t=u.where,u=this.reformulateWithoutAdaptions(a),h=h||u.cannot,null!==(a=u.where)?null!==this._extraFilter&&(a=(0,n.o)(this._extraFilter,a)):a=this._extraFilter,!0===h?null===a&&""===i&&null===r?this._manualStat(e,t,o,l):(0,s.x)({calculated:!1}):this._parent._stat(e,t,i,r,a,o,l).then((s=>!1===s.calculated?null===a&&""===i&&null===r?this._manualStat(e,t,o,l):{calculated:!1}:s))}_canDoAggregates(e,t,i,r,a){if(null===this._parent)return(0,s.x)(!1);for(let t=0;t<e.length;t++)for(const i of this.adaptedFields)if(e[t].toLowerCase()===i.field.name.toLowerCase()&&!(i instanceof F))return(0,s.x)(!1);const o=[];for(let e=0;e<t.length;e++){const i=t[e];if(null!==i.workingexpr){const e=this.reformulateWithoutAdaptions(i.workingexpr);if(e.cannot)return(0,s.x)(!1);const t=i.clone();t.workingexpr=e.where,o.push(t)}else o.push(i)}const l=this.reformulateWithoutAdaptions(a);return l.cannot?(0,s.x)(!1):(null!==(a=l.where)?null!==this._extraFilter&&(a=(0,n.o)(this._extraFilter,a)):a=this._extraFilter,this._parent._canDoAggregates(e,o,i,r,a))}_getAggregatePagesDataSourceDefinition(e,t,i,r,a,o,l){if(null===this._parent)return(0,s.L)(new Error("Should never be called"));const h=[];for(let e=0;e<t.length;e++){const i=t[e];if(null!==i.workingexpr){const e=this.reformulateWithoutAdaptions(i.workingexpr);if(e.cannot)return(0,s.L)(new Error("Should never be called"));const t=i.clone();t.workingexpr=e.where,h.push(t)}else h.push(i)}const u=this.reformulateWithoutAdaptions(a);return u.cannot?(0,s.L)(new Error("Should never be called")):(null!==(a=u.where)?null!==this._extraFilter&&(a=(0,n.o)(this._extraFilter,a)):a=this._extraFilter,this._parent._getAggregatePagesDataSourceDefinition(e,h,i,r,a,o,l))}}function D(e,t){return e===t?0:null===e?-1:null===t?1:e<t?-1:1}class N{constructor(e){const t=e.split(",");this._fields=[],this._directions=[];for(let e=0;e<t.length;e++){const i=t[e].match(/\S+/g);this._fields.push(i[0]),2===i.length?"asc"===i[1].toLowerCase()?this._directions.push(1):this._directions.push(0):this._directions.push(1)}}constructClause(){let e="";for(let t=0;t<this._fields.length;t++)0!==t&&(e+=","),e+=this._fields[t],1===this._directions[t]?e+=" ASC":e+=" DESC";return e}order(e){e.sort(((e,t)=>{for(let i=0;i<this._fields.length;i++){const r=this.featureValue(e.feature,this._fields[i],i),s=this.featureValue(t.feature,this._fields[i],i);let n=0;if(n=1===this._directions[i]?D(r,s):-1*D(r,s),0!==n)return n}return 0}))}scanForField(e){for(let t=0;t<this._fields.length;t++)if(this._fields[t].toLowerCase().trim()===e.toLowerCase().trim())return!0;return!1}replaceFields(e){let t="";for(let i=0;i<this._fields.length;i++){0!==i&&(t+=",");let r=this._fields[i];for(const t of e)if(r.toLowerCase()===t.field.toLowerCase()){r=t.newfield;break}t+=r,1===this._directions[i]?t+=" ASC":t+=" DESC"}return new N(t)}featureValue(e,t,i){const r=e.attributes[t];if(void 0!==r)return r;for(const r in e.attributes)if(t.toLowerCase()===r.toLowerCase())return this._fields[i]=r,e.attributes[r];return null}}class O extends n.v{constructor(e){super(e),this._orderbyclause=null,this.declaredClass="esri.arcade.featureset.actions.OrderBy",this._maxProcessing=100,this._orderbyclause=e.orderbyclause,this._parent=e.parentfeatureset}_getSet(e){return null===this._wset?this._ensureLoaded().then((()=>this._getFilteredSet("",null,null,this._orderbyclause,e))).then((t=>(this._checkCancelled(e),this._wset=t,this._wset))):(0,s.x)(this._wset)}manualOrderSet(e,t){return this.getIdColumnDictionary(e,[],-1,t).then((e=>{this._orderbyclause.order(e);const t=new n.t([],[],!0,null);for(let i=0;i<e.length;i++)t._known.push(e[i].id);return t}))}getIdColumnDictionary(e,t,i,r){if(i<e._known.length-1){const s=this._maxQueryRate();if("GETPAGES"===e._known[i+1])return(0,a.a4)(this._parent._expandPagedSet(e,s,0,0,r)).then((()=>this.getIdColumnDictionary(e,t,i,r)));let n=i+1;const o=[];for(;n<e._known.length&&"GETPAGES"!==e._known[n];)o.push(e._known[n]),n++;return i+=o.length,(0,a.a4)(this._parent._getFeatureBatch(o,r)).then((s=>{this._checkCancelled(r);for(const e of s)t.push({id:e.attributes[this.objectIdField],feature:e});return this.getIdColumnDictionary(e,t,i,r)}))}return e._candidates.length>0?(0,a.a4)(this._refineSetBlock(e,this._maxProcessingRate(),r)).then((()=>(this._checkCancelled(r),this.getIdColumnDictionary(e,t,i,r)))):(0,s.x)(t)}_isInFeatureSet(e){return this._parent._isInFeatureSet(e)}_getFeatures(e,t,i,r){return this._parent._getFeatures(e,t,i,r)}_featureFromCache(e){if(void 0===this._featureCache[e]){const t=this._parent._featureFromCache(e);if(void 0===t)return;return null===t?null:(this._featureCache[e]=t,t)}return this._featureCache[e]}_fetchAndRefineFeatures(){return(0,s.L)(new Error("Fetch and Refine should not be called in this featureset"))}_getFilteredSet(e,t,i,r,s){return this._ensureLoaded().then((()=>this._parent._getFilteredSet(e,t,i,null===r?this._orderbyclause:r,s))).then((e=>{this._checkCancelled(s);const r=new n.t(e._candidates.slice(0),e._known.slice(0),e._ordered,this._clonePageDefinition(e.pagesDefinition));let a=!0;return e._candidates.length>0&&(a=!1),!1===r._ordered?this.manualOrderSet(r,s).then((e=>(!1===a&&(null===t&&null===i||(e=new n.t(e._candidates.slice(0).concat(e._known.slice(0)),[],e._ordered,this._clonePageDefinition(e.pagesDefinition)))),e))):r}))}static registerAction(){n.v._featuresetFunctions.orderBy=function(e){return""===e?this:new O({parentfeatureset:this,orderbyclause:new N(e)})}}}class k{clone(){const e=new k;return e.field=this.field,e.tofieldname=this.tofieldname,e.typeofstat=this.typeofstat,e.workingexpr=this.workingexpr,e}static parseStatField(e,t,i){const r=new k;r.field=e;const s=o.WhereClause.create(t,i),l=function(e){if("function"===e.parseTree.type){if(0===e.parseTree.args.value.length)return{name:e.parseTree.name,expr:null};if(e.parseTree.args.value.length>1)throw new Error("Statistic does not have 1 or 0 Parameters");const t=o.WhereClause.create((0,n.a)(e.parseTree.args.value[0],a.a3.Standardised,e.parameters),e.fieldsIndex);return{name:e.parseTree.name,expr:t}}return null}(s);if(null===l)throw new Error("Invalid Statistic Function");const h=l.name.toUpperCase().trim();if("MIN"===h){if(r.typeofstat="MIN",r.workingexpr=l.expr,null===s)throw new Error("Invalid Statistic Function Parameters")}else if("MAX"===h){if(r.typeofstat="MAX",r.workingexpr=l.expr,null===s)throw new Error("Invalid Statistic Function Parameters")}else if("COUNT"===h)r.typeofstat="COUNT",r.workingexpr=l.expr;else if("STDEV"===h){if(r.typeofstat="STDDEV",r.workingexpr=l.expr,null===s)throw new Error("Invalid Statistic Function Parameters")}else if("SUM"===h){if(r.typeofstat="SUM",r.workingexpr=l.expr,null===s)throw new Error("Invalid Statistic Function Parameters")}else if("MEAN"===h){if(r.typeofstat="AVG",r.workingexpr=l.expr,null===s)throw new Error("Invalid Statistic Function Parameters")}else if("AVG"===h){if(r.typeofstat="AVG",r.workingexpr=l.expr,null===s)throw new Error("Invalid Statistic Function Parameters")}else{if("VAR"!==h)throw new Error("Invalid Statistic Function");if(r.typeofstat="VAR",r.workingexpr=l.expr,null===s)throw new Error("Invalid Statistic Function Parameters")}return r}toStatisticsName(){switch(this.typeofstat.toUpperCase()){case"MIN":return"min";case"MAX":return"max";case"SUM":return"sum";case"COUNT":return"count";case"VAR":return"var";case"STDDEV":return"stddev";case"AVG":return"avg";default:return"count"}}}function V(e){if(!e)return"COUNT";switch(e.toLowerCase()){case"max":return"MAX";case"var":case"variance":return"VAR";case"avg":case"average":case"mean":return"AVG";case"min":return"MIN";case"sum":return"SUM";case"stdev":case"stddev":return"STDDEV";case"count":return"COUNT"}return"COUNT"}class U extends n.v{constructor(e){super(e),this._decodedStatsfield=[],this._decodedGroupbyfield=[],this._candosimplegroupby=!0,this.phsyicalgroupbyfields=[],this.objectIdField="ROW__ID",this._internalObjectIdField="ROW__ID",this._adaptedFields=[],this.declaredClass="esri.arcade.featureset.actions.Aggregate",this._uniqueIds=1,this._maxQuery=10,this._maxProcessing=10,this._parent=e.parentfeatureset,this._config=e}isTable(){return!0}_getSet(e){return null===this._wset?this._getFilteredSet("",null,null,null,e).then((e=>(this._wset=e,this._wset))):(0,s.x)(this._wset)}_isInFeatureSet(){return a.a1.InFeatureSet}nextUniqueName(e){for(;1===e["T"+this._uniqueIds.toString()];)this._uniqueIds++;const t="T"+this._uniqueIds.toString();return e[t]=1,t}convertToEsriFieldType(e){return e}_initialiseFeatureSet(){const e={};let t=!1,i=1;const r=this._parent?this._parent.getFieldsIndex():new d.e([]);for(this.objectIdField="ROW__ID",this.globalIdField="";!1===t;){let e=!1;for(let t=0;t<this._config.groupbyfields.length;t++)if(this._config.groupbyfields[t].name.toLowerCase()===this.objectIdField.toLowerCase()){e=!0;break}if(!1===e)for(let t=0;t<this._config.statsfields.length;t++)if(this._config.statsfields[t].name.toLowerCase()===this.objectIdField.toLowerCase()){e=!0;break}!1===e?t=!0:(this.objectIdField="ROW__ID"+i.toString(),i++)}for(const e of this._config.statsfields){const t=new k;t.field=e.name,t.tofieldname=e.name,t.workingexpr=e.expression instanceof o.WhereClause?e.expression:o.WhereClause.create(e.expression,r),t.typeofstat=V(e.statistic),this._decodedStatsfield.push(t)}this._decodedGroupbyfield=[];for(const e of this._config.groupbyfields){const t={name:e.name,singlefield:null,tofieldname:e.name,expression:e.expression instanceof o.WhereClause?e.expression:o.WhereClause.create(e.expression,r)};this._decodedGroupbyfield.push(t)}if(null!==this._parent){this.geometryType=this._parent.geometryType,this.spatialReference=this._parent.spatialReference,this.hasM=this._parent.hasM,this.hasZ=this._parent.hasZ,this.typeIdField="";for(const t of this._parent.fields)e[t.name.toUpperCase()]=1;this.types=null}else this.geometryType=a.a0.point,this.typeIdField="",this.types=null,this.spatialReference=new l.k({wkid:4326});this.fields=[];const s=new k;s.field=this.nextUniqueName(e),s.tofieldname=this.objectIdField,s.workingexpr=o.WhereClause.create(this._parent.objectIdField,this._parent.getFieldsIndex()),s.typeofstat="MIN",this._decodedStatsfield.push(s);for(const t of this._decodedGroupbyfield){const i=new c.y;if(t.name=this.nextUniqueName(e),i.name=t.tofieldname,i.alias=i.name,(0,n.E)(t.expression)){const e=this._parent.getField((0,n.n)(t.expression,a.a3.Standardised));if(!e)throw new Error("Field is not present for Aggregation");t.name=e.name,t.singlefield=e.name,this.phsyicalgroupbyfields.push(e.name),i.type=e.type}else{i.type=this.convertToEsriFieldType((0,n.f)(t.expression,this._parent.fields));const e=new c.y;e.name=t.name,e.alias=e.name,this.phsyicalgroupbyfields.push(t.name),this._adaptedFields.push(new P(e,t.expression)),this._candosimplegroupby=!1}this.fields.push(i)}if(this._adaptedFields.length>0)for(const e of this._parent.fields)this._adaptedFields.push(new F(e));for(let t=0;t<this._decodedStatsfield.length;t++){const i=new c.y;let r=null;const s=this._decodedStatsfield[t];s.field=this.nextUniqueName(e),s.tofieldname===this.objectIdField&&(this._internalObjectIdField=s.field),i.name=s.tofieldname,i.alias=i.name;const o=null!==s.workingexpr&&(0,n.E)(s.workingexpr)?(0,n.n)(s.workingexpr,a.a3.Standardised):"";switch(this._decodedStatsfield[t].typeofstat){case"SUM":if(""!==o){if(r=this._parent.getField(o),!r)throw new Error("Field is not present for Aggregation");i.type=r.type}else i.type="double";break;case"MIN":case"MAX":if(""!==o){if(r=this._parent.getField(o),!r)throw new Error("Field is not present for Aggregation");i.type=r.type}else i.type="double";break;case"COUNT":i.type="integer";break;case"STDDEV":case"VAR":case"AVG":if(""!==o&&(r=this._parent.getField(o),!r))throw new Error("Field is not present for Aggregation");i.type="double"}this.fields.push(i)}}_canDoAggregates(){return(0,s.x)(!1)}_getFeatures(e,t,i,r){-1!==t&&this._featureCache[t];const n=this._maxQuery;return!0===this._checkIfNeedToExpandKnownPage(e,n)?this._expandPagedSet(e,n,0,0,r).then((()=>this._getFeatures(e,t,i,r))):(0,s.x)("success")}_getFilteredSet(e,t,i,r,a){if(""!==e)return(0,s.x)(new n.t([],[],!0,null));let o=null;const l={ordered:!1,nowhereclause:!1};return this._ensureLoaded().then((()=>{if(null!==i)for(let e=0;e<this._decodedStatsfield.length;e++)if(!0===(0,n.h)(i,this._decodedStatsfield[e].tofieldname)){l.nowhereclause=!0,i=null;break}if(null!==r){l.ordered=!0;for(let e=0;e<this._decodedStatsfield.length;e++)if(!0===r.scanForField(this._decodedStatsfield[e].tofieldname)){r=null,l.ordered=!1;break}if(null!==r)for(const e of this._decodedGroupbyfield)if(null===e.singlefield&&!0===r.scanForField(e.tofieldname)){r=null,l.ordered=!1;break}}return!1===this._candosimplegroupby?(0,s.x)(!1):this._parent._canDoAggregates(this.phsyicalgroupbyfields,this._decodedStatsfield,"",null,null)})).then((e=>{if(e){let e=null;i&&(e=this._reformulateWhereClauseWithoutGroupByFields(i));let t=null;return r&&(t=this._reformulateOrderClauseWithoutGroupByFields(r)),this._parent._getAggregatePagesDataSourceDefinition(this.phsyicalgroupbyfields,this._decodedStatsfield,"",null,e,t,this._internalObjectIdField).then((e=>(this._checkCancelled(a),o=!0===l.nowhereclause?new n.t(e._candidates.slice(0).concat(e._known.slice(0)),[],!0===l.ordered&&e._ordered,this._clonePageDefinition(e.pagesDefinition)):new n.t(e._candidates.slice(0),e._known.slice(0),!0===l.ordered&&e._ordered,this._clonePageDefinition(e.pagesDefinition)),o)))}let t=this._parent;if(this._adaptedFields.length>0&&(t=new L({parentfeatureset:this._parent,adaptedFields:this._adaptedFields,extraFilter:null})),!0===l.nowhereclause)o=new n.t(["GETPAGES"],[],!1,{aggregatefeaturesetpagedefinition:!0,resultOffset:0,resultRecordCount:this._maxQuery,internal:{fullyResolved:!1,workingItem:null,type:"manual",iterator:null,set:[],subfeatureset:new O({parentfeatureset:t,orderbyclause:new N(this.phsyicalgroupbyfields.join(",")+","+this._parent.objectIdField+" ASC")})}});else{let e=t;if(null!==i){let t=null;i&&(t=this._reformulateWhereClauseWithoutGroupByFields(i)),e=new T({parentfeatureset:e,whereclause:t})}o=new n.t(["GETPAGES"],[],!1,{aggregatefeaturesetpagedefinition:!0,resultOffset:0,resultRecordCount:this._maxQuery,internal:{fullyResolved:!1,workingItem:null,type:"manual",iterator:null,set:[],subfeatureset:new O({parentfeatureset:e,orderbyclause:new N(this.phsyicalgroupbyfields.join(",")+","+this._parent.objectIdField+" ASC")})}})}return o}))}_reformulateWhereClauseWithoutStatsFields(e){for(const t of this._decodedStatsfield)e=(0,n.s)(e,t.tofieldname,(0,n.n)(t.workingexpr,a.a3.Standardised),this._parent.getFieldsIndex());return e}_reformulateWhereClauseWithoutGroupByFields(e){for(const t of this._decodedGroupbyfield)t.tofieldname!==t.name&&(e=(0,n.s)(e,t.tofieldname,(0,n.n)(t.expression,a.a3.Standardised),this._parent.getFieldsIndex()));return e}_reformulateOrderClauseWithoutGroupByFields(e){const t=[];for(const e of this._decodedGroupbyfield)e.tofieldname!==e.name&&t.push({field:e.tofieldname,newfield:e.name});return t.length>0?e.replaceFields(t):e}_clonePageDefinition(e){return null===e?null:!0===e.aggregatefeaturesetpagedefinition?{aggregatefeaturesetpagedefinition:!0,resultRecordCount:e.resultRecordCount,resultOffset:e.resultOffset,internal:e.internal}:this._parent._clonePageDefinition(e)}_refineSetBlock(e,t,i){try{return!0===this._checkIfNeedToExpandCandidatePage(e,this._maxQuery)?this._expandPagedSet(e,this._maxQuery,0,0,i).then((()=>this._refineSetBlock(e,t,i))):(this._checkCancelled(i),e._candidates.length,this._refineKnowns(e,t),e._candidates.length,e._candidates.length,(0,s.x)(e))}catch(e){return(0,s.L)(e)}}_expandPagedSet(e,t,i,r,s){return this._expandPagedSetFeatureSet(e,t,i,r,s)}_getPhysicalPage(e,t,i){return!0===e.pagesDefinition.aggregatefeaturesetpagedefinition?(0,s.l)(((t,r)=>{this._sequentialGetPhysicalItem(e,e.pagesDefinition.resultRecordCount,i,[]).then((e=>{t(e)}),r)})):this._getAgregagtePhysicalPage(e,t,i).then((e=>{for(const t of e){const e={geometry:t.geometry,attributes:{}};for(const i of this._decodedGroupbyfield)e.attributes[i.tofieldname]=t.attributes[i.name];for(const i of this._decodedStatsfield)e.attributes[i.tofieldname]=t.attributes[i.field];this._featureCache[e.attributes[this.objectIdField]]=new h.h(e)}return e.length}))}_sequentialGetPhysicalItem(e,t,i,r){return(0,s.l)(((s,n)=>{null===e.pagesDefinition.internal.iterator&&(e.pagesDefinition.internal.iterator=e.pagesDefinition.internal.subfeatureset.iterator(i)),!0===e.pagesDefinition.internal.fullyResolved||0===t?s(r.length):this._nextAggregateItem(e,t,i,r,(n=>{null===n?s(r.length):(t-=1,s(this._sequentialGetPhysicalItem(e,t,i,r)))}),n)}))}_nextAggregateItem(e,t,i,r,s,n){try{(0,a.a4)(e.pagesDefinition.internal.iterator.next()).then((a=>{if(null===a)if(null!==e.pagesDefinition.internal.workingItem){const t=this._calculateAndAppendAggregateItem(e.pagesDefinition.internal.workingItem);r.push(t),e.pagesDefinition.internal.workingItem=null,e.pagesDefinition.internal.set.push(t.attributes[this.objectIdField]),e.pagesDefinition.internal.fullyResolved=!0,s(null)}else e.pagesDefinition.internal.fullyResolved=!0,s(null);else{const o=this._generateAggregateHash(a);if(null===e.pagesDefinition.internal.workingItem)e.pagesDefinition.internal.workingItem={features:[a],id:o};else{if(o!==e.pagesDefinition.internal.workingItem.id){const i=this._calculateAndAppendAggregateItem(e.pagesDefinition.internal.workingItem);return r.push(i),e.pagesDefinition.internal.workingItem=null,e.pagesDefinition.internal.set.push(i.attributes[this.objectIdField]),t-=1,e.pagesDefinition.internal.workingItem={features:[a],id:o},void s(i)}e.pagesDefinition.internal.workingItem.features.push(a)}this._nextAggregateItem(e,t,i,r,s,n)}}),n)}catch(e){n(e)}}_calculateFieldStat(e,t,i){const r=[];for(let i=0;i<e.features.length;i++)if(null!==t.workingexpr){const s=t.workingexpr.calculateValue(e.features[i]);null!==s&&r.push(s)}else r.push(null);switch(t.typeofstat){case"MIN":i.attributes[t.tofieldname]=(0,n.p)("min",r,-1);break;case"MAX":i.attributes[t.tofieldname]=(0,n.p)("max",r,-1);break;case"SUM":i.attributes[t.tofieldname]=(0,n.p)("sum",r,-1);break;case"COUNT":i.attributes[t.tofieldname]=r.length;break;case"VAR":i.attributes[t.tofieldname]=(0,n.p)("var",r,-1);break;case"STDDEV":i.attributes[t.tofieldname]=(0,n.p)("stddev",r,-1);break;case"AVG":i.attributes[t.tofieldname]=(0,n.p)("avg",r,-1)}return!0}_calculateAndAppendAggregateItem(e){const t={attributes:{},geometry:null};for(const i of this._decodedGroupbyfield){const r=i.singlefield?e.features[0].attributes[i.singlefield]:i.expression.calculateValue(e.features[0]);t.attributes[i.tofieldname]=r}for(const i of this._decodedStatsfield)this._calculateFieldStat(e,i,t);const i=[];for(let r=0;r<this._decodedStatsfield.length;r++)i.push(this._calculateFieldStat(e,this._decodedStatsfield[r],t));return this._featureCache[t.attributes[this.objectIdField]]=new h.h({attributes:t.attributes,geometry:t.geometry}),t}_generateAggregateHash(e){let t="";for(const i of this._decodedGroupbyfield){const r=i.singlefield?e.attributes[i.singlefield]:i.expression.calculateValue(e);t+=null==r?":":":"+r.toString()}return(0,u.x)(t,u.n.String)}_stat(){return(0,s.x)({calculated:!1})}getFeatureByObjectId(){return(0,s.x)(null)}static registerAction(){n.v._featuresetFunctions.groupby=function(e,t){return new U({parentfeatureset:this,groupbyfields:e,statsfields:t})}}}class G extends n.v{constructor(e){super(e),this._topnum=0,this.declaredClass="esri.arcade.featureset.actions.Top",this._countedin=0,this._maxProcessing=100,this._topnum=e.topnum,this._parent=e.parentfeatureset}_getSet(e){return null===this._wset?this._ensureLoaded().then((()=>this._parent._getSet(e))).then((e=>(this._wset=new n.t(e._candidates.slice(0),e._known.slice(0),!1,this._clonePageDefinition(e.pagesDefinition)),this._setKnownLength(this._wset)>this._topnum&&(this._wset._known=this._wset._known.slice(0,this._topnum)),this._setKnownLength(this._wset)>=this._topnum&&(this._wset._candidates=[]),this._wset))):(0,s.x)(this._wset)}_setKnownLength(e){return e._known.length>0&&"GETPAGES"===e._known[e._known.length-1]?e._known.length-1:e._known.length}_isInFeatureSet(e){const t=this._parent._isInFeatureSet(e);if(t===a.a1.NotInFeatureSet)return t;const i=this._idstates[e];return i===a.a1.InFeatureSet||i===a.a1.NotInFeatureSet?i:t===a.a1.InFeatureSet&&void 0===i?this._countedin<this._topnum?(this._idstates[e]=a.a1.InFeatureSet,this._countedin++,a.a1.InFeatureSet):(this._idstates[e]=a.a1.NotInFeatureSet,a.a1.NotInFeatureSet):a.a1.Unknown}_expandPagedSet(e,t,i,r,n){if(null===this._parent)return(0,s.L)(new Error("Parent Paging not implemented"));if(t>this._topnum&&(t=this._topnum),this._countedin>=this._topnum&&e.pagesDefinition.internal.set.length<=e.pagesDefinition.resultOffset){let t=e._known.length;return t>0&&"GETPAGES"===e._known[t-1]&&(e._known.length=t-1),t=e._candidates.length,t>0&&"GETPAGES"===e._candidates[t-1]&&(e._candidates.length=t-1),(0,s.x)("success")}return this._parent._expandPagedSet(e,t,i,r,n).then((t=>(this._setKnownLength(e)>this._topnum&&(e._known.length=this._topnum),this._setKnownLength(e)>=this._topnum&&(e._candidates.length=0),t)))}_getFeatures(e,t,i,r){const a=[],o=this._maxQueryRate();if(!0===this._checkIfNeedToExpandKnownPage(e,o))return this._expandPagedSet(e,o,0,0,r).then((()=>this._getFeatures(e,t,i,r)));-1!==t&&void 0===this._featureCache[t]&&a.push(t);let l=0;for(let r=e._lastFetchedIndex;r<e._known.length&&(l++,l<=i&&(e._lastFetchedIndex+=1),!(void 0===this._featureCache[e._known[r]]&&(e._known[r]!==t&&a.push(e._known[r]),a.length>o)));r++);if(0===a.length)return(0,s.x)("success");const h=new n.t([],a,!1,null),u=Math.min(a.length,i);return this._parent._getFeatures(h,-1,u,r).then((()=>{for(let e=0;e<u;e++){const t=this._parent._featureFromCache(a[e]);void 0!==t&&(this._featureCache[a[e]]=t)}return"success"}))}_getFilteredSet(e,t,i,r,s){return this._ensureLoaded().then((()=>this._getSet(s))).then((e=>new n.t(e._candidates.slice(0).concat(e._known.slice(0)),[],!1,this._clonePageDefinition(e.pagesDefinition))))}_refineKnowns(e,t){let i=0,r=null;const s=[];for(let n=0;n<e._candidates.length;n++){const o=this._isInFeatureSet(e._candidates[n]);if(o===a.a1.InFeatureSet){if(e._known.push(e._candidates[n]),i+=1,null===r?r={start:n,end:n}:r.end===n-1?r.end=n:(s.push(r),r={start:n,end:n}),e._known.length>=this._topnum)break}else if(o===a.a1.NotInFeatureSet)null===r?r={start:n,end:n}:r.end===n-1?r.end=n:(s.push(r),r={start:n,end:n}),i+=1;else if(o===a.a1.Unknown)break;if(i>=t)break}null!==r&&s.push(r);for(let t=s.length-1;t>=0;t--)e._candidates.splice(s[t].start,s[t].end-s[t].start+1);this._setKnownLength(e)>this._topnum&&(e._known=e._known.slice(0,this._topnum)),this._setKnownLength(e)>=this._topnum&&(e._candidates=[])}_stat(){return(0,s.x)({calculated:!1})}_canDoAggregates(){return(0,s.x)(!1)}static registerAction(){n.v._featuresetFunctions.top=function(e){return new G({parentfeatureset:this,topnum:e})}}}class z extends n.v{constructor(e){super(e),this.declaredClass="esri.arcade.featureset.sources.FeatureLayerDynamic",this._removeGeometry=!1,this._overrideFields=null,this.formulaCredential=null,this._pageJustIds=!1,this._requestStandardised=!1,e.spatialReference&&(this.spatialReference=e.spatialReference),this._transparent=!0,this._maxProcessing=1e3,this._layer=e.layer,this._wset=null,void 0!==e.outFields&&(this._overrideFields=e.outFields),void 0!==e.includeGeometry&&(this._removeGeometry=!1===e.includeGeometry)}_maxQueryRate(){return a.a5}end(){return this._layer}optimisePagingFeatureQueries(e){this._pageJustIds=e}convertQueryToLruCacheKey(e){const t=(0,a.a6)(e.toJSON());return(0,u.x)(t,u.n.String)}load(){return null===this._loadPromise&&(this._loadPromise=(0,s.l)(((e,t)=>{try{if(!0===this._layer.loaded)return this._initialiseFeatureSet(),void e(this);this._layer.when().then((()=>{try{this._initialiseFeatureSet(),e(this)}catch(e){t(e)}}),t),this._layer.load()}catch(e){t(e)}}))),this._loadPromise}_initialiseFeatureSet(){if(null==this.spatialReference&&(this.spatialReference=this._layer.spatialReference),this.geometryType=this._layer.geometryType,this.fields=this._layer.fields.slice(0),this._layer.outFields)if(1===this._layer.outFields.length&&"*"===this._layer.outFields[0]);else{const e=[];for(const t of this.fields)if("oid"===t.type)e.push(t);else for(const i of this._layer.outFields)if(i.toLowerCase()===t.name.toLowerCase()){e.push(t);break}this.fields=e}if(null!==this._overrideFields)if(1===this._overrideFields.length&&"*"===this._overrideFields[0])this._overrideFields=null;else{const e=[],t=[];for(const i of this.fields)if("oid"===i.type)e.push(i),t.push(i.name);else for(const r of this._overrideFields)if(r.toLowerCase()===i.name.toLowerCase()){e.push(i),t.push(i.name);break}this.fields=e,this._overrideFields=t}if(this._layer.source&&this._layer.source.sourceJSON){const e=this._layer.source.sourceJSON.currentVersion;!0===this._layer.source.sourceJSON.useStandardizedQueries?(this._databaseType=a.a3.StandardisedNoInterval,null!=e&&e>=10.61&&(this._databaseType=a.a3.Standardised)):null!=e&&(e>=10.5&&(this._databaseType=a.a3.StandardisedNoInterval,this._requestStandardised=!0),e>=10.61&&(this._databaseType=a.a3.Standardised))}this.objectIdField=this._layer.objectIdField;for(const e of this.fields)"global-id"===e.type&&(this.globalIdField=e.name);this.hasM=this._layer.supportsM,this.hasZ=this._layer.supportsZ,this.typeIdField=this._layer.typeIdField,this.types=this._layer.types}_isInFeatureSet(){return a.a1.InFeatureSet}_refineSetBlock(e){return(0,s.x)(e)}_candidateIdTransform(e){return e}_getSet(e){return null===this._wset?this._ensureLoaded().then((()=>this._getFilteredSet("",null,null,null,e))).then((e=>(this._wset=e,e))):(0,s.x)(this._wset)}_runDatabaseProbe(e){return(0,s.l)(((t,i)=>{try{this._ensureLoaded().then((()=>{try{const r=new _.b;r.where=e.replace("OBJECTID",this._layer.objectIdField),this._layer.queryObjectIds(r).then((()=>{t(!0)}),(()=>{try{t(!1)}catch(e){i(e)}}))}catch(e){i(e)}}))}catch(e){i(e)}}))}_canUsePagination(){return!(!this._layer.capabilities||!this._layer.capabilities.query||!0!==this._layer.capabilities.query.supportsPagination)}_cacheableFeatureSetSourceKey(){return this._layer.url}pbfSupportedForQuery(e){return!e.outStatistics&&this._layer&&this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsFormatPBF&&!0===this._layer.capabilities.query.supportsQuantizationEditMode}queryPBF(e){return e.quantizationParameters={mode:"edit"},(0,v.c)(this._layer.parsedUrl,e,new m.n({})).then((e=>g.default.fromJSON((0,y.n)(e.data)).unquantize()))}get gdbVersion(){return this._layer&&this._layer.capabilities&&this._layer.capabilities.data&&this._layer.capabilities.data.isVersioned?this._layer.gdbVersion?this._layer.gdbVersion:"SDE.DEFAULT":""}nativeCapabilities(){return{title:this._layer.title,source:this,canQueryRelated:!0,capabilities:this._layer.capabilities,databaseType:this._databaseType,requestStandardised:this._requestStandardised}}executeQuery(e,t){const i=new x.Q({url:this._layer.parsedUrl.path}),r="execute"===t&&this.pbfSupportedForQuery(e);let s=null;if(this.recentlyUsedQueries){const n=this.convertQueryToLruCacheKey(e);s=this.recentlyUsedQueries.getFromCache(n),null===s&&(s=!0!==r?i[t](e):this.queryPBF(e),this.recentlyUsedQueries.addToCache(n,s),s=s.catch((e=>{throw this.recentlyUsedQueries.removeFromCache(n),e})))}return this.featureSetQueryInterceptor&&this.featureSetQueryInterceptor.preLayerQueryCallback({layer:this._layer,query:e,method:t}),null===s&&(s=!0!==r?i[t](e):this.queryPBF(e)),s}_getFilteredSet(e,t,i,r,s){return this.databaseType().then((a=>{if(this.isTable()&&t&&null!==e&&""!==e)return new n.t([],[],!0,null);if(this._canUsePagination())return this._getFilteredSetUsingPaging(e,t,i,r,s);let o="",l=!1;null!==r&&this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsOrderBy&&(o=r.constructClause(),l=!0);const h=new _.b;return h.where=null===i?null===t?"1=1":"":(0,n.n)(i,a),this._requestStandardised&&(h.sqlFormat="standard"),h.spatialRelationship=this._makeRelationshipEnum(e),h.outSpatialReference=this.spatialReference,h.orderByFields=""!==o?o.split(","):null,h.geometry=null===t?null:t,h.relationParameter=this._makeRelationshipParam(e),this.executeQuery(h,"executeForIds").then((e=>(null===e&&(e=[]),this._checkCancelled(s),new n.t([],e,l,null))))}))}_expandPagedSet(e,t,i,r,s){return this._expandPagedSetFeatureSet(e,t,i,r,s)}_getFilteredSetUsingPaging(e,t,i,r,a){try{let s="",o=!1;return null!==r&&this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsOrderBy&&(s=r.constructClause(),o=!0),this.databaseType().then((r=>{let l=null===i?null===t?"1=1":"":(0,n.n)(i,r);this._layer.definitionExpression&&(l=""!==l?"(("+this._layer.definitionExpression+") AND ("+l+"))":this._layer.definitionExpression);let h=this._maxQueryRate();const u=this._layer.capabilities.query.maxRecordCount;void 0!==u&&u<h&&(h=u);let c=null;if(!0===this._pageJustIds)c=new n.t([],["GETPAGES"],o,{spatialRel:this._makeRelationshipEnum(e),relationParam:this._makeRelationshipParam(e),outFields:this._layer.objectIdField,resultRecordCount:h,resultOffset:0,geometry:null===t?null:t,where:l,orderByFields:s,returnGeometry:!1,returnIdsOnly:"false",internal:{set:[],lastRetrieved:0,lastPage:0,fullyResolved:!1}});else{let i=!0;!0===this._removeGeometry&&(i=!1);const r=null!==this._overrideFields?this._overrideFields:this._fieldsIncludingObjectId(this._layer.outFields?this._layer.outFields:["*"]);c=new n.t([],["GETPAGES"],o,{spatialRel:this._makeRelationshipEnum(e),relationParam:this._makeRelationshipParam(e),outFields:r.join(","),resultRecordCount:h,resultOffset:0,geometry:null===t?null:t,where:l,orderByFields:s,returnGeometry:i,returnIdsOnly:"false",internal:{set:[],lastRetrieved:0,lastPage:0,fullyResolved:!1}})}return this._expandPagedSet(c,h,0,1,a).then((()=>c))}))}catch(e){return(0,s.L)(e)}}_clonePageDefinition(e){return null===e?null:!0!==e.groupbypage?{groupbypage:!1,spatialRel:e.spatialRel,relationParam:e.relationParam,outFields:e.outFields,resultRecordCount:e.resultRecordCount,resultOffset:e.resultOffset,geometry:e.geometry,where:e.where,orderByFields:e.orderByFields,returnGeometry:e.returnGeometry,returnIdsOnly:e.returnIdsOnly,internal:e.internal}:{groupbypage:!0,spatialRel:e.spatialRel,relationParam:e.relationParam,outFields:e.outFields,resultRecordCount:e.resultRecordCount,useOIDpagination:e.useOIDpagination,generatedOid:e.generatedOid,groupByFieldsForStatistics:e.groupByFieldsForStatistics,resultOffset:e.resultOffset,outStatistics:e.outStatistics,geometry:e.geometry,where:e.where,orderByFields:e.orderByFields,returnGeometry:e.returnGeometry,returnIdsOnly:e.returnIdsOnly,internal:e.internal}}_getPhysicalPage(e,t,i){try{const t=e.pagesDefinition.internal.lastRetrieved,r=t,s=e.pagesDefinition.internal.lastPage,n=new _.b;return this._requestStandardised&&(n.sqlFormat="standard"),n.spatialRelationship=e.pagesDefinition.spatialRel,n.relationParameter=e.pagesDefinition.relationParam,n.outFields=e.pagesDefinition.outFields.split(","),n.num=e.pagesDefinition.resultRecordCount,n.start=e.pagesDefinition.internal.lastPage,n.geometry=e.pagesDefinition.geometry,n.where=e.pagesDefinition.where,n.orderByFields=""!==e.pagesDefinition.orderByFields?e.pagesDefinition.orderByFields.split(","):null,n.returnGeometry=e.pagesDefinition.returnGeometry,n.outSpatialReference=this.spatialReference,this.executeQuery(n,"execute").then((n=>{if(this._checkCancelled(i),e.pagesDefinition.internal.lastPage!==s)return"done";for(let t=0;t<n.features.length;t++)e.pagesDefinition.internal.set[r+t]=n.features[t].attributes[this._layer.objectIdField];if(!1===this._pageJustIds)for(let e=0;e<n.features.length;e++)this._featureCache[n.features[e].attributes[this._layer.objectIdField]]=n.features[e];return(void 0===n.exceededTransferLimit&&n.features.length!==e.pagesDefinition.resultRecordCount||!1===n.exceededTransferLimit)&&(e.pagesDefinition.internal.fullyResolved=!0),e.pagesDefinition.internal.lastRetrieved=t+n.features.length,e.pagesDefinition.internal.lastPage+=e.pagesDefinition.resultRecordCount,"done"}))}catch(e){return(0,s.L)(e)}}_fieldsIncludingObjectId(e){if(null===e)return[this.objectIdField];const t=e.slice(0);if(t.indexOf("*")>-1)return t;let i=!1;for(const e of t)if(e.toUpperCase()===this.objectIdField.toUpperCase()){i=!0;break}return!1===i&&t.push(this.objectIdField),t}_getFeatures(e,t,i,r){const n=[];try{if(-1!==t&&void 0===this._featureCache[t]&&n.push(t),!0===this._checkIfNeedToExpandKnownPage(e,this._maxProcessingRate()))return this._expandPagedSet(e,this._maxProcessingRate(),0,0,r).then((()=>this._getFeatures(e,t,i,r)));let a=0;for(let r=e._lastFetchedIndex;r<e._known.length;r++){if(e._lastFetchedIndex+=1,a++,void 0===this._featureCache[e._known[r]]){let i=!1;if(null!==this._layer._mode&&void 0!==this._layer._mode){const t=this._layer._mode;if(void 0!==t._featureMap[e._known[r]]){const s=t._featureMap[e._known[r]];null!==s&&(i=!0,this._featureCache[e._known[r]]=s)}}if(!1===i&&(e._known[r]!==t&&n.push(e._known[r]),n.length>=this._maxProcessingRate()-1))break}if(a>=i&&0===n.length)break}if(0===n.length)return(0,s.x)("success");try{const e=new _.b;return this._requestStandardised&&(e.sqlFormat="standard"),e.objectIds=n,e.outFields=null!==this._overrideFields?this._overrideFields:this._fieldsIncludingObjectId(this._layer.outFields?this._layer.outFields:["*"]),e.returnGeometry=!0,!0===this._removeGeometry&&(e.returnGeometry=!1),e.outSpatialReference=this.spatialReference,this.executeQuery(e,"execute").then((e=>{if(this._checkCancelled(r),void 0!==e.error)return(0,s.L)(new Error(e.error));for(let t=0;t<e.features.length;t++)this._featureCache[e.features[t].attributes[this._layer.objectIdField]]=e.features[t];return"success"}))}catch(e){return(0,s.L)(e)}}catch(e){return(0,s.L)(e)}}_getDistinctPages(e,t,i,r,a,o,l,h,u){return this._ensureLoaded().then((()=>this.databaseType())).then((c=>{let d=i.parseTree.column;for(let e=0;e<this._layer.fields.length;e++)if(this._layer.fields[e].name.toLowerCase()===d.toLowerCase()){d=this._layer.fields[e].name;break}const p=new _.b;this._requestStandardised&&(p.sqlFormat="standard");let f=null===o?null===a?"1=1":"":(0,n.n)(o,c);return this._layer.definitionExpression&&(f=""!==f?"(("+this._layer.definitionExpression+") AND ("+f+"))":this._layer.definitionExpression),p.where=f,p.spatialRelationship=this._makeRelationshipEnum(r),p.relationParameter=this._makeRelationshipParam(r),p.geometry=null===a?null:a,p.returnDistinctValues=!0,p.returnGeometry=!1,p.outFields=[d],this.executeQuery(p,"execute").then((n=>{if(this._checkCancelled(u),!n.hasOwnProperty("features"))return(0,s.L)(new Error("Unnexected Result querying statistics from layer"));let c=!1;for(let e=0;e<this._layer.fields.length;e++)if(this._layer.fields[e].name===d){"date"===this._layer.fields[e].type&&(c=!0);break}for(let e=0;e<n.features.length;e++){if(c){const t=n.features[e].attributes[d];null!==t?h.push(new Date(t)):h.push(t)}else h.push(n.features[e].attributes[d]);if(h.length>=l)break}return 0===n.features.length?h:n.features.length===this._layer.capabilities.query.maxRecordCount&&h.length<l?this._getDistinctPages(e+n.features.length,t,i,r,a,o,l,h,u).then((e=>({calculated:!0,result:e}))):h}))}))}_distinctStat(e,t,i,r,s,n,a){return this._getDistinctPages(0,e,t,i,r,s,n,[],a).then((e=>({calculated:!0,result:e})))}isTable(){return this._layer.isTable||null===this._layer.geometryType||"table"===this._layer.type||""===this._layer.geometryType}_countstat(e,t,i,r){return this.databaseType().then((e=>{const s=new _.b;if(this._requestStandardised&&(s.sqlFormat="standard"),this.isTable()&&i&&null!==t&&""!==t)return{calculated:!0,result:0};let a=null===r?null===i?"1=1":"":(0,n.n)(r,e);return this._layer.definitionExpression&&(a=""!==a?"(("+this._layer.definitionExpression+") AND ("+a+"))":this._layer.definitionExpression),s.where=a,s.where=a,s.spatialRelationship=this._makeRelationshipEnum(t),s.relationParameter=this._makeRelationshipParam(t),s.geometry=null===i?null:i,s.returnGeometry=!1,this.executeQuery(s,"executeForCount").then((e=>({calculated:!0,result:e})))}))}_stats(e,t,i,r,a,o,l){return this._ensureLoaded().then((()=>{const h=this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsSqlExpression,u=this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsStatistics,c=this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsDistinct;return"count"===e?c?this._countstat(e,i,r,a):{calculated:!1}:!1===u||!1===(0,n.E)(t)&&!1===h||!1===t.isStandardized?""!==i||null!==a?{calculated:!1}:this._manualStat(e,t,o,l):"distinct"===e?!1===c?""!==i||null!==a?{calculated:!1}:this._manualStat(e,t,o,l):this._distinctStat(e,t,i,r,a,o,l):this.databaseType().then((o=>{if(this.isTable()&&r&&null!==i&&""!==i)return{calculated:!0,result:null};const l=new _.b;this._requestStandardised&&(l.sqlFormat="standard");let h=null===a?null===r?"1=1":"":(0,n.n)(a,o);this._layer.definitionExpression&&(h=""!==h?"(("+this._layer.definitionExpression+") AND ("+h+"))":this._layer.definitionExpression),l.where=h,l.spatialRelationship=this._makeRelationshipEnum(i),l.relationParameter=this._makeRelationshipParam(i),l.geometry=null===r?null:r;const u=new _.m;u.statisticType=(0,n.m)(e),u.onStatisticField=(0,n.n)(t,o),u.outStatisticFieldName="ARCADE_STAT_RESULT",l.returnGeometry=!1;let c="ARCADE_STAT_RESULT";return l.outStatistics=[u],this.executeQuery(l,"execute").then((e=>{if(!e.hasOwnProperty("features")||0===e.features.length)return(0,s.L)(new Error("Unnexected Result querying statistics from layer"));let t=!1;for(let i=0;i<e.fields.length;i++)if("ARCADE_STAT_RESULT"===e.fields[i].name.toUpperCase()){c=e.fields[i].name,"date"===e.fields[i].type&&(t=!0);break}if(t){let t=e.features[0].attributes[c];return null!==t&&(t=new Date(e.features[0].attributes[c])),{calculated:!0,result:t}}return{calculated:!0,result:e.features[0].attributes[c]}}))}))}))}_stat(e,t,i,r,s,n,a){return this._stats(e,t,i,r,s,n,a)}_canDoAggregates(e,t){return this._ensureLoaded().then((()=>{let e=!1;const i=this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsSqlExpression;if(void 0!==this._layer.capabilities&&null!==this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsStatistics&&!0===this._layer.capabilities.query.supportsOrderBy&&(e=!0),e)for(let r=0;r<t.length-1;r++)null!==t[r].workingexpr&&(!1===t[r].workingexpr.isStandardized||!1===(0,n.E)(t[r].workingexpr)&&!1===i)&&(e=!1);return!1!==e}))}_makeRelationshipEnum(e){if(e.indexOf("esriSpatialRelRelation")>=0)return"relation";switch(e){case"esriSpatialRelRelation":return"relation";case"esriSpatialRelIntersects":return"intersects";case"esriSpatialRelContains":return"contains";case"esriSpatialRelOverlaps":return"overlaps";case"esriSpatialRelWithin":return"within";case"esriSpatialRelTouches":return"touches";case"esriSpatialRelCrosses":return"crosses";case"esriSpatialRelEnvelopeIntersects":return"envelope-intersects"}return e}_makeRelationshipParam(e){return e.indexOf("esriSpatialRelRelation")>=0?e.split(":")[1]:""}_getAggregatePagesDataSourceDefinition(e,t,i,r,s,a,o){return this._ensureLoaded().then((()=>this.databaseType())).then((l=>{let h="",u=!1,c=!1;null!==a&&this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsOrderBy&&(h=a.constructClause(),c=!0),this._layer.capabilities&&this._layer.capabilities.query&&!1===this._layer.capabilities.query.supportsPagination&&(c=!1,u=!0,h=this._layer.objectIdField);const d=[];for(let e=0;e<t.length;e++){const i=new _.m;i.onStatisticField=null!==t[e].workingexpr?(0,n.n)(t[e].workingexpr,l):"",i.outStatisticFieldName=t[e].field,i.statisticType=t[e].toStatisticsName(),d.push(i)}""===h&&(h=e.join(","));let p=this._maxQueryRate();const f=this._layer.capabilities.query.maxRecordCount;void 0!==f&&f<p&&(p=f);let y=null===s?null===r?"1=1":"":(0,n.n)(s,l);return this._layer.definitionExpression&&(y=""!==y?"(("+this._layer.definitionExpression+") AND ("+y+"))":this._layer.definitionExpression),new n.t([],["GETPAGES"],c,{groupbypage:!0,spatialRel:this._makeRelationshipEnum(i),relationParam:this._makeRelationshipParam(i),outFields:["*"],useOIDpagination:u,generatedOid:o,resultRecordCount:p,resultOffset:0,groupByFieldsForStatistics:e,outStatistics:d,geometry:null===r?null:r,where:y,orderByFields:h,returnGeometry:!1,returnIdsOnly:!1,internal:{lastMaxId:-1,set:[],lastRetrieved:0,lastPage:0,fullyResolved:!1}})}))}_getAgregagtePhysicalPage(e,t,i){try{let t=e.pagesDefinition.where;!0===e.pagesDefinition.useOIDpagination&&(t=""!==t?"("+t+") AND ("+e.pagesDefinition.generatedOid+">"+e.pagesDefinition.internal.lastMaxId.toString()+")":e.pagesDefinition.generatedOid+">"+e.pagesDefinition.internal.lastMaxId.toString());const r=e.pagesDefinition.internal.lastRetrieved,n=r,a=e.pagesDefinition.internal.lastPage,o=new _.b;return this._requestStandardised&&(o.sqlFormat="standard"),o.where=t,o.spatialRelationship=e.pagesDefinition.spatialRel,o.relationParameter=e.pagesDefinition.relationParam,o.outFields=e.pagesDefinition.outFields,o.outStatistics=e.pagesDefinition.outStatistics,o.geometry=e.pagesDefinition.geometry,o.groupByFieldsForStatistics=e.pagesDefinition.groupByFieldsForStatistics,o.num=e.pagesDefinition.resultRecordCount,o.start=e.pagesDefinition.internal.lastPage,o.returnGeometry=e.pagesDefinition.returnGeometry,o.orderByFields=""!==e.pagesDefinition.orderByFields?e.pagesDefinition.orderByFields.split(","):null,this.isTable()&&o.geometry&&o.spatialRelationship?(0,s.x)([]):this.executeQuery(o,"execute").then((t=>{if(this._checkCancelled(i),!t.hasOwnProperty("features"))return(0,s.L)(new Error("Unnexected Result querying aggregates from layer"));const o=[];if(e.pagesDefinition.internal.lastPage!==a)return[];for(let i=0;i<t.features.length;i++)e.pagesDefinition.internal.set[n+i]=t.features[i].attributes[e.pagesDefinition.generatedOid];for(let e=0;e<t.features.length;e++)o.push(new h.h({attributes:t.features[e].attributes,geometry:null}));return!0===e.pagesDefinition.useOIDpagination?0===t.features.length?e.pagesDefinition.internal.fullyResolved=!0:e.pagesDefinition.internal.lastMaxId=t.features[t.features.length-1].attributes[e.pagesDefinition.generatedOid]:(void 0===t.exceededTransferLimit&&t.features.length!==e.pagesDefinition.resultRecordCount||!1===t.exceededTransferLimit)&&(e.pagesDefinition.internal.fullyResolved=!0),e.pagesDefinition.internal.lastRetrieved=r+t.features.length,e.pagesDefinition.internal.lastPage+=e.pagesDefinition.resultRecordCount,o}))}catch(e){return(0,s.L)(e)}}static create(e,t,i,r,s){const n=new f.W({url:e,outFields:null===t?["*"]:t});return new z({layer:n,spatialReference:i,lrucache:r,interceptor:s})}relationshipMetaData(){return this._layer&&this._layer.source&&this._layer.source.sourceJSON&&this._layer.source.sourceJSON.relationships?this._layer.source.sourceJSON.relationships:[]}serviceUrl(){return(0,a.a7)(this._layer.parsedUrl.path)}queryAttachments(e,t,i,r){if(this._layer.capabilities.data.supportsAttachment&&this._layer.capabilities.operations.supportsQueryAttachments){const s={objectIds:[e]};return(t&&t>0||i&&i>0)&&(s.size=[t&&t>0?t:0,i&&i>0?i:t+1]),r&&r.length>0&&(s.attachmentTypes=r),this.featureSetQueryInterceptor&&this.featureSetQueryInterceptor.preLayerQueryCallback({layer:this._layer,query:s,method:"attachments"}),this._layer.queryAttachments(s).then((t=>{const i=[];return t&&t[e]&&t[e].forEach((t=>{const r=this._layer.parsedUrl.path+"/"+e.toString()+"/attachments/"+t.id.toString();i.push(new a.r(t.id,t.name,t.contentType,t.size,r))})),i}))}return(0,s.x)([])}queryRelatedFeatures(e){const t={f:"json",relationshipId:e.relationshipId.toString(),definitionExpression:e.where,outFields:e.outFields.join(","),returnGeometry:e.returnGeometry.toString()};return void 0!==e.resultOffset&&null!==e.resultOffset&&(t.resultOffset=e.resultOffset.toString()),void 0!==e.resultRecordCount&&null!==e.resultRecordCount&&(t.resultRecordCount=e.resultRecordCount.toString()),e.orderByFields&&(t.orderByFields=e.orderByFields.join(",")),e.objectIds.length>0&&(t.objectIds=e.objectIds.join(",")),e.outSpatialReference&&(t.outSR=JSON.stringify(e.outSpatialReference.toJSON())),this.featureSetQueryInterceptor&&this.featureSetQueryInterceptor.preRequestCallback({layer:this._layer,queryPayload:t,method:"relatedrecords",url:this._layer.parsedUrl.path+"/queryRelatedRecords"}),(0,r.L)(this._layer.parsedUrl.path+"/queryRelatedRecords",{responseType:"json",query:t}).then((e=>{if(e.data){const t={},i=e.data;if(i&&i.relatedRecordGroups){const e=i.spatialReference;for(const r of i.relatedRecordGroups){const s=r.objectId,n=[];for(const t of r.relatedRecords){t.geometry&&(t.geometry.spatialReference=e);const i=new h.h({geometry:t.geometry?(0,p.p)(t.geometry):null,attributes:t.attributes});n.push(i)}t[s]={features:n,exceededTransferLimit:!0===i.exceededTransferLimit}}}return t}return(0,s.L)("Invalid Request")}))}getFeatureByObjectId(e,t){const i=new x.Q({url:this._layer.parsedUrl.path}),r=new _.b;return r.outFields=t,r.returnGeometry=!1,r.outSpatialReference=this.spatialReference,r.where=this.objectIdField+"="+e.toString(),this.featureSetQueryInterceptor&&this.featureSetQueryInterceptor.preLayerQueryCallback({layer:this._layer,query:r,method:"execute"}),i.execute(r).then((e=>1===e.features.length?e.features[0]:null))}getIdentityUser(){return this.load().then((()=>{var e;const t=null==(e=r.a)?void 0:e.findCredential(this._layer.url);return t?t.userId:null}))}getOwningSystemUrl(){return this.load().then((()=>{var e;const t=null==(e=r.a)?void 0:e.findServerInfo(this._layer.url);if(t)return(0,s.x)(t.owningSystemUrl);let i=this._layer.url;const n=i.toLowerCase().indexOf("/rest/services");return i=n>-1?i.substring(0,n):i,i?(i+="/rest/info",(0,s.l)(((e,t)=>{(0,r.L)(i,{query:{f:"json"}}).then((t=>{let i="";t.data&&t.data.owningSystemUrl&&(i=t.data.owningSystemUrl),e(i)}),(t=>{e("")}))}))):(0,s.x)("")}))}}class B extends n.v{constructor(e){super(e),this.declaredClass="esri.arcade.featureset.sources.FeatureLayerMemory",this._removeGeometry=!1,this._overrideFields=null,this._forceIsTable=!1,e.spatialReference&&(this.spatialReference=e.spatialReference),this._transparent=!0,this._maxProcessing=1e3,this._layer=e.layer,this._wset=null,!0===e.isTable&&(this._forceIsTable=!0),void 0!==e.outFields&&(this._overrideFields=e.outFields),void 0!==e.includeGeometry&&(this._removeGeometry=!1===e.includeGeometry)}_maxQueryRate(){return a.a5}end(){return this._layer}optimisePagingFeatureQueries(){}load(){return null===this._loadPromise&&(this._loadPromise=(0,s.l)(((e,t)=>{if(!0===this._layer.loaded)return this._initialiseFeatureSet(),void e(this);this._layer.when().then((()=>{try{this._initialiseFeatureSet(),e(this)}catch(e){t(e)}}),t),this._layer.load()}))),this._loadPromise}get gdbVersion(){return""}_initialiseFeatureSet(){if(null==this.spatialReference&&(this.spatialReference=this._layer.spatialReference),this.geometryType=this._layer.geometryType,this.fields=this._layer.fields.slice(0),this._layer.outFields)if(1===this._layer.outFields.length&&"*"===this._layer.outFields[0]);else{const e=[];for(const t of this.fields)if("oid"===t.type)e.push(t);else for(const i of this._layer.outFields)if(i.toLowerCase()===t.name.toLowerCase()){e.push(t);break}this.fields=e}if(null!==this._overrideFields)if(1===this._overrideFields.length&&"*"===this._overrideFields[0])this._overrideFields=null;else{const e=[],t=[];for(const i of this.fields)if("oid"===i.type)e.push(i),t.push(i.name);else for(const r of this._overrideFields)if(r.toLowerCase()===i.name.toLowerCase()){e.push(i),t.push(i.name);break}this.fields=e,this._overrideFields=t}this.objectIdField=this._layer.objectIdField;for(const e of this.fields)"global-id"===e.type&&(this.globalIdField=e.name);this.hasM=this._layer.supportsM,this.hasZ=this._layer.supportsZ,this._databaseType=a.a3.Standardised,this.typeIdField=this._layer.typeIdField,this.types=this._layer.types}isTable(){return this._forceIsTable||this._layer.isTable||"table"===this._layer.type||!this._layer.geometryType}_isInFeatureSet(){return a.a1.InFeatureSet}_candidateIdTransform(e){return e}_getSet(e){return null===this._wset?this._ensureLoaded().then((()=>this._getFilteredSet("",null,null,null,e))).then((e=>(this._wset=e,e))):(0,s.x)(this._wset)}_changeFeature(e){const t={};for(const i of this.fields)t[i.name]=e.attributes[i.name];return new h.h({geometry:!0===this._removeGeometry?null:e.geometry,attributes:t})}_getFilteredSet(e,t,i,r,o){let l="",h=!1;if(null!==r&&(l=r.constructClause(),h=!0),this.isTable()&&t&&null!==e&&""!==e){const e=new n.t([],[],!0,null);return(0,s.x)(e)}const u=new _.b;return u.where=null===i?null===t?"1=1":"":(0,n.n)(i,a.a3.Standardised),u.spatialRelationship=this._makeRelationshipEnum(e),u.outSpatialReference=this.spatialReference,u.orderByFields=""!==l?l.split(","):null,u.geometry=null===t?null:t,u.returnGeometry=!0,u.relationParameter=this._makeRelationshipParam(e),this._layer.queryFeatures(u).then((e=>{if(null===e)return new n.t([],[],h,null);this._checkCancelled(o);const t=[];return e.features.forEach((e=>{const i=e.attributes[this._layer.objectIdField];t.push(i),this._featureCache[i]=this._changeFeature(e)})),new n.t([],t,h,null)}))}_makeRelationshipEnum(e){if(e.indexOf("esriSpatialRelRelation")>=0)return"relation";switch(e){case"esriSpatialRelRelation":return"relation";case"esriSpatialRelIntersects":return"intersects";case"esriSpatialRelContains":return"contains";case"esriSpatialRelOverlaps":return"overlaps";case"esriSpatialRelWithin":return"within";case"esriSpatialRelTouches":return"touches";case"esriSpatialRelCrosses":return"crosses";case"esriSpatialRelEnvelopeIntersects":return"envelope-intersects"}return e}_makeRelationshipParam(e){return e.indexOf("esriSpatialRelRelation")>=0?e.split(":")[1]:""}_queryAllFeatures(){if(this._wset)return(0,s.x)(this._wset);const e=new _.b;return e.where="1=1",this._ensureLoaded().then((()=>{if(this._layer.source&&this._layer.source.items){const e=[];return this._layer.source.items.forEach((t=>{const i=t.attributes[this._layer.objectIdField];e.push(i),this._featureCache[i]=this._changeFeature(t)})),this._wset=new n.t([],e,!1,null),this._wset}return this._layer.queryFeatures(e).then((e=>{const t=[];return e.features.forEach((e=>{const i=e.attributes[this._layer.objectIdField];t.push(i),this._featureCache[i]=this._changeFeature(e)})),this._wset=new n.t([],t,!1,null),this._wset}))}))}_getFeatures(e,t,i){const r=[];-1!==t&&void 0===this._featureCache[t]&&r.push(t);for(let s=e._lastFetchedIndex;s<e._known.length&&(e._lastFetchedIndex+=1,!(void 0===this._featureCache[e._known[s]]&&(e._known[s]!==t&&r.push(e._known[s]),r.length>i)));s++);return 0===r.length?(0,s.x)("success"):(0,s.L)(new Error("Unaccounted for Features. Not in Feature Collection"))}_refineSetBlock(e){return(0,s.x)(e)}_stat(){return(0,s.x)({calculated:!1})}_canDoAggregates(){return(0,s.x)(!1)}relationshipMetaData(){return[]}static _cloneAttr(e){const t={};for(const i in e)t[i]=e[i];return t}nativeCapabilities(){return{title:this._layer.title,canQueryRelated:!1,source:this,capabilities:this._layer.capabilities,databaseType:this._databaseType,requestStandardised:!0}}static create(e,t){let i=e.layerDefinition.objectIdField;const r=e.layerDefinition.typeIdField?e.layerDefinition.typeIdField:"",s=[];if(e.layerDefinition.types)for(const t of e.layerDefinition.types)s.push(w.d.fromJSON(t));let n=e.layerDefinition.geometryType;void 0===n&&(n=e.featureSet.geometryType||"");let a=e.featureSet.features;const o=t.toJSON();if(""===i||void 0===i){let t=!1;for(const r of e.layerDefinition.fields)if("oid"===r.type||"esriFieldTypeOID"===r.type){i=r.name,t=!0;break}if(!1===t){let t="FID",r=!0,s=0;for(;r;){let i=!0;for(const r of e.layerDefinition.fields)if(r.name===t){i=!1;break}!0===i?r=!1:(s++,t="FID"+s.toString())}e.layerDefinition.fields.push({type:"esriFieldTypeOID",name:t,alias:t});const n=[];for(let i=0;i<a.length;i++)n.push({geometry:e.featureSet.features[i].geometry,attributes:e.featureSet.features[i].attributes?this._cloneAttr(e.featureSet.features[i].attributes):{}}),n[i].attributes[t]=i;a=n,i=t}}const l=[];for(const t of e.layerDefinition.fields)t instanceof c.y?l.push(t):l.push(c.y.fromJSON(t));let h=n;switch(h){case"esriGeometryPoint":h="point";break;case"esriGeometryPolyline":h="polyline";break;case"esriGeometryPolygon":h="polygon";break;case"esriGeometryExtent":h="extent";break;case"esriGeometryMultipoint":h="multipoint"}for(const e of a)e.geometry&&e.geometry instanceof b.p==0&&(e.geometry.type=h,void 0===e.geometry.spatialReference&&(e.geometry.spatialReference=o));const u={outFields:["*"],source:a,fields:l,types:s,typeIdField:r,objectIdField:i,spatialReference:t};u.geometryType=h||"point";const d=new f.W(u);return new B({layer:d,spatialReference:t,isTable:null===h||""===h})}queryAttachments(){return(0,s.x)([])}getFeatureByObjectId(e){const t=new _.b;return t.where=this.objectIdField+"="+e.toString(),this._layer.queryFeatures(t).then((e=>1===e.features.length?e.features[0]:null))}getOwningSystemUrl(){return(0,s.x)("")}getIdentityUser(){return(0,s.x)("")}}class j extends n.v{constructor(e){super(e),this.declaredClass="esri.arcade.featureset.sources.FeatureLayerRelated",this._findObjectId=-1,this._requestStandardised=!1,this._removeGeometry=!1,this._overrideFields=null,this.featureObjectId=null,this.relatedLayer=null,this.relationship=null,e.spatialReference&&(this.spatialReference=e.spatialReference),this._transparent=!0,this._maxProcessing=1e3,this._layer=e.layer,this._wset=null,this._findObjectId=e.objectId,this.featureObjectId=e.objectId,this.relationship=e.relationship,this.relatedLayer=e.relatedLayer,void 0!==e.outFields&&(this._overrideFields=e.outFields),void 0!==e.includeGeometry&&(this._removeGeometry=!1===e.includeGeometry)}_maxQueryRate(){return a.a5}end(){return this._layer}optimisePagingFeatureQueries(){}load(){return null===this._loadPromise&&(this._loadPromise=(0,s.l)(((e,t)=>{(0,s.c)([this._layer.load(),this.relatedLayer.load()]).then((()=>{this._initialiseFeatureSet(),e(this)}),t)}))),this._loadPromise}nativeCapabilities(){return this.relatedLayer.nativeCapabilities()}_initialiseFeatureSet(){if(null==this.spatialReference&&(this.spatialReference=this._layer.spatialReference),this.geometryType=this.relatedLayer.geometryType,this.fields=this.relatedLayer.fields.slice(0),null!==this._overrideFields)if(1===this._overrideFields.length&&"*"===this._overrideFields[0])this._overrideFields=null;else{const e=[],t=[];for(const i of this.fields)if("oid"===i.type)e.push(i),t.push(i.name);else for(const r of this._overrideFields)if(r.toLowerCase()===i.name.toLowerCase()){e.push(i),t.push(i.name);break}this.fields=e,this._overrideFields=t}const e=this._layer.nativeCapabilities();e&&(this._databaseType=e.databaseType,this._requestStandardised=e.requestStandardised),this.objectIdField=this.relatedLayer.objectIdField,this.globalIdField=this.relatedLayer.globalIdField,this.hasM=this.relatedLayer.supportsM,this.hasZ=this.relatedLayer.supportsZ,this.typeIdField=this.relatedLayer.typeIdField,this.types=this.relatedLayer.types}databaseType(){return this.relatedLayer.databaseType().then((()=>(this._databaseType=this.relatedLayer._databaseType,this._databaseType)))}isTable(){return this.relatedLayer.isTable()}_isInFeatureSet(){return a.a1.InFeatureSet}_candidateIdTransform(e){return e}_getSet(e){return null===this._wset?this._ensureLoaded().then((()=>this._getFilteredSet("",null,null,null,e))).then((e=>(this._wset=e,e))):(0,s.x)(this._wset)}_changeFeature(e){const t={};for(const i of this.fields)t[i.name]=e.attributes[i.name];return new h.h({geometry:!0===this._removeGeometry?null:e.geometry,attributes:t})}_getFilteredSet(e,t,i,r,s){return this.databaseType().then((()=>{if(this.isTable()&&t&&null!==e&&""!==e)return new n.t([],[],!0,null);const a=this._layer.nativeCapabilities();if(!1===a.canQueryRelated)return new n.t([],[],!0,null);if(a.capabilities.queryRelated&&a.capabilities.queryRelated.supportsPagination)return this._getFilteredSetUsingPaging(e,t,i,r,s);let o="",l=!1;null!==r&&a.capabilities&&a.capabilities.queryRelated&&!0===a.capabilities.queryRelated.supportsOrderBy&&(o=r.constructClause(),l=!0);const h=new S.l;h.objectIds=[this._findObjectId];const u=null!==this._overrideFields?this._overrideFields:this._fieldsIncludingObjectId(this.relatedLayer.fields?this.relatedLayer.fields.map((e=>e.name)):["*"]);h.outFields=u,h.relationshipId=this.relationship.id,h.where="1=1";let c=!0;return!0===this._removeGeometry&&(c=!1),h.returnGeometry=c,this._requestStandardised&&(h.sqlFormat="standard"),h.outSpatialReference=this.spatialReference,h.orderByFields=""!==o?o.split(","):null,a.source.queryRelatedFeatures(h).then((r=>{this._checkCancelled(s);const a=r[this._findObjectId]?r[this._findObjectId].features:[],o=[];for(let e=0;e<a.length;e++)this._featureCache[a[e].attributes[this._layer.objectIdField]]=a[e],o.push(a[e].attributes[this._layer.objectIdField]);const h=t&&null!==e&&""!==e,u=null!=i;return new n.t(h||u?o:[],h||u?[]:o,l,null)}))}))}_fieldsIncludingObjectId(e){if(null===e)return[this.objectIdField];const t=e.slice(0);if(t.indexOf("*")>-1)return t;let i=!1;for(const e of t)if(e.toUpperCase()===this.objectIdField.toUpperCase()){i=!0;break}return!1===i&&t.push(this.objectIdField),t}_getFilteredSetUsingPaging(e,t,i,r,a){try{let s="",o=!1;const l=this._layer.nativeCapabilities();return null!==r&&l&&l.capabilities.queryRelated&&!0===l.capabilities.queryRelated.supportsOrderBy&&(s=r.constructClause(),o=!0),this.databaseType().then((()=>{let r=this._maxQueryRate();const h=l.capabilities.query.maxRecordCount;void 0!==h&&h<r&&(r=h);const u=t&&null!==e&&""!==e,c=null!=i;let d=null,p=!0;!0===this._removeGeometry&&(p=!1);const f=null!==this._overrideFields?this._overrideFields:this._fieldsIncludingObjectId(this.relatedLayer.fields?this.relatedLayer.fields.map((e=>e.name)):["*"]);return d=new n.t(u||c?["GETPAGES"]:[],u||c?[]:["GETPAGES"],o,{outFields:f.join(","),resultRecordCount:r,resultOffset:0,objectIds:[this._findObjectId],where:"1=1",orderByFields:s,returnGeometry:p,returnIdsOnly:"false",internal:{set:[],lastRetrieved:0,lastPage:0,fullyResolved:!1}}),this._expandPagedSet(d,r,0,0,a).then((()=>d))}))}catch(e){return(0,s.L)(e)}}_expandPagedSet(e,t,i,r,s){return this._expandPagedSetFeatureSet(e,t,i,r,s)}_clonePageDefinition(e){return null===e?null:!0!==e.groupbypage?{groupbypage:!1,outFields:e.outFields,resultRecordCount:e.resultRecordCount,resultOffset:e.resultOffset,where:e.where,objectIds:e.objectIds,orderByFields:e.orderByFields,returnGeometry:e.returnGeometry,returnIdsOnly:e.returnIdsOnly,internal:e.internal}:{groupbypage:!0,outFields:e.outFields,resultRecordCount:e.resultRecordCount,useOIDpagination:e.useOIDpagination,generatedOid:e.generatedOid,groupByFieldsForStatistics:e.groupByFieldsForStatistics,resultOffset:e.resultOffset,outStatistics:e.outStatistics,geometry:e.geometry,where:e.where,objectIds:e.objectIds,orderByFields:e.orderByFields,returnGeometry:e.returnGeometry,returnIdsOnly:e.returnIdsOnly,internal:e.internal}}_getPhysicalPage(e,t,i){try{const t=e.pagesDefinition.internal.lastRetrieved,r=t,s=e.pagesDefinition.internal.lastPage,n=this._layer.nativeCapabilities(),a=new S.l;return!0===this._requestStandardised&&(a.sqlFormat="standard"),a.relationshipId=this.relationship.id,a.objectIds=e.pagesDefinition.objectIds,a.resultOffset=e.pagesDefinition.internal.lastPage,a.resultRecordCount=e.pagesDefinition.resultRecordCount,a.outFields=e.pagesDefinition.outFields.split(","),a.where=e.pagesDefinition.where,a.orderByFields=""!==e.pagesDefinition.orderByFields?e.pagesDefinition.orderByFields.split(","):null,a.returnGeometry=e.pagesDefinition.returnGeometry,a.outSpatialReference=this.spatialReference,n.source.queryRelatedFeatures(a).then((n=>{if(this._checkCancelled(i),e.pagesDefinition.internal.lastPage!==s)return 0;const a=n[this._findObjectId]?n[this._findObjectId].features:[];for(let t=0;t<a.length;t++)e.pagesDefinition.internal.set[r+t]=a[t].attributes[this._layer.objectIdField];for(let e=0;e<a.length;e++)this._featureCache[a[e].attributes[this._layer.objectIdField]]=a[e];const o=!n[this._findObjectId]||!1===n[this._findObjectId].exceededTransferLimit;return a.length!==e.pagesDefinition.resultRecordCount&&o&&(e.pagesDefinition.internal.fullyResolved=!0),e.pagesDefinition.internal.lastRetrieved=t+a.length,e.pagesDefinition.internal.lastPage+=e.pagesDefinition.resultRecordCount,a.length}))}catch(e){return(0,s.L)(e)}}_getFeatures(e,t,i,r){const n=[];-1!==t&&void 0===this._featureCache[t]&&n.push(t);const a=this._maxQueryRate();if(!0===this._checkIfNeedToExpandKnownPage(e,a))return this._expandPagedSet(e,a,0,0,r).then((()=>this._getFeatures(e,t,i,r)));let o=0;for(let r=e._lastFetchedIndex;r<e._known.length&&(o++,o<=i&&(e._lastFetchedIndex+=1),!("GETPAGES"!==e._known[r]&&void 0===this._featureCache[e._known[r]]&&(e._known[r]!==t&&n.push(e._known[r]),n.length>i)))&&!(o>=i&&0===n.length);r++);return 0===n.length?(0,s.x)("success"):(0,s.L)(new Error("Unaccounted for Features. Not in Feature Collection"))}_refineSetBlock(e,t,i){return(0,s.x)(e)}_stat(e,t,i,r,n,a,o){return(0,s.x)({calculated:!1})}get gdbVersion(){return this.relatedLayer.gdbVersion}_canDoAggregates(e,t,i,r,n){return(0,s.x)(!1)}relationshipMetaData(){return this.relatedLayer.relationshipMetaData()}serviceUrl(){return this.relatedLayer.serviceUrl()}queryAttachments(e,t,i,r){return this.relatedLayer.queryAttachments(e,t,i,r)}getFeatureByObjectId(e,t){return this.relatedLayer.getFeatureByObjectId(e,t)}getOwningSystemUrl(){return this.relatedLayer.getOwningSystemUrl()}getIdentityUser(){return this.relatedLayer.getIdentityUser()}}function q(e,t){if(n.b.applicationCache){const i=n.b.applicationCache.getLayerInfo(e);if(i)return i.then((i=>(0,s.x)(new f.W({url:e,outFields:t,sourceJSON:i}))));const r=new f.W({url:e,outFields:t});let a=(0,s.l)(((e,t)=>{r.load().then((()=>{e(r.sourceJSON)}),(e=>{t(e)}))}));return n.b.applicationCache&&(n.b.applicationCache.setLayerInfo(e,a),a=a.catch((t=>{throw n.b.applicationCache.clearLayerInfo(e),t}))),a.then((()=>(0,s.x)(r)))}return(0,s.x)(new f.W({url:e,outFields:t}))}function H(e,t,i,r,n,a=null){return q(e,["*"]).then((e=>(0,s.x)(W(e,t,i,r,n,a))))}function W(e,t=null,i=null,r=!0,s=null,n=null){return!0===e._hasMemorySource()?new B({layer:e,spatialReference:t,outFields:i,includeGeometry:r,lrucache:s,interceptor:n}):new z({layer:e,spatialReference:t,outFields:i,includeGeometry:r,lrucache:s,interceptor:n})}function Q(e){if(null!==n.b.applicationCache){const t=n.b.applicationCache.getLayerInfo(e);if(null!==t)return t}let t=(0,r.L)(e,{responseType:"json",query:{f:"json"}}).then((e=>{if(e.data){const t=e.data;return t.layers||(t.layers=[]),t.tables||(t.tables=[]),(0,s.x)(t)}return(0,s.x)({layers:[],tables:[]})}));return null!==n.b.applicationCache&&(n.b.applicationCache.setLayerInfo(e,t),t=t.catch((t=>{throw n.b.applicationCache.clearLayerInfo(e),t}))),t}function Z(e,t){const i={metadata:null,networkId:-1,unVersion:3,terminals:[],queryelem:null,layerNameLkp:{},lkp:null};return Q(e).then((a=>{if(i.metadata=a,a.controllerDatasetLayers&&void 0!==a.controllerDatasetLayers.utilityNetworkLayerId&&null!==a.controllerDatasetLayers.utilityNetworkLayerId){if(a.layers)for(const e of a.layers)i.layerNameLkp[e.id]=e.name;if(a.tables)for(const e of a.tables)i.layerNameLkp[e.id]=e.name;const l=a.controllerDatasetLayers.utilityNetworkLayerId;return i.networkId=l,function(e,t){const i="QUERYDATAELEMTS:"+t.toString()+":"+e;if(null!==n.b.applicationCache){const e=n.b.applicationCache.getLayerInfo(i);if(null!==e)return e}let s=(0,r.L)(e+"/queryDataElements",{method:"post",responseType:"json",query:{layers:JSON.stringify([t.toString()]),f:"json"}}).then((e=>{if(e.data){const t=e.data;if(t.layerDataElements&&t.layerDataElements[0])return t.layerDataElements[0]}throw new Error("Not Found")}));return null!==n.b.applicationCache&&(n.b.applicationCache.setLayerInfo(i,s),s=s.catch((e=>{throw n.b.applicationCache.clearLayerInfo(i),e}))),s}(e,l).then((a=>{if(a){i.queryelem=a,i.queryelem&&i.queryelem.dataElement&&void 0!==i.queryelem.dataElement.schemaGeneration&&(i.unVersion=i.queryelem.dataElement.schemaGeneration),i.lkp={},i.queryelem.dataElement.domainNetworks||(i.queryelem.dataElement.domainNetworks=[]);for(const e of i.queryelem.dataElement.domainNetworks){for(const t of e.edgeSources?e.edgeSources:[]){const e={layerId:t.layerId,sourceId:t.sourceId,className:i.layerNameLkp[t.layerId]?i.layerNameLkp[t.layerId]:null};e.className&&(i.lkp[e.className]=e)}for(const t of e.junctionSources?e.junctionSources:[]){const e={layerId:t.layerId,sourceId:t.sourceId,className:i.layerNameLkp[t.layerId]?i.layerNameLkp[t.layerId]:null};e.className&&(i.lkp[e.className]=e)}}if(i.queryelem.dataElement.terminalConfigurations)for(const e of i.queryelem.dataElement.terminalConfigurations)for(const t of e.terminals)i.terminals.push({terminalId:t.terminalId,terminalName:t.terminalName});return function(e){if(null!==n.b.applicationCache){const t=n.b.applicationCache.getLayerInfo(e);if(null!==t)return t}let t=(0,r.L)(e,{responseType:"json",query:{f:"json"}}).then((e=>{if(e.data){const t=e.data;return(0,s.x)(t)}return(0,s.x)(null)}));return null!==n.b.applicationCache&&(n.b.applicationCache.setLayerInfo(e,t),t=t.catch((t=>{throw n.b.applicationCache.clearLayerInfo(e),t}))),t}(e+"/"+l).then((r=>{if(r.systemLayers&&void 0!==r.systemLayers.associationsTableId&&null!==r.systemLayers.associationsTableId){const s=[];return i.unVersion>=4&&(s.push("STATUS"),s.push("PERCENTALONG")),H(e+"/"+r.systemLayers.associationsTableId.toString(),t,["OBJECTID","FROMNETWORKSOURCEID","TONETWORKSOURCEID","FROMGLOBALID","TOGLOBALID","TOTERMINALID","FROMTERMINALID","ASSOCIATIONTYPE","ISCONTENTVISIBLE","GLOBALID",...s],!1,null,null).then((e=>e.load())).then((e=>i.unVersion>=4?(e=e.filter(o.WhereClause.create("STATUS NOT IN (1, 2, 3, 4, 5, 6, 7, 9, 10, 11, 12, 13, 14, 15, 17, 18, 19, 20, 21, 22, 23, 25, 26, 27, 28, 29, 30, 31, 33, 34, 35, 36, 37, 38, 39, 41, 42, 43, 44, 45, 46, 47, 49, 50, 51, 52, 53, 54, 55, 57, 58, 59, 60, 61, 62,63)",e.getFieldsIndex()))).load():e)).then((e=>({lkp:i.lkp,associations:e,unVersion:i.unVersion,terminals:i.terminals})))}return{associations:null,unVersion:i.unVersion,lkp:null,terminals:[]}}))}return{associations:null,unVersion:i.unVersion,lkp:null,terminals:[]}}))}return{associations:null,unVersion:i.unVersion,lkp:null,terminals:[]}}))}function Y(e,t,i,r=null,s=null,n=!0,a=null,o=null){let l=e.serviceUrl();return l?(l="/"===l.charAt(l.length-1)?l+t.relatedTableId.toString():l+"/"+t.relatedTableId.toString(),H(l,r,s,n,a,o).then((l=>new j({layer:e,relatedLayer:l,relationship:t,objectId:i,spatialReference:r,outFields:s,includeGeometry:n,lrucache:a,interceptor:o})))):null}T.registerAction(),U.registerAction(),O.registerAction(),n.g.registerAction(),G.registerAction();class J extends M{constructor(e,t=null,i=null,r=null){super(),this._map=e,this._overridespref=t,this.lrucache=i,this.interceptor=r,this._instantLayers=[]}makeAndAddFeatureSet(e,t=!0,i=null){const r=W(e,this._overridespref,null===i?["*"]:i,t,this.lrucache,this.interceptor);return this._instantLayers.push({featureset:r,opitem:e,includeGeometry:t,outFields:JSON.stringify(i)}),r}featureSetByName(e,t=!0,i=null){if(void 0!==this._map.loaded&&void 0!==this._map.load&&!1===this._map.loaded)return this._map.load().then((()=>{try{return this.featureSetByName(e,t,i)}catch(e){return(0,s.L)(e)}}));null===i&&(i=["*"]),i=(i=i.slice(0)).sort();const r=JSON.stringify(i);for(let i=0;i<this._instantLayers.length;i++){const s=this._instantLayers[i];if(s.opitem.title===e&&s.includeGeometry===t&&s.outFields===r)return this.resolvePromise(this._instantLayers[i].featureset)}const n=this._map.layers.find((t=>t instanceof f.W&&t.title===e));if(n)return this.resolvePromise(this.makeAndAddFeatureSet(n,t,i));if(this._map.tables){const r=this._map.tables.find((t=>!!(t.title&&t.title===e||t.title&&t.title===e)));if(r){if(r instanceof f.W)return this.resolvePromise(this.makeAndAddFeatureSet(r,t,i));if(r._materializedTable);else{const e=r.outFields?r:{...r,outFields:["*"]};r._materializedTable=new f.W(e)}return r._materializedTable.load().then((()=>this.resolvePromise(this.makeAndAddFeatureSet(r._materializedTable,t,i))))}}return this.resolvePromise(null)}featureSetById(e,t=!0,i=["*"]){if(void 0!==this._map.loaded&&void 0!==this._map.load&&!1===this._map.loaded)return this._map.load().then((()=>{try{return this.featureSetById(e,t,i)}catch(e){return(0,s.L)(e)}}));null===i&&(i=["*"]),i=(i=i.slice(0)).sort();const r=JSON.stringify(i);for(let i=0;i<this._instantLayers.length;i++){const s=this._instantLayers[i];if(s.opitem.id===e&&s.includeGeometry===t&&s.outFields===r)return this.resolvePromise(this._instantLayers[i].featureset)}const n=this._map.layers.find((t=>t instanceof f.W&&t.id===e));if(n)return this.resolvePromise(this.makeAndAddFeatureSet(n,t,i));if(this._map.tables){const r=this._map.tables.find((t=>t.id===e));if(r){if(r instanceof f.W)return this.resolvePromise(this.makeAndAddFeatureSet(r,t,i));if(r._materializedTable);else{const e={...r,outFields:["*"]};r._materializedTable=new f.W(e)}return r._materializedTable.load().then((()=>this.resolvePromise(this.makeAndAddFeatureSet(r._materializedTable,t,i))))}}return this.resolvePromise(null)}}class X extends M{constructor(e,t=null,i=null,r=null){super(),this._url=e,this._overridespref=t,this.lrucache=i,this.interceptor=r,this.metadata=null,this._instantLayers=[]}get url(){return this._url}makeAndAddFeatureSet(e,t=!0,i=null){const r=W(e,this._overridespref,null===i?["*"]:i,t,this.lrucache);return this._instantLayers.push({featureset:r,opitem:e,includeGeometry:t,outFields:JSON.stringify(i)}),r}_loadMetaData(){return Q(this._url).then((e=>(this.metadata=e,e)))}load(){return this._loadMetaData()}clone(){return new X(this._url,this._overridespref,this.lrucache,this.interceptor)}featureSetByName(e,t=!0,i=null){null===i&&(i=["*"]),i=(i=i.slice(0)).sort();const r=JSON.stringify(i);for(let i=0;i<this._instantLayers.length;i++){const s=this._instantLayers[i];if(s.opitem.title===e&&s.includeGeometry===t&&s.outFields===r)return this.resolvePromise(this._instantLayers[i].featureset)}return this._loadMetaData().then((r=>{let s=null;for(const t of r.layers?r.layers:[])t.name===e&&(s=t);if(!s)for(const t of r.tables?r.tables:[])t.name===e&&(s=t);return s?q(this._url+"/"+s.id,["*"]).then((e=>this.makeAndAddFeatureSet(e,t,i))):this.resolvePromise(null)}))}featureSetById(e,t=!0,i=["*"]){null===i&&(i=["*"]),i=(i=i.slice(0)).sort();const r=JSON.stringify(i);e=null!=e?e.toString():"";for(let i=0;i<this._instantLayers.length;i++){const s=this._instantLayers[i];if(s.opitem.id===e&&s.includeGeometry===t&&s.outFields===r)return this.resolvePromise(this._instantLayers[i].featureset)}return this._loadMetaData().then((r=>{let s=null;for(const t of r.layers?r.layers:[])null!==t.id&&void 0!==t.id&&t.id.toString()===e&&(s=t);if(!s)for(const t of r.tables?r.tables:[])null!==t.id&&void 0!==t.id&&t.id.toString()===e&&(s=t);return s?q(this._url+"/"+s.id,["*"]).then((e=>this.makeAndAddFeatureSet(e,t,i))):this.resolvePromise(null)}))}}function $(e,t){return null===e?t:new I.G({url:e.field("url")})}function K(e,t,i){return r.a.findCredential(e.restUrl)?"loaded"===e.loadStatus&&""===t&&e.user&&e.user.sourceJSON&&!1===i?(0,s.x)(e.user.sourceJSON):""===t?(0,r.L)(e.restUrl+"/community/self",{responseType:"json",query:{f:"json",...!1===i?{}:{returnUserLicenseTypeExtensions:!0}}}).then((e=>{if(e.data){const t=e.data;if(t&&t.username)return(0,s.x)(t)}return(0,s.x)(null)})):(0,r.L)(e.restUrl+"/community/users/"+t,{responseType:"json",query:{f:"json"}}).then((e=>{if(e.data){const t=e.data;return t.error?null:(0,s.x)(t)}return(0,s.x)(null)})):(0,s.x)(null)}function ee(e,t,i,r,o,l,h,u=null){if(n.b.applicationCache){const c=n.b.applicationCache.getLayerInfo(e+":"+l.url);if(c)return c.then((e=>{try{const n=new f.W({url:(0,a.a7)(e.url)+"/"+t,outFields:["*"]});return(0,s.x)(W(n,i,r,o,h,u))}catch(e){return(0,s.L)(e)}}),(e=>(0,s.L)(e)))}return(0,s.l)(((s,c)=>{const d=new C.default({id:e,portal:l}).load();n.b.applicationCache&&n.b.applicationCache.setLayerInfo(e+":"+l.url,d),d.then((e=>{try{const n=new f.W({url:(0,a.a7)(e.url)+"/"+t,outFields:["*"]});s(W(n,i,r,o,h,u))}catch(e){c(e)}}),(t=>{n.b.applicationCache&&n.b.applicationCache.clearLayerInfo(e+":"+l.url),c(t)}))}))}var te=Object.freeze({__proto__:null,constructAssociationMetaDataFeatureSetFromUrl:Z,constructFeatureSet:W,constructFeatureSetFromPortalItem:ee,constructFeatureSetFromRelationship:Y,constructFeatureSetFromUrl:H,createFeatureSetCollectionFromMap:function(e,t,i=null,r=null){return new J(e,t,i,r)},createFeatureSetCollectionFromService:function(e,t,i=null,r=null){return new X(e,t,i,r)},getPortal:$,initialiseMetaDataCache:function(){null===n.b.applicationCache&&(n.b.applicationCache=new n.b)},lookupUser:K})},26554:(e,t,i)=>{"use strict";function r(e){const t=e.layer;if("floorInfo"in t&&t.floorInfo){const i=e.view.floors;if(!i||!i.length)return null;const r=i.filter((e=>""!==e)).map((e=>`'${e}'`));r.push("''");const s=t.floorInfo.floorField;return`${s} IN (${r.join(", ")}) OR ${s} IS NULL`}return null}i.d(t,{o:()=>r})},16034:(e,t,i)=>{"use strict";i.d(t,{I:()=>x,T:()=>v,k:()=>b,r:()=>a});var r=i(20215),s=i(91728);const n={LineString:"esriGeometryPolyline",MultiLineString:"esriGeometryPolyline",MultiPoint:"esriGeometryMultipoint",Point:"esriGeometryPoint",Polygon:"esriGeometryPolygon",MultiPolygon:"esriGeometryPolygon"};function a(e){return n[e]}function*o(e){switch(e.type){case"Feature":yield e;break;case"FeatureCollection":for(const t of e.features)t&&(yield t)}}function*l(e){if(!e)return null;switch(e.type){case"Point":yield e.coordinates;break;case"LineString":case"MultiPoint":yield*e.coordinates;break;case"MultiLineString":case"Polygon":for(const t of e.coordinates)yield*t;break;case"MultiPolygon":for(const t of e.coordinates)for(const e of t)yield*e}}function h(e){for(const t of e)if(t.length>2)return!0;return!1}function u(e){let t=0;for(let i=0;i<e.length;i++){const r=e[i],s=e[(i+1)%e.length];t+=r[0]*s[1]-s[0]*r[1]}return t<=0}function c(e){const t=e[0],i=e[e.length-1];return t[0]===i[0]&&t[1]===i[1]&&t[2]===i[2]||e.push(t),e}function d(e,t,i){switch(t.type){case"LineString":return function(e,t,i){return y(e,t.coordinates,i),e}(e,t,i);case"MultiLineString":return function(e,t,i){for(const r of t.coordinates)y(e,r,i);return e}(e,t,i);case"MultiPoint":return function(e,t,i){return y(e,t.coordinates,i),e}(e,t,i);case"MultiPolygon":return function(e,t,i){for(const r of t.coordinates){p(e,r[0],i);for(let t=1;t<r.length;t++)f(e,r[t],i)}return e}(e,t,i);case"Point":return function(e,t,i){return g(e,t.coordinates,i),e}(e,t,i);case"Polygon":return function(e,t,i){const r=t.coordinates;p(e,r[0],i);for(let t=1;t<r.length;t++)f(e,r[t],i);return e}(e,t,i)}}function p(e,t,i){const r=c(t);!function(e){return!u(e)}(r)?y(e,r,i):m(e,r,i)}function f(e,t,i){const r=c(t);!function(e){return u(e)}(r)?y(e,r,i):m(e,r,i)}function y(e,t,i){for(const r of t)g(e,r,i);e.lengths.push(t.length)}function m(e,t,i){for(let r=t.length-1;r>=0;r--)g(e,t[r],i);e.lengths.push(t.length)}function g(e,t,i){const[r,s,n]=t;e.coords.push(r,s),i.hasZ&&e.coords.push(n||0)}function _(e){switch(typeof e){case"string":return"esriFieldTypeString";case"number":return"esriFieldTypeDouble";default:return"unknown"}}function x(e){if(!e)throw new r.s("geojson-layer:empty","GeoJSON data is empty");if("Feature"!==e.type&&"FeatureCollection"!==e.type)throw new r.s("geojson-layer:unsupported-geojson-object","missing or not supported GeoJSON object type",{data:e});const{crs:t}=e;if(!t)return;const i="string"==typeof t?t:"name"===t.type?t.properties.name:"EPSG"===t.type?t.properties.code:null,s=new RegExp(".*(CRS84H?|4326)$","i");if(!i||!s.test(i))throw new r.s("geojson-layer:unsupported-crs","unsupported GeoJSON 'crs' member",{crs:t})}function v(e,t={}){const i=[],r=new Set,s=new Set;let n,u=!1,c=Number.NEGATIVE_INFINITY,d=null,p=!1,{geometryType:f=null}=t,y=!1;for(const t of o(e)){const{geometry:e,properties:o,id:m}=t;if((!e||(f||(f=a(e.type)),a(e.type)===f))&&(u||(u=h(l(e))),p||(p=null!=m,p&&(n=typeof m,"number"===n&&(d=Object.keys(o).filter((e=>o[e]===m))))),p&&"number"===n&&null!=m&&(c=Math.max(c,m),d.length>1?d=d.filter((e=>o[e]===m)):1===d.length&&(d=o[d[0]]===m?d:[])),!y&&o)){let e=!0;for(const t in o){if(r.has(t))continue;const n=o[t];if(null==n){e=!1,s.add(t);continue}const a=_(n);"unknown"!==a?(s.delete(t),r.add(t),i.push({name:t,alias:t,type:a})):s.add(t)}y=e}}const m=d&&1===d.length&&d[0]||null;if(m)for(const e of i)e.name===m&&(e.type="esriFieldTypeOID");return{fields:i,geometryType:f,hasZ:u,maxObjectId:Math.max(0,c),objectIdFieldName:m,objectIdFieldType:n,unknownFields:Array.from(s)}}function b(e,t){return Array.from(function*(e,t={}){const{geometryType:i,objectIdField:r}=t;for(const o of e){var n;const{geometry:e,properties:l,id:h}=o;if(e&&a(e.type)!==i)continue;const u=l||{};let c=null!=(n=u[r])?n:null;r&&null!=h&&!u[r]&&(u[r]=c=h);const p=new s.t(e?d(new s.a,e,t):null,u,null,c);yield p}}(o(e),t))}},19049:(e,t,i)=>{"use strict";i.r(t),i.d(t,{registerFunctions:()=>c});var r=i(80987),s=i(9389),n=i(98548),a=i(20736),o=i(6770),l=i(89710);function h(e){return 0===r.r.indexOf("4.")?n.j.fromExtent(e):new n.j({spatialReference:e.spatialReference,rings:[[[e.xmin,e.ymin],[e.xmin,e.ymax],[e.xmax,e.ymax],[e.xmax,e.ymin],[e.xmin,e.ymin]]]})}function u(e){if((0,s.J)(e,2,2),e[0]instanceof a.p&&e[1]instanceof a.p);else if(e[0]instanceof a.p&&null===e[1]);else if(e[1]instanceof a.p&&null===e[0]);else if(null!==e[0]||null!==e[1])throw new Error("Illegal Argument")}function c(e){"async"===e.mode&&(e.functions.disjoint=function(t,i){return e.standardFunctionAsync(t,i,(function(e,t,i){return u(i=(0,s.G)(i)),null===i[0]||null===i[1]||(0,o.S)(i[0],i[1])}))},e.functions.intersects=function(t,i){return e.standardFunctionAsync(t,i,(function(e,t,i){return u(i=(0,s.G)(i)),null!==i[0]&&null!==i[1]&&(0,o.g)(i[0],i[1])}))},e.functions.touches=function(t,i){return e.standardFunctionAsync(t,i,(function(e,t,i){return u(i=(0,s.G)(i)),null!==i[0]&&null!==i[1]&&(0,o.A)(i[0],i[1])}))},e.functions.crosses=function(t,i){return e.standardFunctionAsync(t,i,(function(e,t,i){return u(i=(0,s.G)(i)),null!==i[0]&&null!==i[1]&&(0,o.w)(i[0],i[1])}))},e.functions.within=function(t,i){return e.standardFunctionAsync(t,i,(function(e,t,i){return u(i=(0,s.G)(i)),null!==i[0]&&null!==i[1]&&(0,o.x)(i[0],i[1])}))},e.functions.contains=function(t,i){return e.standardFunctionAsync(t,i,(function(e,t,i){return u(i=(0,s.G)(i)),null!==i[0]&&null!==i[1]&&(0,o.p)(i[0],i[1])}))},e.functions.overlaps=function(t,i){return e.standardFunctionAsync(t,i,(function(e,t,i){return u(i=(0,s.G)(i)),null!==i[0]&&null!==i[1]&&(0,o.O)(i[0],i[1])}))},e.functions.equals=function(t,i){return e.standardFunctionAsync(t,i,(function(e,t,i){return(0,s.J)(i,2,2),i[0]===i[1]||(i[0]instanceof a.p&&i[1]instanceof a.p?(0,o.d)(i[0],i[1]):!(!(0,s.n)(i[0])||!(0,s.n)(i[1]))&&i[0].getTime()===i[1].getTime())}))},e.functions.relate=function(t,i){return e.standardFunctionAsync(t,i,(function(e,t,i){if(i=(0,s.G)(i),(0,s.J)(i,3,3),i[0]instanceof a.p&&i[1]instanceof a.p)return(0,o.h)(i[0],i[1],(0,s.K)(i[2]));if(i[0]instanceof a.p&&null===i[1])return!1;if(i[1]instanceof a.p&&null===i[0])return!1;if(null===i[0]&&null===i[1])return!1;throw new Error("Illegal Argument")}))},e.functions.intersection=function(t,i){return e.standardFunctionAsync(t,i,(function(e,t,i){return u(i=(0,s.G)(i)),null===i[0]||null===i[1]?null:(0,o.j)(i[0],i[1])}))},e.functions.union=function(t,i){return e.standardFunctionAsync(t,i,(function(e,i,r){const n=[];if(0===(r=(0,s.G)(r)).length)throw new Error("Function called with wrong number of Parameters");if(1===r.length)if((0,s.Z)(r[0])){const e=(0,s.G)(r[0]);for(let t=0;t<e.length;t++)if(null!==e[t]){if(!(e[t]instanceof a.p))throw new Error("Illegal Argument");n.push(e[t])}}else{if(!(0,s.E)(r[0])){if(r[0]instanceof a.p)return(0,s.v)((0,s.H)(r[0]),t.spatialReference);if(null===r[0])return null;throw new Error("Illegal Argument")}{const e=(0,s.G)(r[0].toArray());for(let t=0;t<e.length;t++)if(null!==e[t]){if(!(e[t]instanceof a.p))throw new Error("Illegal Argument");n.push(e[t])}}}else for(let e=0;e<r.length;e++)if(null!==r[e]){if(!(r[e]instanceof a.p))throw new Error("Illegal Argument");n.push(r[e])}return 0===n.length?null:(0,o.k)(n)}))},e.functions.difference=function(t,i){return e.standardFunctionAsync(t,i,(function(e,t,i){return u(i=(0,s.G)(i)),null!==i[0]&&null===i[1]?(0,s.H)(i[0]):null===i[0]?null:(0,o.R)(i[0],i[1])}))},e.functions.symmetricdifference=function(t,i){return e.standardFunctionAsync(t,i,(function(e,t,i){return u(i=(0,s.G)(i)),null===i[0]&&null===i[1]?null:null===i[0]?(0,s.H)(i[1]):null===i[1]?(0,s.H)(i[0]):(0,o.E)(i[0],i[1])}))},e.functions.clip=function(t,i){return e.standardFunctionAsync(t,i,(function(e,t,i){if(i=(0,s.G)(i),(0,s.J)(i,2,2),!(i[1]instanceof n.M)&&null!==i[1])throw new Error("Illegal Argument");if(null===i[0])return null;if(!(i[0]instanceof a.p))throw new Error("Illegal Argument");return null===i[1]?null:(0,o.l)(i[0],i[1])}))},e.functions.cut=function(t,i){return e.standardFunctionAsync(t,i,(function(e,t,i){if(i=(0,s.G)(i),(0,s.J)(i,2,2),!(i[1]instanceof n.m)&&null!==i[1])throw new Error("Illegal Argument");if(null===i[0])return[];if(!(i[0]instanceof a.p))throw new Error("Illegal Argument");return null===i[1]?[(0,s.H)(i[0])]:(0,o.y)(i[0],i[1])}))},e.functions.area=function(t,i){return e.standardFunctionAsync(t,i,(function(e,i,r){if((0,s.J)(r,1,2),null===(r=(0,s.G)(r))[0])return 0;if((0,s.l)(r[0]))return r[0].sumArea((0,s.L)((0,s.M)(r[1],-1)),!1,t.abortSignal).then((e=>{if(t.abortSignal.aborted)throw new Error("Operation has been cancelled.");return e}));if((0,s.Z)(r[0])||(0,s.E)(r[0])){const e=(0,s.Q)(r[0],t.spatialReference);return null===e?0:(0,o.W)(e,(0,s.L)((0,s.M)(r[1],-1)))}if(!(r[0]instanceof a.p))throw new Error("Illegal Argument");return(0,o.W)(r[0],(0,s.L)((0,s.M)(r[1],-1)))}))},e.functions.areageodetic=function(t,i){return e.standardFunctionAsync(t,i,(function(e,i,r){if((0,s.J)(r,1,2),null===(r=(0,s.G)(r))[0])return 0;if((0,s.l)(r[0]))return r[0].sumArea((0,s.L)((0,s.M)(r[1],-1)),!0,t.abortSignal).then((e=>{if(t.abortSignal.aborted)throw new Error("Operation has been cancelled.");return e}));if((0,s.Z)(r[0])||(0,s.E)(r[0])){const e=(0,s.Q)(r[0],t.spatialReference);return null===e?0:(0,o.K)(e,(0,s.L)((0,s.M)(r[1],-1)))}if(!(r[0]instanceof a.p))throw new Error("Illegal Argument");return(0,o.K)(r[0],(0,s.L)((0,s.M)(r[1],-1)))}))},e.functions.length=function(t,i){return e.standardFunctionAsync(t,i,(function(e,i,r){if((0,s.J)(r,1,2),null===(r=(0,s.G)(r))[0])return 0;if((0,s.l)(r[0]))return r[0].sumLength((0,s.R)((0,s.M)(r[1],-1)),!1,t.abortSignal).then((e=>{if(t.abortSignal.aborted)throw new Error("Operation has been cancelled.");return e}));if((0,s.Z)(r[0])||(0,s.E)(r[0])){const e=(0,s.U)(r[0],t.spatialReference);return null===e?0:(0,o.F)(e,(0,s.R)((0,s.M)(r[1],-1)))}if(!(r[0]instanceof a.p))throw new Error("Illegal Argument");return(0,o.F)(r[0],(0,s.R)((0,s.M)(r[1],-1)))}))},e.functions.lengthgeodetic=function(t,i){return e.standardFunctionAsync(t,i,(function(e,i,r){if((0,s.J)(r,1,2),null===(r=(0,s.G)(r))[0])return 0;if((0,s.l)(r[0]))return r[0].sumLength((0,s.R)((0,s.M)(r[1],-1)),!0,t.abortSignal).then((e=>{if(t.abortSignal.aborted)throw new Error("Operation has been cancelled.");return e}));if((0,s.Z)(r[0])||(0,s.E)(r[0])){const e=(0,s.U)(r[0],t.spatialReference);return null===e?0:(0,o.M)(e,(0,s.R)((0,s.M)(r[1],-1)))}if(!(r[0]instanceof a.p))throw new Error("Illegal Argument");return(0,o.M)(r[0],(0,s.R)((0,s.M)(r[1],-1)))}))},e.functions.distance=function(t,i){return e.standardFunctionAsync(t,i,(function(e,i,r){r=(0,s.G)(r),(0,s.J)(r,2,3);let n=r[0];((0,s.Z)(r[0])||(0,s.E)(r[0]))&&(n=(0,s.V)(r[0],t.spatialReference));let l=r[1];if(((0,s.Z)(r[1])||(0,s.E)(r[1]))&&(l=(0,s.V)(r[1],t.spatialReference)),!(n instanceof a.p))throw new Error("Illegal Argument");if(!(l instanceof a.p))throw new Error("Illegal Argument");return(0,o.m)(n,l,(0,s.R)((0,s.M)(r[2],-1)))}))},e.functions.distancegeodetic=function(t,i){return e.standardFunctionAsync(t,i,(function(e,t,i){i=(0,s.G)(i),(0,s.J)(i,2,3);const r=i[0],l=i[1];if(!(r instanceof a.b))throw new Error("Illegal Argument");if(!(l instanceof a.b))throw new Error("Illegal Argument");const h=new n.m({paths:[],spatialReference:r.spatialReference});return h.addPath([r,l]),(0,o.M)(h,(0,s.R)((0,s.M)(i[2],-1)))}))},e.functions.densify=function(t,i){return e.standardFunctionAsync(t,i,(function(e,t,i){if(i=(0,s.G)(i),(0,s.J)(i,2,3),null===i[0])return null;if(!(i[0]instanceof a.p))throw new Error("Illegal Argument");const r=(0,s.X)(i[1]);if(isNaN(r))throw new Error("Illegal Argument");if(r<=0)throw new Error("Illegal Argument");return i[0]instanceof n.j||i[0]instanceof n.m?(0,o.P)(i[0],r,(0,s.R)((0,s.M)(i[2],-1))):i[0]instanceof n.M?(0,o.P)(h(i[0]),r,(0,s.R)((0,s.M)(i[2],-1))):i[0]}))},e.functions.densifygeodetic=function(t,i){return e.standardFunctionAsync(t,i,(function(e,t,i){if(i=(0,s.G)(i),(0,s.J)(i,2,3),null===i[0])return null;if(!(i[0]instanceof a.p))throw new Error("Illegal Argument");const r=(0,s.X)(i[1]);if(isNaN(r))throw new Error("Illegal Argument");if(r<=0)throw new Error("Illegal Argument");return i[0]instanceof n.j||i[0]instanceof n.m?(0,o.U)(i[0],r,(0,s.R)((0,s.M)(i[2],-1))):i[0]instanceof n.M?(0,o.U)(h(i[0]),r,(0,s.R)((0,s.M)(i[2],-1))):i[0]}))},e.functions.generalize=function(t,i){return e.standardFunctionAsync(t,i,(function(e,t,i){if(i=(0,s.G)(i),(0,s.J)(i,2,4),null===i[0])return null;if(!(i[0]instanceof a.p))throw new Error("Illegal Argument");const r=(0,s.X)(i[1]);if(isNaN(r))throw new Error("Illegal Argument");return(0,o.G)(i[0],r,(0,s.W)((0,s.M)(i[2],!0)),(0,s.R)((0,s.M)(i[3],-1)))}))},e.functions.buffer=function(t,i){return e.standardFunctionAsync(t,i,(function(e,t,i){if(i=(0,s.G)(i),(0,s.J)(i,2,3),null===i[0])return null;if(!(i[0]instanceof a.p))throw new Error("Illegal Argument");const r=(0,s.X)(i[1]);if(isNaN(r))throw new Error("Illegal Argument");return 0===r?(0,s.H)(i[0]):(0,o.V)(i[0],r,(0,s.R)((0,s.M)(i[2],-1)))}))},e.functions.buffergeodetic=function(t,i){return e.standardFunctionAsync(t,i,(function(e,t,i){if(i=(0,s.G)(i),(0,s.J)(i,2,3),null===i[0])return null;if(!(i[0]instanceof a.p))throw new Error("Illegal Argument");const r=(0,s.X)(i[1]);if(isNaN(r))throw new Error("Illegal Argument");return 0===r?(0,s.H)(i[0]):(0,o.b)(i[0],r,(0,s.R)((0,s.M)(i[2],-1)))}))},e.functions.offset=function(t,i){return e.standardFunctionAsync(t,i,(function(e,t,i){if(i=(0,s.G)(i),(0,s.J)(i,2,6),null===i[0])return null;if(!(i[0]instanceof n.j||i[0]instanceof n.m))throw new Error("Illegal Argument");const r=(0,s.X)(i[1]);if(isNaN(r))throw new Error("Illegal Argument");const a=(0,s.X)((0,s.M)(i[4],10));if(isNaN(a))throw new Error("Illegal Argument");const l=(0,s.X)((0,s.M)(i[5],0));if(isNaN(l))throw new Error("Illegal Argument");return(0,o.I)(i[0],r,(0,s.R)((0,s.M)(i[2],-1)),(0,s.K)((0,s.M)(i[3],"round")).toLowerCase(),a,l)}))},e.functions.rotate=function(t,i){return e.standardFunctionAsync(t,i,(function(e,t,i){i=(0,s.G)(i),(0,s.J)(i,2,3);let r=i[0];if(null===r)return null;if(!(r instanceof a.p))throw new Error("Illegal Argument");r instanceof n.M&&(r=n.j.fromExtent(r));const l=(0,s.X)(i[1]);if(isNaN(l))throw new Error("Illegal Argument");const h=(0,s.M)(i[2],null);if(null===h)return(0,o.q)(r,l);if(h instanceof a.b)return(0,o.q)(r,l,h);throw new Error("Illegal Argument")}))},e.functions.centroid=function(t,i){return e.standardFunctionAsync(t,i,(function(e,i,r){if(r=(0,s.G)(r),(0,s.J)(r,1,1),null===r[0])return null;let o=r[0];if(((0,s.Z)(r[0])||(0,s.E)(r[0]))&&(o=(0,s.V)(r[0],t.spatialReference)),null===o)return null;if(!(o instanceof a.p))throw new Error("Illegal Argument");return o instanceof a.b?(0,s.v)((0,s.H)(r[0]),t.spatialReference):o instanceof n.j?o.centroid:o instanceof n.m?(0,s.Y)(o):o instanceof n.u?(0,s.$)(o):o instanceof n.M?o.center:null}))},e.functions.multiparttosinglepart=function(t,i){return e.standardFunctionAsync(t,i,(function(e,i,r){r=(0,s.G)(r),(0,s.J)(r,1,1);const h=[];if(null===r[0])return null;if(!(r[0]instanceof a.p))throw new Error("Illegal Argument");return r[0]instanceof a.b||r[0]instanceof n.M?[(0,s.v)((0,s.H)(r[0]),t.spatialReference)]:(0,o.J)(r[0]).then((e=>{if(e instanceof n.j){const t=[],i=[];for(let r=0;r<e.rings.length;r++)if(e.isClockwise(e.rings[r])){const i=(0,l.p)({rings:[e.rings[r]],hasZ:!0===e.hasZ,hazM:!0===e.hasM,spatialReference:e.spatialReference.toJSON()});t.push(i)}else i.push({ring:e.rings[r],pt:e.getPoint(r,0)});for(let e=0;e<i.length;e++)for(let r=0;r<t.length;r++)if(t[r].contains(i[e].pt)){t[r].addRing(i[e].ring);break}return t}if(e instanceof n.m){const t=[];for(let i=0;i<e.paths.length;i++){const r=(0,l.p)({paths:[e.paths[i]],hasZ:!0===e.hasZ,hazM:!0===e.hasM,spatialReference:e.spatialReference.toJSON()});t.push(r)}return t}if(r[0]instanceof n.u){const e=(0,s.v)((0,s.H)(r[0]),t.spatialReference);for(let t=0;t<e.points.length;t++)h.push(e.getPoint(t));return h}return null}))}))},e.functions.issimple=function(t,i){return e.standardFunctionAsync(t,i,(function(e,t,i){if(i=(0,s.G)(i),(0,s.J)(i,1,1),null===i[0])return!0;if(!(i[0]instanceof a.p))throw new Error("Illegal Argument");return(0,o.v)(i[0])}))},e.functions.simplify=function(t,i){return e.standardFunctionAsync(t,i,(function(e,t,i){if(i=(0,s.G)(i),(0,s.J)(i,1,1),null===i[0])return null;if(!(i[0]instanceof a.p))throw new Error("Illegal Argument");return(0,o.J)(i[0])}))})}i(88903),i(80219),i(92858),i(78155),i(20215),i(31531),i(1598),i(3621),i(47365),i(29126),i(4169),i(52957),i(67079),i(29831),i(90258),i(26779),i(63358),i(6585)},13263:(e,t,i)=>{"use strict";i.r(t),i.d(t,{buffer:()=>T,clip:()=>o,contains:()=>h,convexHull:()=>b,crosses:()=>u,cut:()=>l,densify:()=>k,difference:()=>w,disjoint:()=>m,distance:()=>c,equals:()=>d,extendedSpatialReferenceInfo:()=>a,flipHorizontal:()=>D,flipVertical:()=>N,generalize:()=>O,geodesicArea:()=>z,geodesicBuffer:()=>E,geodesicDensify:()=>V,geodesicLength:()=>B,intersect:()=>I,intersects:()=>p,isSimple:()=>x,nearestCoordinate:()=>F,nearestVertex:()=>A,nearestVertices:()=>R,offset:()=>M,overlaps:()=>g,planarArea:()=>U,planarLength:()=>G,relate:()=>_,rotate:()=>L,simplify:()=>v,symmetricDifference:()=>S,touches:()=>f,union:()=>C,within:()=>y});var r=i(15052),s=i(43508);function n(e){return Array.isArray(e)?e[0].spatialReference:e&&e.spatialReference}function a(e){return r.G.extendedSpatialReferenceInfo(e)}function o(e,t){return r.G.clip(s.hydratedAdapter,n(e),e,t)}function l(e,t){return r.G.cut(s.hydratedAdapter,n(e),e,t)}function h(e,t){return r.G.contains(s.hydratedAdapter,n(e),e,t)}function u(e,t){return r.G.crosses(s.hydratedAdapter,n(e),e,t)}function c(e,t,i){return r.G.distance(s.hydratedAdapter,n(e),e,t,i)}function d(e,t){return r.G.equals(s.hydratedAdapter,n(e),e,t)}function p(e,t){return r.G.intersects(s.hydratedAdapter,n(e),e,t)}function f(e,t){return r.G.touches(s.hydratedAdapter,n(e),e,t)}function y(e,t){return r.G.within(s.hydratedAdapter,n(e),e,t)}function m(e,t){return r.G.disjoint(s.hydratedAdapter,n(e),e,t)}function g(e,t){return r.G.overlaps(s.hydratedAdapter,n(e),e,t)}function _(e,t,i){return r.G.relate(s.hydratedAdapter,n(e),e,t,i)}function x(e){return r.G.isSimple(s.hydratedAdapter,n(e),e)}function v(e){return r.G.simplify(s.hydratedAdapter,n(e),e)}function b(e,t=!1){return r.G.convexHull(s.hydratedAdapter,n(e),e,t)}function w(e,t){return r.G.difference(s.hydratedAdapter,n(e),e,t)}function S(e,t){return r.G.symmetricDifference(s.hydratedAdapter,n(e),e,t)}function I(e,t){return r.G.intersect(s.hydratedAdapter,n(e),e,t)}function C(e,t=null){return r.G.union(s.hydratedAdapter,n(e),e,t)}function M(e,t,i,a,o,l){return r.G.offset(s.hydratedAdapter,n(e),e,t,i,a,o,l)}function T(e,t,i,a=!1){return r.G.buffer(s.hydratedAdapter,n(e),e,t,i,a)}function E(e,t,i,a,o,l){return r.G.geodesicBuffer(s.hydratedAdapter,n(e),e,t,i,a,o,l)}function F(e,t,i=!0){return r.G.nearestCoordinate(s.hydratedAdapter,n(e),e,t,i)}function A(e,t){return r.G.nearestVertex(s.hydratedAdapter,n(e),e,t)}function R(e,t,i,a){return r.G.nearestVertices(s.hydratedAdapter,n(e),e,t,i,a)}function P(e){return"xmin"in e?"center"in e?e.center:null:"x"in e?e:"extent"in e?e.extent.center:null}function L(e,t,i){var s;if(null==e)throw new Error("Illegal Argument Exception");const n=e.spatialReference;if(null==(i=null!=(s=i)?s:P(e)))throw new Error("Illegal Argument Exception");const a=e.constructor.fromJSON(r.G.rotate(e,t,i));return a.spatialReference=n,a}function D(e,t){var i;if(null==e)throw new Error("Illegal Argument Exception");const s=e.spatialReference;if(null==(t=null!=(i=t)?i:P(e)))throw new Error("Illegal Argument Exception");const n=e.constructor.fromJSON(r.G.flipHorizontal(e,t));return n.spatialReference=s,n}function N(e,t){var i;if(null==e)throw new Error("Illegal Argument Exception");const s=e.spatialReference;if(null==(t=null!=(i=t)?i:P(e)))throw new Error("Illegal Argument Exception");const n=e.constructor.fromJSON(r.G.flipVertical(e,t));return n.spatialReference=s,n}function O(e,t,i,a){return r.G.generalize(s.hydratedAdapter,n(e),e,t,i,a)}function k(e,t,i){return r.G.densify(s.hydratedAdapter,n(e),e,t,i)}function V(e,t,i,a=0){return r.G.geodesicDensify(s.hydratedAdapter,n(e),e,t,i,a)}function U(e,t){return r.G.planarArea(s.hydratedAdapter,n(e),e,t)}function G(e,t){return r.G.planarLength(s.hydratedAdapter,n(e),e,t)}function z(e,t,i){return r.G.geodesicArea(s.hydratedAdapter,n(e),e,t,i)}function B(e,t,i){return r.G.geodesicLength(s.hydratedAdapter,n(e),e,t,i)}i(98548),i(78155),i(80219),i(88903),i(20215),i(20736),i(4169),i(92858)},6770:(e,t,i)=>{"use strict";i.d(t,{A:()=>g,E:()=>C,F:()=>O,G:()=>P,I:()=>E,J:()=>S,K:()=>k,M:()=>V,O:()=>v,P:()=>L,R:()=>I,S:()=>x,U:()=>D,V:()=>F,W:()=>N,b:()=>A,d:()=>y,g:()=>m,h:()=>b,j:()=>M,k:()=>T,l:()=>u,m:()=>f,p:()=>d,q:()=>R,v:()=>w,w:()=>p,x:()=>_,y:()=>c}),i(80987);var r=i(26779),s=(i(20736),i(89710));function n(e){var t;return Array.isArray(e)?null==(t=e[0])?void 0:t.spatialReference:null==e?void 0:e.spatialReference}function a(e){return e?Array.isArray(e)?e.map(a):e.toJSON?e.toJSON():e:e}function o(e){return Array.isArray(e)?e.map((e=>(0,s.p)(e))):(0,s.p)(e)}let l;async function h(e,t){return(await async function(){return l||(l=(0,r.p)("geometryEngineWorker",{strategy:"distributed"})),l}()).invoke("executeGEOperation",{operation:e,parameters:a(t)})}async function u(e,t){return o(await h("clip",[n(e),e,t]))}async function c(e,t){return o(await h("cut",[n(e),e,t]))}function d(e,t){return h("contains",[n(e),e,t])}function p(e,t){return h("crosses",[n(e),e,t])}function f(e,t,i){return h("distance",[n(e),e,t,i])}function y(e,t){return h("equals",[n(e),e,t])}function m(e,t){return h("intersects",[n(e),e,t])}function g(e,t){return h("touches",[n(e),e,t])}function _(e,t){return h("within",[n(e),e,t])}function x(e,t){return h("disjoint",[n(e),e,t])}function v(e,t){return h("overlaps",[n(e),e,t])}function b(e,t,i){return h("relate",[n(e),e,t,i])}function w(e){return h("isSimple",[n(e),e])}async function S(e){return o(await h("simplify",[n(e),e]))}async function I(e,t){return o(await h("difference",[n(e),e,t]))}async function C(e,t){return o(await h("symmetricDifference",[n(e),e,t]))}async function M(e,t){return o(await h("intersect",[n(e),e,t]))}async function T(e,t=null){const i=function(e,t){let i;return Array.isArray(e)?i=e:(i=[],i.push(e),null!=t&&i.push(t)),i}(e,t);return o(await h("union",[n(i),i]))}async function E(e,t,i,r,s,a){return o(await h("offset",[n(e),e,t,i,r,s,a]))}async function F(e,t,i,r=!1){const s=[n(e),e,t,i,r];return o(await h("buffer",s))}async function A(e,t,i,r,s,a){const l=[n(e),e,t,i,r,s,a];return o(await h("geodesicBuffer",l))}async function R(e,t,i){var r;if(null==e)throw new Error("Illegal Argument Exception");const s=e.spatialReference;i=null!=(r=i)?r:function(e){return"xmin"in e?e.center:"x"in e?e:e.extent.center}(e);const n=e.constructor.fromJSON(await h("rotate",[s,e,t,i]));return n.spatialReference=s,n}async function P(e,t,i,r){return o(await h("generalize",[n(e),e,t,i,r]))}async function L(e,t,i){return o(await h("densify",[n(e),e,t,i]))}async function D(e,t,i,r=0){return o(await h("geodesicDensify",[n(e),e,t,i,r]))}function N(e,t){return h("planarArea",[n(e),e,t])}function O(e,t){return h("planarLength",[n(e),e,t])}function k(e,t,i){return h("geodesicArea",[n(e),e,t,i])}function V(e,t,i){return h("geodesicLength",[n(e),e,t,i])}},30032:(e,t,i)=>{"use strict";i.d(t,{A:()=>S,B:()=>D,C:()=>U,D:()=>A,E:()=>I,G:()=>G,H:()=>R,I:()=>E,L:()=>N,R:()=>P,S:()=>O,V:()=>F,_:()=>k,a:()=>c,b:()=>L,c:()=>d,d:()=>g,f:()=>p,g:()=>m,h:()=>x,i:()=>o,j:()=>C,k:()=>z,l:()=>f,m:()=>_,o:()=>u,p:()=>y,q:()=>V,r:()=>n,s:()=>l,t:()=>a,u:()=>h,v:()=>M,w:()=>w,x:()=>b,y:()=>v,z:()=>T});var r=i(15052),s=i(26882);function n(e){return r.G.extendedSpatialReferenceInfo(e)}function a(e,t,i){return r.G.clip(s.t,e,t,i)}function o(e,t,i){return r.G.cut(s.t,e,t,i)}function l(e,t,i){return r.G.contains(s.t,e,t,i)}function h(e,t,i){return r.G.crosses(s.t,e,t,i)}function u(e,t,i,n){return r.G.distance(s.t,e,t,i,n)}function c(e,t,i){return r.G.equals(s.t,e,t,i)}function d(e,t,i){return r.G.intersects(s.t,e,t,i)}function p(e,t,i){return r.G.touches(s.t,e,t,i)}function f(e,t,i){return r.G.within(s.t,e,t,i)}function y(e,t,i){return r.G.disjoint(s.t,e,t,i)}function m(e,t,i){return r.G.overlaps(s.t,e,t,i)}function g(e,t,i,n){return r.G.relate(s.t,e,t,i,n)}function _(e,t){return r.G.isSimple(s.t,e,t)}function x(e,t){return r.G.simplify(s.t,e,t)}function v(e,t,i=!1){return r.G.convexHull(s.t,e,t,i)}function b(e,t,i){return r.G.difference(s.t,e,t,i)}function w(e,t,i){return r.G.symmetricDifference(s.t,e,t,i)}function S(e,t,i){return r.G.intersect(s.t,e,t,i)}function I(e,t,i=null){return r.G.union(s.t,e,t,i)}function C(e,t,i,n,a,o,l){return r.G.offset(s.t,e,t,i,n,a,o,l)}function M(e,t,i,n,a=!1){return r.G.buffer(s.t,e,t,i,n,a)}function T(e,t,i,n,a,o,l){return r.G.geodesicBuffer(s.t,e,t,i,n,a,o,l)}function E(e,t,i,n=!0){return r.G.nearestCoordinate(s.t,e,t,i,n)}function F(e,t,i){return r.G.nearestVertex(s.t,e,t,i)}function A(e,t,i,n,a){return r.G.nearestVertices(s.t,e,t,i,n,a)}function R(e,t,i,s){if(null==t||null==s)throw new Error("Illegal Argument Exception");const n=r.G.rotate(t,i,s);return n.spatialReference=e,n}function P(e,t,i){if(null==t||null==i)throw new Error("Illegal Argument Exception");const s=r.G.flipHorizontal(t,i);return s.spatialReference=e,s}function L(e,t,i){if(null==t||null==i)throw new Error("Illegal Argument Exception");const s=r.G.flipVertical(t,i);return s.spatialReference=e,s}function D(e,t,i,n,a){return r.G.generalize(s.t,e,t,i,n,a)}function N(e,t,i,n){return r.G.densify(s.t,e,t,i,n)}function O(e,t,i,n,a=0){return r.G.geodesicDensify(s.t,e,t,i,n,a)}function k(e,t,i){return r.G.planarArea(s.t,e,t,i)}function V(e,t,i){return r.G.planarLength(s.t,e,t,i)}function U(e,t,i,n){return r.G.geodesicArea(s.t,e,t,i,n)}function G(e,t,i,n){return r.G.geodesicLength(s.t,e,t,i,n)}var z=Object.freeze({__proto__:null,extendedSpatialReferenceInfo:n,clip:a,cut:o,contains:l,crosses:h,distance:u,equals:c,intersects:d,touches:p,within:f,disjoint:y,overlaps:m,relate:g,isSimple:_,simplify:x,convexHull:v,difference:b,symmetricDifference:w,intersect:S,union:I,offset:C,buffer:M,geodesicBuffer:T,nearestCoordinate:E,nearestVertex:F,nearestVertices:A,rotate:R,flipHorizontal:P,flipVertical:L,generalize:D,densify:N,geodesicDensify:O,planarArea:k,planarLength:V,geodesicArea:U,geodesicLength:G})},36154:(e,t,i)=>{"use strict";i.d(t,{M:()=>R,O:()=>M,P:()=>P,_:()=>F,a:()=>m,b:()=>v,c:()=>g,k:()=>A,q:()=>_,r:()=>T,v:()=>x,x:()=>E}),i(33807);var r=i(80219),s=i(65352),n=i(62654),a=i(93242),o=i(71542),l=i(95186),h=i(7571),u=i(78155),c=i(88903),d=i(60816),p=i(20736),f=i(65311),y=i(32892);function m(e=b){return[e[0],e[1],e[2],e[3]]}function g(e,t,i=m()){return(0,d.h)(i,e),i[3]=t,i}function _(e,t,i=m()){return(0,n.A)(w,e,v(e)),(0,n.A)(S,t,v(t)),(0,n.P)(w,S,w),function(e,t){return e[3]=t,e}(i,(0,d.N)((0,n.I)(i,w)))}function x(e){return e}function v(e){return(0,d.g)(e[3])}const b=[0,0,1,0],w=(0,n.a)(),S=(0,n.a)();var I;m();let C=I=class extends u.a{constructor(e){super(e),this.origin=(0,d.n)(),this.translation=(0,d.n)(),this.rotation=m(),this.scale=(0,d.i)(1,1,1),this.geographic=!0}get localMatrix(){const e=(0,o.e)();return(0,a.i)(e,e,this.scale),(0,a.f)(e,e,v(this.rotation),this.rotation),(0,a.c)(e,e,this.translation),e}get localMatrixInverse(){return(0,a.h)((0,o.e)(),this.localMatrix)}applyLocal(e,t){return(0,d.I)(t,e,this.localMatrix)}applyLocalInverse(e,t){return(0,d.I)(t,e,this.localMatrixInverse)}project(e,t){const i=new Float64Array(e.length),r=f.T.fromTypedArray(i),n=f.T.fromTypedArray(e);if(this.geographic){const e=(0,s.A)((0,s.p)(t)),l=(0,o.e)();return(0,h.S)(t,this.origin,l,e),(0,a.e)(l,l,this.localMatrix),(0,o.b)(r,n,l),(0,h.x)(i,e,0,i,t,0,i.length/3),i}const{localMatrix:l,origin:u}=this;(0,a.C)(l,o.a)?(0,o.c)(r,n):(0,o.b)(r,n,l);for(let e=0;e<i.length;e+=3)i[e+0]+=u[0],i[e+1]+=u[1],i[e+2]+=u[2];return i}getOriginPoint(e){const[t,i,r]=this.origin;return new p.b({x:t,y:i,z:r,spatialReference:e})}equals(e){return(0,r.r)(e)&&this.geographic===e.geographic&&(0,d.F)(this.origin,e.origin)&&(0,a.B)(this.localMatrix,e.localMatrix)}clone(){const e={origin:(0,d.k)(this.origin),translation:(0,d.k)(this.translation),rotation:m(this.rotation),scale:(0,d.k)(this.scale),geographic:this.geographic};return new I(e)}};(0,u.e)([(0,c.y)({type:[Number],nonNullable:!0,json:{write:!0}})],C.prototype,"origin",void 0),(0,u.e)([(0,c.y)({type:[Number],nonNullable:!0,json:{write:!0}})],C.prototype,"translation",void 0),(0,u.e)([(0,c.y)({type:[Number],nonNullable:!0,json:{write:!0}})],C.prototype,"rotation",void 0),(0,u.e)([(0,c.y)({type:[Number],nonNullable:!0,json:{write:!0}})],C.prototype,"scale",void 0),(0,u.e)([(0,c.y)({type:Boolean,nonNullable:!0,json:{write:!0}})],C.prototype,"geographic",void 0),(0,u.e)([(0,c.y)()],C.prototype,"localMatrix",null),(0,u.e)([(0,c.y)()],C.prototype,"localMatrixInverse",null),C=I=(0,u.e)([(0,c.n)("esri.geometry.support.MeshTransform")],C);var M=C;function T(e,t){var i;return e.isGeographic||e.isWebMercator&&(null==(i=null==t?void 0:t.geographic)||i)}function E(e,t,i){return T(t.spatialReference,i)?function(e,t,i){const r=t.spatialReference,s=k(t,i,z),n=new Float64Array(e.position.length),a=function(e,t,i,r){(0,o.b)(f.T.fromTypedArray(r),f.T.fromTypedArray(e),t);const s=new Float64Array(e.length);return(0,y.M)(r,s,i)}(e.position,s,r,n),h=(0,l.j)(j,s);return{position:a,normal:L(a,n,e.normal,h,r),tangent:D(a,n,e.tangent,h,r)}}(e,t,i):function(e,t,i){const r=new Float64Array(e.position.length),s=e.position,n=t.x,a=t.y,o=t.z||0,{horizontal:l,vertical:h}=G(i?i.unit:null,t.spatialReference);for(let e=0;e<s.length;e+=3)r[e+0]=s[e+0]*l+n,r[e+1]=s[e+1]*l+a,r[e+2]=s[e+2]*h+o;return{position:r,normal:e.normal,tangent:e.tangent}}(e,t,i)}function F(e,t,i){const{position:s,normal:n,tangent:a}=e;if((0,r.t)(t))return{position:s,normal:n,tangent:a};const o=t.localMatrix;return E({position:(0,y.V)(s,new Float64Array(s.length),o),normal:(0,r.r)(n)?(0,y.k)(n,new Float32Array(n.length),o):null,tangent:(0,r.r)(a)?(0,y.L)(a,new Float32Array(a.length),o):null},t.getOriginPoint(i),{geographic:t.geographic})}function A(e,t,i){if(null!=i&&i.useTransform){var r;const{position:s,normal:n,tangent:a}=e;return{vertexAttributes:{position:s,normal:n,tangent:a},transform:new M({origin:[t.x,t.y,null!=(r=t.z)?r:0],geographic:T(t.spatialReference,i)})}}return{vertexAttributes:E(e,t,i),transform:null}}function R(e,t,i){return T(t.spatialReference,i)?O(e,t,i):N(e,t,i)}function P(e,t,i,s){if((0,r.t)(t))return R(e,i,s);const n=F(e,t,i.spatialReference);return i.equals(t.getOriginPoint(i.spatialReference))?N(n,i,s):T(i.spatialReference,s)?O(n,i,s):N(n,i,s)}function L(e,t,i,s,n){if((0,r.t)(i))return null;const a=new Float32Array(i.length);return(0,o.f)(f.i.fromTypedArray(a),f.i.fromTypedArray(i),s),(0,y._)(a,e,t,n,a),a}function D(e,t,i,s,n){if((0,r.t)(i))return null;const a=new Float32Array(i.length);(0,o.f)(f.i.fromTypedArray(a,4*Float32Array.BYTES_PER_ELEMENT),f.i.fromTypedArray(i,4*Float32Array.BYTES_PER_ELEMENT),s);for(let e=3;e<a.length;e+=4)a[e]=i[e];return(0,y.R)(a,e,t,n,a),a}function N(e,t,i){const r=new Float64Array(e.position.length),s=e.position,n=t.x,a=t.y,o=t.z||0,{horizontal:l,vertical:h}=G(i?i.unit:null,t.spatialReference);for(let e=0;e<s.length;e+=3)r[e+0]=(s[e+0]-n)/l,r[e+1]=(s[e+1]-a)/l,r[e+2]=(s[e+2]-o)/h;return{position:r,normal:e.normal,tangent:e.tangent}}function O(e,t,i){const r=t.spatialReference;k(t,i,z);const s=(0,a.h)(B,z),n=new Float64Array(e.position.length),h=function(e,t,i,r){const s=(0,y.v)(e,t,r),n=f.T.fromTypedArray(s),a=new Float64Array(s.length),l=f.T.fromTypedArray(a);return(0,o.b)(l,n,i),a}(e.position,r,s,n),u=(0,l.j)(j,s);return{position:h,normal:V(e.normal,e.position,n,r,u),tangent:U(e.tangent,e.position,n,r,u)}}function k(e,t,i){(0,h.S)(e.spatialReference,[e.x,e.y,e.z||0],i,(0,s.e)(e.spatialReference));const{horizontal:r,vertical:n}=G(t?t.unit:null,e.spatialReference);return(0,a.i)(i,i,[r,r,n]),i}function V(e,t,i,s,n){if((0,r.t)(e))return null;const a=(0,y.F)(e,t,i,s,new Float32Array(e.length)),l=f.i.fromTypedArray(a);return(0,o.f)(l,l,n),a}function U(e,t,i,s,n){if((0,r.t)(e))return null;const a=(0,y.B)(e,t,i,s,new Float32Array(e.length)),l=f.i.fromTypedArray(a,4*Float32Array.BYTES_PER_ELEMENT);return(0,o.f)(l,l,n),a}function G(e,t){if((0,r.t)(e))return q;const i=t.isGeographic?1:(0,s.H)(t),n=t.isGeographic?1:(0,s.T)(t),a=(0,s.I)(1,e,"meters");return{horizontal:a*i,vertical:a*n}}const z=(0,o.e)(),B=(0,o.e)(),j=(0,n.e)(),q={horizontal:1,vertical:1}},70568:(e,t,i)=>{"use strict";i.d(t,{a:()=>o,n:()=>n,o:()=>a}),i(33807);var r=i(80219),s=i(60816);const n=(()=>{if(!("document"in r.e))return()=>null;const e=document.createElement("canvas"),t=e.getContext("2d");return e.height=512,e.width=1,i=>{t.clearRect(0,0,1,e.height);const r=t.createLinearGradient(0,0,0,e.height);for(const{ratio:e,color:t}of i.colorStops)r.addColorStop(Math.max(e,.001),`rgba(${t[0]}, ${t[1]}, ${t[2]}, ${t[3]})`);return t.fillStyle=r,t.fillRect(0,0,1,e.height),t.getImageData(0,0,1,e.height).data}})();function a(e,t,i,r){const{blurRadius:s,fieldOffset:n,field:a}=t,o=new Float64Array(i*r),l=function(e){const t=Math.round(3*e),i=2*e*e,r=new Float64Array(2*t+1);for(let s=0;s<=r.length;s++)r[s]=Math.exp(-((s-t)**2)/i)/Math.sqrt(2*Math.PI)*(e/2);return r}(s),h=Math.round(3*s);let u,c=Number.NEGATIVE_INFINITY;const d=function(e,t){return null!=e?"string"==typeof t?t=>-1*+t.readAttribute(e):i=>+i.readAttribute(e)+t:e=>1}(a,n),p=new Set;for(const t of e){const e=t.getCursor();for(;e.next();){const t=e.getObjectId();if(p.has(t))continue;p.add(t);const s=e.readLegacyPointGeometry(),n=128;if(s.x<-n||s.x>=i+n||s.y<-n||s.y>r+n)continue;const a=+d(e),f=Math.round(s.x)-h,y=Math.round(s.y)-h,m=Math.max(0,f),g=Math.max(0,y),_=Math.min(r,Math.round(s.y)+h),x=Math.min(i,Math.round(s.x)+h);for(let e=g;e<_;e++){const t=l[e-y];for(let r=m;r<x;r++){const s=l[r-f];u=o[e*i+r]+=t*s*a,u>c&&(c=u)}}}}return{matrix:o.buffer,max:c}}function o(e,t,i,r,n,a){e.canvas.width=e.canvas.height=t,e.clearRect(0,0,t,t);const o=e.getImageData(0,0,t,t);i&&r&&o.data.set(new Uint8ClampedArray(function(e,t,i,r,n){const a=new Uint32Array(e*e),o="buffer"in t?t:new Float64Array(t),l="buffer"in i?new Uint32Array(i.buffer):new Uint32Array(new Uint8Array(i).buffer),h=l.length/(n-r);for(let e=0;e<o.length;e++){const t=o[e],i=Math.floor((t-r)*h);a[e]=l[(0,s.o)(i,0,l.length-1)]}return a.buffer}(t,i,r,n,a))),e.putImageData(o,0,0)}},43508:(e,t,i)=>{"use strict";i.r(t),i.d(t,{hydratedAdapter:()=>n});var r=i(98548),s=i(20736);i(78155),i(80219),i(88903),i(20215),i(92858),i(4169);const n={convertToGEGeometry:function(e,t){if(null==t)return null;let i="cache"in t?t.cache._geVersion:void 0;return null==i&&(i=e.convertJSONToGeometry(t),"cache"in t&&(t.cache._geVersion=i)),i},exportPoint:function(e,t,i){const r=e.hasZ(t),n=e.hasM(t),a=new s.b({x:e.getPointX(t),y:e.getPointY(t),spatialReference:i});return r&&(a.z=e.getPointZ(t)),n&&(a.m=e.getPointM(t)),a.cache._geVersion=t,a},exportPolygon:function(e,t,i){const s=new r.j({rings:e.exportPaths(t),hasZ:e.hasZ(t),hasM:e.hasM(t),spatialReference:i});return s.cache._geVersion=t,s},exportPolyline:function(e,t,i){const s=new r.m({paths:e.exportPaths(t),hasZ:e.hasZ(t),hasM:e.hasM(t),spatialReference:i});return s.cache._geVersion=t,s},exportMultipoint:function(e,t,i){const s=new r.u({hasZ:e.hasZ(t),hasM:e.hasM(t),points:e.exportPoints(t),spatialReference:i});return s.cache._geVersion=t,s},exportExtent:function(e,t,i){const s=e.hasZ(t),n=e.hasM(t),a=new r.M({xmin:e.getXMin(t),ymin:e.getYMin(t),xmax:e.getXMax(t),ymax:e.getYMax(t),spatialReference:i});if(s){const i=e.getZExtent(t);a.zmin=i.vmin,a.zmax=i.vmax}if(n){const i=e.getMExtent(t);a.mmin=i.vmin,a.mmax=i.vmax}return a.cache._geVersion=t,a}}},26882:(e,t,i)=>{"use strict";i.d(t,{t:()=>r});const r={convertToGEGeometry:function(e,t){return null==t?null:e.convertJSONToGeometry(t)},exportPoint:function(e,t,i){const r=new s(e.getPointX(t),e.getPointY(t),i),n=e.hasZ(t),a=e.hasM(t);return n&&(r.z=e.getPointZ(t)),a&&(r.m=e.getPointM(t)),r},exportPolygon:function(e,t,i){return new n(e.exportPaths(t),i,e.hasZ(t),e.hasM(t))},exportPolyline:function(e,t,i){return new a(e.exportPaths(t),i,e.hasZ(t),e.hasM(t))},exportMultipoint:function(e,t,i){return new o(e.exportPoints(t),i,e.hasZ(t),e.hasM(t))},exportExtent:function(e,t,i){const r=e.hasZ(t),s=e.hasM(t),n=new l(e.getXMin(t),e.getYMin(t),e.getXMax(t),e.getYMax(t),i);if(r){const i=e.getZExtent(t);n.zmin=i.vmin,n.zmax=i.vmax}if(s){const i=e.getMExtent(t);n.mmin=i.vmin,n.mmax=i.vmax}return n}};class s{constructor(e,t,i){this.x=e,this.y=t,this.spatialReference=i,this.z=void 0,this.m=void 0}}class n{constructor(e,t,i,r){this.rings=e,this.spatialReference=t,this.hasZ=void 0,this.hasM=void 0,i&&(this.hasZ=i),r&&(this.hasM=r)}}class a{constructor(e,t,i,r){this.paths=e,this.spatialReference=t,this.hasZ=void 0,this.hasM=void 0,i&&(this.hasZ=i),r&&(this.hasM=r)}}class o{constructor(e,t,i,r){this.points=e,this.spatialReference=t,this.hasZ=void 0,this.hasM=void 0,i&&(this.hasZ=i),r&&(this.hasM=r)}}class l{constructor(e,t,i,r,s){this.xmin=e,this.ymin=t,this.xmax=i,this.ymax=r,this.spatialReference=s,this.zmin=void 0,this.zmax=void 0,this.mmin=void 0,this.mmax=void 0}}},79762:(e,t,i)=>{"use strict";i.d(t,{o:()=>n});var r=i(80987),s=i(52109);function n(e){return{origin:"portal-item",url:(0,r.U)(e.itemUrl),portal:e.portal||s.G.getDefault(),portalItem:e,readResourcePaths:[]}}},86203:(e,t,i)=>{"use strict";i.d(t,{S:()=>f,b:()=>m,d:()=>d,g:()=>p,j:()=>g});var r=i(80219),s=i(80987),n=i(82906),a=i(92858),o=i(53185),l=i(98548),h=i(94449),u=i(52737);const c={esriGeometryPoint:"points",esriGeometryPolyline:"polylines",esriGeometryPolygon:"polygons"};function d(e){const t=e.folders||[],i=t.slice(),s=new Map,n=new Map,a=new Map,o=new Map,l=new Map,h={esriGeometryPoint:n,esriGeometryPolyline:a,esriGeometryPolygon:o};(e.featureCollection&&e.featureCollection.layers||[]).forEach((e=>{const t=(0,r.y)(e);t.featureSet.features=[];const i=e.featureSet.geometryType;s.set(i,t);const l=e.layerDefinition.objectIdField;"esriGeometryPoint"===i?y(n,l,e.featureSet.features):"esriGeometryPolyline"===i?y(a,l,e.featureSet.features):"esriGeometryPolygon"===i&&y(o,l,e.featureSet.features)})),e.groundOverlays&&e.groundOverlays.forEach((e=>{l.set(e.id,e)})),t.forEach((t=>{t.networkLinkIds.forEach((r=>{const s=function(e,t,i){const r=function(e,t){let i;return t.some((t=>t.id===e&&(i=t,!0))),i}(e,i);return r&&(r.parentFolderId=t,r.networkLink=r),r}(r,t.id,e.networkLinks);s&&i.push(s)}))})),i.forEach((e=>{e.featureInfos&&(e.points=(0,r.y)(s.get("esriGeometryPoint")),e.polylines=(0,r.y)(s.get("esriGeometryPolyline")),e.polygons=(0,r.y)(s.get("esriGeometryPolygon")),e.mapImages=[],e.featureInfos.map((t=>{switch(t.type){case"esriGeometryPoint":case"esriGeometryPolyline":case"esriGeometryPolygon":{const i=h[t.type].get(t.id);i&&e[c[t.type]].featureSet.features.push(i);break}case"GroundOverlay":{const i=l.get(t.id);i&&e.mapImages.push(i);break}}})),e.fullExtent=g([e]))}));const u=g(i);return{folders:t,sublayers:i,extent:u}}function p(e,t,i,n){const a=s.a&&s.a.findCredential(e);e=(0,s.R)(e,{token:a&&a.token});const o=r.d.kmlServiceUrl;return(0,s.L)(o,{query:{url:e,model:"simple",folders:"",refresh:0!==i||void 0,outSR:JSON.stringify(t)},responseType:"json",signal:n})}function f(e,t,i=null,r=[]){const s=[],n={},a=t.sublayers,o=t.folders.map((e=>e.id));return a.forEach((t=>{const a=new e;if(i?a.read(t,i):a.read(t),r.length&&o.indexOf(a.id)>-1&&(a.visible=-1!==r.indexOf(a.id)),n[t.id]=a,null!=t.parentFolderId&&-1!==t.parentFolderId){const e=n[t.parentFolderId];e.sublayers||(e.sublayers=[]),e.sublayers.unshift(a)}else s.unshift(a)})),s}function y(e,t,i){i.forEach((i=>{e.set(i.attributes[t],i)}))}async function m(e){const t=u.default.fromJSON(e.featureSet).features,i=e.layerDefinition,r=(0,h.c)(i.drawingInfo.renderer),s=n.M.fromJSON(e.popupInfo),a=[];for(const e of t){const t=await r.getSymbolAsync(e);e.symbol=t,e.popupTemplate=s,e.visible=!0,a.push(e)}return a}function g(e){const t=(0,o.a)(),i=(0,o.a)(o.D);for(const r of e){if(r.polygons&&r.polygons.featureSet&&r.polygons.featureSet.features)for(const e of r.polygons.featureSet.features)(0,l.i)(t,e.geometry),(0,o.f)(i,t);if(r.polylines&&r.polylines.featureSet&&r.polylines.featureSet.features)for(const e of r.polylines.featureSet.features)(0,l.i)(t,e.geometry),(0,o.f)(i,t);if(r.points&&r.points.featureSet&&r.points.featureSet.features)for(const e of r.points.featureSet.features)(0,l.i)(t,e.geometry),(0,o.f)(i,t);if(r.mapImages)for(const e of r.mapImages)(0,l.i)(t,e.extent),(0,o.f)(i,t)}return(0,o.k)(i,o.D)?null:{xmin:i[0],ymin:i[1],zmin:i[2],xmax:i[3],ymax:i[4],zmax:i[5],spatialReference:a.k.WGS84}}},42495:(e,t,i)=>{"use strict";i.r(t),i.d(t,{f:()=>m,h:()=>g,l:()=>_,m:()=>y,n:()=>h});var r=i(20215),s=i(74075),n=i(52109),a=i(79762),o=i(41822),l=i(80987);async function h(e){const{data:t}=await(0,l.L)(e,{responseType:"json",query:{f:"json"}});return t}function u(e,t){let i;const n=e.portalItem.type;switch(n){case"Feature Service":i=s.a.FeatureLayer;break;case"Stream Service":i=s.a.StreamLayer;break;case"Scene Service":i=s.a.SceneLayer;break;case"Feature Collection":i=s.a.FeatureLayer;break;default:throw new r.s("portal:unsupported-item-type-as-group",`The item type '${n}' is not supported as a 'IGroupLayer'`)}let a;return i().then((e=>(a=e,f(t)))).then((async t=>"Feature Service"===n?(t=await y(t,e.portalItem.url),d(e,a,t)):g(t)>0?d(e,a,t):c(e,a)))}function c(e,t){return e.portalItem.url?h(e.portalItem.url).then((i=>{var r,s;function n(e){return{id:e.id,name:e.name}}i&&d(e,t,{layers:null==(r=i.layers)?void 0:r.map(n),tables:null==(s=i.tables)?void 0:s.map(n)})})):Promise.resolve()}function d(e,t,i){let r=i.layers||[];const s=i.tables||[];"Feature Collection"===e.portalItem.type&&(r.forEach((e=>{var t;"Table"===(null==e||null==(t=e.layerDefinition)?void 0:t.type)&&s.push(e)})),r=r.filter((e=>{var t;return"Table"!==(null==e||null==(t=e.layerDefinition)?void 0:t.type)}))),r.reverse().forEach((r=>{const s=p(e,t,i,r);e.add(s)})),s.reverse().forEach((r=>{const s=p(e,t,i,r);e.tables.add(s)}))}function p(e,t,i,r){const s=new t({portalItem:e.portalItem.clone(),layerId:r.id,sublayerTitleMode:"service-name"});if("Feature Collection"===e.portalItem.type){const t={origin:"portal-item",portal:e.portalItem.portal||n.G.getDefault()};s.read(r,t);const a=i.showLegend;null!=a&&s.read({showLegend:a},t)}return s}function f(e,t){if(!1===e.supportsData)return Promise.resolve(void 0);const i=e.instance;return i.portalItem.fetchData("json",t).catch((()=>null)).then((async e=>{if(function(e){return"stream"!==e.type&&"layerId"in e}(i)){let t,r=!0;return e&&g(e)>0&&(null==i.layerId&&(i.layerId=m(e)),t=function(e,t){const i=e.layers;if(i)for(let e=0;e<i.length;e++)if(i[e].id===t)return i[e];const r=e.tables;if(r)for(let e=0;e<r.length;e++)if(r[e].id===t)return r[e];return null}(e,i.layerId),t&&(1===g(e)&&(r=!1),null!=e.showLegend&&(t.showLegend=e.showLegend))),r&&"service-name"!==i.sublayerTitleMode&&(i.sublayerTitleMode="item-title-and-service-name"),t}return e}))}async function y(e,t){var i,r;if(null==(null==(i=e)?void 0:i.layers)||null==(null==(r=e)?void 0:r.tables)){const i=await h(t);(e=e||{}).layers=e.layers||(null==i?void 0:i.layers),e.tables=e.tables||(null==i?void 0:i.tables)}return e}function m(e){const t=e.layers;if(t&&t.length)return t[0].id;const i=e.tables;return i&&i.length?i[0].id:null}function g(e){var t,i,r,s;return(null!=(t=null==e||null==(i=e.layers)?void 0:i.length)?t:0)+(null!=(r=null==e||null==(s=e.tables)?void 0:s.length)?r:0)}var _=Object.freeze({__proto__:null,getFirstLayerOrTableId:m,getNumLayersAndTables:g,load:async function(e,t){const i=e.instance.portalItem;return i&&i.id?(await i.load(t),function(e){const t=e.instance.portalItem;if(-1===e.supportedTypes.indexOf(t.type))throw new r.s("portal:invalid-layer-item-type","Invalid layer item type '${type}', expected '${expectedType}'",{type:t.type,expectedType:e.supportedTypes.join(", ")})}(e),async function(e,t){const i=e.instance,r=i.portalItem,{url:s,title:n}=r,l=(0,a.o)(r);if("group"===i.type)return i.read({title:n},l),u(i,e);s&&i.read({url:s},l);const h=await f(e,t);return h&&i.read(h,l),i.resourceReferences={portalItem:r,paths:l.readResourcePaths},i.read({title:n},l),(0,o.t)(i,l)}(e,t)):Promise.resolve()},preprocessFSItemData:y})},74075:(e,t,i)=>{"use strict";i.d(t,{a:()=>r});const r={BingMapsLayer:async()=>(await i.e(5136).then(i.bind(i,95136))).default,BuildingSceneLayer:async()=>(await Promise.all([i.e(9351),i.e(9795)]).then(i.bind(i,39795))).default,CSVLayer:async()=>(await Promise.all([i.e(9351),i.e(9845)]).then(i.bind(i,89845))).default,ElevationLayer:async()=>(await Promise.resolve().then(i.bind(i,74869))).default,FeatureLayer:async()=>(await Promise.resolve().then(i.bind(i,16040)).then((function(e){return e.F}))).default,GroupLayer:async()=>(await i.e(3650).then(i.bind(i,3650))).default,GeoRSSLayer:async()=>(await i.e(8351).then(i.bind(i,88351))).default,ImageryLayer:async()=>(await Promise.all([i.e(8503),i.e(9351),i.e(1671)]).then(i.bind(i,11671))).default,ImageryTileLayer:async()=>(await Promise.all([i.e(8503),i.e(9351),i.e(364)]).then(i.bind(i,40364))).default,IntegratedMeshLayer:async()=>(await Promise.all([i.e(9351),i.e(6091)]).then(i.bind(i,86091))).default,KMLLayer:async()=>(await Promise.all([i.e(9351),i.e(387)]).then(i.bind(i,30387))).default,MapImageLayer:async()=>(await Promise.all([i.e(9351),i.e(9943)]).then(i.bind(i,79943))).default,MapNotesLayer:async()=>(await Promise.all([i.e(9351),i.e(9844)]).then(i.bind(i,19844))).default,OGCFeatureLayer:async()=>(await Promise.all([i.e(9351),i.e(1315)]).then(i.bind(i,91315))).default,OpenStreetMapLayer:async()=>(await Promise.all([i.e(9351),i.e(8907)]).then(i.bind(i,98907))).default,PointCloudLayer:async()=>(await Promise.all([i.e(9351),i.e(1752)]).then(i.bind(i,91752))).default,RouteLayer:async()=>(await i.e(6890).then(i.bind(i,66890))).default,SceneLayer:async()=>(await Promise.all([i.e(9351),i.e(4441)]).then(i.bind(i,84441))).default,StreamLayer:async()=>(await i.e(7863).then(i.bind(i,17863))).default,TileLayer:async()=>(await Promise.all([i.e(9351),i.e(6862)]).then(i.bind(i,36862))).default,UnknownLayer:async()=>(await i.e(7583).then(i.bind(i,17583))).default,UnsupportedLayer:async()=>(await i.e(3499).then(i.bind(i,53499))).default,VectorTileLayer:async()=>(await Promise.all([i.e(9351),i.e(4078)]).then(i.bind(i,54078))).default,WebTileLayer:async()=>(await i.e(9351).then(i.bind(i,42132)).then((function(e){return e.W}))).default,WFSLayer:async()=>(await Promise.all([i.e(9351),i.e(809)]).then(i.bind(i,60809))).default,WMSLayer:async()=>(await Promise.all([i.e(9351),i.e(6648)]).then(i.bind(i,52578))).default,WMTSLayer:async()=>(await Promise.all([i.e(9351),i.e(3343)]).then(i.bind(i,33343))).default}},79229:(e,t,i)=>{"use strict";function r(e){return e&&"getAtOrigin"in e&&"originOf"in e}i.d(t,{i:()=>r})},82564:(e,t,i)=>{"use strict";i.d(t,{a:()=>B,c:()=>P,d:()=>z,f:()=>G,i:()=>A,o:()=>x,p:()=>U,u:()=>V});var r=i(80987),s=i(20215),n=i(80219),a=i(2903),o=i(78155),l=i(88903),h=i(29126),u=i(31531),c=i(73574),d=i(4169),p=i(52737),f=i(65990),y=i(92858),m=i(20736),g=i(98548);class _{constructor(e={}){this._options=e}toQueryParams(e){if(!e)return null;const t=e.toJSON(),i={};return Object.keys(t).forEach((e=>{const r=this._options[e];if(r){const s="boolean"!=typeof r&&r.name?r.name:e,n="boolean"!=typeof r&&r.getter?r.getter(t):t[e];null!=n&&(i[s]=(e=>{if(!Array.isArray(e))return!1;const[t]=e;return"number"==typeof t||"string"==typeof t})(n)?n.join(","):"object"==typeof n?JSON.stringify(n):n)}else i[e]=t[e]}),this),i}}function x(e){return new _(e)}const v=(0,u.s)()({esriCentimeters:"centimeters",esriDecimalDegrees:"decimal-degrees",esriDecimeters:"decimeters",esriFeet:"feet",esriInches:"inches",esriKilometers:"kilometers",esriMeters:"meters",esriMiles:"miles",esriMillimeters:"millimeters",esriNauticalMiles:"nautical-miles",esriPoints:"points",esriYards:"yards"});(0,u.s)()({esriNAUCentimeters:"centimeters",esriNAUDecimalDegrees:"decimal-degrees",esriNAUDecimeters:"decimeters",esriNAUFeet:"feet",esriNAUInches:"inches",esriNAUKilometers:"kilometers",esriNAUMeters:"meters",esriNAUMiles:"miles",esriNAUMillimeters:"millimeters",esriNAUNauticalMiles:"nautical-miles",esriNAUPoints:"points",esriNAUYards:"yards"}),(0,u.s)()({esriDOTComplete:"complete",esriDOTCompleteNoEvents:"complete-no-events",esriDOTInstructionsOnly:"instructions-only",esriDOTStandard:"standard",esriDOTSummaryOnly:"summary-only"}),(0,u.s)()({esriNAOutputLineNone:"none",esriNAOutputLineStraight:"straight",esriNAOutputLineTrueShape:"true-shape",esriNAOutputLineTrueShapeWithMeasure:"true-shape-with-measure"}),(0,u.s)()({esriNAOutputPolygonNone:"none",esriNAOutputPolygonSimplified:"simplified",esriNAOutputPolygonDetailed:"detailed"});const b=(0,u.s)()({esriNFSBAllowBacktrack:"allow-backtrack",esriNFSBAtDeadEndsOnly:"at-dead-ends-only",esriNFSBNoBacktrack:"no-backtrack",esriNFSBAtDeadEndsAndIntersections:"at-dead-ends-and-intersections"});(0,u.s)()({esriNATravelDirectionFromFacility:"from-facility",esriNATravelDirectionToFacility:"to-facility"}),(0,u.s)()({esriNATimeOfDayNotUsed:"not-used",esriNATimeOfDayUseAsStartTime:"start",esriNATimeOfDayUseAsEndTime:"end"});const w=(0,u.s)()({AUTOMOBILE:"automobile",TRUCK:"truck",WALK:"walk",OTHER:"other"});var S;let I=S=class extends o.a{constructor(e){super(e),this.attributeParameterValues=null,this.description=null,this.distanceAttributeName=null,this.id=null,this.impedanceAttributeName=null,this.name=null,this.restrictionAttributeNames=null,this.simplificationTolerance=null,this.simplificationToleranceUnits=null,this.timeAttributeName=null,this.type=null,this.useHierarchy=null,this.uturnAtJunctions=null}clone(){return new S((0,n.y)({attributeParameterValues:this.attributeParameterValues,description:this.description,distanceAttributeName:this.distanceAttributeName,id:this.id,impedanceAttributeName:this.impedanceAttributeName,name:this.name,restrictionAttributeNames:this.restrictionAttributeNames,simplificationTolerance:this.simplificationTolerance,simplificationToleranceUnits:this.simplificationToleranceUnits,timeAttributeName:this.timeAttributeName,type:this.type,useHierarchy:this.useHierarchy,uturnAtJunctions:this.uturnAtJunctions}))}};(0,o.e)([(0,l.y)({type:[Object],json:{write:!0}})],I.prototype,"attributeParameterValues",void 0),(0,o.e)([(0,l.y)({type:String,json:{write:!0}})],I.prototype,"description",void 0),(0,o.e)([(0,l.y)({type:String,json:{write:!0}})],I.prototype,"distanceAttributeName",void 0),(0,o.e)([(0,l.y)({type:String,json:{write:!0}})],I.prototype,"id",void 0),(0,o.e)([(0,l.y)({type:String,json:{write:!0}})],I.prototype,"impedanceAttributeName",void 0),(0,o.e)([(0,l.y)({type:String,json:{write:!0}})],I.prototype,"name",void 0),(0,o.e)([(0,l.y)({type:[String],json:{write:!0}})],I.prototype,"restrictionAttributeNames",void 0),(0,o.e)([(0,l.y)({type:Number,json:{write:!0}})],I.prototype,"simplificationTolerance",void 0),(0,o.e)([(0,h.r)(v)],I.prototype,"simplificationToleranceUnits",void 0),(0,o.e)([(0,l.y)({type:String,json:{write:!0}})],I.prototype,"timeAttributeName",void 0),(0,o.e)([(0,h.r)(w)],I.prototype,"type",void 0),(0,o.e)([(0,l.y)({type:Boolean,json:{write:!0}})],I.prototype,"useHierarchy",void 0),(0,o.e)([(0,h.r)(b)],I.prototype,"uturnAtJunctions",void 0),I=S=(0,o.e)([(0,l.n)("esri.rest.support.TravelMode")],I);var C=I;let M=class extends o.a{constructor(e){super(e),this.currentVersion=null,this.defaultTravelMode=null,this.directionsLanguage=null,this.directionsSupportedLanguages=null,this.directionsTimeAttribute=null,this.hasZ=null,this.impedance=null,this.networkDataset=null,this.supportedTravelModes=null}};(0,o.e)([(0,l.y)()],M.prototype,"currentVersion",void 0),(0,o.e)([(0,l.y)()],M.prototype,"defaultTravelMode",void 0),(0,o.e)([(0,l.y)()],M.prototype,"directionsLanguage",void 0),(0,o.e)([(0,l.y)()],M.prototype,"directionsSupportedLanguages",void 0),(0,o.e)([(0,l.y)()],M.prototype,"directionsTimeAttribute",void 0),(0,o.e)([(0,l.y)()],M.prototype,"hasZ",void 0),(0,o.e)([(0,l.y)()],M.prototype,"impedance",void 0),(0,o.e)([(0,l.y)()],M.prototype,"networkDataset",void 0),(0,o.e)([(0,l.y)({type:[C]})],M.prototype,"supportedTravelModes",void 0),M=(0,o.e)([(0,l.n)("esri.rest.support.NetworkServiceDescription")],M);var T=M;const E=new u.o({0:"informative",1:"process-definition",2:"process-start",3:"process-stop",50:"warning",100:"error",101:"empty",200:"abort"});let F=class extends f.a{constructor(e){super(e),this.type=null}};(0,o.e)([(0,l.y)({type:String,json:{read:E.read,write:E.write}})],F.prototype,"type",void 0),F=(0,o.e)([(0,l.n)("esri.rest.support.NAMessage")],F);var A=F;let R=class extends p.default{constructor(e){super(e),this.extent=null,this.features=null,this.geometryType="polyline",this.routeId=null,this.routeName=null,this.totalDriveTime=null,this.totalLength=null,this.totalTime=null}readFeatures(e,t){(e||[]).forEach((e=>{this._decompressFeatureGeometry(e,t.summary.envelope.spatialReference)}));const i=y.k.fromJSON(t.spatialReference);return e.map((e=>{const t=c.h.fromJSON(e),r=e.geometry&&e.geometry.spatialReference;return t.geometry&&!r&&((0,n.f)(t.geometry).spatialReference=i),t.strings=e.strings,t.events=(e.events||[]).map((t=>{const i=new c.h({geometry:new m.b({x:t.point.x,y:t.point.y,z:t.point.z,hasZ:void 0!==t.point.z,spatialReference:e.geometry&&e.geometry.spatialReference}),attributes:{ETA:t.ETA,arriveTimeUTC:t.arriveTimeUTC}});return i.strings=t.strings,i})),t}))}get mergedGeometry(){if(!this.features)return null;const e=this.features.map((({geometry:e})=>(0,n.f)(e))),t=this.get("extent.spatialReference");return this._mergePolylinesToSinglePath(e,t)}get strings(){return this.features.map((({strings:e})=>e))}_decompressFeatureGeometry(e,t){e.geometry=this._decompressGeometry(e.compressedGeometry,t)}_decompressGeometry(e,t){let i=0,r=0,s=0,n=0;const a=[];let o,l,h,u,c,d,p,f,y=0,m=0,g=0;if(c=e.match(/((\+|\-)[^\+\-\|]+|\|)/g),c||(c=[]),0===parseInt(c[y],32)){y=2;const e=parseInt(c[y],32);y++,d=parseInt(c[y],32),y++,1&e&&(m=c.indexOf("|")+1,p=parseInt(c[m],32),m++),2&e&&(g=c.indexOf("|",m)+1,f=parseInt(c[g],32),g++)}else d=parseInt(c[y],32),y++;for(;y<c.length&&"|"!==c[y];){o=parseInt(c[y],32)+i,y++,i=o,l=parseInt(c[y],32)+r,y++,r=l;const e=[o/d,l/d];m&&(u=parseInt(c[m],32)+s,m++,s=u,e.push(u/p)),g&&(h=parseInt(c[g],32)+n,g++,n=h,e.push(h/f)),a.push(e)}return{paths:[a],hasZ:m>0,hasM:g>0,spatialReference:t}}_mergePolylinesToSinglePath(e,t){let i=[];(e||[]).forEach((e=>{e.paths.forEach((e=>{i=i.concat(e)}))}));const r=[];let s=[0,0];return i.forEach((e=>{e[0]===s[0]&&e[1]===s[1]||(r.push(e),s=e)})),new g.m({paths:[r]},t)}};(0,o.e)([(0,l.y)({type:g.M,json:{read:{source:"summary.envelope"}}})],R.prototype,"extent",void 0),(0,o.e)([(0,l.y)()],R.prototype,"features",void 0),(0,o.e)([(0,d.e)("features")],R.prototype,"readFeatures",null),(0,o.e)([(0,l.y)()],R.prototype,"geometryType",void 0),(0,o.e)([(0,l.y)({readOnly:!0})],R.prototype,"mergedGeometry",null),(0,o.e)([(0,l.y)()],R.prototype,"routeId",void 0),(0,o.e)([(0,l.y)()],R.prototype,"routeName",void 0),(0,o.e)([(0,l.y)({value:null,readOnly:!0})],R.prototype,"strings",null),(0,o.e)([(0,l.y)({json:{read:{source:"summary.totalDriveTime"}}})],R.prototype,"totalDriveTime",void 0),(0,o.e)([(0,l.y)({json:{read:{source:"summary.totalLength"}}})],R.prototype,"totalLength",void 0),(0,o.e)([(0,l.y)({json:{read:{source:"summary.totalTime"}}})],R.prototype,"totalTime",void 0),R=(0,o.e)([(0,l.n)("esri.rest.support.DirectionsFeatureSet")],R);var P=R;let L=class extends o.a{constructor(e){super(e),this.directions=null,this.route=null,this.routeName=null,this.stops=null}};(0,o.e)([(0,l.y)({type:P,json:{write:!0}})],L.prototype,"directions",void 0),(0,o.e)([(0,l.y)({type:c.h,json:{write:!0}})],L.prototype,"route",void 0),(0,o.e)([(0,l.y)({type:String,json:{write:!0}})],L.prototype,"routeName",void 0),(0,o.e)([(0,l.y)({type:[c.h],json:{write:!0}})],L.prototype,"stops",void 0),L=(0,o.e)([(0,l.n)("esri.rest.support.RouteResult")],L);var D=L;function N(e){return e&&p.default.fromJSON(e).features.map((e=>e))}let O=class extends o.a{constructor(e){super(e),this.barriers=null,this.messages=null,this.pointBarriers=null,this.polylineBarriers=null,this.polygonBarriers=null,this.routeResults=null}readPointBarriers(e,t){return N(t.barriers||t.pointBarriers)}readPolylineBarriers(e){return N(e)}readPolygonBarriers(e){return N(e)}};(0,o.e)([(0,l.y)({aliasOf:"pointBarriers"})],O.prototype,"barriers",void 0),(0,o.e)([(0,l.y)({type:[A]})],O.prototype,"messages",void 0),(0,o.e)([(0,l.y)({type:[c.h]})],O.prototype,"pointBarriers",void 0),(0,o.e)([(0,d.e)("pointBarriers",["barriers","pointBarriers"])],O.prototype,"readPointBarriers",null),(0,o.e)([(0,l.y)({type:[c.h]})],O.prototype,"polylineBarriers",void 0),(0,o.e)([(0,d.e)("polylineBarriers")],O.prototype,"readPolylineBarriers",null),(0,o.e)([(0,l.y)({type:[c.h]})],O.prototype,"polygonBarriers",void 0),(0,o.e)([(0,d.e)("polygonBarriers")],O.prototype,"readPolygonBarriers",null),(0,o.e)([(0,l.y)({type:[D]})],O.prototype,"routeResults",void 0),O=(0,o.e)([(0,l.n)("esri.rest.support.RouteResultsContainer")],O);var k=O;function V(e,t,i,r){r[i]=[t.length,t.length+e.length],e.forEach((e=>{t.push(e.geometry)}))}function U(e,t){for(let i=0;i<t.length;i++){const r=e[t[i]];if(r&&r.length)for(const e of r)e.z=void 0}console.log("The remote Network Analysis service is powered by a network dataset which is not Z-aware.\nZ-coordinates of the input geometry are ignored.")}function G(e){const t=[],i=[],{directions:r=[],routes:{features:s=[],spatialReference:n=null}={},stops:{features:a=[],spatialReference:o=null}={},barriers:l,polygonBarriers:h,polylineBarriers:u,messages:c}=e.data,d="esri.tasks.RouteTask.NULL_ROUTE_NAME";let p,f,y=!0;const m=s&&n||a&&o||l&&l.spatialReference||h&&h.spatialReference||u&&u.spatialReference;r.forEach((e=>{t.push(p=e.routeName),i[p]={directions:e}})),s.forEach((e=>{-1===t.indexOf(p=e.attributes.Name)&&(t.push(p),i[p]={}),e.geometry&&(e.geometry.spatialReference=m),i[p].route=e})),a.forEach((e=>{f=e.attributes,-1===t.indexOf(p=f.RouteName||d)&&(t.push(p),i[p]={}),p!==d&&(y=!1),e.geometry&&(e.geometry.spatialReference=m),null==i[p].stops&&(i[p].stops=[]),i[p].stops.push(e)})),a.length>0&&!0===y&&(i[t[0]].stops=i[d].stops,delete i[d],t.splice(t.indexOf(d),1));const g=t.map((e=>(i[e].routeName=e===d?null:e,i[e])));return k.fromJSON({routeResults:g,pointBarriers:l,polygonBarriers:h,polylineBarriers:u,messages:c})}function z(e,t){for(let i=0;i<t.length;i++){const r=e[t[i]];if(r&&r.length)for(const e of r)if((0,n.r)(e)&&e.hasZ)return!0}return!1}async function B(e,t,i){if(!e)throw new s.s("network-service:missing-url","Url to Network service is missing");const o=(0,a.r)({f:"json",token:t},i),{data:l}=await(0,r.L)(e,o);l.supportedTravelModes||(l.supportedTravelModes=[]);for(let e=0;e<l.supportedTravelModes.length;e++)l.supportedTravelModes[e].id||(l.supportedTravelModes[e].id=l.supportedTravelModes[e].itemId);const h=l.currentVersion>=10.4?async function(e,t,i){try{const s=(0,a.r)({f:"json",token:t},i),n=(0,r.g)(e)+"/retrieveTravelModes",{data:{supportedTravelModes:o,defaultTravelMode:l}}=await(0,r.L)(n,s);return{supportedTravelModes:o,defaultTravelMode:l}}catch(e){throw new s.s("network-service:retrieveTravelModes","Could not get to the NAServer's retrieveTravelModes.",{error:e})}}(e,t,i):async function(e,t){var i,s;const o=(0,a.r)({f:"json"},t),{data:l}=await(0,r.L)(e.replace(/\/rest\/.*$/i,"/info"),o);if(!l||!l.owningSystemUrl)return{supportedTravelModes:[],defaultTravelMode:null};const{owningSystemUrl:h}=l,u=(0,r.g)(h)+"/sharing/rest/portals/self",{data:c}=await(0,r.L)(u,o),d=(0,n.j)("helperServices.routingUtilities.url",c);if(!d)return{supportedTravelModes:[],defaultTravelMode:null};const p=(0,a.e)(h),f=/\/solve$/i.test(p.path)?"Route":/\/solveclosestfacility$/i.test(p.path)?"ClosestFacility":"ServiceAreas",y=(0,a.r)({f:"json",serviceName:f},t),m=(0,r.g)(d)+"/GetTravelModes/execute",g=await(0,r.L)(m,y),_=[];let x=null;if(null!=g&&null!=(i=g.data)&&null!=(s=i.results)&&s.length){const e=g.data.results;for(const t of e){var v;if("supportedTravelModes"===t.paramName){if(null!=(v=t.value)&&v.features)for(const{attributes:e}of t.value.features)if(e){const t=JSON.parse(e.TravelMode);_.push(t)}}else"defaultTravelMode"===t.paramName&&(x=t.value)}}return{supportedTravelModes:_,defaultTravelMode:x}}(e,i),{defaultTravelMode:u,supportedTravelModes:c}=await h;return l.defaultTravelMode=u,l.supportedTravelModes=c,T.fromJSON(l)}},1598:(e,t,i)=>{"use strict";i.d(t,{a:()=>h,o:()=>o,p:()=>u});var r=i(80219),s=i(3621);const n={ar:[".",","],bs:[",","."],ca:[",","."],cs:[","," "],da:[",","."],de:[",","."],"de-ch":[".","’"],el:[",","."],en:[".",","],"en-au":[".",","],es:[",","."],"es-mx":[".",","],et:[","," "],fi:[","," "],fr:[","," "],"fr-ch":[","," "],he:[".",","],hi:[".",",","#,##,##0.###"],hr:[",","."],hu:[","," "],id:[",","."],it:[",","."],"it-ch":[".","’"],ja:[".",","],ko:[".",","],lt:[","," "],lv:[","," "],mk:[",","."],nb:[","," "],nl:[",","."],pl:[","," "],pt:[",","."],"pt-pt":[","," "],ro:[",","."],ru:[","," "],sk:[","," "],sl:[",","."],sr:[",","."],sv:[","," "],th:[".",","],tr:[",","."],uk:[","," "],vi:[",","."],zh:[".",","]};function a(e){e||(e=(0,s.i)());let t=e in n;if(!t){const i=e.split("-");i.length>1&&i[0]in n&&(e=i[0],t=!0),t||(e="en")}const[i,r,a="#,##0.###"]=n[e];return{decimal:i,group:r,pattern:a}}function o(e,t){const i=a((t={...t}).locale);t.customs=i;const r=t.pattern||i.pattern;return isNaN(e)||Math.abs(e)===1/0?null:function(e,t,i){const r=(i=i||{}).customs.group,s=i.customs.decimal,n=t.split(";"),a=n[0];if(-1!==(t=n[e<0?1:0]||"-"+a).indexOf("%"))e*=100;else if(-1!==t.indexOf("‰"))e*=1e3;else{if(-1!==t.indexOf("¤"))throw new Error("currency notation not supported");if(-1!==t.indexOf("E"))throw new Error("exponential notation not supported")}const o=l,h=a.match(o);if(!h)throw new Error("unable to find a number expression in pattern: "+t);return!1===i.fractional&&(i.places=0),t.replace(o,function(e,t,i){!0===(i=i||{}).places&&(i.places=0),i.places===1/0&&(i.places=6);const r=t.split("."),s="string"==typeof i.places&&i.places.indexOf(",");let n=i.places;s?n=i.places.substring(s+1):n>=0||(n=(r[1]||[]).length),i.round<0||(e=Number(e.toFixed(Number(n))));const a=String(Math.abs(e)).split("."),o=a[1]||"";if(r[1]||i.places){s&&(i.places=i.places.substring(0,s));const e=void 0!==i.places?i.places:r[1]&&r[1].lastIndexOf("0")+1;e>o.length&&(a[1]=o.padEnd(Number(e),"0")),n<o.length&&(a[1]=o.substr(0,Number(n)))}else a[1]&&a.pop();const l=r[0].replace(",","");let h=l.indexOf("0");-1!==h&&(h=l.length-h,h>a[0].length&&(a[0]=a[0].padStart(h,"0")),-1===l.indexOf("#")&&(a[0]=a[0].substr(a[0].length-h)));let u,c,d=r[0].lastIndexOf(",");if(-1!==d){u=r[0].length-d-1;const e=r[0].substr(0,d);d=e.lastIndexOf(","),-1!==d&&(c=e.length-d-1)}const p=[];for(let e=a[0];e;){const t=e.length-u;p.push(t>0?e.substr(t):e),e=t>0?e.slice(0,t):"",c&&(u=c,c=void 0)}return a[0]=p.reverse().join(i.group||","),a.join(i.decimal||".")}(e,h[0],{decimal:s,group:r,places:i.places,round:i.round}))}(e,r,t)}const l=/[#0,]*[#0](?:\.0*#*)?/;function h(e){const t=a((e=e||{}).locale),i=e.pattern||t.pattern,s=t.group,n=t.decimal;let o=1;if(-1!==i.indexOf("%"))o/=100;else if(-1!==i.indexOf("‰"))o/=1e3;else if(-1!==i.indexOf("¤"))throw new Error("currency notation not supported");const h=i.split(";");return 1===h.length&&h.push("-"+h[0]),{regexp:d(h,(function(t){return(t="(?:"+(0,r.N)(t,".")+")").replace(l,(function(t){const i={signed:!1,separator:e.strict?s:[s,""],fractional:e.fractional,decimal:n,exponent:!1},r=t.split(".");let a=e.places;1===r.length&&1!==o&&(r[1]="###"),1===r.length||0===a?i.fractional=!1:(void 0===a&&(a=e.pattern?r[1].lastIndexOf("0")+1:1/0),a&&null==e.fractional&&(i.fractional=!0),!e.places&&a<r[1].length&&(a+=","+r[1].length),i.places=a);const l=r[0].split(",");return l.length>1&&(i.groupSize=l.pop().length,l.length>1&&(i.groupSize2=l.pop().length)),"("+function(e){"places"in(e=e||{})||(e.places=1/0),"string"!=typeof e.decimal&&(e.decimal="."),"fractional"in e&&!/^0/.test(String(e.places))||(e.fractional=[!0,!1]),"exponent"in e||(e.exponent=[!0,!1]),"eSigned"in e||(e.eSigned=[!0,!1]);const t=c(e),i=d(e.fractional,(function(t){let i="";return t&&0!==e.places&&(i="\\"+e.decimal,e.places===1/0?i="(?:"+i+"\\d+)?":i+="\\d{"+e.places+"}"),i}),!0);let r=t+i;return i&&(r="(?:(?:"+r+")|(?:"+i+"))"),r+d(e.exponent,(function(t){return t?"([eE]"+c({signed:e.eSigned})+")":""}))}(i)+")"}))}),!0).replace(/[\xa0 ]/g,"[\\s\\xa0]"),group:s,decimal:n,factor:o}}function u(e,t){const i=h(t),r=new RegExp("^"+i.regexp+"$").exec(e);if(!r)return NaN;let s=r[1];if(!r[1]){if(!r[2])return NaN;s=r[2],i.factor*=-1}return s=s.replace(new RegExp("["+i.group+"\\s\\xa0]","g"),"").replace(i.decimal,"."),Number(s)*i.factor}function c(e){return"signed"in(e=e||{})||(e.signed=[!0,!1]),"separator"in e?"groupSize"in e||(e.groupSize=3):e.separator="",d(e.signed,(function(e){return e?"[-+]":""}),!0)+d(e.separator,(function(t){if(!t)return"(?:\\d+)";" "===(t=(0,r.N)(t))?t="\\s":" "===t&&(t="\\s\\xa0");const i=e.groupSize,s=e.groupSize2;if(s){const e="(?:0|[1-9]\\d{0,"+(s-1)+"}(?:["+t+"]\\d{"+s+"})*["+t+"]\\d{"+i+"})";return i-s>0?"(?:"+e+"|(?:0|[1-9]\\d{0,"+(i-1)+"}))":e}return"(?:0|[1-9]\\d{0,"+(i-1)+"}(?:["+t+"]\\d{"+i+"})*)"}),!0)}const d=function(e,t,i){if(!(e instanceof Array))return t(e);const r=[];for(let i=0;i<e.length;i++)r.push(t(e[i]));return p(r.join("|"),i)},p=function(e,t){return"("+(t?"?:":"")+e+")"}},89713:(e,t,i)=>{"use strict";i.d(t,{n:()=>s,t:()=>r});const r=1;function s(e,t){let i=0;for(const s of t){var r;const t=null==(r=s.attributes)?void 0:r[e];"number"==typeof t&&isFinite(t)&&(i=Math.max(i,t))}return i}},44320:(e,t,i)=>{"use strict";i.d(t,{M:()=>I,N:()=>w,O:()=>C,S:()=>x,T:()=>g,k:()=>_,q:()=>S,v:()=>b,x:()=>v});var r=i(81008),s=i(80987),n=i(20215),a=i(80219),o=i(92858),l=i(20736),h=i(29831),u=i(30691),c=i(16034),d=i(93028),p=i(2502),f=i(67079),y=i(52737);const m=a.n.getLogger("esri.layers.graphics.sources.ogcfeature");async function g(e,t,i={},r=5){const{links:o}=e,l=F(o,"items","application/geo+json")||F(o,"http://www.opengis.net/def/rel/ogc/1.0/items","application/geo+json");if((0,a.t)(l))throw new n.s("ogc-feature-layer:missing-items-page","Missing items url");const{data:h}=await(0,s.L)(l.href,{signal:i.signal,query:{limit:r,...i.customParameters,token:i.apiKey},headers:{accept:"application/geo+json"}});await(0,c.I)(h);const u=(0,c.T)(h,{geometryType:t.geometryType}),y=t.fields||u.fields||[],g=null!=t.hasZ?t.hasZ:u.hasZ,_=u.geometryType,x=t.objectIdField||u.objectIdFieldName||"OBJECTID";let v=t.timeInfo;const b=y.find((e=>e.name===x));if(b)b.type="esriFieldTypeOID",b.editable=!1,b.nullable=!1;else{if(!u.objectIdFieldType)throw new n.s("ogc-feature-layer:missing-feature-id","Collection geojson require a feature id as a unique identifier");y.unshift({name:x,alias:x,type:"esriFieldTypeOID",editable:!1,nullable:!1})}if(x!==u.objectIdFieldName){const e=y.find((e=>e.name===u.objectIdFieldName));e&&(e.type="esriFieldTypeInteger")}if(!_)throw new n.s("ogc-feature-layer:missing-property","geometryType not set and couldn't be inferred from the provided features");y===u.fields&&u.unknownFields.length>0&&m.warn({name:"ogc-feature-layer:unknown-field-types",message:"Some fields types couldn't be inferred from the features and were dropped",details:{unknownFields:u.unknownFields}});for(const e of y){if(null==e.name&&(e.name=e.alias),null==e.alias&&(e.alias=e.name),"esriFieldTypeOID"!==e.type&&"esriFieldTypeGlobalID"!==e.type&&(e.editable=null==e.editable||!!e.editable,e.nullable=null==e.nullable||!!e.nullable),!e.name)throw new n.s("ogc-feature-layer:invalid-field-name","field name is missing",{field:e});if(-1===f.i.jsonValues.indexOf(e.type))throw new n.s("ogc-feature-layer:invalid-field-type",`invalid type for field "${e.name}"`,{field:e})}if(v){const e=new p.e(y);if(v.startTimeField){const t=e.get(v.startTimeField);t?(v.startTimeField=t.name,t.type="esriFieldTypeDate"):v.startTimeField=null}if(v.endTimeField){const t=e.get(v.endTimeField);t?(v.endTimeField=t.name,t.type="esriFieldTypeDate"):v.endTimeField=null}if(v.trackIdField){const t=e.get(v.trackIdField);t?v.trackIdField=t.name:(v.trackIdField=null,m.warn({name:"ogc-feature-layer:invalid-timeInfo-trackIdField",message:"trackIdField is missing",details:{timeInfo:v}}))}v.startTimeField||v.endTimeField||(m.warn({name:"ogc-feature-layer:invalid-timeInfo",message:"startTimeField and endTimeField are missing",details:{timeInfo:v}}),v=null)}return{drawingInfo:(0,d.u)(_),geometryType:_,fields:y,hasZ:!!g,objectIdField:x,timeInfo:v}}async function _(e,t={}){const{links:i}=e,r=F(i,"data","application/json")||F(i,"http://www.opengis.net/def/rel/ogc/1.0/data","application/json");if((0,a.t)(r))throw new n.s("ogc-feature-layer:missing-collections-page","Missing collections url");const{apiKey:o,customParameters:l,signal:h}=t,{data:u}=await(0,s.L)(r.href,{signal:h,headers:{accept:"application/json"},query:{...l,token:o}});return u}async function x(e,t={}){const{links:i}=e,r=F(i,"conformance","application/json")||F(i,"http://www.opengis.net/def/rel/ogc/1.0/conformance","application/json");if((0,a.t)(r))throw new n.s("ogc-feature-layer:missing-conformance-page","Missing conformance url");const{apiKey:o,customParameters:l,signal:h}=t,{data:u}=await(0,s.L)(r.href,{signal:h,headers:{accept:"application/json"},query:{...l,token:o}});return u}async function v(e,t={}){const{apiKey:i,customParameters:r,signal:n}=t,{data:a}=await(0,s.L)(e,{signal:n,headers:{accept:"application/json"},query:{...r,token:i}});return a}async function b(e,t={}){const i="application/vnd.oai.openapi+json;version=3.0",r=F(e.links,"service-desc",i);if((0,a.t)(r))return m.warn("ogc-feature-layer:missing-openapi-page","The OGC API-Features server does not have an OpenAPI page."),null;const{apiKey:n,customParameters:o,signal:l}=t,{data:h}=await(0,s.L)(r.href,{signal:l,headers:{accept:i},query:{...o,token:n}});return h}function w(e){const t=(0,r.t)(/^http:\/\/www\.opengis.net\/def\/crs\/(.*)\/(.*)\/(.*)$/i,{authority:1,version:2,code:3}).exec(e),i=null==t?void 0:t.groups;if(!i)return null;const{authority:s,code:n}=i;switch(s.toLowerCase()){case"ogc":switch(n.toLowerCase()){case"crs27":return o.k.GCS_NAD_1927;case"crs83":return new o.k({wkid:4269});case"crs84":case"crs84h":return o.k.WGS84;default:return null}case"esri":case"epsg":{const e=Number.parseInt(n,10);return Number.isNaN(e)?null:900913===e?o.k.WebMercator:new o.k({wkid:e})}default:return null}}async function S(e,t,i){const r=await I(e,t,i);return y.default.fromJSON(r)}async function I(e,t,i){const r=await C(e,t,i);return(0,h.n)(r)}async function C(e,t,i){const{capabilities:{query:{maxRecordCount:r}},collection:d,layerDefinition:p,queryParameters:{apiKey:f,customParameters:y},spatialReference:m,supportedCrs:g}=e,{links:_}=d,x=F(_,"items","application/geo+json")||F(_,"http://www.opengis.net/def/rel/ogc/1.0/items","application/geo+json");if((0,a.t)(x))throw new n.s("ogc-feature-layer:missing-items-page","Missing items url");const{geometry:v,num:b,start:w,timeExtent:S,where:I}=t;if(t.objectIds)throw new n.s("ogc-feature-layer:query-by-objectids-not-supported","Queries with objectids are not supported");const C=o.k.fromJSON(m),T=(0,a.q)(t.outSpatialReference,C),A=T.isWGS84?null:M(T,g),R=E(v,g),P=function(e){if((0,a.t)(e))return null;const{start:t,end:i}=e;return`${(0,a.r)(t)?t.toISOString():".."}/${(0,a.r)(i)?i.toISOString():".."}`}(S),L=function(e){return(0,a.t)(e)||!e||"1=1"===e?null:e}(I),D=null!=b?b:null!=w&&void 0!==w?10:r,{data:N}=await(0,s.L)(x.href,{...i,query:{...y,...R,crs:A,datetime:P,query:L,limit:D,startindex:w,token:f},headers:{accept:"application/geo+json"}});let O=!1;N.links&&(O=!!N.links.find((e=>"next"===e.rel))),!O&&Number.isInteger(N.numberMatched)&&Number.isInteger(N.numberReturned)&&(O=N.numberReturned<N.numberMatched);const{fields:k,globalIdField:V,hasM:U,hasZ:G,objectIdField:z}=p,B=p.geometryType,j=(0,c.k)(N,{geometryType:B,hasZ:G,objectIdField:z});if(!A&&T.isWebMercator)for(const e of j)if(e.geometry){const t=(0,h.e)(e.geometry,B,G,!1);t.spatialReference=o.k.WGS84,e.geometry=(0,h.X)((0,l.g)(t,T))}for(const e of j)e.objectId=e.attributes[z];const q=A||!A&&T.isWebMercator?T.toJSON():o.I,H=new u.e;return H.exceededTransferLimit=O,H.features=j,H.fields=k,H.geometryType=B,H.globalIdFieldName=V,H.hasM=U,H.hasZ=G,H.objectIdFieldName=z,H.spatialReference=q,H}function M(e,t){return t.find((t=>{const i=w(t);return(0,o.d)(i,e)}))}function T(e){const{xmin:t,ymin:i,xmax:r,ymax:s}=e;return`${t},${i},${r},${s}`}function E(e,t){if(!function(e){return(0,a.r)(e)&&"extent"===e.type}(e))return null;const{spatialReference:i}=e;if(!i||i.isWGS84)return{bbox:T(e)};const r=M(i,t);return r?{bbox:T(e),"bbox-crs":r}:i.isWebMercator?{bbox:T((0,l.g)(e,o.k.WGS84))}:null}function F(e,t,i){return e.find((e=>e.rel===t&&e.type===i))||e.find((e=>e.rel===t&&!e.type))}},66954:(e,t,i)=>{"use strict";i.d(t,{o:()=>n});var r=i(83618),s=i(91728);const n={getObjectId:e=>e.objectId,getAttributes:e=>e.attributes,getAttribute:(e,t)=>e.attributes[t],cloneWithGeometry:(e,t)=>new s.t(t,e.attributes,null,e.objectId),getGeometry:e=>e.geometry,getCentroid:(e,t)=>(e.centroid||(e.centroid=(0,r.t)(new s.a,e.geometry,t.hasZ,t.hasM)),e.centroid)}},58576:(e,t,i)=>{"use strict";i.d(t,{g:()=>y});var r=i(80219),s=i(79229),n=i(80987),a=i(68631),o=i(88903),l=i(78155),h=i(29832);function u(e){return c[function(e){return e instanceof Blob?e.type:function(e){const t=(0,n.y)(e);return f[t]||d}(e.url)}(e)]||p}const c={},d="text/plain",p=c[d],f={png:"image/png",jpeg:"image/jpeg",jpg:"image/jpg",bmp:"image/bmp",gif:"image/gif",json:"application/json",txt:"text/plain",xml:"application/xml",svg:"image/svg+xml",zip:"application/zip",pbf:"application/vnd.mapbox-vector-tile",gz:"application/gzip"};for(const e in f)c[f[e]]=e;function y(e){const t=(0,r.r)(e)&&e.origins?e.origins:[void 0];return(i,a)=>{const u=function(e,t,i){if((0,r.r)(e)&&"resource"===e.type)return function(e,t,i){const a=(0,o.s)(t,i);return{type:String,read:(e,t,i)=>{const r=(0,h.m)(e,t,i);return a.type===String?r:"function"==typeof a.type?new a.type({url:r}):void 0},write:{writer(t,o,u,c){if(!c||!c.resources)return"string"==typeof t?void(o[u]=(0,h.i)(t,c)):void(o[u]=t.write({},c));const d=function(e){return(0,r.t)(e)?null:"string"==typeof e?e:e.url}(t),p=d?(0,h.i)(d,{...c,verifyItemRelativeUrls:c&&c.verifyItemRelativeUrls?{writtenUrls:c.verifyItemRelativeUrls.writtenUrls,rootPath:null}:null},1):null,f=a.type!==String&&(!(0,s.i)(this)||c&&c.origin&&this.originIdOf(i)>(0,l.t)(c.origin));c&&c.portalItem&&(0,r.r)(p)&&!(0,n.Q)(p)?f?g(this,i,t,p,o,u,c,e):function(e,t,i,r){r.resources.toKeep.push({resource:r.portalItem.resourceFromPath(e)}),t[i]=e}(p,o,u,c):c&&c.portalItem&&((0,r.t)(p)||(0,r.r)((0,h.v)(p))||(0,n.F)(p)||f)?m(this,i,t,p,o,u,c,e):o[u]=p}}}}(e,t,i);switch((0,r.r)(e)&&e.type?e.type:"other"){case"other":return{read:!0,write:!0};case"url":{const{read:e,write:t}=h.R;return{read:e,write:t}}}}(e,i,a);for(const e of t){const t=(0,o.h)(i,e,a);for(const e in u)t[e]=u[e]}}}function m(e,t,s,o,l,h,c,d){const p=(0,a.o)(),f=x(s,o,c),y=(0,n.D)((0,r.g)(d,"prefix"),p),m=`${y}.${u(f)}`,g=c.portalItem.resourceFromPath(m);(0,n.F)(o)&&c.resources.pendingOperations.push(async function(e){const t=(await Promise.resolve().then(i.bind(i,80987)).then((function(e){return e.K}))).default,{data:r}=await t(e,{responseType:"blob"});return r}(o).then((e=>{g.path=`${y}.${u(e)}`,l[h]=g.itemRelativeUrl})).catch((()=>{}))),_(e,t,g,f,c.resources.toAdd),l[h]=g.itemRelativeUrl}function g(e,t,i,r,s,a,o,l){const h=o.portalItem.resourceFromPath(r),c=x(i,r,o);u(c)===(0,n.y)(h.path)?(_(e,t,h,c,o.resources.toUpdate),s[a]=r):m(e,t,i,r,s,a,o,l)}function _(e,t,i,r,s){s.push({resource:i,content:r,finish:i=>{!function(e,t,i){"string"==typeof e[t]?e[t]=i.url:e[t].url=i.url}(e,t,i)}})}function x(e,t,i){return"string"==typeof e?{url:t}:new Blob([JSON.stringify(e.toJSON(i))],{type:"application/json"})}},84935:(e,t,i)=>{"use strict";i.d(t,{C:()=>L,T:()=>D,a:()=>b,c:()=>w,d:()=>C,f:()=>v,g:()=>M,h:()=>x,i:()=>f,l:()=>y,m:()=>S,n:()=>p,o:()=>g,r:()=>m,s:()=>_,u:()=>c}),i(33807);var r,s=i(78155),n=i(80219),a=i(20215),o=i(88903),l=i(20736);const h=n.n.getLogger("esri.layers.support.PixelBlock");let u=r=class extends s.a{constructor(e){super(e),this.width=null,this.height=null,this.pixelType="f32",this.validPixelCount=null,this.mask=null,this.maskIsAlpha=!1,this.pixels=null,this.statistics=null}static createEmptyBand(e,t){return new(r.getPixelArrayConstructor(e))(t)}static getPixelArrayConstructor(e){let t;switch(e){case"u1":case"u2":case"u4":case"u8":t=Uint8Array;break;case"u16":t=Uint16Array;break;case"u32":t=Uint32Array;break;case"s8":t=Int8Array;break;case"s16":t=Int16Array;break;case"s32":t=Int32Array;break;case"u32":t=Uint32Array;break;case"f32":t=Float32Array;break;case"f64":t=Float64Array;break;case"c64":case"c128":case"unknown":t=Float32Array}return t}castPixelType(e){if(!e)return"f32";let t=e.toLowerCase();return["u1","u2","u4"].indexOf(t)>-1?t="u8":-1===["unknown","u8","s8","u16","s16","u32","s32","f32","f64"].indexOf(t)&&(t="f32"),t}getPlaneCount(){return this.pixels&&this.pixels.length}addData(e){if(!e.pixels||e.pixels.length!==this.width*this.height)throw new a.s("pixelblock:invalid-or-missing-pixels","add data requires valid pixels array that has same length defined by pixel block width * height");this.pixels||(this.pixels=[]),this.statistics||(this.statistics=[]),this.pixels.push(e.pixels),this.statistics.push(e.statistics||{minValue:null,maxValue:null})}getAsRGBA(){const e=new ArrayBuffer(this.width*this.height*4);switch(this.pixelType){case"s8":case"s16":case"u16":case"s32":case"u32":case"f32":case"f64":this._fillFromNon8Bit(e);break;default:this._fillFrom8Bit(e)}return new Uint8ClampedArray(e)}getAsRGBAFloat(){const e=new Float32Array(this.width*this.height*4);return this._fillFrom32Bit(e),e}updateStatistics(){this.statistics=this.pixels.map((e=>this._calculateBandStatistics(e,this.mask)));const e=this.mask;let t=0;if(e)for(let i=0;i<e.length;i++)e[i]&&t++;else t=this.width*this.height;this.validPixelCount=t}clamp(e){if(!e||"f64"===e||"f32"===e)return;let t;switch(e){case"u8":t=[0,255];break;case"u16":t=[0,65535];break;case"u32":t=[0,4294967295];break;case"s8":t=[-128,127];break;case"s16":t=[-32768,32767];break;case"s32":t=[-2147483648,2147483647];break;default:t=[-34e38,34e38]}const[i,s]=t,n=this.pixels,a=this.width*this.height,o=n.length;let l,h,u;const c=[];for(let t=0;t<o;t++){u=r.createEmptyBand(e,a),l=n[t];for(let e=0;e<a;e++)h=l[e],u[e]=h>s?s:h<i?i:h;c.push(u)}this.pixels=c,this.pixelType=e}extractBands(e){if((0,n.t)(e)||0===e.length||null==this.pixels||0===this.pixels.length)return this;const t=this.pixels.length,i=e.some((e=>e>=this.pixels.length)),s=t===e.length&&!e.some(((e,t)=>e!==t));return i||s?this:new r({pixelType:this.pixelType,width:this.width,height:this.height,mask:this.mask,validPixelCount:this.validPixelCount,maskIsAlpha:this.maskIsAlpha,pixels:e.map((e=>this.pixels[e])),statistics:this.statistics&&e.map((e=>this.statistics[e]))})}clone(){const e=new r({width:this.width,height:this.height,pixelType:this.pixelType,maskIsAlpha:this.maskIsAlpha,validPixelCount:this.validPixelCount});let t;this.mask&&(this.mask instanceof Uint8Array?e.mask=new Uint8Array(this.mask):e.mask=this.mask.slice(0));const i=r.getPixelArrayConstructor(this.pixelType);if(this.pixels&&this.pixels.length>0){e.pixels=[];const r=this.pixels[0].slice;for(t=0;t<this.pixels.length;t++)e.pixels[t]=r?this.pixels[t].slice(0,this.pixels[t].length):new i(this.pixels[t])}if(this.statistics)for(e.statistics=[],t=0;t<this.statistics.length;t++)e.statistics[t]=(0,n.y)(this.statistics[t]);return e}_fillFrom8Bit(e){const{mask:t,maskIsAlpha:i,pixels:r}=this;if(!e||!r||!r.length)return void h.error("getAsRGBA()","Unable to convert to RGBA. The input pixel block is empty.");let s,n,a,o;s=n=a=r[0],r.length>=3?(n=r[1],a=r[2]):2===r.length&&(n=r[1]);const l=new Uint32Array(e),u=this.width*this.height;if(s.length===u)if(t&&t.length===u)if(i)for(o=0;o<u;o++)t[o]&&(l[o]=t[o]<<24|a[o]<<16|n[o]<<8|s[o]);else for(o=0;o<u;o++)t[o]&&(l[o]=255<<24|a[o]<<16|n[o]<<8|s[o]);else for(o=0;o<u;o++)l[o]=255<<24|a[o]<<16|n[o]<<8|s[o];else h.error("getAsRGBA()","Unable to convert to RGBA. The pixelblock is invalid.")}_fillFromNon8Bit(e){const{pixels:t,mask:i,statistics:r}=this;if(!e||!t||!t.length)return void h.error("getAsRGBA()","Unable to convert to RGBA. The input pixel block is empty.");const s=this.pixelType;let n=1,a=0,o=1;if(r&&r.length>0)a=r.map((e=>e.minValue)).reduce(((e,t)=>Math.min(e,t))),o=r.map((e=>e.maxValue-e.minValue)).reduce(((e,t)=>Math.max(e,t))),n=255/o;else{let e=255;"s8"===s?(a=-128,e=127):"u16"===s?e=65535:"s16"===s?(a=-32768,e=32767):"u32"===s?e=4294967295:"s32"===s?(a=-2147483648,e=2147483647):"f32"===s?(a=-34e38,e=34e38):"f64"===s&&(a=-Number.MAX_VALUE,e=Number.MAX_VALUE),n=255/(e-a)}const l=new Uint32Array(e),u=this.width*this.height;let c,d,p,f,y;if(c=d=p=t[0],c.length!==u)return h.error("getAsRGBA()","Unable to convert to RGBA. The pixelblock is invalid.");if(t.length>=2)if(d=t[1],t.length>=3&&(p=t[2]),i&&i.length===u)for(f=0;f<u;f++)i[f]&&(l[f]=255<<24|(p[f]-a)*n<<16|(d[f]-a)*n<<8|(c[f]-a)*n);else for(f=0;f<u;f++)l[f]=255<<24|(p[f]-a)*n<<16|(d[f]-a)*n<<8|(c[f]-a)*n;else if(i&&i.length===u)for(f=0;f<u;f++)y=(c[f]-a)*n,i[f]&&(l[f]=255<<24|y<<16|y<<8|y);else for(f=0;f<u;f++)y=(c[f]-a)*n,l[f]=255<<24|y<<16|y<<8|y}_fillFrom32Bit(e){const{pixels:t,mask:i}=this;if(!e||!t||!t.length)return h.error("getAsRGBAFloat()","Unable to convert to RGBA. The input pixel block is empty.");let r,s,n,a;r=s=n=t[0],t.length>=3?(s=t[1],n=t[2]):2===t.length&&(s=t[1]);const o=this.width*this.height;if(r.length!==o)return h.error("getAsRGBAFloat()","Unable to convert to RGBA. The pixelblock is invalid.");let l=0;if(i&&i.length===o)for(a=0;a<o;a++)e[l++]=r[a],e[l++]=s[a],e[l++]=n[a],e[l++]=1&i[a];else for(a=0;a<o;a++)e[l++]=r[a],e[l++]=s[a],e[l++]=n[a],e[l++]=1}_calculateBandStatistics(e,t){let i=1/0,r=-1/0;const s=e.length;let n,a=0;if(t)for(n=0;n<s;n++)t[n]&&(a=e[n],i=a<i?a:i,r=a>r?a:r);else for(n=0;n<s;n++)a=e[n],i=a<i?a:i,r=a>r?a:r;return{minValue:i,maxValue:r}}};(0,s.e)([(0,o.y)({json:{write:!0}})],u.prototype,"width",void 0),(0,s.e)([(0,o.y)({json:{write:!0}})],u.prototype,"height",void 0),(0,s.e)([(0,o.y)({json:{write:!0}})],u.prototype,"pixelType",void 0),(0,s.e)([(0,l.c)("pixelType")],u.prototype,"castPixelType",null),(0,s.e)([(0,o.y)({json:{write:!0}})],u.prototype,"validPixelCount",void 0),(0,s.e)([(0,o.y)({json:{write:!0}})],u.prototype,"mask",void 0),(0,s.e)([(0,o.y)({json:{write:!0}})],u.prototype,"maskIsAlpha",void 0),(0,s.e)([(0,o.y)({json:{write:!0}})],u.prototype,"pixels",void 0),(0,s.e)([(0,o.y)({json:{write:!0}})],u.prototype,"statistics",void 0),u=r=(0,s.e)([(0,o.n)("esri.layers.support.PixelBlock")],u);var c=u;const d=function(e){return e&&"esri.layers.support.PixelBlock"===e.declaredClass&&e.pixels&&e.pixels.length>0};function p(e,t){if(null==t||!t.length||!d(e))return e;const i=e.pixels.length;return t&&t.some((e=>e>=i))||1===i&&1===t.length&&0===t[0]?e:i!==t.length||t.some(((e,t)=>e!==t))?new c({pixelType:e.pixelType,width:e.width,height:e.height,mask:e.mask,validPixelCount:e.validPixelCount,maskIsAlpha:e.maskIsAlpha,pixels:t.map((t=>e.pixels[t])),statistics:e.statistics&&t.map((t=>e.statistics[t]))}):e}function f(e){if(!e)return;const t=e.colormap;if(!t||0===t.length)return;const i=t.sort(((e,t)=>e[0]-t[0]));let r=0;i[0][0]<0&&(r=i[0][0]);const s=Math.max(256,i[i.length-1][0]-r+1),n=new Uint8Array(4*s),a=[];let o,l=0,h=0;const u=5===i[0].length;if(s>65536)return i.forEach((e=>{a[e[0]-r]=u?e.slice(1):e.slice(1).concat([255])})),{indexed2DColormap:a,offset:r,alphaSpecified:u};if(e.fillUnspecified)for(o=i[h],l=o[0]-r;l<s;l++)n[4*l]=o[1],n[4*l+1]=o[2],n[4*l+2]=o[3],n[4*l+3]=u?o[4]:255,l===o[0]-r&&(o=h===i.length-1?o:i[++h]);else for(l=0;l<i.length;l++)o=i[l],h=4*(o[0]-r),n[h]=o[1],n[h+1]=o[2],n[h+2]=o[3],n[h+3]=u?o[4]:255;return{indexedColormap:n,offset:r,alphaSpecified:u}}function y(e,t){if(!d(e))return e;if(!t&&(t.indexedColormap||t.indexed2DColormap))return e;const i=e.clone(),r=i.pixels;let s=i.mask;const n=i.width*i.height;if(1!==r.length)return e;const{indexedColormap:a,indexed2DColormap:o,offset:l,alphaSpecified:h}=t,u=a.length-1;let c=0;const p=r[0],f=new Uint8Array(p.length),y=new Uint8Array(p.length),m=new Uint8Array(p.length);let g,_=0;if(a)if(s)for(c=0;c<n;c++)s[c]&&(_=4*(p[c]-l),_<l||_>u?s[c]=0:(f[c]=a[_],y[c]=a[_+1],m[c]=a[_+2],s[c]=a[_+3]));else{for(s=new Uint8Array(n),c=0;c<n;c++)_=4*(p[c]-l),_<l||_>u?s[c]=0:(f[c]=a[_],y[c]=a[_+1],m[c]=a[_+2],s[c]=a[_+3]);i.mask=s}else if(s)for(c=0;c<n;c++)s[c]&&(g=o[p[c]],f[c]=g[0],y[c]=g[1],m[c]=g[2],s[c]=g[3]);else{for(s=new Uint8Array(n),c=0;c<n;c++)g=o[p[c]],f[c]=g[0],y[c]=g[1],m[c]=g[2],s[c]=g[3];i.mask=s}return i.pixels=[f,y,m],i.statistics=null,i.pixelType="u8",i.maskIsAlpha=h,i}function m(e){if(!d(e))return null;e.statistics||e.updateStatistics();const{pixels:t,mask:i,pixelType:r,statistics:s}=e,n=e.width*e.height,a=t.length;let o,l,h,u,c;const p=[],f=[];let y,m,g,_,x,v,b,w,S,I;const C=256;for(u=0;u<a;u++){if(y=new Uint32Array(C),g=t[u],"u8"===r)if(o=-.5,l=255.5,i)for(c=0;c<n;c++)i[c]&&y[g[c]]++;else for(c=0;c<n;c++)y[g[c]]++;else{if(o=s[u].minValue,l=s[u].maxValue,h=(l-o)/C,m=new Uint32Array(257),i)for(c=0;c<n;c++)i[c]&&m[Math.floor((g[c]-o)/h)]++;else for(c=0;c<n;c++)m[Math.floor((g[c]-o)/h)]++;for(c=0;c<255;c++)y[c]=m[c];y[255]=m[255]+m[256]}for(p.push({min:o,max:l,size:C,counts:y}),_=0,x=0,w=0,c=0;c<C;c++)_+=y[c],x+=c*y[c];for(S=x/_,c=0;c<C;c++)w+=y[c]*(c-S)**2;I=Math.sqrt(w/(_-1)),h=(l-o)/C,v=(S+.5)*h+o,b=I*h,f.push({min:o,max:l,avg:v,stddev:b})}return{statistics:f,histograms:p}}function g(e){const t=[];for(let i=0;i<e.length;i++){const{min:r,max:s,size:n,counts:a}=e[i];let o=0,l=0;for(let e=0;e<n;e++)o+=a[e],l+=e*a[e];const h=l/o;let u=0;for(let e=0;e<n;e++)u+=a[e]*(e-h)**2;const c=(s-r)/n,d=(h+.5)*c+r,p=Math.sqrt(u/(o-1))*c;t.push({min:r,max:s,avg:d,stddev:p})}return t}function _(e){const{minCutOff:t,maxCutOff:i,gamma:r,pixelType:s}=e,n=e.outMin||0,a=e.outMax||255;if(-1===["u8","u16","s8","s16"].indexOf(s))return null;const o=t.length;let l,h,u=0;"s8"===s?u=-127:"s16"===s&&(u=-32767);let c=256;["u16","s16"].indexOf(s)>-1&&(c=65536);const d=[],p=[],f=a-n;for(l=0;l<o;l++)p[l]=i[l]-t[l],d[l]=f/(i[l]-t[l]);const y=r&&r.length>=o,m=[];if(y)for(l=0;l<o;l++)r[l]>1?r[l]>2?m[l]=6.5+(r[l]-2)**2.5:m[l]=6.5+100*(2-r[l])**4:m[l]=1;let g;const _=[];let x,v,b;if(y)for(l=0;l<o;l++){for(b=[],h=0;h<c;h++)x=h+u,g=(x-t[l])/p[l],v=1,r[l]>1&&(v-=(1/f)**(g*m[l])),x<i[l]&&x>t[l]?b[h]=Math.floor(v*f*g**(1/r[l]))+n:x>=i[l]?b[h]=a:b[h]=n;_[l]=b}else for(l=0;l<o;l++){for(b=[],h=0;h<c;h++)x=h+u,x<=t[l]?b[h]=n:x>=i[l]?b[h]=a:b[h]=Math.floor((x-t[l])/p[l]*f)+n;_[l]=b}if(null!=e.contrastOffset){const t=function(e,t){const i=Math.min(Math.max(e,-100),100),r=Math.min(Math.max(t,-100),100),s=255;let n,a;const o=new Uint8Array(256);for(n=0;n<256;n++)i>0&&i<100?a=(200*n-25500+510*r)/(2*(100-i))+128:i<=0&&i>-100?a=(200*n-25500+510*r)*(100+i)/2e4+128:100===i?(a=200*n-25500+256*(100-i)+510*r,a=a>0?s:0):-100===i&&(a=128),o[n]=a>s?s:a<0?0:a;return o}(e.contrastOffset,e.brightnessOffset);for(l=0;l<o;l++)for(b=_[l],h=0;h<c;h++)b[h]=t[b[h]]}return{lut:_,offset:u}}function x(e,t=256){t=Math.min(t,256);const{size:i,counts:r}=e,s=new Uint8Array(i),n=r.reduce(((e,i)=>e+i/t),0);let a=0,o=0,l=0,h=n;for(let e=0;e<i;e++)if(l+=r[e],!(e<i-1&&l+r[e+1]<h)){for(;a<t-1&&h<l;)a++,h+=n;for(let t=o;t<=e;t++)s[t]=a;o=e+1}for(let e=o;e<i;e++)s[e]=t-1;return s}function v(e,t){if(!d(e))return null;const i=e.clone(),{pixels:r,mask:s}=i,{minCutOff:n,maxCutOff:a,gamma:o}=t,l=t.outMin||0,h=t.outMax||255,u=i.width*i.height,c=r.length;let p,f,y,m,g;const _=h-l,x=[],v=[];for(p=0;p<c;p++)v[p]=a[p]-n[p],x[p]=_/(a[p]-n[p]);const b=o&&o.length>=c,w=[];if(b)for(p=0;p<c;p++)o[p]>1?o[p]>2?w[p]=6.5+(o[p]-2)**2.5:w[p]=6.5+100*(2-o[p])**4:w[p]=1;if(b)if(null!=s){for(f=0;f<u;f++)if(s[f])for(p=0;p<c;p++)y=r[p][f],g=(y-n[p])/v[p],m=1,o[p]>1&&(m-=(1/_)**(g*w[p])),y<a[p]&&y>n[p]?r[p][f]=Math.floor(m*_*g**(1/o[p]))+l:y>=a[p]?r[p][f]=h:r[p][f]=l}else for(f=0;f<u;f++)for(p=0;p<c;p++)y=r[p][f],g=(y-n[p])/v[p],m=1,o[p]>1&&(m-=(1/_)**(g*w[p])),y<a[p]&&y>n[p]?r[p][f]=Math.floor(m*_*g**(1/o[p]))+l:y>=a[p]?r[p][f]=h:r[p][f]=l;else if(null!=s){for(f=0;f<u;f++)if(s[f])for(p=0;p<c;p++)y=r[p][f],y<a[p]&&y>n[p]?r[p][f]=Math.floor((y-n[p])/v[p]*_)+l:y>=a[p]?r[p][f]=h:r[p][f]=l}else for(f=0;f<u;f++)for(p=0;p<c;p++)y=r[p][f],y<a[p]&&y>n[p]?r[p][f]=Math.floor((y-n[p])/v[p]*_)+l:y>=a[p]?r[p][f]=h:r[p][f]=l;return i.pixelType="u8",i.updateStatistics(),i}function b(e,t){if(!d(e))return null;const{pixels:i,mask:r}=e,s=e.width*e.height,n=i.length;let a=t.lut;const{offset:o}=t;let l,h;a&&1===a[0].length&&(a=i.map((()=>a)));const u=[];let p,f,y;if(o)if(null==r)for(l=0;l<n;l++){for(p=i[l],f=a[l],y=new Uint8Array(s),h=0;h<s;h++)y[h]=f[p[h]-o];u.push(y)}else for(l=0;l<n;l++){for(p=i[l],f=a[l],y=new Uint8Array(s),h=0;h<s;h++)r[h]&&(y[h]=f[p[h]-o]);u.push(y)}else if(null==r)for(l=0;l<n;l++){for(p=i[l],f=a[l],y=new Uint8Array(s),h=0;h<s;h++)y[h]=f[p[h]];u.push(y)}else for(l=0;l<n;l++){for(p=i[l],f=a[l],y=new Uint8Array(s),h=0;h<s;h++)r[h]&&(y[h]=f[p[h]]);u.push(y)}const m=new c({width:e.width,height:e.height,pixels:u,mask:r,pixelType:"u8"});return m.updateStatistics(),m}function w(e,t){if(!d(e))return null;const i=e.clone(),{pixels:r}=i,s=i.width*i.height,n=t.length,a=Math.floor(n/2),o=t[Math.floor(a)],l=r[0];let h,u,c,p,f,y,m=!1;const g=new Uint8Array(s),_=new Uint8Array(s),x=new Uint8Array(s);let v=i.mask;const b=4===t[0].mappedColor.length;for(v||(v=new Uint8Array(s),v.fill(b?255:1),i.mask=v),f=0;f<s;f++)if(v[f]){for(h=l[f],m=!1,y=a,u=o,c=0,p=n-1;p-c>1;){if(h===u.value){m=!0;break}h>u.value?c=y:p=y,y=Math.floor((c+p)/2),u=t[Math.floor(y)]}m||(h===t[c].value?(u=t[c],m=!0):h===t[p].value?(u=t[p],m=!0):h<t[c].value?(m=!1,u=null):h>t[c].value&&(h<t[p].value?(u=t[c],m=!0):p===n-1?(m=!1,u=null):(u=t[p],m=!0))),m?(g[f]=u.mappedColor[0],_[f]=u.mappedColor[1],x[f]=u.mappedColor[2],v[f]=u.mappedColor[3]):g[f]=_[f]=x[f]=v[f]=0}return i.pixels=[g,_,x],i.mask=v,i.pixelType="u8",i.maskIsAlpha=b,i}function S(e,t){if(!e||0===e.length)return null;const i=e.filter((e=>e.pixelBlock))[0];if(!i)return null;const r=(i.extent.xmax-i.extent.xmin)/i.pixelBlock.width,s=(i.extent.ymax-i.extent.ymin)/i.pixelBlock.height,n=.01*Math.min(r,s),a=e.sort(((e,t)=>Math.abs(e.extent.ymax-t.extent.ymax)>n?t.extent.ymax-e.extent.ymax:Math.abs(e.extent.xmin-t.extent.xmin)>n?e.extent.xmin-t.extent.xmin:0)),o=Math.min.apply(null,a.map((e=>e.extent.xmin))),l=Math.min.apply(null,a.map((e=>e.extent.ymin))),h=Math.max.apply(null,a.map((e=>e.extent.xmax))),u=Math.max.apply(null,a.map((e=>e.extent.ymax))),c={x:Math.round((t.xmin-o)/r),y:Math.round((u-t.ymax)/s)},d={width:Math.round((h-o)/r),height:Math.round((u-l)/s)},p={width:Math.round((t.xmax-t.xmin)/r),height:Math.round((t.ymax-t.ymin)/s)};return Math.round(d.width/i.pixelBlock.width)*Math.round(d.height/i.pixelBlock.height)!==a.length||c.x<0||c.y<0||d.width<p.width||d.height<p.height?null:{extent:t,pixelBlock:C(a.map((e=>e.pixelBlock)),d,c,p)}}function I(e,t,i,r,s,n){const{width:a,height:o}=i.block,{x:l,y:h}=i.offset,{width:u,height:c}=i.mosaic,d=function(e,t,i,r,s,n,a,o){return{xmin:s<=i*e?0:s<i*e+e?s-i*e:e,ymin:n<=r*t?0:n<r*t+t?n-r*t:t,xmax:s+a<=i*e?0:s+a<i*e+e?s+a-i*e:e,ymax:n+o<=r*t?0:n+o<r*t+t?n+o-r*t:t}}(a,o,r,s,l,h,u,c);let p=0,f=0;if(n){const e=n.hasGCSSShiftTransform?360:n.halfWorldWidth,t=a*n.resolutionX,i=n.startX+r*t,s=i+t;i<e&&s>e?f=n.rightPadding:i>=e&&(p=n.leftMargin-n.rightPadding,f=0)}if(d.xmax-=f,"number"!=typeof t)for(let i=d.ymin;i<d.ymax;i++){const n=(s*o+i-h)*u+(r*a-l)+p,c=i*a;for(let i=d.xmin;i<d.xmax;i++)e[n+i]=t[c+i]}else for(let i=d.ymin;i<d.ymax;i++){const n=(s*o+i-h)*u+(r*a-l)+p;for(let i=d.xmin;i<d.xmax;i++)e[n+i]=t}}function C(e,t,i,r,s){const n=e.filter((e=>d(e)))[0];if(null==n)return null;const a=r?r.width:t.width,o=r?r.height:t.height,l=n.width,h=n.height,u=t.width/l,p=t.height/h,f={offset:i||{x:0,y:0},mosaic:r||t,block:{width:l,height:h}},y=n.pixelType,m=c.getPixelArrayConstructor(y),g=n.pixels.length,_=[];let x,v,b;for(let t=0;t<g;t++){v=new m(a*o);for(let i=0;i<p;i++)for(let r=0;r<u;r++){const n=e[i*u+r];d(n)&&(x=n.pixels[t],I(v,x,f,r,i,s))}_.push(v)}if(e.some((e=>null==e||e.mask&&e.mask.length>0))){b=new Uint8Array(a*o);for(let t=0;t<p;t++)for(let i=0;i<u;i++){const r=e[t*u+i];I(b,(r?r.mask:null)||(r?1:0),f,i,t,s)}}const w=new c({width:a,height:o,pixels:_,pixelType:y,mask:b});return w.updateStatistics(),w}function M(e,t,i){if(!d(e))return null;const{width:r,height:s}=e,n=t.x,a=t.y,o=i.width+n,l=i.height+a;if(n<0||a<0||o>r||l>s)return e;if(0===n&&0===a&&o===r&&l===s)return e;e.mask||(e.mask=new Uint8Array(r*s));const h=e.mask;for(let e=0;e<s;e++){const t=e*r;for(let i=0;i<r;i++)h[t+i]=e<a||e>=l||i<n||i>=o?0:1}return e.updateStatistics(),e}function T(e){if(!d(e))return null;const t=e.clone(),{width:i,height:r,pixels:s,mask:n}=e,a=s[0],o=t.pixels[0];for(let e=2;e<r-1;e++){const t=new Map;for(let r=e-2;r<e+2;r++)for(let e=0;e<4;e++){const s=r*i+e;A(t,a[s],n?n[s]:1)}o[e*i]=E(t),o[e*i+1]=o[e*i+2]=o[e*i];let r=3;for(;r<i-1;r++){let s=(e-2)*i+r+1;A(t,a[s],n?n[s]:1),s=(e-1)*i+r+1,A(t,a[s],n?n[s]:1),s=e*i+r+1,A(t,a[s],n?n[s]:1),s=(e+1)*i+r+1,A(t,a[s],n?n[s]:1),s=(e-2)*i+r-3,F(t,a[s],n?n[s]:1),s=(e-1)*i+r-3,F(t,a[s],n?n[s]:1),s=e*i+r-3,F(t,a[s],n?n[s]:1),s=(e+1)*i+r-3,F(t,a[s],n?n[s]:1),o[e*i+r]=E(t)}o[e*i+r+1]=o[e*i+r]}for(let e=0;e<i;e++)o[e]=o[i+e]=o[2*i+e],o[(r-1)*i+e]=o[(r-2)*i+e];return t.updateStatistics(),t}function E(e){if(0===e.size)return 0;let t=0,i=-1,r=0;const s=e.keys();let n=s.next();for(;!n.done;)r=e.get(n.value),r>t&&(i=n.value,t=r),n=s.next();return i}function F(e,t,i){if(0===i)return;const r=e.get(t);1===r?e.delete(t):e.set(t,r-1)}function A(e,t,i){0!==i&&e.set(t,e.has(t)?e.get(t)+1:1)}function R(e,t,i){let{x:r,y:s}=t;const{width:n,height:a}=i;if(0===r&&0===s&&a===e.height&&n===e.width)return e;const{width:o,height:l}=e,h=Math.max(0,s),u=Math.max(0,r),p=Math.min(r+n,o),f=Math.min(s+a,l);if(p<0||f<0||!d(e))return null;r=Math.max(0,-r),s=Math.max(0,-s);const{pixels:y,mask:m}=e,g=n*a,_=y.length,x=[];for(let t=0;t<_;t++){const i=y[t],a=c.createEmptyBand(e.pixelType,g);for(let e=h;e<f;e++){const t=e*o;let l=(e+s-h)*n+r;for(let e=u;e<p;e++)a[l++]=i[t+e]}x.push(a)}const v=new Uint8Array(g);for(let e=h;e<f;e++){const t=e*o;let i=(e+s-h)*n+r;for(let e=u;e<p;e++)v[i++]=m?m[t+e]:1}const b=new c({width:i.width,height:i.height,pixelType:e.pixelType,pixels:x,mask:v});return b.updateStatistics(),b}function P(e,t=!0){if(!d(e))return null;const{pixels:i,width:r,height:s,mask:n,pixelType:a}=e,o=[],l=Math.round(r/2),h=Math.round(s/2),u=s-1,p=r-1;for(let e=0;e<i.length;e++){const n=i[e],d=c.createEmptyBand(a,l*h);let f=0;for(let e=0;e<s;e+=2)for(let i=0;i<r;i+=2){const s=n[e*r+i];if(t){const t=i===p?s:n[e*r+i+1],a=e===u?s:n[e*r+i+r],o=i===p?a:e===u?t:n[e*r+i+r+1];d[f++]=(s+t+a+o)/4}else d[f++]=s}o.push(d)}let f=null;if(n){f=new Uint8Array(l*h);let e=0;for(let i=0;i<s;i+=2)for(let s=0;s<r;s+=2){const a=n[i*r+s];if(t){const t=s===p?a:n[i*r+s+1],o=i===u?a:n[i*r+s+r],l=s===p?o:i===u?t:n[i*r+s+r+1];f[e++]=a*t*o*l?1:0}else f[e++]=a}}return new c({width:l,height:h,pixelType:a,pixels:o,mask:f})}function L(e,t,i){if(!d(e))return null;const{width:r,height:s}=t;let{width:n,height:a}=e;const o=new Map,l={x:0,y:0},h=null==i?1:1+i;let u=e;for(let e=0;e<h;e++){const i=Math.ceil(n/r),c=Math.ceil(a/s);for(let n=0;n<c;n++){l.y=n*s;for(let s=0;s<i;s++){l.x=s*r;const i=R(u,l,t);o.set(`${e}/${n}/${s}`,i)}}e<h-1&&(u=P(u)),n=Math.round(n/2),a=Math.round(a/2)}return o}function D(e,t,i,r,s="nearest"){if(!d(e))return null;"majority"===s&&(e=T(e));const{pixels:n,mask:a,pixelType:o}=e,l=e.width,h=e.height,u=c.getPixelArrayConstructor(o),p=n.length,{width:f,height:y}=t,m=r.cols,g=r.rows,_=Math.ceil(f/m),x=Math.ceil(y/g);let v,b,w,S,I,C,M,E=!1;for(let e=0;e<i.length;e+=3)-1===i[e]&&-1===i[e+1]&&-1===i[e+2]&&(E=!0);const F=new Float32Array(f*y),A=new Float32Array(f*y);let R,P,L=0;const D="majority"===s?0:.5;for(let e=0;e<x;e++)for(let t=0;t<_;t++){v=12*(e*_+t),b=i[v],w=i[v+1],S=i[v+2],I=i[v+3],C=i[v+4],M=i[v+5];for(let i=0;i<g;i++){L=(e*g+i)*f+t*m,P=(i+.5)/g;for(let e=0;e<i;e++)R=(e+.5)/m,F[L+e]=Math.round((b*R+w*P+S)*l-D),A[L+e]=Math.round((I*R+C*P+M)*h-D)}v+=6,b=i[v],w=i[v+1],S=i[v+2],I=i[v+3],C=i[v+4],M=i[v+5];for(let i=0;i<g;i++){L=(e*g+i)*f+t*m,P=(i+.5)/g;for(let e=i;e<m;e++)R=(e+.5)/m,F[L+e]=Math.round((b*R+w*P+S)*l-D),A[L+e]=Math.round((I*R+C*P+M)*h-D)}}const N=(e,t)=>{for(let i=0;i<y;i++){v=i*f;for(let i=0;i<f;i++)F[v]<0||A[v]<0?e[v]=0:e[v]=t[F[v]+A[v]*l],v++}},O=[];let k;for(let e=0;e<p;e++)k=new u(f*y),N(k,n[e]),O.push(k);const V=new c({width:f,height:y,pixelType:o,pixels:O});if(a)V.mask=new Uint8Array(f*y),N(V.mask,a);else if(E){V.mask=new Uint8Array(f*y);for(let e=0;e<f*y;e++)V.mask[e]=F[e]<0||A[e]<0?0:1}return V.updateStatistics(),V}},81578:(e,t,i)=>{"use strict";i.d(t,{d:()=>a,t:()=>n});var r=i(80219),s=i(52957);async function n(e,t=e.popupTemplate){if(!(0,r.r)(t))return[];const i=await t.getRequiredFields(e.fieldsIndex),{lastEditInfoEnabled:n}=t,{objectIdField:a,typeIdField:o,globalIdField:l,relationships:h}=e;if(i.includes("*"))return["*"];const u=n?await(0,s.D)(e):[],c=(0,s.p)(e.fieldsIndex,[...i,...u]);return o&&c.push(o),c&&a&&e.fieldsIndex.has(a)&&-1===c.indexOf(a)&&c.push(a),c&&l&&e.fieldsIndex.has(l)&&-1===c.indexOf(l)&&c.push(l),h&&h.forEach((t=>{const{keyField:i}=t;c&&i&&e.fieldsIndex.has(i)&&-1===c.indexOf(i)&&c.push(i)})),c}function a(e,t){return e.popupTemplate?e.popupTemplate:(0,r.r)(t)&&t.defaultPopupTemplateEnabled&&(0,r.r)(e.defaultPopupTemplate)?e.defaultPopupTemplate:null}},87495:(e,t,i)=>{"use strict";i.r(t),i.d(t,{l:()=>l,p:()=>d,t:()=>o});var r=i(20215),s=i(74075),n=i(76326),a=i(42495);function o(e,t){return!!e.typeKeywords&&e.typeKeywords.indexOf(t)>-1}function l(e){switch(e.type){case"Map Service":return(t=e,(0,a.n)(t.url).then((e=>e.tileInfo))).then((e=>e?{className:"TileLayer"}:{className:"MapImageLayer"}));case"Feature Service":return function(e){return u(e).then((e=>{if("object"==typeof e){const t={};return null!=e.id&&(t.layerId=e.id),{className:"FeatureLayer",properties:t}}return{className:"GroupLayer"}}))}(e);case"Feature Collection":return async function(e){if(await e.load(),o(e,"Map Notes"))return{className:"MapNotesLayer"};if(o(e,"Route Layer"))return{className:"RouteLayer"};const t=await e.fetchData();return 1===(0,a.h)(t)?{className:"FeatureLayer"}:{className:"GroupLayer"}}(e);case"Scene Service":return function(e){return u(e).then((t=>{if("object"==typeof t){const i={};let r;if(null!=t.id?(i.layerId=t.id,r=`${e.url}/layers/${t.id}`):r=e.url,Array.isArray(e.typeKeywords)&&e.typeKeywords.length>0){const t={IntegratedMesh:"IntegratedMeshLayer","3DObject":"SceneLayer",Point:"SceneLayer",PointCloud:"PointCloudLayer",Building:"BuildingSceneLayer"};for(const i of Object.keys(t))if(-1!==e.typeKeywords.indexOf(i))return{className:t[i]}}return(0,a.n)(r).then((e=>{let t="SceneLayer";const r={Point:"SceneLayer","3DObject":"SceneLayer",IntegratedMesh:"IntegratedMeshLayer",PointCloud:"PointCloudLayer",Building:"BuildingSceneLayer"};return e&&e.layerType&&r[e.layerType]&&(t=r[e.layerType]),{className:t,properties:i}}))}return{className:"GroupLayer"}}))}(e);case"Image Service":return async function(e){var t,i,r;await e.load();const s=null!=(t=null==(i=e.typeKeywords)?void 0:i.map((e=>e.toLowerCase())))?t:[];if(s.indexOf("elevation 3d layer")>-1)return{className:"ElevationLayer"};if(s.indexOf("tiled imagery")>-1)return{className:"ImageryTileLayer"};const n=await e.fetchData(),o=null==n?void 0:n.layerType;return"ArcGISTiledImageServiceLayer"===o?{className:"ImageryTileLayer"}:"ArcGISImageServiceLayer"===o?{className:"ImageryLayer"}:"map"===(null==(r=(await(0,a.n)(e.url)).cacheType)?void 0:r.toLowerCase())?{className:"ImageryTileLayer"}:{className:"ImageryLayer"}}(e);case"Stream Service":return{className:"StreamLayer"};case"Vector Tile Service":return{className:"VectorTileLayer"};case"KML":return{className:"KMLLayer"};case"WFS":return{className:"WFSLayer"};case"WMTS":return{className:"WMTSLayer"};case"WMS":return{className:"WMSLayer"};case"Feed":return{className:"StreamLayer"};default:return Promise.reject(new r.s("portal:unknown-item-type","Unknown item type '${type}'",{type:e.type}))}var t}function h(e){return(0,s.a[e.className])().then((t=>({constructor:t,properties:e.properties})))}function u(e){return!e.url||e.url.match(/\/\d+$/)?Promise.resolve({}):e.load().then((()=>e.fetchData())).then((async t=>"Feature Service"===e.type?c(t=await(0,a.m)(t,e.url)):(0,a.h)(t)>0?c(t):(0,a.n)(e.url).then(c)))}function c(e){return 1===(0,a.h)(e)&&{id:(0,a.f)(e)}}var d=Object.freeze({__proto__:null,fromItem:function(e){return!e.portalItem||e.portalItem instanceof n.default||(e={...e,portalItem:new n.default(e.portalItem)}),function(e){return e.load().then(l).then(h)}(e.portalItem).then((t=>{const i={portalItem:e.portalItem,...t.properties},r=t.constructor;return Promise.resolve(new r(i))}))},selectLayerClassPath:l})},74589:(e,t,i)=>{"use strict";i.d(t,{t:()=>n});var r=i(20736),s=i(41392);function n(e){const t=e.view.spatialReference,i=e.layer.fullExtent,n=i&&i.spatialReference;return n?n.equals(t)?Promise.resolve(i.clone()):(0,r.x)(n,t)?Promise.resolve((0,r.g)(i,t)):e.view.state.isLocal?(0,s.projectGeometry)(i,t,e.layer.portalItem).then((t=>!e.destroyed&&t?t:void 0)).catch((()=>null)):Promise.resolve(null):Promise.resolve(null)}},29986:(e,t,i)=>{"use strict";i.d(t,{j:()=>m,p:()=>c,y:()=>f});var r=i(7571),s=i(26882),n=i(92858),a=i(20736);const o=[0,0];function l(e,t){if(!t)return null;if("x"in t){const i={x:0,y:0};return[i.x,i.y]=e(t.x,t.y,o),null!=t.z&&(i.z=t.z),null!=t.m&&(i.m=t.m),i}if("xmin"in t){const i={xmin:0,ymin:0,xmax:0,ymax:0};return[i.xmin,i.ymin]=e(t.xmin,t.ymin,o),[i.xmax,i.ymax]=e(t.xmax,t.ymax,o),t.hasZ&&(i.zmin=t.zmin,i.zmax=t.zmax,i.hasZ=!0),t.hasM&&(i.mmin=t.mmin,i.mmax=t.mmax,i.hasM=!0),i}return"rings"in t?{rings:h(t.rings,e),hasM:t.hasM,hasZ:t.hasZ}:"paths"in t?{paths:h(t.paths,e),hasM:t.hasM,hasZ:t.hasZ}:"points"in t?{points:u(t.points,e),hasM:t.hasM,hasZ:t.hasZ}:void 0}function h(e,t){const i=[];for(const r of e)i.push(u(r,t));return i}function u(e,t){const i=[];for(const r of e){const e=t(r[0],r[1],[0,0]);i.push(e),r.length>2&&e.push(r[2]),r.length>3&&e.push(r[3])}return i}async function c(e,t){if(!t)return;const i=Array.isArray(e)?e.map((e=>{var t;return null==(t=e.geometry)?void 0:t.spatialReference})):[e];await(0,r.e)(i.map((e=>({source:e,dest:t}))))}const d=l.bind(null,a.M),p=l.bind(null,a.y);function f(e,t,i){return e?(i||(i=t,t=e.spatialReference),(0,n.s)(t)&&(0,n.s)(i)&&!(0,n.d)(t,i)?(0,a.x)(t,i)?(0,n.u)(i)?d(e):p(e):(0,r.J)(s.t,[e],t,i,null)[0]:e):e}const y=new class{constructor(){this._jobs=[],this._timer=null,this._process=this._process.bind(this)}async push(e,t,i){if(!e||!e.length||!t||!i||(0,n.d)(t,i))return e;const r={geometries:e,inSpatialReference:t,outSpatialReference:i,resolve:null};return this._jobs.push(r),new Promise((e=>{r.resolve=e,null===this._timer&&(this._timer=setTimeout(this._process,10))}))}_process(){this._timer=null;const e=this._jobs.shift();if(!e)return;const{geometries:t,inSpatialReference:i,outSpatialReference:o,resolve:l}=e;(0,a.x)(i,o)?(0,n.u)(o)?l(t.map(d)):l(t.map(p)):l((0,r.J)(s.t,t,i,o,null)),this._jobs.length>0&&(this._timer=setTimeout(this._process,10))}};function m(e,t,i){return y.push(e,t,i)}},57424:(e,t,i)=>{"use strict";i.d(t,{a:()=>a});var r,s,n={exports:{}};r=n,void 0!==(s=function(){function e(i,r,s,n,a){for(;n>s;){if(n-s>600){var o=n-s+1,l=r-s+1,h=Math.log(o),u=.5*Math.exp(2*h/3),c=.5*Math.sqrt(h*u*(o-u)/o)*(l-o/2<0?-1:1);e(i,r,Math.max(s,Math.floor(r-l*u/o+c)),Math.min(n,Math.floor(r+(o-l)*u/o+c)),a)}var d=i[r],p=s,f=n;for(t(i,s,r),a(i[n],d)>0&&t(i,s,n);p<f;){for(t(i,p,f),p++,f--;a(i[p],d)<0;)p++;for(;a(i[f],d)>0;)f--}0===a(i[s],d)?t(i,s,f):t(i,++f,n),f<=r&&(s=f+1),r<=f&&(n=f-1)}}function t(e,t,i){var r=e[t];e[t]=e[i],e[i]=r}function i(e,t){return e<t?-1:e>t?1:0}return function(t,r,s,n,a){e(t,r,s||0,n||t.length-1,a||i)}}())&&(r.exports=s);var a=n.exports},43231:(e,t,i)=>{"use strict";i.d(t,{C:()=>T,G:()=>C,L:()=>E,M:()=>p,P:()=>M,W:()=>S,g:()=>f,j:()=>_,w:()=>m,y:()=>d,z:()=>I}),i(33807),i(80987);var r=i(20215),s=i(80219),n=i(65352),a=i(7571),o=i(20736),l=i(98548);const h=5e-4,u=function(e,t){const i=(e.isWGS84||e.isWebMercator)&&(t.isWGS84||t.isWebMercator);return!(e.equals(t)||i)},c={3395:20037508.342789244,3410:17334193.943686873,3832:3339584.723798206,3857:20037508.342788905,3975:17367530.445161372,4087:20037508.342789244,4088:20015108.787169147,6933:17367530.445161372,8858:7396237.374497803,8859:2465412.4581659334,32662:20037508.342789244,53001:20015086.79602057,53002:10007543.39801029,53003:20015086.79602057,53004:20015086.79602057,53016:14152803.599503474,53017:17333573.624304302,53025:7276828.3848298555,53031:10384677.558821043,53034:20015086.79602057,53036:7389443.187332862,53037:2463147.729110953,53079:20015114.352186374,53080:20015114.352186374,54001:20037508.342789244,54002:10018754.171394624,54003:20037508.342789244,54004:20037508.342789244,54016:14168658.027268292,54017:17367530.44516137,54025:7311399.09166516,54031:10396310.810074743,54034:20037508.342789244,54050:808820.9223376509,54053:1920897.3915568967,54079:20037508.342789244,54080:20037508.342789244,54099:13524439.768288724,54100:20037508.342789244,54101:20037508.342789244,102038:4297258.582585486,102299:5013965.117483125};async function d(){if((0,a.V)()||!(0,a.X)())return null;await(0,a.D)()}function p(e,t,i){if(!u(e.spatialReference,t))return null;if(!(0,a.V)())throw new r.s("rasterprojectionhelper-projectResolution","projection engine is not loaded");return i?(0,a.O)(t,e.spatialReference,e):(0,a.O)(e.spatialReference,t,e)}function f(e,t,i,s=null){if(e.spatialReference.equals(t))return e;const n=u(e.spatialReference,t);if(n&&!(0,a.V)())throw new r.s("rasterprojectionhelper-projectResolution","projection engine is not loaded");const h=i.center,c=new l.M({xmin:h.x-e.x/2,xmax:h.x+e.x/2,ymin:h.y-e.y/2,ymax:h.y+e.y/2,spatialReference:e.spatialReference}),d=n?(0,a.H)(c,t,s):(0,o.g)(c,t);return null==d?null:{x:d.xmax-d.xmin,y:d.ymax-d.ymin}}function y(e,t=.01){return(0,n.G)(e)?t/(0,n.G)(e):0}function m(e,t,i=null,s=!0){const n=e.spatialReference;if(n.equals(t))return e;const l=u(n,t);if(l&&!(0,a.V)())throw new r.s("rasterprojectionhelper-projectResolution","projection engine is not loaded");const c=l?(0,a.H)(e,t,i):(0,o.g)(e,t);if(c&&s&&t.isGeographic){const[t,i]=b(n,!0),r=y(n);r&&null!=t&&null!=i&&(Math.abs(e.x-t)<r&&Math.abs(180-c.x)<h?c.x-=360:Math.abs(e.x-i)<r&&Math.abs(180+c.x)<h&&(c.x+=360))}return c}function g(e){const t=v(e[0].spatialReference);if(e.length<2||!(0,s.r)(t))return e[0];let{xmin:i,xmax:r,ymin:n,ymax:a}=e[0];for(let i=1;i<e.length;i++){const s=e[i];r=s.xmax+t*i,n=Math.min(n,s.ymin),a=Math.max(a,s.ymax)}return new l.M({xmin:i,xmax:r,ymin:n,ymax:a,spatialReference:e[0].spatialReference})}function _(e,t,i=null,r=!0){if(e.spatialReference.equals(t))return e;const n=S(e),a=v(e.spatialReference,!0);return(0,s.r)(a)&&0!==n?g(e.clone().normalize().map((e=>x(e,t,i,r)))):x(e,t,i,r)}function x(e,t,i=null,s=!0){const n=e.spatialReference;if(n.equals(t))return e;const l=u(n,t);if(l&&!(0,a.V)())throw new r.s("rasterprojectionhelper-projectExtent","projection engine is not loaded");const c=l?(0,a.H)(e,t,i):(0,o.g)(e,t);let[d,p]=b(n,!0);if(c&&s&&n.isWebMercator&&t.isGeographic&&null!=d&&null!=p){const r=.001,s=1e3;if(Math.abs(e.xmin-d)<r&&Math.abs(p-e.xmax)>s&&Math.abs(180-c.xmax)<h){c.xmin=-180;const r=[];r.push(new o.b(e.xmax,e.ymin,n)),r.push(new o.b(e.xmax,(e.ymin+e.ymax)/2,n)),r.push(new o.b(e.xmax,e.ymax,n));const s=r.map((e=>m(e,t,i))).filter((e=>!isNaN(null==e?void 0:e.x))).map((e=>e.x));c.xmax=Math.max.apply(null,s)}if(Math.abs(e.xmax-p)<r&&Math.abs(d-e.xmin)>s&&Math.abs(180+c.xmin)<h){c.xmax=180;const r=[];r.push(new o.b(e.xmin,e.ymin,n)),r.push(new o.b(e.xmin,(e.ymin+e.ymax)/2,n)),r.push(new o.b(e.xmin,e.ymax,n));const s=r.map((e=>m(e,t,i))).filter((e=>!isNaN(null==e?void 0:e.x))).map((e=>e.x));c.xmin=Math.min.apply(null,s)}}[d,p]=b(t,!0);const f=y(t);return f&&null!=d&&null!=p&&(Math.abs(c.xmin-d)<f&&(c.xmin=d),Math.abs(c.xmax-p)<f&&(c.xmax=p)),c}function v(e,t=!1){const i=t?20037508.342787:20037508.342788905;return e.isWebMercator?2*i:e.wkid&&e.isGeographic?360:2*c[e.wkid]||null}function b(e,t=!1){const i=[],r=v(e,t);return(0,s.r)(r)&&(i.push(-r/2),i.push(r/2)),i}function w(e,t,i,r){let s=(e-t)/i;return s-Math.floor(s)!=0?s=Math.floor(s):r&&(s-=1),s}function S(e,t=!1){const i=v(e.spatialReference);if(!(0,s.r)(i))return 0;const r=t?0:-i/2;return w(e.xmax,r,i,!0)-w(e.xmin,r,i,!1)}function I(e){const t=e.storageInfo.origin.x,i=v(e.spatialReference,!0);if(!(0,s.r)(i))return{originX:t,halfWorldWidth:null,pyramidsInfo:null};const r=i/2,{nativePixelSize:n,storageInfo:a,extent:o}=e,{maximumPyramidLevel:l,blockWidth:h,pyramidScalingFactor:u}=a;let c=n.x;const d=[],p=(0,s.r)(e.transform)&&"gcs-shift"===e.transform.type,f=t+r,y=p?i-t:r-t;for(let e=0;e<=l;e++){const e=(o.xmax-t)/c/h,r=e-Math.floor(e)==0?e:Math.ceil(e),s=(i/2-t)/c/h,n=s-Math.floor(s)==0?s:Math.ceil(s),a=Math.floor(f/c/h),l=Math.round(f/c)%h,p=(h-Math.round(y/c)%h)%h;d.push({resolutionX:c,blockWidth:h,datsetColumnCount:r,worldColumnCountFromOrigin:n,leftMargin:l,rightPadding:p,originColumnOffset:a}),c*=u}return{originX:t,halfWorldWidth:r,pyramidsInfo:d,hasGCSSShiftTransform:p}}function C(e,t,i,n=null,l=null,h=!1,c=[32,32]){if(u(e.spatialReference,t.spatialReference)&&!(0,a.V)())throw new r.s("rasterprojectionhelper-projectResolution","projection engine is not loaded");if(!(e&&t&&i))return null;const{xmin:d,ymin:p,xmax:f,ymax:y}=e,g=e.spatialReference,_=t.spatialReference,x=v(_);h=h||"gcs-shift"===(null==l?void 0:l.type);const b={x:c[0]*i.x,y:c[1]*i.y},w={cols:Math.ceil((f-d)/b.x-.1)+1,rows:Math.ceil((y-p)/b.y-.1)+1},S=b.x,I=b.y,C=[];let M,T=!1;for(let e=0;e<w.cols;e++){const i=[];for(let r=0;r<w.rows;r++){let a=m(new o.b({x:d+S*e,y:y-I*r,spatialReference:g}),_,n);l&&(a=l.inverseTransform(a)),i.push(a),e>0&&h&&a&&M[r]&&(0,s.r)(x)&&a.x<M[r].x&&(a.x+=x),a?(C.push((a.x-t.xmin)/(t.xmax-t.xmin)),C.push((t.ymax-a.y)/(t.ymax-t.ymin))):(C.push(NaN),C.push(NaN),T=!0)}M=i}const E=function(e,t){const i=(e[0]+e[4]+e[4*t.cols]+e[4*t.cols+4])/4,r=(e[1]+e[5]+e[4*t.rows+1]+e[4*t.rows+5])/4;return[Math.abs(i-e[2*t.rows+2]),Math.abs(r-e[2*t.rows+3])]}(C,w),F=new Float32Array((w.cols-1)*(w.rows-1)*2*6),A=new Float32Array([-0,-1,1,-1,1,-0,1,-0,-0]),R=new Float32Array([-1,1,0,0,-1,1,1,0,0]);for(let e=0;e<w.cols-1;e++){for(let t=0;t<w.rows-1;t++){let i=e*w.rows*2+2*t;const r=C[i],s=C[i+1],n=C[i+2],a=C[i+3];i+=2*w.rows;const o=C[i],l=C[i+1],h=C[i+2],u=C[i+3];let c=0,d=12*(t*(w.cols-1)+e);for(let e=0;e<3;e++)F[d++]=A[c++]*r+A[c++]*n+A[c++]*h;c=0;for(let e=0;e<3;e++)F[d++]=A[c++]*s+A[c++]*a+A[c++]*u;c=0;for(let e=0;e<3;e++)F[d++]=R[c++]*r+R[c++]*o+R[c++]*h;c=0;for(let e=0;e<3;e++)F[d++]=R[c++]*s+R[c++]*l+R[c++]*u}if(T)for(let e=0;e<F.length;e++)isNaN(F[e])&&(F[e]=-1)}return{offsets:C,error:E,coefficients:F,spacing:c,size:[w.cols-1,w.rows-1]}}function M(e){const t=e.clone().normalize();return 1===t.length?t[0]:g(t)}function T(e,t,i){const{storageInfo:r,pixelSize:n}=t;let a,l=!1;const{pyramidResolutions:h}=r;if((0,s.r)(h)&&h.length){const r=(e.x+e.y)/2,s=h[h.length-1],u=(s.x+s.y)/2,c=(n.x+n.y)/2;if(r<=c)a=0;else if(r>=u)a=h.length,l=r/u>8;else{let e,t=c;for(let s=1;s<=h.length;s++){if(e=(h[s-1].x+h[s-1].y)/2,r<=e){r===e?a=s:"down"===i?(a=s-1,l=r/t>8):a="up"===i||r-t>e-r||r/t>2?s:s-1;break}t=e}}const d=0===a?n:h[a-1];return{pyramidLevel:a,pyramidResolution:new o.b({x:d.x,y:d.y,spatialReference:t.spatialReference}),excessiveReading:l}}const u=Math.log(e.x/n.x)/Math.LN2,c=Math.log(e.y/n.y)/Math.LN2,d=t.storageInfo.maximumPyramidLevel||0;a="down"===i?Math.floor(Math.min(u,c)):"up"===i?Math.ceil(Math.max(u,c)):Math.round((u+c)/2),a<0?a=0:a>d&&(l=a>d+3,a=d);const p=2**a;return{pyramidLevel:a,pyramidResolution:new o.b({x:p*t.nativePixelSize.x,y:p*t.nativePixelSize.y,spatialReference:t.spatialReference}),excessiveReading:l}}function E(e,t,i=512,r=!0){const{extent:s,spatialReference:a,pixelSize:l}=e,h=f(new o.b({x:l.x,y:l.y,spatialReference:a}),t,s);if(null==h)return{projectedPixelSize:null,scales:null,srcResolutions:null,isCustomTilingScheme:!1};const u=(h.x+h.y)/2,c=(0,n.G)(t),d=u*c*96*39.37,p=t.isGeographic?256/i*295828763.7958547:256/i*591657527.591555;let y=!1;const m=_(s,t);r&&(t.isGeographic||t.isWebMercator)&&(y=m.xmin*m.xmax<0);let g,x=d;const v=1.001;if(y){x=p;const e=t.isGeographic?1341104507446289e-21:.29858214164761665,i=e*(96*c*39.37),r=t.isGeographic?4326:3857;g=f(new o.b({x:e,y:e,spatialReference:{wkid:r}}),a,m),g.x*=x/i,g.y*=x/i}else{g={x:l.x,y:l.y};const t=Math.ceil(Math.log(Math.min(e.width,e.height)/32)/Math.LN2);let i=0;for(;x<p*(v/2)&&i<t;)i++,x*=2,g.x*=2,g.y*=2;Math.max(x,p)/Math.min(x,p)<=v&&(x=p)}const b=[x],w=[{x:g.x,y:g.y}],S=Math.min(70.5310735,d)/v;for(;x>=S;)x/=2,g.x/=2,g.y/=2,b.push(x),w.push({x:g.x,y:g.y});return{projectedPixelSize:h,scales:b,srcResolutions:w,isCustomTilingScheme:!y}}},71252:(e,t,i)=>{"use strict";i.d(t,{M:()=>he,Q:()=>xe,S:()=>de,T:()=>ue,V:()=>ce,a:()=>J,b:()=>H,c:()=>K,d:()=>q,i:()=>$,n:()=>P,o:()=>X,p:()=>Q});var r=i(78155),s=i(80219),n=i(88903),a=i(31531),o=i(20215),l=i(26779),h=i(84935),u=i(17762),c=i(34396),d=i(29126),p=i(25681),f=i(4169),y=(i(80987),i(73574)),m=i(81135),g=i(71470),_=i(84581),x=i(48643),v=i(94527),b=i(11838),w=i(20736),S=(i(65352),i(47365));let I=class extends r.a{constructor(){super(...arguments),this.value=null,this.label=null,this.color=null}};(0,r.e)([(0,n.y)({type:Number,json:{write:!0}})],I.prototype,"value",void 0),(0,r.e)([(0,n.y)({type:String,json:{write:!0}})],I.prototype,"label",void 0),(0,r.e)([(0,n.y)({type:u.o,json:{type:[n.N],write:!0}})],I.prototype,"color",void 0),I=(0,r.e)([(0,n.n)("esri.renderers.support.ColormapInfo")],I);var C,M=I;let T=C=class extends r.a{constructor(e){super(e),this.colormapInfos=null,this.type="raster-colormap"}static createFromColormap(e,t){if(!e)return null;const i=5===e[0].length,r=[...e].sort((e=>e[0][0]-e[1][0])).map((e=>{var r;return M.fromJSON({value:e[0],color:i?e.slice(1,5):e.slice(1,4).concat([255]),label:t?null!=(r=t[e[0]])?r:"":e[0]})}));return new C({colormapInfos:r})}static createFromColorramp(e){const t=(0,p.f)(e,256);return C.createFromColormap(t)}clone(){return new C({colormapInfos:this.colormapInfos.map((e=>e.toJSON()))})}extractColormap(){return this.colormapInfos.map((e=>[e.value,e.color.r,e.color.g,e.color.b,e.color.a>1?e.color.a:255*e.color.a&255])).sort(((e,t)=>e[0]-t[0]))}};(0,r.e)([(0,n.y)({type:[M],json:{write:!0}})],T.prototype,"colormapInfos",void 0),(0,r.e)([(0,d.r)({rasterColormap:"raster-colormap"})],T.prototype,"type",void 0),T=C=(0,r.e)([(0,n.n)("esri.renderers.RasterColormapRenderer")],T);var E,F=T;let A=E=class extends r.a{constructor(e){super(e),this.altitude=45,this.azimuth=315,this.colorRamp=null,this.hillshadeType="multi-directional",this.pixelSizePower=.664,this.pixelSizeFactor=.024,this.scalingType="none",this.type="raster-shaded-relief",this.zFactor=1}readColorRamp(e){return(0,c.p)(e)}clone(){return new E({hillshadeType:this.hillshadeType,altitude:this.altitude,azimuth:this.azimuth,zFactor:this.zFactor,scalingType:this.scalingType,pixelSizeFactor:this.pixelSizeFactor,pixelSizePower:this.pixelSizePower,colorRamp:(0,s.y)(this.colorRamp)})}};(0,r.e)([(0,n.y)({type:Number,json:{write:!0}})],A.prototype,"altitude",void 0),(0,r.e)([(0,n.y)({type:Number,json:{write:!0}})],A.prototype,"azimuth",void 0),(0,r.e)([(0,n.y)({types:c.m,json:{write:!0}})],A.prototype,"colorRamp",void 0),(0,r.e)([(0,f.e)("colorRamp")],A.prototype,"readColorRamp",null),(0,r.e)([(0,n.y)({type:["traditional","multi-directional"],json:{write:!0}})],A.prototype,"hillshadeType",void 0),(0,r.e)([(0,n.y)({type:Number,json:{write:!0}})],A.prototype,"pixelSizePower",void 0),(0,r.e)([(0,n.y)({type:Number,json:{write:!0}})],A.prototype,"pixelSizeFactor",void 0),(0,r.e)([(0,n.y)({type:["none","adjusted"],json:{write:!0}})],A.prototype,"scalingType",void 0),(0,r.e)([(0,d.r)({rasterShadedRelief:"raster-shaded-relief"})],A.prototype,"type",void 0),(0,r.e)([(0,n.y)({type:Number,json:{write:!0}})],A.prototype,"zFactor",void 0),A=E=(0,r.e)([(0,n.n)("esri.renderers.RasterShadedReliefRenderer")],A);var R=A;const P=new a.o({none:"none",standardDeviation:"standard-deviation",histogramEqualization:"histogram-equalization",minMax:"min-max",percentClip:"percent-clip",sigmoid:"sigmoid"}),L={0:"none",3:"standardDeviation",4:"histogramEqualization",5:"minMax",6:"percentClip",9:"sigmoid"};var D;let N=D=class extends r.a{constructor(e){super(e),this.colorRamp=null,this.computeGamma=!1,this.dynamicRangeAdjustment=!1,this.gamma=[],this.maxPercent=null,this.minPercent=null,this.numberOfStandardDeviations=null,this.outputMax=null,this.outputMin=null,this.sigmoidStrengthLevel=null,this.statistics=[],this.histograms=null,this.useGamma=!1,this.stretchType="none",this.type="raster-stretch"}readColorRamp(e){if(e)return(0,c.p)(e)}writeStatistics(e,t,i){var r;null!=(r=e)&&r.length&&(Array.isArray(e[0])||(e=e.map((e=>[e.min,e.max,e.avg,e.stddev]))),t[i]=e)}readStretchType(e,t){let i=t.stretchType;return"number"==typeof i&&(i=L[i]),P.read(i)}clone(){return new D({stretchType:this.stretchType,outputMin:this.outputMin,outputMax:this.outputMax,useGamma:this.useGamma,computeGamma:this.computeGamma,statistics:(0,s.y)(this.statistics),gamma:(0,s.y)(this.gamma),sigmoidStrengthLevel:this.sigmoidStrengthLevel,numberOfStandardDeviations:this.numberOfStandardDeviations,minPercent:this.minPercent,maxPercent:this.maxPercent,colorRamp:(0,s.y)(this.colorRamp),histograms:(0,s.y)(this.histograms),dynamicRangeAdjustment:this.dynamicRangeAdjustment})}};(0,r.e)([(0,n.y)({types:c.m,json:{write:!0}})],N.prototype,"colorRamp",void 0),(0,r.e)([(0,f.e)("colorRamp")],N.prototype,"readColorRamp",null),(0,r.e)([(0,n.y)({type:Boolean,json:{write:!0}})],N.prototype,"computeGamma",void 0),(0,r.e)([(0,n.y)({type:Boolean,json:{write:{target:"dra"},read:{source:"dra"}}})],N.prototype,"dynamicRangeAdjustment",void 0),(0,r.e)([(0,n.y)({type:[Number],json:{write:!0}})],N.prototype,"gamma",void 0),(0,r.e)([(0,n.y)({type:Number,json:{write:!0}})],N.prototype,"maxPercent",void 0),(0,r.e)([(0,n.y)({type:Number,json:{write:!0}})],N.prototype,"minPercent",void 0),(0,r.e)([(0,n.y)({type:n.N,json:{write:!0}})],N.prototype,"numberOfStandardDeviations",void 0),(0,r.e)([(0,n.y)({type:Number,json:{read:{source:"max"},write:{target:"max"}}})],N.prototype,"outputMax",void 0),(0,r.e)([(0,n.y)({type:Number,json:{read:{source:"min"},write:{target:"min"}}})],N.prototype,"outputMin",void 0),(0,r.e)([(0,n.y)({type:Number,json:{write:!0}})],N.prototype,"sigmoidStrengthLevel",void 0),(0,r.e)([(0,n.y)({json:{type:[[Number]],write:!0}})],N.prototype,"statistics",void 0),(0,r.e)([(0,n.y)()],N.prototype,"histograms",void 0),(0,r.e)([(0,r.o)("statistics")],N.prototype,"writeStatistics",null),(0,r.e)([(0,n.y)({type:Boolean,json:{write:!0}})],N.prototype,"useGamma",void 0),(0,r.e)([(0,n.y)({type:P.apiValues,json:{type:P.jsonValues,write:P.write}})],N.prototype,"stretchType",void 0),(0,r.e)([(0,f.e)("stretchType",["stretchType"])],N.prototype,"readStretchType",null),(0,r.e)([(0,d.r)({rasterStretch:"raster-stretch"})],N.prototype,"type",void 0),N=D=(0,r.e)([(0,n.n)("esri.renderers.RasterStretchRenderer")],N);var O,k=N;const V=new Set(["esriMetersPerSecond","esriKilometersPerHour","esriKnots","esriFeetPerSecond","esriMilesPerHour"]),U=new a.o({esriMetersPerSecond:"meter-per-second",esriKilometersPerHour:"kilometer-per-hour",esriKnots:"knots",esriFeetPerSecond:"feet-per-second",esriMilesPerHour:"mile-per-hour"}),G=new a.o({beaufort_ft:"beaufort-ft",beaufort_km:"beaufort-km",beaufort_kn:"beaufort-kn",beaufort_m:"beaufort-m",beaufort_mi:"beaufort-mi",classified_arrow:"classified-arrow",ocean_current_kn:"ocean-current-kn",ocean_current_m:"ocean-current-m",simple_scalar:"simple-scalar",single_arrow:"single-arrow",wind_speed:"wind-barb"}),z=new a.o({flow_from:"flow-from",flow_to:"flow-to"});let B=O=class extends((0,c.v)(r.a)){constructor(e){super(e),this.attributeField="Magnitude",this.flowRepresentation="flow-from",this.rotationType="arithmetic",this.style="single-arrow",this.symbolTileSize=50,this.type="vector-field"}readInputUnit(e,t){return V.has(e)?U.fromJSON(e):null}readOutputUnit(e,t){return V.has(e)?U.fromJSON(e):null}get styleRenderer(){const e=this.style,t=this.attributeField,i=this._createStyleRenderer(e);return i.field=t,i}get sizeVariables(){const e=[];if(this.visualVariables)for(const t of this.visualVariables)"size"===t.type&&e.push(t);if(0===e.length){const t=new c.b({field:"Magnitude",minSize:.2*this.symbolTileSize,maxSize:.8*this.symbolTileSize});this.visualVariables?this.visualVariables.push(t):this._set("visualVariables",[t]),e.push(t)}return e}get rotationVariables(){const e=[];if(this.visualVariables)for(const t of this.visualVariables)"rotation"===t.type&&e.push(t);if(0===e.length){const t=new c.n({field:"Direction",rotationType:this.rotationType});this.visualVariables?this.visualVariables.push(t):this._set("visualVariables",[t]),e.push(t)}return e}clone(){return new O({attributeField:this.attributeField,flowRepresentation:this.flowRepresentation,rotationType:this.rotationType,symbolTileSize:this.symbolTileSize,style:this.style,visualVariables:(0,s.y)(this.visualVariables),inputUnit:this.inputUnit,outputUnit:this.outputUnit})}async getGraphicsFromPixelData(e,t=!1,i=[]){const r=[],s=(0,_.o)(this.inputUnit,this.outputUnit),n=t?(0,_.l)(e.pixelBlock,"vector-uv",this.rotationType,s):(0,_.c)(e.pixelBlock,"vector-magdir",s),a=e.extent,o=n.mask&&n.mask.length>0;let l=0;const h=(a.xmax-a.xmin)/n.width,u=(a.ymax-a.ymin)/n.height;for(let e=0;e<n.height;e++)for(let t=0;t<n.width;t++,l++){let s=new w.b({x:a.xmin+t*h+h/2,y:a.ymax-e*u-u/2,spatialReference:a.spatialReference});s=(await(0,g.L)(s))[0];const c=i.some((e=>e.intersects(s)));if((!o||n.mask[l])&&!c){const e={Magnitude:n.pixels[0][l],Direction:n.pixels[1][l]},t=new y.h({geometry:{type:"point",x:s.x,y:s.y,spatialReference:a.spatialReference},attributes:e});t.symbol=this._getVisualVariablesAppliedSymbol(t),r.push(t)}}return r}getSymbol(e,t){}async getSymbolAsync(e,t){}getSymbols(){return[]}getClassBreakInfos(){var e;return null==(e=this.styleRenderer)?void 0:e.classBreakInfos}getDefaultSymbol(){var e;return null==(e=this.styleRenderer)?void 0:e.defaultSymbol}_getDefaultSymbol(e){return new m.y({path:"M14,32 14,18 9,23 16,3 22,23 17,18 17,32 z",outline:new v.m({width:0}),size:20,color:e||new u.o([0,92,230])})}_getVisualVariablesAppliedSymbol(e){if(!e)return;let t=this.styleRenderer&&this.styleRenderer.getSymbol(e);t=t.clone();const i=this.sizeVariables,r=this.rotationVariables;if(i&&i.length&&this.sizeVariables.forEach((i=>(0,b.M)(t,(0,x.getAllSizes)([i],e)))),r&&r.length){const i=e.attributes.Direction;e.attributes.Direction="flow-from"===this.flowRepresentation?i:i+180,this.rotationVariables.forEach((i=>(0,b.q)(t,(0,x.getRotationAngle)(i,e),i.axis)))}return t}_createStyleRenderer(e){let t={defaultSymbol:this._getDefaultSymbol(),classBreakInfos:[]};switch(e){case"single-arrow":t=this._createSingleArrowRenderer();break;case"beaufort-kn":t=this._createBeaufortKnotsRenderer();break;case"beaufort-m":t=this._createBeaufortMeterRenderer();break;case"beaufort-ft":t=this._createBeaufortFeetRenderer();break;case"beaufort-mi":t=this._createBeaufortMilesRenderer();break;case"beaufort-km":t=this._createBeaufortKilometersRenderer();break;case"ocean-current-m":t=this._createCurrentMeterRenderer();break;case"ocean-current-kn":t=this._createCurrentKnotsRenderer();break;case"simple-scalar":t=this._createSimpleScalarRenderer();break;case"wind-barb":t=this._createWindBarbsRenderer();break;case"classified-arrow":t=this._createClassifiedArrowRenderer()}return new c.N(t)}_createSingleArrowRenderer(){return{defaultSymbol:this._getDefaultSymbol()}}_createBeaufortKnotsRenderer(){return{defaultSymbol:this._getDefaultSymbol(new u.o([214,47,39])),classBreakInfos:this._getClassBreaks([0,1,3,6,10,16,21,27,33,40,47,55,63],[[40,146,199],[89,162,186],[129,179,171],[160,194,155],[191,212,138],[218,230,119],[250,250,100],[252,213,83],[252,179,102],[250,141,52],[247,110,42],[240,71,29]])}}_createBeaufortMeterRenderer(){return{defaultSymbol:this._getDefaultSymbol(new u.o([214,47,39])),classBreakInfos:this._getClassBreaks([0,.2,1.8,3.3,5.4,8.5,11,14.1,17.2,20.8,24.4,28.6,32.7],[[69,117,181],[101,137,184],[132,158,186],[162,180,189],[192,204,190],[222,227,191],[255,255,191],[255,220,161],[250,185,132],[245,152,105],[237,117,81],[232,21,21]])}}_createBeaufortFeetRenderer(){const e=this._getDefaultSymbol(new u.o([214,47,39]));let t=[0,.2,1.8,3.3,5.4,8.5,11,14.1,17.2,20.8,24.4,28.6,32.7];return t=t.map((e=>3.28084*e)),{defaultSymbol:e,classBreakInfos:this._getClassBreaks(t,[[69,117,181],[101,137,184],[132,158,186],[162,180,189],[192,204,190],[222,227,191],[255,255,191],[255,220,161],[250,185,132],[245,152,105],[237,117,81],[232,21,21]])}}_createBeaufortMilesRenderer(){const e=this._getDefaultSymbol(new u.o([214,47,39]));let t=[0,.2,1.8,3.3,5.4,8.5,11,14.1,17.2,20.8,24.4,28.6,32.7];return t=t.map((e=>2.23694*e)),{defaultSymbol:e,classBreakInfos:this._getClassBreaks(t,[[69,117,181],[101,137,184],[132,158,186],[162,180,189],[192,204,190],[222,227,191],[255,255,191],[255,220,161],[250,185,132],[245,152,105],[237,117,81],[232,21,21]])}}_createBeaufortKilometersRenderer(){const e=this._getDefaultSymbol(new u.o([214,47,39]));let t=[0,.2,1.8,3.3,5.4,8.5,11,14.1,17.2,20.8,24.4,28.6,32.7];return t=t.map((e=>3.6*e)),{defaultSymbol:e,classBreakInfos:this._getClassBreaks(t,[[69,117,181],[101,137,184],[132,158,186],[162,180,189],[192,204,190],[222,227,191],[255,255,191],[255,220,161],[250,185,132],[245,152,105],[237,117,81],[232,21,21]])}}_createCurrentMeterRenderer(){return{defaultSymbol:this._getDefaultSymbol(new u.o([177,177,177])),classBreakInfos:this._getClassBreaks([0,.5,1,1.5,2],[[78,26,153],[179,27,26],[202,128,26],[177,177,177]])}}_createCurrentKnotsRenderer(){return{defaultSymbol:this._getDefaultSymbol(new u.o([177,177,177])),classBreakInfos:this._getClassBreaks([0,.25,.5,1,1.5,2,2.5,3,3.5,4],[[0,0,0],[0,37,100],[78,26,153],[151,0,100],[179,27,26],[177,78,26],[202,128,26],[177,179,52],[177,177,177]])}}_createClassifiedArrowRenderer(){var e;const t=this._getDefaultSymbol(new u.o([56,168,0]));let i=[0,1e-6,3.5,7,10.5,14];if(null!=(e=this.sizeVariables)&&e.length){const e=this.sizeVariables[0].minDataValue,t=this.sizeVariables[0].maxDataValue;if(e&&t){const r=(t-e)/5;i=Array.from(Array(6).keys()).map((t=>e+r*t))}}return{defaultSymbol:t,classBreakInfos:this._getClassBreaks(i,[[56,168,0],[139,309,0],[255,255,0],[255,128,0],[255,0,0]])}}_createSimpleScalarRenderer(){return{defaultSymbol:m.n.fromJSON({imageData:"iVBORw0KGgoAAAANSUhEUgAAACsAAAArCAQAAABLVLlLAAAABGdBTUEAAYagMeiWXwAAAAJiS0dEAACqjSMyAAAACXBIWXMAAABIAAAASABGyWs+AAAC3ElEQVRIx9XXvW4cVRQH8N982btpsIREJECyiCXsxX4DKh6AliqGKCBBE2SlwlHgAbBD/AKmyEYUeQ1KahPZSZQvBCkQLTHZ7KGY8Xodz4w3a1NwbzVzz/znfJ//zbStVC5q3icKak9GAs2QIdDx3PtW/S011NW3p+M5Eomh11ipTIKe6+4LQzHaQ+G+63pIZNJJQXMpljwTwj1brpgx5w1zZlyx5Z4QnllEIm2xeeSUHBf0hV0bejo1Uh09G3aFvgXk7cCJFBc9EdaRVuHJJaOdKyTV2TVhYLMduNR0Q9gxL5GaaTDw8GzejrDRBpxWoGsySRW0dttKuattwNkIlFw2YXgzOdYq4Ox49PlM+JrKd5OusjTWhBuVxUfMX/KXXZ3WEmkuqa67wspR4BTbwtKr/5u4fFgStse/T7EifFPnnYl9zPq4vmUOPrRndgoHjDti1gOPqlyXoifcRNGQzUd31lDyfHmob1Gp35vSr+P6vilcQ5Egtyd8YF/ySg9NhPM+9M/IOaHwp5+PSZayXTvCogEUwlatC3J8LLwYtcWB8EuDXQVuCkV5/B4eNHb7wGBs87LBDS+xjdVSn09wq1G8dFM+9tSUhIGneLvUdniKxKpTYljCpu3j7rVWlHj/P23v4NPGUEyeCQnexe9lJjzEQqMjJs+EzNAX6B98dBZVRmroJx95x/A/6gln18EyfCUsl+qdXb/tjvfbw+mwforpUOBz4XLVoBwAn3aWnfeH246NyBXhrq7TTN5lNSP9RkU+puUJm3W2Tsdq0nZWM07srk7MwQrZSRysjjGWBLRJNsNbfj2JMR4AbxpU1XLAb9Mxfpsq5EjMuuiR8L0JiHOOBX3hiUvOmavN0nMueSzcceFk0BK4pMqLo7vDD1Z0qrtDx7Itt4Xwm9UqbMmk8S0Dtuzb2pvOU99Z1nLTOfleNmvfZfP2pYZmPfajwosKdDBNpacNpVGGsWX9CyDI8Xq/Sj6QAAAAJXRFWHRkYXRlOmNyZWF0ZQAyMDE0LTExLTEwVDAzOjE3OjU4LTA1OjAwF+tHyQAAACV0RVh0ZGF0ZTptb2RpZnkAMjAxNC0xMS0xMFQwMzoxNzo1OC0wNTowMGa2/3UAAAAASUVORK5CYII=",height:20,width:20,type:"esriPMS",angle:0})}}_createWindBarbsRenderer(){const e=Array.from(Array(31).keys()).map((e=>5*e)),t=[{range:"0-5",path:"M20 20 M5 20 A15 15 0 1 0 35 20 A15 15 0 1 0 5 20 M20 20 M10 20 A10 10 0 1 0 30 20 A10 10 0 1 0 10 20",imageData:"PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIGhlaWdodD0iMzJweCIgd2lkdGg9IjMycHgiIHZpZXdCb3g9IjkgMCAyNiA0MSI+CiAgPHBhdGggZD0iTTIwIDIwIE01IDIwIEExNSAxNSAwIDEgMCAzNSAyMCBBMTUgMTUgMCAxIDAgNSAyMCBNMjAgMjAgTTEwIDIwIEExMCAxMCAwIDEgMCAzMCAyMCBBMTAgMTAgMCAxIDAgMTAgMjAiIHN0eWxlPSJzdHJva2U6cmdiKDAsMCwwKTtzdHJva2Utd2lkdGg6MS41Ii8+CiA8L3N2Zz4="},{range:"5-10",path:"M25 0 L25 40 M25 35 L17.5 37.5",imageData:"PHN2ZyB3aWR0aD0iMjAiIGhlaWdodD0iMjAiIHZpZXdCb3g9IjkgMCAyNyA0NiIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8cGF0aCBkPSJNMjUgMCBMMjUgNDAgTTI1IDM1IEwxNy41IDM3LjUiIHN0eWxlPSJzdHJva2U6cmdiKDAsMCwwKTtzdHJva2Utd2lkdGg6MS41Ii8+CiA8L3N2Zz4="},{range:"10-15",path:"M25 0 L25 40 L10 45 L25 40",imageData:"PHN2ZyB3aWR0aD0iMjAiIGhlaWdodD0iMjAiIHZpZXdCb3g9IjkgMCAyNyA0NiIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8cGF0aCBkPSJNMjUgMCBMMjUgNDAgTDEwIDQ1IEwyNSA0MCIgc3R5bGU9InN0cm9rZTpyZ2IoMCwwLDApO3N0cm9rZS13aWR0aDoxLjUiLz4KIDwvc3ZnPg=="},{range:"15-20",path:"M25 0 L25 40 L10 45 L25 40 M25 35 L17.5 37.5",imageData:"PHN2ZyB3aWR0aD0iMjAiIGhlaWdodD0iMjAiIHZpZXdCb3g9IjEyIDAgMTUgNDUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CiAgPHBhdGggZD0iTTI1IDAgTDI1IDQwIEwxMCA0NSBMMjUgNDAgTTI1IDM1IEwxNy41IDM3LjUiIHN0eWxlPSJzdHJva2U6cmdiKDAsMCwwKTtzdHJva2Utd2lkdGg6MS41Ii8+CiA8L3N2Zz4="},{range:"20-25",path:"M25 0 L25 40 L10 45 L25 40 M25 35 L10 40",imageData:"PHN2ZyB3aWR0aD0iMjAiIGhlaWdodD0iMjAiIHZpZXdCb3g9IjkgMCAyNiA0NiIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8cGF0aCBkPSJNMjUgMCBMMjUgNDAgTDEwIDQ1IEwyNSA0MCBNMjUgMzUgTDEwIDQwIiBzdHlsZT0ic3Ryb2tlOnJnYigwLDAsMCk7c3Ryb2tlLXdpZHRoOjEuNSIvPgogPC9zdmc+"},{range:"25-30",path:"M25 0 L25 40 L10 45 L25 40 M25 35 L10 40 L25 35 M25 30 L17.5 32.5",imageData:"PHN2ZyB3aWR0aD0iMjAiIGhlaWdodD0iMjAiIHZpZXdCb3g9IjkgMCAyNiA0NiIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8cGF0aCBkPSJNMjUgMCBMMjUgNDAgTDEwIDQ1IEwyNSA0MCBNMjUgMzUgTDEwIDQwIEwyNSAzNSBNMjUgMzAgTDE3LjUgMzIuNSIgc3R5bGU9InN0cm9rZTpyZ2IoMCwwLDApO3N0cm9rZS13aWR0aDoxLjUiLz4KIDwvc3ZnPg=="},{range:"30-35",path:"M25 0 L25 40 L10 45 L25 40 M25 35 L10 40 L25 35 M25 30 L10 35",imageData:"PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMHB4IiBoZWlnaHQ9IjIwcHgiIHZpZXdCb3g9IjkgMCAyNiA0NiI+CiAgPHBhdGggZD0iTTI1IDAgTDI1IDQwIEwxMCA0NSBMMjUgNDAgTTI1IDM1IEwxMCA0MCBMMjUgMzUgTTI1IDMwIEwxMCAzNSIgc3R5bGU9InN0cm9rZTpyZ2IoMCwwLDApO3N0cm9rZS13aWR0aDoxLjUiLz4KIDwvc3ZnPg=="},{range:"35-40",path:"M25 0 L25 40 L10 45 L25 40 M25 35 L10 40 L25 35 M25 30 L10 35 L25 30 M25 25 L17.5 27.5",imageData:"PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMHB4IiBoZWlnaHQ9IjIwcHgiIHZpZXdCb3g9IjkgMCAyNiA0NiI+CiAgPHBhdGggZD0iTTI1IDAgTDI1IDQwIEwxMCA0NSBMMjUgNDAgTTI1IDM1IEwxMCA0MCBMMjUgMzUgTTI1IDMwIEwxMCAzNSBMMjUgMzAgTTI1IDI1IEwxNy41IDI3LjUiIHN0eWxlPSJzdHJva2U6cmdiKDAsMCwwKTtzdHJva2Utd2lkdGg6MS41Ii8+CiA8L3N2Zz4="},{range:"40-45",path:"M25 0 L25 40 L10 45 L25 40 M25 35 L10 40 L25 35 M25 30 L10 35 L25 30 M25 25 L10 30",imageData:"PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMHB4IiBoZWlnaHQ9IjIwcHgiIHZpZXdCb3g9IjkgMCAyNiA0NiI+CiAgPHBhdGggZD0iTTI1IDAgTDI1IDQwIEwxMCA0NSBMMjUgNDAgTTI1IDM1IEwxMCA0MCBMMjUgMzUgTTI1IDMwIEwxMCAzNSBMMjUgMzAgTTI1IDI1IEwxMCAzMCIgc3R5bGU9InN0cm9rZTpyZ2IoMCwwLDApO3N0cm9rZS13aWR0aDoxLjUiLz4KIDwvc3ZnPg=="},{range:"45-50",path:"M25 0 L25 40 L10 45 L25 40 M25 35 L10 40 L25 35 M25 30 L10 35 L25 30 M25 25 L10 30 L25 25 M25 20 L17.5 22.5",imageData:"PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMHB4IiBoZWlnaHQ9IjIwcHgiIHZpZXdCb3g9IjkgMCAyNiA0NiI+CiAgPHBhdGggZD0iTTI1IDAgTDI1IDQwIEwxMCA0NSBMMjUgNDAgTTI1IDM1IEwxMCA0MCBMMjUgMzUgTTI1IDMwIEwxMCAzNSBMMjUgMzAgTTI1IDI1IEwxMCAzMCBMMjUgMjUgTTI1IDIwIEwxNy41IDIyLjUiIHN0eWxlPSJzdHJva2U6cmdiKDAsMCwwKTtzdHJva2Utd2lkdGg6MS41Ii8+CiA8L3N2Zz4="},{range:"50-55",path:"M25 0 L25 40 L10 40 L25 35",imageData:"PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMHB4IiBoZWlnaHQ9IjIwcHgiIHZpZXdCb3g9IjkgMCAyNiA0MSI+CiAgPHBhdGggZD0iTTI1IDAgTDI1IDQwIEwxMCA0MCBMMjUgMzUiIHN0eWxlPSJzdHJva2U6cmdiKDAsMCwwKTtzdHJva2Utd2lkdGg6MS41Ii8+CiA8L3N2Zz4="},{range:"55-60",path:"M25 0 L25 40 L10 40 L25 35 M25 30 L17.5 32.5",imageData:"PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMHB4IiBoZWlnaHQ9IjIwcHgiIHZpZXdCb3g9IjkgMCAyNiA0MSI+CiAgPHBhdGggZD0iTTI1IDAgTDI1IDQwIEwxMCA0MCBMMjUgMzUgTTI1IDMwIEwxNy41IDMyLjUiIHN0eWxlPSJzdHJva2U6cmdiKDAsMCwwKTtzdHJva2Utd2lkdGg6MS41Ii8+CiA8L3N2Zz4="},{range:"60-65",path:"M25 0 L25 40 L10 40 L25 35 M25 30 L10 35",imageData:"PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMnB4IiBoZWlnaHQ9IjMycHgiIHZpZXdCb3g9IjkgMCAyNiA0MSI+CiAgPHBhdGggZD0iTTI1IDAgTDI1IDQwIEwxMCA0MCBMMjUgMzUgTTI1IDMwIEwxMCAzNSIgc3R5bGU9InN0cm9rZTpyZ2IoMCwwLDApO3N0cm9rZS13aWR0aDoxLjUiLz4KIDwvc3ZnPg=="},{range:"65-70",path:"M25 0 L25 40 L10 40 L25 35 M25 30 L10 35 L25 30 M25 25 L17.5 27.5",imageData:"PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMnB4IiBoZWlnaHQ9IjMycHgiIHZpZXdCb3g9IjkgMCAyNiA0MSI+CiAgPHBhdGggZD0iTTI1IDAgTDI1IDQwIEwxMCA0MCBMMjUgMzUgTTI1IDMwIEwxMCAzNSBMMjUgMzAgTTI1IDI1IEwxNy41IDI3LjUiIHN0eWxlPSJzdHJva2U6cmdiKDAsMCwwKTtzdHJva2Utd2lkdGg6MS41Ii8+CiA8L3N2Zz4="},{range:"70-75",path:"M25 0 L25 40 L10 40 L25 35 M25 30 L10 35 L25 30 M25 25 L10 30",imageData:"PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMnB4IiBoZWlnaHQ9IjMycHgiIHZpZXdCb3g9IjkgMCAyNiA0MSI+CiAgPHBhdGggZD0iTTI1IDAgTDI1IDQwIEwxMCA0MCBMMjUgMzUgTTI1IDMwIEwxMCAzNSBMMjUgMzAgTTI1IDI1IEwxMCAzMCIgc3R5bGU9InN0cm9rZTpyZ2IoMCwwLDApO3N0cm9rZS13aWR0aDoxLjUiLz4KIDwvc3ZnPg=="},{range:"75-80",path:"M25 0 L25 40 L10 40 L25 35 M25 30 L10 35 L25 30 M25 25 L10 30 L25 25 M25 20 L17.5 22.5",imageData:"PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMnB4IiBoZWlnaHQ9IjMycHgiIHZpZXdCb3g9IjkgMCAyNiA0MSI+CiAgPHBhdGggZD0iTTI1IDAgTDI1IDQwIEwxMCA0MCBMMjUgMzUgTTI1IDMwIEwxMCAzNSBMMjUgMzAgTTI1IDI1IEwxMCAzMCBMMjUgMjUgTTI1IDIwIEwxNy41IDIyLjUiIHN0eWxlPSJzdHJva2U6cmdiKDAsMCwwKTtzdHJva2Utd2lkdGg6MS41Ii8+CiA8L3N2Zz4="},{range:"80-85",path:"M25 0 L25 40 L10 40 L25 35 M25 30 L10 35 L25 30 M25 25 L10 30 L25 25 M25 20 L10 25",imageData:"PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMnB4IiBoZWlnaHQ9IjMycHgiIHZpZXdCb3g9IjkgMCAyNiA0MSI+CiAgPHBhdGggZD0iTTI1IDAgTDI1IDQwIEwxMCA0MCBMMjUgMzUgTTI1IDMwIEwxMCAzNSBMMjUgMzAgTTI1IDI1IEwxMCAzMCBMMjUgMjUgTTI1IDIwIEwxMCAyNSIgc3R5bGU9InN0cm9rZTpyZ2IoMCwwLDApO3N0cm9rZS13aWR0aDoxLjUiLz4KIDwvc3ZnPg=="},{range:"85-90",path:"M25 0 L25 40 L10 40 L25 35 M25 30 L10 35 L25 30 M25 25 L10 30 L25 25 M25 20 L10 25 L25 20 M25 15 L17.5 17.5",imageData:"PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMnB4IiBoZWlnaHQ9IjMycHgiIHZpZXdCb3g9IjkgMCAyNiA0MSI+CiAgPHBhdGggZD0iTTI1IDAgTDI1IDQwIEwxMCA0MCBMMjUgMzUgTTI1IDMwIEwxMCAzNSBMMjUgMzAgTTI1IDI1IEwxMCAzMCBMMjUgMjUgTTI1IDIwIEwxMCAyNSBMMjUgMjAgTTI1IDE1IEwxNy41IDE3LjUiIHN0eWxlPSJzdHJva2U6cmdiKDAsMCwwKTtzdHJva2Utd2lkdGg6MS41Ii8+CiA8L3N2Zz4="},{range:"90-95",path:"M25 0 L25 40 L10 40 L25 35 M25 30 L10 35 L25 30 M25 25 L10 30 L25 25 M25 20 L10 25 L25 20 M25 15 L10 20",imageData:"PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMnB4IiBoZWlnaHQ9IjMycHgiIHZpZXdCb3g9IjkgMCAyNiA0MSI+CiAgPHBhdGggZD0iTTI1IDAgTDI1IDQwIEwxMCA0MCBMMjUgMzUgTTI1IDMwIEwxMCAzNSBMMjUgMzAgTTI1IDI1IEwxMCAzMCBMMjUgMjUgTTI1IDIwIEwxMCAyNSBMMjUgMjAgTTI1IDE1IEwxMCAyMCIgc3R5bGU9InN0cm9rZTpyZ2IoMCwwLDApO3N0cm9rZS13aWR0aDoxLjUiLz4KIDwvc3ZnPg=="},{range:"95-100",path:"M25 0 L25 40 L10 40 L25 35 M25 30 L10 35 L25 30 M25 25 L10 30 L25 25 M25 20 L10 25 L25 20 M25 15 L10 20 L25 15 M25 10 L17.5 12.5",imageData:"PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMnB4IiBoZWlnaHQ9IjMycHgiIHZpZXdCb3g9IjkgMCAyNiA0MSI+CiAgPHBhdGggZD0iTTI1IDAgTDI1IDQwIEwxMCA0MCBMMjUgMzUgTTI1IDMwIEwxMCAzNSBMMjUgMzAgTTI1IDI1IEwxMCAzMCBMMjUgMjUgTTI1IDIwIEwxMCAyNSBMMjUgMjAgTTI1IDE1IEwxMCAyMCBMMjUgMTUgTTI1IDEwIEwxNy41IDEyLjUiIHN0eWxlPSJzdHJva2U6cmdiKDAsMCwwKTtzdHJva2Utd2lkdGg6MS41Ii8+CiA8L3N2Zz4="},{range:"100-105",path:"M25 0 L25 40 L10 40 L25 35 L10 35 L25 30",imageData:"PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMnB4IiBoZWlnaHQ9IjMycHgiIHZpZXdCb3g9IjkgMCAyNiA0MSI+CiAgPHBhdGggZD0iTTI1IDAgTDI1IDQwIEwxMCA0MCBMMjUgMzUgTDEwIDM1IEwyNSAzMCIgc3R5bGU9InN0cm9rZTpyZ2IoMCwwLDApO3N0cm9rZS13aWR0aDoxLjUiLz4KIDwvc3ZnPg=="},{range:"105-110",path:"M25 0 L25 40 L10 40 L25 35 L10 35 L25 30 M25 25 L17.5 27.5",imageData:"PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIGhlaWdodD0iMzJweCIgd2lkdGg9IjMycHgiIHZpZXdCb3g9IjkgMCAyNiA0MSI+CiAgPHBhdGggZD0iTTI1IDAgTDI1IDQwIEwxMCA0MCBMMjUgMzUgTDEwIDM1IEwyNSAzMCBNMjUgMjUgTDE3LjUgMjcuNSIgc3R5bGU9InN0cm9rZTpyZ2IoMCwwLDApO3N0cm9rZS13aWR0aDoxLjUiLz4KIDwvc3ZnPg=="},{range:"110-115",path:"M25 0 L25 40 L10 40 L25 35 L10 35 L25 30 M25 25 L10 30",imageData:"PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIGhlaWdodD0iMzJweCIgd2lkdGg9IjMycHgiIHZpZXdCb3g9IjkgMCAyNiA0MSI+CiAgPHBhdGggZD0iTTI1IDAgTDI1IDQwIEwxMCA0MCBMMjUgMzUgTDEwIDM1IEwyNSAzMCBNMjUgMjUgTDEwIDMwIiBzdHlsZT0ic3Ryb2tlOnJnYigwLDAsMCk7c3Ryb2tlLXdpZHRoOjEuNSIvPgogPC9zdmc+"},{range:"115-120",path:"M25 0 L25 40 L10 40 L25 35 L10 35 L25 30 M25 25 L10 30 M25 25 M25 20 L17.5 22.5",imageData:"PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIGhlaWdodD0iMzJweCIgd2lkdGg9IjMycHgiIHZpZXdCb3g9IjkgMCAyNiA0MSI+CiAgPHBhdGggZD0iTTI1IDAgTDI1IDQwIEwxMCA0MCBMMjUgMzUgTDEwIDM1IEwyNSAzMCBNMjUgMjUgTDEwIDMwIE0yNSAyNSBNMjUgMjAgTDE3LjUgMjIuNSIgc3R5bGU9InN0cm9rZTpyZ2IoMCwwLDApO3N0cm9rZS13aWR0aDoxLjUiLz4KIDwvc3ZnPg=="},{range:"120-125",path:"M25 0 L25 40 L10 40 L25 35 L10 35 L25 30 M25 25 L10 30 M25 25 M25 20 L10 25",imageData:"PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIGhlaWdodD0iMzJweCIgd2lkdGg9IjMycHgiIHZpZXdCb3g9IjkgMCAyNiA0MSI+CiAgPHBhdGggZD0iTTI1IDAgTDI1IDQwIEwxMCA0MCBMMjUgMzUgTDEwIDM1IEwyNSAzMCBNMjUgMjUgTDEwIDMwIE0yNSAyNSBNMjUgMjAgTDEwIDI1IiBzdHlsZT0ic3Ryb2tlOnJnYigwLDAsMCk7c3Ryb2tlLXdpZHRoOjEuNSIvPgogPC9zdmc+"},{range:"125-130",path:"M25 0 L25 40 L10 40 L25 35 L10 35 L25 30 M25 25 L10 30 M25 25 M25 20 L10 25 M25 20 M25 15 L17.5 17.5",imageData:"PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIGhlaWdodD0iMzJweCIgd2lkdGg9IjMycHgiIHZpZXdCb3g9IjkgMCAyNiA0MSI+CiAgPHBhdGggZD0iTTI1IDAgTDI1IDQwIEwxMCA0MCBMMjUgMzUgTDEwIDM1IEwyNSAzMCBNMjUgMjUgTDEwIDMwIE0yNSAyNSBNMjUgMjAgTDEwIDI1IE0yNSAyMCBNMjUgMTUgTDE3LjUgMTcuNSIgc3R5bGU9InN0cm9rZTpyZ2IoMCwwLDApO3N0cm9rZS13aWR0aDoxLjUiLz4KIDwvc3ZnPg=="},{range:"130-135",path:"M25 0 L25 40 L10 40 L25 35 L10 35 L25 30 M25 25 L10 30 M25 25 M25 20 L10 25 M25 20 M25 15 L10 20",imageData:"PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIGhlaWdodD0iMzJweCIgd2lkdGg9IjMycHgiIHZpZXdCb3g9IjkgMCAyNiA0MSI+CiAgPHBhdGggZD0iTTI1IDAgTDI1IDQwIEwxMCA0MCBMMjUgMzUgTDEwIDM1IEwyNSAzMCBNMjUgMjUgTDEwIDMwIE0yNSAyNSBNMjUgMjAgTDEwIDI1IE0yNSAyMCBNMjUgMTUgTDEwIDIwIiBzdHlsZT0ic3Ryb2tlOnJnYigwLDAsMCk7c3Ryb2tlLXdpZHRoOjEuNSIvPgogPC9zdmc+"},{range:"135-140",path:"M25 0 L25 40 L10 40 L25 35 L10 35 L25 30 M25 25 L10 30 M25 25 M25 20 L10 25 M25 20 M25 15 L10 20 M25 15 M25 10 L17.5 12.5",imageData:"PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIGhlaWdodD0iMzJweCIgd2lkdGg9IjMycHgiIHZpZXdCb3g9IjkgMCAyNiA0MSI+CiAgPHBhdGggZD0iTTI1IDAgTDI1IDQwIEwxMCA0MCBMMjUgMzUgTDEwIDM1IEwyNSAzMCBNMjUgMjUgTDEwIDMwIE0yNSAyNSBNMjUgMjAgTDEwIDI1IE0yNSAyMCBNMjUgMTUgTDEwIDIwIE0yNSAxNSBNMjUgMTAgTDE3LjUgMTIuNSIgc3R5bGU9InN0cm9rZTpyZ2IoMCwwLDApO3N0cm9rZS13aWR0aDoxLjUiLz4KIDwvc3ZnPg=="},{range:"140-145",path:"M25 0 L25 40 L10 40 L25 35 L10 35 L25 30 M25 25 L10 30 M25 25 M25 20 L10 25 M25 20 M25 15 L10 20 M25 15 M25 10 L17.5 12.5",imageData:"PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIGhlaWdodD0iMzJweCIgd2lkdGg9IjMycHgiIHZpZXdCb3g9IjkgMCAyNiA0MSI+CiAgPHBhdGggZD0iTTI1IDAgTDI1IDQwIEwxMCA0MCBMMjUgMzUgTDEwIDM1IEwyNSAzMCBNMjUgMjUgTDEwIDMwIE0yNSAyNSBNMjUgMjAgTDEwIDI1IE0yNSAyMCBNMjUgMTUgTDEwIDIwIE0yNSAxNSBNMjUgMTAgTDEwIDE1IiBzdHlsZT0ic3Ryb2tlOnJnYigwLDAsMCk7c3Ryb2tlLXdpZHRoOjEuNSIvPgogPC9zdmc+"},{range:"145-150",path:"M25 0 L25 40 L10 40 L25 35 L10 35 L25 30 M25 25 L10 30 M25 25 M25 20 L10 25 M25 20 M25 15 L10 20 M25 15 M25 10 L17.5 12.5",imageData:"PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIGhlaWdodD0iMzJweCIgd2lkdGg9IjMycHgiIHZpZXdCb3g9IjkgMCAyNiA0MSI+CiAgPHBhdGggZD0iTTI1IDAgTDI1IDQwIEwxMCA0MCBMMjUgMzUgTDEwIDM1IEwyNSAzMCBNMjUgMjUgTDEwIDMwIE0yNSAyNSBNMjUgMjAgTDEwIDI1IE0yNSAyMCBNMjUgMTUgTDEwIDIwIE0yNSAxNSBNMjUgMTAgTDEwIDE1IE0yNSAxMCBNMjUgNSBMMTcuNSA3LjUiIHN0eWxlPSJzdHJva2U6cmdiKDAsMCwwKTtzdHJva2Utd2lkdGg6MS41Ii8+CiA8L3N2Zz4="}],i=m.n.fromJSON({imageData:"iVBORw0KGgoAAAANSUhEUgAAACgAAAApCAQAAADtq6NDAAAABGdBTUEAALGPC/xhBQAAAAFzUkdCAK7OHOkAAAAgY0hSTQAAeiYAAICEAAD6AAAAgOgAAHUwAADqYAAAOpgAABdwnLpRPAAAAAJiS0dEAP+Hj8y/AAAACXBIWXMAAA7DAAAOwwHHb6hkAAAEY0lEQVRIx5XXWWxWRRQH8N+d+31tUdGAVjGglYJABFEBY91jfDAg7piYaFTccA++uMQEFRcSXlATtxiXqMQt4G4iisYl0ai4sIQYtVFZ1KIFKdTS0l4f7vRCS5fPebozc+bM/2z/Mzcx0AgSiUxXnKfIdMn875FIhX53U2n/B/s+kKM4UINTjTBZImixxnrv+9a2iL6zEoUBXcoudrWj/OtHm3wt02lfU9Qao9OnHvIhgmww84MEl1qnxfNmGrqHxAizLdPpC6chGcAxKGGcL+30gOERf1BSpUqVslQSV8d5ReZFe8VQ9avufJn31cWwlJV7iafKStGOE/1qvfH9qUxxu8ydUdmuSKbGO8YUdT2inKLG69pM70tliktl5qIkCAJGmusDG7Vqsc0WjZa4UBlBiA5YZIcjYzB7qDtH5kaUJFLs7RGZTZ42W4PRRmtwvbdt1+wGiaS4drEtDttdZYIDNVuAclR3vA3+dI3qHqmVSy7U6Tv1MScCPvPR7nIpFlsdCy3FdTLPGhK92e2CUITjMJ9ocwKxnsZqc3O3JwMma3d6UVLnyVxB4aXemZqvPqLdpJhW3KVVbY4yYImPo6M5Urv50fj+0z/FG9YaEiENs8UtMfXUaTeTePNHlhXfA1UU+2lyD1Il3Gtt9+adfpNG7dNlpg2U/T3KYLZ2dUWFdTgp3/rQ4sK973qnInV5TIf40x3dhvrJPBiqyWUo4wAtLqhQYS71qK+QKOFRywmGK/kpikzV6WMKhh58vGWs4TIJNjiEYLIuP8Tt4/zmLyqk+AyrJSbF+Qq1DgqRUPMxyl+9q3IQhX/rMCJ6tEunriDs1oSyQZKlr9AkhT2ZIARbJfaJS1vtVbHB+Rgi0RK/y1q1BWsEEyLoz40xtGKcARPVWB1BTPO7f4LNtpkUl1aoMbViLyZo0GRjPD3BxnxjqXeLYlvhqYrzMMG3HoyJXa3JjfnGlbYYFlP7Jh3qKsKY4hQ7TY0nG+xwRL61n63mxHtqNHosigyMLmClNwvuecFnOZB88nNBDzNkzhxEZaKMBVoKapggMzvHHXBEpNSSFAvtcFRsVn0bW8LlMmcXs+c0Kne3gRR32+zg4uXwjC6zit6Wt4a8LXVfcp/MtQXHn2ynGbuCmb8GvvFeJLEE82ReU9/n6+dkq2x3buG9Wn94smcgAw631RPR7BTH+kbmHReZoEpOdEe7zWqZl40s0JWs9Hmv7hjBHqPDwsjGKVJnWWqjbdZp1KhJi0aPmxYZsIRhlttgeF+Jlke41QcOQKoqilSb6HJzSvNG3G/UoWnxwsmt+sVaYwd63dRbqdnMyCPVeyRPvpYgdavM22oGKoMUVRbJfOWMwidJ8Zzb1UvmWK/VVUXzHaTjjrVYh1897HT7xxYEVUaa5SWb/WO+YUWa9SrwvigzM8YlzlYv2GSdVCYxxlBtVnnFq5olwp5/BEk/OLsf5LUmG2+inRJdVvjZ97ZH9/zP34ug1O91pf4p+D+JYBpvrKxfbwAAACV0RVh0ZGF0ZTpjcmVhdGUAMjAxNC0xMS0xMFQwMzoxMjowOS0wNTowMB9ViV0AAAAldEVYdGRhdGU6bW9kaWZ5ADIwMTQtMTEtMTBUMDM6MTI6MDktMDU6MDBuCDHhAAAAAElFTkSuQmCC",height:20,width:20,type:"esriPMS",angle:0}),r=e.map(((r,s)=>{let n;if(s!==e.length-1)if(0===s)n={minValue:r,maxValue:e[s+1],symbol:i};else{const i=m.n.fromJSON({type:"esriPMS",imageData:t[s].imageData,contentType:"image/svg+xml",height:32,width:32,angle:0});n={minValue:r,maxValue:e[s+1],symbol:i}}return new c.c(n)}));return{defaultSymbol:i,classBreakInfos:r}}_getClassBreaks(e,t){return t.map(((t,i)=>new c.c({minValue:e[i],maxValue:e[i+1],symbol:this._getDefaultSymbol(new u.o(t))})))}};(0,r.e)([(0,n.y)({type:String,json:{write:!0}})],B.prototype,"attributeField",void 0),(0,r.e)([(0,n.y)({type:z.apiValues,json:{type:z.jsonValues,read:{reader:z.read},write:{writer:z.write}}})],B.prototype,"flowRepresentation",void 0),(0,r.e)([(0,n.y)({type:["geographic","arithmetic"],json:{write:!0}})],B.prototype,"rotationType",void 0),(0,r.e)([(0,n.y)({type:G.apiValues,json:{type:G.jsonValues,read:{reader:G.read},write:{writer:G.write}}})],B.prototype,"style",void 0),(0,r.e)([(0,n.y)({json:{write:!0}})],B.prototype,"symbolTileSize",void 0),(0,r.e)([(0,n.y)({type:U.apiValues,json:{type:U.jsonValues,write:{writer:U.write}}})],B.prototype,"inputUnit",void 0),(0,r.e)([(0,f.e)("inputUnit")],B.prototype,"readInputUnit",null),(0,r.e)([(0,n.y)({type:U.apiValues,json:{type:U.jsonValues,read:{reader:U.read},write:{writer:U.write}}})],B.prototype,"outputUnit",void 0),(0,r.e)([(0,f.e)("outputUnit")],B.prototype,"readOutputUnit",null),(0,r.e)([(0,d.r)({vectorField:"vector-field"})],B.prototype,"type",void 0),(0,r.e)([(0,n.y)({type:c.N})],B.prototype,"styleRenderer",null),(0,r.e)([(0,n.y)({type:c.b})],B.prototype,"sizeVariables",null),(0,r.e)([(0,n.y)({type:c.n})],B.prototype,"rotationVariables",null),B=O=(0,r.e)([(0,n.n)("esri.renderers.VectorFieldRenderer")],B);var j=B;const q={key:"type",base:null,typeMap:{"unique-value":c.P,"class-breaks":c.N,"raster-colormap":F,"raster-stretch":k,"vector-field":j,"raster-shaded-relief":R}},H={...q,typeMap:{...q.typeMap}};delete H.typeMap["vector-field"];const W={uniqueValue:c.P,classBreaks:c.N,rasterStretch:k,rasterColormap:F,vectorField:j,rasterShadedRelief:R};function Q(e,t){if(!e)return null;if("classBreaks"===e.type&&e.classificationMethod){const t=e.authoringInfo||{classificationMethod:""};t.classificationMethod=e.classificationMethod,e.authoringInfo=t}const i=(r=e)&&W[r.type]||null;var r;if(i){const r=new i;return r.read(e,t),r}return t&&t.messages&&e&&t.messages.push(new n.z("renderer:unsupported","Renderers of type '"+(e.type||"unknown")+"' are not supported",{definition:e,context:t})),null}var Z;let Y=Z=class extends r.a{constructor(e){super(e),this.variableName=null,this.dimensionName=null,this.values=[],this.isSlice=!1}clone(){return new Z({variableName:this.variableName,dimensionName:this.dimensionName,values:(0,s.y)(this.values),isSlice:this.isSlice})}};(0,r.e)([(0,n.y)({type:String,json:{write:!0}})],Y.prototype,"variableName",void 0),(0,r.e)([(0,n.y)({type:String,json:{write:!0}})],Y.prototype,"dimensionName",void 0),(0,r.e)([(0,n.y)({type:n.S.array(n.S.oneOf([n.S.native(Number),n.S.array(n.S.native(Number))])),json:{write:!0}})],Y.prototype,"values",void 0),(0,r.e)([(0,n.y)({type:Boolean,json:{write:!0}})],Y.prototype,"isSlice",void 0),Y=Z=(0,r.e)([(0,n.n)("esri.layers.support.DimensionalDefinition")],Y);var J=Y;const X=(0,a.s)()({RSP_NearestNeighbor:"nearest",RSP_BilinearInterpolation:"bilinear",RSP_CubicConvolution:"cubic",RSP_Majority:"majority"}),$=(0,a.s)()({esriNoDataMatchAny:"any",esriNoDataMatchAll:"all"});class K{constructor(){this._workerThread=null,this._destroyed=!1}async initialize(){const e=await(0,l.p)("RasterWorker");this._destroyed?e.close():this._workerThread=e}destroy(){this._destroyed=!0,this._workerThread&&(this._workerThread.close(),this._workerThread=null)}async decode(e,t){if(!this._workerThread)throw new o.s("raster-jobhandler:no-connection","no available worker connection");const i=await this._workerThread.invoke("decode",e,t);return i?new h.u(i):null}async symbolize(e,t){if(!this._workerThread)throw new o.s("raster-jobhandler:no-connection","no available worker connection");const i={extent:e.extent&&e.extent.toJSON(),pixelBlock:e.pixelBlock.toJSON(),simpleStretchParams:e.simpleStretchParams,bandIds:e.bandIds},r=await this._workerThread.invoke("symbolize",i,t);return r?new h.u(r):null}async updateSymbolizer(e,t){var i;if(!this._workerThread)throw new o.s("raster-jobhandler:no-connection","no available worker connection");const r=null==e||null==(i=e.rendererJSON)?void 0:i.histograms;await Promise.all(this._workerThread.broadcast("updateSymbolizer",{symbolizerJSON:e.toJSON(),histograms:r},t))}async stretch(e,t){if(!this._workerThread)throw new o.s("raster-jobhandler:no-connection","no available worker connection");if(null==e||!e.pixelBlock)return null;const i={srcPixelBlock:e.pixelBlock.toJSON(),stretchParams:e.stretchParams},r=await this._workerThread.invoke("stretch",i,t);return r?new h.u(r):null}async split(e,t){if(!this._workerThread)throw new o.s("raster-jobhandler:no-connection","no available worker connection");if(null==e||!e.pixelBlock)return null;const i={srcPixelBlock:e.pixelBlock.toJSON(),tileSize:e.tileSize,maximumPyramidLevel:e.maximumPyramidLevel},r=await this._workerThread.invoke("split",i,t);return r&&r.forEach(((e,t)=>{r.set(t,e?h.u.fromJSON(e):null)})),Promise.resolve(r)}async estimateStatisticsHistograms(e,t){if(!this._workerThread)throw new o.s("raster-jobhandler:no-connection","no available worker connection");if(null==e||!e.pixelBlock)return null;const i={srcPixelBlock:e.pixelBlock.toJSON()},r=await this._workerThread.invoke("estimateStatisticsHistograms",i,t);return Promise.resolve(r)}async mosaicAndTransform(e,t){var i;if(!this._workerThread)throw new o.s("raster-jobhandler:no-connection","no available worker connection");if(null==e||null==(i=e.srcPixelBlocks)||!i.length)return null;const r={...e,srcPixelBlocks:e.srcPixelBlocks.map((e=>e?e.toJSON():null))},s=await this._workerThread.invoke("mosaicAndTransform",r,t);return s?new h.u(s):null}}const ee=new a.o({classBreaksDef:"class-breaks-definition",uniqueValueDef:"unique-value-definition"});let te=class extends r.a{constructor(){super(...arguments),this.baseSymbol=null,this.colorRamp=null,this.type=null}};(0,r.e)([(0,n.y)({type:v.a,json:{write:!0}})],te.prototype,"baseSymbol",void 0),(0,r.e)([(0,n.y)({types:c.m,json:{read:{reader:c.p},write:!0}})],te.prototype,"colorRamp",void 0),(0,r.e)([(0,n.y)({json:{read:ee.read,write:ee.write}})],te.prototype,"type",void 0),te=(0,r.e)([(0,n.n)("esri.rest.support.ClassificationDefinition")],te);var ie=te;const re=new a.o({esriClassifyEqualInterval:"equal-interval",esriClassifyManual:"manual",esriClassifyNaturalBreaks:"natural-breaks",esriClassifyQuantile:"quantile",esriClassifyStandardDeviation:"standard-deviation",esriClassifyDefinedInterval:"defined-interval"}),se=new a.o({esriNormalizeByLog:"log",esriNormalizeByPercentOfTotal:"percent-of-total",esriNormalizeByField:"field"});let ne=class extends ie{constructor(){super(...arguments),this.breakCount=null,this.classificationField=null,this.classificationMethod=null,this.normalizationField=null,this.normalizationType=null,this.type="class-breaks-definition"}set standardDeviationInterval(e){"standard-deviation"===this.classificationMethod&&this._set("standardDeviationInterval",e)}set definedInterval(e){"defined-interval"===this.classificationMethod&&this._set("definedInterval",e)}};(0,r.e)([(0,n.y)({json:{write:!0}})],ne.prototype,"breakCount",void 0),(0,r.e)([(0,n.y)({json:{write:!0}})],ne.prototype,"classificationField",void 0),(0,r.e)([(0,n.y)({type:String,json:{read:re.read,write:re.write}})],ne.prototype,"classificationMethod",void 0),(0,r.e)([(0,n.y)({json:{write:!0}})],ne.prototype,"normalizationField",void 0),(0,r.e)([(0,n.y)({json:{read:se.read,write:se.write}})],ne.prototype,"normalizationType",void 0),(0,r.e)([(0,n.y)({value:null,json:{write:!0}})],ne.prototype,"standardDeviationInterval",null),(0,r.e)([(0,n.y)({value:null,json:{write:!0}})],ne.prototype,"definedInterval",null),(0,r.e)([(0,n.y)()],ne.prototype,"type",void 0),ne=(0,r.e)([(0,n.n)("esri.rest.support.ClassBreaksDefinition")],ne);const ae=c.d.fromJSON({type:"multipart",colorRamps:[{fromColor:[0,0,255],toColor:[0,255,255]},{fromColor:[0,255,255],toColor:[255,255,0]},{fromColor:[255,255,0],toColor:[255,0,0]}]}),oe=c.d.fromJSON(p.a[0]),le=new Set(["scientific","standard-time","vector-uv","vector-magdir","vector-u","vector-v","vector-magnitude","vector-direction"]);function he(e,t){const{attributeTable:i,colormap:r}=e;if(ge(e)){const t=function(e){if(!ge(e))return null;let t;var i,r;(0,s.r)(e.statistics)&&(t=[{type:"size",field:"Magnitude",minSize:10,maxSize:40,minDataValue:null==(i=e.statistics[0])?void 0:i.min,maxDataValue:null==(r=e.statistics[0])?void 0:r.max}]);const n=new j({visualVariables:t});return n.visualVariables=[...n.sizeVariables,...n.rotationVariables],n}(e);if((0,s.r)(t))return t}if((0,s.r)(r)){const t=function(e){if(!me(e))return null;let t;const{attributeTable:i,colormap:r}=e;if((0,s.r)(i)){const e=fe(i,"value"),r=pe(i);"string"===r.type&&(t={},i.features.forEach((i=>{const s=i.attributes;t[s[e.name]]=r?s[r.name]:s[e.name]})))}return F.createFromColormap((0,s.f)(r),t)}(e);if((0,s.r)(t))return t}if((0,s.r)(i)){const t=function(e,t,i,r){if(!ye(e,t))return null;const{attributeTable:n,statistics:a}=e,o=pe(n,t),l=fe(n,"red"),h=fe(n,"green"),d=fe(n,"blue"),f=new c.g,y=[],m=new Set,g=!!(l&&h&&d);if((0,s.r)(n))n.features.forEach((e=>{const t=e.attributes[o.name];if(!m.has(e.attributes[o.name])&&null!=t){m.add(t);const i="single"!==l.type&&"double"!==l.type||"single"!==h.type&&"double"!==h.type||"single"!==d.type&&"double"!==d.type||n.features.some((e=>e.attributes[l.name]>1||e.attributes[h.name]>1||e.attributes[d.name]>1))?1:255;y.push(new c.u({value:e.attributes[o.name],label:e.attributes[o.name]+"",symbol:{type:"simple-fill",style:"solid",outline:null,color:new u.o(g?[e.attributes[l.name]*i,e.attributes[h.name]*i,e.attributes[d.name]*i,1]:[0,0,0,0])}}))}}));else if(null!=a&&a[0])for(let e=a[0].min;e<=a[0].max;e++)y.push(new c.u({value:e,label:e.toString(),symbol:{type:"simple-fill",style:"solid",outline:null,color:new u.o([0,0,0,0])}}));if(y.sort(((e,t)=>e.value&&"string"==typeof e.value.valueOf()?0:e.value>t.value?1:-1)),!g){const e=(0,p.f)(oe,y.length);y.forEach(((t,i)=>t.symbol.color=new u.o(e[i].slice(1,4)))),f.colorRamp=oe}return new c.P({field:o.name,uniqueValueInfos:y,authoringInfo:f})}(e);if((0,s.r)(t))return t}return function(e,t){var i,r,n,a;e=function(e,t){if(null==t)return e;let i=(0,s.f)(e.statistics),r=(0,s.f)(e.histograms);const{multidimensionalInfo:n}=e;if(t&&(0,s.r)(n)){const{statistics:e,histograms:s}=n.variables.find((e=>e.name===t));null!=e&&e.length&&(i=e),null!=s&&s.length&&(r=s)}return p.l.fromJSON({...e.toJSON(),statistics:i,histograms:r})}(e,null==t?void 0:t.variableName);const{bandCount:o}=e;let{bandIds:l,stretchType:h}=t||{};null!=(i=l)&&i.some((e=>e>=o))&&(l=null);let u=(0,s.f)(e.statistics),c=(0,s.f)(e.histograms);var d;o>1?(l=null!=(d=l)&&d.length?l:de(e),u=null==u?null:l.map((e=>u[e])),c=null==c?null:l.map((e=>c[e]))):l=[0],null==h&&(h=function(e){let t="percent-clip";const{pixelType:i,dataType:r,histograms:n,statistics:a}=e;return"u8"!==i||"processed"!==r&&(0,s.r)(n)&&(0,s.r)(a)?"u8"===i||"elevation"===r||le.has(r)?t="min-max":(0,s.r)(n)?t="percent-clip":(0,s.r)(a)&&(t="min-max",t="min-max"):t="none",t}(e));let f=!1;switch(h){case"none":f=!1;break;case"percent-clip":f=!(null!=(r=c)&&r.length);break;default:f=!(null!=(n=u)&&n.length)}const{dataType:y}=e,m=1===(null==(a=l)?void 0:a.length)&&le.has(y)?ae:null,g=new k({stretchType:h,dynamicRangeAdjustment:f,colorRamp:m,outputMin:0,outputMax:255,gamma:1===l.length?[1]:[1,1,1],useGamma:!1});return"percent-clip"===h?g.maxPercent=g.minPercent=.25:"standard-deviation"===h&&(g.numberOfStandardDeviations=2),!f&&((0,s.r)(e.multidimensionalInfo)||null!=t&&t.includeStatisticsInStretch)&&("percent-clip"===h?g.histograms=c:"min-max"!==h&&"standard-deviation"!==h||(g.statistics=u)),g}(e,t)}function ue(e){const t=["raster-stretch"];return me(e)&&t.push("raster-colormap"),ye(e)&&t.push("unique-value"),function(e){const{attributeTable:t,bandCount:i}=e;return 1===i&&((0,s.r)(t)||(0,s.r)(e.histograms))}(e)&&t.push("class-breaks"),function(e){return"elevation"===e.dataType}(e)&&t.push("raster-shaded-relief"),ge(e)&&t.push("vector-field"),t}function ce(e,t,i){const r=["nearest","bilinear","cubic","majority"].find((e=>e===(null==i?void 0:i.toLowerCase())));return"Map"===t?null!=r?r:"bilinear":"standard-time"===e.dataType?null!=r?r:"nearest":"thematic"===e.dataType||e.attributeTable||e.colormap?"nearest"===r||"majority"===r?r:"nearest":null!=r?r:"bilinear"}function de(e){const t=e.bandCount;if(1===t)return null;if(2===t)return[0];const i=e.keyProperties&&e.keyProperties.BandProperties;let r;if(i&&i.length===t){const{red:e,green:t,blue:s,nir:n}=function(e){const t={};for(let r=0;r<e.length;r++){var i;const s=e[r],n=null==(i=s.BandName)?void 0:i.toLowerCase();if("red"===n)t.red=r;else if("green"===n)t.green=r;else if("blue"===n)t.blue=r;else if("nearinfrared"===n||"nearinfrared_1"===n||"nir"===n)t.nir=r;else if(s.WavelengthMax&&s.WavelengthMin){const e=s.WavelengthMin,i=s.WavelengthMax;null==t.blue&&e>=410&&e<=480&&i>=480&&i<=540?t.blue=r:null==t.green&&e>=490&&e<=560&&i>=560&&i<=610?t.green=r:null==t.red&&e>=595&&e<=670&&i>=660&&i<=730?t.red=r:null==t.nir&&e>=700&&e<=860&&i>=800&&i<=950&&(t.nir=r)}}return t}(i);null!=e&&null!=t&&null!=s?r=[e,t,s]:null!=n&&null!=e&&null!=t&&(r=[n,e,t])}return!r&&t>=3&&(r=[0,1,2]),r}function pe(e,t){let i;return(0,s.r)(e)?(i=t?e.fields.find((e=>t.toLowerCase()===e.name.toLowerCase())):e.fields.find((e=>"string"===e.type&&e.name.toLowerCase().indexOf("class")>-1)),i||(i=e.fields.find((e=>"string"===e.type)),i||(i=fe(e,"value")))):i=new S.y({name:"value"}),i}function fe(e,t){return(0,s.r)(e)?e.fields.find((e=>e.name.toLowerCase()===t)):null}function ye(e,t){const{attributeTable:i,bandCount:r}=e;return!(((0,s.r)(i)||!function(e){var t,i,r;return["u8","s8"].indexOf(e.pixelType)>-1&&null!=(null==(t=e.statistics)||null==(i=t[0])?void 0:i.min)&&null!=(null==(r=e.statistics[0])?void 0:r.max)&&1===e.bandCount}(e))&&(!(0,s.r)(i)||r>1||t&&null==i.fields.find((e=>e.name.toLowerCase()===t.toLowerCase()))))}function me(e){const{bandCount:t,colormap:i}=e;return(0,s.r)(i)&&i.length&&1===t}function ge(e){var t;const{dataType:i}=e;return!(null!=(t=e.storageInfo)&&t.tileInfo||"vector-uv"!==i&&"vector-magdir"!==i)}function _e(e){var t;return{color:null==(t=e.symbolLayers[0].material)?void 0:t.color,type:"esriSFS",style:"esriSFSSolid"}}function xe(e){if("uniqueValue"===e.type){var t;const i=e.uniqueValueInfos,r=i[0].symbol;return null!=r&&null!=(t=r.symbolLayers)&&t.length&&(e.uniqueValueInfos=i.map((e=>({value:e.value,label:e.label,symbol:e.symbol?_e(e.symbol):null})))),e}if("classBreaks"===e.type){var i;const t=e.classBreakInfos,r=t[0].symbol;return null!=r&&null!=(i=r.symbolLayers)&&i.length&&(e.classBreakInfos=t.map((e=>({classMinValue:e.classMinValue,classMaxValue:e.classMaxValue,label:e.label,symbol:e.symbol?_e(e.symbol):null})))),e}return e}},80962:(e,t,i)=>{"use strict";i.r(t),i.d(t,{addOrUpdateResource:()=>o,contentToBlob:()=>d,fetchResources:()=>a,getSiblingOfSameType:()=>p,getSiblingOfSameTypeI:()=>f,removeAllResources:()=>h,removeResource:()=>l,splitPrefixFileNameAndExtension:()=>c});var r=i(80987),s=i(20215),n=i(80219);async function a(e,t={},i){await e.load(i);const s=(0,r.D)(e.itemUrl,"resources"),{start:a=1,num:o=10,sortOrder:l="asc",sortField:h="created"}=t,u={query:{start:a,num:o,sortOrder:l,sortField:h,token:e.apiKey},signal:(0,n.g)(i,"signal")},c=await e.portal._request(s,u);return{total:c.total,nextStart:c.nextStart,resources:c.resources.map((({created:t,size:i,resource:r})=>({created:new Date(t),size:i,resource:e.resourceFromPath(r)})))}}async function o(e,t,i,a){if(!e.hasPath())throw new s.s(`portal-item-resource-${t}:invalid-path`,"Resource does not have a valid path");const o=e.portalItem;await o.load(a);const l=(0,r.D)(o.userItemUrl,"add"===t?"addResources":"updateResources"),[h,c]=u(e.path),p=await d(i),f=new FormData;return h&&"."!==h&&f.append("resourcesPrefix",h),f.append("fileName",c),f.append("file",p,c),f.append("f","json"),(0,n.r)(a)&&a.access&&f.append("access",a.access),await o.portal._request(l,{method:"post",body:f,signal:(0,n.g)(a,"signal")}),e}async function l(e,t,i){if(!t.hasPath())throw new s.s("portal-item-resources-remove:invalid-path","Resource does not have a valid path");await e.load(i);const a=(0,r.D)(e.userItemUrl,"removeResources");await e.portal._request(a,{method:"post",query:{resource:t.path},signal:(0,n.g)(i,"signal")}),t.portalItem=null}async function h(e,t){await e.load(t);const i=(0,r.D)(e.userItemUrl,"removeResources");return e.portal._request(i,{method:"post",query:{deleteAll:!0},signal:(0,n.g)(t,"signal")})}function u(e){const t=e.lastIndexOf("/");return-1===t?[".",e]:[e.slice(0,t),e.slice(t+1)]}function c(e){const[t,i]=function(e){const t=(0,r.y)(e);return(0,n.t)(t)?[e,""]:[e.slice(0,e.length-t.length-1),`.${t}`]}(e),[s,a]=u(t);return[s,a,i]}async function d(e){return e instanceof Blob?e:(await(0,r.L)(e.url,{responseType:"blob"})).data}function p(e,t){if(!e.hasPath())return null;const[i,,s]=c(e.path);return e.portalItem.resourceFromPath((0,r.D)(i,t+s))}function f(e,t){if(!e.hasPath())return null;const[i,,s]=c(e.path);return e.portalItem.resourceFromPath((0,r.D)(i,t+s))}i(88903),i(98548),i(78155),i(20736),i(4169),i(92858),i(31531)},83991:(e,t,i)=>{"use strict";i.d(t,{A:()=>te,C:()=>ie,D:()=>de,G:()=>pe,H:()=>re,J:()=>fe,K:()=>ye,M:()=>tt,P:()=>K,S:()=>Ke,T:()=>ee,W:()=>se,a:()=>ct,b:()=>Q,c:()=>D,d:()=>N,e:()=>O,f:()=>Qe,g:()=>Ue,h:()=>ze,i:()=>Ve,j:()=>Fe,m:()=>Be,n:()=>A,o:()=>k,r:()=>L,s:()=>V,u:()=>ve,z:()=>$}),i(33807);var r=i(34396),s=i(94449),n=i(20215),a=i(80219),o=i(94527),l=i(5250),h=i(5772),u=i(78191),c=i(13513),d=i(50388),p=i(43356),f=i(24776),y=i(67726),m=i(58404),g=i(98548),_=i(89710),x=i(71470),v=i(92858),b=i(15541),w=i(60816),S=i(76119),I=i(60978),C=i(78155),M=i(88903),T=i(2385),E=i(31531);const F=new S.C;function A(e){if(!F.hasBidiChar(e))return[e,!1];let t;return t="rtl"===F.checkContextual(e)?"IDNNN":"ICNNN",[F.bidiTransform(e,t,"VLYSN"),!0]}var R,P;function L(e){switch(e){case"left":return R.Left;case"right":return R.Right;case"center":case"justify":return R.Center}}function D(e){switch(e){case"top":return P.Top;case"middle":return P.Center;case"baseline":return P.Baseline;case"bottom":return P.Bottom}}function N(e){switch(e){case"above-left":case"esriServerPointLabelPlacementAboveLeft":return[R.Right,P.Bottom];case"above-center":case"above-along":case"esriServerPointLabelPlacementAboveCenter":case"esriServerLinePlacementAboveAlong":return[R.Center,P.Bottom];case"above-right":case"esriServerPointLabelPlacementAboveRight":return[R.Left,P.Bottom];case"center-left":case"esriServerPointLabelPlacementCenterLeft":return[R.Right,P.Center];case"center-center":case"center-along":case"esriServerPointLabelPlacementCenterCenter":case"esriServerLinePlacementCenterAlong":return[R.Center,P.Center];case"center-right":case"esriServerPointLabelPlacementCenterRight":return[R.Left,P.Center];case"below-left":case"esriServerPointLabelPlacementBelowLeft":return[R.Right,P.Top];case"below-center":case"below-along":case"esriServerPointLabelPlacementBelowCenter":case"esriServerLinePlacementBelowAlong":return[R.Center,P.Top];case"below-right":case"esriServerPointLabelPlacementBelowRight":return[R.Left,P.Top];case"always-horizontal":case"esriServerPolygonPlacementAlwaysHorizontal":return[R.Center,P.Baseline];default:return console.debug(`Found invalid placement type ${e}`),[R.Center,P.Center]}}function O(e){switch(e){case R.Right:return-1;case R.Center:return 0;case R.Left:return 1;default:return console.debug(`Found invalid horizontal alignment ${e}`),0}}function k(e){switch(e){case P.Top:return 1;case P.Center:return 0;case P.Bottom:case P.Baseline:return-1;default:return console.debug(`Found invalid vertical alignment ${e}`),0}}function V(e){switch(e){case"left":return R.Left;case"right":return R.Right;case"center":case"justify":return R.Center}}!function(e){e[e.Left=-1]="Left",e[e.Center=0]="Center",e[e.Right=1]="Right"}(R||(R={})),function(e){e[e.Top=1]="Top",e[e.Center=0]="Center",e[e.Bottom=-1]="Bottom",e[e.Baseline=2]="Baseline"}(P||(P={}));class U{constructor(e,t,i,r){this.center=(0,f.t)(e,t),this.centerT=(0,f.b)(),this.halfWidth=i/2,this.halfHeight=r/2,this.width=i,this.height=r}get x(){return this.center[0]}get y(){return this.center[1]}get blX(){return this.center[0]+this.halfWidth}get blY(){return this.center[1]+this.halfHeight}get trX(){return this.center[0]-this.halfWidth}get trY(){return this.center[1]-this.halfHeight}get xmin(){return this.x-this.halfWidth}get xmax(){return this.x+this.halfWidth}get ymin(){return this.y-this.halfHeight}get ymax(){return this.y+this.halfHeight}set x(e){this.center[0]=e}set y(e){this.center[1]=e}clone(){return new U(this.x,this.y,this.width,this.height)}serialize(e){return e.writeF32(this.center[0]),e.writeF32(this.center[1]),e.push(this.width),e.push(this.height),e}findCollisionDelta(e,t=4){const i=Math.abs(e.centerT[0]-this.centerT[0]),r=Math.abs(e.centerT[1]-this.centerT[1]),s=(e.halfWidth+this.halfWidth+t)/i,n=(e.halfHeight+this.halfHeight+t)/r,a=Math.min(s,n);return(0,w.V)(a)}extend(e){const t=Math.min(this.xmin,e.xmin),i=Math.min(this.ymin,e.ymin),r=Math.max(this.xmax,e.xmax)-t,s=Math.max(this.ymax,e.ymax)-i,n=t+r/2,a=i+s/2;this.width=r,this.height=s,this.halfWidth=r/2,this.halfHeight=s/2,this.x=n,this.y=a}static deserialize(e){const t=e.readF32(),i=e.readF32(),r=e.readInt32(),s=e.readInt32();return new U(t,i,r,s)}}const G=Math.PI/180;class z{constructor(e,t,i,r){this._rotationT=(0,f.a)(),this._xBounds=0,this._yBounds=0,this.minZoom=0,this.maxZoom=255,this._bounds=null;const s=i.rect,n=new Float32Array(8);e*=r,t*=r;const a=i.code?s.width*r:i.metrics.width,o=i.code?s.height*r:i.metrics.height;n[0]=e,n[1]=t,n[2]=e+a,n[3]=t,n[4]=e,n[5]=t+o,n[6]=e+a,n[7]=t+o,this._data=n,this._setTextureCoords(s),this._scale=r,this._mosaic=i,this.x=e,this.y=t,this.maxOffset=Math.max(e+a,t+o)}get width(){return this._mosaic.metrics.width*this._scale}get mosaic(){return this._mosaic}set angle(e){this._angle=e,(0,f.n)(this._rotationT),(0,f.c)(this._rotationT,this._rotationT,-e),this._setOffsets(this._data)}get angle(){return this._angle}get xTopLeft(){return this._data[0]}get yTopLeft(){return this._data[1]}get xBottomRight(){return this._data[6]}get yBottomRight(){return this._data[7]}get texcoords(){return this._texcoords}get textureBinding(){return this._mosaic.textureBinding}get offsets(){return this._offsets||this._setOffsets(this._data),this._offsets}get char(){return String.fromCharCode(this._mosaic.code)}get code(){return this._mosaic.code}get bounds(){if(!this._bounds){const{height:e,width:t}=this._mosaic.metrics,i=t*this._scale,r=Math.abs(e)*this._scale,s=new Float32Array(8);s[0]=this.x,s[1]=this.y,s[2]=this.x+i,s[3]=this.y,s[4]=this.x,s[5]=this.y+r,s[6]=this.x+i,s[7]=this.y+r;const n=(0,f.o)((0,f.a)(),this._rotationT,this._T);(0,f.d)(s,s,n);let a=1/0,o=1/0,l=0,h=0;for(let e=0;e<4;e++){const t=s[2*e],i=s[2*e+1];a=Math.min(a,t),o=Math.min(o,i),l=Math.max(l,t),h=Math.max(h,i)}const u=l-a,c=h-o,d=a+u/2,p=o+c/2;this._bounds=new U(d,p,u,c)}return this._bounds}setTransform(e){this._T=e,this._offsets=null}_setOffsets(e){this._offsets||(this._offsets={upperLeft:0,upperRight:0,lowerLeft:0,lowerRight:0});const t=this._offsets,i=new Float32Array(8),r=(0,f.o)((0,f.a)(),this._rotationT,this._T);(0,f.d)(i,e,r),t.upperLeft=(0,h.m)(8*i[0],8*i[1]),t.upperRight=(0,h.m)(8*i[2],8*i[3]),t.lowerLeft=(0,h.m)(8*i[4],8*i[5]),t.lowerRight=(0,h.m)(8*i[6],8*i[7])}_setTextureCoords({x:e,y:t,width:i,height:r}){this._texcoords={upperLeft:(0,h.m)(e,t),upperRight:(0,h.m)(e+i,t),lowerLeft:(0,h.m)(e,t+r),lowerRight:(0,h.m)(e+i,t+r)}}}const B=(e,t)=>({code:0,page:0,sdf:!0,rect:new b.t(0,0,11,8),textureBinding:t,metrics:{advance:0,height:4,width:e,left:0,top:0}});class j{constructor(e,t,i){this._rotation=0,this._decorate(e,t,i),this.glyphs=e,this.bounds=this._createBounds(e),this.isMultiline=t.length>1,this._hasRotation=0!==i.angle,this._T=this._createGlyphTransform(this.bounds,i);for(const t of e)t.setTransform(this._T)}setRotation(e){if(0===e&&0===this._rotation)return;this._rotation=e;const t=this._T,i=(0,f.h)((0,f.a)(),e);(0,f.o)(t,i,t);for(const e of this.glyphs)e.setTransform(this._T)}_decorate(e,t,i){if(!i.decoration||"none"===i.decoration||!e.length)return;const r=i.scale,s="underline"===i.decoration?30:20,n=e[0].textureBinding;for(const i of t){const t=i.startX*r,a=i.startY*r,o=(i.width+i.glyphWidthEnd)*r;e.push(new z(t,a+s*r,B(o,n),1))}}get boundsT(){const e=this.bounds,t=(0,y.r)((0,f.b)(),e.x,e.y);if((0,y.D)(t,t,this._T),this._hasRotation){const i=Math.max(e.width,e.height);return new U(t[0],t[1],i,i)}return new U(t[0],t[1],e.width,e.height)}_createBounds(e){let t=1/0,i=1/0,r=0,s=0;for(const n of e)t=Math.min(t,n.xTopLeft),i=Math.min(i,n.yTopLeft),r=Math.max(r,n.xTopLeft+n.width),s=Math.max(s,n.yBottomRight);const n=r-t,a=s-i;return new U(t+n/2,i+a/2,n,a)}_createGlyphTransform(e,t){const i=G*t.angle,r=(0,f.a)(),s=(0,f.b)();return(0,f.i)(r,r,(0,y.r)(s,t.xOffset,-t.yOffset)),t.isCIM?(0,f.c)(r,r,i):((0,f.i)(r,r,(0,y.r)(s,e.x,e.y)),(0,f.c)(r,r,i),(0,f.i)(r,r,(0,y.r)(s,-e.x,-e.y))),r}}class q{constructor(e,t,i,r,s,n){this.glyphWidthEnd=0,this.startX=0,this.startY=0,this.start=Math.max(0,Math.min(t,i)),this.end=Math.max(0,Math.max(t,i)),this.end<e.length&&(this.glyphWidthEnd=e[this.end].metrics.width),this.width=r,this.yMin=s,this.yMax=n}}const H=e=>10===e,W=e=>32===e;function Q(e,t,i){const r=i.scale,s=new Array,n=function(e,t,i){const r=new Array,s=1/i.scale,n=i.maxLineWidth*s,a=t?e.length-1:0,o=t?-1:e.length,l=t?-1:1;let h=a,u=0,c=0,d=h,p=d,f=0,y=1/0,m=0;for(;h!==o;){const{code:t,metrics:i}=e[h],s=Math.abs(i.top);if(H(t)||W(t)||(y=Math.min(y,s),m=Math.max(m,s+i.height)),H(t))h!==a&&(r.push(new q(e,d,h-l,u,y,m)),y=1/0,m=0),u=0,d=h+l,p=h+l,c=0;else if(W(t))p=h+l,c=0,f=i.advance,u+=i.advance;else if(u>n){if(p!==d){const t=p-2*l;u-=f,r.push(new q(e,d,t,u-c,y,m)),y=1/0,m=0,d=p,u=c}else r.push(new q(e,d,h-l,u,y,m)),y=1/0,m=0,d=h,p=h,u=0;u+=i.advance,c+=i.advance}else u+=i.advance,c+=i.advance;h+=l}const g=new q(e,d,h-l,u,y,m);return g.start>=0&&g.end<e.length&&r.push(g),r}(e,t,i),a=function(e,t){let i=0;for(let t=0;t<e.length;t++){const{width:r}=e[t];i=Math.max(r,i)}const r="underline"===t.decoration?4:0,s=e[0].yMin;return{x:0,y:s,height:e[e.length-1].yMax+t.lineHeight*(e.length-1)+r-s,width:i}}(n,i),{vAlign:o,hAlign:l}=i,h=o===P.Baseline?1:0,u=h?0:o-1,c=(1-h)*-a.y+u*(a.height/2)+-26*(h?1:0);for(let t=0;t<n.length;t++){const{start:a,end:o,width:h}=n[t];let u=-1*(l+1)*(h/2)-3;const d=t*i.lineHeight+c-3;n[t].startX=u,n[t].startY=d;for(let t=a;t<=o;t++){const i=e[t];if(H(i.code))continue;const n=new z(u+i.metrics.left,d-i.metrics.top,i,r);u+=i.metrics.advance,s.push(n)}}return new j(s,n,i)}const Z=Math.PI/180,Y=.04,J=(0,f.a)(),X=(0,f.b)(),$=512,K=50;function ee(e,t){if(!t.isWrappable)return null;const[i,r]=(0,x.a)(t);return e[2]>r?[(0,m.i)([e[0],e[1],r,e[3]]),(0,m.i)([i,e[1],i+e[2]-r,e[3]])]:e[0]<i?[(0,m.i)([i,e[1],e[2],e[3]]),(0,m.i)([r-(i-e[0]),e[1],r,e[3]])]:null}function te(e,t,i,r,s,n,a){if(!r||!i.symbol)return e[0]=e[1]=e[2]=e[3]=0,t[0]=t[1]=t[2]=t[3]=0,e;const o=r;if(!(0,_.l)(o)){(0,g.c)(e,o);let r=t[0];0===r&&(r=me(i),t[0]=r);const n=s*r/2;return e[0]-=n,e[1]-=n,e[2]+=n,e[3]+=n,e}{const r=o.x,l=o.y;"esriTS"===i.symbol.type&&0===t[2]&&0===t[3]&&ge(t,i.symbol,i.mosaicItem),function(e,t,i,r,s,n,a,o){let l;switch(r.type){case"esriSMS":case"esriPMS":l=pe(t,i,r,n,a,0);break;case"esriTS":l=ye(t,i,r,s,n,0);break;case"cim":case"CIMSymbolReference":case"expanded-cim":l=fe(t,i,r,n,a,0)}let h,u,c=0;for(let e=0;e<l.rings[0].length-1;e++)u=l.rings[0][e],h=(t-u[0])*(t-u[0])+(i-u[1])*(i-u[1]),c=Math.max(c,h);c=Math.sqrt(c);let d=(0,x.k)(t-c,o),p=(0,x.k)(t+c,o);if(d>p){const e=(0,v.S)(o);if(e){const[t,i]=e.valid;d=t,p=i}}e[0]=d,e[1]=i-c,e[2]=p,e[3]=i+c}(e,r,l,i.symbol,t,s,n,a)}return e}function ie(e){return"text"===e||"esriTS"===e}function re(e){return"simple-marker"===e||"picture-marker"===e||"esriSMS"===e||"esriPMS"===e}function se(e){switch((0,a.f)(e.geometry).type){case"point":case"multipoint":return 0;case"polyline":return 1;case"polygon":case"extent":return 2}return 0}const ne=(0,f.b)(),ae=(0,f.b)(),oe=(0,f.b)(),le=(0,f.b)(),he=(0,f.b)(),ue=(0,f.b)(),ce=(0,f.b)();function de(e,t,i,r){(0,y.r)(oe,t,i);const s=e.paths;let n,a,o,l,h,u,c,d,p,f=1/0;for(let e=0;e<s.length;e++){const m=s[e];if(!(m.length<2))for(let e=1;e<m.length;e++)n=m[e-1][0],o=m[e-1][1],a=m[e][0],l=m[e][1],h=Math.min(n,a)-r,u=Math.min(o,l)-r,c=Math.max(n,a)+r,d=Math.max(o,l)+r,t<h||t>c||i<u||i>d||((0,y.r)(ne,n,o),(0,y.r)(ae,a,l),(0,y.o)(le,ae,ne),(0,y.o)(he,ne,oe),(0,y.l)(ue,le,(0,y._)(le,he)/(0,y._)(le,le)),(0,y.o)(ce,he,ue),p=(0,y._)(ce,ce),f>p&&(f=p))}return Math.sqrt(f)<=r}function pe(e,t,i,r,s,n){let a,l;const h=(0,o.u)(i.xoffset),u=(0,o.u)(i.yoffset),c=Z*i.angle,d=Z*n;switch(i.type){case"esriSMS":a=l=(0,o.u)(i.size);break;case"esriPMS":a=(0,o.u)(i.width),l=(0,o.u)(i.height)}s<Y&&(r=Y*r/s);const p=(0,f.n)(J);(0,f.i)(p,p,(0,y.r)(X,e,t)),(0,f.c)(p,p,d-c),(0,f.e)(p,p,(0,y.r)(X,r,-r)),(0,f.i)(p,p,(0,y.r)(X,h,-u));const m=[0,0];(0,y.D)(m,(0,y.r)(X,-.5*a,-.5*l),p);const g=[0,0];(0,y.D)(g,(0,y.r)(X,-.5*a,.5*l),p);const _=[0,0];(0,y.D)(_,(0,y.r)(X,.5*a,-.5*l),p);const x=[0,0];return(0,y.D)(x,(0,y.r)(X,.5*a,.5*l),p),{rings:[[m,_,x,g,m]]}}function fe(e,t,i,r,s,n){const a=d.h.getEnvelope(i.data);if(!a)return null;s<Y&&(r=Y*r/s);const l=(0,o.u)(a.width),h=(0,o.u)(a.height),u=(0,o.u)(a.x),c=(0,o.u)(a.y),p=0*Z,m=Z*n,g=(0,f.n)(J);(0,f.i)(g,g,(0,y.r)(X,e,t)),(0,f.c)(g,g,m-p),(0,f.e)(g,g,(0,y.r)(X,r,r));const _=[0,0];(0,y.D)(_,(0,y.r)(X,u,c+h),g);const x=[0,0];(0,y.D)(x,(0,y.r)(X,u,c),g);const v=[0,0];(0,y.D)(v,(0,y.r)(X,u+l,c+h),g);const b=[0,0];return(0,y.D)(b,(0,y.r)(X,u+l,c),g),{rings:[[_,v,b,x,_]]}}function ye(e,t,i,r,s,n){const a=(0,o.u)(i.xoffset),l=(0,o.u)(i.yoffset),h=Z*i.angle,u=Z*n,c=(0,f.n)(J);(0,f.i)(c,c,(0,y.r)(X,e,t)),(0,f.c)(c,c,u),(0,f.e)(c,c,(0,y.r)(X,s,-s));const d=r[0]+r[2]/2,p=r[1]+r[3]/2;(0,f.i)(c,c,(0,y.r)(X,a,-l)),(0,f.i)(c,c,(0,y.r)(X,d,p)),(0,f.c)(c,c,h),(0,f.i)(c,c,(0,y.r)(X,-d,-p));const m=[0,0];(0,y.D)(m,(0,y.r)(X,r[0],r[1]),c);const g=[0,0];(0,y.D)(g,(0,y.r)(X,r[0],r[1]+r[3]),c);const _=[0,0];(0,y.D)(_,(0,y.r)(X,r[0]+r[2],r[1]),c);const x=[0,0];return(0,y.D)(x,(0,y.r)(X,r[0]+r[2],r[1]+r[3]),c),{rings:[[m,_,x,g,m]]}}function me(e){switch(e.symbol.type){case"esriSFS":case"esriPFS":{const t=e.symbol.outline;return t?t.width:0}case"esriSLS":return(0,o.u)(e.symbol.width);case"esriSMS":return(0,o.u)(e.symbol.size);case"esriPMS":return(0,o.u)(Math.max(e.symbol.width,e.symbol.height));case"esriTS":{const t=[0,0,0,0];ge(t,e.symbol,e.mosaicItem);const i=Math.max(Math.abs(t[0]),Math.abs(t[1]));return Math.max(t[2],t[3])+i}case"expanded-cim":{const t=d.h.getEnvelope(e.symbol.data);return t.width!==-1/0&&t.height!==-1/0||(t.width=10,t.height=10,t.x=0,t.y=0),(0,o.u)(Math.sqrt(t.width*t.width+t.height*t.height))}case"composite-symbol":{if(!e.symbol.layers.length)return 0;const t=e.symbol.layers.length-1;return me({symbol:e.symbol.layers[t],mosaicItem:null})}case"label":default:return 0}}function ge(e,t,i){if(!i||0===i.glyphMosaicItems.length)return e;const r=A(t.text)[1],s=Q(i.glyphMosaicItems,r,{scale:(0,o.u)(t.font.size)/24,angle:t.angle,xOffset:t.xoffset,yOffset:t.yoffset,hAlign:L(t.horizontalAlignment||"center"),vAlign:D(t.verticalAlignment||"baseline"),maxLineWidth:Math.max(32,Math.min(t.lineWidth||512,512)),lineHeight:30*Math.max(.25,Math.min(t.lineHeight||1,4)),decoration:t.font.decoration||"none",isCIM:!1}).bounds;return e[0]=(0,o.u)(s.x-s.halfWidth),e[1]=(0,o.u)(s.y-s.halfHeight),e[2]=(0,o.u)(s.width),e[3]=(0,o.u)(s.height),e}const _e={"simple-marker":1,"picture-marker":1,text:0,"simple-line":0,"simple-fill":0,"picture-fill":0,cim:1,"web-style":1};function xe(e){if(!("visualVariables"in e))return 0;if(!e.hasVisualVariables("size"))return 0;const t=e.getVisualVariablesForType("size");if(!t[0])return 0;const i=t[0];if("stops"===i.transformationType)return i.stops.map((e=>e.size)).reduce(Te,0);if("clamped-linear"===i.transformationType){let e=-1/0,t=-1/0;return e="number"==typeof i.maxSize?i.maxSize:i.maxSize.stops.map((e=>e.size)).reduce(Te,0),t="number"==typeof i.minSize?i.minSize:i.minSize.stops.map((e=>e.size)).reduce(Te,0),Math.max(e,t)}return"real-world-size"===i.transformationType?30:void 0}async function ve(e,t,i){if(!e||i&&"cluster"===i.type)return 0;if("heatmap"===e.type)return Math.round(3*e.blurRadius);if("dot-density"===e.type)return 0;if("dictionary"===e.type)return"esriGeometryPoint"===t||"esriGeometryMultipoint"===t?100:200;const r=e.getSymbols(),s=xe(e),n=[];for(const e of r)n.push(Ce(e,s));const a=await Promise.all(n);return(0,o.u)(a.reduce(Te,0))}const be=[0,0,0,0];function we(e,t){return null==e?t:e}const Se={sdf:!0,code:99,metrics:p.k.metrics,rect:new d.t(0,0,24,24),page:0,textureBinding:2};async function Ie(e,t){if("simple-marker"===e.type){const i=Math.max(we(e.size,12),t);return Me(e)+.707*i}if("picture-marker"===e.type){const i=Math.max(we(e.height,12),t),r=we(e.width,12)*(i/we(e.height,12))/2,s=i/2;return Me(e)+Math.sqrt(r*r+s*s)}if("text"===e.type){const t=function(e){const t=e.text&&e.text.length;if(!t)return{glyphMosaicItems:[Se]};const i=[];for(let r=0;r<t;r++)i.push({...Se,code:e.text.charCodeAt(r)});return{glyphMosaicItems:i}}(e);ge(be,e.toJSON(),t);const i=Math.abs(be[0]),r=Math.abs(be[1]),s=be[2],n=be[3];return Math.max(i,r)+Math.max(s,n)}if("simple-line"===e.type){const i=e,r=Math.max(we(i.width,.75),t)/2;return i.marker?Math.max(6*i.width,2*t):r}if("simple-fill"===e.type||"picture-fill"===e.type)return Math.max(function(e,t){return null==e.outline?0:we(e.outline.width,0)}(e),t)/2;if("cim"===e.type){const t=d.h.getEnvelope(e.data);return t?Math.sqrt(t.width*t.width+t.height*t.height):0}return"web-style"===e.type?Ie(await e.fetchCIMSymbol(),t):0}async function Ce(e,t){return function(e){return e.type in _e}(e)?Math.min(await Ie(e,t),75):0}function Me(e){const t=we(e.xoffset,0),i=we(e.yoffset,0);return Math.sqrt(t*t+i*i)}function Te(e,t){return Math.max(e,t)}const Ee=a.n.getLogger("esri.renderers.visualVariables.support.utils"),Fe=e=>{if(!("visualVariables"in e)||!e.visualVariables||!e.visualVariables.length)return e;const t=e.clone(),i=t.visualVariables.map((e=>Re(e)?Pe(e):e));return t.visualVariables=i,t};function Ae(e){return e.map((e=>Re(e)?Pe(e.clone()):e))}function Re(e){return("size"===e.type||"color"===e.type||"opacity"===e.type)&&null!=e.stops}function Pe(e){return e.stops=function(e,t){return t.length<=8?t:(Ee.warn(`Found ${t.length} Visual Variable stops, but MapView only supports 8. Displayed stops will be simplified.`),t.length>16?function(e,t){const[i,...r]=t,s=r.pop(),n=r[0].value,a=r[r.length-1].value,l=(a-n)/6,h=[];for(let i=n;i<a;i+=l){let s=0;for(;i>=r[s].value;)s++;const n=r[s],a=t[s-1],l=i-a.value,u=n.value===a.value?1:l/(n.value-a.value);if("color"===e){const e=r[s],n=t[s-1],a=e.color.clone();a.r=Le(n.color.r,a.r,u),a.g=Le(n.color.g,a.g,u),a.b=Le(n.color.b,a.b,u),a.a=Le(n.color.a,a.a,u),h.push({value:i,color:a,label:e.label})}else if("size"===e){const e=r[s],n=t[s-1],a=(0,o.o)(e.size),l=Le((0,o.o)(n.size),a,u);h.push({value:i,size:l,label:e.label})}else{const e=r[s],n=Le(t[s-1].opacity,e.opacity,u);h.push({value:i,opacity:n,label:e.label})}}return[i,...h,s]}(e,t):function(e){const[t,...i]=e,r=i.pop();for(;i.length>6;){let e=0,t=0;for(let r=1;r<i.length;r++){const s=i[r-1],n=i[r],a=Math.abs(n.value-s.value);a>t&&(t=a,e=r)}i.splice(e,1)}return[t,...i,r]}(t))}(e.type,e.stops),e}function Le(e,t,i){return(1-i)*e+i*t}var De;let Ne=De=class extends r.b{writeLevels(e,t,i){for(const i in e){const e=this.levels[i];return void(t.stops=e)}}clone(){return new De({axis:this.axis,field:this.field,valueExpression:this.valueExpression,valueExpressionTitle:this.valueExpressionTitle,maxDataValue:this.maxDataValue,maxSize:(0,T.n)(this.maxSize)?this.maxSize.clone():this.maxSize,minDataValue:this.minDataValue,minSize:(0,T.n)(this.minSize)?this.minSize.clone():this.minSize,normalizationField:this.normalizationField,stops:this.stops&&this.stops.map((e=>e.clone())),target:this.target,useSymbolValue:this.useSymbolValue,valueRepresentation:this.valueRepresentation,valueUnit:this.valueUnit,legendOptions:this.legendOptions&&this.legendOptions.clone(),levels:(0,a.y)(this.levels)})}};(0,C.e)([(0,M.y)()],Ne.prototype,"levels",void 0),(0,C.e)([(0,C.o)("levels")],Ne.prototype,"writeLevels",null),Ne=De=(0,C.e)([(0,M.n)("esri.views.2d.engine.LevelDependentSizeVariable")],Ne);const Oe=a.n.getLogger("esri.views.2d.layers.support.clusterUtils");a.c.add("esri-cluster-arcade-enabled",!0);const ke=(0,a.c)("esri-cluster-arcade-enabled"),Ve=(e,t,i,r)=>{const s=t.clone();if(!Be(s))return s;if(i.fields)for(const t of i.fields)je(e,t);if("visualVariables"in s){const t=(s.visualVariables||[]).filter((e=>"$view.scale"!==e.valueExpression)),n=Ue(t);t.forEach((t=>{"rotation"===t.type?t.field?t.field=He(e,t.field,"avg_angle"):t.valueExpression&&(t.field=qe(e,t.valueExpression,"avg_angle"),t.valueExpression=null):t.normalizationField?(t.field=He(e,t.field,"norm",t.normalizationField),t.normalizationField=null):t.field?t.field=He(e,t.field,"avg"):(t.field=qe(e,t.valueExpression,"avg"),t.valueExpression=null)})),(0,a.t)(n)&&!Ge(t)&&(t.push(ze(i,r)),s.dynamicClusterSize=!0),s.visualVariables=t}switch(s.type){case"simple":break;case"unique-value":s.field?s.field=He(e,s.field,"mode"):s.valueExpression&&(s.field=qe(e,s.valueExpression,"mode"),s.valueExpression=null);break;case"class-breaks":s.normalizationField?(s.field=He(e,s.field,"norm",s.normalizationField),s.normalizationField=null):s.field?s.field=He(e,s.field,"avg"):(s.field=qe(e,s.valueExpression,"avg"),s.valueExpression=null)}return s},Ue=e=>{for(const t of e)if("size"===t.type)return t;return null},Ge=e=>{for(const t of e)if("cluster_count"===t.field)return!0;return!1},ze=(e,t)=>{const i=[new r.l({value:0,size:0}),new r.l({value:1})];if((0,a.t)(t))return new r.b({field:"cluster_count",stops:[...i,new r.l({value:2,size:0})]});const s=Object.keys(t).reduce(((s,n)=>({...s,[n]:[...i,new r.l({value:Math.max(2,t[n].minValue),size:e.clusterMinSize}),new r.l({value:Math.max(3,t[n].maxValue),size:e.clusterMaxSize})]})),{});return new Ne({field:"cluster_count",levels:s})},Be=e=>{const t=t=>Oe.error(new n.s("Unsupported-renderer",t,{renderer:e}));if("unique-value"===e.type){if(e.field2||e.field3)return t("FeatureReductionCluster does not support multi-field UniqueValueRenderers"),!1}else if("class-breaks"===e.type){if(e.normalizationField){const i=e.normalizationType;if("field"!==i)return t(`FeatureReductionCluster does not support a normalizationType of ${i}`),!1}}else if("simple"!==e.type)return t(`FeatureReductionCluster does not support renderers of type ${e.type}`),!1;if(!ke){if("valueExpression"in e&&e.valueExpression)return t("FeatureReductionCluster does not currently support renderer.valueExpression. Support will be added in a future release"),!1;if(("visualVariables"in e&&e.visualVariables||[]).some((e=>!(!("valueExpression"in e)||!e.valueExpression))))return t("FeatureReductionCluster does not currently support visualVariables with a valueExpression. Support will be added in a future release"),!1}return!0};function je(e,t){const{name:i,outStatistic:r}=t,{onStatisticField:s,onStatisticValueExpression:a,statisticType:o}=r;if(a){const t=(0,I.x)(a.toLowerCase());e.push({name:i,outStatistic:{onStatisticField:t,onStatisticValueExpression:a,statisticType:o}})}else s?e.push({name:i,outStatistic:{onStatisticField:s,statisticType:o}}):Oe.error(new n.s("mapview-unsupported-field","Unable to handle field",{field:t}))}function qe(e,t,i){const r=(0,I.x)(t),s="mode"===i?`cluster_type_${r}`:`cluster_avg_${r}`;return e.some((e=>e.name===s))||e.push({name:s,outStatistic:{onStatisticField:r,onStatisticValueExpression:t,statisticType:i}}),s}function He(e,t,i,r){if("cluster_count"===t||e.some((e=>e.name===t)))return t;const s=function(e,t,i){switch(e){case"avg":case"avg_angle":return`cluster_avg_${t}`;case"mode":return`cluster_type_${t}`;case"norm":{const e=i,r="field",s=t.toLowerCase()+",norm:"+r+","+e.toLowerCase();return"cluster_avg_"+(0,I.x)(s)}}}(i,t,r);return e.some((e=>e.name===s))||("norm"===i?e.push({name:s,outStatistic:{onStatisticField:t,onStatisticNormalizationField:r,statisticType:i}}):e.push({name:s,outStatistic:{onStatisticField:t,statisticType:i}})),s}const We=new E.o({esriGeometryPoint:"point",esriGeometryMultipoint:"multipoint",esriGeometryPolyline:"polyline",esriGeometryPolygon:"polygon",esriGeometryMultiPatch:"multipatch",mesh:"mesh"});function Qe(e){return We.toJSON(e)}const Ze=a.n.getLogger("esri.views.2d.layers.features.schemaUtils"),Ye="ValidationError",Je={esriGeometryPoint:["above-right","above-center","above-left","center-center","center-left","center-right","below-center","below-left","below-right"],esriGeometryPolygon:["always-horizontal"],esriGeometryPolyline:["center-along"],esriGeometryMultipoint:null};function Xe(e){return(0,u.f)(e)}function $e(e){switch(e.type){case"line-marker":var t;return{type:"line-marker",color:null==(t=e.color)?void 0:t.toJSON(),placement:e.placement,style:e.style};default:return(0,l.i)(e.toJSON()).toJSON()}}function Ke(e,t,i){if(!e)return null;let r=0,s=!1,n=0;switch((0,a.r)(t)&&(n=xe(t),"visualVariables"in t&&(r=function(e){if(!e)return h.A.NONE;let t=0;for(const i of e)if("size"===i.type){const e=(0,c.o)(i);t|=e,"outline"===i.target&&(t|=e<<4)}else"color"===i.type?t|=h.A.COLOR:"opacity"===i.type?t|=h.A.OPACITY:"rotation"===i.type&&(t|=h.A.ROTATION);return t}(t.visualVariables||[]),s="dot-density"===t.type)),e.type){case"simple-fill":case"picture-fill":return function(e,t,i,r){const s=(0,u.A)(h.E.FILL,t,!1,i),n=r?Xe(s):s,a=e.clone(),o=a.outline;a.outline=null;const l=[],c={materialKey:n,hash:a.hash(),...$e(a)};if(l.push(c),o){const e=(0,u.A)(h.E.LINE,t,!0,!1),i={materialKey:r?Xe(e):e,hash:o.hash(),...$e(o)};l.push(i)}return{type:"composite-symbol",layers:l,hash:l.reduce(((e,t)=>t.hash+e),"")}}(e,r,s,i);case"simple-marker":case"picture-marker":return function(e,t,i,r){const s=(0,u.A)(h.E.MARKER,t,!1,!1),n=r?Xe(s):s,a=$e(e);return{materialKey:n,hash:e.hash(),...a,angle:e.angle,maxVVSize:i}}(e,r,n,i);case"simple-line":return function(e,t,i){const r=(0,u.A)(h.E.LINE,t,!1,!1),s=i?Xe(r):r,n=e.clone(),a=n.marker;n.marker=null;const o=[];if(o.push({materialKey:s,hash:n.hash(),...$e(n)}),a){var l;const e=(0,u.A)(h.E.MARKER,t,!1,!1),r=i?Xe(e):e;a.color=null!=(l=a.color)?l:n.color,o.push({materialKey:r,hash:a.hash(),lineWidth:n.width,...$e(a)})}return{type:"composite-symbol",layers:o,hash:o.reduce(((e,t)=>t.hash+e),"")}}(e,r,i);case"text":return function(e,t,i,r){const s=(0,u.A)(h.E.TEXT,t,!1,!1),n=r?Xe(s):s,a=$e(e);return{materialKey:n,hash:e.hash(),...a,angle:e.angle,maxVVSize:i}}(e,r,n,i);case"label":return function(e,t,i){const r=e.toJSON(),s=(0,u.A)(h.E.LABEL,t,!1,!1,r.labelPlacement);return{materialKey:i?Xe(s):s,hash:e.hash(),...r,labelPlacement:r.labelPlacement}}(e,r,i);case"cim":return{type:"cim",rendererKey:r,data:e.data,maxVVSize:n};case"web-style":return{...$e(e),type:"web-style",hash:e.hash(),rendererKey:r,maxVVSize:n};default:throw new Error(`symbol not supported ${e.type}`)}}function et(e,t){const i=(0,a.y)(e);return i.some((e=>function(e,t){const i=e.labelPlacement,r=Je[t];if(!e.symbol)return Ze.warn("No ILabelClass symbol specified."),!0;if(!r)return Ze.error(new n.s("mapview-labeling:unsupported-geometry-type",`Unable to create labels for Feature Layer, ${t} is not supported`)),!0;if(!r.some((e=>e===i))){const s=r[0];i&&Ze.warn(`Found invalid label placement type ${i} for ${t}. Defaulting to ${s}`),e.labelPlacement=s}return!1}(e,t)))?[]:i}function tt(e){return(0,a.c)("esri-2d-update-debug")&&console.debug("Created new schema",it(e,!0)),it(e)}function it(e,t=!1){try{var i,r;const s=function(e,t=!1){const i=new Array;return i.push(ht(e,t)),i}(e,t),a={};return s.map((t=>function(e,t,i){switch(i.target){case"feature":return void nt(e,st(t),i);case"aggregate":{if(!("featureReduction"in t))return;const r=t.featureReduction;if("selection"===r.type)throw new n.s(Ye,"Mapview does not support `selection` reduction type",r);return nt(e,st(t),i),void function(e,t,i){e.aggregate||(e.aggregate={name:"aggregate",input:"feature",filters:null,attributes:{},params:{clusterRadius:(0,o.u)(t.clusterRadius/2),clusterPixelBuffer:64*Math.ceil((0,o.u)(t.clusterMaxSize)/64),fields:i.aggregateFields}}),rt(e.aggregate,i.attributes.fields)}(e,r,i)}}}(a,e,t))),{source:{definitionExpression:e.definitionExpression,fields:e.fields.map((e=>e.toJSON())),gdbVersion:e.gdbVersion,historicMoment:null==(i=e.historicMoment)?void 0:i.getTime(),outFields:e.availableFields,pixelBuffer:e.pixelBuffer,spatialReference:e.spatialReference.toJSON(),timeExtent:null==(r=e.timeExtent)?void 0:r.toJSON()},attributes:{fields:{},indexCount:0},processors:s,targets:a}}catch(e){if(e.fieldName===Ye)return Ze.error(e),null;throw e}}function rt(e,t){for(const i in t){const r=t[i];if(r.target!==e.name)continue;const s=e.attributes[i];s?(s.context.mesh=s.context.mesh||r.context.mesh,s.context.storage=s.context.storage||r.context.storage):e.attributes[i]=r}return e}function st(e){var t,i,r,s,n;return[null!=(t=null==(i=e.filter)?void 0:i.toJSON())?t:null,null!=(r=null==(s=e.effect)||null==(n=s.filter)?void 0:n.toJSON())?r:null]}function nt(e,t,i){return e.feature||(e.feature={name:"feature",input:"source",filters:t,attributes:{}}),rt(e.feature,i.attributes.fields),e}function at(e,t){return t.field?ot(e,{...t,type:"field",field:t.field}):t.valueExpression?ot(e,{...t,type:"expression",valueExpression:t.valueExpression}):{field:null,fieldIndex:null}}function ot(e,t){switch(t.type){case"expression":{const i=t.valueExpression;if(!e.fields[i]){const r=e.indexCount++;e.fields[i]={...t,name:i,fieldIndex:r}}return{fieldIndex:e.fields[i].fieldIndex}}case"label-expression":{const i=JSON.stringify(t.label);if(!e.fields[i]){const r=e.indexCount++;e.fields[i]={...t,name:i,fieldIndex:r}}return{fieldIndex:e.fields[i].fieldIndex}}case"field":{const i=t.field;return"aggregate"===t.target&&e.fields[i]||(e.fields[i]={...t,name:i}),{field:i}}case"statistic":return e.fields[t.name]={...t},{field:t.name}}}function lt(e,t,i,r,s,n=!1){const a=ot(t,{type:"label-expression",target:r,context:{mesh:!0},resultType:"string",label:{labelExpression:i.labelExpression,labelExpressionInfo:i.labelExpressionInfo?{expression:i.labelExpressionInfo.expression}:null,symbol:!!i.symbol,where:i.where}}),{fieldIndex:o}=a;return{...Ke(i,e,n),fieldIndex:o,target:r,index:s}}function ht(e,t,i=!1){const r={indexCount:0,fields:{}},o="featureReduction"in e&&e.featureReduction,l=o?"aggregate":"feature";if("sublayers"in e){const t={type:"subtype",subtypeField:e.subtypeField,renderers:{}},s={type:"subtype",mapping:{},target:"feature"},o={type:"subtype",classes:{}},h={type:"symbol",target:"feature",aggregateFields:[],attributes:r,storage:s,mesh:{matcher:t,aggregateMatcher:null,labels:o}},u=new Set;let c=0;for(const{renderer:h,subtypeCode:d,labelingInfo:p,labelsVisible:f}of e.sublayers){const e=ct(r,l,h,i),y=ut(r,l,h),m=f&&p;if("visualVariables"in h&&h.visualVariables&&h.visualVariables.length)throw new n.s(Ye,"Visual variables are currently not supported for subtype layers");if("dictionary"===e.type)throw new n.s(Ye,"Dictionary renderer is not supported in subtype layers");if("subtype"===e.type)throw new n.s(Ye,"Nested subtype renderers is not supported");if((0,a.r)(y)&&"subtype"===y.type)throw new n.s(Ye,"Nested subtype storage is not supported");if((0,a.r)(y)&&"dot-density"===y.type)throw new n.s(Ye,"Dot density attributes are not supported in subtype layers");if(u.has(d))throw new n.s(Ye,"Subtype codes for sublayers must be unique");u.add(d),t.renderers[d]=e,s.mapping[d]=y,m&&(o.classes[d]=m.map((e=>lt(h,r,e,"feature",c++,i))))}return h}switch(e.renderer.type){case"heatmap":{const{blurRadius:t,fieldOffset:i,field:s}=e.renderer;return{type:"heatmap",aggregateFields:[],attributes:r,target:l,storage:null,mesh:{blurRadius:t,fieldOffset:i,field:at(r,{target:l,field:s,resultType:"numeric"}).field}}}default:{const t=[],a="aggregate"===l?Ve(t,e.renderer,o,null):e.renderer;!function(e,t){const i={mesh:!0,storage:!0};for(const r of t){const{name:t,outStatistic:s}=r,{statisticType:n,onStatisticField:a}=s;let o=null,l=null,h=null;const u="numeric",c="feature";"onStatisticValueExpression"in s?l=ot(e,{type:"expression",target:c,valueExpression:s.onStatisticValueExpression,resultType:u}).fieldIndex:"onStatisticNormalizationField"in s?(o=ot(e,{type:"field",target:c,field:a,resultType:u}).field,h=s.onStatisticNormalizationField):o=ot(e,{type:"field",target:c,field:a,resultType:u}).field,ot(e,{type:"statistic",target:"aggregate",name:t,context:i,inField:o,inNormalizationField:h,inFieldIndex:l,statisticType:n})}}(r,t);const h=ct(r,l,a,i);let u=null;const c=ut(r,l,a),d=Qe(e.geometryType);let p=e.labelsVisible&&e.labelingInfo||[],f=[];if(o){if("selection"===o.type)throw new n.s(Ye,"Mapview does not support `selection` reduction type",o);if(o.symbol){const e=new s.m({symbol:o.symbol,visualVariables:"visualVariables"in a?a.visualVariables:null});u=ct(r,l,e,i)}f=o&&o.labelsVisible&&o.labelingInfo||[]}p=et(p,d),f=et(f,d);let y=0;const m=[...p.map((e=>lt(a,r,e,"feature",y++,i))),...f.map((e=>lt(a,r,e,"aggregate",y++,i)))];return{type:"symbol",target:l,attributes:r,aggregateFields:t,storage:c,mesh:{matcher:h,labels:{type:"simple",classes:m},aggregateMatcher:u}}}}}function ut(e,t,i){switch(i.type){case"dot-density":return function(e,t,i){return i&&i.length?{type:"dot-density",mapping:i.map(((i,r)=>{const{field:s,fieldIndex:n}=at(e,{valueExpression:i.valueExpression,field:i.field,resultType:"numeric",target:t});return{binding:r,field:s,fieldIndex:n}})),target:t}:{type:"dot-density",mapping:[],target:t}}(e,t,i.attributes);case"simple":case"class-breaks":case"unique-value":case"dictionary":return function(e,t,i){if(!i||!i.length)return{type:"visual-variable",mapping:[],target:t};const r={storage:!0},s="numeric";return{type:"visual-variable",mapping:Ae(i).map((i=>{var n;const a=(0,h.X)(i.type),{field:o,fieldIndex:l}=at(e,{target:t,valueExpression:i.valueExpression,field:i.field,context:r,resultType:s});switch(i.type){case"size":return"$view.scale"===i.valueExpression?null:{type:"size",binding:a,field:o,fieldIndex:l,normalizationField:at(e,{target:t,field:i.normalizationField,context:r,resultType:s}).field,valueRepresentation:null!=(n=i.valueRepresentation)?n:null};case"color":return{type:"color",binding:a,field:o,fieldIndex:l,normalizationField:at(e,{target:t,field:i.normalizationField,context:r,resultType:s}).field};case"opacity":return{type:"opacity",binding:a,field:o,fieldIndex:l,normalizationField:at(e,{target:t,field:i.normalizationField,context:r,resultType:s}).field};case"rotation":return{type:"rotation",binding:a,field:o,fieldIndex:l}}})).filter((e=>e)),target:t}}(e,t,i.visualVariables);case"heatmap":return null}}function ct(e,t,i,r=!1){const s=(0,a.q)(e,{indexCount:0,fields:{}});switch(i.type){case"simple":case"dot-density":return function(e,t,i,r=!1){const s=t.getSymbols();return{type:"simple",symbol:Ke(s.length?s[0]:null,t,r),isDotDensity:i}}(0,i,"dot-density"===i.type,r);case"class-breaks":return function(e,t,i,r=!1){const s=i.backgroundFillSymbol,{field:n,fieldIndex:a}=at(e,{target:t,field:i.field,valueExpression:i.valueExpression,resultType:"numeric",context:{mesh:!0,use:"renderer.field"}}),o=i.normalizationType,l="log"===o?"esriNormalizeByLog":"percent-of-total"===o?"esriNormalizeByPercentOfTotal":"field"===o?"esriNormalizeByField":null,h=i.classBreakInfos.map((e=>({symbol:Ke(e.symbol,i,r),min:e.minValue,max:e.maxValue}))).sort(((e,t)=>e.min-t.min));return{type:"interval",attributes:e.fields,field:n,fieldIndex:a,backgroundFillSymbol:Ke(s,i,r),defaultSymbol:Ke(i.defaultSymbol,i,r),intervals:h,normalizationField:i.normalizationField,normalizationTotal:i.normalizationTotal,normalizationType:l,isMaxInclusive:i.isMaxInclusive}}(s,t,i,r);case"unique-value":return function(e,t,i,r=!1){const s=[],a=i.backgroundFillSymbol,o={target:t,context:{mesh:!0},resultType:"string"};if(i.field&&"string"!=typeof i.field)throw new n.s(Ye,"Expected renderer.field to be a string",i);const{field:l,fieldIndex:h}=at(e,{...o,field:i.field,valueExpression:i.valueExpression});for(const e of i.uniqueValueInfos)s.push({value:""+e.value,symbol:Ke(e.symbol,i,r)});return{type:"map",attributes:e.fields,field:l,fieldIndex:h,field2:at(e,{...o,field:i.field2}).field,field3:at(e,{...o,field:i.field3}).field,fieldDelimiter:i.fieldDelimiter,backgroundFillSymbol:Ke(a,i),defaultSymbol:Ke(i.defaultSymbol,i),map:s}}(s,t,i,r);case"dictionary":return function(e,t,i=!1){return{type:"dictionary",renderer:t.toJSON()}}(0,i,r)}}},72783:(e,t,i)=>{"use strict";i.d(t,{c:()=>h,d:()=>c,h:()=>f,u:()=>o,y:()=>y});var r=i(92858),s=i(52957);class n{constructor(){this.code=null,this.description=null}}class a{constructor(e){this.error=new n,this.globalId=null,this.objectId=null,this.success=!1,this.uniqueId=null,this.error.description=e}}function o(e){return new a(e)}class l{constructor(e){this.globalId=null,this.success=!0,this.objectId=this.uniqueId=e}}function h(e){return new l(e)}const u=new Set;function c(e,t,i,r,n=!1,a){u.clear();for(const r in i){const l=e.get(r);if(!l)continue;const h=i[r],c=d(l,h);if(c!==h&&a&&a.push({name:"invalid-value-type",message:"attribute value was converted to match the field type",details:{field:l,originalValue:h,sanitizedValue:c}}),u.add(l.name),l&&(n||l.editable)){const e=(0,s.l)(l,c);if(e)return o((0,s.o)(e,l,c));t[l.name]=c}}if(r)for(const e of r)if(!u.has(e.name))return o(`missing required field "${e.name}"`);return null}function d(e,t){let i=t;return"string"==typeof t&&(0,s.J)(e)?i=parseFloat(t):null!=t&&(0,s.X)(e)&&"string"!=typeof t&&(i=String(t)),(0,s.Z)(i)}let p;function f(e,t){if(!e||!(0,r.s)(t))return e;if("rings"in e||"paths"in e){if(!p)throw new TypeError("geometry engine not loaded");return p.simplify(t,e)}return e}async function y(e,t){!(0,r.s)(e)||"esriGeometryPolygon"!==t&&"esriGeometryPolyline"!==t||await async function(){return p||(p=await Promise.all([i.e(1337),i.e(9351),i.e(7273)]).then(i.bind(i,87273)),p)}()}},60255:(e,t,i)=>{"use strict";i.d(t,{I:()=>G,J:()=>I,N:()=>w,P:()=>U,_:()=>S,a:()=>C,j:()=>g,n:()=>y,t:()=>f,v:()=>V,x:()=>M});var r=i(20215),s=i(98548),n=i(89710),a=i(92858),o=i(29831),l=i(91728),h=i(29986),u=i(31531),c=i(80219),d=i(65352),p=i(71470);function f(e,t){if(!e)return null;const i=t.featureAdapter,{startTimeField:r,endTimeField:s}=e;let n=Number.POSITIVE_INFINITY,a=Number.NEGATIVE_INFINITY;if(r&&s)t.forEach((e=>{const t=i.getAttribute(e,r),o=i.getAttribute(e,s);null==t||isNaN(t)||(n=Math.min(n,t)),null==o||isNaN(o)||(a=Math.max(a,o))}));else{const e=r||s;t.forEach((t=>{const r=i.getAttribute(t,e);null==r||isNaN(r)||(n=Math.min(n,r),a=Math.max(a,r))}))}return{start:n,end:a}}function y(e,t,i){if(!t||!e)return null;const{startTimeField:r,endTimeField:s}=e;if(!r&&!s)return null;const{start:n,end:a}=t;return null===n&&null===a?null:void 0===n&&void 0===a?()=>!1:r&&s?function(e,t,i,r,s){return null!=r&&null!=s?n=>{const a=e.getAttribute(n,t),o=e.getAttribute(n,i);return(null==a||a<=s)&&(null==o||o>=r)}:null!=r?t=>{const s=e.getAttribute(t,i);return null==s||s>=r}:null!=s?i=>{const r=e.getAttribute(i,t);return null==r||r<=s}:void 0}(i,r,s,n,a):function(e,t,i,r){return null!=i&&null!=r&&i===r?r=>e.getAttribute(r,t)===i:null!=i&&null!=r?s=>{const n=e.getAttribute(s,t);return n>=i&&n<=r}:null!=i?r=>e.getAttribute(r,t)>=i:null!=r?i=>e.getAttribute(i,t)<=r:void 0}(i,r||s,n,a)}const m=new u.o({esriSRUnit_Meter:"meters",esriSRUnit_Kilometer:"kilometers",esriSRUnit_Foot:"feet",esriSRUnit_StatuteMile:"miles",esriSRUnit_NauticalMile:"nautical-miles",esriSRUnit_USNauticalMile:"us-nautical-miles"}),g=Object.freeze({}),_=new l.a,x=new l.a,v=new l.a,b={esriGeometryPoint:o.w,esriGeometryPolyline:o.A,esriGeometryPolygon:o.$,esriGeometryMultipoint:o.V};function w(e,t,i,r=e.hasZ,s=e.hasM){const n=e.hasZ&&r,a=e.hasM&&s;if(i){const l=(0,o.c)(v,t,e.hasZ,e.hasM,"esriGeometryPoint",i,r,s);return(0,o.w)(l,n,a)}return(0,o.w)(t,n,a)}function S(e,t,i,r,s,n,a=t,l=i){const h=t&&a,u=i&&l,c=r?"coords"in r?r:r.geometry:null;if(!c)return null;if(s){let r=(0,o.l)(x,c,t,i,e,s,a,l);return n&&(r=(0,o.c)(v,r,h,u,e,n)),b[e](r,h,u)}if(n){const r=(0,o.c)(v,c,t,i,e,n,a,l);return b[e](r,h,u)}return(0,o.g)(_,c,t,i,a,l),b[e](_,h,u)}async function I(e,t,i){const{outFields:r,orderByFields:s,groupByFieldsForStatistics:n,outStatistics:a}=e;if(r)for(let e=0;e<r.length;e++)r[e]=r[e].trim();if(s)for(let e=0;e<s.length;e++)s[e]=s[e].trim();if(n)for(let e=0;e<n.length;e++)n[e]=n[e].trim();if(a)for(let e=0;e<a.length;e++)a[e].onStatisticField&&(a[e].onStatisticField=a[e].onStatisticField.trim());return e.geometry&&!e.outSR&&(e.outSR=e.geometry.spatialReference),C(e,t,i)}async function C(e,t,r){if(!e)return null;let{where:o}=e;if(e.where=o=o&&o.trim(),(!o||/^1 *= *1$/.test(o)||t&&t===o)&&(e.where=null),!e.geometry)return e;let l=await async function(e){const{geometry:t,distance:r,units:s}=e;if(null==r||"vertexAttributes"in t)return t;const n=t.spatialReference,o=s?m.fromJSON(s):(0,d.L)(n),l=n&&((0,a.R)(n)||(0,a.u)(n))?t:await(0,h.p)(n,a.I).then((()=>(0,h.y)(t,a.I)));return(await async function(){return(await Promise.all([i.e(1337),i.e(9351),i.e(7273)]).then(i.bind(i,87273))).geodesicBuffer}())(l.spatialReference,l,r,o)}(e);if(e.distance=0,e.units=null,"esriSpatialRelEnvelopeIntersects"===e.spatialRel){const{spatialReference:t}=e.geometry;l=(0,s.d)(l),l.spatialReference=t}e.geometry=l,await(0,h.p)(l.spatialReference,r);const u=(await(0,p.L)((0,n.p)(l)))[0];if((0,c.t)(u))throw g;const f=u.toJSON(),y=await(0,h.y)(f,f.spatialReference,r);if(!y)throw g;return y.spatialReference=r,e.geometry=y,e}function M(e){return e&&T in e?JSON.parse(JSON.stringify(e,E)):e}const T="_geVersion",E=(e,t)=>e!==T?t:void 0;function F(e,t){return e?t?4:3:t?3:2}function A(e,t,i,r,s,n){const a=F(s,n),{coords:o,lengths:l}=r;if(!l)return!1;for(let r=0,s=0;r<l.length;r++,s+=a)if(!R(e,t,i,o[s],o[s+1]))return!1;return!0}function R(e,t,i,r,s){if(!e)return!1;const n=F(t,i),{coords:a,lengths:o}=e;let l=!1,h=0;for(const e of o)l=P(l,a,n,h,e,r,s),h+=e*n;return l}function P(e,t,i,r,s,n,a){let o=e,l=r;for(let e=r,h=r+s*i;e<h;e+=i){l=e+i,l===h&&(l=r);const s=t[e],u=t[e+1],c=t[l],d=t[l+1];(u<a&&d>=a||d<a&&u>=a)&&s+(a-u)/(d-u)*(c-s)<n&&(o=!o)}return o}const L="feature-store:unsupported-query",D={esriSpatialRelIntersects:"intersects",esriSpatialRelContains:"contains",esriSpatialRelCrosses:"crosses",esriSpatialRelDisjoint:"disjoint",esriSpatialRelEnvelopeIntersects:"intersects",esriSpatialRelIndexIntersects:null,esriSpatialRelOverlaps:"overlaps",esriSpatialRelTouches:"touches",esriSpatialRelWithin:"within",esriSpatialRelRelation:null},N={esriSpatialRelIntersects:!0,esriSpatialRelContains:!0,esriSpatialRelWithin:!0,esriSpatialRelCrosses:!0,esriSpatialRelDisjoint:!0,esriSpatialRelTouches:!0,esriSpatialRelOverlaps:!0,esriSpatialRelEnvelopeIntersects:!0,esriSpatialRelIndexIntersects:!1,esriSpatialRelRelation:!1},O={esriGeometryPoint:!0,esriGeometryMultipoint:!0,esriGeometryPolyline:!0,esriGeometryPolygon:!0,esriGeometryEnvelope:!0},k={esriGeometryPoint:!0,esriGeometryMultipoint:!0,esriGeometryPolyline:!0,esriGeometryPolygon:!0,esriGeometryEnvelope:!1};function V(e,t,r,a,h){if((0,n.y)(t)&&"esriGeometryPoint"===r&&("esriSpatialRelIntersects"===e||"esriSpatialRelContains"===e)){const e=(0,o.C)(new l.a,t,!1,!1);return Promise.resolve((t=>function(e,t,i,r){return R(e,!1,!1,r.coords[0],r.coords[1])}(e,0,0,t)))}if((0,n.y)(t)&&"esriGeometryMultipoint"===r){const i=(0,o.C)(new l.a,t,!1,!1);if("esriSpatialRelContains"===e)return Promise.resolve((e=>A(i,!1,!1,e,a,h)))}if((0,n.u)(t)&&"esriGeometryPoint"===r&&("esriSpatialRelIntersects"===e||"esriSpatialRelContains"===e))return Promise.resolve((e=>(0,s.t)(t,S(r,a,h,e))));if((0,n.u)(t)&&"esriGeometryMultipoint"===r&&"esriSpatialRelContains"===e)return Promise.resolve((e=>(0,s.r)(t,S(r,a,h,e))));if((0,n.u)(t)&&"esriSpatialRelIntersects"===e){const e=function(e){return"mesh"===e?s.e:(0,s.G)(e)}(r);return Promise.resolve((i=>e(t,S(r,a,h,i))))}return Promise.all([i.e(1337),i.e(9351),i.e(7273)]).then(i.bind(i,87273)).then((i=>{const s=i[D[e]].bind(null,t.spatialReference,t);return e=>s(S(r,a,h,e))}))}async function U(e,t,i){const{spatialRel:s,geometry:o}=e;if(o){if(!function(e){return!0===N[e]}(s))throw new r.s(L,"Unsupported query spatial relationship",{query:e});if((0,a.s)(o.spatialReference)&&(0,a.s)(i)){if(!function(e){return!0===O[(0,n.d)(e)]}(o))throw new r.s(L,"Unsupported query geometry type",{query:e});if(!function(e){return!0===k[e]}(t))throw new r.s(L,"Unsupported layer geometry type",{query:e});if(e.outSR)return(0,h.p)(e.geometry&&e.geometry.spatialReference,e.outSR)}}}function G(e){if((0,n.u)(e))return!0;if((0,n.y)(e)){for(const t of e.rings){if(5!==t.length)return!1;if(t[0][0]!==t[1][0]||t[0][0]!==t[4][0]||t[2][0]!==t[3][0]||t[0][1]!==t[3][1]||t[0][1]!==t[4][1]||t[1][1]!==t[2][1])return!1}return!0}return!1}},15120:(e,t,i)=>{"use strict";function r(e,t,i){return t.flatten((({sublayers:e})=>e)).length!==e.length||!!e.some((e=>e.originIdOf("minScale")>i||e.originIdOf("maxScale")>i||e.originIdOf("renderer")>i||e.originIdOf("labelingInfo")>i||e.originIdOf("opacity")>i||e.originIdOf("labelsVisible")>i||e.originIdOf("source")>i))||!n(e,t)}function s(e,t,i){return!!e.some((e=>{const t=e.source;return!(!t||"map-layer"===t.type&&t.mapLayerId===e.id&&(!t.gdbVersion||t.gdbVersion===i.gdbVersion))||e.originIdOf("renderer")>2||e.originIdOf("labelingInfo")>2||e.originIdOf("opacity")>2||e.originIdOf("labelsVisible")>2}))||!n(e,t)}function n(e,t){if(!e||!e.length)return!0;const i=t.slice().reverse().flatten((({sublayers:e})=>e&&e.toArray().reverse())).map((e=>e.id)).toArray();if(e.length>i.length)return!1;let r=0;const s=i.length;for(const{id:t}of e){for(;r<s&&i[r]!==t;)r++;if(r>=s)return!1}return!0}function a(e){return!!e&&e.some((e=>null!=e.minScale||e.layerDefinition&&null!=e.layerDefinition.minScale))}i.d(t,{e:()=>r,i:()=>a,n:()=>s})},13838:(e,t,i)=>{"use strict";function r(e,t,i,r){const s=e.clone(),n=1<<s.level,a=s.col+t,o=s.row+i;return r&&a<0?(s.col=a+n,s.world-=1):a>=n?(s.col=a-n,s.world+=1):s.col=a,s.row=o,s}i.d(t,{l:()=>r}),i(78155),i(98548),i(80219),i(18143),i(29218)},32553:(e,t,i)=>{"use strict";function r(e){const t=null!=e.normalizationField||null!=e.normalizationType,i=null!=e.minValue||null!=e.maxValue,r=!!e.sqlExpression&&e.supportsSQLExpression;return!t&&!i&&!r}function s(e){const{values:t,supportsNullCount:i}=e,r=t.filter((e=>null!=e)).length,s={count:r};return i&&(s.nullcount=t.length-r),s}function n(e){const{values:t,useSampleStdDev:i,supportsNullCount:r}=e;let s=Number.POSITIVE_INFINITY,n=Number.NEGATIVE_INFINITY,a=null,o=null,l=null,h=null,u=0;const c=null==e.minValue?-1/0:e.minValue,d=null==e.maxValue?1/0:e.maxValue;for(const e of t)Number.isFinite(e)?e>=c&&e<=d&&(a+=e,s=Math.min(s,e),n=Math.max(n,e),u++):"string"==typeof e&&u++;if(u&&null!=a){o=a/u;let e=0;for(const i of t)Number.isFinite(i)&&i>=c&&i<=d&&(e+=(i-o)**2);h=i?u>1?e/(u-1):0:u>0?e/u:0,l=Math.sqrt(h)}else s=null,n=null;const p={avg:o,count:u,max:n,min:s,stddev:l,sum:a,variance:h};return r&&(p.nullcount=t.length-u),p}function a(e,t){return t?(["avg","stddev","variance"].forEach((t=>{null!=e[t]&&(e[t]=Math.ceil(e[t]))})),e):e}function o(e,t,i,r){let s=null;switch(t){case"log":0!==e&&(s=Math.log(e)*Math.LOG10E);break;case"percent-of-total":Number.isFinite(r)&&0!==r&&(s=e/r*100);break;case"field":Number.isFinite(i)&&0!==i&&(s=e/i);break;case"natural-log":e>0&&(s=Math.log(e));break;case"square-root":e>0&&(s=e**.5)}return s}i.d(t,{i:()=>s,o:()=>r,r:()=>n,s:()=>o,u:()=>a}),i(20215),i(52957)},84581:(e,t,i)=>{"use strict";i.d(t,{c:()=>p,l:()=>d,o:()=>l,p:()=>f});var r=i(80219),s=i(84935);const n=180/Math.PI,a=function(e){return e&&"esri.layers.support.PixelBlock"===e.declaredClass&&e.pixels&&e.pixels.length>0},o=new Map;function l(e,t){return o.get(e)/o.get(t)||1}function h(e){return(450-e)%360}function u(e,t="geographic"){const[i,r]=e,s=Math.sqrt(i*i+r*r);let a=Math.atan2(r,i)*n;return a=(360+a)%360,"geographic"===t&&(a=h(a)),[s,a]}function c(e,t="geographic"){let i=e[1];"geographic"===t&&(i=h(i)),i%=360;const r=e[0];return[r*Math.cos(i/n),r*Math.sin(i/n)]}function d(e,t,i="geographic",r=1){if(!a(e))return e;const{pixels:n,width:o,height:l}=e,h=o*l,d=n[0],p=n[1],f=s.u.createEmptyBand(e.pixelType,h),y=s.u.createEmptyBand(e.pixelType,h);let m=0;for(let e=0;e<l;e++)for(let e=0;e<o;e++)"vector-uv"===t?([f[m],y[m]]=u([d[m],p[m]],i),f[m]*=r):([f[m],y[m]]=c([d[m],p[m]],i),f[m]*=r,y[m]*=r),m++;const g=new s.u({pixelType:e.pixelType,width:e.width,height:e.height,mask:e.mask,validPixelCount:e.validPixelCount,maskIsAlpha:e.maskIsAlpha,pixels:[f,y]});return g.updateStatistics(),g}function p(e,t,i=1){if(1===i||!a(e))return e;const r=e.clone(),{pixels:s,width:n,height:o}=r,l=s[0],h=s[1];let u=0;for(let e=0;e<o;e++)for(let e=0;e<n;e++)"vector-uv"===t?(l[u]*=i,h[u]*=i):l[u]*=i,u++;return r.updateStatistics(),r}function f(e,t,i,s,n){if(!(0,r.r)(n)||!n.spatialReference.equals(e.spatialReference))return{extent:e,width:t,height:i,resolution:e.width/t};const a=n.xmin,o=n.ymax;s=Math.max(s||0,30);const l=Math.ceil(t*(1/s)),h=Math.ceil(i*(1/s)),u=((e.xmax-e.xmin)/l+(e.ymax-e.ymin)/h)/2;return e.xmin=a+Math.floor((e.xmin-a)/u)*u,e.xmax=a+Math.ceil((e.xmax-a)/u)*u,e.ymin=o+Math.floor((e.ymin-o)/u)*u,e.ymax=o+Math.ceil((e.ymax-o)/u)*u,{extent:e,width:Math.round(e.width/u),height:Math.round(e.height/u),resolution:u}}o.set("meter-per-second",1),o.set("kilometer-per-hour",.277778),o.set("knots",.514444),o.set("feet-per-second",.3048),o.set("mile-per-hour",.44704)},39306:(e,t,i)=>{"use strict";i.d(t,{_:()=>ue,a:()=>F,b:()=>E,c:()=>C,d:()=>v,e:()=>_,f:()=>ce,g:()=>b,h:()=>T,i:()=>Z,j:()=>g,k:()=>me,l:()=>I,m:()=>ye,n:()=>A,s:()=>M,t:()=>S,v:()=>W,y:()=>w});var r=i(65352),s=(i(80987),i(20215)),n=i(7571),a=(i(98548),i(20736),i(92858)),o=i(71391),l=i(83731),h=i(80219),u=i(94527),c=i(67726),d=i(60816),p=(i(93242),i(58275)),f=i(78155),y=i(88903),m=(i(95559),i(79679));const g={readOnly:!0,get(){const e="metric",{view:t}=this;if(!t)return e;const i=t.get("map.portalItem.portal");if(i)switch(i.get("user.units")||i.units){case e:return e;case"english":return"imperial"}return(0,r.W)(t.spatialReference)||e}};class _{constructor(e,t){this.measure=(0,r.j)(t),this.value=e,this.unit=t}get isBaseUnit(){return(0,r.C)(this.unit)}toUnit(e){return new _((0,r.I)(this.value,this.unit,e),e)}toBaseUnit(){return this.toUnit((0,r.P)(this.unit))}}function x(e){if(!e)return null;if(e.isGeographic&&e.wkid){const t=n.a[e.wkid];if(t)return t}if(e.wkt){const t=function(e){const t=n.b.exec(e);if(!t||2!==t.length)return null;const i=t[1].split(",");if(!i||i.length<3)return null;const r=parseFloat(i[1]),s=parseFloat(i[2]);return isNaN(r)||isNaN(s)?null:{a:r,f:0===s?0:1/s}}(e.wkt);if(t)return t}return null}function v(e){return null!==x(e)}function b(e,t="meters"){if(!e)throw new s.s("geodesic-lengths:invalid-geometries","the input geometries type is not supported");if(e.some((e=>!v(e.spatialReference))))throw new s.s("geodesic-lengths:invalid-spatial-reference","the input geometries spatial reference is not supported");const i=[];for(let s=0;s<e.length;s++){const n=e[s],{spatialReference:a}=n,o="polyline"===n.type?n.paths:n.rings;let l=0;for(let e=0;e<o.length;e++){const t=o[e];let i=0;for(let e=1;e<t.length;e++){const r=t[e-1][0],s=t[e][0],n=t[e-1][1],o=t[e][1];if(n!==o||r!==s){const e={distance:null};w(e,[r,n],[s,o],a),i+=e.distance}}l+=i}l=(0,r.I)(l,"meters",t),i.push(l)}return i}function w(e,t,i,r){const s=t[0]*n.i,o=t[1]*n.i,l=i[0]*n.i,h=i[1]*n.i,{a:u,b:c,f:d,radius:p}=function(e){const t=x(e||a.k.WGS84);if(function(e){return"b"in e&&"eSq"in e&&"radius"in e}(t))return t;const i=t.a*(1-t.f);return Object.assign(t,{b:i,eSq:1-(i/t.a)**2,radius:(2*t.a+i)/3,densificationRatio:1e4/((2*t.a+i)/3)})}(r),f=l-s,y=Math.atan((1-d)*Math.tan(o)),m=Math.atan((1-d)*Math.tan(h)),g=Math.sin(y),_=Math.cos(y),v=Math.sin(m),b=Math.cos(m);let w,S,I,C,M,T,E,F,A,R,P=1e3,L=f;do{if(E=Math.sin(L),F=Math.cos(L),I=Math.sqrt(b*E*(b*E)+(_*v-g*b*F)*(_*v-g*b*F)),0===I)return e.distance=0,e.azimuth=void 0,e.reverseAzimuth=void 0,e;M=g*v+_*b*F,T=Math.atan2(I,M),A=_*b*E/I,S=1-A*A,C=M-2*g*v/S,isNaN(C)&&(C=0),R=d/16*S*(4+d*(4-3*S)),w=L,L=f+(1-R)*d*A*(T+R*I*(C+R*M*(2*C*C-1)))}while(Math.abs(L-w)>1e-12&&--P>0);if(0===P){const t=p,i=Math.acos(Math.sin(o)*Math.sin(h)+Math.cos(o)*Math.cos(h)*Math.cos(l-s))*t,r=l-s,a=Math.sin(r)*Math.cos(h),u=Math.cos(o)*Math.sin(h)-Math.sin(o)*Math.cos(h)*Math.cos(r),c=Math.atan2(a,u);return e.azimuth=c/n.i,e.distance=i,e.reverseAzimuth=void 0,e}const D=S*(u*u-c*c)/(c*c),N=D/1024*(256+D*(D*(74-47*D)-128)),O=c*(1+D/16384*(4096+D*(D*(320-175*D)-768)))*(T-N*I*(C+N/4*(M*(2*C*C-1)-N/6*C*(4*I*I-3)*(4*C*C-3)))),k=Math.atan2(b*Math.sin(L),_*v-g*b*Math.cos(L)),V=Math.atan2(_*Math.sin(L),_*v*Math.cos(L)-g*b);return e.azimuth=k/n.i,e.distance=O,e.reverseAzimuth=V/n.i,e}class S{constructor(e=null){this.spatialReference=e}get spatialReference(){return this._spatialReference}set spatialReference(e){e!==this._spatialReference&&(this._spatialReference=e,this._updateNormalizationFactors())}normalizeDistance(e){return e*this._metersPerDistanceUnit}normalizeElevation(e){return e*this._metersPerElevationUnit}normalizeArea(e){return e*this._squareMetersPerAreaUnit}_updateNormalizationFactors(){this._metersPerDistanceUnit=(0,r.G)(this._spatialReference,1),this._metersPerElevationUnit=(0,r.G)(this._spatialReference,1),this._squareMetersPerAreaUnit=this._metersPerDistanceUnit*this._metersPerDistanceUnit}}function I(e,t,i,r=2,s="abbr"){return(0,o.af)(e,t.toUnit(i).value,i,r,s)}function C(e,t,i=2,r="abbr"){if("length"!==t.measure)throw new Error("quantity is not a length");return(0,o.aj)(e,t.value,t.unit,i,r)}function M(e,t,i=2,r="abbr"){if("length"!==t.measure)throw new Error("quantity is not a length");return(0,o.ak)(e,t.value,t.unit,i,r)}function T(e,t,i=2,r="abbr"){if("length"!==t.measure)throw new Error("quantity is not a length");return(0,o.ah)(e,t.value,t.unit,i,r)}function E(e,t,i=2,r="abbr"){if("length"!==t.measure)throw new Error("quantity is not a length");return(0,o.ai)(e,t.value,t.unit,i,r)}function F(e){if("angle"!==e.measure)throw new Error("quantity is not an angle");return(0,o.ag)(e.value,e.unit)}function A(e,t){if((0,d.a)(t,0,0,0),e.length>0){for(let i=0;i<e.length;++i)(0,d.u)(t,t,e[i]);(0,d.d)(t,t,1/e.length)}}const R=(0,u.x)(),P=R,L=(0,u.x)(),D=L;let N=e=>({vnodeSelector:"",properties:void 0,children:void 0,text:e.toString(),domNode:null}),O=(e,t,i)=>{for(let r=0,s=t.length;r<s;r++){let s=t[r];Array.isArray(s)?O(e,s,i):null!=s&&!1!==s&&("string"==typeof s&&(s=N(s)),i.push(s))}};function k(e,t,i){if(Array.isArray(t))i=t,t=void 0;else if(t&&("string"==typeof t||t.hasOwnProperty("vnodeSelector"))||i&&("string"==typeof i||i.hasOwnProperty("vnodeSelector")))throw new Error("h called with invalid arguments");let r,s;return i&&1===i.length&&"string"==typeof i[0]?r=i[0]:i&&(s=[],O(e,i,s),0===s.length&&(s=void 0)),{vnodeSelector:e,properties:t,children:s,text:""===r?void 0:r,domNode:null}}let V=class extends f.p{constructor(e){super(e),this.startX=0,this.startY=0,this.endX=0,this.endY=0,this.width=1,this.color=[0,0,0,.5],this.visible=!0}get startPosition(){return[this.startX,this.startY]}set startPosition(e){this._set("startX",e[0]),this._set("startY",e[1])}get endPosition(){return[this.endX,this.endY]}set endPosition(e){this._set("endX",e[0]),this._set("endY",e[1])}get strokeStyle(){const e=this.color;return`rgba(${e[0]}, ${e[1]}, ${e[2]}, ${e[3]})`}get lineCap(){return"round"}render(){const{height:e,left:t,top:i,width:r,x1:s,x2:n,y1:a,y2:o}=this.calculateCoordinates(U),l=`stroke: ${this.strokeStyle}; stroke-width: ${this.width}; stroke-linecap: ${this.lineCap};`;return k("div",{classes:{"esri-line-overlay-item":!0},styles:{left:t+"px",top:i+"px",width:r+"px",height:e+"px",visibility:this.visible?"visible":"hidden"}},[k("svg",{width:r,height:e},[k("line",{x1:s,y1:a,x2:n,y2:o,style:l})])])}renderCanvas(e){if(!this.visible)return;e.strokeStyle=this.strokeStyle,e.lineWidth=this.width,e.lineCap=this.lineCap;const t=this.calculateCoordinates(U);e.beginPath(),e.moveTo(t.left+t.x1,t.top+t.y1),e.lineTo(t.left+t.x2,t.top+t.y2),e.stroke()}calculateCoordinates(e){const t=Math.min(this.startX,this.endX),i=Math.max(this.startX,this.endX),r=Math.min(this.startY,this.endY),s=Math.max(this.startY,this.endY),n=this.width;return e.left=t-n,e.top=r-n,e.width=i-t+2*n,e.height=Math.max(20,s-r+2*n),e.x1=this.startX-t+n,e.y1=this.startY-r+n,e.x2=this.endX-t+n,e.y2=this.endY-r+n,e}};(0,f.e)([(0,y.y)()],V.prototype,"startX",void 0),(0,f.e)([(0,y.y)()],V.prototype,"startY",void 0),(0,f.e)([(0,y.y)()],V.prototype,"endX",void 0),(0,f.e)([(0,y.y)()],V.prototype,"endY",void 0),(0,f.e)([(0,y.y)()],V.prototype,"startPosition",null),(0,f.e)([(0,y.y)()],V.prototype,"endPosition",null),(0,f.e)([(0,y.y)()],V.prototype,"width",void 0),(0,f.e)([(0,y.y)()],V.prototype,"color",void 0),(0,f.e)([(0,y.y)()],V.prototype,"visible",void 0),(0,f.e)([(0,y.y)({readOnly:!0})],V.prototype,"strokeStyle",null),V=(0,f.e)([(0,y.n)("esri.views.overlay.LineOverlayItem")],V);const U={left:0,top:0,width:0,height:0,x1:0,y1:0,x2:0,y2:0};var G=V;const z={bottom:"esri-text-overlay-item-anchor-bottom","bottom-right":"esri-text-overlay-item-anchor-bottom-right","bottom-left":"esri-text-overlay-item-anchor-bottom-left",top:"esri-text-overlay-item-anchor-top","top-right":"esri-text-overlay-item-anchor-top-right","top-left":"esri-text-overlay-item-anchor-top-left",center:"esri-text-overlay-item-anchor-center",right:"esri-text-overlay-item-anchor-right",left:"esri-text-overlay-item-anchor-left"};let B=class extends f.p{constructor(e){super(e),this.x=0,this.y=0,this.text="-",this.fontSize=14,this.anchor="center",this.visible=!0,this.backgroundColor="rgba(0, 0, 0, 0.6)",this.textColor="white",this.textShadowColor=[0,0,0],this.textShadowSize=1}get position(){return[this.x,this.y]}set position(e){this._set("x",e[0]),this._set("y",e[1])}get padding(){return.5*this.fontSize}render(){return k("div",{classes:this._cssClasses(),styles:{left:Math.floor(this.x)+"px",top:Math.floor(this.y)+"px",visibility:this.visible?"visible":"hidden",fontSize:this.fontSize+"px",backgroundColor:this.backgroundColor,color:this.textColor,padding:this.padding+"px",borderRadius:this.padding+"px",textShadow:`0 0 ${this.textShadowSize}px rgb(${this.textShadowColor[0]}, ${this.textShadowColor[1]}, ${this.textShadowColor[2]})`}},[this.text])}renderCanvas(e){if(!this.visible)return;const t=e.font.replace(/^(.*?)px/,"");e.font=`${this.fontSize}px ${t}`;const i=this.padding,r=this.padding,s=e.measureText(this.text).width,n=this.fontSize,a=j[this.anchor];e.textAlign="center",e.textBaseline="middle";const o=s+2*i,l=n+2*i,h=this.x+a.x*o,u=this.y+a.y*l;this.roundedRect(e,h,u,o,l,r),e.fillStyle=this.backgroundColor,e.fill();const c=this.x+(a.x+.5)*o,d=this.y+(a.y+.5)*l;this._renderTextShadow(e,this.text,c,d),e.fillStyle=this.textColor,e.fillText(this.text,c,d)}_renderTextShadow(e,t,i,r){e.lineJoin="miter",e.fillStyle=`rgba(${this.textShadowColor[0]}, ${this.textShadowColor[1]}, ${this.textShadowColor[2]}, ${1/q.length})`;const s=this.textShadowSize;for(const[n,a]of q)e.fillText(t,i+s*n,r+s*a)}roundedRect(e,t,i,r,s,n){e.beginPath(),e.moveTo(t,i+n),e.arcTo(t,i,t+n,i,n),e.lineTo(t+r-n,i),e.arcTo(t+r,i,t+r,i+n,n),e.lineTo(t+r,i+s-n),e.arcTo(t+r,i+s,t+r-n,i+s,n),e.lineTo(t+n,i+s),e.arcTo(t,i+s,t,i+s-n,n),e.closePath()}_cssClasses(){const e={"esri-text-overlay-item":!0};for(const t in z)e[z[t]]=this.anchor===t;return e}};(0,f.e)([(0,y.y)()],B.prototype,"x",void 0),(0,f.e)([(0,y.y)()],B.prototype,"y",void 0),(0,f.e)([(0,y.y)()],B.prototype,"position",null),(0,f.e)([(0,y.y)()],B.prototype,"text",void 0),(0,f.e)([(0,y.y)()],B.prototype,"fontSize",void 0),(0,f.e)([(0,y.y)()],B.prototype,"anchor",void 0),(0,f.e)([(0,y.y)()],B.prototype,"visible",void 0),(0,f.e)([(0,y.y)()],B.prototype,"padding",null),B=(0,f.e)([(0,y.n)("esri.views.overlay.TextOverlayItem")],B);const j={bottom:{x:-.5,y:-1,textAlign:"center",textBaseline:"bottom"},"bottom-left":{x:0,y:-1,textAlign:"left",textBaseline:"bottom"},"bottom-right":{x:-1,y:-1,textAlign:"right",textBaseline:"bottom"},center:{x:-.5,y:-.5,textAlign:"center",textBaseline:"middle"},left:{x:0,y:-.5,textAlign:"left",textBaseline:"middle"},right:{x:-1,y:-.5,textAlign:"right",textBaseline:"middle"},top:{x:-.5,y:0,textAlign:"center",textBaseline:"top"},"top-left":{x:0,y:0,textAlign:"left",textBaseline:"top"},"top-right":{x:-1,y:0,textAlign:"right",textBaseline:"top"}},q=[];{const e=16;for(let t=0;t<360;t+=360/e)q.push([Math.cos(Math.PI*t/180),Math.sin(Math.PI*t/180)])}var H=B;class W extends p.t{constructor(e){super(e.view),this._handles=new l.u,this._textItem=null,this._calloutItem=null,this._showCallout=!0,this._showText=!0,this._geometry=null,this._text=null,this._fontSize=14,this._distance=25,this._anchor="right",this.applyProps(e)}get geometry(){return this._geometry}set geometry(e){this._geometry=e,this._updateLabelPosition()}get textItem(){return this._textItem}get text(){return this._text}set text(e){this._text=e,this.attached&&(this._textItem.text=this._text)}get fontSize(){return this._fontSize}set fontSize(e){this._fontSize=e,this.attached&&(this._textItem.fontSize=this._fontSize)}get distance(){return this._distance}set distance(e){this._distance!==e&&(this._distance=e,this._updateLabelPosition())}get anchor(){return this._anchor}set anchor(e){this._anchor!==e&&(this._anchor=e,this._updateLabelPosition())}overlaps(e){return!!this.attached&&this.textItem.visible&&e.textItem.visible&&this.view.overlay.overlaps(this._textItem,e.textItem)}_updateLabelPosition(){if(this.attached){if(this._showText=!1,this._showCallout=!1,(0,h.r)(this.geometry)&&this.view._stage)switch(this.geometry.type){case"point":if(this._computeLabelPositionFromPoint(this.geometry.point,re)){if(this.geometry.callout){const e=this.view.state.camera,t=this.geometry.callout.distance;(0,c.s)(ie,ie,[0,this.geometry.callout.offset]),e.renderToScreen(ie,re),(0,c.r)(ee,0,1),(0,c.l)(ee,ee,t*e.pixelRatio),(0,c.s)(ee,ee,ie),e.renderToScreen(ee,se),this._showCallout=this._updatePosition(re,se)}else this._textItem.position=[re[0],re[1]],this._textItem.anchor="center";this._showText=!0}break;case"corner":this._computeLabelPositionFromCorner(this.geometry,this._distance,re,se)&&(this._showCallout=this._updatePosition(re,se),this._showText=!0);break;case"segment":this._computeLabelPositionFromSegment(this.geometry,this._distance,this._anchor,re,se)&&(this._showText=!0,this._showCallout=this._updatePosition(re,se))}this.updateVisibility(this.visible)}}_computeLabelPositionFromPoint(e,t){const i=this.view.state.camera;return i.projectToRenderScreen(e,ie),!(ie[2]<0||ie[2]>1||(i.renderToScreen(ie,t),0))}_computeLabelPositionFromCorner(e,t,i,r){if(!e)return!1;const s=this.view.state.camera;return Q(e.left,1,s,$),(0,c.p)($,$),Q(e.right,0,s,K),(0,c.s)(ee,$,K),(0,c.p)(ee,ee),(0,c.g)(ee,ee),s.projectToRenderScreen(e.left.endRenderSpace,ie),!(ie[2]<0||ie[2]>1||(s.renderToScreen(ie,i),(0,c.l)(ee,ee,t*s.pixelRatio),(0,c.s)(ee,ee,ie),s.renderToScreen(ee,r),0))}_computeLabelPositionFromSegment(e,t,i,r,s){if(!e)return!1;const n=e.segment,a=this.view.state.camera;(function(e,t,i,r){r.projectToRenderScreen(e,R),r.projectToRenderScreen(t,L),(0,c.o)(i,D,P),(0,c.g)(i,i)})(n.startRenderSpace,n.endRenderSpace,$,a),(0,c.r)(ee,-$[1],$[0]);let o=!1;switch(i){case"top":o=ee[1]<0;break;case"bottom":o=ee[1]>0;break;case"left":o=ee[0]>0;break;case"right":o=ee[0]<0}if(o&&(0,c.p)(ee,ee),0===(0,c.b)(ee))switch(i){case"top":ee[1]=1;break;case"bottom":ee[1]=-1;break;case"left":ee[0]=-1;break;case"right":ee[0]=1}return n.eval(he[e.sampleLocation],te),a.projectToRenderScreen(te,ie),!(ie[2]<0||ie[2]>1||(a.renderToScreen(ie,r),(0,c.l)(ee,ee,t*a.pixelRatio),(0,c.s)(ee,ee,ie),a.renderToScreen(ee,s),0))}_updatePosition(e,t){if(t){const i=t[0]-e[0],r=t[1]-e[1];return this._textItem.position=[t[0],t[1]],this._textItem.anchor=Math.abs(i)>Math.abs(r)?i>0?"left":"right":r>0?"top":"bottom",this._calloutItem.startPosition=[e[0],e[1]],this._calloutItem.endPosition=[t[0],t[1]],!0}return this._textItem.position=[e[0],e[1]],this._textItem.anchor="center",!1}createResources(){this._textItem=new H({visible:!0}),this._textItem.text=(0,h.f)(this._text),this._textItem.fontSize=this._fontSize,this._calloutItem=new G({visible:!0,width:2}),this._updateLabelPosition(),this.view.overlay.items.addMany([this._textItem,this._calloutItem]),this._handles.add(this.view.state.watch("camera",(()=>this._updateLabelPosition())))}destroyResources(){this.view.overlay&&!this.view.overlay.destroyed&&this.view.overlay.items.removeMany([this._textItem,this._calloutItem]),this._handles.removeAll()}updateVisibility(e){this._textItem.visible=this._showText&&e,this._calloutItem.visible=this._showCallout&&e}}function Q(e,t,i,r){e.eval(t,Y,X),(0,d.u)(J,Y,X),i.projectToRenderScreen(Y,ne),i.projectToRenderScreen(J,oe),(0,c.o)(r,le,ae),(0,c.g)(r,r)}function Z(e){switch(e){case"top":return"bottom";case"right":return"left";case"bottom":return"top";case"left":return"right"}}const Y=(0,d.n)(),J=(0,d.n)(),X=(0,d.n)(),$=(0,u.s)(),K=(0,u.s)(),ee=(0,u.s)(),te=(0,d.n)(),ie=(0,u.x)(),re=(0,u.i)(),se=(0,u.i)(),ne=(0,u.x)(),ae=ne,oe=(0,u.x)(),le=oe,he={start:0,center:.5,end:1};class ue{constructor(e=(0,d.n)(),t=(0,d.n)()){this.startRenderSpace=e,this.endRenderSpace=t,this.type="euclidean"}eval(e,t,i){return(0,d.y)(t,this.startRenderSpace,this.endRenderSpace,e),i&&((0,d.c)(i,this.endRenderSpace,this.startRenderSpace),(0,d.j)(i,i)),t}createRenderGeometry(e,t){const i=[],r=[],s=(t,s)=>{const n=pe;(0,d.c)(n,t,e),i.push([n[0],n[1],n[2]]),r.push([s[0],s[1],s[2]])},n=t.worldUpAtPosition(this.eval(.5,de),m.c.get());return s(this.startRenderSpace,n),s(this.endRenderSpace,n),{points:i,normals:r}}}class ce{constructor(e,t,i){this.startRenderSpace=e,this.endRenderSpace=t,this.renderSpatialReference=i,this.type="geodesic",this._start=(0,d.n)(),this._end=(0,d.n)(),this._pcpf=(0,r.e)(i),this._project=(0,n.n)(i,this._pcpf),this._projectIn(e,this._start),this._projectIn(t,this._end)}_projectIn(e,t){this._project?(0,n.w)(e,this.renderSpatialReference,t,this._pcpf):(0,d.h)(t,e)}eval(e,t,i){if(this._project)if(i){const r=pe;(0,o.al)(this._start,this._end,e,t,r),(0,d.u)(fe,t,r),(0,n.w)(t,this._pcpf,t,this.renderSpatialReference),(0,n.w)(fe,this._pcpf,fe,this.renderSpatialReference),(0,d.c)(i,fe,t),(0,d.j)(i,i)}else(0,o.L)(this._start,this._end,e,t),(0,n.w)(t,this._pcpf,t,this.renderSpatialReference);else(0,d.y)(t,this._start,this._end,e),i&&((0,d.c)(i,this._end,this._start),(0,d.j)(i,i));return t}createRenderGeometry(e,t){const i=[],r=[],s=(t,s)=>{const n=fe;(0,d.c)(n,t,e),i.push([n[0],n[1],n[2]]),r.push([s[0],s[1],s[2]])};for(let e=0;e<128;++e){const i=e/127,r=de,n=pe;this.eval(i,r),t.worldUpAtPosition(r,n),s(r,n)}return{points:i,normals:r}}}const de=(0,d.n)(),pe=(0,d.n)(),fe=(0,d.n)();function ye(e,t){if((0,d.a)(t,0,0,0),e.length>0){for(let i=0;i<e.length;++i)(0,d.u)(t,t,e[i]);(0,d.d)(t,t,1/e.length)}}function me(e,t,i,r){r.projectToRenderScreen(e,ge),r.projectToRenderScreen(t,xe),(0,c.o)(i,ve,_e),(0,c.g)(i,i)}const ge=(0,u.x)(),_e=ge,xe=(0,u.x)(),ve=xe},13513:(e,t,i)=>{"use strict";i.d(t,{o:()=>o});var r=i(20215),s=i(80219),n=i(5772);const a=s.n.getLogger("esri.views.2d.engine.webgl");function o(e){return(0,n.K)(e.minDataValue)&&(0,n.K)(e.maxDataValue)&&null!=e.minSize&&null!=e.maxSize?n.A.SIZE_MINMAX_VALUE:(e.expression&&"view.scale"===e.expression||e.valueExpression&&"$view.scale"===e.valueExpression)&&Array.isArray(e.stops)?n.A.SIZE_SCALE_STOPS:(null!=e.field||e.expression&&"view.scale"!==e.expression||e.valueExpression&&"$view.scale"!==e.valueExpression)&&(Array.isArray(e.stops)||"levels"in e&&e.levels)?n.A.SIZE_FIELD_STOPS:(null!=e.field||e.expression&&"view.scale"!==e.expression||e.valueExpression&&"$view.scale"!==e.valueExpression)&&null!=e.valueUnit?n.A.SIZE_UNIT_VALUE:(a.error(new r.s("mapview-bad-type","Found invalid size VisualVariable",e)),n.A.NONE)}},25894:(e,t,i)=>{"use strict";i.d(t,{f:()=>u,i:()=>h,l:()=>d,m:()=>g,n:()=>c,r:()=>p}),i(33807);var r=i(80219),s=i(94527),n=i(5772),a=i(43356),o=i(13513);function l(e,t=0,i=!1){const r=e[t+3];return e[t+0]*=r,e[t+1]*=r,e[t+2]*=r,i||(e[t+3]*=255),e}function h(e){if(!e)return 0;const{r:t,g:i,b:r,a:s}=e;return(0,n.w)(t*s,i*s,r*s,255*s)}function u(e){if(!e)return 0;const[t,i,r,s]=e;return(0,n.w)(t*(s/255),i*(s/255),r*(s/255),s)}const c=(e,t)=>e&&((...e)=>t.warn("DEBUG:",...e))||(()=>null),d=!1;function p(e,t){if(!e||!t)return e;switch(t){case"radius":case"distance":return 2*e;case"diameter":case"width":return e;case"area":return Math.sqrt(e)}return e}function f(e){return e.map((e=>function(e){return{value:e.value,size:(0,s.o)(e.size)}}(e)))}function y(e){if("string"==typeof e||"number"==typeof e)return(0,s.o)(e);const t=e;return{type:"size",expression:t.expression,stops:f(t.stops)}}const m=e=>{const t=[],i=[],r=f(e),n=r.length;for(let e=0;e<6;e++){const o=r[Math.min(e,n-1)];t.push(o.value),i.push(null==o.size?a.c:(0,s.u)(o.size))}return{values:new Float32Array(t),sizes:new Float32Array(i)}};function g(e){const t=e&&e.length>0?{}:null,i=t?{}:null;if(!t)return{vvFields:t,vvRanges:i};for(const r of e)if(r.field&&(t[r.type]=r.field),"size"===r.type){i.size||(i.size={});const e=r;switch((0,o.o)(e)){case n.A.SIZE_MINMAX_VALUE:i.size.minMaxValue={minDataValue:e.minDataValue,maxDataValue:e.maxDataValue,minSize:y(e.minSize),maxSize:y(e.maxSize)};break;case n.A.SIZE_SCALE_STOPS:i.size.scaleStops={stops:f(e.stops)};break;case n.A.SIZE_FIELD_STOPS:if(e.levels){const t={};for(const i in e.levels)t[i]=m(e.levels[i]);i.size.fieldStops={type:"level-dependent",levels:t}}else i.size.fieldStops={type:"static",...m(e.stops)};break;case n.A.SIZE_UNIT_VALUE:i.size.unitValue={unit:e.valueUnit,valueRepresentation:e.valueRepresentation}}}else if("color"===r.type)i.color=v(r);else if("opacity"===r.type)i.opacity=_(r);else if("rotation"===r.type){const e=r;i.rotation={type:e.rotationType}}return{vvFields:t,vvRanges:i}}function _(e){const t={values:[0,0,0,0,0,0,0,0],opacities:[0,0,0,0,0,0,0,0]};if("string"==typeof e.field){if(!e.stops)return null;{if(e.stops.length>8)return null;const i=e.stops;for(let e=0;e<8;++e){const r=i[Math.min(e,i.length-1)];t.values[e]=r.value,t.opacities[e]=r.opacity}}}else{if(!(e.stops&&e.stops.length>=0))return null;{const i=e.stops&&e.stops.length>=0&&e.stops[0].opacity;for(let e=0;e<8;e++)t.values[e]=1/0,t.opacities[e]=i}}return t}function x(e,t,i){e[4*t+0]=i.r/255,e[4*t+1]=i.g/255,e[4*t+2]=i.b/255,e[4*t+3]=i.a}function v(e){if((0,r.t)(e))return null;if(e.normalizationField)return null;const t={field:null,values:[0,0,0,0,0,0,0,0],colors:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]};if("string"==typeof e.field){if(!e.stops)return null;{if(e.stops.length>8)return null;t.field=e.field;const i=e.stops;for(let e=0;e<8;++e){const r=i[Math.min(e,i.length-1)];t.values[e]=r.value,x(t.colors,e,r.color)}}}else{if(!(e.stops&&e.stops.length>=0))return null;{const i=e.stops&&e.stops.length>=0&&e.stops[0].color;for(let e=0;e<8;e++)t.values[e]=1/0,x(t.colors,e,i)}}for(let e=0;e<32;e+=4)l(t.colors,e,!0);return t}},79578:(e,t,i)=>{"use strict";i.d(t,{D:()=>b,K:()=>P,W:()=>C,X:()=>M,_:()=>T,v:()=>_});var r=i(81008),s=i(80987),n=i(20215),a=i(80219),o=i(7571),l=i(92858),h=i(16034),u=i(47365),c=i(98548);function d(e,t){for(const i of e)if(null!=i&&t(i))return i}const p=(0,r.t)(/^(?:(\x2D?[0-9]{4,})\x2D([0-9]{2})\x2D([0-9]{2}))(?:T([0-9]{2}):([0-9]{2}):([0-9]{2})(?:\.([0-9]+))?)?(?:(Z)|(?:(\+|\x2D)([0-9]{2}):([0-9]{2})))?$/,{year:1,month:2,day:3,hours:4,minutes:5,seconds:6,ms:7,isUTC:8,offsetSign:9,offsetHours:10,offsetMinutes:11});function f(e,t){for(const i of e.children)if(i.localName in t){const e=t[i.localName];if("function"==typeof e){const t=e(i);t&&f(i,t)}else f(i,e)}}function*y(e,t){for(const i of e.children)if(i.localName in t){const e=t[i.localName];"function"==typeof e?yield e(i):yield*y(i,e)}}const m="xlink:href",g="2.0.0",_="__esri_wfs_id__",x="wfs-layer:feature-type-not-found",v="wfs-layer:unknown-geometry-type";async function b(e,t){const i=function(e){const t=D(e);(function(e){const t=e.firstElementChild.getAttribute("version");if(t&&t!==g)throw new n.s("wfs-layer:unsupported-wfs-version",`Unsupported WFS version ${t}. Supported version: ${g}`)})(t),O(t);const i=t.firstElementChild,r=new Map;return{operations:S(i),get featureTypes(){return Array.from(I(i,r))},readFeatureTypes:()=>I(i,r)}}((await(0,s.L)(e,{responseType:"text",query:{SERVICE:"WFS",REQUEST:"GetCapabilities",VERSION:g,...null==t?void 0:t.customParameters},signal:null==t?void 0:t.signal})).data);return function(e,t){(0,s.B)(e)&&((0,s.E)(e,t.operations.DescribeFeatureType.url,!0)&&(t.operations.DescribeFeatureType.url=(0,s.I)(t.operations.DescribeFeatureType.url)),(0,s.E)(e,t.operations.GetFeature.url,!0)&&(t.operations.GetFeature.url=(0,s.I)(t.operations.GetFeature.url)))}(e,i),i}const w=new Set(["json","application/json","geojson","application/json; subtype=geojson"]);function S(e){let t=!1;const i={GetCapabilities:{url:""},DescribeFeatureType:{url:""},GetFeature:{url:"",outputFormat:null,supportsPagination:!1}};if(f(e,{OperationsMetadata:{Operation:e=>{switch(e.getAttribute("name")){case"GetCapabilities":return{DCP:{HTTP:{Get:e=>{i.GetCapabilities.url=e.getAttribute(m)}}}};case"DescribeFeatureType":return{DCP:{HTTP:{Get:e=>{i.DescribeFeatureType.url=e.getAttribute(m)}}}};case"GetFeature":return{DCP:{HTTP:{Get:e=>{i.GetFeature.url=e.getAttribute(m)}}},Parameter:e=>{if("outputFormat"===e.getAttribute("name"))return{AllowedValues:{Value:e=>{const t=e.textContent;w.has(t.toLowerCase())&&(i.GetFeature.outputFormat=t)}}}}}}},Constraint:e=>{switch(e.getAttribute("name")){case"KVPEncoding":return{DefaultValue:e=>{t="true"===e.textContent.toLowerCase()}};case"ImplementsResultPaging":return{DefaultValue:e=>{i.GetFeature.supportsPagination="true"===e.textContent.toLowerCase()}}}}}}),!t)throw new n.s("wfs-layer:kvp-encoding-not-supported","WFS service doesn't support key/value pair (KVP) encoding");if((0,a.t)(i.GetFeature.outputFormat))throw new n.s("wfs-layer:geojson-not-supported","WFS service doesn't support GeoJSON output format");return i}function I(e,t){return y(e,{FeatureTypeList:{FeatureType:e=>{if(t.has(e))return t.get(e);const i={typeName:"undefined:undefined",name:"",title:"",description:"",extent:null,namespacePrefix:"",namespaceUri:"",supportedSpatialReferences:[]},s=new Set([4326]),n=e=>{var t,i;const n=parseInt(null==(t=e.textContent.match((0,r.t)(/([0-9]+$)/i,{wkid:1})))||null==(i=t.groups)?void 0:i.wkid,10);Number.isNaN(n)||s.add(n)};return f(e,{Name:e=>{const{name:t,prefix:r}=N(e.textContent);i.typeName=`${r}:${t}`,i.name=t,i.namespacePrefix=r,i.namespaceUri=e.lookupNamespaceURI(r)},Abstract:e=>{i.description=e.textContent},Title:e=>{i.title=e.textContent},WGS84BoundingBox:e=>{i.extent=function(e){let t,i,r,s;for(const n of e.children)switch(n.localName){case"LowerCorner":[t,i]=n.textContent.split(" ").map((e=>Number.parseFloat(e)));break;case"UpperCorner":[r,s]=n.textContent.split(" ").map((e=>Number.parseFloat(e)))}return{xmin:t,ymin:i,xmax:r,ymax:s,spatialReference:l.I}}(e)},DefaultSRS:n,DefaultCRS:n,OtherSRS:n,OtherCRS:n}),i.title||(i.title=i.name),i.supportedSpatialReferences.push(...s),t.set(e,i),i}}})}function C(e,t,i){return d(e,(e=>i?e.name===t&&e.namespaceUri===i:e.typeName===t||e.name===t))}async function M(e,t,i,r={}){var s;const{featureType:h,extent:u}=await async function(e,t,i,r={}){const{spatialReference:s=l.k.WGS84}=r,h=e.readFeatureTypes(),u=t?C(h,t,i):h.next().value;if((0,a.t)(u))throw t?new n.s(x,`The type '${t}' could not be found in the service`):new n.s("wfs-layer:empty-service","The service is empty");let d=new c.M({...u.extent,spatialReference:s});if(!(0,l.d)(s,l.I))try{await(0,o.e)(l.I,s,void 0,r),d=(0,o.H)(d,l.I)}catch{throw new n.s("wfs-layer:unsupported-spatial-reference","Projection not supported")}return{extent:d,spatialReference:s,featureType:u}}(e,t,i,r),{fields:d,geometryType:p,swapXY:f,objectIdField:y,geometryField:m}=await async function(e,t,i={}){const[r,s]=await(0,n.A)([F(e.operations.DescribeFeatureType.url,t,i),E(e,t,i)]);if(r.error||s.error)throw new n.s("wfs-layer:getWFSLayerTypeInfo-error",`An error occurred while getting info about the feature type '${t}'`,{error:r.error||s.error});const{fields:o,errors:l}=r.value,h=r.value.geometryType||s.value.geometryType,u=s.value.swapXY;if((0,a.t)(h))throw new n.s(v,`The geometry type could not be determined for type '${t}`,{typeName:t,geometryType:h,fields:o,errors:l});return{...T(o),geometryType:h,swapXY:u}}(e,h.typeName,r);return{url:e.operations.GetCapabilities.url,name:h.name,namespaceUri:h.namespaceUri,fields:d,geometryField:m,geometryType:p,objectIdField:y,spatialReference:null!=(s=r.spatialReference)?s:l.k.WGS84,extent:u,swapXY:f,wfsCapabilities:e,customParameters:r.customParameters}}function T(e){var t;const i=e.find((e=>"geometry"===e.type));let r=e.find((e=>"oid"===e.type));return e=e.filter((e=>"geometry"!==e.type)),r||(r=new u.y({name:_,type:"oid",alias:_}),e.unshift(r)),{geometryField:null!=(t=null==i?void 0:i.name)?t:null,objectIdField:r.name,fields:e}}async function E(e,t,i={}){var r;let n,a=!1;const[o,l]=await Promise.all([P(e.operations.GetFeature.url,t,e.operations.GetFeature.outputFormat,{...i,count:1}),(0,s.L)(e.operations.GetFeature.url,{responseType:"text",query:L(t,void 0,{...i,count:1}),signal:null==i?void 0:i.signal})]),u="FeatureCollection"===o.type&&(null==(r=o.features[0])?void 0:r.geometry);if(u){let e;switch(n=s.i.fromJSON((0,h.r)(u.type)),u.type){case"Point":e=u.coordinates;break;case"LineString":case"MultiPoint":e=u.coordinates[0];break;case"MultiLineString":case"Polygon":e=u.coordinates[0][0];break;case"MultiPolygon":e=u.coordinates[0][0][0]}const t=/<[^>]*pos[^>]*> *(-?\d+(?:\.\d+)?) (-?\d+(?:\.\d+)?)/.exec(l.data);if(t){const i=e[0].toFixed(3),r=e[1].toFixed(3),s=parseFloat(t[1]).toFixed(3);i===parseFloat(t[2]).toFixed(3)&&r===s&&(a=!0)}}return{geometryType:n,swapXY:a}}async function F(e,t,i){return A(t,(await(0,s.L)(e,{responseType:"text",query:{SERVICE:"WFS",REQUEST:"DescribeFeatureType",VERSION:g,TYPENAME:t,...null==i?void 0:i.customParameters},signal:null==i?void 0:i.signal})).data)}function A(e,t){const{name:i}=N(e),r=D(t);O(r);const s=d(y(r.firstElementChild,{element:e=>({name:e.getAttribute("name"),typeName:N(e.getAttribute("type")).name})}),(({name:e})=>e===i));if((0,a.r)(s)){const e=d(y(r.firstElementChild,{complexType:e=>e}),(e=>e.getAttribute("name")===s.typeName));if((0,a.r)(e))return function(e){var t,i;const r=[],s=[];let a;const o=y(e,{complexContent:{extension:{sequence:{element:e=>e}}}});for(const l of o){const o=l.getAttribute("name");if(!o)continue;let h,c;if(l.hasAttribute("type")?h=N(l.getAttribute("type")).name:f(l,{simpleType:{restriction:e=>(h=N(e.getAttribute("base")).name,{maxLength:e=>{c=+e.getAttribute("value")}})}}),!h)continue;const d="true"===l.getAttribute("nillable");let p=!1;switch(h.toLowerCase()){case"integer":case"nonpositiveinteger":case"negativeinteger":case"long":case"int":case"short":case"byte":case"nonnegativeinteger":case"unsignedlong":case"unsignedint":case"unsignedshort":case"unsignedbyte":case"positiveinteger":s.push(new u.y({name:o,alias:o,type:"integer",nullable:d}));break;case"float":case"double":case"decimal":s.push(new u.y({name:o,alias:o,type:"double",nullable:d}));break;case"boolean":case"string":case"gyearmonth":case"gyear":case"gmonthday":case"gday":case"gmonth":case"anyuri":case"qname":case"notation":case"normalizedstring":case"token":case"language":case"idrefs":case"entities":case"nmtoken":case"nmtokens":case"name":case"ncname":case"id":case"idref":case"entity":case"duration":case"time":s.push(new u.y({name:o,alias:o,type:"string",nullable:d,length:null!=(t=c)?t:255}));break;case"datetime":case"date":s.push(new u.y({name:o,alias:o,type:"date",nullable:d,length:null!=(i=c)?i:36}));break;case"pointpropertytype":a="point",p=!0;break;case"multipointpropertytype":a="multipoint",p=!0;break;case"curvepropertytype":case"multicurvepropertytype":case"multilinestringpropertytype":a="polyline",p=!0;break;case"surfacepropertytype":case"multisurfacepropertytype":case"multipolygonpropertytype":a="polygon",p=!0;break;case"geometrypropertytype":case"multigeometrypropertytype":p=!0,r.push(new n.s(v,`geometry type '${h}' is not supported`,{type:(new XMLSerializer).serializeToString(e)}));break;default:r.push(new n.s("wfs-layer:unknown-field-type",`Unknown field type '${h}'`,{type:(new XMLSerializer).serializeToString(e)}))}p&&s.push(new u.y({name:o,alias:o,type:"geometry",nullable:d}))}for(const e of s)if("integer"===e.type&&!e.nullable&&R.has(e.name.toLowerCase())){e.type="oid";break}return{geometryType:a,fields:s,errors:r}}(e)}throw new n.s(x,`Type '${e}' not found in document`,{document:(new XMLSerializer).serializeToString(r)})}const R=new Set(["objectid","fid"]);async function P(e,t,i,r){let{data:a}=await(0,s.L)(e,{responseType:"text",query:L(t,i,r),signal:null==r?void 0:r.signal});a=a.replace(/": +(-?\d+),(\d+)(,)?/g,'": $1.$2$3');try{var o;if(null!=r&&null!=(o=r.dateFields)&&o.length){const e=new Set(r.dateFields);return JSON.parse(a,((t,i)=>e.has(t)?function(e){var t;return null!=(t=function(e){var t,i,r,s;const n=p.exec(e);if(!n)return null;const a=n.groups,o=+a.year,l=+a.month-1,h=+a.day,u=+(null!=(t=a.hours)?t:"0"),c=+(null!=(i=a.minutes)?i:"0"),d=+(null!=(r=a.seconds)?r:"0");if(u>23)return null;if(c>59)return null;if(d>59)return null;const f=null!=(s=a.ms)?s:"0",y=f?+f.padEnd(3,"0").substring(0,3):0;let m;if(a.isUTC)m=Date.UTC(o,l,h,u,c,d,y);else if(a.offsetSign){const e=+a.offsetHours,t=+a.offsetMinutes;m=6e4*("+"===a.offsetSign?-1:1)*(60*e+t)+Date.UTC(o,l,h,u,c,d,y)}else m=new Date(o,l,h,u,c,d,y).getTime();return Number.isNaN(m)?null:m}(e))?t:function(e){const t=new Date(e).getTime();return Number.isNaN(t)?null:t}(e)}(i):i))}return JSON.parse(a)}catch(e){throw new n.s("wfs-layer:malformed-json","Error while parsing the response",{response:a,error:e})}}function L(e,t,i){return{SERVICE:"WFS",REQUEST:"GetFeature",VERSION:g,TYPENAMES:e,OUTPUTFORMAT:t,SRSNAME:"EPSG:4326",STARTINDEX:null==i?void 0:i.startIndex,COUNT:null==i?void 0:i.count,...null==i?void 0:i.customParameters}}function D(e){return(new DOMParser).parseFromString(e.trim(),"text/xml")}function N(e){const[t,i]=e.split(":");return{prefix:i?t:"",name:null!=i?i:t}}function O(e){let t,i;if(f(e.firstElementChild,{Exception:e=>(t=e.getAttribute("exceptionCode"),{ExceptionText:e=>{i=e.textContent}})}),t)throw new n.s(`wfs-layer:${t}`,i)}},87509:()=>{},63956:()=>{}}]);