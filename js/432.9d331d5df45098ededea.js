(self.webpackChunk=self.webpackChunk||[]).push([[432],{50432:(e,t,r)=>{"use strict";r.r(t),r.d(t,{default:()=>k});var i=r(78155),s=r(73574),l=r(40130),n=r(88903),a=r(80219),o=r(20215),u=r(36845),d=(r(67075),r(54622)),y=(r(44844),r(52957)),h=r(18143),p=r(80987),c=r(32769),g=r(62121),f=r(15870),b=r(79679),w=r(32422),v=r(15876),F=r(47122),m=r(86125),E=r(31393),_=r(81578),x=r(50822);r(82906),r(20736),r(4169),r(92858),r(31531),r(29126),r(6585),r(3621),r(63358),r(81135),r(94527),r(17762),r(60816),r(61888),r(29832),r(31516),r(52109),r(98548),r(89710),r(95629),r(9612),r(34396),r(5250),r(49878),r(84271),r(48643),r(30316),r(4618),r(65352),r(80657),r(94449),r(97325),r(3629),r(16040),r(83731),r(79506),r(82361),r(41290),r(26779),r(85289),r(98843),r(52737),r(47365),r(67079),r(98420),r(54223),r(8725),r(51218),r(21793),r(13895),r(91236),r(15576),r(76326),r(28941),r(19438),r(15022),r(56416),r(92758),r(78435),r(53902),r(40481),r(78730),r(2570),r(71666),r(72257),r(41822),r(91790),r(99987),r(51962),r(71409),r(65862),r(71391),r(55688),r(15015),r(4807),r(18559),r(42296),r(17331),r(71394),r(13564),r(95559),r(68631),r(56803),r(2903),r(85570),r(71470),r(80136),r(91507),r(29831),r(11838),r(39068),r(24776),r(95186),r(67726),r(59312),r(93242),r(71542),r(15346),r(7571),r(58404),r(53185),r(63114),r(30665),r(28090),r(37191),r(14754),r(72105),r(62654),r(65311),r(43194),r(60183),r(93875),r(14215),r(20868),r(16063),r(72600),r(334),r(35123),r(58576),r(42413),r(66954),r(38624),r(57424),r(49293),r(26852),r(7552),r(78082),r(37762),r(92722),r(25290),r(27270),r(84796),r(87405),r(84320),r(93450),r(97431),r(32892),r(41374),r(86897),r(41392),r(79949),r(6660),r(6783),r(75200),r(29218),r(30494),r(55807),r(29986),r(26882),r(16408),r(32553),r(60255);const V=(e,t)=>{let r=class extends((0,p.d)((0,c.a)((0,g.r)(p.n.EventedMixin(e))))){constructor(e){super(e),this.sublayer=null,this.parent=null,this.view=null}initialize(){}get suspended(){return!this.canResume()}get updating(){return!this.suspended&&this.isUpdating()}get visible(){return!0===this.get("sublayer.visible")}set visible(e){void 0!==e?this._override("visible",e):this._clearOverride("visible")}get fullOpacity(){const e=e=>null!=e?e:1;return e(this.get("sublayer.opacity"))*e(this.get("parent.fullOpacity"))}canResume(){return!this.get("parent.suspended")&&this.get("view.ready")&&this.visible||!1}isUpdating(){return!1}};return(0,i.e)([(0,n.y)()],r.prototype,"sublayer",void 0),(0,i.e)([(0,n.y)()],r.prototype,"parent",void 0),(0,i.e)([(0,n.y)({readOnly:!0})],r.prototype,"suspended",null),(0,i.e)([(0,n.y)({type:Boolean,readOnly:!0})],r.prototype,"updating",null),(0,i.e)([(0,n.y)()],r.prototype,"view",void 0),(0,i.e)([(0,n.y)()],r.prototype,"visible",null),(0,i.e)([(0,n.y)()],r.prototype,"fullOpacity",null),r=(0,i.e)([(0,n.n)("esri.views.3d.layers.BuildingSublayerView3D")],r),r};function M(e){switch(e.filterMode.type){case"solid":return{mode:0};case"wire-frame":return{mode:1,edgeMaterial:(0,w.w)(e.filterMode.edges,{})};case"x-ray":return{mode:2}}}function S(e,t){if((0,a.t)(t))return e.color[3]=0,e.edgeMaterial=null,void(e.pickable=!1);switch(t.mode){case 0:return;case 1:return e.color[3]=0,e.edgeMaterial=t.edgeMaterial,void(e.pickable=!1);case 2:return e.color[0]=1,e.color[1]=1,e.color[2]=1,e.color[3]*=.15,e.colorMixMode=3,e.castShadows=!1,e.pickable=!1,void(e.edgeMaterial=function(e){return(0,a.t)(e)?null:(C.lastMaterial!==e&&(C.cachedMaterial=function(e){const t=(0,b.t)(e.color);return t[3]*=.075,{...e,color:t}}(e),C.lastMaterial=e),C.cachedMaterial)}(e.edgeMaterial))}}const C={cachedMaterial:null,lastMaterial:null};class I extends i.p{constructor(){super(...arguments),this.sublayer=null}get updating(){return!1}get suspended(){return!1}get availableFields(){return[]}get filter(){return null}set filter(e){throw new Error("Not implemented")}queryFeatures(e,t){throw new Error("Not implemented")}queryObjectIds(e,t){throw new Error("Not implemented")}queryFeatureCount(e,t){throw new Error("Not implemented")}createQuery(){throw new Error("Not implemented")}queryExtent(e,t){throw new Error("Not implemented")}highlight(e){throw new Error("Not implemented")}}(0,i.e)([(0,n.y)()],I.prototype,"sublayer",void 0),(0,i.e)([(0,n.y)()],I.prototype,"availableFields",null),(0,i.e)([(0,n.y)()],I.prototype,"filter",null);const O=a.n.getLogger("esri.views.3d.layers.BuildingComponentSublayerView3D");let L=class extends((0,m.p)((0,f.z)(V(I)))){constructor(){super(...arguments),this.type="building-component-sublayer-3d",this.layerView=null,this._elevationContext="scene",this._isIntegratedMesh=!1,this._supportsLabeling=!1,this.lodFactor=1,this.progressiveLoadFactor=1,this._queryEngine=null}get layerUid(){return this.sublayer.layer.uid}get sublayerUid(){return this.sublayer.uid}initialize(){this.updatingHandles.add(this,"sublayer.renderer,definitionExpressionFields,filterExpressionFields",(()=>this._updateRequiredFields())),this.updatingHandles.add(this.sublayer,"renderer",(e=>this._rendererChange(e)),2);for(const e of["parsedDefinitionExpression","filter","viewFilter.parsedWhereClause","viewFilter.parsedGeometry","viewFilter.sortedObjectIds"])this.updatingHandles.add(this,e,(()=>this._filterChange()));this.updatingHandles.add(this,"parsedFilterExpressions",(()=>this._updateSymbologyOverride()),2),this.addResolvingPromise(this._updateRequiredFields())}get parsedFilterExpressions(){return"Overview"===this.sublayer.modelName?[]:this.layerView.filterExpressions.map((([e,t])=>{let r;try{r=d.WhereClause.create(e,this.sublayer.fieldsIndex)}catch(e){return O.error("Failed to parse filterExpression: "+e),null}if(!r.isStandardized)return O.error("filterExpression is using non standard function"),null;const i=[],s=r.fieldNames;return(0,F.o)(s,this.sublayer.fields,{missingFields:i}),i.length>0?(O.error(`filterExpression references unknown fields: ${i.join(", ")}`),null):[r,t]})).filter((e=>null!=e))}get filter(){return(0,a.r)(this.viewFilter)?this.viewFilter.filter:null}set filter(e){!(0,a.t)(e)&&v.k.checkSupport(e)?(0,a.r)(this.viewFilter)?this.viewFilter.filter=e:this.viewFilter=new v.k({filter:e,layerFieldsIndex:this.sublayer.fieldsIndex,loadAsyncModule:e=>this._loadAsyncModule(e),applyFilters:()=>this._applyFilters(!0),addSqlFilter:(e,t)=>this.addSqlFilter(e,t,this.logError)}):this.viewFilter=null}_updateSymbologyOverride(){const e=this.parsedFilterExpressions;e.length>0?this._setSymbologyOverride(((t,r)=>{for(const[i,s]of e)try{if(i.testFeature(t))return S(r,s)}catch(e){this.logError(e)}return S(r,null)}),this.filterExpressionFields):this._setSymbologyOverride(null,null)}get filterExpressionFields(){return(0,y.p)(this.sublayer.fieldsIndex,this.parsedFilterExpressions.reduce(((e,[t])=>e.concat(t.fieldNames)),[]))}get availableFields(){const e=this.sublayer,t=e.fieldsIndex;let r=this.requiredFields;if(e.outFields||e.layer.outFields){const i=[...e.outFields||[],...e.layer.outFields||[]];r=[...(0,y.I)(t,i),...r]}return(0,y.p)(t,r)}_createLayerGraphic(e){const t=new s.h(null,null,e);return t.layer=this.sublayer.layer,t.sourceLayer=this.sublayer,t}canResume(){return super.canResume()&&(!this._controller||this._controller.rootNodeVisible)}async fetchPopupFeatures(e,t){const r=this._validateFetchPopupFeatures(t);if(r)return Promise.reject(r);if(!(0,a.r)(t)||!t.clientGraphics||0===t.clientGraphics.length)return[];const i=[],s=[],l=(0,a.r)(this.sublayer.associatedLayer)?await this.sublayer.associatedLayer.load():this.sublayer,n=(0,y.I)(this.sublayer.fieldsIndex,await(0,_.t)(l,(0,_.d)(this.sublayer,t))),o=new Set;for(const e of t.clientGraphics)(0,y.r)(n,e,o)?s.push(e):i.push(e);return 0===s.length?Promise.resolve(i):((0,a.r)(this.sublayer.associatedLayer)&&await this.sublayer.associatedLayer.load().catch((()=>O.warn("Failed to load associated feature layer. Displaying popup attributes from cached attributes."))),this.whenGraphicAttributes(s,Array.from(o)).catch((()=>s)).then((e=>i.concat(e))))}async _updateRequiredFields(){const e=(0,y.p)(this.sublayer.fieldsIndex,[...this.sublayer.renderer?await this.sublayer.renderer.getRequiredFields(this.sublayer.fieldsIndex):[],...this.definitionExpressionFields||[],...this.filterExpressionFields||[]]);this._set("requiredFields",e)}_validateFetchPopupFeatures(e){const{sublayer:t}=this,{popupEnabled:r}=t;return r?(0,_.d)(t,e)?void 0:new o.s("buildingscenelayerview3d:fetchPopupFeatures","Layer does not define a popup template",{sublayer:t}):new o.s("buildingscenelayerview3d:fetchPopupFeatures","Popups are disabled",{sublayer:t})}getFilters(){const e=super.getFilters();return this.addSqlFilter(e,this.parsedDefinitionExpression,this.logError),(0,a.r)(this.viewFilter)&&this.viewFilter.addFilters(e,this.view,this._controller.crsIndex,this._collection),e}createQuery(){const e={outFields:["*"],returnGeometry:!1,outSpatialReference:this.view.spatialReference};return(0,a.r)(this.filter)?this.filter.createQuery(e):new h.b(e)}queryExtent(e,t){return this._ensureQueryEngine().executeQueryForExtent(this._ensureQuery(e),null==t?void 0:t.signal)}queryFeatureCount(e,t){return this._ensureQueryEngine().executeQueryForCount(this._ensureQuery(e),null==t?void 0:t.signal)}queryFeatures(e,t){return this._ensureQueryEngine().executeQuery(this._ensureQuery(e),null==t?void 0:t.signal).then((e=>{if(null==e||!e.features)return e;const t=this.sublayer,r=t.layer;for(const i of e.features)i.layer=r,i.sourceLayer=t;return e}))}queryObjectIds(e,t){return this._ensureQueryEngine().executeQueryForIds(this._ensureQuery(e),null==t?void 0:t.signal)}_ensureQueryEngine(){return(0,a.t)(this._queryEngine)&&(this._queryEngine=this._createQueryEngine()),this._queryEngine}_createQueryEngine(){const e=(0,f.u)(this.view.spatialReference,this.view.renderSpatialReference,this._collection);return new v.d({layerView:this,priority:w.p.FEATURE_QUERY_ENGINE,spatialIndex:new v.y({featureAdapter:new v.n({objectIdField:this.sublayer.objectIdField,attributeStorageInfo:this.sublayer.attributeStorageInfo,getFeatureExtent:e}),forAllFeatures:(e,t)=>this._forAllFeatures(((t,r,i)=>e({id:t,index:r,meta:i})),t,2),getFeatureExtent:e,sourceSpatialReference:(0,F.p)(this.sublayer),viewSpatialReference:this.view.spatialReference})})}_ensureQuery(e){return this._addDefinitionExpressionToQuery((0,a.t)(e)?this.createQuery():h.b.from(e))}};(0,i.e)([(0,n.y)({aliasOf:"sublayer"})],L.prototype,"i3slayer",void 0),(0,i.e)([(0,n.y)()],L.prototype,"layerView",void 0),(0,i.e)([(0,n.y)()],L.prototype,"suspended",void 0),(0,i.e)([(0,n.y)({readOnly:!0,aliasOf:"view.qualitySettings.sceneService.3dObject.lodFactor"})],L.prototype,"lodFactor",void 0),(0,i.e)([(0,n.y)({readOnly:!0})],L.prototype,"parsedFilterExpressions",null),(0,i.e)([(0,n.y)({type:E.y})],L.prototype,"filter",null),(0,i.e)([(0,n.y)()],L.prototype,"viewFilter",void 0),(0,i.e)([(0,n.y)({type:[String],readOnly:!0})],L.prototype,"filterExpressionFields",null),(0,i.e)([(0,n.y)({type:[String],readOnly:!0})],L.prototype,"requiredFields",void 0),(0,i.e)([(0,n.y)({type:[String],readOnly:!0})],L.prototype,"availableFields",null),L=(0,i.e)([(0,n.n)("esri.views.3d.layers.BuildingComponentSublayerView3D")],L);var q=L;class Q extends x.d{constructor(){super(...arguments),this.layer=null,this.sublayerViews=null}highlight(e){throw new Error("Not implemented")}}(0,i.e)([(0,n.y)()],Q.prototype,"layer",void 0),(0,i.e)([(0,n.y)()],Q.prototype,"sublayerViews",void 0);const R=a.n.getLogger("esri.views.3d.layers.BuildingSceneLayerView3D"),P=V(i.p);let G=class extends((0,w.m)(Q)){constructor(){super(...arguments),this.type="building-scene-3d",this.sublayerViews=new l.L,this._abortController=(0,o.h)(),this._loadingComponents=0}get filterExpression(){const e=this.layer.activeFilterId,t=null!=e?this.layer.filters.find((t=>t.id===e)):null,r=null!=t?t.filterBlocks.find((e=>"solid"===e.filterMode.type)):null;return r?r.filterExpression:null}get filterExpressions(){const e=this.layer.activeFilterId,t=null!=e?this.layer.filters.find((t=>t.id===e)):null;return t&&t.filterBlocks?t.filterBlocks.toArray().map((e=>[e.filterExpression,M(e)])):[]}get updatingProgressValue(){const e=this.sublayerViews,t=this._loadingComponents+(e?e.length:0);return e.reduce(((e,t)=>e+t.updatingProgress),0)/t}isUpdating(){return this._loadingComponents>0||this.sublayerViews&&this.sublayerViews.some((e=>e.updating))}initialize(){(0,F.d)(this.layer.spatialReference,this.view.spatialReference,this.view.viewingMode),this.initializeSubLayerViews(this.layer.sublayers,this)}destroy(){this.sublayerViews&&(this.sublayerViews.forEach((e=>e.destroy())),this.sublayerViews=null),this._abortController.abort(),this._abortController=null}initializeSubLayerViews(e,t){const r=this,i=this.view;e.forEach((e=>{if(!e.isEmpty)if("building-group"===e.type){const r=new P({sublayer:e,view:i,parent:t});this.initializeSubLayerViews(e.sublayers,r)}else"mesh"===e.geometryType&&(this._loadingComponents++,e.load({signal:this._abortController.signal}).then((()=>{const s=new q({sublayer:e,layerView:r,view:i,parent:t});this.sublayerViews.push(s),this.handles.add([(0,u.d)(s,"updating",(()=>this.notifyChange("updating")),!0),(0,u.d)(s,"updatingProgress",(()=>this.notifyChange("updatingProgressValue")),!0)])})).catch((t=>{(0,o.g)(t)||R.error(`Error while creating view for sublayer ${e.id}\nLayer: ${this.layer.url}\n`,t)})).then((()=>{this._loadingComponents--,this.notifyChange("updating"),this.notifyChange("updatingProgressValue")})))}))}getGraphicFromIntersectorMetadata(e){for(const t of this.sublayerViews.items)if(t.sublayer.uid===e.sublayerUid)return t.getGraphicFromIntersectorMetadata(e);return null}async fetchPopupFeatures(e,t){if(!(0,a.r)(t)||!t.clientGraphics||0===t.clientGraphics.length)return;const r=this._findComponent(t.clientGraphics[0].sourceLayer);return(0,a.t)(r)?void 0:r.fetchPopupFeatures(e,t)}whenGraphicBounds(e){const t=this._findComponent(e.sourceLayer);return(0,a.t)(t)?Promise.reject():t.whenGraphicBounds(e)}_findComponent(e){return this.sublayerViews.find((t=>e===t.sublayer))}highlight(e){e instanceof s.h?e=[e]:e instanceof l.L&&(e=e.toArray());const t=[];if(Array.isArray(e)&&e.length>0&&e[0]instanceof s.h){const r=e,i=new Map;for(const e of r){let t=i.get(e.sourceLayer);null==t&&(t=[],i.set(e.sourceLayer,t)),t.push(e)}this.sublayerViews.forEach((e=>{const r=i.get(e.sublayer);r&&t.push(e.highlight(r))}))}return(0,n.x)(t)}getUsedMemory(){return this.sublayerViews.reduce(((e,t)=>e+t.getUsedMemory()),0)}getUnloadedMemory(){return this.sublayerViews.reduce(((e,t)=>e+t.getUnloadedMemory()),0)}ignoresMemoryFactor(){return!1}};(0,i.e)([(0,n.y)()],G.prototype,"sublayerViews",void 0),(0,i.e)([(0,n.y)({readOnly:!0})],G.prototype,"filterExpression",null),(0,i.e)([(0,n.y)({readOnly:!0})],G.prototype,"filterExpressions",null),(0,i.e)([(0,n.y)(w.z)],G.prototype,"updatingProgress",void 0),(0,i.e)([(0,n.y)({readOnly:!0,dependsOn:[]})],G.prototype,"updatingProgressValue",null),G=(0,i.e)([(0,n.n)("esri.views.3d.layers.BuildingSceneLayerView3D")],G);const k=G}}]);