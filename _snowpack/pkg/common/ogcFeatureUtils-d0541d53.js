import { t as t$1 } from './_rollupPluginBabelHelpers-58331421.js';
import { L } from './Loadable-d16b3d7d.js';
import { s } from './promiseUtils-2ff2b194.js';
import { n, t, q as c, r } from './Message-70b34921.js';
import { k as k$1, d, I as I$2 } from './SpatialReference-843b1520.js';
import { g as g$1 } from './Point-ee7951c3.js';
import { n as ne, e as ee, X } from './featureConversionUtils-3ad98dca.js';
import { e as e$1 } from './OptimizedFeatureSet-be12a9b8.js';
import { I as I$1, T as T$1, k as k$2 } from './geojson-d55288bb.js';
import { u } from './clientSideDefaults-b49b5cc7.js';
import { e } from './FieldsIndex-f71b4f3d.js';
import { i } from './fieldType-6799091f.js';
import g from './FeatureSet-d8329cbc.js';

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
const I=n.getLogger("esri.layers.graphics.sources.ogcfeature");async function T(e$1,n,a={},o=5){const{links:s$1}=e$1,l=$(s$1,"items","application/geo+json")||$(s$1,"http://www.opengis.net/def/rel/ogc/1.0/items","application/geo+json");if(t(l))throw new s("ogc-feature-layer:missing-items-page","Missing items url");const{data:c}=await L(l.href,{signal:a.signal,query:{limit:o,...a.customParameters,token:a.apiKey},headers:{accept:"application/geo+json"}});await I$1(c);const d=T$1(c,{geometryType:n.geometryType}),u$1=n.fields||d.fields||[],p=null!=n.hasZ?n.hasZ:d.hasZ,m=d.geometryType,y=n.objectIdField||d.objectIdFieldName||"OBJECTID";let j=n.timeInfo;const F=u$1.find((e=>e.name===y));if(!F){if(!d.objectIdFieldType)throw new s("ogc-feature-layer:missing-feature-id","Collection geojson require a feature id as a unique identifier");u$1.unshift({name:y,alias:y,type:"esriFieldTypeOID",editable:!1,nullable:!1});}else F.type="esriFieldTypeOID",F.editable=!1,F.nullable=!1;if(y!==d.objectIdFieldName){const e=u$1.find((e=>e.name===d.objectIdFieldName));e&&(e.type="esriFieldTypeInteger");}if(!m)throw new s("ogc-feature-layer:missing-property","geometryType not set and couldn't be inferred from the provided features");u$1===d.fields&&d.unknownFields.length>0&&I.warn({name:"ogc-feature-layer:unknown-field-types",message:"Some fields types couldn't be inferred from the features and were dropped",details:{unknownFields:d.unknownFields}});for(const t of u$1){if(null==t.name&&(t.name=t.alias),null==t.alias&&(t.alias=t.name),"esriFieldTypeOID"!==t.type&&"esriFieldTypeGlobalID"!==t.type&&(t.editable=null==t.editable||!!t.editable,t.nullable=null==t.nullable||!!t.nullable),!t.name)throw new s("ogc-feature-layer:invalid-field-name","field name is missing",{field:t});if(-1===i.jsonValues.indexOf(t.type))throw new s("ogc-feature-layer:invalid-field-type",`invalid type for field "${t.name}"`,{field:t})}if(j){const e$1=new e(u$1);if(j.startTimeField){const t=e$1.get(j.startTimeField);t?(j.startTimeField=t.name,t.type="esriFieldTypeDate"):j.startTimeField=null;}if(j.endTimeField){const t=e$1.get(j.endTimeField);t?(j.endTimeField=t.name,t.type="esriFieldTypeDate"):j.endTimeField=null;}if(j.trackIdField){const t=e$1.get(j.trackIdField);t?j.trackIdField=t.name:(j.trackIdField=null,I.warn({name:"ogc-feature-layer:invalid-timeInfo-trackIdField",message:"trackIdField is missing",details:{timeInfo:j}}));}j.startTimeField||j.endTimeField||(I.warn({name:"ogc-feature-layer:invalid-timeInfo",message:"startTimeField and endTimeField are missing",details:{timeInfo:j}}),j=null);}return {drawingInfo:u(m),geometryType:m,fields:u$1,hasZ:!!p,objectIdField:y,timeInfo:j}}async function k(e,n={}){const{links:a}=e,o=$(a,"data","application/json")||$(a,"http://www.opengis.net/def/rel/ogc/1.0/data","application/json");if(t(o))throw new s("ogc-feature-layer:missing-collections-page","Missing collections url");const{apiKey:s$1,customParameters:l,signal:c}=n,{data:d}=await L(o.href,{signal:c,headers:{accept:"application/json"},query:{...l,token:s$1}});return d}async function S(e,n={}){const{links:a}=e,o=$(a,"conformance","application/json")||$(a,"http://www.opengis.net/def/rel/ogc/1.0/conformance","application/json");if(t(o))throw new s("ogc-feature-layer:missing-conformance-page","Missing conformance url");const{apiKey:s$1,customParameters:l,signal:c}=n,{data:d}=await L(o.href,{signal:c,headers:{accept:"application/json"},query:{...l,token:s$1}});return d}async function x(e,i={}){const{apiKey:n,customParameters:r,signal:a}=i,{data:o}=await L(e,{signal:a,headers:{accept:"application/json"},query:{...r,token:n}});return o}async function v(e,i={}){const n="application/vnd.oai.openapi+json;version=3.0",a=$(e.links,"service-desc",n);if(t(a))return I.warn("ogc-feature-layer:missing-openapi-page","The OGC API-Features server does not have an OpenAPI page."),null;const{apiKey:o,customParameters:s,signal:l}=i,{data:c}=await L(a.href,{signal:l,headers:{accept:n},query:{...s,token:o}});return c}function N(t){const i=t$1(/^http:\/\/www\.opengis.net\/def\/crs\/(.*)\/(.*)\/(.*)$/i,{authority:1,version:2,code:3}).exec(t),n=null==i?void 0:i.groups;if(!n)return null;const{authority:r,code:a}=n;switch(r.toLowerCase()){case"ogc":switch(a.toLowerCase()){case"crs27":return k$1.GCS_NAD_1927;case"crs83":return new k$1({wkid:4269});case"crs84":case"crs84h":return k$1.WGS84;default:return null}case"esri":case"epsg":{const e=Number.parseInt(a,10);return Number.isNaN(e)?null:900913===e?k$1.WebMercator:new k$1({wkid:e})}default:return null}}async function q(e,t,i){const n=await M(e,t,i);return g.fromJSON(n)}async function M(e,t,i){const n=await O(e,t,i);return ne(n)}async function O(e,n,o){const{capabilities:{query:{maxRecordCount:l}},collection:d,layerDefinition:f,queryParameters:{apiKey:g,customParameters:w},spatialReference:h,supportedCrs:b}=e,{links:j}=d,I=$(j,"items","application/geo+json")||$(j,"http://www.opengis.net/def/rel/ogc/1.0/items","application/geo+json");if(t(I))throw new s("ogc-feature-layer:missing-items-page","Missing items url");const{geometry:T,num:k,start:S,timeExtent:x,where:v}=n;if(n.objectIds)throw new s("ogc-feature-layer:query-by-objectids-not-supported","Queries with objectids are not supported");const N=k$1.fromJSON(h),q=c(n.outSpatialReference,N),M=q.isWGS84?null:P(q,b),O=G(T,b),D=C(x),R=W(v),Z=null!=k?k:null!=S&&void 0!==S?10:l,{data:K}=await L(I.href,{...o,query:{...w,...O,crs:M,datetime:D,query:R,limit:Z,startindex:S,token:g},headers:{accept:"application/geo+json"}});let L$1=!1;if(K.links){L$1=!!K.links.find((e=>"next"===e.rel));}!L$1&&Number.isInteger(K.numberMatched)&&Number.isInteger(K.numberReturned)&&(L$1=K.numberReturned<K.numberMatched);const{fields:J,globalIdField:_,hasM:A,hasZ:E,objectIdField:U}=f,B=f.geometryType,z=k$2(K,{geometryType:B,hasZ:E,objectIdField:U});if(!M&&q.isWebMercator)for(const t of z)if(t.geometry){const e=ee(t.geometry,B,E,!1);e.spatialReference=k$1.WGS84,t.geometry=X(g$1(e,q));}for(const t of z)t.objectId=t.attributes[U];const H=M||!M&&q.isWebMercator?q.toJSON():I$2,Q=new e$1;return Q.exceededTransferLimit=L$1,Q.features=z,Q.fields=J,Q.geometryType=B,Q.globalIdFieldName=_,Q.hasM=A,Q.hasZ=E,Q.objectIdFieldName=U,Q.spatialReference=H,Q}function D(e){return r(e)&&"extent"===e.type}function P(e,t){return t.find((t=>{const i=N(t);return d(i,e)}))}function R(e){const{xmin:t,ymin:i,xmax:n,ymax:r}=e;return `${t},${i},${n},${r}`}function C(e){if(t(e))return null;const{start:t$1,end:i}=e;return `${r(t$1)?t$1.toISOString():".."}/${r(i)?i.toISOString():".."}`}function W(e){return t(e)||!e||"1=1"===e?null:e}function G(e,t){if(!D(e))return null;const{spatialReference:i}=e;if(!i||i.isWGS84)return {bbox:R(e)};const n=P(i,t);return n?{bbox:R(e),"bbox-crs":n}:i.isWebMercator?{bbox:R(g$1(e,k$1.WGS84))}:null}function $(e,t,i){return e.find((e=>e.rel===t&&e.type===i))||e.find((e=>e.rel===t&&!e.type))}

export { M, N, O, S, T, k, q, v, x };
