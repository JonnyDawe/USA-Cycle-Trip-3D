import { L } from './Loadable-d16b3d7d.js';
import { a } from './promiseUtils-2ff2b194.js';
import { u } from './SimpleLineSymbol-9959d1ea.js';
import { w as c$1 } from './Message-70b34921.js';
import { d as d$1, y as y$1, f as f$1 } from './jsonUtils-f0a19240.js';
import { s as s$1, k, n, e as e$1, b as r$1, T } from './cimAnalyzer-ea6a3f24.js';
import { o as o$1 } from './Rasterizer-5831480d.js';
import './Color-ae84a22a.js';
import { B as c } from './symbols-9e680ec7.js';
import './subclass-fe5fcf78.js';
import './Polyline-ccd8fb47.js';
import './JSONSupport-9346590f.js';
import './Point-ee7951c3.js';
import './reader-fa0f173d.js';
import './SpatialReference-843b1520.js';
import './jsonMap-e142bd84.js';
import './enumeration-7d0c165d.js';
import './fieldUtils-22be41cd.js';
import './CIMSymbolHelper-6b8d9205.js';
import './mathUtils-a477cc74.js';
import './aaBoundingRect-68336c41.js';
import './callExpressionWithFeature-28066cb0.js';
import './quantizationUtils-28a0adf6.js';
import './opacityUtils-b92214c2.js';
import './persistableUrlUtils-59858a7e.js';
import './Collection-32506e74.js';
import './collectionUtils-a13e45d8.js';
import './Portal-ff63481f.js';
import './intl-21ab9759.js';
import './locale-b874fc68.js';
import './assets-73c8998f.js';

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
function f(e,t,o,a){if("CIMTextSymbol"!==e.type){if(o&&e.effects)for(const o of e.effects)y(o,t);if(e.symbolLayers)for(const o of e.symbolLayers)switch(o.type){case"CIMPictureMarker":case"CIMVectorMarker":m(o,t,a);break;case"CIMPictureStroke":case"CIMSolidStroke":null!=a&&a.preserveOutlineWidth||(o.width*=t);break;case"CIMPictureFill":o.height*=t,o.offsetX*=t,o.offsetY*=t;break;case"CIMHatchFill":f(o.lineSymbol,t,!0,{...a,preserveOutlineWidth:!1}),o.offsetX*=t,o.offsetY*=t,o.separation*=t;}}else e.height*=t;}function m(e,t,o){if(e.markerPlacement&&M$1(e.markerPlacement,t),e.offsetX*=t,e.offsetY*=t,e.anchorPoint&&"Absolute"===e.anchorPointUnits&&(e.anchorPoint={x:e.anchorPoint.x*t,y:e.anchorPoint.y*t}),e.size*=t,"CIMVectorMarker"===e.type&&e.markerGraphics)for(const a of e.markerGraphics)e.scaleSymbolsProportionally||f(a.symbol,t,!0,o);}function M$1(e,t){switch(s$1(e)&&(e.offset*=t),e.type){case"CIMMarkerPlacementAlongLineRandomSize":case"CIMMarkerPlacementAlongLineSameSize":if(e.customEndingOffset*=t,e.offsetAlongLine*=t,e.placementTemplate&&e.placementTemplate.length){const o=e.placementTemplate.map((e=>e*t));e.placementTemplate=o;}break;case"CIMMarkerPlacementAlongLineVariableSize":if(e.maxRandomOffset*=t,e.placementTemplate&&e.placementTemplate.length){const o=e.placementTemplate.map((e=>e*t));e.placementTemplate=o;}break;case"CIMMarkerPlacementOnLine":e.startPointOffset*=t;break;case"CIMMarkerPlacementAtExtremities":e.offsetAlongLine*=t;break;case"CIMMarkerPlacementAtMeasuredUnits":case"CIMMarkerPlacementOnVertices":break;case"CIMMarkerPlacementAtRatioPositions":e.beginPosition*=t,e.endPosition*=t;break;case"CIMMarkerPlacementPolygonCenter":e.offsetX*=t,e.offsetY*=t;break;case"CIMMarkerPlacementInsidePolygon":e.offsetX*=t,e.offsetY*=t,e.stepX*=t,e.stepY*=t;}}function y(e,t){switch(e.type){case"CIMGeometricEffectArrow":case"CIMGeometricEffectDonut":e.width*=t;break;case"CIMGeometricEffectBuffer":e.size*=t;break;case"CIMGeometricEffectCut":e.beginCut*=t,e.endCut*=t,e.middleCut*=t;break;case"CIMGeometricEffectDashes":if(e.customEndingOffset*=t,e.offsetAlongLine*=t,e.dashTemplate&&e.dashTemplate.length){const o=e.dashTemplate.map((e=>e*t));e.dashTemplate=o;}break;case"CIMGeometricEffectExtension":case"CIMGeometricEffectJog":case"CIMGeometricEffectRadial":e.length*=t;break;case"CIMGeometricEffectMove":e.offsetX*=t,e.offsetY*=t;break;case"CIMGeometricEffectOffset":case"CIMGeometricEffectOffsetTangent":e.offset*=t;break;case"CIMGeometricEffectRegularPolygon":e.radius*=t;break;case"CIMGeometricEffectTaperedPolygon":e.fromWidth*=t,e.length*=t,e.toWidth*=t;break;case"CIMGeometricEffectWave":e.amplitude*=t,e.period*=t;}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
function e(t){return `rgb(${t.slice(0,3).toString()})`}function i(t){return `rgba(${t.slice(0,3).toString()},${t[3]})`}class r{constructor(){}rasterizeText(t,r){this._textRasterizationCanvas||(this._textRasterizationCanvas=document.createElement("canvas"));const o=this._textRasterizationCanvas,n=o.getContext("2d");this.setFontProperties(n,r),this.parameters=r,this.textLines=t.split(/\r?\n/),this.lineHeight=this.computeLineHeight();const a=this.computeTextWidth(n,r),h=this.lineHeight*this.textLines.length;o.width=a,o.height=h,this.renderedLineHeight=Math.round(this.lineHeight*r.pixelRatio),this.renderedHaloSize=r.halo.size*r.pixelRatio,this.renderedWidth=a*r.pixelRatio,this.renderedHeight=h*r.pixelRatio,this.fillStyle=i(r.color),this.haloStyle=e(r.halo.color);const l=this.renderedLineHeight,d=this.renderedHaloSize;this.setFontProperties(n,r);const c=s(n.textAlign,this.renderedWidth)+d,g=d;let f=0,p=0;d>0&&this.renderHalo(n,c,g,f,p,r),p+=g,f+=c;for(const e of this.textLines)n.globalCompositeOperation="destination-out",n.fillStyle="rgb(0, 0, 0)",n.fillText(e,f,p),n.globalCompositeOperation="source-over",n.fillStyle=this.fillStyle,n.fillText(e,f,p),p+=l;const u=n.getImageData(0,0,this.renderedWidth,this.renderedHeight),x=new Uint8Array(u.data);if(r.premultiplyColors){let t;for(let e=0;e<x.length;e+=4)t=x[e+3]/255,x[e]=x[e]*t,x[e+1]=x[e+1]*t,x[e+2]=x[e+2]*t;}return {size:[this.renderedWidth,this.renderedHeight],image:new Uint32Array(x.buffer),sdf:!1,simplePattern:!1,anchorX:0,anchorY:0}}renderHalo(t,e,i,r,s,o){const n=this.renderedWidth,a=this.renderedHeight;this._haloRasterizationCanvas||(this._haloRasterizationCanvas=document.createElement("canvas")),this._haloRasterizationCanvas.width=n,this._haloRasterizationCanvas.height=a;const h=this._haloRasterizationCanvas,l=h.getContext("2d");l.clearRect(0,0,n,a),this.setFontProperties(l,o),l.fillStyle=this.haloStyle,l.strokeStyle=this.haloStyle;const d=this.renderedHaloSize<3;l.lineJoin=d?"miter":"round",d?this.renderHaloEmulated(l,e,i):this.renderHaloNative(l,e,i),t.globalAlpha=this.parameters.halo.color[3],t.drawImage(h,0,0,n,a,r,s,n,a),t.globalAlpha=1;}renderHaloEmulated(t,e,i){const r=this.renderedLineHeight,s=this.renderedHaloSize;for(const n of this.textLines){for(const[r,a]of o)t.fillText(n,e+s*r,i+s*a);i+=r;}}renderHaloNative(t,e,i){const r=this.renderedLineHeight,s=this.renderedHaloSize;for(const o of this.textLines){const n=2*s,a=5,h=.1;for(let r=0;r<a;r++){const s=1-(a-1)*h+r*h;t.lineWidth=s*n,t.strokeText(o,e,i);}i+=r;}}setFontProperties(e,i){const r=i.font,s=`${r.style} ${r.weight} ${u(i.size*i.pixelRatio)}px ${r.family}, sans-serif`;let o;switch(e.font=s,e.textBaseline="top",i.horizontalAlignment){case"left":o="left";break;case"right":o="right";break;case"center":o="center";break;default:o="left";}e.textAlign=o;}computeTextWidth(t,e){let i=0;for(const s of this.textLines)i=Math.max(i,t.measureText(s).width);const r=e.font;return ("italic"===r.style||"oblique"===r.style||"string"==typeof r.weight&&("bold"===r.weight||"bolder"===r.weight)||"number"==typeof r.weight&&r.weight>600)&&(i+=.3*t.measureText("A").width),i+=2*this.parameters.halo.size,Math.round(i)}computeLineHeight(){const t=1.275*this.parameters.size;return Math.round(t+2*this.parameters.halo.size)}}function s(t,e){return "center"===t?.5*e:"right"===t?e:0}const o=[];{const t=16;for(let e=0;e<360;e+=360/t)o.push([Math.cos(Math.PI*e/180),Math.sin(Math.PI*e/180)]);}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
var p;!function(e){e.Legend="legend",e.Preview="preview";}(p||(p={}));const d=(e,t,a)=>{if(e&&e.targetSize){let i;if(a){const t=Math.max(a.frame.xmax-a.frame.xmin,a.frame.ymax-a.frame.ymin);i=e.targetSize/u(t);}else i=e.targetSize/t.referenceSize;return i}return e&&e.scaleFactor?e.scaleFactor:1},M={fill:{legend:{frame:{xmax:15,xmin:0,ymax:15,ymin:0},geometry:{rings:[[[0,15],[15,7.5],[15,0],[0,0],[0,15]]]},canvasPaths:{rings:[[[0,15],[0,0],[15,7.5],[15,15],[0,15]]]}},preview:{frame:{xmax:100,xmin:0,ymax:100,ymin:0},geometry:{rings:[[[0,100],[100,100],[100,0],[0,0],[0,100]]]},canvasPaths:{rings:[[[0,100],[0,0],[100,0],[100,100],[0,100]]]}}},stroke:{legend:{frame:{xmax:24,xmin:0,ymax:-2,ymin:2},geometry:{paths:[[[0,0],[12,0],[24,0]]]},canvasPaths:{paths:[[[0,2],[12,2],[24,2]]]}},preview:{frame:{xmax:100,xmin:0,ymax:-2,ymin:2},geometry:{paths:[[[0,0],[50,0],[100,0]]]},canvasPaths:{paths:[[[0,2],[50,2],[100,2]]]}}}};class C{constructor(e,t){this._spatialReference=e,this._avoidSDF=t,this._resourceCache=new Map,this._rasterizer=new o$1,this._textRasterizer=new r,this._pictureMarkerCache=new Map;}async rasterizeCIMSymbolAsync(e,t,r,a,s,o,n,c){a=a||(t?null!=t.centroid?"esriGeometryPolygon":d$1(t.geometry):null)||z(e);const l=await this.analyzeCIMSymbol(e,t?I(t.attributes):null,r,a,c);return this.rasterizeCIMSymbol(l,t,a,s,o,n)}async analyzeCIMSymbol(e,r,a$1,i,s){const o=[],c=r?{geometryType:i,spatialReference:this._spatialReference,fields:r}:null;let l;await k(e.data,c,o,this._avoidSDF),a(s);for(const t of o)"CIMPictureMarker"!==t.cim.type&&"CIMPictureFill"!==t.cim.type&&"CIMPictureStroke"!==t.cim.type||(l||(l=[]),l.push(this.fetchPictureMarkerResource(t,s))),a$1&&"text"===t.type&&"string"==typeof t.text&&t.text.indexOf("[")>-1&&(t.text=n(a$1,t.text,t.cim.textCase));return l&&await Promise.all(l),o}async fetchPictureMarkerResource(t,r){const a=t.materialHash;if(!this._pictureMarkerCache.get(a)){const i=(await L(t.cim.url,{responseType:"image",signal:r&&r.signal})).data;this._pictureMarkerCache.set(a,i);}}rasterizeCIMSymbol(e,t,r,a,i,s){const o=[];for(const n of e){a&&"function"==typeof a.scaleFactor&&(a.scaleFactor=a.scaleFactor(t,i,s));const e=this._getRasterizedResource(n,t,r,a,i,s);if(!e)continue;let c=0,l=e.anchorX||0,m=e.anchorY||0,h=!1,g=0,y=0;if("esriGeometryPoint"===r){const e=d(a,n,null);if(g=e$1(n.offsetX,t,i,s)*e||0,y=e$1(n.offsetY,t,i,s)*e||0,"marker"===n.type)c=e$1(n.rotation,t,i,s)||0,h=!!n.rotateClockwise&&n.rotateClockwise;else if("text"===n.type){if(c=e$1(n.angle,t,i,s)||0,void 0!==n.horizontalAlignment)switch(n.horizontalAlignment){case"left":l=-.5;break;case"right":l=.5;break;default:l=0;}if(void 0!==n.verticalAlignment)switch(n.verticalAlignment){case"top":m=.5;break;case"bottom":m=-.5;break;case"baseline":m=-.25;break;default:m=0;}}}null!=e&&o.push({angle:c,rotateClockWise:h,anchorX:l,anchorY:m,offsetX:g,offsetY:y,rasterizedResource:e});}return this.getSymbolImage(o)}getSymbolImage(e){const t=document.createElement("canvas"),a=t.getContext("2d");let i=0,s=0,o=0,n=0;const c$1=[];for(let f=0;f<e.length;f++){const t=e[f],l=t.rasterizedResource;if(!l)continue;const m=l.size,h=t.offsetX,g=t.offsetY,y=t.anchorX,u$1=t.anchorY,p=t.rotateClockWise||!1;let d=t.angle,M=u(h)-m[0]*(.5+y),C=u(g)-m[1]*(.5+u$1),I=M+m[0],z=C+m[1];if(d){p&&(d=-d);const e=Math.sin(d*Math.PI/180),t=Math.cos(d*Math.PI/180),r=M*t-C*e,a=M*e+C*t,i=M*t-z*e,s=M*e+z*t,o=I*t-z*e,n=I*e+z*t,c=I*t-C*e,l=I*e+C*t;M=Math.min(r,i,o,c),C=Math.min(a,s,n,l),I=Math.max(r,i,o,c),z=Math.max(a,s,n,l);}i=M<i?M:i,s=C<s?C:s,o=I>o?I:o,n=z>n?z:n;const P=a.createImageData(l.size[0],l.size[1]);P.data.set(new Uint8ClampedArray(l.image.buffer));const x={offsetX:h,offsetY:g,rotateClockwise:p,angle:d,rasterizedImage:P,anchorX:y,anchorY:u$1};c$1.push(x);}t.width=o-i,t.height=n-s;const l=-i,m=n;for(let f=0;f<c$1.length;f++){const e=c$1[f],t=this._imageDataToCanvas(e.rasterizedImage),i=e.rasterizedImage.width,s=e.rasterizedImage.height,o=l-i*(.5+e.anchorX),n=m-s*(.5-e.anchorY);if(e.angle){const i=(360-e.angle)*Math.PI/180;a.save(),a.translate(u(e.offsetX),-u(e.offsetY)),a.translate(l,m),a.rotate(i),a.translate(-l,-m),a.drawImage(t,o,n),a.restore();}else a.drawImage(t,o+u(e.offsetX),n-u(e.offsetY));}const h=new c({x:l/t.width-.5,y:m/t.height-.5});return {imageData:0!==t.width&&0!==t.height?a.getImageData(0,0,t.width,t.height):a.createImageData(1,1),anchorPosition:h}}_imageDataToCanvas(e){this._imageDataCanvas||(this._imageDataCanvas=document.createElement("canvas"));const t=this._imageDataCanvas,r=t.getContext("2d");return t.width=e.width,t.height=e.height,r.putImageData(e,0,0),t}_imageTo32Array(e,t,r){this._imageDataCanvas||(this._imageDataCanvas=document.createElement("canvas"));const a=this._imageDataCanvas,i=a.getContext("2d");return a.width=t,a.height=r,i.drawImage(e,0,0,t,r),new Uint32Array(i.getImageData(0,0,t,r).data.buffer)}_getRasterizedResource(e,t,r,i,s,o){let n,c,l,m$1;if("esriGeometryPolyline"===r||"esriGeometryPolygon"===r){const m=i&&i.style?i.style:p.Legend,h="esriGeometryPolyline"===r?M.stroke[m]:M.fill[m];if("line"===e.type){if("CIMSolidStroke"!==e.cim.type){if("CIMPictureStroke"===e.cim.type){const r=e$1(e.width,t,s,o),{image:a,width:i,height:n}=this._getPictureResource(e,r);return this._rasterizePictureResource(e,a,i,n,h,r)}return null}({analyzedCIM:n,hash:l}=P(e,t,s,o)),c=this._embedCIMLayerInVectorMarker(n,h);}else if("marker"===e.type){if("CIMPictureMarker"===e.cim.type)return null;if("CIMVectorMarker"!==e.cim.type)return null;e.cim.offsetX=e$1(e.offsetX,t,s,o),e.cim.offsetY=e$1(e.offsetY,t,s,o),e.cim.rotation=e$1(e.rotation,t,s,o),e.cim.markerPlacement=e.markerPlacement,({analyzedCIM:n}=P(e,t,s,o)),l=c$1(JSON.stringify(n)).toString(),c=this._embedCIMLayerInVectorMarker(n,h);}else {if("text"===e.type)return null;if("fill"===e.type){if("CIMHatchFill"===e.cim.type||"CIMVectorMarker"===e.cim.type||"CIMPictureMarker"===e.cim.type||"CIMPictureFill"===e.cim.type){const r=e.cim.size||e.cim.height;let a,i,c;if("CIMPictureMarker"===e.cim.type||"CIMPictureFill"===e.cim.type)({image:a,width:i,height:c}=this._getPictureResource(e,r));else {({analyzedCIM:n,hash:l}=P(e,t,s,o));const r=this._rasterizer.rasterizeJSONResource(n,1,this._avoidSDF);a=r.image,i=r.size[0],c=r.size[1];}return this._rasterizePictureResource(e,a,i,c,h,null)}if("CIMSolidFill"!==e.cim.type)return null;({analyzedCIM:n,hash:l}=P(e,t,s,o)),c=this._embedCIMLayerInVectorMarker(n,h);}}}else {if("text"===e.type)return m$1=this._rasterizeTextResource(e,t,i,s,o),m$1;({analyzedCIM:n,hash:l}=P(e,t,s,o));const r=d(i,e,null);if("CIMPictureMarker"===e.cim.type){const a=e$1(e.size,t,s,o)*r,{image:i,width:n,height:c}=this._getPictureResource(e,a);return m$1={image:i,size:[n,c],sdf:!1,simplePattern:!1,anchorX:e.anchorPoint?e.anchorPoint.x:0,anchorY:e.anchorPoint?e.anchorPoint.y:0},m$1}m(n,r,{preserveOutlineWidth:!1}),c=n;}l+=r,i&&(l+=JSON.stringify(i));const h=this._resourceCache;return h.has(l)?h.get(l):(m$1=this._rasterizer.rasterizeJSONResource(c,window.devicePixelRatio||1,this._avoidSDF),h.set(l,m$1),m$1)}_rasterizeTextResource(e,t,r,a,i){const s=d(r,e,null),o=e$1(e.text,t,a,i);if(!o||0===o.length)return null;const n=e$1(e.fontName,t,a,i),c=e$1(e.style,t,a,i),l=e$1(e.weight,t,a,i),m=e$1(e.decoration,t,a,i),h=e$1(e.size,t,a,i)*s,y=e$1(e.horizontalAlignment,t,a,i),u=e$1(e.verticalAlignment,t,a,i),p=r$1(e$1(e.color,t,a,i)),M=r$1(e$1(e.outlineColor,t,a,i)),C={color:p,size:h,horizontalAlignment:y,verticalAlignment:u,font:{family:n,style:c,weight:l,decoration:m},halo:{size:e$1(e.outlineSize,t,a,i)||0,color:M,style:c},pixelRatio:1,premultiplyColors:!this._avoidSDF};return this._textRasterizer.rasterizeText(o,C)}_rasterizePictureResource(e,t,a,i,n,c){const l=document.createElement("canvas"),m=l.getContext("2d");l.height=u(Math.max(Math.abs(n.frame.ymax-n.frame.ymin),c)),l.width=u(Math.abs(n.frame.xmax-n.frame.xmin));const h=m.createImageData(a,i);h.data.set(new Uint8ClampedArray(t.buffer));const f=this._imageDataToCanvas(h),g=m.createPattern(f,"repeat"),y=Math.cos((-e.cim.rotation||0)*Math.PI/180),u$1=Math.sin((-e.cim.rotation||0)*Math.PI/180);g.setTransform({m11:y,m12:u$1,m21:-u$1,m22:y,m41:u(e.cim.offsetX)||0,m42:u(e.cim.offsetY)||0});const p=n.canvasPaths;let d,M,C;y$1(p)?(d=p.rings,m.fillStyle=g,M=m.fill,C=["evenodd"]):f$1(p)&&(d=p.paths,m.strokeStyle=g,m.lineWidth=c,M=m.stroke,d[0][0][1]=l.height/2,d[0][1][1]=l.height/2),m.beginPath();for(const s of d){const e=s?s.length:0;if(e>1){let t=s[0];m.moveTo(u(t[0]),u(t[1]));for(let a=1;a<e;++a)t=s[a],m.lineTo(u(t[0]),u(t[1]));m.closePath();}}M.apply(m,C);const I=m.getImageData(0,0,l.width,l.height),z=new Uint8Array(I.data);return {size:[l.width,l.height],image:new Uint32Array(z.buffer),sdf:!1,simplePattern:!1,anchorX:0,anchorY:0}}_getPictureResource(e,t){const a=this._pictureMarkerCache.get(e.materialHash);if(!a)return null;const i=a.height/a.width,s=t?i>1?u(t):u(t)/i:a.width,o=t?i>1?u(t)*i:u(t):a.height;return {image:this._imageTo32Array(a,s,o),width:s,height:o}}_embedCIMLayerInVectorMarker(e,t){const r=y$1(t.geometry)?"CIMPolygonSymbol":"CIMLineSymbol";return {type:"CIMVectorMarker",frame:t.frame,markerGraphics:[{type:"CIMMarkerGraphic",geometry:t.geometry,symbol:{type:r,symbolLayers:[e]}}]}}}function I(e){return (e?Object.keys(e):[]).map((t=>({name:t,alias:t,type:"string"==typeof e[t]?"esriFieldTypeString":"esriFieldTypeDouble"})))}function z(e){if(!(e&&e.data&&e.data.symbol))return null;switch(e.data.symbol.type){case"CIMPointSymbol":case"CIMTextSymbol":return "esriGeometryPoint";case"CIMLineSymbol":return "esriGeometryPolyline";case"CIMPolygonSymbol":return "esriGeometryPolygon";default:return null}}function P(e,t,r,a){let i,s;if("function"==typeof e.materialHash){i=(0, e.materialHash)(t,r,a),s=T(e.cim,e.materialOverrides);}else i=e.materialHash,s=e.cim;return {analyzedCIM:s,hash:i}}

export { C as CIMSymbolRasterizer, p as GeometryStyle };
