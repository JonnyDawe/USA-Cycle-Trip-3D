import { e, p as p$1, N as l } from './JSONSupport-9346590f.js';
import { t as t$1, r as r$1, B as a$1, a as s$1, G as n$4, k as l$1, x as o$1, q as c$1, v as v$1 } from './Message-70b34921.js';
import { y as y$1, n, x as r$2, A as n$3 } from './subclass-fe5fcf78.js';
import { y as y$2, p as p$2, u as u$1, a8 as n$2, m as p$3 } from './SceneView-f849f26b.js';
import './Loadable-d16b3d7d.js';
import { u } from './Handles-af859b7b.js';
import { G, y as y$3 } from './promiseUtils-2ff2b194.js';
import { n as n$1, h as r, c, j, d, u as u$2, S, J, M as e$1 } from './mathUtils-a477cc74.js';
import { x as a, A as j$1 } from './objectResourceUtils-59d1d140.js';
import { b } from './Point-ee7951c3.js';
import { L } from './Collection-32506e74.js';
import { o } from './Color-ae84a22a.js';
import { e as e$2 } from './vec33-d394808f.js';
import { m as m$1 } from './LineVisualElement-5e33774f.js';
import { d as d$1 } from './LayerView-0b9de845.js';
import './DefaultUI-99d89841.js';
import './watchUtils-06a91cc9.js';
import './Map-566c621c.js';
import './Basemap-ad33b4b0.js';
import './collectionUtils-a13e45d8.js';
import './loadAll-37e49bde.js';
import './asyncUtils-015dfd6e.js';
import './SpatialReference-843b1520.js';
import './Portal-ff63481f.js';
import './intl-21ab9759.js';
import './jsonMap-e142bd84.js';
import './locale-b874fc68.js';
import './assets-73c8998f.js';
import './reader-fa0f173d.js';
import './Polyline-ccd8fb47.js';
import './PortalItem-4692b2a9.js';
import './writeUtils-7e5aaca1.js';
import './compilerUtils-7bbb76dc.js';
import './enumeration-7d0c165d.js';
import './opacityUtils-b92214c2.js';
import './CollectionFlattener-af542a66.js';
import './HandleOwner-fbf91095.js';
import './basemapUtils-9ae6960d.js';
import './TablesMixin-751fb22e.js';
import './Layer-aafbe66d.js';
import './Identifiable-3ad643f8.js';
import './TimeExtent-02acfb1c.js';
import './PopupTemplate-d97f5e88.js';
import './fieldUtils-22be41cd.js';
import './HeightModelInfo-992659fb.js';
import './unitUtils-b17203be.js';
import './GraphicsCollection-60679841.js';
import './Graphic-bb07b7e4.js';
import './symbols-9e680ec7.js';
import './SimpleLineSymbol-9959d1ea.js';
import './persistableUrlUtils-59858a7e.js';
import './uid-6beaca4c.js';
import './jsonUtils-f0a19240.js';
import './Queue-a5bdb7c1.js';
import './widget-734a78a2.js';
import './uuid-630c0c55.js';
import './QueryTask-55cf149f.js';
import './Query-619f76b0.js';
import './Field-728fb193.js';
import './fieldType-6799091f.js';
import './Task-41e0c8b8.js';
import './query-de9ba206.js';
import './normalizeUtils-5edbbb73.js';
import './pbfQueryUtils-9ef2116f.js';
import './pbf-9fd5cf83.js';
import './OptimizedFeature-ccef5b1d.js';
import './OptimizedFeatureSet-be12a9b8.js';
import './queryZScale-688c1e0e.js';
import './zscale-9df5d655.js';
import './TopFeaturesQuery-b22907ac.js';
import './FeatureSet-d8329cbc.js';
import './featureConversionUtils-3ad98dca.js';
import './FeatureLayer-a1f2dd15.js';
import './UniqueValueRenderer-260b50e9.js';
import './jsonUtils-4c6963ee.js';
import './ColorStop-ed1033bb.js';
import './diffUtils-530d997b.js';
import './sizeVariableUtils-6d1564c8.js';
import './visualVariableUtils-86a9e524.js';
import './lengthUtils-824a0190.js';
import './styleUtils-8b593a34.js';
import './jsonUtils-cb46c967.js';
import './LRUCache-eed24cc2.js';
import './MemCache-b33cfc4b.js';
import './MultiOriginJSONSupport-859401da.js';
import './workers-bd1ea274.js';
import './APIKeyMixin-7fe44a14.js';
import './ArcGISService-32a080a6.js';
import './arcgisLayerUrl-cb5a8728.js';
import './BlendLayer-b9fc1ffb.js';
import './CustomParametersMixin-79fc7530.js';
import './OperationalLayer-a01538e1.js';
import './PortalLayer-722467e6.js';
import './RefreshableLayer-a609d261.js';
import './ScaleRangeLayer-9b1bf210.js';
import './TemporalLayer-f1ac30a1.js';
import './TimeInfo-ba3374ff.js';
import './labelingInfo-c6f27ee6.js';
import './LabelClass-e4354cdb.js';
import './labelUtils-7d1afc11.js';
import './defaults-31c9613a.js';
import './defaultsJSON-0467bd38.js';
import './featureReductionUtils-78800e19.js';
import './FeatureType-97537d09.js';
import './fieldProperties-4363f1e0.js';
import './FieldsIndex-f71b4f3d.js';
import './styleUtils-58b9b121.js';
import './popupUtils-5b007a8e.js';
import './utils-4028018e.js';
import './ItemCache-2457b327.js';
import './vec2f32-556b449a.js';
import './mat3-6cb40036.js';
import './vec2-513a0296.js';
import './vec2f64-3fb878b3.js';
import './capabilities-39806eb7.js';
import './projection-c73dd3c4.js';
import './mat4-8eb66d33.js';
import './aaBoundingRect-68336c41.js';
import './DefaultMaterial_COLOR_GAMMA-7c4a23ef.js';
import './types-fe598891.js';
import './Version-271d30d5.js';
import './quat-44770d30.js';
import './vec4-8546ad05.js';
import './BufferView-3733efba.js';
import './scaleUtils-10613b70.js';
import './ElevationSampler-c8359e31.js';
import './TileInfo-c32d8db8.js';
import './testSVGPremultipliedAlpha-b5c775e7.js';
import './FramebufferObject-238df962.js';
import './Texture-454f8135.js';
import './EdgeProcessingWorker-56aa1068.js';
import './deduplicate-b910185f.js';
import './InterleavedLayout-b66a6862.js';
import './vec3f32-97630458.js';
import './resources-8aaa4737.js';
import './PromiseQueue-edaf4a34.js';
import './dehydratedFeatures-f49828b8.js';
import './byteSizeEstimations-5b7ab251.js';
import './aaBoundingBox-c0155c39.js';
import './quantizationUtils-28a0adf6.js';
import './labelFormatUtils-d93dcf3e.js';
import './earcut-d81146f9.js';
import './MeshComponent-13ddf9e0.js';
import './screenshotUtils-abc7263a.js';
import './callExpressionWithFeature-28066cb0.js';
import './projection-7d8c2528.js';
import './symbolLayerUtils3D-8a618a44.js';
import './rasterUtils-8b815ad2.js';
import './geometryServiceUtils-83e1d118.js';
import './ProjectParameters-0d0884dd.js';
import './VectorTile-a034e4bb.js';
import './config-b1f55e66.js';
import './TiledDisplayObject-38ffcb88.js';
import './DisplayObject-8d4c95bb.js';
import './TileKey-86c6b8c5.js';
import './LercDecoder-00822609.js';
import './quatf32-b1c8b796.js';
import './mat4f32-5ff6470f.js';

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
let i=class extends p$1{constructor(t){super(t),this.inputPoints={isValid:!1,observer:n$1(),target:n$1(),observerAdjusted:n$1(),targetAdjusted:n$1()},this.computationResult={start:n$1(),end:n$1(),intersection:n$1(),isValid:!1,isTargetVisible:!1},this.result=null;}updateComputationResults(){this.notifyChange("computationResult");}updateInputPoints(){this.notifyChange("inputPoints");}};e([y$1()],i.prototype,"target",void 0),e([y$1()],i.prototype,"inputPoints",void 0),e([y$1()],i.prototype,"computationResult",void 0),e([y$1()],i.prototype,"result",void 0),i=e([n("esri.views.3d.layers.analysis.LineOfSight.LineOfSightAnalysis")],i);

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
let t=class extends p$1{constructor(o){super(o);}};e([y$1()],t.prototype,"target",void 0),e([y$1()],t.prototype,"intersectedGraphic",void 0),e([y$1()],t.prototype,"intersectedLocation",void 0),e([y$1()],t.prototype,"visible",void 0),t=e([n("esri.views.3d.layers.analysis.LineOfSight.LineOfSightResult")],t);

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
let V$1=class extends p$1{constructor(e){super(e),this._tasks=y$2,this._handles=new u,this._analysisHandles=new u;}initialize(){var e;const t=null==(e=this.view.resourceController)?void 0:e.scheduler;t&&(this._tasks=t.registerTask(p$2.LINE_OF_SIGHT_TOOL));this._handles.add([l((()=>this.layer.observer),(e=>this._onObserverChange(e))),this._connectAnalyses(),this._connectTargets()]),this._intersector=new u$1(this.view.state.viewingMode),this._intersector.options.hud=!1,this._intersector.options.store=0;}destroy(){this._handles.destroy(),this._analysisHandles.destroy(),this._analyses.removeAll();}get updating(){return this._tasks.updating}get priority(){return this._tasks.priority}set priority(e){this._tasks.priority=e;}get _analyses(){return this.layerViewData.analyses}get _observerEngineLocation(){return this.layerViewData.observerEngineLocation}set _observerEngineLocation(e){this.layerViewData.observerEngineLocation=e;}get _screenPixelSize(){return this.view.state.camera.computeScreenPixelSizeAt(this._observerEngineLocation)}getLineOfSightComputationDependencies(e){const{inputPoints:t}=e;return {inputPoints:t}}computeAnalysis(e,t=!1){const{analysis:s}=e,{inputPoints:n,computationResult:r$1}=s,{observerAdjusted:i,targetAdjusted:o}=n,{start:a,end:l}=r$1;r(a,i),r(l,o);t||this._canComputeAnalysis(s)?this._computeAnalysisIntersection(e):this._interpolateAnalysisIntersection(e),s.updateComputationResults();}_adjustStartEndPositions(e){const t=this._screenPixelSize,s=this.view,{inputPoints:n}=e,{observer:r,target:i,observerAdjusted:o,targetAdjusted:a}=n,l=R;c(l,i,r);const c$1=t;j(l,l),d(l,l,Math.min(c$1,1)),u$2(o,r,l),c(l,r,i);const p=s.state.camera.computeScreenPixelSizeAt(i);j(l,l),d(l,l,Math.min(p,1)),u$2(a,i,l);}_computeAnalysisIntersection({analysis:e,interpolationInfo:t$2}){const{view:s}=this,{sceneIntersectionHelper:n,renderCoordsHelper:r$1}=s;if(t$1(n))return;const o=this._intersector,{computationResult:a,inputPoints:l}=e,{observer:c,target:p}=l,{start:h,end:u}=a,g=j$1(h,u,H);n.intersectToolIntersectorRay(g,o);const d=a.intersection,_=R,m=!!o.results.min&&o.results.min.getIntersectionPoint(d);let v=!0;if(m){r(t$2.originalIntersection,d),r(t$2.originalObserver,h),r(t$2.originalTarget,u),r$1.fromRenderCoords(d,_,s.spatialReference);const e=1-S(u,p)/S(h,p);v=S(c,d)>=e*S(c,p);}const f=new b(_,s.spatialReference);e.result=new t({target:e.target,intersectedGraphic:v?null:n$2(o.results.min,s),intersectedLocation:v?null:f,visible:!!m&&v}),a.isValid=l.isValid=!0,a.isTargetVisible=v;}_interpolateAnalysisIntersection({analysis:e,interpolationInfo:t}){const{computationResult:s,inputPoints:n}=e,{start:r$1,end:i,intersection:o}=s,{originalIntersection:a,originalObserver:l,originalTarget:c}=t;if(r(o,a),n.isValid){const e=R,t=S(l,a)/S(l,c);J(e,r$1,l),d(e,e,1-t),u$2(o,o,e),J(e,i,c),d(e,e,t),u$2(o,o,e),s.isValid=!0;}else e.result=null,s.isValid=!1,s.isTargetVisible=!1;}_canComputeAnalysis(e){const t=this.layer.observer,s=this.view.frustum;if(t$1(t)||t$1(e.target)||t$1(s))return !1;const{observerAdjusted:n,targetAdjusted:r}=e.inputPoints,o=s.intersectsPoint(n),a=s.intersectsPoint(r);return o&&a}_onObserverChange(e){if(t$1(e))return void this.layer.targets.removeAll();const t=n$1();this.view.renderCoordsHelper.toRenderCoords(e,t),this._observerEngineLocation=t,this.priority=p$2.LINE_OF_SIGHT_TOOL_INTERACTIVE;}_onObserverChangeForAnalysis(e){e.inputPoints.isValid=!1;}_onObserverEngineForAnalysis(e,t){const{inputPoints:s}=e;r(s.observer,t),this._adjustStartEndPositions(e),e.updateInputPoints(),this.priority=p$2.LINE_OF_SIGHT_TOOL_INTERACTIVE;}_onTargetLocationChange(e,t){const{inputPoints:s}=e;s.isValid=!1,this.view.renderCoordsHelper.toRenderCoords(t,s.target),this._adjustStartEndPositions(e),e.updateInputPoints(),this.priority=p$2.LINE_OF_SIGHT_TOOL_INTERACTIVE;}_connectAnalysisToTarget(e){return l((()=>({analysis:e,target:e.target})),(({analysis:e,target:t})=>{r$1(t)&&this._onTargetLocationChange(e,t);}))}_connectAnalysisToObserver(e){return l((()=>({analysis:e,observer:this.layer.observer})),(({analysis:e})=>{this._onObserverChangeForAnalysis(e);}))}_connectAnalysisToObserverEngine(e){return l((()=>({analysis:e,observer:this._observerEngineLocation})),(({analysis:e,observer:t})=>{this._onObserverEngineForAnalysis(e,t);}))}_connectAnalysisForCompute(e){let t=n$4;const s={analysis:e,interpolationInfo:{originalIntersection:n$1(),originalObserver:n$1(),originalTarget:n$1()}};return r$2([l((()=>this.getLineOfSightComputationDependencies(e)),(()=>{t=a$1(t),t=G((async e=>{await y$3(this._tasks.schedule((()=>this.computeAnalysis(s)),e));}));})),n$3((()=>t=a$1(t)))])}_connectAnalysis(e){const t=this._analysisHandles;t.has(e)||t.add([this._connectAnalysisToTarget(e),this._connectAnalysisToObserver(e),this._connectAnalysisToObserverEngine(e),this._connectAnalysisForCompute(e)]);}_disconnectAnalysis(e){this._analysisHandles.remove(e);}_onAnalysesCollectionChange(e){e.added.forEach((e=>this._connectAnalysis(e))),e.removed.forEach((e=>this._disconnectAnalysis(e)));}_onTargetsChange(e){return this._analyses.removeAll(),e.items.length>0&&e.forEach((e=>this._addTarget(e))),e.on("change",(e=>this._onTargetCollectionChange(e)))}_onTargetCollectionChange(e){e.added.forEach((e=>this._addTarget(e))),e.removed.forEach((e=>this._removeTarget(e)));}_addTarget(e){const t=this._analyses;t.some((t=>t.target===e))||t.add(new i({target:e}));}_removeTarget(e){const t=this._analyses,s=t.find((t=>t.target===e));t.remove(s);}_connectAnalyses(){let e=null;return r$2([l((()=>this._analyses),(t=>{e=s$1(e),e=t.on("change",(e=>this._onAnalysesCollectionChange(e))),t.forEach((e=>this._connectAnalysis(e)));})),n$3((()=>e=s$1(e)))])}_connectTargets(){let e=null;return r$2([l((()=>this.layer.targets),(t=>{e=s$1(e),e=this._onTargetsChange(t);})),n$3((()=>e=s$1(e)))])}};e([y$1({constructOnly:!0})],V$1.prototype,"layer",void 0),e([y$1({constructOnly:!0})],V$1.prototype,"layerViewData",void 0),e([y$1({constructOnly:!0})],V$1.prototype,"view",void 0),e([y$1()],V$1.prototype,"updating",null),e([y$1()],V$1.prototype,"priority",null),e([y$1()],V$1.prototype,"_analyses",null),e([y$1()],V$1.prototype,"_observerEngineLocation",null),e([y$1()],V$1.prototype,"_screenPixelSize",null),e([y$1()],V$1.prototype,"_tasks",void 0),V$1=e([n("esri.views.3d.layers.analysis.LineOfSight.LineOfSightController")],V$1);const R=n$1(),H=a();

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
let s=class extends p$1{constructor(o$1){super(o$1),this.innerWidth=2,this.outerWidth=8,this.visibleInnerColor=new o([3,252,111,1]),this.visibleOuterColor=new o([3,252,111,.15]),this.occludedInnerColor=new o([252,3,69,1]),this.occludedOuterColor=new o([252,3,69,.1]),this.undefinedInnerColor=new o([255,255,255,1]),this.undefinedOuterColor=new o([127,127,127,.2]);}};e([y$1({type:Number})],s.prototype,"innerWidth",void 0),e([y$1({type:Number})],s.prototype,"outerWidth",void 0),e([y$1({type:o})],s.prototype,"visibleInnerColor",void 0),e([y$1({type:o})],s.prototype,"visibleOuterColor",void 0),e([y$1({type:o})],s.prototype,"occludedInnerColor",void 0),e([y$1({type:o})],s.prototype,"occludedOuterColor",void 0),e([y$1({type:o})],s.prototype,"undefinedInnerColor",void 0),e([y$1({type:o})],s.prototype,"undefinedOuterColor",void 0),s=e([n("esri.views.3d.layers.analysis.LineOfSight.LineOfSightConfiguration")],s);

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
let p=class extends p$1{constructor(){super(...arguments),this.analyses=new L,this.configuration=new s,this.observerEngineLocation=n$1();}};e([y$1()],p.prototype,"analyses",void 0),e([y$1({type:s})],p.prototype,"configuration",void 0),e([y$1()],p.prototype,"observerEngineLocation",void 0),p=e([n("esri.views.3d.layers.analysis.LineOfSight.LineOfSightLayerViewData")],p);

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
let y=class extends p$1{constructor(e){super(e),this._handle=null,this._analysisHandles=new u;}initialize(){this._handle=this._connectAnalyses();}destroy(){this._handle=s$1(this._handle),this._analysisHandles=l$1(this._analysisHandles);}get _analyses(){return this.layerViewData.analyses}get _configuration(){return this.layerViewData.configuration}createLineOfSightVisualization(){const e=this._configuration,t={view:this.view,attached:!0,width:e.outerWidth,innerWidth:e.innerWidth};return {visibleLineVisualElement:new m$1({...t,color:o.toUnitRGBA(e.visibleOuterColor),innerColor:o.toUnitRGBA(e.visibleInnerColor)}),occludedLineVisualElement:new m$1({...t,color:o.toUnitRGBA(e.occludedOuterColor),innerColor:o.toUnitRGBA(e.occludedInnerColor)}),undefinedLineVisualElement:new m$1({...t,color:o.toUnitRGBA(e.undefinedOuterColor),innerColor:o.toUnitRGBA(e.undefinedInnerColor)})}}destroyLineOfSightVisualization(e){e.visibleLineVisualElement=l$1(e.visibleLineVisualElement),e.occludedLineVisualElement=l$1(e.occludedLineVisualElement),e.undefinedLineVisualElement=l$1(e.undefinedLineVisualElement);}updateLineOfSightVisualization(e,t){const o$1=this._configuration,{computationResult:n,inputPoints:s}=e,{start:r,end:l,intersection:a,isValid:c$1,isTargetVisible:u}=n,{observer:d}=s,p=v;p[12]=d[0],p[13]=d[1],p[14]=d[2];const f=c(g,r,d),y=c(V,l,d),L=c(_,a,d),{visibleLineVisualElement:C,occludedLineVisualElement:O,undefinedLineVisualElement:A}=t;C.geometry=null,O.geometry=null,A.geometry=null,c$1?u?(C.geometry=[[e$1(f),e$1(y)]],C.transform=p,C.color=o.toUnitRGBA(o$1.visibleOuterColor)):(C.geometry=[[e$1(f),e$1(L)]],C.transform=p,C.color=o.toUnitRGBA(o$1.occludedOuterColor),O.geometry=[[e$1(L),e$1(y)]],O.transform=p):(A.geometry=[[e$1(f),e$1(y)]],A.transform=p);}getLineOfSightVisualizationDependencies(e){const{computationResult:i}=e,{occludedOuterColor:t,visibleOuterColor:o}=this._configuration;return {computationResult:i,occludedOuterColor:t,visibleOuterColor:o}}_connectAnalysis(e){const i=this._analysisHandles;if(i.has(e))return;const t=this.createLineOfSightVisualization();i.add([l((()=>this.getLineOfSightVisualizationDependencies(e)),(()=>this.updateLineOfSightVisualization(e,t))),n$3((()=>this.destroyLineOfSightVisualization(t)))]);}_disconnectAnalysis(e){this._analysisHandles.remove(e);}_connectAnalyses(){let e=null;return r$2([l((()=>this._analyses),(i=>{e=s$1(e),e=i.on("change",(e=>this._onAnalysesCollectionChange(e))),this._onAnalysesCollectionChange({target:i,added:i.items,removed:[],moved:[]});})),n$3((()=>e=s$1(e)))])}_onAnalysesCollectionChange(e){e.added.forEach((e=>this._connectAnalysis(e))),e.removed.forEach((e=>this._disconnectAnalysis(e)));}};e([y$1({constructOnly:!0})],y.prototype,"layer",void 0),e([y$1({constructOnly:!0})],y.prototype,"view",void 0),e([y$1({constructOnly:!0})],y.prototype,"layerViewData",void 0),e([y$1()],y.prototype,"_analyses",null),e([y$1()],y.prototype,"_configuration",null),y=e([n("esri.views.3d.layers.analysis.LineOfSight.LineOfSightView")],y);const g=n$1(),V=n$1(),_=n$1(),v=e$2();

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
let m=class extends(p$3(d$1)){constructor(){super(...arguments),this.type="line-of-sight-3d",this._layerViewData=new p;}initialize(){const r=this.view,e=this.layer,t=this._layerViewData;this._analysisController=new V$1({layer:e,layerViewData:t,view:r}),this._analysisView=new y({layer:e,layerViewData:t,view:r});}destroy(){this._analysisController=l$1(this._analysisController),this._analysisView=l$1(this._analysisView);}get results(){return this._layerViewData.analyses.map((r=>r.result))}get priority(){return this._analysisController.priority}set priority(r){this._analysisController.priority=r;}getResultForTarget(r){const e=this._layerViewData.analyses.find((e=>e.target===r)),s=o$1(e,(r=>r.result));return c$1(s,null)}isUpdating(){return v$1(this._analysisController,!1,(r=>r.updating))}};e([y$1({readOnly:!0})],m.prototype,"type",void 0),e([y$1()],m.prototype,"layer",void 0),e([y$1({readOnly:!0})],m.prototype,"results",null),e([y$1()],m.prototype,"priority",null),e([y$1()],m.prototype,"_layerViewData",void 0),e([y$1()],m.prototype,"_analysisController",void 0),e([y$1()],m.prototype,"_analysisView",void 0),m=e([n("esri.views.3d.layers.LineOfSightLayerView3D")],m);var w=m;

export default w;
export { m as LineOfSightLayerView3D };
