import { n as n$1, r as r$1, t as t$1 } from './Message-70b34921.js';
import { g as g$1 } from './brushes-b53a5560.js';
import { r as r$3 } from './Container-a08586d2.js';
import { s } from './promiseUtils-2ff2b194.js';
import { a as a$1 } from './DisplayObject-8d4c95bb.js';
import { r as r$2 } from './earcut-d81146f9.js';
import { r } from './vec2-513a0296.js';
import { n as n$2 } from './vec2f64-3fb878b3.js';
import { B, C } from './featureConversionUtils-3ad98dca.js';
import { a as t } from './OptimizedFeature-ccef5b1d.js';
import { m as m$1, I } from './Utils-12055aa8.js';
import { h, f } from './FramebufferObject-238df962.js';

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
const m=n$1.getLogger("esri.views.2d.engine.webgl.Mesh2D"),u=t=>{switch(t.BYTES_PER_ELEMENT){case 1:return 5121;case 2:return 5123;case 4:return 5125;default:throw new s("Cannot get DataType of array")}},y=(e,t,r,n)=>{let o=0;for(let s=1;s<r;s++){const r=e[2*(t+s-1)],n=e[2*(t+s-1)+1];o+=(e[2*(t+s)]-r)*(e[2*(t+s)+1]+n);}return n?o>0:o<0},x=({coords:e,lengths:t},r)=>{const o=[];for(let s=0,c=0;s<t.length;c+=t[s],s+=1){const i=c,a=[];for(;s<t.length-1&&y(e,c+t[s],t[s+1],r);s+=1,c+=t[s])a.push(c+t[s]-i);const f=e.slice(2*i,2*(c+t[s])),h=r$2(f,a,2);for(const e of h)o.push(e+i);}return o};class g{constructor(e,t,r,n=!1){this._cache={},this.vertices=e,this.indices=t,this.primitiveType=r,this.isMapSpace=n;}static fromRect({x:e,y:t,width:r,height:n}){const o=e,s=t,c=o+r,i=s+n;return g.fromScreenExtent({xmin:o,ymin:s,xmax:c,ymax:i})}static fromPath(e){const t$1=B(new t,e.path,!1,!1),r=t$1.coords,n=new Uint32Array(x(t$1,!0)),o=new Uint32Array(r.length/2);for(let s=0;s<o.length;s++)o[s]=m$1(Math.floor(r[2*s]),Math.floor(r[2*s+1]));return new g({geometry:o},n,4)}static fromGeometry(t,r){const n=r.geometry.type;switch(n){case"polygon":return g.fromPolygon(t,r.geometry);case"extent":return g.fromMapExtent(t,r.geometry);default:return m.error(new s("mapview-bad-type",`Unable to create a mesh from type ${n}`,r)),g.fromRect({x:0,y:0,width:1,height:1})}}static fromPolygon(e,t$1){const r$1=C(new t,t$1,!1,!1),n=r$1.coords,c=new Uint32Array(x(r$1,!1)),h=new Uint32Array(n.length/2),m=n$2(),u=n$2();for(let s=0;s<h.length;s++)r(m,n[2*s],n[2*s+1]),e.toScreen(u,m),h[s]=m$1(Math.floor(u[0]),Math.floor(u[1]));return new g({geometry:h},c,4,!0)}static fromScreenExtent({xmin:e,xmax:t,ymin:r,ymax:n}){const o={geometry:new Uint32Array([m$1(e,r),m$1(t,r),m$1(e,n),m$1(e,n),m$1(t,r),m$1(t,n)])},s=new Uint32Array([0,1,2,3,4,5]);return new g(o,s,4)}static fromMapExtent(e,t){const[r,n]=e.toScreen([0,0],[t.xmin,t.ymin]),[o,s]=e.toScreen([0,0],[t.xmax,t.ymax]),c={geometry:new Uint32Array([m$1(r,n),m$1(o,n),m$1(r,s),m$1(r,s),m$1(o,n),m$1(o,s)])},i=new Uint32Array([0,1,2,3,4,5]);return new g(c,i,4)}destroy(){r$1(this._cache.indexBuffer)&&this._cache.indexBuffer.dispose();for(const e in this._cache.vertexBuffers)r$1(this._cache.vertexBuffers[e])&&this._cache.vertexBuffers[e].dispose();}get elementType(){return u(this.indices)}getIndexBuffer(e,t=35044){return this._cache.indexBuffer||(this._cache.indexBuffer=h.createIndex(e,t,this.indices)),this._cache.indexBuffer}getVertexBuffers(e,t=35044){return this._cache.vertexBuffers||(this._cache.vertexBuffers=Object.keys(this.vertices).reduce(((r,n)=>({...r,[n]:h.createVertex(e,t,this.vertices[n])})),{})),this._cache.vertexBuffers}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
const a=n$1.getLogger("esri.views.2d.engine.webgl.ClippingInfo"),c=t=>parseFloat(t)/100;class n extends a$1{constructor(t,e){super(),this._clip=e,this._cache={},this.stage=t,this._handle=e.watch("version",(()=>this._invalidate())),this.ready();}static fromClipArea(t,e){return new n(t,e)}_destroyGL(){r$1(this._cache.mesh)&&(this._cache.mesh.destroy(),this._cache.mesh=null),r$1(this._cache.vao)&&(this._cache.vao.dispose(),this._cache.vao=null);}destroy(){this._destroyGL(),this._handle.remove();}getVAO(t,e,r,i){const[h,a]=e.size;if("geometry"!==this._clip.type&&this._lastWidth===h&&this._lastHeight===a||(this._lastWidth=h,this._lastHeight=a,this._destroyGL()),t$1(this._cache.vao)){const s=this._createMesh(e,this._clip),h=s.getIndexBuffer(t),a=s.getVertexBuffers(t);this._cache.mesh=s,this._cache.vao=new f(t,r,i,a,h);}return this._cache.vao}_invalidate(){this._destroyGL(),this.requestRender();}_createScreenRect(t,e){const[r,s]=t.size,i="string"==typeof e.left?c(e.left)*r:e.left,h="string"==typeof e.right?c(e.right)*r:e.right,o="string"==typeof e.top?c(e.top)*s:e.top,a="string"==typeof e.bottom?c(e.bottom)*s:e.bottom,n=i,p=o;return {x:n,y:p,width:Math.max(r-h-n,0),height:Math.max(s-a-p,0)}}_createMesh(e,r){switch(r.type){case"rect":return g.fromRect(this._createScreenRect(e,r));case"path":return g.fromPath(r);case"geometry":return g.fromGeometry(e,r);default:return a.error(new s("mapview-bad-type","Unable to create ClippingInfo mesh from clip of type: ${clip.type}")),g.fromRect({x:0,y:0,width:1,height:1})}}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class o extends r$3{constructor(){super(...arguments),this.name=this.constructor.name;}set clips(e){this._clips=e,this.children.forEach((r=>r.clips=e)),this._updateClippingInfo();}doRender(e){const r=this.createRenderParams(e),{painter:s,globalOpacity:t,profiler:i,drawPhase:o}=r,a=o===I.LABEL?1:t*this.computedOpacity;i.recordContainerStart(this.name),s.beforeRenderLayer(r,this._clippingInfos?255:0,a),this.updateTransforms(e.state),this.renderChildren(r),s.compositeLayer(r,a),i.recordContainerEnd();}renderChildren(r){t$1(this._renderPasses)&&(this._renderPasses=this.prepareRenderPasses(r.painter));for(const e of this.children)e.beforeRender(r);for(const e of this._renderPasses)try{e.render(r);}catch(s){}for(const e of this.children)e.afterRender(r);}createRenderParams(e){return {...e,requireFBO:this.requiresDedicatedFBO}}prepareRenderPasses(e){return [e.registerRenderPass({name:"clip",brushes:[g$1.clip],target:()=>this._clippingInfos,drawPhase:I.MAP|I.LABEL|I.LABEL_ALPHA|I.DEBUG|I.HIGHLIGHT})]}updateTransforms(e){for(const r of this.children)r.setTransform(e);}onAttach(){super.onAttach(),this._updateClippingInfo();}onDetach(){super.onDetach(),this._updateClippingInfo();}_updateClippingInfo(){if(r$1(this._clippingInfos)&&(this._clippingInfos.forEach((e=>e.destroy())),this._clippingInfos=null),!this.stage)return;const e=this._clips;r$1(e)&&e.length&&(this._clippingInfos=e.items.map((e=>n.fromClipArea(this.stage,e)))),this.requestRender();}}

export { o };
