import { r as r$1, t } from './Message-70b34921.js';
import { h as h$1, v, P, E, U, m } from './promiseUtils-2ff2b194.js';
import { e as e$1 } from './Queue-a5bdb7c1.js';
import { j as v$1, h as e$3 } from './JSONSupport-9346590f.js';
import { S } from './SpatialReference-843b1520.js';
import { e as e$2 } from './TileKey-86c6b8c5.js';

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class l$1{constructor(e,s){this.item=e,this.controller=s,this.promise=null;}}class _{constructor(s){this._deferreds=new Map,this._controllers=new Map,this._processingItems=new Map,this._isPaused=!1,this._schedule=null,this._task=null,this.concurrency=1,s.concurrency&&(this.concurrency=s.concurrency),this._queue=new e$1(s.peeker),this.process=s.process;const t=s.scheduler;s.priority&&r$1(t)&&(this._task=t.registerTask(s.priority,this));}destroy(){this.clear(),this._schedule&&(this._schedule.remove(),this._schedule=null),this._task&&(this._task.remove(),this._task=null);}get length(){return this._processingItems.size+this._queue.length}abort(e){const s=this._controllers.get(e);s&&s.abort();}clear(){this._queue.clear();const e=[];this._controllers.forEach((s=>e.push(s))),this._controllers.clear(),e.forEach((e=>e.abort())),this._processingItems.clear(),this._cancelNext();}forEach(e){this._deferreds.forEach(((s,t)=>e(t)));}get(e){const s=this._deferreds.get(e);return s?s.promise:void 0}isOngoing(e){return this._processingItems.has(e)}has(e){return this._deferreds.has(e)}pause(){this._isPaused||(this._isPaused=!0,this._cancelNext());}push(s,o){const u=this.get(s);if(u)return u;const n=h$1();let l=null;o&&(l=v(o,(()=>n.abort())));const _=()=>{const e=this._processingItems.get(s);e&&e.controller.abort(),p(),d.reject(m());},p=()=>{a.remove(),r$1(l)&&l.remove(),this._deferreds.delete(s),this._controllers.delete(s),this._queue.remove(s),this._processingItems.delete(s),this._scheduleNext();},a=P(n.signal,_),d=E();return this._deferreds.set(s,d),this._controllers.set(s,n),d.promise.then(p,p),this._queue.push(s),this._scheduleNext(),d.promise}last(){return this._queue.last()}peek(){return this._queue.peek()}popLast(){return this._queue.popLast()}reset(){const e=[];this._processingItems.forEach((s=>e.push(s))),this._processingItems.clear();for(const s of e)this._queue.push(s.item),s.controller.abort();this._scheduleNext();}resume(){this._isPaused&&(this._isPaused=!1,this._scheduleNext());}takeAll(){const e=[];for(;this._queue.length;)e.push(this._queue.pop());return this.clear(),e}get running(){return !this._isPaused&&this._queue.length>0&&this._processingItems.size<this.concurrency}runTask(e){for(;!e.done&&this._queue.length>0&&this._processingItems.size<this.concurrency;)this._process(this._queue.pop()),e.madeProgress();}_scheduleNext(){this._task||this._isPaused||this._schedule||(this._schedule=v$1((()=>{this._schedule=null,this._next();})));}_next(){for(;this._queue.length>0&&this._processingItems.size<this.concurrency;)this._process(this._queue.pop());}_cancelNext(){this._schedule&&(this._schedule.remove(),this._schedule=null);}_processResult(e,s){this._canProcessFulfillment(e)&&(this._scheduleNext(),this._deferreds.get(e.item).resolve(s));}_processError(e,s){this._canProcessFulfillment(e)&&(this._scheduleNext(),this._deferreds.get(e.item).reject(s));}_canProcessFulfillment(e){return !!this._deferreds.get(e.item)&&this._processingItems.get(e.item)===e}_process(e){if(t(e))return;let r;const i=h$1(),h=new l$1(e,i);this._processingItems.set(e,h);try{r=this.process(e,i.signal);}catch(c){this._processError(h,c);}U(r)?(h.promise=r,r.then((e=>this._processResult(h,e)),(e=>this._processError(h,e)))):this._processResult(h,r);}get test(){return {update:e=>this.runTask(e)}}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
function o$1(t,r){return [t,r]}function i$1(t,r,o){return t[0]=r,t[1]=o,t}function e(t,r,o,i,e){return t[0]=r,t[1]=o,t[2]=i,t[3]=e,t}const s=new e$2("0/0/0/0");class n$1{constructor(t,r,o,i,e,s,n,l,h,a,u,m){this.level=t,this.resolution=r,this.scale=o,this.origin=i,this.first=e,this.last=s,this.size=n,this.norm=l,this.worldStart=h,this.worldEnd=a,this.worldSize=u,this.wrap=m;}static create(r,e,s){const l=S(r.spatialReference),h=o$1(r.origin.x,r.origin.y),a=o$1(r.size[0]*e.resolution,r.size[1]*e.resolution),u=o$1(-1/0,-1/0),m=o$1(1/0,1/0),g=o$1(1/0,1/0);let w,d,c,f;return s&&(i$1(u,Math.max(0,Math.floor((s.xmin-h[0])/a[0])),Math.max(0,Math.floor((h[1]-s.ymax)/a[1]))),i$1(m,Math.max(0,Math.floor((s.xmax-h[0])/a[0])),Math.max(0,Math.floor((h[1]-s.ymin)/a[1]))),i$1(g,m[0]-u[0]+1,m[1]-u[1]+1)),r.isWrappable?(w=o$1(Math.ceil(Math.round((l.valid[1]-l.valid[0])/e.resolution)/r.size[0]),g[1]),d=o$1(Math.floor((l.origin[0]-h[0])/a[0]),u[1]),c=o$1(w[0]+d[0]-1,m[1]),f=!0):(d=u,c=m,w=g,f=!1),new n$1(e.level,e.resolution,e.scale,h,u,m,g,a,d,c,w,f)}normalizeCol(t){if(!this.wrap)return t;const r=this.worldSize[0];return t<0?r-1-Math.abs((t+1)%r):t%r}denormalizeCol(t,r){return this.wrap?this.worldSize[0]*r+t:t}getWorldForColumn(t){return this.wrap?Math.floor(t/this.worldSize[0]):0}getFirstColumnForWorld(t){return t*this.worldSize[0]+this.first[0]}getLastColumnForWorld(t){return t*this.worldSize[0]+this.first[0]+this.size[0]-1}getColumnForX(t){return (t-this.origin[0])/this.norm[0]}getXForColumn(t){return this.origin[0]+t*this.norm[0]}getRowForY(t){return (this.origin[1]-t)/this.norm[1]}getYForRow(t){return this.origin[1]-t*this.norm[1]}getTileBounds(t,r,o=!1){s.set(r);const i=o?s.col:this.denormalizeCol(s.col,s.world),n=s.row;return e(t,this.getXForColumn(i),this.getYForRow(n+1),this.getXForColumn(i+1),this.getYForRow(n)),t}getTileCoords(t,r,o=!1){s.set(r);const e=o?s.col:this.denormalizeCol(s.col,s.world);return Array.isArray(t)?i$1(t,this.getXForColumn(e),this.getYForRow(s.row)):(t.x=this.getXForColumn(e),t.y=this.getYForRow(s.row)),t}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class l{constructor(){this.spans=[];}acquire(o){this.lodInfo=o;}release(){this.lodInfo=null,this.spans.length=0;}forEach(o,l){const{spans:s,lodInfo:t}=this,{level:e}=t;if(0!==s.length)for(const{row:r,colFrom:n,colTo:c}of s)for(let s=n;s<=c;s++)o.call(l,e,r,t.normalizeCol(s),t.getWorldForColumn(s));}}l.pool=new e$3(l);

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class o{constructor(o,t,s){this.row=o,this.colFrom=t,this.colTo=s;}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
const i=new e$2("0/0/0/0");class n{constructor(e,t,o,l,s,i,n,r){this.x=e,this.ymin=t,this.ymax=o,this.invM=l,this.leftAdjust=s,this.rightAdjust=i,this.leftBound=n,this.rightBound=r;}static create(e,t){e[1]>t[1]&&([e,t]=[t,e]);const[o,l]=e,[s,i]=t,r=s-o,a=i-l,h=0!==a?r/a:0,c=(Math.ceil(l)-l)*h,f=(Math.floor(l)-l)*h;return new n(o,Math.floor(l),Math.ceil(i),h,r<0?c:f,r<0?f:c,r<0?s:o,r<0?o:s)}incrRow(){this.x+=this.invM;}getLeftCol(){return Math.max(this.x+this.leftAdjust,this.leftBound)}getRightCol(){return Math.min(this.x+this.rightAdjust,this.rightBound)}}const r=[[0,0],[0,0],[0,0],[0,0]],a=1e-6;class h{constructor(e,o){this.tileInfo=e,this.fullExtent=o,this.scales=[],this._lodInfos=null,this._infoByScale={},this._infoByLevel={};const l=e.lods.slice();l.sort((function(e,t){return t.scale-e.scale}));const s=this._lodInfos=l.map((l=>n$1.create(e,l,o)));l.forEach(((e,t)=>{this._infoByLevel[e.level]=s[t],this._infoByScale[e.scale]=s[t],this.scales[t]=e.scale;}),this),this._wrap=e.isWrappable;}get spatialReference(){return this.tileInfo.spatialReference}getLODInfoAt(e){return this._infoByLevel["number"==typeof e?e:e.level]}getTileBounds(e,t,o=!1){i.set(t);const l=this._infoByLevel[i.level];return l?l.getTileBounds(e,i,o):e}getTileCoords(e,t,o=!1){i.set(t);const l=this._infoByLevel[i.level];return l?l.getTileCoords(e,i,o):e}getTileCoverage(e,t=192,l$1="closest"){const i="closest"===l$1?this.getClosestInfoForScale(e.scale):this.getSmallestInfoForScale(e.scale),a=l.pool.acquire(i),h=this._wrap;let c,f,u,m=1/0,g=-1/0;const d=a.spans;r[0][0]=r[0][1]=r[1][1]=r[3][0]=-t,r[1][0]=r[2][0]=e.size[0]+t,r[2][1]=r[3][1]=e.size[1]+t;for(const o of r)e.toMap(o,o),o[0]=i.getColumnForX(o[0]),o[1]=i.getRowForY(o[1]);const y=[];let _=3;for(let o=0;o<4;o++){if(r[o][1]===r[_][1]){_=o;continue}const e=n.create(r[o],r[_]);m=Math.min(e.ymin,m),g=Math.max(e.ymax,g),void 0===y[e.ymin]&&(y[e.ymin]=[]),y[e.ymin].push(e),_=o;}if(null==m||null==g||g-m>100)return null;let v=[];for(c=m;c<g;){null!=y[c]&&(v=v.concat(y[c])),f=1/0,u=-1/0;for(let e=v.length-1;e>=0;e--){const t=v[e];f=Math.min(f,t.getLeftCol()),u=Math.max(u,t.getRightCol());}if(f=Math.floor(f),u=Math.floor(u),c>=i.first[1]&&c<=i.last[1])if(h)if(i.size[0]<i.worldSize[0]){const e=Math.floor(u/i.worldSize[0]);for(let t=Math.floor(f/i.worldSize[0]);t<=e;t++)d.push(new o(c,Math.max(i.getFirstColumnForWorld(t),f),Math.min(i.getLastColumnForWorld(t),u)));}else d.push(new o(c,f,u));else f>i.last[0]||u<i.first[0]||(f=Math.max(f,i.first[0]),u=Math.min(u,i.last[0]),d.push(new o(c,f,u)));c+=1;for(let e=v.length-1;e>=0;e--){const t=v[e];t.ymax>=c?t.incrRow():v.splice(e,1);}}return a}getTileParentId(e){i.set(e);const t=this._infoByLevel[i.level],o=this._lodInfos.indexOf(t)-1;return o<0?null:(this._getTileIdAtLOD(i,this._lodInfos[o],i),i.id)}getTileResolution(e){const t=this._infoByLevel["object"==typeof e?e.level:e];return t?t.resolution:-1}getTileScale(e){const t=this._infoByLevel[e.level];return t?t.scale:-1}intersects(e,t){i.set(t);const o=this._infoByLevel[i.level],l=e.lodInfo;if(l.resolution>o.resolution){this._getTileIdAtLOD(i,l,i);const t=l.denormalizeCol(i.col,i.world);for(const o of e.spans)if(o.row===i.row&&o.colFrom<=t&&o.colTo>=t)return !0}if(l.resolution<o.resolution){const[t,s,n,r]=e.spans.reduce(((e,t)=>(e[0]=Math.min(e[0],t.row),e[1]=Math.max(e[1],t.row),e[2]=Math.min(e[2],t.colFrom),e[3]=Math.max(e[3],t.colTo),e)),[1/0,-1/0,1/0,-1/0]),a=o.denormalizeCol(i.col,i.world),h=l.getColumnForX(o.getXForColumn(a)),c=l.getRowForY(o.getYForRow(i.row)),f=l.getColumnForX(o.getXForColumn(a+1))-1,u=l.getRowForY(o.getYForRow(i.row+1))-1;return !(h>r||f<n||c>s||u<t)}const s=l.denormalizeCol(i.col,i.world);return e.spans.some((e=>e.row===i.row&&e.colFrom<=s&&e.colTo>=s))}normalizeBounds(t,o,l){if(t[0]=o[0],t[1]=o[1],t[2]=o[2],t[3]=o[3],this._wrap){const o=S(this.tileInfo.spatialReference),s=-l*(o.valid[1]-o.valid[0]);t[0]+=s,t[2]+=s;}return t}getSmallestInfoForScale(e){const t=this.scales;if(this._infoByScale[e])return this._infoByScale[e];if(e>t[0])return this._infoByScale[t[0]];for(let o=1;o<t.length-1;o++)if(e>t[o]+a)return this._infoByScale[t[o-1]];return this._infoByScale[t[t.length-1]]}getClosestInfoForScale(e){const t=this.scales;return this._infoByScale[e]||(e=t.reduce(((t,o)=>Math.abs(o-e)<Math.abs(t-e)?o:t),t[0])),this._infoByScale[e]}scaleToLevel(e){const t=this.scales;if(this._infoByScale[e])return this._infoByScale[e].level;for(let o=t.length-1;o>=0;o--)if(e<t[o]){if(o===t.length-1)return this._infoByScale[t[t.length-1]].level;return this._infoByScale[t[o]].level+(t[o]-e)/(t[o]-t[o+1])}return this._infoByScale[t[0]].level}scaleToZoom(e){return this.tileInfo.scaleToZoom(e)}_getTileIdAtLOD(e,t,o){const l=this._infoByLevel[o.level];return e.set(o),t.resolution<l.resolution?null:(t.resolution===l.resolution||(e.level=t.level,e.col=Math.floor(o.col*l.resolution/t.resolution+.01),e.row=Math.floor(o.row*l.resolution/t.resolution+.01)),e)}}

export { _, h, l };
