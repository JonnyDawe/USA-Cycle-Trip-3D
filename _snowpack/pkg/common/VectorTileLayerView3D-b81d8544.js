import { e as e$3 } from './JSONSupport-9346590f.js';
import { r as r$2, z as i$3, k as l } from './Message-70b34921.js';
import { a as a$1, h as h$1, b } from './promiseUtils-2ff2b194.js';
import { x } from './watchUtils-06a91cc9.js';
import { y, n as n$1 } from './subclass-fe5fcf78.js';
import { t } from './SchemaHelper-92e518c0.js';
import { e as e$1 } from './MemCache-b33cfc4b.js';
import { ap as e$2 } from './DefaultUI-99d89841.js';
import { i as i$2 } from './aaBoundingRect-68336c41.js';
import { h, s as s$1, d } from './VectorTile-a034e4bb.js';
import { r, i as i$1, a as r$1, f } from './SymbolRepository-70fa7c08.js';
import { e } from './TileKey-86c6b8c5.js';
import { G } from './brushes-b53a5560.js';
import { c } from './VTLMaterialManager-13ffe6a9.js';
import { g as a$2 } from './StyleRepository-5763ade0.js';
import { l as n, m as p } from './SceneView-f849f26b.js';
import './mat3-6cb40036.js';
import './FramebufferObject-238df962.js';
import './Texture-454f8135.js';
import './DisplayObject-8d4c95bb.js';
import { d as d$1 } from './LayerView-0b9de845.js';
import './TileInfo-c32d8db8.js';
import './jsonMap-e142bd84.js';
import './unitUtils-b17203be.js';
import './SpatialReference-843b1520.js';
import './Point-ee7951c3.js';
import './reader-fa0f173d.js';
import './Handles-af859b7b.js';
import './Collection-32506e74.js';
import './Loadable-d16b3d7d.js';
import './Polyline-ccd8fb47.js';
import './Map-566c621c.js';
import './Basemap-ad33b4b0.js';
import './collectionUtils-a13e45d8.js';
import './loadAll-37e49bde.js';
import './asyncUtils-015dfd6e.js';
import './Portal-ff63481f.js';
import './intl-21ab9759.js';
import './locale-b874fc68.js';
import './assets-73c8998f.js';
import './PortalItem-4692b2a9.js';
import './writeUtils-7e5aaca1.js';
import './Color-ae84a22a.js';
import './mathUtils-a477cc74.js';
import './compilerUtils-7bbb76dc.js';
import './enumeration-7d0c165d.js';
import './opacityUtils-b92214c2.js';
import './CollectionFlattener-af542a66.js';
import './HandleOwner-fbf91095.js';
import './basemapUtils-9ae6960d.js';
import './TablesMixin-751fb22e.js';
import './Layer-aafbe66d.js';
import './Identifiable-3ad643f8.js';
import './TimeExtent-02acfb1c.js';
import './PopupTemplate-d97f5e88.js';
import './fieldUtils-22be41cd.js';
import './HeightModelInfo-992659fb.js';
import './GraphicsCollection-60679841.js';
import './Graphic-bb07b7e4.js';
import './symbols-9e680ec7.js';
import './SimpleLineSymbol-9959d1ea.js';
import './persistableUrlUtils-59858a7e.js';
import './uid-6beaca4c.js';
import './jsonUtils-f0a19240.js';
import './Queue-a5bdb7c1.js';
import './widget-734a78a2.js';
import './uuid-630c0c55.js';
import './QueryTask-55cf149f.js';
import './Query-619f76b0.js';
import './Field-728fb193.js';
import './fieldType-6799091f.js';
import './Task-41e0c8b8.js';
import './query-de9ba206.js';
import './normalizeUtils-5edbbb73.js';
import './pbfQueryUtils-9ef2116f.js';
import './pbf-9fd5cf83.js';
import './OptimizedFeature-ccef5b1d.js';
import './OptimizedFeatureSet-be12a9b8.js';
import './queryZScale-688c1e0e.js';
import './zscale-9df5d655.js';
import './TopFeaturesQuery-b22907ac.js';
import './FeatureSet-d8329cbc.js';
import './featureConversionUtils-3ad98dca.js';
import './FeatureLayer-a1f2dd15.js';
import './UniqueValueRenderer-260b50e9.js';
import './jsonUtils-4c6963ee.js';
import './ColorStop-ed1033bb.js';
import './diffUtils-530d997b.js';
import './sizeVariableUtils-6d1564c8.js';
import './visualVariableUtils-86a9e524.js';
import './lengthUtils-824a0190.js';
import './styleUtils-8b593a34.js';
import './jsonUtils-cb46c967.js';
import './LRUCache-eed24cc2.js';
import './MultiOriginJSONSupport-859401da.js';
import './workers-bd1ea274.js';
import './APIKeyMixin-7fe44a14.js';
import './ArcGISService-32a080a6.js';
import './arcgisLayerUrl-cb5a8728.js';
import './BlendLayer-b9fc1ffb.js';
import './CustomParametersMixin-79fc7530.js';
import './OperationalLayer-a01538e1.js';
import './PortalLayer-722467e6.js';
import './RefreshableLayer-a609d261.js';
import './ScaleRangeLayer-9b1bf210.js';
import './TemporalLayer-f1ac30a1.js';
import './TimeInfo-ba3374ff.js';
import './labelingInfo-c6f27ee6.js';
import './LabelClass-e4354cdb.js';
import './labelUtils-7d1afc11.js';
import './defaults-31c9613a.js';
import './defaultsJSON-0467bd38.js';
import './featureReductionUtils-78800e19.js';
import './FeatureType-97537d09.js';
import './fieldProperties-4363f1e0.js';
import './FieldsIndex-f71b4f3d.js';
import './styleUtils-58b9b121.js';
import './popupUtils-5b007a8e.js';
import './utils-4028018e.js';
import './ItemCache-2457b327.js';
import './vec2f32-556b449a.js';
import './vec2-513a0296.js';
import './vec2f64-3fb878b3.js';
import './capabilities-39806eb7.js';
import './config-b1f55e66.js';
import './TiledDisplayObject-38ffcb88.js';
import './Rect-b93f4c2a.js';
import './CIMSymbolHelper-6b8d9205.js';
import './TileIndex-d9b4f06c.js';
import './TilemapCache-fbae412c.js';
import './definitions-8237c146.js';
import './rasterUtils-8b815ad2.js';
import './Utils-12055aa8.js';
import './ShaderCompiler-b2adc15a.js';
import './GeometryUtils-d396765a.js';
import './MaterialKey-5b784827.js';
import './colorUtils-49d4e96f.js';
import './unitBezier-279ad9f0.js';
import './projection-c73dd3c4.js';
import './mat4-8eb66d33.js';
import './DefaultMaterial_COLOR_GAMMA-7c4a23ef.js';
import './vec33-d394808f.js';
import './types-fe598891.js';
import './Version-271d30d5.js';
import './quat-44770d30.js';
import './vec4-8546ad05.js';
import './BufferView-3733efba.js';
import './objectResourceUtils-59d1d140.js';
import './aaBoundingBox-c0155c39.js';
import './testSVGPremultipliedAlpha-b5c775e7.js';
import './InterleavedLayout-b66a6862.js';
import './vec3f32-97630458.js';
import './mat4f32-5ff6470f.js';
import './scaleUtils-10613b70.js';
import './ElevationSampler-c8359e31.js';
import './EdgeProcessingWorker-56aa1068.js';
import './deduplicate-b910185f.js';
import './resources-8aaa4737.js';
import './PromiseQueue-edaf4a34.js';
import './dehydratedFeatures-f49828b8.js';
import './byteSizeEstimations-5b7ab251.js';
import './quantizationUtils-28a0adf6.js';
import './labelFormatUtils-d93dcf3e.js';
import './earcut-d81146f9.js';
import './MeshComponent-13ddf9e0.js';
import './screenshotUtils-abc7263a.js';
import './callExpressionWithFeature-28066cb0.js';
import './projection-7d8c2528.js';
import './symbolLayerUtils3D-8a618a44.js';
import './geometryServiceUtils-83e1d118.js';
import './ProjectParameters-0d0884dd.js';
import './LercDecoder-00822609.js';
import './quatf32-b1c8b796.js';

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
function i(i,p){const a=[],y=new r(4096,a,(()=>{const e=new s$1;return e.show=!1,e.parts.push({startTime:0,startOpacity:0,targetOpacity:0,show:!1}),e.parts.push({startTime:0,startOpacity:0,targetOpacity:0,show:!1}),e})),m=new i$1(a,y,((t,r,o)=>new r$1(t,r,o,i.styleRepository,i.key.level,0)),((t,e)=>{h(t,e,!1);}),(()=>0),(t=>{const e=p.getStyleLayerByUID(t).getLayoutProperty("visibility");return !e||1!==e.getValue()}));a.push(i),y.add(i),m.setScreenSize(512,512),m.continue(1/0);}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class g$1 extends f{constructor(e,t,o,i,s){super(e,t,o),this._memCache=i,this._loader=s,this._ongoingTileRequests=new Map,this._ongoingRequestToController=new Map;}destroy(){this._ongoingRequestToController.forEach((e=>e.abort())),this._ongoingRequestToController.clear(),this._ongoingTileRequests.clear();}async getVectorTile(n,g,h,c){const m=new e(n,g,h,0);let u=this._memCache.get(m.id);if(r$2(u))return u.retain(),u;const _=await this._getVectorTileData(m);if(a$1(c),!this._vectorTileLayer)return null;if(u=this._memCache.get(m.id),r$2(u))return u.retain(),u;const T=this._vectorTileLayer.tileInfo.getTileBounds(i$2(),m);return u=new d(m,this._styleRepository,T,[512,512],this._memCache),r$2(_)&&_.tileData?(u.setData(_.tileData),u.retain(),this._memCache.put(m.id,u,u.memoryUsage*u.referenced,e$1)):u.setData(null),u.neededForCoverage=!0,u.transforms.tileUnitsToPixels=e$2(1/8,0,0,0,1/8,0,0,0,1),i(u,this._styleRepository),u}_getVectorTileData(e){const t=e.id;if(this._ongoingTileRequests.has(t))return this._ongoingTileRequests.get(t);const o=new AbortController,i={signal:o.signal},s=this._getParsedVectorTileData(e,i).then((e=>(this._ongoingTileRequests.delete(t),this._ongoingRequestToController.delete(t),e))).catch((()=>(this._ongoingTileRequests.delete(t),this._ongoingRequestToController.delete(t),null)));return this._ongoingTileRequests.set(t,s),this._ongoingRequestToController.set(t,o),s}_getParsedVectorTileData(e,t){return this.fetchTileData(e,t).then((o=>this.parseTileData({key:e,data:o},t)))}request(e,t){return this._loader.request(e,"binary",t)}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
const s=1e-6;class a{constructor(e,t){this.spriteMosaic=e,this.glyphMosaic=t,this._brushCache=new Map,this._vtlMaterialManager=new c;}dispose(){this._brushCache&&(this._brushCache.forEach((e=>e.dispose())),this._brushCache=null),this._vtlMaterialManager=i$3(this._vtlMaterialManager),this.spriteMosaic.dispose(),this.glyphMosaic.dispose();}get vectorTilesMaterialManager(){return this._vtlMaterialManager}drawTile(e,t,r){const{context:s}=e,a=r.layers;r.backgroundBucketIds.length>0&&(e.renderPass="background",r.backgroundBucketIds.forEach((s=>this._renderStyleLayer(r.getLayerById(s),e,t,!0)))),s.setBlendingEnabled(!1),s.setDepthTestEnabled(!0),s.setDepthWriteEnabled(!0),s.setDepthFunction(515),e.renderPass="opaque";for(let i=a.length-1;i>=0;i--)this._renderStyleLayer(a[i],e,t,!1);s.setDepthWriteEnabled(!1),s.setBlendingEnabled(!0),s.setBlendFunctionSeparate(1,771,1,771),e.renderPass="translucent";for(let i=0;i<a.length;i++)this._renderStyleLayer(a[i],e,t,!1);s.setDepthTestEnabled(!1),e.renderPass="symbol";for(let i=0;i<a.length;i++)this._renderStyleLayer(a[i],e,t,!1);s.bindVAO();}_renderStyleLayer(e,t,r,a=!1){if(!(a||e&&r.layerData.has(e.uid)))return;const i=e.getLayoutProperty("visibility");if(i&&1===i.getValue())return;const{renderPass:n}=t;let l;switch(e.type){case 0:if("background"!==n)return;l="vtlBackground";break;case 1:if("opaque"!==n&&"translucent"!==t.renderPass)return;l="vtlFill";break;case 2:if("translucent"!==n)return;l="vtlLine";break;case 4:if("symbol"!==n)return;l="vtlCircle";break;case 3:if("symbol"!==n)return;l="vtlSymbol";}const h=t.displayLevel;void 0!==e.minzoom&&e.minzoom>h+s||void 0!==e.maxzoom&&e.maxzoom<=h-s||(t.styleLayerUID=e.uid,t.styleLayer=e,this.drawWithBrush(t,r,l));}drawWithBrush(e,r,s){if(!this._brushCache.has(s)){const e=G[s];this._brushCache.set(s,new e);}this._brushCache.get(s).drawMany(e,[r]);}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
let g=class extends(n(p(d$1))){constructor(e){super(e),this.type="vector-tile-3d";}initialize(){const e=this.layer.compatibleTileInfo256,t$1=this._getTileInfoSupportError(e,this.layer.fullExtent);if(t$1)return void this.addResolvingPromise(Promise.reject(t$1));const{basemapTerrain:i,spatialReference:o,pixelRatio:a$1}=this.view,m=x(this.view,"basemapTerrain.tilingSchemeLocked").then((()=>{const e=i.tilingScheme,t$1=e.pixelSize;let r;this.schemaHelper=new t(t$1,o.isGeographic),r=256===t$1?this.layer.compatibleTileInfo256:this.view.spatialReference.isGeographic?this.layer.compatibleTileInfo512:this.layer.tileInfo;const l=this._getTileInfoCompatibilityError(r,e);if(l)throw l;this._set("tileInfo",r);}));this._tileHandlerController=h$1();const d=this.view.resourceController;this._memCache=d.memoryController.getMemCache(this.layer.uid,(e=>e.release()));const{style:f,spriteUrl:g,glyphsUrl:u}=this.layer.currentStyleInfo,_=new a$2(f,{spriteUrl:g,glyphsUrl:u}),H=i.mapTileRequester;this._tileHandler=new g$1(this.layer,_,a$1,this._memCache,H);const v=this._tileHandlerController.signal,C=e=>d.schedule(e),T=this._tileHandler.start({signal:v,schedule:C}),w=this._tileHandler.spriteMosaic;w.then((e=>{!b(v)&&this._tileHandler&&(this.painter=new a(e,this._tileHandler.glyphMosaic));})),T.then((()=>this._tileHandlerController=null));const j=()=>{this._tileHandlerController&&this._tileHandlerController.abort(),this._tileHandlerController=h$1(),this._memCache.clear();const{style:e,spriteUrl:t,glyphsUrl:i}=this.layer.currentStyleInfo,l=new a$2(e,{spriteUrl:t,glyphsUrl:i}),s=new g$1(this.layer,l,a$1,this._memCache,H),o=s.start({signal:this._tileHandlerController.signal,schedule:C}),n=s.spriteMosaic;o.then((()=>this._tileHandlerController=null)),this.updatingHandles.addPromise(Promise.all([o,n]).then((([,e])=>{const t=this._tileHandler,i=this.painter;this.painter=new a(e,s.glyphMosaic),this._tileHandler=s,this.emit("data-changed"),t.destroy(),i&&i.dispose();})));};this.updatingHandles.add(this,"layer.currentStyleInfo",j),this.updatingHandles.add(this,"view.pixelRatio",j);const I=Promise.all([m,T,w]);this.addResolvingPromise(I);}destroy(){this.painter=i$3(this.painter),this._tileHandlerController&&(this._tileHandlerController.abort(),this._tileHandlerController=null),l(this._tileHandler),this._memCache=l(this._memCache),this._tileHandler=null;}get dataLevelRange(){const e=this.tileInfo.lods,t=e[0].scale,i=e[e.length-1].scale,r=this.levelRangeFromScaleRange(t,i);return 1===r.minLevel&&256===this.tileInfo.size[0]&&(r.minLevel=0),r}async fetchTile(e,t,i,r){return this._tileHandler.getVectorTile(e,t,i,r)}};e$3([y({aliasOf:"layer.fullExtent"})],g.prototype,"fullExtent",void 0),e$3([y()],g.prototype,"layer",void 0),e$3([y()],g.prototype,"tileInfo",void 0),e$3([y()],g.prototype,"dataLevelRange",null),e$3([y()],g.prototype,"updatingProgressValue",void 0),g=e$3([n$1("esri.views.3d.layers.VectorTileLayerView3D")],g);var u=g;

export default u;
