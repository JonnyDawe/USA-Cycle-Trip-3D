import { e as e$Q, p as p$14, x as s$S, o as o$V, a as a$_, h as e$X, w as n$1e, B as t$19, D as r$1c, f as n$1h, E as e$10, F as i$Z, G as n$1o, H as t$1p, I as k$G, S as S$F, A as A$D, C as C$t, v as v$Q, J as u$19, K as l$1g, L as c$1b, M as M$C, N as l$1j, O as p$1h, P as F$F } from './JSONSupport-9346590f.js';
import { I as I$y, H as d$T, K as w$D, L as q$p, n as n$1f, M as S$B, i as i$V, c as t$1a, N as r$1e, O as F$z, Q as P$z, R as d$W, f as i$X, s as s$V, T as o$_, d as t$1d, m as u$W, o as n$1g, p as o$$, q as s$X, r as s$Y, v as d$Y, x as e$_, y as u$X, g as n$1i, U as z$y, u as u$17, V as U$p, X as f$$, Y as r$1t, $ as x$W, W as W$k, a0 as r$1x, a1 as n$1z, z as u$1g, B as m$11, _ as _$s, a as a$1s, C as i$1g, D as n$1D, E as s$1g, P as P$D, a2 as t$1w } from './DefaultUI-99d89841.js';
import { n as n$13, V as V$p, w as wt$1, L as L$w } from './Loadable-d16b3d7d.js';
import { h as h$R } from './Graphic-bb07b7e4.js';
import { A as A$E } from './Map-566c621c.js';
import { L as L$t } from './Collection-32506e74.js';
import { c as e$1h } from './widget-734a78a2.js';
import { s as s$Q, D as D$r, h as h$N, g as g$T, G as G$n, C as C$r, m as m$Y, b as b$J, q as q$q, w as w$G, a as a$1i, c as s$12, P as P$B, v as v$P, A as A$C, z as z$z, U as U$q, r as r$1A } from './promiseUtils-2ff2b194.js';
import { y as y$K, n as n$14, d as d$Q, g as h$T, G as u$15, x as r$1z, A as n$1F } from './subclass-fe5fcf78.js';
import { r as r$Y, n as n$12, q as c$W, y as y$M, z as i$S, B as a$$, t as t$17, k as l$W, v as v$M, c as s$U, C as y$Q, D as A$w, E as l$11, f as e$12, x as o$17, h as h$U, g as g$Y, F as t$1n, G as n$1p, a as s$17, e as e$19, H as s$1f, I as i$1f } from './Message-70b34921.js';
import { y as y$L, C as C$q, d as d$S, j as j$K, g as g$12, O as O$A, $ as $$m, x as x$V } from './watchUtils-06a91cc9.js';
import { m as m$12 } from './workers-bd1ea274.js';
import { i as i$U, x as x$Q, p as p$18, d as d$X, u as u$_, e as e$17, c as c$19, s as s$18 } from './SimpleLineSymbol-9959d1ea.js';
import { a as p$13, f as c$X, x as x$O, s as s$R, c as c$Y, b as b$G, d as d$V, g as g$11, p as p$1c, t as t$1u, e as e$1c } from './Point-ee7951c3.js';
import { _ as _$n, d as d$O, z as z$u, u as u$S, h as r$Z, n as n$11, c as c$V, o as o$R, F as F$v, j as j$F, i as t$_, k as r$_, a as o$S, q as q$o, s as s$P, H as H$m, x as x$N, I as I$x, m as p$12, g as b$F, v as F$w, w as w$B, A as d$P, B as k$z, N as N$o, C as m$V, p as p$16, y as y$N, e as s$T, D as x$P, L as L$u, J as J$l, Z as Z$j, X as X$g, E as v$N, S as S$C, G as f$R, K as u$Z, M as e$11, l as l$14, O as i$_, P as e$18, f as a$1j, Q as g$10, R as b$N, r as r$1q, T as G$p, U as i$1b, V as M$B, W as P$C, Y as u$1e, $ as f$12, a0 as l$1h, a1 as T$x, a2 as L$y } from './mathUtils-a477cc74.js';
import { v as v$T } from './HeightModelInfo-992659fb.js';
import { Z as Zn, y as yn, R as Rn, w as wn, d as dn, l as ln, S as Sn, x as xn, C as Cn, M as Mn, n as nn, G as Gn, _ as _n } from './projection-c73dd3c4.js';
import { G as G$m, p as p$15, e as O$C } from './unitUtils-b17203be.js';
import { i as i$P, o as o$U, g as g$U, B as B$m, R as R$t, x as x$R, M as M$y, c as c$14, F as F$A, h as h$S, A as A$y, f as f$X, y as y$T, u as u$16, k as k$F, w as w$H, D as D$u, j as j$L, a as a$1m, q as q$u, G as G$q } from './aaBoundingRect-68336c41.js';
import { r as r$X, c as c$U, s as s$O, v as v$K, A as A$t, b as b$E, l as l$U, n as n$1a, a as r$19, e as e$W, f as f$O, _ as _$q, h as h$Q, t as t$1g, d as l$13, g as l$18, k as k$D, i as g$W, u as u$11, j as l$1e, m as n$1s, o as b$O } from './DefaultMaterial_COLOR_GAMMA-7c4a23ef.js';
import { h as h$L, o as o$T, f as f$L, r as r$$, n as n$18, F as F$x, e as e$V, m as m$W, b as b$H, l as l$X, A as A$v, c as c$_, E as E$z, s as s$10, i as i$12, x as x$S, C as C$u } from './mat4-8eb66d33.js';
import { e as e$P, n as n$1b, r as r$1b, a as a$10, b as e$16, f as f$U, c as e$1f } from './vec33-d394808f.js';
import { O as O$z, e as e$O, k as k$w, n as n$15, t as t$10, r as r$11, a as r$12, b as e$S, c as t$11, d as n$16, o as o$X, f as t$12, u as u$U, i as i$R, g as d$R, h as t$15, j as e$U, l as i$T, v as v$L, V as V$l, w as w$C, m as r$1a, p as u$V, q as l$Y, _ as _$o, s as k$A, x as a$11, y as m$X, z as z$v, A as j$G, B as _$p, C as f$N, F as F$y, E as E$x, D as p$17, G as z$w, H as V$m, I as B$l, $ as $$k, J as f$P, T as T$u, Z as Z$k, K as r$1f, L as a$15, M as a$16, N as c$$, P as e$$, Q as o$10, R as d$Z, S as r$1g, U as l$Z, W as c$10, X as m$Z, Y as t$1f, a0 as o$11, a1 as g$V, a2 as a$17, a3 as o$12, a4 as l$_, a5 as c$11, a6 as a$18, a7 as c$12, a8 as f$Q, a9 as d$_, aa as V$n, ab as d$$, ac as u$Y, ad as a$1a, ae as y$P, af as c$13, ag as i$Y, ah as I$z, ai as B$o, aj as t$1i, ak as q$s, al as d$11, am as B$p, an as t$1j, ao as e$14, ap as r$1j, aq as r$1k, ar as u$$, as as a$1d, at as l$17, au as f$T, av as t$1k, aw as c$15, ax as i$$, ay as n$1m, az as e$15, aA as i$10, aB as u$10, aC as a$1e, aD as A$z, aE as a$1f, aF as a$1g, aG as t$1l, aH as o$16, aI as s$_, aJ as m$_, aK as p$1b, aL as y$R, aM as q$t, aN as n$1n, aO as i$11, aP as s$$, aQ as g$X, aR as y$S, aS as D$t, aT as S$E, aU as g$Z, aV as r$1m, aW as I$A, aX as C$s, aY as P$A, aZ as b$L, a_ as $$l, a$ as M$A, b0 as o$19, b1 as l$1b, b2 as o$1a, b3 as r$1o, b4 as r$1p, b5 as l$1c, b6 as l$1d, b7 as A$B, b8 as f$W, b9 as h$X, ba as x$U, bb as f$_, bc as i$19, bd as r$1s, be as O$B, bf as i$1a, bg as T$w, bh as s$1c, bi as f$10, bj as u$1b, bk as n$1u, bl as u$1c, bm as s$1d, bn as V$r, bo as L$x, bp as r$1u, bq as q$v, br as e$1b, bs as j$M, bt as l$1i, bu as i$1c, bv as d$18, bw as u$1f, bx as t$1s, by as t$1t, bz as r$1v, bA as r$1w, bB as n$1y, bC as a$1o, bD as o$1e, bE as o$1f, bF as F$E, bG as i$1d, bH as f$14, bI as j$O, bJ as K$l, bK as o$1g, bL as l$1k, bM as r$1y, bN as a$1p, bO as v$S } from './objectResourceUtils-59d1d140.js';
import { i as i$W } from './scaleUtils-10613b70.js';
import { u as u$T } from './Handles-af859b7b.js';
import { M as M$x, t as t$$, l as l$12, s as s$Z, a as o$13, j as j$H, u as u$18 } from './Polyline-ccd8fb47.js';
import { h as h$M } from './ElevationSampler-c8359e31.js';
import { k as k$x, a as k$y, P as P$y, o as o$Y } from './SpatialReference-843b1520.js';
import { S as S$A } from './TileInfo-c32d8db8.js';
import { e as e$R } from './reader-fa0f173d.js';
import { o as o$W } from './Color-ae84a22a.js';
import { r as r$10 } from './enumeration-7d0c165d.js';
import { q as c$Z, r as d$10, s as o$14, d as d$13, t as j$J, k as d$16, u as S$G, v as y$V } from './symbols-9e680ec7.js';
import { t as t$14 } from './testSVGPremultipliedAlpha-b5c775e7.js';
import { g as g$S, e as e$T, i as i$Q, r as r$13, a as r$15, f as f$M, h as h$O, t as t$1e, l as l$$, o as o$15, b as t$1m, c as i$15, s as s$13, n as n$1q, d as s$16, j as o$1c, k as e$1d, m as c$1c } from './FramebufferObject-238df962.js';
import { t as t$16, p as p$1g, f as f$15, D as D$v, i as i$1e, a as t$1v, d as d$19, w as w$J, e as e$1e } from './EdgeProcessingWorker-56aa1068.js';
import { A as A$u } from './InterleavedLayout-b66a6862.js';
import { t as t$13, n as n$17, r as r$14, a as a$1n } from './vec3f32-97630458.js';
import { r as r$16, n as n$1r } from './Texture-454f8135.js';
import { r as r$18, d as d$U, a as a$13, k as k$B, l as l$15, _ as _$r, A as A$A, o as o$18, s as s$15, g as g$$, b as b$M, y as y$W, q as q$w, p as p$1f } from './vec2-513a0296.js';
import { n as n$19, t as t$18, r as r$1n, f as f$11 } from './vec2f64-3fb878b3.js';
import { r as r$17, y as y$O, a as a$12, D as D$s, b as b$I, l as l$10, s as s$1b, I as I$C, j as j$N } from './vec4-8546ad05.js';
import { n as n$1c, a as a$1q } from './assets-73c8998f.js';
import { l as l$V } from './HandleOwner-fbf91095.js';
import { e as e$Y, n as n$1w } from './uid-6beaca4c.js';
import { n as n$1d } from './compilerUtils-7bbb76dc.js';
import { o as o$Z, a as a$19, j as j$I, u as u$12, p as p$1e, f as f$13, n as n$1A } from './mat3-6cb40036.js';
import { e as e$Z, w as w$I, a as e$1a, F as F$D } from './quat-44770d30.js';
import { r as r$1d } from './styleUtils-8b593a34.js';
import { t as t$1b, a as t$1c, s as s$W, b as a$14, h as h$P, c as s$1e } from './resources-8aaa4737.js';
import { r as r$1h } from './PromiseQueue-edaf4a34.js';
import { n as n$1k, a as a$1h } from './asyncUtils-015dfd6e.js';
import { p as p$19 } from './jsonUtils-f0a19240.js';
import { v as v$O, J as J$m, w as w$F } from './dehydratedFeatures-f49828b8.js';
import { createLabelFunction as f$Y } from './labelFormatUtils-d93dcf3e.js';
import { S as S$D, z as z$x, a as a$1c, q as q$r, w as w$E, B as B$n, p as p$1a, V as V$o, E as E$y, A as A$x, H as H$n, f as f$S, l as l$16, G as G$o, M as M$z, R as R$u, c as c$16, h as h$V, g as g$_, F as F$C, u as u$14, N as N$p, I as I$B, y as y$U, v as v$R, x as x$X } from './aaBoundingBox-c0155c39.js';
import { r as r$1i, n as n$1j } from './OperationalLayer-a01538e1.js';
import { a as a$1b, j as i$13 } from './fieldUtils-22be41cd.js';
import { t as t$1h, b as n$1l } from './vec2f32-556b449a.js';
import { e as e$13 } from './byteSizeEstimations-5b7ab251.js';
import { X as X$h } from './featureConversionUtils-3ad98dca.js';
import { r as r$1l } from './earcut-d81146f9.js';
import { T as T$v, i as i$14, b as b$K, l as l$1a, u as u$13, h as h$W, c as c$18, d as d$14, x as x$T, a as a$1k } from './BufferView-3733efba.js';
import { getVisualVariableValues as k$C } from './visualVariableUtils-86a9e524.js';
import { l as l$19, f as f$V, c as c$17 } from './MeshComponent-13ddf9e0.js';
import { d as d$12 } from './utils-4028018e.js';
import { s as s$11 } from './callExpressionWithFeature-28066cb0.js';
import { m as m$$ } from './lengthUtils-824a0190.js';
import { V as V$q, k as k$E, F as F$B, L as L$v, B as B$q } from './projection-7d8c2528.js';
import { s as s$14, t as t$1o } from './symbolLayerUtils3D-8a618a44.js';
import { t as t$1q, i as i$18, u as u$1a, o as o$1b, s as s$1a, l as l$1f, f as f$Z, n as n$1t, r as r$1r, m as m$10, c as c$1a, a as n$1B } from './rasterUtils-8b815ad2.js';
import { create as i$16 } from './geometryServiceUtils-83e1d118.js';
import { a as a$1l } from './ProjectParameters-0d0884dd.js';
import { i as i$17, s as s$19 } from './MemCache-b33cfc4b.js';
import { d as d$15, u as u$1d } from './VectorTile-a034e4bb.js';
import { p as p$1d } from './CollectionFlattener-af542a66.js';
import { o as o$1d } from './PopupTemplate-d97f5e88.js';
import { n as n$1v, a as n$1C } from './LercDecoder-00822609.js';
import { d as d$17 } from './LayerView-0b9de845.js';
import { n as n$1x, t as t$1r } from './quatf32-b1c8b796.js';
import { a as a$1r, l as l$1l, d as d$1a, n as n$1E, f as f$16 } from './screenshotUtils-abc7263a.js';
import { e as e$1g } from './capabilities-39806eb7.js';

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
function p$11(n=X$f){return [n[0],n[1],n[2],n[3]]}function j$E(n,t,r,c){return k$v(n,t,r,c,r$X.get())}function b$D(n,t=p$11()){return k$v(n[0],n[1],n[2],n[3],t)}function k$v(n,t,r,c,e=p$11()){return e[0]=n,e[1]=t,e[2]=r,e[3]=c,e}function v$J(n,t,c){return r$Z(c,n),c[3]=t,c}function y$J(n,t,o){r$Z(o,t);const u=z$u(t,t);return Math.abs(u-1)>1e-5&&u>1e-12&&d$O(o,o,1/Math.sqrt(u)),z$t(o,n,o)}function M$w(n,t,r,c=p$11()){return B$k(c$V(c$U.get(),n,t),c$V(c$U.get(),r,t),n,c)}function l$T(n,t,r,e,f){if(n.count<3)return !1;n.getVec(r,x$M);let s=e,a=!1;for(;s<n.count-1&&!a;)n.getVec(s,q$n),s++,a=!F$v(x$M,q$n);if(!a)return !1;for(s=Math.max(s,f),a=!1;s<n.count&&!a;)n.getVec(s,S$z),s++,c$V(U$o,x$M,q$n),j$F(U$o,U$o),c$V(w$A,q$n,S$z),j$F(w$A,w$A),a=!F$v(x$M,S$z)&&!F$v(q$n,S$z)&&Math.abs(z$u(U$o,w$A))<V$k;return a?(M$w(x$M,q$n,S$z,t),!0):(0!==r||1!==e||2!==f)&&l$T(n,t,0,1,2)}const V$k=.99619469809,x$M=n$11(),q$n=n$11(),S$z=n$11(),U$o=n$11(),w$A=n$11();function z$t(n,t,r){return n!==r&&b$D(n,r),r[3]=-z$u(W$j(r),t),r}function A$s(n,t){return t[0]=-n[0],t[1]=-n[1],t[2]=-n[2],t[3]=-n[3],t}function B$k(n,t,r,c){return y$J(r,_$n(S$z,t,n),c)}function D$q(n,r,c){return !!r$Y(r)&&T$t(n,r.origin,r.direction,Z$i,c)}function E$w(n,t,r){return T$t(n,t.origin,t.vector,0,r)}function F$u(n,t,r){return T$t(n,t.origin,t.vector,1,r)}function G$l(n,t){return R$s(n,O$z(t))-t[3]>=0}function I$w(n,t){return R$s(n,t)>=0}function J$k(n,t){return R$s(n,t)<0}function K$k(n,t){const r=t[0],c=t[1],e=t[2],o=t[3],u=t[4],i=t[5];return n[0]*(n[0]>0?r:o)+n[1]*(n[1]>0?c:u)+n[2]*(n[2]>0?e:i)+n[3]>=0}function L$s(n,t){const r=z$u(W$j(n),t.ray.direction),e=-R$s(n,t.ray.origin);if(e<0&&r>=0)return !1;if(r>-1e-6&&r<1e-6)return e>0;if((e<0||r<0)&&!(e<0&&r<0))return !0;const o=e/r;return r>0?o<t.c1&&(t.c1=o):o>t.c0&&(t.c0=o),t.c0<=t.c1}function O$y(n,t,r){const c=d$O(c$U.get(),W$j(n),-n[3]),u=P$x(n,c$V(c$U.get(),t,c),c$U.get());return u$S(r,u,c),r}function P$x(n,t,r){const u=d$O(c$U.get(),W$j(n),z$u(W$j(n),t));return c$V(r,t,u),r}function R$s(n,t){return z$u(W$j(n),t)+n[3]}function T$t(t,r,o,u,i){const f=z$u(W$j(t),o);if(0===f)return !1;let a=-(z$u(W$j(t),r)+t[3])/f;return 1&u&&(a=o$R(a,0,1)),!(!(4&u)&&a<0||!(8&u)&&a>1)&&(u$S(i,r,d$O(i,o,a)),!0)}function W$j(n){return n}const X$f=[0,0,1,0],Z$i=8;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
const L$r=n$12.getLogger("esri.views.3d.support.geometryUtils.boundedPlane");class z$s{constructor(){this.plane=p$11(),this.origin=n$11(),this.basis1=n$11(),this.basis2=n$11();}}function G$k(s=vs){return {plane:p$11(s.plane),origin:r$_(s.origin),basis1:r$_(s.basis1),basis2:r$_(s.basis2)}}function W$i(s,i,n){const t=Ss.get();return t.origin=s,t.basis1=i,t.basis2=n,t.plane=j$E(0,0,0,0),K$j(t),t}function D$p(s,i=G$k()){return J$j(s.origin,s.basis1,s.basis2,i)}function H$l(s,i){r$Z(i.origin,s.origin),r$Z(i.basis1,s.basis1),r$Z(i.basis2,s.basis2),b$D(s.plane,i.plane);}function J$j(s,i,n,t=G$k()){return r$Z(t.origin,s),r$Z(t.basis1,i),r$Z(t.basis2,n),K$j(t),ys(t,"fromValues()"),t}function K$j(s){B$k(s.basis2,s.basis1,s.origin,s.plane);}function Q$l(s,i,n){s!==n&&D$p(s,n);const t=d$O(c$U.get(),ms(s),i);return u$S(n.origin,n.origin,t),n.plane[3]-=i,n}function X$e(s,i,n){return Z$h(i,n),Q$l(n,gs(s,s.origin),n),n}function Z$h(s,i=G$k()){const n=(s[2]-s[0])/2,t=(s[3]-s[1])/2;return o$S(i.origin,s[0]+n,s[1]+t,0),o$S(i.basis1,n,0,0),o$S(i.basis2,0,t,0),k$v(0,0,1,0,i.plane),i}function $$j(s,i,n){return !!D$q(s.plane,i,n)&&hs(s,n)}function ss(s,i,n){if($$j(s,i,n))return n;const t=is(s,i,c$U.get());return u$S(n,i.origin,d$O(c$U.get(),i.direction,q$o(i.origin,t)/s$P(i.direction))),n}function is(s,n,t){const a=Ns.get();Ps(s,n,a,Ns.get());let r=Number.POSITIVE_INFINITY;for(const o of Ts){const e=Is(s,o,ws.get()),u=c$U.get();if(E$w(a,e,u)){const s=H$m(c$U.get(),n.origin,u),a=Math.abs(x$N(z$u(n.direction,s)));a<r&&(r=a,r$Z(t,u));}}return r===Number.POSITIVE_INFINITY?ns(s,n,t):t}function ns(s,i,n){if($$j(s,i,n))return n;const t=Ns.get(),a=Ns.get();Ps(s,i,t,a);let r=Number.POSITIVE_INFINITY;for(const o of Ts){const e=Is(s,o,ws.get()),u=c$U.get();if(F$u(t,e,u)){const s=k$w(i,u);if(!I$w(a,u))continue;s<r&&(r=s,r$Z(n,u));}}return rs(s,i.origin)<r&&ts(s,i.origin,n),n}function ts(s,i,n){const t=O$y(s.plane,i,c$U.get()),a=A$t(js(s,s.basis1),t,-1,1,c$U.get()),r=A$t(js(s,s.basis2),t,-1,1,c$U.get());return c$V(n,u$S(c$U.get(),a,r),s.origin),n}function as(s,i,n){const{origin:t,basis1:a,basis2:r}=s,o=c$V(c$U.get(),i,t),e=e$O(a,o),c=e$O(r,o),u=e$O(ms(s),o);return o$S(n,e,c,u)}function rs(s,i){const n=as(s,i,c$U.get()),{basis1:t,basis2:a}=s,r=s$P(t),o=s$P(a),e=Math.max(Math.abs(n[0])-r,0),c=Math.max(Math.abs(n[1])-o,0),u=n[2];return e*e+c*c+u*u}function os(s,i){return Math.sqrt(rs(s,i))}function es(s,i){let n=Number.NEGATIVE_INFINITY;for(const t of Ts){const a=Is(s,t,ws.get()),r=b$E(a,i);r>n&&(n=r);}return Math.sqrt(n)}function cs(s,i){return I$w(s.plane,i)&&hs(s,i)}function us(s,i,n,t){return ds(s,n,t)}function gs(s,i){const n=-s.plane[3];return e$O(ms(s),i)-n}function bs(s,i,n,t){const a=gs(s,i),r=d$O(Ms,ms(s),n-a);return u$S(t,i,r),t}function fs(s,i){return F$v(s.basis1,i.basis1)&&F$v(s.basis2,i.basis2)&&F$v(s.origin,i.origin)}function ls(s,i,n){return s!==n&&D$p(s,n),h$L(As,i),o$T(As,As),I$x(n.basis1,s.basis1,As),I$x(n.basis2,s.basis2,As),I$x(W$j(n.plane),W$j(s.plane),As),I$x(n.origin,s.origin,i),z$t(n.plane,n.origin,n.plane),n}function ps(s,i,n,t){return s!==t&&D$p(s,t),f$L(Vs,r$$(Vs),i,n),I$x(t.basis1,s.basis1,Vs),I$x(t.basis2,s.basis2,Vs),K$j(t),t}function ms(s){return W$j(s.plane)}function ds(s,i,n){switch(i){case 0:r$Z(n,s.basis1),j$F(n,n);break;case 1:r$Z(n,s.basis2),j$F(n,n);break;case 2:r$Z(n,ms(s));}return n}function hs(s,i){const n=c$V(c$U.get(),i,s.origin),t=p$12(s.basis1),a=p$12(s.basis2),r=z$u(s.basis1,n),o=z$u(s.basis2,n);return -r-t<0&&r-t<0&&-o-a<0&&o-a<0}function js(s,i){const n=ws.get();return r$Z(n.origin,s.origin),r$Z(n.vector,i),n}function Is(s,i,n){const{basis1:t,basis2:a,origin:r}=s,o=d$O(c$U.get(),t,i.origin[0]),e=d$O(c$U.get(),a,i.origin[1]);u$S(n.origin,o,e),u$S(n.origin,n.origin,r);const c=d$O(c$U.get(),t,i.direction[0]),b=d$O(c$U.get(),a,i.direction[1]);return d$O(n.vector,u$S(c,c,b),2),n}function ys(s,i){Math.abs(z$u(s.basis1,s.basis2)/(s$P(s.basis1)*s$P(s.basis2)))>1e-6&&L$r.warn(i,"Provided basis vectors are not perpendicular"),Math.abs(z$u(s.basis1,ms(s)))>1e-6&&L$r.warn(i,"Basis vectors and plane normal are not perpendicular"),Math.abs(-z$u(ms(s),s.origin)-s.plane[3])>1e-6&&L$r.warn(i,"Plane offset is not consistent with plane origin");}function Ps(s,i,n,t){const a=ms(s);B$k(a,i.direction,i.origin,n),B$k(W$j(n),a,i.origin,t);}const vs={plane:p$11(),origin:t$_(0,0,0),basis1:t$_(1,0,0),basis2:t$_(0,1,0)},Ns=new s$O(p$11),ws=new s$O(v$K),Ms=n$11(),Ss=new s$O((()=>({origin:null,basis1:null,basis2:null,plane:null}))),Ts=[{origin:[-1,-1],direction:[1,0]},{origin:[1,-1],direction:[0,1]},{origin:[1,1],direction:[-1,0]},{origin:[-1,1],direction:[0,-1]}],As=e$P(),Vs=e$P();var _s=Object.freeze({__proto__:null,BoundedPlaneClass:z$s,create:G$k,wrap:W$i,copy:D$p,copyWithoutVerify:H$l,fromValues:J$j,updateUnboundedPlane:K$j,elevate:Q$l,setExtent:X$e,fromAABoundingRect:Z$h,intersectRay:$$j,intersectRayClosestSilhouette:ss,closestPointOnSilhouette:is,closestPoint:ns,projectPoint:ts,projectPointLocal:as,distance2:rs,distance:os,distanceToSilhouette:es,extrusionContainsPoint:cs,axisAt:us,altitudeAt:gs,setAltitudeAt:bs,equals:fs,transform:ls,rotate:ps,normal:ms,UP:vs});

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
function e$N(e){return e&&"base-tile"===e.type||"tile"===e.type||"elevation"===e.type||"imagery-tile"===e.type||"base-elevation"===e.type||"open-street-map"===e.type||"wcs"===e.type||"web-tile"===e.type||"wmts"===e.type||"vector-tile"===e.type}function t$Z(e){return e.parent&&"esri.Basemap"===e.parent.declaredClass&&e.parent.baseLayers.indexOf(e)>-1}function a$Z(e){return !0===e.labelsVisible&&null!=e.labelingInfo&&e.labelingInfo.length>0}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
function t$Y(t){return "point"===t.type}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class t$X{constructor(e,r=null,t=0){this.array=e,this.spatialReference=r,this.offset=t;}}function a$Y(e){return "array"in e}function i$O(t,i,n="ground"){if(t$Y(i))return t.getElevation(i.x,i.y,i.z||0,i.spatialReference,n);if(a$Y(i)){let r=i.offset;return t.getElevation(i.array[r++],i.array[r++],i.array[r]||0,c$W(i.spatialReference,t.spatialReference),n)}return t.getElevation(i[0],i[1],i[2]||0,t.spatialReference,n)}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
const g$R=12;class x$L{constructor(e){const t=x$L.checkUnsupported(e);if(t)throw t;this.spatialReference=e.spatialReference,this._isWebMercator=this.spatialReference.isWebMercator,this._isGCS=Zn(this.spatialReference)||k$y(this.spatialReference)||P$y(this.spatialReference),this.origin=[e.origin.x,e.origin.y],this.pixelSize=e.size[0],this.dpi=e.dpi;const i=e.lods.reduce((function(e,t,i){return t.level<e.min&&(e.min=t.level,e.minIndex=i),e.max=Math.max(e.max,t.level),e}),{min:1/0,minIndex:0,max:-1/0}),s=e.lods[i.minIndex],r=2**s.level;let l=s.resolution*r,o=s.scale*r;this.levels=new Array(i.max+1);for(let n=0;n<this.levels.length;n++)this.levels[n]={resolution:l,scale:o,tileSize:[l*e.size[0],l*e.size[1]]},l/=2,o/=2;}clone(){return new x$L(this.toTileInfo())}toTileInfo(){return new S$A({dpi:this.dpi,origin:{x:this.origin[0],y:this.origin[1],spatialReference:this.spatialReference},size:[this.pixelSize,this.pixelSize],spatialReference:this.spatialReference,lods:this.levels.map(((e,t)=>({level:t,scale:e.scale,resolution:e.resolution})))})}getExtent(e,t,i,s){const r=this.levels[e],l=r.tileSize[0],o=r.tileSize[1];s[0]=this.origin[0]+i*l,s[2]=s[0]+l,s[3]=this.origin[1]-t*o,s[1]=s[3]-o;}convertExtentToRadians(e,i){this._isWebMercator?(i[0]=p$13(e[0]),i[1]=c$X(e[1]),i[2]=p$13(e[2]),i[3]=c$X(e[3])):this._isGCS&&(i[0]=b$F(e[0]),i[1]=b$F(e[1]),i[2]=b$F(e[2]),i[3]=b$F(e[3]));}getExtentGeometry(e,t,i,s=new M$x){return this.getExtent(e,t,i,v$I),s.spatialReference=this.spatialReference,s.xmin=v$I[0],s.ymin=v$I[1],s.xmax=v$I[2],s.ymax=v$I[3],s.zmin=void 0,s.zmax=void 0,s}ensureMaxLod(e){if(null==e)return !1;let t=!1;for(;this.levels.length<=e;){const e=this.levels[this.levels.length-1],i=e.resolution/2;this.levels.push({resolution:i,scale:e.scale/2,tileSize:[i*this.pixelSize,i*this.pixelSize]}),t=!0;}return t}capMaxLod(e){this.levels.length>e+1&&(this.levels.length=e+1);}getMaxLod(){return this.levels.length-1}scaleAtLevel(e){return this.levels[0].scale/2**e}levelAtScale(e){const t=this.levels[0].scale;return e>=t?0:Math.log(t/e)*Math.LOG2E}resolutionAtLevel(e){return this.levels[0].resolution/2**e}compatibleWith(e){if(!(e instanceof x$L)){if(x$L.checkUnsupported(e))return !1;e=new x$L(e);}if(!e.spatialReference.equals(this.spatialReference))return !1;if(e.pixelSize!==this.pixelSize)return !1;const t=Math.min(this.levels.length,e.levels.length)-1,s=this.levels[t].resolution;let r=.5*s;if(!F$w(e.origin[0],this.origin[0],r)||!F$w(e.origin[1],this.origin[1],r))return !1;return r=.5*s/2**t/this.pixelSize*g$R,F$w(s,e.levels[t].resolution,r)}rootTilesInExtent(e,t=null,i=1/0){const s=this.levels[0].tileSize;if(0===s[0]||0===s[1])return [];x$L.computeRowColExtent(e,s,this.origin,v$I);let l=v$I[1],o=v$I[3],n=v$I[0],a=v$I[2];const c=a-n,h=o-l;if(c*h>i){const e=Math.floor(Math.sqrt(i));h>e&&(l=l+Math.floor(.5*h)-Math.floor(.5*e),o=l+e),c>e&&(n=n+Math.floor(.5*c)-Math.floor(.5*e),a=n+e);}const u=[];for(let r=l;r<o;r++)for(let e=n;e<a;e++)u.push([0,r,e]);return r$Y(t)&&(t[0]=this.origin[0]+n*s[0],t[1]=this.origin[1]-o*s[1],t[2]=this.origin[0]+a*s[0],t[3]=this.origin[1]-l*s[1]),u}static computeRowColExtent(e,t,i,s){const r=.001*(e[2]-e[0]+(e[3]-e[1]));s[0]=Math.max(0,Math.floor((e[0]+r-i[0])/t[0])),s[2]=Math.max(0,Math.ceil((e[2]-r-i[0])/t[0])),s[1]=Math.max(0,Math.floor((i[1]-e[3]+r)/t[1])),s[3]=Math.max(0,Math.ceil((i[1]-e[1]-r)/t[1]));}static isPowerOfTwo(e){const t=e.lods,i=t[0].resolution*2**t[0].level;return !t.some((function(e){return !w$B(e.resolution,i/2**e.level)}))}static hasGapInLevels(e){const t=e.lods.map((function(e){return e.level}));t.sort((function(e,t){return e-t}));for(let i=1;i<t.length;i++)if(t[i]!==t[0]+i)return !0;return !1}static tileSizeSupported(e){const t=e.size[1];return t===e.size[0]&&0==(t&t-1)&&t>=128&&t<=512}static checkUnsupported(t){return t?t.lods.length<1?new s$Q("tilingscheme:generic","Tiling scheme must have at least one level"):x$L.isPowerOfTwo(t)?x$L.hasGapInLevels(t)?new s$Q("tilingscheme:gaps","Tiling scheme levels must not have gaps between min and max level"):x$L.tileSizeSupported(t)?null:new s$Q("tilingscheme:tile-size","Tiles must be square and size must be one of [128, 256, 512]"):new s$Q("tilingscheme:power-of-two","Tiling scheme must be power of two"):new s$Q("tilingscheme:tile-info-missing","Tiling scheme must have tiling information")}static fromExtent(e,t){const i=e[2]-e[0],s=e[3]-e[1],r=G$m(t),o=1.2*Math.max(i,s),n=256,a=96,c=.0254,h=new x$L(new S$A({size:[n,n],origin:{x:e[0]-.5*(o-i),y:e[3]+.5*(o-s)},lods:[{level:0,resolution:o/n,scale:1/(n/a*c/(o*r))}],spatialReference:t}));return h.ensureMaxLod(20),h}static makeWebMercatorAuxiliarySphere(e){const t=new x$L(x$L.WebMercatorAuxiliarySphereTileInfo);return t.ensureMaxLod(e),t}static makeGCSWithTileSize(e,t=256,i=16){const s=256/t,r=new x$L(new S$A({size:[t,t],origin:{x:-180,y:90,spatialReference:e},spatialReference:e,lods:[{level:0,resolution:.703125*s,scale:295497598.570834*s}]}));return r.ensureMaxLod(i),r}get test(){return {isWebMercator:this._isWebMercator,isGCS:this._isGCS}}}x$L.WebMercatorAuxiliarySphereTileInfo=new S$A({size:[256,256],origin:{x:-20037508.342787,y:20037508.342787,spatialReference:k$x.WebMercator},spatialReference:k$x.WebMercator,lods:[{level:0,resolution:156543.03392800014,scale:591657527.591555}]}),x$L.WebMercatorAuxiliarySphere=x$L.makeWebMercatorAuxiliarySphere(19);const v$I=i$P();

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
const o$Q=[0,1],I$v=64,e$M=512,C$p=2.5,n$10=d$P(k$z/10),r$W=4,E$v=4,s$N=i$P();x$L.WebMercatorAuxiliarySphere.getExtent(0,0,0,s$N);const T$s=i$P([-180,-90,180,90]),a$X="Cannot extend surface to encompass all layers because it would result in too many root tiles.",u$R="Surface extent is too large for tile resolution at level 0.",H$k="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAQAAAAEACAIAAADTED8xAAAACXBIWXMAAAsTAAALEwEAmpwYAAAKT2lDQ1BQaG90b3Nob3AgSUNDIHByb2ZpbGUAAHjanVNnVFPpFj333vRCS4iAlEtvUhUIIFJCi4AUkSYqIQkQSoghodkVUcERRUUEG8igiAOOjoCMFVEsDIoK2AfkIaKOg6OIisr74Xuja9a89+bN/rXXPues852zzwfACAyWSDNRNYAMqUIeEeCDx8TG4eQuQIEKJHAAEAizZCFz/SMBAPh+PDwrIsAHvgABeNMLCADATZvAMByH/w/qQplcAYCEAcB0kThLCIAUAEB6jkKmAEBGAYCdmCZTAKAEAGDLY2LjAFAtAGAnf+bTAICd+Jl7AQBblCEVAaCRACATZYhEAGg7AKzPVopFAFgwABRmS8Q5ANgtADBJV2ZIALC3AMDOEAuyAAgMADBRiIUpAAR7AGDIIyN4AISZABRG8lc88SuuEOcqAAB4mbI8uSQ5RYFbCC1xB1dXLh4ozkkXKxQ2YQJhmkAuwnmZGTKBNA/g88wAAKCRFRHgg/P9eM4Ors7ONo62Dl8t6r8G/yJiYuP+5c+rcEAAAOF0ftH+LC+zGoA7BoBt/qIl7gRoXgugdfeLZrIPQLUAoOnaV/Nw+H48PEWhkLnZ2eXk5NhKxEJbYcpXff5nwl/AV/1s+X48/Pf14L7iJIEyXYFHBPjgwsz0TKUcz5IJhGLc5o9H/LcL//wd0yLESWK5WCoU41EScY5EmozzMqUiiUKSKcUl0v9k4t8s+wM+3zUAsGo+AXuRLahdYwP2SycQWHTA4vcAAPK7b8HUKAgDgGiD4c93/+8//UegJQCAZkmScQAAXkQkLlTKsz/HCAAARKCBKrBBG/TBGCzABhzBBdzBC/xgNoRCJMTCQhBCCmSAHHJgKayCQiiGzbAdKmAv1EAdNMBRaIaTcA4uwlW4Dj1wD/phCJ7BKLyBCQRByAgTYSHaiAFiilgjjggXmYX4IcFIBBKLJCDJiBRRIkuRNUgxUopUIFVIHfI9cgI5h1xGupE7yAAygvyGvEcxlIGyUT3UDLVDuag3GoRGogvQZHQxmo8WoJvQcrQaPYw2oefQq2gP2o8+Q8cwwOgYBzPEbDAuxsNCsTgsCZNjy7EirAyrxhqwVqwDu4n1Y8+xdwQSgUXACTYEd0IgYR5BSFhMWE7YSKggHCQ0EdoJNwkDhFHCJyKTqEu0JroR+cQYYjIxh1hILCPWEo8TLxB7iEPENyQSiUMyJ7mQAkmxpFTSEtJG0m5SI+ksqZs0SBojk8naZGuyBzmULCAryIXkneTD5DPkG+Qh8lsKnWJAcaT4U+IoUspqShnlEOU05QZlmDJBVaOaUt2ooVQRNY9aQq2htlKvUYeoEzR1mjnNgxZJS6WtopXTGmgXaPdpr+h0uhHdlR5Ol9BX0svpR+iX6AP0dwwNhhWDx4hnKBmbGAcYZxl3GK+YTKYZ04sZx1QwNzHrmOeZD5lvVVgqtip8FZHKCpVKlSaVGyovVKmqpqreqgtV81XLVI+pXlN9rkZVM1PjqQnUlqtVqp1Q61MbU2epO6iHqmeob1Q/pH5Z/YkGWcNMw09DpFGgsV/jvMYgC2MZs3gsIWsNq4Z1gTXEJrHN2Xx2KruY/R27iz2qqaE5QzNKM1ezUvOUZj8H45hx+Jx0TgnnKKeX836K3hTvKeIpG6Y0TLkxZVxrqpaXllirSKtRq0frvTau7aedpr1Fu1n7gQ5Bx0onXCdHZ4/OBZ3nU9lT3acKpxZNPTr1ri6qa6UbobtEd79up+6Ynr5egJ5Mb6feeb3n+hx9L/1U/W36p/VHDFgGswwkBtsMzhg8xTVxbzwdL8fb8VFDXcNAQ6VhlWGX4YSRudE8o9VGjUYPjGnGXOMk423GbcajJgYmISZLTepN7ppSTbmmKaY7TDtMx83MzaLN1pk1mz0x1zLnm+eb15vft2BaeFostqi2uGVJsuRaplnutrxuhVo5WaVYVVpds0atna0l1rutu6cRp7lOk06rntZnw7Dxtsm2qbcZsOXYBtuutm22fWFnYhdnt8Wuw+6TvZN9un2N/T0HDYfZDqsdWh1+c7RyFDpWOt6azpzuP33F9JbpL2dYzxDP2DPjthPLKcRpnVOb00dnF2e5c4PziIuJS4LLLpc+Lpsbxt3IveRKdPVxXeF60vWdm7Obwu2o26/uNu5p7ofcn8w0nymeWTNz0MPIQ+BR5dE/C5+VMGvfrH5PQ0+BZ7XnIy9jL5FXrdewt6V3qvdh7xc+9j5yn+M+4zw33jLeWV/MN8C3yLfLT8Nvnl+F30N/I/9k/3r/0QCngCUBZwOJgUGBWwL7+Hp8Ib+OPzrbZfay2e1BjKC5QRVBj4KtguXBrSFoyOyQrSH355jOkc5pDoVQfujW0Adh5mGLw34MJ4WHhVeGP45wiFga0TGXNXfR3ENz30T6RJZE3ptnMU85ry1KNSo+qi5qPNo3ujS6P8YuZlnM1VidWElsSxw5LiquNm5svt/87fOH4p3iC+N7F5gvyF1weaHOwvSFpxapLhIsOpZATIhOOJTwQRAqqBaMJfITdyWOCnnCHcJnIi/RNtGI2ENcKh5O8kgqTXqS7JG8NXkkxTOlLOW5hCepkLxMDUzdmzqeFpp2IG0yPTq9MYOSkZBxQqohTZO2Z+pn5mZ2y6xlhbL+xW6Lty8elQfJa7OQrAVZLQq2QqboVFoo1yoHsmdlV2a/zYnKOZarnivN7cyzytuQN5zvn//tEsIS4ZK2pYZLVy0dWOa9rGo5sjxxedsK4xUFK4ZWBqw8uIq2Km3VT6vtV5eufr0mek1rgV7ByoLBtQFr6wtVCuWFfevc1+1dT1gvWd+1YfqGnRs+FYmKrhTbF5cVf9go3HjlG4dvyr+Z3JS0qavEuWTPZtJm6ebeLZ5bDpaql+aXDm4N2dq0Dd9WtO319kXbL5fNKNu7g7ZDuaO/PLi8ZafJzs07P1SkVPRU+lQ27tLdtWHX+G7R7ht7vPY07NXbW7z3/T7JvttVAVVN1WbVZftJ+7P3P66Jqun4lvttXa1ObXHtxwPSA/0HIw6217nU1R3SPVRSj9Yr60cOxx++/p3vdy0NNg1VjZzG4iNwRHnk6fcJ3/ceDTradox7rOEH0x92HWcdL2pCmvKaRptTmvtbYlu6T8w+0dbq3nr8R9sfD5w0PFl5SvNUyWna6YLTk2fyz4ydlZ19fi753GDborZ752PO32oPb++6EHTh0kX/i+c7vDvOXPK4dPKy2+UTV7hXmq86X23qdOo8/pPTT8e7nLuarrlca7nuer21e2b36RueN87d9L158Rb/1tWeOT3dvfN6b/fF9/XfFt1+cif9zsu72Xcn7q28T7xf9EDtQdlD3YfVP1v+3Njv3H9qwHeg89HcR/cGhYPP/pH1jw9DBY+Zj8uGDYbrnjg+OTniP3L96fynQ89kzyaeF/6i/suuFxYvfvjV69fO0ZjRoZfyl5O/bXyl/erA6xmv28bCxh6+yXgzMV70VvvtwXfcdx3vo98PT+R8IH8o/2j5sfVT0Kf7kxmTk/8EA5jz/GMzLdsAAAAgY0hSTQAAeiUAAICDAAD5/wAAgOkAAHUwAADqYAAAOpgAABdvkl/FRgAAA2JJREFUeNrs3d1O20AQgFFvRJInQLQBhHj/h0JVW34El1yQ2F73DVq3jTys55zrqUBbPrErZUSZ+vcOsto4AjK76Lqu1vr8+G3mPzjc3D/+eJj/Bcz/cd75R80fbu79BsAVCAQAAgABgABAACAAEAAIAAQAAgABQPOKfQAy83Ho+HnnHzXv49B4A4AAQAAgABAACAAEAAIAAYAAQAAgABAANM4+AKnZB4ifd/5R8/YB8AYAAYAAQAAgABAACAAEAAIAAYAAQAAgAGicfQBSsw8QP+/8o+btA+ANAAIAAYAAQAAgABAACAAEAAIAAYAAQADQOPsApGYfIH7e+UfN2wfAGwAEAAIAAYAAQAAgABAACAAEAAIAAXA201QdggAggH0AUrMPED8/jsPL03fns/y8fQC8AUAAIAAQAAgABAACAAGAAEAAIAAQAAgAGmcfgNTsA8TP2weImrcPgDcACAAEAAIAAYAAQAAgABAACAAEAAIAAUDj7AOQmn2A+Hn7AFHz9gHwBgABgABAACAAEAAIAAQAAgABgABgNS4cAf9pu9u3O1+m/n2aplKK/0j+TX86/tVP5+eZ3+729gFIfwWyDxA7bx8gat4+ANkJAAGAAEAAIAAQAAgABAACAAGAAEAAIABonn0AUrMPED9vHyBq3j4A3gAgABAACAAEAAIAAYAAQAAgABAA51VrdQgCAAHAsuwDkJp9gPj5vj+9vvx0PsvP2wfAGwAEAAIAAYAAQAAgABAACAAEAAIAAYAAoHH2AUjNPkD8vH2AqHn7AHgDgABAACAAEAAIAAQAAgABgABAACAAEAA0zj4AqdkHiJ+3DxA1bx8AbwAQACQ0DL0AyKuOowBwBYKUSikCIHUBAsAVCAQAAgABgABAALBy9gFIzT5A/Lx9gKj5y6trVyC8AUAAIAAQAAgAVq90Pg5N5gA2AsAVCAQAAgABgABAALB29gFIzT5A/Lx9gKj5q6+3rkB4A4AAQAAgABAACADWzB/IIHsCAsAVCARAlKlWhyAAEAAIABZjH4DU7APEz5+OH2+vT85n+fkvhztXILwBQAAgABAACAAEAGtWigBIHcBGALgCgQBAACAAyPMO9nHosxuHodZx5vB2t691HIdh/nx/Os7/Zsz/fvgXAAAA//8DAF1P1hM2ICMfAAAAAElFTkSuQmCC",V$j=5;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
const c$T=n$12.getLogger("esri.views.support.GroundViewElevationSampler");let u$Q=class extends n$13.EventedAccessor{constructor(e){super(e),this.demResolution={min:-1,max:-1},this.noDataValue=n$10;}initialize(){this.view.basemapTerrain.on("elevation-change",(()=>this.emit("changed",{})));}get extent(){const e=this.view.basemapTerrain;return e.extent&&e.spatialReference?o$U(e.extent,e.spatialReference):null}elevationAt(e){const t=e.spatialReference,r=this.spatialReference;if(!x$O(t,r)){const e=t?t.wkid:"unknown";return c$T.error(`Cannot sample elevation at a location with spatial reference (${e}) different from the view (${r.wkid})`),null}if(!t$$(this.extent,e)){const t=this.extent,r=`${t.xmin}, ${t.ymin}, ${t.xmax}, ${t.ymax}`;c$T.warn("#elevationAt()",`Point used to sample elevation (${e.x}, ${e.y}) is outside of the sampler extent (${r})`);}return i$O(this.view.elevationProvider,e)}queryElevation(e){return h$M(e.clone(),this)}};e$Q([y$K({readOnly:!0})],u$Q.prototype,"demResolution",void 0),e$Q([y$K({readOnly:!0})],u$Q.prototype,"extent",null),e$Q([y$K({readOnly:!0})],u$Q.prototype,"noDataValue",void 0),e$Q([y$K({readOnly:!0,aliasOf:"view.basemapTerrain.spatialReference"})],u$Q.prototype,"spatialReference",void 0),e$Q([y$K({constructOnly:!0})],u$Q.prototype,"view",void 0),u$Q=e$Q([n$14("esri.views.support.GroundViewElevationSampler")],u$Q);var d$N=u$Q;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
let p$10=class extends p$14{constructor(e){super(e),this.handles=new u$T,this.view=null,this.layerViews=new L$t;}initialize(){this.handles.add(y$L(this,"view.map.ground",(e=>e.load()))),this.handles.add(this.layerViews.on("after-changes",(()=>this.layerViewsAfterChangesHandler())));}destroy(){this._set("view",null),this.handles&&(this.handles.destroy(),this.handles=null);}get elevationSampler(){return this.view?"2d"===this.view.type?null:this.view.ready&&this.view.basemapTerrain&&this.view.basemapTerrain.ready?new d$N({view:this.view}):null:null}get updating(){return !this.suspended&&this.layerViews.some((e=>e.updating))}get suspended(){return !this.view||this.view.suspended}layerViewsAfterChangesHandler(){this.handles.remove("updating"),this.handles.add(this.layerViews.map((e=>e.watch("updating",(()=>this.updateUpdating()),!0))).toArray(),"updating"),this.updateUpdating();}updateUpdating(){this.notifyChange("updating");}};e$Q([y$K({readOnly:!0})],p$10.prototype,"elevationSampler",null),e$Q([y$K({type:Boolean,readOnly:!0})],p$10.prototype,"updating",null),e$Q([y$K({constructOnly:!0})],p$10.prototype,"view",void 0),e$Q([y$K({type:L$t,readOnly:!0})],p$10.prototype,"layerViews",void 0),e$Q([y$K({readOnly:!0})],p$10.prototype,"suspended",null),p$10=e$Q([n$14("esri.views.GroundView")],p$10);var l$S=p$10;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
function l$R(l){return "global"===l?1:2}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
const a$W=()=>import('./TileLayerView3D-6aa76987.js'),i$N=()=>Promise.resolve().then(function () { return ElevationLayerView3D; }),s$M={"base-dynamic":()=>import('./BaseDynamicLayerView3D-c3e8bb07.js'),"base-elevation":i$N,"base-tile":a$W,"bing-maps":a$W,"building-scene":()=>import('./BuildingSceneLayerView3D-f419071e.js'),csv:()=>import('./CSVLayerView3D-362aee29.js'),"direct-line-measurement":()=>import('./DirectLineMeasurementLayerView3D-1f47e6e9.js').then(function (n) { return n.D; }),"area-measurement":()=>import('./AreaMeasurementLayerView3D-0bdc6fc3.js').then(function (n) { return n.A; }),elevation:i$N,feature:()=>import('./FeatureLayerView3D-8c11fbdf.js'),geojson:()=>import('./GeoJSONLayerView3D-f7304e21.js'),graphics:()=>import('./GraphicsLayerView3D-ec4cf4f4.js'),group:()=>import('./GroupLayerView-c87e8b31.js'),imagery:()=>import('./ImageryLayerView3D-4850f617.js'),"integrated-mesh":()=>import('./IntegratedMeshLayerView3D-c7d5cb6a.js'),"line-of-sight":()=>import('./LineOfSightLayerView3D-dfbfcd73.js'),"map-image":()=>import('./MapImageLayerView3D-777e0a74.js'),"ogc-feature":()=>import('./OGCFeatureLayerView3D-8582bfa8.js'),"open-street-map":a$W,"point-cloud":()=>import('./PointCloudLayerView3D-0ca9caa3.js').then(function (n) { return n.P; }),voxel:()=>import('./VoxelLayerView3D-3fb0478b.js'),scene:e=>null==e.profile||"mesh-pyramids"===e.profile?import('./SceneLayerView3D-e89b05d8.js'):import('./SceneLayerGraphicsView3D-40514d04.js'),stream:()=>import('./StreamLayerView3D-50b74893.js'),tile:a$W,"imagery-tile":()=>import('./ImageryTileLayerView3D-3a2e1c83.js'),"vector-tile":()=>import('./VectorTileLayerView3D-b81d8544.js'),wcs:()=>import('./ImageryTileLayerView3D-3a2e1c83.js'),"web-tile":a$W,wfs:()=>import('./WFSLayerView3D-08801108.js'),wms:()=>import('./WMSLayerView3D-a22e540f.js'),wmts:()=>import('./WMTSLayerView3D-a52ecb1f.js'),slice:()=>import('./SliceLayerView3D-2f180a02.js').then(function (n) { return n.S; }),"geo-rss":null,kml:null,"map-notes":null,route:null,"subtype-group":null,unknown:null,unsupported:null};function t$W(r){const a=r.declaredClass?r.declaredClass.slice(r.declaredClass.lastIndexOf(".")+1):"Unknown",i=a.replace(/([a-z])([A-Z])/g,"$1-$2").toLowerCase();return new s$Q(`${i}:view-not-supported`,`${a} is not supported in 3D`)}const l$Q={hasLayerViewModule:e=>r$Y(s$M[e.type]),importLayerView:e=>{const a=s$M[e.type];if(!r$Y(a))throw t$W(e);return a(e)}};

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
const m$U=n$12.getLogger("esri.views.3d.state.Constraints");let c$S=class extends p$14{constructor(t){super(t),this.collision=new x$K,this.distance=1/0,this.minimumPoiDistance=4;}get altitude(){return 2===this.mode?null:this._get("altitude")||null}set altitude(t){2!==this.mode?this._set("altitude",t):m$U.warn("Altitude constraint is ignored in local scenes");}clampAltitude(t){return this.altitude?o$R(t,this.altitude.min,this.altitude.max):t}clampTilt(t,e){if(!this.tilt)return e;const i=this.tilt(t);return o$R(e,i.min,i.max)}clampDistance(t){return Math.min(t,this.distance)}createDefaultTilt(){return 2===this.mode?this.createDefaultTiltLocal():this.createDefaultTiltGlobal()}createConstantMaxTilt(t){return (e,i=h$K)=>(i.min=d$M.min,i.max=t,i)}createDefaultTiltLocal(){const t=this.collision.enabled?I$y([[4e3,d$M.max],[1e4,b$F(88)],[6e6,b$F(88)]]):()=>d$M.max;return (e,i=h$K)=>(i.min=d$M.min,i.max=t(e),i)}createDefaultTiltGlobal(){const t=this.collision.enabled?I$y([[4e3,d$M.max],[5e4,b$F(88)],[6e6,b$F(88)],[2e7,d$M.min]]):I$y([[3e5,d$M.max],[3e6,b$F(88)],[6e6,b$F(88)],[2e7,d$M.min]]);return (e,i=h$K)=>(i.min=d$M.min,i.max=t(e),i)}};function p$$(t){return {min:-2e5,max:4*t.radius}}e$Q([y$K()],c$S.prototype,"altitude",null),e$Q([y$K({readOnly:!0})],c$S.prototype,"collision",void 0),e$Q([y$K()],c$S.prototype,"distance",void 0),e$Q([y$K({readOnly:!0})],c$S.prototype,"minimumPoiDistance",void 0),e$Q([y$K()],c$S.prototype,"tilt",void 0),e$Q([y$K({constructOnly:!0})],c$S.prototype,"mode",void 0),c$S=e$Q([n$14("esri.views.3d.state.Constraints")],c$S);const u$P=p$$(s$R),d$M={min:b$F(.5),max:b$F(179.5)},h$K={min:0,max:0};let x$K=class extends p$14{constructor(){super(...arguments),this.enabled=!0,this.elevationMargin=5;}};e$Q([y$K({type:Boolean})],x$K.prototype,"enabled",void 0),e$Q([y$K({type:Number})],x$K.prototype,"elevationMargin",void 0),x$K=e$Q([n$14("esri.views.3d.state.Constraints.CollisionConstraint")],x$K);var f$K=c$S;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
let n$$=class extends p$14{constructor(){super(...arguments),this.min=u$P.min,this.max=u$P.max;}set mode(e){s$S(n$12.getLogger(this.declaredClass),"esri.views.SceneView.constraints.altitude.mode is deprecated. The altitude constraint no longer applies to local scenes and does not have an automatic mode anymore.",{version:"4.6"});}get mode(){return s$S(n$12.getLogger(this.declaredClass),"esri.views.SceneView.constraints.altitude.mode is deprecated. The altitude constraint no longer applies to local scenes and does not have an automatic mode anymore.",{version:"4.6"}),"manual"}};e$Q([y$K({type:Number})],n$$.prototype,"min",void 0),e$Q([y$K({type:Number})],n$$.prototype,"max",void 0),n$$=e$Q([n$14("esri.views.3d.constraints.AltitudeConstraint")],n$$);var c$R=n$$;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
let o$P=class extends p$14{constructor(){super(...arguments),this.mode="auto";}get near(){return this._get("near")}set near(t){this._set("near",t),t>=this._get("far")&&(this.far=t+1e-9),this.mode="manual";}castNear(t){return Math.max(1e-8,t)}get far(){return this._get("far")}set far(t){this._set("far",t),t<=this._get("near")&&(this.near=t-1e-9),this.mode="manual";}castFar(t){return Math.max(1e-8,t)}autoUpdate(t,r){"auto"===this.mode&&(this._get("near")!==t&&this._set("near",t),this._get("far")!==r&&this._set("far",r));}};e$Q([y$K({type:Number,value:1e-8})],o$P.prototype,"near",null),e$Q([c$Y("near")],o$P.prototype,"castNear",null),e$Q([y$K({type:Number,value:1e-8})],o$P.prototype,"far",null),e$Q([c$Y("far")],o$P.prototype,"castFar",null),e$Q([y$K({type:["auto","manual"]})],o$P.prototype,"mode",void 0),o$P=e$Q([n$14("esri.views.3d.constraints.ClipDistanceConstraint")],o$P);var p$_=o$P;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
const c$Q={min:N$o(d$M.min),max:N$o(d$M.max)};let i$M=class extends p$14{constructor(){super(...arguments),this.mode="auto";}get max(){return this._get("max")}set max(t){this._set("max",t),this.mode="manual";}castMax(t){return o$R(t,c$Q.min,c$Q.max)}autoUpdate(t){"auto"===this.mode&&this._get("max")!==t&&this._set("max",t);}};e$Q([y$K({type:["auto","manual"]})],i$M.prototype,"mode",void 0),e$Q([y$K({type:Number,value:c$Q.max})],i$M.prototype,"max",null),e$Q([c$Y("max")],i$M.prototype,"castMax",null),i$M=e$Q([n$14("esri.views.3d.constraints.TiltConstraint")],i$M);var u$O=i$M;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
let c$P=class extends p$14{constructor(){super(...arguments),this.tilt=new u$O,this.altitude=new c$R,this.clipDistance=new p$_;}};e$Q([y$K({type:u$O})],c$P.prototype,"tilt",void 0),e$Q([y$K({type:c$R})],c$P.prototype,"altitude",void 0),e$Q([y$K({type:p$_})],c$P.prototype,"clipDistance",void 0),c$P=e$Q([n$14("esri.views.3d.constraints.Constraints")],c$P);var a$V=c$P;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
var t$V;let i$L=t$V=class extends p$14{set quality(e){-1!==["low","high"].indexOf(e)&&this._set("quality",e);}clone(){return new t$V({quality:this.quality})}};e$Q([y$K({type:["low","high"],value:"low"})],i$L.prototype,"quality",null),i$L=t$V=e$Q([n$14("esri.views.3d.environment.SceneViewAtmosphere")],i$L);var p$Z=i$L;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
var d$L;let i$K=d$L=class extends a$_{constructor(e){super(e),this.date=null,this.directShadowsEnabled=!1,this.displayUTCOffset=null;}readDate(e,t){return null!=t.datetime&&new Date(t.datetime)||null}writeDate(e,t,r){t[r]=e.getTime();}readDirectShadowsEnabled(e,t){return !!t.directShadows}writedirectShadowsEnabled(e,t,r){e&&(t[r]=e);}writeDisplayUTCOffset(e,t){null!=e&&(t.displayUTCOffset=e);}clone(){return new d$L(this.cloneConstructProperties())}cloneConstructProperties(){const e={directShadowsEnabled:this.directShadowsEnabled,displayUTCOffset:null!=this.displayUTCOffset?this.displayUTCOffset:null};return null!=this.date&&(e.date=new Date(this.date.getTime())),e}};e$Q([y$K({type:Date,json:{type:Number,write:{target:"datetime"}}})],i$K.prototype,"date",void 0),e$Q([e$R("date",["datetime"])],i$K.prototype,"readDate",null),e$Q([o$V("date")],i$K.prototype,"writeDate",null),e$Q([y$K({type:Boolean,json:{default:!1,write:{target:"directShadows"}}})],i$K.prototype,"directShadowsEnabled",void 0),e$Q([e$R("directShadowsEnabled",["directShadows"])],i$K.prototype,"readDirectShadowsEnabled",null),e$Q([o$V("directShadowsEnabled")],i$K.prototype,"writedirectShadowsEnabled",null),e$Q([y$K({type:Number,json:{write:!0}})],i$K.prototype,"displayUTCOffset",void 0),e$Q([o$V("displayUTCOffset")],i$K.prototype,"writeDisplayUTCOffset",null),i$K=d$L=e$Q([n$14("esri.webscene.Lighting")],i$K);var p$Y=i$K;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
var s$L;let a$U=s$L=class extends(n$13.EventedMixin(p$Y)){constructor(e){super(e),this.positionTimezoneInfo={hours:0,minutes:0,seconds:0,autoUpdated:!0},this.cameraTrackingEnabled=!0,this.ambientOcclusionEnabled=!1,this.waterReflectionEnabled=!1;const t=(new Date).getFullYear(),o=new Date("March 15, "+t+" 12:00:00 UTC");this._set("defaultDate",o),this._set("date",o);}static fromWebsceneLighting(e){return new s$L({...e.cloneConstructProperties()})}get defaultDate(){return new Date(this._get("defaultDate").getTime())}set defaultDate(e){const t=this._get("date")===this._get("defaultDate");e=new Date(e.getTime()),this._set("defaultDate",e),t&&this._set("date",e);}set date(e){null!=e&&(this.positionTimezoneInfo.autoUpdated=!1,this._set("date",new Date(e.getTime())));}autoUpdate(e,t){const o=r$V(this.positionTimezoneInfo);this.positionTimezoneInfo.hours=t.hours,this.positionTimezoneInfo.minutes=t.minutes,this.positionTimezoneInfo.seconds=t.seconds;let n=null;null!=e&&(this.positionTimezoneInfo.autoUpdated=!0,n=this.date&&this.date.getTime(),this._set("date",new Date(e.getTime())));const i=r$V(this.positionTimezoneInfo);if(o!==i&&(d$K.target=this,d$K.timezoneOffset=i,this.emit("timezone-will-change",d$K)),null!=e)return n!==e.getTime()}clone(){const e=this._get("date")===this._get("defaultDate"),t=new s$L({...this.cloneConstructProperties(),defaultDate:this.defaultDate,cameraTrackingEnabled:this.cameraTrackingEnabled,ambientOcclusionEnabled:this.ambientOcclusionEnabled,waterReflectionEnabled:this.waterReflectionEnabled});return e&&t._set("date",t._get("defaultDate")),t.positionTimezoneInfo.autoUpdated=this.positionTimezoneInfo.autoUpdated,t.positionTimezoneInfo.hours=this.positionTimezoneInfo.hours,t.positionTimezoneInfo.minutes=this.positionTimezoneInfo.minutes,t.positionTimezoneInfo.seconds=this.positionTimezoneInfo.seconds,t}cloneWithWebsceneLighting(e){const t=this.clone();return null!=e.date&&(t.date=e.date),t.directShadowsEnabled=e.directShadowsEnabled,t.displayUTCOffset=e.displayUTCOffset,t}};function r$V({hours:e,minutes:t,seconds:o}){return Math.round(e+t/60+o/3600)}e$Q([y$K({type:Boolean})],a$U.prototype,"cameraTrackingEnabled",void 0),e$Q([y$K({type:Boolean})],a$U.prototype,"ambientOcclusionEnabled",void 0),e$Q([y$K({type:Boolean})],a$U.prototype,"waterReflectionEnabled",void 0),e$Q([y$K({type:Date})],a$U.prototype,"defaultDate",null),e$Q([y$K({type:Date})],a$U.prototype,"date",null),a$U=s$L=e$Q([n$14("esri.views.3d.environment.SceneViewLighting")],a$U);const d$K={target:null,timezoneOffset:0};

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
let t$U=class extends a$_{constructor(r){super(r);}clone(){}};e$Q([y$K({readOnly:!0,json:{read:!1}})],t$U.prototype,"type",void 0),t$U=e$Q([n$14("esri.webscene.background.Background")],t$U);var c$O=t$U;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
var l$P;const i$J={...c$Z,nonNullable:!0};let a$T=l$P=class extends c$O{constructor(o){super(o),this.type="color",this.color=new o$W([0,0,0,1]);}clone(){return new l$P(this.cloneProperties())}cloneProperties(){return {color:this.color.clone()}}};e$Q([r$10({color:"color"},{readOnly:!0})],a$T.prototype,"type",void 0),e$Q([y$K(i$J)],a$T.prototype,"color",void 0),a$T=l$P=e$Q([n$14("esri.webscene.background.ColorBackground")],a$T);var n$_=a$T;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
const o$O={base:c$O,key:"type",typeMap:{color:n$_}};function t$T(e){return (r,o,t)=>{if(!r)return r;for(const n in e.typeMap)if(r.type===n){const o=new e.typeMap[n];return o.read(r,t),o}}}const n$Z={types:o$O,json:{read:t$T(o$O),write:{overridePolicy:(e,r,o)=>({enabled:!o||!o.isPresentation})}}};

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
var p$X;const a$S=(o,r,e)=>({enabled:!e||!e.isPresentation});let l$O=p$X=class extends a$_{constructor(o){super(o),this.lighting=new p$Y,this.background=null,this.atmosphereEnabled=!0,this.starsEnabled=!0;}clone(){return new p$X(this.cloneConstructProperties())}cloneConstructProperties(){return {lighting:p$Y.prototype.clone.call(this.lighting),background:y$M(this.background),atmosphereEnabled:this.atmosphereEnabled,starsEnabled:this.starsEnabled}}};e$Q([y$K({type:p$Y,json:{write:!0}})],l$O.prototype,"lighting",void 0),e$Q([y$K(n$Z)],l$O.prototype,"background",void 0),e$Q([y$K({type:Boolean,nonNullable:!0,json:{write:{overridePolicy:a$S}}})],l$O.prototype,"atmosphereEnabled",void 0),e$Q([y$K({type:Boolean,nonNullable:!0,json:{write:{overridePolicy:a$S}}})],l$O.prototype,"starsEnabled",void 0),l$O=p$X=e$Q([n$14("esri.webscene.Environment")],l$O);var c$N=l$O;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
var a$R;let p$W=a$R=class extends c$N{constructor(e){super(e),this.atmosphere=new p$Z;}static fromWebsceneEnvironment(e){const t=e.cloneConstructProperties();return new a$R({...t,lighting:a$U.fromWebsceneLighting(t.lighting)})}castLighting(e){return this.convertLighting(e)}applyLighting(e){this.lighting=this.convertLighting(e);}convertLighting(e){return e?e instanceof a$U?e:e instanceof p$Y?this.lighting?this.lighting.cloneWithWebsceneLighting(e):a$U.fromWebsceneLighting(e):d$Q(a$U,e):new a$U}clone(){return new a$R({lighting:this.lighting.clone(),atmosphere:this.atmosphere.clone(),atmosphereEnabled:this.atmosphereEnabled,starsEnabled:this.starsEnabled,background:y$M(this.background)})}cloneWithWebsceneEnvironment(e){return new a$R({atmosphere:this.atmosphere.clone(),atmosphereEnabled:this.atmosphereEnabled,starsEnabled:this.starsEnabled,background:y$M(this.background),...e.cloneConstructProperties(),lighting:null!=this.lighting?this.lighting.cloneWithWebsceneLighting(e.lighting):a$U.fromWebsceneLighting(e.lighting)})}};e$Q([y$K({type:p$Z,json:{read:!1}})],p$W.prototype,"atmosphere",void 0),e$Q([y$K()],p$W.prototype,"lighting",void 0),e$Q([c$Y("lighting")],p$W.prototype,"castLighting",null),p$W=a$R=e$Q([n$14("esri.views.3d.environment.SceneViewEnvironment")],p$W);var l$N=p$W;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
function t$S(t){const r=new n$15;if(2===t.geometry)r.attributes.add("position","vec2"),r.varyings.add("color","vec4"),r.vertex.uniforms.add("lightingMainDirection","vec3").add("cameraPosition","vec3").add("undergroundFadeAlpha","float"),r.vertex.code.add(t$10`void main(void) {
float ndotl = dot(normalize(cameraPosition), lightingMainDirection);
float lighting = max(0.0, smoothstep(-1.0, 0.8, 2.0 * ndotl));
color = vec4(vec3(lighting), undergroundFadeAlpha);
gl_Position = vec4(position.xy, 1.0, 1.0);
}`),r.fragment.code.add(t$10`void main() {
gl_FragColor = color;
}`);else {r.include(r$11,{linearDepth:!1}),r.attributes.add("position","vec3"),r.varyings.add("vtc","vec2"),r.varyings.add("falloff","float");const i=1===t.geometry;r.vertex.uniforms.add("proj","mat4").add("view","mat4").add("lightingMainDirection","vec3"),i||(r.varyings.add("innerFactor","float"),r.vertex.uniforms.add("silCircleCenter","vec3").add("silCircleV1","vec3").add("silCircleV2","vec3").add("texV","vec2").add("innerScale","float"));const a=6.2831853,n=1/128;r.vertex.code.add(t$10`
		void main(void) {
      ${i?t$10`
      vec3 pos = position;
      float ndotl = lightingMainDirection.z;
      vtc = vec2(0.0, position.z + 0.05);`:t$10`
      innerFactor = clamp(-position.z, 0.0, 1.0);
      float scale = position.y * (1.0 + innerFactor * innerScale);
      float phi = position.x * ${t$10.float(a*n)} + 1.0;
      vec3 pos =  (silCircleCenter + sin(phi) * silCircleV1 + cos(phi) * silCircleV2) * scale;
      float ndotl = dot(normalize(position.y > 0.0 ? pos: silCircleCenter), lightingMainDirection);
      vtc.x = position.x  * ${t$10.float(n)};
      vtc.y = texV.x * (1.0 - position.z) + texV.y * position.z;
      `}
      falloff = max(0.0, smoothstep(-1.0, 0.8, 2.0 * ndotl));

		  gl_Position = transformPosition(proj, view, pos);
		  gl_Position.z = gl_Position.w; // project atmosphere onto the far plane
    }
	  `),r.fragment.uniforms.add("tex","sampler2D"),i||r.fragment.uniforms.add("altitudeFade","float"),r.fragment.code.add(t$10`
		void main() {
			vec4 atmosphereColor = texture2D(tex, vtc) * falloff;
      ${i?t$10`gl_FragColor = atmosphereColor;`:t$10`
			vec4 innerColor = vec4(atmosphereColor.rgb, 1.0 - altitudeFade);
			gl_FragColor = mix(atmosphereColor, innerColor, smoothstep(0.0, 1.0, innerFactor));
      `}
    }`);}return r}var r$U=Object.freeze({__proto__:null,build:t$S});

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class h$J extends t$11{initializeProgram(e){const r=h$J.shader.get(),i=this.configuration,t=r.build({geometry:i.geometry});return new n$16(e.rctx,t,o$X)}initializePipeline(){return 1===this.configuration.geometry?g$S({blending:e$T(770,1,771,771),culling:i$Q,depthTest:{func:515},colorWrite:r$13}):g$S({blending:e$T(770,1,771,771),depthTest:{func:515},colorWrite:r$13})}}h$J.shader=new t$12(r$U,(()=>import('./SimpleAtmosphere.glsl-f5c47b6c.js')));class u$N extends e$S{constructor(){super(...arguments),this.geometry=0;}}e$Q([r$12({count:3})],u$N.prototype,"geometry",void 0);

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
var A$r="data:image/png;base64, iVBORw0KGgoAAAANSUhEUgAAAAEAAAIACAYAAABD1gYFAAAACXBIWXMAAC4jAAAuIwF4pT92AAAKT2lDQ1BQaG90b3Nob3AgSUNDIHByb2ZpbGUAAHjanVNnVFPpFj333vRCS4iAlEtvUhUIIFJCi4AUkSYqIQkQSoghodkVUcERRUUEG8igiAOOjoCMFVEsDIoK2AfkIaKOg6OIisr74Xuja9a89+bN/rXXPues852zzwfACAyWSDNRNYAMqUIeEeCDx8TG4eQuQIEKJHAAEAizZCFz/SMBAPh+PDwrIsAHvgABeNMLCADATZvAMByH/w/qQplcAYCEAcB0kThLCIAUAEB6jkKmAEBGAYCdmCZTAKAEAGDLY2LjAFAtAGAnf+bTAICd+Jl7AQBblCEVAaCRACATZYhEAGg7AKzPVopFAFgwABRmS8Q5ANgtADBJV2ZIALC3AMDOEAuyAAgMADBRiIUpAAR7AGDIIyN4AISZABRG8lc88SuuEOcqAAB4mbI8uSQ5RYFbCC1xB1dXLh4ozkkXKxQ2YQJhmkAuwnmZGTKBNA/g88wAAKCRFRHgg/P9eM4Ors7ONo62Dl8t6r8G/yJiYuP+5c+rcEAAAOF0ftH+LC+zGoA7BoBt/qIl7gRoXgugdfeLZrIPQLUAoOnaV/Nw+H48PEWhkLnZ2eXk5NhKxEJbYcpXff5nwl/AV/1s+X48/Pf14L7iJIEyXYFHBPjgwsz0TKUcz5IJhGLc5o9H/LcL//wd0yLESWK5WCoU41EScY5EmozzMqUiiUKSKcUl0v9k4t8s+wM+3zUAsGo+AXuRLahdYwP2SycQWHTA4vcAAPK7b8HUKAgDgGiD4c93/+8//UegJQCAZkmScQAAXkQkLlTKsz/HCAAARKCBKrBBG/TBGCzABhzBBdzBC/xgNoRCJMTCQhBCCmSAHHJgKayCQiiGzbAdKmAv1EAdNMBRaIaTcA4uwlW4Dj1wD/phCJ7BKLyBCQRByAgTYSHaiAFiilgjjggXmYX4IcFIBBKLJCDJiBRRIkuRNUgxUopUIFVIHfI9cgI5h1xGupE7yAAygvyGvEcxlIGyUT3UDLVDuag3GoRGogvQZHQxmo8WoJvQcrQaPYw2oefQq2gP2o8+Q8cwwOgYBzPEbDAuxsNCsTgsCZNjy7EirAyrxhqwVqwDu4n1Y8+xdwQSgUXACTYEd0IgYR5BSFhMWE7YSKggHCQ0EdoJNwkDhFHCJyKTqEu0JroR+cQYYjIxh1hILCPWEo8TLxB7iEPENyQSiUMyJ7mQAkmxpFTSEtJG0m5SI+ksqZs0SBojk8naZGuyBzmULCAryIXkneTD5DPkG+Qh8lsKnWJAcaT4U+IoUspqShnlEOU05QZlmDJBVaOaUt2ooVQRNY9aQq2htlKvUYeoEzR1mjnNgxZJS6WtopXTGmgXaPdpr+h0uhHdlR5Ol9BX0svpR+iX6AP0dwwNhhWDx4hnKBmbGAcYZxl3GK+YTKYZ04sZx1QwNzHrmOeZD5lvVVgqtip8FZHKCpVKlSaVGyovVKmqpqreqgtV81XLVI+pXlN9rkZVM1PjqQnUlqtVqp1Q61MbU2epO6iHqmeob1Q/pH5Z/YkGWcNMw09DpFGgsV/jvMYgC2MZs3gsIWsNq4Z1gTXEJrHN2Xx2KruY/R27iz2qqaE5QzNKM1ezUvOUZj8H45hx+Jx0TgnnKKeX836K3hTvKeIpG6Y0TLkxZVxrqpaXllirSKtRq0frvTau7aedpr1Fu1n7gQ5Bx0onXCdHZ4/OBZ3nU9lT3acKpxZNPTr1ri6qa6UbobtEd79up+6Ynr5egJ5Mb6feeb3n+hx9L/1U/W36p/VHDFgGswwkBtsMzhg8xTVxbzwdL8fb8VFDXcNAQ6VhlWGX4YSRudE8o9VGjUYPjGnGXOMk423GbcajJgYmISZLTepN7ppSTbmmKaY7TDtMx83MzaLN1pk1mz0x1zLnm+eb15vft2BaeFostqi2uGVJsuRaplnutrxuhVo5WaVYVVpds0atna0l1rutu6cRp7lOk06rntZnw7Dxtsm2qbcZsOXYBtuutm22fWFnYhdnt8Wuw+6TvZN9un2N/T0HDYfZDqsdWh1+c7RyFDpWOt6azpzuP33F9JbpL2dYzxDP2DPjthPLKcRpnVOb00dnF2e5c4PziIuJS4LLLpc+Lpsbxt3IveRKdPVxXeF60vWdm7Obwu2o26/uNu5p7ofcn8w0nymeWTNz0MPIQ+BR5dE/C5+VMGvfrH5PQ0+BZ7XnIy9jL5FXrdewt6V3qvdh7xc+9j5yn+M+4zw33jLeWV/MN8C3yLfLT8Nvnl+F30N/I/9k/3r/0QCngCUBZwOJgUGBWwL7+Hp8Ib+OPzrbZfay2e1BjKC5QRVBj4KtguXBrSFoyOyQrSH355jOkc5pDoVQfujW0Adh5mGLw34MJ4WHhVeGP45wiFga0TGXNXfR3ENz30T6RJZE3ptnMU85ry1KNSo+qi5qPNo3ujS6P8YuZlnM1VidWElsSxw5LiquNm5svt/87fOH4p3iC+N7F5gvyF1weaHOwvSFpxapLhIsOpZATIhOOJTwQRAqqBaMJfITdyWOCnnCHcJnIi/RNtGI2ENcKh5O8kgqTXqS7JG8NXkkxTOlLOW5hCepkLxMDUzdmzqeFpp2IG0yPTq9MYOSkZBxQqohTZO2Z+pn5mZ2y6xlhbL+xW6Lty8elQfJa7OQrAVZLQq2QqboVFoo1yoHsmdlV2a/zYnKOZarnivN7cyzytuQN5zvn//tEsIS4ZK2pYZLVy0dWOa9rGo5sjxxedsK4xUFK4ZWBqw8uIq2Km3VT6vtV5eufr0mek1rgV7ByoLBtQFr6wtVCuWFfevc1+1dT1gvWd+1YfqGnRs+FYmKrhTbF5cVf9go3HjlG4dvyr+Z3JS0qavEuWTPZtJm6ebeLZ5bDpaql+aXDm4N2dq0Dd9WtO319kXbL5fNKNu7g7ZDuaO/PLi8ZafJzs07P1SkVPRU+lQ27tLdtWHX+G7R7ht7vPY07NXbW7z3/T7JvttVAVVN1WbVZftJ+7P3P66Jqun4lvttXa1ObXHtxwPSA/0HIw6217nU1R3SPVRSj9Yr60cOxx++/p3vdy0NNg1VjZzG4iNwRHnk6fcJ3/ceDTradox7rOEH0x92HWcdL2pCmvKaRptTmvtbYlu6T8w+0dbq3nr8R9sfD5w0PFl5SvNUyWna6YLTk2fyz4ydlZ19fi753GDborZ752PO32oPb++6EHTh0kX/i+c7vDvOXPK4dPKy2+UTV7hXmq86X23qdOo8/pPTT8e7nLuarrlca7nuer21e2b36RueN87d9L158Rb/1tWeOT3dvfN6b/fF9/XfFt1+cif9zsu72Xcn7q28T7xf9EDtQdlD3YfVP1v+3Njv3H9qwHeg89HcR/cGhYPP/pH1jw9DBY+Zj8uGDYbrnjg+OTniP3L96fynQ89kzyaeF/6i/suuFxYvfvjV69fO0ZjRoZfyl5O/bXyl/erA6xmv28bCxh6+yXgzMV70VvvtwXfcdx3vo98PT+R8IH8o/2j5sfVT0Kf7kxmTk/8EA5jz/GMzLdsAAAAgY0hSTQAAeiUAAICDAAD5/wAAgOkAAHUwAADqYAAAOpgAABdvkl/FRgAAAXVJREFUeNq0k9GWhDAIQ3PjzP9/cuehFqhW19mz++IhkCZAq1prsqT+kSQS9g8Vnqp6VGVWkYVktR6tj3Gr968nLnfwlHzHYyHapkKS73bPd/39eI38AYWj24OGvqdwWjZ3l8IDgacXyl1Dj9tdLOzZiicj+P1YcGk0H2O2vN/VQpTveEHmPHQxZxYlqsQdhUeuCWREuDEvAjqlCqDIMYwIo2ijR1HdYUS58dQrKpgQ0EGeMocsTNXrxzyOhS9kfzlWjn82YuWLqwAnvfNEWJFjYXkJCT0s7AmS0NG4x7Lt6Cpy2MiVPBZmS668QT5AR1cevp7b6CpzQ/ZSNH0vmhy5CsNtdax0MBpXDBiFsrDiMSLKMc8b6hH93bNbEpRsIyHDUhNcfTyeKF16PC7c/2QdczvUnvOB1ylZHVFSMtd5s8C2IW/7w6hwM5GLavLCd1zkiFjB+BwH1DSgctQ7mPOimBLJrw35beSXkd8BM/cCqbXWPgMA+GQQ5sIgkfAAAAAASUVORK5CYII=";

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
var n$Y;!function(n){function t(n,t){const c=n[t],o=n[t+1],r=n[t+2];return Math.sqrt(c*c+o*o+r*r)}function c(n,t){const c=n[t],o=n[t+1],r=n[t+2],u=1/Math.sqrt(c*c+o*o+r*r);n[t]*=u,n[t+1]*=u,n[t+2]*=u;}function o(n,t,c){n[t]*=c,n[t+1]*=c,n[t+2]*=c;}function r(n,t,c,o,r,u=t){(r=r||n)[u]=n[t]+c[o],r[u+1]=n[t+1]+c[o+1],r[u+2]=n[t+2]+c[o+2];}function u(n,t,c,o,r,u=t){(r=r||n)[u]=n[t]-c[o],r[u+1]=n[t+1]-c[o+1],r[u+2]=n[t+2]-c[o+2];}n.length=t,n.normalize=c,n.scale=o,n.add=r,n.subtract=u;}(n$Y||(n$Y={}));

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
const x$J=n$Y;var z$r,M$v,U$n,b$C;!function(t){const e=.5,n=[[-e,-e,e],[e,-e,e],[e,e,e],[-e,e,e],[-e,-e,-e],[e,-e,-e],[e,e,-e],[-e,e,-e]],o=[0,0,1,-1,0,0,1,0,0,0,-1,0,0,1,0,0,0,-1],r=[0,0,1,0,1,1,0,1],a=new Uint16Array([0,1,2,2,3,0,4,0,3,3,7,4,1,5,6,6,2,1,1,0,4,4,5,1,3,2,6,6,7,3,5,4,7,7,6,5]),s=new Uint16Array(36);for(let c=0;c<6;c++)for(let t=0;t<6;t++)s[6*c+t]=c;const i=new Uint16Array(36);for(let c=0;c<6;c++)i[6*c+0]=0,i[6*c+1]=1,i[6*c+2]=2,i[6*c+3]=2,i[6*c+4]=3,i[6*c+5]=0;function l(t){Array.isArray(t)||(t=[t,t,t]);const e=new Array(24);for(let o=0;o<8;o++)e[3*o]=n[o][0]*t[0],e[3*o+1]=n[o][1]*t[1],e[3*o+2]=n[o][2]*t[2];return new u$U([["position",{size:3,data:e,exclusive:!0}],["normal",{size:3,data:o}],["uv0",{size:2,data:r}]],[["position",a],["normal",s],["uv0",i]])}t.createGeometry=l;}(z$r||(z$r={})),function(t){const e=.5,n=[[-e,0,-e],[e,0,-e],[e,0,e],[-e,0,e],[0,-e,0],[0,e,0]],o=[0,1,-1,1,1,0,0,1,1,-1,1,0,0,-1,-1,1,-1,0,0,-1,1,-1,-1,0],r=new Uint16Array([5,1,0,5,2,1,5,3,2,5,0,3,4,0,1,4,1,2,4,2,3,4,3,0]),a=new Uint16Array([0,0,0,1,1,1,2,2,2,3,3,3,4,4,4,5,5,5,6,6,6,7,7,7]);function s(t){Array.isArray(t)||(t=[t,t,t]);const e=new Array(18);for(let o=0;o<6;o++)e[3*o]=n[o][0]*t[0],e[3*o+1]=n[o][1]*t[1],e[3*o+2]=n[o][2]*t[2];return new u$U([["position",{size:3,data:e,exclusive:!0}],["normal",{size:3,data:o}]],[["position",r],["normal",a]])}t.createGeometry=s;}(M$v||(M$v={})),function(o){const r=.5,a=0,s=t$13(-r,a,-r),i=t$13(r,a,-r),l=t$13(0,a,r),f=t$13(0,a+r,0),h=n$17(),y=n$17(),m=n$17(),p=n$17(),g=n$17();c$V(h,s,f),c$V(y,s,i),_$n(m,h,y),j$F(m,m),c$V(h,i,f),c$V(y,i,l),_$n(p,h,y),j$F(p,p),c$V(h,l,f),c$V(y,l,s),_$n(g,h,y),j$F(g,g);const A=[s,i,l,f],w=[0,-1,0,m[0],m[1],m[2],p[0],p[1],p[2],g[0],g[1],g[2]],v=[0,1,2,3,1,0,3,2,1,3,0,2],x=[0,0,0,1,1,1,2,2,2,3,3,3];function z(t){Array.isArray(t)||(t=[t,t,t]);const e=new Array(12);for(let n=0;n<4;n++)e[3*n]=A[n][0]*t[0],e[3*n+1]=A[n][1]*t[1],e[3*n+2]=A[n][2]*t[2];return new u$U([["position",{size:3,data:e,exclusive:!0}],["normal",{size:3,data:w}]],[["position",new Uint16Array(v)],["normal",new Uint16Array(x)]])}o.createGeometry=z;}(U$n||(U$n={})),function(A){function b(t,e,n,o={uv:!0}){const r=-Math.PI,a=2*Math.PI,s=-Math.PI/2,i=Math.PI,l=Math.max(3,Math.floor(e)),c=Math.max(2,Math.floor(n)),u=(l+1)*(c+1),f=new Float32Array(3*u),h=new Float32Array(3*u),y=new Float32Array(2*u),m=[];let p=0;for(let d=0;d<=c;d++){const e=[],n=d/c,o=s+n*i,u=Math.cos(o);for(let s=0;s<=l;s++){const i=s/l,c=r+i*a,m=Math.cos(c)*u,g=Math.sin(o),A=-Math.sin(c)*u;f[3*p]=m*t,f[3*p+1]=g*t,f[3*p+2]=A*t,h[3*p]=m,h[3*p+1]=g,h[3*p+2]=A,y[2*p]=i,y[2*p+1]=n,e.push(p),++p;}m.push(e);}const g=new Uint32Array(2*l*(c-1)*3);p=0;for(let d=0;d<c;d++)for(let t=0;t<l;t++){const e=m[d][t],n=m[d][t+1],o=m[d+1][t+1],r=m[d+1][t];0===d?(g[p++]=e,g[p++]=o,g[p++]=r):d===c-1?(g[p++]=e,g[p++]=n,g[p++]=o):(g[p++]=e,g[p++]=n,g[p++]=o,g[p++]=o,g[p++]=r,g[p++]=e);}const A=[["position",g],["normal",g]],w=[["position",{size:3,data:f,exclusive:!0}],["normal",{size:3,data:h,exclusive:!0}]];return o.uv&&(w.push(["uv0",{size:2,data:y,exclusive:!0}]),A.push(["uv0",g])),o.offset&&(A[0][0]="offset",w[0][0]="offset",A.push(["position",new Uint32Array(g.length)]),w.push(["position",{size:3,data:Float64Array.from(o.offset),exclusive:!0}])),new u$U(w,A)}function P(t,e,n){const o=t;let r,a;if(n)r=[0,-1,0,1,0,0,0,0,1,-1,0,0,0,0,-1,0,1,0],a=new Uint32Array([0,1,2,0,2,3,0,3,4,0,4,1,1,5,2,2,5,3,3,5,4,4,5,1]);else {const t=o*(1+Math.sqrt(5))/2;r=[-o,t,0,o,t,0,-o,-t,0,o,-t,0,0,-o,t,0,o,t,0,-o,-t,0,o,-t,t,0,-o,t,0,o,-t,0,-o,-t,0,o],a=new Uint32Array([0,11,5,0,5,1,0,1,7,0,7,10,0,10,11,1,5,9,5,11,4,11,10,2,10,7,6,7,1,8,3,9,4,3,4,2,3,2,6,3,6,8,3,8,9,4,9,5,2,4,11,6,2,10,8,6,7,9,8,1]);}for(let f=0;f<r.length;f+=3)x$J.scale(r,f,t/x$J.length(r,f));let s={};function i(e,n){e>n&&([e,n]=[n,e]);const o=e.toString()+"."+n.toString();if(s[o])return s[o];let a=r.length;return r.length+=3,x$J.add(r,3*e,r,3*n,r,a),x$J.scale(r,a,t/x$J.length(r,a)),a/=3,s[o]=a,a}for(let f=0;f<e;f++){const t=a.length,e=new Uint32Array(4*t);for(let n=0;n<t;n+=3){const t=a[n],o=a[n+1],r=a[n+2],s=i(t,o),l=i(o,r),c=i(r,t),u=4*n;e[u]=t,e[u+1]=s,e[u+2]=c,e[u+3]=o,e[u+4]=l,e[u+5]=s,e[u+6]=r,e[u+7]=c,e[u+8]=l,e[u+9]=s,e[u+10]=l,e[u+11]=c;}a=e,s={};}const l=new Float32Array(r);for(let f=0;f<l.length;f+=3)x$J.normalize(l,f);const c=[["position",a],["normal",a]],u=[["position",{size:3,data:new Float32Array(r),exclusive:!0}],["normal",{size:3,data:l,exclusive:!0}]];return new u$U(u,c)}function I(t,e,n,o,r,a,s){const i=e?[e[0],e[1],e[2]]:[0,0,0],l=t?[t[0],t[1],t[2]]:[0,0,1];a=a||[0,0];const c=n?[255*n[0],255*n[1],255*n[2],n.length>3?255*n[3]:255]:[255,255,255,255],u=null!=o&&2===o.length?o:[1,1],f=[["position",{size:3,data:i,exclusive:!0}],["normal",{size:3,data:l,exclusive:!0}],["uv0",{size:a.length,data:a}],["color",{size:4,data:c,exclusive:!0}],["size",{size:2,data:u}]];if(null!=r){const t=new Float32Array([r[0],r[1],r[2],r[3]]);f.push(["auxpos1",{size:4,data:t}]);}if(null!=s){const t=new Float32Array([s[0],s[1],s[2],s[3]]);f.push(["auxpos2",{size:4,data:t}]);}return new u$U(f,null,1)}function j(t,e,n,o,r,a,s,i){if(null!=t){const{data:e}=i.getMutableAttribute("normal");e[0]=t[0],e[1]=t[1],e[2]=t[2];}if(null!=e){const{data:t}=i.getMutableAttribute("position");t[0]=e[0],t[1]=e[1],t[2]=e[2];}if(null!=n){const{data:t}=i.getMutableAttribute("color");t[0]=n[0],t[1]=n[1],t[2]=n[2],t[3]=n[3];}if(null!=o){const{data:t}=i.getMutableAttribute("size");t[0]=o[0],t[1]=o[1];}if(null!=r){const{data:t}=i.getMutableAttribute("auxpos1");t[0]=r[0],t[1]=r[1],t[2]=r[2],t[3]=r[3];}if(null!=a){const{data:t}=i.getMutableAttribute("uv0");t[0]=a[0],t[1]=a[1];}if(null!=s){const{data:t}=i.getMutableAttribute("auxpos2");t[0]=s[0],t[1]=s[1],t[2]=s[2],t[3]=s[3];}}function k(t,e){const n=new Float32Array(3*t.length),o=new Float32Array(e?3*t.length:3),r=new Uint32Array(t.length),a=new Uint32Array(t.length);for(let s=0;s<t.length;s++)n[3*s]=t[s][0],n[3*s+1]=t[s][1],n[3*s+2]=t[s][2],e&&(o[3*s]=e[s][0],o[3*s+1]=e[s][1],o[3*s+2]=e[s][2]),r[s]=s,a[s]=0;e||(o[0]=0,o[1]=1,o[2]=0);return new u$U([["position",{size:3,data:n,exclusive:!0}],["normal",{size:3,data:o,exclusive:!0}],["uv0",{size:2,data:[0,0],exclusive:!0}]],[["position",r],["normal",e?r:a],["uv0",a]],1)}function S(){const t=[0,0,0,0,0,100,100,0,0],e=new Uint16Array([0,1,2]),n=[0,1,0],o=new Uint16Array([0,0,0]),r=[0,0],a=new Uint16Array([0,0,0]);return new u$U([["position",{size:3,data:t,exclusive:!0}],["normal",{size:3,data:n,exclusive:!0}],["uv0",{size:2,data:r,exclusive:!0}]],[["position",e],["normal",o],["uv0",a]])}A.createBoxGeometry=z$r.createGeometry,A.createDiamondGeometry=M$v.createGeometry,A.createTetrahedronGeometry=U$n.createGeometry,A.createSphereGeometry=b,A.createPolySphereGeometry=P,A.createPointGeometry=I,A.updatePointGeometry=j,A.createPointArrayGeometry=k,A.createTriangleGeometry=S;const T=[[-1,-1,0],[1,-1,0],[1,1,0],[-1,1,0]];function B(t=T){const e=new Array(12);for(let a=0;a<4;a++)for(let n=0;n<3;n++)e[3*a+n]=t[a][n];const n=new Uint32Array([0,1,2,2,3,0]),o=[0,0,1],r=new Uint32Array([0,0,0,0,0,0]);return new u$U([["position",{size:3,data:e,exclusive:!0}],["normal",{size:3,data:o,exclusive:!0}],["uv0",{size:2,data:[0,0,1,0,1,1,0,1],exclusive:!0}],["color",{size:4,data:[255,255,255,255],exclusive:!0}]],[["position",n],["normal",r],["uv0",n],["color",r]])}function D(t,e,n,o,r=!0,a=!0){let s=0;const i=e,l=t;let u=t$13(0,s,0),f=t$13(0,s+l,0),h=t$13(0,-1,0),y=t$13(0,1,0);o&&(s=l,f=t$13(0,0,0),u=t$13(0,s,0),h=t$13(0,1,0),y=t$13(0,-1,0));const m=[f,u],p=[h,y],g=n+2,A=Math.sqrt(l*l+i*i);if(o)for(let d=n-1;d>=0;d--){const t=d*(2*Math.PI/n),e=t$13(Math.cos(t)*i,s,Math.sin(t)*i);m.push(e);const o=t$13(l*Math.cos(t)/A,-i/A,l*Math.sin(t)/A);p.push(o);}else for(let d=0;d<n;d++){const t=d*(2*Math.PI/n),e=t$13(Math.cos(t)*i,s,Math.sin(t)*i);m.push(e);const o=t$13(l*Math.cos(t)/A,i/A,l*Math.sin(t)/A);p.push(o);}const w=new Uint32Array(2*(n+2)*3),v=new Uint32Array(2*(n+2)*3);let x=0,z=0;if(r){for(let t=3;t<m.length;t++)w[x++]=1,w[x++]=t-1,w[x++]=t,v[z++]=0,v[z++]=0,v[z++]=0;w[x++]=m.length-1,w[x++]=2,w[x++]=1,v[z++]=0,v[z++]=0,v[z++]=0;}if(a){for(let t=3;t<m.length;t++)w[x++]=t,w[x++]=t-1,w[x++]=0,v[z++]=t,v[z++]=t-1,v[z++]=1;w[x++]=0,w[x++]=2,w[x++]=m.length-1,v[z++]=1,v[z++]=2,v[z++]=p.length-1;}const M=new Float32Array(3*g);for(let c=0;c<g;c++)M[3*c]=m[c][0],M[3*c+1]=m[c][1],M[3*c+2]=m[c][2];const U=new Float32Array(3*g);for(let c=0;c<g;c++)U[3*c]=p[c][0],U[3*c+1]=p[c][1],U[3*c+2]=p[c][2];return new u$U([["position",{size:3,data:M,exclusive:!0}],["normal",{size:3,data:U,exclusive:!0}]],[["position",w],["normal",v]])}function q(t,i,l,h,y,m){const p=h?r$14(h):t$13(1,0,0),g=y?r$14(y):t$13(0,0,0);m=null==m||m;const A=n$17();j$F(A,p);const w=n$17();d$O(w,A,Math.abs(t));const v=n$17();d$O(v,w,-.5),u$S(v,v,g);const x=t$13(0,1,0);Math.abs(1-z$u(A,x))<.2&&o$S(x,0,0,1);const z=n$17();_$n(z,A,x),j$F(z,z),_$n(x,z,A);const M=2*l+(m?2:0),U=l+(m?2:0),b=new Float32Array(3*M),G=new Float32Array(3*U),F=new Float32Array(2*M),P=new Uint32Array(3*l*(m?4:2)),I=new Uint32Array(3*l*(m?4:2));m&&(b[3*(M-2)+0]=v[0],b[3*(M-2)+1]=v[1],b[3*(M-2)+2]=v[2],F[2*(M-2)]=0,F[2*(M-2)+1]=0,b[3*(M-1)+0]=b[3*(M-2)+0]+w[0],b[3*(M-1)+1]=b[3*(M-2)+1]+w[1],b[3*(M-1)+2]=b[3*(M-2)+2]+w[2],F[2*(M-1)]=1,F[2*(M-1)+1]=1,G[3*(U-2)+0]=-A[0],G[3*(U-2)+1]=-A[1],G[3*(U-2)+2]=-A[2],G[3*(U-1)+0]=A[0],G[3*(U-1)+1]=A[1],G[3*(U-1)+2]=A[2]);const j=function(t,e,n){P[t]=e,I[t]=n;};let k=0;const S=n$17(),T=n$17();for(let e=0;e<l;e++){const t=e*(2*Math.PI/l);d$O(S,x,Math.sin(t)),d$O(T,z,Math.cos(t)),u$S(S,S,T),G[3*e+0]=S[0],G[3*e+1]=S[1],G[3*e+2]=S[2],d$O(S,S,i),u$S(S,S,v),b[3*e+0]=S[0],b[3*e+1]=S[1],b[3*e+2]=S[2],F[2*e+0]=e/l,F[2*e+1]=0,b[3*(e+l)+0]=b[3*e+0]+w[0],b[3*(e+l)+1]=b[3*e+1]+w[1],b[3*(e+l)+2]=b[3*e+2]+w[2],F[2*(e+l)+0]=e/l,F[2*e+1]=1;const n=(e+1)%l;j(k++,e,e),j(k++,e+l,e),j(k++,n,n),j(k++,n,n),j(k++,e+l,e),j(k++,n+l,n);}if(m){for(let t=0;t<l;t++){const e=(t+1)%l;j(k++,M-2,U-2),j(k++,t,U-2),j(k++,e,U-2);}for(let t=0;t<l;t++){const e=(t+1)%l;j(k++,t+l,U-1),j(k++,M-1,U-1),j(k++,e+l,U-1);}}return new u$U([["position",{size:3,data:b,exclusive:!0}],["normal",{size:3,data:G,exclusive:!0}],["uv0",{size:2,data:F,exclusive:!0}]],[["position",P],["normal",I],["uv0",P]])}function E(t,e,n,o,r){n=n||10,o=null==o||o,i$R(t.length>1);const a=[[0,0,0]],s=[],i=[];for(let l=0;l<n;l++){s.push([0,-l-1,-(l+1)%n-1]);const t=l/n*2*Math.PI;i.push([Math.cos(t)*e,Math.sin(t)*e]);}return A.createPathExtrusionGeometry(i,t,a,s,o,r)}function C(a,l,f,A,w,v=t$13(0,0,0)){const x=a.length,z=new Float32Array(l.length*x*3+(6*f.length||0)),M=new Float32Array(l.length*x*3+(f?6:0)),U=(l.length-1)*x*6+3*A.length*2,b=new Uint32Array(U),F=new Uint32Array(U);let P=0,I=0,j=0,k=0;const S=n$17(),T=n$17(),B=n$17(),D=n$17(),q=n$17(),E=n$17(),C=n$17(),O=n$11(),V=n$17(),H=n$17(),J=n$17(),K=n$17(),N=n$17(),Q=p$11();o$S(V,0,1,0),c$V(T,l[1],l[0]),j$F(T,T),w?(u$S(O,l[0],v),j$F(B,O)):o$S(B,0,0,1),L(T,B,V,V,q,B,G$j),r$Z(D,B),r$Z(K,q);for(let t=0;t<f.length;t++)d$O(E,q,f[t][0]),d$O(O,B,f[t][2]),u$S(E,E,O),u$S(E,E,l[0]),z[P++]=E[0],z[P++]=E[1],z[P++]=E[2];M[I++]=-T[0],M[I++]=-T[1],M[I++]=-T[2];for(let t=0;t<A.length;t++)b[j++]=A[t][0]>0?A[t][0]:-A[t][0]-1+f.length,b[j++]=A[t][1]>0?A[t][1]:-A[t][1]-1+f.length,b[j++]=A[t][2]>0?A[t][2]:-A[t][2]-1+f.length,F[k++]=0,F[k++]=0,F[k++]=0;let R=f.length;const W=f.length-1;for(let s=0;s<l.length;s++){let c=!1;if(s>0){r$Z(S,T),s<l.length-1?(c$V(T,l[s+1],l[s]),j$F(T,T)):c=!0,u$S(H,S,T),j$F(H,H),u$S(J,l[s-1],D),y$J(l[s],H,Q);D$q(Q,d$R(J,S),O)?(c$V(O,O,l[s]),j$F(B,O),_$n(q,H,B),j$F(q,q)):L(H,D,K,V,q,B,G$j),r$Z(D,B),r$Z(K,q);}w&&(u$S(O,l[s],v),j$F(N,O));for(let t=0;t<x;t++)if(d$O(E,q,a[t][0]),d$O(O,B,a[t][1]),u$S(E,E,O),j$F(C,E),M[I++]=C[0],M[I++]=C[1],M[I++]=C[2],u$S(E,E,l[s]),z[P++]=E[0],z[P++]=E[1],z[P++]=E[2],!c){const e=(t+1)%x;b[j++]=R+t,b[j++]=R+x+t,b[j++]=R+e,b[j++]=R+e,b[j++]=R+x+t,b[j++]=R+x+e;for(let t=0;t<6;t++)F[k++]=b[j-6+t]-W;}R+=x;}const X=l[l.length-1];for(let t=0;t<f.length;t++)d$O(E,q,f[t][0]),d$O(O,B,f[t][1]),u$S(E,E,O),u$S(E,E,X),z[P++]=E[0],z[P++]=E[1],z[P++]=E[2];const Y=I/3;M[I++]=T[0],M[I++]=T[1],M[I++]=T[2];const Z=R-x;for(let t=0;t<A.length;t++)b[j++]=A[t][0]>=0?R+A[t][0]:-A[t][0]-1+Z,b[j++]=A[t][2]>=0?R+A[t][2]:-A[t][2]-1+Z,b[j++]=A[t][1]>=0?R+A[t][1]:-A[t][1]-1+Z,F[k++]=Y,F[k++]=Y,F[k++]=Y;return new u$U([["position",{size:3,data:z,exclusive:!0}],["normal",{size:3,data:M,exclusive:!0}]],[["position",b],["normal",F]])}function O(t,e,n){i$R(t.length>1,"createPolylineGeometry(): polyline needs at least 2 points"),i$R(3===t[0].length,"createPolylineGeometry(): malformed vertex"),i$R(null==e||e.length===t.length,"createPolylineGeometry: need same number of points and normals"),i$R(null==e||3===e[0].length,"createPolylineGeometry(): malformed normal");const o=new Float64Array(3*t.length),r=new Uint32Array(2*(t.length-1));let a=0,s=0;for(let c=0;c<t.length;c++){for(let e=0;e<3;e++)o[a++]=t[c][e];c>0&&(r[s++]=c-1,r[s++]=c);}const i=[],l=[];if(i.push(["position",r]),l.push(["position",{size:3,data:o,exclusive:!0}]),e){const n=new Float32Array(3*e.length);let o=0;for(let r=0;r<t.length;r++)for(let t=0;t<3;t++)n[o++]=e[r][t];i.push(["normal",r]),l.push(["normal",{size:3,data:n,exclusive:!0}]);}return n&&(l.push(["color",{size:4,data:n}]),i.push(["color",l$U(n.length/4)])),new u$U(l,i,2)}function V(t,e,n,o,r=0){const a=new Array(18),s=[[-e,r,o/2],[n,r,o/2],[0,t+r,o/2],[-e,r,-o/2],[n,r,-o/2],[0,t+r,-o/2]],i=new Uint16Array([0,1,2,3,0,2,2,5,3,1,4,5,5,2,1,1,0,3,3,4,1,4,3,5]);for(let l=0;l<6;l++)a[3*l]=s[l][0],a[3*l+1]=s[l][1],a[3*l+2]=s[l][2];return new u$U([["position",{size:3,data:a,exclusive:!0}]],[["position",i]])}function H(t,e){const n=t.getMutableAttribute("position").data;for(let o=0;o<n.length;o+=3){const t=n[o],r=n[o+1],a=n[o+2];o$S(F$t,t,r,a),I$x(F$t,F$t,e),n[o]=F$t[0],n[o+1]=F$t[1],n[o+2]=F$t[2];}}function J(t,e=t){const n=t.vertexAttributes,o=n.get("position").data,r=n.get("normal").data;if(r){const t=e.getMutableAttribute("normal").data;for(let e=0;e<r.length;e+=3){const n=r[e+1];t[e+1]=-r[e+2],t[e+2]=n;}}if(o){const t=e.getMutableAttribute("position").data;for(let e=0;e<o.length;e+=3){const n=o[e+1];t[e+1]=-o[e+2],t[e+2]=n;}}return e}function K(t,o,r,s,i){return !(Math.abs(z$u(o,t))>i)&&(_$n(r,t,o),j$F(r,r),_$n(s,r,t),j$F(s,s),!0)}function L(t,e,n,o,r,a,s){return K(t,e,r,a,s)||K(t,n,r,a,s)||K(t,o,r,a,s)}A.createSquareGeometry=B,A.createConeGeometry=D,A.createCylinderGeometry=q,A.createTubeGeometry=E,A.createPathExtrusionGeometry=C,A.createPolylineGeometry=O,A.createExtrudedTriangle=V,A.transformInPlace=H,A.cgToGIS=J,A.makeOrthoBasisDirUp=K,A.makeOrthoBasisDirUpFallback=L;}(b$C||(b$C={}));const G$j=.99619469809,F$t=n$17();var P$w=b$C;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
const j$D=n$12.getLogger("esri.views.3d.environment.PanoramicAtmosphere");class v$H{constructor(){this.slot=14,this._atmosphereTechniqueConfig=new u$N,this._readyResolver=D$r(),this._readyController=h$N();}get canRender(){return null!=this._texture}destroy(){this._readyResolver.reject(),this._texture=i$S(this._texture),this._vao=i$S(this._vao),this._readyController=a$$(this._readyController);}when(){return this._readyResolver.promise}initializeRenderContext(e){this._atmosphereTechniqueConfig.geometry=1,this._atmosphereTechnique=e.shaderTechniqueRep.acquire(h$J,this._atmosphereTechniqueConfig);const t=e.renderContext.rctx;this._vao=this._createVertexArrayObject(t),this._vaoCount=r$15(this._vao,"geometry"),t$14(A$r,{signal:this._readyController.signal}).then((r=>{this._texture=new r$16(t,{pixelFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9729,flipped:!0},r),e.requestRender(),this._readyController=null,this._readyResolver.resolve();})).catch((e=>{g$T(e)||j$D.error("Unable to initialize atmosphere: image request failed",e),this._readyResolver.reject();}));}uninitializeRenderContext(){this.destroy();}render(e){if(e.slot!==this.slot||0!==e.pass)return !1;const t=e.rctx,r=this._atmosphereTechnique.program;return t.useProgram(r),this._atmosphereTechnique.bindPipelineState(t),r.bindTexture(this._texture,"tex"),t$15(r,e.camera.projectionMatrix),w$z(C$o,e.camera.viewMatrix),r.setUniformMatrix4fv("view",C$o),r.setUniform4f("color",1,1,1,1),e.scenelightingData.setLightDirectionUniform(r),t.bindVAO(this._vao),r.assertCompatibleVertexAttributeLocations(this._vao),t.drawArrays(4,0,this._vaoCount),!0}_createVertexArrayObject(e){const t=P$w.createPolySphereGeometry(1,2,!1),r=t.indices.get("position");for(let n=0;n<r.length;n+=3){const e=r[n];r[n]=r[n+2],r[n+2]=e;}const o=t.vertexAttributes.get("position").data,i=q$m.createBuffer(r.length),s=i.position;for(let n=0;n<r.length;++n){const e=3*r[n];s.set(n,0,o[e]),s.set(n,1,o[e+1]),s.set(n,2,o[e+2]);}return new f$M(e,o$X,{geometry:t$16(q$m)},{geometry:h$O.createVertex(e,35044,i.buffer)})}}function w$z(e,t){n$18(e,t),e[12]=0,e[13]=0,e[14]=0,e[15]=1;}const C$o=e$P(),q$m=A$u().vec3f("position");

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
function t$R(t){const n=1e5,e=1e6;return Math.min(1,Math.max(0,(t-n)/(e-n)))}const n$X=1e4;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
function r$T(r){const n=new n$15;return n.attributes.add("position","vec2"),n.attributes.add("uv0","vec2"),n.varyings.add("worldRay","vec3"),n.varyings.add("vtc","vec2"),r.haze&&n.varyings.add("eyeDir","vec3"),n.vertex.uniforms.add("projectionInverse","mat4"),n.vertex.uniforms.add("viewInverse","mat4"),n.vertex.code.add(t$10`
    void main(void) {
      vec3 posViewNear = (projectionInverse * vec4(position, -1, 1)).xyz;

      worldRay = (viewInverse * vec4(posViewNear, 0)).xyz;
      vtc = uv0;

      ${r.haze?t$10`eyeDir = posViewNear;`:""}

      gl_Position = vec4(position, 1, 1);
    }
  `),n.fragment.uniforms.add("lightingMainDirection","vec3").add("invWavelength","vec3").add("invWavelengthScaled","vec3").add("radii","vec2").add("atmosphereParameters1","vec4").add("atmosphereParameters2","vec4").add("cameraPosition","vec3").add("nearFar","vec2").add("heightParameters","vec4"),r.haze?n.fragment.uniforms.add("depthTex","sampler2D"):n.fragment.uniforms.add("atmosphereParameters3","vec3").add("innerFadeDistance","float").add("altitudeFade","float"),n.fragment.include(e$U),n.fragment.code.add(t$10`const float krESun = 0.075;
const float kmESun = 0.015;
#define innerRadius radii[0]
#define outerRadius radii[1]
#define shellScale atmosphereParameters1.x
#define shellDepth vec2(atmosphereParameters1.y, atmosphereParameters2.y)
#define scaleOverScaleDepth vec2(atmosphereParameters1.z, atmosphereParameters2.z)
#define oneOverScaleDepth vec2(atmosphereParameters1.w, atmosphereParameters2.w)`),r.haze||n.fragment.code.add(t$10`#define g atmosphereParameters2.x
#define gSq atmosphereParameters3.x
#define miePhaseCoefficients atmosphereParameters3.y
#define lowerAlphaBlendBound atmosphereParameters3.z`),n.fragment.code.add(t$10`
  // The camera's current height
  #define cameraHeight heightParameters[0]
  // cameraHeight^2
  #define cameraHeightSq heightParameters[1]
  // cameraHeightSq - outerRadiusSq; // C = ||o-c||^2 - r^2
  #define C heightParameters[2]
  // cameraHeightSq - (innerRadiusSq - 63756370000.0); // C = ||o-c||^2 - r^2
  #define CSur heightParameters[3]

  ${r.haze?"// Camera HDR\n        const float exposure = 1.5;\n        const vec3 oneOverGamma = vec3(1.0); //Gamma = 1.0":"const float exposure = 2.0;\n        const vec3 oneOverGamma = vec3(0.454545); // Gamma = 2.2\n        vec3 reinhardTM(vec3 inputColor, float _exposure) {\n          vec3 intermediate = inputColor * _exposure;\n          intermediate /= ( 1.0 + intermediate );\n          return pow(intermediate, oneOverGamma);\n        }\n        "}
    // Loop constants for integral approximation
    const float samples = 5.0;
    const int maxSamples = 5;

    // ToneMapping operators
    vec3 expTM(vec3 inputColor,float _exposure) {
        return pow(1.0 - exp(inputColor * -_exposure), oneOverGamma);
    }

    // Approximation for inner integral based on a radii ratio of 10.25:10
    float scale(float _cos) {
      float x = 1.0 - _cos;
      return exp( -0.00287 + x * ( 0.459 + x * ( 3.83 + x * (-6.80 + x * 5.25 ))));
    }

    void main() {
      // Obtain ray from Camera
      vec3 worldSpaceRay = normalize(worldRay);

      // Compute Atmosphere intersection; i.e. ray/sphere intersection
      float B = 2.0 * dot(cameraPosition, worldSpaceRay); // B = 2(l * (o-c))
      float det = B * B - 4.0 * C; // det = B^2 - 4.0* C

      // idealized sphere intersection to discard early some pixels
      float detSur = B * B - 4.0 * CSur; // det = B^2 - 4.0* C

      // the minimal sample start position:
      // at the camera by default, on the earth radius surface if the camera is underground.
      float minRayStart = 0.0;
  `),r.haze||n.fragment.code.add(t$10`float surfaceBlend = 0.0;
vec4 surfaceColor = vec4(0.0);
if (detSur >= 0.0) {
float nearSurface = max(0.0, 0.5 *(-B - sqrt(detSur)));
float farSurface = max(0.0, 0.5 *(-B + sqrt(detSur)));
if (nearSurface == 0.0) {
minRayStart = farSurface;
}
vec3 vPos = cameraPosition + worldSpaceRay * nearSurface;
float lightAngle = dot(lightingMainDirection, normalize(vPos));
float brightness = max(0.0, (smoothstep(-1.0, 0.8, 2.0 * lightAngle)));
surfaceColor = vec4(brightness, brightness, brightness, 1.0 - altitudeFade);
float relDist = (farSurface - nearSurface) / innerFadeDistance;
if (relDist > 1.0) {
gl_FragColor = surfaceColor;
return;
}
surfaceBlend = smoothstep(0.0, 1.0, relDist * relDist);
}`),n.fragment.code.add(t$10`
    if (det >= 0.0) {
    ${r.haze?"\n          float depthSample = texture2D(depthTex, vtc).r;\n\n          float zNear = nearFar[0];\n          float zFar = nearFar[1];\n\n          // http://web.archive.org/web/20130416194336/http://olivers.posterous.com/linear-depth-in-glsl-for-real\n          float zNorm = 2.0 * depthSample - 1.0;\n          float linDepth = 2.0 * zNear * zFar /\n            (zFar + zNear - zNorm * (zFar - zNear));\n\n          float rayEnd;\n          float altitudeAlpha = 1.0;\n\n          // find intersections with ground, but only between the near and far\n          // clipping planes.\n          if (depthSample < 1.0 && depthSample > 0.0) {\n            vec3 cameraSpaceRay = normalize(eyeDir);\n            cameraSpaceRay /= cameraSpaceRay.z;\n            cameraSpaceRay *= linDepth;\n\n            float cameraSpaceRayLength = length(cameraSpaceRay);\n\n            vec3 world = cameraPosition + worldSpaceRay * cameraSpaceRayLength;\n            float worldRadiusSq = dot(world, world);\n\n            // Handle tall structures:\n            // https://devtopia.esri.com/WebGIS/arcgis-js-api/issues/5450\n            float transitionStart = innerRadius + 20000.0;\n            float transitionHeight = 25000.0;\n            float transitionEnd = transitionStart + transitionHeight;\n\n            float edge0 = transitionStart * transitionStart;\n            float edge1 = transitionEnd * transitionEnd;\n\n            altitudeAlpha = 1.0 - clamp((worldRadiusSq - edge0) / (edge1 - edge0), 0.0, 1.0);\n            rayEnd = cameraSpaceRayLength;\n\n            if (altitudeAlpha > 0.0 && detSur > 0.0) {\n              float nearSurface = 0.5 * ( -B - sqrt(detSur) );\n              float interp = clamp(((cameraHeight - innerRadius) - 2000000.0) / 6000000.0, 0.0, 1.0);\n              rayEnd = mix(cameraSpaceRayLength, nearSurface, interp);\n            }\n          }":""}
    float rayStart = 0.5 *(-B - sqrt(det)); //near intersection with atmosphere
    ${r.haze?"float near = abs(rayStart);\n        float far = abs(rayEnd);":"float rayEnd = 0.5 *(-B + sqrt(det)); //far intersection with atmosphere"}

    float scatterDistance; // calculate its scattering offset
    // Calculate the ray's starting position
    if (rayStart < minRayStart)
    { // ray starts from camera or inner radius sphere to far
      rayStart = minRayStart;
      ${r.haze?"":"// clamp to value at inner radius altitude\n          scatterDistance = shellScale * min(0.0, innerRadius - cameraHeight);"}
    }
    ${r.haze?"":"else { // outside atmosphere\n          scatterDistance = -1.0;\n        }"}
    // Initialize the scattering loop variables
    vec3 start = cameraPosition + worldSpaceRay * rayStart;
  `),r.haze&&n.fragment.code.add(t$10`vec3 end = cameraPosition + worldSpaceRay * rayEnd;
float endLength = length(end);
vec2 altitudeInterval = vec2(length(start) - innerRadius, endLength - innerRadius);
if (altitudeInterval.x < 0.0) {
altitudeInterval = -altitudeInterval;
}
float lightAngle = dot(lightingMainDirection, end) / endLength;
if (near > far)
{
if (altitudeInterval.x < altitudeInterval.y)
{
end = cameraPosition + worldSpaceRay * rayStart;
start = cameraPosition + worldSpaceRay * rayEnd;
worldSpaceRay *= -1.0;
float tmp = altitudeInterval.x;
altitudeInterval.x = altitudeInterval.y;
altitudeInterval.y = tmp;
}
else if (altitudeInterval.x == altitudeInterval.y)
{
altitudeInterval.x += 1.0;
}
}
if (altitudeInterval.x > outerRadius - innerRadius)
{
scatterDistance = innerRadius - outerRadius;
} else
{
scatterDistance = altitudeInterval.y - altitudeInterval.x;
}`),n.fragment.code.add(t$10`vec2 opticalStartDepth = exp(scatterDistance * oneOverScaleDepth);
float rayLength = rayEnd - rayStart;
float sampleLength = rayLength / samples;
float scaledLength = sampleLength * shellScale;
vec3 sampleRay = worldSpaceRay * sampleLength;
vec3 samplePoint = start + sampleRay * 0.5;`),r.haze?n.fragment.code.add(t$10`float cameraAngle = dot(-worldSpaceRay, end) / length(end);
float scaleCameraAngle = scale(cameraAngle);
vec2 cameraOffset = scaleCameraAngle * opticalStartDepth;
float scaledValues = scale(lightAngle) + scaleCameraAngle;
vec2 scaledValuesDepth = scaledValues * shellDepth;`):n.fragment.code.add(t$10`float cameraAngle = dot(worldSpaceRay, start / length(start));
float angleMultiplier = cameraAngle > 0.0 ? cameraAngle : 0.0;
float scaleCameraAngle = scale(cameraAngle);
vec2 cameraOffset = scaleCameraAngle * opticalStartDepth * shellDepth;`),n.fragment.code.add(t$10`vec3 frontColor = vec3(0.0);
vec3 frontColorBlue = vec3(0.0);
vec3 attenuate = vec3(0.0);
vec3 attenuateBlue = vec3(0.0);
for(int i=0; i<maxSamples; i++) {
float height = length(samplePoint);
float altitude = abs(height - innerRadius);
vec2 depth = exp(-altitude * scaleOverScaleDepth);`),r.haze?n.fragment.code.add(t$10`vec2 scatter = depth * scaledValuesDepth - cameraOffset;`):n.fragment.code.add(t$10`float lightAngle = dot(lightingMainDirection, samplePoint) / height;
float cameraAngle = dot(worldSpaceRay, samplePoint) / height;
float tmpScaledValues = scale(lightAngle) - scale(cameraAngle);
vec2 scatter = cameraOffset + tmpScaledValues * depth * shellDepth;`),n.fragment.code.add(t$10`attenuate = exp(-scatter.x * invWavelengthScaled);
attenuateBlue = exp(-scatter.y * invWavelengthScaled);
frontColor += attenuate * depth.x;
frontColorBlue += attenuateBlue * depth.y;
samplePoint += sampleRay;
}
float LdotR = clamp(dot(lightingMainDirection, -worldSpaceRay ),-0.9999999,1.0);
float LdotRSq = LdotR * LdotR + 1.0;`),r.haze?n.fragment.code.add(t$10`vec3 colorCoefficients = (scaledLength * 0.75 * LdotRSq) * (krESun * invWavelength + kmESun );
vec3 color = colorCoefficients * frontColor;
vec3 colorBlue = colorCoefficients * frontColorBlue;`):n.fragment.code.add(t$10`vec3 rayleighCoefficients = (scaledLength * 0.75 * LdotRSq * krESun) * invWavelength;
float mieCoefficients = scaledLength * kmESun * miePhaseCoefficients * LdotRSq / pow(1.0 + gSq - 2.0 * g * LdotR, 1.5);
vec3 color = rayleighCoefficients * frontColor + mieCoefficients * frontColor;
vec3 colorBlue = rayleighCoefficients * frontColorBlue + mieCoefficients * frontColorBlue;`),n.fragment.code.add(t$10`vec3 ldrBlue = expTM(colorBlue, 2.0 * exposure);
vec3 ldrRed = expTM(color, exposure);
vec3 LDR = mix(ldrBlue, ldrRed, 0.2);`),r.haze?n.fragment.code.add(t$10`LDR *= (1.0 - cameraAngle);
vec3 hsv = rgb2hsv(LDR);
hsv.y = clamp(hsv.y * 1.5, 0.0, 1.0);
LDR = hsv2rgb(hsv);
vec3 finalColor = LDR;`):n.fragment.code.add(t$10`vec3 ldrReinhard = reinhardTM(color, exposure);
LDR += angleMultiplier * ldrReinhard;
float side = (rayEnd + rayStart) * 0.5;
float atmoHeight = sqrt(cameraHeightSq - side * side);
float h2 = clamp(1.0 - ( atmoHeight - lowerAlphaBlendBound ) / ( outerRadius - lowerAlphaBlendBound ), 0.0, 1.0);
vec3 finalColor = LDR * h2;
vec3 hsv = rgb2hsv(finalColor);
hsv.y = clamp(hsv.y * 1.5, 0.0, 1.0);
finalColor = hsv2rgb(hsv);`),n.fragment.code.add(t$10`
    ${r.haze?"gl_FragColor = vec4(finalColor, 1.0) * altitudeAlpha;":"float atmosStrength = clamp((length(ldrRed) - 0.05) * 1.05, 0.0, 1.0);\n          gl_FragColor = vec4(finalColor, atmosStrength * clamp(1.0 - ( atmoHeight - innerRadius ) / (outerRadius - innerRadius), 0.0, 1.0));\n          if (surfaceBlend > 0.0) {\n            gl_FragColor = mix(gl_FragColor, surfaceColor, surfaceBlend);\n          }"}
      } else { // Outside Atmosphere
        gl_FragColor = vec4(0.0);
      }
    }
  `),n}var n$W=Object.freeze({__proto__:null,build:r$T});

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class g$Q extends t$11{initializeProgram(e){const r=g$Q.shader.get(),i=this.configuration,t=r.build({haze:i.haze});return new n$16(e.rctx,t,o$X)}initializePipeline(){return this.configuration.haze?g$S({blending:e$T(1,0,769,1),colorWrite:r$13}):g$S({blending:e$T(770,1,771,771),depthTest:{func:515},colorWrite:r$13})}}g$Q.shader=new t$12(n$W,(()=>import('./RealisticAtmosphere.glsl-a4956ba2.js')));class m$T extends e$S{constructor(){super(...arguments),this.haze=!1;}}e$Q([r$12()],m$T.prototype,"haze",void 0);

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class S$y{constructor(e){this._view=e,this.canRender=!0,this._skyslot=14,this._hazeSlot=15,this._renderData={texDepth:n$19(),cameraPosition:n$11(),projectionInverse:e$P(),viewInverse:e$P(),heightParameters:n$1a(),atmosphereParameters1:n$1a(),atmosphereParameters2:n$1a(),atmosphereParameters3:n$11(),invWavelength:E$u,invWavelengthScaled:H$j,radii:n$19(),scale:0,scaleDepth:q$l,lowerAlphaBlendBound:0,scaleOverScaleDepth:0,oneOverScaleDepth:0,scaleDepthBlue:U$m,oneOverScaleDepthBlue:F$s,scaleOverScaleDepthBlue:0,g:k$u,g2:k$u*k$u,miePhaseCoefficients:z$q,nearFar:n$19(),cameraHeight:0,cameraHeightSq:0,C:0,CSur:0,innerFadeDistance:0,altitudeFade:0},this._lowerElevationBoundRadius=0,this._lowerBoundEarthRadius=s$R.radius,this._updateRadius(s$R.radius);}destroy(){this._handles&&(this._handles.destroy(),this._handles=null),this._vao&&(this._vao.dispose(),this._vao=null);}when(){return Promise.resolve()}initializeRenderContext(a){const r=a.renderContext.rctx;this._handles=new u$T,this._updateElevation({spatialReference:this._view.basemapTerrain.spatialReference,tile:this._view.basemapTerrain.rootTiles[0],extent:this._view.basemapTerrain.rootTiles[0].extent,context:"ground"}),this._handles.add(C$q(this._view,"basemapTerrain","elevation-change",(e=>this._updateElevation(e)),(()=>this._updateElevation()))),this._handles.add(C$q(this._view,"basemapTerrain","elevation-bounds-change",(()=>this._updateVisibleElevationBounds()),(()=>this._updateVisibleElevationBounds())));const s=new m$T;s.haze=!1,this._atmosphereTechnique=a.shaderTechniqueRep.acquire(g$Q,s),s.haze=!0,this._atmosphereHazeTechnique=a.shaderTechniqueRep.acquire(g$Q,s),this._vao=this._createVertexArrayObject(r);}uninitializeRenderContext(){this.destroy();}render(e){return (e.slot===this._hazeSlot||e.slot===this._skyslot)&&0===e.pass&&(this._update(e.camera),e.slot===this._skyslot&&this._renderSky(e),e.slot===this._hazeSlot&&this._renderHaze(e),!0)}_renderSky(e){const t=e.rctx,a=this._atmosphereTechnique.program;t.useProgram(a),this._atmosphereTechnique.bindPipelineState(t),a.setUniform3fv("atmosphereParameters3",this._renderData.atmosphereParameters3),this._renderCommon(a,e);}_renderHaze(e){const t=e.rctx,a=e.offscreenRenderingHelper,r=this._atmosphereHazeTechnique.program;t.useProgram(r),this._atmosphereHazeTechnique.bindPipelineState(t),a.renderDepthDetached((()=>{const t=a.depthTexture;r.bindTexture(t,"depthTex"),this._renderCommon(r,e);}));}_renderCommon(e,t){const a=t.rctx;e.setUniform3fv("invWavelength",this._renderData.invWavelength),e.setUniform3fv("invWavelengthScaled",this._renderData.invWavelengthScaled),t.scenelightingData.setLightDirectionUniform(e),e.setUniform4fv("heightParameters",this._renderData.heightParameters),e.setUniform3fv("cameraPosition",this._renderData.cameraPosition),e.setUniformMatrix4fv("projectionInverse",this._renderData.projectionInverse),e.setUniformMatrix4fv("viewInverse",this._renderData.viewInverse),e.setUniform2fv("nearFar",this._renderData.nearFar),e.setUniform2fv("radii",this._renderData.radii),e.setUniform4fv("atmosphereParameters1",this._renderData.atmosphereParameters1),e.setUniform4fv("atmosphereParameters2",this._renderData.atmosphereParameters2),e.setUniform1f("innerFadeDistance",this._renderData.innerFadeDistance),e.setUniform1f("altitudeFade",this._renderData.altitudeFade),a.bindVAO(this._vao),e.assertCompatibleVertexAttributeLocations(this._vao),a.drawArrays(5,0,4);}_createVertexArrayObject(e){const t=I$u.createBuffer(4);return t.position.setVec(0,[-1,-1]),t.position.setVec(1,[1,-1]),t.position.setVec(2,[-1,1]),t.position.setVec(3,[1,1]),t.uv0.setVec(0,[0,0]),t.uv0.setVec(1,[1,0]),t.uv0.setVec(2,[0,1]),t.uv0.setVec(3,[1,1]),new f$M(e,o$X,{geometry:t$16(I$u)},{geometry:h$O.createVertex(e,35044,t.buffer)})}_adjustRadiusForTesselation(e){const t=16,a=4,r=Math.PI/2**a/t;return e*Math.cos(r)}_updateElevation(e){const t=e?e.tile:this._view.basemapTerrain.rootTiles[0];if(0!==t.lij[0])return;const a=this._adjustRadiusForTesselation(s$R.radius+t.elevationBounds[0]);a!==this._lowerElevationBoundRadius&&(this._lowerElevationBoundRadius=a,this._lowerBoundEarthRadius=-1,this._updateVisibleElevationBounds());}_updateVisibleElevationBounds(){const e=this._adjustRadiusForTesselation(s$R.radius+this._view.basemapTerrain.elevationBounds.min);(this._lowerBoundEarthRadius<0||e<this._lowerBoundEarthRadius)&&this._updateRadius(e);}_updateRadius(e){this._lowerBoundEarthRadius=e;const t=e,a=t/10*10.25,r=1/(a-t),i=r/q$l,o=r/U$m,h=.3*(a-t)+t,d=this._renderData;r$17(d.atmosphereParameters1,r,q$l,i,C$n),r$17(d.atmosphereParameters2,k$u,U$m,o,F$s),o$S(d.atmosphereParameters3,k$u*k$u,z$q,h),r$18(d.radii,t,a),d.scale=r,d.lowerAlphaBlendBound=h,d.scaleOverScaleDepth=i,d.scaleOverScaleDepthBlue=o;const c=n$X;d.innerFadeDistance=2*Math.sqrt((2*t-c)*c);}_update(e){e&&(this._renderData.cameraHeight=s$P(e.eye),this._renderData.cameraHeightSq=this._renderData.cameraHeight*this._renderData.cameraHeight,this._renderData.C=this._renderData.cameraHeightSq-this._renderData.radii[1]*this._renderData.radii[1],this._renderData.CSur=this._renderData.cameraHeightSq-this._renderData.radii[0]*this._renderData.radii[0],this._renderData.heightParameters=r$19(this._renderData.cameraHeight,this._renderData.cameraHeightSq,this._renderData.C,this._renderData.CSur),r$Z(this._renderData.cameraPosition,e.eye),h$L(this._renderData.projectionInverse,e.projectionMatrix),h$L(this._renderData.viewInverse,e.viewMatrix),r$18(this._renderData.nearFar,e.near,e.far),this._renderData.altitudeFade=t$R(this._renderData.cameraHeight-this._lowerBoundEarthRadius));}static isSupported(e){return e.renderContext.rctx.capabilities.depthTexture}}const R$r=.001,V$i=4*.005*Math.PI,y$I=4*R$r*Math.PI,E$u=t$_(1/.65**4,1/.57**4,1/.475**4),H$j=r$_(E$u);d$O(H$j,H$j,V$i),u$S(H$j,H$j,t$_(y$I,y$I,y$I));const q$l=.25,U$m=.05,C$n=1/q$l,F$s=1/U$m,k$u=-.99999,z$q=(1-k$u*k$u)/(2+k$u*k$u)*1.5,I$u=A$u().vec2f("position").vec2f("uv0");

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
var A$q="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAIACAYAAAE00TaTAAAACXBIWXMAAA7AAAAOwAFq1okJAAAKT2lDQ1BQaG90b3Nob3AgSUNDIHByb2ZpbGUAAHjanVNnVFPpFj333vRCS4iAlEtvUhUIIFJCi4AUkSYqIQkQSoghodkVUcERRUUEG8igiAOOjoCMFVEsDIoK2AfkIaKOg6OIisr74Xuja9a89+bN/rXXPues852zzwfACAyWSDNRNYAMqUIeEeCDx8TG4eQuQIEKJHAAEAizZCFz/SMBAPh+PDwrIsAHvgABeNMLCADATZvAMByH/w/qQplcAYCEAcB0kThLCIAUAEB6jkKmAEBGAYCdmCZTAKAEAGDLY2LjAFAtAGAnf+bTAICd+Jl7AQBblCEVAaCRACATZYhEAGg7AKzPVopFAFgwABRmS8Q5ANgtADBJV2ZIALC3AMDOEAuyAAgMADBRiIUpAAR7AGDIIyN4AISZABRG8lc88SuuEOcqAAB4mbI8uSQ5RYFbCC1xB1dXLh4ozkkXKxQ2YQJhmkAuwnmZGTKBNA/g88wAAKCRFRHgg/P9eM4Ors7ONo62Dl8t6r8G/yJiYuP+5c+rcEAAAOF0ftH+LC+zGoA7BoBt/qIl7gRoXgugdfeLZrIPQLUAoOnaV/Nw+H48PEWhkLnZ2eXk5NhKxEJbYcpXff5nwl/AV/1s+X48/Pf14L7iJIEyXYFHBPjgwsz0TKUcz5IJhGLc5o9H/LcL//wd0yLESWK5WCoU41EScY5EmozzMqUiiUKSKcUl0v9k4t8s+wM+3zUAsGo+AXuRLahdYwP2SycQWHTA4vcAAPK7b8HUKAgDgGiD4c93/+8//UegJQCAZkmScQAAXkQkLlTKsz/HCAAARKCBKrBBG/TBGCzABhzBBdzBC/xgNoRCJMTCQhBCCmSAHHJgKayCQiiGzbAdKmAv1EAdNMBRaIaTcA4uwlW4Dj1wD/phCJ7BKLyBCQRByAgTYSHaiAFiilgjjggXmYX4IcFIBBKLJCDJiBRRIkuRNUgxUopUIFVIHfI9cgI5h1xGupE7yAAygvyGvEcxlIGyUT3UDLVDuag3GoRGogvQZHQxmo8WoJvQcrQaPYw2oefQq2gP2o8+Q8cwwOgYBzPEbDAuxsNCsTgsCZNjy7EirAyrxhqwVqwDu4n1Y8+xdwQSgUXACTYEd0IgYR5BSFhMWE7YSKggHCQ0EdoJNwkDhFHCJyKTqEu0JroR+cQYYjIxh1hILCPWEo8TLxB7iEPENyQSiUMyJ7mQAkmxpFTSEtJG0m5SI+ksqZs0SBojk8naZGuyBzmULCAryIXkneTD5DPkG+Qh8lsKnWJAcaT4U+IoUspqShnlEOU05QZlmDJBVaOaUt2ooVQRNY9aQq2htlKvUYeoEzR1mjnNgxZJS6WtopXTGmgXaPdpr+h0uhHdlR5Ol9BX0svpR+iX6AP0dwwNhhWDx4hnKBmbGAcYZxl3GK+YTKYZ04sZx1QwNzHrmOeZD5lvVVgqtip8FZHKCpVKlSaVGyovVKmqpqreqgtV81XLVI+pXlN9rkZVM1PjqQnUlqtVqp1Q61MbU2epO6iHqmeob1Q/pH5Z/YkGWcNMw09DpFGgsV/jvMYgC2MZs3gsIWsNq4Z1gTXEJrHN2Xx2KruY/R27iz2qqaE5QzNKM1ezUvOUZj8H45hx+Jx0TgnnKKeX836K3hTvKeIpG6Y0TLkxZVxrqpaXllirSKtRq0frvTau7aedpr1Fu1n7gQ5Bx0onXCdHZ4/OBZ3nU9lT3acKpxZNPTr1ri6qa6UbobtEd79up+6Ynr5egJ5Mb6feeb3n+hx9L/1U/W36p/VHDFgGswwkBtsMzhg8xTVxbzwdL8fb8VFDXcNAQ6VhlWGX4YSRudE8o9VGjUYPjGnGXOMk423GbcajJgYmISZLTepN7ppSTbmmKaY7TDtMx83MzaLN1pk1mz0x1zLnm+eb15vft2BaeFostqi2uGVJsuRaplnutrxuhVo5WaVYVVpds0atna0l1rutu6cRp7lOk06rntZnw7Dxtsm2qbcZsOXYBtuutm22fWFnYhdnt8Wuw+6TvZN9un2N/T0HDYfZDqsdWh1+c7RyFDpWOt6azpzuP33F9JbpL2dYzxDP2DPjthPLKcRpnVOb00dnF2e5c4PziIuJS4LLLpc+Lpsbxt3IveRKdPVxXeF60vWdm7Obwu2o26/uNu5p7ofcn8w0nymeWTNz0MPIQ+BR5dE/C5+VMGvfrH5PQ0+BZ7XnIy9jL5FXrdewt6V3qvdh7xc+9j5yn+M+4zw33jLeWV/MN8C3yLfLT8Nvnl+F30N/I/9k/3r/0QCngCUBZwOJgUGBWwL7+Hp8Ib+OPzrbZfay2e1BjKC5QRVBj4KtguXBrSFoyOyQrSH355jOkc5pDoVQfujW0Adh5mGLw34MJ4WHhVeGP45wiFga0TGXNXfR3ENz30T6RJZE3ptnMU85ry1KNSo+qi5qPNo3ujS6P8YuZlnM1VidWElsSxw5LiquNm5svt/87fOH4p3iC+N7F5gvyF1weaHOwvSFpxapLhIsOpZATIhOOJTwQRAqqBaMJfITdyWOCnnCHcJnIi/RNtGI2ENcKh5O8kgqTXqS7JG8NXkkxTOlLOW5hCepkLxMDUzdmzqeFpp2IG0yPTq9MYOSkZBxQqohTZO2Z+pn5mZ2y6xlhbL+xW6Lty8elQfJa7OQrAVZLQq2QqboVFoo1yoHsmdlV2a/zYnKOZarnivN7cyzytuQN5zvn//tEsIS4ZK2pYZLVy0dWOa9rGo5sjxxedsK4xUFK4ZWBqw8uIq2Km3VT6vtV5eufr0mek1rgV7ByoLBtQFr6wtVCuWFfevc1+1dT1gvWd+1YfqGnRs+FYmKrhTbF5cVf9go3HjlG4dvyr+Z3JS0qavEuWTPZtJm6ebeLZ5bDpaql+aXDm4N2dq0Dd9WtO319kXbL5fNKNu7g7ZDuaO/PLi8ZafJzs07P1SkVPRU+lQ27tLdtWHX+G7R7ht7vPY07NXbW7z3/T7JvttVAVVN1WbVZftJ+7P3P66Jqun4lvttXa1ObXHtxwPSA/0HIw6217nU1R3SPVRSj9Yr60cOxx++/p3vdy0NNg1VjZzG4iNwRHnk6fcJ3/ceDTradox7rOEH0x92HWcdL2pCmvKaRptTmvtbYlu6T8w+0dbq3nr8R9sfD5w0PFl5SvNUyWna6YLTk2fyz4ydlZ19fi753GDborZ752PO32oPb++6EHTh0kX/i+c7vDvOXPK4dPKy2+UTV7hXmq86X23qdOo8/pPTT8e7nLuarrlca7nuer21e2b36RueN87d9L158Rb/1tWeOT3dvfN6b/fF9/XfFt1+cif9zsu72Xcn7q28T7xf9EDtQdlD3YfVP1v+3Njv3H9qwHeg89HcR/cGhYPP/pH1jw9DBY+Zj8uGDYbrnjg+OTniP3L96fynQ89kzyaeF/6i/suuFxYvfvjV69fO0ZjRoZfyl5O/bXyl/erA6xmv28bCxh6+yXgzMV70VvvtwXfcdx3vo98PT+R8IH8o/2j5sfVT0Kf7kxmTk/8EA5jz/GMzLdsAAAAgY0hSTQAAeiUAAICDAAD5/wAAgOkAAHUwAADqYAAAOpgAABdvkl/FRgAAAp1JREFUSMd9lcmSEzEQRCtflnqxYZgIThBDAP//kXDQ0pJtuDhqycxWZ5fKERFCERARIAVEyCjCtSFFEjWVa9q7OdJE0oiidIhKhRBROlhloiGVhaYERQHJWFEwMpYKrjUlibI2cqSJIJEpKNmM2c3GkRTOJDnThTMpnMWu0VFszs3Jfbe5bza3w+a229yOIs6zmP3czfn1K2w/for8+EVU15pNmmyqkeJyclinXNJRu1xrUaJmjmdzJiejVNt7zZVBRAIq1RwrsrrWnez+SR7WmQQP/1itKz2q/pmzuJtYnNy2bth9x9z2NLfDcB7FHOcGx6ebOb9/iPzxG/ztg4iorglFiKjzF9HSNphCoRb1OY3RZQJrYgRdT68bmgXGDdBzrTG8qNS7QP/m19ef7tGlcoH7vESYkK70uoPuOLEetz0IqeGoWQW6MlB/j36EnipYGKPWwDRg/RkNhXCNJIzAhMk6PrDePJNII6JHqM5VWqYApCtNFPe0GFFGtOWopWCrEVBSoiQi06KkRRaD08IlxXa/ifz8Jvz2LvjyLnh7F/r8Rei8a8xfjNkIrpmMOQ1C02COrkTEHxGhh+6DQJfXc/eZprXxcIyVIf1LJVgWvKaHvwI/1aQxtv851SQ/nqGXL6MHFVY3nmhLyqKsWO/+qzWif+yS1TpNKq8NezjGPCV69ciZoQj1PwfN6QRpWyCGVMe1D/AAHt3/gefu1Ign3AVpjOiNXkN90JlpL6TUnzFEUU+Jvks0tkp/dY3Fy1TzI24BWwsYJPyg11Q0FqDwK72xIz2kLojbeuxS1FpgtfNWyMX1gFw0j3W7RNeSHTVEe3VaV7SdCzVywFaEt02w7QH7Eeg4AvZDNdJ+Cu1HENsutO+Byi6ilEBZ9BeCNBJceJIjHgAAAABJRU5ErkJggg==";

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
const L$q=n$12.getLogger("esri.views.3d.environment.SimpleAtmosphere"),O$x=128,H$i=-n$X,P$v=0,z$p=50,B$j=()=>1-511/512,I$t=I$y([[50,.1015625],[500,.21875],[5e3,1-250/512],[5e4,.4140625]]);class E$t{constructor(e){this.view=e,this.slot=14,this._renderData={texV:n$19(),silCircleCenter:n$11(),silCircleV1:n$11(),silCircleV2:n$11(),altitudeFade:0,innerScale:0,undergroundFadeAlpha:0},this._fadeVaoCount=0,this._readyResolver=D$r(),this._readyController=h$N(),this.texV1=1,this.isOnMars=k$y(e.spatialReference);const t=p$15(e.spatialReference);this.planetRadius=t.radius,this.outerRimWidth=t.outerAtmosphereRimWidth,this.innerRimFactor=(this.planetRadius+H$i)/this.planetRadius,this.middleRimFactor=(this.planetRadius+P$v)/this.planetRadius,this.outerRimFactor=(this.planetRadius+this.outerRimWidth)/this.planetRadius,this.texV0=P$v/this.outerRimWidth,this.texVScale=this.texV1-this.texV0;}get canRender(){return null!=this._texture}when(){return this._readyResolver.promise}initializeRenderContext(e){const t=e.renderContext.rctx;this._cameraChangeHandle=d$S(this.view,"state.camera",(()=>e.requestRender()),!0);const r=new u$N;r.geometry=0,this._atmosphereConeTechnique=e.shaderTechniqueRep.acquire(h$J,r),r.geometry=2,this._atmosphereUndergroundTechnique=e.shaderTechniqueRep.acquire(h$J,r),this._vao=this._createRibbon(t),this._vaoCount=r$15(this._vao,"geometry"),this._fadeVao=i$T(t),this._fadeVaoCount=r$15(this._fadeVao,"geometry"),t$14(this.isOnMars?A$q:A$r,{signal:this._readyController.signal}).then((r=>{this._texture=new r$16(t,{pixelFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9729,flipped:!0},r),e.requestRender(),this._readyController=null,this._readyResolver.resolve();})).catch((e=>{g$T(e)||L$q.error("Unable to initialize simple atmosphere: image request failed",e),this._readyResolver.reject();}));}uninitializeRenderContext(){this.destroy();}destroy(){this._readyResolver.reject(),this._cameraChangeHandle&&(this._cameraChangeHandle.remove(),this._cameraChangeHandle=null),this._texture&&(this._texture.dispose(),this._texture=null),this._fadeVao&&(this._fadeVao.dispose(),this._fadeVao=null),this._vao&&(this._vao.dispose(),this._vao=null),this._readyController&&(this._readyController.abort(),this._readyController=null);}render(e){if(e.slot!==this.slot||0!==e.pass)return !1;this._update(e.camera);const t=e.rctx;if(this._atmosphereConeTechnique.bindPipelineState(t),this._renderData.undergroundFadeAlpha<1){const r=this._atmosphereConeTechnique.program;t.useProgram(r),r.setUniformMatrix4fv("proj",e.camera.projectionMatrix),r.setUniformMatrix4fv("view",e.camera.viewMatrix),r.setUniform3fv("silCircleCenter",this._renderData.silCircleCenter),r.setUniform3fv("silCircleV1",this._renderData.silCircleV1),r.setUniform3fv("silCircleV2",this._renderData.silCircleV2),r.setUniform2fv("texV",this._renderData.texV),r.bindTexture(this._texture,"tex"),e.scenelightingData.setLightDirectionUniform(r),r.setUniform1f("altitudeFade",this._renderData.altitudeFade),r.setUniform1f("innerScale",this._renderData.innerScale),t.bindVAO(this._vao),t.drawArrays(4,0,this._vaoCount);}if(this._renderData.undergroundFadeAlpha>0){const r=this._atmosphereUndergroundTechnique.program;t.useProgram(r),r.setUniform1f("undergroundFadeAlpha",this._renderData.undergroundFadeAlpha),e.scenelightingData.setLightDirectionUniform(r),r.setUniform3fv("cameraPosition",e.camera.eye),t.bindVAO(this._fadeVao),t.drawArrays(5,0,this._fadeVaoCount);}return !0}_update(e){const i=n$11(),s=this.planetRadius,a=s$P(e.eye),o=a-s;if(o<0){const e=Math.min(-o/5e3,1);this._renderData.undergroundFadeAlpha=e;}else this._renderData.undergroundFadeAlpha=0;const n=Math.max(z$p,o),h=s+H$i;this._renderData.innerScale=Q$k(s+n,s,h)-1,this._renderData.altitudeFade=t$R(o),d$O(i,e.eye,(s+z$p)/a),G$i(i,e.center,e.up,s,this._renderData);const m=this._computeScreenRimWidth(e,i,e.up,this._renderData),u=B$j(),p=I$t(o);let f=this.texV0+u*this.texVScale,_=this.texV0+m*p*this.texVScale;if(o>z$p){G$i(e.eye,e.center,e.up,s,this._renderData);const i=this._computeScreenRimWidth(e,e.eye,e.up,this._renderData),a=o$R((i-1.5)/(m-1.5),0,1);f=this.texV0+a*u*this.texVScale,_=this.texV0+m$V(this.texV1,m*p,a)*this.texVScale;}r$18(this._renderData.texV,f,_);}_createRibbon(e){const t=new Float32Array(3+3*O$x*3),r=new Uint32Array(3*O$x*5);t[0]=0,t[1]=0,t[2]=-1;for(let a=0;a<O$x;a++){const e=9*a+3;t[e+0]=a,t[e+1]=this.innerRimFactor,t[e+2]=-1,t[e+3]=a,t[e+4]=this.middleRimFactor,t[e+5]=0,t[e+6]=a,t[e+7]=this.outerRimFactor,t[e+8]=1;const i=3*a+1,s=a===O$x-1?1:i+3,o=15*a;r[o+0]=i,r[o+1]=i+1,r[o+2]=s+1,r[o+3]=s+1,r[o+4]=s,r[o+5]=i,r[o+6]=i+1,r[o+7]=i+2,r[o+8]=s+2,r[o+9]=s+2,r[o+10]=s+1,r[o+11]=i+1,r[o+12]=i,r[o+13]=s,r[o+14]=0;}const i=X$d.createBuffer(r.length),s=i.position;for(let a=0;a<r.length;++a){const e=3*r[a];s.set(a,0,t[e]),s.set(a,1,t[e+1]),s.set(a,2,t[e+2]);}return new f$M(e,o$X,{geometry:t$16(X$d)},{geometry:h$O.createVertex(e,35044,i.buffer)})}_computeScreenRimWidth(e,t,r,i){return u$S(K$i,i.silCircleCenter,i.silCircleV2),d$O(N$n,K$i,this.outerRimFactor),F$x(J$i,t,K$i,r),v$L(K$i,J$i,e.projectionMatrix,e.viewport),v$L(N$n,J$i,e.projectionMatrix,e.viewport),q$o(K$i,N$n)/e.height}}function G$i(e,t,r,i,s){const a=s$P(e),o=i*Math.sqrt(a*a-i*i)/a,n=Math.sqrt(i*i-o*o),h=s.silCircleV1,l=s.silCircleV2;return d$O(s.silCircleCenter,e,n/a),_$n(h,e,t),p$12(h)<1&&_$n(h,e,r),d$O(h,h,o/s$P(h)),_$n(l,h,e),d$O(l,l,o/s$P(l)),o}const J$i=e$P(),K$i=n$11(),N$n=n$11();function Q$k(e,t,r){return e*e/(Math.sqrt(e*e-t*t)*Math.sqrt(e*e-r*r)+t*r)}const X$d=A$u().vec3f("position");

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
function c$M(c){const i=t$10`vec4 alignToPixelCenter(vec4 clipCoord, vec2 widthHeight) {
vec2 xy = vec2(0.500123) + 0.5 * clipCoord.xy / clipCoord.w;
vec2 pixelSz = vec2(1.0) / widthHeight;
vec2 ij = (floor(xy * widthHeight) + vec2(0.5)) * pixelSz;
vec2 result = (ij * 2.0 - vec2(1.0)) * clipCoord.w;
return vec4(result, clipCoord.zw);
}`,o=t$10`vec4 alignToPixelOrigin(vec4 clipCoord, vec2 widthHeight) {
vec2 xy = vec2(0.5) + 0.5 * clipCoord.xy / clipCoord.w;
vec2 pixelSz = vec2(1.0) / widthHeight;
vec2 ij = floor((xy + 0.5 * pixelSz) * widthHeight) * pixelSz;
vec2 result = (ij * 2.0 - vec2(1.0)) * clipCoord.w;
return vec4(result, clipCoord.zw);
}`;c.vertex.code.add(i),c.vertex.code.add(o),c.fragment.code.add(i),c.fragment.code.add(o);}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
function i$I(){const i=new n$15;return i.attributes.add("position","vec3"),i.attributes.add("color","vec4"),i.attributes.add("size","float"),i.varyings.add("vcolor","vec4"),i.varyings.add("vsize","float"),i.vertex.uniforms.add("transform","mat4").add("viewport","vec4").add("pixelRatio","float"),i.include(c$M),i.vertex.code.add(t$10`void main(void) {
vec4 posProj = transform * vec4(position, 0);
gl_Position = alignToPixelCenter(posProj, viewport.zw);
vcolor = color / 1.2;
vsize = size * 5.0 * pixelRatio;
gl_PointSize = vsize;
}`),i.fragment.code.add(t$10`void main() {
float cap = 0.7;
float scale = 1.0 / cap;
float helper = clamp(length(abs(gl_PointCoord - vec2(0.5))), 0.0, cap);
float alpha = clamp((cap - helper) * scale, 0.0, 1.0);
float intensity = alpha * alpha * alpha;
if (vsize < 3.0) {
intensity *= 0.5;
}
gl_FragColor = vec4(vcolor.xyz, intensity);
}`),i}var r$S=Object.freeze({__proto__:null,build:i$I});

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class f$J extends t$11{initializeProgram(e){const r=f$J.shader.get().build();return new n$16(e.rctx,r,o$X)}initializePipeline(){return g$S({blending:e$T(770,1,771,771),depthTest:{func:515},colorWrite:r$13})}bindPass({camera:r,modelMatrix:i}){const t=this.makeInfiniteProjectionMatrix(r.projectionMatrix,r.near,p$V);e$V(t,t,r.viewMatrix),e$V(t,t,i),this.program.setUniformMatrix4fv("transform",t),this.program.setUniform4fv("viewport",r.fullViewport),this.program.setUniform1f("pixelRatio",r.pixelRatio);}makeInfiniteProjectionMatrix(e,i,t){const o=24e-8;return n$18(t,e),t[10]=o-1,t[11]=-1,t[14]=(o-2)*i,t}}f$J.shader=new t$12(r$S,(()=>import('./Stars.glsl-872c8bcc.js')));const p$V=e$P();

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
const T$r=n$12.getLogger("esri.views.3d.environment.Stars");let D$o=class extends p$14{constructor(t){super(t),this.slot=14,this._loadDataTask=null,this._numPoints=0,this._modelMatrix=e$P(),this._updatingTracking=new l$V,this._requestRender=()=>{};}get updating(){return this._updatingTracking.updating||this.loading}get loading(){return r$Y(this._loadDataTask)&&!this._loadDataTask.finished}get canRender(){return !this.loading}initialize(){this._loadDataTask=this._createLoadDataTask();}destroy(){this._loadDataTask=a$$(this._loadDataTask),this._updatingTracking.destroy(),this._numPoints=0,this._technique=i$S(this._technique),this._vao=i$S(this._vao),this._requestRender=null;}initializeRenderContext(t){this._requestRender=t.requestRender;}uninitializeRenderContext(){this.destroy();}render(t){if(t.slot!==this.slot||0!==t.pass)return !1;if(this._ensureResources(t),t$17(this._technique)||t$17(this._vao))return !0;const e=t.rctx,s=this._technique.program;return e.useProgram(s),this._technique.bindPass({camera:t.camera,modelMatrix:this._modelMatrix}),this._technique.bindPipelineState(e),e.bindVAO(this._vao),s.assertCompatibleVertexAttributeLocations(this._vao),e.drawArrays(0,0,this._numPoints),!0}_ensureResources(t){if(r$Y(this._technique)||t$17(S$x))return;const e=t.rctx;this._technique=new f$J({rctx:e,viewingMode:this.view.state.viewingMode},null),this._numPoints=S$x.byteLength/R$q;const s=new Float32Array(S$x,0,2*this._numPoints),r=new Uint8Array(S$x,2*this._numPoints*4,this._numPoints);this._vao=this._createVertexArrayObject(t.rctx,s,r,this._numPoints),this._updatingTracking.add(this.view,"environment.lighting.date",(t=>this._update(t)),2);}_computeDayDuration(t){const e=t,s=new Date(t.getFullYear(),0,1,11,58,56);return (+e-+s)/(+new Date(t.getFullYear()+1,0,1,11,58,55)-+s)}_update(t){if(!t)return;const e=(t.getHours()/12+t.getMinutes()/60*(2/24)+t.getSeconds()/60*(2/1440)-.9972222)%2,s=2*this._computeDayDuration(t),r=this._modelMatrix;n$18(r,P$u),m$W(r,r,-s*Math.PI),e$V(r,M$u,r),m$W(r,r,-e*Math.PI),this._requestRender();}_hexToRGB(t){return [parseInt(t.substring(0,2),16),parseInt(t.substring(2,4),16),parseInt(t.substring(4,6),16)]}_unpackUint8Attributes(t){return t>=192?[2.9,t-192]:t>=160?[2.5,t-160]:t>=128?[2,t-128]:t>=96?[1.5,t-96]:t>=64?[1,t-64]:t>=32?[.7,t-32]:[.4,t]}_createVertexArrayObject(t,e,s,r){const i=A$p.createBuffer(r),a=i.position,o=i.color,n=i.size;for(let c=0;c<r;c++){const t=e[2*c+0],r=e[2*c+1];a.set(c,0,-Math.cos(t)*Math.sin(r)),a.set(c,1,-Math.sin(t)*Math.sin(r)),a.set(c,2,-Math.cos(r));const i=this._unpackUint8Attributes(s[c]),f=this._hexToRGB(q$k[i[1]]);o.set(c,0,255*f[0]),o.set(c,1,255*f[1]),o.set(c,2,255*f[2]),o.set(c,3,255),n.set(c,i[0]);}return new f$M(t,o$X,{geometry:t$16(A$p)},{geometry:h$O.createVertex(t,35044,i.buffer)})}_createLoadDataTask(){if(r$Y(S$x))return null;const t=G$n((async t=>{const{data:s}=await n$1c("esri/views/3d/environment/resources/stars.wsv",{responseType:"array-buffer",signal:t});this._verifyStarData(s),S$x=s;}));return t.promise.catch((t=>{g$T(t)||T$r.error(t);})).then((()=>{this.destroyed||(this._requestRender(),this.notifyChange("updating"));})),t}_verifyStarData(t){if(!t)throw new s$Q("stars:no-data-received","Failed to create stars because star catalogue is missing");const e=t.byteLength/R$q;if(e%1!=0||e>5e4||e<5e3)throw new s$Q("stars:invalid-data","Failed to create stars because star catalogue data is invalid")}};e$Q([y$K({constructOnly:!0})],D$o.prototype,"view",void 0),e$Q([y$K({readOnly:!0})],D$o.prototype,"updating",null),e$Q([y$K()],D$o.prototype,"_loadDataTask",void 0),e$Q([y$K()],D$o.prototype,"_updatingTracking",void 0),D$o=e$Q([n$14("esri.views.3d.environment.Stars")],D$o);const q$k=["9bb2ff","9eb5ff","aabfff","bbccff","ccd8ff ","dae2ff","e4e9ff","eeefff","f8f6ff","fff9fb","fff5ef","fff1e5","ffeddb","ffe9d2","ffe6ca","ffe3c3","ffe0bb","ffddb4","ffdaad","ffd6a5","ffd29c","ffcc8f","ffc178","ffa94b","ff7b00"],M$u=n$1b(1,0,0,0,0,.9174771405229186,.39778850739794974,0,0,-.39778850739794974,.9174771405229186,0,0,0,0,1),P$u=n$1b(1,0,0,0,0,.9174771405229186,-.39778850739794974,0,0,.39778850739794974,.9174771405229186,0,0,0,0,1),R$q=9,A$p=A$u().vec3f("position").vec4u8("color").f32("size");let S$x=null;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
const v$G=[14,15];let g$P=class extends p$14{constructor(){super(...arguments),this._handles=new u$T,this._context=null,this._pendingAtmosphere=null,this._atmosphere=null,this._stars=null;}get canRender(){return !(!this.view.basemapTerrain||!this.view.basemapTerrain.renderer.canRender)||"global"!==this.view.viewingMode}get updating(){return r$Y(this._pendingAtmosphere)||r$Y(this._stars)&&this._stars.updating}initialize(){this.view._stage.addRenderPlugin(v$G,this);}destroy(){this._pendingAtmosphere=l$W(this._pendingAtmosphere),this._atmosphere=l$W(this._atmosphere),this._stars=l$W(this._stars),this._handles=l$W(this._handles),this.view&&null!=this.view._stage&&(this.view._stage.removeRenderPlugin(this),this._set("view",null));}initializeRenderContext(e){this._context=e,this.setup();}setup(){this._handles.add(y$L(this.view,"basemapTerrain",(()=>this._updateBasemapTerrain()),!0)),this._handles.add([d$S(this.view,["viewingMode","environment.atmosphereEnabled","environment.atmosphere.quality"],(()=>this._updateAtmosphere()),!0),d$S(this.view,"environment.starsEnabled",(()=>this._updateStars()),!0)]);}uninitializeRenderContext(){r$Y(this._stars)&&(this._stars.uninitializeRenderContext(),this._stars.destroy(),this._stars=null),r$Y(this._atmosphere)&&(this._atmosphere.uninitializeRenderContext(),this._atmosphere.destroy(),this._atmosphere=null);}render(e){let t=!0;return r$Y(this._stars)&&this._stars.canRender&&(t=this._stars.render(e)&&t),r$Y(this._atmosphere)&&this._atmosphere.canRender&&(t=this._atmosphere.render(e)&&t),t}_setNeedsRender(){this._context&&this._context.requestRender();}_updateStars(){var e,t,s;const i=null!=(e=null==(t=this.view)||null==(s=t.environment)?void 0:s.starsEnabled)&&e;i&&t$17(this._stars)?(this._stars=new D$o({view:this.view}),this._stars.initializeRenderContext(this._context),this._setNeedsRender()):!i&&r$Y(this._stars)&&(this._stars.destroy(),this._stars=null,this._setNeedsRender());}_updateAtmosphere(){const e=this._getAtmosphereType();if(this.atmosphereType===e)return;this.atmosphereType=e,r$Y(this._pendingAtmosphere)&&(this._pendingAtmosphere!==this._atmosphere&&this._pendingAtmosphere.destroy(),this._pendingAtmosphere=null);const t=this._getAtmosphereClass();if(!t)return r$Y(this._atmosphere)&&(this._atmosphere.destroy(),this._atmosphere=null,this._setNeedsRender()),void this._updateBasemapTerrain();const s=new t(this.view);s.initializeRenderContext(this._context),t$17(this._atmosphere)&&(this._atmosphere=s,this._setNeedsRender()),this._pendingAtmosphere=s,s.when().then((()=>{r$Y(this._atmosphere)&&this._pendingAtmosphere!==this._atmosphere&&(this._atmosphere.destroy(),this._atmosphere=this._pendingAtmosphere),this._pendingAtmosphere=null,this._setNeedsRender(),this._updateBasemapTerrain();})).catch((()=>{this._pendingAtmosphere===s&&(this._pendingAtmosphere=null);}));}_getAtmosphereClass(){const e=this._getAtmosphereType();if(this.atmosphereClassFromType)return this.atmosphereClassFromType(e);switch(e){case"none":return null;case"realistic":return S$y;case"panoramic":return v$H;case"simple":return E$t;default:return}}_getAtmosphereType(){const e=this.view.get("environment.atmosphereEnabled"),t=this.view.get("environment.atmosphere.quality"),s=this.view.viewingMode;return !e||null==t||P$y(this.view.spatialReference)?"none":"local"===s?"panoramic":"high"===t&&S$y.isSupported(this._context)&&!k$y(this.view.spatialReference)?"realistic":"simple"}_updateBasemapTerrain(){const e=this.view.basemapTerrain;e&&(e.velvetOverground=null!=this._atmosphere&&"simple"===this.atmosphereType);}get test(){return {atmosphere:this._atmosphere}}};e$Q([y$K({constructOnly:!0})],g$P.prototype,"view",void 0),e$Q([y$K({constructOnly:!0})],g$P.prototype,"atmosphereClassFromType",void 0),e$Q([y$K()],g$P.prototype,"updating",null),e$Q([y$K()],g$P.prototype,"_pendingAtmosphere",void 0),e$Q([y$K()],g$P.prototype,"_stars",void 0),g$P=e$Q([n$14("esri.views.3d.environment.EnvironmentRenderer")],g$P);var w$y=g$P;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
function s$K(t,n,o){return u$M(t,n.longitude,n.latitude,o.longitude,o.latitude)}function u$M(t,r,e,s,u){const i=b$F(e),c=b$F(u),a=i-c,h=b$F(r)-b$F(s),d=Math.sin(a/2),f=Math.sin(h/2),m=2*p$16(Math.sqrt(d*d+Math.cos(i)*Math.cos(c)*f*f))*t;return Math.round(1e4*m)/1e4}function i$H(t,n,o){const u=n.spatialReference,i=p$15(u),c=new b$G(n.x,t.y,u),a=new b$G(o.x,t.y,u),h=new b$G(t.x,n.y,u),d=new b$G(t.x,o.y,u);return {lon:s$K(i.radius,c,a),lat:s$K(i.radius,h,d)}}function c$L(r,e,s){const u=e/s,i=b$F(r),c=Math.sin(u/2),a=Math.cos(i),h=2*p$16(Math.sqrt(c*c/(a*a)));return N$o(h)}function d$J(t,n){let o=t/15;return n||(o=Math.round(o)),o}function m$S(t,n){n||(n={hours:0,minutes:0,seconds:0}),n.hours=d$J(t[0],!0);const o=n.hours%1;n.hours-=o,n.minutes=60*o;const r=n.minutes%1;return n.minutes-=r,n.seconds=Math.round(60*r),n}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
var n$V,t$Q,r$R={exports:{}};n$V=r$R,void 0!==(t$Q=function(){var n=Math.PI,t=Math.sin,r=Math.cos,e=Math.tan,u=Math.asin,a=Math.atan2,o=Math.acos,i=n/180,c=864e5,f=2440588,d=2451545,s={dec:0,ra:0};function v(n){return n.valueOf()/c-.5+f}function O(n){return new Date((n+.5-f)*c)}function M(n){return v(n)-d}var N=23.4397*i;function P(n,u){return a(t(n)*r(N)-e(u)*t(N),r(n))}function h(n,e){return u(t(e)*r(N)+r(e)*t(N)*t(n))}function E(n,u,o){return a(t(n),r(n)*t(u)-e(o)*r(u))}function I(n,e,a){return u(t(e)*t(a)+r(e)*r(a)*r(n))}function T(n,t){return i*(280.16+360.9856235*n)-t}function A(n){return i*(357.5291+.98560028*n)}function L(n){return i*(1.9148*t(n)+.02*t(2*n)+3e-4*t(3*n))}function R(t,r){return t+r+102.9372*i+n}function p(n,t){var r=A(n),e=R(r,L(r));return t||(t={dec:0,ra:0}),t.dec=h(e,0),t.ra=P(e,0),t}var _={POLAR_EXCEPTION:{NORMAL:0,MIDNIGHT_SUN:1,POLAR_NIGHT:2},getPosition:function(n,t,r,e){var u=i*-r,a=i*t,o=M(n),c=p(o,s),f=T(o,u)-c.ra;return e||(e={azimuth:0,altitude:0}),e.azimuth=E(f,a,c.dec),e.altitude=I(f,a,c.dec),e}},l=[[-.83,"sunrise","sunset"]];_.addTime=function(n,t,r){l.push([n,t,r]);};var x=9e-4;function g(t,r){return Math.round(t-x-r/(2*n))}function m(t,r,e){return x+(t+r)/(2*n)+e}function C(n,r,e){return d+n+.0053*t(r)-.0069*t(2*e)}function X(n,e,u){return o((t(n)-t(e)*t(u))/(r(e)*r(u)))}function G(n){var e=i*(134.963+13.064993*n),u=i*(93.272+13.22935*n),a=i*(218.316+13.176396*n)+6.289*i*t(e),o=5.128*i*t(u),c=385001-20905*r(e);return {ra:P(a,o),dec:h(a,o),dist:c}}return _.getTimes=function(n,e,u){var a=i*-u,o=i*e,c=g(M(n),a),f=m(0,a,c),d=A(f),s=L(d),v=R(d,s),N=h(v,0),P=C(f,d,v);function E(n){return C(m(X(n,o,N),a,c),d,v)}function I(n){var e=(t(n)-t(o)*t(N))/(r(o)*r(N));return e<-1?_.POLAR_EXCEPTION.MIDNIGHT_SUN:e>1?_.POLAR_EXCEPTION.POLAR_NIGHT:_.POLAR_EXCEPTION.NORMAL}var T,p,x,G,H,z={solarNoon:O(P),nadir:O(P-.5),polarException:_.POLAR_EXCEPTION.NORMAL};for(T=0,p=l.length;T<p;T+=1)H=P-((G=E((x=l[T])[0]*i))-P),z[x[1]]=O(H),z[x[2]]=O(G);return z.polarException=I(l[0][0]*i),z},_.getMoonPosition=function(n,t,r){var u=i*-r,a=i*t,o=M(n),c=G(o),f=T(o,u)-c.ra,d=I(f,a,c.dec);return d+=.017*i/e(d+10.26*i/(d+5.1*i)),{azimuth:E(f,a,c.dec),altitude:d,distance:c.dist}},_.getMoonFraction=function(n){var e=M(n),u=p(e),i=G(e),c=149598e3,f=o(t(u.dec)*t(i.dec)+r(u.dec)*r(i.dec)*r(u.ra-i.ra)),d=a(c*t(f),i.dist-c*r(f));return (1+r(d))/2},_}())&&(n$V.exports=t$Q);var e$L=r$R.exports;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
const d$I={local:{altitude:1500,ambientAtNight:.1,ambientAtNoon:.45,ambientAtTwilight:.2,diffuseAtNoon:.65,diffuseAtTwilight:.7},global:{altitude:8e5,ambient:.015,diffuse:.75},planarDirection:{localAltitude:1e4,globalAltitude:1e6,globalAngles:{azimuth:1.3*Math.PI,altitude:.6*Math.PI}}};function g$O(i,n){const o=n[2],a=O$w;o$S(a.ambient.color,1,1,1),a.ambient.intensity=d$I.global.ambient,o$S(a.diffuse.color,1,1,1),a.diffuse.intensity=d$I.global.diffuse;let l=(Math.abs(o)-d$I.local.altitude)/(d$I.global.altitude-d$I.local.altitude);l=o$R(l,0,1),a.globalFactor=l;const r=e$L.getTimes(i,n[1],n[0]);if(l<1){const e=y$H(i,r);y$N(a.ambient.color,e.ambient.color,a.ambient.color,l),a.ambient.intensity=m$V(e.ambient.intensity,a.ambient.intensity,l),y$N(a.diffuse.color,e.diffuse.color,a.diffuse.color,l),a.diffuse.intensity=m$V(e.diffuse.intensity,a.diffuse.intensity,l);}return a.noonFactor=T$q(i,r),a}function b$B(t,l,u,c){c||(c=n$11());const g=N$m,b=r$$(p$U);if("global"===u)e$L.getPosition(t,0,0,g),o$S(c,0,0,-1),b$H(b,b,-g.azimuth),l$X(b,b,-g.altitude),I$x(c,c,b);else {const i=d$I.planarDirection,o=i.globalAngles,u=l[2];let f=(Math.abs(u)-i.localAltitude)/(i.globalAltitude-i.localAltitude);f=o$R(f,0,1),f<1?(e$L.getPosition(t,l[1],l[0],g),g.azimuth=(1-f)*g.azimuth+f*o.azimuth,g.altitude=(1-f)*g.altitude+f*o.altitude):(g.azimuth=o.azimuth,g.altitude=o.altitude),o$S(c,0,-1,0),m$W(b,b,-g.azimuth),b$H(b,b,-g.altitude),I$x(c,c,b);}return c}function h$I(t,e){if("global"===e)return !0;{const e=d$I.planarDirection,i=t[2];return Math.abs(i)<e.localAltitude}}const p$U=e$P(),N$m={azimuth:0,altitude:0},O$w={ambient:{color:n$11(),intensity:0},diffuse:{color:n$11(),intensity:0,directionToLightSource:n$11()},globalFactor:0,noonFactor:0};function T$q(t,i){const n=t.valueOf();let o,a;i.polarException===e$L.POLAR_EXCEPTION.MIDNIGHT_SUN?(o=n-60*(t.getHours()+48)*60*1e3-60*t.getMinutes()*1e3,a=o+432e6):i.polarException===e$L.POLAR_EXCEPTION.POLAR_NIGHT?(o=n-2,a=n-1):(o=i.sunrise.valueOf(),a=i.sunset.valueOf());const l=o+(a-o)/2;return 1-o$R(Math.abs(n-l)/432e5,0,1)}function y$H(t,e){const i=t.valueOf();let n,o;e.polarException===e$L.POLAR_EXCEPTION.MIDNIGHT_SUN?(n=i-60*(t.getHours()+48)*60*1e3-60*t.getMinutes()*1e3,o=n+432e6):e.polarException===e$L.POLAR_EXCEPTION.POLAR_NIGHT?(n=i-2,o=i-1):(n=e.sunrise.valueOf(),o=e.sunset.valueOf());const a=o-n,l=n+a/2,s=a/4,u=l-s,r=l+s,f=.06*a,g=n-f/2,b=n+f/2,h=o-f/2,A=o+f/2,p=d$I.local,N=[.01,p.ambientAtNight],O=[.8,.8,1],T=[.01,.01,.01],y=[p.diffuseAtTwilight,p.ambientAtTwilight],E=[1,.75,.75],I=[.8,.8,1],M=[.9*p.diffuseAtNoon,p.ambientAtNoon],z=[1,.98,.98],v=[.98,.98,1],_=[p.diffuseAtNoon,p.ambientAtNoon],j=[1,1,1],D=[1,1,1],L=M,H=z,R=v,k=y,w=E,x=I;let C,S,F=[0,0],G=[0,0,0],X=[0,0,0];return i<g||i>A?(F=N,G=T,X=O,S="night"):i<b?(C=b-g,F=P$t(i-g,C,N,y),G=P$t(i-g,C,T,E),X=P$t(i-g,C,O,I),S="sun rising"):i<u?(C=u-b,F=P$t(i-b,C,y,M),G=P$t(i-b,C,E,z),X=P$t(i-b,C,I,v),S="early morning"):i<l?(C=l-u,F=P$t(i-u,C,M,_),G=P$t(i-u,C,z,j),X=P$t(i-u,C,v,D),S="late morning"):i<r?(C=r-l,F=P$t(i-l,C,_,L),G=P$t(i-l,C,j,H),X=P$t(i-l,C,D,R),S="early afternoon"):i<h?(C=h-r,F=P$t(i-r,C,L,k),G=P$t(i-r,C,H,w),X=P$t(i-r,C,R,x),S="late afternoon"):i<A&&(C=A-h,F=P$t(i-h,C,k,N),G=P$t(i-h,C,w,T),X=P$t(i-h,C,x,O),S="sun setting"),{diffuse:{intensity:F[0],color:t$_(G[0],G[1],G[2])},ambient:{intensity:F[1],color:t$_(X[0],X[1],X[2])},timeOfDay:S}}function P$t(t,e,i,n){const o=[];for(let a=0;a<i.length;a++)o[a]=(n[a]-i[a])*t/e+i[a];return o}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class i$G{constructor(t=n$11()){this.intensity=t;}}class c$K{constructor(i=n$11(),c=t$_(.57735,.57735,.57735)){this.intensity=i,this.direction=c;}}class o$N{constructor(i=n$11(),c=t$_(.57735,.57735,.57735),o=!0){this.intensity=i,this.direction=c,this.castShadows=o;}}class r$Q{constructor(){this.r=[0],this.g=[0],this.b=[0];}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
const L$p=t$_(.5773502691896258,-.5773502691896258,.5773502691896258);let W$h=class extends n$13.EventedAccessor{constructor(...e){super(...e),this._referencePointUpdateDelay=200,this._referencePointUpdateInterval=3e3,this._referencePointUpdateDistThreshold=1e6,this._referencePosUpdateQuery=null,this._referencePosMapCoordsRequested=null,this._viewHandles=new u$T,this._preserveAbsoluteDateTime=!1,this._trackingEnabled=!1,this._referencePosResetPreserveAbsoluteTime=!1,this.referencePosUpdateTimer=null,this._referencePosMapCoords=null,this._mainLight=new o$N,this._ambientLight=new i$G,this._moonLight=new c$K,this._renderer=null,this._referencePosWGS84Comparable=null,this._resetReferencePosition();}destroy(){this.disconnectView(),this._viewHandles.destroy();}get updating(){return !!(!this.disableQueries&&(this._referencePosUpdateQuery||this._referencePosMapCoordsRequested)||this._renderer&&this._renderer.updating)}get referencePositionWGS84Comparable(){return this._referencePosWGS84Comparable}connectView(e){this._renderer||(this._view=e,this._renderer=new w$y({view:e}),this._viewHandles.add([e.watch("environment.lighting.date",(e=>this._lightingDateHandler(e)),!0),e.watch("stationary",(()=>this._interactingStationaryHandler())),e.watch(["environment.lighting.directShadowsEnabled","environment.lighting.ambientOcclusionEnabled","environment.lighting.waterReflectionEnabled","environment.background.color"],(()=>this._updateRenderParamsHandler()),!0),e.watch("spatialReference",(()=>this._resetReferencePosition(!0)),!0),d$S(e,"viewingMode",(()=>this._resetReferencePosition(!0)),!0),d$S(e,"environment.lighting.cameraTrackingEnabled",(e=>this._updateCameraTracking(e)),!0),d$S(e,"state.camera",(()=>this._cameraHandler(null)),!0),this.watch("disableQueries",(()=>this._cameraHandler(null)))]),this._updateRenderParamsHandler(),this._updateLightParams(),this._cameraHandler(),this.notifyChange("updating"));}disconnectView(){this._renderer&&(this._viewHandles.removeAll(),this._resetReferencePosition(),this._renderer.destroy(),this._renderer=null,this._view=null);}_updateCameraTracking(e){if(this._trackingEnabled=e,e)this._cameraHandler();else {const e=this._view.environment.lighting;e&&(e.positionTimezoneInfo.autoUpdated=!1);}}_lightingDateHandler(e){if(!e)return;const t=this._view.environment.lighting;if(!t.positionTimezoneInfo.autoUpdated){this._preserveAbsoluteDateTime=!0;const r=this._view.spatialReference;if(!Zn(r)){const e=this._view.camera.position;if(!this._referencePosMapCoords||!this._referencePosMapCoords.equals(e))return void this._requestReferencePositionUpdate(e)}if(this._preupdateTracking(e),r$Y(this._referencePosWGS84Comparable)){const e=m$S(this._referencePosWGS84Comparable,k$t);r$Y(e)&&(t.autoUpdate(null,e),this._trackingEnabled&&(t.positionTimezoneInfo.autoUpdated=!0));}}this._updateLightParams(e);}_preupdateTracking(e){!this._trackingEnabled&&this._view.environment.lighting.cameraTrackingEnabled&&this._cameraHandler(e);}_cameraHandler(e=null){if(!this._view.ready)return;const t=this._view.camera;t&&(this._cameraHandlerClientSide(t,e)||this._cameraHandlerServerSide(t));}_cameraHandlerClientSide(e,t){const r=o$Y(this._view.spatialReference);if(r&&!Zn(this._view.spatialReference))return !1;const i=e.position;return t$17(this._referencePosWGS84Comparable)&&(this._referencePosWGS84Comparable=n$11()),r?yn(i,this._referencePosWGS84Comparable):o$S(this._referencePosWGS84Comparable,i.longitude,i.latitude,i.z),this.notifyChange("referencePositionWGS84Comparable"),this._autoUpdateTimezone(this._referencePosWGS84Comparable,t)||this._updateLightParams(t),!0}_cameraHandlerServerSide(e){const t=e.position;(!this._referencePosMapCoords||this._referencePosMapCoordsRequested||this._exceedsReferencePosDistThreshold(t))&&this._requestReferencePositionUpdate(t,!0),this._view.mapCoordsHelper&&this._referencePosWGS84Comparable&&(this._referencePosWGS84Comparable[2]=t.z*this._view.mapCoordsHelper.unitInMeters,this._referencePosChanged());}_interactingStationaryHandler(){this._view.stationary&&this._executePendingReferencePositionUpdate();}_updateLightParams(e){const t=this._view.environment.lighting;e=e||t.date;const r=this._view._stage;let i;r$Y(this._referencePosWGS84Comparable)?(i=g$O(e,this._referencePosWGS84Comparable),b$B(e,this._referencePosWGS84Comparable,this._view.viewingMode,i.diffuse.directionToLightSource)):i={diffuse:{color:[1,1,1],intensity:.55,directionToLightSource:L$p},ambient:{color:[1,1,1],intensity:.55},noonFactor:.5,globalFactor:0},d$O(this._mainLight.intensity,i.diffuse.color,i.diffuse.intensity*Math.PI),r$Z(this._mainLight.direction,i.diffuse.directionToLightSource),d$O(this._ambientLight.intensity,i.ambient.color,i.ambient.intensity),y$N(this._moonLight.intensity,E$s,D$n,i.globalFactor);const n=(1-.5*i.globalFactor)*(1-.4*i.noonFactor*(1-i.globalFactor));d$O(this._moonLight.intensity,this._moonLight.intensity,n),r$Z(this._moonLight.direction,i.diffuse.directionToLightSource),r.renderView.updateLightSources([this._mainLight,this._ambientLight,this._moonLight],1-i.noonFactor,i.globalFactor),this._updateRenderParamsHandler();}_autoUpdateTimezone(e,t=null){if(!this._view.environment.lighting.cameraTrackingEnabled||t$17(e))return !1;const r=j$C;r.setTime((t||this._view.environment.lighting.date).getTime());const i=m$S(e,k$t);if(t$17(i))return !1;let s=this._view.environment.lighting.positionTimezoneInfo;if(s.autoUpdated){if(s.hours===i.hours&&s.minutes===i.minutes&&s.seconds===i.seconds)return !1}else s=i;const o=r.getUTCHours()-(i.hours-s.hours),a=r.getUTCMinutes()-(i.minutes-s.minutes),c=r.getUTCSeconds()-(i.seconds-s.seconds);return r.setUTCHours(o),r.setUTCMinutes(a),r.setUTCSeconds(c),!t&&this._view.environment.lighting.autoUpdate(r,i)}_updateRenderParamsHandler(){const e=this._view._stage;if(!e)return;const r=v$M(this._referencePosWGS84Comparable,!0,(e=>h$I(e,this._view.viewingMode))),i=this._view.environment.background,s=i instanceof n$_?{type:"color",color:e$W(o$W.toUnitRGBA(i.color))}:{type:"color",color:r$19(0,0,0,1)};e.renderView.setRenderParameters({shadowMap:this._view.environment.lighting.directShadowsEnabled&&r,ssao:this._view.environment.lighting.ambientOcclusionEnabled,waterReflectionEnabled:this._view.environment.lighting.waterReflectionEnabled,background:s});}_resetReferencePosition(e=!1){this._cancelReferencePosUpdates(),this._referencePosMapCoords=null,this._referencePosMapCoordsRequested=null,this._referencePosResetPreserveAbsoluteTime=null,this._referencePosWGS84Comparable=null,this.notifyChange("updating"),e&&this._cameraHandler(null);}_requestReferencePositionUpdate(e,t=!1){if(!this.disableQueries&&(this._referencePosMapCoordsRequested?this._referencePosMapCoordsRequested.copy(e):this._referencePosMapCoordsRequested=e.clone(),this._referencePosResetPreserveAbsoluteTime=!!t,!this._referencePosUpdateQuery&&!this.referencePosUpdateTimer&&this._view.stationary)){const e=this._referencePosUpdateQuery=C$r(this._referencePointUpdateDelay).then((()=>{if(this._referencePosUpdateQuery===e){const t=()=>this._referencePosUpdateQuery!==e;return this._doReferencePositionUpdateQuery(t)}})).catch((e=>{"mapcoordshelper:missing-geometry-service"===e.name&&(this.disableQueries=!0);})).then((()=>{this._referencePosUpdateQuery===e&&(this._referencePosUpdateQuery=null,this.referencePosUpdateTimer||this._executePendingReferencePositionUpdate(),this.notifyChange("updating"));})),t=this.referencePosUpdateTimer=C$r(this._referencePointUpdateInterval).then((()=>{this.referencePosUpdateTimer===t&&(this.referencePosUpdateTimer=null,this._referencePosUpdateQuery||this._executePendingReferencePositionUpdate());}));this.notifyChange("updating");}}async _doReferencePositionUpdateQuery(e){this._referencePosResetPreserveAbsoluteTime&&(this._preserveAbsoluteDateTime=!1),this._referencePosMapCoords?this._referencePosMapCoords.copy(this._referencePosMapCoordsRequested):this._referencePosMapCoords=this._referencePosMapCoordsRequested.clone(),this._referencePosResetPreserveAbsoluteTime=null,this._referencePosMapCoordsRequested=null;const t=await this._view.mapCoordsHelper.toGeographic(this._referencePosMapCoords);if(!e()&&!isNaN(t[0])&&!isNaN(t[1])){const e=this._referencePosMapCoords.z*this._view.mapCoordsHelper.unitInMeters;this._referencePosWGS84Comparable?(this._referencePosWGS84Comparable[0]=t[0],this._referencePosWGS84Comparable[1]=t[1],this._referencePosWGS84Comparable[2]=e):this._referencePosWGS84Comparable=[t[0],t[1],e],this._referencePosChanged();}}_executePendingReferencePositionUpdate(){const e=this._referencePosMapCoordsRequested;e&&this._requestReferencePositionUpdate(e,this._referencePosResetPreserveAbsoluteTime);}_referencePosChanged(){this._preserveAbsoluteDateTime?this._updateLightParams():this._autoUpdateTimezone(this._referencePosWGS84Comparable)||this._updateLightParams(),this.notifyChange("referencePositionWGS84Comparable");}_exceedsReferencePosDistThreshold(e){if(this._referencePosMapCoords){let t=this._referencePosMapCoords.distance(e);return this._view.mapCoordsHelper&&(t*=this._view.mapCoordsHelper.unitInMeters),t>this._referencePointUpdateDistThreshold}return !0}_cancelReferencePosUpdates(){const e=!!this._referencePosUpdateQuery;return this._referencePosUpdateQuery=null,this.referencePosUpdateTimer=null,e}get test(){const e=this;return {renderer:this._renderer,set referencePointUpdateInterval(t){e._referencePointUpdateInterval=t;},set referencePointUpdateDistThreshold(t){e._referencePointUpdateDistThreshold=t;},set referencePosUpdateTimer(t){e.referencePosUpdateTimer=t;},set referencePointUpdateDelay(t){e._referencePointUpdateDelay=t;}}}};W$h.FIXED_LIGHT_DIRECTION=L$p,e$Q([y$K({type:Boolean,readOnly:!0})],W$h.prototype,"updating",null),e$Q([y$K()],W$h.prototype,"disableQueries",void 0),e$Q([y$K()],W$h.prototype,"referencePositionWGS84Comparable",null),e$Q([y$K()],W$h.prototype,"_renderer",void 0),e$Q([y$K()],W$h.prototype,"_referencePosWGS84Comparable",void 0),W$h=e$Q([n$14("esri.views.3d.environment.SceneViewEnvironmentManager")],W$h);const j$C=new Date,k$t={hours:0,minutes:0,seconds:0},E$s=t$_(.22,.22,.33),D$n=t$_(.22,.22,.22);var Q$j=W$h;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
function m$R(t,a){return 0!=(t&a)}function r$P(t,a,n,i,m,r){0!==t&&(n?(r.min=Math.min(r.min,a),r.max=Math.max(r.max,a)):null!=i?(r.min-=Math.max(0,(a-r.min)*(1-i)),r.max+=Math.max(0,(a-r.max)*(1-i))):m&&(r.min-=Math.max(0,a-r.min-m),r.max+=Math.max(0,a-r.max-m)));}const o$M={selection:0,interactionType:0,interactionFactor:0,interactionStartCamera:null,interactionDirection:null,tiltMode:0};function e$K(m,r,o,e){return r=r||m.viewForward,r$Z(e,r),d$O(e,e,s$T(z$u(r,o))),e}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
function h$H(r,n,t,i){return b$A(r,n,t,k$s(i,n,t,!0))}function j$B(r,c,u,o){const f=z$u(u,c$V(r,o,c));return u$S(r,c,d$O(r,u,f))}const g$N={dir:n$11(),len:0,clip:n$19()};function k$s(r,n,i,f){const s=g$N;return r?(i&&f&&(s.len=q$o(n,i)),r$Z(s.dir,r)):f?(s.len=q$o(n,i),c$V(s.dir,i,n),d$O(s.dir,s.dir,1/s.len)):(c$V(s.dir,i,n),j$F(s.dir,s.dir)),s}function v$F(r,t,i){const e=z$u(W$j(r),i.dir),c=-R$s(r,t);if(c<0&&e>=0)return !1;if(e>-1e-6&&e<1e-6)return c>0;if((c<0||e<0)&&!(c<0&&e<0))return !0;const u=c/e;return e>0?u<i.clip[1]&&(i.clip[1]=u):u>i.clip[0]&&(i.clip[0]=u),i.clip[0]<=i.clip[1]}function b$A(r,n,t,i){i.clip[0]=0,i.clip[1]=t?i.len:Number.MAX_VALUE;for(let e=0;e<r.length;e++)if(!v$F(r[e],n,i))return !1;return !0}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
function p$T(t,o,i=o$M){const m=d$H(t,o,i);if(0===m)return !1;const u=t.renderCoordsHelper,p=u.getAltitude(o.eye)+m,l=e$K(o,i.interactionDirection,j$A(t,o,s$T(m),C$m),A$o),y=r$Z(h$G,o.viewForward),x=u.intersectInfiniteManifold(d$R(o.eye,l),p,H$h);return o.eye=r$Y(x)?x:u.setAltitude(H$h,p,o.eye),o.center=j$B(H$h,o.eye,y,o.center),!0}function d$H(e,r,n=o$M){if(!l$M(e,n))return 0;const o=x$I(e.state.constraints.altitude,g$M);y$G(e,n,o);const i=e.renderCoordsHelper.getAltitude(r.eye),s=o$R(i,o.min,o.max)-i;return Math.abs(s)<=1e-6?0:s}function l$M(t,e){const r=t.state.constraints.altitude;return !(!t.state.isGlobal||!r)&&(2!==e.interactionType||!m$R(e.selection,1))}function y$G(t,e,r){const n=e.interactionType;if(0===n)return;const{min:o,max:i}=r,{interactionStartCamera:s,interactionFactor:c}=e,a=2===n||1===n,m=d$H(t,s),f=0===m?0:t.renderCoordsHelper.getAltitude(s.eye);r.min=o,r.max=i;r$P(m,f,a,c,.05*f,r);}function j$A(t,e,r,n){return t.renderCoordsHelper.worldUpAtPosition(e.eye,n),d$O(n,n,r),n}function x$I(t,e){return e.min=t.min,e.max=t.max,e}const g$M={min:0,max:0},A$o=n$11(),C$m=n$11(),h$G=n$11(),H$h=n$11();

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
function d$G(e,n,r=o$M){if(!e.state.isLocal)return 0;const t=e.state.constraints.distance;if(!e.pointsOfInterest.surfaceOrigin.renderLocation||t===1/0)return 0;x$H.min=0,x$H.max=t,O$v(e,r,x$H);const o=g$L(e,n),i=x$H.max-o;return i>=-1e-6?0:i}function y$F(n,t,s=o$M){const p=d$G(n,t,s);if(0===p)return !1;const y=n.pointsOfInterest.surfaceOrigin,O=g$L(n,t)+p,x=r$Z(l$L,t.eye),C=e$K(t,s.interactionDirection,j$z(n,t,h$F),L$o);if(!V$l(w$C(y.renderLocation,O),d$R(t.eye,C),k$r))return !1;t.eye=k$r;const b=c$V(I$s,t.eye,x);t.center=u$S(k$r,t.center,b);const v=n.renderCoordsHelper.getAltitude(t.center),H=n.renderCoordsHelper.intersectInfiniteManifold(t.ray,v,k$r);return r$Y(H)&&(t.center=H),!0}function O$v(e,n,r){const t=n.interactionType;if(0===t)return;const{min:o,max:i}=r,{interactionStartCamera:s,interactionFactor:c}=n,a=1===t||4===t,f=d$G(e,s),m=0===f?0:g$L(e,s);r.min=o,r.max=i;r$P(f,m,a,c,.05*m,r);}function g$L(e,r){const t=e.pointsOfInterest.surfaceOrigin;return q$o(r.eye,t.renderLocation)}function j$z(e,n,r){const o=e.pointsOfInterest.surfaceOrigin;return H$m(r,n.eye,o.renderLocation)}const x$H={min:0,max:0},l$L=n$11(),I$s=n$11(),L$o=n$11(),h$F=n$11(),k$r=n$11();

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class i$F{constructor(){this.verticalOffset=0,this.selectionMode=!1,this.hud=!0,this.selectOpaqueTerrainOnly=!0,this.invisibleTerrain=!1,this.backfacesTerrain=!0,this.isFiltered=!1,this.store=2;}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class o$L{constructor(){this._disposed=!1;}get disposed(){return this._disposed}get shaderTransformation(){return this._shaderTransformation}acquire(t,r,i,o,e,a){this.id=e$Y(),this.geometry=t,this.material=r,this.transformation=i,this.instanceParameters=o,this.origin=e,this._shaderTransformation=a,this._disposed=!1;}release(){this._disposed=!1;}dispose(){this._disposed=!0;}getStaticTransformation(){return this.transformation}getShaderTransformation(){return r$Y(this._shaderTransformation)?this._shaderTransformation(this.transformation):this.transformation}computeAttachmentOrigin(t){return !!(this.material.computeAttachmentOrigin?this.material.computeAttachmentOrigin(this.geometry,t):this.geometry.computeAttachmentOrigin(t))&&(I$x(t,t,this.getStaticTransformation()),!0)}}o$L.pool=new e$X(o$L);

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class r$O{constructor(r){this.channel=r,this.id=e$Y();}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class R$p extends r$1a{constructor(t={}){super(),this.type=1,this._geometryRecords=new Array,this._geometries=new Array,this._objectTransformation=e$P(),this._bvObjectSpace=new T$p,this._bvWorldSpace=new T$p,this._bvDirty=!0,this._hasVolatileTransformation=!1,this._visible=!0,this.castShadow=null==t.castShadow||t.castShadow,this.metadata=t.metadata,this.metadata&&this.metadata.isElevationSource&&(this.metadata.lastValidElevationBB=new x$G),this.transformation=e$P();const{geometries:e,materials:s,transformations:i,origins:r}=t;if(Array.isArray(e)){i$R(s.length===e.length,"Object3D: materials don't match geometries"),i$R(i.length===e.length,"Object3D: transformations don't match geometries"),this._geometryRecords.length=e.length,this._geometries.length=e.length;for(let t=0;t<e.length;t++)this._geometries[t]=e[t],this._geometryRecords[t]=o$L.pool.acquire(e[t],s[t],r$1b(i[t]),{highlights:null,occludees:null,visible:!0},r&&r[t]);}}get geometryRecords(){return this._geometryRecords}get geometries(){return this._geometries}get transformation(){return this._objectTransformation}set transformation(t){n$18(this._objectTransformation,t),this._invalidateBoundingVolume(),this._emit("objectTransformation",this);}dispose(){this._geometryRecords.length=0,this._geometries.length=0;}get parentLayer(){return this._parentLayer}set parentLayer(t){i$R(null==this._parentLayer||null==t,"Object3D can only be added to a single Layer"),this._parentLayer=t;}getNumGeometryRecords(){return this._geometryRecords.length}getGeometryRecord(t){return i$R(t>=0&&t<this._geometryRecords.length,"Object3d.getGeometryDataByIndex: index out of range"),this._geometryRecords[t]}addGeometry(e,s,i,r,o,a){i=i||a$10,this._geometries.push(e);const h=o$L.pool.acquire(e,s,i,r||{highlights:null,occludees:null,visible:!0},o,a);return this._geometryRecords.push(h),this._hasVolatileTransformation=this._hasVolatileTransformation||r$Y(h.shaderTransformation),this._emit("objectGeometryAdded",{object:this,record:h}),this._invalidateBoundingVolume(),h}removeGeometry(e){const s=this._geometryRecords.splice(e,1)[0];return this._hasVolatileTransformation=r$Y(s.shaderTransformation)?this._geometryRecords.some((e=>r$Y(e.shaderTransformation))):this._hasVolatileTransformation,s.dispose(),this._geometries.splice(e,1),this._emit("objectGeometryRemoved",{object:this,record:s}),this._invalidateBoundingVolume(),s}removeAllGeometries(){for(;this.getNumGeometryRecords()>0;)this.removeGeometry(0);}geometryVertexAttrsUpdated(t){this._emit("vertexAttrsUpdated",{object:this,record:this._geometryRecords[t]}),this._invalidateBoundingVolume();}get isVisible(){return this._visible}setVisible(t){this._visible=t;for(const e of this._geometryRecords)e.instanceParameters.visible=this._visible;this._emit("visibilityChanged",this);}maskOccludee(){const t=new r$O(1);for(const e of this._geometryRecords)e.instanceParameters.occludees=u$V(e.instanceParameters.occludees,t);return this._emit("occlusionChanged",this),t}removeOcclude(t){for(const e of this._geometryRecords)e.instanceParameters.occludees=l$Y(e.instanceParameters.occludees,t);this._emit("occlusionChanged",this);}highlight(){const t=new r$O(0);for(const e of this._geometryRecords)e.instanceParameters.highlights=u$V(e.instanceParameters.highlights,t);return this._emit("highlightChanged",this),t}removeHighlight(t){for(const e of this._geometryRecords)e.instanceParameters.highlights=l$Y(e.instanceParameters.highlights,t);this._emit("highlightChanged",this);}getCombinedStaticTransformation(t,s){return e$V(c$W(s,e$P()),this.transformation,t.getStaticTransformation())}getCombinedShaderTransformation(t,e){return e=e||e$P(),e$V(e,this.transformation,t.getShaderTransformation()),e}hasVolativeTransformation(){return this._hasVolatileTransformation}get boundingVolumeWorldSpace(){return this._validateBoundingVolume(),this._bvWorldSpace}get boundingVolumeObjectSpace(){return this._validateBoundingVolume(),this._bvObjectSpace}_validateBoundingVolume(){if(!this._bvDirty&&!this._hasVolatileTransformation)return;this._bvObjectSpace.init(),this._bvWorldSpace.init();for(let s=0;s<this._geometryRecords.length;++s){const e=this._geometries[s],i=this._geometryRecords[s],r=e.boundingInfo;r$Y(r)&&(this._calculateTransformedBoundingVolume(r,this._bvObjectSpace,i.getShaderTransformation()),this._calculateTransformedBoundingVolume(r,this._bvWorldSpace,this.getCombinedShaderTransformation(i)));}y$N(this._bvObjectSpace.bounds,this._bvObjectSpace.min,this._bvObjectSpace.max,.5),y$N(this._bvWorldSpace.bounds,this._bvWorldSpace.min,this._bvWorldSpace.max,.5);const e=n$11(),i=n$11(),r=d$T(this.transformation);for(let t=0;t<this._geometryRecords.length;++t){const o=this._geometries[t].boundingInfo;if(t$17(o))continue;const a=this._geometryRecords[t].getShaderTransformation(),n=d$T(a);I$x(e,o.getCenter(),a);const h=q$o(e,this._bvObjectSpace.bounds),d=o.getBSRadius()*n;this._bvObjectSpace.bounds[3]=Math.max(this._bvObjectSpace.bounds[3],h+d),I$x(i,e,this.transformation);const l=q$o(i,this._bvWorldSpace.bounds),g=d*r;this._bvWorldSpace.bounds[3]=Math.max(this._bvWorldSpace.bounds[3],l+g);}this._bvDirty=!1;}_calculateTransformedBoundingVolume(t,e,s){const i=t.getBBMin(),r=t.getBBMax(),o=r$_(i),a=r$_(r);I$x(o,o,s),I$x(a,a,s);for(let n=0;n<3;++n)e.min[n]=Math.min(e.min[n],o[n],a[n]),e.max[n]=Math.max(e.max[n],o[n],a[n]);for(let n=0;n<3;++n){r$Z(o,i),r$Z(a,r),o[n]=r[n],a[n]=i[n],I$x(o,o,s),I$x(a,a,s);for(let t=0;t<3;++t)e.min[t]=Math.min(e.min[t],o[t],a[t]),e.max[t]=Math.max(e.max[t],o[t],a[t]);}}_invalidateBoundingVolume(){this._bvDirty=!0,r$Y(this._parentLayer)&&this._parentLayer.notifyObjectBBChanged(this,this._bvWorldSpace.bounds);}_emit(e,s){r$Y(this._parentLayer)&&this._parentLayer.events.emit(e,s);}get test(){const t=this;return {hasGeometry:e=>t._geometries.indexOf(e)>-1,getGeometryIndex:e=>t._geometries.indexOf(e)}}}class x$G{constructor(){this.min=t$_(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this.max=t$_(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);}isEmpty(){return this.max[0]<this.min[0]&&this.max[1]<this.min[1]&&this.max[2]<this.min[2]}}class T$p extends x$G{constructor(){super(...arguments),this.bounds=_$o();}init(){o$S(this.min,Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),o$S(this.max,-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),k$A(this.bounds);}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
function g$K(t){return (r,s,e)=>(y$N(v$E,r,s,e),!cs(t,v$E))}class f$I{constructor(){this.min=new j$y,this.max=new j$y,this.hud=new j$y,this.ground=new j$y;}init(t){this.min.init(t),this.max.init(t),this.hud.init(t),this.ground.init(t),this.all=[];}}class j$y{constructor(t){this.normal=n$11(),this.transformation=e$P(),this._ray=a$11(),this.init(t);}get ray(){return this._ray}get hasIntersectionPoint(){return null!=this.dist}get distanceInRenderSpace(){if(null!=this.dist)return d$O(O$u,this.ray.direction,this.dist),s$P(O$u)}getIntersectionPoint(t){return !!this.hasIntersectionPoint&&(d$O(O$u,this.ray.direction,this.dist),u$S(t,this.ray.origin,O$u),!0)}getTransformedNormal(t){return r$Z(I$r,this.normal),I$r[3]=0,y$O(I$r,I$r,this.transformation),r$Z(t,I$r),j$F(t,t),t}init(t){this.dist=void 0,this.target=void 0,this.name=void 0,this.drapedLayerOrder=void 0,this.drapedLayerGraphicOrder=void 0,this.center=null,this.geometryId=null,this.triangleNr=null,this.intersector="Stage",t?m$X(t,this._ray):this._ray=a$11();}set(r,i,s,e,a,o,h,c,m,l){r instanceof R$p&&(r={type:"stage",obj:r}),this.dist=s,r$Z(this.normal,e),n$18(this.transformation,a),this.target=r,this.name=i,this.drapedLayerOrder=o,this.center=h?r$_(h):null,this.geometryId=c,this.triangleNr=m,this.drapedLayerGraphicOrder=l;}copyFrom(r){m$X(r.ray,this._ray),this.dist=r.dist,this.target=r.target,this.name=r.name,this.drapedLayerOrder=r.drapedLayerOrder,this.center=r.center?r$_(r.center):null,this.geometryId=r.geometryId,this.triangleNr=r.triangleNr,this.intersector=r.intersector,this.drapedLayerGraphicOrder=r.drapedLayerGraphicOrder,r$Z(this.normal,r.normal),n$18(this.transformation,r.transformation);}}const v$E=n$11(),O$u=n$11(),I$r=n$1a();

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
const m$Q=1e-5;class u$L{constructor(t){this.options=new i$F,this.results=new f$I,this.transform=new z$v,this.performanceInfo={queryDuration:0,numObjectsTested:0},this.tolerance=m$Q,this.verticalOffset=null,this._ray={origin:n$11(),direction:n$11()},this._rayEndPoint=n$11(),this._rayStartPointTransformed=n$11(),this._rayEndPointTransformed=n$11(),this.viewingMode=null==t?1:t;}get ray(){return this._ray}get rayBeginPoint(){return this._ray.origin}get rayEndPoint(){return this._rayEndPoint}reset(t,r){this.resetWithRay(j$G(t,r,this._ray));}resetWithRay(t){t!==this._ray&&m$X(t,this._ray),0!==this.options.verticalOffset?2===this.viewingMode?this._ray.origin[2]-=this.options.verticalOffset:this.verticalOffset=this.options.verticalOffset:this.verticalOffset=null,u$S(this._rayEndPoint,this._ray.origin,this._ray.direction),this._numObjectsTested=0,this.results.init(this._ray);}intersect(r=null,s,e,i,a,n){this.point=s,this.camera=e,this.filterPredicate=a,this.tolerance=null==i?m$Q:i;const o=_$p(this.verticalOffset);if(r$Y(r)&&r.length>0){const s=n?t=>{n(t)&&this.intersectObject(t);}:t=>{this.intersectObject(t);};for(const e of r){const r=e.getSpatialQueryAccelerator&&e.getSpatialQueryAccelerator();r$Y(r)?(r$Y(o)?r.forEachAlongRayWithVerticalOffset(this._ray.origin,this._ray.direction,s,o):r.forEachAlongRay(this._ray.origin,this._ray.direction,s),this.options.selectionMode&&this.options.hud&&r.forEachDegenerateObject(s)):e.objects.forAll((t=>s(t)));}}this.sortResults();}intersectObject(s){this._numObjectsTested++;const i=s.geometryRecords;if(!i)return;const a=s.id,n=s.transformation;let o;const h=_$p(this.verticalOffset);for(const c of i){const{geometry:i,material:l,instanceParameters:m}=c;if(f$N(m))continue;o=i.id,this.transform.setAndInvalidateLazyTransforms(n,c.getShaderTransformation()),I$x(this._rayStartPointTransformed,this._ray.origin,this.transform.inverse),I$x(this._rayEndPointTransformed,this._rayEndPoint,this.transform.inverse);const u=this.transform.transform;r$Y(h)&&(h.objectTransform=this.transform),l.intersect(i,m,this.transform.transform,this,this._rayStartPointTransformed,this._rayEndPointTransformed,((e,i,n,h,c,l)=>{if(e>=0){if(r$Y(this.filterPredicate)&&!this.filterPredicate(this._ray.origin,this._rayEndPoint,e))return;const f=`Object3D ${a}`;if(c)return void((null==this.results.hud.dist||e<this.results.hud.dist)&&this.results.hud.set(s,f,e,i,a$10,h,l,o,n));const m=t=>t.set(s,f,e,i,u,h,null,o,n);if((null==this.results.min.drapedLayerOrder||h>=this.results.min.drapedLayerOrder)&&(null==this.results.min.dist||e<this.results.min.dist)&&m(this.results.min),0!==this.options.store&&(null==this.results.max.drapedLayerOrder||h<this.results.max.drapedLayerOrder)&&(null==this.results.max.dist||e>this.results.max.dist)&&m(this.results.max),2===this.options.store){const t=new j$y(this._ray);m(t),this.results.all.push(t);}}}),c.shaderTransformation);}}sortResults(){this.results.all.sort(((t,r)=>t.dist!==r.dist?t.dist-r.dist:t.drapedLayerOrder!==r.drapedLayerOrder?(void 0!==t.drapedLayerOrder?t.drapedLayerOrder:Number.MAX_VALUE)-(void 0!==r.drapedLayerOrder?r.drapedLayerOrder:Number.MAX_VALUE):(void 0!==r.drapedLayerGraphicOrder?r.drapedLayerGraphicOrder:Number.MIN_VALUE)-(void 0!==t.drapedLayerGraphicOrder?t.drapedLayerGraphicOrder:Number.MIN_VALUE)));}}u$L.DEFAULT_TOLERANCE=m$Q;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
function p$S(r,n,t,o){return r$Y(r.renderCoordsHelper.fromRenderCoords(n.eye,j$x,o))&&g$U(t,j$x)}function m$P(e,n){return e.elevationProvider?c$W(e.elevationProvider.getElevation(n[0],n[1],n[2],e.renderCoordsHelper.spatialReference,"ground"),0):0}function g$J(e,r,a,c){const l=e.state.camera.clone();r&&(l.eye=r,l.center=a,l.up=c),v$D(e,l.ray,w$x)||r$Z(w$x,l.center);const d=e.state.constraints,u=d.minimumPoiDistance;if(x$P(l.eye,w$x)<u){const r=d.collision.enabled;r$Z(H$g,l.viewForward),d$O(H$g,H$g,u),r?l.eye=c$V(j$x,w$x,H$g):u$S(w$x,l.eye,H$g);const t=e.renderCoordsHelper,a=t.getAltitude(l.eye),c=d.collision.elevationMargin;r&&a<c&&(c$V(H$g,w$x,l.eye),l.eye=t.setAltitude(j$x,c,l.eye),u$S(w$x,l.eye,H$g));}return l.center=w$x,l}function y$E(e,r,n){if(!e.state.isGlobal)return !1;const o=m$P(e,r),i=e.stateManager.constraintsManager.nearFarHeuristic,{far:s}=i.compute(r,n,e.dataExtent,o,C$l),a=s*s;return x$P(r,n)>a}function v$D(e,r,n){let t=M$t[e.viewingMode];t||(t=new u$L(e.state.viewingMode),t.options.backfacesTerrain=!e.state.isGlobal,t.options.invisibleTerrain=!0,M$t[e.viewingMode]=t);const{isGlobal:o}=e.state;return !(!e.sceneIntersectionHelper.intersectRay(r,t,n)||y$E(e,r.origin,n))||(!(!e.renderCoordsHelper.intersectManifold(r,0,n)||y$E(e,r.origin,n))||!!o&&b$z(r,n,p$15(e.spatialReference).radius))}function b$z(e,r,n){const t=z$u(e.origin,e.origin)-n*n,i=t>0?Math.sqrt(t)/3:1;return d$O(r,e.direction,i/s$P(e.direction)),u$S(r,r,e.origin),!0}const M$t={},j$x=n$11(),w$x=n$11(),H$g=n$11(),C$l={near:0,far:0};

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
function i$E(s,i,a=0){const f=s.state.constraints;if(!f.collision.enabled)return !1;const u=m$P(s,i.eye),d=s.renderCoordsHelper.getAltitude(i.eye),y=u+f.collision.elevationMargin;if(d>=y)return !1;const m=s$P(i.eye);if(c$V(c$J,i.center,i.eye),i.eye=s.renderCoordsHelper.setAltitude(l$K,y,i.eye),1===a)i.center=u$S(c$J,i.eye,c$J);else if(2===a){const e=(m-d+y)/m;i.center=d$O(c$J,i.center,e);}return !0}const c$J=n$11(),l$K=n$11();

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
function n$U(c,n,f){c.worldUpAtPosition(n,i$D),c$V(m$O,f,n);const a=s$P(m$O);return 0===a?0:x$N(z$u(m$O,i$D)/a)}const i$D=n$11(),m$O=n$11();

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
function R$o(t,r,n=o$M,i=!0){Q$i.eyeCenterDistance=0,Q$i.requiresTwoSteps=!1;const s=T$o(t,r,n,void 0,Q$i);if(0===s)return !1;switch(r$$(B$i),f$L(B$i,B$i,-s,r.viewRight),n.tiltMode){case 1:I$x(z$o,r.viewForward,B$i),d$O(z$o,z$o,Q$i.eyeCenterDistance),r.center=u$S(G$h,r.eye,z$o);break;case 0:c$V(z$o,r.center,r.eye),I$x(z$o,z$o,B$i),r.eye=c$V(G$h,r.center,z$o);break;default:n$1d(n.tiltMode);}return r.up=I$x(G$h,r.up,B$i),!Q$i.requiresTwoSteps||!i||R$o(t,r,n,!1)}function T$o(e,t,r=o$M,n=o$M,i){if(!e.state.constraints.tilt)return 0;const s=t.distance,a=e.state.constraints.tilt(s,K$h);return L$n(e,r,a),2===n.interactionType&&m$R(n.selection,2)&&E$r(e,n.interactionStartCamera,a),1===r.tiltMode||1===n.tiltMode?v$C(e,t,a,i):P$s(e,t,a)}function P$s(e,r,n){const i=n$U(e.renderCoordsHelper,r.center,r.eye),s=i-o$R(i,n.min,n.max);return k$q(s)?s:0}function v$C(t,r,n,i){switch(i&&(i.requiresTwoSteps=!1),t.viewingMode){case"global":return b$y(t,r,n,i);case"local":return O$t(t,r,n,i);default:return void n$1d(t.viewingMode)}}function O$t(e,r,n,i){const s=n$U(e.renderCoordsHelper,r.center,r.eye),a=o$R(s,n.min,n.max),c=s-a;if(!k$q(c))return 0;if(i){const t=e.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,n=e.renderCoordsHelper.getAltitude(r.eye)-t,s=Math.cos(a);Math.abs(s)>1e-4?i.eyeCenterDistance=n/s:i.eyeCenterDistance=r.distance;}return c}function b$y(e,r,n,i){const s=q$j(e,r,N$l),a=o$R(s.tiltAtCenter,n.min,n.max);if(!k$q(s.tiltAtCenter-a))return 0;let c,o;return s.centerIsOnSurface?(c=H$f(s),o=F$r(s,c)):(c=s.constraints.clampTilt(s.eyeCenterDistance,s.tiltAtCenter),i&&c<Math.PI/2&&(i.requiresTwoSteps=!0,c=Math.PI/2-1e-5),o=U$l(s,c)),i&&(i.eyeCenterDistance=g$I(s,c)),o}function q$j(e,t,n){const i=e.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,a=i+p$15(e.spatialReference).radius,c=e.renderCoordsHelper.intersectManifold(t.ray,i,G$h);return n.eyeCenterDistance=t.distance,n.centerIsOnSurface=!1,r$Y(c)?(n.eyeCenterDistance=q$o(t.eye,c),n.tiltAtCenter=n$U(e.renderCoordsHelper,c,t.eye),n.centerIsOnSurface=!0):e.state.isLocal?n.tiltAtCenter=n$U(e.renderCoordsHelper,t.center,t.eye):(F$y(E$x(a),t.ray,G$h),n.eyeCenterDistance=q$o(t.eye,G$h),n.tiltAtCenter=x$N(-z$u(t.viewForward,j$F(G$h,G$h)))),n.radius=a,n.eyeRadius=s$P(t.eye),n.constraints=e.state.constraints,n}function k$q(e){return Math.abs(e)>1e-9}function H$f(e){const{constraints:t,eyeCenterDistance:r,tiltAtCenter:n}=e;let i=n,s=t.clampTilt(r,n);const a=g$I(e,s);if(t.clampTilt(a,n)===s)return s;let c=0;for(;c<10&&k$q(s-i);){const r=(i+s)/2,n=g$I(e,r);k$q(t.clampTilt(n,r)-r)?i=r:s=r,c++;}return s}function g$I(e,r){if(!e.centerIsOnSurface)return e.eyeCenterDistance;const i=Math.PI-o$R(r,0,Math.PI),s=p$16(e.radius/e.eyeRadius*Math.sin(i)),a=Math.PI-i-s,c=Math.sin(a)/Math.sin(i);if(e.eyeRadius<e.radius&&c>1){const t=Math.PI-s,r=Math.PI-i-t;return Math.sin(r)/Math.sin(i)*e.eyeRadius}return c*e.eyeRadius}function F$r(e,t){const r=p$16(e.radius/e.eyeRadius*Math.sin(e.tiltAtCenter)),i=p$16(e.radius/e.eyeRadius*Math.sin(t));return e.eyeRadius>e.radius?r-i:i-r}function U$l(e,t){return e.tiltAtCenter-Math.PI/2-(t-Math.PI/2)}function L$n(e,t,r){if(0===t.interactionType)return;const{interactionStartCamera:n,interactionFactor:i}=t,{min:s,max:a}=r,c=T$o(e,n,o$M,t),o=0===c?0:n$U(e.renderCoordsHelper,n.center,n.eye);r.min=s,r.max=a,2===t.interactionType?(m$R(t.selection,2)&&E$r(e,n,r),r$P(c,o,!0,i,J$h,r)):r$P(c,o,!1,i,J$h,r);}function E$r(e,t,n){if(e.state.isLocal)return;const i=e.state.constraints;if(!i.altitude)return;const s=p$12(t.center),a=Math.sqrt(s),c=t.distance,o=p$15(e.spatialReference).radius,u=i.altitude.min+o,l=i.altitude.max+o,m=(u*u-c*c-s)/(-2*a*c),d=(l*l-c*c-s)/(-2*a*c);n.min=Math.max(n.min,Math.min(Math.PI-x$N(d),n.max)),n.max=Math.min(n.max,Math.PI-x$N(m));}const z$o=n$11(),B$i=e$P(),G$h=n$11(),J$h=b$F(5),K$h={min:0,max:0},N$l={constraints:null,radius:0,eyeRadius:0,centerIsOnSurface:!0,eyeCenterDistance:0,tiltAtCenter:0},Q$i={eyeCenterDistance:0,requiresTwoSteps:!1};

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
function t$P(t){return t}const u$K=t=>t*t,o$K=t=>1-u$K(1-t),i$C=t=>t<.5?u$K(2*t)/2:(o$K(2*(t-.5))+1)/2,n$T=t=>t*t*t,c$I=t=>1-n$T(1-t),a$Q=t=>t<.5?n$T(2*t)/2:(c$I(2*(t-.5))+1)/2,s$J=t=>t*t*t*t,q$i=t=>1-s$J(1-t),r$N=t=>t<.5?s$J(2*t)/2:(q$i(2*(t-.5))+1)/2,e$J=t=>t*t*t*t*t,b$x=t=>1-e$J(1-t),d$F=t=>t<.5?e$J(2*t)/2:(b$x(2*(t-.5))+1)/2,h$E=t=>1-Math.cos(t*Math.PI/2),p$R=t=>1-h$E(1-t),x$F=t=>t<.5?h$E(2*t)/2:(p$R(2*(t-.5))+1)/2,M$s=t=>2**(10*(t-1)),f$H=t=>1-M$s(1-t),l$J=t=>t<.5?M$s(2*t)/2:(f$H(2*(t-.5))+1)/2,I$q=t=>-(Math.sqrt(1-t*t)-1),P$r=t=>1-I$q(1-t),g$H=t=>t<.5?I$q(2*t)/2:(P$r(2*(t-.5))+1)/2;function j$w(t){const u=2*(t-Math.sqrt((t-1)*t)),o=u/2/t;return i=>i<o?t*i*i:u*i-u+1}function k$p(t,u){return (o,i)=>o<u?u*t(o/u,i):1-t((1-o)/(1-u),i)*(1-u)}const m$N=k$p(j$w(1),1),v$B=k$p(j$w(1),0),w$w=k$p(j$w(1),.5),y$D=k$p(j$w(2),1),z$n=k$p(j$w(2),0),A$n=k$p(j$w(2),.5),B$h=k$p(j$w(3),1),C$k=k$p(j$w(3),0),D$m=k$p(j$w(3),.5),E$q=k$p(j$w(4),1),F$q=k$p(j$w(4),0),G$g=k$p(j$w(4),.5),H$e={linear:t$P,"in-quad":u$K,"out-quad":o$K,"in-out-quad":i$C,"in-coast-quad":m$N,"out-coast-quad":v$B,"in-out-coast-quad":w$w,"in-cubic":n$T,"out-cubic":c$I,"in-out-cubic":a$Q,"in-coast-cubic":y$D,"out-coast-cubic":z$n,"in-out-coast-cubic":A$n,"in-quart":s$J,"out-quart":q$i,"in-out-quart":r$N,"in-coast-quart":B$h,"out-coast-quart":C$k,"in-out-coast-quart":D$m,"in-quint":e$J,"out-quint":b$x,"in-out-quint":d$F,"in-coast-quint":E$q,"out-coast-quint":F$q,"in-out-coast-quint":G$g,"in-sine":h$E,"out-sine":p$R,"in-out-sine":x$F,"in-expo":M$s,"out-expo":f$H,"in-out-expo":l$J,"in-circ":I$q,"out-circ":P$r,"in-out-circ":g$H};

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
function p$Q(t,r,o=d$E,i=r){let e=!1;i!==r&&i.copyFrom(r),i.computeUp(t.state.viewingMode);for(let s=0;s<j$v;s++){let r=0;for(const s of y$C)if(m$R(o.selection,s.type)){const n=Math.abs(s.error(t,i,o));s.apply(t,i,o)&&(e=!0,r+=n);}if(0===r)break}const a=m$R(o.selection,8),c=m$M(o.interactionType,t);return a&&i$E(t,i,c)&&(e=!0),e&&i.computeUp(t.state.viewingMode),e}function m$M(t,r){switch(t){case 4:return 1;case 5:return r.state.isGlobal?2:1;default:return 0}}function f$G(r,o){const n="number"==typeof r?r:d$U(r,o),i=Math.min(1,n/150);return a$Q(i)}function u$J(t,r,o){return T$o(t,r,o)*r.distance}const y$C=[{type:1,error:u$J,apply:R$o},{type:2,error:d$H,apply:p$T},{type:4,error:d$G,apply:y$F}],d$E={selection:15,interactionType:0,interactionFactor:0,interactionStartCamera:null,interactionDirection:null,tiltMode:0},j$v=5;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
const f$F=n$11(),P$q=n$11(),_$m=n$11(),g$G=n$11(),k$o=n$11(),v$A=n$11(),x$E={upward:t$_(0,0,1),forward:t$_(0,1,0),sideway:t$_(1,0,0)},z$m=e$Z();class T$n{constructor(t=1){this.viewingMode=t,this.center=n$11(),this.pitch=0,this.yaw=0,this.distance=0,this.lookAtDirection=r$_(x$E.forward);}pixelsPerPanAtZoom(t){return this.size/2/(this._zoomToPanScale*t)}zoomAtPixelsPerPan(t){return this.size/2/(this._zoomToPanScale*t)}pixelsPerRotateAtZoom(){const t=Math.max(Math.cos(Math.abs(this.pitch)),.5);return this.size/2/t}compareTo(t,e){if(e||(e={pan:0,rotate:0,sourceZoom:0,targetZoom:0}),1===this.viewingMode){const i=(s$P(this.center)+s$P(t.center))/2;e.pan=w$D(this.center,t.center)*i;}else e.pan=q$o(this.center,t.center);let i=Math.abs(t.yaw-this.yaw);i>=Math.PI&&(i=2*Math.PI-i);const o=Math.abs(t.pitch-this.pitch);return e.rotate=Math.max(i,o),e.sourceZoom=this.distance,e.targetZoom=t.distance,e}interpolate(e,i,s){1===this.viewingMode?q$p(e.center,i.center,s.pan,this.center):y$N(this.center,e.center,i.center,s.pan),this.distance=m$V(e.distance,i.distance,s.zoom),this.pitch=m$V(e.pitch,i.pitch,s.rotate);let a=e.yaw;const h=i.yaw;Math.abs(h-a)>=Math.PI&&(a+=2*(a<h?1:-1)*Math.PI),this.yaw=m$V(a,h,s.rotate);}copyFrom(t){r$Z(this.center,t.center),this.pitch=t.pitch,this.yaw=t.yaw,this.distance=t.distance,r$Z(this.lookAtDirection,t.lookAtDirection),this.size=t.size,this.copyFromCommon(t),this.viewingMode=t.viewingMode;}copyFromRenderCamera(t){const e=this._lookAtOrientation(t.center,z$m);r$Z(this.center,t.center),c$V(g$G,t.center,t.eye),L$u(g$G,g$G,e),L$u(k$o,t.up,e),this.distance=s$P(g$G),g$G[0]/=this.distance,g$G[1]/=this.distance,g$G[2]/=this.distance,this.pitch=this._eyeUpToPitch(g$G),this.yaw=this._eyeUpToYaw(g$G,k$o),this.size=Math.sqrt(t.width*t.width+t.height*t.height),this.copyFromCommon(t);}copyFromCommon(t){this.fov=t.fov,this._zoomToPanScale=Math.atan(.5*this.fov);}copyToRenderCamera(t){const i=this._lookAtOrientation(this.center,z$m);o$Z(i,i),this._axisAngleVec3(x$E.sideway,this.pitch-Math.PI/2,x$E.forward,g$G),this._axisAngleVec3(x$E.upward,this.yaw,g$G),this._axisAngleVec3(x$E.sideway,this.pitch-Math.PI/2,x$E.upward,k$o),this._axisAngleVec3(x$E.upward,this.yaw,k$o),d$O(g$G,g$G,this.distance),L$u(g$G,g$G,i),L$u(k$o,k$o,i),t.center=this.center,t.eye=c$V(g$G,this.center,g$G),t.up=k$o;}_axisAngleVec3(t,e,i,s=i){const a=Math.cos(e),o=Math.sin(e);return d$O(f$F,i,a),_$n(P$q,t,i),d$O(P$q,P$q,o),d$O(_$m,t,(1-a)*z$u(t,i)),u$S(s,u$S(s,f$F,P$q),_$m)}_lookAtOrientation(t,e=e$Z()){return this._upAtLookAt(t,_$m),_$n(f$F,this.lookAtDirection,_$m),j$F(f$F,f$F),0===f$F[0]&&0===f$F[1]&&0===f$F[2]&&r$Z(f$F,x$E.sideway),_$n(P$q,_$m,f$F),j$F(P$q,P$q),e[0]=f$F[0],e[1]=P$q[0],e[2]=_$m[0],e[3]=f$F[1],e[4]=P$q[1],e[5]=_$m[1],e[6]=f$F[2],e[7]=P$q[2],e[8]=_$m[2],e}_upAtLookAt(t,e){return 2===this.viewingMode?r$Z(e,x$E.upward):j$F(e,t)}_eyeUpToPitch(t){return Math.PI-w$D(x$E.upward,t)}_eyeUpToYaw(t,e){const i=v$A;return Math.abs(e[2])<.5?(r$Z(i,e),t[2]>0&&d$O(i,i,-1)):r$Z(i,t),_$n(P$q,i,x$E.upward),j$F(P$q,P$q),w$D(x$E.sideway,P$q,x$E.upward)}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
function s$I(r){return r?{ray:a$11(r.ray),c0:r.c0,c1:r.c1}:{ray:a$11(),c0:0,c1:Number.MAX_VALUE}}function p$P(r,c=s$I()){return m$X(r,c.ray),c.c0=0,c.c1=Number.MAX_VALUE,c}function b$w(r,c,t=s$I()){const o=s$P(r.vector);return p$17(r.origin,c,t.ray),t.c0=0,t.c1=o,t}new s$O((()=>({c0:0,c1:0,ray:null})));

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
function y$B(t){return t?[p$11(t[0]),p$11(t[1]),p$11(t[2]),p$11(t[3]),p$11(t[4]),p$11(t[5])]:[p$11(),p$11(),p$11(),p$11(),p$11(),p$11()]}function S$w(){return [n$11(),n$11(),n$11(),n$11(),n$11(),n$11(),n$11(),n$11()]}function w$v(t,r=y$B()){for(let n=0;n<6;n++)b$D(t[n],r[n]);}function x$D(t,e,c,u=G$f){const s=e$V(f$O.get(),e,t);h$L(s,s);for(let r=0;r<8;++r){const t=y$O(r$X.get(),E$p[r],s);o$S(u[r],t[0]/t[3],t[1]/t[3],t[2]/t[3]);}O$s(c,u);}function O$s(t,r){M$w(r[4],r[0],r[3],t[0]),M$w(r[1],r[5],r[6],t[1]),M$w(r[4],r[5],r[1],t[2]),M$w(r[3],r[2],r[6],t[3]),M$w(r[0],r[1],r[2],t[4]),M$w(r[5],r[4],r[7],t[5]);}function R$n(t,r){for(let n=0;n<6;n++)if(G$l(t[n],r))return !1;return !0}function d$D(t,r){return C$j(t,p$P(r,F$p.get()))}function z$l(t,r,n){return C$j(t,b$w(r,n,F$p.get()))}function A$m(t,r){for(let n=0;n<6;n++){if(R$s(t[n],r)>0)return !1}return !0}function B$g(t,r){for(let n=0;n<6;n++)if(K$k(t[n],r))return !1;return !0}function C$j(t,r){for(let n=0;n<6;n++)if(!L$s(t[n],r))return !1;return !0}const D$l={bottom:[5,1,0,4],near:[0,1,2,3],far:[5,4,7,6],right:[1,5,6,2],left:[4,0,3,7],top:[7,3,2,6]},E$p=[r$19(-1,-1,-1,1),r$19(1,-1,-1,1),r$19(1,1,-1,1),r$19(-1,1,-1,1),r$19(-1,-1,1,1),r$19(1,-1,1,1),r$19(1,1,1,1),r$19(-1,1,1,1)],F$p=new s$O(s$I),G$f=S$w();

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
const B$f=n$12.getLogger("esri.views.3d.webgl-engine.lib.Camera");class J$g{constructor(t=null,i=null,r=null){this._viewUp=n$11(),this._viewForward=n$11(),this._viewRight=n$11(),this._ray=a$11(),this._viewport=r$19(0,0,1,1),this._padding=r$19(0,0,0,0),this._fov=55/180*Math.PI,this._nearFar=t$18(1,1e3),this._viewDirty=!0,this._viewMatrix=e$P(),this._projectionDirty=!0,this._projectionMatrix=e$P(),this._viewProjectionDirty=!0,this._viewProjectionMatrix=e$P(),this._viewInverseTransposeMatrixDirty=!0,this._viewInverseTransposeMatrix=e$P(),this._frustumDirty=!0,this._frustum=y$B(),this._fullViewport=n$1a(),this.pixelRatio=1,this.relativeElevation=0,r$Y(t)&&r$Z(this._ray.origin,t),this._center=r$Y(i)?r$_(i):n$11(),this._up=r$Y(r)?r$_(r):t$_(0,0,1);}get eye(){return this._ray.origin}set eye(t){this._compareAndSetView(t,this._ray.origin);}get center(){return this._center}set center(t){this._compareAndSetView(t,this._center);}get ray(){return c$V(this._ray.direction,this.center,this.eye),this._ray}get up(){return this._up}set up(t){this._compareAndSetView(t,this._up);}get viewMatrix(){return this._ensureViewClean(),this._viewMatrix}set viewMatrix(t){n$18(this._viewMatrix,t),this._viewDirty=!1,this._viewInverseTransposeMatrixDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0;}get viewForward(){return this._ensureViewClean(),this._viewForward}get viewUp(){return this._ensureViewClean(),this._viewUp}get viewRight(){return this._ensureViewClean(),this._viewRight}get nearFar(){return this._nearFar}get near(){return this._nearFar[0]}set near(t){this._nearFar[0]!==t&&(this._nearFar[0]=t,this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0);}get far(){return this._nearFar[1]}set far(t){this._nearFar[1]!==t&&(this._nearFar[1]=t,this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0);}get viewport(){return this._viewport}set viewport(t){this.x=t[0],this.y=t[1],this.width=t[2],this.height=t[3];}get x(){return this._viewport[0]}set x(t){t+=this._padding[3],this._viewport[0]!==t&&(this._viewport[0]=t,this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0);}get y(){return this._viewport[1]}set y(t){t+=this._padding[2],this._viewport[1]!==t&&(this._viewport[1]=t,this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0);}get width(){return this._viewport[2]}set width(t){this._viewport[2]!==t&&(this._viewport[2]=t,this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0);}get height(){return this._viewport[3]}set height(t){this._viewport[3]!==t&&(this._viewport[3]=t,this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0);}get fullWidth(){return this._viewport[2]+this._padding[1]+this._padding[3]}set fullWidth(t){this.width=t-(this._padding[1]+this._padding[3]);}get fullHeight(){return this._viewport[3]+this._padding[0]+this._padding[2]}set fullHeight(t){this.height=t-(this._padding[0]+this._padding[2]);}get fullViewport(){return this._fullViewport[0]=this._viewport[0]-this._padding[3],this._fullViewport[1]=this._viewport[1]-this._padding[2],this._fullViewport[2]=this.fullWidth,this._fullViewport[3]=this.fullHeight,this._fullViewport}get aspect(){return this.width/this.height}get padding(){return this._padding}set padding(t){this._padding[0]===t[0]&&this._padding[1]===t[1]&&this._padding[2]===t[2]&&this._padding[3]===t[3]||(this._viewport[0]+=t[3]-this._padding[3],this._viewport[1]+=t[2]-this._padding[2],this._viewport[2]-=t[1]+t[3]-(this._padding[1]+this._padding[3]),this._viewport[3]-=t[0]+t[2]-(this._padding[0]+this._padding[2]),a$12(this._padding,t),this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0);}get viewProjectionMatrix(){return this._viewProjectionDirty&&(e$V(this._viewProjectionMatrix,this.projectionMatrix,this.viewMatrix),this._viewProjectionDirty=!1),this._viewProjectionMatrix}get projectionMatrix(){if(this._projectionDirty){const t=this.width,i=this.height,e=this.near*Math.tan(this.fovY/2),r=e*this.aspect;A$v(this._projectionMatrix,-r*(1+2*this._padding[3]/t),r*(1+2*this._padding[1]/t),-e*(1+2*this._padding[2]/i),e*(1+2*this._padding[0]/i),this.near,this.far),this._projectionDirty=!1;}return this._projectionMatrix}set projectionMatrix(t){n$18(this._projectionMatrix,t),this._projectionDirty=!1,this._viewProjectionDirty=!0,this._frustumDirty=!0;}get fov(){return this._fov}set fov(t){this._fov=t,this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0;}get fovX(){return z$w(this._fov,this.width,this.height)}set fovX(t){this._fov=V$m(t,this.width,this.height),this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0;}get fovY(){return B$l(this._fov,this.width,this.height)}set fovY(t){this._fov=$$k(t,this.width,this.height),this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0;}get distance(){return q$o(this._center,this.eye)}get frustum(){return this._recomputeFrustum(),this._frustum}get viewInverseTransposeMatrix(){return (this._viewInverseTransposeMatrixDirty||this._viewDirty)&&(h$L(this._viewInverseTransposeMatrix,this.viewMatrix),o$T(this._viewInverseTransposeMatrix,this._viewInverseTransposeMatrix),this._viewInverseTransposeMatrixDirty=!1),this._viewInverseTransposeMatrix}depthNDCToWorld(t){const i=2*t-1;return 2*this.near*this.far/(this.far+this.near-i*(this.far-this.near))}get perRenderPixelRatio(){return Math.tan(this.fovX/2)/(this.width/2)}get perScreenPixelRatio(){return this.perRenderPixelRatio*this.pixelRatio}get aboveGround(){return this.relativeElevation&&this.relativeElevation>=0}copyFrom(t){r$Z(this._ray.origin,t.eye),r$Z(this._center,t.center),r$Z(this._up,t.up),a$12(this._viewport,t.viewport),a$12(this._padding,t.padding),a$13(this._nearFar,t.nearFar),this._fov=t.fov,this.relativeElevation=t.relativeElevation;const i=t;return this._viewDirty=i._viewDirty,this._viewDirty||(n$18(this._viewMatrix,t.viewMatrix),r$Z(this._viewRight,t.viewRight),r$Z(this._viewUp,t.viewUp),r$Z(this._viewForward,t.viewForward)),i._projectionDirty?this._projectionDirty=!0:(n$18(this._projectionMatrix,t.projectionMatrix),this._projectionDirty=!1),this._viewProjectionDirty=!0,this._frustumDirty=i._frustumDirty,this._frustumDirty||(w$v(t.frustum,this._frustum),this._frustumDirty=!1),i._viewInverseTransposeMatrixDirty?this._viewInverseTransposeMatrixDirty=!0:(n$18(this._viewInverseTransposeMatrix,t.viewInverseTransposeMatrix),this._viewInverseTransposeMatrixDirty=!1),a$12(this._fullViewport,t.fullViewport),this.pixelRatio=t.pixelRatio,this}copyViewFrom(t){this.eye=t.eye,this.center=t.center,this.up=t.up;}clone(){return (new J$g).copyFrom(this)}equals(t){return F$v(this.eye,t.eye)&&F$v(this._center,t.center)&&F$v(this._up,t.up)&&D$s(this._viewport,t.viewport)&&D$s(this._padding,t.padding)&&k$B(this._nearFar,t.nearFar)&&this._fov===t.fov&&this.pixelRatio===t.pixelRatio&&this.relativeElevation===t.relativeElevation}almostEquals(t){if(this.pixelRatio!==t.pixelRatio||Math.abs(t.fov-this._fov)>=.001)return !1;const i=5e-4,e=1-1e-10;J$l(Q$h,t.eye,t.center),J$l(Z$g,this.eye,this._center);const r=z$u(Q$h,Z$g),s=Z$j(Q$h),h=Z$j(Z$g);return r*r>=e*s*h&&X$g(t.eye,this.eye)<Math.max(s,h)*i*i&&b$I(t.padding,this._padding)<.5&&b$I(t.viewport,this._viewport)<.5}computeRenderPixelSizeAt(t){return this.computeRenderPixelSizeAtDist(this.viewDirectionDistance(t))}computeRenderPixelSizeAtDist(t){return t*this.perRenderPixelRatio}computeScreenPixelSizeAt(t){return this.computeScreenPixelSizeAtDist(this.viewDirectionDistance(t))}viewDirectionDistance(t){return Math.abs(e$O(this.viewForward,c$V(Q$h,t,this.eye)))}computeScreenPixelSizeAtDist(t){return t*this.perScreenPixelRatio}computeDistanceFromRadius(t,i){return t/Math.tan(Math.min(this.fovX,this.fovY)/(2*(i||1)))}getScreenCenter(t=i$U()){return t[0]=(this.padding[3]+this.width/2)/this.pixelRatio,t[1]=(this.padding[0]+this.height/2)/this.pixelRatio,t}getRenderCenter(t,i=.5,e=.5){return t||(t=x$Q()),t[0]=this.padding[3]+this.width*i,t[1]=this.padding[2]+this.height*e,t.length>2&&(t[2]=.5),t}setGLViewport(t){const i=this.viewport,e=this.padding;t.setViewport(i[0]-e[3],i[1]-e[2],i[2]+e[1]+e[3],i[3]+e[0]+e[2]);}applyProjection(t,e,r=!1){t!==K$g&&r$Z(K$g,t),K$g[3]=1,r&&(e[2]=-K$g[2]),y$O(K$g,K$g,this.projectionMatrix),d$O(K$g,K$g,1/Math.abs(K$g[3]));const s=this.fullViewport;return e[0]=m$V(0,s[0]+s[2],.5+.5*K$g[0]),e[1]=m$V(0,s[1]+s[3],.5+.5*K$g[1]),r||(e[2]=.5*(K$g[2]+1)),e}projectToScreen(t,i){this.projectToRenderScreen(t,$$i),this.renderToScreen($$i,i);}projectToRenderScreen(t,e){if(K$g[0]=t[0],K$g[1]=t[1],K$g[2]=t[2],K$g[3]=1,y$O(K$g,K$g,this.viewProjectionMatrix),0===K$g[3])return null;d$O(K$g,K$g,1/Math.abs(K$g[3]));const r=this.fullViewport;return "x"in e?(e.x=m$V(0,r[0]+r[2],.5+.5*K$g[0]),e.y=m$V(0,r[1]+r[3],.5+.5*K$g[1])):(e[0]=m$V(0,r[0]+r[2],.5+.5*K$g[0]),e[1]=m$V(0,r[1]+r[3],.5+.5*K$g[1]),e.length>2&&(e[2]=.5*(K$g[2]+1))),e}unprojectFromScreen(t,i){return this.unprojectFromRenderScreen(this.screenToRender(t,$$i),i)}unprojectFromRenderScreen(t,i){if(e$V(O$r,this.projectionMatrix,this.viewMatrix),!h$L(O$r,O$r))return null;const e=this.fullViewport;return K$g[0]=2*(t[0]-e[0])/e[2]-1,K$g[1]=2*(t[1]-e[1])/e[3]-1,K$g[2]=2*t[2]-1,K$g[3]=1,y$O(K$g,K$g,O$r),0===K$g[3]?null:(i[0]=K$g[0]/K$g[3],i[1]=K$g[1]/K$g[3],i[2]=K$g[2]/K$g[3],i)}constrainWindowSize(t,i,e,r=e){const s=t*this.pixelRatio,h=i*this.pixelRatio,n=Math.max(s-e/2,0),o=Math.max(this.fullHeight-h-r/2,0),a=-Math.min(s-e/2,0),_=-Math.min(this.fullHeight-h-r/2,0);return [n,o,e-a- -Math.min(this.fullWidth-s-e/2,0),r-_- -Math.min(h-r/2,0)]}computeUp(t){1===t?this.computeUpGlobal():this.computeUpLocal();}screenToRender(t,i){const e=t[0]*this.pixelRatio,r=this.fullHeight-t[1]*this.pixelRatio;return i[0]=e,i[1]=r,i}renderToScreen(t,i){const e=t[0]/this.pixelRatio,r=(this.fullHeight-t[1])/this.pixelRatio;i[0]=e,i[1]=r;}computeUpGlobal(){c$V(Q$h,this.center,this.eye);const t=s$P(this.center);t<1?(o$S(this._up,0,0,1),this._markViewDirty()):Math.abs(z$u(Q$h,this.center))>.9999*s$P(Q$h)*t||(_$n(this._up,Q$h,this.center),_$n(this._up,this._up,Q$h),j$F(this._up,this._up),this._markViewDirty());}computeUpLocal(){H$m(Q$h,this.eye,this.center),Math.abs(Q$h[2])<=.9999&&(d$O(Q$h,Q$h,Q$h[2]),o$S(this._up,-Q$h[0],-Q$h[1],1-Q$h[2]),j$F(this._up,this._up),this._markViewDirty());}_compareAndSetView(t,i){"number"==typeof t[0]&&isFinite(t[0])&&"number"==typeof t[1]&&isFinite(t[1])&&"number"==typeof t[2]&&isFinite(t[2])?F$v(t,i)||(r$Z(i,t),this._markViewDirty()):B$f.warn("Camera vector contains invalid number, ignoring value");}_markViewDirty(){this._viewDirty=!0,this._frustumDirty=!0,this._viewProjectionDirty=!0;}_recomputeFrustum(){this._frustumDirty&&(x$D(this.viewMatrix,this.projectionMatrix,this._frustum),this._frustumDirty=!1);}_ensureViewClean(){this._viewDirty&&(F$x(this._viewMatrix,this.eye,this._center,this._up),o$S(this._viewForward,-this._viewMatrix[2],-this._viewMatrix[6],-this._viewMatrix[10]),o$S(this._viewUp,this._viewMatrix[1],this._viewMatrix[5],this._viewMatrix[9]),o$S(this._viewRight,this._viewMatrix[0],this._viewMatrix[4],this._viewMatrix[8]),this._viewDirty=!1,this._viewInverseTransposeMatrixDirty=!0);}}const K$g=n$1a(),O$r=e$P(),Q$h=n$11(),Z$g=n$11(),$$i=x$Q();

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
const o$J={desiredScreenFlow:2,minDuration:n$1e(500),maxDuration:n$1e(8e3)};

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class t$O{constructor(t){this.createCamera=t,this.compared={sourceZoom:0,targetZoom:0,pan:0,rotate:0},this.settings={desiredScreenFlow:o$J.desiredScreenFlow},this.source=t(),this.target=t();}clone(){const e=new t$O(this.createCamera);return e.copyFrom(this),e}copyFrom(e){this.update(e.source,e.target,e.settings);}update(t,r,s){this.source!==t&&this.source.copyFrom(t),this.target!==r&&this.target.copyFrom(r),this.compared=this.source.compareTo(this.target,this.compared),this.settings.desiredScreenFlow=null!=s.desiredScreenFlow?s.desiredScreenFlow:o$J.desiredScreenFlow,this.desiredPixelFlow=this.settings.desiredScreenFlow*this.target.size,this.halfWindowSize=this.target.size/2;}halfWindowPanAtZoom(e){const t=this.target.pixelsPerPanAtZoom(e);return this.halfWindowSize/t}get hasZoom(){return Math.abs(this.compared.sourceZoom-this.compared.targetZoom)>1e-5}get hasPan(){return this.compared.pan>1e-9}get hasRotate(){return this.compared.rotate>1e-9}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class e$I{constructor(){this.segments=[];}get time(){return this.segments.reduce(((e,o)=>t$19(e+o.time)),t$19(0))}interpolateComponentsAt(t,e){t=Math.min(Math.max(t,0),1),t*=this.time;let o=0,n=0;const s=this.definition;for(let m=0;m<this.segments.length;m++){const r=this.segments[m],a=r.definition;if(t<=r.time||m===this.segments.length-1){e=this.segmentInterpolateComponentsAt(r,t/r.time,e),s.hasPan?e.pan=(o+a.compared.pan*e.pan)/s.compared.pan:e.pan=1,s.hasRotate?e.rotate=(n+a.compared.rotate*e.rotate)/s.compared.rotate:e.rotate=1;const m=e.zoom*(a.compared.targetZoom-a.compared.sourceZoom)+a.compared.sourceZoom,i=this.segments[0].definition.compared.sourceZoom,p=this.segments[this.segments.length-1].definition.compared.targetZoom;return s.hasZoom?e.zoom=(m-i)/(p-i):e.zoom=1,e}t-=r.time,o+=a.compared.pan,n+=a.compared.rotate;}}segmentInterpolateComponentsAt(t,e,o){return t.interpolateComponentsAt(e,o)}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class i$B{constructor(t){t&&this.update(t);}get time(){return this._time}update(t){t&&(this.definition?this.definition.copyFrom(t):this.definition=t.clone()),this._updatePrecomputedVariables(),this._updatePixelFlow();}_updatePrecomputedVariables(){const t=this.definition,i=t.compared,o=i.sourceZoom,e=i.targetZoom;this._zoomSign=o>e?1:-1,this._panPixelsAtSource=i.pan*t.source.pixelsPerPanAtZoom(o);const n=(t.source.pixelsPerRotateAtZoom(o)+t.target.pixelsPerRotateAtZoom(e))/2;this._rotatePixels=i.rotate*n;}_updatePixelFlow(){const i=this.definition.compared.sourceZoom,o=this.definition.compared.targetZoom,{hasZoom:e,hasPan:n,hasRotate:s}=this.definition;let a=0,h=0;e&&(n&&(a=(o/i-1)/(-1/(this._zoomSign*this.definition.halfWindowSize)*Math.LN2*this._panPixelsAtSource)),s&&(h=this._zoomSign*(Math.log(i/o)/Math.LN2)*this.definition.halfWindowSize/this._rotatePixels)),this._zoomPixelFlow=0,this._panPixelFlow=0,this._rotatePixelFlow=0;const l=this.definition.desiredPixelFlow;if(e&&n&&s){const t=a+h+a*h;this._zoomPixelFlow=a*h/t*l,this._panPixelFlow=h/t*l,this._rotatePixelFlow=a/t*l;}else if(e&&n){const t=1+a;this._zoomPixelFlow=a/t*l,this._panPixelFlow=1/t*l;}else if(e&&s){const t=1+h;this._zoomPixelFlow=h/t*l,this._rotatePixelFlow=1/t*l;}else if(n&&s){const t=this._panPixelsAtSource/this._rotatePixels,i=1+t;this._panPixelFlow=t/i*l,this._rotatePixelFlow=1/i*l;}else n?this._panPixelFlow=l:e?this._zoomPixelFlow=l:s&&(this._rotatePixelFlow=l);this._time=s?this.rotateTime:e?this.zoomTime:n?this.panTime:t$19(0);}get rotateTime(){return this.definition.hasRotate?t$19(this._rotatePixels/this._rotatePixelFlow):t$19(0)}get zoomTime(){return this.definition.hasZoom?t$19(this._zoomSign*(Math.log(this.definition.compared.sourceZoom/this.definition.compared.targetZoom)/Math.LN2)*this.definition.halfWindowSize/this._zoomPixelFlow):t$19(0)}get panTime(){if(this.definition.hasPan){if(this.definition.hasZoom){const i=-1/(this._zoomSign*this.definition.halfWindowSize)*Math.LN2,o=i*this._panPixelsAtSource;return t$19(Math.log(o*(this._zoomPixelFlow/this._panPixelFlow)+1)/(i*this._zoomPixelFlow))}return t$19(this._panPixelsAtSource/this._panPixelFlow)}return t$19(0)}_interpolateComponentsZoom(t){if(0===t||1===t)return t;if(this.definition.hasZoom){const i=this.definition.compared.sourceZoom,o=this.definition.compared.targetZoom;return (i*(i/o)**-t-i)/(o-i)}return t}_interpolateComponentsPan(t){if(0===t||1===t)return t;if(this.definition.hasPan&&this.definition.hasZoom){const i=-1/(this._zoomSign*this.definition.halfWindowSize)*this._zoomPixelFlow;return 1/this._panPixelsAtSource*(this._panPixelFlow*(2**(i*t*this._time)-1))/(i*Math.LN2)}return t}_interpolateComponentsRotate(t){return t}interpolateComponentsAt(t,i){t=Math.min(Math.max(t,0),1);const o=this._interpolateComponentsZoom(t),e=this._interpolateComponentsPan(t),n=this._interpolateComponentsRotate(t);return i?(i.zoom=o,i.pan=e,i.rotate=n):i={zoom:o,pan:e,rotate:n},i}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
function o$I(o,a,e){const n=a-o.compared.sourceZoom,t=o.halfWindowPanAtZoom(n);return -o.halfWindowSize*(e.ascensionFactor*Math.LN2*o.compared.pan+t)*Math.log(o.compared.sourceZoom/a)/(o.desiredPixelFlow*Math.LN2*t)}function a$P(o,a,e){const n=1/a,t=Math.log(o.compared.sourceZoom*n),i=1/o.desiredPixelFlow,r=1/Math.LN2,d=a-o.compared.sourceZoom,c=1/d,l=(e.ascensionFactor*Math.LN2*o.compared.pan+o.halfWindowPanAtZoom(d))/o.halfWindowPanAtZoom(1);return o.halfWindowSize*n*i*r*c*l-o.halfWindowSize*t*i*r*c+o.halfWindowSize*t*i*r*l/(d*d)}function e$H(o,a,e){const n=a-o.compared.sourceZoom,t=1/n,i=1/a,r=Math.log(o.compared.sourceZoom*i),d=(e.ascensionFactor*Math.LN2*o.compared.pan+o.halfWindowPanAtZoom(n))/o.halfWindowPanAtZoom(1);return o.halfWindowSize*t*(-2*t*i*d+2*t*r+2*i-2*r*d/(n*n)-d/(a*a))/(o.desiredPixelFlow*Math.LN2)}function n$S(o,a){return -o.halfWindowSize*Math.log(o.compared.sourceZoom/a)/(o.desiredPixelFlow*Math.LN2)}function t$N(o,a){return o.halfWindowSize/(a*o.desiredPixelFlow*Math.LN2)}function i$A(o,a){return -o.halfWindowSize/(a*a*o.desiredPixelFlow*Math.LN2)}function r$M(o,a,e){return -o.compared.pan*o.halfWindowSize*(e.ascensionFactor+e.descensionFactor-1)/(o.desiredPixelFlow*o.halfWindowPanAtZoom(a))}function d$C(o,a,e){return o.compared.pan*o.halfWindowSize*(e.ascensionFactor+e.descensionFactor-1)/(o.desiredPixelFlow*o.halfWindowPanAtZoom(a*a))}function c$H(o,a,e){return -2*o.compared.pan*o.halfWindowSize*(e.ascensionFactor+e.descensionFactor-1)/(o.desiredPixelFlow*o.halfWindowPanAtZoom(a*a*a))}function l$I(o,a,e){return o.halfWindowSize*(-o.halfWindowPanAtZoom(a)-e.descensionFactor*Math.LN2*o.compared.pan+o.halfWindowPanAtZoom(o.compared.targetZoom))*Math.log(a/o.compared.targetZoom)/(o.desiredPixelFlow*Math.LN2*o.halfWindowPanAtZoom(-a+o.compared.targetZoom))}function m$L(o,a,e){const n=Math.log(a/o.compared.targetZoom),t=1/o.desiredPixelFlow,i=1/Math.LN2,r=-a+o.compared.targetZoom,d=1/r,c=(-o.halfWindowPanAtZoom(a)-e.descensionFactor*Math.LN2*o.compared.pan+o.halfWindowPanAtZoom(o.compared.targetZoom))/o.halfWindowPanAtZoom(1);return -o.halfWindowSize*n*t*i*d+o.halfWindowSize*n*t*i*c/(r*r)+o.halfWindowSize*t*i*d*c/a}function h$D(o,a,e){const n=a-o.compared.targetZoom,t=1/n,i=1/a,r=Math.log(a/o.compared.targetZoom),d=(o.halfWindowPanAtZoom(a)+e.descensionFactor*Math.LN2*o.compared.pan-o.halfWindowPanAtZoom(o.compared.targetZoom))/o.halfWindowPanAtZoom(1);return o.halfWindowSize*t*(-2*t*i*d-2*t*r+2*i+2*r*d/(n*n)-d/(a*a))/(o.desiredPixelFlow*Math.LN2)}function s$H(o,a){return o.halfWindowSize*Math.log(a/o.compared.targetZoom)/(o.desiredPixelFlow*Math.LN2)}function f$E(o,a){return o.halfWindowSize/(a*o.desiredPixelFlow*Math.LN2)}function w$u(o,a){return -o.halfWindowSize/(a*a*o.desiredPixelFlow*Math.LN2)}function p$O(o){const a=Math.LN2*o.compared.pan,e=o.compared.sourceZoom-o.compared.targetZoom,n=o.halfWindowPanAtZoom(e),t=o.halfWindowSize*Math.log(o.compared.sourceZoom/o.compared.targetZoom)/(o.desiredPixelFlow*Math.LN2*n);return o.compared.sourceZoom<=o.compared.targetZoom?t*(a-n):t*(a+n)}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
function f$D(f,Z){let P=D$k(f,Z);const b={ascensionFactor:null!=Z.ascensionFactor?Z.ascensionFactor:.5,descensionFactor:null!=Z.descensionFactor?Z.descensionFactor:.5},g=0===b.ascensionFactor,h=0===b.descensionFactor,M=g?n$S:o$I,k=g?t$N:a$P,N=g?i$A:e$H,j=h?s$H:l$I,w=h?f$E:m$L,z=h?w$u:h$D,A=e=>M(f,e,b)+r$M(f,e,b)+j(f,e,b),I=o=>k(f,o,b)+d$C(f,o,b)+w(f,o,b),q=o=>N(f,o,b)+c$H(f,o,b)+z(f,o,b);let v=A(P);const y=p$O(f);let B;const C=Z.maximumIterations||20,E=null!=Z.maximumDistance?Z.maximumDistance:1/0;for(B=0;B<C;B++){const o=1e-6,e=(I(P)+o)/q(P);if(isNaN(e)||P>=E&&e<0){if(!isFinite(E))return null;P=E,v=A(P);break}if(P-=e,P<f.compared.sourceZoom||P<f.compared.targetZoom)return null;const n=A(P);if(Math.abs(n-v)/v<=.005)break;v=n;}return v>y*(1-.3)||P<f.compared.sourceZoom||P<f.compared.targetZoom?null:P}function D$k(o,e){const n=Math.max(o.compared.sourceZoom,o.compared.targetZoom),a=o.source.zoomAtPixelsPerPan(o.desiredPixelFlow/o.compared.pan)/2;return a<n?null!=e.maximumDistance?n+(e.maximumDistance-n)/2:1.5*n:e.maximumDistance?Math.min(e.maximumDistance,a):a}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class s$G extends e$I{constructor(i,e){super(),this._preallocSegments=[new i$B,new i$B,new i$B],this.update(i,e);}update(i,e){if(!i)return;this.definition?this.definition.copyFrom(i):this.definition=i.clone();let t=null;e&&e.apex&&(t=f$D(i,e.apex)),this.segments.length=0,this._ascensionSegment=null,this._descensionSegment=null,null==t?this._updateWithoutApex():this._updateWithApex(t,e.apex);}segmentInterpolateComponentsAt(t,n,o){return o=t.interpolateComponentsAt(n,o),t===this._ascensionSegment?o.zoom=o$K(o.zoom):t===this._descensionSegment&&(o.zoom=u$K(o.zoom)),o}_updateWithApex(i,e){const[t,n,o]=this._preallocSegments,s=null!=e.ascensionFactor?e.ascensionFactor:.5,d=Math.min(1-s,null!=e.ascensionFactor?e.descensionFactor:.5),a=1-s-d;t.definition?t.definition.copyFrom(this.definition):t.definition=this.definition.clone(),t.definition.compared.targetZoom=i,t.definition.compared.pan=this.definition.compared.pan*s,t.definition.compared.rotate=this.definition.compared.rotate*s,t.update(),this._ascensionSegment=t,this.segments.push(t),a>0&&(n.definition?n.definition.copyFrom(this.definition):n.definition=this.definition.clone(),n.definition.copyFrom(this.definition),n.definition.compared.sourceZoom=i,n.definition.compared.targetZoom=i,n.definition.compared.pan=this.definition.compared.pan*a,n.definition.compared.rotate=this.definition.compared.rotate*a,n.update(),this.segments.push(n)),o.definition?o.definition.copyFrom(this.definition):o.definition=this.definition.clone(),o.definition.compared.sourceZoom=i,o.definition.compared.pan=this.definition.compared.pan*d,o.definition.compared.rotate=this.definition.compared.rotate*d,o.update(),this._descensionSegment=o,this.segments.push(o);}_updateWithoutApex(){const[i]=this._preallocSegments;i.update(this.definition),this.segments.push(i);}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
const r$L={zoom:0,pan:0,rotate:0};class m$K{constructor(i){this.createCamera=i,this._time=n$1e(0),this.definition=new t$O(i),this.path=new s$G;}get time(){return this._time}update(t,a,s){this.definition.update(t,a,s),this.path.update(this.definition,s),this._time=this._applyTimeSettings(r$1c(this.path.time),s),this._easing=s.easing?s.easing:this._time>=1e3?w$w:f$H;}cameraAt(t,i){i=i||this.createCamera(),t=Math.min(Math.max(0,t),1),t=this._normalizedEasing(t);const e=this.path.interpolateComponentsAt(t,r$L);return i.interpolate(this.definition.source,this.definition.target,e),i}_normalizedEasing(t){const i=this._easing(0,this._time),e=this._easing(1,this._time);return (this._easing(t,this._time)-i)/(e-i)}_applyTimeSettings(i,e){const n=null!=e.speedFactor?e.speedFactor:1;null!=e.duration?i=e.duration:null!=e.speedFactor&&(i=n$1e(i/n));const a=null!=e.minDuration?e.minDuration:o$J.minDuration/n,o=null!=e.maxDuration?e.maxDuration:o$J.maxDuration/n;return n$1e(Math.min(Math.max(a,i),o))}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
const c$G=n$11();class h$C{constructor(i){this.currentTime=n$1e(0),this._animation=new m$K((()=>new T$n(i))),this._current=new T$n(i);}get finished(){return this.currentTime>=this._animation.time}get time(){return this._animation.time}update(i,m,o){const s=this._animation.definition.source,a=this._animation.definition.target,h=c$V(c$G,m.center,i.center),u=s$P(h);u>=1e-5?(h[0]/=u,h[1]/=u,h[2]/=u):(h[0]=0,h[1]=1,h[0]=0),r$Z(s.lookAtDirection,h),r$Z(a.lookAtDirection,h),s.copyFromRenderCamera(i),a.copyFromRenderCamera(m),this._current.copyFrom(s),this._animation.update(s,a,o),this.currentTime=n$1e(0),i.almostEquals(m)&&(this.currentTime=this._animation.time);}cameraAt(t,i){return this._animation.cameraAt(t,this._current),i=i||new J$g,this._current.copyToRenderCamera(i),i}step(e,r){return this.finished||(this.currentTime=n$1e(this.currentTime+r$1c(e)),this.currentTime>=this.time&&(this.currentTime=this.time)),this.cameraAt(this.currentTime/this.time,r)}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
var o$H;!function(e){e.Ready="ready",e.Rejected="rejected",e.Running="running",e.Stopped="stopped",e.Finished="finished";}(o$H||(o$H={}));let i$z=class extends p$14{constructor(){super(...arguments),this.state=o$H.Ready;}get active(){return this.state===o$H.Running}get isInteractive(){return !1}get canStop(){return !1}stopController(){return !!this.canStop&&(this.state=o$H.Stopped,!0)}finishController(){this.state=o$H.Finished;}get steppingFinished(){return !1}};e$Q([y$K({readOnly:!0})],i$z.prototype,"active",null),e$Q([y$K()],i$z.prototype,"state",void 0),i$z=e$Q([n$14("esri.views.3d.state.controllers.CameraController")],i$z);

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
let a$O=class extends i$z{get canStop(){return !0}set asyncResult(t){this._asyncResult&&(this._asyncResult.reject(m$Y()),this._asyncResult=null),this.state===o$H.Finished||this.state===o$H.Stopped?this.state===o$H.Finished?t.resolve():t.reject(m$Y()):this._asyncResult=t;}get asyncResult(){return this._asyncResult}onControllerStart(){this.state=o$H.Running,r$Y(this.viewAnimation)&&this.viewAnimation.when((()=>this.updateStateFromViewAnimation()),(()=>this.updateStateFromViewAnimation()));}updateStateFromViewAnimation(){!r$Y(this.viewAnimation)||this.state!==o$H.Ready&&this.state!==o$H.Running||(this.viewAnimation.state===n$1f.State.FINISHED?this.finish():this.viewAnimation.state===n$1f.State.STOPPED&&(this.state=o$H.Stopped));}onControllerEnd(){r$Y(this.viewAnimation)&&!this.viewAnimation.done&&(this.state===o$H.Finished?this.viewAnimation.finish():this.state===o$H.Stopped&&this.viewAnimation.stop()),this._asyncResult&&(this.state===o$H.Finished?this._asyncResult.resolve():this._asyncResult.reject(m$Y()));}finish(){this.finishController();}};a$O=e$Q([n$14("esri.views.3d.state.controllers.AnimationController")],a$O);

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
let h$B=class extends a$O{constructor(i){super(i),this.view=null,this.mode="interaction",this.hasTarget=!1;}get intersectionHelper(){return this.view.sceneIntersectionHelper}initialize(){this.animation=new h$C(this.view.state.viewingMode),this.viewAnimation="interaction"===this.mode?null:new n$1f;}get isInteractive(){return "interaction"===this.mode}begin(i,t){this.hasTarget=!0;const e=this.animationSettings(t);p$N.copyFrom(this.view.state.camera);const n=new u$L(this.view.state.viewingMode);this.intersectionHelper.intersectRay(p$N.ray,n,l$H)&&(p$N.center=l$H),this.animation.update(p$N,i,e),this.animation.finished&&this.finish();}finish(){this.animation.currentTime=this.animation.time,super.finish();}get steppingFinished(){return this.hasTarget&&this.animation.finished}stepController(i,t){this.hasTarget&&this.animation.step(i,t);}onControllerEnd(i){this.hasTarget&&(this.animation.cameraAt(this.animation.currentTime/this.animation.time,i),this.animation.currentTime=this.animation.time),super.onControllerEnd(i);}animationSettings(i={}){return {apex:{maximumDistance:this.view.state.constraints.clampAltitude(1/0)/6,ascensionFactor:void 0,descensionFactor:void 0},...i,easing:"string"==typeof i.easing?H$e[i.easing]:i.easing}}};e$Q([y$K({constructOnly:!0})],h$B.prototype,"view",void 0),e$Q([y$K({constructOnly:!0})],h$B.prototype,"mode",void 0),h$B=e$Q([n$14("esri.views.3d.state.controllers.PointToPointAnimationController")],h$B);const p$N=new J$g,l$H=n$11();

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
function i$y(n=x$C){return [n[0],n[1],n[2],n[3]]}function m$J(n,t){return g$F(n[0],n[1],n[2],t,r$X.get())}function g$F(n,t,r,u,o=i$y()){return o[0]=n,o[1]=t,o[2]=r,o[3]=u,o}function k$n(n,t,r=i$y()){return _$n(r,n,t),j$F(r,r),r[3]=f$P(n,t),r}function v$z(n){return n}const x$C=[0,0,1,0];

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
function p$M(t){const{value:n,operations:e}=t;return {operations:e,value:e.create(n)}}function v$y(t,n,e){return t.operations.setExtent(t.value,n,e.value),e}function m$I(t){return {operations:t,value:t.create()}}function d$B(t,n,e=m$I(t)){return e.operations=t,t.copy(n,e.value),e}function h$A(t){return d$B(Z$k,T$u(0,0,0,p$15(t).radius))}const j$u=2**50;function k$m(){return d$B(_s,J$j([0,0,0],[j$u,0,0],[0,j$u,0]))}function x$B(t,n,e){return t.operations.axisAt(t.value,n,2,e)}function y$A(t,n,e,o){return t.operations.axisAt(t.value,n,e,o)}function P$p(t,n,e){return t.operations.intersectRay(t.value,n,e)}function b$v(t,n,e){return t.operations.intersectRayClosestSilhouette(t.value,n,e)}function C$i(t,n){return t.operations.altitudeAt(t.value,n)}function O$q(t,n,e,o){return t.operations.setAltitudeAt(t.value,n,e,o)}function T$m(e,o,r,u){return o!==u&&n$18(u,o),o$S(w$t,u[12],u[13],u[14]),O$q(e,w$t,r,w$t),u[12]=w$t[0],u[13]=w$t[1],u[14]=w$t[2],u}function q$h(t,n,e){return t.operations.elevate(t.value,n,e.value)}const w$t=n$11();function B$e(t,n,o,r,u){return u[0]=z$u(t,n),u[1]=z$u(t,o),u[2]=z$u(t,r),u}function D$j(t,n,e,s,a){r$Z(e,t),r$Z(F$o,n),j$F(F$o,F$o),_$n(s,F$o,e),_$n(a,s,e);}const F$o=n$11();

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
function u$I(r,n,o=a$11()){return m$H(r,r.screenToRender(n,p$18(c$U.get())),o)}function m$H(t,c,u=a$11()){const m=p$18(a$13(c$U.get(),c));if(m[2]=0,!t.unprojectFromRenderScreen(m,u.origin))return null;const g=p$18(a$13(c$U.get(),c));g[2]=1;const p=t.unprojectFromRenderScreen(g,c$U.get());return t$17(p)?null:(c$V(u.direction,p,u.origin),u)}function g$E(r,n,o=a$11()){return p$L(r,r.screenToRender(n,p$18(c$U.get())),o)}function p$L(e,n,u=a$11()){r$Z(u.origin,e.eye);const m=o$S(c$U.get(),n[0],n[1],1),g=e.unprojectFromRenderScreen(m,c$U.get());return t$17(g)?null:(c$V(u.direction,g,u.origin),u)}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
function s$F(r,s,p,e){const n=g$E(s,p,m$G);return V$l(r,n,e)}const m$G=a$11();

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
function L$m(t,e,n){return n[0]=e[0]/(t.fullWidth/t.pixelRatio),n[1]=e[1]/(t.fullHeight/t.pixelRatio),n}function O$p(t){for(;t>Math.PI;)t-=2*Math.PI;for(;t<-Math.PI;)t+=2*Math.PI;return t}function Q$g(t,e,n){const o=f$O.get();r$$(o),f$L(o,o,n[3],v$z(n)),c$V(Jt,t.eye,e),I$x(Jt,Jt,o),t.eye=u$S(Jt,Jt,e),c$V(Jt,t.center,e),I$x(Jt,Jt,o),t.center=u$S(Jt,Jt,e),t.up=I$x(Jt,t.up,o);}function X$c(t,e,n,o){return D$q(t,u$I(e,n,Qt),o)}function Y$g(t,e,n,o){const r=c$U.get();let a=1-n;c$V(r,e,t.eye);const s=s$P(r);let i=s*(1-a);a>=0&&i<o&&(i=o,a=-(i-s)/s),Math.abs(s-i)<1e-6||(d$O(r,r,a),t.eye=u$S(Jt,t.eye,r),t.center=y$N(Jt,t.center,e,a));}function Z$f(t,e,n){e.getScreenCenter($$h),s$F(t,e,$$h,Jt)&&(e.center=Jt);const o=e.distance,r=o*n;if(Math.abs(o-r)<1e-6)return;const a=d$O(c$U.get(),e.viewForward,r);e.eye=c$V(Jt,e.center,a);}const $$h=i$U();function tt$4(t,e){o$S(e,0,0,0);for(const n of t)u$S(e,e,n);d$O(e,e,1/t.length);}function et$3(t,e,n,o){return Math.sin(t/s$P(e))*(n+o.radius)}function nt$3(t,e,n,o){return et$3(Math.PI/2,e,n,o)+(t-Math.PI/2)}var ot$2;!function(t){t[t.Vertical=0]="Vertical",t[t.Horizontal=1]="Horizontal";}(ot$2||(ot$2={}));const rt$2={Elevation:3e4,Angle:b$F(6)},at$2={Pole:.95,Angle:b$F(18),Tilt:45},st$2=b$F(80);function it$3(t,e,n,o,r){const a=n$11(),s=_$o();let i=!0,c=!0;return t.intersectScreen(n,a)?s[3]=s$P(a):(c=!1,e.aboveGround?s[3]=Math.max(s$P(e.center),.9*r.radius):s[3]=s$P(e.eye)-e.relativeElevation,o?pt$2(s,e,n,a):i=s$F(s,e,n,a)),{sphere:s,scenePickPoint:i?a:null,hasGeometryIntersection:c}}function ct$2(t,n,o,r){if(s$P(t.eye)-r.radius>rt$2.Elevation)return ot$2.Horizontal;if(!o)return ot$2.Vertical;g$E(t,n,Xt);return -s$T(t.relativeElevation)*(.5*Math.PI+f$P(t.eye,Xt.direction))<rt$2.Angle?ot$2.Vertical:ot$2.Horizontal}function mt$1(t,e,n){c$V(ut$2,n,e),t.eye=c$V(Jt,t.eye,ut$2),t.center=c$V(Jt,t.center,ut$2);}const ut$2=n$11();function pt$2(t,e,n,o){const a=g$E(e,n,Qt);return !t$17(a)&&(F$y(t,a,lt$2),V$l(t,a,o)?!(x$P(lt$2,a.origin)<x$P(o,a.origin))||(r$Z(o,lt$2),!1):(c$V(ft$2,e.eye,e.center),j$F(ft$2,ft$2),v$J(ft$2,-z$u(j$F(ft$2,ft$2),lt$2),ht$2),D$q(ht$2,a,o),!1))}const lt$2=n$11(),ft$2=n$11(),ht$2=p$11();function Mt(e,r,a,s,i,c){let m;if(_$n(Nt,e,r),c$V(Kt,e,r),s$P(e)<=i||!s.aboveGround){_$n(a,Kt,s.eye);const u=z$u(e,r)/(s$P(e)*s$P(r)),p=Math.cos(o$R(S$B.normalize(b$F(c)),0,st$2));m=-x$N(u)-Math.max(0,s$P(r)-i)/(p*i);}else c$V(yt,s.eye,s.center),_$n(a,Kt,yt),m=-s$P(Kt)/i;return j$F(a,a),d$O(a,a,s$P(Nt)),m}const yt=n$11();function gt$1(e,r,a,s){let i,c;const m=Math.cos(o$R(S$B.normalize(b$F(s)),0,st$2));return i=r>a?-(r-a)/(m*a):r<-a?Math.PI-(r+a)/(m*a):x$N(r/a),c=e>a?-(e-a)/(m*a):e<-a?Math.PI-(e+a)/(m*a):x$N(e/a),(c-i)*a}function bt$1(t,e,n,o,r,a,s,i,c,m){const p=gt$1(t[2],e[2],s[3],c),l=m?gt$1(t[0],e[0],s[3],180):e[0]-t[0],h=Math.sin(i)*l-Math.cos(i)*p,M=Math.cos(i)*l+Math.sin(i)*p;j$F(Jt,r);const g=m?h/Math.sqrt(Math.abs(s[3]**2-z$u(n,Jt)**2)):h/s[3],b=M/Math.sqrt(Math.abs(s[3]**2-z$u(n,o)**2));r$18(a,g,b);}function dt$1(t,e,n,o,r,a,s,i,c,m){_$n(Nt,t,e),D$j(a.up,a.eye,Gt,St$1,Vt),D$j([0,0,1],a.eye,Ht,Ut,Et),r$Z(n,Ut),r$Z(o,Ht),j$F(n,n),d$O(n,n,s$P(Nt)),B$e(t,j$F(St$1,St$1),j$F(Vt,Vt),j$F(Gt,Gt),qt),B$e(e,St$1,Vt,Gt,Ft),bt$1(qt,Ft,t,Ht,Ut,r,s,i,c,m);}function jt(t,e,n,o,r,a,m){r$$(Tt$1),r$$(Wt),r$$(Bt),f$L(Tt$1,Tt$1,r,o),f$L(Wt,Wt,m,a),e$V(Bt,Tt$1,Wt),c$V(e,t,n),I$x(e,e,Bt),u$S(e,e,n);}function vt(t,e,n,o,r,a){r$$(Tt$1),r$$(Wt),r$$(Bt),f$L(Tt$1,Tt$1,o,n),f$L(Wt,Wt,a,r),e$V(Bt,Tt$1,Wt),c$V(Jt,t.eye,e),I$x(Jt,Jt,Bt),t.eye=u$S(Jt,Jt,e),c$V(Jt,t.center,e),I$x(Jt,Jt,Bt),t.center=u$S(Jt,Jt,e),c$V(Jt,t.up,e),I$x(Jt,Jt,Bt),t.up=u$S(Jt,Jt,e);}function zt(t,e,n,o,r,a,s=at$2.Pole,i=at$2.Angle){const c=Math.abs(o)>Math.PI-i||Math.abs(o)<i,m=Math.abs(t[2])<n*s||Math.abs(e)>n;return !!(c&&m&&a.aboveGround&&r<at$2.Tilt)}function xt$2(t,e,n,o,r,a){if(a)k$n(n,o,Ct),Q$g(e,t,Ct);else {const a=Mt(n,o,Ot,e,t[3],r);Q$g(e,t,m$J(Ot,a));}}function Pt(t,e,n,o,r,a,s){const i=s?20:1,c=1e-12;let m,u;r$Z(Dt,o),Lt.copyFrom(e);for(let p=0;p<i&&x$P(n,Dt)>c&&(m=x$P(n,Dt),dt$1(n,Dt,Ut,Ht,Rt,Lt,t,r,a,s),vt(Lt,t,Ht,Rt[1],Ut,Rt[0]),jt(Dt,Dt,t,Ht,Rt[1],Ut,Rt[0]),u=x$P(n,Dt),u<m||0===p);p++)e.copyFrom(Lt);}function kt(e,n,o,r,a,s,i){zt(o,z$u(n.up,o),e[3],-S$B.normalize(b$F(a)),s,n,at$2.Pole,at$2.Angle)?Pt(e,n,o,r,-S$B.normalize(b$F(a)),s,i):xt$2(e,n,o,r,s,i);}function It(t,e,n,o,r,a){const{eye:s}=t;D$j([0,0,1],s,Ht,Ut,Et);const c=e.translation[0]*n.pan,m="zoom"===r.mode?0:e.translation[1]*n.pan,u=Math.max(Math.sqrt(Math.abs(1-z$u(t.center,Ht)**2/s$P(t.center)**2)),.5),p=(Math.sin(a)*m+Math.cos(a)*c)/u,l=-Math.cos(a)*m+Math.sin(a)*c;switch(f$L(o.pan.matrix,o.pan.matrix,p,Ht),o.pan.enabled=!0,r.mode){case"pan":f$L(o.pan.matrix,o.pan.matrix,l,Ut),o.pan.enabled=!0;break;case"zoom":o.zoom=-e.translation[1]*n.zoom;}}function wt(t,e,n,o,r){const{eye:a,viewRight:s}=t,c=_$n(c$U.get(),s,a),m=e.translation[0]*n.pan;switch(0!==m&&(f$L(o.pan.matrix,o.pan.matrix,-m,c),o.pan.enabled=!0),r.mode){case"pan":{const t=e.translation[1]*n.pan;0!==t&&(f$L(o.pan.matrix,o.pan.matrix,t,s),o.pan.enabled=!0);break}case"zoom":o.zoom=-e.translation[1]*n.zoom;}}function At(e,n,o,r,a,s,i,c,m){zt(e.center,z$u(e.up,e.center),s$P(e.center),-S$B.normalize(b$F(s)),i,n)?It(n,o,r,c,m,-S$B.normalize(b$F(a))):wt(n,o,r,c,m);}const Ht=n$11(),Ut=n$11(),Et=n$11(),Gt=n$11(),St$1=n$11(),Vt=n$11(),qt=n$11(),Ft=n$11(),Rt=n$19(),Ct=i$y(),Tt$1=e$P(),Wt=e$P(),Bt=e$P(),Dt=n$11(),Jt=n$11(),Kt=n$11(),Lt=new J$g,Nt=n$11(),Ot=n$11(),Qt={origin:n$11(),direction:n$11()},Xt={origin:n$11(),direction:n$11()};

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
const S$v=.6,z$k=4,M$r=12,L$l=60,V$h=20;let O$o=class extends h$B{constructor(){super(...arguments),this.zoomLocation=n$11(),this.tmpCamera=new J$g,this.tmpViewDir=n$11(),this.tmpRayDir={origin:n$11(),direction:n$11()},this.targetOnSphere=n$11(),this.tmpCenter=n$11(),this.constraintOptions={selection:7,interactionType:1,interactionFactor:null,interactionStartCamera:new J$g,interactionDirection:null,tiltMode:0},this.sphere=_$o();}initialize(){this.intersector=new u$L(this.view.state.viewingMode);}zoomStep(t,i){if(!this.active)return;const e=this.view.state,{interactionStartCamera:r}=this.constraintOptions;this.animation.finished?r.copyFrom(e.camera):this.animation.cameraAt(1,r);let o=!1,a=!1;this.intersectionHelper.intersectScreen(i,this.zoomLocation)&&(o=t>0,a=!0),this.tmpCamera.copyFrom(e.camera),o?this.intersectionHelper.intersectRay(this.tmpCamera.ray,this.intersector,this.tmpCenter)&&(this.tmpCamera.center=this.tmpCenter):this.intersectionHelper.intersectRay(this.tmpCamera.ray,this.intersector,this.zoomLocation)?this.tmpCamera.center=this.zoomLocation:r$Z(this.zoomLocation,this.tmpCamera.center),this.updateCamera(this.tmpCamera,t,this.zoomLocation,i,a),this.begin(this.tmpCamera);}animationSettings(){return {apex:null,duration:n$1e(600),easing:f$H}}updateCamera(t,e,r,s,p){const y=p$15(this.view.spatialReference);if(ct$2(t,s,p,y)===ot$2.Horizontal||s$U("disable-feature:context-navigation")){let i=S$v**e;this.sphere[3]=s$P(r),c$V(this.tmpViewDir,t.center,t.eye);const h=s$P(this.tmpViewDir);let p=h*i;if(i<=1&&p<z$k&&(p=z$k,i=p/h),Math.abs(h-p)<1e-6)return;const l=s$P(t.center);if(this.sphere[3]!==l){const e=this.sphere[3]+i*(l-this.sphere[3]);t.center=d$O(x$A,t.center,e/l);}d$O(this.tmpViewDir,this.tmpViewDir,-i),t.eye=u$S(x$A,t.center,this.tmpViewDir),p$Q(this.view,t,this.constraintOptions),x$P(r,t.center)>1e-12&&s$F(this.sphere,t,s,this.targetOnSphere)&&kt(this.sphere,t,r,this.targetOnSphere,this.view.camera.heading,this.view.camera.tilt,!0);}else {let i=S$v**Math.abs(e);const o=e>0?1:-1;let a;g$E(t,s,this.tmpRayDir),j$F(this.tmpRayDir.direction,this.tmpRayDir.direction),this.view.camera.position.hasZ&&(a=Math.abs(this.view.camera.position.z));let c=Math.max(M$r*a,V$h);const p=this.view._stage.renderView.getMinimalDepthForArea(s[0],s[1],this.view.state.camera,L$l);c=c>p?p:c,d$O(this.tmpRayDir.direction,this.tmpRayDir.direction,c),u$S(r,this.tmpRayDir.origin,this.tmpRayDir.direction);let l=c*i;if(e>0&&l<z$k&&(l=z$k,i=l/c),Math.abs(c-l)<1e-6)return;d$O(this.tmpRayDir.direction,this.tmpRayDir.direction,o*(1-i)),t.eye=u$S(x$A,t.eye,this.tmpRayDir.direction),t.center=u$S(x$A,t.center,this.tmpRayDir.direction);}i$E(this.view,t);}};O$o=e$Q([n$14("esri.views.3d.state.controllers.global.ZoomStepController")],O$o);const x$A=n$11();

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
const g$D=.6,j$t=4,w$s=60,b$u=14,d$A=20;let v$x=class extends h$B{constructor(){super(...arguments),this.zoomLocation=n$11(),this.tmpCamera=new J$g,this.tmpRayDir=n$11(),this.tmpCenter=n$11(),this.constraintOptions={selection:15,interactionType:1,interactionFactor:null,interactionStartCamera:new J$g,interactionDirection:null,tiltMode:0};}zoomStep(t,e){if(!this.active)return;const i=this.view.state,{interactionStartCamera:c}=this.constraintOptions;this.animation.finished?c.copyFrom(i.camera):this.animation.cameraAt(1,c),this.tmpCamera.copyFrom(i.camera);const l=new u$L(this.view.state.viewingMode);t>0?(this.intersectionHelper.intersectScreenFreePointFallback(e,this.zoomLocation),this.intersectionHelper.intersectRay(this.tmpCamera.ray,l,this.tmpCenter)&&(this.tmpCamera.center=this.tmpCenter)):this.intersectionHelper.intersectRay(this.tmpCamera.ray,l,this.zoomLocation)?this.tmpCamera.center=this.zoomLocation:r$Z(this.zoomLocation,this.tmpCamera.center);const C=g$D**t;if(!r$1d()){let t=this.view._stage.renderView.getMinimalDepthForArea(e[0],e[1],this.view.state.camera,w$s);const i=Math.max(b$u*Math.abs(this.view.camera.position.z),d$A);if(t=t?Math.min(t,i):i,t){const e=n$11();c$V(e,this.zoomLocation,this.tmpCamera.eye),t<s$P(e)&&(j$F(e,e),u$S(this.zoomLocation,this.tmpCamera.eye,d$O(e,e,t)));}}this.updateCamera(this.tmpCamera,C,this.zoomLocation),this.begin(this.tmpCamera);}animationSettings(){return {apex:null,duration:n$1e(600),easing:f$H}}updateCamera(t,e,i){c$V(this.tmpRayDir,i,t.eye);const o=s$P(this.tmpRayDir);let a=o*e;e<=1&&a<j$t&&(a=j$t,e=a/o),Math.abs(o-a)<1e-6||(d$O(this.tmpRayDir,this.tmpRayDir,e),t.eye=c$V(z$j,i,this.tmpRayDir),t.center=y$N(z$j,t.center,i,1-e),p$Q(this.view,t,this.constraintOptions));}};v$x=e$Q([n$14("esri.views.3d.state.controllers.local.ZoomStepController")],v$x);const z$j=n$11();

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class s$E extends i$V{constructor(o,t){super(!0),this.view=o,this.registerIncoming("double-click",t,(o=>this.handleDoubleClick(o)));}handleDoubleClick(r){const s=r.data;if(t$1a(s,"primary")){const i=this.view.state.isGlobal?new O$o({view:this.view,mode:"animation"}):new v$x({view:this.view,mode:"animation"});this.view.state.switchCameraController(i),i.zoomStep(Math.log(.5)/Math.log(.6),i$U(s.x,s.y)),r.stopPropagation();}}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
let a$N=class extends i$z{constructor(){super(...arguments),this.startCamera=new J$g,this.currentCamera=new J$g;}get isInteractive(){return !0}stepController(r,e){e.copyViewFrom(this.currentCamera),this.currentCamera.copyFrom(e);}onControllerStart(r){this.state=o$H.Running,this.startCamera.copyFrom(r),this.currentCamera.copyFrom(r);}onControllerEnd(r){r.copyViewFrom(this.currentCamera);}};a$N=e$Q([n$14("esri.views.3d.state.controllers.InteractiveController")],a$N);

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
const O$n=7,V$g=90;let b$t=class extends a$N{constructor(t){super(t),this.view=null,this.pivot=0,this.lastPoint=n$19(),this.tmpWorldUp=n$11(),this.tmpViewDir=n$11(),this.tmpRotCurPoint=n$19(),this.tmpTransf=e$P(),this.tmpAxis=n$11(),this.tmpPivotPoint=n$11(),this.pivotPos=n$11(),this.constraintOptions={selection:15,interactionType:2,interactionFactor:0,interactionStartCamera:null,interactionDirection:null,tiltMode:0};}get intersectionHelper(){return this.view.sceneIntersectionHelper}initialize(){this.rotScale=0===this.pivot?3:1.5;}begin(t){if(this.active){switch(this.pivot){case 1:r$Z(this.pivotPos,this.startCamera.eye),this.constraintOptions.interactionType=3,this.constraintOptions.tiltMode=1,this.constraintOptions.selection=0;break;case 0:this.intersectionHelper.intersectRayFreePointFallback(this.startCamera.ray,this.pivotPos)||r$Z(this.pivotPos,this.startCamera.center),s$U("disable-feature:context-navigation")||this.constrainPivotPoint(t),this.startCamera.center=this.pivotPos,this.constraintOptions.interactionType=2,this.constraintOptions.tiltMode=0,this.constraintOptions.selection=11;}this.constraintOptions.interactionStartCamera=this.startCamera,L$m(this.startCamera,t,this.lastPoint);}}constrainPivotPoint(t){const i=this.startCamera,s=n$11();c$V(s,this.pivotPos,i.eye);let o=s$P(s);this.view.camera.position.hasZ&&(o=Math.min(o,O$n*Math.abs(this.view.camera.position.z)));const e=p$15(this.view.spatialReference),a=i$U(i.width/i.pixelRatio*.5,i.height/i.pixelRatio*.5),n=ct$2(this.startCamera,a,!0,e);let p=this.view._stage.renderView.getMinimalDepthForArea(i.fullWidth/i.pixelRatio*.5,i.fullHeight/i.pixelRatio*.5,i,2.5*V$g,V$g),h=this.view._stage.renderView.getMinimalDepthForArea(t[0],t[1],i,V$g);void 0===p&&void 0===h||(p=void 0===p?h:p,h=void 0===h||n===ot$2.Horizontal?p:h,o=p>h?h:p),j$F(s,s),r$Z(this.pivotPos,u$S(this.tmpPivotPoint,i.eye,d$O(this.tmpPivotPoint,s,o)));}update(t){if(this.active){switch(this.pivot){case 1:this.currentCamera.center=this.applyRotation(this.currentCamera,t,this.currentCamera.center,this.pivotPos);break;case 0:this.currentCamera.center=this.pivotPos,this.currentCamera.eye=this.applyRotation(this.currentCamera,t,this.currentCamera.eye,this.pivotPos);}p$Q(this.view,this.currentCamera,this.constraintOptions);}}end(){this.active&&this.finishController();}applyRotation(t,i,r,e){this.view.renderCoordsHelper.worldUpAtPosition(e,this.tmpWorldUp),L$m(t,i,this.tmpRotCurPoint);let a=(this.lastPoint[1]-this.tmpRotCurPoint[1])*this.rotScale,h=(this.tmpRotCurPoint[0]-this.lastPoint[0])*this.rotScale;c$V(this.tmpViewDir,r,e);const m=s$P(this.tmpViewDir),l=x$N(z$u(this.tmpViewDir,this.tmpWorldUp)/m);if(1===this.pivot){a*=-.5;const t=.5*Math.PI-l,i=.5*Math.PI*.99;a=t-Math.max(-i,Math.min(i,t+a));}return a=o$R(a+l,d$M.min,d$M.max)-l,r$$(this.tmpTransf),_$n(this.tmpAxis,t.up,this.tmpViewDir),0===this.pivot&&(h=-h),f$L(this.tmpTransf,this.tmpTransf,h,this.tmpWorldUp),f$L(this.tmpTransf,this.tmpTransf,a,this.tmpAxis),I$x(this.tmpViewDir,this.tmpViewDir,this.tmpTransf),t.up=I$x(U$k,t.up,this.tmpTransf),u$S(U$k,e,this.tmpViewDir),a$13(this.lastPoint,this.tmpRotCurPoint),U$k}};e$Q([y$K({constructOnly:!0})],b$t.prototype,"view",void 0),e$Q([y$K()],b$t.prototype,"pivot",void 0),b$t=e$Q([n$14("esri.views.3d.state.controllers.RotateController")],b$t);const U$k=n$11();

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class a$M extends i$V{constructor(t,r,e,o){super(!0),this.view=t,this.pointerAction=r,this.pivot=e,this.registerIncoming("drag",o,(t=>this.handleDrag(t)));}handleDrag(e){const a=e.data;if(a.pointers.size>1)return;if(!r$1e(e.data,this.pointerAction))return;const i=i$U(a.center.x,a.center.y);switch(a.action){case"start":this.cameraController&&(this.cameraController.end(),this.cameraController=null),this.cameraController=new b$t({view:this.view,pivot:this.pivot}),this.view.state.switchCameraController(this.cameraController),this.cameraController.begin(i);break;case"update":this.cameraController&&this.cameraController.update(i);break;case"end":this.cameraController&&(this.cameraController.end(),this.cameraController=null);}e.stopPropagation();}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
const x$z=30,M$q=70;let O$m=class extends a$N{constructor(t){super(t),this.view=null,this.pickPoint=n$11(),this.tmpP0=n$19(),this.panAxisAngle=i$y(),this.tmpRayDir=n$11(),this.targetOnSphere=n$11(),this.tmpRay={origin:n$11(),direction:n$11()},this.dragBeginPoint=i$U(),this.normalizedAnchorPoint=n$19(),this.constraintOptions={selection:7,interactionType:1,interactionFactor:0,interactionStartCamera:null,interactionDirection:null,tiltMode:0},this.sphere=_$o(),this.hasPickPoint=!1;}get intersectionHelper(){return this.view.sceneIntersectionHelper}begin(t){if(!this.active)return;a$13(this.dragBeginPoint,t),L$m(this.startCamera,t,this.normalizedAnchorPoint);const e=p$15(this.view.spatialReference),r=it$3(this.intersectionHelper,this.startCamera,t,!1,e);if(this.navMode=ct$2(this.startCamera,t,r.hasGeometryIntersection,e),this.navMode===ot$2.Horizontal||s$U("disable-feature:context-navigation"))this.hasPickPoint=!!r.scenePickPoint,this.pickPoint=r.scenePickPoint,this.sphere=r.sphere;else {let i;g$E(this.startCamera,t,this.tmpRay),j$F(this.tmpRay.direction,this.tmpRay.direction),this.view.camera.position.hasZ&&(i=Math.abs(this.view.camera.position.z));let e=x$z*i;const r=this.view._stage.renderView.getMinimalDepthForArea(t[0],t[1],this.view.state.camera,M$q);e=e>r?r:e,this.hasPickPoint=!0,d$O(this.tmpRay.direction,this.tmpRay.direction,e),u$S(this.pickPoint,this.tmpRay.origin,this.tmpRay.direction);}this.constraintOptions.interactionStartCamera=this.startCamera;}update(t){if(this.active){if(this.currentCamera.eye=this.startCamera.eye,this.currentCamera.center=this.startCamera.center,this.currentCamera.up=this.startCamera.up,this.navMode===ot$2.Horizontal||s$U("disable-feature:context-navigation")){c$V(this.tmpRayDir,this.currentCamera.center,this.currentCamera.eye);const i=s$P(this.tmpRayDir);L$m(this.currentCamera,t,this.tmpP0);const e=12*(this.normalizedAnchorPoint[1]-this.tmpP0[1]);let r=i*2**e;const s=this.view.state.constraints.minimumPoiDistance;if(e<0&&r<s&&(r=s),Math.abs(i-r)<1e-6)return;if(this.hasPickPoint&&r<i){const t=1-(1-r/i)*(1-this.sphere[3]/s$P(this.currentCamera.center));this.currentCamera.center=d$O(S$u,this.currentCamera.center,t);}d$O(this.tmpRayDir,this.tmpRayDir,-r/i),this.currentCamera.eye=u$S(S$u,this.currentCamera.center,this.tmpRayDir),this.constraintOptions.interactionFactor=f$G(this.dragBeginPoint,t),p$Q(this.view,this.currentCamera,this.constraintOptions),this.hasPickPoint&&(pt$2(this.sphere,this.currentCamera,this.dragBeginPoint,this.targetOnSphere),k$n(this.pickPoint,this.targetOnSphere,this.panAxisAngle),Q$g(this.currentCamera,this.sphere,this.panAxisAngle));}else {const i=s$P(this.tmpRay.direction);L$m(this.currentCamera,t,this.tmpP0);const e=12*(this.normalizedAnchorPoint[1]-this.tmpP0[1]);let r=i*2**e;const s=this.view.state.constraints.minimumPoiDistance;if(e<0&&r<s&&(r=s),Math.abs(i-r)<1e-6)return;d$O(this.tmpRayDir,this.tmpRay.direction,1-r/i),this.currentCamera.eye=u$S(S$u,this.currentCamera.eye,this.tmpRayDir),this.currentCamera.center=u$S(S$u,this.currentCamera.center,this.tmpRayDir);}i$E(this.view,this.currentCamera);}}end(){this.active&&this.finishController();}};e$Q([y$K({constructOnly:!0})],O$m.prototype,"view",void 0),O$m=e$Q([n$14("esri.views.3d.state.controllers.global.ZoomController")],O$m);const S$u=n$11();

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
const w$r=30,N$k=70;let O$l=class extends a$N{constructor(t){super(t),this.view=null,this.tmpP=n$11(),this.tmpDir=n$11(),this.tmpN=n$11(),this.tmpP0=n$19(),this.tmpPoi=n$11(),this.tmpRayDir=n$11(),this.dragBeginPoint=i$U(),this.normalizedAnchorPoint=n$19(),this.constraintOptions={selection:15,interactionType:1,interactionFactor:0,interactionStartCamera:null,interactionDirection:n$11(),tiltMode:0},this.plane=p$11();}get intersectionHelper(){return this.view.sceneIntersectionHelper}begin(t){if(!this.active)return;let i;a$13(this.dragBeginPoint,t),L$m(this.startCamera,t,this.normalizedAnchorPoint),this.intersectionHelper.intersectScreenFreePointFallback(t,this.tmpP),c$V(this.tmpDir,this.tmpP,this.startCamera.eye),j$F(this.tmpDir,this.tmpDir),this.view.camera.position.hasZ&&(i=Math.abs(this.view.camera.position.z));let r=w$r*i;const s=this.view._stage.renderView.getMinimalDepthForArea(t[0],t[1],this.view.state.camera,N$k);r=r>s?s:r,d$O(this.tmpDir,this.tmpDir,r),u$S(this.tmpP,this.startCamera.eye,this.tmpDir),c$V(this.tmpN,this.startCamera.eye,this.startCamera.center),j$F(this.tmpN,this.tmpN),this.tmpN[1]<0&&v$N(this.tmpN,this.tmpN),y$J(this.tmpP,this.tmpN,this.plane),this.constraintOptions.interactionStartCamera=this.startCamera;}update(t){if(!this.active)return;X$c(this.plane,this.currentCamera,this.dragBeginPoint,this.tmpPoi)||r$Z(this.tmpPoi,this.currentCamera.center),L$m(this.currentCamera,t,this.tmpP0);let r=4*(this.tmpP0[1]-this.normalizedAnchorPoint[1]);a$13(this.normalizedAnchorPoint,this.tmpP0),c$V(this.tmpRayDir,this.tmpPoi,this.currentCamera.eye);const s=s$P(this.tmpRayDir);let e=s*(1-r);r$Z(this.constraintOptions.interactionDirection,this.tmpRayDir),d$O(this.constraintOptions.interactionDirection,this.constraintOptions.interactionDirection,s$T(r)/s);const o=this.view.state.constraints.minimumPoiDistance;r>=0&&e<o&&(e=o,r=-(e-s)/s),Math.abs(s-e)<1e-6||(d$O(this.tmpRayDir,this.tmpRayDir,r),this.currentCamera.eye=u$S(b$s,this.currentCamera.eye,this.tmpRayDir),y$N(b$s,this.currentCamera.center,this.tmpPoi,r),this.tmpPoi[2]>this.startCamera.center[2]?b$s[2]=Math.max(this.startCamera.center[2],b$s[2]):b$s[2]=Math.min(this.startCamera.center[2],b$s[2]),this.currentCamera.center=b$s,this.constraintOptions.interactionFactor=f$G(this.dragBeginPoint,t),p$Q(this.view,this.currentCamera,this.constraintOptions));}end(){this.active&&this.finishController();}};e$Q([y$K({constructOnly:!0})],O$l.prototype,"view",void 0),O$l=e$Q([n$14("esri.views.3d.state.controllers.local.ZoomController")],O$l);const b$s=n$11();

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class s$D extends i$V{constructor(r,t,e){super(!0),this.view=r,this.pointerAction=t,this.registerIncoming("drag",e,(r=>this.handleDrag(r)));}handleDrag(o){const s=o.data;if(s.pointers.size>1)return;if(!r$1e(o.data,this.pointerAction))return;const i=i$U(s.center.x,s.center.y);switch(s.action){case"start":this.cameraController&&(this.cameraController.end(),this.cameraController=null),this.view.state.isGlobal?this.cameraController=new O$m({view:this.view}):this.cameraController=new O$l({view:this.view}),this.view.state.switchCameraController(this.cameraController),this.cameraController.begin(i);break;case"update":this.cameraController&&this.cameraController.update(i);break;case"end":this.cameraController&&(this.cameraController.end(),this.cameraController=null);}o.stopPropagation();}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
const l$G=n$11(),u$H=n$11();function h$z(){return {direction:n$11(),up:n$11()}}function m$F(f,h,m,p,d){let g=j$F(l$G,f),j=z$u(g,p);const b=j>0;j=Math.abs(j),j>.99&&(j=Math.abs(z$u(h,p)),j<.99?(r$Z(g,h),b&&d$O(g,g,-1)):g=null);let k=0;if(g){d$O(u$H,p,z$u(p,g)),c$V(g,g,u$H);const n=z$u(g,d)/(s$P(g)*s$P(d));_$n(u$H,g,d);k=(z$u(u$H,p)>0?1:-1)*N$o(x$N(n));}const v=N$o(x$N(-z$u(p,f)/s$P(f)));return m?(m.heading=k,m.tilt=v,m):{heading:k,tilt:v}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
const j$s=t$_(0,1,0),y$z=t$_(0,0,1),g$C=e$P(),x$y=n$11(),h$y=n$11();function v$w(t,n,c,m=h$z()){r$$(g$C);const{direction:f,up:p}=m;return m$W(g$C,g$C,-b$F(n)),b$H(g$C,g$C,b$F(c)),I$x(f,y$z,g$C),d$O(f,f,-1),I$x(p,j$s,g$C),m}function R$m(t,e,r,o){return m$F(e,r,o,y$z,j$s)}function _$l(t,e,r,o){const i=v$w(t,r,o),n=n$11();return d$O(n,i.direction,-e),u$S(n,n,t),{up:i.up,eye:n,heading:r,tilt:o}}function b$r(e){return N$o(e)}function E$o(t){return b$F(t)}function H$d(t,e,r,o,i){const n=t.renderSpatialReference,a=t.map&&t.spatialReference||e.spatialReference;return Rn(e,x$y,n),Rn(e,h$y,n),x$y[0]-=r/2,h$y[0]+=r/2,x$y[1]-=o/2,h$y[1]+=o/2,wn(x$y,n,x$y,a),wn(h$y,n,h$y,a),i?(i.xmin=x$y[0],i.ymin=x$y[1],i.xmax=h$y[0],i.ymax=h$y[1],i.spatialReference=a):i=new M$x(x$y[0],x$y[1],h$y[0],h$y[1],a),i}var U$j=Object.freeze({__proto__:null,headingTiltToDirectionUp:v$w,directionToHeadingTilt:R$m,eyeForCenterWithHeadingTilt:_$l,lookAtTiltToEyeTilt:b$r,eyeTiltToLookAtTilt:E$o,toExtent:H$d});

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
const v$v=t$_(0,0,1),w$q=j$F(n$11(),t$_(1,1,1)),I$p=new P$z(-180,180),U$i=e$P(),P$o=n$11(),q$g=n$11();function E$n(e,a,s,f=h$z()){_$n(P$o,e,v$v),0===z$u(P$o,P$o)&&_$n(P$o,e,w$q),r$$(U$i),f$L(U$i,U$i,-b$F(a),e),f$L(U$i,U$i,-b$F(s),P$o);const{up:p,direction:h}=f;return _$n(p,P$o,e),j$F(p,p),I$x(p,p,U$i),j$F(h,e),v$N(h,h),I$x(h,h,U$i),f}function _$k(t,e,a,i){const o=P$o,s=q$g;return j$F(o,t),_$n(q$g,o,v$v),0===z$u(q$g,q$g)&&_$n(q$g,o,w$q),_$n(s,q$g,o),m$F(e,a,i,o,s)}function H$c(e,i,o,s){const n={eye:n$11(),up:null,tilt:s,heading:o},r=P$o;r[0]=e[0],r[1]=e[2],r[2]=-e[1];const c=i,l=b$F(o),m=b$F(s),h=Math.sin(l),y=Math.cos(l),M=Math.sin(m),d=Math.cos(m),j=s$P(r);let T;if(Math.abs(m)<1e-8)T=c+j;else {const t=j/M,e=p$16(c/t),i=Math.PI-m-e;T=t*Math.sin(i);}const g=d*c,R=c*c*(M*M),x=y*y*R,b=T-g,v=b*b,w=x*(x+v-r[1]*r[1]);if(w<0)return d$O(n.eye,r,T/j),n.tilt=0,n;const I=Math.sqrt(w),U=r[1]*b,q=x+v;let E;if(E=y>0?-I+U:I+U,Math.abs(q)<1e-8)return j<1e-8?(n.eye[0]=0,n.eye[1]=0,n.eye[2]=c):d$O(n.eye,r,T/j),n.tilt=0,W$g(n.eye),k$l(n,e);n.eye[1]=E/q;const _=h*h*R,H=M*c,z=y*H*n.eye[1],A=n.eye[1]*n.eye[1],G=1-A,S=Math.sqrt(G),C=x*A+_-2*z*S*b+G*v;return Math.abs(C)<1e-8?(d$O(n.eye,r,T/j),n.tilt=0,W$g(n.eye),k$l(n,e)):(n.eye[0]=(G*(T*r[0]-g*r[0])-H*S*(r[0]*n.eye[1]*y+r[2]*h))/C,n.eye[2]=(G*(T*r[2]-g*r[2])-H*S*(r[2]*n.eye[1]*y-r[0]*h))/C,d$O(n.eye,n.eye,T),W$g(n.eye),k$l(n,e))}function W$g(t){const e=t[1];t[1]=-t[2],t[2]=e;}function k$l(t,e){const a=E$n(e,t.heading,t.tilt);return t.up=a.up,t}function z$i(t,i,o){const s=s$P(i),n=Math.sqrt(o*o+s*s-2*o*s*Math.cos(Math.PI-t)),r=p$16(o/(n/Math.sin(t)));return N$o(t-r)}function A$l(e,i,o){const s=b$F(e),n=s$P(i);return p$16(o/(n/Math.sin(s)))+s}function G$e(a,i,o,s,n){let r,c,l,m;const f=i.latitude,p=i.longitude,h=c$L(f,o,p$15(a.spatialReference).radius)/2;r=p-h,c=p+h;const u=b$F(f),T=p$15(a.spatialReference).radius,g=(1+Math.sin(u))/(1-Math.sin(u)),x=(g+1)*Math.tan(s/T/2),v=x*x;function w(t){const e=Math.PI/2;return (t=F$z.normalize(t,-e))>e&&(t=Math.PI-t),t}if(l=1.5*Math.PI-2*Math.atan(.5*(x+Math.sqrt(4*g+v))),m=l+s/T,l=w(l),m=w(m),m<l){const t=m;m=l,l=t;}if(l=Math.max(N$o(l),-90),m=Math.min(N$o(m),90),c=I$p.monotonic(r,c),c-r>180){const t=(c-r-180)/2;r+=t,c-=t;}const U=a.spatialReference&&a.spatialReference.isGeographic?a.spatialReference:k$x.WGS84;return n?(n.xmin=r,n.ymin=l,n.xmax=c,n.ymax=m,n.spatialReference=U):n=new M$x(r,l,c,m,U),a.spatialReference&&a.spatialReference.isWebMercator&&d$V(n,!1,n),n}var S$t=Object.freeze({__proto__:null,headingTiltToDirectionUp:E$n,directionToHeadingTilt:_$k,eyeForCenterWithHeadingTilt:H$c,lookAtTiltToEyeTilt:z$i,eyeTiltToLookAtTilt:A$l,toExtent:G$e});

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
function i$x(i,r){return null!=i&&("2d"===r||("local"===r?!i.isGeographic:i.isWebMercator||i.isWGS84||4490===i.wkid||104971===i.wkid||104905===i.wkid||104903===i.wkid))}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
const P$n=n$12.getLogger("esri.views.3d.support.cameraUtils"),k$k=39.37,A$k=96,I$o=1,L$k=8,E$m=5,q$f=1,F$n=n$11(),G$d=n$11(),O$k={heading:0,tilt:0},W$f=new b$G,X$b=new P$z(-20037508.342788905,20037508.342788905),D$i=new P$z(-180,180);function Y$f(e){return e.spatialReference||k$x.WGS84}function N$j(e){return "global"===e.viewingMode?S$t:U$j}function Z$e(e,t,n,r,i){return N$j(e).headingTiltToDirectionUp(t,n,r,i)}function B$d(e,t){if(t$17(t))return null;const r=e.renderSpatialReference,o=N$j(e).headingTiltToDirectionUp,a=n$11();if(!Rn(t.position,a,r))return null;const s=o(a,t.heading,t.tilt);d$O(s.direction,s.direction,e.state.camera.distance),u$S(s.direction,s.direction,a);const f=g$J(e,a,s.direction,s.up);return f.fov=b$F(t.fov),f}const J$f=n$11();function K$f(t,n,o){const a=t.renderSpatialReference,s=ee$9(t,n.eye,n.viewForward,n.up,O$k);let c=Y$f(t);return wn(n.eye,a,J$f,c)||(c=k$x.WGS84,wn(n.eye,a,J$f,c)),t$17(o)?new d$W(new b$G(J$f,c),s.heading,s.tilt,N$o(n.fov)):(o.position.x=J$f[0],o.position.y=J$f[1],o.position.z=J$f[2],o.position.spatialReference=c,o.heading=s.heading,o.tilt=s.tilt,o.fov=N$o(n.fov),o)}function Q$f(e,t,r){const i=e.state.camera,o=i.width/2/i.pixelRatio;1===e.renderCoordsHelper.viewingMode&&null!=r&&(t*=Math.cos(b$F(r))),t/=e.renderCoordsHelper.unitInMeters;return o/(A$k*k$k/t)/Math.tan(i.fovX/2)}function V$f(e,t,r){const i=e.state.camera,o=t*Math.tan(i.fovX/2),a=i.width/2/i.pixelRatio;let s=A$k*k$k/(a/o);return 1===e.renderCoordsHelper.viewingMode&&(s/=Math.cos(b$F(r))),s*=e.renderCoordsHelper.unitInMeters,s}function $$g(e,t,n,r,i,o){return _$j(e,t,Q$f(e,n,t.latitude),r,i,o)}function _$j(e,t,n,r,o,a){if(xe$1(a)){const s=new je$1(a.signal);return oe$8(e,r.heading,r.tilt,t,n,o,s),void s.resolver.promise.then((t=>{const n=he$8(e,t,r.fov);if(!t$17(n))return a.resolver.resolve(n);a.resolver.reject();}),(e=>a.resolver.reject(e)))}const s=oe$8(e,r.heading,r.tilt,t,n,o);return he$8(e,s,r.fov,a)}function ee$9(e,t,n,r,i){return N$j(e).directionToHeadingTilt(t,n,r,i)}function te$8(e,t){return !!(e.basemapTerrain&&e.renderCoordsHelper.fromRenderCoords(t,W$f,e.spatialReference)&&c$W(i$O(e.elevationProvider,W$f),0)>W$f.z-q$f)}async function ne$8(e,t,n){if(!e.renderCoordsHelper.fromRenderCoords(t,W$f,e.spatialReference))return !1;const r=await e.elevationProvider.queryElevation(W$f.x,W$f.y,W$f.z,W$f.spatialReference,"ground",n);return c$W(r,0)>W$f.z-q$f}async function re$8(e,t,n){const r=n$11();if(t)if(t instanceof b$G){if(Rn(t,r,e.renderSpatialReference),null==t.z&&null!=e.basemapTerrain){const i=await e.elevationProvider.queryElevation(t.x,t.y,t.z,t.spatialReference,"ground",n);return r$Y(i)&&e.renderCoordsHelper.setAltitude(r,i),r}}else r$Z(r,t);else r$Z(r,e.state.camera.center);return r}function ie$7(e,t){const n=n$11();if(t&&t instanceof b$G){if(Rn(t,n,e.renderSpatialReference),null==t.z&&null!=e.basemapTerrain){const r=i$O(e.elevationProvider,t);r$Y(r)&&e.renderCoordsHelper.setAltitude(n,r);}}else r$Z(n,t||e.state.camera.center);return n}function oe$8(e,t,n,r,i,o,a){const s=r&&r instanceof b$G?r:null;if(xe$1(a))return re$8(e,r,a.signal).then((r=>{ae$8(e,t,n,s,r,i,o,a);}),(e=>a.resolver.reject(e))),null;const c=ie$7(e,r);return ae$8(e,t,n,s,c,i,o,a)}function ae$8(e,t,n,r,o,a,s,c){if(t$17(r)){const t=e.renderSpatialReference;if(r=dn(o,t,Y$f(e)),t$17(r))return null}a=Math.max(a,e.state.constraints.minimumPoiDistance);const l=fe$3(e,t,n,o,a,s),f=(0, N$j(e).eyeForCenterWithHeadingTilt)(o,a,l.heading,l.tilt);if(1===s&&"global"===e.viewingMode&&n>0){const i=()=>{const i=de$5(e,o,a,pe$7(e,a,n,o));return ae$8(e,t,i,r,o,a,s=n-i<1?0:1,c)},l=e.map.ground.navigationConstraint;if(!l||"stay-above"===l.type){if(te$8(e,f.eye))return i();if(xe$1(c))return ne$8(e,f.eye,c.signal).then((e=>e?i():(c.resolver.resolve({eye:f.eye,up:f.up,center:r$_(o),heading:f.heading,tilt:f.tilt}),null))),null}}const u=!c||xe$1(c)?{center:n$11(),eye:n$11(),up:n$11(),tilt:0,heading:0}:c;return u.eye=f.eye,u.up=f.up,u.center=r$_(o),u.heading=f.heading,u.tilt=f.tilt,xe$1(c)&&c.resolver.resolve(u),u}function se$a(e,t,n,r,o,a=null){let s,c,l,f,u=0;null!=t.zmax&&null!=t.zmin&&(s=(t.zmax+t.zmin)/2,u=t.zmax-t.zmin);if("global"===e.viewingMode){if(!i$x(t.spatialReference,"global"))return xe$1(a)&&a.resolver.reject(),null;const e=new b$G(t.xmin,t.ymin,t.spatialReference),n=new b$G(t.xmax,t.ymax,t.spatialReference),r=t.spatialReference.isGeographic?D$i:X$b;c=new b$G(r.center(e.x,n.x),(n.y+e.y)/2,t.spatialReference),null!=s&&(c.z=s);const i=p$15(t.spatialReference),o=i$H(c,e,n);l=o.lon,f=o.lat,r.diff(e.x,n.x)>r.range/2&&(l+=i.halfCircumference),l=Math.min(l,i.halfCircumference),f=Math.min(f,i.halfCircumference);}else {const n=Y$f(e);l=t.xmax-t.xmin,f=t.ymax-t.ymin,c=new b$G({x:t.xmin+.5*l,y:t.ymin+.5*f,z:s,spatialReference:n});}const m=e.state.camera,p=1/Math.tan(m.fovX/2),d=1/Math.tan(m.fovY/2),h=1/Math.tan(m.fov/2),g=Math.max(.5*l*p,.5*f*d,.5*u*h)/I$o;if(xe$1(a)){const t=new je$1(a.signal);return oe$8(e,n,r,c,g,o,t),void t.resolver.promise.then((t=>{const n=he$8(e,t,e.camera.fov);if(!t$17(n))return a.resolver.resolve(n);a.resolver.reject();}),(e=>a.resolver.reject(e)))}const y=oe$8(e,n,r,c,g,o);return he$8(e,y,e.camera.fov,a)}function ce$8(e,t,n){const r=e.renderSpatialReference,o=dn(n,r,Y$f(e));if(t$17(o))return null;const a=Math.tan(t.fovX/2),s=Math.tan(t.fovY/2),c=S$C(t.eye,n),l=2*c*a*I$o,u=2*c*s*I$o;return "global"===e.viewingMode?G$e(e,o,l,u):H$d(e,o,l,u)}function le$a(e,t,n){const r=e.pointsOfInterest.centerOnSurfaceFrequent.distance;if(Math.log(n/r)/Math.LN2>L$k)return !0;const o=e.renderSpatialReference,a=Y$f(e),s=dn(t,o,a),c=dn(e.pointsOfInterest.centerOnSurfaceFrequent.renderLocation,o,a);if(t$17(s)||t$17(c))return !1;const l=Math.tan(.5*e.state.camera.fov)*r;return c.distance(s)/l>E$m}function fe$3(e,t,n,r,i,o){let a=0;return 1===o&&le$a(e,r,i)?(t=0,a=me$5(e,i,n,r)):a=ve$1(e,r,i,n),a=e.state.constraints.clampTilt(i,a),{heading:t,tilt:n=de$5(e,r,i,a)}}const ue$6=.7;function me$5(e,t,n,r){const i=e.state.constraints.tilt(t);i.max=Math.min(i.max,.5*Math.PI);const o=i.min*(1-ue$6)+i.max*ue$6,a=ve$1(e,r,t,n);return Math.min(a,o)}function pe$7(e,t,n,r){const i=e.state.constraints.tilt(t);let o=ve$1(e,r,t,n);return o=Math.min(o,.5*Math.PI),i.min*(1-ue$6)+o*ue$6}function de$5(e,t,n,r){return N$j(e).lookAtTiltToEyeTilt(r,t,n)}function ve$1(e,t,n,r){return N$j(e).eyeTiltToLookAtTilt(r,t,n)}function he$8(t,n,r,o){if(t$17(n))return null;const s=t.renderSpatialReference,c=dn(n.eye,s,Y$f(t));return t$17(c)?null:r$Y(o)?(o.position=c,o.heading=n.heading,o.tilt=n.tilt,o.fov=r,o):new d$W(c,n.heading,n.tilt,r)}function ge$3(e,t){var n;const r=null==(n=e.basemapTerrain)?void 0:n.tilingScheme;if(r)return r.levelAtScale(t);P$n.error("#scaleToZoom()","Cannot compute zoom from scale without a tiling scheme");}function ye$2(e,t){var n;const r=null==(n=e.basemapTerrain)?void 0:n.tilingScheme;if(r)return r.scaleAtLevel(t);P$n.error("#zoomToScale()","Cannot compute scale from zoom without a tiling scheme");}function Re$1(e,t){return e.spatialReference?i$W(t,e.spatialReference):void 0}function Me$2(t,n,r){const i=t.renderSpatialReference;let o,a;n||(n=t.state.camera);const s=k$x.WGS84;return n instanceof d$W?(o=n.position.latitude,Rn(n.position,F$n,i),Rn(r,G$d,i),a=q$o(F$n,G$d)):(wn(n.center,i,G$d,s),o=G$d[1],a=n.distance),V$f(t,a,o)}class je$1{constructor(e){this.signal=e,this.resolver=D$r();}}function xe$1(e){return e&&"resolver"in e}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
let K$e=class extends a$N{constructor(t){super(t),this.transformation={translation:[0,0,0],heading:0,tilt:0,zoom:0},this.keysButtonState=[0,0,0,0,0,0,0,0,0,0,0,0],this.tmpCamera=new J$g,this.constraintOptions={selection:15,interactionType:0,interactionStartCamera:new J$g,interactionFactor:0,interactionDirection:null,tiltMode:1};}handleEventGamepad(t){const e=i$X(t,this.view.navigation.gamepad,this.transformation);("end"===t.action||s$V(e))&&this.finishController();}activateDirection(t){this.keysButtonState[t]=1,o$_(this.keysButtonState,this.transformation);}deactivateDirection(t){this.keysButtonState[t]=0;const e=o$_(this.keysButtonState,this.transformation);s$V(e)&&this.finishController();}onControllerStart(t){this.filteredSurfaceElevation=this.view.pointsOfInterest.cameraOnSurface.location.z,this.headingStart=this.view.camera.heading,super.onControllerStart(t);}updateFilteredSurfaceElevation(t){const e=this.view.pointsOfInterest.cameraOnSurface.location.z,i=1;this.filteredSurfaceElevation+=i*(e-this.filteredSurfaceElevation)*t;}stepController(t,e){this.updateStartHeading(),this.updateFilteredSurfaceElevation(t),this.currentCamera.copyViewFrom(e),this.updateCameraCenter(),this.constraintOptions.interactionStartCamera.copyFrom(this.currentCamera),this.calculateControlTransformation(t,this.currentCamera,Y$e),this.applyDisabledMovementTypes(Y$e),this.applyPan(Y$e.pan),this.applyRotate(Y$e.rotate),this.applyZoom(Y$e.zoom),this.applyAscend(Y$e.ascend),this.constraintOptions.interactionType=0,this.constraintOptions.selection=8,p$Q(this.view,this.currentCamera,this.constraintOptions),super.stepController(t,e);}updateStartHeading(){0!==this.transformation.heading&&(this.headingStart=this.view.camera.heading);}applyRotate(t){if(!t.enabled)return;const e=this.currentCamera;c$V($$f,e.center,e.eye),I$x($$f,$$f,t.matrix),e.center=u$S($$f,$$f,e.eye),e.up=I$x($$f,e.up,t.matrix),this.constraintOptions.interactionType=3,this.constraintOptions.selection=7,p$Q(this.view,e,this.constraintOptions);}applyPan(t,e=this.currentCamera){if(!t.enabled)return;e.eye=I$x($$f,e.eye,t.matrix),e.center=I$x($$f,e.center,t.matrix);this.view.state.isGlobal&&(e.up=I$x($$f,e.up,t.matrix)),this.constraintOptions.interactionType=4,this.constraintOptions.selection=15,p$Q(this.view,e,this.constraintOptions);}applyZoom(t){if(!t)return;const e=this.currentCamera.viewForward;this.currentCamera.eye=u$S($$f,this.currentCamera.eye,d$O(c$U.get(),e,t)),r$Z(tt$3,e),v$N(tt$3,tt$3),this.constraintOptions.interactionDirection=tt$3,this.constraintOptions.interactionType=1,this.constraintOptions.selection=7,p$Q(this.view,this.currentCamera,this.constraintOptions),this.constraintOptions.interactionDirection=null;}applyAscend(t){if(!t)return;const e=this.view.renderCoordsHelper.worldUpAtPosition(this.currentCamera.eye,c$U.get());this.constraintOptions.interactionDirection=r$Z(tt$3,e);if(this.view.state.isGlobal){const e=s$P(this.currentCamera.eye),i=(e+t)/e;this.currentCamera.eye=d$O($$f,this.currentCamera.eye,i),this.currentCamera.center=d$O($$f,this.currentCamera.center,i);}else {const i=d$O(c$U.get(),e,t);this.currentCamera.eye=u$S($$f,this.currentCamera.eye,i),this.currentCamera.center=u$S($$f,this.currentCamera.center,i);}this.updateCameraCenter(),this.constraintOptions.interactionType=5,this.constraintOptions.selection=8,p$Q(this.view,this.currentCamera,this.constraintOptions)&&this.updateCameraCenter(),this.constraintOptions.selection=7,p$Q(this.view,this.currentCamera,this.constraintOptions),this.constraintOptions.interactionDirection=null;}calculateControlTransformation(t,e,i){it$2(i);const a=this.computeVelocities(t);this.view.state.isLocal?this.calculateControlTransformationLocal(a,e,i):this.calculateControlTransformationGlobal(a,e,i);}updateCameraCenter(){const t=this.view.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,e=this.view.renderCoordsHelper,i=this.currentCamera.ray;this.currentCamera.center=e.intersectManifoldClosestSilhouette(i,t,$$f);}calculateControlTransformationLocal(t,i,r){const{viewRight:o,viewForward:s}=i,n=this.transformation,l=this.view.navigation.gamepad,p=o$S(c$U.get(),s[0],s[1],0);j$F(p,p);const h=n.translation[0]*t.pan;if(0!==h){const t=d$O(c$U.get(),o,h);c$_(r.pan.matrix,r.pan.matrix,t),r.pan.enabled=!0;}switch(l.mode){case"pan":{const e=-n.translation[1]*t.pan;if(0!==e){const t=d$O(c$U.get(),p,e);c$_(r.pan.matrix,r.pan.matrix,t),r.pan.enabled=!0;}r.zoom=n.zoom*t.zoom;break}case"zoom":r.zoom=(-n.translation[1]+n.zoom)*t.zoom;break;default:n$1d(l.mode);}const d=n.translation[2]*t.ascend;r.ascend=d;const u=-n.heading*t.rotate;0!==u&&(f$L(r.rotate.matrix,r.rotate.matrix,u,this.view.renderCoordsHelper.worldUpAtPosition(i.eye,c$U.get())),r.rotate.enabled=!0);const v=n.tilt*t.rotate,C=n$U(this.view.renderCoordsHelper,i.center,i.eye),g=o$R(C+v,d$M.min,d$M.max)-C;g&&(f$L(r.rotate.matrix,r.rotate.matrix,g,o),r.rotate.enabled=!0);}calculateControlTransformationGlobal(t,e,i){const{eye:a,viewRight:r}=e,o=this.transformation,s=this.view.navigation.gamepad,n=_$n(c$U.get(),r,a);j$F(n,n),v$N(n,n),At(this.startCamera,e,o,t,this.view.camera.heading,this.headingStart,this.view.camera.tilt,i,s),this.tmpCamera.copyFrom(this.currentCamera),this.applyPan(Y$e.pan,this.tmpCamera);const c=this.view.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,l=o.translation[2]*t.ascend;i.ascend=l;const p=-o.heading*t.rotate;0!==p&&(f$L(i.rotate.matrix,i.rotate.matrix,p,this.tmpCamera.eye),i.rotate.enabled=!0);const h=o.tilt*t.rotate,d=this.clampTiltDeltaGlobalToValidRange(h,e.ray,c);0!==d&&(f$L(i.rotate.matrix,i.rotate.matrix,d,this.tmpCamera.viewRight),i.rotate.enabled=!0),i.zoom+=o.zoom*t.zoom;}clampTiltDeltaGlobalToValidRange(t,e,r){const o=p$15(this.view.spatialReference),s=et$3(d$M.min,e.origin,r,o);let n=0,c=0;const m=c$U.get();if(this.view.renderCoordsHelper.intersectManifold(e,r,m)){const t=n$U(this.view.renderCoordsHelper,m,e.origin);n=et$3(t,e.origin,r,o),c=et$3(d$M.max,e.origin,r,o);}else {F$y(E$x(r+o.radius),e,m);const t=x$N(-z$u(e.direction,j$F(m,m)));n=nt$3(t,e.origin,r,o),c=nt$3(d$M.max,e.origin,r,o);}return o$R(n+t,s,c)-n}getPointAbsoluteSurfaceElevation(t,e,i){const{renderCoordsHelper:a}=this.view,r=a.getAltitude(t),o=e+Math.abs(r-e);return a.setAltitude(i,o,t),o}clampedDistanceToSurface(t,e){const{renderCoordsHelper:i}=this.view,{camera:a}=this.view.state,{direction:r}=Z$e(this.view,e,0,X$a,et$2),o=i.intersectManifoldClosestSilhouette(d$R(e,r),t,c$U.get()),s=q$o(e,o),n=i.intersectManifoldClosestSilhouette(d$R(e,H$m(c$U.get(),e,a.center)),t,c$U.get()),c=q$o(e,n);return Math.min(s,c)}computeHeadingRotateRadius(t){const{renderCoordsHelper:e,state:a}=this.view,{camera:r,isGlobal:o}=a,s=e.intersectManifoldClosestSilhouette(r.ray,this.filteredSurfaceElevation,c$U.get());if(o){const e=c$V(c$U.get(),t,s),a=s$P(e);d$O(e,e,1/a);const r=j$F(c$U.get(),t),o=x$N(z$u(r,e));return a*Math.sin(Math.min(_$i,o))}{const i=r$Z(c$U.get(),t);return e.setAltitude(i,this.filteredSurfaceElevation),q$o(s,i)}}minimumAscendVelocity(){return this.view.state.constraints.collision.enabled?0:N$i}computeVelocities(t){const e=this.filteredSurfaceElevation,i=e+p$15(this.view.spatialReference).radius,{camera:r,isGlobal:o}=this.view.state,s=c$U.get(),n=this.getPointAbsoluteSurfaceElevation(r.eye,e,s),c=this.clampedDistanceToSurface(e,s),m=r.width/2,l=J$e*r.width,p=J$e*r.width,h=c*Math.tan(.5*r.fovX)/m,d=h/i,u=h/this.computeHeadingRotateRadius(s),f=n-e;return {pan:(o?d:h)*l*t,ascend:Math.max(this.minimumAscendVelocity()*t,2**(l*t/m)*f-f),zoom:2**(l*t/m)*c-c,rotate:o$R(u*p,Q$e,W$e)*t}}applyDisabledMovementTypes(t){!r$Y(this.disableMovements)||void 0!==this.disableMovements.mode&&this.view.state.viewingMode!==this.disableMovements.mode||(t.zoom=this.disableMovements.zoom?0:t.zoom,t.ascend=this.disableMovements.ascend?0:t.ascend,t.pan.enabled=!this.disableMovements.pan,this.disableMovements.pan&&r$$(t.pan.matrix),t.rotate.enabled=!this.disableMovements.rotate,this.disableMovements.rotate&&r$$(t.rotate.matrix));}static activatesFor(t,e){const i=i$X(e,t.navigation.gamepad,Z$d);return !("end"===e.action||s$V(i))}};e$Q([y$K({constructOnly:!0})],K$e.prototype,"view",void 0),e$Q([y$K({constructOnly:!0})],K$e.prototype,"gamepadDevice",void 0),e$Q([y$K({constructOnly:!0})],K$e.prototype,"disableMovements",void 0),K$e=e$Q([n$14("esri.views.3d.state.controllers.GamepadKeyboardController")],K$e);const Z$d={translation:[0,0,0],heading:0,tilt:0,zoom:0},X$a=80,_$i=b$F(X$a),J$e=.75,N$i=5,Q$e=b$F(30),W$e=b$F(80),Y$e={zoom:0,ascend:0,pan:{enabled:!1,matrix:e$P()},rotate:{enabled:!1,matrix:e$P()}},$$f=n$11(),tt$3=n$11(),et$2=h$z();function it$2(t){t.zoom=0,t.ascend=0,t.pan.enabled=!1,r$$(t.pan.matrix),t.rotate.enabled=!1,r$$(t.rotate.matrix);}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class i$w extends i$V{constructor(e){super(!0),this.view=e,this.watchHandles=new u$T,this.handle=this.registerIncoming("gamepad",(a=>this.handleEventGamepad(a))),this.handle.pause();}onInstall(a){super.onInstall(a),this.watchHandles.add([d$S(this.view.navigation.gamepad,"enabled",(a=>{a?this.handle.resume():(this.handle.pause(),this.cameraControllerGamepad&&(this.cameraControllerGamepad.finishController(),this.cameraControllerGamepad=null));})),this.view.navigation.gamepad.watch("device",(a=>{this.cameraControllerGamepad&&a&&this.cameraControllerGamepad.gamepadDevice!==a&&(this.cameraControllerGamepad.finishController(),this.cameraControllerGamepad=null);}))]);}onUninstall(){this.watchHandles.removeAll(),super.onUninstall();}handleEventGamepad(a){const e=this.view.navigation.gamepad.device;if(e&&a.data.device!==e)return;const r=this.cameraControllerGamepad&&this.cameraControllerGamepad.active;if(r||K$e.activatesFor(this.view,a.data)){if(!r){const e=new K$e({view:this.view,gamepadDevice:a.data.device});this.view.state.switchCameraController(e)&&(this.cameraControllerGamepad=e);}this.cameraControllerGamepad&&this.cameraControllerGamepad.active&&this.cameraControllerGamepad.gamepadDevice===a.data.device&&this.cameraControllerGamepad.handleEventGamepad(a.data);}}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class r$K extends i$V{constructor(e,t){super(!0),this.view=e,this.disableMovements={pan:!0,zoom:!1,ascend:!0,rotate:!1,mode:2},this.keyToNumber={[t.left]:0,[t.right]:1,[t.forward]:2,[t.backward]:3,[t.up]:4,[t.down]:5,[t.headingLeft]:6,[t.headingRight]:7,[t.tiltUp]:8,[t.tiltDown]:9,[t.zoomIn]:10,[t.zoomOut]:11},this.registerIncoming("key-down",null,(e=>this.handleKeyDown(e))),this.registerIncoming("key-up",null,(e=>this.handleKeyUp(e))),this.registerIncoming("blur",null,(()=>this.handleBlur()));}handleKeyDown(t){if(t.data.native.ctrlKey||t.data.native.metaKey)return;const r=this.keyToNumber[t.data.key];null!=r&&(this.cameraControllerKeyboard&&this.cameraControllerKeyboard.active||(this.cameraControllerKeyboard=new K$e({view:this.view,disableMovements:this.disableMovements}),this.view.state.switchCameraController(this.cameraControllerKeyboard)),this.cameraControllerKeyboard.active&&(this.cameraControllerKeyboard.activateDirection(r),t.stopPropagation()));}handleBlur(){this.cameraControllerKeyboard&&this.cameraControllerKeyboard.active&&(this.cameraControllerKeyboard.finishController(),this.cameraControllerKeyboard=null);}handleKeyUp(e){if(e.data.native.ctrlKey||e.data.native.metaKey)return;const t=this.keyToNumber[e.data.key];null!=t&&this.cameraControllerKeyboard&&this.cameraControllerKeyboard.active&&(this.cameraControllerKeyboard.deactivateDirection(t),e.stopPropagation());}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class i$v extends i$V{constructor(e,t){super(!0),this.view=e,this.registerIncoming("mouse-wheel",t,(e=>this.handleMouseWheel(e)));}handleMouseWheel(r){if(!this.view.navigation.mouseWheelZoomEnabled)return;const i=r.data;this.cameraController&&this.cameraController.active||(this.cameraController=this.view.state.isGlobal?new O$o({view:this.view,mode:"interaction"}):new v$x({view:this.view,mode:"interaction"}),this.view.state.switchCameraController(this.cameraController)),this.cameraController.zoomStep(-1/60*i.deltaY,i$U(i.x,i.y)),r.preventDefault(),r.stopPropagation();}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class t$M{constructor(t){this._gain=t;}reset(t){this._value=t;}set gain(t){this._gain=t;}get value(){return void 0===this._value?0:this._value}update(t){void 0===this._value?this._value=t:this._value=this._gain*t+(1-this._gain)*this._value;}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
let a$L=class extends a$O{constructor(t){super(t),this.view=null,this.beginCamera=new J$g,this.elapsedTimeSec=0,this.constraintOptions={selection:15,interactionType:4,interactionFactor:0,interactionStartCamera:new J$g,interactionDirection:null,tiltMode:0};}initialize(){this.constraintOptions.interactionType=this.interactionType,this.viewAnimation=new n$1f;}get steppingFinished(){return this.momentum.isFinished(this.elapsedTimeSec)}onControllerStart(t){this.beginCamera.copyFrom(t),this.constraintOptions.interactionStartCamera=this.beginCamera,super.onControllerStart(t);}stepController(t,e){e.copyViewFrom(this.beginCamera),this.elapsedTimeSec+=t,this.momentumStep(this.elapsedTimeSec,e),p$Q(this.view,e,this.constraintOptions);}};e$Q([y$K({constructOnly:!0})],a$L.prototype,"view",void 0),a$L=e$Q([n$14("esri.views.3d.state.controllers.momentum.MomentumController")],a$L);

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
let c$F=class extends a$L{constructor(t){super(t),this.interactionType=4,this.tmpPan=n$11();}momentumStep(t,o){const r=this.momentum.value(t);d$O(this.tmpPan,this.momentum.direction,r),o.eye=c$V(i$u,o.eye,this.tmpPan),o.center=c$V(i$u,o.center,this.tmpPan),this.constraintOptions.interactionDirection=this.tmpPan;}};e$Q([y$K({constructOnly:!0})],c$F.prototype,"momentum",void 0),c$F=e$Q([n$14("esri.views.3d.state.controllers.momentum.PanPlanarMomentumController")],c$F);const i$u=n$11();

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
const p$K=n$11(),a$K=n$11();let u$G=class extends a$L{constructor(o){super(o),this.interactionType=4;}momentumStep(o,s){const t=this.momentum.value1(o),i=this.momentum.value2(o);r$Z(a$K,s.eye),j$F(a$K,a$K),_$n(this.momentum.axis2,a$K,this.momentum.axis1),vt(s,p$K,this.momentum.axis1,t,this.momentum.axis2,i);}};e$Q([y$K({constructOnly:!0})],u$G.prototype,"momentum",void 0),u$G=e$Q([n$14("esri.views.3d.state.controllers.momentum.PanSphericalMomentumController")],u$G);

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
let n$R=class extends a$L{constructor(t){super(t),this.interactionType=2;}set center(t){this._set("center",r$_(t));}set axis(t){this._set("axis",r$_(t));}momentumStep(t,o){const r=this.momentum.value(t);Q$g(o,this.center,m$J(this.axis,r));}};e$Q([y$K({constructOnly:!0})],n$R.prototype,"momentum",void 0),e$Q([y$K({constructOnly:!0})],n$R.prototype,"center",null),e$Q([y$K({constructOnly:!0})],n$R.prototype,"axis",null),n$R=e$Q([n$14("esri.views.3d.state.controllers.momentum.MomentumController")],n$R);

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
let a$J=class extends a$L{constructor(t){super(t),this.interactionType=1,this.constraintOptions.interactionDirection=n$11();}set zoomCenter(t){this._set("zoomCenter",r$_(t));}momentumStep(t,o){r$Z(this.constraintOptions.interactionDirection,o.eye);const r=this.momentum.valueDelta(0,t);Y$g(o,this.zoomCenter,r,this.view.state.constraints.minimumPoiDistance),this.constraintOptions.interactionDirection=H$m(this.constraintOptions.interactionDirection,o.eye,this.constraintOptions.interactionDirection);}};e$Q([y$K({constructOnly:!0})],a$J.prototype,"momentum",void 0),e$Q([y$K({constructOnly:!0})],a$J.prototype,"zoomCenter",null),a$J=e$Q([n$14("esri.views.3d.state.controllers.momentum.ZoomPlanarMomentumController")],a$J);

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
let y$y=class extends a$L{constructor(t){super(t),this.interactionType=1,this.radius=0,this.tmpSceneCenter=n$11(),this.tmpZoomAxisAngle=i$y(),this.sphere=_$o();}set screenCenter(t){this._set("screenCenter",i$U(t[0],t[1]));}set sceneCenter(t){this._set("sceneCenter",r$_(t));}initialize(){this.sphere[3]=this.radius;}momentumStep(t,e){const s=this.momentum.valueDelta(0,t);Z$f(this.sphere,e,s),this.constraintOptions.interactionType=1,p$Q(this.view,e,this.constraintOptions),pt$2(this.sphere,e,this.screenCenter,this.tmpSceneCenter),k$n(this.sceneCenter,this.tmpSceneCenter,this.tmpZoomAxisAngle),Q$g(e,this.sphere,this.tmpZoomAxisAngle),this.constraintOptions.interactionType=4;}};e$Q([y$K({constructOnly:!0})],y$y.prototype,"momentum",void 0),e$Q([y$K({constructOnly:!0})],y$y.prototype,"screenCenter",null),e$Q([y$K({constructOnly:!0})],y$y.prototype,"sceneCenter",null),e$Q([y$K({constructOnly:!0})],y$y.prototype,"radius",void 0),y$y=e$Q([n$14("esri.views.3d.state.controllers.momentum.ZoomSphericalMomentumController")],y$y);

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class e$G{constructor(e){this.gain=e;}update(e){this.hasFilteredValue?this.filteredValue=(1-this.gain)*this.filteredValue+this.gain*e:this.filteredValue=e;}reset(){this.filteredValue=void 0;}get hasFilteredValue(){return void 0!==this.filteredValue}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
const u$F=1e-5;class c$E extends t$1c{constructor(t,e,i,s,a,h=0,n){super(t,e,i),this.angularVelocity1=s,this.axis1=a,this.angularVelocity2=h,this.axis2=n;}value1(t){return super.valueFromInitialVelocity(this.angularVelocity1,t)}value2(t){return super.valueFromInitialVelocity(this.angularVelocity2,t)}}class o$G{constructor(e=300,i=12,s=.84){this.minimumInitialVelocity=e,this.stopVelocity=i,this.friction=s,this.enabled=!0,this.tmpAxis1=n$11(),this.tmpAxis2=n$11(),this.tmpAngles=n$19(),this.time=new t$1b(.3),this.screen=[new t$1b(.4),new t$1b(.4)],this.angle1=new e$G(.6),this.angle2=new e$G(.6),this.axis1=n$11(),this.axis2=n$11(),this.lastScene=n$11();}addMomentumDirectRotation(t,a,n,l,r,m){if(this.enabled){if(this.time.hasLastValue){if(this.time.computeDelta(n)<.01)return;let t=Mt(this.lastScene,a,this.tmpAxis2,l,r,m);this.angle2.update(0),p$12(this.tmpAxis2)<u$F?t=0:j$F(this.axis1,this.tmpAxis2),this.angle1.update(t),r$Z(this.lastScene,a);}this.screen[0].update(t[0]),this.screen[1].update(t[1]),this.time.update(n);}}addMomentumPreserveHeading(t,a,h,l,r,m,c){if(this.enabled){if(this.time.hasLastValue){if(this.time.computeDelta(h)<.01)return;dt$1(this.lastScene,a,this.tmpAxis2,this.tmpAxis1,this.tmpAngles,l,r,m,c,!1),p$12(this.tmpAxis2)<u$F?(this.angle1.update(0),this.angle2.update(0)):(this.angle1.update(this.tmpAngles[1]),this.angle2.update(this.tmpAngles[0]),j$F(this.axis1,this.tmpAxis1),j$F(this.axis2,this.tmpAxis2)),r$Z(this.lastScene,a);}this.screen[0].update(t[0]),this.screen[1].update(t[1]),this.time.update(h);}}reset(){this.screen[0].reset(),this.screen[1].reset(),this.angle1.reset(),this.angle2.reset(),this.time.reset();}evaluateMomentum(){if(!this.enabled||!this.screen[0].hasFilteredDelta)return null;const t=this.screen[0].filteredDelta,e=this.screen[1].filteredDelta,i=Math.sqrt(t*t+e*e)/this.time.filteredDelta;return Math.abs(i)<this.minimumInitialVelocity?null:this.createMomentum(i,this.stopVelocity,this.friction)}createMomentum(t,e,i){const s=this.angle1.filteredValue/this.time.filteredDelta,a=this.angle2.filteredValue/this.time.filteredDelta;return new c$E(t,e,i,s,this.axis1,a,this.axis2)}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
let Y$d=class extends a$N{constructor(t){super(t),this.view=null,this.smoothRotation=new t$M(.05),this.rotationAxis=n$11(),this.panningPlane=p$11(),this.smoothScaling=new t$M(.05),this.zoomCenterScreen=i$U(),this.zoomMomentumEstimator=new s$W,this.rotationMomentumEstimator=new a$14,this.panSphericalMomentumEstimator=new o$G,this.panPlanarMomentumEstimator=new h$P,this.adjustedSphere=_$o(),this.tmp3d=n$11(),this.tmpScreenPointArray=i$U(),this.beginScreenPoint=i$U(),this.beginScenePoint=n$11(),this.screenPickPoint=i$U(),this.navMode=ot$2.Horizontal,this.tmpInteractionDirection=n$11(),this.constraintOptions={selection:15,interactionType:0,interactionFactor:0,interactionStartCamera:new J$g,interactionDirection:null,tiltMode:0};}get intersectionHelper(){return this.view.sceneIntersectionHelper}begin(t){if(!this.active)return;const e=this.view.navigation.momentumEnabled;this.zoomMomentumEstimator.enabled=e,this.rotationMomentumEstimator.enabled=e,this.panPlanarMomentumEstimator.enabled=e,this.panSphericalMomentumEstimator.enabled=e,this.beginHeading=-S$B.normalize(b$F(this.view.camera.heading)),this.beginRadius=t.radius,this.pointerCount=t.pointers.size,this.beginAngle=t.angle,this.smoothRotation.reset(),d$X(t.center,this.screenPickPoint),a$13(this.beginScreenPoint,this.screenPickPoint);const s=p$15(this.view.spatialReference),o=it$3(this.intersectionHelper,this.startCamera,this.screenPickPoint,!0,s);this.scenePickPoint=o.scenePickPoint,this.sphere=o.sphere,r$Z(this.beginScenePoint,this.scenePickPoint),this.navMode=ct$2(this.startCamera,this.screenPickPoint,o.hasGeometryIntersection,s),this.navMode===ot$2.Vertical&&this.preparePlanarPanMode(t),this.constraintOptions.interactionStartCamera.copyFrom(this.startCamera);}preparePlanarPanMode(t){const i=v$N(this.tmp3d,this.startCamera.viewForward);y$J(this.scenePickPoint,i,this.panningPlane);const o=i$U(this.screenPickPoint[0],0),r=n$11(),a=s$P(this.startCamera.eye);this.adjustedSphere[3]=a<this.sphere[3]?a-100:this.sphere[3],pt$2(this.adjustedSphere,this.startCamera,o,r);const v=x$Q();this.startCamera.projectToRenderScreen(r,v);const C=.9*v[1];if(this.screenPickPoint[1]=Math.min(this.screenPickPoint[1],C),this.intersectionHelper.intersectScreen(this.screenPickPoint,this.scenePickPoint)&&y$J(this.scenePickPoint,W$j(this.panningPlane),this.panningPlane),!r$1d()){const t=n$11(),i=n$11(),e=n$11(),n=80,s=5,o=50;c$V(t,this.scenePickPoint,this.currentCamera.eye),j$F(t,t);const r=s*Math.max(Math.abs(this.view.camera.position.z),o),a=this.view._stage.renderView.getMinimalDepthForArea(this.screenPickPoint[0],this.screenPickPoint[1],this.view.state.camera,n),m=a?Math.min(a,r):r;r$Z(e,u$S(i,this.currentCamera.eye,d$O(i,t,m))),this.panningPlane[3]=-z$u(this.panningPlane,e),this.startCamera.center=u$S(i,this.startCamera.eye,d$O(i,this.startCamera.viewForward,m));}const M=d$X(t.center,this.tmpScreenPointArray);X$c(this.panningPlane,this.startCamera,M,this.beginScenePoint);}update(t){if(!this.active)return;this.currentCamera.copyFrom(this.startCamera);const i=t.pointers.size>1;this.navMode===ot$2.Horizontal?(i&&this.zoomSpherical(t),this.panningSpherical(t),i&&this.rotateSpherical(t)):(i&&this.zoomPlanar(t),this.panningPlanar(t),i&&this.rotatePlanar(t));}end(t){t.pointers.size===this.pointerCount&&this.update(t),this.finishController();const i=this.zoomMomentumEstimator.evaluateMomentum();if(i)return this.navMode===ot$2.Horizontal?new y$y({view:this.view,momentum:i,screenCenter:this.zoomCenterScreen,sceneCenter:this.beginScenePoint,radius:this.sphere[3]}):new a$J({view:this.view,momentum:i,zoomCenter:this.beginScenePoint});const e=this.rotationMomentumEstimator.evaluateMomentum();if(e)return new n$R({view:this.view,momentum:e,center:this.sphere,axis:this.rotationAxis});if(this.navMode===ot$2.Horizontal){const t=this.panSphericalMomentumEstimator.evaluateMomentum();if(t)return new u$G({view:this.view,momentum:t})}else {const t=this.panPlanarMomentumEstimator.evaluateMomentum();if(t)return new c$F({view:this.view,momentum:t})}return null}zoomSpherical(t){const i=this.beginRadius/t.radius,e=.001875*Math.min(Math.max(t.radius,40),120);this.smoothScaling.gain=e,this.smoothScaling.update(i),Z$f(this.sphere,this.currentCamera,this.smoothScaling.value),d$X(t.center,this.zoomCenterScreen),this.zoomMomentumEstimator.add(this.smoothScaling.value,.001*t.timestamp),this.constraintOptions.interactionType=1,this.constraintOptions.interactionFactor=f$G(t.radius-this.beginRadius),p$Q(this.view,this.currentCamera,this.constraintOptions);}panningSpherical(t){const i=d$X(t.center,this.tmpScreenPointArray);pt$2(this.sphere,this.currentCamera,i,this.tmp3d),zt(this.beginScenePoint,z$u(this.currentCamera.up,this.beginScenePoint),this.sphere[3],this.beginHeading,this.view.camera.tilt,this.startCamera)?(Pt(this.sphere,this.currentCamera,this.beginScenePoint,this.tmp3d,this.beginHeading,this.view.camera.tilt,!1),this.panSphericalMomentumEstimator.addMomentumPreserveHeading(i,this.tmp3d,.001*t.timestamp,this.startCamera,this.sphere,this.beginHeading,this.view.camera.tilt)):(xt$2(this.sphere,this.currentCamera,this.beginScenePoint,this.tmp3d,this.view.camera.tilt,!1),this.panSphericalMomentumEstimator.addMomentumDirectRotation(i,this.tmp3d,.001*t.timestamp,this.startCamera,this.sphere[3],this.view.camera.tilt)),this.constraintOptions.interactionType=4,this.constraintOptions.interactionFactor=f$G(this.screenPickPoint,i),p$Q(this.view,this.currentCamera,this.constraintOptions);}rotateSpherical(t){j$F(this.rotationAxis,this.scenePickPoint),this.currentCamera.aboveGround||v$N(this.rotationAxis,this.rotationAxis);const i=this.smoothRotation.value,e=i+O$p(t.angle-i),n=.00125*Math.min(Math.max(t.radius,40),120);this.smoothRotation.gain=n,this.smoothRotation.update(e);const s=this.smoothRotation.value-this.beginAngle;this.rotationMomentumEstimator.add(s,.001*t.timestamp),Q$g(this.currentCamera,this.sphere,m$J(this.rotationAxis,s)),this.constraintOptions.interactionType=2,this.constraintOptions.interactionFactor=f$G(t.radius*e),p$Q(this.view,this.currentCamera,this.constraintOptions);}panningPlanar(t){const i=d$X(t.center,this.tmpScreenPointArray);X$c(this.panningPlane,this.currentCamera,i,this.tmp3d)&&(mt$1(this.currentCamera,this.beginScenePoint,this.tmp3d),this.panPlanarMomentumEstimator.add(i,this.tmp3d,.001*t.timestamp),this.constraintOptions.interactionType=4,this.constraintOptions.interactionFactor=f$G(this.beginScreenPoint,i),this.constraintOptions.interactionDirection=this.view.renderCoordsHelper.worldUpAtPosition(this.currentCamera.eye,this.tmpInteractionDirection),p$Q(this.view,this.currentCamera,this.constraintOptions),this.constraintOptions.interactionDirection=null);}zoomPlanar(t){const i=this.beginRadius/t.radius,e=.001875*Math.min(Math.max(t.radius,40),120);this.smoothScaling.gain=e,this.smoothScaling.update(i),this.zoomMomentumEstimator.add(this.smoothScaling.value,.001*t.timestamp),Y$g(this.currentCamera,this.beginScenePoint,this.smoothScaling.value,this.view.state.constraints.minimumPoiDistance),this.constraintOptions.interactionType=1,this.constraintOptions.interactionFactor=f$G(t.radius-this.beginRadius),p$Q(this.view,this.currentCamera,this.constraintOptions);}rotatePlanar(t){r$Z(this.rotationAxis,this.beginScenePoint),this.currentCamera.aboveGround||v$N(this.rotationAxis,this.rotationAxis);const i=this.smoothRotation.value;let e=t.angle-i;e=O$p(e);const n=i+e,s=.00125*Math.min(Math.max(t.radius,40),120);this.smoothRotation.gain=s,this.smoothRotation.update(n);const o=this.smoothRotation.value-this.beginAngle;this.rotationMomentumEstimator.add(o,.001*t.timestamp),Q$g(this.currentCamera,this.sphere,m$J(this.rotationAxis,o)),this.constraintOptions.interactionType=2,this.constraintOptions.interactionFactor=f$G(t.radius*o),p$Q(this.view,this.currentCamera,this.constraintOptions);}};e$Q([y$K({constructOnly:!0})],Y$d.prototype,"view",void 0),Y$d=e$Q([n$14("esri.views.3d.state.controllers.global.PinchAndPanController")],Y$d);

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
const I$n=t$_(0,0,1),U$h={ELEVATION_THRESHOLD:3e4,ANGLE_THRESHOLD:16/180*Math.PI},G$c=80;let N$h=class extends a$N{constructor(t){super(t),this.view=null,this.rotationValueSmooth=new t$M(.05),this.scalingValueSmooth=new t$M(.05),this.planeHorizontal=p$11(),this.planeVertical=p$11(),this.rotationMomentumEstimator=new a$14,this.panMomentumEstimator=new h$P(300,12,.9),this.zoomMomentumEstimator=new s$W,this.beginCenter=n$11(),this.tmpPoints=[],this.beginCenterScreen=i$U(),this.tmpCentroid3d=n$11(),this.tmpCentroid2d=i$U(),this.tmp2d=i$U(),this.constraintOptions={selection:15,interactionType:0,interactionFactor:0,interactionStartCamera:new J$g,interactionDirection:null,tiltMode:0};}get intersectionHelper(){return this.view.sceneIntersectionHelper}begin(t){if(!this.active)return;const e=this.view.navigation.momentumEnabled;this.zoomMomentumEstimator.enabled=e,this.rotationMomentumEstimator.enabled=e,this.panMomentumEstimator.enabled=e,this.beginRadius=t.radius,this.pointerCount=t.pointers.size,this.beginAngle=t.angle,this.rotationValueSmooth.reset(),this.scalingValueSmooth.reset(),d$X(t.center,this.beginCenterScreen),v$J(I$n,0,this.planeHorizontal);const o=n$11();this.intersectionHelper.intersectScreenFreePointFallback(this.beginCenterScreen,o);const s=n$11();v$N(s,this.startCamera.viewForward);const d=n$11();r$Z(d,I$n);const g=z$u(s,d),C=p$16(g<0?-g:g);if(this.panMode=C>=U$h.ANGLE_THRESHOLD?ot$2.Horizontal:ot$2.Vertical,z$t(this.planeHorizontal,o,this.planeHorizontal),this.startCamera.aboveGround||A$s(this.planeHorizontal,this.planeHorizontal),this.panMode===ot$2.Vertical){if(d$O(d,d,g),c$V(this.planeVertical,s,d),j$F(this.planeVertical,this.planeVertical),z$t(this.planeVertical,o,this.planeVertical),!r$1d()){const t=n$11(),i=n$11(),e=n$11();c$V(t,o,this.currentCamera.eye),j$F(t,t);const n=5*Math.max(Math.abs(this.view.camera.position.z),50),s=this.view._stage.renderView.getMinimalDepthForArea(this.beginCenterScreen[0],this.beginCenterScreen[1],this.view.state.camera,G$c),r=s?Math.min(s,n):n;r$Z(e,u$S(i,this.currentCamera.eye,d$O(i,t,r))),this.planeVertical[3]=-z$u(this.planeVertical,e);}this.computePlanePoints(t.pointers,this.planeVertical,this.startCamera,this.tmpPoints),tt$4(this.tmpPoints,this.beginCenter);}else this.computePlanePoints(t.pointers,this.planeHorizontal,this.startCamera,this.tmpPoints),tt$4(this.tmpPoints,this.beginCenter);this.constraintOptions.interactionStartCamera.copyFrom(this.startCamera);}update(t){if(!this.active)return;this.currentCamera.copyFrom(this.startCamera);const i=t.pointers.size>1,e=this.panMode===ot$2.Horizontal?this.planeHorizontal:this.planeVertical,o=this.beginCenter;if(i){const i=this.beginRadius/t.radius,e=.001875*Math.min(Math.max(t.radius,40),120);this.scalingValueSmooth.gain=e,this.scalingValueSmooth.update(i),Y$g(this.currentCamera,o,this.scalingValueSmooth.value,this.view.state.constraints.minimumPoiDistance),this.zoomMomentumEstimator.add(this.scalingValueSmooth.value,.001*t.timestamp),this.constraintOptions.interactionType=1,this.constraintOptions.interactionFactor=f$G(Math.abs(t.radius-this.beginRadius)),p$Q(this.view,this.currentCamera,this.constraintOptions);}if(this.computePlanePoints(t.pointers,e,this.currentCamera,this.tmpPoints),tt$4(this.tmpPoints,this.tmpCentroid3d),d$X(t.center,this.tmpCentroid2d),mt$1(this.currentCamera,o,this.tmpCentroid3d),this.panMomentumEstimator.add(this.tmpCentroid2d,this.tmpCentroid3d,.001*t.timestamp),this.constraintOptions.interactionType=4,this.constraintOptions.interactionFactor=f$G(this.beginCenterScreen,this.tmpCentroid2d),p$Q(this.view,this.currentCamera,this.constraintOptions),i){const i=this.planeHorizontal,e=o,n=this.rotationValueSmooth.value,s=n+O$p(t.angle-n),r=.00125*Math.min(Math.max(t.radius,40),120);this.rotationValueSmooth.gain=r,this.rotationValueSmooth.update(s);const a=this.rotationValueSmooth.value-this.beginAngle;this.rotationMomentumEstimator.add(a,.001*t.timestamp),Q$g(this.currentCamera,e,m$J(i,a)),this.constraintOptions.interactionType=2,this.constraintOptions.interactionFactor=f$G(Math.abs(t.radius*a)),p$Q(this.view,this.currentCamera,this.constraintOptions);}}end(t){t.pointers.size===this.pointerCount&&this.update(t),this.finishController();const i=this.zoomMomentumEstimator.evaluateMomentum();if(i)return new a$J({view:this.view,momentum:i,zoomCenter:this.beginCenter});const e=this.rotationMomentumEstimator.evaluateMomentum();if(e)return new n$R({view:this.view,momentum:e,center:this.beginCenter,axis:W$j(this.planeHorizontal)});const n=this.panMomentumEstimator.evaluateMomentum();return n?new c$F({view:this.view,momentum:n}):null}computePlanePoints(t,i,e,n){n.length=t.size;const o=this.tmp2d;let s=0;return t.forEach((t=>{o[0]=t.x,o[1]=t.y,void 0===n[s]&&(n[s]=n$11()),X$c(i,e,o,n[s]),s+=1;})),n}};e$Q([y$K({constructOnly:!0})],N$h.prototype,"view",void 0),N$h=e$Q([n$14("esri.views.3d.state.controllers.local.PinchAndPanController")],N$h);

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class i$t extends i$V{constructor(t,e,s){super(!0),this.view=t,this.pointerAction=e,this.lastEndTimestamp=0,this.lastTimestamp=0,this.registerIncoming("drag",s,(t=>this.handleDrag(t)));}handleDrag(t){if("mouse"===t.data.pointerType&&!r$1e(t.data,this.pointerAction))return;const e=t.timestamp-this.lastEndTimestamp,s=40,i=this.momentum&&this.momentum.active&&e<s;switch(t.data.action){case"start":case"update":if(i)break;this.controller&&this.controller.active?t.data.timestamp-this.lastTimestamp>2&&(this.controller.update(t.data),this.lastTimestamp=t.timestamp):this.startController(t);break;case"end":case"removed":this.endController(t,!0);break;case"added":this.endController(t,!1),this.startController(t);}t.stopPropagation();}endController(t,e){if(this.controller&&this.controller.active){this.lastEndTimestamp=t.timestamp;const s=this.controller.end(t.data);e&&s&&(this.momentum=s,this.view.state.switchCameraController(this.momentum));}this.controller=null;}startController(t){this.controller=this.createController(),this.view.state.switchCameraController(this.controller),this.controller.begin(t.data),this.lastTimestamp=t.timestamp;}createController(){return this.view.state.isGlobal?new Y$d({view:this.view}):new N$h({view:this.view})}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class e$F extends i$V{constructor(t,e){super(!0),this.view=t,this.registerIncoming("pointer-down",e,(()=>this.view.state.stopActiveCameraController()));}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class e$E extends i$V{constructor(t,e){super(!0),this.key=t,this.registerIncoming("key-down",e,(t=>this._handleKeyDown(t)));}_handleKeyDown(t){t.data.key===this.key&&(this.activate(),t.stopPropagation());}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class t$L extends e$E{constructor(e,t,i){super(t,i),this.view=e,this.key=t;}activate(){this.view.goTo({heading:0}).catch((()=>{}));}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class e$D extends e$E{constructor(t,e,i){super(e,i),this.view=t,this.key=e;}activate(){this.view.goTo({tilt:0}).catch((()=>{}));}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class a$I extends i$V{constructor(e,t=!1){super(!0),this.view=e,this.invert=t,this.registerIncoming("vertical-two-finger-drag",(e=>this.handleTwoFinger(e)));}handleTwoFinger(r){var a,o,i;const n=this.invert?-1:1,l=i$U(0,r.data.delta*n);switch(r.data.action){case"begin":null==(a=this.cameraController)||a.end(),this.cameraController=new b$t({view:this.view,pivot:0}),this.view.state.switchCameraController(this.cameraController),this.cameraController.begin(l);break;case"update":null==(o=this.cameraController)||o.update(l);break;case"end":null==(i=this.cameraController)||i.end(),this.cameraController=null;}}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class a$H extends i$V{constructor(e=20,a=40){super(!1),this._threshold=e,this._maxDelta=a,this.state="ready",this.emittedArtificalEnd2=!1,this._vertical=this.registerOutgoing("vertical-two-finger-drag"),this._artificalDrag=this.registerOutgoing("drag"),this.dragEventSeparator=new t$1d({start:(t,e)=>this.observeStart(t,e),update:(t,e,a)=>this.observeUpdate(t,e,a),end:(t,e)=>this.observeEnd(e)}),this.registerIncoming("drag",(t=>this.dragEventSeparator.handle(t)));}get failed(){return "failed"===this.state}observeStart(t,e){1===t&&this.emittedArtificalEnd2&&(this.emittedArtificalEnd2=!1,this._artificalDrag.emit({action:"start",button:e.data.button,buttons:e.data.buttons,pointerType:e.data.pointerType,timestamp:e.data.timestamp,pointers:e.data.pointers,pointer:e.data.pointer,angle:e.data.angle,radius:e.data.radius,center:e.data.center}),e.stopPropagation()),this.state=2===t?"ready":"failed";}observeUpdate(t,e,a){if("failed"!==this.state&&2===t)return "active"===this.state?(this._vertical.emit({delta:e.data.center.y-this._thresholdReachedCenter.y,action:"update"}),void e.stopPropagation()):void(this.checkMovementWithinLimits(e.data,a.data)?this.checkVerticalThresholdReached(e.data,a.data)&&(this.state="active",this.emittedArtificalEnd2=!0,this._thresholdReachedCenter=e.data.center,this._artificalDrag.emit({action:"end",button:e.data.button,buttons:e.data.buttons,pointerType:e.data.pointerType,timestamp:e.data.timestamp,pointers:e.data.pointers,pointer:e.data.pointer,angle:e.data.angle,radius:e.data.radius,center:e.data.center}),this._vertical.emit({delta:e.data.center.y-this._thresholdReachedCenter.y,action:"begin"}),e.stopPropagation()):this.state="failed")}observeEnd(t){"active"===this.state&&(this._vertical.emit({delta:t.data.center.y-this._thresholdReachedCenter.y,action:"end"}),this.state="ready",t.stopPropagation());}checkMovementWithinLimits(t,e){let a=-1/0,i=1/0,r=-1/0,s=1/0;e.pointers.forEach((t=>{a=Math.max(a,t.x),i=Math.min(i,t.x),r=Math.max(r,t.y),s=Math.min(s,t.y);}));let n=-1/0,h=1/0,d=-1/0,o=1/0;t.pointers.forEach((t=>{n=Math.max(n,t.x),h=Math.min(h,t.x),d=Math.max(d,t.y),o=Math.min(o,t.y);}));const c=a-i,l=r-s,p=n-h,m=d-o;return Math.abs(t.center.x-e.center.x)<this._threshold&&Math.abs(p-c)<=this._maxDelta&&Math.abs(m-l)<=this._maxDelta}checkVerticalThresholdReached(t,e){let a=Math.abs(t.center.y-e.center.y);return t.pointers.forEach(((t,i)=>{const r=e.pointers.get(i);a=Math.min(a,Math.abs(t.y-r.y));})),a>=this._threshold}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
let z$h=class extends p$14{constructor(){super(...arguments),this._handles=new u$T;}destroy(){this._handles&&(this._handles.removeAll(),this._handles=null),this.disconnect();}get primaryDragAction(){return this._get("primaryDragAction")}set primaryDragAction(e){"pan"!==e&&"rotate"!==e||e===this._get("primaryDragAction")||(this._set("primaryDragAction",e),this._updateMode());}get mode(){return this._get("mode")}set mode(e){"default"!==e&&"pro"!==e||e===this._get("mode")||(this._set("mode",e),this._updateMode());}disconnect(){this.view.viewEvents.disconnect(),this._inputManager&&(this._inputManager.destroy(),this._inputManager=null),this._source&&(this._source.destroy(),this._source=null);}connect(){const e=this.view;this._source=new u$W(this.view.surface,e.input);const t=[new n$1g,new o$$,new s$X,new s$Y(this.view.navigation),new a$H],r=new d$Y({eventSource:this._source,recognizers:t});this._inputManager=r,r.installHandlers("prevent-context-menu",[new e$_],u$X.INTERNAL),this._modeDragPan=new i$t(e,"primary"),this._modeDragRotate=new a$M(e,"secondary",0),this._modeDragZoom=new s$D(e,"tertiary");const n={lookAround:"b",pan:{left:"ArrowLeft",right:"ArrowRight",forward:"ArrowUp",backward:"ArrowDown",up:"u",down:"j",headingLeft:"a",headingRight:"d",tiltUp:"w",tiltDown:"s",zoomIn:"+",zoomOut:"-"},resetHeading:"n",resetTilt:"p"};r.installHandlers("navigation",[new e$F(e),new s$E(e),new i$w(e),new r$K(e,n.pan),new i$v(e),new e$D(e,n.resetTilt),new t$L(e,n.resetHeading),new a$M(e,"primary",1,[n.lookAround]),new a$M(e,"secondary",0,[n.lookAround]),new i$t(e,"tertiary",[n.lookAround]),this._modeDragRotate,this._modeDragZoom,this._modeDragPan,new a$I(e)],u$X.INTERNAL),this.view.viewEvents.connect(r),this._updateMode(),d$S(this.view.navigation,"browserTouchPanEnabled",(e=>{this._source.browserTouchPanningEnabled=!e;}));}_updateMode(){const e=this.mode,t=this.primaryDragAction,r=R$l.get(e).get(t);this._modeDragPan&&(this._modeDragPan.pointerAction=r.pan),this._modeDragRotate&&(this._modeDragRotate.pointerAction=r.rotate),this._modeDragZoom&&(this._modeDragZoom.pointerAction=r.zoom);}get test(){return {inputManager:this._inputManager,modeDragPan:this._modeDragPan,modeDragRotate:this._modeDragRotate,modeDragZoom:this._modeDragZoom}}};e$Q([y$K()],z$h.prototype,"view",void 0),e$Q([y$K({value:"pan"})],z$h.prototype,"primaryDragAction",null),e$Q([y$K({value:"default"})],z$h.prototype,"mode",null),e$Q([y$K({readOnly:!0,aliasOf:"_inputManager.hasPendingInputs"})],z$h.prototype,"hasPendingInputs",void 0),e$Q([y$K({readOnly:!0,aliasOf:"_inputManager.latestPointerType"})],z$h.prototype,"latestPointerType",void 0),e$Q([y$K()],z$h.prototype,"_inputManager",void 0),z$h=e$Q([n$14("esri.views.3d.input.SceneInputManager")],z$h);const R$l=new Map,T$l=new Map,b$q=new Map;T$l.set("pan",{pan:"primary",rotate:"secondary",zoom:"tertiary"}),T$l.set("rotate",{pan:"secondary",rotate:"primary",zoom:"tertiary"}),b$q.set("pan",{pan:"primary",rotate:"tertiary",zoom:"secondary"}),b$q.set("rotate",{pan:"tertiary",rotate:"primary",zoom:"secondary"}),R$l.set("default",T$l),R$l.set("pro",b$q);var k$j=z$h;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
let S$s=class extends p$14{constructor(){super(...arguments),this.SCENEVIEW_HITTEST_RETURN_INTERSECTOR=!1,this.SCENEVIEW_LOCKING_LOG=!1,this.HIGHLIGHTS_GRID_OPTIMIZATION_ENABLED=!0,this.HIGHLIGHTS_PROFILE_TO_CONSOLE=!1,this.DECONFLICTOR_SHOW_VISIBLE=!1,this.DECONFLICTOR_SHOW_INVISIBLE=!1,this.DECONFLICTOR_SHOW_GRID=!1,this.LABELS_SHOW_BORDER=!1,this.OVERLAY_DRAW_DEBUG_TEXTURE=!1,this.OVERLAY_SHOW_CENTER=!1,this.SHOW_POI=!1,this.TESTS_DISABLE_UPDATE_THRESHOLDS=!1,this.DISABLE_DECONFLICTOR_VISIBILITY_OFFSET=!1,this.DISABLE_ELEVATION_ALIGNERS_ITERATIVE_UPDATES=!1,this.DRAW_MESH_GEOMETRY_NORMALS=!1,this.FEATURE_TILE_FETCH_SHOW_TILES=!1,this.FEATURE_TILE_TREE_SHOW_TILES=!1,this.TERRAIN_TILE_TREE_SHOW_TILES=!1,this.I3S_TREE_SHOW_TILES=!1,this.I3S_SHOW_MODIFICATIONS=!1,this.ENABLE_PROFILE_DEPTH_RANGE=!1,this.DISABLE_FAST_UPDATES=!1,this.LOD_INSTANCE_RENDERER_DISABLE_UPDATES=!1,this.LOD_INSTANCE_RENDERER_COLORIZE_BY_LEVEL=!1,this.EDGES_SHOW_HIDDEN_TRANSPARENT_EDGES=!1;}};e$Q([y$K()],S$s.prototype,"SCENEVIEW_HITTEST_RETURN_INTERSECTOR",void 0),e$Q([y$K()],S$s.prototype,"SCENEVIEW_LOCKING_LOG",void 0),e$Q([y$K()],S$s.prototype,"HIGHLIGHTS_GRID_OPTIMIZATION_ENABLED",void 0),e$Q([y$K()],S$s.prototype,"HIGHLIGHTS_PROFILE_TO_CONSOLE",void 0),e$Q([y$K()],S$s.prototype,"DECONFLICTOR_SHOW_VISIBLE",void 0),e$Q([y$K()],S$s.prototype,"DECONFLICTOR_SHOW_INVISIBLE",void 0),e$Q([y$K()],S$s.prototype,"DECONFLICTOR_SHOW_GRID",void 0),e$Q([y$K()],S$s.prototype,"LABELS_SHOW_BORDER",void 0),e$Q([y$K()],S$s.prototype,"OVERLAY_DRAW_DEBUG_TEXTURE",void 0),e$Q([y$K()],S$s.prototype,"OVERLAY_SHOW_CENTER",void 0),e$Q([y$K()],S$s.prototype,"SHOW_POI",void 0),e$Q([y$K()],S$s.prototype,"TESTS_DISABLE_UPDATE_THRESHOLDS",void 0),e$Q([y$K()],S$s.prototype,"DISABLE_DECONFLICTOR_VISIBILITY_OFFSET",void 0),e$Q([y$K()],S$s.prototype,"DISABLE_ELEVATION_ALIGNERS_ITERATIVE_UPDATES",void 0),e$Q([y$K()],S$s.prototype,"DRAW_MESH_GEOMETRY_NORMALS",void 0),e$Q([y$K()],S$s.prototype,"FEATURE_TILE_FETCH_SHOW_TILES",void 0),e$Q([y$K()],S$s.prototype,"FEATURE_TILE_TREE_SHOW_TILES",void 0),e$Q([y$K()],S$s.prototype,"TERRAIN_TILE_TREE_SHOW_TILES",void 0),e$Q([y$K()],S$s.prototype,"I3S_TREE_SHOW_TILES",void 0),e$Q([y$K()],S$s.prototype,"I3S_SHOW_MODIFICATIONS",void 0),e$Q([y$K()],S$s.prototype,"ENABLE_PROFILE_DEPTH_RANGE",void 0),e$Q([y$K()],S$s.prototype,"DISABLE_FAST_UPDATES",void 0),e$Q([y$K()],S$s.prototype,"LOD_INSTANCE_RENDERER_DISABLE_UPDATES",void 0),e$Q([y$K()],S$s.prototype,"LOD_INSTANCE_RENDERER_COLORIZE_BY_LEVEL",void 0),e$Q([y$K()],S$s.prototype,"EDGES_SHOW_HIDDEN_TRANSPARENT_EDGES",void 0),S$s=e$Q([n$14("esri.views.3d.support.DebugFlags")],S$s);const T$k=new S$s;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
let e$C,i$s,n$Q=!1,l$F=!1,o$F=!1,s$C=!1,a$G=null;function c$D(t,e){if(!l$F||!i$s)return;u$E();const n=i$s;let o=0;for(let i=0;i<t.accBinsNumX;i++)for(let e=0;e<t.accBinsNumY;e++){const l=t.accBins[i][t.accBinsNumY-1-e];o+=l.length;const s=i*t.accBinsSizeX,a=(i+1)*t.accBinsSizeX,c=e*t.accBinsSizeY,r=(e+1)*t.accBinsSizeY;n.fillText(l.length.toFixed(),s+5,c+15),p$J(s,a,c,r,"blue");}n.fillText("total totalShownLabels: "+o,70,40),n.fillText("total visible labels: "+e.size,70,50),n.fillText("total numTests: "+t.accNumTests,70,30);}function r$J(i){o$F=T$k.DECONFLICTOR_SHOW_VISIBLE,s$C=T$k.DECONFLICTOR_SHOW_INVISIBLE,n$Q=o$F||s$C,l$F=T$k.DECONFLICTOR_SHOW_GRID,a$G=null,n$Q||l$F?a$G=()=>h$x(i):e$C&&(e$C.parentElement.removeChild(e$C),e$C=null);}function u$E(){a$G&&(a$G(),a$G=null);}function h$x(t){null==e$C&&(e$C=document.createElement("canvas"),e$C.setAttribute("id","canvas2d"),t.surface.parentElement.style.position="relative",t.surface.parentElement.appendChild(e$C));const n=t.width*t.pixelRatio,l=t.height*t.pixelRatio;e$C.setAttribute("width",`${n}px`),e$C.setAttribute("height",`${l}px`),e$C.setAttribute("style",`position:absolute;left:0px;top:0px;display:block;pointer-events:none;width:${t.width}px;height:${t.height}px`),i$s=e$C.getContext("2d"),i$s.clearRect(0,0,t.width,t.height),i$s.font="12px Arial";}function p$J(t,n,l,o,s){u$E();const a=e$C.height,c=i$s;c.beginPath(),c.lineWidth=1,c.strokeStyle=s,c.moveTo(t,a-l),c.lineTo(n,a-l),c.stroke(),c.lineTo(n,a-o),c.stroke(),c.lineTo(n,a-l),c.stroke(),c.lineTo(t,a-l),c.stroke(),c.lineTo(t,a-l),c.stroke(),c.closePath();}function f$C(t,e){n$Q&&(e&&o$F||!e&&s$C)&&p$J(t.aabr[0],t.aabr[2],t.aabr[1],t.aabr[3],e?"green":"red");}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
function n$P(n){return n instanceof Float32Array&&n.length>=16}function r$I(n){return Array.isArray(n)&&n.length>=16}function t$K(t){return n$P(t)||r$I(t)}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
function o$E(o,a){const i=o;i.include(r$1f),i.attributes.add("position","vec3"),i.attributes.add("normal","vec3"),i.attributes.add("auxpos1","vec4"),i.vertex.uniforms.add("proj","mat4"),i.vertex.uniforms.add("view","mat4"),i.vertex.uniforms.add("viewNormal","mat4"),i.vertex.uniforms.add("viewport","vec4"),i.vertex.uniforms.add("camPos","vec3"),i.vertex.uniforms.add("polygonOffset","float"),i.vertex.uniforms.add("cameraGroundRelative","float"),i.vertex.uniforms.add("pixelRatio","float"),i.vertex.uniforms.add("perDistancePixelRatio","float"),i.vertex.uniforms.add("uRenderTransparentlyOccludedHUD","float"),a.verticalOffsetEnabled&&i.vertex.uniforms.add("verticalOffset","vec4"),a.screenSizePerspectiveEnabled&&i.vertex.uniforms.add("screenSizePerspectiveAlignment","vec4"),i.vertex.uniforms.add("hudVisibilityTexture","sampler2D"),i.vertex.constants.add("smallOffsetAngle","float",.984807753012208),i.vertex.code.add(t$10`struct ProjectHUDAux {
vec3 posModel;
vec3 posView;
vec3 vnormal;
float distanceToCamera;
float absCosAngle;
};`),i.vertex.code.add(t$10`float applyHUDViewDependentPolygonOffset(float pointGroundDistance, float absCosAngle, inout vec3 posView) {
float pointGroundSign = sign(pointGroundDistance);
if (pointGroundSign == 0.0) {
pointGroundSign = cameraGroundRelative;
}
float groundRelative = cameraGroundRelative * pointGroundSign;
if (polygonOffset > .0) {
float cosAlpha = clamp(absCosAngle, 0.01, 1.0);
float tanAlpha = sqrt(1.0 - cosAlpha * cosAlpha) / cosAlpha;
float factor = (1.0 - tanAlpha / viewport[2]);
if (groundRelative > 0.0) {
posView *= factor;
}
else {
posView /= factor;
}
}
return groundRelative;
}`),a.isDraped||i.vertex.code.add(t$10`void applyHUDVerticalGroundOffset(vec3 normalModel, inout vec3 posModel, inout vec3 posView) {
float distanceToCamera = length(posView);
float pixelOffset = distanceToCamera * perDistancePixelRatio * 0.5;
vec3 modelOffset = normalModel * cameraGroundRelative * pixelOffset;
vec3 viewOffset = (viewNormal * vec4(modelOffset, 1.0)).xyz;
posModel += modelOffset;
posView += viewOffset;
}`),i.vertex.code.add(t$10`
    vec4 projectPositionHUD(out ProjectHUDAux aux) {
      // centerOffset is in view space and is used to implement world size offsetting
      // of labels with respect to objects. It also pulls the label towards the viewer
      // so that the label is visible in front of the object.
      vec3 centerOffset = auxpos1.xyz;

      // The pointGroundDistance is the distance of the geometry to the ground and is
      // negative if the point is below the ground, or positive if the point is above
      // ground.
      float pointGroundDistance = auxpos1.w;

      aux.posModel = position;
      aux.posView = (view * vec4(aux.posModel, 1.0)).xyz;
      aux.vnormal = normal;
      ${a.isDraped?"":"applyHUDVerticalGroundOffset(aux.vnormal, aux.posModel, aux.posView);"}

      // Screen sized offset in world space, used for example for line callouts
      // Note: keep this implementation in sync with the CPU implementation, see
      //   - MaterialUtil.verticalOffsetAtDistance
      //   - HUDMaterial.applyVerticalOffsetTransformation

      aux.distanceToCamera = length(aux.posView);

      vec3 viewDirObjSpace = normalize(camPos - aux.posModel);
      float cosAngle = dot(aux.vnormal, viewDirObjSpace);

      aux.absCosAngle = abs(cosAngle);

      ${a.screenSizePerspectiveEnabled&&(a.verticalOffsetEnabled||1===a.screenCenterOffsetUnitsEnabled)?"vec4 perspectiveFactor = screenSizePerspectiveScaleFactor(aux.absCosAngle, aux.distanceToCamera, screenSizePerspectiveAlignment);":""}

      ${a.verticalOffsetEnabled?a.screenSizePerspectiveEnabled?"float verticalOffsetScreenHeight = applyScreenSizePerspectiveScaleFactorFloat(verticalOffset.x, perspectiveFactor);":"float verticalOffsetScreenHeight = verticalOffset.x;":""}

      ${a.verticalOffsetEnabled?t$10`
            float worldOffset = clamp(verticalOffsetScreenHeight * verticalOffset.y * aux.distanceToCamera, verticalOffset.z, verticalOffset.w);
            vec3 modelOffset = aux.vnormal * worldOffset;
            aux.posModel += modelOffset;
            vec3 viewOffset = (viewNormal * vec4(modelOffset, 1.0)).xyz;
            aux.posView += viewOffset;
            // Since we elevate the object, we need to take that into account
            // in the distance to ground
            pointGroundDistance += worldOffset;`:""}

      float groundRelative = applyHUDViewDependentPolygonOffset(pointGroundDistance, aux.absCosAngle, aux.posView);

      ${1!==a.screenCenterOffsetUnitsEnabled?t$10`
            // Apply x/y in view space, but z in screen space (i.e. along posView direction)
            aux.posView += vec3(centerOffset.x, centerOffset.y, 0.0);

            // Same material all have same z != 0.0 condition so should not lead to
            // branch fragmentation and will save a normalization if it's not needed
            if (centerOffset.z != 0.0) {
              aux.posView -= normalize(aux.posView) * centerOffset.z;
            }
          `:""}

      vec4 posProj = proj * vec4(aux.posView, 1.0);

      ${1===a.screenCenterOffsetUnitsEnabled?a.screenSizePerspectiveEnabled?"float centerOffsetY = applyScreenSizePerspectiveScaleFactorFloat(centerOffset.y, perspectiveFactor);":"float centerOffsetY = centerOffset.y;":""}

      ${1===a.screenCenterOffsetUnitsEnabled?"posProj.xy += vec2(centerOffset.x, centerOffsetY) * pixelRatio * 2.0 / viewport.zw * posProj.w;":""}

      // constant part of polygon offset emulation
      posProj.z -= groundRelative * polygonOffset * posProj.w;
      return posProj;
    }
  `),i.vertex.code.add(t$10`bool testVisibilityHUD(vec4 posProj) {
vec4 posProjCenter = alignToPixelCenter(posProj, viewport.zw);
vec4 occlusionPixel = texture2D(hudVisibilityTexture, .5 + .5 * posProjCenter.xy / posProjCenter.w);
if (uRenderTransparentlyOccludedHUD > 0.5) {
return occlusionPixel.r * occlusionPixel.g > 0.0 && occlusionPixel.g * uRenderTransparentlyOccludedHUD < 1.0;
}
return occlusionPixel.r * occlusionPixel.g > 0.0 && occlusionPixel.g == 1.0;
}`);}function a$F(e,t){e.setUniform1f("uRenderTransparentlyOccludedHUD",0===t.renderTransparentlyOccludedHUD?1:1===t.renderTransparentlyOccludedHUD?0:.75);}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
function r$H(r){r.include(a$15),r.uniforms.add("geometryDepthTexture","sampler2D"),r.uniforms.add("cameraNearFar","vec2"),r.code.add(t$10`bool geometryDepthTest(vec2 pos, float elementDepth) {
float geometryDepth = linearDepthFromTexture(geometryDepthTexture, pos, cameraNearFar);
return (elementDepth < (geometryDepth - 1.0));
}`);}function o$D(e,t){t.multipassGeometryEnabled&&t.geometryLinearDepthTexture&&e.bindTexture(t.geometryLinearDepthTexture,"geometryDepthTexture");}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
function a$E(a,i){i.multipassGeometryEnabled&&a.vertex.include(r$H),i.multipassTerrainEnabled&&a.varyings.add("depth","float"),a.vertex.code.add(t$10`
  void main(void) {
    vec4 posProjCenter;
    if (dot(position, position) > 0.0) {
      // Render single point to center of the pixel to avoid subpixel
      // filtering to affect the marker color
      ProjectHUDAux projectAux;
      vec4 posProj = projectPositionHUD(projectAux);
      posProjCenter = alignToPixelCenter(posProj, viewport.zw);

      ${i.multipassGeometryEnabled?t$10`
        // Don't draw vertices behind geometry
        if(geometryDepthTest(.5 + .5 * posProjCenter.xy / posProjCenter.w, projectAux.posView.z)){
          posProjCenter = vec4(1e038, 1e038, 1e038, 1.0);
        }`:""}

      ${i.multipassTerrainEnabled?"depth = projectAux.posView.z;":""}
      vec3 vpos = projectAux.posModel;
      if (rejectBySlice(vpos)) {
        // Project out of clip space
        posProjCenter = vec4(1e038, 1e038, 1e038, 1.0);
      }

    } else {
      // Project out of clip space
      posProjCenter = vec4(1e038, 1e038, 1e038, 1.0);
    }

    gl_Position = posProjCenter;
    gl_PointSize = 1.0;
  }
  `),i.multipassTerrainEnabled&&a.fragment.include(a$15),a.fragment.uniforms.add("terrainDepthTexture","sampler2D"),a.fragment.uniforms.add("cameraNearFar","vec2"),a.fragment.uniforms.add("inverseViewport","vec2"),a.fragment.include(a$16),a.fragment.code.add(t$10`
  void main() {
    gl_FragColor = vec4(1, 1, 1, 1);
    ${i.multipassTerrainEnabled?t$10`

          vec2 uv = gl_FragCoord.xy * inverseViewport;

          //Read the rgba data from the texture linear depth
          vec4 terrainDepthData = texture2D(terrainDepthTexture, uv);

          float terrainDepth = linearDepthFromFloat(rgba2float(terrainDepthData), cameraNearFar);

          //If HUD vertex is behind terrain and the terrain depth is not the initialize value (e.g. we are not looking at the sky)
          //Mark the HUD vertex as occluded by transparent terrain
          if(depth < terrainDepth && terrainDepthData != vec4(0,0,0,1)){
            gl_FragColor.g = 0.5;
          }`:""}
  }
  `);}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
function m$E(e){const o=new n$15,i=e.signedDistanceFieldEnabled;if(o.include(c$M),o.include(o$E,e),o.include(c$$,e),6===e.output)return o.include(a$E,e),o;o.include(r$1f),o.fragment.include(a$16),o.fragment.include(e$U),o.include(e$$,e),o.varyings.add("vcolor","vec4"),o.varyings.add("vtc","vec2"),o.varyings.add("vsize","vec2"),e.binaryHighlightOcclusionEnabled&&o.varyings.add("voccluded","float"),o.vertex.uniforms.add("screenOffset","vec2").add("anchorPos","vec2").add("textureCoordinateScaleFactor","vec2").add("materialColor","vec4"),i&&o.vertex.uniforms.add("outlineColor","vec4"),e.screenSizePerspectiveEnabled&&o.vertex.uniforms.add("screenSizePerspective","vec4"),(e.debugDrawBorder||e.binaryHighlightOcclusionEnabled)&&o.varyings.add("debugBorderCoords","vec4"),o.attributes.add("uv0","vec2"),o.attributes.add("color","vec4"),o.attributes.add("size","vec2"),o.attributes.add("auxpos2","vec4"),o.vertex.code.add(t$10`
    void main(void) {
      ProjectHUDAux projectAux;
      vec4 posProj = projectPositionHUD(projectAux);

      if (rejectBySlice(projectAux.posModel)) {
        // Project outside of clip plane
        gl_Position = vec4(1e038, 1e038, 1e038, 1.0);
        return;
      }
      vec2 inputSize;
      ${e.screenSizePerspectiveEnabled?t$10`
      inputSize = screenSizePerspectiveScaleVec2(size, projectAux.absCosAngle, projectAux.distanceToCamera, screenSizePerspective);
      vec2 screenOffsetScaled = screenSizePerspectiveScaleVec2(screenOffset, projectAux.absCosAngle, projectAux.distanceToCamera, screenSizePerspectiveAlignment);
         `:t$10`
      inputSize = size;
      vec2 screenOffsetScaled = screenOffset;`}

      ${e.vvSize?"inputSize *= vvScale(auxpos2).xx;":""}

      vec2 combinedSize = inputSize * pixelRatio;
      vec4 quadOffset = vec4(0.0);

      ${e.occlusionTestEnabled||e.binaryHighlightOcclusionEnabled?"bool visible = testVisibilityHUD(posProj);":""}

      ${e.binaryHighlightOcclusionEnabled?"voccluded = visible ? 0.0 : 1.0;":""}
    `);const m=t$10`vec2 uv01 = floor(uv0);
vec2 uv = uv0 - uv01;
quadOffset.xy = ((uv01 - anchorPos) * 2.0 * combinedSize + screenOffsetScaled) / viewport.zw * posProj.w;`,b=e.pixelSnappingEnabled?i?t$10`posProj = alignToPixelOrigin(posProj, viewport.zw) + quadOffset;`:t$10`posProj += quadOffset;
if (inputSize.x == size.x) {
posProj = alignToPixelOrigin(posProj, viewport.zw);
}`:t$10`posProj += quadOffset;`;o.vertex.code.add(t$10`
      ${e.occlusionTestEnabled?"if (visible) {":""}
      ${m}
      ${e.vvColor?"vcolor = vvGetColor(auxpos2, vvColorValues, vvColorColors) * materialColor;":"vcolor = color / 255.0 * materialColor;"}

      bool alphaDiscard = vcolor.a < ${t$10.float(o$10)};
      ${i?`alphaDiscard = alphaDiscard && outlineColor.a < ${t$10.float(o$10)};`:""}
      if (alphaDiscard) {
        // "early discard" if both symbol color (= fill) and outline color (if applicable) are transparent
        gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
        return;
      } else {
        ${b}
        gl_Position = posProj;
      }

      vtc = uv * textureCoordinateScaleFactor;

      ${e.debugDrawBorder?"debugBorderCoords = vec4(uv01, 1.5 / combinedSize);":""}
      vsize = inputSize;
      ${e.occlusionTestEnabled?t$10`} else { vtc = vec2(0.0);
        ${e.debugDrawBorder?"debugBorderCoords = vec4(0.5, 0.5, 1.5 / combinedSize);}":"}"}`:""}
    }
    `),o.fragment.uniforms.add("tex","sampler2D"),i&&(o.fragment.uniforms.add("outlineColor","vec4"),o.fragment.uniforms.add("outlineSize","float"));const x=e.debugDrawBorder?t$10`(isBorder > 0.0 ? 0.0 : ${t$10.float(d$Z)})`:t$10.float(d$Z),h=t$10`
    ${e.debugDrawBorder?t$10`
      float isBorder = float(any(lessThan(debugBorderCoords.xy, debugBorderCoords.zw)) || any(greaterThan(debugBorderCoords.xy, 1.0 - debugBorderCoords.zw)));`:""}

    ${i?t$10`
      vec4 fillPixelColor = vcolor;

      // Attempt to sample texel centers to avoid that thin cross outlines
      // disappear with large symbol sizes.
      // see: https://devtopia.esri.com/WebGIS/arcgis-js-api/issues/7058#issuecomment-603041
      const float txSize = 128.0;
      const float texelSize = 1.0 / txSize;
      // Calculate how much we have to add/subtract to/from each texel to reach the size of an onscreen pixel
      vec2 scaleFactor = (vsize - txSize) * texelSize;
      vec2 samplePos = vtc + (vec2(1.0, -1.0) * texelSize) * scaleFactor;

      // Get distance and map it into [-0.5, 0.5]
      float d = rgba2float(texture2D(tex, samplePos)) - 0.5;

      // Distance in output units (i.e. pixels)
      float dist = d * vsize.x;

      // Create smooth transition from the icon into its outline
      float fillAlphaFactor = clamp(0.5 - dist, 0.0, 1.0);
      fillPixelColor.a *= fillAlphaFactor;

      if (outlineSize > 0.25) {
        vec4 outlinePixelColor = outlineColor;
        float clampedOutlineSize = min(outlineSize, 0.5*vsize.x);

        // Create smooth transition around outline
        float outlineAlphaFactor = clamp(0.5 - (abs(dist) - 0.5*clampedOutlineSize), 0.0, 1.0);
        outlinePixelColor.a *= outlineAlphaFactor;

        if (
          outlineAlphaFactor + fillAlphaFactor < ${x} ||
          fillPixelColor.a + outlinePixelColor.a < ${t$10.float(o$10)}
        ) {
          discard;
        }

        // perform un-premultiplied over operator (see https://en.wikipedia.org/wiki/Alpha_compositing#Description)
        float compositeAlpha = outlinePixelColor.a + fillPixelColor.a * (1.0 - outlinePixelColor.a);
        vec3 compositeColor = vec3(outlinePixelColor) * outlinePixelColor.a +
          vec3(fillPixelColor) * fillPixelColor.a * (1.0 - outlinePixelColor.a);

        gl_FragColor = vec4(compositeColor, compositeAlpha);
      } else {
        if (fillAlphaFactor < ${x}) {
          discard;
        }

        gl_FragColor = premultiplyAlpha(fillPixelColor);
      }

      // visualize SDF:
      // gl_FragColor = vec4(clamp(-dist/vsize.x*2.0, 0.0, 1.0), clamp(dist/vsize.x*2.0, 0.0, 1.0), 0.0, 1.0);
      `:t$10`
          vec4 texColor = texture2D(tex, vtc, -0.5);
          if (texColor.a < ${x}) {
            discard;
          }
          gl_FragColor = texColor * premultiplyAlpha(vcolor);
          `}

    ${e.debugDrawBorder?t$10`gl_FragColor = mix(gl_FragColor, vec4(1.0, 0.0, 1.0, 1.0), isBorder);`:""}
  `;return 7===e.output&&o.fragment.code.add(t$10`
      void main() {
        ${h}
        gl_FragColor = vec4(gl_FragColor.a);
      }
      `),0===e.output&&o.fragment.code.add(t$10`
    void main() {
      ${h}
      ${e.FrontFacePass?"gl_FragColor.rgb /= gl_FragColor.a;":""}
    }
    `),4===e.output&&(o.include(r$1g),o.fragment.code.add(t$10`
    void main() {
      ${h}
      ${e.binaryHighlightOcclusionEnabled?t$10`
          if (voccluded == 1.0) {
            gl_FragColor = vec4(1.0, 1.0, 0.0, 1.0);
          } else {
            gl_FragColor = vec4(1.0, 0.0, 1.0, 1.0);
          }`:"outputHighlight();"}
    }
    `)),o}function b$p(e,o,r){e.setUniform4fv("materialColor",o.color),o.textureIsSignedDistanceField&&(o.outlineColor[3]<=0||o.outlineSize<=0?(e.setUniform4fv("outlineColor",_$q),e.setUniform1f("outlineSize",0)):(e.setUniform4fv("outlineColor",o.outlineColor),e.setUniform1f("outlineSize",o.outlineSize))),e.setUniform2f("screenOffset",2*o.screenOffset[0]*r,2*o.screenOffset[1]*r),e.setUniform2fv("anchorPos",x$x(o));}function x$x(o,i=C$h){return o.textureIsSignedDistanceField?h$w(o.anchorPos,o.distanceFieldBoundingBox,i):a$13(i,o.anchorPos),i}function h$w(e,o,i){i[0]=e[0]*(o[2]-o[0])+o[0],i[1]=e[1]*(o[3]-o[1])+o[1];}const C$h=n$19();var z$g=Object.freeze({__proto__:null,build:m$E,bindHUDMaterialUniforms:b$p,calculateAnchorPosForRendering:x$x});

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class j$r extends t$11{initializeProgram(e){const r=j$r.shader.get(),t=this.configuration,i=r.build({output:t.output,FrontFacePass:2===t.transparencyPassType,viewingMode:e.viewingMode,occlusionTestEnabled:t.occlusionTestEnabled,signedDistanceFieldEnabled:t.sdf,slicePlaneEnabled:t.slicePlaneEnabled,sliceHighlightDisabled:!1,sliceEnabledForVertexPrograms:!0,debugDrawBorder:t.debugDrawBorder,binaryHighlightOcclusionEnabled:t.binaryHighlightOcclusion,screenCenterOffsetUnitsEnabled:t.screenCenterOffsetUnitsEnabled,screenSizePerspectiveEnabled:t.screenSizePerspective,verticalOffsetEnabled:t.verticalOffset,pixelSnappingEnabled:t.pixelSnappingEnabled,vvSize:t.vvSize,vvColor:t.vvColor,vvInstancingEnabled:!1,isDraped:t.isDraped,multipassGeometryEnabled:t.multipassGeometryEnabled,multipassTerrainEnabled:t.multipassTerrainEnabled,cullAboveGround:t.cullAboveGround});return new n$16(e.rctx,i,o$X)}bindPass(e,r){t$15(this.program,r.camera.projectionMatrix),this.program.setUniform1f("cameraGroundRelative",r.camera.aboveGround?1:-1),this.program.setUniform1f("perDistancePixelRatio",Math.tan(r.camera.fovY/2)/(r.camera.fullViewport[2]/2)),this.program.setUniformMatrix4fv("viewNormal",r.camera.viewInverseTransposeMatrix),this.program.setUniform1f("polygonOffset",e.shaderPolygonOffset),l$Z(this.program,e,r),c$10(this.program,e),this.program.setUniform1f("pixelRatio",r.camera.pixelRatio||1),m$Z(this.program,r),6===this.configuration.output?(this.program.setUniform2fv("cameraNearFar",r.camera.nearFar),this.program.setUniform2fv("inverseViewport",r.inverseViewport),o$D(this.program,r),t$1f(this.program,r)):(a$F(this.program,r),b$p(this.program,e,r.camera.pixelRatio||1),o$11(this.program,e),this.configuration.occlusionTestEnabled&&this.program.bindTexture(r.hudVisibilityTexture,"hudVisibilityTexture")),4===this.configuration.output&&g$V(this.program,r);}bindDraw(e){a$17(this.program,e),o$12(this.program,e.origin,e.camera.viewInverseTransposeMatrix),l$_(this.program,this.configuration,e),this.program.rebindTextures();}setPipelineState(e){const r=this.configuration,t=3===e,i=2===e,o=515,s=this.configuration.polygonOffsetEnabled&&w$p,a=(t||i)&&4!==r.output?(r.depthEnabled||6===r.output)&&l$$:null;return g$S({blending:0===r.output||7===r.output||4===r.output?t?D$h:c$11(e):null,depthTest:{func:o},depthWrite:a,colorWrite:r$13,polygonOffset:s})}initializePipeline(){return this.setPipelineState(this.configuration.transparencyPassType)}get primitiveType(){return 6===this.configuration.output?0:4}}j$r.shader=new t$12(z$g,(()=>import('./HUDMaterial.glsl-753ccfcc.js')));const w$p={factor:0,units:-4},D$h=t$1e(1,771);class U$g extends e$S{constructor(){super(...arguments),this.output=0,this.occlusionTestEnabled=!0,this.sdf=!1,this.vvSize=!1,this.vvColor=!1,this.verticalOffset=!1,this.screenSizePerspective=!1,this.screenCenterOffsetUnitsEnabled=0,this.debugDrawBorder=!0,this.binaryHighlightOcclusion=!0,this.slicePlaneEnabled=!1,this.polygonOffsetEnabled=!1,this.depthEnabled=!0,this.transparencyPassType=3,this.pixelSnappingEnabled=!0,this.isDraped=!1,this.multipassGeometryEnabled=!1,this.multipassTerrainEnabled=!1,this.cullAboveGround=!1;}}e$Q([r$12({count:8})],U$g.prototype,"output",void 0),e$Q([r$12()],U$g.prototype,"occlusionTestEnabled",void 0),e$Q([r$12()],U$g.prototype,"sdf",void 0),e$Q([r$12()],U$g.prototype,"vvSize",void 0),e$Q([r$12()],U$g.prototype,"vvColor",void 0),e$Q([r$12()],U$g.prototype,"verticalOffset",void 0),e$Q([r$12()],U$g.prototype,"screenSizePerspective",void 0),e$Q([r$12({count:2})],U$g.prototype,"screenCenterOffsetUnitsEnabled",void 0),e$Q([r$12()],U$g.prototype,"debugDrawBorder",void 0),e$Q([r$12()],U$g.prototype,"binaryHighlightOcclusion",void 0),e$Q([r$12()],U$g.prototype,"slicePlaneEnabled",void 0),e$Q([r$12()],U$g.prototype,"polygonOffsetEnabled",void 0),e$Q([r$12()],U$g.prototype,"depthEnabled",void 0),e$Q([r$12({count:4})],U$g.prototype,"transparencyPassType",void 0),e$Q([r$12()],U$g.prototype,"pixelSnappingEnabled",void 0),e$Q([r$12()],U$g.prototype,"isDraped",void 0),e$Q([r$12()],U$g.prototype,"multipassGeometryEnabled",void 0),e$Q([r$12()],U$g.prototype,"multipassTerrainEnabled",void 0),e$Q([r$12()],U$g.prototype,"cullAboveGround",void 0);

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class W$d extends a$18{constructor(e){super(e,me$4),this.techniqueConfig=new U$g;}getTechniqueConfig(e,t){return this.techniqueConfig.output=e,this.techniqueConfig.slicePlaneEnabled=this.params.slicePlaneEnabled,this.techniqueConfig.verticalOffset=!!this.params.verticalOffset,this.techniqueConfig.screenSizePerspective=!!this.params.screenSizePerspective,this.techniqueConfig.screenCenterOffsetUnitsEnabled="screen"===this.params.centerOffsetUnits?1:0,this.techniqueConfig.polygonOffsetEnabled=this.params.polygonOffset,this.techniqueConfig.isDraped=this.params.isDraped,this.techniqueConfig.occlusionTestEnabled=this.params.occlusionTest,this.techniqueConfig.pixelSnappingEnabled=this.params.pixelSnappingEnabled,this.techniqueConfig.sdf=this.params.textureIsSignedDistanceField,this.techniqueConfig.vvSize=!!this.params.vvSizeEnabled,this.techniqueConfig.vvColor=!!this.params.vvColorEnabled,0===e&&(this.techniqueConfig.debugDrawBorder=!!this.params.debugDrawBorder),4===e&&(this.techniqueConfig.binaryHighlightOcclusion=this.params.binaryHighlightOcclusion),this.techniqueConfig.depthEnabled=this.params.depthEnabled,this.techniqueConfig.transparencyPassType=t?t.transparencyPassType:3,this.techniqueConfig.multipassGeometryEnabled=!!t&&t.multipassGeometryEnabled,this.techniqueConfig.multipassTerrainEnabled=!!t&&t.multipassTerrainEnabled,this.techniqueConfig.cullAboveGround=!!t&&t.cullAboveGround,this.techniqueConfig}intersect(e,t,i,s,r,n,a,o,c){c?this.intersectDrapedHudGeometry(e,n,a,o):this.intersectHudGeometry(e,t,i,s,a,o);}intersectDrapedHudGeometry(e,t,s,r){const n=e.vertexAttributes.get("position"),a=e.vertexAttributes.get("size"),o=this.params,c=x$x(o);let l=1,u=1;if(r$Y(r)){const e=r(le$9);l=e[0],u=e[5];}l*=e.screenToWorldRatio,u*=e.screenToWorldRatio;const f=fe$2*e.screenToWorldRatio;for(let i=0;i<n.data.length/n.size;i++){const r=i*n.size,p=n.data[r],h=n.data[r+1],m=i*a.size;let d;pe$6[0]=a.data[m]*l,pe$6[1]=a.data[m+1]*u,o.textureIsSignedDistanceField&&(d=o.outlineSize*e.screenToWorldRatio/2),X$9(t,p,h,pe$6,f,d,o,c)&&s();}}intersectHudGeometry(e,t,s,n,o,c){if(!n.options.selectionMode||!n.options.hud)return;if(f$N(t))return;const l=this.params;let u=1,b=1;if(a$19(re$7,s),r$Y(c)){const e=c(le$9);u=e[0],b=e[5],Q$d(re$7);}const S=e.vertexAttributes.get("position"),A=e.vertexAttributes.get("size"),O=e.vertexAttributes.get("normal"),P=e.vertexAttributes.get("auxpos1");i$R(S.size>=3);const y=n.point,z=n.camera,C=x$x(l);u*=z.pixelRatio,b*=z.pixelRatio;const T="screen"===this.params.centerOffsetUnits;for(let i=0;i<S.data.length/S.size;i++){const e=i*S.size;o$S($$e,S.data[e],S.data[e+1],S.data[e+2]),I$x($$e,$$e,s);const t=i*A.size;pe$6[0]=A.data[t]*u,pe$6[1]=A.data[t+1]*b,I$x($$e,$$e,z.viewMatrix);const r=i*P.size;if(o$S(oe$7,P.data[r+0],P.data[r+1],P.data[r+2]),!T&&($$e[0]+=oe$7[0],$$e[1]+=oe$7[1],0!==oe$7[2])){const e=oe$7[2];j$F(oe$7,$$e),c$V($$e,$$e,d$O(oe$7,oe$7,e));}const c=i*O.size;if(o$S(ee$8,O.data[c],O.data[c+1],O.data[c+2]),this.normalAndViewAngle(ee$8,re$7,z,ce$7),this.applyVerticalOffsetTransformationView($$e,ce$7,z,Y$c),z.applyProjection($$e,te$7),te$7[0]>-1){let e=Math.floor(te$7[0])+this.params.screenOffset[0],t=Math.floor(te$7[1])+this.params.screenOffset[1];T&&(e+=oe$7[0],0!==oe$7[1]&&(t+=c$12(oe$7[1],Y$c.factorAlignment))),f$Q(pe$6,Y$c.factor,pe$6);const i=ue$5*z.pixelRatio;let s;if(l.textureIsSignedDistanceField&&(s=l.outlineSize*z.pixelRatio/2),X$9(y,e,t,pe$6,i,s,l,C)){const e=n.ray;if(I$x(se$9,$$e,h$L(ae$7,z.viewMatrix)),te$7[0]=y[0],te$7[1]=y[1],z.unprojectFromRenderScreen(te$7,$$e)){const t=n$11();r$Z(t,e.direction);const i=1/s$P(t);d$O(t,t,i);o(q$o(e.origin,$$e)*i,t,-1,1,!0,se$9);}}}}}computeAttachmentOrigin(e,t){const i=e.vertexAttributes;if(!i)return !1;const s=i.get("position"),r=e.indices.get("position");return h$Q(s,r,t)}createBufferWriter(){return new ge$2(this)}normalAndViewAngle(e,t,i,s){return t$K(t)&&(t=a$19(ne$7,t)),L$u(s.normal,e,t),I$x(s.normal,s.normal,i.viewInverseTransposeMatrix),s.cosAngle=z$u(ie$6,he$7),s}updateScaleInfo(e,t,i){const s=this.params;s.screenSizePerspective?d$_(i,t,s.screenSizePerspective,e.factor):(e.factor.scale=1,e.factor.factor=0,e.factor.minPixelSize=0,e.factor.paddingPixels=0),s.screenSizePerspectiveAlignment?d$_(i,t,s.screenSizePerspectiveAlignment,e.factorAlignment):(e.factorAlignment.factor=e.factor.factor,e.factorAlignment.scale=e.factor.scale,e.factorAlignment.minPixelSize=e.factor.minPixelSize,e.factorAlignment.paddingPixels=e.factor.paddingPixels);}applyShaderOffsetsView(e,t,i,s,r,n,a){const o=this.normalAndViewAngle(t,i,r,ce$7);return this.applyVerticalGroundOffsetView(e,o,r,a),this.applyVerticalOffsetTransformationView(a,o,r,n),this.applyPolygonOffsetView(a,o,s[3],r,a),this.applyCenterOffsetView(a,s,a),a}applyShaderOffsetsNDC(e,t,s,r,n){return this.applyCenterOffsetNDC(e,t,s,r),r$Y(n)&&r$Z(n,r),this.applyPolygonOffsetNDC(r,t,s,r),r}applyPolygonOffsetView(i,s,r,n,a){const o=n.aboveGround?1:-1;let c=s$T(r);0===c&&(c=o);const l=o*c;if(this.params.shaderPolygonOffset<=0)return r$Z(a,i);const u=o$R(Math.abs(s.cosAngle),.01,1),f=1-Math.sqrt(1-u*u)/u/n.viewport[2];return d$O(a,i,l>0?f:1/f),a}applyVerticalGroundOffsetView(e,t,i,s){const r=s$P(e),n=i.aboveGround?1:-1,a=.5*i.computeRenderPixelSizeAtDist(r),o=d$O($$e,t.normal,n*a);return u$S(s,e,o),s}applyVerticalOffsetTransformationView(e,t,i,s){const r=this.params;if(!r.verticalOffset||!r.verticalOffset.screenLength){if(r.screenSizePerspective||r.screenSizePerspectiveAlignment){const i=s$P(e);this.updateScaleInfo(s,i,t.cosAngle);}else s.factor.scale=1,s.factorAlignment.scale=1;return e}const n=s$P(e),a=r.screenSizePerspectiveAlignment||r.screenSizePerspective,o=V$n(i,n,r.verticalOffset,t.cosAngle,a);return this.updateScaleInfo(s,n,t.cosAngle),d$O(t.normal,t.normal,o),u$S(e,e,t.normal)}applyCenterOffsetView(e,t,i){const s="screen"!==this.params.centerOffsetUnits;return i!==e&&r$Z(i,e),s&&(i[0]+=t[0],i[1]+=t[1],t[2]&&(j$F(ee$8,i),u$S(i,i,d$O(ee$8,ee$8,t[2])))),i}applyCenterOffsetNDC(e,t,i,s){const r="screen"!==this.params.centerOffsetUnits;return s!==e&&r$Z(s,e),r||(s[0]+=t[0]/i.fullWidth*2,s[1]+=t[1]/i.fullHeight*2),s}applyPolygonOffsetNDC(e,i,s,r){const n=this.params.shaderPolygonOffset;if(e!==r&&r$Z(r,e),n){const e=s.aboveGround?1:-1,a=e*s$T(i[3]);r[2]-=(a||e)*n;}return r}getGLMaterial(e){return 0===e.output||7===e.output?new N$g(e):4===e.output?new J$d(e):void 0}calculateRelativeScreenBounds(e,t,i=i$P()){return K$d(this.params,e,t,i),i[2]=i[0]+e[0],i[3]=i[1]+e[1],i}}class L$j extends i$Y{constructor(e){super({...e,...e.material.params}),this.updateParameters();}beginSlot(e){return e===(this._material.params.drawInSecondSlot?19:18)}updateParameters(e){this.updateTexture(this._material.params.textureId),this.selectProgram(e);}selectProgram(e){this._technique=this._techniqueRep.releaseAndAcquire(j$r,this._material.getTechniqueConfig(this._output,e),this._technique);}ensureParameters(e){this.updateParameters(e);}bind(e){this.bindTextures(this._technique.program),this.bindTextureScale(this._technique.program),this._technique.bindPass(this._material.params,e);}}class N$g extends L$j{constructor(e){super(e),this._isOcclusionSlot=!1;}beginSlot(e){const t=this._material.params.drawInSecondSlot?19:18;return this._material.params.occlusionTest?(this._isOcclusionSlot=12===e,12===e||e===t):(this._isOcclusionSlot=!1,e===t)}get technique(){return this._isOcclusionSlot?this._occlusionTechnique:this._technique}selectProgram(e){this._technique=this._techniqueRep.releaseAndAcquire(j$r,this._material.getTechniqueConfig(this._output,e),this._technique),this._occlusionTechnique=this._techniqueRep.releaseAndAcquire(j$r,this._material.getTechniqueConfig(6,e),this._occlusionTechnique);}bind(e){const t=this.technique;this._isOcclusionSlot||(this.bindTextures(t.program),this.bindTextureScale(t.program)),t.bindPass(this._material.params,e);}}class J$d extends L$j{constructor(e){super({...e,output:4});}}function K$d(e,t,i,s=Z$c){return a$13(s,e.anchorPos),s[0]*=-t[0],s[1]*=-t[1],s[0]+=e.screenOffset[0]*i,s[1]+=e.screenOffset[1]*i,s}function Q$d(e){const t=e[0],i=e[1],s=e[2],r=e[3],n=e[4],a=e[5],o=e[6],c=e[7],l=e[8],u=1/Math.sqrt(t*t+i*i+s*s),f=1/Math.sqrt(r*r+n*n+a*a),p=1/Math.sqrt(o*o+c*c+l*l);return e[0]=t*u,e[1]=i*u,e[2]=s*u,e[3]=r*f,e[4]=n*f,e[5]=a*f,e[6]=o*p,e[7]=c*p,e[8]=l*p,e}function X$9(e,t,i,s,r,n,a,o){let c=t-r-(o[0]>0?s[0]*o[0]:0),l=c+s[0]+2*r,u=i-r-(o[1]>0?s[1]*o[1]:0),f=u+s[1]+2*r;if(a.textureIsSignedDistanceField){const e=a.distanceFieldBoundingBox;c+=s[0]*e[0],u+=s[1]*e[1],l-=s[0]*(1-e[2]),f-=s[1]*(1-e[3]),c-=n,l+=n,u-=n,f+=n;}return e[0]>c&&e[0]<l&&e[1]>u&&e[1]<f}const Y$c={factor:{scale:0,factor:0,minPixelSize:0,paddingPixels:0},factorAlignment:{scale:0,factor:0,minPixelSize:0,paddingPixels:0}},Z$c=n$19(),$$e=n$11(),ee$8=n$11(),te$7=x$Q(),ie$6=n$11(),se$9=n$11(),re$7=e$Z(),ne$7=e$Z(),ae$7=e$P(),oe$7=n$11(),ce$7={normal:ie$6,cosAngle:0},le$9=e$P(),ue$5=1,fe$2=2,pe$6=[0,0],he$7=t$_(0,0,1),me$4={texCoordScale:[1,1],occlusionTest:!0,binaryHighlightOcclusion:!0,drawInSecondSlot:!1,color:[1,1,1,1],outlineColor:[1,1,1,1],outlineSize:0,textureIsSignedDistanceField:!1,distanceFieldBoundingBox:null,vvSizeEnabled:!1,vvSizeMinSize:[1,1,1],vvSizeMaxSize:[100,100,100],vvSizeOffset:[0,0,0],vvSizeFactor:[1,1,1],vvColorEnabled:!1,vvColorValues:[0,0,0,0,0,0,0,0],vvColorColors:[1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0],screenOffset:[0,0],verticalOffset:null,screenSizePerspective:null,screenSizePerspectiveAlignment:null,slicePlaneEnabled:!1,anchorPos:t$18(.5,.5),shaderPolygonOffset:1e-5,polygonOffset:!1,textureId:null,centerOffsetUnits:"world",depthEnabled:!0,pixelSnappingEnabled:!0,debugDrawBorder:!1,isDraped:!1,...d$$},de$4=A$u().vec3f("position").vec3f("normal").vec2f("uv0").vec4u8("color").vec2f("size").vec4f("auxpos1").vec4f("auxpos2");class ge$2{constructor(e){this.material=e,this.vertexBufferLayout=de$4;}allocate(e){return this.vertexBufferLayout.createBuffer(e)}elementCount(e){return 6*e.indices.get("position").length}write(e,t,i,s){u$Y(t.indices.get("position"),t.vertexAttributes.get("position").data,e.transformation,i.position,s,6),a$1a(t.indices.get("normal"),t.vertexAttributes.get("normal").data,e.invTranspTransformation,i.normal,s,6);{const e=t.vertexAttributes.get("uv0").data;let r,n,a,o;if(null==e||e.length<4){const e=this.material.params;r=0,n=0,a=e.texCoordScale[0],o=e.texCoordScale[1];}else r=e[0],n=e[1],a=e[2],o=e[3];a=Math.min(1.99999,a+1),o=Math.min(1.99999,o+1);const c=t.indices.get("position").length,l=i.uv0;let u=s;for(let t=0;t<c;++t)l.set(u,0,r),l.set(u,1,n),u+=1,l.set(u,0,a),l.set(u,1,n),u+=1,l.set(u,0,a),l.set(u,1,o),u+=1,l.set(u,0,a),l.set(u,1,o),u+=1,l.set(u,0,r),l.set(u,1,o),u+=1,l.set(u,0,r),l.set(u,1,n),u+=1;}y$P(t.indices.get("color"),t.vertexAttributes.get("color").data,4,i.color,s,6);{const e=t.indices.get("size"),r=t.vertexAttributes.get("size").data,n=e.length,a=i.size;let o=s;for(let t=0;t<n;++t){const i=r[2*e[t]],s=r[2*e[t]+1];for(let e=0;e<6;++e)a.set(o,0,i),a.set(o,1,s),o+=1;}}t.indices.get("auxpos1")&&t.vertexAttributes.get("auxpos1")&&c$13(t.indices.get("auxpos1"),t.vertexAttributes.get("auxpos1").data,i.auxpos1,s,6),t.indices.get("auxpos2")&&t.vertexAttributes.get("auxpos2")&&c$13(t.indices.get("auxpos2"),t.vertexAttributes.get("auxpos2").data,i.auxpos2,s,6);}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
const W$c=n$11(),L$i=n$1a(),U$f=n$1a(),H$b=n$11(),Z$b=e$P(),q$e=_$o(),J$c=a$11(),K$c=n$11(),Q$c=i$P();class $$d{constructor(){this.aabr=i$P(),this.distance=0,this.culled=!1,this.visible=!1;}}class ii{constructor(i,t,s={}){this.graphics3DGraphic=i,this.slicePlaneEnabled=t,this.info=s;}}class ti{constructor(){this.active=new Map,this.visible=new Map;}clear(){this.active.clear(),this.visible.clear();}}class si{}class ei{constructor(){this.sortArray=new n$1h({allocator:i=>i||new si});}}class ri{constructor(){this.camera=new J$g,this.slicePlane=G$k(),this.slicePlaneEnabled=!1;}copyFrom(i){this.camera.copyFrom(i.camera),D$p(i.slicePlane,this.slicePlane),this.slicePlaneEnabled=i.slicePlaneEnabled;}}let ai=class extends p$14{constructor(){super(...arguments),this._dirty=!1,this._runningViewState=new ri,this._state=0,this.graphics=new ti,this.iterators=new ei,this.accBinsNumX=15,this.accBinsNumY=20,this.accBinsSizeX=0,this.accBinsSizeY=0,this.accBins=null,this.accNumTests=0;}get dirty(){return this._dirty}get state(){return this._state}destroy(){this.graphics.clear(),this.iterators=null;}setDirty(){!this._dirty&&this.graphics.active.size>0&&(this._dirty=!0,this.notifyChange("updating"));}get updating(){return 0!==this._state||this._dirty}get updatingProgress(){if(!this.updating)return 1;const i=this._state/4;return this._dirty?.5*i:i}get running(){return this.view.ready&&null!=this.view.state&&this.updating}runTask(i){switch(this._state){case 0:this.startUpdate(),i.madeProgress();case 1:if(this._state=1,!this.processActiveGraphics(i))return;case 2:if(this._state=2,!this.sortVisibleGraphics(i))return;case 3:if(this._state=3,!this.deconflictVisibleGraphics(i))return;default:c$D(this,this.graphics.visible),this._state=0,this.notifyChange("updating");}}modifyGraphics(i,t){t?i.forEach((i=>this.addToActiveGraphics(i))):i.forEach((i=>this.removeFromActiveGraphics(i))),this.setDirty();}layerSupportsDeconfliction(i){if(t$17(i)||"object3d"!==i.type)return !1;const t=i.stageObject;if(1!==(t?t.getNumGeometryRecords():0))return !1;return t.getGeometryRecord(0).material instanceof W$d}startUpdate(){r$J(this.view),this._dirty=!1,this._runningViewState.copyFrom(this.viewState);const{fullWidth:i,fullHeight:t}=this._runningViewState.camera;this.initBins(i,t),this.resetIterators();}addToActiveGraphics(i){i.info[this.visibilityGroup]=new $$d,this.graphics.active.set(i.graphics3DGraphic.graphic.uid,i),this.setDirty();}removeFromActiveGraphics(i){this.removeFromVisibleGraphics(i),oi(i,this.visibilityGroup),delete i.info[this.visibilityGroup],this.graphics.active.delete(i.graphics3DGraphic.graphic.uid),this.setDirty();}addToVisibleGraphics(i){this.graphics.visible.set(i.graphics3DGraphic.graphic.uid,i);}removeFromVisibleGraphics(i){this.graphics.visible.delete(i.graphics3DGraphic.graphic.uid);}processActiveGraphics(i){const t=this.ensureActiveGraphicsIterator(),s=h$L(Z$b,this._runningViewState.camera.projectionMatrix),e="global"===this.view.viewingMode&&1===this.view.map.ground.opacity&&this._runningViewState.camera.relativeElevation>0?q$e:null;let a=0;for(r$Y(e)&&(I$x(e,f$R,this._runningViewState.camera.viewMatrix),e[3]=p$15(this.view.spatialReference).radius,a=I$z(e,f$R));!i.done;){i.madeProgress();const r=t.next();if(r.done)return this.resetActiveGraphicsIterator(),!0;const o=r.value,c=o&&o.info[this.visibilityGroup];c&&(this.collectGraphics3DGraphics(o,s,e,a),c.culled?this.removeFromVisibleGraphics(o):this.addToVisibleGraphics(o));}return !1}sortVisibleGraphics(i){const t=this.ensureSortGraphicsIterator();for(;!i.done;){const s=t.next();if(i.madeProgress(),s.done)return this.resetSortGraphicsIterator(),!0}return !1}deconflictVisibleGraphics(i){const t=this.ensureVisibleGraphicsIterator(),s=1===this.visibilityGroup;for(;!i.done;){i.madeProgress();const e=t.next();if(e.done)return this.resetVisibleGraphicsIterator(),!0;const r=e.value,a=r.info[this.visibilityGroup];if(!a||a.culled)continue;const o=r.graphics3DGraphic,c=(!s||o.isVisible())&&!this.isConflicted(r);c&&this.addToBins(r),a.visible=c,this.setGraphicVisibility(r,c),f$C(a,c);}return !1}resetIterators(){this.iterators.active=null,this.iterators.visible=null,this.iterators.sort=null;}ensureActiveGraphicsIterator(){return this.iterators.active||(this.iterators.active=ci(this.graphics.active)),this.iterators.active}resetActiveGraphicsIterator(){this.iterators.active=null;}ensureVisibleGraphicsIterator(){return this.iterators.visible||(this.iterators.visible=ci(this.graphics.visible)),this.iterators.visible}resetVisibleGraphicsIterator(){this.iterators.visible=null;}ensureSortGraphicsIterator(){return this.iterators.sort||(this.iterators.sort=ni(this.graphics.visible,this.iterators.sortArray,this.visibilityGroup)),this.iterators.sort}resetSortGraphicsIterator(){this.iterators.sort=null;}collectGraphics3DGraphics(i,t,s,a){const o=i.graphics3DGraphic;if(o.destroyed)return;const c=i.info[this.visibilityGroup];if(!o.isVisible(0,3))return void(c.culled=!0);const n=this.getGraphicsLayers(o);B$m(c.aabr);let h=null;for(const l of n){if(!this.layerSupportsDeconfliction(l))continue;const o=l.stageObject.getGeometryRecord(0).material;if(t$17(h)){if(h=this.getProjectionInfo(l,t,pi),h.isOutsideScreen||this.isCulledBySlice(i,W$c)||r$Y(s)&&this.isCulledByHorizon(h,s,a))return void(c.culled=!0);!T$k.DISABLE_DECONFLICTOR_VISIBILITY_OFFSET&&c.visible&&(h.distance*=.7);}this.expandBoundingRect(c,l,o,h);}t$17(h)?c.culled=!0:(c.distance=h.distance,c.culled=!1);}getProjectionInfo(i,t,s){const e=this._runningViewState.camera,r=i.stageObject,a=r.getGeometryRecord(0),o=a.material,c=O$z(r.boundingVolumeWorldSpace.bounds);I$x(W$c,c,e.viewMatrix);const n=a.geometry.vertexAttributes,h=n.get("normal").data,l=n.get("auxpos1").data;return o.applyShaderOffsetsView(W$c,h,r.transformation,l,e,s.scaleInfo,W$c),r$17(L$i,W$c[0],W$c[1],W$c[2],1),y$O(U$f,L$i,e.projectionMatrix),d$O(s.positionNDC,U$f,1/U$f[3]),o.applyShaderOffsetsNDC(s.positionNDC,l,e,s.positionNDC,H$b),s.distanceWithoutPolygonOffset=e.depthNDCToWorld(H$b[2]),s.distance=H$b[2]===s.positionNDC[2]?s.distanceWithoutPolygonOffset:e.depthNDCToWorld(s.positionNDC[2]),r$17(U$f,s.positionNDC[0],s.positionNDC[1],s.positionNDC[2],1),y$O(L$i,U$f,t),l$10(L$i,L$i,1/L$i[3]),o$S(s.positionView,W$c[0],W$c[1],W$c[2]),s}isCulledByHorizon(i,t,s){return r$Z(J$c.direction,i.positionView),o$S(J$c.origin,0,0,0),!!V$l(t,J$c,K$c)&&i.distanceWithoutPolygonOffset>s}isCulledBySlice(i,t){return i.slicePlaneEnabled&&this._runningViewState.slicePlaneEnabled&&cs(this._runningViewState.slicePlane,t)}expandBoundingRect(i,t,e,{positionNDC:r,scaleInfo:a}){const o=this._runningViewState.camera,c=t.getScreenSize(hi);f$Q(c,a.factor,c),c[0]*=o.pixelRatio,c[1]*=o.pixelRatio;const n=R$t(e.calculateRelativeScreenBounds(c,a.factorAlignment.scale,Q$c),m$V(0,o.fullWidth,.5+.5*r[0]),m$V(0,o.fullHeight,.5+.5*r[1])),h=this.iconMarginFactor;if(0!==h){const i=h*Math.min(x$R(n),M$y(n));n[0]-=i,n[1]-=i,n[2]+=i,n[3]+=i;}c$14(i.aabr,n);}isConflicted(i){const t=i.graphics3DGraphic.graphic.uid,s=i.info[this.visibilityGroup];for(let e=Math.floor(s.aabr[0]/this.accBinsSizeX);e<=Math.floor(s.aabr[2]/this.accBinsSizeX);e++)if(!(e<0||e>=this.accBinsNumX))for(let i=Math.floor(s.aabr[1]/this.accBinsSizeY);i<=Math.floor(s.aabr[3]/this.accBinsSizeY);i++){if(i<0||i>=this.accBinsNumY)continue;const r=this.accBins[e][i];for(let i=0;i<r.length;i++){const e=r.data[i],a=e.info[this.visibilityGroup];if(a&&a.visible&&(e.graphics3DGraphic.graphic.uid!==t&&(this.accNumTests++,F$A(a.aabr,s.aabr))))return !0}}return !1}initBins(i,t){if(null==this.accBins){this.accBins=[];for(let i=0;i<this.accBinsNumX;i++){this.accBins.push([]);const i=this.accBins[this.accBins.length-1];for(let t=0;t<this.accBinsNumY;t++)i.push(new n$1h);}}else for(let s=0;s<this.accBinsNumX;s++)for(let i=0;i<this.accBinsNumY;i++)this.accBins[s][i].clear();this.accBinsSizeX=i/this.accBinsNumX,this.accBinsSizeY=t/this.accBinsNumY,this.accNumTests=0;}addToBins(i){const t=i.info[this.visibilityGroup],s=Math.floor(t.aabr[0]/this.accBinsSizeX),e=Math.floor(t.aabr[2]/this.accBinsSizeX),r=Math.floor(t.aabr[1]/this.accBinsSizeY),a=Math.floor(t.aabr[3]/this.accBinsSizeY);for(let o=s;o<=e;o++)if(!(o<0||o>=this.accBinsNumX))for(let t=r;t<=a;t++)t<0||t>=this.accBinsNumY||this.accBins[o][t].push(i);}setGraphicVisibility(i,t){const s=i.graphics3DGraphic;s.destroyed||(s.setVisibilityFlag(3,t,this.visibilityGroup),1===this.visibilityGroup&&this.view.labeler.setLabelGraphicVisibility(s,t));}};function oi(i,t){const s=i.graphics3DGraphic;s.destroyed||s.clearVisibilityFlag(3,t);}function*ci(i){if(Map.prototype.entries){const t=i.entries();for(let i=t.next();!i.done;i=t.next())yield i.value[1];}else yield*i.values();}function*ni(i,t,s){t.clear(),i.forEach(((i,e)=>{const r=t.pushNew();r.id=e,r.prio=i.info?-i.info[s].distance:Number.MAX_VALUE;})),yield;const e=t.iterableSort(((i,t)=>t.prio-i.prio));for(let r=e.next();!r.done;r=e.next())yield;t.forAll((t=>{const s=i.get(t.id);s&&(i.delete(t.id),i.set(t.id,s));})),t.clear();}e$Q([y$K({constructOnly:!0})],ai.prototype,"view",void 0),e$Q([y$K({type:Boolean,readOnly:!0})],ai.prototype,"updating",null),ai=e$Q([n$14("esri.views.3d.layers.graphics.Deconflictor")],ai);const hi=n$19();class li{constructor(){this.positionView=n$11(),this.positionNDC=n$11(),this.distance=0,this.distanceWithoutPolygonOffset=0,this.scaleInfo={factor:{scale:0,factor:0,minPixelSize:0,paddingPixels:0},factorAlignment:{scale:0,factor:0,minPixelSize:0,paddingPixels:0}};}get isOutsideScreen(){const i=this.positionNDC;return i[0]<-1||i[1]<-1||i[2]<-1||i[0]>=1||i[1]>=1}}const pi=new li;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
const o$C=2e3;let i$r=class extends ai{constructor(){super(...arguments),this.visibilityGroup=1,this.iconMarginFactor=0,this._lastDeconfliction=0;}get viewState(){return this.parent.viewState}runTask(r){if(this.parent.running)return;const t=performance.now();(2===r.state||t-this._lastDeconfliction>o$C)&&(super.runTask(r),0===this.state&&(this._lastDeconfliction=t));}enabledChanged(r,t){this.modifyGraphics(t,r.labelsEnabled);}getGraphicsLayers(r){return r.labelGraphics}};e$Q([y$K({constructOnly:!0})],i$r.prototype,"parent",void 0),i$r=e$Q([n$14("esri.views.3d.layers.graphics.LabelDeconflictor")],i$r);

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
let t$J=class extends p$14{constructor(){super(...arguments),this.SCHEDULER_LOG_SLOW_TASKS=!1,this.FEATURE_SERVICE_SNAPPING_SOURCE_TILE_TREE_SHOW_TILES=!1;}};e$Q([y$K()],t$J.prototype,"SCHEDULER_LOG_SLOW_TASKS",void 0),e$Q([y$K()],t$J.prototype,"FEATURE_SERVICE_SNAPPING_SOURCE_TILE_TREE_SHOW_TILES",void 0),t$J=e$Q([n$14("esri.views.support.DebugFlags")],t$J);const p$I=new t$J;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
const m$D=n$12.getLogger("esri.views.support.Scheduler");function g$B(e){return new U$e.Scheduler({nowFunc:e})}var p$H;!function(e){e.RESOURCE_CONTROLLER="schedule",e.SLIDE="slide",e.STREAM_DATA_LOADER="stream loader",e.ELEVATION_QUERY="elevation query",e.TERRAIN_SURFACE="terrain",e.SURFACE_GEOMETRY_UPDATES="surface geometry updates",e.GRAPHICS_CORE="Graphics3D",e.I3S_CONTROLLER="I3S",e.POINT_CLOUD_LAYER="point cloud",e.FEATURE_TILE_FETCHER="feature fetcher",e.STAGE="stage",e.GRAPHICS_DECONFLICTOR="graphics deconflictor",e.FILTER_VISIBILITY="Graphics3D filter visibility",e.SCALE_VISIBILITY="Graphics3D scale visibility",e.FRUSTUM_VISIBILITY="Graphics3D frustum visibility",e.POINT_OF_INTEREST_FREQUENT="POI frequent",e.POINT_OF_INTEREST_INFREQUENT="POI infrequent",e.LABELER="labeler",e.FEATURE_QUERY_ENGINE="feature query",e.FEATURE_TILE_TREE="feature tile tree",e.FEATURE_TILE_TREE_ACTIVE="fast feature tile tree",e.ELEVATION_ALIGNMENT="elevation alignment",e.TEXT_TEXTURE_ATLAS="text texture atlas",e.TEXTURE_UNLOAD="texture unload",e.OVERLAY_MANAGER="overlay manager",e.LINE_OF_SIGHT_TOOL="line of sight tool",e.LINE_OF_SIGHT_TOOL_INTERACTIVE="interactive line of sight tool",e.ELEVATION_PROFILE="elevation profile",e.SNAPPING="snapping",e.SHADOW_ACCUMULATOR="shadow accumulator",e[e.TEST_PRIO=1]="TEST_PRIO";}(p$H||(p$H={}));const I$m=0,R$k=new Map([[p$H.RESOURCE_CONTROLLER,I$m],[p$H.SLIDE,I$m],[p$H.STREAM_DATA_LOADER,I$m],[p$H.ELEVATION_QUERY,I$m],[p$H.TERRAIN_SURFACE,1],[p$H.SURFACE_GEOMETRY_UPDATES,1],[p$H.GRAPHICS_CORE,2],[p$H.I3S_CONTROLLER,2],[p$H.POINT_CLOUD_LAYER,2],[p$H.FEATURE_TILE_FETCHER,2],[p$H.STAGE,4],[p$H.GRAPHICS_DECONFLICTOR,4],[p$H.FILTER_VISIBILITY,4],[p$H.SCALE_VISIBILITY,4],[p$H.FRUSTUM_VISIBILITY,4],[p$H.POINT_OF_INTEREST_FREQUENT,6],[p$H.POINT_OF_INTEREST_INFREQUENT,30],[p$H.LABELER,8],[p$H.FEATURE_QUERY_ENGINE,8],[p$H.FEATURE_TILE_TREE,16],[p$H.FEATURE_TILE_TREE_ACTIVE,I$m],[p$H.ELEVATION_ALIGNMENT,12],[p$H.TEXT_TEXTURE_ATLAS,12],[p$H.TEXTURE_UNLOAD,12],[p$H.OVERLAY_MANAGER,12],[p$H.LINE_OF_SIGHT_TOOL,16],[p$H.LINE_OF_SIGHT_TOOL_INTERACTIVE,I$m],[p$H.SNAPPING,I$m],[p$H.SHADOW_ACCUMULATOR,30]]);function f$B(e){return R$k.has(e)?R$k.get(e):"number"==typeof e?e:1}const A$j=n$1e(6.5),S$r=n$1e(1),b$o=n$1e(30),L$h=n$1e(1e3/30),k$i=n$1e(100),O$j=.9;var U$e,P$m;!function(s){let o=class extends p$14{constructor(e){super(e),this.updating=!0,this.performanceInfo={total:new e$10("total"),tasks:new Map},this._frameTaskTimes=new Map,this._budget=null,this._state=1,this._tasks=new n$1h,this._runQueue=new n$1h,this._load=0,this._idleStateCallbacks=new n$1h,this._idleUpdatesStartFired=!1,this._maxReschedule=C$g,this._forceTask=!1,this._debug=!1,this._debugHandle=d$S(p$I,"SCHEDULER_LOG_SLOW_TASKS",(e=>this._debug=e)),this._budget=new h(e.nowFunc);for(const r of Object.keys(p$H))this.performanceInfo.tasks.set(p$H[r],new e$10(p$H[r]));let t;const s=this;this._test={get state(){return t$17(t)?s._state:t},set state(e){t=e;},FRAME_SAFETY_BUDGET:A$j,INTERACTING_BUDGET:L$h,IDLE_BUDGET:k$i,get budget(){return s._budget.budget},usedBudget:0,updateTask:e=>this._updateTask(e),getState:e=>this._getState(e),getRuntime:e=>this._getRuntime(e),resetRuntimes:()=>this._resetRuntimes(),getRunning:()=>this._getRunning()};}destroy(){this._debugHandle&&this._debugHandle.remove();}registerTask(e,t){const s=f$B(e),r=new u(this,e,t,s);return this._tasks.push(r),this.performanceInfo.tasks.has(e)||this.performanceInfo.tasks.set(e,new e$10(e)),r}registerIdleStateCallbacks(e,t){const s={idleBegin:e,idleEnd:t};this._idleStateCallbacks.push(s),2===this.state&&this._idleUpdatesStartFired&&s.idleBegin();const r=this;return {remove:()=>this._removeIdleStateCallbacks(s),set idleBegin(e){r._idleUpdatesStartFired&&(s.idleEnd(),2===r._state&&e()),s.idleBegin=e;},set idleEnd(e){s.idleEnd=e;}}}get now(){return this.nowFunc()}get load(){return this._load}set state(e){this._state!==e&&(this._state=e,2!==this.state&&this._idleUpdatesStartFired&&(this._idleUpdatesStartFired=!1,this._idleStateCallbacks.forAll((e=>e.idleEnd()))));}get state(){return t$17(this._test.state)?this._state:this._test.state}updateBudget(e){this._test.usedBudget=0;let t=A$j,s=e.frameDuration,r=S$r;switch(this.state){case 2:t=n$1e(0),s=n$1e(Math.max(k$i,e.frameDuration)),r=b$o;break;case 1:s=n$1e(Math.max(L$h,e.frameDuration));}return s=n$1e(s-e.elapsedFrameTime-t),2!==this.state&&s<S$r&&!this._forceTask?(this._forceTask=!0,!1):(s=n$1e(Math.max(s,r)),this._budget.reset(s,this.state),this._maxReschedule=C$g,this._updateLoad(),this._schedule())}frame(){switch(this._forceTask=!1,this.state){case 2:this._idleUpdatesStartFired||(this._idleUpdatesStartFired=!0,this._idleStateCallbacks.forAll((e=>e.idleBegin()))),this._runIdle();break;case 1:this._runInteracting();break;default:this._runAnimating();}this._test.usedBudget=this._budget.elapsed;}stopFrame(){this._budget.reset(n$1e(0),this._state),this._budget.madeProgress();}_removeIdleStateCallbacks(e){this._idleUpdatesStartFired&&e.idleEnd(),this._idleStateCallbacks.removeUnordered(e);}removeTask(e){this._tasks.removeUnordered(e),this._runQueue.removeUnordered(e);}_updateTask(e){this._tasks.forAll((t=>{t.name===e&&t.setPriority(e);}));}_getState(e){if(this._runQueue.some((t=>t.name===e)))return P$m.SCHEDULED;let t=P$m.IDLE;return this._tasks.forAll((s=>{s.name===e&&s.needsUpdate&&(s.schedulePriority<=1?t=P$m.READY:t!==P$m.READY&&(t=P$m.WAITING));})),t}_getRuntime(e){let t=0;return this._tasks.forAll((s=>{s.name===e&&(t+=s.runtime);})),t}_resetRuntimes(){this._tasks.forAll((e=>e.runtime=0));}_getRunning(){const e=new Map;if(this._tasks.forAll((t=>{t.needsUpdate&&e.set(t.name,(e.get(t.name)||0)+1);})),0===e.size)return null;let t="";return e.forEach(((e,s)=>{t+=e>1?` ${e}x ${s}`:` ${s}`;})),t}_runIdle(){this._run();}_runInteracting(){this._run();}_runAnimating(){this._run();}_updateLoad(){const e=this._tasks.reduce(((e,t)=>t.needsUpdate?++e:e),0);this._load=this._load*O$j+e*(1-O$j);}_schedule(){if(this._maxReschedule<=0)return !1;for(this._runQueue.filterInPlace((e=>!!e.needsUpdate||(e.schedulePriority=e.basePriority,!1))),this._tasks.forAll((e=>{e.basePriority===I$m&&e.needsUpdate&&!this._runQueue.some((t=>t===e))&&this._runQueue.unshift(e);}));0===this._runQueue.length;){let e=!1,t=0;if(this._tasks.forAll((s=>{if(s.needsUpdate&&0!==s.schedulePriority&&s.basePriority!==I$m)switch(e=!0,t=Math.max(t,s.basePriority),s.schedulePriority){case 1:s.schedulePriority=0,this._runQueue.push(s);break;default:--s.schedulePriority;}})),!e)return this.updating=!1,!1;this._maxReschedule===C$g&&(this._maxReschedule=t),--this._maxReschedule;}return this.updating=!0,!0}_run(){const e=this._budget.now();this._startFrameTaskTimes();do{for(;this._runQueue.length>0;){const s=this._budget.now(),r=this._runQueue.pop();this._budget.resetProgress();try{r.task.runTask(this._budget);}catch(t){m$D.error(`Exception in task "${r.name}"`,t);}r.schedulePriority=r.basePriority;const i=this._budget.now()-s;if(r.runtime+=i,this._frameTaskTimes.set(r.priority,this._frameTaskTimes.get(r.priority)+i),this._debug&&this._budget.elapsed>2*this._budget.budget&&console.log("Task",r.name,"used",this._budget.elapsed,"of max",this._budget.budget,"ms"),this._budget.remaining<=0)return void this._recordFrameTaskTimes(this._budget.now()-e)}}while(this._schedule());this._recordFrameTaskTimes(this._budget.now()-e);}_startFrameTaskTimes(){for(const e of Object.keys(p$H))this._frameTaskTimes.set(p$H[e],0);}_recordFrameTaskTimes(e){this._frameTaskTimes.forEach(((e,t)=>this.performanceInfo.tasks.get(t).record(e))),this.performanceInfo.total.record(e);}get test(){return this._test}};e$Q([y$K()],o.prototype,"updating",void 0),e$Q([y$K()],o.prototype,"nowFunc",void 0),o=e$Q([n$14("esri.views.support.Scheduler")],o),s.Scheduler=o;let u=class extends p$14{constructor(e,t,s,r){super({}),this._scheduler=e,this.name=t,this._basePriority=r,this.runtime=0,this._queue=new r$1h,this.updating=!1,this.schedulePriority=this._basePriority,this.task=r$Y(s)?s:{running:!1,runTask:e=>this.processQueue(e)};}normalizeCtorArgs(){return {}}remove(){this.processQueue(N$f),this._scheduler.removeTask(this),this.schedule=y$x.schedule,this.reschedule=y$x.reschedule;}get basePriority(){return this._basePriority}setPriority(e){this.name=e;const t=f$B(e);this._basePriority!==I$m&&0===this.schedulePriority||(this.schedulePriority=t),this._basePriority=t;}get priority(){return this.name}set priority(e){this.setPriority(e);}get needsUpdate(){return this.updating||this.task.running}schedule(e,t,s){return this.updating=!0,this._queue.push(e,t,s)}reschedule(e,t,s){return this.updating=!0,this._queue.unshift(e,t,s)}processQueue(e){for(;!e.done&&this._queue.process();)e.madeProgress();this.updating=this._queue.length>0;}};e$Q([y$K()],u.prototype,"updating",void 0),u=e$Q([n$14("esri.views.support.SchedulerTask")],u);class h{constructor(e){this.now=e,this._begin=0,this._budget=0,this._state=2,this._didWork=!1,this._enabled=!0;}run(e){return !this.done&&(!0===e()&&(this._didWork=!0),!0)}get done(){return this._didWork&&this.elapsed>=this._budget&&this._enabled}get budget(){return this._budget}madeProgress(){this._didWork=!0;}get state(){return this._state}get enabled(){return this._enabled}set enabled(e){this._enabled=e;}reset(e,t){this._begin=this.now(),this._budget=e,this._state=t,this._didWork=!1;}get remaining(){return Math.max(this._budget-this.elapsed,0)}get elapsed(){return this.now()-this._begin}resetProgress(){this._didWork=!1;}get hasProgressed(){return this._didWork}}s.Budget=h;}(U$e||(U$e={})),function(e){e.SCHEDULED="s",e.READY="r",e.WAITING="w",e.IDLE="i";}(P$m||(P$m={}));const N$f=(()=>{const e=new U$e.Budget((()=>performance.now()));return e.enabled=!1,e})();class F$m{remove(){}processQueue(){}schedule(e,t,s){try{if(b$J(t)){const e=m$Y();return s?Promise.resolve(s(e)):Promise.reject(e)}return q$q(e())}catch(r){return Promise.reject(r)}}reschedule(e,t,s){return this.schedule(e,t,s)}}const y$x=new F$m,C$g=Number.MAX_SAFE_INTEGER;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
let d$z=class extends ai{constructor(){super(...arguments),this._handles=new u$T,this._contexts=new Map,this._viewState=new ri,this.visibilityGroup=0,this._iconMarginFactor=-.1;}get labels(){return this._labels}get viewState(){return this._viewState}initialize(){this._handles.add([this.view.watch("state.camera",(()=>{this.updateViewState(),this.setDirty();})),this.view.watch("map.ground.opacity",((e,t)=>{1!==e&&1!==t||this.setDirty();})),d$S(this.view,"slicePlane",(()=>{this.updateSlicePlane(),this.slicePlaneChanged();}))]),this._frameTask=this.view.resourceController.scheduler.registerTask(p$H.GRAPHICS_DECONFLICTOR,this),this._labels=new i$r({view:this.view,parent:this});}destroy(){this._labels.destroy(),this._labels=null,this._handles.destroy(),this._handles=null,this._frameTask&&(this._frameTask.remove(),this._frameTask=null);}get iconMarginFactor(){return this._iconMarginFactor}set iconMarginFactor(e){this._iconMarginFactor=e,this.setDirty();}setDirty(){this._contexts.size>0&&(super.setDirty(),this._labels.setDirty());}runTask(e){super.runTask(e),this.running||this._labels.setDirty();}setInitialIconVisibilityFlag(e,t){const i=!(this._graphicSupportsDeconfliction(t)&&u$D(e));t.setVisibilityFlag(3,i,0);}updateViewState(){this.view&&this.view.state&&(this._viewState.camera.copyFrom(this.view.state.camera),this.updateSlicePlane());}updateSlicePlane(){const e=this.view?this.view.slicePlane:null;r$Y(e)&&ls(e,this._viewState.camera.viewMatrix,this._viewState.slicePlane),this._viewState.slicePlaneEnabled=r$Y(e);}slicePlaneChanged(){n$1i(this._contexts,((e,t)=>t.symbolCreationContext.slicePlaneEnabled))&&this.setDirty();}addGraphicsOwner(e){let t=this._contexts.get(e);return null==t&&(t=new Map,this._contexts.set(e,t),this.setDirty()),{addGraphic:i=>this.addGraphic(e,t,i),removeGraphic:e=>this.removeGraphic(t,e),labelingInfoChange:()=>this._labels.enabledChanged(e,t),featureReductionChange:()=>this.enabledChanged(e,t),slicePlaneEnabledChange:()=>this._slicePlaneEnabledChanged(e,t),clear:()=>t.forEach((e=>this.removeGraphic(t,e.graphics3DGraphic)))}}removeGraphicsOwner(e){const t=this._contexts.get(e);t&&(t.forEach((e=>this.removeGraphic(t,e.graphics3DGraphic))),this._contexts.delete(e),this.setDirty());}addGraphic(e,t,i){const s=i.graphic.uid,r=new ii(i,e.symbolCreationContext.slicePlaneEnabled);t.set(s,r),u$D(e)&&this.addToActiveGraphics(r),e.labelsEnabled&&this._labels.addToActiveGraphics(r);}removeGraphic(e,t){const i=t.graphic.uid,s=e.get(i);s&&(this.removeFromActiveGraphics(s),this._labels.removeFromActiveGraphics(s),e.delete(i),this.setDirty());}enabledChanged(e,t){const i=u$D(e);i||m$C(e),this.modifyGraphics(t,i);}_slicePlaneEnabledChanged(e,t){const i=e.symbolCreationContext.slicePlaneEnabled;t.forEach((e=>e.slicePlaneEnabled=i)),this.setDirty();}getGraphicsLayers(e){return e._graphics}_graphicSupportsDeconfliction(e){if(e.isDraped)return !1;const t=e._graphics;if(!t||!t.length)return !1;for(const i of t)if(this.layerSupportsDeconfliction(i))return !0;return !1}};function u$D(e){const t=e.layer;return !(!t||!t.featureReduction||"selection"!==t.featureReduction.type)}function m$C(e){const t=e.graphics3DGraphics;t&&t.forEach((e=>e.clearVisibilityFlag(3)));}d$z=e$Q([n$14("esri.views.3d.layers.graphics.GraphicsDeconflictor")],d$z);

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
function m$B(e){return "declaredClass"in e}function u$C(e){return "declaredClass"in e}function l$E(e){return "declaredClass"in e}function c$C(r,t){if(!r)return null;if(l$E(r))return r;const s=new h$R({layer:t,sourceLayer:t});return s.visible=r.visible,s.symbol=y$M(r.symbol),s.attributes=y$M(r.attributes),s.geometry=f$A(r.geometry),s}function f$A(e){return t$17(e)?null:m$B(e)?e:p$19(h$v(e))}function h$v(e){const n=e.spatialReference.toJSON();switch(e.type){case"point":{const{x:r,y:t,z:s,m:a}=e;return {x:r,y:t,z:s,m:a,spatialReference:n}}case"polygon":{const{rings:r,hasZ:t,hasM:s}=e;return {rings:p$G(r),hasZ:t,hasM:s,spatialReference:n}}case"polyline":{const{paths:r,hasZ:t,hasM:s}=e;return {paths:p$G(r),hasZ:t,hasM:s,spatialReference:n}}case"extent":{const{xmin:r,xmax:t,ymin:s,ymax:a,zmin:i,zmax:o,mmin:m,mmax:u,hasZ:l,hasM:c}=e;return {xmin:r,xmax:t,ymin:s,ymax:a,zmin:i,zmax:o,mmin:m,mmax:u,hasZ:l,hasM:c,spatialReference:n}}case"multipoint":{const{points:r,hasZ:t,hasM:s}=e;return {points:M$p(r)?y$w(r):r,hasZ:t,hasM:s,spatialReference:n}}default:return}}function p$G(e){return x$w(e)?e.map((e=>y$w(e))):e}function y$w(e){return e.map((e=>l$11(e)))}function x$w(e){for(const n of e)if(0!==n.length)return M$p(n);return !1}function M$p(e){return e.length&&(y$Q(e[0])||A$w(e[0]))}function Z$a(e,n){if(!e)return null;let r;if(u$C(e)){if(null==n)return e.clone();if(u$C(n))return n.copy(e)}return null!=n?(r=n,r.x=e.x,r.y=e.y,r.spatialReference=e.spatialReference,e.hasZ?(r.z=e.z,r.hasZ=e.hasZ):(r.z=null,r.hasZ=!1),e.hasM?(r.m=e.m,r.hasM=!0):(r.m=null,r.hasM=!1)):(r=v$O(e.x,e.y,e.z,e.spatialReference),e.hasM&&(r.m=e.m,r.hasM=!0)),r}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
function R$j(t,e){if("point"===t.type)return F$l(t,e,!1);if(m$B(t))switch(t.type){case"extent":return F$l(t.center,e,!1);case"polygon":return F$l(t.centroid,e,!1);case"polyline":return F$l(k$h(t),e,!0);case"mesh":return F$l(t.origin,e,!1)}else switch(t.type){case"extent":return F$l(M$o(t),e,!0);case"polygon":return F$l(A$i(t),e,!0);case"polyline":return F$l(k$h(t),e,!0)}}function k$h(t){const e=t.paths[0];if(!e||0===e.length)return null;const r=l$12(e,s$Z(e)/2);return v$O(r[0],r[1],r[2],t.spatialReference)}function M$o(e){const r=u$Z(e.zmin);return v$O(.5*(e.xmax+e.xmin),.5*(e.ymax+e.ymin),r?.5*(e.zmax+e.zmin):void 0,e.spatialReference)}function A$i(t){const e=t.rings[0];if(!e||0===e.length)return null;const r=o$13(t.rings,t.hasZ);return v$O(r[0],r[1],r[2],t.spatialReference)}function F$l(t,e,r){const n=r?t:Z$a(t);return e&&t?ln(t,n,e)?n:null:n}function P$l(t,e,r,n=0){if(t){e||(e=i$P());const o=t;let i=.5*o.width*(r-1),s=.5*o.height*(r-1);return o.width<1e-7*o.height?i+=s/20:o.height<1e-7*o.width&&(s+=i/20),r$17(e,o.xmin-i-n,o.ymin-s-n,o.xmax+i+n,o.ymax+s+n),e}return null}function z$f(t,e){for(let r=0;r<t.geometries.length;++r){const n=t.geometries[r].getMutableAttribute("auxpos1");n&&n.data[3]!==e&&(n.data[3]=e,t.geometryVertexAttrsUpdated(r));}}function B$c(t,r){const n=t$1g(l$13);return r$Y(t)&&(n[0]=t[0],n[1]=t[1],n[2]=t[2]),r$Y(r)?n[3]=r:r$Y(t)&&t.length>3&&(n[3]=t[3]),n}function D$g(t,r,n,o,i,s=[0,0,0,0]){for(let u=0;u<3;++u)r$Y(t)&&null!=t[u]?s[u]=t[u]:r$Y(n)&&null!=n[u]?s[u]=n[u]:s[u]=i[u];return r$Y(r)?s[3]=r:r$Y(o)?s[3]=o:s[3]=i[3],s}function I$l(t=l$14,e,n,o=1){const i=new Array(3);if(t$17(e)||t$17(n))i[0]=1,i[1]=1,i[2]=1;else {let r,o=0;for(let s=2;s>=0;s--){const u=t[s];let a;const m=null!=u,l=0===s&&!r&&!m,c=n[s];"symbol-value"===u||l?a=0!==c?e[s]/c:1:m&&"proportional"!==u&&isFinite(u)&&(a=0!==c?u/c:1),null!=a&&(i[s]=a,r=a,o=Math.max(o,Math.abs(a)));}for(let t=2;t>=0;t--)null==i[t]?i[t]=r:0===i[t]&&(i[t]=.001*o);}for(let r=2;r>=0;r--)i[r]/=o;return e$11(i)}function U$d(t){return null!=t.isPrimitive}function O$i(t){return U$d(t)&&(t=[t.width,t.depth,t.height]),S$q(t)?null:"Symbol sizes may not be negative values"}function S$q(t){if(Array.isArray(t)){for(const e of t)if(!S$q(e))return !1;return !0}return null==t||t>=0}function V$e(t,e,r,u=e$P()){const a=t||0,m=e||0,l=r||0;return 0!==a&&m$W(u,u,-a/180*Math.PI),0!==m&&b$H(u,u,m/180*Math.PI),0!==l&&l$X(u,u,l/180*Math.PI),u}function Z$9(t,e){return null!=e.minDemResolution?e.minDemResolution:S$D(t)?e.minDemResolutionForPoints:.01*z$x(t)}const q$d={"bottom-left":t$18(0,0),bottom:t$18(.5,0),"bottom-right":t$18(1,0),left:t$18(0,.5),center:t$18(.5,.5),right:t$18(1,.5),"top-left":t$18(0,1),top:t$18(.5,1),"top-right":t$18(1,1)};

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
function f$z(e,t,n,o,r,s,a,l,c,u,f){const m=j$q[f.mode];let d,p,g=0;if(xn(e,t,n,o,c.spatialReference,r,l))return m.requiresAlignment(f)?(g=m.applyElevationAlignmentBuffer(o,r,s,a,l,c,u,f),d=s,p=a):(d=o,p=r),xn(d,c.spatialReference,p,s,u.spatialReference,a,l)?g:void 0}function m$A(n,o,r,i,s){const l=(t$Y(n)?n.z:a$Y(n)?n.array[n.offset+2]:n[2])||0;switch(r.mode){case"on-the-ground":{const e=c$W(i$O(o,n,"ground"),0);return s&&(s.verticalDistanceToGround=0,s.sampledElevation=e),e}case"relative-to-ground":{const e=c$W(i$O(o,n,"ground"),0),a=r.geometryZWithOffset(l,i);return s&&(s.verticalDistanceToGround=a,s.sampledElevation=e),a+e}case"relative-to-scene":{const e=c$W(i$O(o,n,"scene"),0),a=r.geometryZWithOffset(l,i);return s&&(s.verticalDistanceToGround=a,s.sampledElevation=e),a+e}case"absolute-height":{const e=r.geometryZWithOffset(l,i);if(s){const r=c$W(i$O(o,n,"ground"),0);s.verticalDistanceToGround=e-r,s.sampledElevation=r;}return e}default:return n$1d(r.mode),0}}function d$y(e,t,n){return null==t||null==n?e.definedChanged:"on-the-ground"===t&&"on-the-ground"===n?e.staysOnTheGround:t===n||"on-the-ground"!==t&&"on-the-ground"!==n?T$j.UPDATE:e.onTheGroundChanged}function p$F(e){return "relative-to-ground"===e||"relative-to-scene"===e}function g$A(e){return "absolute-height"!==e}function v$u(e,t,o,r,i){const a=m$A(t,o,i,r,O$h);z$f(e,O$h.verticalDistanceToGround);const c=O$h.sampledElevation,u=n$18(x$v,e.transformation);U$c[0]=t.x,U$c[1]=t.y,U$c[2]=a;return Sn(t.spatialReference,U$c,u,r.spatialReference)?e.transformation=u:console.warn("Could not locate symbol object properly, it might be misplaced"),c}function E$l(e,n,o,r,i,s){let a=0;const l=s.spatialReference;n*=3,r*=3;for(let c=0;c<i;++c){const i=e[n+0],c=e[n+1],u=e[n+2],f=c$W(s.getElevation(i,c,u,l,"ground"),0);a+=f,o[r+0]=i,o[r+1]=c,o[r+2]=f,n+=3,r+=3;}return a/i}function h$u(e,n,o,r,i,s,a,l){let c=0;const u=l.calculateOffsetRenderUnits(a),f=l.featureExpressionInfoContext,m=s.spatialReference;n*=3,r*=3;for(let d=0;d<i;++d){const i=e[n+0],a=e[n+1],l=e[n+2],d=c$W(s.getElevation(i,a,l,m,"ground"),0);c+=d,o[r+0]=i,o[r+1]=a,o[r+2]=null==f?l+d+u:d+u,n+=3,r+=3;}return c/i}function y$v(e,n,o,r,i,s,a,l){let c=0;const u=l.calculateOffsetRenderUnits(a),f=l.featureExpressionInfoContext,m=s.spatialReference;n*=3,r*=3;for(let d=0;d<i;++d){const i=e[n+0],a=e[n+1],l=e[n+2],d=c$W(s.getElevation(i,a,l,m,"scene"),0);c+=d,o[r+0]=i,o[r+1]=a,o[r+2]=null==f?l+d+u:d+u,n+=3,r+=3;}return c/i}function A$h(e){const t=e.meterUnitOffset,n=e.featureExpressionInfoContext;return 0!==t||null!=n}function R$i(e,t,n,o,r,i,s,a){const l=a.calculateOffsetRenderUnits(s),c=a.featureExpressionInfoContext;t*=3,o*=3;for(let u=0;u<r;++u){const r=e[t+0],i=e[t+1],s=e[t+2];n[o+0]=r,n[o+1]=i,n[o+2]=null==c?s+l:l,t+=3,o+=3;}return 0}var T$j;!function(e){e[e.NONE=0]="NONE",e[e.UPDATE=1]="UPDATE",e[e.RECREATE=2]="RECREATE";}(T$j||(T$j={}));const j$q={"absolute-height":{applyElevationAlignmentBuffer:R$i,requiresAlignment:A$h},"on-the-ground":{applyElevationAlignmentBuffer:E$l,requiresAlignment:()=>!0},"relative-to-ground":{applyElevationAlignmentBuffer:h$u,requiresAlignment:()=>!0},"relative-to-scene":{applyElevationAlignmentBuffer:y$v,requiresAlignment:()=>!0}},x$v=e$P(),O$h={verticalDistanceToGround:0,sampledElevation:0},U$c=n$11();

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
function f$y(t,e,a,o){const s=t.stageObject,r=a.spatialReference,l=s.geometryRecords,f=l.length,E="absolute-height"!==e.mode;let u=0;for(let p=0;p<f;p++){const t=l[p].geometry,f=l[p].getShaderTransformation();A$g[0]=f[12],A$g[1]=f[13],A$g[2]=f[14],t.invalidateBoundingInfo();const I=t.getMutableAttribute("position"),b=I.data,g=t.vertexAttributes.get("mapPos").data,R=I.size,_=b.length/R,D=new t$X(g,r);let v=0,L=!1,j=0;for(let s=0;s<_;s++){h$t[0]=b[v],h$t[1]=b[v+1],h$t[2]=b[v+2];const t=m$A(D,a,e,o,E?S$p:null);if(E&&(j+=S$p.sampledElevation),T$k.DISABLE_ELEVATION_ALIGNERS_ITERATIVE_UPDATES?(b[v]=D.array[D.offset],b[v+1]=D.array[D.offset+1],b[v+2]=t,xn(b,r,v,b,o.spatialReference,v,1),b[v]-=A$g[0],b[v+1]-=A$g[1],b[v+2]-=A$g[2]):(T$i[0]=b[v]+A$g[0],T$i[1]=b[v+1]+A$g[1],T$i[2]=b[v+2]+A$g[2],o.setAltitude(T$i,t),b[v]=T$i[0]-A$g[0],b[v+1]=T$i[1]-A$g[1],b[v+2]=T$i[2]-A$g[2]),T$k.TESTS_DISABLE_UPDATE_THRESHOLDS)L=!0;else {const t=d$x/o.unitInMeters;(Math.abs(h$t[0]-b[v])>=t||Math.abs(h$t[1]-b[v+1])>=t||Math.abs(h$t[2]-b[v+2])>=t)&&(L=!0);}v+=R,D.offset+=3;}u+=j/_,L&&s.geometryVertexAttrsUpdated(p);}return u/f}function E$k(t,a,s,n){const m=t.stageObject,f=a.centerPointInElevationSR;let E=0,p=0;if(m.metadata.usesVerticalDistanceToGround)E=m$A(f,s,a,n,S$p),z$f(m,S$p.verticalDistanceToGround),p=S$p.sampledElevation;else {const t="absolute-height"!==a.mode;E=m$A(f,s,a,n,t?S$p:null),t&&(p=S$p.sampledElevation);}const A=n$18(u$B,m.transformation),h=o$S(b$n,A[12],A[13],A[14]);T$k.DISABLE_ELEVATION_ALIGNERS_ITERATIVE_UPDATES?(T$i[0]=f.x,T$i[1]=f.y,T$i[2]=E,Sn(f.spatialReference,T$i,A,n.spatialReference)&&(m.transformation=A)):n.setAltitudeOfTransformation(E,A);const I=d$x/n.unitInMeters;return (Math.abs(A[12]-h[0])>=I||Math.abs(A[13]-h[1])>=I||Math.abs(A[14]-h[2])>=I)&&(m.transformation=A),p}const u$B=e$P();function p$E(e,a,s,n){const l=e.graphics3DSymbolLayer.lodRenderer;if(t$17(l))return 0;const m=a.centerPointInElevationSR;let f=0,E=0;const u="absolute-height"!==a.mode;f=m$A(m,s,a,n,u?S$p:null),u&&(E=S$p.sampledElevation);const p=l.instanceData,A=e.instanceIndex,h=I$k;p.getGlobalTransform(A,h);const g=o$S(b$n,h[12],h[13],h[14]);T$k.DISABLE_ELEVATION_ALIGNERS_ITERATIVE_UPDATES?(T$i[0]=m.x,T$i[1]=m.y,T$i[2]=f,Sn(m.spatialReference,T$i,h,n.spatialReference)&&p.setGlobalTransform(A,h)):n.setAltitudeOfTransformation(f,h);const R=d$x/n.unitInMeters;return (T$k.TESTS_DISABLE_UPDATE_THRESHOLDS||Math.abs(h[12]-g[0])>=R||Math.abs(h[13]-g[1])>=R||Math.abs(h[14]-g[2])>=R)&&p.setGlobalTransform(A,h),E}const d$x=.01,T$i=n$11(),A$g=n$11(),h$t=n$11(),I$k=e$P(),b$n=n$11(),S$p={verticalDistanceToGround:0,sampledElevation:0};

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
const n$O=n$12.getLogger("esri.views.3d.layers.graphics.featureExpressionInfoUtils");function c$B(e){return {cachedResult:e.cachedResult,arcade:e.arcade?{func:e.arcade.func,context:e.arcade.modules.arcadeUtils.createExecContext(null,{sr:e.arcade.context.spatialReference}),modules:e.arcade.modules}:null}}function o$B(e){const t=e&&e.expression;if("string"==typeof t){const e=p$D(t);if(null!=e)return {cachedResult:e}}return null}async function a$D(e,t,n){const c=e&&e.expression;if("string"!=typeof c)return null;const o=p$D(c);if(null!=o)return {cachedResult:o};const a=await a$1b(),u=a.arcadeUtils,s=u.createSyntaxTree(c);return u.dependsOnView(s)?(null!=n&&n.error("Expressions containing '$view' are not supported on ElevationInfo"),{cachedResult:0}):{arcade:{func:u.createFunction(s),context:u.createExecContext(null,{sr:t}),modules:a}}}function u$A(e,t,r){return e.arcadeUtils.createFeature(t.attributes,t.geometry,r)}function s$B(e,r){if(null!=e&&!f$x(e)){if(!r||!e.arcade)return void n$O.errorOncePerTick("Arcade support required but not provided");const c=r;c._geometry&&(c._geometry=f$A(c._geometry)),e.arcade.modules.arcadeUtils.updateExecContext(e.arcade.context,r);}}function l$D(e){if(null!=e){if(f$x(e))return e.cachedResult;const t=e.arcade;let r=e.arcade.modules.arcadeUtils.executeFunction(t.func,t.context);return "number"!=typeof r&&(e.cachedResult=0,r=0),r}return 0}function i$q(e,t=!1){let r=e&&e.featureExpressionInfo;const n=r&&r.expression;return t||"0"===n||(r=null),r}const d$w={cachedResult:0};function f$x(e){return null!=e.cachedResult}function p$D(e){return "0"===e?0:null}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class h$s{constructor(){this._meterUnitOffset=0,this._renderUnitOffset=0,this._unit="meters",this._metersPerElevationInfoUnit=1,this._featureExpressionInfoContext=null,this.centerPointInElevationSR=null,this.mode=null;}get featureExpressionInfoContext(){return this._featureExpressionInfoContext}get meterUnitOffset(){return this._meterUnitOffset}get unit(){return this._unit}set unit(t){this._unit=t,this._metersPerElevationInfoUnit=r$1i(t);}reset(){this.mode=null,this._meterUnitOffset=0,this._renderUnitOffset=0,this._featureExpressionInfoContext=null,this.unit="meters";}set offsetMeters(t){this._meterUnitOffset=t,this._renderUnitOffset=0;}set offsetElevationInfoUnits(t){this._meterUnitOffset=t*this._metersPerElevationInfoUnit,this._renderUnitOffset=0;}addOffsetRenderUnits(t){this._renderUnitOffset+=t;}geometryZWithOffset(t,e){const n=this.calculateOffsetRenderUnits(e);return null!=this.featureExpressionInfoContext?n:t+n}calculateOffsetRenderUnits(t){let e=this._meterUnitOffset;const n=this.featureExpressionInfoContext;return null!=n&&(e+=l$D(n)*this._metersPerElevationInfoUnit),e/t.unitInMeters+this._renderUnitOffset}setFromElevationInfo(e){this.mode=e.mode,this.unit=n$1j(e.unit)?e.unit:"meters",this.offsetElevationInfoUnits=c$W(e.offset,0);}updateFeatureExpressionInfoContext(t,s,i){if(t$17(t))return void(this._featureExpressionInfoContext=null);const r=t&&t.arcade;r&&r$Y(s)&&r$Y(i)?(this._featureExpressionInfoContext=c$B(t),s$B(this._featureExpressionInfoContext,u$A(r.modules,s,i))):this._featureExpressionInfoContext=t;}static fromElevationInfo(t){const e=new h$s;return r$Y(t)&&e.setFromElevationInfo(t),e}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class m$z{constructor(e,t,s,i,a,n,r,o=null){this.graphics3DSymbolLayer=e,this.stageObject=t,this._uniqueGeometries=s,this._uniqueMaterials=i,this._uniqueTextures=a,this.elevationAligner=n,this.elevationContext=r,this._edgeState=o,this.type="object3d",this.stageLayer=null,this.stage=null,this._visible=!1,this._addedToStage=!1,this.alignedSampledElevation=0,this.needsElevationUpdates=!1,this.useObjectOriginAsAttachmentOrigin=!1,this.graphics3DSymbolLayer=e,this.stageObject=t;}get isElevationSource(){return !(!this.stageObject.metadata||!this.stageObject.metadata.isElevationSource)}initialize(e,t){this.stageLayer=t,this.stage=e,e.addMany(this._uniqueMaterials),e.addMany(this._uniqueGeometries),e.addMany(this._uniqueTextures),e.add(this.stageObject);}destroy(){const e=this.stage;this.stageLayer&&(e.removeMany(this._uniqueMaterials),e.removeMany(this._uniqueGeometries),e.removeMany(this._uniqueTextures)),e.remove(this.stageObject),this._addedToStage&&(this.stageLayer.remove(this.stageObject),this._addedToStage=!1);const t=this.stage.renderView.ensureEdgeView();t.hasObject(this.stageObject)&&t.removeObject(this.stageObject),this.stageObject.dispose(),this._visible=!1,this.stageLayer=null,this.stage=null;}layerOpacityChanged(t,s){if(t$17(this._edgeState))return;const i=p$C(this._edgeState.baseMaterial);let a=!1;for(const e of this._edgeState.edgeMaterials)e.objectTransparency!==i&&(e.objectTransparency=i,a=!0);a&&this.resetEdgeObject(s);this.stage.renderView.ensureEdgeView().updateAllComponentOpacities(this.stageObject,[t]);}slicePlaneEnabledChanged(t,s){if(t$17(this._edgeState))return;this.stage.renderView.ensureEdgeView().updateAllComponentMaterials(this.stageObject,this._edgeState.edgeMaterials,{slicePlaneEnabled:t},!s),this._edgeState.properties.slicePlaneEnabled=t;}setVisibility(e){if(null!=this.stage&&this._visible!==e&&(this._visible=e,this._visible?this._addedToStage?this.stageObject.setVisible(!0):(this.stageLayer.add(this.stageObject),this._addedToStage=!0):this.stageObject.setVisible(!1),r$Y(this._edgeState))){const t=this.stage.renderView.ensureEdgeView();t.hasObject(this.stageObject)?t.updateObjectVisibility(this.stageObject,e):e&&this.addOrUpdateEdgeObject(t,!1);}}get visible(){return this._visible}alignWithElevation(e,s,i,a){if(null==this.elevationAligner)return;r$Y(i)&&s$B(this.elevationContext.featureExpressionInfoContext,i);const n=this.elevationAligner(this,this.elevationContext,e,s);null!=n&&(this.alignedSampledElevation=n),this.resetEdgeObject(a);}getCenterObjectSpace(e=n$11()){return r$Z(e,O$z(this.stageObject.boundingVolumeObjectSpace.bounds))}getBoundingBoxObjectSpace(e=a$1c()){const t=this.stageObject.boundingVolumeObjectSpace;return q$r(e,t.min),w$E(e,t.max),e}computeAttachmentOrigin(e){if(this.useObjectOriginAsAttachmentOrigin){const t=this.stageObject.transformation;e.render.origin[0]+=t[12],e.render.origin[1]+=t[13],e.render.origin[2]+=t[14],e.render.num++;}else for(const t of this.stageObject.geometryRecords)t.computeAttachmentOrigin(y$u)&&(I$x(y$u,y$u,this.stageObject.transformation),u$S(e.render.origin,e.render.origin,y$u),e.render.num++);}async getProjectedBoundingBox(e,t,i,n,r){const o=this.getBoundingBoxObjectSpace(r),c=S$o,h=S$D(o)?1:c.length;for(let s=0;s<h;s++){const e=c[s];f$w[0]=o[e[0]],f$w[1]=o[e[1]],f$w[2]=o[e[2]],I$x(f$w,f$w,this.stageObject.transformation),v$t[3*s+0]=f$w[0],v$t[3*s+1]=f$w[1],v$t[3*s+2]=f$w[2];}if(!e(v$t,0,h))return null;B$n(o);let b=null;this.calculateRelativeScreenBounds&&(b=this.calculateRelativeScreenBounds());for(let s=0;s<3*h;s+=3){for(let e=0;e<3;e++)o[e]=Math.min(o[e],v$t[s+e]),o[e+3]=Math.max(o[e+3],v$t[s+e]);b&&i.push({location:v$t.slice(s,s+3),screenSpaceBoundingRect:b});}if(t&&t.service&&"absolute-height"!==this.elevationContext.mode){p$1a(o,y$u);const e="relative-to-scene"===this.elevationContext.mode?"scene":"ground";let i=0;if(t.useViewElevation)i=c$W(t.service.getElevation(y$u[0],y$u[1],e),0);else try{const a=Z$9(o,t);i=c$W(await t.service.queryElevation(y$u[0],y$u[1],n,a,e),0);}catch(O){}V$o(o,0,0,-this.alignedSampledElevation+i);}return o}addObjectState(e,t){0===e&&t.addObject(this.stageObject,this.stageObject.highlight()),1===e&&t.addObject(this.stageObject,this.stageObject.maskOccludee());}removeObjectState(e){e.removeObject(this.stageObject);}resetEdgeObject(t){if(t$17(this._edgeState))return;const s=this.stage.renderView.ensureEdgeView();this._visible?this.addOrUpdateEdgeObject(s,t):s.removeObject(this.stageObject);}addOrUpdateEdgeObject(t,s){const i=this._edgeState;if(t$17(i))return;const a=p$C(i.baseMaterial);for(const e of i.edgeMaterials)e.objectTransparency=a;t.addOrUpdateObject3D(this.stageObject,i.edgeMaterials,i.properties,!s).then((()=>{var e;return null==(e=this.stageLayer)?void 0:e.sync()}));}}function p$C(e){return e.isVisible?e.params.transparent?1:2:0}const v$t=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],f$w=n$11(),y$u=n$11(),S$o=[[0,1,2],[3,1,2],[0,4,2],[3,4,2],[0,1,5],[3,1,5],[0,4,5],[3,4,5]];

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class l$C{constructor(t){this.schedule=t,this._abortController=null,this._loadStatus=0,this._loadError=null,this._loader=null,this.logger=null;}get loadStatus(){return this._loadStatus}load(l,r){return 1===this._loadStatus?(l&&l(),this._loader):2===this._loadStatus?(r&&r(this._loadError),this._loader):(this._loader||(this._abortController=h$N(),this._loader=this.doLoad(this._abortController.signal).then((()=>{this._abortController=null,this._loadStatus=1;}),(t=>{throw this._loadError=t,this._abortController=null,this._loadStatus=2,!g$T(t)&&this.logger&&t.message&&this.logger.warn(t.message),t}))),this._loader.then(l,r).catch((()=>{})),this._loader)}abortLoad(){this._abortController?(this._abortController.abort(),this._abortController=null):0===this._loadStatus&&(this._loadStatus=2),this._loader=null;}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
function n$N(e){switch(e){case"sphere":case"cube":case"diamond":case"cylinder":case"cone":case"inverted-cone":case"tetrahedron":return !0}return !1}function t$I(n,t){const r=(n,a,r=!1)=>({levels:n.map((n=>{const c=a(n.tesselation);return r&&P$w.cgToGIS(c),{components:[{geometry:c,material:t}],faceCount:c.indexCount/3,minScreenSpaceRadius:n.minScreenSpaceRadius}}))});switch(n){case"sphere":return r([{tesselation:0,minScreenSpaceRadius:0},{tesselation:1,minScreenSpaceRadius:8},{tesselation:2,minScreenSpaceRadius:16},{tesselation:3,minScreenSpaceRadius:50},{tesselation:4,minScreenSpaceRadius:250}],(n=>P$w.createPolySphereGeometry(.5,n,!0)));case"cube":return r([{tesselation:0,minScreenSpaceRadius:0}],(()=>P$w.createBoxGeometry(1)));case"cone":return r(a$C,(n=>P$w.createConeGeometry(1,.5,n,!1)),!0);case"inverted-cone":return r(a$C,(n=>P$w.createConeGeometry(1,.5,n,!0)),!0);case"cylinder":return r(a$C,(n=>P$w.createCylinderGeometry(1,.5,n,[0,0,1],[0,0,.5])));case"tetrahedron":return r([{tesselation:0,minScreenSpaceRadius:0}],(()=>P$w.createTetrahedronGeometry(1)),!0);case"diamond":return r([{tesselation:0,minScreenSpaceRadius:0}],(()=>P$w.createDiamondGeometry(1)),!0);default:return}}const a$C=[{tesselation:6,minScreenSpaceRadius:0},{tesselation:18,minScreenSpaceRadius:7},{tesselation:64,minScreenSpaceRadius:65}];

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
function t$H(t){return "fill"===t.type}function e$B(t){return "extrude"===t.type}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
function l$B(e){return e&&e.enabled&&(e$B(e)||t$H(e))&&r$Y(e.edges)}function u$z(e){return e&&e.enabled&&e.edges||null}function a$B(e,n){return f$v(u$z(e),n)}function f$v(c,i){if(t$17(c))return null;const l=r$Y(c.color)?e$W(o$W.toUnitRGBA(c.color)):r$19(0,0,0,0),u=u$_(c.size),a=u$_(c.extensionLength);switch(c.type){case"solid":return p$B({color:l,size:u,extensionLength:a,...i});case"sketch":return m$y({color:l,size:u,extensionLength:a,...i});default:return}}function p$B(e){return {...h$r,...e,type:"solid"}}function m$y(e){return {...y$t,...e,type:"sketch"}}const h$r={color:r$19(0,0,0,.2),size:1,extensionLength:0,opacity:1,objectTransparency:2},y$t={color:r$19(0,0,0,.2),size:1,extensionLength:0,opacity:1,objectTransparency:2};

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
function e$A(e){const n=[];return e.levels.forEach((o=>{o.components.forEach((o=>{n.push(o.material);}));})),i$Z(n)}function n$M(e){const n=[];return e.levels.forEach((o=>{o.components.forEach((o=>{o.textures&&n.push(...o.textures);}));})),i$Z(n)}function r$G(e){const n=[];return e.components.forEach((o=>{n.push(o.geometry);})),i$Z(n)}function t$G(e){const n=[];return e.levels.forEach((o=>{o.components.forEach((o=>{n.push(o.geometry);}));})),i$Z(n)}function c$A(o){return r$G(o).reduce(((o,e)=>o+e.indexCount/3),0)}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
const u$y={primitivesPerFeature:0,primitivesPerCoordinate:0,drawCallsPerFeature:0,estimated:!0,memory:{bytesPerFeature:0,bytesPerCoordinate:0,bytesPerFeatureLabel:0,draped:{bytesPerFeature:0,bytesPerFeatureLabel:0,bytesPerCoordinate:0}}};function b$m(e){if("web-style"===e.type)return u$y;return P$k(e.symbolLayers.toArray().map((r=>n$L(e,r))))}function P$k(e){let t=0,a=0,s=0,i=!1,o=0;const u={bytesPerFeature:0,bytesPerFeatureLabel:0,bytesPerCoordinate:0,draped:{bytesPerFeature:0,bytesPerFeatureLabel:0,bytesPerCoordinate:0}};for(const b of e)t$17(b)||(t+=b.primitivesPerFeature,a+=b.primitivesPerCoordinate,s+=b.drawCallsPerFeature,u.bytesPerFeature+=b.memory.bytesPerFeature,u.bytesPerFeatureLabel+=b.memory.bytesPerFeatureLabel,u.bytesPerCoordinate+=b.memory.bytesPerCoordinate,u.draped.bytesPerFeature+=b.memory.bytesPerFeature,u.draped.bytesPerFeatureLabel+=b.memory.bytesPerFeatureLabel,u.draped.bytesPerCoordinate+=b.memory.bytesPerCoordinate,i=i||b.estimated,++o);return {primitivesPerFeature:t,primitivesPerCoordinate:a,drawCallsPerFeature:s,estimated:i,memory:u,numComplexities:o}}function d$v(e){const r=P$k(e);return r.numComplexities>0&&(r.primitivesPerFeature/=r.numComplexities,r.primitivesPerCoordinate/=r.numComplexities,r.drawCallsPerFeature/=r.numComplexities,r.memory.bytesPerFeature/=r.numComplexities,r.memory.bytesPerFeatureLabel/=r.numComplexities,r.memory.bytesPerCoordinate/=r.numComplexities,r.memory.draped.bytesPerFeature/=r.numComplexities,r.memory.draped.bytesPerFeatureLabel/=r.numComplexities,r.memory.draped.bytesPerCoordinate/=r.numComplexities),r}const y$s={};function n$L(r,s){const o=m$x(r,s),u=l$B(s)?2:0;switch(s.type){case"extrude":return {primitivesPerFeature:-4,primitivesPerCoordinate:4,drawCallsPerFeature:u,estimated:!1,memory:o};case"fill":return "mesh-3d"===r.type?{primitivesPerFeature:0,primitivesPerCoordinate:0,drawCallsPerFeature:u,estimated:!1,memory:o}:r$Y(s.outline)&&s.outline.size>0?{primitivesPerFeature:-4,primitivesPerCoordinate:3,drawCallsPerFeature:0,estimated:!1,memory:o}:{primitivesPerFeature:-2,primitivesPerCoordinate:1,drawCallsPerFeature:0,estimated:!1,memory:o};case"water":return {primitivesPerFeature:-2,primitivesPerCoordinate:1,drawCallsPerFeature:0,estimated:!1,memory:o};case"line":return {primitivesPerFeature:-2,primitivesPerCoordinate:2,drawCallsPerFeature:0,estimated:!1,memory:o};case"object":if(s.resource&&s.resource.href)return {primitivesPerFeature:16,primitivesPerCoordinate:0,drawCallsPerFeature:0,estimated:!0,memory:o};return {...l$A(s.resource&&s.resource.primitive||d$10),memory:o};case"path":{const r=3,t=3,a=10;let i=0,u=0;switch(s.profile){case"circle":i=a;break;case"quad":i=4;break;default:return void n$1d(s.profile)}switch(s.join){case"round":u=r;break;case"miter":case"bevel":u=1;break;default:return void n$1d(s.join)}const b=2*i,P=i*u*2;let d=-2*P-b;switch(s.cap){case"none":break;case"butt":case"square":d+=2*(i-1);break;case"round":d+=2*(i*(t-1)*2+i);break;default:return}return {primitivesPerFeature:d,primitivesPerCoordinate:P+b,drawCallsPerFeature:0,estimated:!1,memory:o}}case"text":case"icon":return {primitivesPerFeature:2,primitivesPerCoordinate:0,drawCallsPerFeature:0,estimated:!1,memory:o};default:return}}function m$x(r,a){const s="point-3d"===r.type;switch(a.type){case"extrude":return a.edges&&a.edges.size>0?F$k.EXTRUDE_EDGES:F$k.EXTRUDE;case"fill":return r$Y(a.outline)&&a.outline.size>0?F$k.FILL_OUTLINE:F$k.FILL;case"water":return F$k.FILL;case"line":return "round"===a.join?F$k.LINE_ROUND:F$k.LINE_MITER;case"path":switch(a.join){case"round":switch(a.profile){case"circle":return F$k.PATH_ROUND_CIRCLE;case"quad":return F$k.PATH_ROUND_QUAD;default:return void n$1d(a.profile)}case"miter":case"bevel":switch(a.profile){case"circle":return F$k.PATH_MITER_CIRCLE;case"quad":return F$k.PATH_MITER_QUAD;default:return void n$1d(a.profile)}default:return void n$1d(a.join)}case"object":return s?F$k.OBJECT_POINT:F$k.OBJECT_POLYGON;case"icon":case"text":return s?F$k.ICON_POINT:F$k.ICON_POLYGON;default:return}}function l$A(e){let r=y$s[e];if(r)return r;const t=t$I(e,null);return r={primitivesPerFeature:r$G(t.levels[0]).reduce(((e,r)=>e+r.indices.get("position").length/3),0),primitivesPerCoordinate:0,drawCallsPerFeature:0,estimated:!1},y$s[e]=r,r}const F$k={ICON_POINT:{bytesPerFeature:7127.413186968842,bytesPerFeatureLabel:4826.302896296296,bytesPerCoordinate:0,draped:{bytesPerFeature:3929.4396628895197,bytesPerFeatureLabel:3550.1332222222227,bytesPerCoordinate:0}},ICON_POLYGON:{bytesPerFeature:9329.452613976147,bytesPerFeatureLabel:3675.3372604938268,bytesPerCoordinate:60.177252982212096,draped:{bytesPerFeature:6190.247450139383,bytesPerFeatureLabel:3744.074358024691,bytesPerCoordinate:59.488211068026104}},OBJECT_POINT:{bytesPerFeature:2350.5884192634558,bytesPerFeatureLabel:4446.651003703703,bytesPerCoordinate:0,draped:{bytesPerFeature:2350.5884192634558,bytesPerFeatureLabel:4446.651003703703,bytesPerCoordinate:0}},OBJECT_POLYGON:{bytesPerFeature:4583.807620302299,bytesPerFeatureLabel:3665.342685185186,bytesPerCoordinate:60.11621818101506,draped:{bytesPerFeature:4583.807620302299,bytesPerFeatureLabel:3665.342685185186,bytesPerCoordinate:60.11621818101506}},LINE_MITER:{bytesPerFeature:7321.028181375921,bytesPerFeatureLabel:4048.0226716049388,bytesPerCoordinate:186.55621386363578,draped:{bytesPerFeature:4246.856619435009,bytesPerFeatureLabel:3852.3737679012347,bytesPerCoordinate:163.47884002621583}},LINE_ROUND:{bytesPerFeature:7482.205842738954,bytesPerFeatureLabel:4045.886987654321,bytesPerCoordinate:191.5452524171851,draped:{bytesPerFeature:4473.481387957992,bytesPerFeatureLabel:3842.1112395061728,bytesPerCoordinate:167.27703460226945}},PATH_MITER_CIRCLE:{bytesPerFeature:9010.489006415351,bytesPerFeatureLabel:4230.9109,bytesPerCoordinate:4618.2594178027275,draped:{bytesPerFeature:9010.489006415351,bytesPerFeatureLabel:4230.9109,bytesPerCoordinate:4618.2594178027275}},PATH_ROUND_CIRCLE:{bytesPerFeature:4104.727250200398,bytesPerFeatureLabel:4251.8525,bytesPerCoordinate:8019.043777064957,draped:{bytesPerFeature:4104.727250200398,bytesPerFeatureLabel:4251.8525,bytesPerCoordinate:8019.043777064957}},PATH_MITER_QUAD:{bytesPerFeature:9416.372942261387,bytesPerFeatureLabel:4241.2757,bytesPerCoordinate:3176.7222742582203,draped:{bytesPerFeature:9416.372942261387,bytesPerFeatureLabel:4241.2757,bytesPerCoordinate:3176.7222742582203}},PATH_ROUND_QUAD:{bytesPerFeature:6614.431545308682,bytesPerFeatureLabel:4206.7461,bytesPerCoordinate:5141.817789093826,draped:{bytesPerFeature:6614.431545308682,bytesPerFeatureLabel:4206.7461,bytesPerCoordinate:5141.817789093826}},FILL:{bytesPerFeature:9478.244183633637,bytesPerFeatureLabel:3713.816824691358,bytesPerCoordinate:95.9343604185578,draped:{bytesPerFeature:6287.911108168086,bytesPerFeatureLabel:3790.785032098766,bytesPerCoordinate:83.08783220478168}},FILL_OUTLINE:{bytesPerFeature:13085.871870349445,bytesPerFeatureLabel:3392.613241975309,bytesPerCoordinate:118.63968023169875,draped:{bytesPerFeature:8437.199992480122,bytesPerFeatureLabel:3973.5431172839503,bytesPerCoordinate:106.33556817014312}},EXTRUDE:{bytesPerFeature:19459.53727140414,bytesPerFeatureLabel:3743.7045209876546,bytesPerCoordinate:372.6819978900477,draped:{bytesPerFeature:19459.53727140414,bytesPerFeatureLabel:3743.7045209876546,bytesPerCoordinate:372.6819978900477}},EXTRUDE_EDGES:{bytesPerFeature:22266.888534913724,bytesPerFeatureLabel:3064.3193358024696,bytesPerCoordinate:374.3725221561312,draped:{bytesPerFeature:22266.888534913724,bytesPerFeatureLabel:3064.3193358024696,bytesPerCoordinate:374.3725221561312}}};

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
const f$u=n$12.getLogger("esri.views.3d.layers.graphics.Graphics3DSymbolLayer");class y$r extends l$C{constructor(e,t,o,i){super(o.schedule),this._context=o,this._elevationInfoOverride=null,this.complexity=null,this.logger=f$u,this._elevationOptions={supportsOffsetAdjustment:!1,supportsOnTheGround:!0},this.symbol=e,this.symbolLayer=t,this._renderPriority=i.renderPriority,this._renderPriorityStep=i.renderPriorityStep,this._elevationContext=new h$s,this.complexity=this.computeComplexity(),this._updateDrivenProperties(i.ignoreDrivers),this._updateElevationContext();}getCachedSize(){return null}get extentPadding(){return 0}get needsDrivenTransparentPass(){return this._drivenProperties.opacity&&!this._drivenProperties.opacityAlwaysOpaque}_logGeometryCreationWarnings(e,t,o,i){const r=e.projectionSuccess,n="polygons"in e?e.polygons:null,s=`${i} geometry failed to be created`;let a=null;r?!t.length||1===t.length&&!t[0].length?a=`${s} (no ${o} were defined)`:Array.isArray(t)&&Array.isArray(t[0])?n&&0===n.length&&"rings"===o&&t.length>0&&t[0].length>2&&(a=`${s} (filled rings should use clockwise winding - try reversing the order of vertices)`):a=`${s} (${o} should be defined as a 2D array)`:a=`${s} (failed to project geometry to view spatial reference)`,a&&f$u.warnOncePerTick(a);}_validateGeometry(e,t=null,r=null){if(r$Y(t)&&!t.includes(e.type))return this.logger.warn("unsupported geometry type for "+r+` symbol: ${e.type}`),!1;if("point"===e.type){const t=e;if(!u$Z(t.x)||!u$Z(t.y))return f$u.warn("point coordinate is not a valid number, graphic skipped"),!1}return !0}_defaultElevationInfoNoZ(){return m$w}_defaultElevationInfoZ(){return g$z}_updateElevationContext(){r$Y(this._elevationInfoOverride)?(this._elevationContext.setFromElevationInfo(this._elevationInfoOverride),this._elevationContext.updateFeatureExpressionInfoContext(null)):this._context.layer.elevationInfo?(this._elevationContext.setFromElevationInfo(this._context.layer.elevationInfo),this._elevationContext.updateFeatureExpressionInfoContext(this._context.featureExpressionInfoContext)):this._elevationContext.reset();}getDefaultElevationInfo(e){return e.hasZ?this._defaultElevationInfoZ():this._defaultElevationInfoNoZ()}getGeometryElevationMode(e,t=this.getDefaultElevationInfo(e)){return this._elevationContext.mode||t.mode}setElevationInfoOverride(e){this._elevationInfoOverride=e,this._updateElevationContext();}setGraphicElevationContext(e,t){const o=e$12(e.geometry),i=this.getDefaultElevationInfo(o);t.unit=null!=this._elevationContext.unit?this._elevationContext.unit:i.unit,t.mode=this.getGeometryElevationMode(o,i),t.offsetMeters=c$W(this._elevationContext.meterUnitOffset,c$W(i.offset,0));const s=!this._elevationOptions.supportsOnTheGround&&"on-the-ground"===t.mode;s&&(t.mode="relative-to-ground",t.offsetMeters=0);const a=s?d$w:this._elevationContext.featureExpressionInfoContext;return t.updateFeatureExpressionInfoContext(a,e,this._context.layer),t}prepareSymbolLayerPatch(e){}updateGeometry(e,t){return !1}onRemoveGraphic(e){}_updateDrivenProperties(e){const t={color:!1,opacity:!1,opacityAlwaysOpaque:!0,size:!1};if(e)return void(this._drivenProperties=t);const o=this._context.renderer;o&&"visualVariables"in o&&o.visualVariables&&o.visualVariables.forEach((e=>{switch(e.type){case"color":if(t.color=!0,e.stops)for(let o=0;o<e.stops.length;o++){const i=e.stops[o].color;i&&(t.opacity=!0,i.a<1&&(t.opacityAlwaysOpaque=!1));}break;case"opacity":t.opacity=!0,t.opacityAlwaysOpaque=!1;break;case"size":t.size=!0;}})),this._drivenProperties=t;}_getLayerOpacity(){if(this._context.layerView&&"fullOpacity"in this._context.layerView)return this._context.layerView.fullOpacity;const e=this._context.layer.opacity;return null==e?1:e}_getCombinedOpacity(e,t=_$h){let o=1;return this.draped||(o*=this._getLayerOpacity()),this._drivenProperties.opacity||(r$Y(e)?o*=e.a:t.hasIntrinsicColor||(o=0)),o}_getCombinedOpacityAndColor(t,o=_$h){const r=this._getCombinedOpacity(t,o);if(this._drivenProperties.color)return B$c(null,r);const n=r$Y(t)?o$W.toUnitRGB(t):l$14;return B$c(n,r)}_getVertexOpacityAndColor(e,t=null){const o=this._drivenProperties.color?e.color:null,r=this._drivenProperties.opacity?e.opacity:null,n=B$c(o,r);return r$Y(t)&&(n[0]*=t,n[1]*=t,n[2]*=t,n[3]*=t),n}isFastUpdatesEnabled(){return this._fastUpdates&&this._fastUpdates.enabled}computeComplexity(){return n$L(this.symbol,this.symbolLayer)}destroy(){this.abortLoad();}globalPropertyChanged(e,t,o){switch(e){case"opacity":return this.layerOpacityChanged(t,o);case"elevationInfo":{const e=this._elevationContext.mode;this._updateElevationContext();return this.layerElevationInfoChanged(t,o,e)!==T$j.RECREATE}case"slicePlaneEnabled":return this.slicePlaneEnabledChanged(t,o);case"physicalBasedRenderingEnabled":return this.physicalBasedRenderingChanged();case"pixelRatio":return this.pixelRatioChanged();default:return !1}}updateGraphics3DGraphicElevationInfo(e,t,o){let r=T$j.UPDATE;return e.forEach((e=>{const n=t(e);if(r$Y(n)){const t=e.graphic;this.setGraphicElevationContext(t,n.elevationContext),n.needsElevationUpdates=o(n.elevationContext.mode);}else r=T$j.RECREATE;})),r}applyRendererDiff(e,t){return !1}getFastUpdateAttrValues(e){if(!this._fastUpdates.enabled)return null;const t=this._fastUpdates.visualVariables,o=t.size?v$s(t.size.field,e):0,i=t.color?v$s(t.color.field,e):0,r=t.opacity?v$s(t.opacity.field,e):0;return r$19(o,i,r,0)}get draped(){return this._draped}ensureDrapedStatus(e){return null==this._draped?(this._draped=e,!0):(e!==this.draped&&f$u.warnOnce("A symbol can only produce either draped or non-draped visualizations. Use two separate symbol instances for draped and non-draped graphics if necessary."),!1)}}function v$s(e,t){const o=null!=e?t.attributes[e]:0;return null!=o&&isFinite(o)?o:0}const m$w={mode:"on-the-ground",offset:0,unit:"meters"},g$z={mode:"absolute-height",offset:0,unit:"meters"},_$h={hasIntrinsicColor:!1};

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
const u$x=n$11();function f$t(r,i,s,a,l,p,f,g,d,h){const j=s?s.length:0,y=r.clippingExtent;if(Rn(i,u$x,r.elevationProvider.spatialReference),r$Y(y)&&!E$y(y,u$x))return null;const v=r.renderCoordsHelper.spatialReference;Rn(i,u$x,v);const w=r.localOriginFactory.getOrigin(u$x),b=new R$p({castShadow:!1,metadata:{layerUid:g,graphicUid:d,usesVerticalDistanceToGround:!0}});for(let e=0;e<j;e++){const r=l?l[e]:a$10;b.addGeometry(s[e],a[e],r,p,w,h);}return {object:b,sampledElevation:v$u(b,i,r.elevationProvider,r.renderCoordsHelper,f)}}function g$y(e,t,r){const n=e.elevationContext,i=r.spatialReference;Rn(t,u$x,i),n.centerPointInElevationSR=v$O(u$x[0],u$x[1],t.hasZ?u$x[2]:0,i);}function d$u(e){switch(e.type){case"point":return e;case"polygon":case"extent":return R$j(e);case"polyline":{const t=e.paths[0];if(!t||0===t.length)return null;const r=l$12(t,s$Z(t)/2);return v$O(r[0],r[1],r[2],e.spatialReference)}case"mesh":return e.origin}return null}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
function l$z(l){const a=new n$15;return a.include(c$M),a.include(o$E,l),a.include(c$$,l),a.attributes.add("uv0","vec2"),a.vertex.uniforms.add("lineSize","float").add("pixelToNDC","vec2").add("borderSize","float").add("screenOffset","vec2"),a.varyings.add("coverageSampling","vec4"),a.varyings.add("lineSizes","vec2"),l.multipassGeometryEnabled&&a.varyings.add("depth","float"),a.vertex.code.add(t$10`
    void main(void) {
      ProjectHUDAux projectAux;
      vec4 endPoint = projectPositionHUD(projectAux);

      vec3 vpos = projectAux.posModel;
      if (rejectBySlice(vpos)) {
        gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
        return;
      }
    ${l.occlusionTestEnabled?t$10`
      if (!testVisibilityHUD(endPoint)) {
        gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
        return;
      }`:""}

    ${l.screenSizePerspectiveEnabled?t$10`
      vec4 perspectiveFactor = screenSizePerspectiveScaleFactor(projectAux.absCosAngle, projectAux.distanceToCamera, screenSizePerspectiveAlignment);
      vec2 screenOffsetScaled = applyScreenSizePerspectiveScaleFactorVec2(screenOffset, perspectiveFactor);
        `:t$10`
      vec2 screenOffsetScaled = screenOffset;
        `}
      // Add view dependent polygon offset to get exact same original starting point. This is mostly
      // used to get the correct depth value
      vec3 posView = (view * vec4(position, 1.0)).xyz;
      ${l.multipassGeometryEnabled?"depth = posView.z;":""}

      applyHUDViewDependentPolygonOffset(auxpos1.w, projectAux.absCosAngle, posView);
      vec4 startPoint = proj * vec4(posView, 1.0);
      // Apply screen offset to both start and end point
      vec2 screenOffsetNorm = screenOffsetScaled * 2.0 / viewport.zw;
      startPoint.xy += screenOffsetNorm * startPoint.w;
      endPoint.xy += screenOffsetNorm * endPoint.w;
      // Align start and end to pixel origin
      vec4 startAligned = alignToPixelOrigin(startPoint, viewport.zw);
      vec4 endAligned = alignToPixelOrigin(endPoint, viewport.zw);
    ${l.depthHudEnabled?l.depthHudAlignStartEnabled?t$10`endAligned = vec4(endAligned.xy / endAligned.w * startAligned.w, startAligned.zw);`:t$10`startAligned = vec4(startAligned.xy / startAligned.w * endAligned.w, endAligned.zw);`:""}
      vec4 projectedPosition = mix(startAligned, endAligned, uv0.y);
      // The direction of the line in screen space
      vec2 screenSpaceDirection = normalize(endAligned.xy / endAligned.w - startAligned.xy / startAligned.w);
      vec2 perpendicularScreenSpaceDirection = vec2(screenSpaceDirection.y, -screenSpaceDirection.x);
    ${l.screenSizePerspectiveEnabled?t$10`
      float lineSizeScaled = applyScreenSizePerspectiveScaleFactorFloat(lineSize, perspectiveFactor);
      float borderSizeScaled = applyScreenSizePerspectiveScaleFactorFloat(borderSize, perspectiveFactor);
        `:t$10`
      float lineSizeScaled = lineSize;
      float borderSizeScaled = borderSize;
        `}
      float halfPixelSize = lineSizeScaled * 0.5;
      // Calculate a pixel offset from the edge of the pixel, s.t. we keep the line aligned
      // to pixels if it has a full pixel size. Since pixel aligned biases to the bottom-left,
      // we bias the size to the right (for odd sizes) to balance out the bias. Grow sub-pixel
      // sizes towards the left or right s.t. there is a smooth transition (e.g. from 2 to 3 px).
      float halfWholePixelSize = floor(lineSizeScaled) * 0.5;
      float halfPixelSizeInt = floor(halfWholePixelSize);

      // Sub-pixel offset if we need to grow sub-pixels to the left
      float subpixelOffset = -fract(lineSizeScaled) * float(halfWholePixelSize > 0.0);

      // Pixel offset aligning to whole pixels and adding subpixel offset if needed
      float pixelOffset = -halfPixelSizeInt + subpixelOffset;

      // Compute full ndc offset, adding 1px padding for doing anti-aliasing and the border size
      float padding = 1.0 + borderSizeScaled;
      vec2 ndcOffset = (pixelOffset - padding + uv0.x * (lineSizeScaled + padding + padding)) * pixelToNDC;

      // Offset x/y from the center of the line in screen space
      projectedPosition.xy += perpendicularScreenSpaceDirection * ndcOffset * projectedPosition.w;

      // Compute a coverage varying which we can use in the fragment shader to determine
      // how much a pixel is actually covered by the line (i.e. to anti alias the line).
      // This works by computing two coordinates that can be linearly interpolated and then
      // subtracted to find out how far away from the line edge we are.
      float edgeDirection = (uv0.x * 2.0 - 1.0);

      float halfBorderSize = 0.5 * borderSizeScaled;
      float halfPixelSizeAndBorder = halfPixelSize + halfBorderSize;
      float outerEdgeCoverageSampler = edgeDirection * (halfPixelSizeAndBorder + halfBorderSize + 1.0);

      float isOneSided = float(lineSizeScaled < 2.0 && borderSize < 2.0);

      coverageSampling = vec4(
        // Edge coordinate
        outerEdgeCoverageSampler,

        // Border edge coordinate
        outerEdgeCoverageSampler - halfPixelSizeAndBorder * isOneSided,

        // Line offset
        halfPixelSize - 0.5,

        // Border offset
        halfBorderSize - 0.5 + halfPixelSizeAndBorder * (1.0 - isOneSided)
      );

      lineSizes = vec2(lineSizeScaled, borderSizeScaled);

      gl_Position = projectedPosition;
    }
  `),a.fragment.uniforms.add("color","vec4"),a.fragment.uniforms.add("borderColor","vec4"),l.multipassGeometryEnabled&&(a.fragment.include(r$H,l),a.fragment.uniforms.add("inverseViewport","vec2")),a.fragment.code.add(t$10`
    void main() {
      ${l.multipassGeometryEnabled?"if( geometryDepthTest(gl_FragCoord.xy * inverseViewport, depth) ){ discard; }":""}

      // Mix between line and border coverage offsets depending on whether we need
      // a border (based on the sidedness).
      vec2 coverage = min(1.0 - clamp(abs(coverageSampling.xy) - coverageSampling.zw, 0.0, 1.0), lineSizes);

      // Mix between border and line color based on the line coverage (conceptually the line
      // blends on top of the border background).
      //
      // Anti-alias by blending final result using the full (including optional border) coverage
      // and the color alpha
      float borderAlpha = color.a * borderColor.a * coverage.y;
      float colorAlpha = color.a * coverage.x;

      float finalAlpha = mix(borderAlpha, 1.0, colorAlpha);

    ${l.depthHudEnabled?t$10`
      if (finalAlpha < 0.01) {
        discard;
      }
      `:t$10`
      // Compute the finalRgb, but keep it pre-multiplied (for unpre-multiplied you
      // need to divide by finalAlpha). We avoid the division here by setting the
      // appropriate blending function in the material.
      vec3 finalRgb = mix(borderColor.rgb * borderAlpha, color.rgb, colorAlpha);
      gl_FragColor = vec4(finalRgb, finalAlpha);
      `}
  }
  `),a}var a$A;function d$t(e,i,o){3===o.length?e.setUniform4f(i,o[0],o[1],o[2],1):e.setUniform4fv(i,o);}!function(e){function i(e,i,o){d$t(e,"color",i.color),e.setUniform1f("pixelRatio",o),e.setUniform2f("screenOffset",i.screenOffset[0]*o,i.screenOffset[1]*o),null!==i.borderColor?(d$t(e,"borderColor",i.borderColor),e.setUniform1f("borderSize",o)):(e.setUniform4f("borderColor",0,0,0,0),e.setUniform1f("borderSize",0));}e.bindUniforms=i;}(a$A||(a$A={}));var s$A=Object.freeze({__proto__:null,build:l$z,get LineCallout(){return a$A}});

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class T$h extends t$11{initializeProgram(e){const r=T$h.shader.get(),t=this.configuration,i=r.build({occlusionTestEnabled:t.occlusionTestEnabled,verticalOffsetEnabled:t.verticalOffset,screenSizePerspectiveEnabled:t.screenSizePerspective,depthHudEnabled:t.depthHudEnabled,depthHudAlignStartEnabled:t.depthHudAlignStartEnabled,screenCenterOffsetUnitsEnabled:t.screenCenterOffsetUnitsEnabled,slicePlaneEnabled:t.slicePlaneEnabled,sliceHighlightDisabled:!1,sliceEnabledForVertexPrograms:!0,viewingMode:e.viewingMode,isDraped:!1,multipassGeometryEnabled:t.multipassGeometryEnabled});return new n$16(e.rctx,i,o$X)}bindPass(e,r){t$15(this.program,r.camera.projectionMatrix),a$A.bindUniforms(this.program,e,r.camera.pixelRatio||1),l$Z(this.program,e,r),a$F(this.program,r),this.program.setUniform2fv("cameraNearFar",r.camera.nearFar),this.program.setUniform2fv("inverseViewport",r.inverseViewport),o$D(this.program,r),this.program.bindTexture(r.hudVisibilityTexture,"hudVisibilityTexture"),this.program.setUniform1f("cameraGroundRelative",r.camera.aboveGround?1:-1),this.program.setUniform1f("polygonOffset",e.shaderPolygonOffset),m$Z(this.program,r),this.program.setUniform1f("perDistancePixelRatio",Math.tan(r.camera.fovY/2)/(r.camera.fullViewport[2]/2)),this.program.setUniformMatrix4fv("viewNormal",r.camera.viewInverseTransposeMatrix),this.program.setUniform2f("pixelToNDC",2/r.camera.fullViewport[2],2/r.camera.fullViewport[3]);const n=r.camera.pixelRatio||1;this.program.setUniform1f("lineSize",Math.ceil(e.size)*n),B$o(e.screenSizePerspective,this.program,"screenSizePerspectiveAlignment");}bindDraw(e){a$17(this.program,e),o$12(this.program,e.origin,e.camera.viewInverseTransposeMatrix),l$_(this.program,this.configuration,e),this.program.rebindTextures();}setPipelineState(e){const r=e?519:513;return this.configuration.depthHudEnabled?g$S({depthTest:{func:r},depthWrite:l$$}):g$S({blending:e$T(1,770,771,771),depthTest:{func:r},colorWrite:r$13})}initializePipeline(){return this.setPipelineState(this.configuration.multipassGeometryEnabled)}}T$h.shader=new t$12(s$A,(()=>import('./LineCallout.glsl-a325629b.js')));class x$u extends e$S{constructor(){super(...arguments),this.occlusionTestEnabled=!0,this.verticalOffset=!1,this.screenSizePerspective=!1,this.depthHudEnabled=!1,this.depthHudAlignStartEnabled=!1,this.screenCenterOffsetUnitsEnabled=0,this.slicePlaneEnabled=!1,this.multipassGeometryEnabled=!1;}}e$Q([r$12()],x$u.prototype,"occlusionTestEnabled",void 0),e$Q([r$12()],x$u.prototype,"verticalOffset",void 0),e$Q([r$12()],x$u.prototype,"screenSizePerspective",void 0),e$Q([r$12()],x$u.prototype,"depthHudEnabled",void 0),e$Q([r$12()],x$u.prototype,"depthHudAlignStartEnabled",void 0),e$Q([r$12({count:2})],x$u.prototype,"screenCenterOffsetUnitsEnabled",void 0),e$Q([r$12()],x$u.prototype,"slicePlaneEnabled",void 0),e$Q([r$12()],x$u.prototype,"multipassGeometryEnabled",void 0);

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class l$y extends a$18{constructor(e){super(e,f$s),this.techniqueConfig=new x$u,this._uniqueMaterialIdentifier=l$y.uniqueMaterialIdentifier(this.params);}get uniqueMaterialIdentifier(){return this._uniqueMaterialIdentifier}dispose(){}getGLMaterial(e){return 0===e.output?new h$q(e):void 0}getPassParameters(){return this.params}getTechniqueConfig(e,t){return this.techniqueConfig.occlusionTestEnabled=this.params.occlusionTest,this.techniqueConfig.verticalOffset=!!this.params.verticalOffset,this.techniqueConfig.screenSizePerspective=!!this.params.screenSizePerspective,this.techniqueConfig.depthHudEnabled=e,this.techniqueConfig.depthHudAlignStartEnabled=!!this.params.depthHUDAlignStart,this.techniqueConfig.screenCenterOffsetUnitsEnabled="screen"===this.params.centerOffsetUnits?1:0,this.techniqueConfig.slicePlaneEnabled=this.params.slicePlaneEnabled,this.techniqueConfig.multipassGeometryEnabled=!!t&&t.multipassGeometryEnabled,this.techniqueConfig}intersect(){}createBufferWriter(){return new m$v}validateParameterValues(e){const t=l$y.uniqueMaterialIdentifier(e);t!==this._uniqueMaterialIdentifier&&(this._uniqueMaterialIdentifier=t);}static uniqueMaterialIdentifier(e){return JSON.stringify({screenOffset:e.screenOffset||[0,0],centerOffsetUnits:e.centerOffsetUnits||"world"})}}class h$q extends t$1i{constructor(e){super(e),this._isRenderSlot=!0,this.updateParameters();}updateParameters(e){this._technique=this._techniqueRep.releaseAndAcquire(T$h,this._material.getTechniqueConfig(!1,e),this._technique),this._depthTechnique=this._techniqueRep.releaseAndAcquire(T$h,this._material.getTechniqueConfig(!0,e),this._depthTechnique);}beginSlot(e){switch(e){case 20:return this._isRenderSlot=!0,!0;case 21:return this._isRenderSlot=!1,!0}return !1}get technique(){return this._isRenderSlot?this._technique:this._depthTechnique}ensureParameters(e){this.updateParameters(e);}bind(e){this.technique.bindPass(this._material.getPassParameters(),e);}}const f$s={verticalOffset:null,screenSizePerspective:null,screenOffset:[0,0],color:[0,0,0,1],size:1,borderColor:null,occlusionTest:!1,shaderPolygonOffset:1e-5,depthHUDAlignStart:!1,centerOffsetUnits:"world",slicePlaneEnabled:!1,...d$$},d$s=A$u().vec3f("position").vec3f("normal").vec2f("uv0").vec4f("auxpos1"),p$A=[t$1h(0,0),t$1h(1,0),t$1h(0,1),t$1h(1,0),t$1h(1,1),t$1h(0,1)];class m$v{constructor(){this.vertexBufferLayout=d$s;}allocate(e){return this.vertexBufferLayout.createBuffer(e)}elementCount(e){return 6*e.indices.get("position").length}write(e,t,i,s){u$Y(t.indices.get("position"),t.vertexAttributes.get("position").data,e.transformation,i.position,s,6),a$1a(t.indices.get("normal"),t.vertexAttributes.get("normal").data,e.invTranspTransformation,i.normal,s,6),c$13(t.indices.get("auxpos1"),t.vertexAttributes.get("auxpos1").data,i.auxpos1,s,6);for(let r=0;r<p$A.length;++r)i.uv0.setVec(s+r,p$A[r]);}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class y$q extends y$r{constructor(e,t){super(e,null,t,b$l),this._elevationOptions={supportsOffsetAdjustment:!0,supportsOnTheGround:!1},this.ensureDrapedStatus(!1);}async doLoad(){this._material=new l$y(this.materialParameters),this._context.stage.add(this._material);}destroy(){super.destroy(),this._context.stage.remove(this._material),this._material=null;}perInstanceMaterialParameters(e){const t=this.materialParameters;return t.screenOffset=e.screenOffset||[0,0],t.centerOffsetUnits=e.centerOffsetUnits||"world",t}get materialParameters(){const r=this.symbol,i=r.callout,n=r$Y(i.color)?o$W.toUnitRGBA(i.color):[0,0,0,0];n[3]*=this._getLayerOpacity();const s=u$_(i.size||0);let o=null;if(r.verticalOffset){const{screenLength:e,minWorldLength:t,maxWorldLength:i}=r.verticalOffset;o={screenLength:u$_(e),minWorldLength:t||0,maxWorldLength:null!=i?i:1/0};}const l=r$Y(i.border)&&r$Y(i.border.color)?o$W.toUnitRGBA(i.border.color):null,c="object"===r.symbolLayers.getItemAt(0).type,m=!c,d=c?0:void 0,u="label-3d"===r.type;return {color:n,size:s,verticalOffset:o,screenSizePerspective:this._context.screenSizePerspectiveEnabled?this._context.sharedResources.screenSizePerspectiveSettings:null,screenOffset:[0,0],centerOffsetUnits:"world",borderColor:l,occlusionTest:m,shaderPolygonOffset:d,depthHUDAlignStart:u,slicePlaneEnabled:this._context.slicePlaneEnabled,renderOccluded:d$$.renderOccluded}}_defaultElevationInfoNoZ(){return _$g}createGraphics3DGraphic(e){const t=e.renderingInfo,a=e.graphic,i=this.setGraphicElevationContext(a,new h$s,t.elevationOffset||0),n=t.symbol,s="on-the-ground"===this._elevationContext.mode&&("cim"===n.type||!n.symbolLayers.some((e=>"object"===e.type||"text"===e.type)));if("label-3d"!==n.type&&s)return null;const o=R$j(a.geometry);return t$17(o)?null:this._createAs3DShape(o,i,t,a.uid)}layerOpacityChanged(){return t$17(this._material)||this._material.setParameterValues(this.materialParameters),!0}layerElevationInfoChanged(e,r,a){const i=this._elevationContext.mode,o=d$y(y$q.elevationModeChangeTypes,a,i);return o!==T$j.UPDATE||e.forEach((e=>{const a=r(e);r$Y(a)&&this.updateGraphicElevationContext(e.graphic,a);})),o}slicePlaneEnabledChanged(){return t$17(this._material)||this._material.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled}),!0}physicalBasedRenderingChanged(){return !0}pixelRatioChanged(){return !0}setGraphicElevationContext(e,t,r=0){const a=super.setGraphicElevationContext(e,t);return a.addOffsetRenderUnits(r),a}updateGraphicElevationContext(e,t){this.setGraphicElevationContext(e,t.elevationContext,t.metadata.elevationOffset),t.needsElevationUpdates=p$F(t.elevationContext.mode);}updateGeometry(e,t){return !1}computeComplexity(){return {primitivesPerFeature:2,primitivesPerCoordinate:0,drawCallsPerFeature:0,estimated:!1,memory:u$y.memory}}createVertexData(e){const{translation:t,centerOffset:r}=e;return [["position",t?{size:3,data:[t[0],t[1],t[2]],exclusive:!0}:{size:3,data:[0,0,0],exclusive:!0}],["normal",{size:3,data:[0,0,1],exclusive:!0}],["auxpos1",r?{size:4,data:[r[0],r[1],r[2],r[3]],exclusive:!0}:{size:4,data:[0,0,0,1],exclusive:!0}]]}_getOrCreateMaterial(e){const a=this.perInstanceMaterialParameters(e),i=l$y.uniqueMaterialIdentifier(a);if(r$Y(this._material)&&i===this._material.uniqueMaterialIdentifier)return {material:this._material,isUnique:!1};if(e.materialCollection){let t=e.materialCollection.get(i);return t$17(t)&&(t=new l$y(a),e.materialCollection.add(i,t)),{material:t,isUnique:!1}}return {material:new l$y(a),isUnique:!0}}_createAs3DShape(e,t,r,a){const n=[new u$U(this.createVertexData(r),C$f,1)],s=this._getOrCreateMaterial(r),l=f$t(this._context,e,n,[s.material],null,null,t,this._context.layer.uid,a);if(null===l)return null;const m=E$k,d=new m$z(this,l.object,n,s.isUnique?[s.material]:null,null,m,t);return d.metadata={elevationOffset:r.elevationOffset||0},d.alignedSampledElevation=l.sampledElevation,d.needsElevationUpdates=p$F(t.mode),g$y(d,e,this._context.elevationProvider),d}}y$q.elevationModeChangeTypes={definedChanged:T$j.UPDATE,staysOnTheGround:T$j.UPDATE,onTheGroundChanged:T$j.RECREATE};const x$t=new Uint16Array([0]),C$f=[["position",x$t],["normal",x$t],["auxpos1",x$t]],_$g={mode:"relative-to-ground",offset:0},b$l={ignoreDrivers:!0,renderPriority:0,renderPriorityStep:1};

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
const t$F=n$12.getLogger("esri.views.3d.layers.graphics.Graphics3DCalloutSymbolLayerFactory");function e$z(o,l){if(!o$14(o))return t$F.error("Graphics3DCalloutSymbolLayerFactory#make",`symbol of type '${o.type}' does not support callouts`),null;if(!o.callout)return null;const e=a$z[o.callout.type];return e?new e(o,l):(t$F.error("Graphics3DCalloutSymbolLayerFactory#make",`unknown or unsupported callout type ${o.callout.type}`),null)}const a$z={line:y$q};

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class r$F{constructor(r,t,s){this.graphic=r,this.renderingInfo=t,this.layer=s;}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
const j$p=new e$X(Array,(i=>A$x(i,H$n)),null,10,5),v$r=i$P();class S$n{constructor(i,e,r,s,a){this._labelGraphics=new Array,this._auxiliaryGraphics=new Array,this._visibilityFlags=L$g(2,4),this._featureExpressionFeature=null,this._optimizedGeometry={geometry:null,hasZ:!1,hasM:!1},this._extent=null,this.isElevationSource=!1,++e.referenced,this.graphics3DSymbol=e,this.graphic=i,this._graphics=r,this._featureExpressionFeature=a?u$A(a,i,s):null;for(const o of this._graphics)r$Y(o)&&(this.isElevationSource=this.isElevationSource||o.isElevationSource);}get labelGraphics(){return this._labelGraphics}get extent(){return this._extent}initialize(i,e,t){this._layer=e,this._stage=i,this.forEachSymbolLayerGraphic((r=>{r.initialize(i,e,t),r.setVisibility(this.isVisible());}));}destroy(){this.forEachSymbolLayerGraphic((i=>i.destroy())),this._graphics=null,this._auxiliaryGraphics=null,--this.graphics3DSymbol.referenced,this.graphics3DSymbol=null;}get destroyed(){return null==this._graphics}clearLabelGraphics(){this.forEachLabelGraphic((i=>i.destroy())),this._labelGraphics.length=0;}addLabelGraphic(i,e,t){this._labelGraphics.push(i),i.initialize(e,t),i.setVisibility(this.isVisible(1));}addAuxiliaryGraphic(i){this._auxiliaryGraphics.push(i),this._layer&&(i.initialize(this._stage,this._layer),i.setVisibility(this.isVisible()));}get isDraped(){let i=!1;return this.forEachSymbolLayerGraphic((e=>{"draped"===e.type&&(i=!0);})),i}isVisible(i=0,e){for(let t=0;t<=i;t++){const i=this._visibilityFlags[t];for(let t=0;t<i.length;++t)if(!1===i[t]&&t!==e)return !1}return !0}hasVisibilityFlag(i,e){return null!=this._visibilityFlags[e][i]}setVisibilityFlag(i,e,t){const r=this.isVisible(t);this._visibilityFlags[t][i]=e;const s=this.isVisible(t);if(r===s)return !1;if(1===t)this.forEachLabelGraphic((i=>i.setVisibility(s)));else {this.forEachSymbolLayerGraphic((i=>i.setVisibility(s)));const i=this.isVisible(1);this.forEachLabelGraphic((e=>e.setVisibility(i)));}return !0}clearVisibilityFlag(i,e=0){return this.setVisibilityFlag(i,void 0,e)}computeExtent(i){if(!this._extent){const e=this.graphic.geometry;if(t$17(e))return !1;this._extent=i$P(),J$m(e,this._extent);const t=e.spatialReference;if(!t.equals(i)&&!Cn(this._extent,t,this._extent,i))return this._extent=null,!1}return !0}getAsOptimizedGeometry(i,e){return this._optimizedGeometry.geometry&&this._optimizedGeometry.hasZ===i&&this._optimizedGeometry.hasM===e||(this._optimizedGeometry.geometry=this._convertGraphicToOptimizedGeometry(this.graphic,i,e),this._optimizedGeometry.hasZ=i,this._optimizedGeometry.hasM=e),this._optimizedGeometry.geometry}_convertGraphicToOptimizedGeometry(i,e,t){let r=i.geometry;return "mesh"!==r.type&&"extent"!==r.type||(r=j$H.fromExtent("mesh"===r.type?r.extent:r)),X$h(r,e,t)}get usedMemory(){let i=e$13(this.graphic.attributes);return this.forEachSymbolLayerGraphic((e=>{const t=e.graphics3DSymbolLayer.complexity;if(t$17(t))return;const s="draped"===e.type?t.memory.draped:t.memory;i+=s.bytesPerFeature,s.bytesPerCoordinate&&(i+=w$F(this.graphic.geometry)*s.bytesPerCoordinate);})),i}computeAttachmentOrigin(){const i={render:{origin:n$11(),num:0},draped:{origin:n$19(),num:0}};for(const e of this._graphics)t$17(e)||e.computeAttachmentOrigin(i);return i.render.num&&d$O(i.render.origin,i.render.origin,1/i.render.num),i.draped.num&&l$15(i.draped.origin,i.draped.origin,1/i.draped.num),i}async getProjectedBoundingBox(e,t,s,a,o){return o||(o={boundingBox:null,requiresDrapedElevation:!1,screenSpaceObjects:[]}),o.boundingBox?B$n(o.boundingBox):o.boundingBox=B$n(),o.requiresDrapedElevation=!1,await n$1k(this._graphics,(async i=>{if(t$17(i))return;const h="draped"===i.type?t:e,n=j$p.acquire(),c=await i.getProjectedBoundingBox(h,s,o.screenSpaceObjects,a,n);isFinite(c[2])&&isFinite(c[5])||(o.requiresDrapedElevation=!0),c&&f$S(o.boundingBox,n),j$p.release(n);})),l$16(o.boundingBox)||h$S(G$o(o.boundingBox,v$r))?o:null}needsElevationUpdates(){for(const i of this._graphics)if(r$Y(i)&&("object3d"===i.type||"lod-instance"===i.type)&&i.needsElevationUpdates)return !0;for(const i of this._labelGraphics)if(i&&i.needsElevationUpdates)return !0;return !1}alignWithElevation(i,e,t){this.forEachRenderedGraphic((r=>{"object3d"!==r.type&&"lod-instance"!==r.type||r.alignWithElevation(i,e,this._featureExpressionFeature,t);}));}addObjectStateSet(i,e){this.forEachSymbolLayerGraphic((t=>t.addObjectState(i,e)));}removeObjectState(i){this.forEachSymbolLayerGraphic((e=>e.removeObjectState(i)));}forEachGraphicList(i,e){i.forEach((i=>i&&e(i)));}forEachSymbolLayerGraphic(i){this.forEachGraphicList(this._graphics,i),this.forEachGraphicList(this._auxiliaryGraphics,i);}forEachLabelGraphic(i){this.forEachGraphicList(this._labelGraphics,i);}forEachRenderedGraphic(i){this.forEachSymbolLayerGraphic(i),this.forEachLabelGraphic(i);}}function L$g(i,e){const t=new Array(i);for(let r=0;r<t.length;r++)t[r]=new Array(e);return t}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
function i$p(t,o){if(!t||t.symbol)return null;const r=o&&o.renderer;return t&&r$Y(r)&&r.getObservationRenderer?r.getObservationRenderer(t):r}function n$K(t,o){if(r$Y(t.symbol))return t.symbol;const r=i$p(t,o);return r$Y(r)&&"dot-density"!==r.type?r.getSymbol(t,o):null}function a$y(t,e){const a=i$p(t,e),l=n$K(t,e);if(t$17(l))return null;const s={renderer:a,symbol:l};if(t$17(a)||!("visualVariables"in a)||!a.visualVariables)return s;const u=k$C(a,t,e),c=["proportional","proportional","proportional"];for(const{variable:o,value:r}of u)switch(o.type){case"color":s.color=r.toRgba();break;case"size":if("outline"===o.target)s.outlineSize=r;else {const t=o.axis,e=o.useSymbolValue?"symbol-value":r;switch(t){case"width":c[0]=e;break;case"depth":c[1]=e;break;case"height":c[2]=e;break;case"width-and-depth":c[0]=c[1]=e;break;default:c[0]=c[1]=c[2]=e;}}break;case"opacity":s.opacity=r;break;case"rotation":switch(o.axis){case"tilt":s.tilt=r;break;case"roll":s.roll=r;break;default:s.heading=r;}}return "proportional"===c[0]&&"proportional"===c[1]&&"proportional"===c[2]||(s.size=c),s}async function l$x(t,o){if(r$Y(t.symbol))return t.symbol;const r=i$p(t,o);return r$Y(r)&&r.getSymbolAsync(t,{...o,abortOptions:{signal:o.signal}})}async function s$z(e,o){const n=i$p(e,o),a=await l$x(e,o);if(!a)return null;const s={renderer:n,symbol:a};if(!n||!("visualVariables"in n)||!n.visualVariables)return s;const u=k$C(n,e,o),c=["proportional","proportional","proportional"];for(const{variable:r,value:i}of u)if("color"===r.type)s.color=o$W.toUnitRGBA(i);else if("size"===r.type)if("outline"===r.target)s.outlineSize=i;else {const t=r.axis,e=r.useSymbolValue?"symbol-value":i;"width"===t?c[0]=e:"depth"===t?c[1]=e:"height"===t?c[2]=e:c[0]=c[1]="width-and-depth"===t?e:c[2]=e;}else "opacity"===r.type?s.opacity=i:"rotation"===r.type&&"tilt"===r.axis?s.tilt=i:"rotation"===r.type&&"roll"===r.axis?s.roll=i:"rotation"===r.type&&(s.heading=i);return (isFinite(c[0])||isFinite(c[1])||isFinite(c[2]))&&(s.size=c),s}function u$w(t,e=0){const o=t[e];return "number"==typeof o&&isFinite(o)?o:null}function c$z(t){for(let e=0;e<3;e++){const o=t[e];if("number"==typeof o)return isFinite(o)?o:0}return 0}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class r$E{constructor(n,t){this.vec3=n,this.id=t;}}function c$y(n,s,c,e){return new r$E(t$_(n,s,c),e)}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class n$J{constructor(e,t){this.index=e,this.renderTargets=t,this.extent=i$P(),this.resolution=0,this.viewport=i$P(),this.renderLocalOrigin=c$y(0,0,0,"O"),this.pixelRatio=1,this.canvasGeometries={extents:[i$P(),i$P(),i$P()],numViews:0},this.validTargets=null,this.hasDrapedFeatureSource=!1,this.hasDrapedRasterSource=!1,this.hasTargetWithoutRasterImage=!1,this.index=e,this.validTargets=new Array(t.renderTargets.length).fill(!1);}getValidTarget(e){return this.validTargets[e]?this.renderTargets.getTarget(e):null}get needsColorWithoutRasterImage(){return this.hasDrapedRasterSource&&this.hasDrapedFeatureSource&&this.hasTargetWithoutRasterImage}getColorTexture(e){const t=1===e?this.renderTargets.getTarget(0):2===e?this.renderTargets.getTarget(2):this.renderTargets.getTarget(4);return t?t.getTexture():null}getNormalTexture(e){const t=1===e?this.renderTargets.getTarget(3):null;return t?t.getTexture():null}draw(e,t){const s=this.computeRenderTargetValidityBitfield(),r=this.needsColorWithoutRasterImage;for(const i of this.renderTargets.renderTargets)1===i.type&&!1===r?this.validTargets[i.type]=!1:this.validTargets[i.type]=e.drawTarget(this,i,t);return s^this.computeRenderTargetValidityBitfield()?0:1}computeRenderTargetValidityBitfield(){const e=this.validTargets;return +e[0]|+e[1]<<1|+e[2]<<2|+e[3]<<3|+e[4]<<4}setupGeometryViewsCyclical(e){this.setupGeometryViewsDirect();const t=.001*e.range;if(this.extent[0]-t<=e.min){const t=this.canvasGeometries.extents[this.canvasGeometries.numViews++];R$t(this.extent,e.range,0,t);}if(this.extent[2]+t>=e.max){const t=this.canvasGeometries.extents[this.canvasGeometries.numViews++];R$t(this.extent,-e.range,0,t);}}setupGeometryViewsDirect(){this.canvasGeometries.numViews=1,A$y(this.canvasGeometries.extents[0],this.extent),r$17(this.viewport,0,0,this.resolution,this.resolution);}hasSomeSizedView(){for(let e=0;e<this.canvasGeometries.numViews;e++){const t=this.canvasGeometries.extents[e];if(t[0]!==t[2]&&t[1]!==t[3])return !0}return !1}applyViewport(e){const t=this.viewport;0===this.index?e.setViewport(t[0],t[1],t[2],t[3]):e.setViewport(t[0]+this.resolution,t[1],t[2],t[3]);}}function o$A(t,s,r){return Math.min(i$_(Math.max(t,s)+256),r)}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class i$o{constructor(e,i){this.size=n$1l(),this._fbo=null,this._fbo=new o$15(e,{colorTarget:0,depthStencilTarget:0},{target:3553,pixelFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9987,hasMipmap:i,maxAnisotropy:8,width:0,height:0});}dispose(){this._fbo=i$S(this._fbo);}getTexture(){return this._fbo?this._fbo.colorTexture:null}isValid(){return null!==this._fbo}resize(e,t){this.size[0]=e,this.size[1]=t,this._fbo.resize(this.size[0],this.size[1]);}bind(e){e.bindFramebuffer(this._fbo);}generateMipMap(){this._fbo.colorTexture.descriptor.hasMipmap&&this._fbo.colorTexture.generateMipmap();}disposeRenderTargetMemory(){var e;null==(e=this._fbo)||e.resize(0,0);}get gpuMemoryUsage(){var e,t;return null!=(e=null==(t=this._fbo)?void 0:t.gpuMemoryUsage)?e:0}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class r$D{constructor(r){this.renderTargets=null;const s=(s,t,o=!0)=>({type:t,fbo:new i$o(r,o),renderPass:s,valid:!1,lastUsed:1/0});this.renderTargets=[s(0,0),s(0,1),s(5,2,!1),s(3,3),s(0,4)];}getTarget(e){return this.renderTargets[e].fbo}dispose(){for(const e of this.renderTargets)e.fbo.dispose();}disposeRenderTargetMemory(){for(const e of this.renderTargets)e.fbo.disposeRenderTargetMemory();}validateUsageForTarget(e,r,t){if(e)r.lastUsed=t;else if(t-r.lastUsed>s$y)r.fbo.disposeRenderTargetMemory(),r.lastUsed=1/0;else if(r.lastUsed<1/0)return !0;return !1}get gpuMemoryUsage(){return this.renderTargets.reduce(((e,r)=>e+r.fbo.gpuMemoryUsage),0)}}const s$y=1e3;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class r$C{constructor(e){this.technique=e,this.refCount=0,this.refZeroFrame=0;}}class s$x{constructor(e){this._context=e,this._perConstructorInstances=new Map,this._frameCounter=0,this._keepAliveFrameCount=1200;}get viewingMode(){return this._context.viewingMode}get constructionContext(){return this._context}dispose(){this._perConstructorInstances.forEach((e=>e.forEach((e=>e.technique.dispose())))),this._perConstructorInstances.clear();}acquire(e,t){const s=t.key;let n=this._perConstructorInstances.get(e);n||(n=new Map,this._perConstructorInstances.set(e,n));let o=n.get(s);if(void 0===o){const c=new e(this._context,t,(()=>this.release(c)));o=new r$C(c),n.set(s,o);}return ++o.refCount,o.technique}releaseAndAcquire(t,r,s){if(r$Y(s)){if(r.key===s.key)return s;s.release();}return this.acquire(t,r)}release(e){if(t$17(e))return;const r=this._perConstructorInstances.get(e.constructor).get(e.key);--r.refCount,0===r.refCount&&(r.refZeroFrame=this._frameCounter);}frameUpdate(){this._frameCounter++,this._perConstructorInstances.forEach(((e,t)=>{e.forEach(((t,r)=>{0===t.refCount&&t.refZeroFrame+this._keepAliveFrameCount<this._frameCounter&&(t.technique.dispose(),e.delete(r));})),0===e.size&&this._perConstructorInstances.delete(t);}));}async hotReload(){const e=new Array;this._perConstructorInstances.forEach(((t,r)=>{const s=async(e,t)=>{const r=t.shader;r&&(await r.reload(),e.forEach((e=>{e.technique.reload(this._context);})));};e.push(s(t,r));})),await Promise.all(e);}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
const t$E=[{output:0,name:"color"},{output:1,name:"depth"},{output:2,name:"normal"},{output:3,name:"depthShadowMap"},{output:4,name:"highlight"},{output:5,name:"draped"},{output:6,name:"occlusion"},{output:7,name:"alpha"}];function u$v(u,o){return u+"_"+t$E.find((t=>t.output===o)).name}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
const s$w=n$12.getLogger("esri.views.3d.webgl-engine.lib.GLMaterialRep");class o$z{constructor(e){this.refCnt=0,this.glMaterial=e;}incRefCnt(){++this.refCnt;}decRefCnt(){--this.refCnt,i$R(this.refCnt>=0);}getRefCnt(){return this.refCnt}getGLMaterial(){return this.glMaterial}}class n$I{constructor(e,t,i){this._textureRep=e,this._techniqueRep=t,this.onMaterialChanged=i,this._id2glMaterialRef=new Map;}dispose(){this._textureRep.dispose();}acquire(e,t){this.ownMaterial(e);const r=u$v(e.id,t);let a=this._id2glMaterialRef.get(r);if(null==a){const i=e.getGLMaterial({material:e,techniqueRep:this._techniqueRep,textureRep:this._textureRep,output:t});return a=new o$z(i),a.incRefCnt(),this._id2glMaterialRef.set(r,a),i}return a.incRefCnt(),a.getGLMaterial()}release(e,t){const r=u$v(e.id,t),a=this._id2glMaterialRef.get(r);if(a.decRefCnt(),0===a.getRefCnt()){const e=a.getGLMaterial();e&&e.dispose(),this._id2glMaterialRef.delete(r);}}materialChanged(e){for(const t of t$E)if(5!==t.output&&6!==t.output){const r=this._id2glMaterialRef.get(u$v(e.id,t.output));if(r&&r.getGLMaterial()){const e=r.getGLMaterial();e.updateParameters&&e.updateParameters();}}this.onMaterialChanged&&this.onMaterialChanged(e);}ownMaterial(e){r$Y(e.materialRepository)&&e.materialRepository!==this&&s$w.error("Material is already owned by a different material repository"),e.materialRepository=this;}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
const e$y=["layerObjectAdded","layerObjectRemoved","layerObjectsAdded","layerObjectsRemoved","shaderTransformationChanged","objectTransformation","visibilityChanged","occlusionChanged","highlightChanged","objectGeometryAdded","objectGeometryRemoved","vertexAttrsUpdated"];

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class p$z{constructor(e,t){this._objectToBoundingSphere=e,this._maximumObjectsPerNode=10,this._maximumDepth=20,this._degenerateObjects=new Set,this._root=new b$k,this._objectCount=0,t&&(void 0!==t.maximumObjectsPerNode&&(this._maximumObjectsPerNode=t.maximumObjectsPerNode),void 0!==t.maximumDepth&&(this._maximumDepth=t.maximumDepth));}get bounds(){return this._root.bounds}get halfSize(){return this._root.halfSize}get root(){return this._root.node}get maximumObjectsPerNode(){return this._maximumObjectsPerNode}get maximumDepth(){return this._maximumDepth}get objectCount(){return this._objectCount}destroy(){this._degenerateObjects.clear(),b$k.clearPool(),v$q[0]=null,B$b.prune(),C$e.prune();}add(e,t=e.length){this._objectCount+=t,this._grow(e,t);const n=b$k.acquire();for(let i=0;i<t;i++){const t=e[i];this._isDegenerate(t)?this._degenerateObjects.add(t):(n.init(this._root),this._add(t,n));}b$k.release(n);}remove(t,n=null){this._objectCount-=t.length;const i=b$k.acquire();for(const o of t){const t=r$Y(n)?n:q$s(this._objectToBoundingSphere(o),I$j);z$e(t[3])?(i.init(this._root),this._remove(o,t,i)):this._degenerateObjects.delete(o);}b$k.release(i),this._shrink();}update(e,t){if(!z$e(t[3])&&this._isDegenerate(e))return;const n=A$f(e);this.remove(n,t),this.add(n);}forEachAlongRay(e,t,n){const i=d$R(e,t);this._forEachNode(this._root,(e=>{if(!this._intersectsNode(i,e))return !1;const t=e.node;return t.terminals.forAll((e=>{this._intersectsObject(i,e)&&n(e);})),null!==t.residents&&t.residents.forAll((e=>{this._intersectsObject(i,e)&&n(e);})),!0}));}forEachAlongRayWithVerticalOffset(e,t,n,i){const o=d$R(e,t);this._forEachNode(this._root,(e=>{if(!this._intersectsNodeWithOffset(o,e,i))return !1;const t=e.node;return t.terminals.forAll((e=>{this._intersectsObjectWithOffset(o,e,i)&&n(e);})),null!==t.residents&&t.residents.forAll((e=>{this._intersectsObjectWithOffset(o,e,i)&&n(e);})),!0}));}forEach(e){this._forEachNode(this._root,(t=>{const n=t.node;return n.terminals.forAll(e),null!==n.residents&&n.residents.forAll(e),!0})),this._degenerateObjects.forEach(e);}forEachDegenerateObject(e){this._degenerateObjects.forEach(e);}findClosest(e,t,n,s=(()=>!0),r=1/0){let h=1/0,a=1/0,d=null;const c=N$e(e,t),u=i=>{if(--r,!s(i))return;const o=this._objectToBoundingSphere(i);if(!R$n(n,o))return;const c=M$n(e,t,O$z(o)),u=c-o[3],f=c+o[3];u<h&&(h=u,a=f,d=i);};return this._forEachNodeDepthOrdered(this._root,(s=>{if(r<=0||!R$n(n,s.bounds))return !1;d$O(k$g,c,s.halfSize),u$S(k$g,k$g,s.bounds);if(M$n(e,t,k$g)>a)return !1;const h=s.node;return h.terminals.forAll((e=>u(e))),null!==h.residents&&h.residents.forAll((e=>u(e))),!0}),e,t),d}forEachInDepthRange(e,t,n,s,r,h,a){let d=-1/0,c=1/0;const u={setRange:e=>{1===n?(d=Math.max(d,e.near),c=Math.min(c,e.far)):(d=Math.max(d,-e.far),c=Math.min(c,-e.near));}};u.setRange(s);const f=M$n(t,n,e),_=N$e(t,n),p=N$e(t,-1*n),b=e=>{if(!a(e))return;const i=this._objectToBoundingSphere(e),o=O$z(i),s=M$n(t,n,o)-f,_=s-i[3],p=s+i[3];_>c||p<d||!R$n(h,i)||r(e,u);};this._forEachNodeDepthOrdered(this._root,(e=>{if(!R$n(h,e.bounds))return !1;d$O(k$g,_,e.halfSize),u$S(k$g,k$g,e.bounds);if(M$n(t,n,k$g)-f>c)return !1;d$O(k$g,p,e.halfSize),u$S(k$g,k$g,e.bounds);if(M$n(t,n,k$g)-f<d)return !1;const s=e.node;return s.terminals.forAll((e=>b(e))),null!==s.residents&&s.residents.forAll((e=>b(e))),!0}),t,n);}forEachNode(e){this._forEachNode(this._root,(t=>e(t.node,t.bounds,t.halfSize)));}_intersectsNode(e,t){return S$m(t.bounds,2*-t.halfSize,q$c),S$m(t.bounds,2*t.halfSize,w$o),d$11(e.origin,e.direction,q$c,w$o)}_intersectsNodeWithOffset(e,t,n){return S$m(t.bounds,2*-t.halfSize,q$c),S$m(t.bounds,2*t.halfSize,w$o),n.applyToMinMax(q$c,w$o),d$11(e.origin,e.direction,q$c,w$o)}_intersectsObject(e,t){const n=this._objectToBoundingSphere(t);return !(n[3]>0)||B$p(n,e)}_intersectsObjectWithOffset(e,t,n){const i=this._objectToBoundingSphere(t);return !(i[3]>0)||B$p(n.applyToBoundingSphere(i),e)}_forEachNode(e,t){let n=b$k.acquire().init(e);const i=[n];for(;0!==i.length;){if(n=i.pop(),t(n)&&!n.isLeaf())for(let e=0;e<n.node.children.length;e++){n.node.children[e]&&i.push(b$k.acquire().init(n).advance(e));}b$k.release(n);}}_forEachNodeDepthOrdered(e,t,n,i=1){let o=b$k.acquire().init(e);const s=[o];for(O$g(n,i,W$b);0!==s.length;){if(o=s.pop(),t(o)&&!o.isLeaf())for(let e=7;e>=0;--e){const t=W$b[e];o.node.children[t]&&s.push(b$k.acquire().init(o).advance(t));}b$k.release(o);}}_remove(e,t,n){B$b.clear();const i=n.advanceTo(t,((e,t)=>{B$b.push(e.node),B$b.push(t);}))?n.node.terminals:n.node.residents;if(i.removeUnordered(e),0===i.length)for(let o=B$b.length-2;o>=0;o-=2){const e=B$b.data[o],t=B$b.data[o+1];if(!this._purge(e,t))break}}_nodeIsEmpty(e){if(0!==e.terminals.length)return !1;if(null!==e.residents)return 0===e.residents.length;for(let t=0;t<e.children.length;t++)if(e.children[t])return !1;return !0}_purge(e,t){return t>=0&&(e.children[t]=null),!!this._nodeIsEmpty(e)&&(null===e.residents&&(e.residents=new n$1h({shrink:!0})),!0)}_add(e,t){t.advanceTo(this._objectToBoundingSphere(e))?t.node.terminals.push(e):(t.node.residents.push(e),t.node.residents.length>this._maximumObjectsPerNode&&t.depth<this._maximumDepth&&this._split(t));}_split(e){const t=e.node.residents;e.node.residents=null;for(let n=0;n<t.length;n++){const i=b$k.acquire().init(e);this._add(t.getItemAt(n),i),b$k.release(i);}}_grow(e,t){if(0!==t&&(x$s(e,t,(e=>this._objectToBoundingSphere(e)),P$j),z$e(P$j[3])&&!this._fitsInsideTree(P$j)))if(this._nodeIsEmpty(this._root.node))q$s(P$j,this._root.bounds),this._root.halfSize=1.25*P$j[3];else {const e=this._rootBoundsForRootAsSubNode(P$j);this._placingRootViolatesMaxDepth(e)?this._rebuildTree(P$j,e):this._growRootAsSubNode(e),b$k.release(e);}}_rebuildTree(e,t){r$Z(R$h,t.bounds),R$h[3]=t.halfSize,x$s([e,R$h],2,(e=>e),F$j);const n=b$k.acquire().init(this._root);this._root.initFrom(null,F$j,1.25*F$j[3]),this._forEachNode(n,(e=>(this.add(e.node.terminals.data,e.node.terminals.length),null!==e.node.residents&&this.add(e.node.residents.data,e.node.residents.length),!0))),b$k.release(n);}_placingRootViolatesMaxDepth(e){const t=Math.log(e.halfSize/this._root.halfSize)*Math.LOG2E;let n=0;return this._forEachNode(this._root,(e=>(n=Math.max(n,e.depth),n+t<=this._maximumDepth))),n+t>this._maximumDepth}_rootBoundsForRootAsSubNode(e){const t=e[3],n=e;let i=-1/0;const o=this._root.bounds,s=this._root.halfSize;for(let r=0;r<3;r++){const e=o[r]-s-(n[r]-t),h=n[r]+t-(o[r]+s),a=Math.max(0,Math.ceil(e/(2*s))),l=Math.max(0,Math.ceil(h/(2*s)))+1,d=2**Math.ceil(Math.log(a+l)*Math.LOG2E);i=Math.max(i,d),L$f[r].min=a,L$f[r].max=l;}for(let r=0;r<3;r++){let e=L$f[r].min,t=L$f[r].max;const n=(i-(e+t))/2;e+=Math.ceil(n),t+=Math.floor(n);const h=o[r]-s-e*s*2;y$p[r]=h+(t+e)*s;}return y$p[3]=i*s*D$f,b$k.acquire().initFrom(null,y$p,i*s,0)}_growRootAsSubNode(e){const t=this._root.node;r$Z(P$j,this._root.bounds),P$j[3]=this._root.halfSize,this._root.init(e),e.advanceTo(P$j,null,!0),e.node.children=t.children,e.node.residents=t.residents,e.node.terminals=t.terminals;}_shrink(){for(;;){const e=this._findShrinkIndex();if(-1===e)break;this._root.advance(e),this._root.depth=0;}}_findShrinkIndex(){if(0!==this._root.node.terminals.length||this._root.isLeaf())return -1;let e=null;const t=this._root.node.children;let n=0,i=0;for(;i<t.length&&null==e;)n=i++,e=t[n];for(;i<t.length;)if(t[i++])return -1;return n}_isDegenerate(e){return !z$e(this._objectToBoundingSphere(e)[3])}_fitsInsideTree(e){const t=this._root.bounds,n=this._root.halfSize;return e[3]<=n&&e[0]>=t[0]-n&&e[0]<=t[0]+n&&e[1]>=t[1]-n&&e[1]<=t[1]+n&&e[2]>=t[2]-n&&e[2]<=t[2]+n}}class b$k{constructor(){this.bounds=_$o(),this.halfSize=0,this.initFrom(null,null,0,0);}init(e){return this.initFrom(e.node,e.bounds,e.halfSize,e.depth)}initFrom(t,n,i,o=this.depth){return this.node=r$Y(t)?t:b$k.createEmptyNode(),r$Y(n)&&q$s(n,this.bounds),this.halfSize=i,this.depth=o,this}advance(e){let t=this.node.children[e];t||(t=b$k.createEmptyNode(),this.node.children[e]=t),this.node=t,this.halfSize/=2,this.depth++;const n=E$j[e];return this.bounds[0]+=n[0]*this.halfSize,this.bounds[1]+=n[1]*this.halfSize,this.bounds[2]+=n[2]*this.halfSize,this.bounds[3]=this.halfSize*D$f,this}advanceTo(e,t,n=!1){for(;;){if(this.isTerminalFor(e))return t&&t(this,-1),!0;if(this.isLeaf()){if(!n)return t&&t(this,-1),!1;this.node.residents=null;}const i=this._childIndex(e);t&&t(this,i),this.advance(i);}}isLeaf(){return null!=this.node.residents}isTerminalFor(e){return e[3]>this.halfSize/2}_childIndex(e){const t=this.bounds;return (t[0]<e[0]?1:0)+(t[1]<e[1]?2:0)+(t[2]<e[2]?4:0)}static createEmptyNode(){return {children:[null,null,null,null,null,null,null,null],terminals:new n$1h({shrink:!0}),residents:new n$1h({shrink:!0})}}static acquire(){return b$k._pool.acquire()}static release(e){b$k._pool.release(e);}static clearPool(){b$k._pool.prune();}}function g$x(e,t){e[0]=Math.min(e[0],t[0]-t[3]),e[1]=Math.min(e[1],t[1]-t[3]),e[2]=Math.min(e[2],t[2]-t[3]);}function j$o(e,t){e[0]=Math.max(e[0],t[0]+t[3]),e[1]=Math.max(e[1],t[1]+t[3]),e[2]=Math.max(e[2],t[2]+t[3]);}function S$m(e,t,n){n[0]=e[0]+t,n[1]=e[1]+t,n[2]=e[2]+t;}function x$s(e,t,n,i){if(1===t){const t=n(e[0]);q$s(t,i);}else {q$c[0]=1/0,q$c[1]=1/0,q$c[2]=1/0,w$o[0]=-1/0,w$o[1]=-1/0,w$o[2]=-1/0;for(let i=0;i<t;i++){const t=n(e[i]);z$e(t[3])&&(g$x(q$c,t),j$o(w$o,t));}y$N(i,q$c,w$o,.5),i[3]=Math.max(w$o[0]-q$c[0],w$o[1]-q$c[1],w$o[2]-q$c[2])/2;}}function O$g(e,t,n){if(!C$e.length)for(let i=0;i<8;++i)C$e.push({index:0,distance:0});for(let i=0;i<8;++i){const n=E$j[i];C$e.data[i].index=i,C$e.data[i].distance=M$n(e,t,n);}C$e.sort(((e,t)=>e.distance-t.distance));for(let i=0;i<8;++i)n[i]=C$e.data[i].index;}function N$e(e,t){let n=1/0,i=null;for(let o=0;o<8;++o){const s=M$n(e,t,T$g[o]);s<n&&(n=s,i=T$g[o]);}return i}function M$n(e,t,n){return t*(e[0]*n[0]+e[1]*n[1]+e[2]*n[2])}function z$e(e){return !isNaN(e)&&e!==-1/0&&e!==1/0&&e>0}b$k._pool=new e$X(b$k);const E$j=[t$_(-1,-1,-1),t$_(1,-1,-1),t$_(-1,1,-1),t$_(1,1,-1),t$_(-1,-1,1),t$_(1,-1,1),t$_(-1,1,1),t$_(1,1,1)],T$g=[t$_(-1,-1,-1),t$_(-1,-1,1),t$_(-1,1,-1),t$_(-1,1,1),t$_(1,-1,-1),t$_(1,-1,1),t$_(1,1,-1),t$_(1,1,1)],D$f=Math.sqrt(3),v$q=[null];function A$f(e){return v$q[0]=e,v$q}const y$p=_$o(),k$g=n$11(),q$c=n$11(),w$o=n$11(),B$b=new n$1h,I$j=_$o(),P$j=_$o(),R$h=_$o(),F$j=_$o(),L$f=[{min:0,max:0},{min:0,max:0},{min:0,max:0}],C$e=new n$1h,W$b=[0,0,0,0,0,0,0,0];

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class n$H extends r$1a{constructor(s,i=""){var r,a,h;super(),this.apiLayerUid=i,this.type=0,this.events=new n$13,this.isSliceable=!1,this._objects=new n$1h,this._stageHandles=new u$T,this.apiLayerUid=i,this.isVisible=null==(r=null==s?void 0:s.isVisible)||r,this.isPickable=null==(a=null==s?void 0:s.isPickable)||a,this.updatePolicy=null!=(h=null==s?void 0:s.updatePolicy)?h:0;}get objects(){return this._objects}destroy(){this.detachStage(),this._stage=null;}attachStage(e){this.detachStage(),this._stage=e;for(const t of e$y)this._stageHandles.add(this.events.on(t,(s=>e.handleEvent(t,s))));}detachStage(){this._stageHandles.removeAll(),this.invalidateSpatialQueryAccelerator();}add(e){this._objects.push(e),e.parentLayer=this,this.events.emit("layerObjectAdded",{layer:this,object:e}),r$Y(this._octree)&&this._octree.add([e]);}remove(e){this._objects.removeUnordered(e)&&(e.parentLayer=null,this.events.emit("layerObjectRemoved",{layer:this,object:e}),r$Y(this._octree)&&this._octree.remove([e]));}addMany(e){this._objects.pushArray(e);for(const t of e)t.parentLayer=this;this.events.emit("layerObjectsAdded",{layer:this,objects:e}),r$Y(this._octree)&&this._octree.add(e);}removeMany(e){const t=new Array;if(this._objects.removeUnorderedMany(e,e.length,t),0!==t.length){for(const e of t)e.parentLayer=null;this.events.emit("layerObjectsRemoved",{layer:this,objects:t}),r$Y(this._octree)&&this._octree.remove(t);}}sync(){r$Y(this._stage)&&1!==this.updatePolicy&&this._stage.syncLayer(this.id);}notifyObjectBBChanged(e,t){r$Y(this._octree)&&this._octree.update(e,t);}getSpatialQueryAccelerator(){return t$17(this._octree)&&this._objects.length>50&&this._createOctree(),this._octree}shaderTransformationChanged(){this.invalidateSpatialQueryAccelerator(),this.events.emit("shaderTransformationChanged",this);}invalidateSpatialQueryAccelerator(){this._octree=l$W(this._octree);}_createOctree(){this._octree=new p$z((e=>e.boundingVolumeWorldSpace.bounds)),this._octree.add(this._objects.data,this._objects.length);}}function l$w(e){return r$Y(e)&&0===e.type}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
var e$x;!function(e){e.Default={vvSizeEnabled:!1,vvSizeMinSize:t$13(1,1,1),vvSizeMaxSize:t$13(100,100,100),vvSizeOffset:t$13(0,0,0),vvSizeFactor:t$13(1,1,1),vvSizeValue:t$13(1,1,1),vvColorEnabled:!1,vvColorValues:[0,0,0,0,0,0,0,0],vvColorColors:[1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0],vvOpacityEnabled:!1,vvOpacityValues:[0,0,0,0,0,0,0,0],vvOpacityOpacities:[1,1,1,1,1,1,1,1],vvSymbolAnchor:[0,0,0],vvSymbolRotationMatrix:e$Z()};}(e$x||(e$x={}));var o$y=e$x;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
function t$D(t,i){t.vertex.uniforms.add("intrinsicWidth","float"),i.vvSize?(t.attributes.add("sizeFeatureAttribute","float"),t.vertex.uniforms.add("vvSizeMinSize","vec3"),t.vertex.uniforms.add("vvSizeMaxSize","vec3"),t.vertex.uniforms.add("vvSizeOffset","vec3"),t.vertex.uniforms.add("vvSizeFactor","vec3"),t.vertex.code.add(t$10`float getSize() {
return intrinsicWidth * clamp(vvSizeOffset + sizeFeatureAttribute * vvSizeFactor, vvSizeMinSize, vvSizeMaxSize).x;
}`)):(t.attributes.add("size","float"),t.vertex.code.add(t$10`float getSize(){
return intrinsicWidth * size;
}`)),i.vvOpacity?(t.attributes.add("opacityFeatureAttribute","float"),t.vertex.constants.add("vvOpacityNumber","int",8),t.vertex.code.add(t$10`uniform float vvOpacityValues[vvOpacityNumber];
uniform float vvOpacityOpacities[vvOpacityNumber];
float interpolateOpacity( float value ){
if (value <= vvOpacityValues[0]) {
return vvOpacityOpacities[0];
}
for (int i = 1; i < vvOpacityNumber; ++i) {
if (vvOpacityValues[i] >= value) {
float f = (value - vvOpacityValues[i-1]) / (vvOpacityValues[i] - vvOpacityValues[i-1]);
return mix(vvOpacityOpacities[i-1], vvOpacityOpacities[i], f);
}
}
return vvOpacityOpacities[vvOpacityNumber - 1];
}
vec4 applyOpacity( vec4 color ){
return vec4(color.xyz, interpolateOpacity(opacityFeatureAttribute));
}`)):t.vertex.code.add(t$10`vec4 applyOpacity( vec4 color ){
return color;
}`),i.vvColor?(t.attributes.add("colorFeatureAttribute","float"),t.vertex.constants.add("vvColorNumber","int",8),t.vertex.code.add(t$10`uniform float vvColorValues[vvColorNumber];
uniform vec4 vvColorColors[vvColorNumber];
vec4 interpolateColor( float value ) {
if (value <= vvColorValues[0]) {
return vvColorColors[0];
}
for (int i = 1; i < vvColorNumber; ++i) {
if (vvColorValues[i] >= value) {
float f = (value - vvColorValues[i-1]) / (vvColorValues[i] - vvColorValues[i-1]);
return mix(vvColorColors[i-1], vvColorColors[i], f);
}
}
return vvColorColors[vvColorNumber - 1];
}
vec4 getColor(){
return applyOpacity(interpolateColor(colorFeatureAttribute));
}`)):(t.attributes.add("color","vec4"),t.vertex.code.add(t$10`vec4 getColor(){
return applyOpacity(color);
}`));}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
function p$y(e,p){e.constants.add("stippleAlphaColorDiscard","float",.001),e.constants.add("stippleAlphaHighlightDiscard","float",.5),p.stippleEnabled?t$C(e,p):l$v(e);}function t$C(p,t){p.vertex.uniforms.add("stipplePatternPixelSizeInv","float"),t.stippleUVMaxEnabled&&p.varyings.add("stipplePatternUvMax","float"),p.varyings.add("stipplePatternUv","float"),p.fragment.uniforms.add("stipplePatternTexture","sampler2D"),t.stippleOffColorEnabled&&p.fragment.uniforms.add("stippleOffColor","vec4"),p.fragment.code.add(t$10`
  float getStippleAlpha() {
    float stipplePatternUvClamped = stipplePatternUv * gl_FragCoord.w;
    ${t.stippleUVMaxEnabled?"stipplePatternUvClamped = clamp(stipplePatternUvClamped, 0.0, stipplePatternUvMax);":""}

    return texture2D(stipplePatternTexture, vec2(mod(stipplePatternUvClamped, 1.0), 0.5)).a;
  }`),t.stippleOffColorEnabled?p.fragment.code.add(t$10`#define discardByStippleAlpha(stippleAlpha, threshold) {}
#define blendStipple(color, stippleAlpha) mix(color, stippleOffColor, stippleAlpha)`):p.fragment.code.add(t$10`#define discardByStippleAlpha(stippleAlpha, threshold) if (stippleAlpha < threshold) { discard; }
#define blendStipple(color, stippleAlpha) vec4(color.rgb, color.a * stippleAlpha)`);}function l$v(p){p.fragment.code.add(t$10`float getStippleAlpha() { return 1.0; }
#define discardByStippleAlpha(_stippleAlpha_, _threshold_) {}
#define blendStipple(color, _stippleAlpha_) color`);}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
function c$x(c){const v=new n$15;v.extensions.add("GL_OES_standard_derivatives"),v.include(t$1j),v.include(t$D,c),v.include(p$y,c),1===c.output&&v.include(e$14,c),v.vertex.uniforms.add("proj","mat4").add("view","mat4").add("cameraNearFar","vec2").add("pixelRatio","float").add("miterLimit","float").add("screenSize","vec2"),v.attributes.add("position","vec3"),v.attributes.add("subdivisionFactor","float"),v.attributes.add("uv0","vec2"),v.attributes.add("auxpos1","vec3"),v.attributes.add("auxpos2","vec3"),v.varyings.add("vColor","vec4"),v.varyings.add("vpos","vec3"),v.varyings.add("linearDepth","float"),c.multipassTerrainEnabled&&v.varyings.add("depth","float");const f=c.falloffEnabled,m=c.innerColorEnabled;return m&&v.varyings.add("vLineDistance","float"),f&&v.varyings.add("vLineDistanceNorm","float"),c.falloffEnabled&&v.fragment.uniforms.add("falloff","float"),c.innerColorEnabled&&(v.fragment.uniforms.add("innerColor","vec4"),v.fragment.uniforms.add("innerWidth","float")),v.vertex.code.add(t$10`#define PERPENDICULAR(v) vec2(v.y, -v.x);
#define ISOUTSIDE (left.x * right.y - left.y * right.x)*uv0.y > 0.0
float interp(float ncp, vec4 a, vec4 b) {
return (-ncp - a.z) / (b.z - a.z);
}
vec2 rotate(vec2 v, float a) {
float s = sin(a);
float c = cos(a);
mat2 m = mat2(c, -s, s, c);
return m * v;
}`),v.vertex.code.add(t$10`vec4 projectAndScale(vec4 pos) {
vec4 posNdc = proj * pos;
posNdc.xy *= screenSize / posNdc.w;
return posNdc;
}`),v.vertex.code.add(t$10`
    void clipAndTransform(inout vec4 pos, inout vec4 prev, inout vec4 next, in bool isStartVertex) {
      float vnp = cameraNearFar[0] * 0.99;

      //current pos behind ncp --> we need to clip
      if(pos.z > -cameraNearFar[0]) {
        if (!isStartVertex) {
          //previous in front of ncp
          if(prev.z < -cameraNearFar[0]) {
            pos = mix(prev, pos, interp(vnp, prev, pos));
            next = pos;
          } else {
            pos = vec4(0.0, 0.0, 0.0, 1.0);
          }
        }
        //next in front of ncp
        if(isStartVertex) {
          if(next.z < -cameraNearFar[0]) {
            pos = mix(pos, next, interp(vnp, pos, next));
            prev = pos;
          } else {
            pos = vec4(0.0, 0.0, 0.0, 1.0);
          }
        }
      } else {
        //current position visible
        //previous behind ncp
        if (prev.z > -cameraNearFar[0]) {
          prev = mix(pos, prev, interp(vnp, pos, prev));
        }
        //next behind ncp
        if (next.z > -cameraNearFar[0]) {
          next = mix(next, pos, interp(vnp, next, pos));
        }
      }

      ${c.multipassTerrainEnabled?"depth = pos.z;":""}
      linearDepth = (-pos.z - cameraNearFar[0]) / (cameraNearFar[1] - cameraNearFar[0]);

      pos = projectAndScale(pos);
      next = projectAndScale(next);
      prev = projectAndScale(prev);
    }
`),v.vertex.code.add(t$10`void main(void) {
float coverage = 1.0;
vpos = position;
if (uv0.y == 0.0) {
gl_Position = vec4(1e038, 1e038, 1e038, 1.0);
}
else {
bool isStartVertex = abs(abs(uv0.y)-3.0) == 1.0;
bool isJoin = abs(uv0.y)-3.0 < 0.0;
float lineWidth = getSize() * pixelRatio;
if (lineWidth < 1.0) {
coverage = lineWidth;
lineWidth = 1.0;
}else{
lineWidth = floor(lineWidth + 0.5);
}
vec4 pos  = view * vec4(position.xyz, 1.0);
vec4 prev = view * vec4(auxpos1.xyz, 1.0);
vec4 next = view * vec4(auxpos2.xyz, 1.0);
clipAndTransform(pos, prev, next, isStartVertex);
vec2 left = (pos.xy - prev.xy);
vec2 right = (next.xy - pos.xy);
float leftLen = length(left);
float rightLen = length(right);`),c.stippleEnabled&&v.vertex.code.add(t$10`vec4 stippleSegmentInfo = mix(vec4(pos.xy, right), vec4(prev.xy, left), uv0.x);
vec2 stippleSegmentOrigin = stippleSegmentInfo.xy;
vec2 stippleSegmentDirection = stippleSegmentInfo.zw;`),v.vertex.code.add(t$10`left = (leftLen > 0.001) ? left/leftLen : vec2(0.0, 0.0);
right = (rightLen > 0.001) ? right/rightLen : vec2(0.0, 0.0);
vec2 capDisplacementDir = vec2(0, 0);
vec2 joinDisplacementDir = vec2(0, 0);
float displacementLen = lineWidth;
if (isJoin) {
bool isOutside = ISOUTSIDE;
joinDisplacementDir = normalize(left + right);
joinDisplacementDir = PERPENDICULAR(joinDisplacementDir);
if (leftLen > 0.001 && rightLen > 0.001) {
float nDotSeg = dot(joinDisplacementDir, left);
displacementLen /= length(nDotSeg * left - joinDisplacementDir);
if (!isOutside) {
displacementLen = min(displacementLen, min(leftLen, rightLen)/abs(nDotSeg));
}
}
if (isOutside && (displacementLen > miterLimit * lineWidth)) {`),c.roundJoins?v.vertex.code.add(t$10`vec2 startDir;
vec2 endDir;
if (leftLen < 0.001) {
startDir = right;
}
else{
startDir = left;
}
startDir = normalize(startDir);
startDir = PERPENDICULAR(startDir);
if (rightLen < 0.001) {
endDir = left;
}
else{
endDir = right;
}
endDir = normalize(endDir);
endDir = PERPENDICULAR(endDir);
float rotationAngle = acos(clamp(dot(startDir, endDir), -1.0, 1.0));
joinDisplacementDir = rotate(startDir, -sign(uv0.y) * subdivisionFactor * rotationAngle);`):v.vertex.code.add(t$10`if (leftLen < 0.001) {
joinDisplacementDir = right;
}
else if (rightLen < 0.001) {
joinDisplacementDir = left;
}
else {
joinDisplacementDir = isStartVertex ? right : left;
}
joinDisplacementDir = normalize(joinDisplacementDir);
joinDisplacementDir = PERPENDICULAR(joinDisplacementDir);`),v.vertex.code.add(t$10`displacementLen = lineWidth;
}
} else {
if (leftLen < 0.001) {
joinDisplacementDir = right;
}
else if (rightLen < 0.001) {
joinDisplacementDir = left;
}
else {
joinDisplacementDir = isStartVertex ? right : left;
}
joinDisplacementDir = normalize(joinDisplacementDir);
joinDisplacementDir = PERPENDICULAR(joinDisplacementDir);
displacementLen = lineWidth;
capDisplacementDir = isStartVertex ? -right : left;`),c.roundCaps?v.vertex.code.add(t$10`float angle = subdivisionFactor*PI*0.5;
joinDisplacementDir *= cos(angle);
capDisplacementDir *= sin(angle);`):v.vertex.code.add(t$10`capDisplacementDir *= subdivisionFactor;`),v.vertex.code.add(t$10`
  }

  // Displacement (in pixels) caused by join/or cap
  vec2 dpos = joinDisplacementDir * sign(uv0.y) * displacementLen + capDisplacementDir * displacementLen;

  ${f||m?t$10`float lineDist = lineWidth * sign(uv0.y) * pos.w;`:""}

  ${m?t$10`vLineDistance = lineDist;`:""}
  ${f?t$10`vLineDistanceNorm = lineDist / lineWidth;`:""}

  pos.xy += dpos;
  `),c.stippleEnabled&&(v.vertex.code.add(t$10`{
vec2 posVec = pos.xy - stippleSegmentOrigin;
float stippleSegmentDirectionLength = length(stippleSegmentDirection);`),c.stippleIntegerRepeatsEnabled&&v.vertex.code.add(t$10`float numberOfPatternRepeats = stippleSegmentDirectionLength * 0.5 * stipplePatternPixelSizeInv;
float roundedNumberOfPatternRepeats = floor(numberOfPatternRepeats);
stipplePatternUvMax = roundedNumberOfPatternRepeats;`),v.vertex.code.add(t$10`
      if (stippleSegmentDirectionLength >= 0.001) {
        // Project the vertex position onto the line segment.
        float projectedLength = dot(stippleSegmentDirection, posVec) / stippleSegmentDirectionLength * 0.5;
     ${c.stippleIntegerRepeatsEnabled?"float wholeNumberOfRepeatsScale = roundedNumberOfPatternRepeats / numberOfPatternRepeats;":"float wholeNumberOfRepeatsScale = 1.0;"}
        stipplePatternUv = projectedLength * wholeNumberOfRepeatsScale * stipplePatternPixelSizeInv * pos.w;
        } else {
          stipplePatternUv = 1.0;
        }
      }
    `)),v.vertex.code.add(t$10`pos.xy = pos.xy / screenSize * pos.w;
vColor = getColor();
vColor.a *= coverage;
gl_Position = pos;
}
}`),c.multipassTerrainEnabled&&(v.fragment.include(a$15),v.include(r$1j,c)),v.include(c$$,c),v.fragment.uniforms.add("intrinsicColor","vec4"),v.fragment.include(e$U),v.fragment.code.add(t$10`
  void main() {
    discardBySlice(vpos);
    ${c.multipassTerrainEnabled?"terrainDepthTest(gl_FragCoord, depth);":""}
    float stippleAlpha = getStippleAlpha();
    discardByStippleAlpha(stippleAlpha, stippleAlphaColorDiscard);

    vec4 color = intrinsicColor * vColor;
  `),c.innerColorEnabled&&(v.fragment.uniforms.add("pixelRatio","float"),v.fragment.code.add(t$10`float distToInner = abs(vLineDistance * gl_FragCoord.w) - innerWidth;
float innerAA = clamp(0.5 - distToInner, 0.0, 1.0);
float innerAlpha = innerColor.a + color.a * (1.0 - innerColor.a);
color = mix(color, vec4(innerColor.rgb, innerAlpha), innerAA);`)),v.fragment.code.add(t$10`vec4 finalColor = blendStipple(color, stippleAlpha);`),c.falloffEnabled&&v.fragment.code.add(t$10`finalColor.a *= pow(max(0.0, 1.0 - abs(vLineDistanceNorm * gl_FragCoord.w)), falloff);`),v.fragment.code.add(t$10`
    if (finalColor.a < ${t$10.float(o$10)}) {
      discard;
    }

    ${7===c.output?t$10`gl_FragColor = vec4(finalColor.a);`:""}
    ${0===c.output?t$10`gl_FragColor = highlightSlice(finalColor, vpos);`:""}
    ${0===c.output&&c.OITEnabled?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""}
    ${4===c.output?t$10`gl_FragColor = vec4(1.0);`:""}
    ${1===c.output?t$10`outputDepth(linearDepth);`:""}
  }
  `),v}var v$p=Object.freeze({__proto__:null,build:c$x});

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
const z$d=new Map([["position",0],["subdivisionFactor",1],["uv0",2],["auxpos1",3],["auxpos2",4],["size",6],["sizeFeatureAttribute",6],["color",5],["colorFeatureAttribute",5],["opacityFeatureAttribute",7]]);class I$i extends t$11{constructor(e,t,i){super(e,t,i),this.stippleTextureRepository=e.stippleTextureRepository;}initializeProgram(e){const t=I$i.shader.get(),i=this.configuration,r=t.build({OITEnabled:0===i.transparencyPassType,output:i.output,slicePlaneEnabled:i.slicePlaneEnabled,sliceHighlightDisabled:!1,sliceEnabledForVertexPrograms:!1,stippleEnabled:i.stippleEnabled,stippleOffColorEnabled:i.stippleOffColorEnabled,stippleUVMaxEnabled:i.stippleIntegerRepeatsEnabled,stippleIntegerRepeatsEnabled:i.stippleIntegerRepeatsEnabled,roundCaps:i.roundCaps,roundJoins:i.roundJoins,vvColor:i.vvColor,vvSize:i.vvSize,vvInstancingEnabled:!0,vvOpacity:i.vvOpacity,falloffEnabled:i.falloffEnabled,innerColorEnabled:i.innerColorEnabled,multipassTerrainEnabled:i.multipassTerrainEnabled,cullAboveGround:i.cullAboveGround});return new n$16(e.rctx,r,z$d)}dispose(){super.dispose(),this.stippleTextureRepository.release(this.stipplePattern),this.stipplePattern=null,this.stippleTextureBind=null;}bindPass(e,o){if(t$15(this.program,o.camera.projectionMatrix),4===this.configuration.output&&g$V(this.program,o),o.multipassTerrainEnabled&&(this.program.setUniform2fv("inverseViewport",o.inverseViewport),t$1f(this.program,o)),this.program.setUniform1f("intrinsicWidth",e.width),this.program.setUniform4fv("intrinsicColor",e.color),this.program.setUniform1f("miterLimit","miter"!==e.join?0:e.miterLimit),this.program.setUniform2fv("cameraNearFar",o.camera.nearFar),this.program.setUniform1f("pixelRatio",o.camera.pixelRatio),this.program.setUniform2f("screenSize",o.camera.fullViewport[2],o.camera.fullViewport[3]),r$1k(this.program,e),this.stipplePattern!==e.stipplePattern){const t=e.stipplePattern;this.stippleTextureBind=this.stippleTextureRepository.swap(this.stipplePattern,t),this.stipplePattern=t;}if(this.configuration.stippleEnabled){const r=r$Y(this.stippleTextureBind)?this.stippleTextureBind(this.program)*o.camera.pixelRatio:1;if(this.program.setUniform1f("stipplePatternPixelSizeInv",1/r),this.configuration.stippleOffColorEnabled){const t=e$12(e.stippleOffColor);this.program.setUniform4f("stippleOffColor",t[0],t[1],t[2],t.length>3?t[3]:1);}}this.configuration.falloffEnabled&&this.program.setUniform1f("falloff",e.falloff),this.configuration.innerColorEnabled&&(this.program.setUniform4fv("innerColor",c$W(e.innerColor,e.color)),this.program.setUniform1f("innerWidth",e.innerWidth*o.camera.pixelRatio));}bindDraw(e){a$17(this.program,e),l$_(this.program,this.configuration,e),this.program.rebindTextures();}setPipelineState(e,t){const i=this.configuration,r=3===e,o=2===e;return g$S({blending:0===i.output||7===i.output?r?u$$:c$11(e):null,depthTest:{func:a$1d(e)},depthWrite:r?!i.transparent&&i.writeDepth&&l$$:l$17(e),colorWrite:r$13,stencilWrite:i.sceneHasOcludees?f$T:null,stencilTest:i.sceneHasOcludees?t?t$1k:c$15:null,polygonOffset:r||o?i.polygonOffset&&L$e:i$$})}initializePipeline(){const e=this.configuration,t=e.polygonOffset&&L$e;return e.occluder&&(this._occluderPipelineTransparent=g$S({blending:u$$,polygonOffset:t,depthTest:n$1m,depthWrite:null,colorWrite:r$13,stencilWrite:null,stencilTest:e$15}),this._occluderPipelineOpaque=g$S({blending:u$$,polygonOffset:t,depthTest:n$1m,depthWrite:null,colorWrite:r$13,stencilWrite:i$10,stencilTest:u$10}),this._occluderPipelineMaskWrite=g$S({blending:null,polygonOffset:t,depthTest:a$1e,depthWrite:null,colorWrite:null,stencilWrite:f$T,stencilTest:t$1k})),this._occludeePipelineState=this.setPipelineState(this.configuration.transparencyPassType,!0),this.setPipelineState(this.configuration.transparencyPassType,!1)}get primitiveType(){return 5}getPipelineState(e,t){return t?this._occludeePipelineState:this.configuration.occluder?11===e?this._occluderPipelineTransparent:10===e?this._occluderPipelineOpaque:this._occluderPipelineMaskWrite:this.pipeline}}I$i.shader=new t$12(v$p,(()=>import('./RibbonLine.glsl-104c9485.js')));const L$e={factor:0,units:-4};class V$d extends e$S{constructor(){super(...arguments),this.output=0,this.occluder=!1,this.slicePlaneEnabled=!1,this.transparent=!1,this.polygonOffset=!1,this.writeDepth=!1,this.stippleEnabled=!1,this.stippleOffColorEnabled=!1,this.stippleIntegerRepeatsEnabled=!1,this.roundCaps=!1,this.roundJoins=!1,this.vvSize=!1,this.vvColor=!1,this.vvOpacity=!1,this.falloffEnabled=!1,this.innerColorEnabled=!1,this.sceneHasOcludees=!1,this.transparencyPassType=3,this.multipassTerrainEnabled=!1,this.cullAboveGround=!1;}}e$Q([r$12({count:8})],V$d.prototype,"output",void 0),e$Q([r$12()],V$d.prototype,"occluder",void 0),e$Q([r$12()],V$d.prototype,"slicePlaneEnabled",void 0),e$Q([r$12()],V$d.prototype,"transparent",void 0),e$Q([r$12()],V$d.prototype,"polygonOffset",void 0),e$Q([r$12()],V$d.prototype,"writeDepth",void 0),e$Q([r$12()],V$d.prototype,"stippleEnabled",void 0),e$Q([r$12()],V$d.prototype,"stippleOffColorEnabled",void 0),e$Q([r$12()],V$d.prototype,"stippleIntegerRepeatsEnabled",void 0),e$Q([r$12()],V$d.prototype,"roundCaps",void 0),e$Q([r$12()],V$d.prototype,"roundJoins",void 0),e$Q([r$12()],V$d.prototype,"vvSize",void 0),e$Q([r$12()],V$d.prototype,"vvColor",void 0),e$Q([r$12()],V$d.prototype,"vvOpacity",void 0),e$Q([r$12()],V$d.prototype,"falloffEnabled",void 0),e$Q([r$12()],V$d.prototype,"innerColorEnabled",void 0),e$Q([r$12()],V$d.prototype,"sceneHasOcludees",void 0),e$Q([r$12({count:4})],V$d.prototype,"transparencyPassType",void 0),e$Q([r$12()],V$d.prototype,"multipassTerrainEnabled",void 0),e$Q([r$12()],V$d.prototype,"cullAboveGround",void 0);

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
const T$f=n$12.getLogger("esri.views.3d.webgl-engine.materials.RibbonLineMaterial");class M$m extends a$18{constructor(e){super(e,D$e),this._vertexAttributeLocations=z$d,this.techniqueConfig=new V$d,this.layout=this.createLayout();}isClosed(e,t){return B$a(this.params,e,t)}dispose(){}getPassParameters(){return this.params}getTechniqueConfig(e,t){this.techniqueConfig.output=e;const s=r$Y(this.params.stipplePattern);return this.techniqueConfig.stippleEnabled=s,this.techniqueConfig.stippleIntegerRepeatsEnabled=s&&this.params.stippleIntegerRepeats,this.techniqueConfig.stippleOffColorEnabled=s&&r$Y(this.params.stippleOffColor),this.techniqueConfig.slicePlaneEnabled=this.params.slicePlaneEnabled,this.techniqueConfig.sceneHasOcludees=this.params.sceneHasOcludees,this.techniqueConfig.roundJoins="round"===this.params.join,this.techniqueConfig.roundCaps="round"===this.params.cap,this.techniqueConfig.transparent=this.params.transparent,this.techniqueConfig.polygonOffset=this.params.polygonOffset,this.techniqueConfig.writeDepth=this.params.writeDepth,this.techniqueConfig.vvColor=this.params.vvColorEnabled,this.techniqueConfig.vvOpacity=this.params.vvOpacityEnabled,this.techniqueConfig.vvSize=this.params.vvSizeEnabled,this.techniqueConfig.innerColorEnabled=this.params.innerWidth>0&&r$Y(this.params.innerColor),this.techniqueConfig.falloffEnabled=this.params.falloff>0,this.techniqueConfig.occluder=8===this.params.renderOccluded,this.techniqueConfig.transparencyPassType=t?t.transparencyPassType:3,this.techniqueConfig.multipassTerrainEnabled=!!t&&t.multipassTerrainEnabled,this.techniqueConfig.cullAboveGround=!!t&&t.cullAboveGround,this.techniqueConfig}intersect(e,t,i,s,r,a,n,o,u){u?this.intersectDrapedLineGeometry(e,s,a,n):this.intersectLineGeometry(e,t,i,s,this.params.width,n);}intersectDrapedLineGeometry(e,i,s,r){if(!i.options.selectionMode)return;const a=e.vertexAttributes.get("position").data,n=e.vertexAttributes.get("size");let o=this.params.width;if(this.params.vvSizeEnabled){const i=e.vertexAttributes.get("sizeFeatureAttribute").data[0];o*=o$R(this.params.vvSizeOffset[0]+i*this.params.vvSizeFactor[0],this.params.vvSizeMinSize[0],this.params.vvSizeMaxSize[0]);}else n&&(o*=n.data[0]);const u=s[0],l=s[1],c=(o/2+4)*e.screenToWorldRatio;let p=Number.MAX_VALUE;for(let h=0;h<a.length-5;h+=3){const e=a[h],i=a[h+1],s=u-e,r=l-i,n=a[h+3]-e,o=a[h+4]-i,c=o$R((n*s+o*r)/(n*n+o*o),0,1),m=n*c-s,f=o*c-r,d=m*m+f*f;d<p&&(p=d);}p<c*c&&r();}intersectLineGeometry(e,i,s,m,f,g){if(!m.options.selectionMode||f$N(i))return;if(!A$z(s))return void T$f.error("intersection assumes a translation-only matrix");const A=e.vertexAttributes,y=A.get("position").data;let x=f;if(this.params.vvSizeEnabled){const e=A.get("sizeFeatureAttribute").data[0];x*=o$R(this.params.vvSizeOffset[0]+e*this.params.vvSizeFactor[0],this.params.vvSizeMinSize[0],this.params.vvSizeMaxSize[0]);}else A.has("size")&&(x*=A.get("size").data[0]);const z=m.camera,E=X$8;a$13(E,m.point);const j=x*z.pixelRatio/2+4*z.pixelRatio;o$S(re$6[0],E[0]-j,E[1]+j,0),o$S(re$6[1],E[0]+j,E[1]+j,0),o$S(re$6[2],E[0]+j,E[1]-j,0),o$S(re$6[3],E[0]-j,E[1]-j,0);for(let t=0;t<4;t++)if(!z.unprojectFromRenderScreen(re$6[t],ae$6[t]))return;M$w(z.eye,ae$6[0],ae$6[1],ne$6),M$w(z.eye,ae$6[1],ae$6[2],oe$6),M$w(z.eye,ae$6[2],ae$6[3],ue$4),M$w(z.eye,ae$6[3],ae$6[0],le$8);let O=Number.MAX_VALUE;const _=V$c(this.params,A,e.indices)?y.length-2:y.length-5;for(let t=0;t<_;t+=3){W$a[0]=y[t]+s[12],W$a[1]=y[t+1]+s[13],W$a[2]=y[t+2]+s[14];const e=(t+3)%y.length;if(k$f[0]=y[e]+s[12],k$f[1]=y[e+1]+s[13],k$f[2]=y[e+2]+s[14],R$s(ne$6,W$a)<0&&R$s(ne$6,k$f)<0||R$s(oe$6,W$a)<0&&R$s(oe$6,k$f)<0||R$s(ue$4,W$a)<0&&R$s(ue$4,k$f)<0||R$s(le$8,W$a)<0&&R$s(le$8,k$f)<0)continue;if(z.projectToRenderScreen(W$a,K$b),z.projectToRenderScreen(k$f,Q$b),K$b[2]<0&&Q$b[2]>0){c$V(I$h,W$a,k$f);const e=z.frustum,t=-R$s(e[4],W$a)/z$u(I$h,W$j(e[4]));d$O(I$h,I$h,t),u$S(W$a,W$a,I$h),z.projectToRenderScreen(W$a,K$b);}else if(K$b[2]>0&&Q$b[2]<0){c$V(I$h,k$f,W$a);const e=z.frustum,t=-R$s(e[4],k$f)/z$u(I$h,W$j(e[4]));d$O(I$h,I$h,t),u$S(k$f,k$f,I$h),z.projectToRenderScreen(k$f,Q$b);}else if(K$b[2]<0&&Q$b[2]<0)continue;K$b[2]=0,Q$b[2]=0;const i=b$E(l$18(K$b,Q$b,$$c),E);i<O&&(O=i,r$Z(Y$b,W$a),r$Z(Z$8,k$f));}const R=m.rayBeginPoint,w=m.rayEndPoint;if(O<j*j){let e=Number.MAX_VALUE;if(k$D(l$18(Y$b,Z$8,$$c),l$18(R,w,ee$7),N$d)){c$V(N$d,N$d,R);const t=s$P(N$d);d$O(N$d,N$d,1/t),e=t/q$o(R,w);}g(e,N$d);}}computeAttachmentOrigin(e,t){const i=e.vertexAttributes;if(!i)return null;const s=e.indices,r=i.get("position");return g$W(r,s?s.get("position"):null,s&&V$c(this.params,i,s),t)}createLayout(){const e=A$u().vec3f("position").f32("subdivisionFactor").vec2f("uv0").vec3f("auxpos1").vec3f("auxpos2");return this.params.vvSizeEnabled?e.f32("sizeFeatureAttribute"):e.f32("size"),this.params.vvColorEnabled?e.f32("colorFeatureAttribute"):e.vec4f("color"),this.params.vvOpacityEnabled&&e.f32("opacityFeatureAttribute"),e}createBufferWriter(){return new G$b(this.layout,this.params)}getGLMaterial(e){return 0===e.output||7===e.output||4===e.output||1===e.output?new F$i(e):void 0}validateParameterValues(e){"miter"!==e.join&&(e.miterLimit=0),this.requiresTransparent(e)&&(e.transparent=!0);}requiresTransparent(e){return !!((e.color&&e.color[3])<1||e.innerWidth>0&&this.colorRequiresTransparent(e.innerColor)||e.stipplePattern&&this.colorRequiresTransparent(e.stippleOffColor)||e.falloff>0)}colorRequiresTransparent(e){return r$Y(e)&&e[3]<1&&e[3]>0}}class F$i extends t$1i{constructor(e){super(e),this.updateParameters();}updateParameters(e){this._technique=this._techniqueRep.releaseAndAcquire(I$i,this._material.getTechniqueConfig(this._output,e),this._technique);}beginSlot(e){return this._technique.configuration.occluder?3===e||10===e||11===e:0===this._output||7===this._output?(this.targetSlot=this._technique.configuration.writeDepth?5:8,e===this.targetSlot):3===e}_updateOccludeeState(e){e.hasOccludees!==this._material.params.sceneHasOcludees&&this._material.setParameterValues({sceneHasOcludees:e.hasOccludees});}ensureParameters(e){0!==this._output&&7!==this._output||this._updateOccludeeState(e),this.updateParameters(e);}bind(e){this._technique.bindPass(this._material.getPassParameters(),e);}getPipelineState(e,t){return this._technique.getPipelineState(e,t)}}const D$e={width:0,color:[1,1,1,1],join:"miter",cap:"butt",miterLimit:5,writeDepth:!0,polygonOffset:!1,stipplePattern:null,stippleIntegerRepeats:!1,stippleOffColor:null,slicePlaneEnabled:!1,vvFastUpdate:!1,transparent:!1,isClosed:!1,falloff:0,innerWidth:0,innerColor:null,sceneHasOcludees:!1,...d$$,...o$y.Default};class G$b{constructor(e,t){switch(this.params=t,this.numJoinSubdivisions=0,this.vertexBufferLayout=e,this.params.join){case"miter":case"bevel":this.numJoinSubdivisions=t.stipplePattern?1:0;break;case"round":this.numJoinSubdivisions=H$a;}}isClosed(e){return V$c(this.params,e.vertexAttributes,e.indices)}numCapSubdivisions(e){if(this.isClosed(e))return 0;switch(this.params.cap){case"butt":return 0;case"square":return 1;case"round":return J$b}}allocate(e){return this.vertexBufferLayout.createBuffer(e)}elementCount(e){const t=2*this.numCapSubdivisions(e)+2,i=e.indices.get("position").length/2+1,s=this.isClosed(e);let r=s?2:2*t;const a=s?0:1,n=s?i:i-1;if(e.vertexAttributes.has("subdivisions")){const t=e.vertexAttributes.get("subdivisions").data;for(let e=a;e<n;++e){r+=4+2*t[e];}}else {r+=(n-a)*(2*this.numJoinSubdivisions+4);}return r+=2,r}write(e,t,i,s){const r=te$6,n=ie$5,o=se$8,u=t.vertexAttributes.get("position").data,l=t.indices&&t.indices.get("position"),p=this.numCapSubdivisions(t);l&&l.length!==2*(u.length/3-1)&&console.warn("RibbonLineMaterial does not support indices");let h=null;t.vertexAttributes.has("subdivisions")&&(h=t.vertexAttributes.get("subdivisions").data);let f=1,d=0;this.params.vvSizeEnabled?d=t.vertexAttributes.get("sizeFeatureAttribute").data[0]:t.vertexAttributes.has("size")&&(f=t.vertexAttributes.get("size").data[0]);let v=[1,1,1,1],b=0;this.params.vvColorEnabled?b=t.vertexAttributes.get("colorFeatureAttribute").data[0]:t.vertexAttributes.has("color")&&(v=t.vertexAttributes.get("color").data);let g=0;this.params.vvOpacityEnabled&&(g=t.vertexAttributes.get("opacityFeatureAttribute").data[0]);const C=u.length/3,S=e.transformation,q=new Float32Array(i.buffer),A=this.vertexBufferLayout.stride/4;let y=s*A;const x=y,z=(e,t,i,s,r,a,n)=>{if(q[y++]=t[0],q[y++]=t[1],q[y++]=t[2],q[y++]=s,q[y++]=r,q[y++]=a,q[y++]=e[0],q[y++]=e[1],q[y++]=e[2],q[y++]=i[0],q[y++]=i[1],q[y++]=i[2],this.params.vvSizeEnabled?q[y++]=d:q[y++]=f,this.params.vvColorEnabled)q[y++]=b;else {const e=Math.min(4*n,v.length-4);q[y++]=v[e+0],q[y++]=v[e+1],q[y++]=v[e+2],q[y++]=v[e+3];}this.params.vvOpacityEnabled&&(q[y++]=g);};y+=A,o$S(n,u[0],u[1],u[2]),S&&I$x(n,n,S);const E=this.isClosed(t);if(E){const e=u.length-3;o$S(r,u[e],u[e+1],u[e+2]),S&&I$x(r,r,S);}else {r$Z(r,n),o$S(o,u[3],u[4],u[5]),S&&I$x(o,o,S);for(let e=0;e<p;++e){const t=1-e/p;z(r,n,o,t,1,-4,0),z(r,n,o,t,1,4,0);}z(r,n,o,0,0,-4,0),z(r,n,o,0,0,4,0),r$Z(r,n),r$Z(n,o);}const j=E?C:C-1;for(let P=E?0:1;P<j;P++){const e=(P+1)%C*3;o$S(o,u[e+0],u[e+1],u[e+2]),S&&I$x(o,o,S),z(r,n,o,0,1,-1,P),z(r,n,o,0,1,1,P);const t=h?h[P]:this.numJoinSubdivisions;for(let i=0;i<t;++i){const e=(i+1)/(t+1);z(r,n,o,e,1,-2,P),z(r,n,o,e,1,2,P);}z(r,n,o,1,0,-2,P),z(r,n,o,1,0,2,P),r$Z(r,n),r$Z(n,o);}if(E){y=U$b(q,x+A,q,y,2*A);}else {z(r,n,o,0,1,-5,j),z(r,n,o,0,1,5,j);for(let e=0;e<p;++e){const t=(e+1)/p;z(r,n,o,t,1,-5,j),z(r,n,o,t,1,5,j);}}U$b(q,x+A,q,x,A);y=U$b(q,y-A,q,y,A);}}function U$b(e,t,i,s,r){for(let a=0;a<r;a++)i[s++]=e[t++];return s}function V$c(e,t,i){return B$a(e,t.get("position").data,i?i.get("position"):null)}function B$a(e,t,i){return !!e.isClosed&&(i?i.length>2:t.length>6)}const J$b=3,H$a=1,W$a=n$11(),k$f=n$11(),I$h=n$11(),N$d=n$11(),X$8=n$11(),K$b=x$Q(),Q$b=x$Q(),Y$b=n$11(),Z$8=n$11(),$$c=v$K(),ee$7=v$K(),te$6=n$11(),ie$5=n$11(),se$8=n$11(),re$6=[x$Q(),x$Q(),x$Q(),x$Q()],ae$6=[n$11(),n$11(),n$11(),n$11()],ne$6=p$11(),oe$6=p$11(),ue$4=p$11(),le$8=p$11();

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
let _$f=0;const m$u="rg_";class d$r{constructor(t){this._originSR=t,this.ROOT_ORIGIN_ID=m$u+"root_"+_$f++,this._origins=new Map,this._gridSize=125e4,this._objects=new Map;}getOrigin(i){const r=this._origins.get(this.ROOT_ORIGIN_ID);if(null==r){if(r$Y(g$w))return this._origins.set(this.ROOT_ORIGIN_ID,c$y(g$w[0],g$w[1],g$w[2],this.ROOT_ORIGIN_ID)),this.getOrigin(i);const s=c$y(i[0]+Math.random()-.5,i[1]+Math.random()-.5,i[2]+Math.random()-.5,this.ROOT_ORIGIN_ID);return this._origins.set(this.ROOT_ORIGIN_ID,s),s}const e=this._gridSize,o=Math.round(i[0]/e),a=Math.round(i[1]/e),h=Math.round(i[2]/e),c=`${m$u}${o}/${a}/${h}`;let _=this._origins.get(c);const d=.5*e;if(c$V(f$r,i,r.vec3),f$r[0]=Math.abs(f$r[0]),f$r[1]=Math.abs(f$r[1]),f$r[2]=Math.abs(f$r[2]),f$r[0]<d&&f$r[1]<d&&f$r[2]<d){if(_){const t=Math.max(...f$r);c$V(f$r,i,_.vec3),f$r[0]=Math.abs(f$r[0]),f$r[1]=Math.abs(f$r[1]),f$r[2]=Math.abs(f$r[2]);if(Math.max(...f$r)<t)return _}return r}return _||(_=c$y(o*e,a*e,h*e,c),this._origins.set(c,_)),_}_drawOriginBox(t,s=[1,1,0,1]){const r=window.view,n=r._stage,_=s.toString();if(!this._objects.has(_)){this._material=new M$m({width:2,color:s}),n.add(this._material);const t=new n$H({isPickable:!1}),i=new R$p({castShadow:!1});n.add(i),t.add(i),n.add(t),this._objects.set(_,i);}const m=this._objects.get(_),d=[0,1,5,4,0,2,1,7,6,2,0,1,3,7,5,4,6,2,0],g=d.length,O=new Array(3*g),f=new Uint16Array(2*(g-1)),l=.5*this._gridSize;for(let i=0;i<g;i++)O[3*i+0]=t[0]+(1&d[i]?l:-l),O[3*i+1]=t[1]+(2&d[i]?l:-l),O[3*i+2]=t[2]+(4&d[i]?l:-l),i>0&&(f[2*i+0]=i-1,f[2*i+1]=i);xn(O,this._originSR,0,O,r.renderSpatialReference,0,g);const I=new u$U([["position",{size:3,data:O,exclusive:!0}]],[["position",f]],2);n.add(I),m.addGeometry(I,this._material,a$10);}get test(){const t=this;return {get gridSize(){return t._gridSize},set gridSize(i){t._gridSize=i;}}}}let g$w=null;const f$r=n$11();

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class e$w{constructor(e){this.rctx=e,this.camera=null,this.lastFrameCamera=new J$g,this.pass=0,this.slot=0,this.highlightDepthTexture=null,this.renderOccludedMask=r$B,this.hasOccludees=!1;}resetRenderOccludedMask(){this.renderOccludedMask=r$B;}get isHighlightPass(){return 5===this.pass}}class t$B extends e$w{constructor(s,e,t,r,i,h){super(s),this.offscreenRenderingHelper=e,this.scenelightingData=t,this.shadowMap=r,this.ssaoHelper=i,this.sliceHelper=h;}}const r$B=13;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class r$A{constructor(){this.adds=new n$1h,this.removes=new n$1h,this.updates=new n$1h({allocator:e=>e||new s$v,deallocator:e=>(e.renderGeometry=null,e)});}clear(){this.adds.clear(),this.removes.clear(),this.updates.clear();}prune(){this.adds.prune(),this.removes.prune(),this.updates.prune();}}class s$v{}class t$A{constructor(){this.adds=new Array,this.removes=new Array,this.updates=new Array;}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
function r$z(r){const n=new Map,a=r=>{let t=n.get(r);return t||(t=new t$A,n.set(r,t)),t};return r.adds.forAll((e=>{t$z(e)&&a(e.material).adds.push(e);})),r.removes.forAll((e=>{t$z(e)&&a(e.material).removes.push(e);})),r.updates.forAll((e=>{t$z(e.renderGeometry)&&a(e.renderGeometry.material).updates.push(e);})),n}function t$z(e){return e.data.indexCount>=1}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class t$y{constructor(t){null==t?t=16:t<65536&&(t=i$_(t)),this._array=new Float32Array(t),this._size=0;}resize(r,t){if(this._size=r,this._size>this._array.length){let r=this._array.length||1;for(;r<this._size;)r*=2;const s=new Float32Array(r);return t&&s.set(this._array),this._array=s,!0}const s=2*this._size;if(s<=this._array.length){let r=this._array.length;for(;r>=s;)r=Math.floor(r/2);const a=new Float32Array(r);return t&&a.set(this._array.subarray(0,r)),this._array=a,!0}return !1}append(r){const t=this._size;this.resize(this._size+r.length,!0),this._array.set(r,t);}erase(r,t){for(let s=r;s<t;++s)this._array[s]=0;}get array(){return this._array}get size(){return this._size}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
function o$x(o){o.fragment.uniforms.add("lastFrameColorMap","sampler2D"),o.fragment.uniforms.add("reprojectionMat","mat4"),o.fragment.uniforms.add("rpProjectionMat","mat4"),o.fragment.code.add(t$10`vec2 reprojectionCoordinate(vec3 projectionCoordinate)
{
vec4 zw = rpProjectionMat * vec4(0.0, 0.0, -projectionCoordinate.z, 1.0);
vec4 reprojectedCoord = reprojectionMat * vec4(zw.w * (projectionCoordinate.xy * 2.0 - 1.0), zw.z, zw.w);
reprojectedCoord.xy /= reprojectedCoord.w;
return reprojectedCoord.xy * 0.5 + 0.5;
}`);}function e$v(r,o){r.bindTexture(o.lastFrameColorTexture,"lastFrameColorMap"),r.setUniformMatrix4fv("reprojectionMat",o.reprojectionMat),r.setUniformMatrix4fv("rpProjectionMat",o.camera.projectionMatrix);}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
function a$x(o,a){o.fragment.uniforms.add("nearFar","vec2"),o.fragment.uniforms.add("depthMapView","sampler2D"),o.fragment.uniforms.add("ssrViewMat","mat4"),o.fragment.uniforms.add("invResolutionHeight","float"),o.fragment.include(a$15),o.include(o$x),o.fragment.code.add(t$10`
  const int maxSteps = ${a.highStepCount?"150;":"75;"}

  vec4 applyProjectionMat(mat4 projectionMat, vec3 x)
  {
    vec4 projectedCoord =  projectionMat * vec4(x, 1.0);
    projectedCoord.xy /= projectedCoord.w;
    projectedCoord.xy = projectedCoord.xy*0.5 + 0.5;
    return projectedCoord;
  }

  vec3 screenSpaceIntersection(vec3 dir, vec3 startPosition, vec3 viewDir, vec3 normal)
  {
    vec3 viewPos = startPosition;
    vec3 viewPosEnd = startPosition;

    // Project the start position to the screen
    vec4 projectedCoordStart = applyProjectionMat(rpProjectionMat, viewPos);
    vec3  Q0 = viewPos / projectedCoordStart.w; // homogeneous camera space
    float k0 = 1.0/ projectedCoordStart.w;

    // advance the position in the direction of the reflection
    viewPos += dir;

    vec4 projectedCoordVanishingPoint = applyProjectionMat(rpProjectionMat, dir);

    // Project the advanced position to the screen
    vec4 projectedCoordEnd = applyProjectionMat(rpProjectionMat, viewPos);
    vec3  Q1 = viewPos / projectedCoordEnd.w; // homogeneous camera space
    float k1 = 1.0/ projectedCoordEnd.w;

    // calculate the reflection direction in the screen space
    vec2 projectedCoordDir = (projectedCoordEnd.xy - projectedCoordStart.xy);
    vec2 projectedCoordDistVanishingPoint = (projectedCoordVanishingPoint.xy - projectedCoordStart.xy);

    float yMod = min(abs(projectedCoordDistVanishingPoint.y), 1.0);

    float projectedCoordDirLength = length(projectedCoordDir);
    float maxSt = float(maxSteps);

    // normalize the projection direction depending on maximum steps
    // this determines how blocky the reflection looks
    vec2 dP = yMod * (projectedCoordDir)/(maxSt * projectedCoordDirLength);

    // Normalize the homogeneous camera space coordinates
    vec3  dQ = yMod * (Q1 - Q0)/(maxSt * projectedCoordDirLength);
    float dk = yMod * (k1 - k0)/(maxSt * projectedCoordDirLength);

    // initialize the variables for ray marching
    vec2 P = projectedCoordStart.xy;
    vec3 Q = Q0;
    float k = k0;
    float rayStartZ = -startPosition.z; // estimated ray start depth value
    float rayEndZ = -startPosition.z;   // estimated ray end depth value
    float prevEstimateZ = -startPosition.z;
    float rayDiffZ = 0.0;
    float dDepth;
    float depth;
    float rayDiffZOld = 0.0;

    // early outs
    if (dot(normal, dir) < 0.0 || dot(-viewDir, normal) < 0.0)
      return vec3(P, 0.0);

    for(int i = 0; i < maxSteps-1; i++)
    {
      depth = -linearDepthFromTexture(depthMapView, P, nearFar); // get linear depth from the depth buffer

      // estimate depth of the marching ray
      rayStartZ = prevEstimateZ;
      dDepth = -rayStartZ - depth;
      rayEndZ = (dQ.z * 0.5 + Q.z)/ ((dk * 0.5 + k));
      rayDiffZ = rayEndZ- rayStartZ;
      prevEstimateZ = rayEndZ;

      if(-rayEndZ > nearFar[1] || -rayEndZ < nearFar[0] || P.y < 0.0  || P.y > 1.0 )
      {
        return vec3(P, 0.);
      }

      // If we detect a hit - return the intersection point, two conditions:
      //  - dDepth > 0.0 - sampled point depth is in front of estimated depth
      //  - if difference between dDepth and rayDiffZOld is not too large
      //  - if difference between dDepth and 0.025/abs(k) is not too large
      //  - if the sampled depth is not behind far plane or in front of near plane

      if((dDepth) < 0.025/abs(k) + abs(rayDiffZ) && dDepth > 0.0 && depth > nearFar[0] && depth < nearFar[1] && abs(P.y - projectedCoordStart.y) > invResolutionHeight)
      {
          return vec3(P, depth);
      }

      // continue with ray marching
      P += dP;
      Q.z += dQ.z;
      k += dk;
      rayDiffZOld = rayDiffZ;
    }
    return vec3(P, 0.0);
  }
  `);}function i$n(e,t){t.ssrEnabled&&(e.bindTexture(t.linearDepthTexture,"depthMapView"),e.setUniform2fv("nearFar",t.camera.nearFar),e.setUniformMatrix4fv("ssrViewMat",t.camera.viewMatrix),e.setUniform1f("invResolutionHeight",1/t.camera.height),e$v(e,t));}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
function o$w(o){o.fragment.code.add(t$10`float normals2FoamIntensity(vec3 n, float waveStrength){
float normalizationFactor =  max(0.015, waveStrength);
return max((n.x + n.y)*0.3303545/normalizationFactor + 0.3303545, 0.0);
}`);}function n$G(o){o.fragment.code.add(t$10`vec3 foamIntensity2FoamColor(float foamIntensityExternal, float foamPixelIntensity, vec3 skyZenitColor, float dayMod){
return foamIntensityExternal * (0.075 * skyZenitColor * pow(foamPixelIntensity, 4.) +  50.* pow(foamPixelIntensity, 23.0)) * dayMod;
}`);}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
function r$y(r){r.fragment.uniforms.add("texWaveNormal","sampler2D"),r.fragment.uniforms.add("texWavePerturbation","sampler2D"),r.fragment.uniforms.add("waveParams","vec4"),r.fragment.uniforms.add("waveDirection","vec2"),r.include(o$w),r.fragment.code.add(t$10`const vec2  FLOW_JUMP = vec2(6.0/25.0, 5.0/24.0);
vec2 textureDenormalized2D(sampler2D _tex, vec2 _uv) {
return 2.0 * texture2D(_tex, _uv).rg - 1.0;
}
float sampleNoiseTexture(vec2 _uv) {
return texture2D(texWavePerturbation, _uv).b;
}
vec3 textureDenormalized3D(sampler2D _tex, vec2 _uv) {
return 2.0 * texture2D(_tex, _uv).rgb - 1.0;
}
float computeProgress(vec2 uv, float time) {
return fract(time);
}
float computeWeight(vec2 uv, float time) {
float progress = computeProgress(uv, time);
return 1.0 - abs(1.0 - 2.0 * progress);
}
vec3 computeUVPerturbedWeigth(sampler2D texFlow, vec2 uv, float time, float phaseOffset) {
float flowStrength = waveParams[2];
float flowOffset = waveParams[3];
vec2 flowVector = textureDenormalized2D(texFlow, uv) * flowStrength;
float progress = computeProgress(uv, time + phaseOffset);
float weight = computeWeight(uv, time + phaseOffset);
vec2 result = uv;
result -= flowVector * (progress + flowOffset);
result += phaseOffset;
result += (time - progress) * FLOW_JUMP;
return vec3(result, weight);
}
const float TIME_NOISE_TEXTURE_REPEAT = 0.3737;
const float TIME_NOISE_STRENGTH = 7.77;
vec3 getWaveLayer(sampler2D _texNormal, sampler2D _dudv, vec2 _uv, vec2 _waveDir, float time) {
float waveStrength = waveParams[0];
vec2 waveMovement = time * -_waveDir;
float timeNoise = sampleNoiseTexture(_uv * TIME_NOISE_TEXTURE_REPEAT) * TIME_NOISE_STRENGTH;
vec3 uv_A = computeUVPerturbedWeigth(_dudv, _uv + waveMovement, time + timeNoise, 0.0);
vec3 uv_B = computeUVPerturbedWeigth(_dudv, _uv + waveMovement, time + timeNoise, 0.5);
vec3 normal_A = textureDenormalized3D(_texNormal, uv_A.xy) * uv_A.z;
vec3 normal_B = textureDenormalized3D(_texNormal, uv_B.xy) * uv_B.z;
vec3 mixNormal = normalize(normal_A + normal_B);
mixNormal.xy *= waveStrength;
mixNormal.z = sqrt(1.0 - dot(mixNormal.xy, mixNormal.xy));
return mixNormal;
}
vec4 getSurfaceNormalAndFoam(vec2 _uv, float _time) {
float waveTextureRepeat = waveParams[1];
vec3 normal = getWaveLayer(texWaveNormal, texWavePerturbation, _uv * waveTextureRepeat, waveDirection, _time);
float foam  = normals2FoamIntensity(normal, waveParams[0]);
return vec4(normal, foam);
}`);}function a$w(e,t){e.setUniform4f("waveParams",t.waveStrength,t.waveTextureRepeat,t.flowStrength,t.flowOffset),e.setUniform2f("waveDirection",t.waveDirection[0]*t.waveVelocity,t.waveDirection[1]*t.waveVelocity);}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
function n$F(n,r){1===r.viewingMode?n.vertex.code.add(t$10`vec3 getLocalUp(in vec3 pos, in vec3 origin) {
return normalize(pos + origin);
}`):n.vertex.code.add(t$10`vec3 getLocalUp(in vec3 pos, in vec3 origin) {
return vec3(0.0, 0.0, 1.0);
}`),1===r.viewingMode?n.vertex.code.add(t$10`mat3 getTBNMatrix(in vec3 n) {
vec3 t = normalize(cross(vec3(0.0, 0.0, 1.0), n));
vec3 b = normalize(cross(n, t));
return mat3(t, b, n);
}`):n.vertex.code.add(t$10`mat3 getTBNMatrix(in vec3 n) {
vec3 t = vec3(1.0, 0.0, 0.0);
vec3 b = normalize(cross(n, t));
return mat3(t, b, n);
}`);}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
function e$u(e){e.fragment.code.add(t$10`const float GAMMA = 2.2;
const float INV_GAMMA = 0.4545454545;
vec4 delinearizeGamma(vec4 color) {
return vec4(pow(color.rgb, vec3(INV_GAMMA)), color.w);
}
vec3 linearizeGamma(vec3 color) {
return pow(color, vec3(GAMMA));
}`);}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
function a$v(a,n){a.include(a$1f,n),a.include(e$u),a.include(n$G),n.ssrEnabled&&a.include(a$x,n),a.fragment.constants.add("fresnelSky","vec3",[.02,1,15]).add("fresnelMaterial","vec2",[.02,.1]).add("roughness","float",.015).add("foamIntensityExternal","float",1.7).add("ssrIntensity","float",.65).add("ssrHeightFadeStart","float",3e5).add("ssrHeightFadeEnd","float",5e5).add("waterDiffusion","float",.775).add("waterSeeColorMod","float",.8).add("correctionViewingPowerFactor","float",.4).add("skyZenitColor","vec3",[.52,.68,.9]).add("skyColor","vec3",[.67,.79,.9]),a.fragment.code.add(t$10`PBRShadingWater shadingInfo;
vec3 getSkyGradientColor(in float cosTheta, in vec3 horizon, in vec3 zenit) {
float exponent = pow((1.0 - cosTheta), fresnelSky[2]);
return mix(zenit, horizon, exponent);
}`),a.fragment.code.add(t$10`vec3 getSeaColor(in vec3 n, in vec3 v, in vec3 l, vec3 color, in vec3 lightIntensity, in vec3 localUp, in float shadow, float foamIntensity, vec3 positionView) {
float reflectionHit = 0.;
vec3 seaWaterColor = linearizeGamma(color);
vec3 h = normalize(l + v);
shadingInfo.NdotL = clamp(dot(n, l), 0.0, 1.0);
shadingInfo.NdotV = clamp(dot(n, v), 0.001, 1.0);
shadingInfo.VdotN = clamp(dot(v, n), 0.001, 1.0);
shadingInfo.NdotH = clamp(dot(n, h), 0.0, 1.0);
shadingInfo.VdotH = clamp(dot(v, h), 0.0, 1.0);
shadingInfo.LdotH = clamp(dot(l, h), 0.0, 1.0);
float upDotV = max(dot(localUp,v), 0.0);
vec3 skyHorizon = linearizeGamma(skyColor);
vec3 skyZenit = linearizeGamma(skyZenitColor);
vec3 skyColor = getSkyGradientColor(upDotV, skyHorizon, skyZenit );
float upDotL = max(dot(localUp,l),0.0);
float daytimeMod = 0.1 + upDotL * 0.9;
skyColor *= daytimeMod;
float shadowModifier = clamp(shadow, 0.8, 1.0);
vec3 fresnelModifier = fresnelReflection(shadingInfo.VdotN, vec3(fresnelSky[0]), fresnelSky[1]);
vec3 reflSky = fresnelModifier * skyColor * shadowModifier;
vec3 reflSea = seaWaterColor * mix(skyColor, upDotL * lightIntensity * LIGHT_NORMALIZATION, 2.0 / 3.0) * shadowModifier;
vec3 specular = vec3(0.0);
if(upDotV > 0.0 && upDotL > 0.0) {
vec3 specularSun = brdfSpecularWater(shadingInfo, roughness, vec3(fresnelMaterial[0]), fresnelMaterial[1]);
vec3 incidentLight = lightIntensity * LIGHT_NORMALIZATION * shadow;
specular = shadingInfo.NdotL * incidentLight * specularSun;
}
vec3 foam = vec3(0.0);
if(upDotV > 0.0) {
foam = foamIntensity2FoamColor(foamIntensityExternal, foamIntensity, skyZenitColor, daytimeMod);
}`),n.ssrEnabled?a.fragment.code.add(t$10`vec4 viewPosition = vec4(positionView.xyz, 1.0);
vec3 viewDir = normalize(viewPosition.xyz);
vec4 viewNormalVectorCoordinate = ssrViewMat *vec4(n, 0.0);
vec3 viewNormal = normalize(viewNormalVectorCoordinate.xyz);
vec4 viewUp = ssrViewMat *vec4(localUp, 0.0);
float correctionViewingFactor = pow(max(dot(-viewDir, viewUp.xyz), 0.0), correctionViewingPowerFactor);
vec3 viewNormalCorrected = mix(viewUp.xyz, viewNormal, correctionViewingFactor);
vec3 reflected = normalize(reflect(viewDir, viewNormalCorrected));
vec3 hitCoordinate = screenSpaceIntersection( normalize(reflected), viewPosition.xyz, viewDir, viewUp.xyz);
vec3 reflectedColor = vec3(0.0);
if (hitCoordinate.z > 0.0)
{
vec2 reprojectedCoordinate = reprojectionCoordinate(hitCoordinate);
vec2 dCoords = smoothstep(0.3, 0.6, abs(vec2(0.5, 0.5) - hitCoordinate.xy));
float heightMod = smoothstep(ssrHeightFadeEnd, ssrHeightFadeStart, -positionView.z);
reflectionHit = waterDiffusion * clamp(1.0 - (1.3*dCoords.y), 0.0, 1.0) * heightMod;
reflectedColor = linearizeGamma(texture2D(lastFrameColorMap, reprojectedCoordinate).xyz)* reflectionHit * fresnelModifier.y * ssrIntensity;
}
float seeColorMod =  mix(waterSeeColorMod, waterSeeColorMod*0.5, reflectionHit);
return tonemapACES((1. - reflectionHit) * reflSky + reflectedColor + reflSea * seeColorMod + specular + foam);
}`):a.fragment.code.add(t$10`return tonemapACES(reflSky + reflSea * waterSeeColorMod + specular + foam);
}`);}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
function p$x(p){const u=new n$15;return u.include(r$11,{linearDepth:!1}),u.attributes.add("position","vec3"),u.attributes.add("uv0","vec2"),u.vertex.uniforms.add("proj","mat4").add("view","mat4").add("localOrigin","vec3"),u.vertex.uniforms.add("waterColor","vec4"),0!==p.output&&7!==p.output||(u.include(n$F,p),u.include(a$1g,p),u.varyings.add("vuv","vec2"),u.varyings.add("vpos","vec3"),u.varyings.add("vnormal","vec3"),u.varyings.add("vtbnMatrix","mat3"),p.multipassTerrainEnabled&&u.varyings.add("depth","float"),u.vertex.code.add(t$10`
      void main(void) {
        if (waterColor.a < ${t$10.float(o$10)}) {
          // Discard this vertex
          gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
          return;
        }

        vuv = uv0;
        vpos = position;

        vnormal = getLocalUp(vpos, localOrigin);
        vtbnMatrix = getTBNMatrix(vnormal);

        ${p.multipassTerrainEnabled?"depth = (view * vec4(vpos, 1.0)).z;":""}

        gl_Position = transformPosition(proj, view, vpos);
        ${0===p.output?"forwardLinearDepth();":""}
      }
    `)),p.multipassTerrainEnabled&&(u.fragment.include(a$15),u.include(r$1j,p)),7===p.output&&(u.include(c$$,p),u.fragment.uniforms.add("waterColor","vec4"),u.fragment.code.add(t$10`
        void main() {
          discardBySlice(vpos);
          ${p.multipassTerrainEnabled?"terrainDepthTest(gl_FragCoord, depth);":""}

          gl_FragColor = vec4(waterColor.a);
        }
      `)),0===p.output&&(u.include(r$y,p),u.include(c$$,p),p.receiveShadows&&u.include(t$1l,p),u.include(a$v,p),u.fragment.uniforms.add("waterColor","vec4").add("lightingMainDirection","vec3").add("lightingMainIntensity","vec3").add("camPos","vec3").add("timeElapsed","float").add("view","mat4"),u.fragment.include(e$U),u.fragment.code.add(t$10`
      void main() {
        discardBySlice(vpos);
        ${p.multipassTerrainEnabled?"terrainDepthTest(gl_FragCoord, depth);":""}
        vec3 localUp = vnormal;
        // the created normal is in tangent space
        vec4 tangentNormalFoam = getSurfaceNormalAndFoam(vuv, timeElapsed);

        // we rotate the normal according to the tangent-bitangent-normal-Matrix
        vec3 n = normalize(vtbnMatrix * tangentNormalFoam.xyz);
        vec3 v = -normalize(vpos - camPos);
        float shadow = ${p.receiveShadows?t$10`1.0 - readShadowMap(vpos, linearDepth)`:"1.0"};
        vec4 vPosView = view*vec4(vpos, 1.0);
        vec4 final = vec4(getSeaColor(n, v, lightingMainDirection, waterColor.rgb, lightingMainIntensity, localUp, shadow, tangentNormalFoam.w, vPosView.xyz), waterColor.w);

        // gamma correction
        gl_FragColor = delinearizeGamma(final);
        gl_FragColor = highlightSlice(gl_FragColor, vpos);
        ${p.OITEnabled?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""}
      }
    `)),2===p.output&&(u.include(n$F,p),u.include(r$y,p),u.include(c$$,p),u.varyings.add("vpos","vec3"),u.varyings.add("vuv","vec2"),u.vertex.code.add(t$10`
        void main(void) {
          if (waterColor.a < ${t$10.float(o$10)}) {
            // Discard this vertex
            gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
            return;
          }

          vuv = uv0;
          vpos = position;

          gl_Position = transformPosition(proj, view, vpos);
        }
    `),u.fragment.uniforms.add("timeElapsed","float"),u.fragment.code.add(t$10`void main() {
discardBySlice(vpos);
vec4 tangentNormalFoam = getSurfaceNormalAndFoam(vuv, timeElapsed);
tangentNormalFoam.xyz = normalize(tangentNormalFoam.xyz);
gl_FragColor = vec4((tangentNormalFoam.xyz + vec3(1.0)) * 0.5, tangentNormalFoam.w);
}`)),5===p.output&&(u.varyings.add("vpos","vec3"),u.vertex.code.add(t$10`
        void main(void) {
          if (waterColor.a < ${t$10.float(o$10)}) {
            // Discard this vertex
            gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
            return;
          }

          vpos = position;
          gl_Position = transformPosition(proj, view, vpos);
        }
    `),u.fragment.uniforms.add("waterColor","vec4"),u.fragment.code.add(t$10`void main() {
gl_FragColor = waterColor;
}`)),4===p.output&&(u.include(r$1g),u.varyings.add("vpos","vec3"),u.vertex.code.add(t$10`
      void main(void) {
        if (waterColor.a < ${t$10.float(o$10)}) {
          // Discard this vertex
          gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
          return;
        }

        vpos = position;
        gl_Position = transformPosition(proj, view, vpos);
      }
    `),u.include(c$$,p),u.fragment.code.add(t$10`void main() {
discardBySlice(vpos);
outputHighlight();
}`)),u}var u$u=Object.freeze({__proto__:null,build:p$x});

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class P$i extends t$11{constructor(r,t,e){super(r,t,e),this._textureRepository=r.waterTextureRepository;}initializeProgram(r){const t=P$i.shader.get(),e=this.configuration,i=t.build({OITEnabled:0===e.transparencyPassType,output:e.output,viewingMode:r.viewingMode,slicePlaneEnabled:e.slicePlaneEnabled,sliceHighlightDisabled:!1,sliceEnabledForVertexPrograms:!1,receiveShadows:e.receiveShadows,pbrMode:3,useCustomDTRExponentForWater:!0,ssrEnabled:e.useSSR,highStepCount:!0,multipassTerrainEnabled:e.multipassTerrainEnabled,cullAboveGround:e.cullAboveGround});return new n$16(r.rctx,i,o$X)}ensureResource(r){return this._textureRepository.ready||this._textureRepository.updating||this._textureRepository.loadTextures(r),this._textureRepository.ready?2:1}bindPass(r,t){t$15(this.program,t.camera.projectionMatrix),t.multipassTerrainEnabled&&(this.program.setUniform2fv("cameraNearFar",t.camera.nearFar),this.program.setUniform2fv("inverseViewport",t.inverseViewport),t$1f(this.program,t)),0===this.configuration.output&&(t.lighting.setUniforms(this.program,!1),i$n(this.program,t)),0!==this.configuration.output&&2!==this.configuration.output||(a$w(this.program,r),this._textureRepository.bind(this.program)),this.program.setUniform4fv("waterColor",r.color),4===this.configuration.output&&g$V(this.program,t);}bindDraw(r){a$17(this.program,r),this.program.rebindTextures(),0!==this.configuration.output&&7!==this.configuration.output||o$12(this.program,r.origin,r.camera.viewInverseTransposeMatrix),0===this.configuration.output&&o$16(this.program,r),0!==this.configuration.output&&7!==this.configuration.output&&4!==this.configuration.output||l$_(this.program,this.configuration,r);}setPipelineState(r){const t=this.configuration,e=3===r,i=2===r;return g$S({blending:2!==t.output&&4!==t.output&&t.transparent?e?u$$:c$11(r):null,depthTest:{func:a$1d(r)},depthWrite:e?t.writeDepth&&l$$:l$17(r),colorWrite:r$13,polygonOffset:e||i?null:s$_(t.enableOffset)})}initializePipeline(){return this.setPipelineState(this.configuration.transparencyPassType)}}P$i.shader=new t$12(u$u,(()=>import('./WaterSurface.glsl-07b5875a.js')));class R$g extends e$S{constructor(){super(...arguments),this.output=0,this.receiveShadows=!1,this.slicePlaneEnabled=!1,this.transparent=!1,this.enableOffset=!0,this.writeDepth=!1,this.useSSR=!1,this.isDraped=!1,this.transparencyPassType=3,this.multipassTerrainEnabled=!1,this.cullAboveGround=!1;}}e$Q([r$12({count:8})],R$g.prototype,"output",void 0),e$Q([r$12()],R$g.prototype,"receiveShadows",void 0),e$Q([r$12()],R$g.prototype,"slicePlaneEnabled",void 0),e$Q([r$12()],R$g.prototype,"transparent",void 0),e$Q([r$12()],R$g.prototype,"enableOffset",void 0),e$Q([r$12()],R$g.prototype,"writeDepth",void 0),e$Q([r$12()],R$g.prototype,"useSSR",void 0),e$Q([r$12()],R$g.prototype,"isDraped",void 0),e$Q([r$12({count:4})],R$g.prototype,"transparencyPassType",void 0),e$Q([r$12()],R$g.prototype,"multipassTerrainEnabled",void 0),e$Q([r$12()],R$g.prototype,"cullAboveGround",void 0);

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class a$u extends t$1i{constructor(e){super(e),this.updateParameters();}updateParameters(e){this._technique=this._techniqueRep.releaseAndAcquire(P$i,this._material.getTechniqueConfig(this._output,e),this._technique);}beginSlot(e){if(2===this._output)return 22===e;if(5===this._output)return null==e;if(4===this._output)return 3===e;let t=3;return this._material.params.transparent&&(t=this._material.params.writeDepth?5:8),e===t}setElapsedTimeUniform(e){const t=.001*this._material.animation.time;e.setUniform1f("timeElapsed",t*this._material.params.animationSpeed);}_updateShadowState(e){e.shadowMappingEnabled!==this._material.params.receiveShadows&&this._material.setParameterValues({receiveShadows:e.shadowMappingEnabled});}_updateSSRState(e){e.ssrEnabled!==this._material.params.ssrEnabled&&this._material.setParameterValues({ssrEnabled:e.ssrEnabled});}ensureResources(e){return this._technique.ensureResource(e)}ensureParameters(e){0===this._output&&(this._updateShadowState(e),this._updateSSRState(e)),this.updateParameters(e);}bind(e){this._technique.bindPass(this._material.params,e),2!==this._output&&0!==this._output||this.setElapsedTimeUniform(this._technique.program);}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class s$u{constructor(s,i,n,f,m,a){this.from=s,this.to=i,this.isVisible=n,this.hasHighlights=f,this.hasOccludees=m,this.transformation=a,null!=a&&(this.transformationNormal=r$1b(a),h$L(this.transformationNormal,this.transformationNormal),o$T(this.transformationNormal,this.transformationNormal));}}function i$m(t){return t.sort(((t,o)=>t.from===o.from?t.to>o.to?1:t.to<o.to?-1:0:t.from>o.from?1:t.from<o.from?-1:0))}function n$E(t,o){return t.first+t.count>=o.from}function f$q(t,o){const r=t=>({first:t.from,count:t.to-t.from});if(0===t.length)return void t.push(r(o));const s=t[t.length-1];if(n$E(s,o)){const t=o.from-s.first+o.to-o.from;s.count=t;}else t.push(r(o));}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
function e$t(e){const u=e.capabilities.disjointTimerQuery;return t$17(u)?null:u.timestampBits()>0?new i$l(u):r$x?null:new s$t(u)}class i$l{constructor(t){this.timer=t,this.start=t.createQuery(),t.createTimestamp(this.start);}stop(t,e=50){this.end=this.timer.createQuery(),this.timer.createTimestamp(this.end),this.checkQueryResult(t,e);}checkQueryResult(t,e){if(!this.timer.resultAvailable(this.end))return void setTimeout((()=>this.checkQueryResult(t,e)),e);if(this.timer.disjoint())return void t(null);const i=this.timer.getResult(this.start),s=this.timer.getResult(this.end);t((s-i)/1e6);}}class s$t{constructor(t){this.timer=t,this.query=t.createQuery(),r$x=!0,this.timer.beginTimeElapsed(this.query);}stop(t,e=50){this.timer.endTimeElapsed(),r$x=!1,this.checkQueryResult(t,e);}checkQueryResult(t,e){const i=this.timer.resultAvailable(this.query),s=this.timer.disjoint();if(!i||s)s?t(null):setTimeout((()=>this.checkQueryResult(t,e)),e);else {const e=this.timer.getResult(this.query);t(e/1e6);}}}let r$x=!1;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
const i$k=["prepare","shadowmap","lineardepth","normals","ssao","opaque","opaque edges","transparent","transparent edges","hudvisibility","transparent terrain","atmosphere","laserline","occluded","antialiasing","highlights","hudOccluded","hudNotoccluded"];class a$t{constructor(){this.triangles=0,this.drawCalls=0;}reset(){this.triangles=0,this.drawCalls=0;}}function o$v(t,s,r){r$Y(r)&&(r.drawCalls+=t,r.triangles+=s);}class n$D extends e$10{constructor(){super("total"),this.total=0,this.frameCount=0;}}class l$u{constructor(){this._startTime=0,this._lastSample=0,this._enableGPUTimer=0,this.totalTime=new n$D,this.gpuTime=new e$10("gpu",9),this.renderPassTimings=i$k.map((e=>new e$10(e))),this.stats=new a$t;}enableGPUTimer(){return ++this._enableGPUTimer,{remove:h$T((()=>--this._enableGPUTimer))}}prerender(e){this._startTime=this._lastSample=performance.now(),this._enableGPUTimer&&(this._gpuTimer=e$t(e));}advance(e){const t=performance.now();this.renderPassTimings[e].record(t-this._lastSample),this._lastSample=t;}postrender(){r$Y(this._gpuTimer)&&(this._gpuTimer.stop((t=>r$Y(t)&&this.gpuTime.record(t)),16),this._gpuTimer=null);const t=performance.now()-this._startTime;this.totalTime.record(t),this.totalTime.total+=t,this.totalTime.frameCount++;}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class v$o{constructor(e,t,s){this.type="MergedRenderer",this._dataByOrigin=new Map,this._hasHighlights=!1,this._hasOccludees=!1,this._rctx=e,this._material=s,this._materialRep=t,this._glMaterials=m$_(this._material,this._materialRep),this._bufferWriter=s.createBufferWriter();}dispose(){p$1b(this._material,this._materialRep),this._dataByOrigin&&(this._dataByOrigin.forEach((e=>{e.vao.dispose(!0),e.vao=null;})),this._dataByOrigin.clear(),this._dataByOrigin=null),this._glMaterials&&(this._glMaterials.forEach((e=>{e&&e.dispose();})),this._glMaterials.clear(),this._glMaterials=null);}get isEmpty(){return 0===this._dataByOrigin.size}get hasHighlights(){return this._hasHighlights}get hasOccludees(){return this._hasOccludees}get hasWater(){return !this.isEmpty&&n$1i(this._glMaterials,(e=>e instanceof a$u))}get rendersOccluded(){return !this.isEmpty&&1!==this._material.renderOccluded}modify(e){this.updateGeometries(e.updates),this.addAndRemoveGeometries(e.adds,e.removes),this.updateRenderCommands();}addAndRemoveGeometries(e,t){const s=this._bufferWriter,a=s.vertexBufferLayout,i=a.stride/4,r=this._dataByOrigin,n=H$9(r,s,e,t);n.forEach(((e,t)=>{n.delete(t);const s=e.optimalCount,o=e.sparseCount;let d=r.get(t);if(null==d)i$R(s>0),d=this.createData(a,s,e.origin),r.set(t,d);else if(0===s)return d.vao.dispose(!0),d.vao=null,void r.delete(t);const m=s<e.sparseCount/2,c=m?s:o,u=R$f,g=d.buffer.size,f=d.buffer.array,p=d.buffer.resize(c,!1);m||p?this.removeAndRebuild(d,e.toRemove,i,f,u):e.toRemove.length>0?(this.removeByErasing(d,e.toRemove,i,u),e.toAdd.length>0&&(u.end=g)):(u.begin=g,u.end=g);const w=B$9;y$R(w,-e.origin[0],-e.origin[1],-e.origin[2]),this.append(d,e.toAdd,i,w,u);const b=d.vao.vertexBuffers.geometry;if(b.byteSize!==d.buffer.array.buffer.byteLength)b.setData(d.buffer.array);else {const{begin:e,end:t}=u;if(e<t){const s=d.buffer.array,a=4,i=e*a,r=t*a;b.setSubData(s,i,i,r);}}d.drawCommandsDirty=!0;}));}updateGeometries(e){const t=this._bufferWriter,s=t.vertexBufferLayout.stride/4;for(const a of e){const e=a.updateType,i=a.renderGeometry,r=this._dataByOrigin.get(i.origin.id),n=r&&r.instances.get(i.id);if(!n)return;if(1&e&&(n.isVisible=i.instanceParameters.visible),9&e){const e=i.instanceParameters.visible;n.hasHighlights=!!i.instanceParameters.highlights&&e;}if(16&e&&(n.hasOccludees=!!i.instanceParameters.occludees),6&e){const e=r.buffer.array,a=r.vao;q$t(i,D$d,j$n),t.write({transformation:D$d,invTranspTransformation:j$n},i.data,t.vertexBufferLayout.createView(e.buffer),n.from),i$R(n.from+t.elementCount(i.data)===n.to,"material VBO layout has changed"),a.vertexBuffers.geometry.setSubData(e,n.from*s*4,n.from*s*4,n.to*s*4);}r.drawCommandsDirty=!0;}}updateRenderCommands(){this._hasHighlights=!1,this._hasOccludees=!1,this._dataByOrigin.forEach((t=>{t.hasHiddenInstances=!1,t.hasHighlights=!1,t.hasOccludees=!1,n$1i(t.instances,(e=>(e.isVisible?(e.hasHighlights&&(this._hasHighlights=!0,t.hasHighlights=!0),e.hasOccludees&&(this._hasOccludees=!0,t.hasOccludees=!0)):t.hasHiddenInstances=!0,t.hasHiddenInstances&&t.hasHighlights&&t.hasOccludees)));}));const t=e=>{if(e.drawCommandsDefault=null,e.drawCommandsHighlight=null,e.drawCommandsOccludees=null,e.drawCommandsShadowHighlightRest=null,e.stats={default:0,highlight:0,occludees:0,shadowHighlightRest:0},0===e.instances.size)return;if(!O$f(e)){const t=4*e.buffer.size/t$1m(e.vao.layout.geometry);return e.drawCommandsDefault=[{first:0,count:t}],void(e.stats={default:t,highlight:0,occludees:0,shadowHighlightRest:0})}const t=i$m([...e.instances.values()]);e.drawCommandsDefault=[],e.drawCommandsHighlight=[],e.drawCommandsOccludees=[],e.drawCommandsShadowHighlightRest=[];for(const a of t)a.isVisible&&(a.hasOccludees?f$q(e.drawCommandsOccludees,a):f$q(e.drawCommandsDefault,a),a.hasHighlights?f$q(e.drawCommandsHighlight,a):f$q(e.drawCommandsShadowHighlightRest,a));const s=e=>{let t=0;for(const s of e)t+=s.count;return t/3};e.stats={default:s(e.drawCommandsDefault),highlight:s(e.drawCommandsHighlight),occludees:s(e.drawCommandsOccludees),shadowHighlightRest:s(e.drawCommandsShadowHighlightRest)};};this._dataByOrigin.forEach((e=>{e.drawCommandsDirty&&(t(e),e.drawCommandsDirty=!1);}));}updateLogic(e){return this._material.update(e)}render(e,a,i,r){const n=this._rctx,o=this._glMaterials.get(a),d=5===a||7===a,l=6===a,h=!(d||l);if(3===a&&null===e&&(e=22),!o||2!==o.ensureResources(n)||null!=e&&!o.beginSlot(e)||d&&!this._hasHighlights)return !1;o.ensureParameters(i);const m=o.getPipelineState(e,!1);n.setPipelineState(m);const c=o.technique;n.useProgram(c.program),o.bind(i);let u=!1;return this._dataByOrigin.forEach((a=>{if(t$17(a.drawCommandsDefault)&&t$17(a.drawCommandsHighlight)&&t$17(a.drawCommandsOccludees)&&t$17(a.drawCommandsShadowHighlightRest))return;if(d&&!a.hasHighlights)return;i.origin=a.origin,c.bindDraw(i,{},{}),c.ensureAttributeLocations(a.vao),n.bindVAO(a.vao);const g=c.primitiveType,f=d?a.drawCommandsHighlight:l&&O$f(a)?a.drawCommandsShadowHighlightRest:a.drawCommandsDefault;if(r$Y(f)){this.renderCommands(n,g,f);const e=d?a.stats.highlight:l&&O$f(a)?a.stats.shadowHighlightRest:a.stats.default;o$v(f.length,e,r),u=!0;}if(h){const t=a.drawCommandsOccludees;if(r$Y(t)){const s=o.getPipelineState(e,!0);n.setPipelineState(s),this.renderCommands(n,g,t),n.setPipelineState(m),o$v(t.length,a.stats.occludees,r),u=!0;}}})),u}renderCommands(e,t,s){for(let a=0;a<s.length;a++)e.drawArrays(t,s[a].first,s[a].count);}createData(e,t,s){return {instances:new Map,vao:new f$M(this._rctx,this._material.vertexAttributeLocations,{geometry:t$16(e)},{geometry:h$O.createVertex(this._rctx,35044)}),buffer:new t$y(t),optimalCount:0,origin:s,hasHiddenInstances:!1,hasHighlights:!1,hasOccludees:!1,drawCommandsDirty:!1,drawCommandsDefault:null,drawCommandsOccludees:null,drawCommandsHighlight:null,drawCommandsShadowHighlightRest:null,stats:{default:0,highlight:0,occludees:0,shadowHighlightRest:0}}}removeAndRebuild(e,t,s,a,i){for(const h of t){const t=h.id,a=e.instances.get(t);e.optimalCount-=(a.to-a.from)*s,e.instances.delete(t);}let r=0;const n=e.buffer.array;i.begin=0,i.end=0;let o=-1,d=-1,l=0;e.instances.forEach((e=>{const t=e.from*s,i=e.to*s,h=i-t;o!==d&&d!==t?(n.set(a.subarray(o,d),l),l+=d-o,o=t):-1===o&&(o=t),d=i,e.from=r/s,r+=h,e.to=r/s;})),o!==d&&n.set(a.subarray(o,d),l),i.end=r;}removeByErasing(e,t,s,a){a.begin=1/0,a.end=-1/0;let i=-1,r=-1;for(const n of t){const t=n.id,o=e.instances.get(t),d=o.from*s,l=o.to*s;i!==r&&r!==d?(e.buffer.erase(i,r),i=d):-1===i&&(i=d),r=l,e.instances.delete(t),e.optimalCount-=l-d,d<a.begin&&(a.begin=d),l>a.end&&(a.end=l);}i!==r&&e.buffer.erase(i,r);}append(e,t,n,o,d){const h=this._bufferWriter;for(const m of t){const t=r$Y(m.transformation)?e$V(D$d,o,m.transformation):o;h$L(j$n,t),o$T(j$n,j$n);const u=d.end;h.write({transformation:t,invTranspTransformation:j$n},m.data,h.vertexBufferLayout.createView(e.buffer.array.buffer),d.end/n);const g=h.elementCount(m.data)*n,f=u+g;i$R(null==e.instances.get(m.id));const p=m.instanceParameters.visible,w=!!m.instanceParameters.highlights&&p,b=!!m.instanceParameters.occludees,C=new s$u(u/n,f/n,p,w,b);e.instances.set(m.id,C),e.optimalCount+=g,d.end+=g;}}get test(){return {material:this._material,glMaterials:this._glMaterials}}}function H$9(e,s,a,i){const r=new Map,n=s.vertexBufferLayout.stride/4,o=(a,i)=>{const o=a.origin;if(t$17(o))return;const d=e.get(o.id);let l=r.get(o.id);null==l&&(l={optimalCount:null==d?0:d.optimalCount,sparseCount:null==d?0:d.buffer.size,toAdd:[],toRemove:[],origin:o.vec3},r.set(o.id,l));const h=s.elementCount(a.data)*n;i?(l.optimalCount+=h,l.sparseCount+=h,l.toAdd.push(a)):(l.optimalCount-=h,l.toRemove.push(a));};for(const t of a)o(t,!0);for(const t of i)o(t,!1);return r}function O$f(e){return e.hasOccludees||e.hasHighlights||e.hasHiddenInstances}const R$f={begin:0,end:0},B$9=e$P(),D$d=e$P(),j$n=e$P();

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
let p$w=class extends p$14{constructor(){super(...arguments),this._pending=new m$t,this._changes=new r$A,this._materialRenderers=new Map,this._sortedMaterialRenderers=new n$1h,this._hasHighlights=!1,this._hasWater=!1;}dispose(){this._changes.prune(),this._materialRenderers.forEach((e=>e.dispose())),this._materialRenderers.clear(),this._sortedMaterialRenderers.clear();}get updating(){return !this._pending.empty||this._changes.updates.length>0}get hasHighlights(){return this._hasHighlights}get hasWater(){return this._hasWater}get rendersOccluded(){return n$1i(this._materialRenderers,(e=>e.rendersOccluded))}stopAnimationsAtTime(e){this._sortedMaterialRenderers.forAll((r=>o$17(r.material.animation,(r=>r.stopAtTime(e)))));}get isEmpty(){return !this.updating&&0===this._materialRenderers.size}commitChanges(){if(!this.updating)return !1;this._processAddsRemoves();const e=r$z(this._changes);let r=!1,s=!1,i=!1;return e.forEach(((e,t)=>{let a=this._materialRenderers.get(t);if(!a&&e.adds.length>0&&(a=new v$o(this.rctx,this.materialRepository,t),this._materialRenderers.set(t,a),r=!0,s=!0,i=!0),!a)return;const n=s||a.hasHighlights,d=i||a.hasWater;a.modify(e),s=s||n!==a.hasHighlights,i=i||d!==a.hasWater,a.isEmpty&&(this._materialRenderers.delete(t),a.dispose(),r=!0);})),this._changes.clear(),r&&this.updateSortedMaterialRenderers(),s&&(this._hasHighlights=n$1i(this._materialRenderers,(e=>e.hasHighlights))),i&&(this._hasWater=n$1i(this._materialRenderers,(e=>e.hasWater))),this.notifyChange("updating"),!0}add(e){if(0===e.length)return;const r=this._pending.empty;for(const t of e)this._pending.adds.add(t);r&&this.notifyChange("updating");}remove(e){const r=this._pending.empty;for(const t of e)this._pending.adds.has(t)?(this._pending.removed.add(t),this._pending.adds.delete(t)):this._pending.removed.has(t)||this._pending.removes.add(t);r&&!this._pending.empty&&this.notifyChange("updating");}modify(e,r){const t=0===this._changes.updates.length;for(const s of e){const e=this._changes.updates.pushNew();e.renderGeometry=s,e.updateType=r;}t&&this._changes.updates.length>0&&this.notifyChange("updating");}updateLogic(e){let r=!1;return this._sortedMaterialRenderers.forAll((({materialRenderer:t})=>{t.updateLogic&&t.updateLogic(e)&&(r=!0);})),r}render(e,r){for(let t=0;t<this._sortedMaterialRenderers.length;t++){const s=this._sortedMaterialRenderers.data[t];n$1n(s.material,e)&&s.materialRenderer.render(null,e.pass,r,null);}}updateSortedMaterialRenderers(){this._sortedMaterialRenderers.clear();let e=0;this._materialRenderers.forEach(((r,t)=>{t.insertOrder=e++,this._sortedMaterialRenderers.push({material:t,materialRenderer:r});})),this._sortedMaterialRenderers.sort(((e,r)=>{const t=r.material.renderPriority-e.material.renderPriority;return 0!==t?t:e.material.insertOrder-r.material.insertOrder}));}_processAddsRemoves(){this._changes.adds.clear(),this._changes.removes.clear(),this._changes.adds.pushArray(Array.from(this._pending.adds)),this._changes.removes.pushArray(Array.from(this._pending.removes));for(let e=0;e<this._changes.updates.length;){const r=this._changes.updates.data[e];this._pending.has(r.renderGeometry)?this._changes.updates.removeUnorderedIndex(e):e++;}this._pending.clear();}get test(){return {sortedMaterialRenderers:this._sortedMaterialRenderers}}};e$Q([y$K()],p$w.prototype,"rctx",void 0),e$Q([y$K()],p$w.prototype,"materialRepository",void 0),e$Q([y$K()],p$w.prototype,"updating",null),p$w=e$Q([n$14("esri.views.3d.webgl-engine.lib.SortedRenderGeometryRenderer")],p$w);class m$t{constructor(){this.adds=new Set,this.removes=new Set,this.removed=new Set;}get empty(){return 0===this.adds.size&&0===this.removes.size&&0===this.removed.size}has(e){return this.adds.has(e)||this.removes.has(e)||this.removed.has(e)}clear(){this.adds.clear(),this.removes.clear(),this.removed.clear();}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
function o$u(o){o.attributes.add("position","vec2"),o.varyings.add("uv","vec2"),o.vertex.code.add(t$10`
    void main(void) {
      gl_Position = vec4(position, 0.0, 1.0);
      uv = position * 0.5 + vec2(0.5);
    }
  `);}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
function n$C(){const n=new n$15;return n.include(o$u),n.fragment.uniforms.add("tex","sampler2D"),n.fragment.uniforms.add("color","vec4"),n.fragment.code.add(t$10`void main() {
vec4 texColor = texture2D(tex, uv);
gl_FragColor = texColor * color;
}`),n}var a$s=Object.freeze({__proto__:null,build:n$C});

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class u$t extends t$11{initializeProgram(e){const r=u$t.shader.get().build();return new n$16(e.rctx,r,o$X)}initializePipeline(){return this.configuration.hasAlpha?g$S({blending:e$T(770,1,771,771),colorWrite:r$13}):g$S({colorWrite:r$13})}}u$t.shader=new t$12(a$s,(()=>import('./TextureOnly.glsl-fe6f6a65.js')));class m$s extends e$S{constructor(){super(...arguments),this.hasAlpha=!1;}}e$Q([r$12()],m$s.prototype,"hasAlpha",void 0);

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
function n$B(t,n,e){(e=e||t).length=t.length;for(let l=0;l<t.length;l++)e[l]=t[l]*n[l];return e}function e$s(t,n,e){(e=e||t).length=t.length;for(let l=0;l<t.length;l++)e[l]=t[l]*n;return e}function l$t(t,n,e){(e=e||t).length=t.length;for(let l=0;l<t.length;l++)e[l]=t[l]+n[l];return e}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
function g$v(t){return (t+1)*(t+1)}function l$s(n){return o$R(Math.floor(Math.sqrt(n)-1),0,2)}function y$o(t,n,o){const i=t[0],s=t[1],r=t[2],e=o||[];return e.length=g$v(n),n>=0&&(e[0]=.28209479177),n>=1&&(e[1]=.4886025119*i,e[2]=.4886025119*r,e[3]=.4886025119*s),n>=2&&(e[4]=1.09254843059*i*s,e[5]=1.09254843059*s*r,e[6]=.31539156525*(3*r*r-1),e[7]=1.09254843059*i*r,e[8]=.54627421529*(i*i-s*s)),e}function m$r(t,n){const o=g$v(t),i=n||{r:[],g:[],b:[]};i.r.length=i.g.length=i.b.length=o;for(let s=0;s<o;s++)i.r[s]=i.g[s]=i.b[s]=0;return i}function p$v(t,o){const i=l$s(o.r.length);for(const s of t)v$N(v$n,s.direction),y$o(v$n,i,P$h),n$B(P$h,w$n),e$s(P$h,s.intensity[0],k$e),l$t(o.r,k$e),e$s(P$h,s.intensity[1],k$e),l$t(o.g,k$e),e$s(P$h,s.intensity[2],k$e),l$t(o.b,k$e);return o}function b$j(t,n){y$o(v$n,0,P$h);for(const o of t)n.r[0]+=P$h[0]*w$n[0]*o.intensity[0]*4*Math.PI,n.g[0]+=P$h[0]*w$n[0]*o.intensity[1]*4*Math.PI,n.b[0]+=P$h[0]*w$n[0]*o.intensity[2]*4*Math.PI;return n}function M$l(t,n,s,r){m$r(n,r),o$S(s.intensity,0,0,0);let e=!1;const g=d$q,l=j$m,y=I$g;g.length=0,l.length=0,y.length=0;for(const o of t)o instanceof o$N&&!e?(r$Z(s.direction,o.direction),s.intensity[0]=o.intensity[0],s.intensity[1]=o.intensity[1],s.intensity[2]=o.intensity[2],s.castShadows=o.castShadows,e=!0):o instanceof o$N||o instanceof c$K?g.push(o):o instanceof i$G?l.push(o):o instanceof r$Q&&y.push(o);p$v(g,r),b$j(l,r);for(const o of y)l$t(r.r,o.r),l$t(r.g,o.g),l$t(r.b,o.b);}const d$q=[],j$m=[],I$g=[],P$h=[0],k$e=[0],v$n=n$11(),w$n=[3.141593,2.094395,2.094395,2.094395,.785398,.785398,.785398,.785398,.785398];

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class e$r{constructor(){this._shOrder=2,this._ambientBoost=.4,this._oldSunlight={direction:n$11(),ambient:{color:n$11(),intensity:1},diffuse:{color:n$11(),intensity:1}},this.globalFactor=.5,this.groundLightingFactor=.5,this._sphericalHarmonics=new r$Q,this._mainLight={intensity:n$11(),direction:t$_(1,0,0),castShadows:!1};}get lightingMainDirection(){return this._mainLight.direction}setLightDirectionUniform(i){i.setUniform3fv("lightingMainDirection",this._mainLight.direction);}setUniforms(i,t=!1){const n=t?(1-this.groundLightingFactor)*(1-this.globalFactor):0;i.setUniform1f("lightingFixedFactor",n),i.setUniform1f("lightingGlobalFactor",this.globalFactor),this.setLightDirectionUniform(i),i.setUniform3fv("lightingMainIntensity",this._mainLight.intensity),i.setUniform1f("ambientBoostFactor",this._ambientBoost);const s=this._sphericalHarmonics;0===this._shOrder?i.setUniform3f("lightingAmbientSH0",s.r[0],s.g[0],s.b[0]):1===this._shOrder?(i.setUniform4f("lightingAmbientSH_R",s.r[0],s.r[1],s.r[2],s.r[3]),i.setUniform4f("lightingAmbientSH_G",s.g[0],s.g[1],s.g[2],s.g[3]),i.setUniform4f("lightingAmbientSH_B",s.b[0],s.b[1],s.b[2],s.b[3])):2===this._shOrder&&(i.setUniform3f("lightingAmbientSH0",s.r[0],s.g[0],s.b[0]),i.setUniform4f("lightingAmbientSH_R1",s.r[1],s.r[2],s.r[3],s.r[4]),i.setUniform4f("lightingAmbientSH_G1",s.g[1],s.g[2],s.g[3],s.g[4]),i.setUniform4f("lightingAmbientSH_B1",s.b[1],s.b[2],s.b[3],s.b[4]),i.setUniform4f("lightingAmbientSH_R2",s.r[5],s.r[6],s.r[7],s.r[8]),i.setUniform4f("lightingAmbientSH_G2",s.g[5],s.g[6],s.g[7],s.g[8]),i.setUniform4f("lightingAmbientSH_B2",s.b[5],s.b[6],s.b[7],s.b[8]));}set(s){M$l(s,this._shOrder,this._mainLight,this._sphericalHarmonics),r$Z(this._oldSunlight.direction,this._mainLight.direction);const o=1/Math.PI;this._oldSunlight.ambient.color[0]=.282095*this._sphericalHarmonics.r[0]*o,this._oldSunlight.ambient.color[1]=.282095*this._sphericalHarmonics.g[0]*o,this._oldSunlight.ambient.color[2]=.282095*this._sphericalHarmonics.b[0]*o,d$O(this._oldSunlight.diffuse.color,this._mainLight.intensity,o),r$Z(g$u,this._oldSunlight.diffuse.color),d$O(g$u,g$u,this._ambientBoost*this.globalFactor),u$S(this._oldSunlight.ambient.color,this._oldSunlight.ambient.color,g$u);}get old(){return this._oldSunlight}}const g$u=n$11();

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class s$s{constructor(e){this._rctx=e,this.cache=new Map;}dispose(){this.cache.forEach((t=>t.texture=i$S(t.texture))),this.cache.clear();}acquire(e){if(t$17(e))return null;const r=this.patternId(e),s=this.cache.get(r);if(s)return s.refCount++,s.bind;const i=2,o=this.patternToTextureData(e,2),a=o.length/i,c={refCount:1,texture:null,bind:e=>(t$17(c.texture)&&(c.texture=new r$16(this._rctx,{width:o.length,height:1,internalFormat:6406,pixelFormat:6406,dataType:5121,wrapMode:33071},o)),e.bindTexture(c.texture,"stipplePatternTexture"),a)};return this.cache.set(r,c),c.bind}release(e){if(t$17(e))return;const n=this.patternId(e),s=this.cache.get(n);s&&(s.refCount--,0===s.refCount&&(r$Y(s.texture)&&s.texture.dispose(),this.cache.delete(n)));}swap(e,t){const r=this.acquire(t);return this.release(e),r}patternId(e){return e.join(",")}patternToTextureData(e,t){const r=e.reduce(((e,t)=>e+t))*t,n=new Uint8Array(r);let s=!0,i=0;for(const o of e){for(let e=0;e<o*t;e++)n[i++]=s?255:0;s=!s;}return n}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
const X$7=n$12.getLogger("esri.views.3d.webgl-engine.lib.OverlayRenderer");let Y$a=class extends(s$$(p$14)){constructor(e){super(e),this._overlays=null,this._overlayRenderTarget=null,this._hasHighlights=!1,this._rendersOccluded=!1,this._hasWater=!1,this._lighting=new e$r,this._handles=new u$T,this._layerRenderers=new Map,this._sortedLayerRenderersDirty=!1,this._sortedLayerRenderers=new n$1h,this._geometries=new Map,this.globalUnitScale=1,this.longitudeCyclical=null;}initialize(){const e=this.view._stage.renderView;this._rctx=e.renderingContext,this._renderContext=new e$w(this._rctx);const r=e.waterTextureRepository;this._stippleTextureRepository=new s$s(e.renderingContext),this._shaderTechniqueRepository=new s$x({rctx:this._rctx,viewingMode:2,stippleTextureRepository:this._stippleTextureRepository,waterTextureRepository:r}),this._handles.add([d$S(r,"loadingState",(()=>this.emitContentChanged())),d$S(this,"spatialReference",(e=>this._localOrigins=new d$r(e)))]),this._materialRepository=new n$I(e.textureRepository,this._shaderTechniqueRepository),this._materialRepository.onMaterialChanged=e=>{(e.renderOccluded&ee$6)>0!==this._rendersOccluded&&this.updateRendersOccluded(),this.emitContentChanged(),this.notifyChange("updating");},this._lighting.groundLightingFactor=1,this._lighting.globalFactor=0,this._lighting.set([new i$G(t$_(1,1,1))]),this._bindParameters={slot:null,highlightDepthTexture:g$X(this._rctx),camera:N$c,inverseViewport:n$19(),origin:null,screenToWorldRatio:null,screenToWorldRatioGlobalWM:null,shadowMappingEnabled:!1,slicePlane:null,ssaoEnabled:!1,hasOccludees:!1,linearDepthTexture:null,lastFrameColorTexture:null,reprojectionMat:null,ssrEnabled:!1,lighting:this._lighting,transparencyPassType:3,terrainLinearDepthTexture:null,geometryLinearDepthTexture:null,multipassTerrainEnabled:!1,cullAboveGround:!1,multipassGeometryEnabled:!1,highlightColorTexture:null},this._handles.add(this.view.resourceController.scheduler.registerTask(p$H.STAGE,this));}dispose(){this._handles.destroy(),this._layerRenderers.forEach((e=>e.dispose())),this._layerRenderers.clear(),this._debugTextureTechnique=h$U(this._debugTextureTechnique),this._debugPatternTexture=i$S(this._debugPatternTexture),this._bindParameters.highlightDepthTexture=i$S(this._bindParameters.highlightDepthTexture),this._shaderTechniqueRepository=i$S(this._shaderTechniqueRepository),this._temporaryFBO=i$S(this._temporaryFBO),this._quadVAO=i$S(this._quadVAO),this._overlayRenderTarget=i$S(this._overlayRenderTarget);}get updating(){return this._sortedLayerRenderersDirty||n$1i(this._layerRenderers,(e=>e.updating))}get hasOverlays(){return r$Y(this._overlays)&&r$Y(this._overlayRenderTarget)}get gpuMemoryUsage(){return r$Y(this._overlayRenderTarget)?this._overlayRenderTarget.gpuMemoryUsage:0}collectUnusedRenderTargetMemory(e){let r=!1;if(r$Y(this._overlayRenderTarget))for(const t of this._overlayRenderTarget.renderTargets){const s=this.overlays[0].validTargets[t.type]||!this.overlays[1].validTargets[t.type];r=this._overlayRenderTarget.validateUsageForTarget(s,t,e)||r;}return r}get overlays(){return c$W(this._overlays,[])}ensureDrapeTargets(e){r$Y(this._overlays)&&this._overlays.forEach((r=>{r.hasTargetWithoutRasterImage=n$1o(e,(e=>1===e.drapeTargetType));}));}ensureDrapeSources(e){r$Y(this._overlays)&&this._overlays.forEach((r=>{r.hasDrapedFeatureSource=n$1i(e,((e,r)=>1===r.drapeSourceType)),r.hasDrapedRasterSource=n$1i(e,((e,r)=>0===r.drapeSourceType));}));}ensureOverlays(e,r){t$17(this._overlays)&&(this._overlayRenderTarget=new r$D(this._rctx),this._overlays=[new n$J(0,this._overlayRenderTarget),new n$J(1,this._overlayRenderTarget)]),this.ensureDrapeTargets(e),this.ensureDrapeSources(r);}disposeOverlays(){r$Y(this._overlayRenderTarget)&&this._overlayRenderTarget.disposeRenderTargetMemory();}get running(){return this.updating}runTask(e,r=(()=>!0)){let t=!1;for(const[s,i]of this._layerRenderers){if(e.done)break;r(s)&&(i.commitChanges()&&(t=!0,e.madeProgress()),i.isEmpty&&(this._sortedLayerRenderersDirty=!0,this._layerRenderers.delete(s),this._handles.remove(s)));}this._sortedLayerRenderersDirty&&(this.updateSortedLayerRenderers(),t=!0),t&&(r$Y(this._overlays)&&0===this._layerRenderers.size&&this.disposeOverlays(),this.notifyChange("updating"),this.emitContentChanged(),this.updateHasHighlights(),this.updateRendersOccluded(),this.updateHasWater());}processSyncLayers(){this.runTask(N$f,(e=>1===e.updatePolicy));}addGeometries(e,r,t){for(const s of e)t$17(s.origin)&&(s.origin=this._localOrigins.getOrigin(s.boundingSphere)),this._geometries.set(s.id,s);this.ensureLayerRenderer(r).add(e),2===t&&this.notifyGraphicGeometryChanged(e,r);}removeGeometries(e,r,t){for(const i of e)this._geometries.delete(e$12(i.id));const s=this._layerRenderers.get(r);s&&(s.remove(e),2===t&&this.notifyGraphicGeometryChanged(e,r));}updateGeometries(e,r,t){const s=this._layerRenderers.get(r);if(s)switch(s.modify(e,t),t){case 4:case 2:return this.notifyGraphicGeometryChanged(e,r);case 1:return this.notifyGraphicVisibilityChanged(e,r)}else X$7.warn("Attempted to update geometry for nonexistent layer");}notifyGraphicGeometryChanged(e,r){if(t$17(r.notifyGraphicGeometryChanged))return;let t;for(const s of e){const e=s.graphicUid;r$Y(e)&&e!==t&&(r.notifyGraphicGeometryChanged(e),t=e);}}notifyGraphicVisibilityChanged(e,r){if(t$17(r.notifyGraphicVisibilityChanged))return;let t;for(const s of e){const e=s.graphicUid;r$Y(e)&&e!==t&&(r.notifyGraphicVisibilityChanged(e),t=e);}}updateHighlights(e,r){const t=this._layerRenderers.get(r);t?t.modify(e,8):X$7.warn("Attempted to update highlights for nonexistent layer");}isEmpty(){return 0===this._geometries.size&&!T$k.OVERLAY_DRAW_DEBUG_TEXTURE}get hasHighlights(){return this._hasHighlights}get hasWater(){return this._hasWater}get rendersOccluded(){return this._rendersOccluded}updateLogic(e){let r=!1;return this._layerRenderers.forEach((t=>{t.updateLogic(e)&&(r=!0);})),r}updateLayerOrder(){this._sortedLayerRenderersDirty=!0;}drawTarget(e,r,t){const s=e.canvasGeometries;if(0===s.numViews)return !1;const i=e.pixelRatio*t;this._screenToWorldRatio=i*Math.abs(s.extents[0][2]-s.extents[0][0])/Math.abs(e.viewport[2]-e.viewport[0]);const a=r.renderPass;if(this.isEmpty()||5===a&&!this.hasHighlights||3===a&&!this.hasWater)return !1;if(!e.hasSomeSizedView())return !1;const n=r.fbo,h=2*e.resolution,l=e.resolution,u=1===r.type?2:4===r.type?1:0;if(!n.isValid())return !1;n.resize(h,l);const g=this._rctx;if(N$c.pixelRatio=i||1,this._renderContext.pass=a,this._bindParameters.screenToWorldRatio=this._screenToWorldRatio,this._bindParameters.screenToWorldRatioGlobalWM=this._screenToWorldRatio*this.globalUnitScale,e.applyViewport(this._rctx),n.bind(g),0===e.index&&(g.setClearColor(0,0,0,0),g.clearSafe(16384)),1===u&&(this._renderContext.renderOccludedMask=ee$6),T$k.OVERLAY_DRAW_DEBUG_TEXTURE&&1!==u)for(let o=0;o<s.numViews;o++)this.setViewParameters(s.extents[o],e,N$c),this.drawDebugTexture(e.resolution,K$a[e.index%K$a.length]);return this._layerRenderers.size>0&&this._sortedLayerRenderers.forAll((({layerView:r,renderer:t})=>{if(2===u&&r$Y(r)&&0===r.drapeSourceType)return;const i=r$Y(r)&&r$Y(r.fullOpacity)&&r.fullOpacity<1&&0===a;i&&(this.bindTemporaryFramebuffer(this._rctx,h,l),g.clearSafe(16384));for(let a=0;a<s.numViews;a++)this.setViewParameters(s.extents[a],e,N$c),t.render(this._renderContext,this._bindParameters);i&&r$Y(this._temporaryFBO)&&(n.bind(g),this.view._stage.renderView.compositingHelper.composite(this._temporaryFBO.getTexture(),2,e$12(e$12(r).fullOpacity),3,e.index));})),g.bindFramebuffer(null),n.generateMipMap(),this._renderContext.resetRenderOccludedMask(),!0}bindTemporaryFramebuffer(e,r,t){t$17(this._temporaryFBO)&&(this._temporaryFBO=new i$o(e,!1)),this._temporaryFBO.resize(r,t),this._temporaryFBO.bind(e);}async reloadShaders(){await this._shaderTechniqueRepository.hotReload();}intersect(e,r,t){let s=0;this._geometries.forEach((i=>{if(t&&!t(i))return;this.intersectRenderGeometry(i,r,0,e,s);const a=this.longitudeCyclical;a&&(i.boundingSphere[0]-i.boundingSphere[3]<a.min&&this.intersectRenderGeometry(i,r,a.range,e,s),i.boundingSphere[0]+i.boundingSphere[3]>a.max&&this.intersectRenderGeometry(i,r,-a.range,e,s)),s++;}));}intersectRenderGeometry(e,r,t,s,i){if(!e.instanceParameters.visible)return;let a=0;r$Y(e.transformation)&&(t+=e.transformation[12],a=e.transformation[13]),Q$a[0]=r[0]-t,Q$a[1]=r[1]-a,Q$a[2]=1,Z$7[0]=r[0]-t,Z$7[1]=r[1]-a,Z$7[2]=0,e.screenToWorldRatio=this._screenToWorldRatio,e.material.intersect(e,null,e.getShaderTransformation(),s,Q$a,Z$7,((r,t,a)=>{this.addIntersectionResult(a,e.material.renderPriority,i,s,e.layerUid,e.graphicUid);}),e.calculateShaderTransformation,!0);}addIntersectionResult(e,r,t,s,i,a){const n={type:"external",metadata:{layerUid:i,graphicUid:a}},o=i=>{i.set(n,null,s.results.ground.dist,s.results.ground.normal,s.results.ground.transformation,r,null,null,e,t),i.intersector="OverlayRenderer";};if((null==s.results.min.drapedLayerOrder||r>=s.results.min.drapedLayerOrder)&&(null==s.results.min.dist||s.results.ground.dist<=s.results.min.dist)&&o(s.results.min),0!==s.options.store&&(null==s.results.max.drapedLayerOrder||r<s.results.max.drapedLayerOrder)&&(null==s.results.max.dist||s.results.ground.dist>s.results.max.dist)&&o(s.results.max),2===s.options.store){const e=new j$y(s.ray);o(e),s.results.all.push(e);}}stopAnimationsAtTime(e){this._sortedLayerRenderers.forAll((r=>r.renderer.stopAnimationsAtTime(e)));}ensureLayerRenderer(e){let r=this._layerRenderers.get(e);return r||(r=new p$w({rctx:this._rctx,materialRepository:this._materialRepository}),this._layerRenderers.set(e,r),this._sortedLayerRenderersDirty=!0,"fullOpacity"in e&&this._handles.add(e.watch("fullOpacity",(()=>this.emitContentChanged())),e),this._handles.add(d$S(r,"updating",(()=>this.notifyChange("updating"))),e)),r}updateSortedLayerRenderers(){if(!this._sortedLayerRenderersDirty)return;if(this._sortedLayerRenderersDirty=!1,this._sortedLayerRenderers.clear(),0===this._layerRenderers.size)return;const e=new Set(this._layerRenderers.values());this.view.allLayerViews.forEach((r=>{const t=r,s=this._layerRenderers.get(t);s&&(this._sortedLayerRenderers.push(new J$a(t,s)),e.delete(s));})),e.forEach((e=>this._sortedLayerRenderers.push(new J$a(null,e))));}setViewParameters(e,r,t){t.viewport=r.viewport,E$z(t.projectionMatrix,0,e[2]-e[0],0,e[3]-e[1],t.near,t.far),r$$(t.viewMatrix),c$_(t.viewMatrix,t.viewMatrix,[-e[0],-e[1],0]),this._renderContext.camera=t,this._bindParameters.camera=t,this._bindParameters.inverseViewport[0]=1/t.fullViewport[2],this._bindParameters.inverseViewport[1]=1/t.fullViewport[3];}emitContentChanged(){this.onContentChanged&&this.onContentChanged();}updateHasWater(){const e=n$1i(this._layerRenderers,(e=>e.hasWater));e!==this._hasWater&&(this._hasWater=e,this.onHasWaterChanged&&this.onHasWaterChanged(e));}updateHasHighlights(){const e=n$1i(this._layerRenderers,(e=>e.hasHighlights));e!==this._hasHighlights&&(this._hasHighlights=e,this.onHasHighlightsChanged&&this.onHasHighlightsChanged(this._hasHighlights));}updateRendersOccluded(){const e=n$1i(this._layerRenderers,(e=>e.rendersOccluded));e!==this._rendersOccluded&&(this._rendersOccluded=e,this.onRendersOccludedChanged&&this.onRendersOccludedChanged(this.rendersOccluded));}drawDebugTexture(e,r){const t=this._rctx;this.ensureDebugPatternResources(e,e);const s=this._debugTextureTechnique.program;t.useProgram(s),t.setPipelineState(this._debugTextureTechnique.pipeline),s.setUniform4f("color",r[0],r[1],r[2],1),s.bindTexture(this._debugPatternTexture,"tex"),t.bindVAO(this._quadVAO),t.drawArrays(5,0,r$15(this._quadVAO,"geometry"));}ensureDebugPatternResources(e,r){if(this._debugPatternTexture)return;const t=new Uint8Array(e*r*4);let s=0;for(let a=0;a<r;a++)for(let i=0;i<e;i++){const n=Math.floor(i/10),o=Math.floor(a/10);n<2||o<2||10*n>e-20||10*o>r-20?(t[s++]=255,t[s++]=255,t[s++]=255,t[s++]=255):(t[s++]=255,t[s++]=255,t[s++]=255,t[s++]=1&n&&1&o?1&i^1&a?0:255:1&n^1&o?0:128);}this._debugPatternTexture=new r$16(this._rctx,{target:3553,pixelFormat:6408,dataType:5121,samplingMode:9728,width:e,height:r},t);const i=new m$s;i.hasAlpha=!0,this._debugTextureTechnique=this._shaderTechniqueRepository.acquire(u$t,i),this._quadVAO=i$T(this._rctx);}get test(){return {layerRenderers:this._layerRenderers}}};e$Q([i$11()],Y$a.prototype,"_shaderTechniqueRepository",void 0),e$Q([i$11()],Y$a.prototype,"_stippleTextureRepository",void 0),e$Q([y$K({constructOnly:!0})],Y$a.prototype,"view",void 0),e$Q([y$K()],Y$a.prototype,"globalUnitScale",void 0),e$Q([y$K()],Y$a.prototype,"spatialReference",void 0),e$Q([y$K({type:Boolean,readOnly:!0})],Y$a.prototype,"updating",null),Y$a=e$Q([n$14("esri.views.3d.terrain.OverlayRenderer")],Y$a);class J$a{constructor(e,r){this.layerView=e,this.renderer=r;}}const K$a=[[1,.5,.5],[.5,.5,1],[.5,1,.5]],N$c=new J$g;N$c.near=1,N$c.far=1e4,N$c.relativeElevation=null;const Q$a=n$11(),Z$7=n$11(),$$b=-2,ee$6=4;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
function p$u(i){const o=[["position",i.indices]],n=[["position",{size:3,data:i.attributeData.position,exclusive:!0}]];return r$Y(i.attributeData.color)&&(n.push(["color",{size:4,data:i.attributeData.color,exclusive:!0}]),o.push(["color",new Uint32Array(i.indices.length)])),r$Y(i.attributeData.uvMapSpace)&&(n.push(["uvMapSpace",{size:4,data:i.attributeData.uvMapSpace,exclusive:!0}]),o.push(["uvMapSpace",i.indices])),r$Y(i.attributeData.boundingRect)&&(n.push(["boundingRect",{size:9,data:i.attributeData.boundingRect,exclusive:!0}]),o.push(["boundingRect",i.indices])),r$Y(i.attributeData.mapPosition)&&(n.push(["mapPos",{size:3,data:i.attributeData.mapPosition,exclusive:!0}]),o.push(["mapPos",i.indices])),new u$U(n,o)}function u$s(i){const o=[["position",i.indices],["uv0",i.indices]],n=[["position",{size:3,data:i.attributeData.position,exclusive:!0}],["uv0",{size:2,data:i.attributeData.uv0,exclusive:!0}]];return r$Y(i.attributeData.mapPosition)&&(n.push(["mapPos",{size:3,data:i.attributeData.mapPosition,exclusive:!0}]),o.push(["mapPos",i.indices])),new u$U(n,o)}function c$w(t){switch(t.type){case"extent":if(t instanceof M$x)return j$H.fromExtent(t);break;case"polygon":return t}return null}function l$r(t,i,e,s){const a=l$19(t.rings,t.hasZ,1),r=new Float64Array(a.position.length),p=f$z(a.position,t.spatialReference,0,r,0,a.position,0,a.position.length/3,i,e,s),u=null!=p;return {position:a.position,mapPosition:r,polygons:g$t(a.polygons,a.position,r),outlines:d$p(a.outlines,a.position,r),projectionSuccess:u,sampledElevation:p}}function m$q(t,n){const s=l$19(t.rings,!1,1),a=xn(s.position,t.spatialReference,0,s.position,n,0,s.position.length/3);for(let i=2;i<s.position.length;i+=3)s.position[i]=$$b;return {position:s.position,polygons:g$t(s.polygons,s.position),outlines:d$p(s.outlines,s.position),projectionSuccess:a}}function d$p(t,i,o){const n=new Array;for(const{index:e,count:s}of t){if(s<=1)continue;const t=3*e,a=t+3*s;n.push({index:e,count:s,position:i.subarray(t,a),mapPosition:o?o.subarray(t,a):void 0});}return n}function g$t(t,i,o){const n=new Array;for(const{index:e,count:s,holeIndices:a,pathLengths:r}of t){if(s<=1)continue;const t=3*e,p=t+3*s,u=a.map((t=>t-e));n.push({index:e,count:s,holeIndices:u,pathLengths:r,position:i.subarray(t,p),mapPosition:o?o.subarray(t,p):void 0});}return n}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
const F$h=["polygon","extent"];class N$b extends y$r{constructor(e,t,s,r){super(e,t,s,r),this.ensureDrapedStatus(!1);}async doLoad(){if(!this._drivenProperties.size){const t=O$i(this._getSymbolSize());if(t)throw new s$Q("graphics3dextrudesymbollayer:invalid-size",t)}const s=g$Y(this.symbolLayer,"material","color"),r=this._getCombinedOpacityAndColor(s),n=e$11(r),a=r[3],o=a<1||this.needsDrivenTransparentPass,i={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0,diffuse:n,ambient:n,opacity:a,transparent:o,cullFace:o?0:2,vertexColors:!0,slicePlaneEnabled:this._context.slicePlaneEnabled,castShadows:this.symbolLayer.castShadows,offsetTransparentBackfaces:!0};this._material=new y$S(i),this._bottomMaterial=new y$S({...i,cullFace:2}),this._context.stage.add(this._material),this._context.stage.add(this._bottomMaterial);}destroy(){super.destroy(),this._material&&(this._context.stage.remove(this._material),this._context.stage.remove(this._bottomMaterial));}createGraphics3DGraphic(e){const t=e.graphic;if(!this._validateGeometry(t.geometry,F$h,this.symbolLayer.type))return null;const s=this._getVertexOpacityAndColor(e.renderingInfo,255),r=this.setGraphicElevationContext(t,new h$s);return this._createAs3DShape(t,e.renderingInfo,s,r,t.uid)}layerOpacityChanged(e,r){const n=g$Y(this.symbolLayer,"material","color"),a=this._getCombinedOpacity(n),o=a<1||this.needsDrivenTransparentPass;this._material.setParameterValues({opacity:a,transparent:o}),this._bottomMaterial.setParameterValues({opacity:a,transparent:o});const i=this._getLayerOpacity();return e.forEach((e=>{const t=r(e);r$Y(t)&&t.layerOpacityChanged(i,this._context.isAsync);})),!0}layerElevationInfoChanged(e,t){return this.updateGraphics3DGraphicElevationInfo(e,t,g$A)}slicePlaneEnabledChanged(e,t){return this._material.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled}),this._bottomMaterial.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled}),e.forEach((e=>{const r=t(e);r$Y(r)&&r.slicePlaneEnabledChanged(this._context.slicePlaneEnabled,this._context.isAsync);})),!0}physicalBasedRenderingChanged(){return this._material.setParameterValues({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}),this._bottomMaterial.setParameterValues({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}),!0}pixelRatioChanged(){return !0}_getExtrusionSize(e){let t;var s;e.size&&this._drivenProperties.size?t=null!=(s=u$w(e.size,2))?s:0:t=this._getSymbolSize();return t/=this._context.renderCoordsHelper.unitInMeters,t}_getSymbolSize(){var e;return null!=(e=this.symbolLayer.size)?e:1}_createAs3DShape(e,t,h,m,p){const d=c$w(e.geometry);if(t$17(d))return null;const u=l$r(d,this._context.elevationProvider,this._context.renderCoordsHelper,m);if(this._logGeometryCreationWarnings(u,d.rings,"rings","ExtrudeSymbol3DLayer"),0===d.rings.length||!d.rings.some((e=>e.length>0)))return null;const f=R$j(d);if(t$17(f))return null;const g=new Array,j=new Array,S=new Array,B=a$1c(),M=e$P(),R=n$11(),T=1===this._context.renderCoordsHelper.viewingMode;T||this._context.renderCoordsHelper.worldUpAtPosition(null,R),Sn(d.spatialReference,[f.x,f.y,0],M,this._context.renderCoordsHelper.spatialReference);const U=e$P();h$L(U,M);const V=e$Z();j$I(V,U);const{polygons:k,mapPosition:F,position:N}=u,Y=N.length/3,W=new Float64Array(3*Y*6),q=new Float64Array(3*Y*6),J=new Float64Array(3*Y*6),K=new Float64Array(1*Y*6);let Q=0;for(let s=0;s<k.length;++s){const e=k[s],r=e.count;if(this._context.clippingExtent&&(B$n(B),M$z(B,e.mapPosition),!R$u(B,this._context.clippingExtent)))continue;const a=r$1l(e.mapPosition,e.holeIndices,3);if(0===a.length)continue;const o=3*r*2+a.length,i=new Uint32Array(o),c=new Uint32Array(a.length),m=6*r,p=3*W.BYTES_PER_ELEMENT,d=new T$v(W.buffer,Q*p,p,(Q+m)*p),u=3*q.BYTES_PER_ELEMENT,f=new T$v(q.buffer,Q*u,u,(Q+m)*u),y=new Float64Array(J.buffer,3*Q*J.BYTES_PER_ELEMENT,3*m),_=new Float64Array(K.buffer,1*Q*K.BYTES_PER_ELEMENT,1*m),E=this._getExtrusionSize(t);H$8(N,F,a,e,d.typedBuffer,y,f.typedBuffer,_,0,i,c,E,R,T),e$16(d,d,U),f$U(f,f,V),Q+=6*r;const L=this._createExtrudeGeometry(i,i.length-c.length,{positions:d.typedBuffer,elevation:y,normals:f.typedBuffer,heights:_},h);g.push(L),j.push(this._material),S.push(a$10);const C=this._createExtrudeGeometry(c,0,{positions:d.typedBuffer,elevation:y,normals:f.typedBuffer,heights:_},h);g.push(C),j.push(this._bottomMaterial),S.push(a$10);}if(0===g.length)return null;const X=new R$p({geometries:g,materials:j,transformations:S,metadata:{layerUid:this._context.layer.uid,graphicUid:p,isElevationSource:!0}});X.transformation=M;const Z=se$7,$=a$B(this.symbolLayer,{opacity:this._getLayerOpacity()}),ee=r$Y($)?{baseMaterial:this._material,edgeMaterials:[$],properties:{mergeGeometries:!0,slicePlaneEnabled:this._context.slicePlaneEnabled}}:null,te=new m$z(this,X,g,null,null,Z,m,ee);return te.alignedSampledElevation=u.sampledElevation,te.needsElevationUpdates=g$A(m.mode),te}_createExtrudeGeometry(e,t,s,r){const n=new Uint32Array(e.length),a=[["position",{size:3,data:s.positions,exclusive:!0}],["normal",{size:3,data:s.normals,exclusive:!0}],["color",{size:4,data:r,exclusive:!0}],["size",{size:1,data:s.heights,exclusive:!0}]],o=[["position",e],["normal",e],["color",n]];return s.elevation&&(a.push(["mapPos",{size:3,data:s.elevation}]),o.push(["mapPos",e])),new u$U(a,o,0,t)}}function H$8(e,t,s,r,n,a,o,i,l,c,h,m,p,d){const u=s.length/3;let f=0,g=2*r.count;Y$9(e,t,r.index,r.count,s,0,u,n,a,o,i,l,c,h,g,m,p,d),l+=2*r.count,g=0,J$9(n,a,i,o,f,r.pathLengths[0],r.count,l,c,g,m),l+=4*r.pathLengths[0],g+=2*r.pathLengths[0],f+=r.pathLengths[0];for(let y=1;y<r.pathLengths.length;++y)J$9(n,a,i,o,f,r.pathLengths[y],r.count,l,c,g,m),l+=4*r.pathLengths[y],g+=2*r.pathLengths[y],f+=r.pathLengths[y];}function Y$9(e,t,s,r,n,a,o,i,l,c,p,d,u,f,g,y,_,E){r$Z(ne$5,_);const b=y>0?1:-1;let x=3*s,v=d,P=3*v,w=d+r,A=3*w;for(let h=0;h<r;++h)E&&(ne$5[0]=e[x+0],ne$5[1]=e[x+1],ne$5[2]=e[x+2],j$F(ne$5,ne$5)),i[P+0]=e[x+0],i[P+1]=e[x+1],i[P+2]=e[x+2],l[P+0]=t[x+0],l[P+1]=t[x+1],l[P+2]=t[x+2],c[P+0]=-b*ne$5[0],c[P+1]=-b*ne$5[1],c[P+2]=-b*ne$5[2],p[v]=0,i[A+0]=e[x+0]+y*ne$5[0],i[A+1]=e[x+1]+y*ne$5[1],i[A+2]=e[x+2]+y*ne$5[2],l[A+0]=t[x+0],l[A+1]=t[x+1],l[A+2]=t[x+2],c[A+0]=b*ne$5[0],c[A+1]=b*ne$5[1],c[A+2]=b*ne$5[2],p[w]=y,P+=3,A+=3,x+=3,v+=1,w+=1;x=3*a,P=0,A=3*g;const j=y<0?oe$5:ae$5,L=y<0?ae$5:oe$5;for(let h=0;h<o;++h)f[P+0]=n[x+j[0]],f[P+1]=n[x+j[1]],f[P+2]=n[x+j[2]],u[A+0]=n[x+L[0]]+r,u[A+1]=n[x+L[1]]+r,u[A+2]=n[x+L[2]]+r,P+=3,A+=3,x+=3;}function W$9(e,t,s,r,n,a,o){r[a]=r[o],o*=3,e[(a*=3)+0]=e[o+0],e[a+1]=e[o+1],e[a+2]=e[o+2],t[a+0]=t[o+0],t[a+1]=t[o+1],t[a+2]=t[o+2],s[a+0]=n[0],s[a+1]=n[1],s[a+2]=n[2];}const q$b=n$11();function J$9(e,t,s,r,n,a,o,i,l,c,h){let m=n,p=n+1,d=n+o,u=n+o+1,f=i,g=i+1,y=i+2*a,_=i+2*a+1;h<0&&(m=n+o+1,u=n),c*=3;for(let E=0;E<a;++E)E===a-1&&(h>0?(p=n,u=n+o):(p=n,m=n+o)),ee$5(e,m,p,d,q$b),W$9(e,t,r,s,q$b,f,m),W$9(e,t,r,s,q$b,g,p),W$9(e,t,r,s,q$b,y,d),W$9(e,t,r,s,q$b,_,u),l[c++]=f,l[c++]=y,l[c++]=_,l[c++]=f,l[c++]=_,l[c++]=g,m++,p++,d++,u++,f+=2,g+=2,y+=2,_+=2;}const K$9=n$11(),Q$9=n$11(),X$6=n$11(),Z$6=n$11(),$$a=n$11();function ee$5(e,t,s,r,n){t*=3,s*=3,r*=3,o$S(K$9,e[t++],e[t++],e[t++]),o$S(Q$9,e[s++],e[s++],e[s++]),o$S(X$6,e[r++],e[r++],e[r++]),c$V(Z$6,Q$9,K$9),c$V($$a,X$6,K$9),_$n(n,$$a,Z$6),j$F(n,n);}const te$5=n$11();function se$7(e,t,s,r){const n=e.stageObject,a=n.geometryRecords,o=a.length,l="absolute-height"!==t.mode;let h=0;const m=n.transformation,d=h$L(e$P(),m);for(let i=0;i<o;i+=2){const e=a[i].geometry,o=e.getMutableAttribute("position").data,c=e.vertexAttributes.get("size").data,u=e.vertexAttributes.get("mapPos").data,g=new t$X(u),y=o.length/3;let _=0,E=!1,b=0;const x=s.spatialReference;for(let n=0;n<y;n++){te$5[0]=o[_],te$5[1]=o[_+1],te$5[2]=o[_+2];const e=m$A(g,s,t,r,l?le$7:null);l&&(b+=le$7.sampledElevation),T$k.DISABLE_ELEVATION_ALIGNERS_ITERATIVE_UPDATES?(o$S(re$5,g.array[g.offset+0],g.array[g.offset+1],e+c[_/3]),r.toRenderCoords(re$5,x,re$5),I$x(re$5,re$5,d)):(o$S(re$5,o[_+0],o[_+1],o[_+2]),I$x(re$5,re$5,m),r.setAltitude(re$5,e+c[_/3]),I$x(re$5,re$5,d)),o[_]=re$5[0],o[_+1]=re$5[1],o[_+2]=re$5[2];const n=ie$4/r.unitInMeters;(Math.abs(te$5[0]-o[_])>=n||Math.abs(te$5[1]-o[_+1])>=n||Math.abs(te$5[2]-o[_+2])>=n)&&(E=!0),g.offset+=3,_+=3;}E&&(e.invalidateBoundingInfo(),n.geometryVertexAttrsUpdated(i),a[i+1].geometry.invalidateBoundingInfo(),n.geometryVertexAttrsUpdated(i+1)),h+=b/y;}return h/o}const re$5=n$11(),ne$5=n$11(),ae$5=[0,2,1],oe$5=[0,1,2],ie$4=.01,le$7={verticalDistanceToGround:0,sampledElevation:0};

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
const r$w=1.2,t$x=_$q,a$r=l$13;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class l$q{constructor(e,t,i){this.graphics3DSymbolLayer=e,this.renderGeometries=t,this.boundingBox=i,this.type="draped",this.stage=null,this._visible=!1,this._addedToStage=!1,this._layerView=null,this.isElevationSource=!1;}initialize(e,t,i){this.stage=e,this._layerView=i,this._overlayRenderer=this._layerView.view.basemapTerrain.overlayManager.renderer;}setVisibility(e){if(null!=this.stage&&this._visible!==e){if(this._visible=e,e&&!this._addedToStage)return this._addedToStage=!0,void this._overlayRenderer.addGeometries(this.renderGeometries,this._layerView,1);if(e||this._addedToStage){for(const e of this.renderGeometries)e.instanceParameters.visible=this._visible;this._overlayRenderer.updateGeometries(this.renderGeometries,this._layerView,1);}}}destroy(){this.stage&&this._addedToStage&&this._overlayRenderer.removeGeometries(this.renderGeometries,this._layerView,4),this._addedToStage=!1,this._visible=!1,this.stage=null;}getCenterObjectSpace(e=n$11()){return o$S(e,0,0,0)}getBoundingBoxObjectSpace(e=a$1c()){return B$n(e)}addObjectState(e,t){0===e&&(this.renderGeometries.forEach((e=>{const i=e.addHighlight();t.addRenderGeometry(e,i,this);})),this._addedToStage&&this._overlayRenderer.updateHighlights(this.renderGeometries,this._layerView));}removeObjectState(e){this.renderGeometries.forEach((t=>{e.removeRenderGeometry(t);}));}removeRenderGeometryObjectState(e,t){e.removeHighlight(t),this._addedToStage&&this._overlayRenderer.updateHighlights(this.renderGeometries,this._layerView);}computeAttachmentOrigin(e){for(const t of this.renderGeometries)t.computeAttachmentOrigin(u$r)&&(e.draped.origin[0]+=u$r[0],e.draped.origin[1]+=u$r[1],e.draped.num++);}async getProjectedBoundingBox(t,i,r,n,d){B$n(d);for(let e=0;e<this.renderGeometries.length;e++){const i=this.renderGeometries[e];this._getRenderGeometryProjectedBoundingRect(i,t,m$p,r),c$16(d,m$p);}if(i){let t;p$1a(d,u$r);const r=Z$9(d,i);try{t=await i.service.queryElevation(u$r[0],u$r[1],n,r,"ground");}catch(h){}r$Y(t)&&(d[2]=Math.min(d[2],t),d[5]=Math.max(d[5],t));}return d}_getRenderGeometryProjectedBoundingRect(e,t,i,r){if(this.boundingBox)A$x(g$s,this.boundingBox);else {const t=e.boundingSphere,i=t[3];g$s[0]=t[0]-i,g$s[1]=t[1]-i,g$s[2]=t[2]-i,g$s[3]=t[0]+i,g$s[4]=t[1]+i,g$s[5]=t[2]+i;}return t(g$s,0,2),this.calculateRelativeScreenBounds&&r.push({location:p$1a(g$s),screenSpaceBoundingRect:this.calculateRelativeScreenBounds()}),G$o(g$s,i)}}const m$p=i$P(),g$s=a$1c(),u$r=n$11();

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
function n$A(r,n){const e=r,a=new Uint8Array(4*e*e),o=e/2-.5,s=n/2;for(let c=0;c<e;c++)for(let n=0;n<e;n++){const u=n+e*c,i=n-o,f=c-o;let l=Math.sqrt(i*i+f*f)-s;l=l/r+.5,D$t(l,a,4*u);}return a}function e$q(t,r){return u$q(t,r,!1)}function a$q(t,r){return u$q(t,r,!0)}function o$t(t,r){return i$j(t,r,!1)}function s$r(t,r){return i$j(t,r,!0)}function c$v(r,n){const e=new Uint8Array(4*r*r),a=1,o=-.5,s=Math.sqrt(a*a+o*o),c=(r-n)/2;for(let u=0;u<r;u++)for(let i=0;i<r;i++){const f=u*r+i,l=(i-c)/n,h=(u-c+.75)/n,M=-(a*l+o*h)/s,b=(a*(l-1)+o*-h)/s,w=-h,Q=Math.max(M,b,w);D$t(Q*n/r+.5,e,4*f);}return e}function u$q(r,n,e){e&&(n/=Math.SQRT2);const a=new Uint8Array(4*r*r);for(let o=0;o<r;o++)for(let s=0;s<r;s++){let c=s-.5*r+.25,u=.5*r-o-.75;const i=o*r+s;if(e){const t=(c+u)/Math.SQRT2;u=(u-c)/Math.SQRT2,c=t;}let f=Math.max(Math.abs(c),Math.abs(u))-.5*n;f=f/r+.5,D$t(f,a,4*i);}return a}function i$j(r,n,e){e&&(n*=Math.SQRT2);const a=.5*n,o=new Uint8Array(4*r*r);for(let s=0;s<r;s++)for(let n=0;n<r;n++){let c=n-.5*r,u=.5*r-s-1;const i=s*r+n;if(e){const t=(c+u)/Math.SQRT2;u=(u-c)/Math.SQRT2,c=t;}let f;c=Math.abs(c),u=Math.abs(u),f=c>u?c>a?Math.sqrt((c-a)*(c-a)+u*u):u:u>a?Math.sqrt(c*c+(u-a)*(u-a)):c,f=f/r+.5,D$t(f,o,4*i);}return o}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
function y$n(e){return null!=e}function S$l(e){return "number"==typeof e}function h$p(e){return "string"==typeof e}function x$r(e){return null==e||h$p(e)}function b$i(e,o){e&&e.push(o);}function C$d(e,o,t,i=e$P()){const l=e||0,a=o||0,u=t||0;return 0!==l&&m$W(i,i,-l/180*Math.PI),0!==a&&b$H(i,i,a/180*Math.PI),0!==u&&l$X(i,i,u/180*Math.PI),i}function M$k(e,o,t,i,n){const r=e.minSize,s=e.maxSize;if(e.expression)return b$i(n,"Could not convert size info: expression not supported"),!1;if(e.useSymbolValue){const e=i.symbolSize[t];return o.minSize[t]=e,o.maxSize[t]=e,o.offset[t]=o.minSize[t],o.factor[t]=0,o.type[t]=1,!0}if(y$n(e.field))return y$n(e.stops)?2===e.stops.length&&S$l(e.stops[0].size)&&S$l(e.stops[1].size)?(g$r(e.stops[0].size,e.stops[1].size,e.stops[0].value,e.stops[1].value,o,t),o.type[t]=1,!0):(b$i(n,"Could not convert size info: stops only supported with 2 elements"),!1):S$l(r)&&S$l(s)&&y$n(e.minDataValue)&&y$n(e.maxDataValue)?(g$r(r,s,e.minDataValue,e.maxDataValue,o,t),o.type[t]=1,!0):null!=m$$[e.valueUnit]?(o.minSize[t]=-1/0,o.maxSize[t]=1/0,o.offset[t]=0,o.factor[t]=1/m$$[e.valueUnit],o.type[t]=1,!0):"unknown"===e.valueUnit?(b$i(n,"Could not convert size info: proportional size not supported"),!1):(b$i(n,"Could not convert size info: scale-dependent size not supported"),!1);if(!y$n(e.field)){if(e.stops&&e.stops[0]&&S$l(e.stops[0].size))return o.minSize[t]=e.stops[0].size,o.maxSize[t]=e.stops[0].size,o.offset[t]=o.minSize[t],o.factor[t]=0,o.type[t]=1,!0;if(S$l(r))return o.minSize[t]=r,o.maxSize[t]=r,o.offset[t]=r,o.factor[t]=0,o.type[t]=1,!0}return b$i(n,"Could not convert size info: unsupported variant of sizeInfo"),!1}function g$r(e,o,t,i,n,r){const s=Math.abs(i-t)>0?(o-e)/(i-t):0;n.minSize[r]=s>0?e:o,n.maxSize[r]=s>0?o:e,n.offset[r]=e-t*s,n.factor[r]=s;}function V$b(e,o,t,i){if(e.normalizationField||e.valueRepresentation)return b$i(i,"Could not convert size info: unsupported property"),null;if(!x$r(e.field))return b$i(i,"Could not convert size info: field is not a string"),null;if(o.size){if(e.field)if(o.size.field){if(e.field!==o.size.field)return b$i(i,"Could not convert size info: multiple fields in use"),null}else o.size.field=e.field;}else o.size={field:e.field,minSize:[0,0,0],maxSize:[0,0,0],offset:[0,0,0],factor:[0,0,0],type:[0,0,0]};let n;switch(e.axis){case"width":return n=M$k(e,o.size,0,t,i),n?o:null;case"height":return n=M$k(e,o.size,2,t,i),n?o:null;case"depth":return n=M$k(e,o.size,1,t,i),n?o:null;case"width-and-depth":return n=M$k(e,o.size,0,t,i),n&&M$k(e,o.size,1,t,i),n?o:null;case null:case void 0:case"all":return n=M$k(e,o.size,0,t,i),n=n&&M$k(e,o.size,1,t,i),n=n&&M$k(e,o.size,2,t,i),n?o:null;default:return b$i(i,`Could not convert size info: unknown axis "${e.axis}""`),null}}function T$e(e,o,t){for(let n=0;n<3;++n){let t=o.unitInMeters;1===e.type[n]&&(t*=o.modelSize[n],e.type[n]=2),e.minSize[n]=e.minSize[n]/t,e.maxSize[n]=e.maxSize[n]/t,e.offset[n]=e.offset[n]/t,e.factor[n]=e.factor[n]/t;}let i;if(0!==e.type[0])i=0;else if(0!==e.type[1])i=1;else {if(0===e.type[2])return b$i(t,"No size axis contains a valid size or scale"),!1;i=2;}for(let n=0;n<3;++n)0===e.type[n]&&(e.minSize[n]=e.minSize[i],e.maxSize[n]=e.maxSize[i],e.offset[n]=e.offset[i],e.factor[n]=e.factor[i],e.type[n]=e.type[i]);return !0}function O$e(e,o,t){e[4*o+0]=t.r/255,e[4*o+1]=t.g/255,e[4*o+2]=t.b/255,e[4*o+3]=t.a;}function j$l(e,o,t){if(e.normalizationField)return b$i(t,"Could not convert color info: unsupported property"),null;if(h$p(e.field)){if(!e.stops)return b$i(t,"Could not convert color info: missing stops or colors"),null;{if(e.stops.length>8)return b$i(t,"Could not convert color info: too many color stops"),null;o.color={field:e.field,values:[0,0,0,0,0,0,0,0],colors:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]};const i=e.stops;for(let e=0;e<8;++e){const t=i[Math.min(e,i.length-1)];o.color.values[e]=t.value,O$e(o.color.colors,e,t.color);}}}else {if(!(e.stops&&e.stops.length>=0))return b$i(t,"Could not convert color info: no field and no colors/stops"),null;{const t=e.stops&&e.stops.length>=0&&e.stops[0].color;o.color={field:null,values:[0,0,0,0,0,0,0,0],colors:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]};for(let e=0;e<8;e++)o.color.values[e]=1/0,O$e(o.color.colors,e,t);}}return o}function E$i(e,o,t){if(e.normalizationField)return b$i(t,"Could not convert opacity info: unsupported property"),null;if(h$p(e.field)){if(!e.stops)return b$i(t,"Could not convert opacity info: missing stops or opacities"),null;{if(e.stops.length>8)return b$i(t,"Could not convert opacity info: too many opacity stops"),null;o.opacity={field:e.field,values:[0,0,0,0,0,0,0,0],opacityValues:[0,0,0,0,0,0,0,0]};const i=e.stops;for(let e=0;e<8;++e){const t=i[Math.min(e,i.length-1)];o.opacity.values[e]=t.value,o.opacity.opacityValues[e]=t.opacity;}}}else {if(!(e.stops&&e.stops.length>=0))return b$i(t,"Could not convert opacity info: no field and no opacities/stops"),null;{const t=e.stops&&e.stops.length>=0&&e.stops[0].opacity;o.opacity={field:null,values:[0,0,0,0,0,0,0,0],opacityValues:[0,0,0,0,0,0,0,0]};for(let e=0;e<8;e++)o.opacity.values[e]=1/0,o.opacity.opacityValues[e]=t;}}return o}function k$d(e,o,t){const i=2===t&&"arithmetic"===e.rotationType;o.offset[t]=i?90:0,o.factor[t]=i?-1:1,o.type[t]=1;}function w$m(e,o,t){if(!h$p(e.field))return b$i(t,"Could not convert rotation info: field is not a string"),null;if(o.rotation){if(e.field)if(o.rotation.field){if(e.field!==o.rotation.field)return b$i(t,"Could not convert rotation info: multiple fields in use"),null}else o.rotation.field=e.field;}else o.rotation={field:e.field,offset:[0,0,0],factor:[1,1,1],type:[0,0,0]};switch(e.axis){case"tilt":return k$d(e,o.rotation,0),o;case"roll":return k$d(e,o.rotation,1),o;case null:case void 0:case"heading":return k$d(e,o.rotation,2),o;default:return b$i(t,`Could not convert rotation info: unknown axis "${e.axis}""`),null}}function F$g(e,o,t){if(!e)return null;const i=!o.supportedTypes||!!o.supportedTypes.size,n=!o.supportedTypes||!!o.supportedTypes.color,r=!o.supportedTypes||!!o.supportedTypes.rotation,s=!!o.supportedTypes&&!!o.supportedTypes.opacity,l=e.reduce(((e,l)=>{if(!e)return e;if(l.valueExpression)return b$i(t,"Could not convert visual variables: arcade expressions not supported"),null;switch(l.type){case"size":return i?V$b(l,e,o,t):e;case"color":return n?j$l(l,e,t):e;case"opacity":return s?E$i(l,e,t):null;case"rotation":return r?w$m(l,e,t):e;default:return null}}),{size:null,color:null,opacity:null,rotation:null});return !(e.length>0&&l)||l.size||l.color||l.opacity||l.rotation?l&&l.size&&!T$e(l.size,o,t)?null:l:null}function A$e(e){return e&&null!=e.size}function D$c(e,o){if(!e)return {enabled:!1};if(T$k.DISABLE_FAST_UPDATES)return {enabled:!1};const t=F$g(e.visualVariables,o);return t?{enabled:!0,visualVariables:t,materialParameters:U$a(t,o),requiresShaderTransformation:A$e(t)}:{enabled:!1}}function I$f(e,o,t){if(!o||!e.enabled)return !1;const i=e.visualVariables,n=F$g(o.visualVariables,t);return !!n&&(!!(P$g(i.size,n.size,"size")&&P$g(i.color,n.color,"color")&&P$g(i.rotation,n.rotation,"rotation")&&P$g(i.opacity,n.opacity,"opacity"))&&(e.visualVariables=n,e.materialParameters=U$a(n,t),e.requiresShaderTransformation=A$e(n),!0))}function P$g(e,o,t){if(!!e!=!!o)return !1;if(e&&e.field!==o.field)return !1;if(e&&"rotation"===t){const t=e,i=o;for(let e=0;e<3;e++)if(t.type[e]!==i.type[e]||t.offset[e]!==i.offset[e]||t.factor[e]!==i.factor[e])return !1}return !0}function U$a(e,n){const r={vvSizeEnabled:!1,vvSizeMinSize:null,vvSizeMaxSize:null,vvSizeOffset:null,vvSizeFactor:null,vvSizeValue:null,vvColorEnabled:!1,vvColorValues:null,vvColorColors:null,vvOpacityEnabled:!1,vvOpacityValues:null,vvOpacityOpacities:null,vvSymbolAnchor:null,vvSymbolRotationMatrix:null},s=A$e(e);return e&&e.size?(r.vvSizeEnabled=!0,r.vvSizeMinSize=e.size.minSize,r.vvSizeMaxSize=e.size.maxSize,r.vvSizeOffset=e.size.offset,r.vvSizeFactor=e.size.factor):e&&s&&(r.vvSizeValue=n.transformation.scale),e&&s&&(r.vvSymbolAnchor=n.transformation.anchor,r.vvSymbolRotationMatrix=e$Z(),r$$(q$a),C$d(n.transformation.rotation[2],n.transformation.rotation[0],n.transformation.rotation[1],q$a),a$19(r.vvSymbolRotationMatrix,q$a)),e&&e.color&&(r.vvColorEnabled=!0,r.vvColorValues=e.color.values,r.vvColorColors=e.color.colors),e&&e.opacity&&(r.vvOpacityEnabled=!0,r.vvOpacityValues=e.opacity.values,r.vvOpacityOpacities=e.opacity.opacityValues),r}var R$e;!function(o){const t=e$P(),i=n$11();function n(o,n,r){if(!o.vvSizeEnabled)return r;n$18(t,r);const s=o.vvSymbolRotationMatrix;s$10(q$a,s[0],s[1],s[2],0,s[3],s[4],s[5],0,s[6],s[7],s[8],0,0,0,0,1),e$V(t,t,q$a);for(let t=0;t<3;++t){const r=o.vvSizeOffset[t]+n[0]*o.vvSizeFactor[t];i[t]=o$R(r,o.vvSizeMinSize[t],o.vvSizeMaxSize[t]);}return i$12(t,t,i),c$_(t,t,o.vvSymbolAnchor),t}function r(o,t,i){if(!t.vvSizeEnabled)return o$S(o,1,1,1);for(let n=0;n<3;++n){const r=t.vvSizeOffset[n]+i[0]*t.vvSizeFactor[n];o[n]=o$R(r,t.vvSizeMinSize[n],t.vvSizeMaxSize[n]);}return o}o.evaluateModelTransform=n,o.evaluateModelTransformScale=r;}(R$e||(R$e={}));const q$a=e$P(),$$9=R$e.evaluateModelTransform,_$e=R$e.evaluateModelTransformScale;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class l$p{constructor(t,i,r=null,a=null,e=e$Y(),o=null,m=null,u=!1){this.data=t,this.material=i,this.layerUid=r,this.graphicUid=a,this.id=e,this.boundingInfo=o,this.calculateShaderTransformation=m,this.castShadow=u,this.boundingSphere=n$1a(),this.instanceParameters={highlights:null,occludees:null,visible:!0},this._transformation=e$P(),this._shaderTransformationDirty=!0;}get transformation(){return this._transformation}updateTransformation(t){t(this._transformation),this._shaderTransformationDirty=!0,this.computeBoundingSphere(this._transformation,this.boundingSphere);}shaderTransformationChanged(){this._shaderTransformationDirty=!0;}computeBoundingSphere(i,r,s=d$T(i)){t$17(this.boundingInfo)||(I$x(r,this.boundingInfo.getCenter(),i),r[3]=this.boundingInfo.getBSRadius()*s);}get hasShaderTransformation(){return r$Y(this.calculateShaderTransformation)}get primitiveType(){return this.data.primitiveType}getShaderTransformation(){return t$17(this.calculateShaderTransformation)?c$W(this.transformation,a$10):(this._shaderTransformationDirty&&(this._shaderTransformation||(this._shaderTransformation=e$P()),n$18(this._shaderTransformation,this.calculateShaderTransformation(c$W(this.transformation,a$10))),this._shaderTransformationDirty=!1),this._shaderTransformation)}computeAttachmentOrigin(t){if(this.material.computeAttachmentOrigin)return !!this.material.computeAttachmentOrigin(this,t)&&(r$Y(this._transformation)&&I$x(t,t,this._transformation),!0);const r=this.indices.get("position"),s=this.vertexAttributes.get("position");return !!u$11(s,r,t)&&(r$Y(this._transformation)&&I$x(t,t,this._transformation),!0)}get indices(){return this.data.indices}get vertexAttributes(){return this.data.vertexAttributes}addHighlight(){const t=new r$O(0),i=this.instanceParameters;return i.highlights=u$V(i.highlights,t),t}removeHighlight(t){const i=this.instanceParameters;i.highlights=l$Y(i.highlights,t);}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
const se$6=e$P(),ae$4=t$_(0,0,1),oe$4=16,ne$4=1.5,le$6=128,ce$6=.5,he$6=[ce$6/2,ce$6/2,1-ce$6/2,1-ce$6/2],me$3=[le$6*ce$6,le$6*ce$6];class ue$3 extends y$r{constructor(e,t,r,i){super(e,t,r,i),this._cimLayers=null,this._cimSymbolMaterials=new Map,this._cimSymbolTextures=new Map,this._cimMaterialParametersInfo=null,this._cimRequiredFields=null,this._cimScaleFactorOrFunction=null,this._size=null,this._symbolTextureRatio=1,this._outlineSize=0,this._texture=null,this._releaseTexture=null,this._elevationOptions={supportsOffsetAdjustment:!0,supportsOnTheGround:!0};}getCachedSize(){return {size:this._getIconSize()}}async doLoad(e){this._validateOrThrow();const t=this._prepareMaterialParameters(),r=this._getPrimitive();if(r$Y(r))this._prepareResourcesPrimitive(t,r);else {const r=d$12(this.symbol,this.symbolLayer),i=V$p(r);i&&"application/json"===i.mediaType?await this._prepareResourcesCIM(t,JSON.parse(i.data),e):await this._prepareResourcesHref(t,r,e);}}_validateOrThrow(){if(this._drivenProperties.size)return;const e=O$i(this._getIconSize());if(e)throw new s$Q("graphics3diconsymbollayer:invalid-size",e)}_getIconSize(){const e=this.symbolLayer,t=Math.round(null!=e.size?u$_(e.size):oe$4);return this._drivenProperties.size?Math.max(t,64):t}_generateTextureCIM(e){const t=this._getGraphicHash(e);let r=""===t?null:this._cimSymbolTextures.get(t);if(!r){const i={scaleFactor:this._cimScaleFactorOrFunction},s=this._context.sharedResources.cimSymbolRasterizer.rasterizeCIMSymbol(this._cimLayers,e,"esriGeometryPoint",i,null,null);this._cimMaterialParametersInfo.anchorPos=this._getAnchorPos("relative",s.anchorPosition);const a={width:s.imageData.width,height:s.imageData.height,powerOfTwoResizeMode:2};r=new S$E(s.imageData,a),this._cimSymbolTextures.set(t,r),this._context.stage.add(r);}return r}_computeSize(e,t){const r=e.width/e.height;return r>1?[t,Math.round(t/r)]:[Math.round(t*r),t]}_prepareMaterialParameters(){const e={anchorPos:this._getAnchorPos(this.symbolLayer.anchor,this.symbolLayer.anchorPosition)},t=this.symbol;if(de$3(t)){const{screenLength:r,minWorldLength:i,maxWorldLength:s}=t.verticalOffset;e.verticalOffset={screenLength:u$_(r),minWorldLength:i||0,maxWorldLength:null!=s?s:1/0};}return this._context.screenSizePerspectiveEnabled&&(e.screenSizePerspective=this._context.sharedResources.screenSizePerspectiveSettings),e.occlusionTest=!0,e.slicePlaneEnabled=this._context.slicePlaneEnabled,e}_prepareResourcesPrimitive(e,t){const r=this._getOutlineSize();if(_e(t)&&0===r)throw new Error("Nothing to render");this._outlineSize=r,e.color=this._getFillColor(),e.outlineColor=this._getOutlineColor(),e.outlineSize=this._outlineSize;const i=this._context.sharedResources.textures.fromData(t,(()=>pe$5(t)));this._texture=i.texture,this._releaseTexture=()=>this._context.sharedResources.textures.release(i.uid),e.textureIsSignedDistanceField=!0,e.distanceFieldBoundingBox=he$6,e.textureId=this._texture.id;const s=this._getIconSize();this._size=[s,s],this._symbolTextureRatio=1/ce$6,this._createMaterialAndAddToStage(e,this._context.stage);}async _prepareResourcesHref(e,s,a){if(!s$U("esri-canvas-svg-support")&&wt$1(s)){throw new s$Q("graphics3diconsymbollayer:unsupported-image-format","IconSymbol3DLayer failed to load (SVG symbols are not supported in IE11)")}this._outlineSize=this._getOutlineSize(),e.color=this._getFillColor(),e.outlineColor=this._getOutlineColor(),e.outlineSize=this._outlineSize,e.textureIsSignedDistanceField=!1;const o=this._getIconSize(),n=o*this._context.layerView.view.pixelRatio,c=await a$1h(this._context.sharedResources.textures.fromUrl(s,n,{signal:a}));if(!1===c.ok){w$G(c.error);throw new s$Q("graphics3diconsymbollayer:request-failed",`Failed to load (Request for icon resource failed: ${s})`)}const{uid:h,texture:m}=c.value;this._releaseTexture=()=>this._context.sharedResources.textures.release(h);const u=m.params;this._size=this._computeSize(u,o),e.textureId=m.id,this._createMaterialAndAddToStage(e,this._context.stage);}async _prepareResourcesCIM(e,t,r){const i=new d$13({data:t});if(!this._context.sharedResources.cimSymbolRasterizer){const e=(await import('./CIMSymbolRasterizer-fb878283.js')).CIMSymbolRasterizer;a$1i(r),this._context.sharedResources.cimSymbolRasterizer||(this._context.sharedResources.cimSymbolRasterizer=new e(this._context.renderCoordsHelper.spatialReference,!0));}const s=this._context.layer.fields?this._context.layer.fields.map((e=>e.toJSON())):null;let a,o;if(this._cimLayers=await this._context.sharedResources.cimSymbolRasterizer.analyzeCIMSymbol(i,s,this._context.renderer&&"dictionary"===this._context.renderer.type?this._context.renderer.fieldMap:null,"esriGeometryPoint",{signal:r}),this._context.renderer&&"dictionary"===this._context.renderer.type&&this._context.renderer.scaleExpression){const e=this._context.renderer;if(isNaN(e.scaleExpression)){const t=e.scaleExpression,r=await i$13(t,this._context.layer.spatialReference,s);o=(e,t,i)=>{const s=s$11(r,e,{$view:i},"esriGeometryPoint",t);return null!==s?s:1};}else a=Number(e.scaleExpression);}this._cimScaleFactorOrFunction=a||o||1;const n=this._context.renderer?await this._context.renderer.getRequiredFields(this._context.layer.fieldsIndex):[];a$1i(r);const l=this._context.layer.fieldsIndex;this._cimRequiredFields=n.map((e=>l.get(e).name)),this._cimMaterialParametersInfo=e,this._cimMaterialParametersInfo.color=this._getFillColor(),this._cimMaterialParametersInfo.outlineColor=[0,0,0,0],this._cimMaterialParametersInfo.outlineSize=0,this._cimMaterialParametersInfo.textureIsSignedDistanceField=!1;}_getPrimitive(){return this.symbolLayer.resource&&this.symbolLayer.resource.href?null:this.symbolLayer.resource&&this.symbolLayer.resource.primitive||j$J}_getOutlineSize(){let e=0;const t=this.symbolLayer;if(r$Y(t.outline)&&null!=t.outline.size)return Math.max(u$_(t.outline.size),0);return e=_e(this._getPrimitive())?ne$4:0,Math.max(e,0)}_getOutlineColor(){const t=this._getLayerOpacity(),r=this.symbolLayer,i=g$Y(r,"outline","color");if(r$Y(i)){const r=o$W.toUnitRGB(i),s=i.a*t;return [r[0],r[1],r[2],s]}return [0,0,0,0]}_getFillColor(){if(_e(this._getPrimitive()))return t$x;const e=t$17(this._getPrimitive()),t=g$Y(this.symbolLayer,"material","color");return this._getCombinedOpacityAndColor(t,{hasIntrinsicColor:e})}_getAnchorPos(e,t){return "relative"===e?t$18((t.x||0)+.5,.5-(t.y||0)):e in q$d?q$d[e]:q$d.center}_createMaterialAndAddToStage(e,t){if(this._cimLayers?this._fastUpdates={enabled:!1}:this._fastUpdates=D$c(this._context.renderer,this._fastVisualVariableConvertOptions()),this._fastUpdates.enabled&&Object.assign(e,this._fastUpdates.materialParameters),this._cimLayers){let r=this._cimSymbolMaterials.get(e.textureId);return r||(r=new W$d(e),this._cimSymbolMaterials.set(e.textureId,r),t.add(r)),r}return this._material=new W$d(e),t.add(this._material),this._material}_setDrapingDependentMaterialParameters(){this.draped&&(this._forEachMaterial((e=>{e.setParameterValues({verticalOffset:null,screenSizePerspective:null,occlusionTest:!1,slicePlaneEnabled:!1,shaderPolygonOffset:0,isDraped:this.draped});})),this.layerOpacityChanged());}destroy(){super.destroy(),this._forEachMaterial((e=>this._context.stage.remove(e))),this._material=null,this._cimSymbolMaterials.clear(),this._cimSymbolTextures.forEach((e=>this._context.stage.remove(e))),this._cimSymbolTextures.clear(),this._releaseTexture&&(this._releaseTexture(),this._releaseTexture=null);}_getScaleFactor(e,t){if(this._drivenProperties.size&&e.size){for(let t=0;t<3;t++){const r=e.size[t];r&&"symbol-value"!==r&&"proportional"!==r&&(e.size[t]=u$_(r));}if("symbol-value"===e.size[0])return 1;if(isFinite(+e.size[0]))return +e.size[0]/t;if(isFinite(+e.size[2]))return +e.size[2]/t}return 1}createGraphics3DGraphic(e){const t=e.graphic;if(!this._validateGeometry(t.geometry))return null;let r,i;if(this._cimLayers){if(!this._cimLayers.length)return null;const e=this._generateTextureCIM(t),s={textureId:e.id,...this._cimMaterialParametersInfo};i=this._createMaterialAndAddToStage(s,this._context.stage),r=[e.params.width,e.params.height];}else r=this._size,i=e$12(this._material);const s=d$u(t.geometry);if(t$17(s))return this.logger.warn(`unsupported geometry type for icon symbol: ${t.geometry.type}`),null;const a=e.renderingInfo,l=this._getVertexOpacityAndColor(a);let c=1;if(!this._fastUpdates.enabled||!this._fastUpdates.visualVariables.size){const e=r[0]>r[1]?r[0]:r[1];c=this._getScaleFactor(a,e);}c*=this._symbolTextureRatio;const h=[r[0]*c,r[1]*c],m=this.setGraphicElevationContext(t,new h$s);return this.ensureDrapedStatus("on-the-ground"===m.mode)&&this._setDrapingDependentMaterialParameters(),this.draped?this._createAsOverlay(t,s,i,l,h,e.layer.uid):this._createAs3DShape(t,s,i,l,h,m,t.uid)}layerOpacityChanged(){const e=this._getFillColor(),t=this._getOutlineColor();return this._forEachMaterial((r=>{r.setParameterValues({color:e}),r.setParameterValues({outlineColor:t});})),!0}layerElevationInfoChanged(e,t,r){const i=this._elevationContext.mode,s=d$y(ue$3.elevationModeChangeTypes,r,i);if(s!==T$j.UPDATE)return s;const a=p$F(i)||"absolute-height"===i;return this.updateGraphics3DGraphicElevationInfo(e,t,(()=>a))}slicePlaneEnabledChanged(){return this.draped||this._forEachMaterial((e=>{e.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled});})),!0}physicalBasedRenderingChanged(){return !0}pixelRatioChanged(){return !!this._getPrimitive()}applyRendererDiff(e,t){for(const r in e.diff)switch(r){case"visualVariables":if(!I$f(this._fastUpdates,t,this._fastVisualVariableConvertOptions()))return !1;r$Y(this._material)&&this._material.setParameterValues(this._fastUpdates.materialParameters);break;default:return !1}return !0}_defaultElevationInfoNoZ(){return fe$1}_createAs3DShape(e,t,r,i,s,a,o){const n=this.getFastUpdateAttrValues(e),l=n?e=>$$9(this._fastUpdates.materialParameters,n,e):null,c=[P$w.createPointGeometry(ae$4,null,i,s,ye$1,null,n)],h=f$t(this._context,t,c,[r],null,null,a,this._context.layer.uid,o,l);if(null===h)return null;const m=E$k,u=new m$z(this,h.object,c,null,null,m,a);return u.alignedSampledElevation=h.sampledElevation,u.needsElevationUpdates=p$F(a.mode)||"absolute-height"===a.mode,u.getScreenSize=this._createScreenSizeGetter(s,l),u.calculateRelativeScreenBounds=e=>r.calculateRelativeScreenBounds(u.getScreenSize(),1,e),g$y(u,t,this._context.elevationProvider),u}_createAsOverlay(e,t,r,i,a,o){r.renderPriority=this._renderPriority;const n=n$1a();Rn(t,n,this._context.overlaySR),n[2]=$$b;const l=this._context.clippingExtent;if(r$Y(l)&&!E$y(l,n))return null;const c=this.getFastUpdateAttrValues(e),h=c?e=>$$9(this._fastUpdates.materialParameters,c,e):null,m=P$w.createPointGeometry(ae$4,n,i,a,null,null,c),u=new l$p(m,r,o,e.uid);n[3]=0,a$12(u.boundingSphere,n),u.calculateShaderTransformation=h;const d=new l$q(this,[u],null);return d.getScreenSize=this._createScreenSizeGetter(a,h),d.calculateRelativeScreenBounds=e=>r.calculateRelativeScreenBounds(d.getScreenSize(),1,e),d}_createScreenSizeGetter(e,t){const r=this._outlineSize+2;if(this._fastUpdates.enabled){const i=e[0]/this._symbolTextureRatio,s=e[1]/this._symbolTextureRatio;return (e=n$19())=>{const a=t(se$6);return e[0]=a[0]*i+r,e[1]=a[5]*s+r,e}}{const t=e[0]/this._symbolTextureRatio+r,i=e[1]/this._symbolTextureRatio+r;return (e=n$19())=>(e[0]=t,e[1]=i,e)}}_fastVisualVariableConvertOptions(){const e=this._size[0]>this._size[1]?this._size[0]:this._size[1],t=t$_(e,e,e),r=e$17(1),i=e*r;return {modelSize:t,symbolSize:t$_(i,i,i),unitInMeters:r,transformation:{anchor:f$R,scale:l$14,rotation:f$R}}}_getGraphicHash(e){let t="";for(const r of this._cimRequiredFields)t+=r+e.attributes[r];return t}_forEachMaterial(e){r$Y(this._material)&&e(this._material),this._cimSymbolMaterials.forEach(e);}}function de$3(e){return e&&"point-3d"===e.type&&e.hasVisibleVerticalOffset()}function _e(e){return !!r$Y(e)&&("cross"===e||"x"===e)}function pe$5(e){let t;const r=le$6,i=r*ce$6;switch(e){case"circle":t=n$A(r,i);break;case"square":t=e$q(r,i);break;case"kite":t=a$q(r,i);break;case"cross":t=o$t(r,i);break;case"x":t=s$r(r,i);break;case"triangle":t=c$v(r,i);}return new S$E(t,{mipmap:!1,wrap:{s:33071,t:33071},width:le$6,height:le$6,components:4,noUnpackFlip:!0})}ue$3.PRIMITIVE_SIZE=me$3,ue$3.elevationModeChangeTypes={definedChanged:T$j.UPDATE,staysOnTheGround:T$j.NONE,onTheGroundChanged:T$j.RECREATE};const fe$1={mode:"relative-to-ground",offset:0},ye$1=r$19(0,0,0,1);

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
function b$h(t){const o=[],e=[];j$k(t,e,o);const n=e[0][1].data,r=o[0][1].length,i=new Uint16Array(r);return A$d(t,e,o),F$f(t,e,o,i),w$l(t,e,o,i),v$m(t,e,o,i),D$b(t,e,o,i),P$f(t,e,o,i),U$9(t,e,o,n),new u$U(e,o,2)}function g$q(t,o,e,n){const r="polygon"===t.type?1:0,i="polygon"===t.type?t.rings:t.paths,{position:s,outlines:a}=l$19(i,t.hasZ,r),u=new Float64Array(s.length),c=f$z(s,t.spatialReference,0,u,0,s,0,s.length/3,o,e,n),p=null!=c;return {lines:p?d$o(a,s,u):[],projectionSuccess:p,sampledElevation:c}}function d$o(t,o,e){const n=new Array;for(const{index:r,count:i}of t){if(i<=1)continue;const t=3*r,s=t+3*i;n.push({position:o.subarray(t,s),mapPosition:e?e.subarray(t,s):void 0});}return n}function z$c(t,o){const e="polygon"===t.type?1:0,n="polygon"===t.type?t.rings:t.paths,{position:r,outlines:i}=l$19(n,!1,e),s=xn(r,t.spatialReference,0,r,o,0,r.length/3);for(let a=2;a<r.length;a+=3)r[a]=$$b;return {lines:s?d$o(i,r):[],projectionSuccess:s}}function j$k(t,o,e){const{attributeData:{position:n},removeDuplicateStartEnd:i}=t,s=M$j(n)&&1===i,a=n.length/3-(s?1:0),u=new Uint32Array(2*(a-1)),c=s?t$1n(n,0,n.length-3):n;let p=0;for(let r=0;r<a-1;r++)u[p++]=r,u[p++]=r+1;o.push(["position",{size:3,data:c,exclusive:s}]),e.push(["position",u]);}function A$d(t,e,n){const r=t.attributeData.mapPosition;t$17(r)||(n.push(["mapPos",n[0][1]]),e.push(["mapPos",{size:3,data:r}]));}function F$f(t,o,r,i){if(r$Y(t.attributeData.colorFeature))return;const s=t.attributeData.color;o.push(["color",{size:4,data:c$W(s,a$r)}]),r.push(["color",i]);}function v$m(t,e,n,r){const i=t.attributeData.colorFeature;t$17(i)||(e.push(["colorFeatureAttribute",{size:1,data:new Float32Array([i])}]),n.push(["color",r]));}function w$l(t,o,r,i){if(r$Y(t.attributeData.sizeFeature))return;const s=t.attributeData.size;o.push(["size",{size:1,data:[c$W(s,1)]}]),r.push(["size",i]);}function D$b(t,e,n,r){const i=t.attributeData.sizeFeature;t$17(i)||(e.push(["sizeFeatureAttribute",{size:1,data:new Float32Array([i])}]),n.push(["sizeFeatureAttribute",r]));}function P$f(t,e,n,r){const i=t.attributeData.opacityFeature;t$17(i)||(e.push(["opacityFeatureAttribute",{size:1,data:new Float32Array([i])}]),n.push(["opacityFeatureAttribute",r]));}function U$9(o,e,r,c){if("round"!==o.join)return;const p=c.length/3,l=new Float32Array(p),f=S$k,h=R$d;o$S(f,0,0,0);const m=c$W(o.uniformSize,1);for(let n=-1;n<p;++n){const o=n<0?p+n:n,e=(n+1)%p;if(o$S(h,c[3*e+0]-c[3*o+0],c[3*e+1]-c[3*o+1],c[3*e+2]-c[3*o+2]),j$F(h,h),n>=0){const o=1*((Math.PI-x$N(z$u(f,h)))*k$c)*x$q(m);l[n]=Math.max(Math.floor(o),0);}d$O(f,h,-1);}e.push(["subdivisions",{size:1,data:l}]),r.push(["subdivisions",r[0][1]]);}function x$q(t){return 1.863798+-2.0062872/(1+t/18.2313)**.8856294}function M$j(t){const o=t.length;return t[0]===t[o-3]&&t[1]===t[o-2]&&t[2]===t[o-1]}const S$k=n$11(),R$d=n$11(),k$c=4/Math.PI;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
function e$p(e){return t$17(e)?e:e.slice()}function n$z(r){return [r,r]}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
const V$a=["polyline","polygon","extent"];class R$c extends y$r{constructor(e,t,i,r){super(e,t,i,r),this._uniformSize=1;}async doLoad(){if(this._vvConvertOptions={modelSize:[1,1,1],symbolSize:[1,1,1],unitInMeters:1,transformation:{anchor:[0,0,0],scale:[1,1,1],rotation:[0,0,0]},supportedTypes:{size:!0,color:!0,opacity:!0,rotation:!1}},this._context.renderer&&this._context.renderer.visualVariables&&this._context.renderer.visualVariables.length>0?this._fastUpdates=D$c(this._context.renderer,this._vvConvertOptions):this._fastUpdates={enabled:!1},!this._drivenProperties.size){const e=null!=this.symbolLayer.size?this.symbolLayer.size:e$17(1);if(e<0)throw new s$Q("graphics3dlinesymbollayer:invalid-size","Symbol sizes may not be negative values");this._uniformSize=e;}}getMaterialParameters(t){const r=g$Y(this.symbolLayer,"material","color"),a=this._getCombinedOpacityAndColor(r),o=a[3],l={width:1,color:a,polygonOffset:!0,join:this.symbolLayer.join||"miter",cap:this.symbolLayer.cap||"butt",transparent:o<1||this.needsDrivenTransparentPass,slicePlaneEnabled:this._context.slicePlaneEnabled,isClosed:t,stipplePattern:this.symbolLayer.stipplePattern?e$p(this.symbolLayer.stipplePattern.map(u$_)):null,stippleOffColor:this.symbolLayer.stippleOffColor?o$W.toUnitRGBA(this.symbolLayer.stippleOffColor):null,stippleIntegerRepeats:!0};if(this._drivenProperties.size)this._fastUpdates.enabled&&this._fastUpdates.visualVariables.size&&(l.width=u$_(1));else {const e=null!=this.symbolLayer.size?this.symbolLayer.size:e$17(1);l.width=u$_(e);}return this._fastUpdates&&this._fastUpdates.visualVariables?{...l,...this._fastUpdates.materialParameters}:l}get lineMaterial(){return t$17(this._lineMaterial)&&(this._lineMaterial=new M$m(this.getMaterialParameters(!1)),this._context.stage.add(this._lineMaterial)),this._lineMaterial}get ringMaterial(){return t$17(this._ringMaterial)&&(this._ringMaterial=new M$m(this.getMaterialParameters(!0)),this._context.stage.add(this._ringMaterial)),this._ringMaterial}destroy(){super.destroy(),this._context.stage.remove(this._lineMaterial),this._lineMaterial=null,this._context.stage.remove(this._ringMaterial),this._ringMaterial=null;}getDrivenSize(e){return this._drivenProperties.size&&e.size?u$_(c$z(e.size)):1}getSizeFeatureAttributeData(e){return this._fastUpdates.enabled&&this._fastUpdates.visualVariables.size?v$s(this._fastUpdates.visualVariables.size.field,e):null}getDrivenColor(e){const t=r$19(1,1,1,1);return this._drivenProperties.color&&e.color&&(t[0]=e.color[0],t[1]=e.color[1],t[2]=e.color[2],e.color.length>0&&(t[3]=e.color[3])),this._drivenProperties.opacity&&e.opacity&&(t[3]=e.opacity),t}getColorFeatureAttributeData(e){return this._fastUpdates.enabled&&this._fastUpdates.visualVariables.color?v$s(this._fastUpdates.visualVariables.color.field,e):null}getOpacityFeatureAttributeData(e){return this._fastUpdates.enabled&&this._fastUpdates.visualVariables.opacity?v$s(this._fastUpdates.visualVariables.opacity.field,e):null}createGraphics3DGraphic(e){const t=e.graphic;if(!this._validateGeometry(t.geometry,V$a,this.symbolLayer.type))return null;const i=this.setGraphicElevationContext(t,new h$s);return this.ensureDrapedStatus("on-the-ground"===i.mode),this.draped?this._createAsOverlay(e,this._context.layer.uid):this._createAs3DShape(e,i,t.uid)}applyRendererDiff(e,t){for(const i in e.diff)switch(i){case"visualVariables":if(!I$f(this._fastUpdates,t,this._vvConvertOptions))return !1;r$Y(this._lineMaterial)&&this._lineMaterial.setParameterValues(this._fastUpdates.materialParameters),r$Y(this._ringMaterial)&&this._ringMaterial.setParameterValues(this._fastUpdates.materialParameters);break;default:return !1}return !0}layerOpacityChanged(){return r$Y(this._lineMaterial)&&this.updateMaterialLayerOpacity(this._lineMaterial),r$Y(this._ringMaterial)&&this.updateMaterialLayerOpacity(this._ringMaterial),!0}updateMaterialLayerOpacity(e){const t=e.params.color,r=g$Y(this.symbolLayer,"material","color"),a=this._getCombinedOpacity(r),s=a<1||this.needsDrivenTransparentPass,n=[t[0],t[1],t[2],a];e.setParameterValues({color:n,transparent:s});}layerElevationInfoChanged(e,t,i){const r=this._elevationContext.mode,a=d$y(R$c.elevationModeChangeTypes,i,r);if(a!==T$j.UPDATE)return a;const s=p$F(r);return this.updateGraphics3DGraphicElevationInfo(e,t,(()=>s))}slicePlaneEnabledChanged(){return r$Y(this._lineMaterial)&&this._lineMaterial.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled}),r$Y(this._ringMaterial)&&this._ringMaterial.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled}),!0}physicalBasedRenderingChanged(){return !0}pixelRatioChanged(){return !0}_getGeometryAsPolygonOrPolyline(e){switch(e.type){case"extent":if(e instanceof M$x)return j$H.fromExtent(e);break;case"polygon":case"polyline":return e}return null}_createAs3DShape(e,t,i){const r=e.graphic,s=this._getGeometryAsPolygonOrPolyline(r.geometry),n="polygon"===s.type?s.rings:s.paths,l=new Array,p=new Array,y=new Array,u=a$1c(),f=g$q(s,this._context.elevationProvider,this._context.renderCoordsHelper,t),_="polygon"===s.type?"rings":"paths";this._logGeometryCreationWarnings(f,n,_,"LineSymbol3DLayer");for(let h=0;h<f.lines.length;h++){const{position:t,mapPosition:i}=f.lines[h];if(r$Y(this._context.clippingExtent)&&(B$n(u),M$z(u,i),!R$u(u,this._context.clippingExtent)))continue;const r=this._createGeometry(e,t,i,s.type);l.push(r),p.push("polygon"===s.type?this.ringMaterial:this.lineMaterial),y.push(a$10);}if(0===l.length)return null;const v=new R$p({geometries:l,materials:p,transformations:y,castShadow:!1,metadata:{layerUid:this._context.layer.uid,graphicUid:i}}),M=new m$z(this,v,l,null,null,f$y,t);return M.alignedSampledElevation=f.sampledElevation,M.needsElevationUpdates=p$F(t.mode),M}_createGeometry(e,t,i,r){const a="polygon"===r?1:0,s=this._fastUpdates.enabled&&this._fastUpdates.visualVariables.color,n=this._fastUpdates.enabled&&this._fastUpdates.visualVariables.size;return b$h({removeDuplicateStartEnd:a,uniformSize:this._uniformSize,attributeData:{position:t,mapPosition:i,size:n?null:this.getDrivenSize(e.renderingInfo),color:s?null:this.getDrivenColor(e.renderingInfo),sizeFeature:this.getSizeFeatureAttributeData(e.graphic),colorFeature:this.getColorFeatureAttributeData(e.graphic),opacityFeature:this.getOpacityFeatureAttributeData(e.graphic)}})}_createAsOverlay(e,t){const i=e.graphic,r=this._getGeometryAsPolygonOrPolyline(i.geometry),a="polygon"===r.type?r.rings:r.paths,s="polygon"===r.type?this.ringMaterial:this.lineMaterial;s.renderPriority=this._renderPriority;const n=new Array,o=a$1c(),p=B$n(),u=z$c(r,this._context.overlaySR),g="polygon"===r.type?"rings":"paths";this._logGeometryCreationWarnings(u,a,g,"LineSymbol3DLayer");for(const h of u.lines){if(B$n(o),M$z(o,h.position),!R$u(o,this._context.clippingExtent))continue;f$S(p,o);const a=this._createGeometry(e,h.position,null,r.type),u=new l$p(a,s,t,i.uid);r$17(u.boundingSphere,.5*(o[0]+o[3]),.5*(o[1]+o[4]),0,.5*Math.sqrt((o[3]-o[0])*(o[3]-o[0])+(o[4]-o[1])*(o[4]-o[1]))),n.push(u);}return new l$q(this,n,p)}}R$c.elevationModeChangeTypes={definedChanged:T$j.RECREATE,staysOnTheGround:T$j.NONE,onTheGroundChanged:T$j.RECREATE};

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
function e$o(r){switch(r){case"multiply":return 1;case"ignore":return 2;case"replace":return 3;case"tint":return 4;default:return 1}}function n$y(e,n,i){if(t$17(e)||2===n)return i[0]=255,i[1]=255,i[2]=255,void(i[3]=255);const s=o$R(Math.round(e[3]*u$p),0,u$p),m=0===s||4===n?0:3===n?a$p:c$u;i[0]=o$R(Math.round(e[0]*o$s),0,o$s),i[1]=o$R(Math.round(e[1]*o$s),0,o$s),i[2]=o$R(Math.round(e[2]*o$s),0,o$s),i[3]=s+m;}const o$s=255,u$p=85,a$p=u$p,c$u=2*u$p;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
const r$v=A$u().vec3f("position"),o$r=A$u().vec3f("position").vec2f("uv0"),i$i=A$u().vec3f("position").vec4u8("color");class f$p{constructor(t){this.vertexBufferLayout=t;}allocate(t){return this.vertexBufferLayout.createBuffer(t)}elementCount(t){return t.indices.get("position").length}write(t,r,o,i){g$Z(r,this.vertexBufferLayout,t.transformation,t.invTranspTransformation,o,i);}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
function n$x(n){const p=new n$15;return p.include(r$11,{linearDepth:!1}),p.include(r$1m,n),p.include(p$y,n),p.vertex.uniforms.add("proj","mat4").add("view","mat4"),p.attributes.add("position","vec3"),p.varyings.add("vpos","vec3"),p.vertex.code.add(t$10`void main(void) {
vpos = position;
forwardNormalizedVertexColor();
gl_Position = transformPosition(proj, view, vpos);`),n.stippleEnabled&&(p.attributes.add("auxpos1","vec3"),p.vertex.uniforms.add("ndcToPixel","vec2"),p.vertex.code.add(t$10`
    vec4 vpos2 = transformPosition(proj, view, auxpos1);
    float lineSegmentPixelSize = length((vpos2.xy / vpos2.w - gl_Position.xy / gl_Position.w) * ndcToPixel);

    stipplePatternUv = lineSegmentPixelSize * stipplePatternPixelSizeInv;
    ${n.stippleIntegerRepeatsEnabled?"stipplePatternUv = floor(stipplePatternUv + 0.5);":""}

    // Cancel out perspective correct interpolation because we want this length the really represent
    // the screen distance
    stipplePatternUv *= gl_Position.w;
    `)),p.vertex.code.add(t$10`}`),4===n.output&&p.include(r$1g),p.include(c$$,n),p.fragment.uniforms.add("constantColor","vec4").add("alphaCoverage","float"),p.fragment.code.add(t$10`
  void main() {
    discardBySlice(vpos);

    vec4 color = ${n.attributeColor?"vColor":"constantColor"};

    float stippleAlpha = getStippleAlpha();
    discardByStippleAlpha(stippleAlpha, stippleAlphaColorDiscard);

    vec4 finalColor = blendStipple(vec4(color.rgb, color.a * alphaCoverage), stippleAlpha);

    if (finalColor.a < ${t$10.float(o$10)}) {
      discard;
    }

    ${0===n.output?t$10`gl_FragColor = highlightSlice(finalColor, vpos);`:""}
    ${4===n.output?t$10`outputHighlight();`:""}
  }
  `),p}var p$t=Object.freeze({__proto__:null,build:n$x});

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class v$l extends t$11{constructor(e,t,i){super(e,t,i),this.stipplePattern=null,this.stippleTextureBind=null,this.stippleTextureRepository=e.stippleTextureRepository;}initializeProgram(e){const t=v$l.shader.get(),i=this.configuration,r=t.build({output:i.output,attributeColor:i.vertexColors,slicePlaneEnabled:i.slicePlaneEnabled,sliceHighlightDisabled:!1,sliceEnabledForVertexPrograms:!1,stippleEnabled:i.stippleEnabled,stippleOffColorEnabled:i.stippleOffColorEnabled,stippleUVMaxEnabled:!1,stippleIntegerRepeatsEnabled:i.stippleIntegerRepeatsEnabled});return new n$16(e.rctx,r,o$X)}dispose(){super.dispose(),this.stippleTextureRepository.release(this.stipplePattern),this.stipplePattern=null,this.stippleTextureBind=null;}bindPass(e,r){if(t$15(this.program,r.camera.projectionMatrix),this.stipplePattern!==e.stipplePattern){const t=e.stipplePattern;this.stippleTextureBind=this.stippleTextureRepository.swap(this.stipplePattern,t),this.stipplePattern=t;}if(this.configuration.stippleEnabled){const e=r$Y(this.stippleTextureBind)?this.stippleTextureBind(this.program)*r.camera.pixelRatio:1;this.program.setUniform1i("stipplePatternTexture",0),this.program.setUniform1f("stipplePatternPixelSizeInv",1/e),this.program.setUniform2f("ndcToPixel",r.camera.fullViewport[2]/2,r.camera.fullViewport[3]/2);}if(this.program.setUniform4fv("constantColor",e.color),this.program.setUniform1f("alphaCoverage",Math.min(1,e.width*r.camera.pixelRatio)),this.configuration.stippleOffColorEnabled){const t=e$12(e.stippleOffColor);this.program.setUniform4f("stippleOffColor",t[0],t[1],t[2],t.length>3?t[3]:1);}4===this.configuration.output&&g$V(this.program,r);}bindDraw(e){a$17(this.program,e),l$_(this.program,this.configuration,e),this.program.rebindTextures();}initializePipeline(){const e=this.configuration,t=e$T(770,1,771,771),i=(t,i=null,r=null)=>g$S({blending:i,depthTest:a$1e,depthWrite:r,colorWrite:r$13,stencilWrite:e.sceneHasOcludees?f$T:null,stencilTest:e.sceneHasOcludees?t?t$1k:c$15:null});return 0===e.output?(this._occludeePipelineState=i(!0,e.transparent||e.stippleEnabled?t:null,l$$),i(!1,e.transparent||e.stippleEnabled?t:null,l$$)):i(!1)}get primitiveType(){return 1}getPipelineState(e){return e?this._occludeePipelineState:this.pipeline}}v$l.shader=new t$12(p$t,(()=>import('./NativeLine.glsl-d979d971.js')));class y$m extends e$S{constructor(){super(...arguments),this.output=0,this.slicePlaneEnabled=!1,this.vertexColors=!1,this.transparent=!1,this.stippleEnabled=!1,this.stippleOffColorEnabled=!1,this.stippleIntegerRepeatsEnabled=!1,this.sceneHasOcludees=!1;}}e$Q([r$12({count:8})],y$m.prototype,"output",void 0),e$Q([r$12()],y$m.prototype,"slicePlaneEnabled",void 0),e$Q([r$12()],y$m.prototype,"vertexColors",void 0),e$Q([r$12()],y$m.prototype,"transparent",void 0),e$Q([r$12()],y$m.prototype,"stippleEnabled",void 0),e$Q([r$12()],y$m.prototype,"stippleOffColorEnabled",void 0),e$Q([r$12()],y$m.prototype,"stippleIntegerRepeatsEnabled",void 0),e$Q([r$12()],y$m.prototype,"sceneHasOcludees",void 0);

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
const U$8=n$12.getLogger("esri.views.3d.webgl-engine.materials.NativeLineMaterial");class H$7 extends a$18{constructor(e){super(e,V$9),this.techniqueConfig=new y$m;}getTechniqueConfig(e){this.techniqueConfig.output=e,this.techniqueConfig.slicePlaneEnabled=this.params.slicePlaneEnabled,this.techniqueConfig.vertexColors=this.params.vertexColors,this.techniqueConfig.transparent=this.params.color[3]<1||this.params.width<1;const r=r$Y(this.params.stipplePattern);return this.techniqueConfig.stippleEnabled=r,this.techniqueConfig.stippleOffColorEnabled=r&&r$Y(this.params.stippleOffColor),this.techniqueConfig.stippleIntegerRepeatsEnabled=r&&this.params.stippleIntegerRepeats,this.techniqueConfig.sceneHasOcludees=this.params.sceneHasOcludees,this.techniqueConfig}getPassParameters(){return this.params}intersect(e,t,r,s,i,n,o,a,c){c?I$A(e,s,n,1,o):this.intersectLineGeometry(e,t,r,s,o);}intersectLineGeometry(e,t,r,s,f){if(!s.options.selectionMode||f$N(t))return;if(!A$z(r))return void U$8.error("intersection assumes a translation-only matrix");const b=e.vertexAttributes.get("position").data,C=s.camera,q=Y$8;a$13(q,s.point);const y=2;o$S(Z$5[0],q[0]-y,q[1]+y,0),o$S(Z$5[1],q[0]+y,q[1]+y,0),o$S(Z$5[2],q[0]+y,q[1]-y,0),o$S(Z$5[3],q[0]-y,q[1]-y,0);for(let i=0;i<4;i++)if(!C.unprojectFromRenderScreen(Z$5[i],$$8[i]))return;M$w(C.eye,$$8[0],$$8[1],ee$4),M$w(C.eye,$$8[1],$$8[2],te$4),M$w(C.eye,$$8[2],$$8[3],re$4),M$w(C.eye,$$8[3],$$8[0],se$5);let x=Number.MAX_VALUE;for(let i=0;i<b.length-5;i+=3){if(k$b[0]=b[i]+r[12],k$b[1]=b[i+1]+r[13],k$b[2]=b[i+2]+r[14],I$e[0]=b[i+3]+r[12],I$e[1]=b[i+4]+r[13],I$e[2]=b[i+5]+r[14],R$s(ee$4,k$b)<0&&R$s(ee$4,I$e)<0||R$s(te$4,k$b)<0&&R$s(te$4,I$e)<0||R$s(re$4,k$b)<0&&R$s(re$4,I$e)<0||R$s(se$5,k$b)<0&&R$s(se$5,I$e)<0)continue;if(C.projectToRenderScreen(k$b,F$e),C.projectToRenderScreen(I$e,X$5),F$e[2]<0&&X$5[2]>0){c$V(W$8,k$b,I$e);const e=C.frustum,t=-R$s(e[4],k$b)/z$u(W$8,W$j(e[4]));d$O(W$8,W$8,t),u$S(k$b,k$b,W$8),C.projectToRenderScreen(k$b,F$e);}else if(F$e[2]>0&&X$5[2]<0){c$V(W$8,I$e,k$b);const e=C.frustum,t=-R$s(e[4],I$e)/z$u(W$8,W$j(e[4]));d$O(W$8,W$8,t),u$S(I$e,I$e,W$8),C.projectToRenderScreen(I$e,X$5);}else if(F$e[2]<0&&X$5[2]<0)continue;F$e[2]=0,X$5[2]=0;const e=b$E(l$18(F$e,X$5,K$8),q);e<x&&(x=e,r$Z(z$b,k$b),r$Z(J$8,I$e));}const _=s.rayBeginPoint,L=s.rayEndPoint;if(x<y*y){let e=Number.MAX_VALUE;if(k$D(l$18(z$b,J$8,K$8),l$18(_,L,Q$8),D$a)){c$V(D$a,D$a,_);const t=s$P(D$a);d$O(D$a,D$a,1/t),e=t/q$o(_,L);}f(e,D$a);}}computeAttachmentOrigin(e,t){const r=e.vertexAttributes;if(!r)return !1;const s=r.get("position");return g$W(s,null,!1,t)}createBufferWriter(){const e=this.params.vertexColors?i$i:r$v;return t$17(this.params.stipplePattern)?new f$p(e):new N$a(e.clone().vec3f("auxpos1"))}getGLMaterial(e){return 0===e.output||4===e.output?new G$a(e):void 0}}class G$a extends t$1i{constructor(e){super(e),this.updateParameters();}updateParameters(){this._technique=this._techniqueRep.releaseAndAcquire(v$l,this._material.getTechniqueConfig(this._output),this._technique);}beginSlot(e){return 3===e}_updateOccludeeState(e){e.hasOccludees!==this._material.params.sceneHasOcludees&&(this._material.setParameterValues({sceneHasOcludees:e.hasOccludees}),this.updateParameters());}ensureParameters(e){0===this._output&&this._updateOccludeeState(e);}bind(e){this._technique.bindPass(this._material.getPassParameters(),e);}getPipelineState(e,t){return this._technique.getPipelineState(t)}}class N$a{constructor(e){this.vertexBufferLayout=e;}allocate(e){return this.vertexBufferLayout.createBuffer(e)}elementCount(e){return e.indices.get("position").length}write(e,t,r,s){g$Z(t,this.vertexBufferLayout,e.transformation,e.invTranspTransformation,r,s),this.writeAuxpos1(e,t,r,s);}writeAuxpos1(e,t,r,s){const i=r.getField("auxpos1",i$14),n=t.indices.get("position"),o=t.vertexAttributes.get("position").data,a=e.transformation,c=i.typedBufferStride,u=i.typedBuffer;s*=c;for(let l=0;l<n.length;l+=2){const e=3*n[l],t=o[e],r=o[e+1],i=o[e+2],p=a[0]*t+a[4]*r+a[8]*i+a[12],m=a[1]*t+a[5]*r+a[9]*i+a[13],f=a[2]*t+a[6]*r+a[10]*i+a[14];for(let n=0;n<2;++n)u[s]=p,u[s+1]=m,u[s+2]=f,s+=c;}}}const V$9={color:[1,1,1,1],vertexColors:!1,slicePlaneEnabled:!1,width:1,stipplePattern:null,stippleIntegerRepeats:!1,stippleOffColor:null,sceneHasOcludees:!1,...d$$},k$b=n$11(),I$e=n$11(),W$8=n$11(),D$a=n$11(),F$e=x$Q(),X$5=x$Q(),z$b=n$11(),J$8=n$11(),K$8=v$K(),Q$8=v$K(),Y$8=n$11(),Z$5=[x$Q(),x$Q(),x$Q(),x$Q()],$$8=[n$11(),n$11(),n$11(),n$11()],ee$4=p$11(),te$4=p$11(),re$4=p$11(),se$5=p$11();

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
const oe$3=["mesh"];class ae$3 extends y$r{constructor(e,t,r,o){super(e,t,r,o),this._materials=new Map,this._textures=new Map,this.ensureDrapedStatus(!1);}async doLoad(){T$k.DRAW_MESH_GEOMETRY_NORMALS&&(this._debugVertexNormalMaterial=new H$7({color:[1,0,1,1]}),this._debugFaceNormalMaterial=new H$7({color:[0,1,1,1]}));}destroy(){super.destroy(),this._context.stage.removeMany(Array.from(this._materials.values(),(e=>e.material))),this._context.stage.removeMany(Array.from(this._textures.values())),this._materials.clear(),this._textures.clear();}createGraphics3DGraphic(e){const t=e.graphic;if(!this._validateGeometry(t.geometry,oe$3,"fill on mesh-3d"))return null;const r=this.setGraphicElevationContext(t,new h$s),o=e.renderingInfo;return this._createAs3DShape(t,o,r,t.uid)}layerOpacityChanged(e,r){const o=this._getLayerOpacity();return this._materials.forEach((e=>{e.material.setParameterValues({layerOpacity:o});const t=e.material.params;this._setMaterialTransparentParameter(t,e),e.material.setParameterValues({transparent:t.transparent});})),e.forEach((e=>{const a=r(e);r$Y(a)&&a.layerOpacityChanged(o,this._context.isAsync);})),!0}layerElevationInfoChanged(e,t){return this.updateGraphics3DGraphicElevationInfo(e,t,g$A)}slicePlaneEnabledChanged(e,r){return this._materials.forEach((e=>{e.material.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled});})),e.forEach((e=>{const o=r(e);r$Y(o)&&o.slicePlaneEnabledChanged(this._context.slicePlaneEnabled,this._context.isAsync);})),!0}physicalBasedRenderingChanged(){const e=this._usePBR();return this._materials.forEach((t=>t.material.setParameterValues({usePBR:e}))),!0}pixelRatioChanged(){return !0}_requiresSymbolVertexColors(){return this._drivenProperties.color||this._drivenProperties.opacity}_colorOrTextureUid(t){return t$17(t)?"-":t instanceof o$W?t.toHex():t.contentHash}_materialPropertiesDefault(e,t){const r=this._requiresSymbolVertexColors(),o=!!e.vertexAttributes.color,a=!!e.vertexAttributes.tangent;return {hasSymbolVertexColors:r,hasVertexColors:o,hasVertexTangents:a,uid:`vc:${o},vt:${a},vct${t},svc:${r}`}}_materialProperties(e,t,r){const o=this._materialPropertiesDefault(e,r);if(!t.material)return o;const{color:a,colorTexture:s,normalTexture:n,doubleSided:i,alphaCutoff:l,alphaMode:c}=t.material,u=this._colorOrTextureUid(a),m=this._colorOrTextureUid(s),h=this._colorOrTextureUid(n);if(o.color=a,o.colorTexture=s,o.normalTexture=n,o.uid=`${o.uid},cmuid:${u},ctmuid:${m},ntmuid:${h},ds:${i},ac:${l},am:${c}`,t.material instanceof c$17){const{metallic:e,roughness:r,metallicRoughnessTexture:a,emissiveColor:s,emissiveTexture:n,occlusionTexture:i}=t.material,l=this._colorOrTextureUid(a),c=this._colorOrTextureUid(s),u=this._colorOrTextureUid(n),m=this._colorOrTextureUid(i);o.metallic=e,o.roughness=r,o.metallicRoughnessTexture=a,o.emissiveColor=s,o.emissiveTexture=n,o.occlusionTexture=i,o.uid=`${o.uid},mrm:${e},mrr:${r},mrt:${l},emuid:${c},etmuid:${u},otmuid:${m}`;}return o}_setInternalColorValueParameters(t,r){r.diffuse=o$W.toUnitRGB(t),r.opacity=t.a;}_getLoadableTextureResource(e){return e.data?e.data:e.url}_getInternalTextureId(e){const t=this._getLoadableTextureResource(e);if(!t)return;const r=e.contentHash;let o=this._textures.get(r);return o||(o=new S$E(t,{mipmap:!0,wrap:this._castTextureWrap(e.wrap),noUnpackFlip:!0,preMultiplyAlpha:!0}),this._textures.set(r,o),this._context.stage.add(o)),o.id}_castTextureWrap(e="repeat"){if("string"==typeof e){const t=this._castTextureWrapIndividual(e);return {s:t,t}}return {s:this._castTextureWrapIndividual(e.horizontal),t:this._castTextureWrapIndividual(e.vertical)}}_castTextureWrapIndividual(e){switch(e){case"clamp":return 33071;case"mirror":return 33648;case"repeat":default:return 10497}}_setInternalMaterialParameters(r,o){r$Y(r.color)&&this._setInternalColorValueParameters(r.color,o),r$Y(r.colorTexture)&&(o.textureId=this._getInternalTextureId(r.colorTexture)),r$Y(r.normalTexture)&&(o.normalTextureId=this._getInternalTextureId(r.normalTexture)),r$Y(r.emissiveColor)&&(o.emissiveFactor=o$W.toUnitRGB(r.emissiveColor)),r$Y(r.emissiveTexture)&&(o.emissiveTextureId=this._getInternalTextureId(r.emissiveTexture)),r$Y(r.occlusionTexture)&&(o.occlusionTextureId=this._getInternalTextureId(r.occlusionTexture)),r$Y(r.metallicRoughnessTexture)&&(o.metallicRoughnessTextureId=this._getInternalTextureId(r.metallicRoughnessTexture));}_setExternalMaterialParameters(r){const o=this._drivenProperties.color;let a=r$Y(this.symbolLayer.material)?this.symbolLayer.material.colorMixMode:null;if(o)r.externalColor=l$13;else {const o=r$Y(this.symbolLayer.material)?this.symbolLayer.material.color:null;r$Y(o)?r.externalColor=o$W.toUnitRGBA(o):(a=null,r.externalColor=l$13);}a&&(r.colorMixMode=a),r.castShadows=!!this.symbolLayer.castShadows;}_hasTransparentVertexColors(e){const t=e.vertexAttributes.color;if(t$17(t))return !1;for(let r=3;r<t.length;r+=4)if(255!==t[r])return !0;return !1}_getOrCreateMaterial(e,r){const o=r.material&&r.material.color,a=r.material&&r.material.colorTexture,s=r.material&&"blend"===r.material.alphaMode,n=!(r.material&&"opaque"===r.material.alphaMode)&&(this._hasTransparentVertexColors(e)||r$Y(o)&&o.a<1||r$Y(a)&&a.transparent||s),i=this._materialProperties(e,r,n),l=this._materials.get(i.uid);if(l)return l.material;const c={material:null,isComponentTransparent:n,alphaMode:r.material?r.material.alphaMode:"opaque"},u=null==i.metallicRoughnessTexture&&null==i.metallic&&null==i.roughness,m={usePBR:this._usePBR(),isSchematic:u,vertexColors:i.hasVertexColors,symbolColors:i.hasSymbolVertexColors,vertexTangents:i.hasVertexTangents,ambient:f$R,diffuse:l$14,opacity:1,doubleSided:!0,doubleSidedType:"winding-order",cullFace:0,textureAlphaPremultiplied:!0,layerOpacity:this._getLayerOpacity(),slicePlaneEnabled:this._context.slicePlaneEnabled,initTextureTransparent:!0};u||(m.mrrFactors=[null!=i.metallic?i.metallic:1,null!=i.roughness?i.roughness:1,.5]),r.material&&(m.doubleSided=r.material.doubleSided,m.cullFace=r.material.doubleSided?0:2,m.textureAlphaCutoff=r.material.alphaCutoff),this._setInternalMaterialParameters(i,m),this._setExternalMaterialParameters(m),this._setMaterialTransparentParameter(m,c);const h=new y$S(m);return c.material=h,this._materials.set(i.uid,c),this._context.stage.add(h),h}_usePBR(){return this._context.physicalBasedRenderingEnabled}_setMaterialTransparentParameter(e,t){e.transparent=this.needsDrivenTransparentPass||t.isComponentTransparent||e.layerOpacity<1||e.opacity<1||e.externalColor&&e.externalColor[3]<1,"auto"===t.alphaMode?e.textureAlphaMode=e.transparent?3:1:e.textureAlphaMode="opaque"===t.alphaMode?1:"mask"===t.alphaMode?2:0;}_addDebugNormals(e,t,r,o){const a=t.length,s=e.spatialReference.isGeographic?20015077/180:1,n=.1*Math.max(e.extent.width*s,e.extent.height*s,e.extent.zmax-e.extent.zmin),i=[],l=[],c=[],m=[];for(let u=0;u<a;u++){const e=t[u],r=e.vertexAttributes.get("position"),o=e.vertexAttributes.get("normal"),a=e.indices.get("position"),s=e.indices.get("normal"),f=r.data,d=o.data;for(let t=0;t<a.length;t++){const e=3*a[t],r=3*s[t];for(let t=0;t<3;t++)i.push(f[e+t]);for(let t=0;t<3;t++)i.push(f[e+t]+d[r+t]*n);if(l.push(l.length),l.push(l.length),t%3==0){this._calculateFaceNormal(f,a,t,ce$5),this._getFaceVertices(f,a,t,ne$3,ie$3,le$5),u$S(ne$3,ne$3,ie$3),u$S(ne$3,ne$3,le$5),d$O(ne$3,ne$3,1/3);for(let e=0;e<3;e++)c.push(ne$3[e]);for(let e=0;e<3;e++)c.push(ne$3[e]+ce$5[e]*n);m.push(m.length),m.push(m.length);}}}const f=new u$U([["position",{data:i,size:3,exclusive:!0}]],[["position",new Uint32Array(l)]],2);t.push(f),r.push(this._debugVertexNormalMaterial),o.push(r$1b(o[0]));const d=new u$U([["position",{data:c,size:3,exclusive:!0}]],[["position",new Uint32Array(m)]],2);t.push(d),r.push(this._debugFaceNormalMaterial),o.push(r$1b(o[0]));}_createAs3DShape(e,r,o,a){const s=e.geometry;if("mesh"!==s.type)return null;const n=this._createGeometryInfo(s,r);if(!n)return null;const{geometries:i,materials:l,transformations:c,objectTransformation:u}=n;T$k.DRAW_MESH_GEOMETRY_NORMALS&&this._addDebugNormals(s,i,l,c);const m=new R$p({geometries:i,materials:l,transformations:c,metadata:{layerUid:this._context.layer.uid,graphicUid:a}});m.transformation=u;const h=E$k,p=this._createEdgeMaterial(),f=r$Y(p)?{baseMaterial:l[0],edgeMaterials:[p],properties:{mergeGeometries:!0,slicePlaneEnabled:this._context.slicePlaneEnabled}}:null,d=new m$z(this,m,i,null,null,h,o,f);return d.needsElevationUpdates=g$A(o.mode),d.useObjectOriginAsAttachmentOrigin=!0,d.elevationContext.centerPointInElevationSR=this.getCenterPointInElevationSR(m),d.alignedSampledElevation=h(d,d.elevationContext,this._context.elevationProvider,this._context.renderCoordsHelper),d}getCenterPointInElevationSR(e){const t=v$O(0,0,0,this._context.elevationProvider.spatialReference);return Mn([e.transformation[12],e.transformation[13],e.transformation[14]],this._context.renderCoordsHelper.spatialReference,t),t}_createComponentNormals(e,t,r,o){switch(r.shading||"flat"){case"source":return this._createComponentNormalsSource(e,t,r,o);case"flat":return this._createComponentNormalsFlat(e,o);case"smooth":return this._createComponentNormalsSmooth(e,o);default:return}}_createComponentNormalsSource(e,t,o,a){if(t$17(t))return this._createComponentNormalsFlat(e,a);let s=!1;if(!o.trustSourceNormals)for(let r=0;r<a.length;r+=3){this._calculateFaceNormal(e,a,r,ce$5);for(let e=0;e<3;e++){const o=3*a[r+e];ne$3[0]=t[o+0],ne$3[1]=t[o+1],ne$3[2]=t[o+2],z$u(ce$5,ne$3)<0&&(t[o+0]=-t[o+0],t[o+1]=-t[o+1],t[o+2]=-t[o+2],s=!0);}}return {normals:t,indices:a,didFlipNormals:s}}_createComponentNormalsFlat(e,t){const r=new Float32Array(t.length),o=new Uint32Array(3*t.length);for(let a=0;a<t.length;a+=3){const s=this._calculateFaceNormal(e,t,a,ce$5);for(let e=0;e<3;e++)r[a+e]=s[e],o[a+e]=a/3;}return {normals:r,indices:o,didFlipNormals:!1}}_createComponentNormalsSmooth(e,t){const r={};for(let s=0;s<t.length;s+=3){const o=this._calculateFaceNormal(e,t,s,ce$5);for(let e=0;e<3;e++){const a=t[s+e];let n=r[a];n||(n={normal:n$11(),count:0},r[a]=n),u$S(n.normal,n.normal,o),n.count++;}}const o=new Float32Array(3*t.length),a=new Uint32Array(3*t.length);for(let s=0;s<t.length;s++){const e=r[t[s]];1!==e.count&&(j$F(e.normal,e.normal),e.count=1);for(let t=0;t<3;t++)o[3*s+t]=e.normal[t];a[s]=s;}return {normals:o,indices:a,didFlipNormals:!1}}_getFaceVertices(e,t,r,o,a,s){const n=3*t[r+0],i=3*t[r+1],l=3*t[r+2];o[0]=e[n+0],o[1]=e[n+1],o[2]=e[n+2],a[0]=e[i+0],a[1]=e[i+1],a[2]=e[i+2],s[0]=e[l+0],s[1]=e[l+1],s[2]=e[l+2];}_calculateFaceNormal(e,t,r,o){return this._getFaceVertices(e,t,r,ne$3,ie$3,le$5),c$V(ie$3,ie$3,ne$3),c$V(le$5,le$5,ne$3),_$n(ne$3,ie$3,le$5),j$F(o,ne$3),o}_getOrCreateComponents(e){return e.components?e.components:pe$4}_createPositionBuffer(e,r){let o=e.vertexAttributes.position;const a=1===r.reprojection?r.transformBeforeProject:null;if(r$Y(a)&&(o=V$q(o,new Float64Array(o.length),a)),0===r.reprojection)return r.needsBufferCopy?new Float64Array(o):o;const s=r$Y(a)?o:new Float64Array(o.length);return xn(o,e.spatialReference,0,s,this._context.renderCoordsHelper.spatialReference,0,o.length/3),s}_createNormalBuffer(e,o,a){let s=e.vertexAttributes.normal;if(t$17(s))return null;const n=1===a.reprojection?a.transformBeforeProject:null;r$Y(n)&&(s=k$E(s,new Float32Array(s.length),n));if("local"===this._context.layerView.view.viewingMode||0===a.reprojection)return a.needsBufferCopy&&e.vertexAttributes.normal===s?new Float32Array(s):s;const i=e.vertexAttributes.position,l=r$Y(n)?s:new Float32Array(s.length);return F$B(s,i,o,e.spatialReference,l)}_createTangentBuffer(e,o,a){let s=e.vertexAttributes.tangent;if(t$17(s))return null;const n=1===a.reprojection?a.transformBeforeProject:null;r$Y(n)&&(s=L$v(s,new Float32Array(s.length),n));if("local"===this._context.layerView.view.viewingMode||0===a.reprojection)return a.needsBufferCopy&&e.vertexAttributes.normal===s?new Float32Array(s):s;const i=e.vertexAttributes.position,l=r$Y(n)?s:new Float32Array(s.length);return B$q(s,i,o,e.spatialReference,l)}_createColorBuffer(e){return e.vertexAttributes.color}_createSymbolColorBuffer(e){if(this._requiresSymbolVertexColors()){const t=this._getVertexOpacityAndColor(e),r=e$o(g$Y(this.symbolLayer,"material","colorMixMode")),a=new Uint8Array(4);return n$y(t,r,a),a}return null}_createBuffers(e,r){const o=e.vertexAttributes&&e.vertexAttributes.position;if(!o)return this.logger.warn("Mesh geometry must contain position vertex attributes"),null;const a=e.vertexAttributes.normal,s=e.vertexAttributes.uv,n=e.vertexAttributes.tangent;if(r$Y(a)&&a.length!==o.length)return this.logger.warn("Mesh normal vertex buffer must contain the same number of elements as the position buffer"),null;if(r$Y(n)&&n.length/4!=o.length/3)return this.logger.warn("Mesh tangent vertex buffer must contain the same number of elements as the position buffer"),null;if(r$Y(s)&&s.length/2!=o.length/3)return this.logger.warn("Mesh uv vertex buffer must contain the same number of elements as the position buffer"),null;const i=this._computeReprojectionInfo(e),l=this._createPositionBuffer(e,i),c=this._createColorBuffer(e),u=this._createSymbolColorBuffer(r),h=this._createNormalBuffer(e,l,i),p=this._createTangentBuffer(e,l,i);return {positionBuffer:l,normalBuffer:h,tangentBuffer:p,uvBuffer:s,colorBuffer:c,symbolColorBuffer:u,objectTransformation:0===i.reprojection&&r$Y(i.objectTransformation)?i.objectTransformation:this._transformOriginLocal(e,l,h,p),geometryTransformation:0===i.reprojection&&r$Y(i.geometryTransformation)?i.geometryTransformation:e$P()}}_computeReprojectionInfo(e){const r=r$Y(e.transform)&&e.transform.geographic||2===this._context.renderCoordsHelper.viewingMode?0:1;let o=null;if(r$Y(e.transform)){if(0===r){const t=e$P();Sn(e.spatialReference,e.transform.origin,t,this._context.renderCoordsHelper.spatialReference);return {reprojection:r,objectTransformation:t,geometryTransformation:r$1b(e.transform.localMatrix),needsBufferCopy:!1}}return o=x$S(e$P(),e.transform.origin),e$V(o,o,e.transform.localMatrix),{reprojection:r,transformBeforeProject:o,needsBufferCopy:!0}}return {reprojection:r,needsBufferCopy:!0}}_transformOriginLocal(e,r,o,n){const i=this._context.renderCoordsHelper.spatialReference,l=e.anchor;se$4[0]=l.x,se$4[1]=l.y,se$4[2]=l.z;const u=e$P();Sn(e.spatialReference,se$4,u,i);const h=T$v.fromTypedArray(r);if(h$L(ue$2,u),e$16(h,h,ue$2),r$Y(o)||r$Y(n)){if(a$19(me$2,u),o$Z(me$2,me$2),r$Y(o)){const e=i$14.fromTypedArray(o);f$U(e,e,me$2);}if(r$Y(n)){const e=i$14.fromTypedArray(n,4*n.BYTES_PER_ELEMENT);f$U(e,e,me$2);}}return u}_validateFaces(e,t){const r=e.vertexAttributes.position.length/3,o=t.faces;if(o){let e=-1;for(let t=0;t<o.length;t++){const r=o[t];r>e&&(e=r);}if(r<=e)return this.logger.warn(`Vertex index ${e} is out of bounds of the mesh position buffer`),!1}else if(r%3!=0)return this.logger.warn("Mesh position buffer length must be a multiple of 9 if no component faces are defined (3 values per vertex * 3 vertices per triangle)"),!1;return !0}_getOrCreateFaces(e,t){return t.faces?t.faces:l$U(e.vertexAttributes.position.length/3)}_isOutsideClippingArea(e){if(!this._context.clippingExtent)return !1;const t=e.vertexAttributes&&e.vertexAttributes.position;if(!t)return !1;const r=this._context.elevationProvider.spatialReference;let o;const a=t.length/3;return e.spatialReference.equals(r)?o=t:(o=new Float64Array(t.length),xn(e.vertexAttributes.position,e.spatialReference,0,o,r,0,a)),B$n(he$5),M$z(he$5,o,0,a),!R$u(he$5,this._context.clippingExtent)}_createGeometryInfo(e,o){if(!nn(e.spatialReference,this._context.layerView.view.spatialReference))return this.logger.warn("Geometry spatial reference is not compatible with the view"),null;if(this._isOutsideClippingArea(e))return null;const a=this._createBuffers(e,o);if(t$17(a))return null;const{positionBuffer:s,uvBuffer:n,colorBuffer:i,symbolColorBuffer:l,normalBuffer:c,tangentBuffer:u,objectTransformation:m,geometryTransformation:h}=a,p=this._getOrCreateComponents(e),f=[],d=[],g=[];let x=!1;for(const r of p){if(!this._validateFaces(e,r))return null;const o=this._getOrCreateFaces(e,r);if(0===o.length)continue;const a=this._createComponentNormals(s,c,r,o);a.didFlipNormals&&(x=!0);const m=[["position",{size:3,data:s,exclusive:!0}],["normal",{size:3,data:a.normals,exclusive:!0}]],p=[["position",o],["normal",a.indices]];r$Y(i)&&(m.push(["color",{size:4,data:i,exclusive:!0}]),p.push(["color",o])),r$Y(l)&&(m.push(["symbolColor",{size:4,data:l,exclusive:!0}]),p.push(["symbolColor",new Uint16Array(o.length)])),r$Y(n)&&(m.push(["uv0",{size:2,data:n,exclusive:!0}]),p.push(["uv0",o])),r$Y(u)&&(m.push(["tangent",{size:4,data:u,exclusive:!0}]),p.push(["tangent",o]));const _=new u$U(m,p);f.push(_),d.push(h),g.push(this._getOrCreateMaterial(e,r));}return x&&this.logger.warn("Normals have been automatically flipped to be consistent with the counter clock wise face winding order. It is better to generate mesh geometries that have consistent normals."),{geometries:f,transformations:d,materials:g,objectTransformation:m}}_createEdgeMaterial(){const e={opacity:this._getLayerOpacity()};return a$B(this.symbolLayer,e)}}const se$4=n$11(),ne$3=n$11(),ie$3=n$11(),le$5=n$11(),ce$5=n$11(),ue$2=e$P(),me$2=e$Z(),he$5=a$1c(),pe$4=[new f$V];

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class u$o{constructor(e,t,i,n){this.graphics3DSymbolLayer=e,this.instanceIndex=t,this.elevationAligner=i,this.elevationContext=n,this.type="lod-instance",this.alignedSampledElevation=0,this.isElevationSource=!1,this.needsElevationUpdates=!1;}initialize(){}setVisibility(e){const t=this.lodRenderer.instanceData;e!==t.getVisible(this.instanceIndex)&&t.setVisible(this.instanceIndex,e);}destroy(){null!=this.instanceIndex&&(this.lodRenderer.instanceData.removeInstance(this.instanceIndex),this.graphics3DSymbolLayer.notifyDestroyGraphicLayer(this));}alignWithElevation(e,t,i){if(this.elevationAligner){s$B(this.elevationContext.featureExpressionInfoContext,i);const n=this.elevationAligner(this,this.elevationContext,e,t);null!=n&&(this.alignedSampledElevation=n);}}getCenterObjectSpace(e=n$11()){return this.lodRenderer.instanceData.getCombinedLocalTransform(this.instanceIndex,b$g),I$x(e,this.lodRenderer.baseBoundingSphere.center,b$g)}getBoundingBoxObjectSpace(e=a$1c()){this.lodRenderer.instanceData.getCombinedLocalTransform(this.instanceIndex,b$g);const t=this.lodRenderer.baseBoundingBox;B$n(e);for(let s=0;s<8;++s)o$S(f$o,0==(1&s)?t[0]:t[3],0==(2&s)?t[1]:t[4],0==(4&s)?t[2]:t[5]),I$x(f$o,f$o,b$g),h$V(e,f$o);return e}computeAttachmentOrigin(e){this.lodRenderer.instanceData.getGlobalTransform(this.instanceIndex,b$g),e.render.origin[0]+=b$g[12],e.render.origin[1]+=b$g[13],e.render.origin[2]+=b$g[14],e.render.num++;}async getProjectedBoundingBox(t,n,s,a,o){const c=this.getBoundingBoxObjectSpace(o),m=v$k,u=S$D(c)?1:m.length;this.lodRenderer.instanceData.getGlobalTransform(this.instanceIndex,b$g);for(let e=0;e<u;e++){const t=m[e];f$o[0]=c[t[0]],f$o[1]=c[t[1]],f$o[2]=c[t[2]],I$x(f$o,f$o,b$g),p$s[3*e+0]=f$o[0],p$s[3*e+1]=f$o[1],p$s[3*e+2]=f$o[2];}if(!t(p$s,0,u))return null;B$n(c);let I=null;this.calculateRelativeScreenBounds&&(I=this.calculateRelativeScreenBounds());for(let e=0;e<3*u;e+=3){for(let t=0;t<3;t++)c[t]=Math.min(c[t],p$s[e+t]),c[t+3]=Math.max(c[t+3],p$s[e+t]);I&&s.push({location:p$s.slice(e,e+3),screenSpaceBoundingRect:I});}if(n&&(p$1a(c,x$p),"absolute-height"!==this.elevationContext.mode)){let t;const i=Z$9(c,n);try{t=await n.service.queryElevation(x$p[0],x$p[1],a,i,"ground");}catch(S){}r$Y(t)&&V$o(c,0,0,-this.alignedSampledElevation+t);}return c}addObjectState(e,t){if(0===e){const i=new r$O(e);this.addHighlightId(i),t.addExternal((e=>{this.removeHighlightId(e);}),i);}}removeObjectState(e){this.highlights&&this.highlights.forEach((t=>e.remove(t)));}addHighlightId(e){this.highlights=this.highlights||new Set,this.highlights.add(e),this.lodRenderer.instanceData.setHighlight(this.instanceIndex,!0);}removeHighlightId(e){this.highlights&&(this.highlights.delete(e),this.lodRenderer.instanceData.setHighlight(this.instanceIndex,this.highlights.size>0),0===this.highlights.size&&(this.highlights=null));}get lodRenderer(){return this.graphics3DSymbolLayer.lodRenderer}}const p$s=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],f$o=n$11(),x$p=n$11(),v$k=[[0,1,2],[3,1,2],[0,4,2],[3,4,2],[0,1,5],[3,1,5],[0,4,5],[3,4,5]],b$g=e$P();

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
function t$w(e){const t=[];return e.stageResources.geometries.forEach(((s,n)=>{const o=e.stageResources.materials[n],r=e.stageResources.textures;t.push({material:o,geometry:s,textures:r});})),{components:t,minScreenSpaceRadius:e.lodThreshold,pivotOffset:e.pivotOffset}}function s$q(e){return {levels:e.map((e=>t$w(e)))}}function n$w(t,s=r$u){const n=c$A(t);return Math.sqrt(n/(s*Math.PI))}function o$q(e){e.levels.forEach((e=>{e.minScreenSpaceRadius||(e.minScreenSpaceRadius=n$w(e));}));}const r$u=.05;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
var p$r;function F$d(t){let e=A$u().mat4f64("localTransform").mat4f64("globalTransform").vec4f64("boundingSphere").vec3f64("modelOrigin").mat3f("model").mat3f("modelNormal").vec2f("modelScaleFactors");return t.indexOf("color")>=0&&(e=e.vec4f("color")),t.indexOf("featureAttribute")>=0&&(e=e.vec4f("featureAttribute")),e=e.u8("state").u8("lodLevel").alignTo(8),e}!function(t){t[t.ALLOCATED=1]="ALLOCATED",t[t.DEFAULT_ACTIVE=2]="DEFAULT_ACTIVE",t[t.VISIBLE=4]="VISIBLE",t[t.HIGHLIGHT=8]="HIGHLIGHT",t[t.HIGHLIGHT_ACTIVE=16]="HIGHLIGHT_ACTIVE",t[t.REMOVE=32]="REMOVE",t[t.TRANSFORM_CHANGED=64]="TRANSFORM_CHANGED",t[t.ACTIVE=18]="ACTIVE";}(p$r||(p$r={}));class b$f{constructor(t){this.localTransform=t.getField("localTransform",b$K),this.globalTransform=t.getField("globalTransform",b$K),this.modelOrigin=t.getField("modelOrigin",T$v),this.model=t.getField("model",l$1a),this.modelNormal=t.getField("modelNormal",l$1a),this.modelScaleFactors=t.getField("modelScaleFactors",u$13),this.boundingSphere=t.getField("boundingSphere",h$W),this.color=t.getField("color",c$18),this.featureAttribute=t.getField("featureAttribute",c$18),this.state=t.getField("state",d$14),this.lodLevel=t.getField("lodLevel",d$14);}}class A$c extends n$13{constructor(t,e){super(),this._capacity=0,this._size=0,this._next=0,this._layout=F$d(t),this._shaderTransformation=e;}get capacity(){return this._capacity}get size(){return this._size}get buffer(){return this._buffer.buffer}get view(){return this._view}addInstance(){this._size+1>this._capacity&&this.grow();const t=this.findSlot();return this._view.state.set(t,p$r.ALLOCATED),this._size++,this.emit("instance-added",{index:t}),t}removeInstance(t){const e=this._view.state;i$R(t>=0&&t<this._capacity&&e.get(t)&p$r.ALLOCATED,"invalid instance handle"),this.getStateFlag(t,p$r.ACTIVE)?this.setStateFlags(t,p$r.REMOVE):this.freeInstance(t),this.emit("instance-removed",{index:t});}freeInstance(t){const e=this._view.state;i$R(t>=0&&t<this._capacity&&e.get(t)&p$r.ALLOCATED,"invalid instance handle"),e.set(t,0),this._size--;}setLocalTransform(t,e,s=!0){this._view.localTransform.setMat(t,e),s&&this.updateModelTransform(t);}getLocalTransform(t,e){this._view.localTransform.getMat(t,e);}setGlobalTransform(t,e,s=!0){this._view.globalTransform.setMat(t,e),s&&this.updateModelTransform(t);}getGlobalTransform(t,e){this._view.globalTransform.getMat(t,e);}updateModelTransform(t){const a=this._view,o=w$k,l=I$d;a.localTransform.getMat(t,E$h),a.globalTransform.getMat(t,M$i);const h=e$V(M$i,M$i,E$h);o$S(o,h[12],h[13],h[14]),a.modelOrigin.setVec(t,o),a$19(l,h),a.model.setMat(t,l);const c=z$y(w$k,h);c.sort(),a.modelScaleFactors.set(t,0,c[1]),a.modelScaleFactors.set(t,1,c[2]),u$12(l,l),o$Z(l,l),a.modelNormal.setMat(t,l),this.setStateFlags(t,p$r.TRANSFORM_CHANGED),this.emit("instance-transform-changed",{index:t});}getModelTransform(t,e){const s=this._view;s.model.getMat(t,I$d),s.modelOrigin.getVec(t,w$k),e[0]=I$d[0],e[1]=I$d[1],e[2]=I$d[2],e[3]=0,e[4]=I$d[3],e[5]=I$d[4],e[6]=I$d[5],e[7]=0,e[8]=I$d[6],e[9]=I$d[7],e[10]=I$d[8],e[11]=0,e[12]=w$k[0],e[13]=w$k[1],e[14]=w$k[2],e[15]=1;}applyShaderTransformation(t,e){this._shaderTransformation&&this._shaderTransformation.applyTransform(this,t,e);}getCombinedModelTransform(t,e){return this.getModelTransform(t,e),this._shaderTransformation&&this._shaderTransformation.applyTransform(this,t,e),e}getCombinedLocalTransform(t,e){return this._view.localTransform.getMat(t,e),this._shaderTransformation&&this._shaderTransformation.applyTransform(this,t,e),e}getCombinedMaxScaleFactor(t){let e=this._view.modelScaleFactors.get(t,1);if(this._shaderTransformation){const s=this._shaderTransformation.scaleFactor(w$k,this,t);e*=Math.max(s[0],s[1],s[2]);}return e}getCombinedMedianScaleFactor(t){let e=this._view.modelScaleFactors.get(t,0);if(this._shaderTransformation){const s=this._shaderTransformation.scaleFactor(w$k,this,t);s.sort(),e*=s[1];}return e}getModel(t,e){this._view.model.getMat(t,e);}setFeatureAttribute(t,e){this._view.featureAttribute.setVec(t,e);}getFeatureAttribute(t,e){this._view.featureAttribute.getVec(t,e);}setColor(t,e){this._view.color.setVec(t,e);}getColor(t,e){this._view.color.getVec(t,e);}setVisible(t,e){e!==this.getVisible(t)&&(this.setStateFlag(t,p$r.VISIBLE,e),this.emit("instance-visibility-changed",{index:t}));}getVisible(t){return this.getStateFlag(t,p$r.VISIBLE)}setHighlight(t,e){e!==this.getHighlight(t)&&(this.setStateFlag(t,p$r.HIGHLIGHT,e),this.emit("instance-highlight-changed",{index:t}));}getHighlight(t){return this.getStateFlag(t,p$r.HIGHLIGHT)}getState(t){return this._view.state.get(t)}getLodLevel(t){return this._view.lodLevel.get(t)}countFlags(t){let e=0;for(let s=0;s<this._capacity;++s){this.getState(s)&t&&++e;}return e}setStateFlags(t,e){const s=this._view.state;e=s.get(t)|e,s.set(t,e);}clearStateFlags(t,e){const s=this._view.state;e=s.get(t)&~e,s.set(t,e);}setStateFlag(t,e,s){s?this.setStateFlags(t,e):this.clearStateFlags(t,e);}getStateFlag(t,e){return !!(this._view.state.get(t)&e)}grow(){const t=Math.max(S$j,Math.floor(this._capacity*L$d)),e=this._layout.createBuffer(t);if(this._buffer){const t=new Uint8Array(this._buffer.buffer);new Uint8Array(e.buffer).set(t);}this._capacity=t,this._buffer=e,this._view=new b$f(this._buffer);}findSlot(){const t=this._view.state;let e=this._next;for(;t.get(e)&p$r.ALLOCATED;)e=(e+1)%this._capacity;return this._next=(e+1)%this._capacity,e}}const S$j=1024,L$d=2,w$k=n$11(),I$d=e$Z(),E$h=e$P(),M$i=e$P();

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class n$v extends p$z{constructor(e,r){super((t=>C$s(this._instanceData.view.boundingSphere.getVec(t,this._tmpSphere))),{maximumDepth:25}),this._tmpSphere=_$o(),this._tmpMat4=e$P(),this._instanceData=e,this._boundingSphere=r;}addInstance(t){const s=this._instanceData.view.boundingSphere,i=this._instanceData.getCombinedModelTransform(t,this._tmpMat4);I$x(this._tmpSphere,this._boundingSphere.center,i),this._tmpSphere[3]=this._boundingSphere.radius*d$T(i),s.setVec(t,this._tmpSphere),this.add([t]);}removeInstance(t){this.remove([t]);}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class t$v{constructor(t,s){this.thresholdScale=1,this._camera=new J$g,this._worldSpaceRadius=t,this._thresholds=s.map((e=>e));}updateCamera(e){this._camera.copyFrom(e);}selectLevel(e,t){const s=this._camera.computeScreenPixelSizeAt(e),r=this._worldSpaceRadius*t/s,a=this._thresholds;let h=-1;for(let o=0;o<a.length;++o)r>=a[o]*this.thresholdScale&&(h=o);return h}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class a$o{constructor(r,i){const a=r.renderContext.rctx,l=i.geometry,m=i.material;this.materialRep=r.materialRep,m.setParameterValues({instancedDoublePrecision:!0});const u=m.createBufferWriter(),d=u.vertexBufferLayout,f=u.elementCount(l),c=u.allocate(f);u.write({},l,c,0),this.geometry=l,this.material=m,this.glMaterials=m$_(m,this.materialRep),this.vertexBufferLayout=d,this.vbo=h$O.createVertex(a,35044,c.buffer),this.vao=new f$M(a,o$X,{geometry:t$16(d)},{geometry:this.vbo}),this.vertexCount=f;}destroy(){p$1b(this.material,this.materialRep),this.vbo.dispose(),this.vao.dispose();}get boundingInfo(){return this.geometry.boundingInfo}get triangleCount(){return this.vertexCount/3}intersect(e,t,s,i,o,n){const a=this.geometry.id,l=o.toString();this.material.intersect(this.geometry,null,e.transform.transform,e,s,i,((s,i,m,u)=>{if(s>=0){if(null!=t&&!t(e.rayBeginPoint,e.rayEndPoint,s))return;const d={type:"external",metadata:{layerUid:n.layerUid,graphicUid:n.graphicUid(o)}};if((null==e.results.min.drapedLayerOrder||u>=e.results.min.drapedLayerOrder)&&(null==e.results.min.dist||s<e.results.min.dist)&&(e.results.min.set(d,l,s,i,e.transform.transform,u,null,a,m),e.results.min.intersector="LodRenderer"),0!==e.options.store&&(null==e.results.max.drapedLayerOrder||u>=e.results.max.drapedLayerOrder)&&(null==e.results.max.dist||s>e.results.max.dist)&&(e.results.max.set(d,l,s,i,e.transform.transform,u,null,a,m),e.results.min.intersector="LodRenderer"),2===e.options.store){const t=new j$y(e.results.min.ray);t.set(d,l,s,i,e.transform.transform,u,null,a,m),t.intersector="LodRenderer",e.results.all.push(t);}}}));}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class c$t{constructor(n,o){this.minScreenSpaceRadius=n,this.components=o;}static async create(n,o,t){const e=await Promise.all(o.components.map((o=>n.schedule((()=>new a$o(n,o)),t))));return new c$t(o.minScreenSpaceRadius,e)}destroy(){this.components.forEach((n=>{n.destroy();}));}intersect(n,o,t,e,i,s){this.components.forEach((r=>{r.intersect(n,o,t,e,i,s);}));}get boundingBox(){if(!this._boundingBox){const o=B$n();this.components.forEach((t=>{r$Y(t.boundingInfo)&&(h$V(o,t.boundingInfo.bbMin),h$V(o,t.boundingInfo.bbMax));})),this._boundingBox=o;}return this._boundingBox}get boundingSphere(){if(!this._boundingSphere){const n=this.boundingBox,t=n$11();p$1a(n,t),this._boundingSphere={center:t,radius:.5*g$_(n)};}return this._boundingSphere}get triangleCount(){return this.components.reduce(((n,o)=>n+o.triangleCount),0)}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class t$u{constructor(t,r,i){this._elementSize=r,this._buffer=h$O.createVertex(t,35044),this.resize(i);}destroy(){this._buffer.dispose();}get elementSize(){return this._elementSize}get capacity(){return this._capacity}get array(){return this._array}get buffer(){return this._buffer}get memoryUsage(){return {cpu:this._capacity*this._elementSize,gpu:this._capacity*this._elementSize}}copyRange(e,t,r,i=0){const a=new Uint8Array(this.array,e*this.elementSize,(t-e)*this.elementSize);new Uint8Array(r.array,i*this.elementSize).set(a);}transferAll(){this._buffer.setData(this._array);}transferRange(e,t){const r=e*this._elementSize,i=t*this._elementSize;this._buffer.setSubData(this._array,r,r,i);}resize(e){const t=e*this._elementSize,r=new ArrayBuffer(t);this._array&&(e>=this._capacity?new Uint8Array(r).set(new Uint8Array(this._array)):new Uint8Array(r).set(new Uint8Array(this._array).subarray(0,e*this._elementSize))),this._array=r,this._buffer.setData(t),this._capacity=e;}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class n$u{constructor(s){this.modelOriginHi=s.getField("modelOriginHi",i$14),this.modelOriginLo=s.getField("modelOriginLo",i$14),this.model=s.getField("model",l$1a),this.modelNormal=s.getField("modelNormal",l$1a),this.color=s.getField("instanceColor",c$18),this.featureAttribute=s.getField("instanceFeatureAttribute",c$18);}}class r$t{constructor(t,i){this._headIndex=0,this._tailIndex=0,this._captureFirstIndex=!0,this._updating=!1,this._prevHeadIndex=0,this._resized=!1,this._rctx=t,this._instanceBufferLayout=i,this._elementSize=i.stride,this._capacity=1;}destroy(){this._buffer&&this._buffer.destroy();}get buffer(){return this._buffer.buffer}get view(){return this._view}get capacity(){return this._capacity}get size(){const t=this._headIndex,i=this._tailIndex;return t>=i?t-i:t+this._capacity-i}get isEmpty(){return this._headIndex===this._tailIndex}get isFull(){return this._tailIndex===(this._headIndex+1)%this._capacity}get headIndex(){return this._headIndex}get tailIndex(){return this._tailIndex}get firstIndex(){return this._firstIndex}get memoryUsage(){return this._buffer?this._buffer.memoryUsage:{cpu:0,gpu:0}}reset(){this._headIndex=0,this._tailIndex=0,this._firstIndex=null;}startUpdateCylce(){this._captureFirstIndex=!0;}beginUpdate(){i$R(!this._updating,"already updating"),this._updating=!0,this._prevHeadIndex=this._headIndex;}endUpdate(){i$R(this._updating,"not updating"),this.size<_$d*this.capacity&&this.shrink(),this._resized?(this._buffer.transferAll(),this._resized=!1):this.transferRange(this._prevHeadIndex,this._headIndex),this._updating=!1;}allocateHead(){i$R(this._updating,"not updating"),this.isFull&&this.grow();const t=this.headIndex;return this._captureFirstIndex&&(this._firstIndex=t,this._captureFirstIndex=!1),this.incrementHead(),i$R(this._headIndex!==this._tailIndex,"invalid pointers"),t}freeTail(){i$R(this._updating,"not updating"),i$R(this.size>0,"invalid size");const t=this._tailIndex===this._firstIndex;this.incrementTail(),t&&(this._firstIndex=this._tailIndex);}grow(){const t=Math.max(h$o,Math.floor(this._capacity*d$n));this.resize(t);}shrink(){const t=Math.max(h$o,Math.floor(this._capacity*c$s));this.resize(t);}resize(t){if(i$R(this._updating,"not updating"),t===this._capacity)return;const i=new t$u(this._rctx,this._elementSize,t);if(this._buffer){this._firstIndex&&(this._firstIndex=(this._firstIndex+this._capacity-this._tailIndex)%this._capacity);const t=this.size,e=this.compactInstances(i);i$R(e===t,"invalid compaction"),this._buffer.destroy(),this._tailIndex=0,this._headIndex=e,this._prevHeadIndex=0;}this._resized=!0,this._capacity=t,this._buffer=i,this._view=new n$u(this._instanceBufferLayout.createView(this._buffer.array));}compactInstances(t){const i=this._headIndex,e=this._tailIndex;return e<i?(this._buffer.copyRange(e,i,t),i-e):e>i?(this._buffer.copyRange(e,this._capacity,t),i>0&&this._buffer.copyRange(0,i,t,this._capacity-e),i+(this._capacity-e)):0}incrementHead(t=1){this._headIndex=(this._headIndex+t)%this._capacity;}incrementTail(t=1){this._tailIndex=(this._tailIndex+t)%this._capacity;}transferRange(t,i){t<i?this._buffer.transferRange(t,i):t>i&&(i>0&&this._buffer.transferRange(0,i),this._buffer.transferRange(t,this._capacity));}}const h$o=1024,d$n=2,_$d=.3,c$s=.5;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
let E$g=function(e){const t=e.baseBoundingSphere.radius,s=e.levels.map((e=>e.minScreenSpaceRadius));return new t$v(t,s)};class L$c{constructor(e,t,a,n){this.type="Lod",this.isGround=!1,this._inverseViewport=n$19(),this._levels=[],this._defaultRenderInstanceData=[],this._highlightRenderInstanceData=[],this._instanceIndex=0,this._slicePlane=!1,this._enableLevelSelection=!0,this._lastCamera=new J$g,this._updateCyclesWithStaticCamera=-1,this._needFullCycle=!1,this.canRender=!0,this._symbol=e,this._optionalFields=t,this._metadata=a,this._instanceBufferLayout=y$S.getInstanceBufferLayout({instancedDoublePrecision:!0,instanced:t}),this._glInstanceBufferLayout=t$16(this._instanceBufferLayout,1),this._instanceData=new A$c(this._optionalFields,n),this._instanceData.on("instance-added",(()=>{this.requestUpdateCycle();})),this._instanceData.on("instance-removed",(()=>{this.requestUpdateCycle();})),this._instanceData.on("instance-transform-changed",(e=>{this.requestUpdateCycle(),this._metadata.notifyGraphicGeometryChanged(e.index);})),this._instanceData.on("instance-visibility-changed",(e=>{this.requestUpdateCycle(!0),this._metadata.notifyGraphicVisibilityChanged(e.index);})),this._instanceData.on("instance-highlight-changed",(()=>{this.requestUpdateCycle(!0);})),this._enableLevelSelection=this._symbol.levels.length>1;}get levels(){return this._levels}get baseBoundingBox(){return this._levels[this._levels.length-1].boundingBox}get baseBoundingSphere(){return this._levels[this._levels.length-1].boundingSphere}get baseMaterial(){return this._levels[this._levels.length-1].components[0].material}get slicePlane(){return this._slicePlane}set slicePlane(e){this._slicePlane=e;}get intersectionHandlerId(){return this._metadata.layerUid}get instanceData(){return this._instanceData}get memoryUsage(){const e={cpu:0,gpu:0};return this._defaultRenderInstanceData.forEach((t=>{const s=t.memoryUsage;e.cpu+=s.cpu,e.gpu+=s.gpu;})),this._highlightRenderInstanceData.forEach((t=>{const s=t.memoryUsage;e.cpu+=s.cpu,e.gpu+=s.gpu;})),e}get renderStats(){const e=this._instanceData.size,t=[];return this._levels.forEach(((e,s)=>{const a=this._defaultRenderInstanceData[s],n=this._highlightRenderInstanceData[s],i=a.size+n.size,r=e.triangleCount;t.push({renderedInstances:i,renderedTriangles:i*r,trianglesPerInstance:r});})),{totalInstances:e,renderedInstances:t.reduce(((e,t)=>e+t.renderedInstances),0),renderedTriangles:t.reduce(((e,t)=>e+t.renderedTriangles),0),levels:t}}async initializeRenderContext(t,s){this._context=t;const a=t.renderContext.rctx;this._levels=await s$12(this._symbol.levels.map((e=>(this._defaultRenderInstanceData.push(new r$t(a,this._instanceBufferLayout)),this._highlightRenderInstanceData.push(new r$t(a,this._instanceBufferLayout)),c$t.create(t,e,s))))),this._levelSelector=E$g(this);}uninitializeRenderContext(){this.invalidateOctree(),this._levels.forEach((e=>e.destroy())),this._defaultRenderInstanceData.forEach((e=>e.destroy())),this._highlightRenderInstanceData.forEach((e=>e.destroy()));}get slots(){return [4,6]}get needsHighlight(){return this._highlightRenderInstanceData.reduce(((e,t)=>e+t.size),0)>0}prepareRender(e,t){if(T$k.LOD_INSTANCE_RENDERER_DISABLE_UPDATES)return;if(this._enableLevelSelection){const e=t.equals(this._lastCamera);this._lastCamera.copyFrom(t),e||this.requestUpdateCycle();}const s=this._needFullCycle?this._instanceData.size:2e3;this._needFullCycle=!1,this.updateInstances(t,s),this.needsUpdates&&this._context.requestRender();}render(e){const t=e.rctx,s=4===e.slot?3:6===e.slot?5:null;if(!s)return;if(!this.baseMaterial.isVisible()||!this.baseMaterial.isVisibleInPass(e.pass))return !1;const a=e.camera;this._inverseViewport[0]=1/a.fullViewport[2],this._inverseViewport[1]=1/a.fullViewport[3];const n={slot:s,origin:[0,0,0],camera:a,inverseViewport:this._inverseViewport,shadowMap:e.shadowMap,shadowMappingEnabled:e.shadowMap.enabled,ssaoHelper:e.ssaoHelper,ssaoEnabled:e.ssaoHelper.enabled,screenToWorldRatio:null,screenToWorldRatioGlobalWM:null,slicePlane:e.sliceHelper&&e.sliceHelper.plane,hudVisibilityTexture:e.offscreenRenderingHelper?e.offscreenRenderingHelper.hudVisibilityTexture:null,highlightDepthTexture:e.offscreenRenderingHelper?e.offscreenRenderingHelper.depthTexture:null,hasOccludees:!1,linearDepthTexture:null,lastFrameColorTexture:null,reprojectionMat:null,ssrEnabled:!1,lighting:e.scenelightingData,transparencyPassType:e.transparencyPassType,terrainLinearDepthTexture:e.multipassTerrainParams.terrainLinearDepthTexture,geometryLinearDepthTexture:e.multipassGeometryParams.geometryLinearDepthTexture,multipassTerrainEnabled:e.multipassTerrainParams.multipassTerrainEnabled,cullAboveGround:e.multipassTerrainParams.cullAboveGround,multipassGeometryEnabled:e.multipassGeometryParams.multipassGeometryEnabled,highlightColorTexture:null};t.bindVAO();const i=5!==e.pass&&7!==e.pass,r=6!==e.pass;return i&&this._renderComponents(e,s,n,this._defaultRenderInstanceData),r&&this._renderComponents(e,s,n,this._highlightRenderInstanceData),!0}intersect(e,t,s,n){if(!this.baseMaterial.isVisible())return;const l=n$11();c$V(l,n,s);const o=a=>{this._instanceData.getCombinedModelTransform(a,V$8),e.transform.set(V$8),I$x(w$j,s,e.transform.inverse),I$x(H$6,n,e.transform.inverse);const r=this._instanceData.getState(a),l=this._instanceData.getLodLevel(a);i$R(r&p$r.ACTIVE,"invalid instance state"),i$R(l>=0&&l<this._levels.length,"invaid lod level"),this._levels[l].intersect(e,t,w$j,H$6,a,this._metadata);};this.baseMaterial.params.verticalOffset?this.octree.forEach(o):this.octree.forEachAlongRay(s,l,o);}queryDepthRange(e){return this.queryDepthRangeOctree(e)}notifyShaderTransformationChanged(){this.invalidateOctree();}requestUpdateCycle(e=!1){this._updateCyclesWithStaticCamera=-1,e&&(this._needFullCycle=!0),this.needsUpdates&&this._context.requestRender();}get needsUpdates(){return this._instanceData.size>0&&this._updateCyclesWithStaticCamera<1}get octree(){return this._octree||(this._octree=this.buildOctree()),this._octree}invalidateOctree(){this._octree&&(this._octree.destroy(),this._octree=null);}buildOctree(){const e=new n$v(this._instanceData,this.baseBoundingSphere),t=this._instanceData,s=t.view?t.view.state:null;for(let a=0;a<this._instanceData.capacity;++a){s.get(a)&p$r.ACTIVE&&e.addInstance(a);}return e}queryDepthRangeOctree(e){const t=e.eye,s=e.viewForward,i=this.octree.findClosest(s,1,e.frustum),r=this.octree.findClosest(s,-1,e.frustum);if(null!=i&&null!=r){this._instanceData.view.boundingSphere.getVec(i,U$7),c$V(U$7,U$7,t);const l=z$u(U$7,s)-U$7[3];this._instanceData.view.boundingSphere.getVec(r,U$7),c$V(U$7,U$7,t);const o=z$u(U$7,s)+U$7[3];return {near:Math.max(e.near,l),far:Math.min(e.far,o)}}return {near:1/0,far:-1/0}}startUpdateCycle(){this._updateCyclesWithStaticCamera++,this._defaultRenderInstanceData.forEach((e=>{e.startUpdateCylce();})),this._highlightRenderInstanceData.forEach((e=>{e.startUpdateCylce();})),this.needsUpdates&&this._context.requestRender();}updateInstances(e,t){const s=this._enableLevelSelection,a=this._levelSelector;a.updateCamera(e),this._defaultRenderInstanceData.forEach((e=>{e.beginUpdate();})),this._highlightRenderInstanceData.forEach((e=>{e.beginUpdate();}));const n=this._instanceData,i=this._instanceData.view,r=n.size,l=n.capacity;let o=this._instanceIndex;t=Math.min(r,t);for(let c=0;c<t;++c){0===o&&this.startUpdateCycle();const e=i.state.get(o);let r=0;if(!(e&p$r.ALLOCATED)){o=(o+1)%l,t++;continue}const c=i.lodLevel.get(o);if(e&p$r.DEFAULT_ACTIVE&&this._defaultRenderInstanceData[c].freeTail(),e&p$r.HIGHLIGHT_ACTIVE&&this._highlightRenderInstanceData[c].freeTail(),e&p$r.REMOVE)n.freeInstance(o);else if(e&p$r.VISIBLE){let t=0;s&&(i.modelOrigin.getVec(o,S$i),t=a.selectLevel(S$i,n.getCombinedMedianScaleFactor(o))),r=e&~(p$r.ACTIVE|p$r.TRANSFORM_CHANGED),t>=0&&(e&p$r.HIGHLIGHT?(x$o(this._highlightRenderInstanceData[t],i,o),r|=p$r.HIGHLIGHT_ACTIVE):(x$o(this._defaultRenderInstanceData[t],i,o),r|=p$r.DEFAULT_ACTIVE)),i.state.set(o,r),i.lodLevel.set(o,t);}else r=e&~(p$r.ACTIVE|p$r.TRANSFORM_CHANGED),i.state.set(o,r);if(this._octree){const t=!!(e&p$r.ACTIVE),s=!!(r&p$r.ACTIVE);!t&&s?this._octree.addInstance(o):t&&!s?this._octree.removeInstance(o):t&&s&&e&p$r.TRANSFORM_CHANGED&&(this._octree.removeInstance(o),this._octree.addInstance(o));}o=(o+1)%l;}this._instanceIndex=o,this._defaultRenderInstanceData.forEach((e=>{e.endUpdate();})),this._highlightRenderInstanceData.forEach((e=>{e.endUpdate();}));}_renderComponents(e,t,s,a){this.levels.forEach(((n,i)=>{n.components.forEach((n=>{this._renderComponent(e,t,s,a[i],n,i);}));}));}_renderComponent(e,t,s,a,n,i){const r=n.glMaterials.get(e.pass);if(!r||!r.beginSlot(t)||0===a.size)return;const l=e.rctx,c=l.capabilities.instancing;r.ensureParameters(s);const d=r.technique,m=d.program,_=r.getPipelineState(t);l.setPipelineState(_),l.useProgram(m),r.bind(s),l.bindVAO(n.vao),d.ensureAttributeLocations(n.vao),e.isHighlightPass&&g$V(m,s),d.bindDraw(s,{},{}),T$k.LOD_INSTANCE_RENDERER_COLORIZE_BY_LEVEL&&0===e.pass&&(m.setUniform4fv("externalColor",O$d[Math.min(i,O$d.length-1)]),m.setUniform1i("colorMixMode",P$A.replace));const f=a.capacity,g=a.headIndex,I=a.tailIndex,y=a.firstIndex,D=this._glInstanceBufferLayout,b=(e,t)=>{i$15(l,o$X,a.buffer,D,e),c.drawArraysInstanced(d.primitiveType,0,n.vertexCount,t-e),s$13(l,o$X,a.buffer,D);};n.material.params.transparent&&null!=y?g>I?(i$R(y>=I&&y<=g,"invalid firstIndex"),b(y,g),b(I,y)):g<I&&(y<=g?(i$R(y>=0&&y<=g,"invalid firstIndex"),b(y,g),b(I,f),b(0,y)):(i$R(y>=I&&y<=f,"invalid firstIndex"),b(y,f),b(0,g),b(I,y))):g>I?b(I,g):g<I&&(b(0,g),b(I,f)),l.bindVAO(null);}}function x$o(e,t,s){const a=e.allocateHead();A$b(t,s,e.view,a);}function A$b(e,t,s,a){b$L(e.modelOrigin,t,s.modelOriginHi,s.modelOriginLo,a),s.model.copyFrom(a,e.model,t),s.modelNormal.copyFrom(a,e.modelNormal,t),e.color&&s.color&&s.color.copyFrom(a,e.color,t),e.featureAttribute&&s.featureAttribute&&s.featureAttribute.copyFrom(a,e.featureAttribute,t);}const S$i=n$11(),U$7=n$1a(),V$8=e$P(),w$j=n$11(),H$6=n$11(),O$d=[[1,0,1,1],[0,0,1,1],[0,1,0,1],[1,1,0,1],[1,0,0,1]];

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class le$4 extends y$r{constructor(e,t,s,r){super(e,t,s,r),this._resources=null,this._optionalFields=new Array,this._instanceIndexToGraphicUid=new Map,this.hasLoadedPBRTextures=!1,this.ensureDrapedStatus(!1),this.hasLoadedPBRTextures=s.physicalBasedRenderingEnabled;}getCachedSize(){const[e,s,r]=r$Y(this._resources)?this._resources.symbolSize:[1,1,1];return {width:e,depth:s,height:r}}async doLoad(e){if(!this._drivenProperties.size){if(O$i(this.symbolLayer))throw new Error}const t=this.symbolLayer;if(this.isPrimitive){const s=t.resource?t.resource.primitive:d$10;this._resources=await this._createResourcesForPrimitive(s,e);}else this._resources=await this._createResourcesForUrl(t.resource.href,e);this.layerOpacityChanged(),this.slicePlaneEnabledChanged(),this.physicalBasedRenderingChanged(),this.complexity=this.computeComplexity();}get extentPadding(){return r$Y(this._resources)?this._resources.extentPadding:0}get isPrimitive(){return !(this.symbolLayer.resource&&this.symbolLayer.resource.href)}get lodRenderer(){return g$Y(this._resources,"lodRenderer")}setMaterialTransparencyParams(e,t=g$Y(this.symbolLayer,"material","color")){const r=this._getCombinedOpacity(t),i=r<1||this.needsDrivenTransparentPass;return e.transparent=i,e.opacity=r,e.cullFace=i?0:2,e}async _createResourcesForPrimitive(s,i){if(!n$N(s))throw new Error(`Unknown object symbol primitive: ${s}`);const a=this.symbolLayer,n=a$1c(s$14(s)),l=e$11(F$C(n)),c=e$11(t$1o(l,a)),h=s$P(c),d=!1,m=!1,u={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0,instanced:["transformation"],ambient:l$14,diffuse:l$14,slicePlaneEnabled:this._context.slicePlaneEnabled,sliceHighlightDisabled:!0,castShadows:this.symbolLayer.castShadows,offsetTransparentBackfaces:!this.symbolLayer.isPrimitive},y=u.usePBR;this.setMaterialTransparencyParams(u);const f=this.symbol;if("point-3d"===f.type&&f.verticalOffset){const{screenLength:e,minWorldLength:t,maxWorldLength:s}=f.verticalOffset;u.verticalOffset={screenLength:u$_(e),minWorldLength:t||0,maxWorldLength:null!=s?s:1/0},u.castShadows=!1;}if(this._context.screenSizePerspectiveEnabled&&(u.screenSizePerspective=this._context.sharedResources.screenSizePerspectiveSettings),this._drivenProperties.color)u.externalColor=l$13;else {const s=r$Y(a.material)&&a.material.color,r=r$Y(s)?o$W.toUnitRGBA(s):l$13;u.externalColor=r;}this._fastUpdates=D$c(this._context.renderer,this._fastVisualVariableConvertOptions(n,c,l,n$1p)),this._fastUpdates.enabled?(Object.assign(u,this._fastUpdates.materialParameters),u.instanced.push("featureAttribute"),this._optionalFields.push("featureAttribute")):this._hasPerInstanceColor()&&(u.instanced.push("color"),this._optionalFields.push("color"));const _=new y$S(u),P=t$I(s,_);if(!P)throw new Error(`Unknown object symbol primitive: ${s}`);const v=e$A(P).map((e=>({opacity:1,transparent:e.params.transparent}))),x=this._createStageResources(P,y);return {lodResources:P,lodRenderer:await this._createLodRenderer(P,i),stageResources:x,symbolSize:c,extentPadding:h,isEsriSymbolResource:d,isWosr:m,originalMaterialParameters:v,physicalBasedRenderingEnabled:y,resourceBoundingBox:n,resourceSize:l,dispose:n$1p,pivotOffset:n$1p}}async _createResourcesForUrl(e,t){const i=["transformation"],a={materialParamsMixin:{instanced:i,slicePlaneEnabled:this._context.slicePlaneEnabled,castShadows:this.symbolLayer.castShadows},streamDataRequester:this._context.streamDataRequester,cache:this._context.sharedResources.objectResourceCache};this._fastUpdates=D$c(this._context.renderer,this._fastVisualVariableConvertOptions(n$1p,n$1p,n$1p,n$1p)),this._fastUpdates.enabled?(Object.assign(a.materialParamsMixin,this._fastUpdates.materialParameters),i.push("featureAttribute"),this._optionalFields.push("featureAttribute")):this._hasPerInstanceColor()&&(i.push("color"),this._optionalFields.push("color"));const n=this.symbol;if("point-3d"===n.type&&n.verticalOffset){const{screenLength:e,minWorldLength:t,maxWorldLength:s}=n.verticalOffset;a.materialParamsMixin.verticalOffset={screenLength:u$_(e),minWorldLength:t||0,maxWorldLength:null!=s?s:1/0},a.materialParamsMixin.castShadows=!1;}a.signal=t,a.usePBR=this._context.physicalBasedRenderingEnabled;const l=a.usePBR,c=await $$l(e,a),h=c.isEsriSymbolResource,d=c.isWosr,m=c.remove,u=s$q(c.lods);o$q(u),u.levels.sort(((e,t)=>e.minScreenSpaceRadius-t.minScreenSpaceRadius)),u.levels[0].minScreenSpaceRadius=Math.min(2,u.levels[0].minScreenSpaceRadius);const y=this._context,f=this.symbolLayer.material,_=this._getExternalColorParameters(f),b=g$Y(this.symbolLayer,"material","color"),P=this._getCombinedOpacity(b,{hasIntrinsicColor:!0}),v=this.needsDrivenTransparentPass,x=e$A(u),R=e$A(u).map((e=>({opacity:e.params.opacity||1,transparent:e.params.transparent})));x.forEach((e=>{const t=e.params;e.setParameterValues(_);const s=t.opacity*P,r=s<1||v||t.transparent;e.setParameterValues({opacity:s,transparent:r}),y.screenSizePerspectiveEnabled&&e.setParameterValues({screenSizePerspective:y.sharedResources.screenSizePerspectiveSettings});}));const L=c.referenceBoundingBox,S=e$11(F$C(L)),C=e$11(u.levels[0].pivotOffset),E=e$11(t$1o(S,this.symbolLayer)),w=s$P(E);I$f(this._fastUpdates,this._context.renderer,this._fastVisualVariableConvertOptions(L,E,S,C))&&x.forEach((e=>e.setParameterValues(this._fastUpdates.materialParameters)));const j=this._createStageResources(u,l);return {lodResources:u,lodRenderer:await this._createLodRenderer(u,t),stageResources:j,symbolSize:E,extentPadding:w,isEsriSymbolResource:h,isWosr:d,originalMaterialParameters:R,physicalBasedRenderingEnabled:l,resourceBoundingBox:L,resourceSize:S,dispose:m,pivotOffset:C}}_createStageResources(e,t){const s=this._context.stage,r=e$A(e);t!==this._context.physicalBasedRenderingEnabled&&this.physicalBasedRenderingChanged(),s.addMany(r);const i=n$M(e);s.addMany(i);const a=t$G(e);return s.addMany(a),{materials:r,textures:i,geometries:a}}async _createLodRenderer(e,t){const s=this._context.stage,r={layerUid:this._context.layer.uid,graphicUid:e=>this._instanceIndexToGraphicUid.get(e),notifyGraphicGeometryChanged:e=>this._context.notifyGraphicGeometryChanged(this._instanceIndexToGraphicUid.get(e)),notifyGraphicVisibilityChanged:e=>this._context.notifyGraphicVisibilityChanged(this._instanceIndexToGraphicUid.get(e))},i=this._fastUpdates.enabled?{applyTransform:(e,t,s)=>{e.getFeatureAttribute(t,pe$3),n$18(s,$$9(this._fastUpdates.materialParameters,pe$3,s));},scaleFactor:(e,t,s)=>(t.getFeatureAttribute(s,pe$3),_$e(e,this._fastUpdates.materialParameters,pe$3))}:null,a=new L$c(e,this._optionalFields,r,i);return a.slicePlane=this._context.slicePlaneEnabled,await s.addRenderPlugin(a.slots,a,t),a}_getExternalColorParameters(s){const r={};return this._drivenProperties.color?r.externalColor=l$13:r$Y(s)&&r$Y(s.color)?r.externalColor=o$W.toUnitRGBA(s.color):(r.externalColor=l$13,r.colorMixMode="ignore"),r}destroy(){super.destroy();const e=this._context.stage;if(r$Y(this._resources)){e.removeRenderPlugin(this._resources.lodRenderer);const s=this._resources.stageResources;e.removeMany(s.materials),e.removeMany(s.textures),e.removeMany(s.geometries),r$Y(this._resources.dispose)&&this._resources.dispose();}this._resources=null;}createGraphics3DGraphic(e){const t=e.graphic;if(!this._validateGeometry(t.geometry))return null;const s=d$u(t.geometry);if(t$17(s))return this.logger.warn(`unsupported geometry type for icon symbol: ${t.geometry.type}`),null;const r=this.setGraphicElevationContext(t,new h$s),a=e.renderingInfo;return this._createAs3DShape(t,s,a,r,t.uid)}notifyDestroyGraphicLayer(e){this._instanceIndexToGraphicUid.delete(e.instanceIndex);}graphicLayerToGraphicId(){return 0}layerOpacityChanged(){if(t$17(this._resources))return !0;const e=this._drivenProperties.opacity,t=!this.isPrimitive,r=this._resources.stageResources.materials,a=this._resources.originalMaterialParameters;for(let i=0;i<r.length;i++){const o=r[i],n=g$Y(this.symbolLayer,"material","color"),l=a[i],c=this._getCombinedOpacity(n,{hasIntrinsicColor:t})*l.opacity,h=c<1||e||l.transparent;o.setParameterValues({opacity:c,transparent:h}),this.isPrimitive&&o.setParameterValues({cullFace:h?0:2});}return !0}layerElevationInfoChanged(e,t){return this.updateGraphics3DGraphicElevationInfo(e,t,g$A)}slicePlaneEnabledChanged(){if(t$17(this._resources))return !0;this._resources.lodRenderer.slicePlane=this._context.slicePlaneEnabled;for(const e of this._resources.stageResources.materials)e.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled});return !0}physicalBasedRenderingChanged(){if(t$17(this._resources))return !0;const{stageResources:e,isWosr:t}=this._resources;for(const s of e.materials)this.isPrimitive?s.setParameterValues({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}):t||s.setParameterValues({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!1});return !1!==this.hasLoadedPBRTextures||!0!==this._context.physicalBasedRenderingEnabled||(this.hasLoadedPBRTextures=!0,!1)}pixelRatioChanged(){return !0}applyRendererDiff(e,t){if(t$17(this._resources))return !0;const{stageResources:{materials:s},lodRenderer:r,resourceBoundingBox:a,symbolSize:o,resourceSize:n,pivotOffset:l}=this._resources;for(const i in e.diff)switch(i){case"visualVariables":if(!I$f(this._fastUpdates,t,this._fastVisualVariableConvertOptions(a,o,n,l)))return !1;for(const e of s)e.setParameterValues(this._fastUpdates.materialParameters);r.notifyShaderTransformationChanged();break;default:return !1}return !0}computeComplexity(){if(t$17(this._resources))return super.computeComplexity();return {primitivesPerFeature:r$G(this._resources.lodResources.levels[0]).reduce(((e,t)=>e+t.indices.get("position").length),0)/3,primitivesPerCoordinate:0,drawCallsPerFeature:0,estimated:!1,memory:m$x(this.symbol,this.symbolLayer)}}hasLodRenderer(){return r$Y(this._resources)}_createAs3DShape(e,s,r,a,o){if(!this.hasLodRenderer()||t$17(this._resources))return null;const n=this.getFastUpdateAttrValues(e),l=!this._fastUpdates.enabled&&this._hasPerInstanceColor()?B$c(r.color,r.opacity):null,c=this._context.clippingExtent;if(Rn(s,ce$4,this._context.elevationProvider.spatialReference),r$Y(c)&&!E$y(c,ce$4))return null;const h=this._requiresTerrainElevation(a),d=this._computeGlobalTransform(s,a,de$2,h?me$1:null),p=this._computeLocalTransform(this._resources,this.symbolLayer,r,he$4),m=this._resources.lodRenderer.instanceData,u=m.addInstance();this._instanceIndexToGraphicUid.set(u,o),m.setLocalTransform(u,p,!1),m.setGlobalTransform(u,d),n&&m.setFeatureAttribute(u,n),l&&m.setColor(u,l);const y=new u$o(this,u,p$E,a);return h&&(y.alignedSampledElevation=me$1.sampledElevation),y.needsElevationUpdates=g$A(a.mode),g$y(y,s,this._context.elevationProvider),y}_computeGlobalTransform(e,t,s,r){const i=m$A(e,this._context.elevationProvider,t,this._context.renderCoordsHelper,r);return ce$4[0]=e.x,ce$4[1]=e.y,ce$4[2]=i,Sn(e.spatialReference,ce$4,s,this._context.renderCoordsHelper.spatialReference),s}_computeLocalTransform(e,t,s,r){return r$$(r),this._applyObjectRotation(s,!1,r),this._applyObjectRotation(t,!0,r),this._applyObjectScale(e,s,r),this._applyAnchor(e,t,r),r}_applyObjectScale(e,t,s){if(this._fastUpdates.enabled&&this._fastUpdates.requiresShaderTransformation)return;const r=this._drivenProperties.size&&t.size?t.size:e.symbolSize,i=I$l(r,e.symbolSize,e.resourceSize,this._context.renderCoordsHelper.unitInMeters);1===i[0]&&1===i[1]&&1===i[2]||i$12(s,s,i);}prepareSymbolLayerPatch(e){if("partial"!==e.diff.type)return;const t=e.diff.diff;this._preparePatchTransform(e,t),this._preparePatchColor(e,t);}updateGeometry(e,t){if(t$17(this._resources))return !0;const s=t&&d$u(t);if(t$17(s))return !1;const r=this.getGeometryElevationMode(t);if(e.elevationContext.mode!==r)return !1;const a=this._requiresTerrainElevation(e.elevationContext);return this._computeGlobalTransform(s,e.elevationContext,de$2,a?me$1:null),a&&(e.alignedSampledElevation=me$1.sampledElevation),this._resources.lodRenderer.instanceData.setGlobalTransform(e.instanceIndex,de$2,!0),g$y(e,s,this._context.elevationProvider),!0}_preparePatchTransform(e,t){if(!(t.heading||t.tilt||t.roll||t.width||t.height||t.depth||t.anchor||t.anchorPosition))return;if(t$17(this._resources))return;const s=(e,t,s)=>c$W(null!=e&&"complete"===e.type?e.newValue:t,s),r=s(t.heading,this.symbolLayer.heading,0),o=s(t.tilt,this.symbolLayer.tilt,0),n=s(t.roll,this.symbolLayer.roll,0),l=s(t.width,this.symbolLayer.width,void 0),c=s(t.height,this.symbolLayer.height,void 0),h=s(t.depth,this.symbolLayer.depth,void 0),d=s(t.anchor,this.symbolLayer.anchor,void 0),p=s(t.anchorPosition,this.symbolLayer.anchorPosition,void 0);delete t.heading,delete t.tilt,delete t.roll,delete t.width,delete t.height,delete t.depth,delete t.anchor,delete t.anchorPosition;const m={heading:r,tilt:o,roll:n,anchor:d,anchorPosition:p},u=this._resources;1===this.loadStatus&&e.symbolLayerStatePatches.push((()=>{u.symbolSize=e$11(t$1o(u.resourceSize,{width:l,height:c,depth:h,isPrimitive:this.symbolLayer.isPrimitive}));})),e.graphics3DGraphicPatches.push(((e,t)=>{const s=this._computeLocalTransform(u,m,t,he$4),r=e.instanceIndex;u.lodRenderer.instanceData.setLocalTransform(r,s,!0);}));}_preparePatchColor(s,r){if(!r.material||"partial"!==r.material.type)return;const a=r.material.diff;if(!a.color||"complete"!==a.color.type||null==a.color.newValue||null==a.color.oldValue)return;const o=a.color.newValue,n=r$Y(o)?o$W.toUnitRGBA(o):l$13;delete a.color;const l=this._resources;t$17(l)||s.graphics3DGraphicPatches.push((e=>{let t;this._hasPerInstanceColor()?(l.lodRenderer.instanceData.setColor(e.instanceIndex,n),t=this.setMaterialTransparencyParams({},o)):t=this.setMaterialTransparencyParams({externalColor:n},o);for(const s of l.stageResources.materials)s.setParameterValues(t);}));}_requiresTerrainElevation(e){return "absolute-height"!==e.mode}_applyObjectRotation(e,t,s){if(!(this._fastUpdates.enabled&&this._fastUpdates.requiresShaderTransformation&&t))return V$e(e.heading,e.tilt,e.roll,s)}_computeAnchor(e,s,r){const i=n$11();switch(r.anchor){case"center":r$Z(i,p$1a(e)),v$N(i,i);break;case"top":{const t=p$1a(e);o$S(i,-t[0],-t[1],-e[5]);break}case"bottom":{const t=p$1a(e);o$S(i,-t[0],-t[1],-e[2]);break}case"relative":{const t=p$1a(e),s=F$C(e),a=r.anchorPosition,o=a?t$_(a.x,a.y,a.z):f$R;e$18(i,s,o),u$S(i,i,t),v$N(i,i);break}case"origin":default:r$Y(s)?v$N(i,s):r$Z(i,f$R);}return i}_applyAnchor(e,t,s){if(this._fastUpdates.enabled&&this._fastUpdates.requiresShaderTransformation)return;const r=this._computeAnchor(e.resourceBoundingBox,e.pivotOffset,t);r&&c$_(s,s,r);}_hasPerInstanceColor(){return this._drivenProperties.color||this._drivenProperties.opacity}_fastVisualVariableConvertOptions(e,s,r,i){const a=r$Y(e)?e$11(F$C(e)):l$14,o=r$Y(e)?this._computeAnchor(e,i,this.symbolLayer):f$R,n=this._context.renderCoordsHelper.unitInMeters,l=I$l(r$Y(s)?s:void 0,s,r,n),c=t$_(this.symbolLayer.tilt||0,this.symbolLayer.roll||0,this.symbolLayer.heading||0);return {modelSize:a,symbolSize:r$Y(s)?s:l$14,unitInMeters:n,transformation:{anchor:o,scale:l,rotation:c}}}}const ce$4=n$11(),he$4=e$P(),de$2=e$P(),pe$3=n$1a(),me$1={verticalDistanceToGround:0,sampledElevation:0};

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
function n$t(t,n){return t[0]=n[0],t[1]=n[1],t[2]=n[2],t[3]=n[3],t}function a$n(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=1,t}function s$p(t,n,a,s,r){return t[0]=n,t[1]=a,t[2]=s,t[3]=r,t}function r$s(t,n){if(t===n){const a=n[1];t[1]=n[2],t[2]=a;}else t[0]=n[0],t[1]=n[2],t[2]=n[1],t[3]=n[3];return t}function u$n(t,n){const a=n[0],s=n[1],r=n[2],u=n[3];let o=a*u-r*s;return o?(o=1/o,t[0]=u*o,t[1]=-s*o,t[2]=-r*o,t[3]=a*o,t):null}function o$p(t,n){const a=n[0];return t[0]=n[3],t[1]=-n[1],t[2]=-n[2],t[3]=a,t}function c$r(t){return t[0]*t[3]-t[2]*t[1]}function e$n(t,n,a){const s=n[0],r=n[1],u=n[2],o=n[3],c=a[0],e=a[1],i=a[2],f=a[3];return t[0]=s*c+u*e,t[1]=r*c+o*e,t[2]=s*i+u*f,t[3]=r*i+o*f,t}function i$h(t,n,a){const s=n[0],r=n[1],u=n[2],o=n[3],c=Math.sin(a),e=Math.cos(a);return t[0]=s*e+u*c,t[1]=r*e+o*c,t[2]=s*-c+u*e,t[3]=r*-c+o*e,t}function f$n(t,n,a){const s=n[0],r=n[1],u=n[2],o=n[3],c=a[0],e=a[1];return t[0]=s*c,t[1]=r*c,t[2]=u*e,t[3]=o*e,t}function h$n(t,n){const a=Math.sin(n),s=Math.cos(n);return t[0]=s,t[1]=a,t[2]=-a,t[3]=s,t}function M$h(t,n){return t[0]=n[0],t[1]=0,t[2]=0,t[3]=n[1],t}function l$o(t){return "mat2("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+")"}function b$e(t){return Math.sqrt(t[0]**2+t[1]**2+t[2]**2+t[3]**2)}function m$o(t,n,a,s){return t[2]=s[2]/s[0],a[0]=s[0],a[1]=s[1],a[3]=s[3]-t[2]*a[1],[t,n,a]}function d$m(t,n,a){return t[0]=n[0]+a[0],t[1]=n[1]+a[1],t[2]=n[2]+a[2],t[3]=n[3]+a[3],t}function p$q(t,n,a){return t[0]=n[0]-a[0],t[1]=n[1]-a[1],t[2]=n[2]-a[2],t[3]=n[3]-a[3],t}function x$n(t,n){return t[0]===n[0]&&t[1]===n[1]&&t[2]===n[2]&&t[3]===n[3]}function y$l(n,a){const s=n[0],r=n[1],u=n[2],o=n[3],c=a[0],e=a[1],i=a[2],f=a[3];return Math.abs(s-c)<=a$1j*Math.max(1,Math.abs(s),Math.abs(c))&&Math.abs(r-e)<=a$1j*Math.max(1,Math.abs(r),Math.abs(e))&&Math.abs(u-i)<=a$1j*Math.max(1,Math.abs(u),Math.abs(i))&&Math.abs(o-f)<=a$1j*Math.max(1,Math.abs(o),Math.abs(f))}function j$j(t,n,a){return t[0]=n[0]*a,t[1]=n[1]*a,t[2]=n[2]*a,t[3]=n[3]*a,t}function q$9(t,n,a,s){return t[0]=n[0]+a[0]*s,t[1]=n[1]+a[1]*s,t[2]=n[2]+a[2]*s,t[3]=n[3]+a[3]*s,t}const _$c=e$n,v$j=p$q;Object.freeze({__proto__:null,copy:n$t,identity:a$n,set:s$p,transpose:r$s,invert:u$n,adjoint:o$p,determinant:c$r,multiply:e$n,rotate:i$h,scale:f$n,fromRotation:h$n,fromScaling:M$h,str:l$o,frob:b$e,LDU:m$o,add:d$m,subtract:p$q,exactEquals:x$n,equals:y$l,multiplyScalar:j$j,multiplyScalarAndAdd:q$9,mul:_$c,sub:v$j});

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class e$m extends u$U{constructor(t,e,r,i,n,s){super(t,e),this.path=r,this.geometrySR=i,this.upVectorAlignment=n,this.stencilWidth=s;}}function r$r(t){return "upVectorAlignment"in t}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
function e$l(){return [1,0,0,1]}function r$q(e){return [e[0],e[1],e[2],e[3]]}function n$s(e,r,n,t){return [e,r,n,t]}function t$t(e,r){return new Float64Array(e,r,4)}Object.freeze({__proto__:null,create:e$l,clone:r$q,fromValues:n$s,createView:t$t});

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
function w$i(){return {up:n$11(),right:n$11()}}function G$9(t,e,i){I$x(t.up,e.up,i),I$x(t.right,e.right,i);}function z$a(t,e,i){r$18(t,z$u(i,e.right),z$u(i,e.up));}class E$f{constructor(){this.pos=n$11(),this.posES=n$11(),this.posGS=n$11(),this.vRight=n$11(),this.vLeft=n$11(),this.frame=w$i(),this.rotationFrame=w$i(),this.rotationRight=n$19(),this.rotationAngle=0,this.miterStretch=e$l();}setFrameFromUpVector(t){r$Z(this.frame.up,t),u$S(lt$1,this.vLeft,this.vRight),j$F(lt$1,lt$1),d$O(at$1,this.frame.up,z$u(lt$1,this.frame.up)),c$V(ft$1,lt$1,at$1),j$F(ft$1,ft$1),_$n(this.frame.right,ft$1,this.frame.up);}computeRotationAxisAndAngleFromUpVector(){r$Z(this.rotationFrame.up,this.frame.up),r$Z(this.rotationFrame.right,this.frame.right),r$18(this.rotationRight,1,0),d$O(at$1,this.frame.up,z$u(this.frame.up,this.vLeft)),c$V(at$1,this.vLeft,at$1),v$N(at$1,at$1),j$F(at$1,at$1),d$O(lt$1,this.frame.up,z$u(this.frame.up,this.vRight)),c$V(lt$1,this.vRight,lt$1),j$F(lt$1,lt$1),_$n(ut$1,this.rotationFrame.up,this.vLeft);const r=s$T(z$u(ut$1,this.vRight));if(this.rotationAngle=r*(Math.PI-x$N(z$u(at$1,lt$1))),Math.abs(this.rotationAngle)>0){const t=g$10(Math.cos(.5*this.rotationAngle));s$p(this.miterStretch,t-1+1,0,0,1);}const o=Math.PI-this.rotationAngle;this.maxStretchDistance=Math.abs(Math.min(this.vLeftLength,this.vRightLength)/Math.cos(.5*o));}}class O$c{constructor(){this.vertices=[],this.vertexIndices=[],this.vertexNormals=[],this.poles=[],this.poleIndices=[],this.uvs=null,this.uvIndices=null;}addVertex(t,e){return this.vertices.push(r$1n(t)),this.vertexNormals.push(r$1n(e)),this.vertices.length-1}addUV(t){return this.uvs||(this.uvs=[],this.uvIndices=[]),this.uvs.push(t),this.uvs.length-1}addPole(t,e=null){return this.poles.push({position:r$1n(t),normal:e?r$1n(e):null}),this.poles.length-1}addSegment(t,e=null,i=null){this.vertexIndices.push(t.v0),this.vertexIndices.push(t.v1),e&&(this.uvIndices.push(e.v0),this.uvIndices.push(e.v1)),i&&(this.poleIndices.push(i.v0),this.poleIndices.push(i.v1));}get numSegments(){return this.vertexIndices.length/2}hasUV(){return null!=this.uvs}translate(t,e){for(const i of this.vertices)i[0]+=t,i[1]+=e;for(const i of this.poles)i.position[0]+=t,i.position[1]+=e;}static circle(t=20){const e=.5,i=new O$c,s={v0:0,v1:0};i.addPole(t$18(0,0));for(let h=0;h<t;++h){const s=2*h*Math.PI/t,r=Math.cos(s),o=Math.sin(s),n=t$18(r*e,o*e),a=t$18(r,o);i.addVertex(n,a),i.addUV(h/t);}i.addUV(1);for(let h=0;h<t-1;++h){const t={v0:h,v1:h+1},e=t;i.addSegment(t,e,s);}const r={v0:t-1,v1:0},o={v0:t-1,v1:t};return i.addSegment(r,o,s),i}static rect(){const t=1,e=1,i=new O$c,s=t$18(.5*-t,.5*-e),r=t$18(.5*t,.5*-e),o=t$18(.5*t,.5*e),h=t$18(.5*-t,.5*e),n=t$18(0,-1),a=t$18(1,0),l=t$18(0,1),u=t$18(-1,0);i.addUV(0),i.addUV(1),i.addPole(t$18(0,.5*e),l),i.addPole(t$18(0,.5*e)),i.addPole(t$18(0,.5*-e)),i.addPole(t$18(0,.5*-e),n);const p={v0:0,v1:1};return i.addVertex(s,n),i.addVertex(r,n),i.addSegment({v0:0,v1:1},p,{v0:3,v1:3}),i.addVertex(r,a),i.addVertex(o,a),i.addSegment({v0:2,v1:3},p,{v0:2,v1:1}),i.addVertex(o,l),i.addVertex(h,l),i.addSegment({v0:4,v1:5},p,{v0:0,v1:0}),i.addVertex(h,u),i.addVertex(s,u),i.addSegment({v0:6,v1:7},p,{v0:1,v1:2}),i}}class J$7{constructor(t){this.vertices=[],this.offset=n$11(),this.xform=e$P(),this.vertices=t;const e=Math.floor((t.length-1)/2);r$Z(this.offset,this.vertices[e].pos);for(const i of this.vertices)c$V(i.pos,i.pos,this.offset);c$_(this.xform,this.xform,this.offset),this.updatePathVertexInformation();}updatePathVertexInformation(){const t=this.vertices.length;let e=this.vertices[0];e.index=0,o$S(e.vLeft,0,0,0),e.vLeftLength=0,c$V(e.vRight,this.vertices[1].pos,e.pos),e.vRightLength=s$P(e.vRight),j$F(e.vRight,e.vRight);let i=e;for(let s=1;s<t;++s)e=this.vertices[s],e.index=s,r$Z(e.vLeft,i.vRight),e.vLeftLength=i.vRightLength,s<t-1?(c$V(e.vRight,this.vertices[s+1].pos,e.pos),e.vRightLength=s$P(e.vRight),j$F(e.vRight,e.vRight)):(r$Z(e.vRight,e.vLeft),e.vRightLength=e.vLeftLength),i=e;}}function q$8(t,e){let i=null;const s=t.vertices.length,r=.99619469809,o=n$11(),h=n$11(),n=n$11(),a=n$11(),l=n$11(),u=n$11(),p=p$11();let f=t.vertices[0];r$Z(h,e),o$S(o,0,1,0),P$w.makeOrthoBasisDirUpFallback(f.vRight,h,o,o,n,h,r),r$Z(f.frame.up,h),r$Z(f.frame.right,n),i=f;for(let c=1;c<s;++c){f=t.vertices[c],u$S(l,f.vLeft,f.vRight);let e=s$P(l);e>0?(e=1/Math.sqrt(e),l[0]=l[0]*e,l[1]=l[1]*e,l[2]=l[2]*e):(l[0]=f.vRight[0],l[1]=f.vRight[1],l[2]=f.vRight[2]),u$S(u,i.pos,i.frame.up),y$J(f.pos,l,p);D$q(p,d$R(u,f.vLeft),a)?(c$V(a,a,f.pos),j$F(h,a),_$n(n,l,h),j$F(n,n)):P$w.makeOrthoBasisDirUpFallback(l,i.frame.up,i.frame.right,o,n,h,r),r$Z(f.frame.up,h),r$Z(f.frame.right,n),i=f;}}class K$7{numProfilesPerJoin(){return 1}extrude(t,e,i){for(let s=0;s<e.vertices.length;++s)i(t.index,t.frame,e.vertices[s],e.vertexNormals[s],!1);}}class Q$7{constructor(t=.8*Math.PI,e=1){this.cutoffAngle=t,this.numBendSubdivisions=e;}numProfilesPerJoin(){return this.numBendSubdivisions+1}extrude(t,e,i){const s=ct$1;if(Math.abs(t.rotationAngle)>=this.cutoffAngle)for(let r=0;r<this.numBendSubdivisions+1;++r){r$$(xt$1),f$L(xt$1,xt$1,.5*-t.rotationAngle+r*t.rotationAngle/this.numBendSubdivisions,t.rotationFrame.up),G$9(s,t.frame,xt$1);for(let r=0;r<e.vertices.length;++r){_$r(e.vertices[r],t.rotationRight)*t.rotationAngle>=0?i(t.index,s,e.vertices[r],e.vertexNormals[r],!1):(A$A(ot$1,e.vertices[r],t.miterStretch),i(t.index,t.frame,ot$1,e.vertexNormals[r],!0));}}else for(let r=0;r<this.numBendSubdivisions+1;++r)for(let s=0;s<e.vertices.length;++s){const r=_$r(e.vertices[s],t.rotationRight)*t.rotationAngle>=0;A$A(ot$1,e.vertices[s],t.miterStretch),i(t.index,t.frame,ot$1,e.vertexNormals[s],!r);}}}const W$7={generateUV:!1};class X$4{rebuildConnectingProfileGeometry(t,e,i){for(let s=0;s<e.vertices.length;++s)i(t.index,t.frame,e.vertices[s],e.vertexNormals[s],0,0);}}class Y$7 extends X$4{constructor(){super();}getNumVertices(){return 0}getNumIndices(){return 0}rebuildCapGeometry(){}buildTopology(){}}class Z$4 extends X$4{constructor(t,e=0,i=!1){super(),this.profile=t,this.profilePlaneOffset=e,this.flip=i;}getNumVertices(){return this.profile.vertices.length}getNumIndices(){return 3*this.profile.numSegments}rebuildConnectingProfileGeometry(t,e,i){for(let s=0;s<e.vertices.length;++s)i(t.index,t.frame,e.vertices[s],e.vertexNormals[s],this.profilePlaneOffset,0);}rebuildCapGeometry(t,e){const i=ht$1;r$18(i,0,0);const s=this.flip?1:-1;for(let r=0;r<this.profile.vertices.length;++r)e(t.index,t.frame,this.profile.vertices[r],i,this.profilePlaneOffset,s);}buildTopology(t,e){const i=this.vertexBufferStart+this.profile.vertexIndices[0];for(let s=1;s<this.profile.numSegments;++s){const t=this.profile.vertexIndices[2*s+0],r=this.profile.vertexIndices[2*s+1],o=this.vertexBufferStart+t,h=this.vertexBufferStart+r;this.flip?e(h,o,i):e(i,o,h);}}}class $$7 extends X$4{constructor(t){super(),this.flip=!1,this.sign=0,this.breakNormals=!1,this.numSegments=3,this.profile=t.profile,this.flip=t.flip,this.sign=this.flip?1:-1,this.breakNormals=t.breakNormals,this.numSegments=t.subdivisions;}getNumVertices(){let t=0;return t=this.profile.vertices.length*(this.numSegments-1),this.breakNormals&&(t+=this.profile.vertices.length),t+=this.profile.poles.length,t}getNumIndices(){let t=0;t+=2*this.profile.numSegments*(this.numSegments-1);for(let e=0;e<this.profile.numSegments;++e){const i=this.profile.vertexIndices[2*e+0],s=this.profile.vertexIndices[2*e+1];this.profile.poleIndices[i]===this.profile.poleIndices[s]?t+=1:t+=2;}return 3*t}rebuildCapGeometry(t,e){const i=t.frame,s=.5*this.sign,r=ot$1,o=ht$1;r$18(o,0,0);for(let h=0;h<this.profile.poles.length;++h){const r=this.profile.poles[h];r.normal?e(t.index,i,r.position,r.normal,s,0):e(t.index,i,r.position,o,s,this.sign);}if(this.breakNormals)for(let h=0;h<this.profile.vertices.length;++h)e(t.index,i,this.profile.vertices[h],this.profile.vertexNormals[h],0,0);for(let h=0;h<this.numSegments-1;++h){const n=(1-(h+1)/this.numSegments)*Math.PI*.5,a=Math.sin(n),l=Math.cos(n);for(let h=0;h<this.profile.vertices.length;++h){const n=this.profile.poles[this.profile.poleIndices[h]];o$18(r,this.profile.vertices[h],n.position),l$15(r,r,a),n.normal?(s$15(r,r,n.position),e(t.index,i,r,n.normal,s*l,0)):(g$$(o,r),l$15(o,o,a),s$15(r,r,n.position),e(t.index,i,r,o,s*l,this.sign*l));}}}buildTopology(t,e){const i=this.breakNormals?this.vertexBufferStart+this.profile.poles.length:this.firstProfileVertexIndex,s=this.breakNormals?this.vertexBufferStart+this.profile.poles.length+this.profile.vertices.length:this.vertexBufferStart+this.profile.poles.length;for(let r=0;r<this.profile.numSegments;++r){const t=this.profile.vertexIndices[2*r+0],o=this.profile.vertexIndices[2*r+1],h=this.vertexBufferStart+this.profile.poleIndices[t],n=this.vertexBufferStart+this.profile.poleIndices[o];let a=i+t,l=i+o;for(let i=0;i<this.numSegments-1;++i){const r=s+i*this.profile.vertices.length+t,h=s+i*this.profile.vertices.length+o;this.flip?(e(r,l,a),e(l,r,h)):(e(a,l,r),e(h,r,l)),a=r,l=h;}this.flip?(e(h,l,a),h!==n&&e(h,n,l)):(e(a,l,h),h!==n&&e(l,n,h));}}}class tt$2{constructor(t,e,i,s,r,o=W$7){this.options=o,this._extrusionVertexCount=0,this._triangleCount=0,this.numExtrusionProfiles=0,this.numVerticesTotal=0,this.numNormalsTotal=0,this.numUVTotal=0,this.profile=e,this.path=t,this.extruder=i,this.startCap=s,this.endCap=r;const h=this.path.vertices.length-2;this.numExtrusionProfiles=i.numProfilesPerJoin()*h+2,this.numVerticesTotal=e.vertices.length*this.numExtrusionProfiles,this.numNormalsTotal=this.numVerticesTotal,this.startCap.vertexBufferStart=this.numVerticesTotal;const n=this.startCap.getNumVertices();this.numVerticesTotal+=n,this.numNormalsTotal+=n,this.endCap.vertexBufferStart=this.numVerticesTotal;const a=this.endCap.getNumVertices();this.numVerticesTotal+=a,this.numNormalsTotal+=a,this.pathVertexData=new Float32Array(1*this.numVerticesTotal),this.profileRightAxisData=new Float32Array(4*this.numVerticesTotal),this.profileUpAxisData=new Float32Array(4*this.numVerticesTotal),this.profileVertexAndNormalData=new Float32Array(4*this.numVerticesTotal),this.profile.hasUV()&&this.options.generateUV&&(this.numUVTotal=this.profile.uvs.length,this.uvData=new Float32Array(2*this.numUVTotal)),this.originData=new Float32Array(3*this.path.vertices.length),this.rebuildGeometry(),this.buildTopology();}emitVertex(t,e,i,s,r){if(this.profileRightAxisData[4*this._extrusionVertexCount+0]=e.right[0],this.profileRightAxisData[4*this._extrusionVertexCount+1]=e.right[1],this.profileRightAxisData[4*this._extrusionVertexCount+2]=e.right[2],this.profileUpAxisData[4*this._extrusionVertexCount+0]=e.up[0],this.profileUpAxisData[4*this._extrusionVertexCount+1]=e.up[1],this.profileUpAxisData[4*this._extrusionVertexCount+2]=e.up[2],this.profileVertexAndNormalData[4*this._extrusionVertexCount+0]=i[0],this.profileVertexAndNormalData[4*this._extrusionVertexCount+1]=i[1],this.profileVertexAndNormalData[4*this._extrusionVertexCount+2]=s[0],this.profileVertexAndNormalData[4*this._extrusionVertexCount+3]=s[1],this.pathVertexData[this._extrusionVertexCount]=t,r){const e=this.path.vertices[t];this.profileRightAxisData[4*this._extrusionVertexCount+3]=e.rotationRight[0]*e.maxStretchDistance,this.profileUpAxisData[4*this._extrusionVertexCount+3]=e.rotationRight[1]*e.maxStretchDistance;}else this.profileRightAxisData[4*this._extrusionVertexCount+3]=0,this.profileUpAxisData[4*this._extrusionVertexCount+3]=0;++this._extrusionVertexCount;}emitCapVertex(t,e,i,s,r,o){this.profileRightAxisData[4*this._extrusionVertexCount+0]=e.right[0],this.profileRightAxisData[4*this._extrusionVertexCount+1]=e.right[1],this.profileRightAxisData[4*this._extrusionVertexCount+2]=e.right[2],this.profileUpAxisData[4*this._extrusionVertexCount+0]=e.up[0],this.profileUpAxisData[4*this._extrusionVertexCount+1]=e.up[1],this.profileUpAxisData[4*this._extrusionVertexCount+2]=e.up[2],this.profileVertexAndNormalData[4*this._extrusionVertexCount+0]=i[0],this.profileVertexAndNormalData[4*this._extrusionVertexCount+1]=i[1],this.profileVertexAndNormalData[4*this._extrusionVertexCount+2]=s[0],this.profileVertexAndNormalData[4*this._extrusionVertexCount+3]=s[1],this.pathVertexData[this._extrusionVertexCount]=t,this.profileRightAxisData[4*this._extrusionVertexCount+3]=r,this.profileUpAxisData[4*this._extrusionVertexCount+3]=o,++this._extrusionVertexCount;}emitTriangle(t,e,i){this.vertexIndices[3*this._triangleCount+0]=t,this.vertexIndices[3*this._triangleCount+1]=e,this.vertexIndices[3*this._triangleCount+2]=i,this.pathVertexIndices[3*this._triangleCount+0]=this.pathVertexData[t],this.pathVertexIndices[3*this._triangleCount+1]=this.pathVertexData[e],this.pathVertexIndices[3*this._triangleCount+2]=this.pathVertexData[i],this.normalIndices[3*this._triangleCount+0]=t,this.normalIndices[3*this._triangleCount+1]=e,this.normalIndices[3*this._triangleCount+2]=i,++this._triangleCount;}rebuildGeometry(){const t=(t,e,i,s,r)=>this.emitVertex(t,e,i,s,r),e=(t,e,i,s,r,o)=>this.emitCapVertex(t,e,i,s,r,o);this._extrusionVertexCount=0;for(const i of this.path.vertices)this.originData[3*i.index+0]=i.pos[0],this.originData[3*i.index+1]=i.pos[1],this.originData[3*i.index+2]=i.pos[2];this.startCap.rebuildConnectingProfileGeometry(this.path.vertices[0],this.profile,e);for(let i=1;i<this.path.vertices.length-1;++i)this.extruder.extrude(this.path.vertices[i],this.profile,t);if(this.endCap.rebuildConnectingProfileGeometry(this.path.vertices[this.path.vertices.length-1],this.profile,e),this.startCap.rebuildCapGeometry(this.path.vertices[0],e),this.endCap.rebuildCapGeometry(this.path.vertices[this.path.vertices.length-1],e),this.profile.hasUV()&&this.options.generateUV)for(let i=0;i<this.profile.uvs.length;++i)this.uvData[2*i+0]=this.profile.uvs[i],this.uvData[2*i+1]=0;}buildTopology(){const t=(t,e,i)=>this.emitTriangle(t,e,i);this._triangleCount=0;const e=this.profile.vertices.length,i=this.profile.numSegments,s=this.numExtrusionProfiles-1;let r=3*(2*(i*s));this.startCap.indexBufferStart=r,this.startCap.firstProfileVertexIndex=0,r+=this.startCap.getNumIndices(),this.endCap.indexBufferStart=r,this.endCap.firstProfileVertexIndex=e*(this.numExtrusionProfiles-1),r+=this.endCap.getNumIndices(),this.vertexIndices=new Uint32Array(r),this.normalIndices=new Uint32Array(r),this.pathVertexIndices=new Uint32Array(r),this.profile.hasUV()&&this.options.generateUV&&(this.uvIndices=new Uint32Array(r));for(let o=0;o<i;++o){const i=this.profile.vertexIndices[2*o],r=this.profile.vertexIndices[2*o+1];for(let o=0;o<s;++o){const s=o*e+i,h=(o+1)*e+r,n=o*e+r;t(s,(o+1)*e+i,h),t(s,h,n);}}this.startCap.buildTopology(this.path.vertices[0],t),this.endCap.buildTopology(this.path.vertices[this.path.vertices.length-1],t);}onPathChanged(){this.rebuildGeometry();}}class et$1{constructor(t){this.builder=t;}get xform(){return this.builder.path.xform}onPathChanged(){this.builder.onPathChanged();}}class it$1 extends et$1{constructor(t){super(t),this.vertexAttributePosition=null,this.vertexAttributeNormal=null,this.vertexAttributeColor=null,this.vertexAttributePosition=new Float32Array(3*this.builder.numVerticesTotal),this.vertexAttributeNormal=new Float32Array(3*this.builder.numNormalsTotal),this.vertexAttributeColor=new Uint8Array(4),this.vertexAttributeColor[0]=255,this.vertexAttributeColor[1]=255,this.vertexAttributeColor[2]=255,this.vertexAttributeColor[3]=255;}bakeVertexColors(t){this.vertexAttributeColor[0]=255*t[0],this.vertexAttributeColor[1]=255*t[1],this.vertexAttributeColor[2]=255*t[2],this.vertexAttributeColor[3]=255*(t.length>3?t[3]:1);}bake(e){this.size=e;for(let i=0;i<this.builder.numVerticesTotal;++i){let s=this.builder.pathVertexData[i];const r=0===s||s===this.builder.path.vertices.length-1;s*=3;const o=rt$1;o$S(o,this.builder.originData[s++],this.builder.originData[s++],this.builder.originData[s]);const h=4*i,n=at$1,a=ot$1,p=lt$1,f=ut$1,m=pt$1;let g=0,V=0;if(o$S(f,this.builder.profileRightAxisData[h],this.builder.profileRightAxisData[h+1],this.builder.profileRightAxisData[h+2]),o$S(m,this.builder.profileUpAxisData[h],this.builder.profileUpAxisData[h+1],this.builder.profileUpAxisData[h+2]),r$18(a,this.builder.profileVertexAndNormalData[h]*e[0],this.builder.profileVertexAndNormalData[h+1]*e[1]),r)_$n(p,m,f),g=this.builder.profileRightAxisData[h+3]*e[0],V=this.builder.profileUpAxisData[h+3];else {const e=ht$1,i=nt$2;r$18(e,this.builder.profileRightAxisData[h+3],this.builder.profileUpAxisData[h+3]);const s=b$M(e);g$$(e,e);const r=_$r(a,e);if(Math.abs(r)>s){r$18(i,-e[1],e[0]);const o=_$r(a,i);l$15(e,e,s*s$T(r)),l$15(i,i,o),s$15(a,e,i);}o$S(p,0,0,0);}o$S(n,f[0]*a[0]+m[0]*a[1],f[1]*a[0]+m[1]*a[1],f[2]*a[0]+m[2]*a[1]),this.vertexAttributePosition[3*i+0]=o[0]+n[0]+p[0]*g,this.vertexAttributePosition[3*i+1]=o[1]+n[1]+p[1]*g,this.vertexAttributePosition[3*i+2]=o[2]+n[2]+p[2]*g;const b=ot$1;r$18(b,this.builder.profileVertexAndNormalData[h+2],this.builder.profileVertexAndNormalData[h+3]),this.vertexAttributeNormal[3*i+0]=f[0]*b[0]+m[0]*b[1]+p[0]*V,this.vertexAttributeNormal[3*i+1]=f[1]*b[0]+m[1]*b[1]+p[1]*V,this.vertexAttributeNormal[3*i+2]=f[2]*b[0]+m[2]*b[1]+p[2]*V;}}createGeometryData(){const t=[["position",this.builder.vertexIndices],["normal",this.builder.normalIndices]],e=[["position",{size:3,data:this.vertexAttributePosition,exclusive:!0}],["normal",{size:3,data:this.vertexAttributeNormal,exclusive:!0}]];if(this.vertexAttributeColor){const i=this.builder.vertexIndices.length;t.push(["color",new Uint32Array(i)]),e.push(["color",{size:4,data:this.vertexAttributeColor}]);}return {vertexAttributes:e,indices:t}}onPathChanged(){super.onPathChanged(),this.bake(this.size);}intersect(t,e,i){const s=this.builder.vertexIndices,r={size:3,data:this.vertexAttributePosition},o=s.length/3;M$A(t,e,0,o,s,r,void 0,void 0,i);}}class st$1 extends et$1{constructor(t,e,i,s){super(t),this.sizeAttributeValue=e,this.colorAttributeValue=i,this.opacityAttributeValue=s,this.vvData=null,this.baked=new it$1(t),this.vvData=new Float32Array(4*this.builder.path.vertices.length);for(let r=0;r<this.builder.path.vertices.length;++r){this.vvData[4*r+0]=e,this.vvData[4*r+1]=i,this.vvData[4*r+2]=s;const t=0===r||r===this.builder.path.vertices.length-1;this.vvData[4*r+3]=t?1:0;}}createGeometryData(){return {vertexAttributes:[["position",{size:3,data:this.builder.originData,exclusive:!0}],["profileRight",{size:4,data:this.builder.profileRightAxisData,exclusive:!0}],["profileUp",{size:4,data:this.builder.profileUpAxisData,exclusive:!0}],["profileVertexAndNormal",{size:4,data:this.builder.profileVertexAndNormalData,exclusive:!0}],["featureValue",{size:4,data:this.vvData,exclusive:!0}]],indices:[["position",this.builder.pathVertexIndices],["profileRight",this.builder.vertexIndices],["profileUp",this.builder.vertexIndices],["profileVertexAndNormal",this.builder.vertexIndices],["featureValue",this.builder.pathVertexIndices]]}}}const rt$1=n$11(),ot$1=n$19(),ht$1=n$19(),nt$2=n$19(),at$1=n$11(),lt$1=n$11(),ut$1=n$11(),pt$1=n$11(),ft$1=n$11(),ct$1=w$i(),xt$1=e$P();

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
function r$p(r,i){r.attributes.add("featureValue","vec4"),r.vertex.code.add(t$10`bool isCapVertex() {
return featureValue.w == 1.0;
}`),r.vertex.uniforms.add("size","vec3"),i.vvSize?(r.vertex.uniforms.add("vvSizeMinSize","vec3"),r.vertex.uniforms.add("vvSizeMaxSize","vec3"),r.vertex.uniforms.add("vvSizeOffset","vec3"),r.vertex.uniforms.add("vvSizeFactor","vec3"),r.vertex.code.add(t$10`vec2 getSize() {
return size.xy*clamp(vvSizeOffset + featureValue.x * vvSizeFactor, vvSizeMinSize, vvSizeMaxSize).xz;
}`)):r.vertex.code.add(t$10`vec2 getSize(){
return size.xy;
}`),i.vvOpacity?(r.vertex.constants.add("vvOpacityNumber","int",8),r.vertex.code.add(t$10`uniform float vvOpacityValues[vvOpacityNumber];
uniform float vvOpacityOpacities[vvOpacityNumber];
vec4 applyOpacity(vec4 color) {
float value = featureValue.z;
if (value <= vvOpacityValues[0]) {
return vec4( color.xyz, vvOpacityOpacities[0]);
}
for (int i = 1; i < vvOpacityNumber; ++i) {
if (vvOpacityValues[i] >= value) {
float f = (value - vvOpacityValues[i-1]) / (vvOpacityValues[i] - vvOpacityValues[i-1]);
return vec4( color.xyz, mix(vvOpacityOpacities[i-1], vvOpacityOpacities[i], f));
}
}
return vec4( color.xyz, vvOpacityOpacities[vvOpacityNumber - 1]);
}`)):r.vertex.code.add(t$10`vec4 applyOpacity(vec4 color){
return color;
}`),i.vvColor?(r.vertex.constants.add("vvColorNumber","int",8),r.vertex.code.add(t$10`uniform float vvColorValues[vvColorNumber];
uniform vec4 vvColorColors[vvColorNumber];
vec4 getColor() {
float value = featureValue.y;
if (value <= vvColorValues[0]) {
return applyOpacity(vvColorColors[0]);
}
for (int i = 1; i < vvColorNumber; ++i) {
if (vvColorValues[i] >= value) {
float f = (value - vvColorValues[i-1]) / (vvColorValues[i] - vvColorValues[i-1]);
return applyOpacity(mix(vvColorColors[i-1], vvColorColors[i], f));
}
}
return applyOpacity(vvColorColors[vvColorNumber - 1]);
}`)):r.vertex.code.add(t$10`vec4 getColor(){
return applyOpacity(vec4(1, 1, 1, 1));
}`),r.include(o$19),r.attributes.add("profileRight","vec4"),r.attributes.add("profileUp","vec4"),r.attributes.add("profileVertexAndNormal","vec4"),r.vertex.code.add(t$10`vec3 calculateVPos() {
vec2 size = getSize();
vec3 origin = position;
vec3 right = profileRight.xyz;
vec3 up = profileUp.xyz;
vec3 forward = cross(up, right);
vec2 profileVertex = profileVertexAndNormal.xy * size;
vec2 profileNormal = profileVertexAndNormal.zw;
float positionOffsetAlongProfilePlaneNormal = 0.0;
float normalOffsetAlongProfilePlaneNormal = 0.0;`),r.vertex.code.add(t$10`if(!isCapVertex()) {
vec2 rotationRight = vec2(profileRight.w, profileUp.w);
float maxDistance = length(rotationRight);`),r.vertex.code.add(t$10`rotationRight = maxDistance > 0.0 ? normalize(rotationRight) : vec2(0, 0);
float rx = dot(profileVertex, rotationRight);
if (abs(rx) > maxDistance) {
vec2 rotationUp = vec2(-rotationRight.y, rotationRight.x);
float ry = dot(profileVertex, rotationUp);
profileVertex = rotationRight * maxDistance * sign(rx) + rotationUp * ry;
}
}else{
positionOffsetAlongProfilePlaneNormal = profileRight.w * size[0];
normalOffsetAlongProfilePlaneNormal = profileUp.w;
}
vec3 offset = right * profileVertex.x + up * profileVertex.y + forward * positionOffsetAlongProfilePlaneNormal;
return origin + offset;
}`),r.vertex.code.add(t$10`vec3 localNormal() {
vec3 right = profileRight.xyz;
vec3 up = profileUp.xyz;
vec3 forward = cross(up, right);
vec2 profileNormal = profileVertexAndNormal.zw;
vec3 normal = right * profileNormal.x + up * profileNormal.y;
if(isCapVertex()) {
normal += forward * profileUp.w;
}
return normal;
}`);}function i$g(e,o){o.vvSizeEnabled&&(e.setUniform3fv("vvSizeMinSize",o.vvSizeMinSize),e.setUniform3fv("vvSizeMaxSize",o.vvSizeMaxSize),e.setUniform3fv("vvSizeOffset",o.vvSizeOffset),e.setUniform3fv("vvSizeFactor",o.vvSizeFactor)),o.vvColorEnabled&&(e.setUniform1fv("vvColorValues",o.vvColorValues),e.setUniform4fv("vvColorColors",o.vvColorColors)),o.vvOpacityEnabled&&(e.setUniform1fv("vvOpacityValues",o.vvOpacityValues),e.setUniform1fv("vvOpacityOpacities",o.vvOpacityOpacities));}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
function h$m(h){const f=new n$15;return f.vertex.uniforms.add("proj","mat4").add("view","mat4").add("camPos","vec3").add("localOrigin","vec3"),f.varyings.add("vpos","vec3"),f.include(r$p,h),0!==h.output&&7!==h.output||(f.include(r$11,{linearDepth:!1}),h.receiveShadows&&f.include(t$1l,h),f.include(a$1g,h),f.varyings.add("vnormal","vec3"),f.varyings.add("vcolor","vec4"),h.multipassTerrainEnabled&&f.varyings.add("depth","float"),f.vertex.code.add(t$10`
      void main() {
        vpos = calculateVPos();
        vnormal = normalize(localNormal());

        ${h.multipassTerrainEnabled?"depth = (view * vec4(vpos, 1.0)).z;":""}
        gl_Position = transformPosition(proj, view, vpos);

        ${0===h.output?"forwardLinearDepth();":""}

        vcolor = getColor();
      }
    `)),h.multipassTerrainEnabled&&(f.fragment.include(a$15),f.include(r$1j,h)),7===h.output&&(f.include(c$$,h),f.fragment.uniforms.add("camPos","vec3"),f.fragment.uniforms.add("localOrigin","vec3"),f.fragment.uniforms.add("opacity","float"),f.fragment.code.add(t$10`
      void main() {
        discardBySlice(vpos);
        ${h.multipassTerrainEnabled?"terrainDepthTest(gl_FragCoord, depth);":""}
        float combinedOpacity = vcolor.a * opacity;
        gl_FragColor = vec4(combinedOpacity);
      }
    `)),0===h.output&&(f.include(c$$,h),f.include(l$1b,h),f.include(o$1a,h),h.receiveShadows&&f.include(t$1l,h),f.include(r$1o,h),f.fragment.uniforms.add("camPos","vec3").add("localOrigin","vec3").add("ambient","vec3").add("diffuse","vec3").add("specular","vec3").add("opacity","float"),f.fragment.include(e$U),f.fragment.code.add(t$10`
      void main() {
        discardBySlice(vpos);
        ${h.multipassTerrainEnabled?"terrainDepthTest(gl_FragCoord, depth);":""}

        shadingParams.viewDirection = normalize(vpos - camPos);
        shadingParams.normalView = vnormal;
        vec3 normal = shadingNormal(shadingParams);
        float ssao = evaluateAmbientOcclusionInverse();

        float additionalAmbientScale = additionalDirectedAmbientLight(vpos + localOrigin);
        vec3 additionalLight = ssao * lightingMainIntensity * additionalAmbientScale * ambientBoostFactor * lightingGlobalFactor;
        ${h.receiveShadows?"float shadow = readShadowMap(vpos, linearDepth);":1===h.viewingMode?"float shadow = lightingGlobalFactor * (1.0 - additionalAmbientScale);":"float shadow = 0.0;"}
        vec3 albedo = vcolor.rgb * max(ambient, diffuse); // combine the old material parameters into a single one
        float combinedOpacity = vcolor.a * opacity;
        albedo += 0.25 * specular; // don't completely ignore specular for now

        vec3 shadedColor = evaluateSceneLighting(normal, albedo, shadow, 1.0 - ssao, additionalLight);
        gl_FragColor = vec4(shadedColor, combinedOpacity);
        gl_FragColor = highlightSlice(gl_FragColor, vpos);
        ${h.OITEnabled?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""}
      }
    `)),1!==h.output&&3!==h.output||(f.include(r$11,{linearDepth:!0}),f.vertex.uniforms.add("nearFar","vec2"),f.varyings.add("depth","float"),f.vertex.code.add(t$10`void main() {
vpos = calculateVPos();
gl_Position = transformPositionWithDepth(proj, view, vpos, nearFar, depth);
}`),f.include(c$$,h),f.include(e$14,h),f.fragment.uniforms.add("timeElapsed","float"),f.fragment.code.add(t$10`void main() {
discardBySlice(vpos);
outputDepth(depth);
}`)),2===h.output&&(f.include(r$11,{linearDepth:!1}),f.include(n$F,h),f.vertex.uniforms.add("viewNormal","mat4"),f.varyings.add("vnormal","vec3"),f.vertex.code.add(t$10`void main(void) {
vpos = calculateVPos();
vnormal = normalize((viewNormal * vec4(localNormal(), 1.0)).xyz);
gl_Position = transformPosition(proj, view, vpos);
}`),f.include(c$$,h),f.fragment.uniforms.add("waterColor","vec4"),f.fragment.code.add(t$10`void main() {
discardBySlice(vpos);
vec3 normal = normalize(vnormal);
if (gl_FrontFacing == false) normal = -normal;
gl_FragColor = vec4(vec3(0.5) + 0.5 * normal, 1.0);
}`)),4===h.output&&(f.include(r$11,{linearDepth:!1}),f.include(n$F,h),f.vertex.uniforms.add("viewNormal","mat4"),f.varyings.add("vnormal","vec3"),f.vertex.code.add(t$10`void main(void) {
vpos = calculateVPos();
gl_Position = transformPosition(proj, view, vpos);
}`),f.include(c$$,h),f.include(r$1g),f.fragment.code.add(t$10`void main() {
discardBySlice(vpos);
outputHighlight();
}`)),f}var f$m=Object.freeze({__proto__:null,build:h$m});

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
const O$b=new Map([["position",0],["profileRight",1],["profileUp",2],["profileVertexAndNormal",3],["featureValue",4]]);class E$e extends t$11{initializeProgram(e){const r=E$e.shader.get(),i=this.configuration,t=r.build({OITEnabled:0===i.transparencyPassType,output:i.output,viewingMode:e.viewingMode,slicePlaneEnabled:i.slicePlaneEnabled,sliceHighlightDisabled:!1,sliceEnabledForVertexPrograms:!1,receiveShadows:i.receiveShadows,vvSize:i.vvSize,vvColor:i.vvColor,vvInstancingEnabled:!0,vvOpacity:i.vvOpacity,pbrMode:0,useCustomDTRExponentForWater:!1,receiveAmbientOcclusion:i.receiveSSAO,doubleSidedMode:i.doubleSidedMode,multipassTerrainEnabled:i.multipassTerrainEnabled,cullAboveGround:i.cullAboveGround});return new n$16(e.rctx,t,O$b)}bindPass(e,r){var t,s;t$15(this.program,r.camera.projectionMatrix),this.program.setUniform3fv("size",e.size),r.multipassTerrainEnabled&&(this.program.setUniform2fv("cameraNearFar",r.camera.nearFar),this.program.setUniform2fv("inverseViewport",r.inverseViewport),t$1f(this.program,r)),0!==this.configuration.output&&7!==this.configuration.output||this.program.setUniform1f("opacity",e.opacity),0===this.configuration.output?(r.lighting.setUniforms(this.program,!1),this.program.setUniform3fv("ambient",e.ambient),this.program.setUniform3fv("diffuse",e.diffuse),this.program.setUniform3fv("specular",e.specular),this.program.setUniform1f("opacity",e.opacity)):1!==this.configuration.output&&3!==this.configuration.output||r$1p(this.program,r.camera.nearFar),i$g(this.program,e),null==(t=r.shadowMap)||t.bind(this.program),null==(s=r.ssaoHelper)||s.bind(this.program);}bindDraw(e){a$17(this.program,e),l$_(this.program,this.configuration,e),this.program.rebindTextures(),0!==this.configuration.output&&7!==this.configuration.output||o$12(this.program,e.origin,e.camera.viewInverseTransposeMatrix),0===this.configuration.output&&l$1c(this.program,e),2===this.configuration.output&&l$1d.bindUniforms(this.program,e.camera.viewInverseTransposeMatrix);}setPipelineState(e){const r=this.configuration,i=3===e,t=2===e,o=e=>!e.slicePlaneEnabled&&!(e.transparent||0===e.doubleSidedMode);return g$S({blending:0!==r.output&&7!==r.output||!r.transparent?null:i?u$$:c$11(e),culling:o(r)&&n$1q,depthTest:{func:a$1d(e)},depthWrite:i||t?l$$:null,colorWrite:r$13,stencilWrite:r.sceneHasOcludees?f$T:null,stencilTest:r.sceneHasOcludees?c$15:null,polygonOffset:i||t?null:i$$})}initializePipeline(){return this.setPipelineState(this.configuration.transparencyPassType)}}E$e.shader=new t$12(f$m,(()=>import('./Path.glsl-62c59b9c.js')));class x$m extends e$S{constructor(){super(...arguments),this.output=0,this.doubleSidedMode=0,this.receiveShadows=!1,this.receiveSSAO=!1,this.vvSize=!1,this.vvColor=!1,this.vvOpacity=!1,this.slicePlaneEnabled=!1,this.transparent=!1,this.sceneHasOcludees=!1,this.transparencyPassType=3,this.multipassTerrainEnabled=!1,this.cullAboveGround=!1;}}e$Q([r$12({count:8})],x$m.prototype,"output",void 0),e$Q([r$12({count:3})],x$m.prototype,"doubleSidedMode",void 0),e$Q([r$12()],x$m.prototype,"receiveShadows",void 0),e$Q([r$12()],x$m.prototype,"receiveSSAO",void 0),e$Q([r$12()],x$m.prototype,"vvSize",void 0),e$Q([r$12()],x$m.prototype,"vvColor",void 0),e$Q([r$12()],x$m.prototype,"vvOpacity",void 0),e$Q([r$12()],x$m.prototype,"slicePlaneEnabled",void 0),e$Q([r$12()],x$m.prototype,"transparent",void 0),e$Q([r$12()],x$m.prototype,"sceneHasOcludees",void 0),e$Q([r$12({count:4})],x$m.prototype,"transparencyPassType",void 0),e$Q([r$12()],x$m.prototype,"multipassTerrainEnabled",void 0),e$Q([r$12()],x$m.prototype,"cullAboveGround",void 0);

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
const g$p=i$R;class S$h extends a$18{constructor(e){super(e,y$k),this.supportsEdges=!0,this._vertexAttributeLocations=O$b,this.techniqueConfig=new x$m,this.vertexBufferLayout=S$h.getVertexBufferLayout(this.params);}getTechniqueConfig(e,t){return this.techniqueConfig.output=e,this.techniqueConfig.vvSize=this.params.vvSizeEnabled,this.techniqueConfig.vvColor=this.params.vvColorEnabled,this.techniqueConfig.vvOpacity=this.params.vvOpacityEnabled,this.techniqueConfig.slicePlaneEnabled=this.params.slicePlaneEnabled,this.techniqueConfig.transparent=this.params.transparent,this.techniqueConfig.sceneHasOcludees=this.params.sceneHasOcludees,0!==e&&7!==e||(this.techniqueConfig.doubleSidedMode=this.params.doubleSided&&"normal"===this.params.doubleSidedType?1:this.params.doubleSided&&"winding-order"===this.params.doubleSidedType?2:0,this.techniqueConfig.receiveShadows=this.params.receiveShadows,this.techniqueConfig.receiveSSAO=!(!t||!t.ssaoEnabled)&&this.params.receiveSSAO),this.techniqueConfig.transparencyPassType=t?t.transparencyPassType:3,this.techniqueConfig.multipassTerrainEnabled=!!t&&t.multipassTerrainEnabled,this.techniqueConfig.cullAboveGround=!!t&&t.cullAboveGround,this.techniqueConfig}getPassParameters(){return this.params}isVisibleInPass(e){return 4!==e&&6!==e&&7!==e||this.params.castShadows}isVisible(){const e=this.params;return !!super.isVisible()&&e.opacity>0}intersect(s,a,r,n,o,u,c){const l=s;if(!r$r(l))return;const p=l.path,d=[this.params.size[0],this.params.size[1]];if(this.params.vvSizeEnabled){const t=this.params.vvSizeOffset,i=this.params.vvSizeFactor,s=this.params.vvSizeMinSize,a=this.params.vvSizeMaxSize,r=p.sizeAttributeValue;d[0]*=o$R(t[0]+r*i[0],s[0],a[0]),d[1]*=o$R(t[2]+r*i[2],s[2],a[2]);}const f=Math.max(d[0],d[1]),m=s.boundingInfo;if(t$17(m))return void this._intersectTriangles(p,d,o,u,c);const b=u$14(m.bbMin[0]-f,m.bbMin[1]-f,m.bbMin[2]-f,m.bbMax[0]+f,m.bbMax[1]+f,m.bbMax[2]+f),g=[u[0]-o[0],u[1]-o[1],u[2]-o[2]],S=Math.sqrt(g[0]*g[0]+g[1]*g[1]+g[2]*g[2]),q=[S/g[0],S/g[1],S/g[2]];A$B(b,o,q,n.tolerance)&&this._intersectTriangles(p,d,o,u,c);}_intersectTriangles(e,t,i,s,a){e.baked.size&&e.baked.size[0]===t[0]&&e.baked.size[1]===t[1]||e.baked.bake(t),e.baked.intersect(i,s,a);}computeAttachmentOrigin(e,t){const i=e.vertexAttributes;if(!i)return null;const s=i.get("position");return g$W(s,null,!1,t)}createBufferWriter(){return new x$l(this.vertexBufferLayout)}getGLMaterial(e){if(0===e.output||7===e.output||1===e.output||2===e.output||4===e.output||3===e.output&&this.params.castShadows)return new q$7(e)}static getVertexBufferLayout(e){let t=A$u().vec3f("position").vec4f("profileRight").vec4f("profileUp").vec4f("profileVertexAndNormal");return (e.vvColorEnabled||e.vvSizeEnabled||e.vvOpacityEnabled)&&(t=t.vec4f("featureValue")),t}}class q$7 extends t$1i{constructor(e){super(e),this.updateParameters();}updateParameters(e){this._technique=this._techniqueRep.releaseAndAcquire(E$e,this._material.getTechniqueConfig(this._output,e),this._technique);}beginSlot(e){return e===(this._technique.configuration.transparent?5:3)}_updateOccludeeState(e){e.hasOccludees!==this._material.params.sceneHasOcludees&&this._material.setParameterValues({sceneHasOcludees:e.hasOccludees});}_updateShadowState(e){e.shadowMappingEnabled!==this._technique.configuration.receiveShadows&&this._material.setParameterValues({receiveShadows:e.shadowMappingEnabled});}ensureParameters(e){0!==this._output&&7!==this._output||(this._updateShadowState(e),this._updateOccludeeState(e)),this.updateParameters(e);}bind(e){this._technique.bindPass(this._material.getPassParameters(),e);}}const y$k={size:[1,1,1],ambient:[.2,.2,.2],diffuse:[.8,.8,.8],specular:[0,0,0],opacity:1,doubleSided:!1,doubleSidedType:"normal",receiveSSAO:!0,receiveShadows:!1,castShadows:!0,slicePlaneEnabled:!1,transparent:!1,sceneHasOcludees:!1,...o$y.Default,...d$$};class x$l{constructor(e){this.vertexBufferLayout=e;}allocate(e){return this.vertexBufferLayout.createBuffer(e)}elementCount(e){return e.indices.get("position").length}write(e,t,i,a){const r=e=>{if(t.vertexAttributes.has(e)){const r=t.vertexAttributes.get(e),n=t.indices.get(e);g$p(4===r.size);const o=i.getField(e,c$18);if(!o)throw new Error("unable to acquire view for "+e);c$13(n,r.data,o,a);}};r("profileRight"),r("profileUp"),r("profileVertexAndNormal"),this.vertexBufferLayout.hasField("featureValue")&&r("featureValue"),g$Z(t,this.vertexBufferLayout,e.transformation,e.invTranspTransformation,i,a);}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
const $$6=["polyline"];class ee$3 extends y$r{constructor(e,t,i,r){super(e,t,i,r),this._intrinsicSize=t$18(1,1),this.upVectorAlignment="path",this.stencilWidth=.1,this.ensureDrapedStatus(!1);}async doLoad(){const t=r$Y(this.symbolLayer.width)?this.symbolLayer.width:r$Y(this.symbolLayer.height)?this.symbolLayer.height:this.symbolLayer.size,i=r$Y(this.symbolLayer.height)?this.symbolLayer.height:t;this._vvConvertOptions={modelSize:[1,1,1],symbolSize:[t,1,i],unitInMeters:this._context.renderCoordsHelper.unitInMeters,transformation:{anchor:[0,0,0],scale:[1,1,1],rotation:[0,0,0]},supportedTypes:{size:!0,color:!0,opacity:!0,rotation:!1}},this._context.renderer&&this._context.renderer.visualVariables&&this._context.renderer.visualVariables.length>0?this._fastUpdates=D$c(this._context.renderer,this._vvConvertOptions):this._fastUpdates={enabled:!1};const r=this.symbolLayer.anchor||"center";this.upVectorAlignment="path","heading"===this.symbolLayer.profileRotation&&(this.upVectorAlignment="world");const o=this.symbolLayer.profile||"circle";switch(o){case"circle":default:this._profile=O$c.circle(ce$3);break;case"quad":this._profile=O$c.rect();}let h=[0,0];"center"!==r&&(h={left:[.5,0],right:[-.5,0],top:[0,-.5],bottom:[0,.5]}[r],this._profile.translate(h[0],h[1]));switch(this.symbolLayer.join||"simple"){case"round":this._extruder=new Q$7(0,le$3);break;case"bevel":this._extruder=new Q$7(0,1);break;case"miter":this._extruder=new Q$7(.8*Math.PI,1);break;case"simple":default:this._extruder=new K$7;}const c=this.symbolLayer.cap||"butt";switch(c){case"none":this._startCap=new Y$7,this._endCap=new Y$7;break;case"butt":default:this._startCap=new Z$4(this._profile,0),this._endCap=new Z$4(this._profile,0,!0);break;case"square":this._startCap=new Z$4(this._profile,-.5),this._endCap=new Z$4(this._profile,.5,!0);break;case"round":{const e="quad"===o;this._startCap=new $$7({profile:this._profile,flip:!1,breakNormals:e,subdivisions:he$3}),this._endCap=new $$7({profile:this._profile,flip:!0,breakNormals:e,subdivisions:he$3});break}}const p=g$Y(this.symbolLayer,"material","color"),m=this._getCombinedOpacityAndColor(p),d=e$11(m),f=m[3],u=f<1||this.needsDrivenTransparentPass,y={diffuse:d,ambient:d,opacity:f,transparent:u,vertexColors:!1,slicePlaneEnabled:this._context.slicePlaneEnabled,castShadows:this.symbolLayer.castShadows,cullFace:u||"none"===c?0:2,offsetTransparentBackfaces:!0};if(!this._drivenProperties.size&&(r$18(this._intrinsicSize,t,i),!S$q(this._intrinsicSize[0])||!S$q(this._intrinsicSize[1])))throw new s$Q("graphics3dpathsymbollayer:invalid-size","Symbol sizes may not be negative values");this._fastUpdates.enabled&&this._fastUpdates.visualVariables.size||l$15(this._intrinsicSize,this._intrinsicSize,1/this._context.renderCoordsHelper.unitInMeters),this._fastUpdates.enabled?(Object.assign(y,this._fastUpdates.materialParameters,{size:[this._intrinsicSize[0],this._intrinsicSize[1],0]}),this._material=new S$h(y)):(y.vertexColors=this._drivenProperties.color||this._drivenProperties.opacity,this._material=new y$S(y)),this._material.setParameterValues({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}),this._context.stage.add(this._material);}destroy(){super.destroy(),this._context.stage.remove(this._material),this._material=null;}createGraphics3DGraphic(e){const t=e.graphic;if(!this._validateGeometry(t.geometry,$$6,this.symbolLayer.type))return null;const i=this.setGraphicElevationContext(t,new h$s),r=e.renderingInfo;return this._createAs3DShape(t,r,i,t.uid)}layerOpacityChanged(){const e=g$Y(this.symbolLayer,"material","color"),t=this._getCombinedOpacity(e),i=t<1||this.needsDrivenTransparentPass;return this._material.setParameterValues({opacity:t,transparent:i}),!0}layerElevationInfoChanged(e,t){return this.updateGraphics3DGraphicElevationInfo(e,t,g$A)}slicePlaneEnabledChanged(){return this._material.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled}),!0}physicalBasedRenderingChanged(){return this._material.setParameterValues({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}),!0}pixelRatioChanged(){return !0}applyRendererDiff(e,t){for(const i in e.diff)switch(i){case"visualVariables":if(!I$f(this._fastUpdates,t,this._vvConvertOptions))return !1;this._material.setParameterValues(this._fastUpdates.materialParameters);break;default:return !1}return !0}getVertexData(e){let t=0;const i=e.paths,r=[],s=e.spatialReference,a=this._context.elevationProvider.spatialReference,o=this._context.renderCoordsHelper.spatialReference;for(const m of i)t+=m.length;const n=new Float64Array(3*t),l=new Float64Array(3*t),h=new Float64Array(3*t);let c=0;for(const m of i){r.push({index:c,numVertices:m.length});for(const t of m)n[c++]=t[0],n[c++]=t[1],n[c++]=e.hasZ?t[2]:0;}let p=!0;return s.equals(a)?this._copyVertices(n,0,l,0,t):p=xn(n,s,0,l,a,0,t),a.equals(o)?this._copyVertices(l,0,h,0,t):xn(l,a,0,h,o,0,t),{pathVertexDataInfos:r,vertexDataGS:n,vertexDataES:l,vertexDataRS:h,projectionSuccess:p,terrainElevation:0}}_copyVertices(e,t,i,r,s){t*=3,r*=3;for(let a=0;a<s;++a)i[r++]=e[t++],i[r++]=e[t++],i[r++]=e[t++];}_createAs3DShape(e,t,i,r){const a=e.geometry,o=new Array,n=new Array,l=new Array,h=a.spatialReference,p=a$1c(),m=this._context.renderCoordsHelper,d=this.getVertexData(a);if(!d.projectionSuccess)return this.logger.warn("PathSymbol3DLayer geometry failed to be created (failed to project geometry to view spatial reference)"),null;if(d.pathVertexDataInfos.length>0){for(let r=0;r<d.pathVertexDataInfos.length;++r){const a=d.pathVertexDataInfos[r],f=a.index,u=a.numVertices;if(u<2)continue;if(r$Y(this._context.clippingExtent)&&(B$n(p),M$z(p,d.vertexDataES,3*f,u),!R$u(p,this._context.clippingExtent)))continue;const y=[];for(let e=f;e<f+3*u;){const t=e++,r=e++,s=e++,a=new E$f;o$S(a.posGS,d.vertexDataGS[t],d.vertexDataGS[r],d.vertexDataGS[s]),o$S(a.posES,d.vertexDataES[t],d.vertexDataES[r],d.vertexDataES[s]);const o=m$A(a.posES,this._context.elevationProvider,i,m,null);o$S(ae$2,d.vertexDataRS[t],d.vertexDataRS[r],d.vertexDataRS[s]),m.setAltitude(ae$2,o),o$S(a.pos,ae$2[0],ae$2[1],ae$2[2]),y.push(a);}const g=new J$7(y);te$3(g,this.upVectorAlignment,this._context.renderCoordsHelper);const _=new tt$2(g,this._profile,this._extruder,this._startCap,this._endCap);let b=null;if(this._fastUpdates.enabled){const t=this._fastUpdates.visualVariables,i=t.size?v$s(t.size.field,e):0,r=t.color?v$s(t.color.field,e):0,s=t.opacity?v$s(t.opacity.field,e):0;b=new st$1(_,i,r,s);}else {const e=[this._intrinsicSize[0],this._intrinsicSize[1]];this._drivenProperties.size&&(e[0]*=ie$2(t.size[0],"symbol-value"===t.size[2]?this.symbolLayer.height||0:t.size[2],this.symbolLayer.width||0),e[1]*=ie$2(t.size[2],"symbol-value"===t.size[0]?this.symbolLayer.width||0:t.size[0],this.symbolLayer.height||0));let i=null;this._drivenProperties.color&&(i=t.color),this._drivenProperties.opacity&&null!=t.opacity&&(i=i?[i[0],i[1],i[2],t.opacity]:[1,1,1,t.opacity]);const r=new it$1(_);r.bake(e),i&&r.bakeVertexColors(i),b=r;}const{vertexAttributes:v,indices:x}=b.createGeometryData(),w=new e$m(v,x,b,h,this.upVectorAlignment,this.stencilWidth);o.push(w),n.push(this._material),l.push(b.xform);}if(o.length>0){const e={layerUid:this._context.layer.uid,graphicUid:r},t=new R$p({geometries:o,materials:n,transformations:l,metadata:e}),s=new m$z(this,t,o,null,null,se$3,i);return s.alignedSampledElevation=d.terrainElevation,s.needsElevationUpdates=g$A(i.mode),s}}else 0!==a.paths.length&&a.paths.some((e=>e.length>0))||this.logger.warn("PathSymbol3DLayer geometry failed to be created (no paths were defined)");return null}}function te$3(e,s,a){switch(s){case"world":for(const t of e.vertices)u$S(oe$2,t.pos,e.offset),a.worldUpAtPosition(oe$2,ae$2),t.setFrameFromUpVector(ae$2),t.computeRotationAxisAndAngleFromUpVector();break;case"path":u$S(oe$2,e.vertices[0].pos,e.offset),a.worldUpAtPosition(oe$2,ae$2),q$8(e,ae$2);for(const s of e.vertices){const e=s$T(z$u(s.frame.right,s.vRight));_$n(s.rotationFrame.up,s.vRight,s.vLeft),d$O(s.rotationFrame.up,s.rotationFrame.up,e),j$F(s.rotationFrame.up,s.rotationFrame.up);const a=z$u(s.rotationFrame.up,s.frame.up),n=z$u(s.rotationFrame.up,s.frame.right);if(d$O(oe$2,s.frame.up,-n),d$O(ne$2,s.frame.right,a),u$S(oe$2,oe$2,ne$2),j$F(s.rotationFrame.right,oe$2),z$a(s.rotationRight,s.frame,s.rotationFrame.right),v$N(oe$2,s.vLeft),s.rotationAngle=-e*(Math.PI-x$N(z$u(oe$2,s.vRight))),Math.abs(s.rotationAngle)>0){const e=g$10(Math.cos(.5*s.rotationAngle));s$p(s.miterStretch,1+(e-1)*s.rotationRight[0]*s.rotationRight[0],(e-1)*s.rotationRight[0]*s.rotationRight[1],(e-1)*s.rotationRight[0]*s.rotationRight[1],1+(e-1)*s.rotationRight[1]*s.rotationRight[1]);}const l=Math.PI-s.rotationAngle;s.maxStretchDistance=Math.abs(Math.min(s.vLeftLength,s.vRightLength)*g$10(Math.cos(.5*l)));}}}function ie$2(e,t,i){switch(e){case"symbol-value":return i;case"proportional":return t;default:return e}}function re$3(e,t,i,r){let s=0;for(const a of e.vertices){const o=m$A(a.posES,i,t,r,pe$2);s+=pe$2.sampledElevation,u$S(ae$2,a.pos,e.offset),r.setAltitude(ae$2,o),c$V(a.pos,ae$2,e.offset);}return e.updatePathVertexInformation(),s/e.vertices.length}function se$3(e,t,i,r){const s=e.stageObject,a=s.geometryRecords,o=a.length;let n=0;r.spatialReference;for(let l=0;l<o;l++){const e=a[l].geometry;if(!r$r(e))continue;const o=e.path,h=o.builder.path;e.geometrySR,n+=re$3(h,t,i,r),"world"!==e.upVectorAlignment&&te$3(h,e.upVectorAlignment,r),o.onPathChanged(),e.invalidateBoundingInfo(),s.geometryVertexAttrsUpdated(l);}return n/o}const ae$2=n$11(),oe$2=n$17(),ne$2=n$17(),le$3=3,he$3=3,ce$3=10,pe$2={verticalDistanceToGround:0,sampledElevation:0};

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
function g$o(t,o,r,s=1){if(r.isGeographic){const t=new Float64Array(o.typedBuffer.length),e=3*o.count;for(let s=0;s<e;s+=3)Gn(o.typedBuffer,s,t,s,p$15(r));o=T$v.fromTypedArray(t);}r$18(d$l,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY);for(let e=0;e<o.count;e++)o.getVec(e,y$j),d$l[0]=Math.min(d$l[0],y$j[0]),d$l[1]=Math.min(d$l[1],y$j[1]);const n=d$l[0]%s,c=d$l[1]%s;A$a[0]=d$l[0]-n,A$a[1]=d$l[1]-c;for(let e=0;e<o.count;e++)o.getVec(e,y$j),t.setValues(e,(y$j[0]-A$a[0])/s,(y$j[1]-A$a[1])/s,A$a[0]/s,A$a[1]/s);}function j$i(t,o,r,m,u=1){o$S(F$c,1,0,0),o$S(Y$6,0,1,0),o$S(_$b,0,0,1),z$9(M$g,o),O$a(o,E$d)&&S$g(E$d,F$c,Y$6,_$b,r,M$g),r$18(d$l,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY),r$18(k$a,Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY);for(let e=0;e<o.count;e++){o.getVec(e,y$j);const t=z$u(F$c,y$j),r=z$u(Y$6,y$j);d$l[0]=Math.min(d$l[0],t),d$l[1]=Math.min(d$l[1],r),k$a[0]=Math.max(k$a[0],t),k$a[1]=Math.max(k$a[1],r);}const i=z$u(_$b,M$g);D$9(P$e,d$l[0],d$l[1],i,F$c,Y$6,_$b),D$9(v$i,k$a[0],d$l[1],i,F$c,Y$6,_$b),D$9(x$k,d$l[0],k$a[1],i,F$c,Y$6,_$b),c$V(v$i,v$i,P$e),d$O(v$i,v$i,.5),c$V(x$k,x$k,P$e),d$O(x$k,x$k,.5),u$S(P$e,P$e,v$i),u$S(P$e,P$e,x$k);const I=d$l[0]%u,p=d$l[1]%u;A$a[0]=d$l[0]-I,A$a[1]=d$l[1]-p;for(let e=0;e<o.count;e++){o.getVec(e,y$j),t.setValues(e,(z$u(F$c,y$j)-A$a[0])/u,(z$u(Y$6,y$j)-A$a[1])/u,A$a[0]/u,A$a[1]/u);for(let t=0;t<3;t++)m.set(e,t,P$e[t]),m.set(e,t+3,v$i[t]),m.set(e,t+6,x$k[t]);}}const M$g=n$11(),y$j=n$11(),E$d=p$11(),F$c=n$11(),Y$6=n$11(),_$b=n$11(),d$l=n$19(),k$a=n$19(),A$a=n$19(),P$e=n$11(),v$i=n$11(),x$k=n$11();function O$a(t,o){const e=t.count-1;return l$T(t,o,0,Math.floor(e/3),Math.floor(e*(2/3)))}function S$g(o,e,r,c,f,p){r$Y(f)?(f.basisMatrixAtPosition(p,B$8),o$S(G$8,B$8[0],B$8[1],B$8[2]),o$S(w$h,B$8[4],B$8[5],B$8[6]),o$S(q$6,B$8[8],B$8[9],B$8[10])):(o$S(G$8,1,0,0),o$S(w$h,0,1,0),o$S(q$6,0,0,1));const N=W$j(o);z$u(N,q$6)<0&&d$O(N,N,-1),r$Z(c,N);const h=z$u(N,w$h),l=z$u(N,G$8);Math.abs(h)<Math.abs(l)?(b$N(e,G$8,N,-l),j$F(e,e),_$n(r,e,N),j$F(r,r),d$O(r,r,-1)):(b$N(r,w$h,N,-h),j$F(r,r),_$n(e,r,N),j$F(e,e));}const B$8=e$P(),G$8=n$11(),w$h=n$11(),q$6=n$11();function z$9(t,o){o$S(C$c,0,0,0);for(let e=0;e<o.count-1;e++)o.getVec(e,y$j),u$S(C$c,C$c,y$j);d$O(t,C$c,1/(o.count-1));}const C$c=n$11();function D$9(t,o,e,r,n,c,a){o$S(t,o*n[0]+e*c[0]+r*a[0],o*n[1]+e*c[1]+r*a[1],o*n[2]+e*c[2]+r*a[2]);}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
function g$n(g){const u=new n$15,c=1===g.output;return u.include(r$11,{linearDepth:c}),u.include(r$1m,g),u.vertex.uniforms.add("proj","mat4").add("view","mat4"),u.attributes.add("position","vec3"),u.varyings.add("vpos","vec3"),g.multipassTerrainEnabled&&u.varyings.add("depth","float"),c&&(u.include(e$14,g),u.vertex.uniforms.add("cameraNearFar","vec2"),u.varyings.add("linearDepth","float")),u.vertex.code.add(t$10`
    void main(void) {
      vpos = position;
      forwardNormalizedVertexColor();
      ${g.multipassTerrainEnabled?"depth = (view * vec4(vpos, 1.0)).z;":""}
      gl_Position = ${c?t$10`transformPositionWithDepth(proj, view, vpos, cameraNearFar, linearDepth);`:t$10`transformPosition(proj, view, vpos);`}
    }
  `),u.include(c$$,g),u.fragment.include(e$U),g.multipassTerrainEnabled&&(u.fragment.include(a$15),u.include(r$1j,g)),u.fragment.uniforms.add("eColor","vec4"),4===g.output&&u.include(r$1g),u.fragment.code.add(t$10`
  void main() {
    discardBySlice(vpos);
    ${g.multipassTerrainEnabled?"terrainDepthTest(gl_FragCoord, depth);":""}
    vec4 color = ${g.attributeColor?"vColor * eColor;":"eColor;"}

    if (color.a < ${t$10.float(o$10)}) {
      discard;
    }

    ${7===g.output?t$10`gl_FragColor = vec4(color.a);`:""}

    ${0===g.output?t$10`gl_FragColor = highlightSlice(color, vpos); ${g.OITEnabled?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""}`:""}
    ${4===g.output?t$10`outputHighlight();`:""};
    ${1===g.output?t$10`outputDepth(linearDepth);`:""};
  }
  `),u}var u$m=Object.freeze({__proto__:null,build:g$n});

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class E$c extends t$11{initializeProgram(e){const t=E$c.shader.get(),r=this.configuration,i=t.build({output:r.output,OITEnabled:0===r.transparencyPassType,attributeColor:r.vertexColors,slicePlaneEnabled:r.slicePlaneEnabled,sliceHighlightDisabled:!1,sliceEnabledForVertexPrograms:!1,multipassTerrainEnabled:r.multipassTerrainEnabled,cullAboveGround:r.cullAboveGround});return new n$16(e.rctx,i,o$X)}bindPass(e,t){t$15(this.program,t.camera.projectionMatrix),this.program.setUniform4fv("eColor",e.color),4===this.configuration.output&&g$V(this.program,t),(1===this.configuration.output||t.multipassTerrainEnabled)&&this.program.setUniform2fv("cameraNearFar",t.camera.nearFar),t.multipassTerrainEnabled&&(this.program.setUniform2fv("inverseViewport",t.inverseViewport),t$1f(this.program,t));}bindDraw(e){a$17(this.program,e),this.program.rebindTextures(),l$_(this.program,this.configuration,e);}setPipelineState(e,t){const r=this.configuration,i=3===e,o=2===e;return g$S({blending:0!==r.output&&7!==r.output||!r.transparent?null:i?u$$:c$11(e),culling:s$16(r.cullFace),depthTest:{func:a$1d(e)},depthWrite:i||o?r.writeDepth&&l$$:null,colorWrite:r$13,stencilWrite:r.sceneHasOcludees?f$T:null,stencilTest:r.sceneHasOcludees?t?t$1k:c$15:null,polygonOffset:i||o?r.polygonOffset&&S$f:s$_(r.enableOffset)})}initializePipeline(){return this._occludeePipelineState=this.setPipelineState(this.configuration.transparencyPassType,!0),this.setPipelineState(this.configuration.transparencyPassType,!1)}getPipelineState(e){return e?this._occludeePipelineState:this.pipeline}}E$c.shader=new t$12(u$m,(()=>import('./ColorMaterial.glsl-1f6805dd.js')));const S$f={factor:1,units:1};class x$j extends e$S{constructor(){super(...arguments),this.output=0,this.cullFace=0,this.slicePlaneEnabled=!1,this.vertexColors=!1,this.transparent=!1,this.polygonOffset=!1,this.enableOffset=!0,this.writeDepth=!0,this.sceneHasOcludees=!1,this.transparencyPassType=3,this.multipassTerrainEnabled=!1,this.cullAboveGround=!1;}}e$Q([r$12({count:8})],x$j.prototype,"output",void 0),e$Q([r$12({count:3})],x$j.prototype,"cullFace",void 0),e$Q([r$12()],x$j.prototype,"slicePlaneEnabled",void 0),e$Q([r$12()],x$j.prototype,"vertexColors",void 0),e$Q([r$12()],x$j.prototype,"transparent",void 0),e$Q([r$12()],x$j.prototype,"polygonOffset",void 0),e$Q([r$12()],x$j.prototype,"enableOffset",void 0),e$Q([r$12()],x$j.prototype,"writeDepth",void 0),e$Q([r$12()],x$j.prototype,"sceneHasOcludees",void 0),e$Q([r$12({count:4})],x$j.prototype,"transparencyPassType",void 0),e$Q([r$12()],x$j.prototype,"multipassTerrainEnabled",void 0),e$Q([r$12()],x$j.prototype,"cullAboveGround",void 0);

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class o$o extends a$18{constructor(e){super(e,l$n),this.supportsEdges=!0,this.techniqueConfig=new x$j;}getTechniqueConfig(e,t){return this.techniqueConfig.output=e,this.techniqueConfig.cullFace=this.params.cullFace,this.techniqueConfig.vertexColors=this.params.vertexColors,this.techniqueConfig.slicePlaneEnabled=this.params.slicePlaneEnabled,this.techniqueConfig.transparent=this.params.transparent,this.techniqueConfig.polygonOffset=this.params.polygonOffset,this.techniqueConfig.writeDepth=this.params.writeDepth,this.techniqueConfig.sceneHasOcludees=this.params.sceneHasOcludees,this.techniqueConfig.transparencyPassType=t?t.transparencyPassType:3,this.techniqueConfig.enableOffset=!t||t.camera.relativeElevation<f$W,this.techniqueConfig.multipassTerrainEnabled=!!t&&t.multipassTerrainEnabled,this.techniqueConfig.cullAboveGround=!!t&&t.cullAboveGround,this.techniqueConfig}getPassParameters(){return this.params}intersect(e,t,i,s,r,a,u){h$X(e,t,s,r,a,void 0,u);}getGLMaterial(e){return 0===e.output||7===e.output||4===e.output||1===e.output&&this.params.writeLinearDepth?new c$q(e):void 0}createBufferWriter(){return new f$p(i$i)}}class c$q extends t$1i{constructor(e){super(e),this.updateParameters();}updateParameters(e){this._technique=this._techniqueRep.releaseAndAcquire(E$c,this._material.getTechniqueConfig(this._output,e),this._technique);}beginSlot(e){if(4===this._output)return 3===e;return e===(this._technique.configuration.transparent?this._technique.configuration.writeDepth?5:8:3)}_updateOccludeeState(e){e.hasOccludees!==this._material.params.sceneHasOcludees&&this._material.setParameterValues({sceneHasOcludees:e.hasOccludees});}ensureParameters(e){0!==this._output&&7!==this._output||this._updateOccludeeState(e),this.updateParameters(e);}bind(e){this._technique.bindPass(this._material.getPassParameters(),e);}getPipelineState(e,t){return this._technique.getPipelineState(t)}}const l$n={color:[1,1,1,1],transparent:!1,writeDepth:!0,writeLinearDepth:!1,vertexColors:!1,polygonOffset:!1,slicePlaneEnabled:!1,cullFace:0,sceneHasOcludees:!1,...d$$};

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
const p$p=.70710678118,v$h=p$p,u$l=.08715574274;function m$n(m){const f=new n$15;m.draped||f.extensions.add("GL_OES_standard_derivatives");const h=1===m.output;f.include(r$11,{linearDepth:h}),f.include(r$1m,m),f.vertex.uniforms.add("proj","mat4"),f.vertex.uniforms.add("view","mat4"),h&&(f.include(e$14,m),f.vertex.uniforms.add("cameraNearFar","vec2"),f.varyings.add("linearDepth","float")),m.draped?f.vertex.uniforms.add("worldToScreenRatio","float"):(f.vertex.uniforms.add("worldToScreenPerDistanceRatio","float"),f.vertex.uniforms.add("camPos","vec3"),f.attributes.add("boundingRect","mat3")),f.attributes.add("position","vec3"),f.attributes.add("uvMapSpace","vec4"),f.varyings.add("vpos","vec3"),f.varyings.add("vuv","vec2"),m.multipassTerrainEnabled&&f.varyings.add("depth","float");const w=3===m.style||4===m.style||5===m.style;return w&&f.vertex.code.add(t$10`
      const mat2 rotate45 = mat2(${t$10.float(p$p)}, ${t$10.float(-v$h)},
                                 ${t$10.float(v$h)}, ${t$10.float(p$p)});
    `),m.draped||(f.vertex.code.add(t$10`vec3 projectPointToLineSegment(vec3 center, vec3 halfVector, vec3 point) {
float projectedLength = dot(halfVector, point - center) / dot(halfVector, halfVector);
return center + halfVector * clamp(projectedLength, -1.0, 1.0);
}`),f.vertex.code.add(t$10`vec3 intersectRayPlane(vec3 rayDir, vec3 rayOrigin, vec3 planeNormal, vec3 planePoint) {
float d = dot(planeNormal, planePoint);
float t = (d - dot(planeNormal, rayOrigin)) / dot(planeNormal, rayDir);
return rayOrigin + t * rayDir;
}`),f.vertex.code.add(t$10`
      float boundingRectDistanceToCamera() {
        vec3 center = vec3(boundingRect[0][0], boundingRect[0][1], boundingRect[0][2]);
        vec3 halfU = vec3(boundingRect[1][0], boundingRect[1][1], boundingRect[1][2]);
        vec3 halfV = vec3(boundingRect[2][0], boundingRect[2][1], boundingRect[2][2]);
        vec3 n = normalize(cross(halfU, halfV));

        vec3 viewDir = - vec3(view[0][2], view[1][2], view[2][2]);

        float viewAngle = dot(viewDir, n);
        float minViewAngle = ${t$10.float(u$l)};

        if (abs(viewAngle) < minViewAngle) {
          // view direction is (almost) parallel to plane -> clamp it to min angle
          float normalComponent = sign(viewAngle) * minViewAngle - viewAngle;
          viewDir = normalize(viewDir + normalComponent * n);
        }

        // intersect view direction with infinite plane that contains bounding rect
        vec3 planeProjected = intersectRayPlane(viewDir, camPos, n, center);

        // clip to bounds by projecting to u and v line segments individually
        vec3 uProjected = projectPointToLineSegment(center, halfU, planeProjected);
        vec3 vProjected = projectPointToLineSegment(center, halfV, planeProjected);

        // use to calculate the closest point to camera on bounding rect
        vec3 closestPoint = uProjected + vProjected - center;

        return length(closestPoint - camPos);
      }
    `)),f.vertex.code.add(t$10`
    vec2 scaledUV() {
      vec2 uv = uvMapSpace.xy ${w?" * rotate45":""};
      vec2 uvCellOrigin = uvMapSpace.zw ${w?" * rotate45":""};

      ${m.draped?t$10`
            float ratio = worldToScreenRatio;
          `:t$10`
            float distanceToCamera = boundingRectDistanceToCamera();
            float ratio = worldToScreenPerDistanceRatio / distanceToCamera;

            // Logarithmically discretize ratio to avoid jittering
            float step = 0.1;
            ratio = log(ratio);
            ratio = ceil(ratio / step) * step;
            ratio = exp(ratio);
          `}

      vec2 uvOffset = mod(uvCellOrigin * ratio, ${t$10.float(m.patternSpacing)});
      return uvOffset + (uv * ratio);
    }
  `),f.vertex.code.add(t$10`
    void main(void) {
      vuv = scaledUV();
      vpos = position;
      ${m.multipassTerrainEnabled?"depth = (view * vec4(vpos, 1.0)).z;":""}
      forwardNormalizedVertexColor();
      gl_Position = ${h?t$10`transformPositionWithDepth(proj, view, vpos, cameraNearFar, linearDepth);`:t$10`transformPosition(proj, view, vpos);`}
    }
  `),f.include(c$$,m),f.fragment.include(e$U),f.fragment.uniforms.add("matColor","vec4"),m.draped&&f.fragment.uniforms.add("texelSize","float"),4===m.output&&f.include(r$1g),m.multipassTerrainEnabled&&(f.fragment.include(a$15),f.include(r$1j,m)),4!==m.output&&(f.fragment.code.add(t$10`
      const float lineWidth = ${t$10.float(m.lineWidth)};
      const float spacing = ${t$10.float(m.patternSpacing)};
      const float spacingINV = ${t$10.float(1/m.patternSpacing)};

      float coverage(float p, float txlSize) {
        p = mod(p, spacing);

        float halfTxlSize = txlSize / 2.0;

        float start = p - halfTxlSize;
        float end = p + halfTxlSize;

        float coverage = (ceil(end * spacingINV) - floor(start * spacingINV)) * lineWidth;
        coverage -= min(lineWidth, mod(start, spacing));
        coverage -= max(lineWidth - mod(end, spacing), 0.0);

        return coverage / txlSize;
      }
    `),m.draped||f.fragment.code.add(t$10`const int maxSamples = 5;
float sample(float p) {
vec2 dxdy = abs(vec2(dFdx(p), dFdy(p)));
float fwidth = dxdy.x + dxdy.y;
ivec2 samples = 1 + ivec2(clamp(dxdy, 0.0, float(maxSamples - 1)));
vec2 invSamples = 1.0 / vec2(samples);
float accumulator = 0.0;
for (int j = 0; j < maxSamples; j++) {
if(j >= samples.y) {
break;
}
for (int i = 0; i < maxSamples; i++) {
if(i >= samples.x) {
break;
}
vec2 step = vec2(i,j) * invSamples - 0.5;
accumulator += coverage(p + step.x * dxdy.x + step.y * dxdy.y, fwidth);
}
}
accumulator /= float(samples.x * samples.y);
return accumulator;
}`)),f.fragment.code.add(t$10`
    void main() {
      discardBySlice(vpos);
      ${m.multipassTerrainEnabled?"terrainDepthTest(gl_FragCoord, depth);":""}
      vec4 color = ${m.attributeColor?"vColor * matColor;":"matColor;"}
      color = highlightSlice(color, vpos);

      ${4!==m.output?t$10`color.a *= ${g$m(m)};`:""}

      if (color.a < ${t$10.float(o$10)}) {
        discard;
      }

      ${7===m.output?t$10`gl_FragColor = vec4(color.a);`:""}

      ${0===m.output?t$10`gl_FragColor = color; ${m.OITEnabled?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""}`:""}
      ${4===m.output?t$10`outputHighlight();`:""}
      ${1===m.output?t$10`outputDepth(linearDepth);`:""};
    }
  `),f}function g$m(e){function t(t){return e.draped?t$10`coverage(vuv.${t}, texelSize)`:t$10`sample(vuv.${t})`}switch(e.style){case 3:case 0:return t("y");case 4:case 1:return t("x");case 5:case 2:return t$10`
        1.0 - (1.0 - ${t("x")}) * (1.0 - ${t("y")})
      `;default:return "0.0"}}var f$l=Object.freeze({__proto__:null,build:m$n});

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class x$i extends t$11{initializeProgram(e){const t=x$i.shader.get(),r=this.configuration,i=t.build({output:r.output,attributeColor:r.vertexColors,slicePlaneEnabled:r.slicePlaneEnabled,sliceHighlightDisabled:!1,sliceEnabledForVertexPrograms:!1,style:r.style,patternSpacing:r.patternSpacing,lineWidth:r.lineWidth,draped:r.draped,OITEnabled:0===r.transparencyPassType,multipassTerrainEnabled:r.multipassTerrainEnabled,cullAboveGround:r.cullAboveGround});return new n$16(e.rctx,i,W$6)}bindPass(e,t){t$15(this.program,t.camera.projectionMatrix),this.program.setUniform4fv("matColor",e.color),this.configuration.draped?(this.program.setUniform1f("worldToScreenRatio",1/t.screenToWorldRatioGlobalWM),this.program.setUniform1f("texelSize",1/t.camera.pixelRatio)):this.program.setUniform1f("worldToScreenPerDistanceRatio",1/t.camera.perScreenPixelRatio),4===this.configuration.output&&g$V(this.program,t),(1===this.configuration.output||t.multipassTerrainEnabled)&&this.program.setUniform2fv("cameraNearFar",t.camera.nearFar),t.multipassTerrainEnabled&&(this.program.setUniform2fv("inverseViewport",t.inverseViewport),t$1f(this.program,t));}bindDraw(e){a$17(this.program,e),o$12(this.program,e.origin,e.camera.viewInverseTransposeMatrix),l$_(this.program,this.configuration,e),this.program.rebindTextures();}setPipelineState(e,t){const r=this.configuration,i=3===e,o=2===e;return g$S({blending:0===r.output||7===r.output?r.transparent&&i?u$$:c$11(e):null,culling:s$16(r.cullFace),depthTest:{func:a$1d(e)},depthWrite:i?r.writeDepth&&l$$:l$17(e),colorWrite:r$13,stencilWrite:r.sceneHasOcludees?f$T:null,stencilTest:r.sceneHasOcludees?t?t$1k:c$15:null,polygonOffset:i||o?r.polygonOffset&&O$9:s$_(r.enableOffset)})}initializePipeline(){return this._occludeePipelineState=this.setPipelineState(this.configuration.transparencyPassType,!0),this.setPipelineState(this.configuration.transparencyPassType,!1)}getPipelineState(e){return e?this._occludeePipelineState:this.pipeline}}x$i.shader=new t$12(f$l,(()=>import('./Pattern.glsl-f182b509.js')));const O$9={factor:1,units:1};class E$b extends e$S{constructor(){super(...arguments),this.output=0,this.cullFace=0,this.slicePlaneEnabled=!1,this.vertexColors=!1,this.transparent=!0,this.polygonOffset=!1,this.writeDepth=!0,this.sceneHasOcludees=!1,this.enableOffset=!0,this.transparencyPassType=3,this.multipassTerrainEnabled=!1,this.cullAboveGround=!1;}}e$Q([r$12({count:8})],E$b.prototype,"output",void 0),e$Q([r$12({count:3})],E$b.prototype,"cullFace",void 0),e$Q([r$12()],E$b.prototype,"slicePlaneEnabled",void 0),e$Q([r$12()],E$b.prototype,"vertexColors",void 0),e$Q([r$12()],E$b.prototype,"transparent",void 0),e$Q([r$12()],E$b.prototype,"polygonOffset",void 0),e$Q([r$12()],E$b.prototype,"writeDepth",void 0),e$Q([r$12()],E$b.prototype,"sceneHasOcludees",void 0),e$Q([r$12({count:6})],E$b.prototype,"style",void 0),e$Q([r$12()],E$b.prototype,"patternSpacing",void 0),e$Q([r$12()],E$b.prototype,"lineWidth",void 0),e$Q([r$12()],E$b.prototype,"enableOffset",void 0),e$Q([r$12()],E$b.prototype,"draped",void 0),e$Q([r$12({count:4})],E$b.prototype,"transparencyPassType",void 0),e$Q([r$12()],E$b.prototype,"multipassTerrainEnabled",void 0),e$Q([r$12()],E$b.prototype,"cullAboveGround",void 0);const W$6=new Map([["position",0],["color",3],["uvMapSpace",4],["boundingRect",5]]);

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class b$d extends a$18{constructor(e){super(e,P$d),this.supportsEdges=!0,this._vertexAttributeLocations=W$6,this.techniqueConfig=new E$b;}getTechniqueConfig(e,t){return this.techniqueConfig.output=e,this.techniqueConfig.cullFace=this.params.cullFace,this.techniqueConfig.vertexColors=this.params.vertexColors,this.techniqueConfig.slicePlaneEnabled=this.params.slicePlaneEnabled,this.techniqueConfig.polygonOffset=this.params.polygonOffset,this.techniqueConfig.writeDepth=this.params.writeDepth,this.techniqueConfig.style=this.params.style,this.techniqueConfig.patternSpacing=this.params.patternSpacing,this.techniqueConfig.lineWidth=this.params.lineWidth,this.techniqueConfig.draped=this.params.draped,this.techniqueConfig.transparencyPassType=t?t.transparencyPassType:3,this.techniqueConfig.enableOffset=!t||t.camera.relativeElevation<f$W,this.techniqueConfig.multipassTerrainEnabled=!!t&&t.multipassTerrainEnabled,this.techniqueConfig.cullAboveGround=!!t&&t.cullAboveGround,this.techniqueConfig}getPassParameters(){return this.params}intersect(e,t,i,s,r,a,n){h$X(e,t,s,r,a,void 0,n);}getGLMaterial(e){return 0===e.output||7===e.output||4===e.output||1===e.output&&this.params.writeLinearDepth?new C$b(e):void 0}createBufferWriter(){const e=A$u().vec3f("position").vec4u8("color").vec4f("uvMapSpace");return this.params.draped||e.mat3f("boundingRect"),new v$g(e)}}class C$b extends t$1i{constructor(e){super(e),this.updateParameters();}updateParameters(e){this._technique=this._techniqueRep.releaseAndAcquire(x$i,this._material.getTechniqueConfig(this._output,e),this._technique);}beginSlot(e){if(4===this._output)return 3===e;return e===(this._technique.configuration.transparent?this._technique.configuration.writeDepth?5:8:3)}_updateOccludeeState(e){e.hasOccludees!==this._material.params.sceneHasOcludees&&this._material.setParameterValues({sceneHasOcludees:e.hasOccludees});}ensureParameters(e){0!==this._output&&7!==this._output||this._updateOccludeeState(e),this.updateParameters(e);}bind(e){this._technique.bindPass(this._material.getPassParameters(),e);}getPipelineState(e,t){return this._technique.getPipelineState(t)}}class v$g extends f$p{write(r,a,n,o){for(const u of this.vertexBufferLayout.fieldNames){const f=a.vertexAttributes.get(u),d=a.indices.get(u);if(f&&d)switch(u){case"position":{i$R(3===f.size);const e=n.getField(u,i$14);e&&u$Y(d,f.data,r.transformation,e,o);break}case"color":{i$R(3===f.size||4===f.size);const e=n.getField(u,x$T);e&&y$P(d,f.data,f.size,e,o);break}case"uvMapSpace":{i$R(4===f.size);const e=n.getField(u,c$18);e&&c$13(d,f.data,e,o);break}case"boundingRect":{i$R(9===f.size);const t=n.getField(u,l$1a);t&&this.writeBoundingRect(d,f.data,r.transformation,t,o);break}}}}writeBoundingRect(e,t,i,s,r){const a=i,n=s.typedBuffer,o=s.typedBufferStride,u=e.length;r*=o;for(let c=0;c<u;++c){const i=9*e[c],s=t[i],u=t[i+1],h=t[i+2];n[r]=a[0]*s+a[4]*u+a[8]*h+a[12],n[r+1]=a[1]*s+a[5]*u+a[9]*h+a[13],n[r+2]=a[2]*s+a[6]*u+a[10]*h+a[14];for(let e=3;e<9;++e)n[r+e]=t[i+e];r+=o;}}}const P$d={color:[1,1,1,1],writeDepth:!0,writeLinearDepth:!1,vertexColors:!1,polygonOffset:!1,slicePlaneEnabled:!1,cullFace:0,sceneHasOcludees:!1,style:2,patternSpacing:10,lineWidth:1,draped:!0,...d$$};

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
function l$m(r,e,t){return f$k(u$k(r),e,t)}function u$k(r){return r&&r.pattern||null}function f$k(t,a,n){return r$Y(t)?"none"===t.style||"solid"===t.style?("none"===t.style&&(a.color=r$19(0,0,0,0),a.transparent=!0),new o$o(a)):(a.style=m$m(t.style),a.draped=n.isDraped,new b$d(a)):new o$o(a)}function m$m(r){switch(r){case"horizontal":return 0;case"vertical":return 1;case"cross":return 2;case"forward-diagonal":return 3;case"backward-diagonal":return 4;case"diagonal-cross":return 5;default:return}}function p$o(r){return r.material instanceof b$d&&!r.material.params.draped}function d$k(r,e){if(p$o(r)){const o=r.geometry.vertexAttributes,i=o.get("position").data,c=o.get("uvMapSpace").data,l=o.get("boundingRect").data;j$i(c$18.fromTypedArray(c),T$v.fromTypedArray(i),e,a$1k.fromTypedArray(l));}}function g$l(r,e,t,a){const n=f$y(r,e,t,a),s=r.stageObject.geometryRecords;for(let o=0;o<s.length;o++)d$k(s[o],a);return n}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
const F$b=["polyline","polygon","extent"];class I$c extends y$r{constructor(e,t,i,r){super(e,t,i,r),this._needsUV=!1,this._hasOutline=!1;}async doLoad(){}ensureMaterials(){this.ensureFillMaterial(),this.ensureOutlineMaterial();}ensureFillMaterial(){if(r$Y(this._material))return;const e=g$Y(this.symbolLayer,"material","color"),r=this._getCombinedOpacityAndColor(e);this._material=l$m(this.symbolLayer,{color:r,transparent:r[3]<1||this.needsDrivenTransparentPass,polygonOffset:!1,vertexColors:!0,writeLinearDepth:!0,slicePlaneEnabled:this._context.slicePlaneEnabled},{isDraped:this.draped}),this._needsUV=this._material instanceof b$d,this._context.stage.add(this._material);}ensureOutlineMaterial(){const i=this.symbolLayer.outline;if(r$Y(this._outlineMaterial)||!this._isValidOutline(i))return;this._hasOutline=!0;const r=t=>{const r=i.stipplePattern?e$p(i.stipplePattern.map(u$_)):null,n=i.stippleOffColor?o$W.toUnitRGBA(i.stippleOffColor):null;return t>1.5?new M$m({width:t,color:this._getOutlineColor(),polygonOffset:!0,slicePlaneEnabled:this._context.slicePlaneEnabled,isClosed:!0,stipplePattern:r,stippleIntegerRepeats:!0,stippleOffColor:n}):new H$7({color:this._getOutlineColor(),slicePlaneEnabled:this._context.slicePlaneEnabled,width:t,stipplePattern:r,stippleIntegerRepeats:!0,stippleOffColor:n})};this._outlineMaterial=r(u$_(i.size)),this._context.stage.add(this._outlineMaterial);}_isValidOutline(e){return r$Y(e)&&e.size&&e.size>0&&r$Y(e.color)}destroy(){super.destroy(),this._context.stage.remove(this._material),this._material=null,this._context.stage.remove(this._outlineMaterial),this._outlineMaterial=null;}createGraphics3DGraphic(e){const t=e.graphic;if(!this._validateGeometry(t.geometry,F$b,this.symbolLayer.type))return null;const i=this._getVertexOpacityAndColor(e.renderingInfo,255),r=this.setGraphicElevationContext(t,new h$s);return this.ensureDrapedStatus("on-the-ground"===r.mode),this.ensureMaterials(),this.draped?this._createAsOverlay(t,i):this._createAs3DShape(t,i,r)}layerOpacityChanged(){if(r$Y(this._material)){const e=this._material.params.color,t=g$Y(this.symbolLayer,"material","color"),r=this._getCombinedOpacity(t);this._material.setParameterValues({color:[e[0],e[1],e[2],r],transparent:r<1||this.needsDrivenTransparentPass});}if(r$Y(this._outlineMaterial)){const e=this._outlineMaterial.params.color;this._outlineMaterial.setParameterValues({color:[e[0],e[1],e[2],this._getOutlineOpacity()]});}return !0}layerElevationInfoChanged(e,t,i){const r=this._elevationContext.mode,n=d$y(I$c.elevationModeChangeTypes,i,r);if(n!==T$j.UPDATE)return n;const o=p$F(r);return this.updateGraphics3DGraphicElevationInfo(e,t,(()=>o))}slicePlaneEnabledChanged(){if(r$Y(this._material)&&this._material.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled}),r$Y(this._outlineMaterial)){const e={slicePlaneEnabled:this._context.slicePlaneEnabled};this._outlineMaterial.setParameterValues(e);}return !0}physicalBasedRenderingChanged(){return !0}pixelRatioChanged(){return !0}_createAs3DShape(e,t,i){const n=c$w(e.geometry);if(t$17(n))return null;z$8.renderData=l$r(n,this._context.elevationProvider,this._context.renderCoordsHelper,i),z$8.color=t;const o=z$8.renderData.position.length/3;if(this._needsUV&&(z$8.uvMapSpace=new Float32Array(4*o),z$8.boundingRect=new Float64Array(9*o)),z$8.outNum=0,z$8.outGeometries=[],z$8.outTransforms=[],z$8.outMaterials=[],this._createAs3DShapeFill(z$8),this._hasOutline&&this._createAs3DShapeOutline(z$8),this._logGeometryCreationWarnings(z$8.renderData,n.rings,"rings","FillSymbol3DLayer"),0===z$8.outNum)return null;this._needsUV&&j$i(c$18.fromTypedArray(z$8.uvMapSpace),T$v.fromTypedArray(z$8.renderData.position),this._context.renderCoordsHelper,a$1k.fromTypedArray(z$8.boundingRect));const a=new R$p({geometries:z$8.outGeometries,materials:z$8.outMaterials,transformations:z$8.outTransforms,castShadow:!1,metadata:{layerUid:this._context.layer.uid,graphicUid:e.uid}}),s=g$l,l=new m$z(this,a,z$8.outGeometries,null,null,s,i);return l.alignedSampledElevation=z$8.renderData.sampledElevation,l.needsElevationUpdates=p$F(i.mode),l}_createAs3DShapeFill(e){const i=e.renderData.polygons;for(const{position:r,mapPosition:o,holeIndices:l,index:h,count:m}of i){if(r$Y(this._context.clippingExtent)&&(B$n(k$9),M$z(k$9,o),!R$u(k$9,this._context.clippingExtent)))continue;const i=r$1l(o,l,3);if(0===i.length)continue;const d=new Uint32Array(i),_=p$u({indices:d,attributeData:{position:r,color:e.color,mapPosition:o,uvMapSpace:this._needsUV?new Float32Array(e.uvMapSpace.buffer,4*h*e.uvMapSpace.BYTES_PER_ELEMENT,4*m):null,boundingRect:this._needsUV?new Float64Array(e.boundingRect.buffer,9*h*e.boundingRect.BYTES_PER_ELEMENT,9*m):null}});e.outGeometries.push(_),e.outMaterials.push(e$12(this._material)),e.outTransforms.push(a$10),e.outNum++;}}_createAs3DShapeOutline(e){if(!this._hasOutline)return;const i=e.renderData.outlines,r=this._outlineMaterial instanceof H$7;for(let o=0;o<i.length;++o){const{mapPosition:a,position:l}=i[o];if(r$Y(this._context.clippingExtent)&&(B$n(k$9),M$z(k$9,a),!R$u(k$9,this._context.clippingExtent)))continue;const h=b$h({removeDuplicateStartEnd:r?0:1,attributeData:{position:l,mapPosition:a}}),m=h.vertexAttributes.get("position");m.data===l&&(m.data=new Float64Array(l)),e.outGeometries.push(h),e.outMaterials.push(e$12(this._outlineMaterial)),e.outTransforms.push(a$10),e.outNum++;}}_createAsOverlay(e,i){const o=c$w(e.geometry);if(t$17(o))return null;e$12(this._material).renderPriority=this._renderPriority+this._renderPriorityStep/2,r$Y(this._outlineMaterial)&&(this._outlineMaterial.renderPriority=this._renderPriority),Y$5.renderData=m$q(o,this._context.overlaySR),Y$5.color=i;const a=Y$5.renderData.position.length/3;return this._needsUV&&(Y$5.uvMapSpace=new Float32Array(4*a)),Y$5.outNum=0,Y$5.outGeometries=[],Y$5.outBoundingBox=B$n(),Y$5.layerUid=this._context.layer.uid,Y$5.graphicsUid=e.uid,this._createAsOverlayFill(Y$5),this._hasOutline&&this._createAsOverlayOutline(Y$5),this._logGeometryCreationWarnings(Y$5.renderData,o.rings,"rings","FillSymbol3DLayer"),0===Y$5.outNum?null:(this._needsUV&&g$o(c$18.fromTypedArray(Y$5.uvMapSpace),T$v.fromTypedArray(Y$5.renderData.position),this._context.overlaySR),Y$5.outNum>0?new l$q(this,Y$5.outGeometries,Y$5.outBoundingBox):null)}_createAsOverlayFill(e){const t=e.renderData.polygons;for(const{position:i,holeIndices:r,index:o,count:s}of t){if(B$n(k$9),M$z(k$9,i),!R$u(k$9,this._context.clippingExtent))continue;const t=r$1l(i,r,3);if(0===t.length)continue;f$S(e.outBoundingBox,k$9);const m=new Uint32Array(t),d=p$u({indices:m,attributeData:{position:i,color:e.color,uvMapSpace:this._needsUV?new Float32Array(e.uvMapSpace.buffer,4*o*e.uvMapSpace.BYTES_PER_ELEMENT,4*s):null}}),_=new l$p(d,e$12(this._material),e.layerUid,e.graphicsUid),y=k$9;r$17(_.boundingSphere,.5*(y[0]+y[3]),.5*(y[1]+y[4]),0,.5*Math.sqrt((y[3]-y[0])*(y[3]-y[0])+(y[4]-y[1])*(y[4]-y[1]))),e.outGeometries.push(_),e.outNum++;}}_createAsOverlayOutline(e){if(!this._hasOutline)return;const t=e.renderData.outlines;for(let i=0;i<t.length;++i){const{position:r}=t[i];if(B$n(k$9),M$z(k$9,r),!R$u(k$9,this._context.clippingExtent))continue;f$S(e.outBoundingBox,k$9);const o=this._outlineMaterial instanceof H$7,a=b$h({removeDuplicateStartEnd:o?0:1,attributeData:{position:r}}),s=new l$p(a,e$12(this._outlineMaterial),e.layerUid,e.graphicsUid),m=k$9;r$17(s.boundingSphere,.5*(m[0]+m[3]),.5*(m[1]+m[4]),0,.5*Math.sqrt((m[3]-m[0])*(m[3]-m[0])+(m[4]-m[1])*(m[4]-m[1]))),e.outGeometries.push(s),e.outNum++;}}_getOutlineOpacity(){const e=g$Y(this.symbolLayer,"outline","color");return (this.draped?1:this._getLayerOpacity())*(r$Y(e)?e.a:0)}_getOutlineColor(){const r=g$Y(this.symbolLayer,"outline","color"),n=this._getOutlineOpacity();return B$c(r$Y(r)?o$W.toUnitRGB(r):null,n)}get test(){return {createAsOverlay:(e,t)=>this._createAsOverlay(e,t),createAs3DShape:(e,t,i)=>this._createAs3DShape(e,t,i)}}}I$c.elevationModeChangeTypes={definedChanged:T$j.RECREATE,staysOnTheGround:T$j.NONE,onTheGroundChanged:T$j.RECREATE};const k$9=a$1c(),z$8={renderData:null,color:null,uvMapSpace:null,boundingRect:null,outNum:0,outBoundingBox:null,outGeometries:null,outMaterials:null,outTransforms:null},Y$5={renderData:null,color:null,uvMapSpace:null,outNum:0,outBoundingBox:null,outGeometries:null,outMaterials:null,outTransforms:null};

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class s$o{constructor(o){this.definition=o,this.key=JSON.stringify(o),this.haloSize=Math.round(o.halo.size),this.fillStyle=this.colorToRGBA(o.color),this.haloStyle=this.colorToRGB(o.halo.color);}colorToRGB(o){return `rgb(${o.slice(0,3).map((o=>Math.floor(255*o))).toString()})`}colorToRGBA(o){return `rgba(${o.slice(0,3).map((o=>Math.floor(255*o))).toString()},${o[3]})`}static fromSymbol(e,n=1){const a=g$Y(e,"material","color"),f=r$Y(a)?o$W.toUnitRGBA(a):_$q,c=e.halo,h=null!=e.size?u$_(e.size):12,m={family:e.font&&e.font.family?e.font.family:"sans-serif",weight:e.font&&e.font.weight?e.font.weight:"normal",style:e.font&&e.font.style?e.font.style:"normal"},y=r$Y(c)&&r$Y(c.color)&&c.size>0?{size:u$_(c.size),color:o$W.toUnitRGBA(c.color)}:{size:0,color:_$q};return new s$o({size:h,color:f,font:m,halo:y,pixelRatio:n})}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class i$f{constructor(e,t,i=2048){this.text=e,this._parameters=t,this.maxSize=i,this._lineWidths=new Array,this._renderPixelRatio=null,this._displayWidth=null,this.key=`${this._parameters.key}--${e}`,this._lines=e.split(/\r?\n/),this._lineHeight=this.computeLineHeight();}get displayWidth(){return this._ensureTextWidth()}get displayHeight(){return this._lineHeight*this._lines.length}get renderedWidth(){return Math.round(this.displayWidth*this.renderPixelRatio)}get renderedHeight(){return Math.round(this.displayHeight*this.renderPixelRatio)}get renderedLineHeight(){return Math.round(this._lineHeight*this.renderPixelRatio)}get renderedFontSize(){return this._parameters.definition.size*this.renderPixelRatio}get renderedHaloSize(){return this._parameters.haloSize*this.renderPixelRatio}get renderPixelRatio(){if(t$17(this._renderPixelRatio)){const e=this._parameters.definition.pixelRatio;this.maxSize>0?this._renderPixelRatio=Math.min(e,Math.min(this.maxSize/(this.displayWidth*e),this.maxSize/(this.displayHeight*e))):this._renderPixelRatio=e;}return this._renderPixelRatio}getLineXOffset(e){return Math.round((this.renderedWidth-this._lineWidths[e]*this.renderPixelRatio)/2)}render(e,t=0,i=0){const n=this.renderedLineHeight,h=this.renderedHaloSize,a=s$n(e.textAlign,this.renderedWidth)+h,l=h+r$o;e.save(),h>0&&this.renderHalo(e,a,l,t,i),this.setFontProperties(e,this.renderedFontSize),i+=l,t+=a;for(let s=0;s<this._lines.length;++s){e.globalCompositeOperation="destination-out",e.fillStyle="rgb(0, 0, 0)";const r=this._lines[s],h=this.getLineXOffset(s);e.fillText(r,t+h,i),e.globalCompositeOperation="source-over",e.fillStyle=this._parameters.fillStyle,e.fillText(r,t+this.getLineXOffset(s),i),i+=n;}e.restore();}renderHalo(e,t,i,s,r){const n=this.renderedWidth,o=this.renderedHeight,d=h$l(a$m,Math.max(n,l$l),Math.max(o,l$l)),g=d.getContext("2d");g.clearRect(0,0,n,o),this.setFontProperties(g,this.renderedFontSize),g.fillStyle=this._parameters.haloStyle,g.strokeStyle=this._parameters.haloStyle;const p=this.renderedHaloSize<3;g.lineJoin=p?"miter":"round",p?this.renderHaloEmulated(g,t,i):this.renderHaloNative(g,t,i),e.globalAlpha=this._parameters.definition.halo.color[3],e.drawImage(d,0,0,n,o,s,r,n,o),e.globalAlpha=1;}renderHaloEmulated(e,t,i){const s=this.renderedLineHeight,r=this.renderedHaloSize;for(let h=0;h<this._lines.length;++h){const a=this._lines[h],l=this.getLineXOffset(h);for(const[s,h]of n$r)e.fillText(a,t+l+r*s,i+r*h);i+=s;}}renderHaloNative(e,t,i){const s=this.renderedLineHeight,r=this.renderedHaloSize;for(let n=0;n<this._lines.length;++n){const h=2*r,a=this._lines[n],l=this.getLineXOffset(n),o=5,d=.1;for(let s=0;s<o;s++){const r=1-(o-1)*d+s*d;e.lineWidth=r*h,e.strokeText(a,t+l,i);}i+=s;}}setFontProperties(e,t){const i=this._parameters.definition.font,s=`${i.style} ${i.weight} ${t}px ${i.family}, sans-serif`;e.font=s,e.textAlign="left",e.textBaseline="top";}_ensureTextWidth(){if(r$Y(this._displayWidth))return this._displayWidth;const e=h$l(a$m,l$l,l$l).getContext("2d");this.setFontProperties(e,this._parameters.definition.size);let i=0,s=2*this._parameters.haloSize;this._lineWidths.length=0;const r=this._parameters.definition.font;("italic"===r.style||"oblique"===r.style||"string"==typeof r.weight&&("bold"===r.weight||"bolder"===r.weight)||"number"==typeof r.weight&&r.weight>600)&&(s+=.3*e.measureText("A").width);for(const t of this._lines){const r=Math.round(e.measureText(t).width+s);this._lineWidths.push(r),i=Math.max(i,r);}return this._displayWidth=i,this._displayWidth}computeLineHeight(){const e=1.275*this._parameters.definition.size;return Math.ceil(e+2*this._parameters.haloSize)+r$o}}function s$n(e,t){return "center"===e?.5*t:"right"===e?t:0}const r$o=1,n$r=[];{const e=16;for(let t=0;t<360;t+=360/e)n$r.push([Math.cos(Math.PI*t/180),Math.sin(Math.PI*t/180)]);}function h$l(e,t,i){return e.canvas||(e.canvas=document.createElement("canvas")),e.canvas.width=t,e.canvas.height=i,e.canvas}const a$m={canvas:null},l$l=512;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class o$n extends r$1a{constructor(t,r,i){super(),this.type=4,this._glTexture=null,this.events=new n$13,this._requiresPowerOfTwo=!n$1r(t.gl),this._renderer=new i$f(r,i);}get width(){return this._renderer.renderedWidth}get height(){return this._renderer.renderedHeight}get textureWidth(){const e=this.width;return this._requiresPowerOfTwo?i$_(e):e}get textureHeight(){const e=this.height;return this._requiresPowerOfTwo?i$_(e):e}get displayWidth(){return this._renderer.displayWidth}get displayHeight(){return this._renderer.displayHeight}get texcoordScale(){return [this._renderer.renderedWidth/this.textureWidth,this._renderer.renderedHeight/this.textureHeight]}get requiresFrameUpdates(){return !1}createDescriptor(e){return {target:3553,pixelFormat:6408,dataType:5121,wrapMode:33071,flipped:!0,samplingMode:9987,hasMipmap:!0,preMultiplyAlpha:!0,maxAnisotropy:e.parameters.maxMaxAnisotropy}}load(e){if(r$Y(this._glTexture))return this._glTexture;const t=h$l(u$j,this.textureWidth,this.textureHeight),i=t.getContext("2d");return i.save(),this._renderer.render(i,0,this.textureHeight-this._renderer.renderedHeight),this._glTexture=new r$16(e,this.createDescriptor(e),t),i.restore(),this._glTexture}unload(){r$Y(this._glTexture)&&(this._glTexture.dispose(),this._glTexture=null),this.events.emit("unloaded");}}const u$j={canvas:null};

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
const P$c=[0,0,1];class E$a extends y$r{constructor(e,t,r,n){super(e,t,r,n),this._elevationOptions={supportsOffsetAdjustment:!0,supportsOnTheGround:!1},this.ensureDrapedStatus(!1);}async doLoad(){if(!this._drivenProperties.size){const t=O$i(this.symbolLayer.size);if(t)throw new s$Q("graphics3dtextsymbollayer:invalid-size",t)}this._createTextRenderParameters();}_createTextRenderParameters(){const e=this._context.layerView.view.pixelRatio;this._textRenderParameters=s$o.fromSymbol(this.symbolLayer,e);}destroy(){super.destroy();}createGraphics3DGraphic(e){const r=e.graphic,n=d$u(r.geometry);if(t$17(n))return this.logger.warn(`unsupported geometry type for text symbol: ${r.geometry.type}`),null;const s=this.symbolLayer.text;if(!s)return null;const o=o$14(this.symbol)&&this.symbol.hasVisibleVerticalOffset()?this.symbol:null;return this._createAs3DShape(r,n,s,o)}createLabel(e,r,n,s){const o=e.graphic,i=d$u(o.geometry);if(t$17(i))return this.logger.warn(`unsupported geometry type for label: ${o.geometry.type}`),null;const a=r.text;return !a||/^\s+$/.test(a)?null:this._createAs3DShape(o,i,a,r,r,n,s)}setGraphicElevationContext(e,t,r=0){const n=super.setGraphicElevationContext(e,t);return n.addOffsetRenderUnits(r),n}layerOpacityChanged(){return this.logger.warn("layer opacity change not yet implemented in Graphics3DTextSymbolLayer"),!1}layerElevationInfoChanged(e,t){return S$e(e,t,((e,t)=>{this.updateGraphicElevationContext(t,e);})),T$j.UPDATE}slicePlaneEnabledChanged(e,t){return S$e(e,t,(e=>{for(const t of e.stageObject.geometryRecords)t.material.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled});})),!0}physicalBasedRenderingChanged(){return !0}pixelRatioChanged(){return !1}updateGraphicElevationContext(e,t){this.setGraphicElevationContext(e,t.elevationContext,t.metadata.elevationOffset),t.needsElevationUpdates=p$F(t.elevationContext.mode)||"absolute-height"===t.elevationContext.mode;}_defaultElevationInfoNoZ(){return w$g}_createAs3DShape(e,i,l,f,m=j$h,u,v){const E=this.setGraphicElevationContext(e,new h$s,m.elevationOffset),S="polyline"===g$Y(e.geometry,"type"),w=e.uid,_=this._context.stage.renderView.renderingContext,C=m.anchor in q$d?m.anchor:"center",G=q$d[C],L=t$17(v)?new o$n(_,l,this._textRenderParameters):null,D={occlusionTest:!0,screenOffset:m.screenOffset,anchorPos:G,polygonOffset:!0,color:[1,1,1,1],centerOffsetUnits:m.centerOffsetUnits,debugDrawBorder:m.debugDrawBorder,drawInSecondSlot:!0};if(r$Y(L)&&(D.textureId=L.id,D.texCoordScale=L.texcoordScale),r$Y(v)&&(D.textureId=v.id),r$Y(f)&&r$Y(f.verticalOffset)){const{screenLength:e,minWorldLength:t,maxWorldLength:r}=f.verticalOffset;D.verticalOffset={screenLength:u$_(e),minWorldLength:t||0,maxWorldLength:null!=r?r:1/0};}if(this._context.screenSizePerspectiveEnabled){const{screenSizePerspectiveSettings:e,screenSizePerspectiveSettingsLabels:t}=this._context.sharedResources;D.screenSizePerspective=t.overridePadding(this._textRenderParameters.haloSize),D.screenSizePerspectiveAlignment=e;}let U;if(S&&(D.shaderPolygonOffset=1e-4),D.slicePlaneEnabled=this._context.slicePlaneEnabled,r$Y(u)){const e=JSON.stringify(D);U=u.get(e),t$17(U)&&(U=new W$d(D),u.add(e,U));}else U=new W$d(D);const R=[U],z=m.translation,T=r$Y(L)?[L.displayWidth,L.displayHeight]:[0,0],A=m.centerOffset,W=P$c,I=[0,0],V=[P$w.createPointGeometry(W,z,null,T,A,I,null)],B=this._context.layer.uid,H=f$t(this._context,i,V,R,null,null,E,B,w);if(null===H)return null;const $=E$k,N=new m$z(this,H.object,V,t$17(u)?R:null,r$Y(L)?[L]:null,$,E);N.alignedSampledElevation=H.sampledElevation,N.needsElevationUpdates=p$F(E.mode)||"absolute-height"===E.mode;const{displayWidth:k,displayHeight:J}=r$Y(L)?L:m;N.getScreenSize=(e=n$19())=>(e[0]=k,e[1]=J,e);const M={labelText:l,elevationOffset:m.elevationOffset};return N.metadata=M,g$y(N,i,this._context.elevationProvider),N}}function S$e(e,t,r){e&&e.forEach((e=>{const s=t(e);r$Y(s)&&r(s,e.graphic);}));}const w$g={mode:"relative-to-ground",offset:0},j$h={text:null,translation:[0,0,0],elevationOffset:0,centerOffset:[0,0,0,1],screenOffset:[0,0],anchor:"center",verticalOffset:null,centerOffsetUnits:null,debugDrawBorder:!1,displayWidth:0,displayHeight:0};

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class r$n{constructor(e=!0){this.enabled=e,this._time=0;}get time(){return r$Y(this._forcedTime)?this._forcedTime:n$1e(this._time)}advance(e){return this.enabled&&(this._time+=e),t$17(this._forcedTime)&&this.enabled&&0!==e}stopAtTime(e){this._forcedTime=e;}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
const r$m={waveStrength:.06,waveTextureRepeat:32,waveDirection:t$18(1,0),waveVelocity:.05,flowStrength:.015,flowOffset:-.5,animationSpeed:.35,color:[0,0,0,0],transparent:!0,writeDepth:!0,slicePlaneEnabled:!1,isDraped:!1,receiveShadows:!0,ssrEnabled:!1,...d$$},a$l={"calm-small":{waveStrength:.005,perturbationStrength:.02,textureRepeat:12,waveVelocity:.01},"rippled-small":{waveStrength:.02,perturbationStrength:.09,textureRepeat:32,waveVelocity:.07},"slight-small":{waveStrength:.05,perturbationStrength:.07,textureRepeat:28,waveVelocity:.1},"moderate-small":{waveStrength:.075,perturbationStrength:.07,textureRepeat:24,waveVelocity:.1},"calm-medium":{waveStrength:.003125,perturbationStrength:.01,textureRepeat:8,waveVelocity:.02},"rippled-medium":{waveStrength:.035,perturbationStrength:.015,textureRepeat:12,waveVelocity:.07},"slight-medium":{waveStrength:.06,perturbationStrength:.015,textureRepeat:8,waveVelocity:.12},"moderate-medium":{waveStrength:.09,perturbationStrength:.03,textureRepeat:4,waveVelocity:.12},"calm-large":{waveStrength:.01,perturbationStrength:0,textureRepeat:4,waveVelocity:.05},"rippled-large":{waveStrength:.025,perturbationStrength:.01,textureRepeat:8,waveVelocity:.11},"slight-large":{waveStrength:.06,perturbationStrength:.02,textureRepeat:3,waveVelocity:.13},"moderate-large":{waveStrength:.14,perturbationStrength:.03,textureRepeat:2,waveVelocity:.15}};

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class c$p extends a$18{constructor(t){super(t,r$m),this.animation=new r$n,this.techniqueConfig=new R$g;}getTechniqueConfig(e,t){return this.techniqueConfig.output=e,this.techniqueConfig.writeDepth=this.params.writeDepth,this.techniqueConfig.receiveShadows=this.params.receiveShadows,this.techniqueConfig.slicePlaneEnabled=this.params.slicePlaneEnabled,this.techniqueConfig.transparent=this.params.transparent,this.techniqueConfig.useSSR=this.params.ssrEnabled,this.techniqueConfig.isDraped=this.params.isDraped,this.techniqueConfig.transparencyPassType=t?t.transparencyPassType:3,this.techniqueConfig.enableOffset=!t||t.camera.relativeElevation<f$W,this.techniqueConfig.multipassTerrainEnabled=!!t&&t.multipassTerrainEnabled,this.techniqueConfig.cullAboveGround=!!t&&t.cullAboveGround,this.techniqueConfig}update(e){const t=Math.min(e.camera.relativeElevation,e.camera.distance);this.animation.enabled=Math.sqrt(this.params.waveTextureRepeat/this.params.waveStrength)*t<u$i;const i=this.animation.advance(e.dt);return this.animation.enabled&&i}intersect(e,t,i,a,n,r,s){h$X(e,t,a,n,r,void 0,s);}getGLMaterial(e){if(0===e.output&&this.params.isDraped){const t=e;return t.output=5,new a$u(t)}switch(e.output){case 0:case 2:case 4:case 7:return new a$u(e)}}createBufferWriter(){return new f$p(o$r)}}const u$i=35e3;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
const N$9=["polyline","polygon","extent"];class V$7 extends y$r{constructor(e,t,r,o){super(e,t,r,o);}async doLoad(){}destroy(){super.destroy(),this._context.stage.remove(this._material),this._material=null;}createGraphics3DGraphic(e){const t=e.graphic;if(!this._validateGeometry(t.geometry,N$9,this.symbolLayer.type))return null;const r=this.setGraphicElevationContext(t,new h$s);return this.ensureDrapedStatus("on-the-ground"===r.mode),this.ensureMaterial(),this.draped?this._createAsOverlay(t):this._createAs3DShape(t,r,t.uid)}ensureMaterial(){if(r$Y(this._material))return;const r={...r$m},o=this.symbolLayer.color;r$Y(o)&&(r.color=o$W.toUnitRGBA(o));const a=this._getCombinedOpacity(o,{hasIntrinsicColor:!0});r.color=[r.color[0],r.color[1],r.color[2],a],r.transparent=a<1||this.needsDrivenTransparentPass,r.waveDirection=r$Y(this.symbolLayer.waveDirection)?V$7.headingVectorFromAngle(this.symbolLayer.waveDirection):t$18(0,0);const i=this.symbolLayer.waveStrength+"-"+this.symbolLayer.waterbodySize,n=a$l[i];r.waveStrength=n.waveStrength,r.waveTextureRepeat=n.textureRepeat,r.waveVelocity=n.waveVelocity,r.flowStrength=n.perturbationStrength,r.slicePlaneEnabled=this._context.slicePlaneEnabled,r.isDraped=this.draped,this._material=new c$p(r),this._context.stage.add(this._material);}layerOpacityChanged(){if(t$17(this._material))return !0;const e=this._material.params.color,t=this._getCombinedOpacity(this.symbolLayer.color,{hasIntrinsicColor:!0}),o=t<1||this.needsDrivenTransparentPass;return this._material.setParameterValues({color:[e[0],e[1],e[2],t],transparent:o}),!0}layerElevationInfoChanged(e,t,r){const o=this._elevationContext.mode,a=d$y(V$7.elevationModeChangeTypes,r,o);if(a!==T$j.UPDATE)return a;const i=p$F(o);return this.updateGraphics3DGraphicElevationInfo(e,t,(()=>i))}slicePlaneEnabledChanged(){return r$Y(this._material)&&this._material.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled}),!0}physicalBasedRenderingChanged(){return !0}pixelRatioChanged(){return !0}_createAs3DShape(e,t,o){const a=c$w(e.geometry);if(t$17(a))return null;z$7.renderData=l$r(a,this._context.elevationProvider,this._context.renderCoordsHelper,t);const i=z$7.renderData.position.length/3;if(z$7.uvCoords=new Float64Array(2*i),z$7.outNum=0,z$7.outGeometries=[],z$7.outTransforms=[],z$7.outMaterials=[],this._create3DShapeGeometries(z$7),this._logGeometryCreationWarnings(z$7.renderData,a.rings,"rings","WaterSymbol3DLayer"),0===z$7.outNum)return null;this._createUVCoordsFromVertices(z$7.uvCoords,z$7.renderData.mapPosition,i,this._context.elevationProvider.spatialReference);const n=new R$p({geometries:z$7.outGeometries,materials:z$7.outMaterials,transformations:z$7.outTransforms,castShadow:!1,metadata:{layerUid:this._context.layer.uid,graphicUid:o}}),s=f$y,l=new m$z(this,n,z$7.outGeometries,null,null,s,t);return l.alignedSampledElevation=z$7.renderData.sampledElevation,l.needsElevationUpdates=p$F(t.mode),l}_createUVCoordsFromVertices(e,t,r,o){const i=G$m(o);B$m(I$b);for(let a=0;a<r;a++)r$18(W$5,t[3*a+0],t[3*a+1]),f$X(I$b,W$5);l$10(I$b,I$b,i);const n=I$b[0]%V$7.unitSizeOfTexture,l=I$b[1]%V$7.unitSizeOfTexture;F$a[0]=I$b[0]-n,F$a[1]=I$b[1]-l;for(let a=0;a<r;a++)e[2*a+0]=(t[3*a+0]*i-F$a[0])/V$7.unitSizeOfTexture,e[2*a+1]=(t[3*a+1]*i-F$a[1])/V$7.unitSizeOfTexture;}_create3DShapeGeometries(e){const r=e.renderData.polygons,a=e.uvCoords;for(const{count:s,index:l,position:u,mapPosition:c,holeIndices:m}of r){if(r$Y(this._context.clippingExtent)&&(B$n(k$8),M$z(k$8,c),!R$u(k$8,this._context.clippingExtent)))continue;const r=r$1l(c,m,3);if(0===r.length)continue;const h=new Uint32Array(r),y=new Float64Array(a.buffer,2*l*a.BYTES_PER_ELEMENT,2*s),f=u$s({indices:h,attributeData:{position:u,uv0:y,mapPosition:c}});e.outGeometries.push(f),e.outMaterials.push(e$12(this._material)),e.outTransforms.push(a$10),e.outNum++;}}_createAsOverlay(e){const t=c$w(e.geometry);if(t$17(t))return null;e$12(this._material).renderPriority=this._renderPriority,Y$4.renderData=m$q(t,this._context.overlaySR);const a=Y$4.renderData.position.length/3;return Y$4.uvCoords=new Float64Array(2*a),Y$4.outNum=0,Y$4.outGeometries=[],Y$4.outBoundingBox=B$n(),Y$4.layerUid=this._context.layer.uid,Y$4.graphicsUid=e.uid,this._createAsOverlayWater(Y$4),this._logGeometryCreationWarnings(Y$4.renderData,t.rings,"rings","WaterSymbol3DLayer"),0===Y$4.outNum?null:(this._createUVCoordsFromVertices(Y$4.uvCoords,Y$4.renderData.position,a,this._context.overlaySR),Y$4.outNum>0?new l$q(this,Y$4.outGeometries,Y$4.outBoundingBox):null)}_createAsOverlayWater(e){const t=e.uvCoords,r=e.renderData.polygons;for(const{position:a,holeIndices:n,index:s,count:l}of r){if(B$n(k$8),M$z(k$8,a),!R$u(k$8,this._context.clippingExtent))continue;f$S(e.outBoundingBox,k$8);const r=r$1l(a,n,3);if(0===r.length)continue;const u=new Uint32Array(r),c=new Float64Array(t.buffer,2*s*t.BYTES_PER_ELEMENT,2*l),h=u$s({indices:u,attributeData:{position:a,uv0:c}}),f=new l$p(h,e$12(this._material),e.layerUid,e.graphicsUid),_=k$8;r$17(f.boundingSphere,.5*(_[0]+_[3]),.5*(_[1]+_[4]),0,.5*Math.sqrt((_[3]-_[0])*(_[3]-_[0])+(_[4]-_[1])*(_[4]-_[1]))),e.outGeometries.push(f),e.outNum++;}}static headingVectorFromAngle(e){const t=n$19(),r=r$1q(e);return t[0]=Math.sin(r),t[1]=Math.cos(r),t}get test(){return {create3DShape:e=>this._createAs3DShape(e.graphic,e.elevationContext,e.graphicUid),ensureMaterial:()=>this.ensureMaterial()}}}V$7.unitSizeOfTexture=100,V$7.elevationModeChangeTypes={definedChanged:T$j.RECREATE,staysOnTheGround:T$j.NONE,onTheGroundChanged:T$j.RECREATE};const F$a=n$19(),I$b=i$P(),W$5=n$19(),k$8=a$1c(),z$7={renderData:null,uvCoords:null,outNum:0,outBoundingBox:null,outGeometries:null,outMaterials:null,outTransforms:null},Y$4={renderData:null,uvCoords:null,outNum:0,outBoundingBox:null,outGeometries:null,outMaterials:null,outTransforms:null};

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
const c$o=n$12.getLogger("esri.views.3d.layers.graphics.Graphics3DSymbolLayerFactory");function l$k(r,o,e,t){const i=f$j[r.type]&&f$j[r.type][o.type]||n$q[o.type];return i?new i(r,o,e,t):(c$o.error("GraphicsLayerFactory#make",`unknown symbol type ${o.type}`),null)}const n$q={icon:ue$3,object:le$4,line:R$c,path:ee$3,fill:I$c,extrude:N$b,text:E$a,water:V$7};const f$j={"mesh-3d":{fill:ae$3}};

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class c$n extends l$C{constructor(t,e,s){super(e.schedule),this._symbol=t,this._context=e,this._backgroundLayers=s,this._destroyed=!1,this.symbolLayers=[],this.referenced=0,this._extentPadding=0;}set symbol(t){if(this._symbol=t,this.symbolLayers)for(let s=0;s<t.symbolLayers.length;s++){const r=this.symbolLayers[s];t$17(r)||(r.symbol=t,r.symbolLayer=t.symbolLayers.items[s]);}}get symbol(){return this._symbol}async doLoad(e){let r=this._symbol.symbolLayers;this._extentPadding=0,this._backgroundLayers&&(r=this._backgroundLayers.concat(r));const i=r.length;for(;this.symbolLayers.length<r.length;)this.symbolLayers.push(null);this.symbolLayers.length=r.length;const n=[];for(let t=0;t<i;t++){const s=r.getItemAt(t);if(!1===s.enabled)continue;m$l.renderPriority=1-(1+t)/i,m$l.renderPriorityStep=1/i,m$l.ignoreDrivers=s._ignoreDrivers;const a=l$k(this.symbol,s,this._context,m$l);n.push(P$B(e,(()=>{this.symbolLayers[t]=null,a.destroy();}))),this.symbolLayers[t]=a;}await n$1k(this.symbolLayers,(async(t,e)=>{if(r$Y(t))try{await t.load(),this._extentPadding+=Math.max(this._extentPadding,t.extentPadding);}catch{this.symbolLayers[e]=null;}}));for(const t of n)null==t||t.remove();if(n.length=0,a$1i(e),this.symbolLayers.length&&!this.symbolLayers.some((t=>!!t)))throw new Error}getSymbolLayerSize(t){const e=this.symbolLayers[t];return r$Y(e)?e.getCachedSize():null}get extentPadding(){return this._extentPadding}createGraphics3DGraphic(t,e){const r=t.graphic,o=new Array(this.symbolLayers.length);for(let i=0;i<this.symbolLayers.length;i++){const e=this.symbolLayers[i];o[i]=r$Y(e)?e.createGraphics3DGraphic(t):null;}const a=this._context.arcade||this._context.featureExpressionInfoContext&&this._context.featureExpressionInfoContext.arcade&&this._context.featureExpressionInfoContext.arcade.modules||null;return new S$n(r,e||this,o,t.layer,a)}get complexity(){return P$k(this.symbolLayers.map((t=>g$Y(t,"complexity"))))}globalPropertyChanged(t,e){const r=this.symbolLayers.length;for(let o=0;o<r;o++){const r=this.symbolLayers[o],a=t=>{const e=t._graphics[o];return e instanceof m$z?e:null};if(r$Y(r)&&!r.globalPropertyChanged(t,e,a))return !1}return !0}applyRendererDiff(t,s){return 1===this.loadStatus&&this.symbolLayers.reduce(((r,o)=>r&&(t$17(o)||o.applyRendererDiff(t,s))),!0)}prepareSymbolPatch(t){if(2===this.loadStatus)return;if("partial"!==t.diff.type)return;const r=t.diff.diff;if(!r.symbolLayers||"partial"!==r.symbolLayers.type)return;const o=r.symbolLayers.diff;this.symbolLayers.forEach(((r,a)=>{if(t$17(r))return;const i=o[a];if(i){const e={diff:i,graphics3DGraphicPatches:[],symbolLayerStatePatches:[]};r.prepareSymbolLayerPatch(e),t.symbolStatePatches.push(...e.symbolLayerStatePatches),e.graphics3DGraphicPatches.length&&t.graphics3DGraphicPatches.push(((t,r)=>{const o=t._graphics[a];r$Y(o)&&e.graphics3DGraphicPatches.forEach((t=>t(o,r)));}));}}));}updateGeometry(t,s){for(let r=0;r<this.symbolLayers.length;r++){const o=this.symbolLayers[r];if(t$17(o))continue;const a=t._graphics[r];if(t$17(a)||!o.updateGeometry(a,s))return !1}return !0}onRemoveGraphic(t){for(let r=0;r<this.symbolLayers.length;r++){const o=this.symbolLayers[r];if(t$17(o))continue;const a=t._graphics[r];r$Y(a)&&o.onRemoveGraphic(a);}}getFastUpdateStatus(){let t=0,s=0,r=0;return this.symbolLayers.forEach((o=>{t$17(o)||(0===o.loadStatus?t++:o.isFastUpdatesEnabled()?r++:s++);})),{loading:t,slow:s,fast:r}}destroy(){if(this.destroyed)console.error("Graphics3DSymbol.destroy called when already destroyed!");else {this.abortLoad();for(const t of this.symbolLayers)r$Y(t)&&t.destroy();this.symbolLayers.length=0,this._destroyed=!0;}}get destroyed(){return this._destroyed}}const m$l={renderPriority:0,renderPriorityStep:1,ignoreDrivers:!1};

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class i$e extends l$C{constructor(t,r,s){super(r),this.symbol=t,this.convert=s,this.graphics3DSymbol=null,this.referenced=0;}getSymbolLayerSize(r){return r$Y(this.graphics3DSymbol)?this.graphics3DSymbol.getSymbolLayerSize(r):null}get extentPadding(){return r$Y(this.graphics3DSymbol)?this.graphics3DSymbol.extentPadding:0}async doLoad(t){const r=await this.symbol.fetchSymbol({signal:t});r.id=this.symbol.id,this.graphics3DSymbol=this.convert(r),await this.graphics3DSymbol.load();}createGraphics3DGraphic(r){return r$Y(this.graphics3DSymbol)?this.graphics3DSymbol.createGraphics3DGraphic(r,this):null}get complexity(){return r$Y(this.graphics3DSymbol)?this.graphics3DSymbol.complexity:u$y}globalPropertyChanged(r,s){return !!r$Y(this.graphics3DSymbol)&&this.graphics3DSymbol.globalPropertyChanged(r,s)}applyRendererDiff(r,s){return !!r$Y(this.graphics3DSymbol)&&this.graphics3DSymbol.applyRendererDiff(r,s)}prepareSymbolPatch(r){r$Y(this.graphics3DSymbol)&&this.graphics3DSymbol.prepareSymbolPatch(r);}updateGeometry(r,s){return !!r$Y(this.graphics3DSymbol)&&this.graphics3DSymbol.updateGeometry(r,s)}onRemoveGraphic(){}getFastUpdateStatus(){return r$Y(this.graphics3DSymbol)?this.graphics3DSymbol.getFastUpdateStatus():{loading:1,fast:0,slow:0}}destroy(){r$Y(this.graphics3DSymbol)&&this.graphics3DSymbol.destroy(),this.graphics3DSymbol=void 0,this.abortLoad();}get destroyed(){return void 0===this.graphics3DSymbol}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
function i$d(i){return i instanceof i$e?i.graphics3DSymbol:i instanceof c$n?i:null}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
const u$h=n$12.getLogger("esri.views.3d.layers.graphics.labelPlacement");function b$c(e){const r=k$7(e);if(t$17(r))return null;const a=g$k(e,r);if(t$17(a))return null;const c=a.anchor,l=!!r.hasLabelVerticalOffset;return P$b({anchor:c,verticalOffset:r.verticalOffset,screenOffset:n$19(),centerOffset:r$19(0,0,0,-1),centerOffsetUnits:"world",translation:n$11(),elevationOffset:0,hasLabelVerticalOffset:l},a,e)}function g$k(e,t){if(t.anchor)return t;const r=e.labelClass.labelPlacement,n=V$6[r],a=n||y$i(e);return r&&!n&&u$h.warnOncePerTick(`the requested label placement '${r}' is not currently supported in SceneView`),d$j(a,e)}function O$8(e){const t=e.graphics3DGraphic.graphics3DSymbol,n=i$d(t);return r$Y(n)?n.symbol.symbolLayers.getItemAt(0):null}function d$j(e,n){const a=n.graphics3DGraphic.graphic.geometry;if(t$17(a))return null;if(r$Y(n.disablePlacement)){return n.labelClass.labelPlacement?(u$h.warnOncePerTick(v$f(e.placement,n.disablePlacement.logEntityDescription)),y$i(n)):e}const c=a.type;switch(c){case"polyline":case"polygon":case"extent":case"multipoint":if(n.labelClass.labelPlacement)return u$h.warnOncePerTick(v$f(e.placement,`'${c}' geometries`)),y$i(n);break;case"point":case"mesh":return e}return e}function v$f(e,t){return `the requested label placement '${e}' is currently unsupported for ${t} in SceneView`}function y$i(e){const n=e.graphics3DGraphic.graphic.geometry;if(t$17(n))return null;switch(n.type){case"polyline":case"extent":case"multipoint":return {placement:"center-center",normalizedOffset:null,anchor:"center"};case"polygon":{const t=O$8(e);return r$Y(t)&&"extrude"===t.type?V$6["above-center"]:{placement:"center-center",normalizedOffset:null,anchor:"center"}}case"point":case"mesh":return V$6["above-center"];default:return}}function P$b(e,r,n){const a=n.graphics3DGraphic.graphic.geometry;if(t$17(a))return null;switch(a.type){case"point":L$b(e,r,n);break;case"polygon":w$f(e,r,n);break;case"mesh":S$d(e,r,n.graphics3DGraphic._graphics[0]);}return e}function w$f(e,n,c){const l=O$8(c);if(!t$17(l))switch(l.type){case"extrude":{const t=c.graphics3DGraphic._graphics[0];r$Y(t)?(t.getBoundingBoxObjectSpace(T$d),p$1a(T$d,e.translation),e.translation[2]=N$p(T$d)/2):o$S(e.translation,0,0,0),S$d(e,n,t);break}}}function L$b(e,n,c){const l=O$8(c);if(t$17(l))return;const o=c.graphics3DGraphic._graphics[0];switch(r$Y(o)?o.getCenterObjectSpace(e.translation):o$S(e.translation,0,0,0),l.type){case"icon":case"text":z$6(e,n,c,o);break;case"object":S$d(e,n,o);}}function z$6(e,t,n,a){const{graphics3DGraphic:c}=n,l=r$Y(a)?a.getScreenSize():null;if(!c.isDraped&&r$Y(l)){const r=j$g(n);G$7[0]=l[0]/2*(t.normalizedOffset[0]-r[0]),G$7[1]=l[1]/2*(t.normalizedOffset[1]-r[1]),e.screenOffset[0]=G$7[0],e.hasLabelVerticalOffset?(e.centerOffset[1]=G$7[1],e.centerOffsetUnits="screen"):e.screenOffset[1]=G$7[1];}else e.hasLabelVerticalOffset||"center"===e.anchor||(V$6[n.labelClass.labelPlacement]&&u$h.warnOncePerTick(`the requested placement '${t.placement}' is currently unsupported for draped graphics`),e.anchor="center");}function j$g(e,t=B$7){const{graphics3DGraphic:n}=e,a=n._graphics[0],c=r$Y(a)?a.stageObject.geometryRecords[0].material:null;if(c&&c instanceof W$d){const e=c.params.anchorPos;t[0]=2*(e[0]-.5),t[1]=2*(e[1]-.5);}else t[0]=0,t[1]=0;return t}function S$d(e,t,n){const a=r$Y(n)?n.getBoundingBoxObjectSpace(T$d):T$d,o=t$_(a[3]-a[0],a[4]-a[1],a[5]-a[2]),s=Math.sqrt(o[0]*o[0]+o[1]*o[1]);e.centerOffset[0]=s/2*t.normalizedOffset[0];const i=e.translation[2],f=o[2]/2*t.normalizedOffset[1];e.translation[2]=0,e.elevationOffset=i+f;const p=s$P(o);e.centerOffset[2]=p/2*t.normalizedOffset[2];}function D$8(e){switch(e){case"above-center":return !0;default:return !1}}function k$7(e){const t=e.labelClass.labelPlacement,{labelSymbol:n,graphics3DGraphic:a}=e,c=i$d(a.graphics3DSymbol),l=r$Y(c)?c.symbol:null,o=V$6[t]||y$i(e);return "point-3d"===l.type&&l.supportsCallout()&&l.hasVisibleVerticalOffset()&&!a.isDraped?{placement:null,hasLabelVerticalOffset:!1,verticalOffset:C$a(l.verticalOffset),anchor:null,normalizedOffset:null}:!n||!n.hasVisibleVerticalOffset()||"point-3d"===l.type&&l.supportsCallout()&&l.verticalOffset&&!a.isDraped?{placement:null,verticalOffset:null,anchor:null,normalizedOffset:null,hasLabelVerticalOffset:!1}:D$8(o.placement)?{placement:"above-center",verticalOffset:C$a(n.verticalOffset),anchor:"bottom",normalizedOffset:[0,o.normalizedOffset[1],0],hasLabelVerticalOffset:!0}:(u$h.errorOncePerTick("Callouts and vertical offset on labels are currently only supported with 'above-center' label placement (not with "+t+" placement)"),null)}function C$a(e){const{screenLength:t,minWorldLength:r,maxWorldLength:n}=e;return {screenLength:t,minWorldLength:r,maxWorldLength:n}}const V$6={"above-center":{placement:"above-center",normalizedOffset:[0,1,0],anchor:"bottom"},"above-left":{placement:"above-left",normalizedOffset:[-1,1,0],anchor:"bottom-right"},"above-right":{placement:"above-right",normalizedOffset:[1,1,0],anchor:"bottom-left"},"below-center":{placement:"below-center",normalizedOffset:[0,-1,2],anchor:"top"},"below-left":{placement:"below-left",normalizedOffset:[-1,-1,0],anchor:"top-right"},"below-right":{placement:"below-right",normalizedOffset:[1,-1,0],anchor:"top-left"},"center-center":{placement:"center-center",normalizedOffset:[0,0,1],anchor:"center"},"center-left":{placement:"center-left",normalizedOffset:[-1,0,0],anchor:"right"},"center-right":{placement:"center-right",normalizedOffset:[1,0,0],anchor:"left"}},x$h={"above-center":["default","esriServerPointLabelPlacementAboveCenter"],"above-left":["esriServerPointLabelPlacementAboveLeft"],"above-right":["esriServerPointLabelPlacementAboveRight"],"below-center":["esriServerPointLabelPlacementBelowCenter"],"below-left":["esriServerPointLabelPlacementBelowLeft"],"below-right":["esriServerPointLabelPlacementBelowRight"],"center-center":["esriServerPointLabelPlacementCenterCenter"],"center-left":["esriServerPointLabelPlacementCenterLeft"],"center-right":["esriServerPointLabelPlacementCenterRight"]};for(const $ in x$h){const e=x$h[$],t=V$6[$];e.forEach((e=>{V$6[e]=t;}));}Object.freeze&&(Object.freeze(V$6),Object.keys(V$6).forEach((function(e){Object.freeze(V$6[e]),Object.freeze(V$6[e].normalizedOffset);})));const G$7=[0,0],B$7=[0,0],T$d=a$1c();

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class s$m{constructor(s){this._stage=s,this._materials=new Map;}get(s){return this._materials.get(s)}add(s,t){this._materials.set(s,t),this._stage.add(t);}dispose(){this._stage.removeMany(Array.from(this._materials.values())),this._materials.clear();}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
var p$n;const g$j=512,u$g=4096,x$g=.85,T$c=.95;let v$e=p$n=class extends p$14{constructor(e){super(e),this.type=4,this.id=e$Y(),this.events=new n$13,this.glTexture=null,this.needsClear=!1,this.elementsToAddOrUpdate=new Map,this.elementsToRemove=new Map,this.elementsToRender=new Map,this.elements=new Map,this.stageObjects=new Map,this.updating=!1;}initialize(){this.stage=this.view._stage,this.canvas=this.create2DCanvas(),this.ctx=this.canvas.getContext("2d"),this.stage.add(this);const e=this.computeAtlasResolution(this.view.width,this.view.height);this.createAtlasRegion(e),this.update2DCanvasSize(),this.resetAtlasCursor();}unload(){r$Y(this.glTexture)&&(this.glTexture.dispose(),this.glTexture=null),this.events.emit("unloaded");}get width(){return this.atlas.size.width}get height(){return this.atlas.size.height}get requiresFrameUpdates(){return !1}createDescriptor(e){return {target:3553,pixelFormat:6408,dataType:5121,wrapMode:33071,flipped:!0,samplingMode:9987,hasMipmap:!0,preMultiplyAlpha:!0,maxAnisotropy:e.parameters.maxMaxAnisotropy}}load(e){if(r$Y(this.glTexture))return this.glTexture;this.glTexture=new r$16(e,this.createDescriptor(e),this.canvas);const t=this.view.resourceController.scheduler;return this.frameWorker=t.registerTask(p$H.TEXT_TEXTURE_ATLAS,this),this.setDirty(),this.glTexture}dispose(){this.elements=null,this.elementsToAddOrUpdate=null,this.elementsToRemove=null,this.elementsToRender=null,this.frameWorker=s$17(this.frameWorker),this.glTexture&&(this.stage.remove(this),this.glTexture=null),this.canvas.width=0,this.canvas.height=0,this.canvas=null,this.ctx=null;}create2DCanvas(){const e=document.createElement("canvas");return e.setAttribute("id","canvas2d"),e.setAttribute("style","display:none"),e.setAttribute("width",g$j.toString()),e.setAttribute("height",g$j.toString()),e}update2DCanvasSize(){this.canvas.setAttribute("width",this.atlas.size.width.toString()),this.canvas.setAttribute("height",this.atlas.size.height.toString());}createAtlasRegion(e=g$j){this.atlas={size:{width:e,height:e},cursor:{x:0,y:0},lineHeight:0};}computeAtlasResolution(e,t){let s=Math.max(e,t);return s+=256,s=i$_(s),s=Math.min(s,u$g),s}resizeAtlas(e,t){t=t||e;const s=this.atlas;s.size.width=e,s.size.height=t,r$Y(this.glTexture)&&this.glTexture.resize(e,t),this.update2DCanvasSize();}resetAtlasCursor(){const e=this.atlas;e.cursor.x=f$i,e.cursor.y=f$i+y$h,e.lineHeight=0,this.needsClear=!0;}getAtlasUsage(){const e=this.atlas;return (e.cursor.x+e.cursor.y*e.size.width)/(e.size.width*e.size.height)}getExpectedAtlasUsage(){const e=this.elementsToRemove.size,t=this.elementsToAddOrUpdate.size,s=this.elements.size;return this.getAtlasUsage()/s*(s+t-e)}addAtlasElement(e,t,s,i){const r=this.atlas,{renderedWidth:a,renderedHeight:n,displayWidth:h,displayHeight:o}=e.textRenderer;e.placement.offset.x=r.cursor.x,e.placement.offset.y=r.cursor.y,e.placement.size.width=a,e.placement.size.height=n,e.placement.size.displayWidth=h,e.placement.size.displayHeight=o,e.placement.uvMinMax=[e.placement.offset.x/r.size.width,1-(e.placement.offset.y+n)/r.size.height,(e.placement.offset.x+a)/r.size.width,1-e.placement.offset.y/r.size.height],r.cursor.x+=s,r.lineHeight=Math.max(r.lineHeight,i),this.elements.set(t,e);}removeAtlasElement(e){if(e&&this.elements.has(e.textId)){const t=e.placement.offset,s=e.placement.size;this.ctx.clearRect(t.x,t.y,s.width,s.height),this.elements.delete(e.textId);}}ensureStageObjects(e){const t=this.stageObjects.get(e);if(t)return t;const s=new Set;return this.stageObjects.set(e,s),s}addStageObject(e,t){this.ensureStageObjects(e).add(t);}removeStageObject(e,t){const s=this.stageObjects.get(e);s&&s.delete(t)&&(t.geometries[0].vertexAttributes.get("size").data=[0,0],t.geometryVertexAttrsUpdated(0));}_processAddition(e,t){const s=this.atlas,i=e.textId,r=e.textRenderer.renderedWidth,a=e.textRenderer.renderedHeight,n=r+f$i,h=a+f$i+y$h;if(s.cursor.x+n<s.size.width&&s.cursor.y+h<s.size.height)this.addAtlasElement(e,i,n,h),this.elementsToRender.set(i,e),this.elementsToAddOrUpdate.delete(i);else {if(!(s.cursor.y+h+s.lineHeight<s.size.height)){const e=this.getExpectedAtlasUsage(),i=e>x$g&&s.size.width<u$g;return i&&this.resizeAtlas(2*s.size.width,2*s.size.height),!t||!i&&e>T$c&&s.size.width===u$g?(this.processRemovals(),0):(this.repack(),1)}s.cursor.x=f$i,s.cursor.y+=s.lineHeight,s.lineHeight=0,this.addAtlasElement(e,i,n,h),this.elementsToRender.set(i,e),this.elementsToAddOrUpdate.delete(i);}return 0}processRemovals(){this.elementsToRemove.forEach(((e,t)=>{const s=this.stageObjects.get(t);s&&0!==s.size||this.removeAtlasElement(e),s&&0===s.size&&this.stageObjects.delete(t);})),this.elementsToRemove.clear();}repack(){this.processRemovals(),this.elements.forEach(((e,t)=>{e.rendered=!1,this.elementsToAddOrUpdate.set(t,e);})),this.elements.clear(),this.resetAtlasCursor(),this.elementsToRender.clear();}processRenderingRequest(e){this.ctx.clearRect(e.placement.offset.x,e.placement.offset.y,e.placement.size.width,e.placement.size.height),e.textRenderer.render(this.ctx,e.placement.offset.x,e.placement.offset.y);const t=this.stageObjects.get(e.textId);t&&t.forEach((t=>{t.geometries[0].vertexAttributes.get("uv0").data=new Float32Array(e.placement.uvMinMax),t.geometries[0].vertexAttributes.get("size").data=[e.placement.size.displayWidth,e.placement.size.displayHeight],t.geometryVertexAttrsUpdated(0);})),e.rendered=!0;}get running(){return this.updating}runTask(e,t=!0){if(!this.glTexture)return;let s=!1;if(n$1i(this.elementsToAddOrUpdate,((e,i)=>{const r=this.elements.get(i);if(r&&r.rendered){const e=this.stageObjects.get(i);return e&&e.forEach((e=>{const t=e.geometries[0].vertexAttributes,s=this.elements.get(i);t.get("uv0").data=new Float32Array(s.placement.uvMinMax),t.get("size").data=new Float32Array([s.placement.size.displayWidth,s.placement.size.displayHeight]),e.geometryVertexAttrsUpdated(0);})),this.elementsToAddOrUpdate.delete(i),!1}return 1===this._processAddition(this.elementsToAddOrUpdate.get(i),t)&&(s=!0,!0)})),s)return void this.runTask(N$f,!1);let r=!1;this.elementsToRender.size>0&&this.needsClear&&(this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.needsClear=!1),n$1i(this.elementsToRender,((t,s)=>(this.processRenderingRequest(t),this.elementsToRender.delete(s),r=!0,e.madeProgress(),e.done))),r&&r$Y(this.glTexture)&&this.glTexture.setData(this.canvas),this.updating=this.elementsToRender.size>0,!this.updating&&p$n.test.orderedRepackingEnabled&&this.repackOrdered();}addTextTexture(e,t){const s=e.key;this.elementsToAddOrUpdate.has(s)||this.elementsToAddOrUpdate.set(s,{textId:s,placement:{offset:{x:0,y:0},size:{width:0,height:0,displayWidth:0,displayHeight:0},uvMinMax:[]},textRenderer:e,rendered:!1}),this.addStageObject(s,t),this.elementsToRemove.delete(s),this.setDirty();}removeTextTexture(e,t){const s=e.key;this.elementsToRemove.set(s,this.elements.get(s)),this.removeStageObject(s,t);}setDirty(){this.updating=!0;}repackOrdered(){if(0===this.elements.size)return;const e=[];this.elements.forEach(((t,s)=>e.push({element:t,key:s})));let t=!0;for(let s=0;s<e.length-1;s++)if(e[s].key.localeCompare(e[s+1].key)>0){t=!1;break}if(!t||this.elementsToRemove.size){e.sort(((e,t)=>e.key.localeCompare(t.key))),this.elements.clear();for(const{element:t,key:s}of e)this.elements.set(s,t);this.repack(),this.setDirty();}}get test(){const{elements:e,stageObjects:t,elementsToRemove:s,atlas:i}=this,r=this;return {elements:e,stageObjects:t,elementsToRemove:s,atlas:i,resizeAtlas:(e,t)=>r.resizeAtlas(e,t),run:(e,t)=>r.runTask(e,t)}}};v$e.test={orderedRepackingEnabled:!1},e$Q([y$K({constructOnly:!0})],v$e.prototype,"view",void 0),e$Q([y$K({type:Boolean})],v$e.prototype,"updating",void 0),v$e=p$n=e$Q([n$14("esri.views.3d.webgl-engine.lib.TextTextureAtlas")],v$e);const f$i=2,y$h=2;var A$9=v$e;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
const I$a=n$12.getLogger("esri.views.3d.layers.graphics.Labeler");let S$c=class extends p$14{constructor(){super(...arguments),this._dirty=!1,this._labels=new Map,this._labelsToAdd=new Map,this._labelsToRemove=new Map,this._labelingContexts=new Array;}setup(){this.dispose(),this._handles=new u$T,this._handles.add([this.view.watch("state.camera",(()=>this.setDirty())),this.view.watch("pixelRatio",(()=>this._resetAllLabels())),this.view.resourceController.scheduler.registerTask(p$H.LABELER,this)]),this._textTextureAtlas=new A$9({view:this.view}),this._hudMaterialCollection=new s$m(this.view._stage),this._calloutMaterialCollection=new s$m(this.view._stage);}dispose(){this._handles=l$W(this._handles),this._textTextureAtlas=i$S(this._textTextureAtlas),this._hudMaterialCollection=i$S(this._hudMaterialCollection),this._calloutMaterialCollection=i$S(this._calloutMaterialCollection),this._labelingContexts.length=0,this._labels.clear(),this._labelsToAdd.clear(),this._labelsToRemove.clear();}_activateLabelingContext(e){e.labels.forEach(((e,t)=>{this._labels.set(t,e),e.graphics3DGraphic.setVisibilityFlag(0,!0,1);})),e.active=!0;}_deactivateLabelingContext(e){e.labels.forEach(((e,t)=>{e.graphics3DGraphic.setVisibilityFlag(0,!1,1),this.setLabelGraphicVisibility(e.graphics3DGraphic,!1),this._labels.delete(t);})),e.active=!1;}_addLabelTextureToAtlas(e){for(const t of e.graphics3DGraphic.labelGraphics){if(!t._labelClass)continue;const s=e.textRenderers[t._labelIndex];s&&this._textTextureAtlas.addTextTexture(s,t.stageObject);}e.rendered=!0;}_removeLabelTextureFromAtlas(e){for(const t of e.graphics3DGraphic.labelGraphics){if(!t._labelClass)continue;const s=e.textRenderers[t._labelIndex];s&&this._textTextureAtlas.removeTextTexture(s,t.stageObject);}e.rendered=!1;}get running(){var e;return !!this.view.ready&&(this._dirty||(null==(e=this._textTextureAtlas)?void 0:e.updating)||this.deconflictor.running)}runTask(e){this._updateLabels(e),!this._dirty&&this.deconflictor.running&&this.deconflictor.runTask(e);}_updateLabels(e){if(this._dirty){this._dirty=!1;for(const t of this._labelingContexts)if(j$f(t)){if(!E$9(t)){if(V$5(t)){this._deactivateLabelingContext(t);continue}if(this._createLabelClassContext(t),P$a(t)){this._dirty=!0;continue}if(!E$9(t))continue}n$1i(t.labelsToInitialize,((s,l)=>(this._ensureGraphics3DResources(s)&&(this._labels.set(l,s),this.deconflictor.setDirty(),e.madeProgress()),(s.visible&&s.hasTextTextureResources||!s.visible&&s.hasGraphics3DResources)&&(t.labelsToInitialize.delete(l),e.madeProgress()),e.done)))&&(this._dirty=!0);}this._labelsToRemove.forEach((e=>this._removeLabelTextureFromAtlas(e))),this._labelsToAdd.forEach((e=>this._addLabelTextureToAtlas(e))),this._labelsToRemove.clear(),this._labelsToAdd.clear(),this._dirty||this.notifyChange("updating");}}async _createLabelClassContextAsync(e){const t=e.labelClassAbortController.signal;await e.layer.when(),a$1i(t),e.scaleVisibility&&e.scaleVisibility.updateScaleRangeActive();const a=e.graphics3DCore,i=a.layer,r=i.labelingInfo&&i.labelingInfo.filter((e=>!!e.symbol));if(!r||0===r.length)return;const o=new Array(r.length);let n=!1;await n$1k(r,(async(s,i)=>{const r=s.symbol,h=i$d(a.getOrCreateGraphics3DSymbol(r));if(t$17(h))return void I$a.error("Failed to create Graphics3DSymbol for label");await h.load(),a$1i(t);let d=null;o$14(r)&&r.hasVisibleCallout()&&(d=e$z(r,a.symbolCreationContext),await d.load(),a$1i(t));const p=await a$1h(f$Y(s,e.layer.fieldsIndex,this.view.spatialReference));a$1i(t),!0===p.ok?o[i]={labelClass:s,labelFunction:p.value,graphics3DSymbol:h,graphics3DCalloutSymbolLayer:d,calloutSymbolLayerIndex:0,textRenderParameters:this._createTextRenderParameters(h.symbol)}:(I$a.error(`Label expression failed to evaluate: ${p.error}`),n=!0);})),a$1i(t),n||(e.labelClassContexts=o);}async _createLabelClassContext(e){return e.labelClassPromise||(e.labelClassPromise=this._createLabelClassContextAsync(e).catch((t=>{if(g$T(t))throw t;e.labelClassContexts=null;})).then((()=>{e.labelClassAbortController=null,this.notifyChange("updating");})).catch((()=>{})),this.notifyChange("updating")),e.labelClassPromise}_createTextRenderParameters(e){const t=e.symbolLayers.getItemAt(0);return t&&"text"===t.type?s$o.fromSymbol(t,this.view.pixelRatio):null}_destroyLabelClassContext(e){for(const s of e.labelClassContexts)--s.graphics3DSymbol.referenced,s.graphics3DSymbol=null;const t=e.labelClassAbortController;e.labelClassAbortController=h$N(),t&&t.abort(),e.labelClassContexts=[],e.labelClassPromise=null,this.notifyChange("updating");}_createTextSymbolGraphic(e,t,s,l,a){const i={text:e.text,centerOffset:s.centerOffset,translation:s.translation,elevationOffset:s.elevationOffset,screenOffset:s.screenOffset,anchor:s.anchor,centerOffsetUnits:s.centerOffsetUnits,verticalOffset:s.verticalOffset,debugDrawBorder:T$k.LABELS_SHOW_BORDER,displayWidth:e.displayWidth,displayHeight:e.displayHeight};return M$f.graphic=t,M$f.renderingInfo=null,M$f.layer=l,a.createLabel(M$f,i,this._hudMaterialCollection,this._textTextureAtlas)}_createLineCalloutGraphic(e,t,s,l,a){const i={symbol:t,translation:l.translation,elevationOffset:l.elevationOffset,screenOffset:l.screenOffset,centerOffset:l.centerOffset,centerOffsetUnits:l.centerOffsetUnits,materialCollection:this._calloutMaterialCollection};return M$f.graphic=e,M$f.renderingInfo=i,M$f.layer=a,s.createGraphics3DGraphic(M$f)}_ensureGraphics3DResources(e){if(e.hasGraphics3DResources)return !1;const t=e.graphics3DGraphic;if(t.destroyed)return !1;this._ensureTextTextureResources(e);const s=e.labelingContext,l=s.labelClassContexts;if(!l||0===l.length||!s.emptySymbolLabelSupported&&0===t._graphics.length)return !1;let a=!1;const i=t.graphic,r=s.layer,o=a$Z(s.layer),n=this.view._stage;for(let h=0;h<l.length;h++){const b=e.textRenderers[h];if(!b)continue;const d=l[h],p=d.graphics3DSymbol;let u=null;p.symbol&&"label-3d"===p.symbol.type&&(u=p.symbol);const g=p.symbolLayers[0];if(!g)continue;const y=d.labelClass,f=s.disablePlacement,_=b$c({graphics3DGraphic:t,labelSymbol:u,labelClass:y,disablePlacement:f});if(t$17(_))continue;g.setElevationInfoOverride(s.elevationInfoOverride);const m=this._createTextSymbolGraphic(b,i,_,r,g);if(!m)return !1;m._labelClass=y,m._labelIndex=h,t.addLabelGraphic(m,n,s.stageLayer),t.setVisibilityFlag(0,o,1),t.clearVisibilityFlag(1,1),t.setVisibilityFlag(3,!1,1),a=!0;const x=d.graphics3DCalloutSymbolLayer;if(x&&_.hasLabelVerticalOffset){x.setElevationInfoOverride(s.elevationInfoOverride);const e=this._createLineCalloutGraphic(i,u,x,_,r);e&&(d.calloutSymbolLayerIndex=t.labelGraphics.length,t.addLabelGraphic(e,n,s.stageLayer));}break}return s.scaleVisibility&&a&&s.scaleVisibility.updateGraphicLabelScaleVisibility(t),e.hasGraphics3DResources=!0,!0}_destroyGraphics3DResources(e){const t=e.labelingContext.labelClassContexts;for(const s of e.graphics3DGraphic.labelGraphics){if(null==s._labelClass)continue;const e=t[s._labelIndex].graphics3DSymbol.symbolLayers[0];null!=e&&e.onRemoveGraphic(s);}e.graphics3DGraphic.clearLabelGraphics(),e.hasGraphics3DResources=!1;}_ensureTextTextureResources(e){if(e.hasTextTextureResources)return;const t=e.labelingContext,s=t.labelClassContexts;if(!s||0===s.length)return;const l=e.graphics3DGraphic.graphic;for(let i=0;i<s.length;i++){const r=s[i];if(e.textRenderers[i]=null,!r.textRenderParameters)continue;const o=r.labelFunction;let n;if("arcade"===o.type)try{const e=o.needsHydrationToEvaluate()?c$C(l,t.layer):l;n=o.evaluate(e);}catch(a){n=null;}else n=o.evaluate(l);t$17(n)||""===n||/^\s+$/.test(n)||(e.textRenderers[i]=new i$f(n,r.textRenderParameters));}e.hasTextTextureResources=!0;}_destroyTextTextureResources(e){e.textRenderers=[],e.hasTextTextureResources=!1;}_addGraphic(e,t){const s={hasGraphics3DResources:!1,hasTextTextureResources:!1,visible:!1,rendered:!1,labelingContext:e,graphics3DGraphic:t,textRenderers:[]},l=t.graphic.uid;e.labels.set(l,s),e.labelsToInitialize.set(l,s),this.setDirty(),this.deconflictor.setDirty();}_removeGraphic(e,t){const s=t.graphic.uid,l=e.labels.get(s);l&&(this._destroyGraphic(l,s),e.labels.delete(s),e.labelsToInitialize.delete(s),this.setDirty(),this.deconflictor.setDirty());}_destroyGraphic(e,t){this._labels.has(t)&&(this._labels.delete(t),this._labelsToAdd.delete(t),this._labelsToRemove.delete(t)),e.hasTextTextureResources&&(this._removeLabelTextureFromAtlas(e),this._destroyTextTextureResources(e)),e.hasGraphics3DResources&&this._destroyGraphics3DResources(e);}async _labelingInfoChange(e,t){if(!t)return this._visibilityInfoChange(e),this._resetLabels(e),this._createLabelClassContext(e);for(const s of t){const t=e.labels.get(s);t&&(this._removeGraphic(e,t.graphics3DGraphic),this._addGraphic(e,t.graphics3DGraphic));}}_globalPropertyChanged(e,t){for(const s of t.labelClassContexts){const l=new Map;t.labels.forEach((e=>{const t=e.graphics3DGraphic;l.set(t.graphic.uid,t);}));const a=e=>e.labelGraphics[0];if(e$12(s.graphics3DSymbol.symbolLayers[0]).globalPropertyChanged(e,l,a),s.graphics3DCalloutSymbolLayer){const t=e=>e.labelGraphics[s.calloutSymbolLayerIndex];s.graphics3DCalloutSymbolLayer.globalPropertyChanged(e,l,t);}}}_visibilityInfoChange(e){const t=e.layer.labelsVisible;t&&!e.active&&this._activateLabelingContext(e),!t&&e.active&&this._deactivateLabelingContext(e),this.setDirty();}_resetAllLabels(){for(const e of this._labelingContexts)this._resetLabels(e);}_resetLabels(e){e.labels.forEach(((t,s)=>{this._destroyGraphic(t,s),t.visible=!1,t.rendered=!1,e.labelsToInitialize.set(s,t);})),this._destroyLabelClassContext(e),this.setDirty(),this.deconflictor.setDirty();}_findLabelingContext(e){for(const t of this._labelingContexts)if(t.graphics3DCore===e)return t;return null}addGraphicsOwner(e,t,s){const l=s&&s.emptySymbolLabelSupported||!1,a=s&&s.elevationInfoOverride||null,i=s&&s.disablePlacement||null;if(this._findLabelingContext(e))return;const r=e.layer,o={graphics3DCore:e,layer:r,scaleVisibility:t,emptySymbolLabelSupported:l,elevationInfoOverride:a,disablePlacement:i,active:r.labelsVisible,labelClassPromise:null,labelClassAbortController:h$N(),labelClassContexts:[],labels:new Map,labelsToInitialize:new Map,stageLayer:new n$H({isPickable:!0},r.uid)};return this.view._stage.add(o.stageLayer),this._labelingContexts.push(o),this.setDirty(),{addGraphic:e=>this._addGraphic(o,e),removeGraphic:e=>this._removeGraphic(o,e),featureReductionChange:()=>{},layerLabelsEnabled:()=>a$Z(o.layer),labelingInfoChange:e=>this._labelingInfoChange(o,e),elevationInfoChange:()=>this._globalPropertyChanged("elevationInfo",o),slicePlaneEnabledChange:()=>this._globalPropertyChanged("slicePlaneEnabled",o),visibilityInfoChange:()=>this._visibilityInfoChange(o),reset:()=>this._resetLabels(o),clear:()=>{}}}removeGraphicsOwner(e){const t=this._findLabelingContext(e);if(!t)return;const s=this._labelingContexts.indexOf(t);this._labelingContexts.splice(s,1),t.labels.forEach((e=>this._removeGraphic(t,e.graphics3DGraphic))),this.view._stage.remove(t.stageLayer),t.stageLayer=null,this.setDirty();}setLabelGraphicVisibility(e,t){const s=e.graphic.uid,l=this._labels.get(s);l&&l.visible!==t&&(t&&!l.rendered?(this._labelsToAdd.set(s,l),this._labelsToRemove.delete(s),l.hasTextTextureResources||l.labelingContext.labelsToInitialize.set(s,l)):!t&&l.rendered&&(this._labelsToRemove.set(s,l),this._labelsToAdd.delete(s)),l.visible=t,this.setDirty());}setDirty(){!this._dirty&&this._labelingContexts.length>0&&(this._dirty=!0,this.notifyChange("updating"));}get updating(){var e;return this._dirty||(null==(e=this._textTextureAtlas)?void 0:e.updating)||this.deconflictor.updating||this._labelingContexts.some((e=>P$a(e)))}get updatingProgress(){if(!this.updating||!this._textTextureAtlas)return 1;const e=this._labelingContexts.length>0?this._labelingContexts.reduce(((e,t)=>e+(P$a(t)?0:1)),0)/this._labelingContexts.length:1;return (this._dirty?0:.3)+(this._textTextureAtlas.updating?0:.1)+.1*e+.5*this.deconflictor.updatingProgress}get test(){return {textTextureAtlas:this._textTextureAtlas,resetAllLabels:()=>this._resetAllLabels()}}};function j$f(e){return e.active&&a$Z(e.layer)}function P$a(e){return e.labelClassPromise&&!!e.labelClassAbortController}function E$9(e){return e.labelClassContexts&&e.labelClassContexts.length}function V$5(e){return null===e.labelClassContexts}e$Q([y$K({constructOnly:!0})],S$c.prototype,"view",void 0),e$Q([y$K({constructOnly:!0})],S$c.prototype,"deconflictor",void 0),e$Q([y$K()],S$c.prototype,"_textTextureAtlas",void 0),e$Q([y$K({type:Boolean,readOnly:!0})],S$c.prototype,"updating",null),S$c=e$Q([n$14("esri.views.3d.layers.graphics.Labeler")],S$c);const M$f=new r$F(null,null,null);

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class m$k{constructor(){this.gltfCache=new Map,this.wosrCache=new Map,this.evictHandles=new u$T;}loadGLTF(e,t,r){const o=r?`gltfPBR:${e}`:`gltf:${e}`;return this.fromCache(this.gltfCache,o,(t=>l$1e(new n$1s(t.streamDataRequester),e,t,r)),t)}loadWOSR(e,t){const r=`wosr:${e}:${t.disableTextures}`;return this.fromCache(this.wosrCache,r,(t=>x$U(e,t)),t)}destroy(){this.evictHandles.destroy(),this.gltfCache.clear(),this.wosrCache.clear();}get size(){return this.wosrCache.size+this.gltfCache.size}fromCache(e,t,n,l){return new Promise(((c,m)=>{if(b$J(l))return void m(m$Y());const h=v$P(l,(()=>{this.remove(e,t),m(m$Y());})),f=e.get(t);if(f)return this.evictHandles.remove(t),f.refCount++,void f.item.then(c,m);const d=h$N(),C={...l,signal:d.signal},v={refCount:1,abortController:d,item:n(C).then((r=>(v.abortController=null,r.remove=()=>this.remove(e,t),r)))};e.set(t,v),v.item.then((e=>{r$Y(h)&&h.remove(),c(e);}),(e=>{r$Y(h)&&h.remove(),m(e);}));}))}remove(e,o){const s=e.get(o);s&&(s.refCount--,0===s.refCount&&this.evictHandles.add(u$15((()=>{e.delete(o),r$Y(s.abortController)&&s.abortController.abort();}),f$h),o));}}const h$k=1e4;let f$h=h$k;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class t$s{constructor(e,t,s,h=null){this.lij=[0,0,0],this.extent=i$P(),this.resolution=0,this.loadPriority=0,this.measures={visibility:2,screenRect:i$P(),distance:0,shouldSplit:!1},this.used=!1,h&&this.acquire(e,t,s,h);}acquire(i,e,s,h){this.tilingScheme=h,this.id=t$s.id(i,e,s),this.lij[0]=i,this.lij[1]=e,this.lij[2]=s,h.getExtent(i,e,s,this.extent),this.resolution=h.resolutionAtLevel(i);}release(){this.tilingScheme=null;}getChildren(i){const e=this.lij[0]+1,s=2*this.lij[1],h=2*this.lij[2];return i?(i[0].acquire(e,s,h,this.tilingScheme),i[1].acquire(e,s+1,h,this.tilingScheme),i[2].acquire(e,s,h+1,this.tilingScheme),i[3].acquire(e,s+1,h+1,this.tilingScheme),i):[new t$s(e,s,h,this.tilingScheme),new t$s(e,s+1,h,this.tilingScheme),new t$s(e,s,h+1,this.tilingScheme),new t$s(e,s+1,h+1,this.tilingScheme)]}copyMeasurementsFrom(i){this.measures.visibility=i.measures.visibility,this.measures.shouldSplit=i.measures.shouldSplit,this.measures.distance=i.measures.distance,A$y(i.measures.screenRect,this.measures.screenRect);}static id(i,e,t){return `${i}/${e}/${t}`}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class c$m{constructor(t){this.renderCoordsHelper=t,this.frustum=y$B(),this._points=S$w(),this.lines=new Array(12),this._origin=n$11(),this._direction=n$11(),this._altitude=null;for(let i=0;i<12;i++)this.lines[i]={origin:null,direction:n$11(),endpoint:null};}get planes(){return this.frustum}get points(){return this._points}get mutablePoints(){return this._points}get direction(){return this._direction}update(i){x$D(i.viewMatrix,i.projectionMatrix,this.frustum,this._points),r$Z(this._origin,i.eye),r$Z(this._direction,i.viewForward),this._altitude=this.renderCoordsHelper.getAltitude(this._origin),this.updateLines();}updatePoints(i){for(let s=0;s<this._points.length;s++)r$Z(this._points[s],i[s]);O$s(this.frustum,this._points),this.updateLines();}get altitude(){return this._altitude}intersectsSphere(t){return R$n(this.frustum,t)}intersectsRay(t){return d$D(this.frustum,t)}intersectsLineSegment(t,i){return z$l(this.frustum,t,i)}intersectsPoint(t){return A$m(this.frustum,t)}updateLines(){const t=this._points;for(let i=0;i<4;i++){const s=i+4;a$k(this.lines[i],t[i],t[s]),a$k(this.lines[i+4],t[i],3===i?t[0]:t[i+1]),a$k(this.lines[i+8],t[s],3===i?t[4]:t[s+1]);}}}function a$k(t,s,e){t.origin=s,t.endpoint=e,H$m(t.direction,s,e);}c$m.planePointIndices=D$l,c$m.nearFarLineIndices=[[0,4],[1,5],[2,6],[3,7]];

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
const w$e=.5*Math.PI,M$e=w$e/Math.PI*180;class E$8{constructor(t){this.renderCoordsHelper=t.renderCoordsHelper,this.extent=new Array(4),this.planes=new Array(6),this.maxSpan=0,this.center={origin:n$11(),direction:n$11()};for(let e=0;e<4;e++)this.extent[e]={origin:n$11(),direction:n$11(),cap:{next:null,direction:n$11()}},this.planes[e]=p$11();this.planes[4]=p$11(),this.planes[5]=p$11(),this.planesWithoutFar=this.planes.slice(0,5);}update(t,e,i,r=!0){const a=this.extent;this.toRenderBoundingExtent(t,e,i),u$S(this.center.origin,a[0].origin,a[2].origin),d$O(this.center.origin,this.center.origin,.5),this.renderCoordsHelper.worldUpAtPosition(this.center.origin,this.center.direction),r||d$O(this.center.direction,this.center.direction,-1);for(let n=0;n<4;n++){const t=a[n];this.renderCoordsHelper.worldUpAtPosition(t.origin,t.direction);const e=a[3===n?0:n+1];t.cap.next=e.origin,H$m(t.cap.direction,t.origin,e.origin),B$k(t.direction,t.cap.direction,t.origin,this.planes[n]),r||d$O(t.direction,t.direction,-1);}B$k(a[0].cap.direction,a[1].cap.direction,a[0].origin,this.planes[4]),r?A$s(this.planes[4],this.planes[5]):(b$D(this.planes[4],this.planes[5]),A$s(this.planes[4],this.planes[4])),this.maxSpan=Math.max(Math.abs(t[0]-t[2]),Math.abs(t[1]-t[3])),this.maxSpanSpatialReference=e,this.minGlobalAltitude=.9*p$15(this.maxSpanSpatialReference).radius;}isVisibleInFrustum(t,e,i=!1){if(null==t)return !1;if(1===this.renderCoordsHelper.viewingMode){const i=this.maxSpanSpatialReference.isGeographic?M$e:w$e*e;if(this.maxSpan>i)return !0;if(t.altitude>=this.minGlobalAltitude)return this.isVisibleInFrustumGlobal(t)}if(0===this.maxSpan){const e=this.extent[0];return !(i||!t.intersectsRay(d$R(e.origin,e.direction)))}for(let n=0;n<this.extent.length;n++){const e=this.extent[n];if(!i&&t.intersectsRay(d$R(e.origin,e.direction)))return !0;if(t.intersectsLineSegment(l$18(e.origin,e.cap.next,I$9),e.cap.direction))return !0}const r=i?this.planes:this.planesWithoutFar;for(let n=0;n<t.lines.length;n++){const e=t.lines[n];if(h$H(r,e.origin,e.endpoint,e.direction))return !0}return !1}toRenderBoundingExtentGlobal(t,r,n){const o=5;y$T(t,k$6),k$6[2]=n,Sn(r,k$6,A$8,this.renderCoordsHelper.spatialReference),h$L(v$d,A$8),B$n(F$9);for(const{x0:i,x1:s,y0:c,y1:p}of G$6)for(let h=0;h<o;h++){const l=h/(o-1);k$6[0]=m$V(t[i],t[s],l),k$6[1]=m$V(t[c],t[p],l),k$6[2]=n,wn(k$6,r,k$6,this.renderCoordsHelper.spatialReference),I$x(k$6,k$6,v$d),h$V(F$9,k$6);}o$S(this.extent[0].origin,F$9[0],F$9[1],F$9[2]),o$S(this.extent[1].origin,F$9[3],F$9[1],F$9[2]),o$S(this.extent[2].origin,F$9[3],F$9[4],F$9[2]),o$S(this.extent[3].origin,F$9[0],F$9[4],F$9[2]);for(let e=0;e<4;++e)I$x(this.extent[e].origin,this.extent[e].origin,A$8);}toRenderBoundingExtentLocal(t,e){o$S(this.extent[0].origin,t[0],t[1],e),o$S(this.extent[1].origin,t[2],t[1],e),o$S(this.extent[2].origin,t[2],t[3],e),o$S(this.extent[3].origin,t[0],t[3],e);}toRenderBoundingExtent(e,i,r){switch(this.renderCoordsHelper.viewingMode){case 1:this.toRenderBoundingExtentGlobal(e,i,r);break;case 2:this.toRenderBoundingExtentLocal(e,r);break;default:n$1d(this.renderCoordsHelper.viewingMode);}}isVisibleInFrustumGlobal(t){if(z$u(this.center.direction,t.direction)<0)return !0;for(let e=0;e<4;e++){const i=this.extent[e];if(z$u(i.direction,t.direction)<0)return !0}return !1}}const G$6=[{x0:0,y0:1,x1:2,y1:1},{x0:0,y0:3,x1:2,y1:3},{x0:0,y0:1,x1:0,y1:3},{x0:2,y0:1,x1:2,y1:3}],k$6=n$11(),A$8=e$P(),v$d=e$P(),F$9=a$1c(),I$9=v$K();

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class F$8{constructor(e){this.renderCoordsHelper=e,this.surfaceElevation=0,this.cache=new Map,this.frustum=new c$m(e),this.extendedFrustum=new c$m(e),this.intersector=new E$8({renderCoordsHelper:e}),this.renderCoordsHelper=e;}begin(e,t){this.surfaceElevation=t,this.aboveGround=this.renderCoordsHelper.getAltitude(e.eye)>t,this.frustum.update(e),this.shortenFrustumFarPlane(this.frustum),this.updateExtendedFrustum(e);}end(){this.cache.clear();}calculate(e){if(this.allTilesInvisible)return 0;const t=1===this.renderCoordsHelper.viewingMode&&e.lij[0]>=b$b&&e.lij[0]<v$c,i=this.getOrCalculateSingleTileVisibility(e,!t);return 0!==i&&t?this.calculateAggregatedChildrenVisibility(e):i}shortenFrustumFarPlane(e){const t=c$m.nearFarLineIndices,n=e.mutablePoints;for(const o of t){const[e,t]=o,a=n[e],u=n[t];c$V(w$d,u,a),d$O(w$d,w$d,P$9),u$S(n[t],a,w$d);}e.updatePoints(n);}calculateAggregatedChildrenVisibility(e){let t=0;const i=this.cache.get(e.id);if(null!=i)return i;const s=A$7.acquire();e.getChildren(s);for(const r of s){const e=this.calculate(r);if(0!==e&&(t=e,2===e))break}return A$7.release(s),this.cache.set(e.id,t),t}getOrCalculateSingleTileVisibility(e,t){const i=this.cache.get(e.id);if(null!=i)return i;const s=this.calculateSingleTileVisibility(e);return t&&this.cache.set(e.id,s),s}calculateSingleTileVisibility(e){if(!this.aboveGround&&1===this.renderCoordsHelper.viewingMode&&e.lij[0]<x$f){return 0===this.calculateSingleTileVisibilitySided(e,!1)?this.calculateSingleTileVisibilitySided(e,!0):void 0}return this.calculateSingleTileVisibilitySided(e,this.aboveGround)}calculateSingleTileVisibilitySided(e,t){this.intersector.update(e.extent,e.tilingScheme.spatialReference,this.surfaceElevation,t);const i=p$15(e.tilingScheme.spatialReference).radius;return this.intersector.isVisibleInFrustum(this.extendedFrustum,i)?this.intersector.isVisibleInFrustum(this.frustum,i,!0)?2:1:0}updateExtendedFrustum(t){this.extendedFrustum.update(t),this.shortenFrustumFarPlane(this.extendedFrustum);const i=this.renderCoordsHelper.worldUpAtPosition(t.eye,w$d);this.aboveGround||v$N(i,i);const r=x$N(-z$u(i,t.viewForward));if(this.allTilesInvisible=r>(Math.PI+t.fovY)/2,this.allTilesInvisible)return;if(this.hasExtendedFrustum=r>t.fovY/2,!this.hasExtendedFrustum)return;const a=this.extendedFrustumParameters(),u=this.extendedFrustum.mutablePoints;for(let e=0;e<4;e++){const t=a.pointIndices[e],i=u[t],r=this.renderCoordsHelper.getAltitude(i);if(a.needsAltitudeAdjustment(r)){switch(this.renderCoordsHelper.worldUpAtPosition(i,w$d),t){case 4:case 7:case 0:case 3:P$x(this.extendedFrustum.planes[0],w$d,w$d);break;case 5:case 6:case 1:case 2:P$x(this.extendedFrustum.planes[1],w$d,w$d);}d$O(w$d,w$d,a.direction),this.renderCoordsHelper.intersectInfiniteManifold(d$R(i,w$d),a.zWithMargin,i);}}if(this.extendedFrustum.updatePoints(u),M$w(u[0],u[1],u[2],S$b),M$w(u[1],u[2],u[3],y$g),z$u(W$j(S$b),W$j(y$g))<0){const e=this.extendedFrustum.mutablePoints;this.aboveGround?[e[0],e[1]]=[e[1],e[0]]:[e[3],e[2]]=[e[2],e[3]],this.extendedFrustum.updatePoints(e);}}extendedFrustumParameters(){return this.aboveGround?this.extendedFrustumParametersAboveSurface():this.extendedFrustumParametersBelowSurface()}extendedFrustumParametersAboveSurface(){const e=this.surfaceElevation-j$e;return {zWithMargin:e,pointIndices:c$m.planePointIndices.bottom,direction:-1,needsAltitudeAdjustment:t=>t>e}}extendedFrustumParametersBelowSurface(){const e=this.surfaceElevation+j$e;return {zWithMargin:e,pointIndices:c$m.planePointIndices.top,direction:1,needsAltitudeAdjustment:t=>t<e}}}const b$b=2,v$c=6,x$f=12,P$9=.95,j$e=1,w$d=n$11(),S$b=p$11(),y$g=p$11(),A$7=new e$X(Array,(e=>{4!==e.length&&(e[0]=new t$s,e[1]=new t$s,e[2]=new t$s,e[3]=new t$s);}),(e=>{e[0].release(),e[1].release(),e[2].release(),e[3].release();}));

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class j$d{constructor(e){this.camera=new J$g,this.focusOnMap=[0,0],this.screenRect=i$P(),this.tileSize=e.tileSize,this.renderCoordsHelper=e.renderCoordsHelper,this.tilingScheme=e.tilingScheme,this.visibility=new F$8(e.renderCoordsHelper);}begin(e,t,i){this.camera.copyFrom(e),this.surfaceElevation=i,this.focusOnMap[0]=t.x,this.focusOnMap[1]=t.y,u$16(0,0,e.fullWidth,e.fullHeight,this.screenRect),this.visibility.begin(this.camera,i);}end(){this.visibility.end();}updateTile(e){e.measures.visibility=this.visibility.calculate(e),e.measures.distance=k$F(e.extent,this.focusOnMap),0!==e.measures.visibility&&this.updateScreenMeasure(e);}updateScreenMeasure(e){const t=y$f,i=1<<t,s=e.measures.screenRect;B$m(s);let r=0;const o=e.lij[0]+t,n=e.lij[1]<<t,a=e.lij[2]<<t,l=this.tileSizeWithBias(e),h=l*l;for(let c=0;c<i;c++)for(let t=0;t<i;t++)if(r+=this.computeScreenArea(e,o,n+c,a+t,s),r>h)return void(e.measures.shouldSplit=!0);e.measures.shouldSplit=!1;}tileSizeWithBias(e){return 1===e.measures.visibility?this.tileSize*v$b:this.tileSize}computeScreenArea(e,t,i,s,r){const o=1===e.measures.visibility;this.projectToScreen(t,i,s,o,R$b),B$m(g$i);for(let n=0;n<4;n++)f$X(g$i,R$b[n]);return c$14(r,g$i),w$H(g$i,this.screenRect,b$a),b$O(R$b[0],R$b[1],R$b[2])+b$O(R$b[0],R$b[2],R$b[3])}projectToScreen(e,t,i,s,r){this.tilingScheme.ensureMaxLod(e),this.tilingScheme.getExtent(e,t,i,C$9),this.toRenderCoords(C$9,0,3,M$d[0]),this.toRenderCoords(C$9,2,3,M$d[1]),this.toRenderCoords(C$9,2,1,M$d[2]),this.toRenderCoords(C$9,0,1,M$d[3]),s&&(this.projectToPlane(M$d,this.camera.frustum[4]),this.projectToPlane(M$d,this.camera.frustum[3]),this.projectToPlane(M$d,this.camera.frustum[2]));for(let o=0;o<4;o++)this.camera.projectToRenderScreen(M$d[o],z$5),this.camera.renderToScreen(z$5,r[o]);}projectToPlane(e,t){for(let i=0;i<4;i++)x$e[i]=R$s(t,e[i]);const r=Math.max(x$e[0],x$e[1],x$e[2],x$e[3]);if(r>0){const o=d$O(T$b,W$j(t),-r);for(let t=0;t<4;t++)u$S(e[t],e[t],o);}}toRenderCoords(e,t,i,s){return T$b[0]=e[t],T$b[1]=e[i],T$b[2]=this.surfaceElevation,this.renderCoordsHelper.toRenderCoords(T$b,this.tilingScheme.spatialReference,s),s}}const g$i=i$P(),b$a=i$P(),y$f=2,v$b=5,R$b=[i$U(),i$U(),i$U(),i$U()],C$9=i$P(),T$b=n$11(),M$d=[n$11(),n$11(),n$11(),n$11()],x$e=[0,0,0,0],z$5=x$Q();

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
function u$f(l,u,x){if(null==l||t$17(x))return !1;let i=!0;return e$k[0]=null!=l.xmin?l.xmin:0,e$k[1]=null!=l.ymin?l.ymin:0,e$k[2]=null!=l.zmin?l.zmin:0,i=i&&xn(e$k,l.spatialReference,0,u,x,0,1),e$k[0]=null!=l.xmax?l.xmax:0,e$k[1]=null!=l.ymax?l.ymax:0,e$k[2]=null!=l.zmax?l.zmax:0,i=i&&xn(e$k,l.spatialReference,0,u,x,3,1),null==l.xmin&&(u[0]=-1/0),null==l.ymin&&(u[1]=-1/0),null==l.zmin&&(u[2]=-1/0),null==l.xmax&&(u[3]=1/0),null==l.ymax&&(u[4]=1/0),null==l.zmax&&(u[5]=1/0),i}function x$d(n,l,u){if(null==n)return !1;let x=!0;return e$k[0]=null!=n.xmin?n.xmin:0,e$k[1]=null!=n.ymin?n.ymin:0,e$k[2]=null!=n.zmin?n.zmin:0,x=x&&xn(e$k,n.spatialReference,0,e$k,u,0,1),l[0]=e$k[0],l[1]=e$k[1],e$k[0]=null!=n.xmax?n.xmax:0,e$k[1]=null!=n.ymax?n.ymax:0,e$k[2]=null!=n.zmax?n.zmax:0,x=x&&xn(e$k,n.spatialReference,0,e$k,u,0,1),l[2]=e$k[0],l[3]=e$k[1],null==n.xmin&&(l[0]=-1/0),null==n.ymin&&(l[1]=-1/0),null==n.xmax&&(l[2]=1/0),null==n.ymax&&(l[3]=1/0),x}const e$k=n$11();

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
const E$7=n$12.getLogger("esri.views.3d.layers.support.FeatureTileTree3D");let w$c=class extends p$14{constructor(e){super(e),this.tiles=new L$t,this.tileSize=512,this._idToTile=new Map,this._handles=new u$T,this._clients=new Set,this._dirty=!1,this._newTiles=new n$1h;}get tilingScheme(){const e=this.tilingSchemeOwner.tilingScheme;if(!e)return null;return e.clone()}set filterExtent(e){if(e&&!e.spatialReference.equals(this.viewState.spatialReference))return void E$7.error("#extent","extent spatial reference needs to be in the same spatial reference as the view");const t=this._get("filterExtent");if(t===e||t&&e&&t.equals(e))return;const i=e?e.clone():null;this._set("filterExtent",i),this._setDirty();}get filterExtentRect(){if(!this.filterExtent||!this.tilingScheme)return null;const e=i$P();return x$d(this.filterExtent,e,this.tilingScheme.spatialReference),e}get rootTileIds(){return this.filterExtentRect?this.tilingScheme.rootTilesInExtent(this.filterExtentRect):[[0,0,0]]}set suspended(e){e!==this._get("suspended")&&(this._set("suspended",e),this._setDirty());}get updating(){return this._dirty||!!this._pendingTiles}initialize(){this._handles.add(this.watch(["tilingScheme","tileSize"],(()=>this._reset()),!0)),this._handles.add(d$S(this,["tileSize","cameraOnSurface.location","tilingScheme","viewState.contentCamera","focus.location"],(()=>this._setDirty()),!0)),this.scheduler&&(this._frameWorker=this.scheduler.registerTask(p$H.FEATURE_TILE_TREE,this));}destroy(){this._frameWorker=s$17(this._frameWorker),this._handles=l$W(this._handles);}addClient(){const e=R$a();return this._clients.add(e),1===this._clients.size&&this._setDirty(),{remove:()=>this._removeClient(e)}}_removeClient(e){this._clients.delete(e),this._hasClients||this._clear();}get _hasClients(){return this._clients.size>0}_setDirty(){!this._hasClients||this.suspended||this._dirty||(this._frameWorker?(this._dirty=!0,this.notifyChange("updating")):this.runTask(N$f));}_clear(){this.tiles.removeAll(),this._idToTile.clear(),this._reset(),this._dirty=!1,this.notifyChange("updating");}get running(){return this.updating}runTask(e){this._dirty=!1,this._pendingTiles||(this._startUpdate(),r$Y(this._frameWorker)&&(this._frameWorker.priority=p$H.FEATURE_TILE_TREE_ACTIVE)),this._subdivideTilesForView(e),!this._pendingTiles&&r$Y(this._frameWorker)&&(this._frameWorker.priority=p$H.FEATURE_TILE_TREE),this.notifyChange("updating");}_startUpdate(){if(this.suspended)return;if(!this.tilingScheme)return void this._clear();this._tileMeasurements||(this._tileMeasurements=new j$d({renderCoordsHelper:this.renderCoordsHelper,tilingScheme:this.tilingScheme,tileSize:this.tileSize}));const e=this.viewState.contentCamera;this._tileMeasurements.begin(e,this.focus.location,this.cameraOnSurface.location.z),this._pendingTiles=this._getRootTiles();}_reset(){this._newTiles.clear(),this._tileMeasurements=null,this._pendingTiles=null,this._setDirty();}_getRootTiles(){return this.rootTileIds.map((e=>new t$s(e[0],e[1],e[2],this.tilingScheme)))}_purgeHorizonTiles(e){e.sort(((e,t)=>{const i=e.measures.screenRect,s=t.measures.screenRect;return i[1]+i[3]-(s[1]+s[3])})),B$m(C$8);for(let t=0;t<e.length;t++)if(c$14(C$8,e.data[t].measures.screenRect),M$y(C$8)>j$c)return e.data.slice(t,e.length);return []}_subdivideTilesForView(e){if(this._pendingTiles){for(;this._pendingTiles.length>0&&!e.done;){const t=this._pendingTiles.pop();e.madeProgress(),this.filterExtentRect&&!F$A(this.filterExtentRect,t.extent)||(this._tileMeasurements.updateTile(t),0!==t.measures.visibility&&(t.measures.shouldSplit?(this.tilingScheme.ensureMaxLod(t.lij[0]+1),this._pendingTiles.push(...t.getChildren())):this._newTiles.push(t)));}0===this._pendingTiles.length&&(this._updateTiles(this._purgeHorizonTiles(this._newTiles)),this._newTiles.clear(),this._tileMeasurements.end(),this._pendingTiles=null);}}_updateTiles(e){for(const s of this.tiles.items)s.used=!1;const t=e.filter((e=>{const t=this._idToTile.get(e.id);return t?(t.copyMeasurementsFrom(e),t.used=!0):this._idToTile.set(e.id,e),!t})),i=this.tiles.items.filter((e=>!e.used&&(this._idToTile.delete(e.id),!0)));this.tiles.removeMany(i),this.tiles.addMany(t),this.sortTiles();}sortTiles(){this.viewState.fixedContentCamera||this.tiles.sort(((e,t)=>e.measures.visibility!==t.measures.visibility?2===e.measures.visibility?-1:1:e.measures.distance-t.measures.distance)),this.tiles.forEach(((e,t)=>e.loadPriority=t));}};e$Q([y$K({constructOnly:!0})],w$c.prototype,"scheduler",void 0),e$Q([y$K({constructOnly:!0})],w$c.prototype,"renderCoordsHelper",void 0),e$Q([y$K({constructOnly:!0})],w$c.prototype,"tilingSchemeOwner",void 0),e$Q([y$K({constructOnly:!0})],w$c.prototype,"cameraOnSurface",void 0),e$Q([y$K({constructOnly:!0})],w$c.prototype,"focus",void 0),e$Q([y$K({constructOnly:!0})],w$c.prototype,"viewState",void 0),e$Q([y$K({constructOnly:!0})],w$c.prototype,"terrain",void 0),e$Q([y$K()],w$c.prototype,"tiles",void 0),e$Q([y$K()],w$c.prototype,"tileSize",void 0),e$Q([y$K({readOnly:!0})],w$c.prototype,"tilingScheme",null),e$Q([y$K()],w$c.prototype,"filterExtent",null),e$Q([y$K({readOnly:!0})],w$c.prototype,"filterExtentRect",null),e$Q([y$K({readOnly:!0})],w$c.prototype,"rootTileIds",null),e$Q([y$K({value:!1})],w$c.prototype,"suspended",null),e$Q([y$K({readOnly:!0})],w$c.prototype,"updating",null),w$c=e$Q([n$14("esri.views.3d.layers.support.FeatureTileTree3D")],w$c);let x$c=0;function R$a(){return x$c++}const C$8=i$P(),j$c=10;var O$7=w$c;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class o$m{constructor(r,o){this.owner=o,this.properties={},this.afterDispatchHandle=null;for(const t in r){const o=r[t],s=new t$1p(o,null,null,2,2);this.properties[t]={pool:s,acquired:[]};}this.afterDispatchHandle=k$G((()=>this.release()));}destroy(){this.afterDispatchHandle&&(this.afterDispatchHandle.remove(),this.afterDispatchHandle=null);for(const e in this.properties){const t=this.properties[e];for(const e of t.acquired)S$F(e)||t.pool.release(e);t.pool.destroy(),t.pool=null,t.acquired=null;}this.properties=null,this.owner=null;}get(e){const t=this.owner._get(e),r=this.properties[e];let o=r.pool.acquire();for(r.acquired.push(o);o===t;)r.acquired.push(o),o=r.pool.acquire();return o}release(){for(const e in this.properties){const t=this.properties[e];let o=0;for(const e of t.acquired)S$F(e)?t.acquired[o++]=e:t.pool.release(e);t.acquired.length=o;}}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
let g$h=class extends p$14{constructor(){super(...arguments),this._propertiesPool=new o$m({camera:J$g},this),this._lastSeenCameraProjectionValues=new J$g,this.events=new n$13,this.viewingMode=1,this._cameraChanged=!1,this.updateQueue=new Array,this.processingUpdates=!1;}init(e,t){this._set("viewingMode",e),this._set("spatialReference",t),this._set("constraints",new f$K({mode:this.viewingMode}));}exit(){this.cameraController=null,this._propertiesPool.destroy(),this._propertiesPool=new o$m({camera:J$g},this);}createInitialCamera(){if(1===this.viewingMode){const e=p$15(this.spatialReference).radius;this.camera=new J$g(t$_(4*e,0,0),t$_(e,0,0),t$_(0,0,1));}else this.camera=new J$g(t$_(0,0,100),t$_(0,0,0),t$_(0,1,0));}get animation(){return this.cameraController instanceof a$O&&r$Y(this.cameraController.viewAnimation)?this.cameraController.viewAnimation:null}get camera(){return this._get("camera")}set camera(e){e!==y$e&&y$e.copyFrom(e),y$e.computeUp(this.viewingMode),f$g.camera=y$e,this.events.emit("before-camera-change",f$g);const t=this._get("camera");if(this.cameraProjectionChanged(this._lastSeenCameraProjectionValues,y$e)&&(this._lastSeenCameraProjectionValues.copyFrom(y$e),w$b.camera=this._lastSeenCameraProjectionValues,this.events.emit("camera-projection-changed",w$b)),(!t||!t.equals(y$e))&&(this._set("camera",this._propertiesPool.get("camera").copyFrom(y$e)),this._cameraChanged=!t||!t.almostEquals(y$e),this._cameraChanged)){const e=k$G((()=>{this._cameraChanged=!1,e.remove();}));}}get contentCamera(){return r$Y(this._contentCamera)?this._contentCamera:this.camera}set contentCamera(e){this._contentCamera=r$Y(e)?e.clone():null;}get fixedContentCamera(){return !!r$Y(this._contentCamera)}get isGlobal(){return 1===this.viewingMode}get isLocal(){return 2===this.viewingMode}get navigating(){return !(!this.cameraController||!this.cameraController.isInteractive)}get stationary(){return !this._cameraChanged&&!this.navigating}get cameraController(){return this._get("cameraController")}set cameraController(e){this.stopActiveCameraController()?(e&&(e.watch("state",(t=>{t!==o$H.Finished&&t!==o$H.Stopped||(this._set("cameraController",null),this.updateCamera((t=>e.onControllerEnd(t))));}),!0),e.onControllerStart(this.camera)),this._set("cameraController",e)):e&&(e.state=o$H.Rejected);}switchCameraController(e){return this.cameraController=e,e.state!==o$H.Rejected}stopActiveCameraController(){return !(this.cameraController&&!this.cameraController.stopController())}updateCamera(e){this.updateQueue.push(e),this.processUpdateQueue();}processUpdateQueue(){if(0===this.updateQueue.length||this.processingUpdates)return;this.processingUpdates=!0;const e=this.updateQueue.shift();y$e.copyFrom(this._get("camera")),e(y$e),this.camera=y$e,this.processingUpdates=!1,this.processUpdateQueue();}cameraProjectionChanged(e,t){return e.fov!==t.fov||(e.fullViewport[0]!==t.fullViewport[0]||e.fullViewport[1]!==t.fullViewport[1]||e.fullViewport[2]!==t.fullViewport[2]||e.fullViewport[3]!==t.fullViewport[3]||(e.padding[0]!==t.padding[0]||e.padding[1]!==t.padding[1]||e.padding[2]!==t.padding[2]||e.padding[3]!==t.padding[3]))}};e$Q([y$K({readOnly:!0,type:n$1f})],g$h.prototype,"animation",null),e$Q([y$K({type:J$g})],g$h.prototype,"camera",null),e$Q([y$K({})],g$h.prototype,"_contentCamera",void 0),e$Q([y$K({type:J$g})],g$h.prototype,"contentCamera",null),e$Q([y$K({readOnly:!0})],g$h.prototype,"fixedContentCamera",null),e$Q([y$K({readOnly:!0})],g$h.prototype,"constraints",void 0),e$Q([y$K({readOnly:!0})],g$h.prototype,"events",void 0),e$Q([y$K({readOnly:!0})],g$h.prototype,"isGlobal",null),e$Q([y$K({readOnly:!0})],g$h.prototype,"isLocal",null),e$Q([y$K({readOnly:!0})],g$h.prototype,"viewingMode",void 0),e$Q([y$K({readOnly:!0})],g$h.prototype,"spatialReference",void 0),e$Q([y$K({readOnly:!0})],g$h.prototype,"navigating",null),e$Q([y$K({readOnly:!0})],g$h.prototype,"stationary",null),e$Q([y$K()],g$h.prototype,"_cameraChanged",void 0),e$Q([y$K()],g$h.prototype,"cameraController",null),g$h=e$Q([n$14("esri.views.3d.state.ViewState")],g$h);var C$7=g$h;const y$e=new J$g,f$g={camera:null},w$b={camera:null};

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
function h$j(t,e,i){return 1===t?new l$j(i):new c$l(e,i)}class c$l{constructor(t,e){this.elevationProvider=t,this._referenceEllipsoid=p$15(e),this.unitInMeters=G$m(e,this._referenceEllipsoid.metersPerDegree);}compute(i,a,o,m,h){h||(h={near:0,far:0});let c=i[2]*this.unitInMeters;const l=c,M=c-m,v=this.elevationProvider?this.elevationProvider.elevationBounds:null;v&&(c=M>=0?l-this.unitInMeters*v.min:this.unitInMeters*v.max-l);const I={x:o.xmax-o.xmin,y:o.ymax-o.ymin,z:4*Math.max(o.xmax-o.xmin,o.ymax-o.ymin)},E=Math.max(I.x,I.y,I.z);c$V(y$d,a,i),d$i[0]=y$d[0]>0?o.xmax:o.xmin,d$i[1]=y$d[1]>0?o.ymax:o.ymin,d$i[2]=y$d[2]>0?E/2:-E/2,c$V(d$i,d$i,i),j$F(y$d,y$d);const j=1.1*z$u(d$i,y$d)*this.unitInMeters,_=Math.sqrt(c*(c+2*this._referenceEllipsoid.radius)),g=Math.max(o.xmax-o.xmin,o.ymax-o.ymin),P=g*f$f*this.unitInMeters,b=g*p$m*this.unitInMeters;let k=o$R((c-b)/(P-b),0,1);k*=k*k;let q=m$V(_,j,k);return q*=Math.max(Math.log(Math.abs(M)),1),q=Math.min(q,Math.max(34064e4,E)),q/=this.unitInMeters,u$e(q,x$b,this.unitInMeters,h)}}class l$j{constructor(t){this._referenceEllipsoid=p$15(t);}compute(t,i,r,s,n){n||(n={near:0,far:0});const o=s$P(t)-this._referenceEllipsoid.radius,m=this._referenceEllipsoid.radius+Math.min(0,s),h=Math.abs(o-s),c=Math.max(h,Math.abs(o));return u$e(1.2*Math.sqrt(c*(c+2*m)),o$R(2e4-(Math.log(c)-7.983)/9.011*19e3,1e3,2e4),1,n)}}function u$e(t,e,i,r){const s=M$c/i;return t/e>s?(r.far=t,r.near=r.far/e):(r.near=s,r.far=r.near*e),r}const x$b=2e4,M$c=2,f$f=.001,p$m=1e-4,d$i=n$11(),y$d=n$11();

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
let n$p=class extends p$14{constructor(e){super(e),this.handles=new u$T;}initialize(){this.handles.add(this.view.basemapTerrain.on("elevation-change",(e=>this.handleElevationChangeEvent(e))));}destroy(){this.handles&&(this.handles.destroy(),this.handles=null);}handleElevationChangeEvent(e){if(this.view.state.cameraController)return;const t=this.view.state.camera;p$S(this.view,t,e.extent,e.spatialReference)&&this.applyToCurrentCamera();}applyToCurrentCamera(){this.view.state.updateCamera((e=>{i$E(this.view,e,1);}));}};e$Q([y$K({constructOnly:!0})],n$p.prototype,"view",void 0),n$p=e$Q([n$14("esri.views.3d.state.ElevationCollisionConstraint")],n$p);var p$l=n$p;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
let p$k=class extends p$14{constructor(t){super(t),this._handles=new u$T,this.nearFarHeuristic=h$j(t.view.state.viewingMode,t.view.basemapTerrain,t.view.renderCoordsHelper.spatialReference);}initialize(){this._handles.add([this.view.watch(["constraints.clipDistance.near","constraints.clipDistance.far"],(()=>this._clipDistanceNearFarChanged())),this.view.watch("constraints.clipDistance.mode",(()=>this._updateNearFar())),this.view.state.events.on("before-camera-change",(t=>this._updateCameraNearFar(t.camera))),this.view.watch("dataExtent",(()=>this._updateNearFar()),!0),this.view.watch(["constraints.altitude.min","constraints.altitude.max"],(()=>this._updateAltitude()),!0),this.view.watch("constraints.tilt.max",(()=>this._updateTiltMax()),!0),this.view.watch("constraints.tilt.mode",(()=>this._updateTilt()),!0),this.view.watch("state.camera",(()=>this._updateTiltAutoMax()),!0),this.view.watch(["map.ground.navigationConstraint.type","constraints.collision.enabled"],(()=>this._updateCollision()),!0)]),this.view.state.isLocal&&this._handles.add(d$S(this.view,"dataExtent",(t=>this._updateLocalSurfaceDistance(t)))),this._updateNearFar(),2!==this.view.state.viewingMode&&this._updateAltitude(),this._updateTilt(),this._updateCollision(),this._set("surfaceCollisionConstraint",new p$l({view:this.view}));}destroy(){this._handles=l$W(this._handles),this.surfaceCollisionConstraint&&(this.surfaceCollisionConstraint.destroy(),this._set("surfaceCollisionConstraint",null));}_clipDistanceNearFarChanged(){const t=this.view.constraints&&this.view.constraints.clipDistance;t&&"auto"!==t.mode&&this.view.state.updateCamera((a=>(this._updateCameraNearFarManual(a,t),!0)));}_updateNearFar(){this.view.state.updateCamera((t=>(this._updateCameraNearFar(t),!0)));}_updateCameraNearFar(t){const a=this.view.constraints&&this.view.constraints.clipDistance;"manual"===(a?a.mode:"auto")?this._updateCameraNearFarManual(t,a):this._updateCameraNearFarAuto(t,a);}_updateCameraNearFarAuto(t,a){this.nearFarHeuristic.compute(t.eye,t.center,this.view.dataExtent,m$P(this.view,t.eye),t),a&&a.autoUpdate(t.near,t.far);}_updateCameraNearFarManual(t,a){a&&(t.near=a.near,t.far=a.far);}_updateCollision(){var t,a,i;const e=null==(t=this.view.map)||null==(a=t.ground)||null==(i=a.navigationConstraint)?void 0:i.type,s=!e||"stay-above"===e,r=this.view.state.constraints.collision;if(s!==r.enabled){r.enabled=s,s&&this._reapplyConstraints(8);const t=this.view.constraints&&this.view.constraints.tilt;t&&"auto"!==t.mode||this._updateTiltAuto();}}_updateAltitude(){const t=this.view.constraints&&this.view.constraints.altitude;t&&2!==this.view.state.viewingMode?this.view.state.constraints.altitude={min:t.min,max:t.max}:this.view.state.constraints.altitude=null,this._reapplyConstraints();}_updateTiltMax(){const t=this.view.constraints&&this.view.constraints.tilt;t&&"auto"!==t.mode&&(this._updateTiltManual(t),this._reapplyConstraints());}_updateTilt(){const t=this.view.constraints&&this.view.constraints.tilt;"manual"===(t?t.mode:"auto")?this._updateTiltManual(t):this._updateTiltAuto(),this._reapplyConstraints();}_updateTiltManual(t){const a=this.view.state.constraints;a.tilt=a.createConstantMaxTilt(b$F(t.max));}_updateTiltAuto(){const t=this.view.state.constraints;t.tilt=t.createDefaultTilt(),this._updateTiltAutoMax();}_updateTiltAutoMax(){const t=this.view.constraints&&this.view.constraints.tilt;if(!t||"auto"!==t.mode)return;const a=this.view.state.constraints;if(a.tilt){const i=a.tilt(this.view.state.camera.distance).max;t.autoUpdate(N$o(i));}}_updateLocalSurfaceDistance(t){let a=Math.max(t.width,t.height);if(a<=0)return;t.hasZ&&(a=Math.max(a,t.zmax-t.zmin));const i=this.view.state,e=3*a/Math.atan(i.camera.fov/2);e!==i.constraints.distance&&(i.constraints.distance=e);}_reapplyConstraints(t=15){this.view.state.updateCamera((a=>p$Q(this.view,a,{selection:t,interactionType:0,interactionFactor:null,interactionStartCamera:null,interactionDirection:null,tiltMode:0})));}};e$Q([y$K({constructOnly:!0})],p$k.prototype,"view",void 0),e$Q([y$K({readOnly:!0})],p$k.prototype,"surfaceCollisionConstraint",void 0),p$k=e$Q([n$14("esri.views.3d.state.ConstraintsManager")],p$k);var m$j=p$k;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
let p$j=class extends i$z{constructor(e){super(e),this.handles=new u$T;}set desiredCamera(e){this._set("desiredCamera",e.clone());}get canStop(){return !0}get constraintEnabled(){return this.view.state.constraints.collision.enabled}onControllerStart(){this.state=o$H.Running,this.handles.add(this.view.basemapTerrain.on("elevation-change",(e=>this.handleElevationChangeEvent(e)))),this.applyCorrection();}onControllerEnd(){this.handles.removeAll();}stepController(){}handleElevationChangeEvent(e){p$S(this.view,this.desiredCamera,e.extent,e.spatialReference)&&this.applyCorrection();}applyCorrection(){this.view.state.updateCamera((e=>{e.copyViewFrom(this.desiredCamera),i$E(this.view,e,1)||this.constraintEnabled||(this.state=o$H.Stopped);}));}};e$Q([y$K({constructOnly:!0})],p$j.prototype,"view",void 0),e$Q([y$K({constructOnly:!0})],p$j.prototype,"desiredCamera",null),p$j=e$Q([n$14("esri.views.3d.state.controllers.SurfaceCollisionCorrectionController")],p$j);

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
const se$2=.66;function ce$2(e){return 360-U$p.normalize(e)}function le$2(e){return U$p.normalize(360-e)}function me(e){return r$Y(e)&&e.resolver&&e.resolver.reject(),null}function fe(e,t){return r$Y(e)&&e.resolver&&e.resolver.resolve(t),t}function ue$1(e,t,n,r=null){if(!t)return me(r);const a=e.spatialReference||k$x.WGS84;if(r$Y(t.camera)){const e=t.get("camera.position.spatialReference");if(!x$O(e,a))return me(r);const n=t.camera.clone();return e.equals(a)||(n.position=g$11(n.position,a)),fe(r,n)}if(t$17(t.targetGeometry))return me(r);const s=t.get("targetGeometry.spatialReference");if(s&&!x$O(s,a))return me(r);const c=K$f(e,e.state.camera);let l=1;if(null!=t.rotation&&(c.heading=ce$2(t.rotation),l=0),null!=n&&(c.tilt=n),"point"===t.targetGeometry.type){const n=t.targetGeometry;let a;const o=t.targetGeometry.clone();return a=null!=t.scale?Q$f(e,t.scale,n.latitude):e.state.camera.distance,_$j(e,o,a,c,l,r)}const m=t.targetGeometry.extent;return se$a(e,m,c.heading,c.tilt,l,r)}function pe$1(e,t,r=null){return t$17(r)&&(r=new u$17),xe(e,null,t.clone(),r)}async function ge$1(t,r,o){const i=Fe$1(t,r);if(!i)throw new s$Q("viewpointutils-create:no-target","Missing target for creating viewpoint");const s=new d$W({fov:t.camera.fov}),c=new u$17({camera:s});if(i.target instanceof u$17){return Ae$1(await je(t,i.target,i,o,c))}if(i.target instanceof d$W)return Ae$1(Re(t,i.target,c));const l=null!=i.scale||null!=i.zoom;if(i.target instanceof M$x){const e=i.target.xmin===i.target.xmax||i.target.ymin===i.target.ymax;return Ae$1(l||e?await ze$1(t,i,i.target.center,s,o,c):await ke$2(t,i,i.target,s,o,c))}const m={boundingBox:B$n(),hasZ:!1,screenSpaceObjects:[]},f=l?ye(t,i):void 0;if(await be(t,i.target,f,m),isFinite(m.boundingBox[0])){let e;if(p$1a(m.boundingBox,Ue),Ce.x=Ue[0],Ce.y=Ue[1],Ce.z=Ue[2],Ce.spatialReference=t.spatialReference,isFinite(Ce.z)&&m.hasZ?e=S$D(m.boundingBox):(Ce.z=void 0,e=D$u(G$o(m.boundingBox,Ne$2))),l||e)return Ae$1(await ze$1(t,i,Ce,s,o,c));const n=Ee$1(t,m.screenSpaceObjects);return Ae$1(await Ze(t,i,Ce,m.boundingBox,n,s,o,c))}return i.position?Ae$1(Se(t,i,s,c)):Ae$1(await Be$2(t,i,s,o,c))}function he$2(e,t){return null==t.scale&&null!=t.zoom?ye$2(e,t.zoom):t.scale}function ye(e,t){return Re$1(e,he$2(e,t))}function de$1(e,t){let n=!1;return null!=t.heading?(e.heading=t.heading,n=!0):null!=t.rotation&&(e.heading=ce$2(t.rotation),n=!0),null!=t.tilt&&(e.tilt=t.tilt,n=!0),null!=t.fov&&(e.fov=t.fov),n}function xe(e,t,n,r){const a=e.spatialReference||k$x.WGS84;return t=r$Y(t)?t:B$d(e,n),t$17(t)||(r.targetGeometry=dn(t.center,e.renderSpatialReference,a),r.scale=Me$2(e,t),r.rotation=le$2(n.heading),r.camera=n),r}function we(e,t,n){if(!t)return;if(!x$O(t.spatialReference,e.spatialReference))throw new s$Q("viewpointutils:incompatible-spatialreference",`Spatial reference (${t.spatialReference?t.spatialReference.wkid:"unknown"}) is incompatible with the view (${e.spatialReference.wkid})`,{geometry:t});const r=[];if(!t.hasZ&&e.basemapTerrain){let n;switch(t.type){case"point":n=t;break;case"multipoint":case"polyline":n=t.extent.center;break;case"mesh":n=t.origin;break;case"extent":n=t.center;break;case"polygon":n=t.centroid;}n&&x$O(n,e.basemapTerrain.spatialReference)?Ue[2]=c$W(i$O(e.elevationProvider,n),0):Ue[2]=0;}(0, Ye[t.type])(t,(e=>{r.push(e[0],e[1],e[2]);}),Ue);const o=r.length/3;if(0===o)return;const i=new Array(r.length);if(xn(r,t.spatialReference,0,i,e.spatialReference,0,o)){t.hasZ&&(n.hasZ=!0);for(let e=0;e<i.length;e+=3)t.hasZ?(Ue[0]=i[e+0],Ue[1]=i[e+1],Ue[2]=i[e+2]):(Ue[0]=i[e+0],Ue[1]=i[e+1]),h$V(n.boundingBox,Ue);}}async function ve(e,t,n,a){const o=await a$1h(e.whenViewForGraphic(t));if(!1===o.ok||t$17(o.value)||!("whenGraphicBounds"in o.value))return void we(e,t.geometry,a);const s=o.value,c=await a$1h(s.whenGraphicBounds(t,{minDemResolution:n}));if(!1===c.ok)return void we(e,t.geometry,a);const{screenSpaceObjects:l,boundingBox:m}=c.value;f$S(a.boundingBox,m),l&&l.forEach((e=>{a.screenSpaceObjects.push(e);})),isFinite(m[2])&&(a.hasZ=!0);}async function be(e,n,r,a){if(Array.isArray(n)&&2===n.length){const t=n[0],r=n[1];if("number"==typeof t&&"number"==typeof r)return Ce.x=t,Ce.y=r,Ce.z=void 0,Ce.spatialReference=e.spatialReference.isGeographic?e.spatialReference:k$x.WGS84,void we(e,Ce,a)}n&&"function"==typeof n.map?await A$C(n.map((t=>be(e,t,r,a)))):n instanceof p$1c?we(e,n,a):n instanceof h$R&&await ve(e,n,r,a);}async function je(e,t,n,r,a){if(r$Y(t.camera))return Re(e,t.camera,a);a.scale=t.scale,a.rotation=t.rotation,a.targetGeometry=r$Y(t.targetGeometry)?t.targetGeometry.clone():null,a.camera=null,null!=n.heading?a.rotation=le$2(n.heading):null!=n.rotation&&(a.rotation=n.rotation);const i=he$2(e,n);null!=i&&(a.scale=i);const s=new je$1(r);return ue$1(e,a,n.tilt,s),a.camera=await s.resolver.promise,a}function Re(e,t,n){const r=e.spatialReference,a=t.position.spatialReference;return x$O(a,r)?((t=t.clone()).fov=e.camera.fov,a.equals(r)||(t.position=g$11(t.position,r)),xe(e,null,t,n)):null}function Ge$1(e,t,n,r,a,o){const i=e.renderSpatialReference;return Rn(n.position,qe$2,i),Rn(t,Ve$1,i),o.targetGeometry=new b$G(t),a.position=new b$G(n.position),c$V(Oe$1,Ve$1,qe$2),ee$9(e,qe$2,Oe$1,r.up,a),o.scale=V$f(e,q$o(qe$2,Ve$1),o.targetGeometry.latitude),o.rotation=le$2(a.heading),o.camera=a,o}async function ze$1(e,t,n,r,o,s){if(t$17(n))throw new s$Q("createfromcenter","invalid point");s.targetGeometry=n.clone();const c=g$J(e);if(t.position)return Ge$1(e,s.targetGeometry,t,c,r,s);if(t.zoomFactor){const r=c.distance/t.zoomFactor,a=d$O(Ue,c.viewForward,-r);c.eye=u$S(Ue,c.center,a),s.scale=V$f(e,r,n.latitude);}K$f(e,c,r);const l=de$1(r,t)?0:1;if(!t.zoomFactor){s.scale=he$2(e,t),null==s.scale&&(Rn(n,Ue,e.renderSpatialReference),A$m(c.frustum,Ue)?s.scale=V$f(e,q$o(c.eye,Ue),n.latitude):s.scale=Me$2(e,c));const a=new je$1(o);$$g(e,s.targetGeometry,s.scale,r,l,a),s.camera=await a.resolver.promise;}return s}function Se(e,t,n,r){const a=g$J(e);return r$Z(Oe$1,a.viewForward),ee$9(e,a.eye,Oe$1,a.up,We$1),n.position=new b$G(t.position),n.heading=null!=t.heading?t.heading:We$1.heading,n.tilt=null!=t.tilt?t.tilt:We$1.tilt,xe(e,null,n,r)}async function Be$2(e,t,n,r,a){const o=g$J(e);return ze$1(e,t,dn(o.center,e.renderSpatialReference,e.spatialReference),n,r,a)}async function ke$2(e,t,n,r,a,o){o.targetGeometry=n.clone();const i=g$J(e);K$f(e,i,r);const s=de$1(r,t)?0:1,c=new je$1(a);return se$a(e,n,r.heading,r.tilt,s,c),o.camera=await c.resolver.promise,o}function Me$1(e,t,n,r,a){let o=0;n.hasZ?o=n.z:e.basemapTerrain&&(o=e$12(i$O(e.elevationProvider,n))),o$S(Ue,n.x,n.y,o),Sn(e.spatialReference,Ue,Pe,e.renderSpatialReference),a$19(Te,Pe),o$Z(Te,Te),B$n(Ie$1);const i=[[0,1,2],[3,1,2],[0,4,2],[3,4,2],[0,1,5],[3,1,5],[0,4,5],[3,4,5]];for(let c=0;c<i.length;c++){const t=i[c];let n=r[t[2]];isFinite(n)||(n=o),o$S(Ue,r[t[0]],r[t[1]],n),wn(Ue,e.spatialReference,Ue,e.renderSpatialReference),h$V(Ie$1,L$u(Ue,Ue,Te));}const s=I$B(Ie$1),l=N$p(Ie$1),u=y$U(Ie$1),p=1/Math.tan(t.fovX/2),g=1/Math.tan(t.fovY/2),h=.5*Math.sqrt(s*s+u*u)*Math.max(g,p)+.5*l,y=.5*l*g+.5*Math.max(s,u);return Math.max(h,y)/a}async function Ze(e,t,n,r,a,o,i,s){s.targetGeometry=n.clone();const c=g$J(e),l=Me$1(e,c,n,r,a);K$f(e,c,o);const m=de$1(o,t)?0:1;s.scale=V$f(e,l,s.targetGeometry.latitude);const f=new je$1(i);return $$g(e,s.targetGeometry,s.scale,o,m,f),s.camera=await f.resolver.promise,s}function Fe$1(e,t){if(!t||!e.spatialReference)return null;const n={target:null};if("declaredClass"in t||Array.isArray(t))n.target=t;else {for(const e in t)n[e]=t[e];t.center&&!n.target&&(n.target=t.center);}return n}function Ae$1(e){return e&&r$Y(e.camera)&&(e.rotation=le$2(e.camera.heading)),e}function Ee$1(e,t){const n=se$2;if(!t.length)return n;let r=Number.NEGATIVE_INFINITY;for(let a=0;a<t.length;a++){const e=t[a].screenSpaceBoundingRect;r=Math.max(r,Math.abs(e[0]),Math.abs(e[1]),Math.abs(e[2]),Math.abs(e[3]));}return n-r/Math.min(e.width,e.height)*2}const Ue=n$11(),Pe=e$P(),Te=e$Z(),Ie$1=a$1c(),Ne$2=i$P(),Oe$1=n$11(),qe$2=n$11(),Ve$1=n$11(),We$1={heading:0,tilt:0},Ce=new b$G,Ye={point(e,t,n){n[0]=e.x,n[1]=e.y,e.hasZ&&(n[2]=e.z),t(n);},polygon(e,t,n){const r=e.hasZ;for(let a=0;a<e.rings.length;a++){const o=e.rings[a];for(let e=0;e<o.length;e++)n[0]=o[e][0],n[1]=o[e][1],r&&(n[2]=o[e][2]),t(n);}},polyline(e,t,n){const r=e.hasZ;for(let a=0;a<e.paths.length;a++){const o=e.paths[a];for(let e=0;e<o.length;e++)n[0]=o[e][0],n[1]=o[e][1],r&&(n[2]=o[e][2]),t(n);}},multipoint(e,t,n){const r=e.points,a=e.hasZ;for(let o=0;o<r.length;o++)n[0]=r[o][0],n[1]=r[o][1],a&&(n[2]=r[o][2]),t(n);},extent(e,t,n){e.hasZ?(t(o$S(n,e.xmin,e.ymin,e.zmin)),t(o$S(n,e.xmax,e.ymin,e.zmin)),t(o$S(n,e.xmin,e.ymax,e.zmin)),t(o$S(n,e.xmax,e.ymax,e.zmin)),t(o$S(n,e.xmin,e.ymin,e.zmax)),t(o$S(n,e.xmax,e.ymin,e.zmax)),t(o$S(n,e.xmin,e.ymax,e.zmax)),t(o$S(n,e.xmax,e.ymax,e.zmax))):(t(o$S(n,e.xmin,e.ymin,n[2])),t(o$S(n,e.xmax,e.ymin,n[2])),t(o$S(n,e.xmin,e.ymax,n[2])),t(o$S(n,e.xmax,e.ymax,n[2])));},mesh(e,t,n){const r=e.vertexAttributes&&e.vertexAttributes.position;if(r)for(let a=0;a<r.length;a+=3)t(o$S(n,r[a+0],r[a+1],r[a+2]));}};

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class C$6{constructor(t,i,e){this.target=t,this.options=i,this.view=e,this.state="pending",this.abortController=null,this.animationController=null,this.promise=new Promise(((t,i)=>{this.resolveCallback=t,this.rejectCallback=i;const e=h$N();r$Y(this.options.signal)&&v$P(this.options.signal,(()=>{this.abort();})),this.abortController=e,this.waitForReady();}));}then(t,i){return this.promise.then(t,i)}catch(t){return this.promise.catch(t)}resolve(t){return this.state="finished",this.resolveCallback(t)}reject(t){return this.state="finished",this.rejectCallback(t)}abort(t=!1){switch(this.state){case"pending":case"wait-for-ready":case"wait-for-viewpoint":this.reject(m$Y());break;case"wait-for-animation-finish":!t&&r$Y(this.animationController)&&this.view.state.cameraController===this.animationController&&this.animationController.active&&this.animationController.stopController(),this.reject(m$Y());}}waitForReady(){this.state="wait-for-ready",this.view.ready?this.createViewPoint():j$K(this.view,"ready",this.abortController.signal).then((()=>{this.createViewPoint();}),(t=>{this.reject(t);}));}createViewPoint(){"finished"!==this.state&&(this.state="wait-for-viewpoint",this.animationController=this.options.animate?this.getAnimationController():null,ge$1(this.view,this.target,this.abortController.signal).then((t=>{if("finished"===this.state)return;const i=this.getCameraFromViewpoint(t);if(!t$17(i))if(this.options.animate){if(t$17(this.animationController))return;this.startAnimation(i,this.animationController);}else this.view.stateManager.setStateCamera(i.camera,{applyConstraints:!i.isFullySpecified,positionAndOrientationOnly:!0,doNotCancelGoToOperation:!0}),this.resolve();}),(t=>{this.reject(t);})));}getCameraFromViewpoint(a){const o=!!(this.target instanceof u$17&&this.target.camera||this.target instanceof d$W),r=a.camera;if(t$17(r))return null;if(!this.view.stateManager.isCompatible(r)){const t=r.position,i=t&&t.spatialReference,a=i?i.wkid:"none",n=this.view.spatialReference.wkid;return this.reject(new s$Q("GotoAnimation:incompatible-spatialreference",`Resulting camera has an incompatible spatial reference (camera: ${a}, view: ${n})`,{camera:r})),null}const s=B$d(this.view,r);return t$17(s)?(this.reject(new s$Q("GotoAnimation:invalid-camera","Resulting camera is invalid")),null):{viewpoint:a,camera:s,isFullySpecified:o}}startAnimation(t,i){this.state="wait-for-animation-finish";const o=i.viewAnimation;if(t$17(o))return void this.reject(new s$Q("GotoAnimation:missing-animation","Unreachable code in view.stateManager"));if(o.update(t.viewpoint,"running"),!i.active||t$17(i.viewAnimation)||i.viewAnimation.target!==t.viewpoint||this.view.state.cameraController!==i)return this.abort();let r;t.isFullySpecified?(r=new p$j({view:this.view,desiredCamera:t.camera}),i$E(this.view,t.camera,1)):p$Q(this.view,t.camera),i.begin(t.camera,this.options);const s=()=>{const e=this.view.state.cameraController;r&&(e&&e.active?e instanceof h$B&&r$Y(e.viewAnimation)&&e.viewAnimation.target===t.viewpoint&&(this.view.state.cameraController=r):r$Y(i.viewAnimation)&&i.viewAnimation.target===t.viewpoint&&"finished"===i.state&&(this.view.state.cameraController=r));},l=t=>{if(!t$17(this.view.state))switch(i.state){case o$H.Finished:switch(this.state){case"pending":case"wait-for-ready":case"wait-for-viewpoint":case"wait-for-animation-finish":this.resolve();}break;case o$H.Ready:case o$H.Rejected:case o$H.Running:case o$H.Stopped:switch(this.state){case"pending":case"wait-for-ready":case"wait-for-viewpoint":case"wait-for-animation-finish":this.reject(t);}}};o.when(s,(t=>l(t))),i.asyncResult={resolve:()=>l(),reject:t=>l(t)};}getAnimationController(){let t,i=null;const n=this.view.state.cameraController;return n instanceof h$B&&(n.updateStateFromViewAnimation(),n.active&&(t=n,i=t.viewAnimation)),null!=t||(t=new h$B({view:this.view,mode:"animation"}),i=t.viewAnimation,this.view.state.switchCameraController(t))?t:(r$Y(i)&&i.stop(),this.reject(new s$Q("GotoAnimation:goto-cannot-interrupt","Cannot start an animation while interacting")),null)}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
const G$5=n$12.getLogger("esri.views.3d.state.ViewStateManager");let D$7=class extends p$14{constructor(e){super(e),this.propertiesPool=new o$m({frustum:c$m},this),this.handles=new u$T,this.cameraSetByUser=!1,this.gotoOperation=null,this.ready=!1,this.updateDevicePixelRatio=null,this.test={contentCameraResetState:new Map};}get camera(){const e=this._get("camera");if(!this.ready)return e;const t=K$f(this.view,this.view.state.camera);return t&&e&&t.equals(e)?e:t}set camera(e){this.updatePropertyBeforeReady("camera",e)||this.setStateCamera(B$d(this.view,e),{applyConstraints:!1})||G$5.error("#camera=","Invalid camera",e);}get contentCamera(){const e=this._get("contentCamera");if(!this.ready)return e;const t=K$f(this.view,this.view.state.contentCamera);return t&&e&&t.equals(e)?e:t}set contentCamera(e){if(this.updatePropertyBeforeReady("contentCamera",e))return;const t=B$d(this.view,e);t$17(t)?this.view.state.contentCamera=null:(this.updateElevation(t),this.view.state.contentCamera=t);}installContentCameraReset(e){if(this.handles.remove("contentCameraReset"),this.test.contentCameraResetState.clear(),!this.view.state.fixedContentCamera)return !1;const t=this.zoom,i=this.view.state.camera.distance**2,r=e$11(this.view.state.camera.center),a=e.sticky?this.contentCamera.clone():null;return this.handles.add([this.watch("contentCamera",(()=>{e.sticky||(this.handles.remove("contentCameraReset"),this.test.contentCameraResetState.clear());})),this.watch("zoom",(e=>{this.test.contentCameraResetState.set("view.zoom",Math.abs(e-t)/2),Math.abs(e-t)>2?this.contentCamera=null:this.view.state.fixedContentCamera||(this.contentCamera=a);})),this.view.state.watch("camera",(e=>{const t=x$P(r,e.center);this.test.contentCameraResetState.set("camera.center",t/i),t>i?this.contentCamera=null:this.view.state.fixedContentCamera||(this.contentCamera=a);}))],"contentCameraReset"),!0}get center(){return this.ready?this.view.pointsOfInterest.centerOnContent.location:this._get("center")}set center(e){this.updatePropertyBeforeReady("center",e)||(e?this.isCompatible(e)?this.setStateCamera(this.centerToCamera(e),{applyConstraints:!0})?this.view.pointsOfInterest.centerOnContent.runTask():G$5.error("#center=","Invalid center",e):G$5.error("#center=","Center has an incompatible spatial reference (center: "+(e.spatialReference?e.spatialReference.wkid:"none")+", view: "+this.view.spatialReference.wkid+")",e):G$5.error("#center=","Center may not be null or undefined"));}get extent(){if(!this.ready)return this._get("extent");const e=this.view,t=ce$8(e,e.state.camera,e.pointsOfInterest.centerOnContent.renderLocation);return r$Y(t)?t:this._get("extent")}set extent(e){this.updatePropertyBeforeReady("extent",e)||(e?this.isCompatible(e)?this.setStateCamera(this.extentToCamera(e),{applyConstraints:!0})||G$5.error("#extent=","Invalid extent",e):G$5.error("#extent=","Extent has an incompatible spatial reference (extent: "+(e.spatialReference?e.spatialReference.wkid:"none")+", view: "+this.view.spatialReference.wkid+")",e):G$5.error("#extent=","Extent may not be null or undefined"));}get frustum(){const e=this.propertiesPool.get("frustum");return e.renderCoordsHelper=this.view.renderCoordsHelper,e.update(this.view.state.camera),e}get hasInitialView(){return !!this.view.get("map.initialViewProperties.viewpoint")}get scale(){if(this.ready){const e=this.view.pointsOfInterest.centerOnContent;return V$f(this.view,e.distance,e.location.latitude)}return this._get("scale")}set scale(e){this.updatePropertyBeforeReady("scale",e)||this.setStateCamera(this.scaleToCamera(e),{applyConstraints:!0})||G$5.error("#scale=","Invalid scale",e);}get padding(){if(!this.ready)return this._get("padding");const e=this.view.state.camera,t=e.padding,i=e.pixelRatio,r=this._get("padding"),a=Math.round(t[0]/i),s=Math.round(t[1]/i),n=Math.round(t[2]/i),o=Math.round(t[3]/i);return null!=r&&r.top===a&&r.right===s&&r.bottom===n&&r.left===o?r:{top:a,right:s,bottom:n,left:o}}set padding(e){this.updatePropertyBeforeReady("padding",e)||(this.paddingToArray(e,this.view.state.camera.pixelRatio,X$3),this.view.state.updateCamera((e=>e.padding=X$3)));}paddingToArray(e,t,i){e?r$17(i,e.top||0,e.right||0,e.bottom||0,e.left||0):r$17(i,0,0,0,0);for(let r=0;r<4;r++)i[r]=Math.round(i[r]*t);}get screenCenter(){const e=this.padding;return c$19((this.view.width-(e.left+e.right))/2+e.left,(this.view.height-(e.top+e.bottom))/2+e.top)}get viewpoint(){return this.ready?pe$1(this.view,this.camera):this._get("viewpoint")}set viewpoint(e){if(!this.updatePropertyBeforeReady("viewpoint",e))if(e)if(this.isCompatible(e))this.setStateCamera(this.viewpointToCamera(e),{applyConstraints:!e.camera})||G$5.error("#viewpoint=","Invalid viewpoint",e);else {const t=r$Y(e.camera)?e.camera.position:e.targetGeometry,i=r$Y(t)&&t.spatialReference;G$5.error("#viewpoint=","Viewpoint has an incompatible spatial reference (viewpoint: "+(i?i.wkid:"none")+", view: "+this.view.spatialReference.wkid+")",e);}else G$5.error("#viewpoint=","Viewpoint may not be null or undefined");}get zoom(){return this.ready?ge$3(this.view,this.scale):this._get("zoom")}set zoom(e){this.updatePropertyBeforeReady("zoom",e)||this.setStateCamera(this.zoomToCamera(e),{applyConstraints:!0})||G$5.error("#zoom=","Invalid zoom",e);}initialize(){this.handles.add([C$q(this.view,"state.events","before-camera-change",(e=>this.updateElevation(e.camera)))]),g$12(this.view.state,"camera",(e=>this.updateElevation(e)),!0),this.handles.add(A$D({prepare:()=>this.prepareFrame()})),this.handles.add(this.view.state.watch("cameraController",(()=>{this.cameraSetByUser=!0,this.handles.remove(Y$3);}))),this.handles.add(C$q(this.view,"state.events","camera-projection-changed",(()=>this.notifyChange("scale"))));}destroy(){this.deinit(),this.handles&&(this.handles.destroy(),this.handles=null),this.propertiesPool&&(this.propertiesPool.destroy(),this.propertiesPool=null);}init(){this.constraintsManager=new m$j({view:this.view}),this.prepareFrame();const e=this.getInitialProperties();this.cameraSetByUser=!1,this._set("ready",!0);for(const t of e)this.set(t.name,t.value);if(!this.cameraSetByUser){const e=this.view.get("map.initialViewProperties.viewpoint")||this.view.initialExtent;e&&this.isCompatible(e)?this.setInitialView(e):2===this.view.state.viewingMode&&this.handles.add(j$K(this.view.basemapTerrain,"ready",(()=>{this.handles.remove(Y$3),this.setInitialView(this.view.groundExtent);})),Y$3);}}deinit(){this.cancelGoToOperation(),this.ready&&(this._override("padding",this.padding),this._set("ready",!1),this._clearOverride("hasInitialView"),this.cameraSetByUser=!1,this.handles.remove(Y$3),this.constraintsManager&&(this.constraintsManager.destroy(),this.constraintsManager=null));}async goTo(e,t){const i={animate:!0,...t};return r$Y(this.gotoOperation)&&this.gotoOperation.abort(i.animate),this.gotoOperation=new C$6(e,i,this.view),this.view.resourceController.scheduler.stopFrame(),this.gotoOperation}debugSetCameraOnContent(){this.setStateCamera(g$J(this.view),{applyConstraints:!1});}step(e){const t=this.view.state,i=t&&this.view.state.cameraController;i&&(t.updateCamera((t=>{i.stepController(e,t);})),i.steppingFinished&&i.finishController());}cancelGoToOperation(){r$Y(this.gotoOperation)&&(this.gotoOperation.abort(),this.gotoOperation=null);}getInitialProperties(){const e=new Set,t=[];for(const{propertyName:i,overrides:r}of q$5){const a=e.has(i),s=this._isOverridden(i);!a&&s&&t.push({name:i,value:this._get(i)}),this._clearOverride(i),(a||s)&&r.forEach((t=>e.add(t)));}return t}setInitialView(e){if(!e||this.cameraSetByUser)return;if(e instanceof d$W)return void this.setStateCamera(B$d(this.view,e),{applyConstraints:!1});if(e instanceof u$17){if(e.targetGeometry instanceof M$x){const t=se$a(this.view,e.targetGeometry,0,.5,0);return void(r$Y(t)&&this.setStateCamera(B$d(this.view,t),{applyConstraints:!0}))}const t={applyConstraints:!e.camera},i=this.viewpointToCamera(e);return void this.setStateCamera(i,t)}const r=se$a(this.view,e,0,.5,0);r$Y(r)&&this.setStateCamera(B$d(this.view,r),{applyConstraints:!0});}updatePropertyBeforeReady(e,t){return !this.ready&&(this._override(e,t),t&&-1!==W$4.indexOf(e)&&this._override("hasInitialView",!0),!0)}isCompatible(e){return !t$17(e)&&(e instanceof u$17?e.camera?this.isCompatible(e.camera):this.isCompatible(e.targetGeometry):e instanceof d$W?this.isCompatible(e.position):e.spatialReference&&x$O(e.spatialReference,this.view.spatialReference))}getPreservingHeadingTilt(e=J$6){return this.cameraSetByUser?(e.heading=this.camera.heading,e.tilt=this.camera.tilt):(e.heading=0,e.tilt=.5),e}centerPointAtDistanceToCamera(e,t,i=Q$6){const{heading:r,tilt:a}=this.getPreservingHeadingTilt(),s=oe$8(this.view,r,a,e,t,1);return t$17(s)?null:(i.copyFrom(this.view.state.camera),i.eye=s.eye,i.center=s.center,i.up=s.up,i)}centerToCamera(e){const t=this.view.pointsOfInterest.centerOnContent;t.runTask();const i=t.distance;return this.centerPointAtDistanceToCamera(e,i)}extentToCamera(e){const{heading:t,tilt:i}=this.getPreservingHeadingTilt(),r=se$a(this.view,e,t,i,1,K$6);return r$Y(r)?B$d(this.view,r):null}scaleToCamera(e){if(null==e)return null;const t=this.view.pointsOfInterest.centerOnContent;t.runTask();const i=t.renderLocation,r=t.location.latitude,a=Q$f(this.view,e,r);return this.centerPointAtDistanceToCamera(i,a)}zoomToCamera(e){return this.scaleToCamera(ye$2(this.view,e))}viewpointToCamera(e){return B$d(this.view,ue$1(this.view,e))}setStateCamera(e,t){return !(t$17(e)||!this.view.state.stopActiveCameraController())&&(this.cameraSetByUser=!0,t.doNotCancelGoToOperation||this.cancelGoToOperation(),this.view.state.updateCamera((i=>{t.positionAndOrientationOnly?(i.eye=e.eye,i.center=e.center,i.up=e.up):i.copyFrom(e),t.applyConstraints&&p$Q(this.view,i);})),t.applyConstraints||(this.view.state.cameraController=new p$j({view:this.view,desiredCamera:e})),!0)}prepareFrame(){const{container:e,canvas:t}=this.view;if(!e||!t)return;r$Y(this.updateDevicePixelRatio)&&this.updateDevicePixelRatio();const i=this.view.pixelRatio,r=Math.round(e.clientWidth*i),a=Math.round(e.clientHeight*i);if(0!==r&&0!==a&&(t.width===r&&t.height===a||(t.width=r,t.height=a),this.view.state)){const e=this.view.state.camera;e.fullWidth===r&&e.fullHeight===a&&e.pixelRatio===i||(Q$6.copyFrom(e),Q$6.pixelRatio!==i&&(this.paddingToArray(this.padding,i,X$3),Q$6.padding=X$3),Q$6.fullWidth=r,Q$6.fullHeight=a,Q$6.pixelRatio=i,this.view.state.camera=Q$6);}}updateElevation(e){const t=this.view.basemapTerrain&&this.view.basemapTerrain.spatialReference,i=this.view.renderCoordsHelper.getAltitude(e.eye),r=t?m$P(this.view,e.eye):0;e.relativeElevation=i-r;}};e$Q([y$K({type:d$W,dependsOn:["view.state.camera","ready"]})],D$7.prototype,"camera",null),e$Q([y$K({type:d$W,dependsOn:["view.state.contentCamera","ready"]})],D$7.prototype,"contentCamera",null),e$Q([y$K({type:b$G})],D$7.prototype,"center",null),e$Q([y$K({type:M$x})],D$7.prototype,"extent",null),e$Q([y$K({readOnly:!0})],D$7.prototype,"frustum",null),e$Q([y$K({readOnly:!0})],D$7.prototype,"hasInitialView",null),e$Q([y$K({readOnly:!0,type:Boolean})],D$7.prototype,"ready",void 0),e$Q([y$K({type:Number})],D$7.prototype,"scale",null),e$Q([y$K()],D$7.prototype,"padding",null),e$Q([y$K({readOnly:!0})],D$7.prototype,"screenCenter",null),e$Q([y$K({constructOnly:!0})],D$7.prototype,"view",void 0),e$Q([y$K({type:u$17})],D$7.prototype,"viewpoint",null),e$Q([y$K({type:Number})],D$7.prototype,"zoom",null),e$Q([y$K({constructOnly:!0})],D$7.prototype,"updateDevicePixelRatio",void 0),D$7=e$Q([n$14("esri.views.3d.state.ViewStateManager")],D$7);var L$a=D$7;const W$4=["camera","viewpoint","extent","scale","center","zoom"],q$5=[{propertyName:"camera",overrides:["viewpoint"]},{propertyName:"viewpoint",overrides:["extent"]},{propertyName:"extent",overrides:["center","scale"]},{propertyName:"center",overrides:[]},{propertyName:"scale",overrides:["zoom"]},{propertyName:"zoom",overrides:[]},{propertyName:"padding",overrides:[]}],J$6={heading:0,tilt:0},K$6=new d$W,Q$6=new J$g,X$3=n$1a(),Y$3="pending-initial-view";

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class v$a{constructor(e,t,r){this.viewingMode=e,this.layerProvider=t,this.view=r,this.externalIntersectionHandlers=new n$1h,this.tolerance=u$L.DEFAULT_TOLERANCE,this.tmpRay=a$11(),this.validateHUDIntersector=new u$L(this.viewingMode),this.validateHUDIntersector.options.hud=!1;}intersectScreen(e,t){return this.intersectRay(this.getPickRay(e,this.tmpRay),x$a(this.viewingMode),t)}intersectScreenFreePointFallback(e,t){return this.intersectRayFreePointFallback(this.getPickRay(e,this.tmpRay),t)}intersectRayFreePointFallback(e,t){return this.intersectRay(e,x$a(this.viewingMode),t)||this.intersectRayFreePointLocal(e,t)}intersectRay(e,t,r,i){return t.options.selectionMode=!1,t.options.store=0,this.computeIntersection(e,t,i),!!t.results.min&&t.results.min.getIntersectionPoint(r)}getCenterRayWithSubpixelOffset(e,t,r=.5,i=.5){return e.getRenderCenter(M$b,r,i),M$b[0]+=.0466,M$b[1]-=.0123,p$L(e,M$b,t)}intersectIntersectorScreen(e,t,r){this.computeIntersection(this.getPickRay(e,this.tmpRay),t,r);}intersectToolIntersectorScreen(e,t,r){const i=this.getPickRay(e,this.tmpRay);this.intersectToolIntersectorRay(i,t,r);}intersectToolIntersectorRay(e,t,r){t.options.selectionMode=!0,this.computeIntersection(e,t,r);const i=t.results.min;!!this.view.basemapTerrain&&this.view.basemapTerrain.opaque||i.hasIntersectionPoint&&"TerrainRenderer"!==i.intersector||(t.options.selectionMode=!1,this.computeIntersection(e,t,r));}setTolerance(e=u$L.DEFAULT_TOLERANCE){this.tolerance=e;}addIntersectionHandler(e){this.externalIntersectionHandlers.push(e),this.externalIntersectionHandlers.sort(((e,t)=>"Terrain"===e.type?1:"Terrain"===t.type?-1:0));}removeIntersectionHandler(e){this.externalIntersectionHandlers.removeUnordered(e),this.externalIntersectionHandlers.sort(((e,t)=>"Terrain"===e.type?1:"Terrain"===t.type?-1:0));}getPickRay(e,t=a$11()){const r=this.view.state.camera;return u$I(r,e,t)}intersectRayFreePointLocal(t,r){if(2!==this.viewingMode||t$17(t))return !1;const i=this.view.dataExtent,n={x:i.xmax-i.xmin,y:i.ymax-i.ymin,z:8*Math.max(i.xmax-i.xmin,i.ymax-i.ymin)},s=Math.max(n.x,n.y,n.z);if(0===s)return u$S(r,t.origin,j$F(c$U.get(),t.direction)),!0;const d=this.view.state.camera,h=Math.max(0,i.xmin-d.eye[0],d.eye[0]-i.xmax),u=Math.max(0,i.ymin-d.eye[1],d.eye[1]-i.ymax),p=Math.sqrt(h*h+u*u),y=Math.abs(d.relativeElevation)+Number.MIN_VALUE,g=Math.max(0,Math.log(s/y))**2;let f=s/Math.max(1,g);f=Math.max(f,Math.min(p,s));const v=d$O(c$U.get(),t.direction,f/s$P(t.direction));return u$S(r,t.origin,v),!0}intersectElevationFromScreen(e,t,r=0,i=null){return this.intersectElevation(this.getPickRay(e,this.tmpRay),t,r,i)}intersectElevation(i,s,a=0,c=null){if(t$17(i))return null;const l=r$Y(s)?s.mode:"absolute-height",d=r$Y(s)?c$W(s.offset,0):0,h="on-the-ground"!==l?d+a:0,u=h/this.view.renderCoordsHelper.unitInMeters;if("absolute-height"===l){if(this.view.renderCoordsHelper.intersectInfiniteManifold(i,h,b$9)){const e=this.view.computeMapPointFromVec3d(b$9);return e.z-=d,e}return null}const p=this.view.state.camera,y=p$18(c$U.get());p.projectToRenderScreen(i.origin,y);const v=this.prepareFilters(null,w$a),R=this.view.slicePlane,I=r$Y(R)?g$K(R):null,x=new u$L(this.viewingMode);x.options.store=0,x.options.verticalOffset=u;const P=i.origin,M=u$S(c$U.get(),P,i.direction);x.reset(P,M),x.point=y,x.camera=p,x.filterPredicate=null;const H=r$Y(c)?"type"in c&&"graphics"===c.type?e=>e.metadata.layerUid!==c.uid:e=>e.metadata.graphicUid!==c.uid:null;switch(l){case"relative-to-scene":{const t=t=>(t$17(H)||H(t))&&t.metadata&&t.metadata.isElevationSource;x.intersect(v.layers,y,p,this.tolerance,null,t),this.externalIntersectionHandlers.forAll((e=>{if("I3S"===e.type||"Terrain"===e.type){const t=e.slicePlane?I:null;e.intersect(x,t,x.rayBeginPoint,x.rayEndPoint,y);}}));}break;case"on-the-ground":case"relative-to-ground":this.externalIntersectionHandlers.forAll((e=>{if(e.isGround){const t=e.slicePlane?I:null;e.intersect(x,t,x.rayBeginPoint,x.rayEndPoint,y);}}));}if(x.results.min.getIntersectionPoint(b$9)){const e=this.view.computeMapPointFromVec3d(b$9);return e.z=a,e}return null}computeIntersection(i,s,a){if(t$17(i))return;const c=this.view.state.camera,l=p$18(c$U.get());c.projectToRenderScreen(i.origin,l);const h=this.prepareFilters(a,w$a);s.options.selectOpaqueTerrainOnly=!a||!("include"in a||"exclude"in a);const u=i.origin,p=u$S(c$U.get(),i.origin,i.direction);s.reset(u,p),s.intersect(h.layers,l,c,this.tolerance);const y=this.view.slicePlane,g=r$Y(y)?g$K(y):null;s.intersect(h.sliceableLayers,l,c,this.tolerance,g);const v=a&&(a.requiresGroundFeedback||a.enableDraped);this.externalIntersectionHandlers.forAll((e=>{if(s.options.isFiltered=!h.filterLayerUid(e.intersectionHandlerId),e.isGround&&v||!s.options.isFiltered){const t=e.slicePlane?g:null;e.intersect(s,t,u,p,l);}}));const R=c$U.get();if(a&&a.enableDraped&&s.results.ground.getIntersectionPoint(R)){const e=this.view.basemapTerrain.overlayManager.renderer,t=this.view.renderCoordsHelper.spatialReference,i=c$U.get();this.view.renderCoordsHelper.fromRenderCoords(R,i,this.view.spatialReference),i[2]=c$W(this.view.elevationProvider.getElevation(R[0],R[1],R[2],t,"ground"),0),e.intersect(s,i,h.filterRenderGeometry);}s.sortResults();const I=s.results.hud;if(I.hasIntersectionPoint){const e=p$18(c$U.get()),t=c$U.get(),r=c$U.get();this.unprojectHUDResultRay(I.center,e,t,r);const i=q$o(I.center,t)/q$o(t,r)*.99;this.validateHUDIntersector.reset(t,r),this.validateHUDIntersector.intersect(h.layers,e,c,this.tolerance),this.validateHUDIntersector.intersect(h.sliceableLayers,e,c,this.tolerance,g),this.externalIntersectionHandlers.forAll((i=>{if(!h.filterLayerUid(i.intersectionHandlerId))return;const n=i.slicePlane?g:null;i.intersect(this.validateHUDIntersector,n,t,r,e);}));const o=this.validateHUDIntersector.results.min;(null==o.dist||i<=o.dist)&&(s.results.min.copyFrom(I),s.results.all.splice(0,0,I));}}prepareFilters(e,t){const r=[],i=[];return this.layerProvider.forEachLayer((e=>{e.isPickable&&(e.isSliceable?i:r).push(e);})),t.include=e&&e.include,t.exclude=e&&e.exclude,t.layers.length=0,t.sliceableLayers.length=0,R$9(r,t.filterLayer,t.layers),R$9(i,t.filterLayer,t.sliceableLayers),t}unprojectHUDResultRay(e,t,r,i){const s=this.view.state.camera;s.projectToRenderScreen(e,t);const o=p$18(c$U.get());o[0]=t[0],o[1]=t[1],o[2]=0,s.unprojectFromRenderScreen(o,r),o[2]=1,s.unprojectFromRenderScreen(o,i);}}function R$9(e,t,r){for(const i of e)t&&!t(i)||r.push(i);return r}let I$8;function x$a(e){return I$8||(I$8=new u$L(e)),I$8.viewingMode=e,I$8}const w$a={include:null,exclude:null,layers:[],sliceableLayers:[],filterLayer:e=>w$a.filterLayerUid(e.apiLayerUid),filterLayerUid(t){const{include:r,exclude:i}=w$a;return t$17(t)?null==r&&null==i:(null==r||r.has(t))&&(null==i||!i.has(t))},filterRenderGeometry:e=>w$a.filterLayerUid(e.layerUid)};function P$8(e){return "object"==typeof e&&"intersect"in e}const b$9=n$11(),M$b=s$18();

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class a$j{constructor(e,t){this.spatialReference=e,this.view=t;}getElevation(e,t,r){return this.view.elevationProvider.getElevation(e,t,0,this.spatialReference,r)}async queryElevation(e,t,r,s,i){return this.view.elevationProvider.queryElevation(e,t,0,this.spatialReference,i,r,s)}}class l$i{constructor(e,t,r,s){this.spatialReference=t,this._getElevationQueryProvider=r,this._queries=new Array,this._queryOptions={...s,ignoreInvisibleLayers:!0},this._frameTask=e.registerTask(p$H.ELEVATION_QUERY,this);}destroy(){this._frameTask.remove();}queryElevation(t,i,o,n=0){return new Promise(((a,l)=>{const u={x:t,y:i,minDemResolution:n,result:{resolve:a,reject:l},signal:o};this._queries.push(u),v$P(o,(()=>{C$t(this._queries,u),l(m$Y());}));}))}get running(){return this._queries.length>0}runTask(){const e=this._queries;this._queries=[];const o=this._getElevationQueryProvider();if(!o)return void e.forEach((e=>e.result.reject()));const a=e.map((e=>[e.x,e.y])),l=e.reduce(((e,t)=>Math.min(e,t.minDemResolution)),1/0),u=new u$18({points:a,spatialReference:this.spatialReference}),c=e.length>1&&e.some((e=>!!e.signal))?h$N():null,h=r$Y(c)?c.signal:e[0].signal;if(r$Y(c)){let t=0;e.forEach((i=>v$P(i.signal,(()=>{t++,i.result.reject(m$Y()),t===e.length&&c.abort();}))));}const m={...this._queryOptions,minDemResolution:l,signal:h};o.queryElevation(u,m).then((r=>{e.forEach(((e,i)=>{r$Y(e.signal)&&e.signal.aborted?e.result.reject(m$Y()):e.result.resolve(r.geometry.points[i][2]);}));})).catch((t=>{e.forEach((e=>e.result.reject(t)));}));}get test(){const e=this;return {update:()=>e._queries.length>0&&e.runTask()}}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
let p$i=class extends(n$13.EventedMixin(p$14)){constructor(e){super(e),this.im=new Array,this.ground=new Array,this.scene=new Array,this.handles=new Map;}destroy(){this._elevationQuery=l$W(this._elevationQuery);}get elevationQuery(){return t$17(this._elevationQuery)&&(this._elevationQuery=new l$i(this.view.resourceController.scheduler,this.view.spatialReference,(()=>this.view.map&&this.view.map.ground),{maximumAutoTileRequests:4})),this._elevationQuery}getElevation(e,t,r,s,i){let n=null;return n=u$d(n,this.im,e,t,r,s,i),t$17(n)&&(n=u$d(n,this.ground,e,t,r,s,i)),"scene"===i&&(n=u$d(n,this.scene,e,t,r,s,i)),n}queryElevation(e,t,r,s,o,i=null,c=0){const l=D$r();return this.elevationQuery.queryElevation(e,t,i,c).then((i=>{"scene"===o&&(i=u$d(i,this.scene,e,t,r,s,o)),l.resolve(i);})).catch((i=>{g$T(i)?l.reject(i):l.resolve(this.getElevation(e,t,r,s,o));})),l.promise}register(e,t){this.handles.set(t,t.on("elevation-change",(e=>this.emit("elevation-change",e)))),this[e].push(t);}unregister(e){this.handles.has(e)&&(this.handles.get(e).remove(),this.handles.delete(e));for(const t of [this.im,this.ground,this.scene]){const r=t.indexOf(e);r>-1&&t.splice(r,1);}}};function u$d(e,t,r,s,o,n,a){for(const c of t){const t=c.getElevation(r,s,o,n,a);r$Y(t)&&(e=r$Y(e)?Math.max(t,e):t);}return e}e$Q([y$K({constructOnly:!0})],p$i.prototype,"view",void 0),e$Q([y$K({readOnly:!0,aliasOf:"view.basemapTerrain.spatialReference"})],p$i.prototype,"spatialReference",void 0),p$i=e$Q([n$14("esri.views.3d.support.CombinedElevationProvider")],p$i);

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class a$i{static isValidProfile(e){return e in a$i.profiles}static getDefaultProfile(){return s$U("trident")||s$U("esri-iPhone")?"low":"medium"}static apply(e,i){const o=a$i.profiles[e];i.graphics3D.maxTotalNumberOfFeatures=o.graphics3D.maxTotalNumberOfFeatures,i.graphics3D.maxTotalNumberOfPrimitives=o.graphics3D.maxTotalNumberOfPrimitives,i.graphics3D.polygonLodFactor=o.graphics3D.polygonLodFactor,i.graphics3D.polylineLodFactor=o.graphics3D.polylineLodFactor;{const e=i.sceneService["3dObject"],a=o.sceneService["3dObject"];e.lodFactor=a.lodFactor,e.lodCrossfadeinDuration=a.lodCrossfadeinDuration,e.lodCrossfadeoutDuration=a.lodCrossfadeoutDuration,e.lodCrossfadeUncoveredDuration=a.lodCrossfadeUncoveredDuration;}i.sceneService.point.lodFactor=o.sceneService.point.lodFactor,i.sceneService.integratedMesh.lodFactor=o.sceneService.integratedMesh.lodFactor,i.sceneService.pointCloud.lodFactor=o.sceneService.pointCloud.lodFactor,i.sceneService.uncompressedTextureDownsamplingEnabled=o.sceneService.uncompressedTextureDownsamplingEnabled,i.tiledSurface.lodBias=o.tiledSurface.lodBias,i.tiledSurface.angledSplitBias=o.tiledSurface.angledSplitBias,i.tiledSurface.reduceTileLevelDifferences=o.tiledSurface.reduceTileLevelDifferences,i.tiledSurface.textureFadeDuration=o.tiledSurface.textureFadeDuration,i.antialiasingEnabled=o.antialiasingEnabled,i.physicallyBasedRenderingEnabled=o.physicalBasedRenderingEnabled,i.highQualityTransparency=o.highQualityTransparency,i.memoryLimit=o.memoryLimit,i.additionalCacheMemory=o.additionalCacheMemory,i.frameRate=o.frameRate,i.maximumRenderResolution=o.maximumRenderResolution,i.maximumPixelRatio=o.maximumPixelRatio;}}function i$c(){const a=!!s$U("esri-mobile");return {low:{graphics3D:{maxTotalNumberOfFeatures:25e3,maxTotalNumberOfPrimitives:85e4,polygonLodFactor:.5,polylineLodFactor:1},sceneService:{"3dObject":{lodFactor:.2,lodCrossfadeinDuration:0,lodCrossfadeoutDuration:0,lodCrossfadeUncoveredDuration:0},point:{lodFactor:1},integratedMesh:{lodFactor:.6},pointCloud:{lodFactor:.5},uncompressedTextureDownsamplingEnabled:!0},tiledSurface:{lodBias:-1,angledSplitBias:.5,reduceTileLevelDifferences:!1,textureFadeDuration:0},antialiasingEnabled:!1,physicalBasedRenderingEnabled:!1,highQualityTransparency:!1,memoryLimit:200,additionalCacheMemory:0,frameRate:0,maximumRenderResolution:null,maximumPixelRatio:1},medium:{graphics3D:{maxTotalNumberOfFeatures:5e4,maxTotalNumberOfPrimitives:17e5,polygonLodFactor:a?.8:1,polylineLodFactor:a?1.2:1.5},sceneService:{"3dObject":{lodFactor:1,lodCrossfadeinDuration:0,lodCrossfadeoutDuration:0,lodCrossfadeUncoveredDuration:400},point:{lodFactor:1},integratedMesh:{lodFactor:1},pointCloud:{lodFactor:1},uncompressedTextureDownsamplingEnabled:a},tiledSurface:{lodBias:0,angledSplitBias:1,reduceTileLevelDifferences:!s$U("disable-feature:reduce-map-tile-levels"),textureFadeDuration:400},antialiasingEnabled:!0,physicalBasedRenderingEnabled:!0,highQualityTransparency:!0,memoryLimit:a?600:750,additionalCacheMemory:a?0:150,frameRate:0,maximumRenderResolution:null,maximumPixelRatio:1},high:{graphics3D:{maxTotalNumberOfFeatures:5e4,maxTotalNumberOfPrimitives:17e5,polygonLodFactor:a?1.2:2,polylineLodFactor:a?1.2:2},sceneService:{"3dObject":{lodFactor:1,lodCrossfadeinDuration:0,lodCrossfadeoutDuration:0,lodCrossfadeUncoveredDuration:400},point:{lodFactor:1},integratedMesh:{lodFactor:1},pointCloud:{lodFactor:1},uncompressedTextureDownsamplingEnabled:!1},tiledSurface:{lodBias:0,angledSplitBias:1,reduceTileLevelDifferences:!s$U("disable-feature:reduce-map-tile-levels"),textureFadeDuration:400},antialiasingEnabled:!0,physicalBasedRenderingEnabled:!0,highQualityTransparency:!0,memoryLimit:a?900:1500,additionalCacheMemory:0,frameRate:0,maximumRenderResolution:a?null:4096,maximumPixelRatio:a?1:null}}}a$i.debug={reset(){const e=i$c();for(const i in e)a$i.profiles[i]=e[i];}},function(e){e.profiles=i$c();}(a$i||(a$i={}));var o$l=a$i;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
let a$h=class extends p$14{constructor(){super(...arguments),this.color=new o$W([0,255,255]),this.haloColor=null,this.haloOpacity=1,this.fillOpacity=.25,this.shadowOpacity=.4,this.shadowColor=new o$W([0,0,0]),this.shadowDifference=.2;}static toEngineOptions(o){const r=o$W.toUnitRGBA(o.color),s=r$Y(o.haloColor)?o$W.toUnitRGBA(o.haloColor):r,p=o$W.toUnitRGBA(o.shadowColor);return {color:t$1q(r[0],r[1],r[2],r[3]),haloColor:t$1q(s[0],s[1],s[2],s[3]),haloOpacity:o.haloOpacity,haloOpacityOccluded:.25*o.haloOpacity,fillOpacity:o.fillOpacity,fillOpacityOccluded:.25*o.fillOpacity,shadowOpacity:o.shadowOpacity,shadowColor:t$1q(p[0],p[1],p[2],p[3]),occludedShadowOpacity:o.shadowOpacity*(1-o.shadowDifference)}}};e$Q([y$K({type:o$W})],a$h.prototype,"color",void 0),e$Q([y$K({type:o$W})],a$h.prototype,"haloColor",void 0),e$Q([y$K()],a$h.prototype,"haloOpacity",void 0),e$Q([y$K()],a$h.prototype,"fillOpacity",void 0),e$Q([y$K()],a$h.prototype,"shadowOpacity",void 0),e$Q([y$K({type:o$W})],a$h.prototype,"shadowColor",void 0),e$Q([y$K()],a$h.prototype,"shadowDifference",void 0),a$h=e$Q([n$14("esri.views.3d.support.HighlightOptions")],a$h);var e$j=a$h;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class c$k{constructor(r,i,s=null){this.spatialReference=i,this.unitInMeters=G$m(this.spatialReference,p$15(this.spatialReference).metersPerDegree),this._geometryServicePromise=a$1h(this.loadGeometryService(r,s));}async loadGeometryService(e,t){if(t)return t;try{return await i$16(e&&e.get("portalItem"))}catch{throw new s$Q("mapcoordshelper:missing-geometry-service","Must specify geometryService in esri/config")}}async awaitGeometryService(){const e=await this._geometryServicePromise;if(!0===e.ok)return e.value;throw e.error}async toGeographic(e){const r=await this.awaitGeometryService();let t,o=!0;Array.isArray(e[0])&&"number"!=typeof e[0]?t=e:(t=[e],o=!1);const i=t.map((e=>e instanceof b$G?e:new b$G(e,this.spatialReference))),c=new a$1l({geometries:i,outSpatialReference:k$x.WGS84}),p=(await r.project(c)).map((e=>"point"===e.type?[e.x,e.y]:void 0));return o?p:p[0]}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
let r$l=class extends p$14{constructor(){super(...arguments),this.minTotalNumberOfFeatures=2e3,this.maxTotalNumberOfFeatures=5e4,this.maxTotalNumberOfPrimitives=17e5,this.polygonLodFactor=1,this.polylineLodFactor=1;}};e$Q([y$K()],r$l.prototype,"minTotalNumberOfFeatures",void 0),e$Q([y$K()],r$l.prototype,"maxTotalNumberOfFeatures",void 0),e$Q([y$K()],r$l.prototype,"maxTotalNumberOfPrimitives",void 0),e$Q([y$K()],r$l.prototype,"polygonLodFactor",void 0),e$Q([y$K()],r$l.prototype,"polylineLodFactor",void 0),r$l=e$Q([n$14("esri.views.3d.support.QualitySettings.Graphics3DSettings")],r$l);let s$l=class extends p$14{constructor(){super(...arguments),this.lodFactor=1;}};e$Q([y$K()],s$l.prototype,"lodFactor",void 0),s$l=e$Q([n$14("esri.views.3d.support.QualitySettings.LoDFactorSettings")],s$l);let p$h=class extends s$l{constructor(){super(...arguments),this.lodCrossfadeinDuration=0,this.lodCrossfadeoutDuration=0,this.lodCrossfadeUncoveredDuration=0;}};p$h=e$Q([n$14("esri.views.3d.support.QualitySettings.LoDFactor3DObjectSettings")],p$h);let a$g=class extends p$14{constructor(){super(...arguments),this["3dObject"]=new p$h,this.point=new s$l,this.integratedMesh=new s$l,this.pointCloud=new s$l,this.uncompressedTextureDownsamplingEnabled=!1;}};e$Q([y$K({type:p$h})],a$g.prototype,"3dObject",void 0),e$Q([y$K({type:s$l})],a$g.prototype,"point",void 0),e$Q([y$K({type:s$l})],a$g.prototype,"integratedMesh",void 0),e$Q([y$K({type:s$l})],a$g.prototype,"pointCloud",void 0),e$Q([y$K()],a$g.prototype,"uncompressedTextureDownsamplingEnabled",void 0),a$g=e$Q([n$14("esri.views.3d.support.QualitySettings.SceneServiceSettings")],a$g);let d$h=class extends p$14{constructor(){super(...arguments),this.lodBias=0,this.angledSplitBias=1,this.reduceTileLevelDifferences=!0,this.textureFadeDuration=500;}};e$Q([y$K()],d$h.prototype,"lodBias",void 0),e$Q([y$K()],d$h.prototype,"angledSplitBias",void 0),e$Q([y$K()],d$h.prototype,"reduceTileLevelDifferences",void 0),e$Q([y$K()],d$h.prototype,"textureFadeDuration",void 0),d$h=e$Q([n$14("esri.views.3d.support.QualitySettings.TiledSurfaceSettings")],d$h);let n$o=class extends p$14{constructor(){super(...arguments),this.graphics3D=new r$l,this.sceneService=new a$g,this.tiledSurface=new d$h,this.antialiasingEnabled=!0,this.physicallyBasedRenderingEnabled=!1,this.highQualityTransparency=!0;}};e$Q([y$K({type:r$l})],n$o.prototype,"graphics3D",void 0),e$Q([y$K({type:a$g})],n$o.prototype,"sceneService",void 0),e$Q([y$K({type:d$h})],n$o.prototype,"tiledSurface",void 0),e$Q([y$K()],n$o.prototype,"antialiasingEnabled",void 0),e$Q([y$K()],n$o.prototype,"physicallyBasedRenderingEnabled",void 0),e$Q([y$K()],n$o.prototype,"highQualityTransparency",void 0),e$Q([y$K()],n$o.prototype,"memoryLimit",void 0),e$Q([y$K()],n$o.prototype,"additionalCacheMemory",void 0),e$Q([y$K()],n$o.prototype,"frameRate",void 0),e$Q([y$K()],n$o.prototype,"maximumRenderResolution",void 0),e$Q([y$K()],n$o.prototype,"maximumPixelRatio",void 0),n$o=e$Q([n$14("esri.views.3d.support.QualitySettings.QualitySettings")],n$o);var l$h=n$o;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class _$a{constructor(t,e,s,i){this.viewingMode=t,this.spatialReference=e,this.unitInMeters=s,this.coordinateSystem=i,this._coordinateSystem=p$M(i);}set extent(t){t&&v$y(this.coordinateSystem,t,this.coordinateSystem);}getAltitude(t){return C$i(this.coordinateSystem,t)}setAltitude(t,e,s=t){return O$q(this.coordinateSystem,s,e,t)}setAltitudeOfTransformation(t,e){T$m(this.coordinateSystem,e,t,e);}worldUpAtPosition(t,e){return x$B(this.coordinateSystem,t,e)}worldBasisAtPosition(t,e,s){return y$A(this.coordinateSystem,t,e,s)}basisMatrixAtPosition(t,e){const i=this.worldBasisAtPosition(t,0,c$U.get()),r=this.worldBasisAtPosition(t,1,c$U.get()),o=this.worldBasisAtPosition(t,2,c$U.get());return s$10(e,i[0],i[1],i[2],0,r[0],r[1],r[2],0,o[0],o[1],o[2],0,0,0,0,1),e}intersectManifoldClosestSilhouette(t,e,s){return q$h(this.coordinateSystem,e,this._coordinateSystem),b$v(this._coordinateSystem,t,s),s}intersectManifold(t,e,s){q$h(this.coordinateSystem,e,this._coordinateSystem);const r=c$U.get();return P$p(this._coordinateSystem,t,r)?r$Z(s,r):null}intersectInfiniteManifold(t,e,s){if(1===this.viewingMode)return this.intersectManifold(t,e,s);q$h(this.coordinateSystem,e,this._coordinateSystem);const r=this._coordinateSystem.value,o=c$U.get();return D$q(r.plane,t,o)?r$Z(s,o):null}toRenderCoords(t,e,s){return t$Y(t)?Rn(t,e,this.spatialReference):wn(t,e,s,this.spatialReference)}fromRenderCoords(e,s,i=null){return t$Y(s)?(r$Y(i)&&(s.spatialReference=i),Mn(e,this.spatialReference,s)):s instanceof k$x?dn(e,this.spatialReference,s):wn(e,this.spatialReference,s,i)?s:null}static create(t,s){switch(t){case 2:return new _$a(2,s,G$m(s),k$m());case 1:return new _$a(1,s,1,h$A(s))}}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
const r$k=(()=>{const r=new Array;return r[0]=10,r[1]=10,r[2]=10,r[3]=10,r[4]=5,r})(),n$n=30;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
function e$i(e){return "function"==typeof e.getUsedMemory}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
const h$i=n$12.getLogger("esri.views.3d.support.MemoryController");function o$k(t){return new d$g(t)}const m$i=1,y$c=1,n$m=.75,_$9=.6,l$g=1.3;class d$g{constructor(e){this._view=e,this.events=new n$13,this.minQuality=.1,this._maxMemory=500,this._additionalCacheMemory=100,this._quality=1,this._stableQuality=0,this._downscaleMemoryUsed=0,this._canFastRecover=!1,this._memoryUsed=0,this._memoryPredicted=0,this._cacheStorage=new i$17,this._numQualityChanges=0,this._updating=!1;}destroy(){this.events=null,this._cacheStorage.destroy();}getMemCache(t,e){return new s$19(t,this._cacheStorage,e)}set maxMemory(t){null!=t&&t>0&&(this._stableQuality=0,this._canFastRecover=!1,this._maxMemory<t&&this._updateQuality(m$i),this._maxMemory=t);}get maxMemory(){return this._maxMemory}set additionalCacheMemory(t){null!=t&&t>=0&&(this._additionalCacheMemory=t);}disableMemCache(){this._additionalCacheMemory=-4096;}get memoryFactor(){return this._quality}get updating(){return this._updating}get usedMemory(){return this._memoryUsed}resetStableQuality(){this._stableQuality=0;}update(){if(this._updateMemory(),this._memoryPredicted<=0&&!this._updating)return;let t=this._layersUpdating();if(this._memoryPredicted<_$9&&this._canFastRecover)this._downscaleMemoryUsed=0,this._stableQuality=0,this._canFastRecover=!1,this._updateQuality(m$i);else if(t)(this._memoryPredicted>1.1*y$c||this._memoryUsed>y$c)&&(this._stableQuality>0?(this._downscaleMemoryUsed=0,this._updateQuality(this._stableQuality)):this._quality>this.minQuality&&this._downscaleMemoryUsed<this._memoryUsed&&(this._updateQuality(this._quality/l$g),this._downscaleMemoryUsed=this._memoryUsed,this._canFastRecover=!1));else if(this._downscaleMemoryUsed=0,this._memoryUsed>y$c)this._stableQuality=0,this._canFastRecover=!1,t=this._updateQuality(this._quality/l$g),this._downscaleMemoryUsed=this._memoryPredicted;else if(this._stableQuality!==this._quality)if(this._memoryUsed<n$m&&this._quality<m$i){this._stableQuality=this._quality;const e=.05;t=this._updateQuality(this._quality+e);}else this._quality<1&&(this._canFastRecover=!0);this.updating!==t&&(this._updating=t,this.events.emit("updating-changed",this.updating));}_updateQuality(t){return (t=Math.min(Math.max(t,this.minQuality),m$i))!==this._quality&&(this._quality=t,this.events.emit("quality-changed",this._quality),++this._numQualityChanges,!0)}_layersUpdating(){return this._view.allLayerViews.some((t=>!!t.updating))}_updateMemory(){let t=0,e=0;this._view.basemapTerrain&&this._view.basemapTerrain.getUsedMemory&&(t+=this._view.basemapTerrain.getUsedMemory());const s=this._view._stage&&this._view._stage.renderView&&this._view._stage.renderView.edgeView;r$Y(s)&&(t+=s.usedMemory),this._view.allLayerViews&&this._view.allLayerViews.forEach((i=>{if(e$i(i)){const s=i.ignoresMemoryFactor()?this._quality:1;t+=i.getUsedMemory()*s,e+=i.getUnloadedMemory()*s;}}));const a=null==this._warnMemoryUsage||Math.round(10*t)!==Math.round(10*this._warnMemoryUsage),o=1048576*this._maxMemory;if(t>o&&a){this._warnMemoryUsage=t;const i=t=>(t/1048576).toLocaleString(void 0,{maximumFractionDigits:1})+" MB",s=Math.round(100*this._quality);h$i.warn(`Memory Limit exceeded! Limit: ${i(o)} Current: ${i(t)} Projected: ${i(t+e)} Quality: ${s}%`);}this._memoryUsed=t/o,this._memoryPredicted=(t+e)/o;const m=o-t;this._cacheStorage.maxSize=Math.max(0,m+1048576*this._additionalCacheMemory),this.events.emit("memory-used",this._memoryUsed);}get test(){const t=this;return {cacheStorage:this._cacheStorage,resetQualityChanges:()=>{const e=t._numQualityChanges;return t._numQualityChanges=0,e}}}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class s$k{constructor(t){this.client=t,this._cancelled=!1,this.size=0,this.duration=0;}}class e$h{constructor(t){this.typeWorkerQuota=t,this.tasks=new Array,this.numWorkers=0,this.statistics=new r$j;}}class r$j{constructor(){this.requests=0,this.size=0,this.duration=0,this.speed=0;}}class i$b{constructor(t,s,r,i){this._workerFunc=t,this._callbackFunc=s,this._maxTotalNumWorkers=r,this._totalNumWorkers=0,this._clients=i.map((t=>new e$h(t)));}hasQuota(t){const s=this._clients[t];return !!s&&(this._totalNumWorkers<this._maxTotalNumWorkers||s.numWorkers+s.tasks.length<s.typeWorkerQuota)}push(t){const s=this._clients[t.client];s&&(this._totalNumWorkers<this._maxTotalNumWorkers?(s.numWorkers++,this._totalNumWorkers++,this._workerFunc(t,((t,s)=>this._taskCallback(t,s)))):s.tasks.push(t));}cancel(t){this._taskFinished(t),t._cancelled=!0;}destroy(){this._clients.length=0;}_taskFinished(s){const e=this._clients[s.client];this._totalNumWorkers--,e.numWorkers--,e.statistics.requests++,e.statistics.size+=s.size||0,e.statistics.duration+=s.duration||0,e.statistics.speed=e.statistics.duration>0?e.statistics.size/e.statistics.duration:0,i$R(e.numWorkers>=0),this._next();}_next(){for(const t of this._clients)if(t&&t.numWorkers<t.typeWorkerQuota&&this._processQueue(t))return;for(const t of this._clients)if(t&&this._processQueue(t))return}_processQueue(t){for(;t.tasks.length>0;)if(this._workerFunc(t.tasks.shift(),((t,s)=>this._taskCallback(t,s))))return t.numWorkers++,this._totalNumWorkers++,!0;return !1}_taskCallback(t,s){t._cancelled||(this._callbackFunc(t,s),this._taskFinished(t));}getStatsForType(t){const s=this._clients[t];return s?{quota:s.typeWorkerQuota,workers:s.numWorkers,queueSize:s.tasks.length,requestStats:s.statistics}:null}get test(){const t=this;return {set workerFunc(s){t._workerFunc=s;}}}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class t$r extends s$k{constructor(s,t,r,e,i){super(e),this.url=s,this.options=t,this.docType=r,this.key=i,this.result=null,this.status=1,this.request=null,this.abortController=null,this.resolvers=new Array,this.startTime=0;}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
let L$9=class extends p$14{constructor(){super(...arguments),this.tasks=new Map,this.onLoadQueue=new Array,this.doneQueue=new Array,this.updating=!1;}setup(e,t,s){this.loadQueue=new i$b(((e,t)=>this.startLoading(e,t)),((e,t)=>this.doneLoadingCallback(e,t)),e,t),s&&(this.taskHandle=s.registerTask(p$H.STREAM_DATA_LOADER,this));}destroy(){this.taskHandle=s$17(this.taskHandle),this.tasks.forEach((e=>{e.abortController&&e.abortController.abort();})),this.loadQueue.destroy(),this.loadQueue=null,this.onLoadQueue=null,this.doneQueue=null,this.tasks=null;}hasDownloadSlots(e){return this.loadQueue.hasQuota(e)}request(e,t,s,r={}){const o=D$r();o.__signal=r$Y(r)?r.signal:null;const a=this.createOrUpdateTask(e,t,s,r,o);return v$P(r,(()=>this.cancelRequest(a,o))),o.promise}createTask(e,t,s,r,o,a){const n=new t$r(e,t,s,r,o);return this.updateTask(n,a),this.tasks.set(o,n),1===this.tasks.size&&this._set("updating",!0),this.loadQueue.push(n),n}cancelRequest(e,t){v$Q(e.resolvers,t),t.reject(m$Y()),0===e.resolvers.length&&(2===e.status&&(e.status=4,this.loadQueue.cancel(e),e.abortController.abort(),e.request=null,e.abortController=null),e.status=4,this.tasks.delete(e.key),0===this.tasks.size&&this._set("updating",!1));}taskKey(e,t,s){return `${e}:${t}:${s}`}updateTask(e,t){e.resolvers.push(t);}createOrUpdateTask(e,t,s,r,o){const a=r$Y(r)&&r.uid||e,n=this.taskKey(a,t,s),u=this.tasks.get(n);return u?(this.updateTask(u,o),u):this.createTask(e,r,t,s,n,o)}doneLoadingCallback(e,t){this.loadQueue&&(i$R(2===e.status),e.status=3,this.taskHandle?this.doneQueue.push({task:e,err:t}):this.doneLoading(e,t));}get running(){return this.doneQueue.length>0||this.onLoadQueue.length>0}runTask(e){for(;!e.done&&this.onLoadQueue.length>0;){const t=this.onLoadQueue.shift();a$1i(t.task.abortController),t.task.abortController=null,t.callback(t.task),e.madeProgress();}for(;!e.done&&this.doneQueue.length>0;){const t=this.doneQueue.shift();3!==t.task.status&&(t.err=t.err||m$Y()),this.doneLoading(t.task,t.err),e.madeProgress();}}doneLoading(e,t){let s=e.result instanceof HTMLImageElement?0:e.resolvers.length;for(const r of e.resolvers)if(t)g$T(t)?r.reject(t):r.reject(new s$Q("stream-data-loader:request-error",`Failed to request resource at '${e.url}'. ${t}`,{url:e.url,error:t}));else {--s;const t=s<=0?e.result:y$M(e.result);r.resolve(t);}this.tasks.delete(e.key),0===this.tasks.size&&this._set("updating",!1);}startLoading(e,s){if(4===e.status)return !1;let r,o;switch(e.startTime=performance.now(),e.status=2,e.docType){case"binary":o="array-buffer",r=0;break;case"image":o="image";break;case"image+type":o="array-buffer";break;default:o="json";}e.abortController=h$N();const a=e.abortController.signal;e.request=L$w(e.url,{...e.options,responseType:o,timeout:r,signal:a});let n=()=>{};const i=t=>{e.duration=performance.now()-e.startTime,e.size=t instanceof ArrayBuffer?t.byteLength:e.size||0,e.result=t,this.taskHandle?this.onLoadQueue.push({callback:s,task:e}):(e.abortController=null,s(e));},u=t=>{2===e.status&&s(e,t),n();};return "image+type"!==e.docType?(e.request.then((e=>i(e.data)),u),!0):(e.request.then((s=>{const l=s.data,d=j$b(l);if(o="image",e.size=l.byteLength,"unknown"===d)return e.request=L$w(e.url,{responseType:o,timeout:r,signal:a}),void e.request.then((e=>i(e.data)),u);const h=new Blob([l],{type:d}),c=window.URL.createObjectURL(h);n=()=>window.URL.revokeObjectURL(c),e.request=L$w(c,{responseType:o,timeout:r,signal:a}),e.request.then((e=>i(new Q$5(e.data,d,n))),u);}),u),!0)}get test(){return {loadQueue:this.loadQueue}}};function j$b(e){if(e.byteLength<2)return "unknown";const t=new Uint8Array(e,0,e.byteLength);return 137===t[0]&&80===t[1]?"image/png":71===t[0]&&73===t[1]?"image/gif":66===t[0]&&77===t[1]?"image/bmp":255===t[0]&&216===t[1]?"image/jpeg":"unknown"}e$Q([y$K({readOnly:!0})],L$9.prototype,"updating",void 0),L$9=e$Q([n$14("esri.views.3d.support.StreamDataLoader")],L$9);class Q$5{constructor(e,t,s){this.image=e,this.type=t,this.release=s;}get isOpaque(){return "image/jpeg"===this.type}}var w$9=L$9;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
let y$b=class extends p$14{constructor(){super(...arguments),this.updating=!1;}};function g$g(e,t=(()=>performance.now())){return new C$5.ResourceController({view:e,now:t})}var C$5;e$Q([y$K({readOnly:!0})],y$b.prototype,"updating",void 0),y$b=e$Q([n$14("esri.views.3d.support.ResourceController")],y$b),function(t){let g=class extends y$b{constructor(){super(...arguments),this._scheduler=null,this._memoryController=null,this._streamDataLoader=null,this._cameraChangeTime=0,this._handles=new u$T,this._frameTask=null,this._scheduleTask=y$x;}initialize(){this._cameraChangeTime=this.now(),this._scheduler=g$B(this.now),this._memoryController=o$k(this.view),this._streamDataLoader=new w$9,this._streamDataLoader.setup(n$n,r$k,this._scheduler),this._handles.add([this.view.watch("state.camera",((e,t)=>this._cameraChangedHandler(e,t)),!0),this.view.watch("stationary",(()=>this._stationaryChangedHandler())),this._memoryController.events.on("updating-changed",(()=>this.notifyChange("updating")))]),this._frameTask=A$D({update:e=>this.frame(e)}),this._scheduleTask=this._scheduler.registerTask(p$H.RESOURCE_CONTROLLER);}destroy(){this._handles=l$W(this._handles),this._scheduleTask.remove(),this._frameTask=s$17(this._frameTask),this._streamDataLoader=l$W(this._streamDataLoader),this._memoryController=l$W(this._memoryController),this._scheduler=l$W(this._scheduler);}get updating(){var e,t;return !!(null!=(e=this._memoryController)&&e.updating||null!=(t=this._streamDataLoader)&&t.updating)}get scheduler(){return this._scheduler}get memoryController(){return this._memoryController}schedule(e,t,r){return this._scheduleTask.schedule(e,t,r)}createStreamDataRequester(e){const t=this._streamDataLoader;return {request:(r,s,o)=>t.request(r,s,e,o),get busy(){return !t.hasDownloadSlots(e)}}}frame(e){this.view.suspended||this.view.stateManager&&(this.view.stateManager.step(u$19(e.deltaTime)),!this._scheduler)||(this._scheduler.state=this.state,this._scheduler.updateBudget(e)?(this._memoryController.update(),this._scheduler.frame()):this._memoryController.updating&&this._memoryController.update());}_cameraChangedHandler(e,t){e&&t&&e.almostEquals(t)||(this._cameraChangeTime=this._scheduler.now,this._scheduler.state=this.state);}_stationaryChangedHandler(){this.memoryController.resetStableQuality();}get state(){const e=this.view;return e.animation?0:e.interacting||this._scheduler.now-this._cameraChangeTime<=C?1:2}get test(){return {getQueueStats:e=>this._streamDataLoader.test.loadQueue.getStatsForType(e),state:this.state}}};e$Q([y$K({constructOnly:!0})],g.prototype,"view",void 0),e$Q([y$K({constructOnly:!0})],g.prototype,"now",void 0),e$Q([y$K()],g.prototype,"_scheduler",void 0),e$Q([y$K()],g.prototype,"_memoryController",void 0),e$Q([y$K()],g.prototype,"_streamDataLoader",void 0),e$Q([y$K({readOnly:!0})],g.prototype,"updating",null),g=e$Q([n$14("esri.views.3d.support.ResourceController")],g),t.ResourceController=g;const C=300;}(C$5||(C$5={}));

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
function n$l(n){return "performanceInfo"in n}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
const m$h={bandCount:3,outMin:0,outMax:1,minCutOff:[0,0,0],maxCutOff:[255,255,255],factor:[1/255,1/255,1/255],useGamma:!1,gamma:[1,1,1],gammaCorrection:[1,1,1],colormap:null,colormapOffset:null,type:"stretch"};class d$f{constructor(t,r,e=null,s=null){this._memoryUsed=null,this._source=null,this._symbolizerParameters=null,this._bandIds=null,this._interpolation=null,this._dirty=!1,this._transformGrid=null,this.isRendereredSource=!1,this.symbolizerRenderer=null,this.rawPixelData=null,this.lij=null,this.scale=1,this.offset=[0,0],this.opacity=1,this.lij=t,this.source=r,this.width=e||r.width,this.height=s||r.height;}get source(){return this._source}set source(t){this._source=t,this._rasterTexture&&(this._rasterTexture.dispose(),this._rasterTexture=null,this._memoryUsed=null);}get symbolizerParameters(){return this.isRendereredSource?{...m$h,maxCutOff:[1,1,1],factor:[1,1,1]}:this._symbolizerParameters||m$h}set symbolizerParameters(t){this._symbolizerParameters=t;}get bandIds(){return this._bandIds}set bandIds(r){if(r$Y(r)&&r.length>0){this._bandIds&&r.every(((t,r)=>!!this._bandIds[r]&&t===this._bandIds[r]))||(this._bandIds=r,this._dirty=!0);}else this._bandIds=null;}get interpolation(){return this._interpolation}set interpolation(t){this._interpolation=t,this._rasterTexture&&this._rasterTexture.setSamplingMode("bilinear"===t?9729:9728);}get transformGrid(){return this._transformGrid}set transformGrid(t){this._transformGrid=t,this._transformGridTexture&&(this._transformGridTexture.dispose(),this._transformGridTexture=null,this._memoryUsed=null);}bind(t){return !!(this.source&&this.source.pixels&&this.source.pixels.length>0)&&(this._rasterTexture&&!this._dirty||this._updateRasterTexture(t,this.bandIds),this._rasterTexture&&(this._updateColormapTexture(t),this.transformGrid&&!this._transformGridTexture&&(this._transformGridTexture=i$18(t,this.transformGrid))),!0)}getUniforms(){const t=u$1a(this.scale,this.offset),{symbolizerParameters:r,transformGrid:e,width:s,height:u,opacity:n}=this;return {basic:t,common:o$1b(e,[s,u],[this.source.width,this.source.height],n),colormap:r.colormap?s$1a(r.colormap,r.colormapOffset):null,stretch:"stretch"===this.symbolizerParameters.type?l$1f(this.symbolizerParameters):null,hillshade:"hillshade"===this.symbolizerParameters.type?f$Z(this.symbolizerParameters):null}}getTextures(){const t=new Array,r=[];return this._rasterTexture&&(r.push(this._rasterTexture),t.push("u_image"),this._transformGridTexture&&(r.push(this._transformGridTexture),t.push("u_transformGrid")),this._colormapTexture&&(r.push(this._colormapTexture),t.push("u_colormap"))),{names:t,textures:r}}get memoryUsage(){if(t$17(this._memoryUsed)){const t=this.getTextures();if(null==t)return 0;this._memoryUsed=t.textures.map((t=>t.descriptor.width*t.descriptor.height*4)).reduce(((t,r)=>t+r),0);}return this._memoryUsed}release(){return this._rasterTexture=i$S(this._rasterTexture),this._transformGridTexture=i$S(this._transformGridTexture),this._colormapTexture=i$S(this._colormapTexture),this.source=null,this.transformGrid=null,this.rawPixelData=null,!0}_updateRasterTexture(e,s){const i=this.source?this.source.extractBands(s):null;if(!(i&&i.pixels&&i.pixels.length>0))return void(this._rasterTexture&&(this._rasterTexture.dispose(),this._rasterTexture=null));const o=t$17(s)&&t$17(this.bandIds)||r$Y(s)&&r$Y(this.bandIds)&&s.join("")===this.bandIds.join("");if(this._rasterTexture){if(o)return;this._rasterTexture.dispose(),this._rasterTexture=null;}this._rasterTexture=n$1t(e,i,this.interpolation||"nearest",this.isRendereredSource);}_updateColormapTexture(t){const r=this._colormap,e=this.symbolizerParameters.colormap;return e?r?e.length!==r.length||e.some(((t,e)=>t!==r[e]))?(this._colormapTexture&&(this._colormapTexture.dispose(),this._colormapTexture=null),this._colormapTexture=r$1r(t,e),void(this._colormap=e)):void 0:(this._colormapTexture=r$1r(t,e),void(this._colormap=e)):(this._colormapTexture&&(this._colormapTexture.dispose(),this._colormapTexture=null),void(this._colormap=null))}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
const h$h=n$11(),p$g=n$11(),g$f=n$11(),d$e=n$11();function M$a(e,t,o=0){const n=e.extent;if(0===o)return g$U(n,t);const r=Math.min(n[2]-n[0],n[3]-n[1]);return j$L(n,t,o*r)}function v$9(e,i,a,l){r$Z(h$h,a),h$h[l]=i[l];const c=c$V(h$h,h$h,i),u=c$V(p$g,e,i),f=z$u(u,c),m=z$u(c,c);let g;g=f<=0?i:m<=f?a:u$S(h$h,i,d$O(c,c,f/m));const d=c$V(h$h,e,g);return Math.PI/2-Math.atan(d[2]/Math.sqrt(d[0]*d[0]+d[1]*d[1]))}function x$9(e,t,o){const n=e.extent;g$f[0]=n[0],g$f[1]=n[1],g$f[2]=o,d$e[0]=n[2],d$e[1]=n[3],d$e[2]=o;let r=1/0,s=1/0;return t[0]<g$f[0]?r=v$9(t,g$f,d$e,0):t[0]>d$e[0]&&(r=v$9(t,d$e,g$f,0)),t[1]<g$f[1]?s=v$9(t,g$f,d$e,1):t[1]>d$e[1]&&(s=v$9(t,d$e,g$f,1)),Math.min(r,s)}function S$a(t,o,n){if(t.spatialReference.isGeographic)return new s$Q("tilingscheme:local-gcs-not-supported","Geographic coordinate systems are not supported in local scenes");const r=x$L.checkUnsupported(t);if(r)return r;const s=w$8(t,n);return s||(o&&!t.spatialReference.equals(o)?new s$Q("tilingscheme:spatial-reference-mismatch","The tiling scheme does not match the spatial reference of the local scene"):null)}function w$8(t,o){const n=t.lods,r=n[0].resolution*2**n[0].level,s=[r*t.size[0],r*t.size[1]],i=[t.origin.x,t.origin.y],a=a$1m(o),l=i$P();x$L.computeRowColExtent(a,s,i,l);const h=(l[2]-l[0])*(l[3]-l[1]);if(h>I$v){const o=n[0].scale*2**n[0].level;let s=Math.max((a[3]-a[1])/t.size[1],(a[2]-a[0])/t.size[0])*o/r;const i=Math.floor(Math.log(s)/Math.log(10));return s=Math.ceil(s/10**i)*10**i,new s$Q("tilingscheme:too-many-root-tiles","Scale of level 0 of the tiling scheme (1:"+Math.floor(o).toLocaleString()+") is too large for the layer's extent. Suggested scale: 1:"+s.toLocaleString()+".",{level0Scale:o,suggestedLevel0Scale:s,requiredNumRootTiles:h,allowedNumRootTiles:I$v})}return null}var j$a=Object.freeze({__proto__:null,isInsideExtent:M$a,tiltToExtentEdge:x$9,checkIfTileInfoSupportedForViewSR:S$a});

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
function l$f(){return !0}function o$j(){return 0}function s$j(l,o){const s=l.lods.length-1,c=l.spatialReference,a=Zn(c)||k$y(c)||P$y(c);if(c.isWebMercator){if(!x$L.makeWebMercatorAuxiliarySphere(s).compatibleWith(l))return new s$Q("tilingscheme:incompatible-global-web-mercator","The tiling scheme is not compatible with the ArcGIS Online Web Mercator tiling scheme")}else {if(!a)return new s$Q("tilingscheme:global-unsupported-spatial-reference","The tiling scheme spatial reference is not supported in global scenes");if(!x$L.makeGCSWithTileSize(l.spatialReference,l.size[0],s).compatibleWith(l))return l.spatialReference.isWGS84?new s$Q("tilingscheme:incompatible-global-wgs84","The tiling scheme is not compatible with the ArcGIS Online WGS84 tiling scheme"):new s$Q("tilingscheme:incompatible-global","The tiling scheme is not compatible with the ArcGIS Online tiling scheme")}if(o&&!l.spatialReference.equals(o))return new s$Q("tilingscheme:spatial-reference-mismatch","The tiling scheme does not match the spatial reference of the global scene")}var c$j=Object.freeze({__proto__:null,isInsideExtent:l$f,tiltToExtentEdge:o$j,checkIfTileInfoSupportedForViewSR:s$j});

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class t$q{constructor(t){this._texture=t,this._refCount=1;}retain(){++this._refCount;}release(){--this._refCount,0===this._refCount&&this._texture.dispose();}get texture(){return this._texture}generateMipmap(){this._texture.generateMipmap();}get descriptor(){return this._texture.descriptor}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
const a$f={1:c$j,2:j$a};function f$e(e,t){e||console.warn("Terrain: "+t);}const c$i=1.2,s$i=80/180*Math.PI,d$d=110/180*Math.PI;function m$g(n,l,i){const o=a$f[n.viewingMode];let r;if(o.isInsideExtent(n,l))r=c$W(n.getElevation(l[0],l[1],l[1],n.spatialReference),0);else {if(!o.isInsideExtent(n,l,c$i))return 0;const e=n.getTileWithElevation(l[0],l[1],l[1],n.spatialReference);r=.5*((r$Y(e)?e.elevationBounds[0]:n.elevationBounds.min)+(r$Y(e)?e.elevationBounds[1]:n.elevationBounds.max));const i=o.tiltToExtentEdge(n,l,r);if(i>s$i&&i<d$d)return 0}const u=l[2]-r;return Math.abs(u)<i?0:u<0?-1:1}function v$8(e){return x$8(e)?{fullExtent:e.fullExtent,minScale:e.layer.minScale,maxScale:e.layer.maxScale,tilemapCache:null}:e.layer}function p$f(e){return "vector-tile"===(null==e?void 0:e.type)}function I$7(e){return "imagery-tile"===(null==e?void 0:e.type)||"wcs"===(null==e?void 0:e.type)}function x$8(e){return "imagery-tile-3d"===(null==e?void 0:e.type)}function y$a(e){return "tile-3d"===(null==e?void 0:e.type)}function E$6(e){return "vector-tile-3d"===(null==e?void 0:e.type)}function T$a(e){return "wmts-3d"===(null==e?void 0:e.type)}function h$g(e){return "elevation-3d"===(null==e?void 0:e.type)}function g$e(e){return e&&(y$a(e)||x$8(e)||h$g(e)||E$6(e)||T$a(e))}function L$8(e){var t;return (null==e||null==(t=e.sourceLayerInfo)?void 0:t.data)instanceof d$f}function S$9(e){var t;return (null==e||null==(t=e.sourceLayerInfo)?void 0:t.data)instanceof d$15}function M$9(e){var t;return (null==e||null==(t=e.sourceLayerInfo)?void 0:t.data)instanceof t$q}function j$9(e){var t;const n=null==e||null==(t=e.sourceLayerInfo)?void 0:t.data;return n instanceof HTMLImageElement||n instanceof Q$5||n instanceof HTMLCanvasElement||n instanceof ImageData}function w$7(e){return r$Y(e)&&"release"in e&&e.release(),null}function b$8(e){return e.fetchTile&&!1!==e.hasOverriddenFetchTile}function B$6(e,t,n,l){return a$f[l].checkIfTileInfoSupportedForViewSR(e,n,t)}function C$4(e,t,n){let l,i;if("wmts"===e.type){const o=e.activeLayer;if(o){const e=o.tileMatrixSet;if(e)l=e.tileInfo,i=e.fullExtent;else {const e=o.tileMatrixSets;if(e){const l=e.find((e=>null==B$6(e.tileInfo,e.fullExtent,t,n)));if(l)return {tileInfo:l.tileInfo,fullExtent:l.fullExtent}}}}}else i=I$7(e)?e.getCompatibleFullExtent(t):e.fullExtent,l=p$f(e)&&!R$8.force512VTL?e.compatibleTileInfo256:I$7(e)?e.getCompatibleTileInfo(t,i,2===n):e.tileInfo;return l&&i&&null==B$6(l,i,t,n)?{tileInfo:l,fullExtent:i}:{tileInfo:null,fullExtent:null}}const R$8={force512VTL:!1};

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class t$p{constructor(t,s){if(this.layer=null,this.memory=0,this.displayedNumberOfFeatures=0,this.maximumNumberOfFeatures=null,this.totalNumberOfFeatures=null,this.layer=t.layer,this.memory=g$e(t)?s.basemapTerrain.getUsedMemoryForLayerView(t):t.getUsedMemory(),n$l(t)){const e=t.performanceInfo;this.displayedNumberOfFeatures=e.displayedNumberOfFeatures,this.maximumNumberOfFeatures=e.maximumNumberOfFeatures,this.totalNumberOfFeatures=e.totalNumberOfFeatures;}}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class s$h{constructor(s){this.totalMemory=0,this.usedMemory=0,this.quality=1,this.load=0,this.terrainMemory=0,this.edgesMemory=0,this.layerPerformanceInfos=new Array;const a=s.resourceController.memoryController;this.totalMemory=1048576*a.maxMemory,this.usedMemory=Math.round(a.usedMemory*this.totalMemory),this.quality=a.memoryFactor,this.load=s.resourceController.scheduler.load,this.terrainMemory=s.basemapTerrain?s.basemapTerrain.getUsedMemory():0;const m=s._stage&&s._stage.renderView&&s._stage.renderView.edgeView;this.edgesMemory=r$Y(m)?m.usedMemory:0,s.allLayerViews.items.forEach((e=>{(e$i(e)||g$e(e))&&this.layerPerformanceInfos.push(new t$p(e,s));})),this.layerPerformanceInfos.sort(((e,r)=>r.memory-e.memory));}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class h$f{constructor(t,r,s,o){this._streamDataRequester=t,this._stage=r,this._textureOptions=s,this._textureRequests=new Map,this._frameTask=r$Y(o)?o.registerTask(p$H.TEXTURE_UNLOAD):y$x;}destroy(){this._frameTask.remove(),this._textureRequests.forEach((e=>this.releaseTextureRequest(e))),this._textureRequests.clear();}async fromUrl(u,i,n){a$1i(n);const l=r$Y(n)&&n.signal,a=this.makeUid(u,i);let h=this._textureRequests.get(a);if(!h){const e=h$N(),t=this._streamDataRequester.request(u,"image",{uid:a,signal:e.signal});h={referenceCount:0,texture:null,textureAsync:null,abortController:e},this._textureRequests.set(a,h),h.textureAsync=t.then((e=>{const t=this.createTexture(u,e,i);return h.texture=t,h.abortController=null,this.addToStage(t),{uid:a,texture:t}}),(e=>{throw h.abortController=null,e}));}return h.referenceCount++,new Promise(((e,t)=>{v$P(l,(()=>{t(m$Y());})),h.textureAsync.then(e,t);})).catch((e=>{throw this.release(a),e}))}fromData(e,t){const r=this.makeUid(e);let s=this._textureRequests.get(r);return s||(s={referenceCount:0,texture:t(),textureAsync:null,abortController:null},this.addToStage(s.texture),this._textureRequests.set(r,s)),s.referenceCount++,{uid:r,texture:s.texture}}release(e){if(!this._textureRequests)return;const t=this._textureRequests.get(e);t?(t.referenceCount<1&&console.warn("TextureCollection: reference count is < 1 for "+e),t.referenceCount--,t.referenceCount<1&&this._frameTask.schedule((()=>this.releaseNow(e)))):console.warn(`TextureCollection: texture doesn't exist: '${e}'`);}get test(){return {textureRequests:this._textureRequests}}releaseNow(e){if(!this._textureRequests)return;const t=this._textureRequests.get(e);!t||t.referenceCount>0||(this.releaseTextureRequest(t),this._textureRequests.delete(e));}releaseTextureRequest(e){e.texture?this.removeFromStage(e.texture):e.abortController&&(e.abortController.abort(),e.abortController=null);}createTexture(e,t,r){const s={...this._textureOptions,powerOfTwoResizeMode:2};if(wt$1(e)){if(r||0===t.width&&0===t.height){const e=t.width?t.height/t.width:1;r=r||64,e>1?(t.width=Math.round(r/e),t.height=r):(t.width=r,t.height=Math.round(r*e));}this._stage.renderView&&f$_(this._stage.renderView.renderingContext).svgAlwaysPremultipliesAlpha&&(s.preMultiplyAlpha=!1);}return s.width=t.width,s.height=t.height,new S$E(t,s)}addToStage(e){this._stage.add(e);}removeFromStage(e){this._stage.remove(e);}makeUid(e,t){return null!=t?`${e}.${t}px`:e}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class c$h{constructor(e){this.textures=null,this.streamDataRequester=null,this.graphicsOwners=[],this.screenSizePerspectiveHandles=null,this.cimSymbolRasterizer=null,this.viewState=e.viewState,this.view=e.view,this.pointsOfInterest=e.pointsOfInterest,this.objectResourceCache=e.objectResourceCache,this.streamDataRequester=e.resourceController.createStreamDataRequester(4),this.textures=new h$f(this.streamDataRequester,e.view._stage,{preMultiplyAlpha:!0,wrap:{s:33071,t:33071}},e.resourceController.scheduler);const t=p$15(this.view.spatialReference).radius;this.screenSizePerspectiveSettings=i$19(e.viewingMode,t),this.screenSizePerspectiveSettingsLabels=r$1s(e.viewingMode,t);}destroy(){this.textures.destroy(),this.textures=null,this.streamDataRequester=null;}addGraphicsOwner(t){if(!t)return {remove(){}};this.graphicsOwners.push(t);const s="layer"in t?t.watch("layer.screenSizePerspectiveEnabled",(()=>this.updateScreenSizePerspectiveEnabled())):null;return this.updateScreenSizePerspectiveEnabled(),{remove:()=>{s&&(s.remove(),v$Q(this.graphicsOwners,t),this.updateScreenSizePerspectiveEnabled());}}}updateScreenSizePerspectiveEnabled(){const e=this.graphicsOwners.some((e=>!0===e.get("layer.screenSizePerspectiveEnabled")));if(e&&!this.screenSizePerspectiveHandles){this.screenSizePerspectiveHandles=new u$T;const e=()=>this.updateScreenSizePerspectiveSettings();this.screenSizePerspectiveHandles.add([this.pointsOfInterest.centerOnSurfaceInfrequent.watch("distance",e,!0),this.viewState.events.on("camera-projection-changed",e)]),this.updateScreenSizePerspectiveSettings();}else !e&&this.screenSizePerspectiveHandles&&(this.screenSizePerspectiveHandles.destroy(),this.screenSizePerspectiveHandles=null);}updateScreenSizePerspectiveSettings(){const e=this.pointsOfInterest;a$e.distance=e.centerOnSurfaceInfrequent.distance,a$e.fovY=this.viewState.camera.fovY,this.screenSizePerspectiveSettings.update(a$e),this.screenSizePerspectiveSettingsLabels.update(a$e),this.view._stage.renderView.setNeedsRender();}}const a$e={distance:0,fovY:0};

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class l$e{constructor(o,r,s=""){this.graphics=o,this._symbol=new d$16({symbolLayers:[new S$G({material:{color:r},outline:{color:[255,255,255],size:1},resource:{primitive:"circle"}}),new y$V({text:s,halo:{color:"white",size:1/.75},material:{color:r},size:12})]});}showPoint(s,i){if(t$17(i))return;this.remove();const e=new b$G({x:s[0],y:s[1],z:s[2],spatialReference:i});this._graphic=new h$R({geometry:e,symbol:this._symbol}),this.graphics.add(this._graphic);}remove(){r$Y(this._graphic)&&(this.graphics.remove(this._graphic),this._graphic=null);}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
let c$g=class extends p$14{constructor(r){super(r),this.handles=new u$T;}destroy(){this.handles.destroy();}};e$Q([y$K({constructOnly:!0})],c$g.prototype,"renderCoordsHelper",void 0),e$Q([y$K({constructOnly:!0})],c$g.prototype,"surface",void 0),e$Q([y$K({constructOnly:!0})],c$g.prototype,"state",void 0),c$g=e$Q([n$14("esri.views.3d.support.PointOfInterest")],c$g);

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
const m$f=Array;let y$9=class extends c$g{constructor(t){super(t),this._dirty=!1,this._propertiesPool=new o$m({location:b$G,renderLocation:m$f},this),this._estimatedSurfaceAltitude=0,this._pendingElevationQueryController=null,this.cameraName="camera",this.renderLocation=n$11(),this.tmpPoint=new b$G;}initialize(){if(this.scheduler&&this.handles.add(this.scheduler.registerTask(this.task,this)),this.runTask(),this.map){const t=()=>this._setDirty();this.handles.add(C$q(this.map,"ground.layers","change",t,t,t));}this._updateRenderLocation();}destroy(){this._cancelPendingRequest(),this._propertiesPool.destroy(),this._propertiesPool=null;}get _camera(){return this.state[this.cameraName]}get location(){const t=this._propertiesPool.get("location");return this.renderCoordsHelper.fromRenderCoords(this.renderLocation,t,this.state.spatialReference),t}get scale(){const t=this._camera,e=q$o(t.eye,this.renderLocation),r={renderCoordsHelper:this.renderCoordsHelper,state:{camera:t}};return V$f(r,e,0)}get updating(){return this._dirty||null!=this._pendingElevationQueryController}updateRenderLocation(){this._setDirty(),this._updateRenderLocation();}_setDirty(){this._dirty||(this._dirty=!0,this.notifyChange("updating"));}_cancelPendingRequest(){const t=this._pendingElevationQueryController;t&&(this._pendingElevationQueryController=null,t.abort(),this.notifyChange("updating"));}get running(){return !this._pendingElevationQueryController&&this._dirty}runTask(){if(this._cancelPendingRequest(),this._dirty=!1,this.notifyChange("updating"),!this.map||!this.map.ground)return void this._updateSurfaceAltitude(0);this.renderCoordsHelper.fromRenderCoords(this._camera.eye,this.tmpPoint,this.state.spatialReference);let t=h$N();this.map.ground.queryElevation(this.tmpPoint,{signal:t.signal,cache:this.cache}).then((t=>this._updateSurfaceAltitude(t.geometry.z))).catch((t=>{g$T(t)||this._updateSurfaceAltitude(0);})).catch((()=>{})).then((()=>{this._pendingElevationQueryController===t&&(this._pendingElevationQueryController=null,this.notifyChange("updating")),t=null;})),this._pendingElevationQueryController=t;}_updateSurfaceAltitude(t){this._estimatedSurfaceAltitude!==t&&(this._estimatedSurfaceAltitude=t,this._updateRenderLocation());}_updateRenderLocation(){this.renderCoordsHelper.setAltitude(_$8,this._estimatedSurfaceAltitude,this._camera.eye),F$v(this._get("renderLocation"),_$8)||this._set("renderLocation",r$Z(this._propertiesPool.get("renderLocation"),_$8));}};e$Q([y$K({constructOnly:!0})],y$9.prototype,"scheduler",void 0),e$Q([y$K({constructOnly:!0})],y$9.prototype,"cache",void 0),e$Q([y$K({constructOnly:!0})],y$9.prototype,"task",void 0),e$Q([y$K({constructOnly:!0})],y$9.prototype,"cameraName",void 0),e$Q([y$K({readOnly:!0})],y$9.prototype,"location",null),e$Q([y$K({constructOnly:!0})],y$9.prototype,"map",void 0),e$Q([y$K({readOnly:!0})],y$9.prototype,"renderLocation",void 0),e$Q([y$K({readOnly:!0})],y$9.prototype,"scale",null),e$Q([y$K({readOnly:!0})],y$9.prototype,"updating",null),y$9=e$Q([n$14("esri.views.3d.support.CameraOnSurface")],y$9);const _$8=n$11();var g$d=y$9;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
const S$8=Array;let _$7=class extends c$g{constructor(t){super(t),this._propertiesPool=new o$m({location:b$G,renderLocation:S$8},this),this._currentSurfaceAltitude=0,this._latestSurfaceAltitude=0,this.distance=0,this.renderLocation=n$11(),this.updating=!1;}initialize(){this._frameWorker=this.scheduler.registerTask(this.task,this),this.runTask();}destroy(){this._frameWorker&&(this._frameWorker.remove(),this._frameWorker=null),this._propertiesPool.destroy(),this._propertiesPool=null;}get location(){const t=this._propertiesPool.get("location");return this.renderCoordsHelper.fromRenderCoords(this.renderLocation,t,this.state.spatialReference),t}updateRenderLocation(){this.updating=!0,this._updateRenderLocation();}get estimatedSurfaceAltitude(){return this._latestSurfaceAltitude}get running(){return this.updating}runTask(){this._latestSurfaceAltitude=this.estimateSurfaceAltitudeAtCenter(),this._updateRenderLocation(),this.updating=!1;}_updateRenderLocation(){const t=g$c;let e=this.calculateSurfaceIntersection(this._currentSurfaceAltitude,t);const r=this._currentSurfaceAltitude!==this._latestSurfaceAltitude;!e&&r&&(e=this.calculateSurfaceIntersection(this._latestSurfaceAltitude,t),e&&(this._currentSurfaceAltitude=this._latestSurfaceAltitude));const s=A$6;if(e&&this.latestSurfaceAltitudeChangesDistanceSignificantly(t,s)&&(r$Z(t,s),this._currentSurfaceAltitude=this._latestSurfaceAltitude),e)this.distance=q$o(this.state.camera.eye,t);else {const e=this.state.camera;d$O(t,e.viewForward,this._get("distance")),u$S(t,t,e.eye);}F$v(this._get("renderLocation"),t)||this._set("renderLocation",r$Z(this._propertiesPool.get("renderLocation"),t));}calculateSurfaceIntersection(t,r){const s=this.state.camera;if(!this.renderCoordsHelper.intersectManifold(s.ray,t,r))return !1;if(this.state.isGlobal){const e=p$15(this.renderCoordsHelper.spatialReference).radius,i=e+t,c=p$12(s.eye),l=c<i*i,d=q$o(s.eye,r);if(l&&d>e/4){const t=i-Math.sqrt(c);return d$O(r,s.viewForward,t),u$S(r,r,s.eye),!0}}else {const t=this.surface.ready&&this.surface.extent;t&&(r[0]=o$R(r[0],t[0],t[2]),r[1]=o$R(r[1],t[1],t[3]));}return !0}latestSurfaceAltitudeChangesDistanceSignificantly(t,e){if(this._latestSurfaceAltitude===this._currentSurfaceAltitude||null==t)return !1;if(this.calculateSurfaceIntersection(this._latestSurfaceAltitude,e)){if(T$k.TESTS_DISABLE_UPDATE_THRESHOLDS)return !0;const r=this.state.camera.eye,s=q$o(r,t),i=q$o(r,e);if(Math.abs(i-s)/s>y$8)return !0}return !1}};e$Q([y$K({constructOnly:!0})],_$7.prototype,"scheduler",void 0),e$Q([y$K({constructOnly:!0})],_$7.prototype,"task",void 0),e$Q([y$K()],_$7.prototype,"distance",void 0),e$Q([y$K({constructOnly:!0})],_$7.prototype,"estimateSurfaceAltitudeAtCenter",void 0),e$Q([y$K({readOnly:!0})],_$7.prototype,"location",null),e$Q([y$K({readOnly:!0})],_$7.prototype,"renderLocation",void 0),e$Q([y$K()],_$7.prototype,"updating",void 0),_$7=e$Q([n$14("esri.views.3d.support.CenterOnSurface")],_$7);const y$8=.05,g$c=n$11(),A$6=n$11();var j$8=_$7;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class s$g{constructor(s){this.handles=new u$T,this.events=new n$13,this.contentLayerViews=s.contentLayerViews,this.handles.add(this.contentLayerViews.on("change",(e=>this.layerViewsChanged(e)))),this.layerViewsChanged({added:this.contentLayerViews.toArray(),removed:[],moved:[],target:this.contentLayerViews});}destroy(){this.handles&&(this.handles.destroy(),this.handles=null);}layerViewsChanged(e){e.added.forEach((e=>{"esri.views.3d.layers.SceneLayerView3D"===e.declaredClass&&this.handles.add(e.on("visible-geometry-changed",(()=>this.contentChanged())),e.uid);})),e.removed.forEach((e=>this.handles.remove(e.uid)));}contentChanged(){this.events.emit("request-update",n$k);}}const n$k={};

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
const g$b=Array;let _$6=class extends c$g{constructor(e){super(e),this._propertiesPool=new o$m({location:b$G,renderLocation:g$b},this),this._dirty=!0,this.renderLocation=this._propertiesPool.get("renderLocation");}initialize(){this.handles.add([this.centerOnSurface.watch("renderLocation",(()=>this.updateRenderLocation())),this.state.watch("camera",(()=>this.updateRenderLocation()))]),this.scheduler&&this.handles.add(this.scheduler.registerTask(p$H.POINT_OF_INTEREST_FREQUENT,this));}destroy(){this._propertiesPool.destroy(),this._propertiesPool=null;}get updating(){return this._dirty||this.centerOnSurface.updating}get location(){const e=this._propertiesPool.get("location");return this.renderCoordsHelper.fromRenderCoords(this.renderLocation,e,this.state.spatialReference),e}get running(){return this._dirty}runTask(){const e=this._get("renderLocation"),r=this.centerOnSurface.renderLocation,o=this.renderCoordsHelper,s=this.state.camera;this._dirty=!1,o.worldUpAtPosition(r,S$7);const d=Math.max(0,(Math.acos(z$u(S$7,s.viewForward))-.5*Math.PI)*(s.aboveGround?1:-1));if(Number.isNaN(d)){if(!e||!G$p(e,r)){const e=this._propertiesPool.get("renderLocation");r$Z(e,r),this._set("renderLocation",e);}return}const p=1-o$R(d/(.5*Math.PI),0,1),h=p*p*p;this._calculateScreenHorizontalEdgeOnSurface(O$6);const u=this._propertiesPool.get("renderLocation");y$N(u,r,O$6,h),e&&G$p(e,u)||this._set("renderLocation",u);}_calculateScreenHorizontalEdgeOnSurface(e){const t=this.state.camera,o=t.getRenderCenter(x$Q());if(o[1]=t.aboveGround?t.padding[2]:t.fullHeight-t.padding[0],this.estimateSurfaceIntersectionAtRenderPoint(o,e))return e;const s=this.renderCoordsHelper.getAltitude(this.centerOnSurface.renderLocation);if(t.unprojectFromRenderScreen(o,L$7)){c$V(L$7,L$7,t.eye);const r=j$F(L$7,L$7);if(this.renderCoordsHelper.intersectManifold(d$R(t.eye,r),s,e))return e}return this.renderCoordsHelper.setAltitude(e,s,t.eye)}updateRenderLocation(){this._dirty=!0;}};e$Q([y$K()],_$6.prototype,"_dirty",void 0),e$Q([y$K({constructOnly:!0})],_$6.prototype,"scheduler",void 0),e$Q([y$K({constructOnly:!0})],_$6.prototype,"centerOnSurface",void 0),e$Q([y$K({constructOnly:!0})],_$6.prototype,"estimateSurfaceIntersectionAtRenderPoint",void 0),e$Q([y$K({readOnly:!0})],_$6.prototype,"updating",null),e$Q([y$K({readOnly:!0})],_$6.prototype,"location",null),e$Q([y$K({readOnly:!0})],_$6.prototype,"renderLocation",void 0),_$6=e$Q([n$14("esri.views.3d.support.CenterOnSurface")],_$6);const S$7=n$11(),L$7=n$11(),O$6=n$11();var P$7=_$6;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
let u$c=class extends p$14{constructor(e){super(e),this.location=null,this._updateController=null,this._handles=new u$T;}get renderLocation(){if(!this.location)return null;const e=n$11();return this.view.renderCoordsHelper.toRenderCoords(this.location,e),e}initialize(){this.view.state.isLocal&&(this._handles.add([this.watch(["surfaceView.spatialReference","surfaceView.extent"],(()=>this._update())),C$q(this,"surface.layers","change",(()=>this._update()))]),this._update());}destroy(){this._handles.destroy();}_update(){if(this._updateController&&(this._updateController.abort(),this._updateController=null),!this.surfaceView||!this.surfaceView.extent||!this.surfaceView.spatialReference)return void this._set("location",null);const e=y$T(this.surfaceView.extent),t=new b$G({x:e[0],y:e[1],z:0,spatialReference:this.surfaceView.spatialReference});this.surface&&this.surface.layers.length>0?(this._set("location",null),this._updateController=h$N(),this.surface.queryElevation(t,{noDataValue:0,signal:this._updateController.signal,cache:this.cache}).then((e=>{this._updateController=null,this._set("location",e.geometry);})).catch((e=>{g$T(e)||e&&"elevation-query:invalid-layer"===e.name||console.error("StableSurfaceCenter failed to update: ",e);}))):this._set("location",t);}};e$Q([y$K({constructOnly:!0})],u$c.prototype,"view",void 0),e$Q([y$K({constructOnly:!0})],u$c.prototype,"cache",void 0),e$Q([y$K({readOnly:!0,aliasOf:"view.map.ground"})],u$c.prototype,"surface",void 0),e$Q([y$K({readOnly:!0,aliasOf:"view.basemapTerrain"})],u$c.prototype,"surfaceView",void 0),e$Q([y$K({readOnly:!0})],u$c.prototype,"location",void 0),e$Q([y$K({readOnly:!0})],u$c.prototype,"renderLocation",null),u$c=e$Q([n$14("esri.views.3d.terrain.StableSurfaceCenter")],u$c);

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
let h$e=class extends p$14{constructor(){super(...arguments),this.handles=new u$T,this._tileGeometryUpdateExtent=B$m(),this._tileGeometryUpdateSpatialReference=null,this.events=new n$13,this.updating=!1;}initialize(){this.handles.add([this.surface.on("elevation-change",(e=>this._tileGeometryChanged(e))),this.scheduler.registerTask(p$H.SURFACE_GEOMETRY_UPDATES,this)]);}destroy(){this.handles&&(this.handles.destroy(),this.handles=null);}get running(){return this.updating}runTask(){this.updating&&(this._centerIntersectsExtent(this._tileGeometryUpdateExtent,this._tileGeometryUpdateSpatialReference)&&this.events.emit("request-update",u$b),B$m(this._tileGeometryUpdateExtent),this._set("updating",!1));}_tileGeometryChanged(e){this._tileGeometryUpdateSpatialReference=e.spatialReference,c$14(this._tileGeometryUpdateExtent,e.tile.extent),this._set("updating",!0);}_furthestCenterOnSurface(){let e=this.centerOnSurfaces[0];for(let t=1;t<this.centerOnSurfaces.length;t++){const r=this.centerOnSurfaces[t];r.distance>e.distance&&(e=r);}return e}_centerIntersectsExtent(e,t){const r=this.state.camera.eye,s=f$d,o=this._furthestCenterOnSurface();return this.renderCoordsHelper.fromRenderCoords(r,l$d,t),this.renderCoordsHelper.fromRenderCoords(o.renderLocation,m$e,t),l$d[0]<m$e[0]?(s[0]=l$d[0],s[2]=m$e[0]):(s[0]=m$e[0],s[2]=l$d[0]),l$d[1]<m$e[1]?(s[1]=l$d[1],s[3]=m$e[1]):(s[1]=m$e[1],s[3]=l$d[1]),F$A(s,e)}};e$Q([y$K({constructOnly:!0})],h$e.prototype,"state",void 0),e$Q([y$K({constructOnly:!0})],h$e.prototype,"centerOnSurfaces",void 0),e$Q([y$K({constructOnly:!0})],h$e.prototype,"renderCoordsHelper",void 0),e$Q([y$K({constructOnly:!0})],h$e.prototype,"scheduler",void 0),e$Q([y$K({constructOnly:!0})],h$e.prototype,"surface",void 0),e$Q([y$K({readOnly:!0})],h$e.prototype,"updating",void 0),h$e=e$Q([n$14("esri.views.3d.support.SurfaceGeometryUpdates")],h$e);const u$b={},l$d=n$11(),m$e=n$11(),f$d=B$m();var y$7=h$e;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
let T$9=class extends p$14{constructor(e){super(e),this._handles=new u$T,this._tmpRay=a$11(),this._centerRayDirty=!0,this._surfaceAltitudeAtCenter=0,this._surfaceAltitudeAtCenterDirty=!0,this._contentAltitudeAtCenter=0,this._contentAltitudeAtCenterDirty=!0,this._propertiesPool=new o$m({renderPointOfView:R$7},this),this.renderPointOfView=n$11(),this._pois=new Array,this._debugCenters=new Map;}initialize(){var e;const{state:t,basemapTerrain:r,renderCoordsHelper:n,map:a}=this.view;this._surfaceIntersector=new u$L(t.viewingMode),t.isGlobal?this._surfaceIntersector.options.backfacesTerrain=!1:this._surfaceIntersector.options.backfacesTerrain=!0,this._surfaceIntersector.options.invisibleTerrain=!1,this._surfaceIntersector.options.store=0,this._contentIntersector=new u$L(t.viewingMode);const c=()=>this._estimateSurfaceAltitudeAtCenter(),u=this.view.resourceController.scheduler,h=e$12(null==(e=this.view.basemapTerrain)?void 0:e.elevationQueryCache),d={state:t,scheduler:u,surface:r,renderCoordsHelper:n};this._set("centerOnSurfaceInfrequent",new j$8({...d,task:p$H.POINT_OF_INTEREST_INFREQUENT,estimateSurfaceAltitudeAtCenter:c})),this._set("centerOnSurfaceFrequent",new j$8({...d,task:p$H.POINT_OF_INTEREST_FREQUENT,estimateSurfaceAltitudeAtCenter:c})),this._set("centerOnContent",new j$8({...d,task:p$H.POINT_OF_INTEREST_FREQUENT,estimateSurfaceAltitudeAtCenter:()=>this._estimateContentAltitudeAtCenter()})),this._set("cameraOnSurface",new g$d({...d,cache:h,task:p$H.POINT_OF_INTEREST_INFREQUENT,map:a})),this._set("contentCameraOnSurface",new g$d({...d,cache:h,task:p$H.POINT_OF_INTEREST_INFREQUENT,map:a,cameraName:"contentCamera"})),this._set("surfaceGeometryUpdates",new y$7({...d,centerOnSurfaces:[this.centerOnSurfaceFrequent,this.centerOnContent,this.centerOnSurfaceInfrequent]})),this._set("contentGeometryUpdates",new s$g({contentLayerViews:this.view.allLayerViews,renderCoordsHelper:n})),this._set("surfaceOrigin",new u$c({cache:h,view:this.view})),this._set("focus",new P$7({state:t,scheduler:u,surface:r,renderCoordsHelper:n,centerOnSurface:this.centerOnSurfaceFrequent,estimateSurfaceIntersectionAtRenderPoint:(e,t)=>this._estimateSurfaceIntersectionAtRenderPoint(e,t)})),this._pois.push(this.centerOnContent,this.centerOnSurfaceFrequent,this.centerOnSurfaceInfrequent,this.cameraOnSurface,this.contentCameraOnSurface,this.focus);const f=this.view.graphics;this._debugCenters.set(this.centerOnContent,new l$e(f,"red","CenterOnContent")),this._debugCenters.set(this.centerOnSurfaceFrequent,new l$e(f,"red","CenterOnSurface")),this._debugCenters.set(this.cameraOnSurface,new l$e(f,"blue","CameraOnSurface")),this._debugCenters.set(this.contentCameraOnSurface,new l$e(f,"blue","CameraOfInterestOnSurface")),this._debugCenters.set(this.focus,new l$e(f,"green","Focus")),this._handles.add([t.watch("camera",(e=>this._cameraChanged(e)),!0),r.watch("extent",(()=>this._updateCenterPointsOfInterest())),O$A(r,"updating",(()=>this._updateCenterPointsOfInterest()),!0),this.surfaceGeometryUpdates.events.on("request-update",(()=>this._updateCenterPointsOfInterest())),this.contentGeometryUpdates.events.on("request-update",(()=>this._updateCenterOnContent())),d$S(T$k,"SHOW_POI",(e=>this._setDebug(e)))]),this._cameraChanged(this.view.state.camera);for(const s of this._pois)s.runTask();}destroy(){this._setDebug(!1),this._handles.destroy(),this._propertiesPool.destroy();for(const e of this._pois)e.destroy();this.surfaceOrigin.destroy();}get updating(){var e;return !!(null!=(e=this.surfaceGeometryUpdates)&&e.updating||this._pois.some((e=>e.updating)))}get centerRay(){return this._centerRayDirty&&(this._centerRay=this.view.sceneIntersectionHelper.getCenterRayWithSubpixelOffset(this.view.state.camera,this._tmpRay),this._centerRayDirty=!1),this._centerRay}_estimateContentAltitudeAtCenter(){if(!this._contentAltitudeAtCenterDirty)return this._contentAltitudeAtCenter;this._contentAltitudeAtCenterDirty=!1;const e=this.centerRay;return t$17(e)||(this.view.sceneIntersectionHelper.intersectRay(e,this._contentIntersector,P$6,E$5)?this._contentAltitudeAtCenter=this.view.renderCoordsHelper.getAltitude(P$6):this._contentAltitudeAtCenter=this._estimateSurfaceAltitudeAtCenter()),this._contentAltitudeAtCenter}_estimateSurfaceAltitudeAtCenter(){if(!this.view.basemapTerrain)return 0;if(!this._surfaceAltitudeAtCenterDirty)return this._surfaceAltitudeAtCenter;this._surfaceAltitudeAtCenterDirty=!1;const e=this.centerRay;if(t$17(e))return this._surfaceAltitudeAtCenter;const t=e.origin,r=u$S(P$6,e.origin,e.direction);return this._surfaceIntersector.resetWithRay(e),this._surfaceIntersector.camera=this.view.state.camera,this.view.basemapTerrain.intersect(this._surfaceIntersector,null,t,r),this._surfaceIntersector.results.min.getIntersectionPoint(P$6)&&(this._surfaceAltitudeAtCenter=this.view.renderCoordsHelper.getAltitude(P$6)),this._surfaceAltitudeAtCenter}_estimateSurfaceIntersectionAtRenderPoint(e,t){const r=p$L(this.view.state.camera,e,j$7);if(t$17(r))return null;const s=r.origin,i=u$S(P$6,r.origin,r.direction);return this._surfaceIntersector.resetWithRay(r),this._surfaceIntersector.camera=this.view.state.camera,this.view.basemapTerrain.intersect(this._surfaceIntersector,null,s,i),this._surfaceIntersector.results.min.getIntersectionPoint(t)?t:null}_cameraChanged(e){this._updateCenterPointsOfInterest();const t=e.eye;F$v(this.renderPointOfView,t)||this._set("renderPointOfView",r$Z(this._propertiesPool.get("renderPointOfView"),t));}_updateCenterPointsOfInterest(){this._centerRayDirty=!0,this._surfaceAltitudeAtCenterDirty=!0,this._contentAltitudeAtCenterDirty=!0;for(const e of this._pois)e.updateRenderLocation();}_updateCenterOnContent(){this._contentAltitudeAtCenterDirty=!0,this.centerOnContent.updateRenderLocation();}_setDebug(e){if(!e)return this._debugCenters.forEach((e=>e.remove())),void this._handles.remove("debug");for(const t of this._pois)this._handles.add(d$S(t,"renderLocation",(e=>this._debugCenters.get(t).showPoint(e,t.renderCoordsHelper.spatialReference))),"debug");}get test(){return {update:()=>{this.surfaceGeometryUpdates.runTask();for(const e of this._pois)e.runTask();},surfaceGeometryUpdates:this.surfaceGeometryUpdates}}};e$Q([y$K({readOnly:!0})],T$9.prototype,"centerOnContent",void 0),e$Q([y$K({readOnly:!0})],T$9.prototype,"centerOnSurfaceFrequent",void 0),e$Q([y$K({readOnly:!0})],T$9.prototype,"centerOnSurfaceInfrequent",void 0),e$Q([y$K({readOnly:!0})],T$9.prototype,"cameraOnSurface",void 0),e$Q([y$K({readOnly:!0})],T$9.prototype,"contentCameraOnSurface",void 0),e$Q([y$K({readOnly:!0})],T$9.prototype,"focus",void 0),e$Q([y$K({readOnly:!0})],T$9.prototype,"renderPointOfView",void 0),e$Q([y$K({readOnly:!0})],T$9.prototype,"surfaceOrigin",void 0),e$Q([y$K({readOnly:!0})],T$9.prototype,"contentGeometryUpdates",void 0),e$Q([y$K({readOnly:!0})],T$9.prototype,"surfaceGeometryUpdates",void 0),e$Q([y$K({constructOnly:!0})],T$9.prototype,"view",void 0),e$Q([y$K({readOnly:!0})],T$9.prototype,"updating",null),T$9=e$Q([n$14("esri.views.3d.support.PointsOfInterest")],T$9);const R$7=Array,P$6=n$11(),j$7=a$11(),E$5={exclude:new Set([O$B])};var U$6=T$9;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class t$o{constructor(t){this.store=t;}destroy(){this.store.destroy();}get(t){return this.store.get(t)}put(t,s){this.store.put(t,s,s.values.byteLength+256);}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
const p$e=p=>{let a=class extends p{constructor(){super(...arguments),this.slicePlaneEnabled=!1,this.supportsHeightUnitConversion=!1;}postscript(s){super.postscript(s),f$$(this.layer)&&this.addResolvingPromise(this._validateHeightModelInfo());}async _validateHeightModelInfo(){const s=$$m(this.view.defaultsFromMap,"isHeightModelInfoSearching");this.handles.add(s),await s;const e=r$1t(this.layer,this.view.heightModelInfo,this.supportsHeightUnitConversion);if(e)throw e}};return e$Q([y$K()],a.prototype,"view",void 0),e$Q([y$K()],a.prototype,"slicePlaneEnabled",void 0),a=e$Q([n$14("esri.views.3d.layers.LayerView3D")],a),a};

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
const e$g={value:.5,readOnly:!0},t$n={readOnly:!0,value:.5,get(){return this.updating?this.updatingProgressValue:1}};

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
const n$j=n=>{let p=class extends n{get imageFormatIsOpaque(){return !1}get isOpaque(){return this.fullOpacity>=1&&this.imageFormatIsOpaque}get dataLevelRange(){const e=this.tileInfo.lods,t=e[0].scale,r=e[e.length-1].scale;return this.levelRangeFromScaleRange(t,r)}get displayLevelRange(){const e=this.tileInfo.lods,t=this.layer.minScale||e[0].scale,r=this.layer.maxScale||e[e.length-1].scale,i=this.levelRangeFromScaleRange(t,r);return this.layer.maxScale&&i.maxLevel++,i}getTileUrl(e,t,r){return this.layer.getTileUrl(e,t,r)}_addTilingSchemeMatchPromise(){const e=this._getTileInfoSupportError(this.tileInfo,this.layer.fullExtent);if(e)this.addResolvingPromise(Promise.reject(e));else {const e=x$V(this.view,"basemapTerrain.tilingSchemeLocked").then((()=>{const e=this.view.basemapTerrain.tilingScheme,t=this._getTileInfoCompatibilityError(this.tileInfo,e);if(t)throw t}));this.addResolvingPromise(e);}}_getTileInfoSupportError(e,r){const i=B$6(e,r,this.view.spatialReference,this.view.state.viewingMode);if(i){const e={layer:this.layer,error:i};let r;switch(i.name){case"tilingscheme:local-gcs-not-supported":r=new s$Q("layerview:local-gcs-not-supported","Geographic coordinate systems are not supported in local scenes",e);break;case"tilingscheme:spatial-reference-mismatch":case"tilingscheme:global-unsupported-spatial-reference":r=new s$Q("layerview:spatial-reference-incompatible","The spatial reference of this layer does not meet the requirements of the view",e);break;default:r=new s$Q("layerview:tiling-scheme-unsupported","The tiling scheme of this layer is not supported by SceneView",e);}return r}return null}_getTileInfoCompatibilityError(e,r){return r.compatibleWith(e)?null:new s$Q("layerview:tiling-scheme-incompatible","The tiling scheme of this layer is incompatible with the tiling scheme of the surface")}levelRangeFromScaleRange(e,t){const r={minLevel:0,maxLevel:1/0},i=this.view&&this.view.basemapTerrain&&this.view.basemapTerrain.tilingScheme;if(!i)return r;const a=i.levels[0],s=e=>{const t=Math.log(a.scale/e)/Math.LN2;return .5-Math.abs(.5-t%1)<1e-9?Math.round(t):Math.ceil(t)};return null!=e&&e>0&&(r.minLevel=Math.max(0,s(e))),null!=t&&t>0&&(r.maxLevel=Math.max(0,s(t))),r}isUpdating(){return !!(this.view&&this.view.basemapTerrain&&this.view.basemapTerrain.updating)}};return e$Q([y$K({readOnly:!0})],p.prototype,"imageFormatIsOpaque",null),e$Q([y$K({readOnly:!0})],p.prototype,"updating",void 0),e$Q([y$K(t$n)],p.prototype,"updatingProgress",void 0),e$Q([y$K(e$g)],p.prototype,"updatingProgressValue",void 0),e$Q([y$K({readOnly:!0})],p.prototype,"fullExtent",void 0),e$Q([y$K({readOnly:!0})],p.prototype,"isOpaque",null),e$Q([y$K({readOnly:!0})],p.prototype,"dataLevelRange",null),e$Q([y$K({readOnly:!0})],p.prototype,"displayLevelRange",null),e$Q([y$K()],p.prototype,"layer",void 0),e$Q([y$K({readOnly:!0})],p.prototype,"tileInfo",void 0),p=e$Q([n$14("esri.views.3d.layers.TiledLayerView3D")],p),p};

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
let l$c=class extends(n$j(p$e(d$17))){constructor(){super(...arguments),this.type="elevation-3d";}initialize(){const e=this.get("view.map.allLayers"),o=e&&e.includes(this.layer),s=this.get("view.map.ground.layers"),t=s&&s.includes(this.layer);if(o&&!t){const e=new s$Q("layerview:elevation-layer-only","3D elevation layer '"+this.layer.id+"' can only be added in the map ground");this.addResolvingPromise(Promise.reject(e));}this._addTilingSchemeMatchPromise();}};e$Q([y$K({readOnly:!0,aliasOf:"layer.fullExtent"})],l$c.prototype,"fullExtent",void 0),e$Q([y$K()],l$c.prototype,"layer",void 0),e$Q([y$K({readOnly:!0,aliasOf:"layer.tileInfo"})],l$c.prototype,"tileInfo",void 0),l$c=e$Q([n$14("esri.views.3d.layers.ElevationLayerView3D")],l$c);var p$d=l$c;

var ElevationLayerView3D = /*#__PURE__*/Object.freeze({
    __proto__: null,
    'default': p$d
});

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class s$f{constructor(s=0,a=0){this.min=s,this.max=a,this.level=0,this.hasNoDataValues=!1;}copyFrom(s){this.min=s.min,this.max=s.max,this.level=s.level,this.hasNoDataValues=s.hasNoDataValues;}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class i$a{constructor(t,a,s){this.samplerData=null,this.level=t[0],this.i=t[1],this.j=t[2],this.extent=a;const i=s.noDataValue,o=s.values;let e=1/0,l=-1/0,h=!0,r=!1;for(let n=0;n<o.length;n++){const t=o[n];t!==i?(e=t<e?t:e,l=t>l?t:l,h=!1):r=!0;}h&&(e=0,l=0),l=l>-3e38?l:0,this.samplerData={pixelData:s.values,width:s.width,height:s.height,noDataValue:i,safeWidth:.99999999*(s.width-1),dx:(s.width-1)/(a[2]-a[0]),dy:(s.width-1)/(a[3]-a[1]),x0:a[0],y1:a[3]},this.bounds=[e,l],this.hasNoDataValues=r;}release(){this.samplerData=null,this.bounds=null;}computeMinMaxValue(t,i,o,e){e.min=1/0,e.max=-1/0,e.hasNoDataValues=!1;const l=t-this.level;if(l<=0)return e;const h=2**l;if(!(Math.floor(i/h)===this.i&&Math.floor(o/h)===this.j))return e;let r=1/0,n=-1/0;const m=this.samplerData.width,f=this.samplerData.pixelData,u=.5*n$10;let c=(m-1)/h,p=(o-this.j*h)*c,d=(i-this.i*h)*c;if(c<1){const t=Math.floor(p),s=Math.floor(d),i=t+s*m,o=f[i],l=f[i+1],h=f[i+m],r=f[i+m+1];if(o+l+h+r<u){const i=p-t,n=d-s,m=x$W(o,l,h,r,i,n),f=x$W(o,l,h,r,i+c,n),u=x$W(o,l,h,r,i,n+c),x=x$W(o,l,h,r,i+c,n+c);return e.min=Math.min(m,f,u,x),e.max=Math.max(m,f,u,x),e}p=t,d=s,c=1;}else p=Math.floor(p),d=Math.floor(d),c=Math.ceil(c);for(let a=p;a<=p+c;a++)for(let t=d;t<=d+c;t++){const s=f[a+t*m];s<u?(r=Math.min(r,s),n=Math.max(n,s)):e.hasNoDataValues=!0;}return e.min=r,e.max=n,e}static sample(a,i,o){for(const e of o){if(!e)continue;const o=e.safeWidth,l=e.width,h=e.pixelData;let r=o$R(e.dy*(e.y1-i),0,o),n=o$R(e.dx*(a-e.x0),0,o);const m=Math.floor(r),f=Math.floor(n),u=m*l+f,c=u+l,p=h[u],d=h[c],x=h[u+1],M=h[c+1];if(p+d+x+M<.5*n$10){r-=m,n-=f;const t=p+(x-p)*n;return t+(d+(M-d)*n-t)*r}}return null}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
const o$i=25,r$i=n$1e(1e3/o$i),t$m=20,m$d=n$1e(1e3/t$m);

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
function e$f(){var e;const r=null==(e=e$19.require)?void 0:e.modules;if(r){const o=Object.keys(r);for(const e of o)-1!==e.search(".glsl")&&delete r[e];}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
const $$5=3.5,ee$2=10,te$2=[[-.1,-2,3.9,2],[-.1,-3.9,3.9,.1],[-2,-3.9,2,.1],[-3.9,-3.9,.1,.1],[-3.9,-2,.1,2],[-3.9,-.1,.1,3.9],[-2,-.1,2,3.9],[-.1,-.1,3.9,3.9]];let re$2,se$1=class extends p$14{constructor(e){super(e),this._handles=new u$T,this._spatialReference=null,this._renderSR=null,this._overlaySREqualsRenderSR=!0,this._drapeSources=new Map,this._drapeTargets=new Set,this._renderedAltitude=0,this._displayOpacity=0,this._displayOpacityTime=-1,this._placementDirty=!1,this._drawTexturesDirty=!1,this._drawTexturesAnimateDirty=!1,this._layerViewsDirty=!0,this._hasUnusedRenderTargets=!1,this._longitudeCyclical=null,this._latestOriginId=0,this._maxResolution=s$U("esri-mobile")?2048:4096,this._animationTimeLast=0;}get running(){return (this._placementDirty||this._layerViewsDirty)&&(this._drapeSources.size>0||this.view.graphics.length>0||T$k.OVERLAY_DRAW_DEBUG_TEXTURE)&&!!this._spatialReference&&!this.suspended&&this.surface.ready}get _isSpherical(){return this.view.state.isGlobal}get view(){return this.surface.view}get updating(){return this.running||this.renderer.updating}get hasHighlights(){return this.renderer.hasHighlights}get rendersOccluded(){return this.renderer.rendersOccluded}initialize(){const e=this.view,t=e.state.isGlobal&&r$Y(this._spatialReference)?G$m(this._spatialReference):1;this.renderer=new Y$a({view:e,globalUnitScale:t,spatialReference:this._spatialReference}),this.renderer.onHasHighlightsChanged=()=>{this._setDrawTexturesDirty(),this.notifyChange("hasHighlights");},this.renderer.onRendersOccludedChanged=()=>{this._setDrawTexturesDirty(),this.notifyChange("rendersOccluded");},this.renderer.onContentChanged=()=>this._setDrawTexturesDirty(),this.renderer.onHasWaterChanged=t=>{var r;return null==(r=e._stage)?void 0:r.renderView.setRenderParameters({hasOverlayWater:t})},this.groundIntersector=new u$L(this.view.state.viewingMode),this.groundIntersector.options.backfacesTerrain=!0,this.groundIntersector.options.invisibleTerrain=!0,this.groundIntersector.options.hud=!1,this._handles.add([e.watch(["pointsOfInterest.renderPointOfView","pointsOfInterest.centerOnSurfaceFrequent.location","pixelRatio"],(()=>this.setOverlayPlacementDirty())),this.surface.on("elevation-change",(()=>this.setOverlayPlacementDirty())),e.allLayerViews.on("after-changes",(()=>this._layerViewsDirty=!0)),e.on("resize",(()=>this.setOverlayPlacementDirty())),A$D({preRender:e=>{this.renderer.processSyncLayers(),this._updateLayerViews(),this.renderer.hasOverlays&&(this._dispatchRendererUpdate(e),this._drawOverlayTextures(this.renderer.overlays)),this._hasUnusedRenderTargets&&this._collectUnusedRenderTargetMemory();}}),e.resourceController.scheduler.registerTask(p$H.OVERLAY_MANAGER,this),e._stage.renderView.events.on("force-camera-for-screenshot",(e=>{this._updateOverlays(e),this.renderer.hasOverlays&&this._drawOverlayTextures(this.renderer.overlays);}))]),this._updateLayerViews();}destroy(){this._drapeSources.forEach(((e,t)=>this.unregisterDrapeSource(t))),this._drapeTargets.forEach((e=>this._unregisterDrapeTarget(e))),this.renderer.dispose(),this._handles&&(this._handles.destroy(),this._handles=null),r$Y(re$2)&&(re$2.remove(),re$2=null);}get hasOverlays(){return this.renderer.hasOverlays}setSpatialReference(e){this._spatialReference=e,this.renderer.spatialReference=e,this._longitudeCyclical=null;const t=this.view.renderSpatialReference;r$Y(e)&&r$Y(t)?(this._renderSR=t,this._overlaySREqualsRenderSR=e.equals(this._renderSR),this._isSpherical&&(this._longitudeCyclical=e.isWebMercator?new P$z(-20037508.342787,20037508.342787):new P$z(-180,180),this.renderer.longitudeCyclical=this._longitudeCyclical),this.renderer&&(this.renderer.globalUnitScale=this._isSpherical&&r$Y(this._spatialReference)?G$m(this._spatialReference):1)):this.renderer.disposeOverlays();}getGpuMemoryUsage(){return this.renderer.gpuMemoryUsage}_updateLayerViews(){if(!this._layerViewsDirty)return;const e=new Set;for(const t of this.view.allLayerViews.items)e.add(t.uid),"drapeSourceType"in t&&!this._drapeSources.has(t)&&this._registerDrapeSource(t,0),"drapeTargetType"in t&&!this._drapeTargets.has(t)&&this._registerDrapeTarget(t);this._drapeSources.forEach(((t,r)=>{0!==t||e.has(r.uid)||this.unregisterDrapeSource(r);})),this._drapeTargets.forEach((t=>{e.has(t.uid)||this._unregisterDrapeTarget(t);})),this.renderer.updateLayerOrder(),this._setDrawTexturesDirty(),this._layerViewsDirty=!1;}registerDrapeSource(e){this._registerDrapeSource(e,1);}_registerDrapeSource(e,t){this._drapeSources.set(e,t),this.renderer.ensureOverlays(this._drapeTargets,this._drapeSources),this.renderer.overlays.forEach((t=>{this._updateDrapeSource(e,t);})),this._setOverlayContentDirty(),this.notifyChange("running");}_updateDrapeSource(e,t){r$Y(e.setDrapingExtent)&&r$Y(this._spatialReference)&&e.setDrapingExtent(t,this._spatialReference);}unregisterDrapeSource(e){this._drapeSources.has(e)&&(this._drapeSources.delete(e),this.renderer.ensureDrapeSources(this._drapeSources),this._setOverlayContentDirty(),this.notifyChange("running"));}_registerDrapeTarget(e){this._drapeTargets.add(e),this._updateDrapeTarget(e),this.renderer.ensureOverlays(this._drapeTargets,this._drapeSources);}_updateDrapeTarget(e){this.renderer.overlays.forEach((t=>e.setDrapingTextures(t)));}_unregisterDrapeTarget(e){this._drapeTargets.delete(e),this.renderer.ensureDrapeTargets(this._drapeTargets);}_setOverlayContentDirty(){this.setOverlayPlacementDirty(),this._setDrawTexturesDirty();}setOverlayPlacementDirty(){this._placementDirty=!0;}runTask(){this._updateOverlays(this.view.state.camera);}_updateOverlays(e){if(!this._spatialReference)return;this._updateLayerViews();const t=o$A(e.fullWidth,e.fullHeight,this._maxResolution);this._computeOverlayExtents(e,t,oe$1);const r=x$R(oe$1.inner)/x$R(oe$1.outer);this.renderer.ensureOverlays(this._drapeTargets,this._drapeSources);const s=this._updateOverlay(0,oe$1.inner,t,1),i=this._updateOverlay(1,oe$1.outer,t,r);(s||i)&&(this.surface.updateTileOverlayParams(),this._setDrawTexturesDirty()),this._placementDirty=!1,this.surface.updateOverlayOpacity();}_updateOverlay(e,t,r,s){if(0===this.renderer.overlays.length)return !1;const i=this.renderer.overlays[e];if(!ie$1(t,i.extent)&&r===i.resolution&&i.pixelRatio===s)return !1;A$y(i.extent,t),i.resolution=r,i.pixelRatio=s;const a=y$T(i.extent);return i.renderLocalOrigin=c$y(a[0],a[1],0,"OV_"+this._latestOriginId++),this._drapeSources.forEach(((e,t)=>this._updateDrapeSource(t,i))),!0}computeOpacity(e){if(!this.renderer.hasOverlays)return this._displayOpacity=0,this._displayOpacityTime=-1,1;if(e*$$5<this._renderedAltitude){const t=(e-this._renderedAltitude/ee$2)/(this._renderedAltitude/$$5-this._renderedAltitude/ee$2);this._displayOpacity=Math.sqrt(o$R(t,0,1)),this._displayOpacityTime=performance.now();}else if(1!==this._displayOpacity){const e=performance.now();this._displayOpacityTime=this._displayOpacityTime>0?this._displayOpacityTime:e;const t=e-this._displayOpacityTime,r=this.surface.textureFadeDuration;if(t<r)return this._displayOpacity+(1-this._displayOpacity)*(t/r);this._displayOpacity=1,this._displayOpacityTime=-1;}return this._displayOpacity}setTileParameters(e){const t=e.renderData.overlay;if(this.renderer.overlays.length>0){const r=this.renderer.overlays[0],s=this.renderer.overlays[1],i=w$H(e.extent,e.surface.extent,he$1);this._rectInsideRect(i,r.extent)||this._rectanglesOverlap(i,r.extent)||this._rectanglesOverlap(i,s.extent)?(this._setTileOverlayData(i,0,t),this._setTileOverlayData(i,1,t)):(this._clearTileOverlayData(0,t),this._clearTileOverlayData(1,t));}else this._clearTileOverlayData(0,t),this._clearTileOverlayData(1,t);}overlayPixelSizeInMapUnits(e){if(0===this.renderer.overlays.length)return 0;const t=this.renderer.overlays[0],r=this.renderer.overlays[1],s=this._pointIsInExtent(e,t.extent)?t:r;return (s.extent[2]-s.extent[0])/s.resolution}_setTileOverlayData(e,t,r){if(0===this.renderer.overlays.length)return;const s=this.renderer.overlays[t].extent;r.setScale(t,(e[2]-e[0])/(s[2]-s[0]),(e[3]-e[1])/(s[3]-s[1]));let i=e[0];if(this._longitudeCyclical){i=this._longitudeCyclical.minimalMonotonic(s[0],i);const t=this._longitudeCyclical.minimalMonotonic(s[0],e[2]);i>t&&(i=t-(e[2]-e[0]));}r.setOffset(t,(i-s[0])/(s[2]-s[0]),(e[1]-s[1])/(s[3]-s[1]));}_clearTileOverlayData(e,t){t.setScale(e,-1,-1),t.setOffset(e,-1,-1);}async reloadShaders(){e$f(),await this.renderer.reloadShaders(),this.runTask();}stopAnimationsAtTime(e){this.renderer.stopAnimationsAtTime(e),this._drawTexturesAnimateDirty=!0;}_dispatchRendererUpdate(e){const t=n$1e(e.time-this._animationTimeLast);if(t<m$d)return;this._animationTimeLast=e.time;this.renderer.updateLogic({dt:t,camera:this.view.state.camera})&&(this._drawTexturesAnimateDirty=!0);}_setDrawTexturesDirty(){this.renderer.hasOverlays?this._drawTexturesDirty=!0:this.setOverlayPlacementDirty();}_intersectGroundFromView(e,t,r,s){const i=this.view.sceneIntersectionHelper.getCenterRayWithSubpixelOffset(e,ce$1,t,r);if(t$17(i))return !1;const a=i.origin,n=u$S(ne$1,i.origin,i.direction);return this.groundIntersector.reset(a,n),this.groundIntersector.intersect([],null,e),this.view.basemapTerrain.intersect(this.groundIntersector,null,a,n),this.groundIntersector.results.min.getIntersectionPoint(s)}_findHorizonBasedPointOfInterest(e,t){let r=.5;const s=.55,a=this.view.renderCoordsHelper.getAltitude(e.eye),n=this.view.pointsOfInterest.centerOnSurfaceFrequent,o=1e-5,h=o$R(n.estimatedSurfaceAltitude,e.aboveGround?-1/0:a+o,e.aboveGround?a-o:1/0),l=e.aboveGround;if("global"===this.view.viewingMode){const t=ne$1;F$y(E$x(p$15(this.view.spatialReference).radius+h),d$R(e.eye,e.viewForward),t),c$V(t,t,e.eye);const i=S$B.normalize(i$1a(e.viewForward,t,e.viewRight))/e.fovY+.5,a=i<=0||i>=1?.5:s;r=l?a*i:i+a*(1-i);}else {const t=.5*Math.PI-Math.acos(-e.viewForward[2]),a=Math.tan(t),n=r$19(0,a,1,0),o=y$O(n,n,e.projectionMatrix)[1],h=o$R(.5+.5*o,0,1);r=1===h||0===h?.5:l?h*s:1-(1-h)*s;}return !!this._intersectGroundFromView(e,.5,r,t)&&X$g(t,e.eye)<n.distance*n.distance}_computeOverlayExtents(e,t,r){const s=this.surface.extent,i=this.view.pointsOfInterest.centerOnSurfaceFrequent.renderLocation,h=n$11();this._findHorizonBasedPointOfInterest(e,h)||r$Z(h,i),this._renderedAltitude=this.view.renderCoordsHelper.getAltitude(e.eye);const l=q$o(e.eye,h),c=n$U(this.view.renderCoordsHelper,i,e.eye),d=Math.PI/2-Math.abs(c-Math.PI/2);T$k.OVERLAY_SHOW_CENTER?(t$17(re$2)&&(re$2=new l$e(this.view.graphics,"red")),re$2.showPoint(h,this._renderSR)):r$Y(re$2)&&re$2.remove(),this._overlaySREqualsRenderSR||wn(h,this._renderSR,h,this._spatialReference);let p=t*e.perRenderPixelRatio*l/2,y=!1,_=1/0;this._isSpherical&&r$Y(this._spatialReference)&&(this._spatialReference.isWebMercator?(p/=Math.cos(c$X(h[1])),_=this.surface.extent[3]):(y=!0,p/=p$15(this._spatialReference).metersPerDegree,_=90),p>=_&&(p=_,h[1]=0,this._spatialReference.isWebMercator&&(h[0]=0)));let g=1;y&&(g=1/Math.max(.2,Math.cos(Math.abs(b$F(h[1])))),p*g>180&&(g=180/p));const O=Math.log(2)/12;p=Math.exp(Math.round(Math.log(p)/O)*O);const D=p*g,R=32,M=.5*t/(R*D),j=.5*t/(R*p);h[0]=Math.round(h[0]*M)/M,h[1]=Math.round(h[1]*j)/j;const E=r.inner;E[0]=h[0]-D,E[1]=h[1]-p,E[2]=h[0]+D,E[3]=h[1]+p,this._isSpherical&&this._shiftExtentToFitBounds(E,1/0,_);const A=r.outer;if(A$y(A,E),6*D>s[2]-s[0])A$y(A,s);else if(d<=.25*Math.PI)A[0]-=D,A[1]-=p,A[2]+=D,A[3]+=p;else {wn(e.eye,this._renderSR,ne$1,this._spatialReference),o$18(ae$1,h,ne$1);let t=-Math.atan2(ae$1[1],ae$1[0])+.125*Math.PI;t<0&&(t+=2*Math.PI);const r=Math.floor(t/(.25*Math.PI));l$10(ae$1,te$2[r],2*p),ae$1[0]*=g,ae$1[2]*=g,s$1b(A,A,ae$1);}if(this._isSpherical&&(A[0]=this._longitudeCyclical.clamp(A[0]),A[2]=this._longitudeCyclical.clamp(A[2]),A[1]=Math.max(A[1],-_),A[3]=Math.min(A[3],_)),!this._isSpherical&&s){const e=w$H(E,s,he$1),t=w$H(A,s,le$1);q$u(e,t)&&(A[2]=A[0],A[3]=A[1]);}}_drawOverlayTextures(e){if(0===e.length||!this._drawTexturesDirty&&!this._drawTexturesAnimateDirty)return;const t=this._drawOverlay(e[0]),r=this._drawOverlay(e[1]);0!==t&&0!==r||this.surface.updateTileOverlayParams(),this._collectUnusedRenderTargetMemory(),this._drapeTargets.forEach((e=>this._updateDrapeTarget(e))),this._drawTexturesAnimateDirty=!1,this._drawTexturesDirty?(this._drawTexturesDirty=!1,this.surface.requestRender(),this.surface.requestUpdate()):this.surface.requestRender(0);}_drawOverlay(e){return this._longitudeCyclical?e.setupGeometryViewsCyclical(this._longitudeCyclical):e.setupGeometryViewsDirect(),e.draw(this.renderer,this.view.state.camera.pixelRatio)}_collectUnusedRenderTargetMemory(){if(this._hasUnusedRenderTargets=!1,this.renderer.hasOverlays){const e=performance.now();this._hasUnusedRenderTargets=this.renderer.collectUnusedRenderTargetMemory(e);}}_rectanglesOverlap(e,t){return this._longitudeCyclical?(this._longitudeCyclical.contains(t[0],t[2],e[0])||this._longitudeCyclical.contains(t[0],t[2],e[2])||this._longitudeCyclical.contains(e[0],e[2],t[0]))&&!(e[1]>t[3]||e[3]<t[1]):F$A(e,t)}_rectInsideRect(e,t){return this._longitudeCyclical?this._longitudeCyclical.contains(t[0],t[2],e[0])&&this._longitudeCyclical.contains(t[0],t[2],e[2])&&e[1]>t[1]&&e[3]<t[3]:q$u(t,e)}_pointIsInExtent(e,t){if(this._longitudeCyclical)return this._longitudeCyclical.contains(t[0],t[2],e.x)&&e.y>=t[1]&&e.y<=t[3];const r=e.x,s=e.y;return r>t[0]&&r<t[2]&&s>t[1]&&s<t[3]}_shiftExtentToFitBounds(e,t,r){let s=0,i=0;e[0]<-t?s=e[0]+t:e[2]>t&&(s=t-e[2]),e[1]<-r?i=e[1]+r:e[3]>r&&(i=r-e[3]),R$t(e,s,i);}get test(){return {renderer:this.renderer,update:()=>this.runTask()}}};function ie$1(e,t){const r=1e-5,s=T$k.TESTS_DISABLE_UPDATE_THRESHOLDS?0:r*Math.max(e[2]-e[0],e[3]-e[1],t[2]-t[0],t[3]-t[1]);for(let i=0;i<4;i++)if(Math.abs(t[i]-e[i])>s)return !0;return !1}e$Q([y$K()],se$1.prototype,"_spatialReference",void 0),e$Q([y$K({readOnly:!0})],se$1.prototype,"running",null),e$Q([y$K()],se$1.prototype,"_placementDirty",void 0),e$Q([y$K()],se$1.prototype,"_layerViewsDirty",void 0),e$Q([y$K()],se$1.prototype,"renderer",void 0),e$Q([y$K({constructOnly:!0})],se$1.prototype,"surface",void 0),e$Q([y$K({readOnly:!0,aliasOf:"surface.suspended"})],se$1.prototype,"suspended",void 0),e$Q([y$K({readOnly:!0})],se$1.prototype,"updating",null),e$Q([y$K({type:Boolean})],se$1.prototype,"hasHighlights",null),e$Q([y$K({type:Boolean})],se$1.prototype,"rendersOccluded",null),se$1=e$Q([n$14("esri.views.3d.terrain.OverlayManager")],se$1);const ae$1=n$1a(),ne$1=n$11(),oe$1={inner:i$P(),outer:i$P()},he$1=i$P(),le$1=i$P(),ce$1=a$11();

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class t$l{constructor(e,t){this._factoryCallback=e,this._lengthCallback=t,this._pool=new Map;}acquire(e){if(!t$l.test.disabled){const t=this._pool.get(e);if(t&&0!==t.length)return t.pop()}try{return this._factoryCallback(e)}catch(o){const t=window.performance&&window.performance.memory;let i="";throw t&&(i=`\n  totalJSHeapSize: ${t.totalJSHeapSize}, usedJSHeapSize: ${t.usedJSHeapSize}, jsHeapSizeLimit: ${t.jsHeapSizeLimit}`),console.log("Array allocation of size "+e+" failed: "+o+i),o}}release(o){if(t$l.test.disabled)return;const i=this._lengthCallback(o);let s=this._pool.get(i);s||(s=new n$1h({shrink:!0}),this._pool.set(i,s)),s.push(o);}clear(){this._pool.clear();}get test(){return {size:this._pool.size}}}t$l.test={disabled:!1};

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
const p$c=A$u().vec3f("position").vec2f("uv0"),g$a=new t$l((t=>p$c.createBuffer(t)),(t=>t.count));class h$d{constructor(){this.indices=null,this.vertexAttributes=null,this.boundingBox=B$n(),this.numSurfaceIndices=0,this.numSkirtIndices=0,this.numWithoutSkirtIndices=0,this.numVertsPerRow=0,this.skirtLength=0,this.uvOffsetAndScale=n$1a();}}class d$c{constructor(t,e,n){this.values=t,this.numSurfaceIndices=e,this.numSkirtIndices=n;}}function y$6(){g$a.clear(),V$4.clear();}function w$6(t){g$a.release(t.vertexAttributes),t.vertexAttributes=null,t.indices=null;}const I$6=65536;function v$7(e,n,r,s,c,u,a,l){const p=c[0],h=c[1],d=c[2],y=c[3],w=.1*a.radius*(y-h),I=e.numVertsPerRow-1,v=e.numVertsPerRow-1,P=e.numVertsPerRow*e.numVertsPerRow,V=2*I+2*v,A=g$a.acquire(P+V),M=A.position.typedBuffer,j=A.uv0.typedBuffer,O=s.geometryInfo.boundingBox;B$n(O);const T=n[2]-n[0],U=n[3]-n[1],q=d-p,E=r[0],N=r[1],W=r[2];for(let t=0;t<=I;t++){const e=t/I,r=p+e*q;k$5[t]=Math.sin(r),B$5[t]=Math.cos(r),D$6[t]=e,L$6[t]=n[0]+e*T;}const C=u&&!!(1&l),z=u&&!!(2&l);let F=0;for(let o=0;o<=v;o++){let r=o/v;const s=m$V(h,y,r),i=Math.cos(s),c=Math.sin(s);let l;u?(l=a.halfSemiMajorAxis*Math.log((1+c)/(1-c)),r=(l-n[1])/U):l=180*s/Math.PI;for(let t=0;t<=I;t++){const n=D$6[t],s=k$5[t],u=B$5[t];let p=a.radius;e.samplerData&&(p+=i$a.sample(L$6[t],l,e.samplerData)||0);const g=u*i*p-E,h=s*i*p-N,d=c*p-W;S$6(g,h,d,O);const y=V$j*F;M[y+0]=g,M[y+1]=h,M[y+2]=d,j[y+0]=n,j[y+1]=r;const V=b$7(t,o,I,v);if(V>-1){const t=V$j*(P+V),e=C&&0===o?-1:z&&o===v?1:0,s=0===e?g:-E,i=0===e?h:-N,c=0===e?d:a.radius*e-W;M[t+0]=s,M[t+1]=i,M[t+2]=c,j[t+0]=0===e?R$6(n,r):n,j[t+1]=0===e?w:r,0!==e&&S$6(s,i,c,O);}++F;}}s.geometryInfo.numVertsPerRow=e.numVertsPerRow,s.geometryInfo.vertexAttributes=A,s.geometryInfo.skirtLength=w,r$17(s.geometryInfo.uvOffsetAndScale,0,0,1,1),x$7(s.geometryInfo,e.numVertsPerRow,u?l:0,e.wireframe);}function P$5(t,n,r,s){const c=n[0],u=n[1],a=n[2]-c,l=n[3]-u,p=t.clippingArea,h=r$Y(p)?Math.max(0,(p[0]-n[0])/a):0,d=r$Y(p)?Math.max(0,(p[1]-n[1])/l):0,y=r$Y(p)?Math.min(1,(p[2]-n[0])/a):1,w=r$Y(p)?Math.min(1,(p[3]-n[1])/l):1,I=y>h?1/(y-h):1,v=w>d?1/(w-d):1,P=-h*I,V=-d*v,A=.1*a,M=t.numVertsPerRow-1,j=t.numVertsPerRow-1,k=t.numVertsPerRow*t.numVertsPerRow,B=2*M+2*j,D=g$a.acquire(k+B),L=D.position.typedBuffer,O=D.uv0.typedBuffer,T=s.geometryInfo.boundingBox;B$n(T);let U=0;for(let o=0;o<=j;o++){const n=o/j;let s=V+n*v,i=u+n*l;r$Y(p)&&(i<p[1]?(i=p[1],s=0):i>p[3]&&(i=p[3],s=1));for(let u=0;u<=M;u++){const n=u/M;let l=P+n*I,g=c+n*a;r$Y(p)&&(g<p[0]?(g=p[0],l=0):g>p[2]&&(g=p[2],l=1));const h=t.samplerData&&i$a.sample(g,i,t.samplerData)||0,d=g-r[0],y=i-r[1],w=h-r[2];S$6(d,y,w,T);const v=V$j*U;L[v+0]=d,L[v+1]=y,L[v+2]=w,O[v+0]=l,O[v+1]=s;const V=b$7(u,o,M,M);if(V>-1){const t=V$j*(k+V);L[t+0]=d,L[t+1]=y,L[t+2]=w,O[t+0]=R$6(l,s),O[t+1]=A;}++U;}}s.geometryInfo.numVertsPerRow=t.numVertsPerRow,s.geometryInfo.vertexAttributes=D,s.geometryInfo.skirtLength=A,r$17(s.geometryInfo.uvOffsetAndScale,h,d,y-h,w-d),x$7(s.geometryInfo,t.numVertsPerRow,0,t.wireframe);}const V$4=new Map;function x$7(t,e,n,r){const o=(2&n)>0,s=e+(r?1024:0)+(o?2048:0);let i=V$4.get(s);i||(i=A$5(e,o,r),V$4.set(s,i)),t.indices=i.values,t.numSurfaceIndices=i.numSurfaceIndices,t.numSkirtIndices=i.numSkirtIndices,t.numWithoutSkirtIndices=t.numSurfaceIndices+(n?6*(e-1)*(r?2:1):0);}function A$5(t,e,n){const r=t-1,o=t-1,s=t*t,i=2*r+2*o;let c=r*o*2*3,u=6*i,f=6*(2*r+o-1);n&&(c*=2,u*=2,f*=2);const a=s+i>I$6?new Uint32Array(c+u):new Uint16Array(c+u);let m,l,p,g,h=0,y=0,w=c,v=0;for(let d=0;d<=o;d++){e&&(v=0===d?f:d===o?-f:0),w+=v;for(let t=0;t<=r;t++){const e=b$7(t,d,r,o);if(e>-1){const i=M$8(t,d,r,o);0!==i&&(m=h,l=s+e,p=s+(0===t&&1===d?0:e+1),g=h+i,n?(a[w+0]=m,a[w+1]=l,a[w+2]=l,a[w+3]=p,a[w+4]=p,a[w+5]=m,a[w+6]=p,a[w+7]=g,a[w+8]=g,a[w+9]=m,a[w+10]=m,a[w+11]=p,w+=12):(a[w+0]=m,a[w+1]=l,a[w+2]=p,a[w+3]=p,a[w+4]=g,a[w+5]=m,w+=6));}++h,t<r&&d<o&&(m=d*(r+1)+t,l=m+1,p=l+(r+1),g=p-1,n?(a[y+0]=m,a[y+1]=l,a[y+2]=l,a[y+3]=p,a[y+4]=p,a[y+5]=m,a[y+6]=p,a[y+7]=g,a[y+8]=g,a[y+9]=m,a[y+10]=m,a[y+11]=p,y+=12):(a[y+0]=m,a[y+1]=l,a[y+2]=p,a[y+3]=p,a[y+4]=g,a[y+5]=m,y+=6));}w-=v;}return new d$c(a,c,u)}function S$6(t,e,n,r){t<r[0]&&(r[0]=t),t>r[3]&&(r[3]=t),e<r[1]&&(r[1]=e),e>r[4]&&(r[4]=e),n<r[2]&&(r[2]=n),n>r[5]&&(r[5]=n);}function R$6(t,e){const n=e>t?1:0;return 2+4*n+(1-2*n)*(t+e)}function b$7(t,e,n,r){return 0===e?t:t===n?n+e:e===r?n+r+(n-t):0===t&&e>0?2*n+r+(r-e):-1}function M$8(t,e,n,r){return 0===e&&t!==n?1:t===n&&e!==r?n+1:e===r&&0!==t?-1:0===t&&0!==e?-(n+1):0}function j$6(t,r,o,s,i,c,u,f,a){const m=c.position,p=c.uv0,g=t[0],h=t[1],d=t[2],y=r[0]-g,w=r[1]-h,I=r[2]-d;s*=3;for(let v=o*=3;v<s;v+=3){const t=i[v],r=i[v+1],o=i[v+2];let s=m.get(t,0),c=m.get(t,1),P=m.get(t,2),V=m.get(r,0),x=m.get(r,1),A=m.get(r,2),S=m.get(o,0),R=m.get(o,1),b=m.get(o,2);p.get(t,0)>=2&&(o$S(O$5,s,c,P),u(O$5),s+=O$5[0],c+=O$5[1],P+=O$5[2]);p.get(r,0)>=2&&(o$S(O$5,V,x,A),u(O$5),V+=O$5[0],x+=O$5[1],A+=O$5[2]);p.get(o,0)>=2&&(o$S(O$5,S,R,b),u(O$5),S+=O$5[0],R+=O$5[1],b+=O$5[2]),r$Y(f)&&([s,c,P]=f.applyToVertex(s,c,P),[V,x,A]=f.applyToVertex(V,x,A),[S,R,b]=f.applyToVertex(S,R,b));const M=V-s,j=x-c,k=A-P,B=S-s,D=R-c,L=b-P,U=w*L-D*I,q=I*B-L*y,E=y*D-B*w,N=M*U+j*q+k*E;if(Math.abs(N)<=Number.EPSILON)continue;const W=g-s,C=h-c,z=d-P,F=W*U+C*q+z*E;if(N>0){if(F<0||F>N)continue}else if(F>0||F<N)continue;const G=C*k-j*z,H=z*M-k*W,J=W*j-M*C,K=y*G+w*H+I*J;if(N>0){if(K<0||F+K>N)continue}else if(K>0||F+K<N)continue;const Q=(B*G+D*H+L*J)/N;if(Q>=0){a(Q,T$w(M,j,k,B,D,L,T$8));}}}const k$5=new Array(e$M+1),B$5=new Array(e$M+1),D$6=new Array(e$M+1),L$6=new Array(e$M+1),O$5=n$11(),T$8=n$11();

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class r$h{constructor(){this._queue=new n$1h,this._last=null,this.remove=()=>{};}get done(){return 0===this._queue.length&&(!this._last||this._last.isLeaf)}resetOne(t){this._queue.clear(),this._queue.push(t),this._last=null;}reset(e=null){this._queue.clear(),r$Y(e)&&this._queue.pushArray(e),this._last=null;}skipSubtree(){this._last=null;}next(){return this._last&&!this._last.isLeaf&&this._queue.pushArray(this._last.children),this._last=this._queue.pop(),this._last}}class s$e{constructor(){this.q=new n$1h;}get done(){return 0===this.q.length}reset(t){if(this.q.clear(),t){this.q.pushArray(t);for(let t=0;t<this.q.length;++t){const e=this.q.data[t];e.isLeaf||this.q.pushArray(e.children);}}}next(){return this.q.pop()}}function i$9(e){return r$Y(e)?e.lij.toString():"null"}function o$h(t,n,r){if(t$17(n))return !1;const s=n.fullExtent,i=t.extent;if(r){if(i[0]<s.xmin||i[1]<s.ymin||i[2]>s.xmax||i[3]>s.ymax)return !1}else if(s.xmin>i[2]||s.ymin>i[3]||s.xmax<i[0]||s.ymax<i[1])return !1;const l=t.surface.tilingScheme.levels[t.lij[0]].scale;return !(n.minScale>0&&l>1.00000001*n.minScale)&&!(n.maxScale>0&&l<.99999999*n.maxScale)}function a$d(t,e){e.sort(((e,n)=>h$c(e,n,t)));}function h$c(t,e,n){const r=t.screenDepth,s=e.screenDepth;return r<s?-n:r>s?n:0}function c$f(t,e){const n=new Map;t.forAll((t=>n.set(t,t.distanceToSquared(e)))),t.sort(((t,e)=>n.get(t)-n.get(e)));}function f$c(t,e,n){let r=1,s=0,i=0;for(;t!==e;)if(r*=.5,s*=.5,i*=.5,1&t.lij[2]&&(s+=.5),0==(1&t.lij[1])&&(i+=.5),null==(t=t.parent))throw new Error("tile was not a descendant of upsampleTile");n.init(e,s,i,r);}function m$c(t){for(let e=0;e<t.length;e++){const n=t[e],r=n.parent;if(r)for(let t=0;t<4;t++){const e=r.children[t];if(e&&e!==n&&e.loadable)return !0}}return !1}function p$b(t,e){if(!t||!e||t[0]===e[0])return !1;const n=t[0]<e[0],r=n?t:e,s=n?e:t,i=1<<s[0]-r[0];return Math.floor(s[1]/i)===r[1]&&Math.floor(s[2]/i)===r[2]}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class r$g{get updating(){return !!this._tileRequested}init(e,t,s,i){this.tile=e,this._layerIdx=t,this._layerClass=s,this._suspended=i,this._tileLayerInfo=e.getLayerInfo(t,s),this._tileRequested=null;const l=this._findAncestorWithData();this._setUpsampleTile(l);}startLoading(){return this._requestNext()}dispose(){this._tileRequested&&(this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null),this.tile=null,this._tileLayerInfo=null;}setSuspension(e){e!==this._suspended&&(this._suspended=e,e?this._tileRequested&&(this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null):this._tileLayerInfo.data||this.update());}update(){const e=this._findAncestorWithData();return this._setUpsampleTile(e),this._requestNext()}dataArrived(e){this._setUpsampleTile(e),this._tileRequested=null,e===this.tile?this.tile.updateRenderData(this._layerClass):this._requestNext();}dataMissing(){this._tileRequested=null,this._tileLayerInfo.data=null,this._requestNext();}_agentDone(){this.tile.agentDone(this._layerIdx,this._layerClass),this.dispose();}_requestNext(){if(this._suspended)return !0;const t=this._findNextDownload();if(this._tileRequested){if(t===this._tileRequested)return !0;this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null;}return r$Y(t)?t.requestLayerData(this._layerIdx,this._layerClass,this)&&(this._tileRequested=t):this._agentDone(),!!this._tileRequested}_findNextDownload(){const r=this._layerIdx,n=this._layerClass,h=this.tile.surface.layerViewByIndex(r,n),d=v$8(h),{minLevel:_,maxLevel:o}=h.dataLevelRange,u=this._desiredMinLevelDelta,p=this._progressiveLevelModulo+u,y=this._scaleRangeEnabled?o$h:()=>!0;let f=this.tile;const q=f.level;let v;const I=this._tileLayerInfo.upsampleInfo,L=I?I.tile.level:-1,m=g$Y(d,"tilemapCache");for(;f&&y(f,d,!1)&&f.level>=_;){const e=f.level,t=q-e,l=f.layerInfo[n][r];if(l.data&&t>=u){e>L&&this._setUpsampleTile(f),l.dataInvalidated&&(v=f);break}if((t$17(m)||"unavailable"!==m.getAvailability(f.lij[0],f.lij[1],f.lij[2]))&&e<=o&&!l.data&&!l.dataMissing&&((t$17(v)||f.level===_||e%r$W==0||q-v.level<u)&&(v=f),t>=p))break;f=f.parent;}return r$Y(v)&&q-v.level<u&&this._tileLayerInfo.upsampleInfo&&(v=null),v}_findAncestorWithData(){const e=this.tile.vlevel,t=this._desiredMinLevelDelta;let s;for(let i=this.tile;i;i=i.parent)if(i.hasLayerData(this._layerIdx,this._layerClass)){if(e-i.level>=t)return i;s=i;}return s}_setUpsampleTile(e){this._tileLayerInfo.setUpsampleInfo(this.tile,e),this.tile.updateRenderData(this._layerClass);}get test(){return {findNextDownload:()=>this._findNextDownload(),tileLayerInfo:this._tileLayerInfo}}}class n$i extends r$g{get _desiredMinLevelDelta(){throw h$b}get _progressiveLevelModulo(){throw h$b}dispose(){}}const h$b=new Error("Abstract method called on TileAgent"),d$b=new n$i;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class r$f extends r$g{constructor(){super(...arguments),this._scaleRangeEnabled=!1;}get _desiredMinLevelDelta(){return E$v-(this.tile.vlevel-this.tile.level)}get _progressiveLevelModulo(){return 0}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class t$k extends r$g{constructor(){super(),this._scaleRangeEnabled=!0;}get _desiredMinLevelDelta(){return 0}get _progressiveLevelModulo(){return r$W}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class l$b{constructor(){this.waitingAgents=new n$1h,this._upsampleInfo=null,this.loadingAgent=null,this.requestPromise=null,this.requestAbort=null,this.pendingUpdates=0;}static acquire(t){const s=p$a.acquire();return s._init(t),s}release(){this.dispose(),r$e.delete(this),p$a.release(this);}dispose(){this.loadingAgent=i$S(this.loadingAgent),this.abortRequest(),this._unsetUpsampleInfo(),this.pendingUpdates=0,this._data=w$7(this._data);}static prune(){p$a.prune(0);}_init(t){this.waitingAgents.clear(),this._data=w$7(this._data),this.dataMissing=!1,this.dataInvalidated=!1,this._unsetUpsampleInfo(),this.abortRequest(),this.loadingAgent=null,this.pendingUpdates=0,this._pool=t,this.elevationBounds=null;}invalidateSourceData(){this.dataInvalidated=!0,this.dataMissing=!1,this._unsetUpsampleInfo();}abortRequest(){this.requestAbort=a$$(this.requestAbort),this.requestPromise=null;}get upsampleInfo(){return this._upsampleInfo}_unsetUpsampleInfo(){this._upsampleInfo&&(this._upsampleInfo.tile.unrefMapData(),this._pool.release(this._upsampleInfo),this._upsampleInfo=null);}setUpsampleInfo(t,s){if(t===s||t$17(s))this._unsetUpsampleInfo();else {if(null==this._upsampleInfo)this._upsampleInfo=this._pool.acquire();else {if(this._upsampleInfo.tile===s)return;this._upsampleInfo.tile.unrefMapData();}s.refMapData(),f$c(t,s,this._upsampleInfo);}}get data(){return this._data}set data(t){w$7(this._data),this._data=t;}}const p$a=new e$X(l$b,null,(()=>{})),r$e=new Map;function h$a(){r$e.size>0&&(console.log(`${r$e.size} live TilePerLayerInfo allocations:`),r$e.forEach((t=>console.log(t,"\n"))));}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
const O$4=n$11(),k$4=n$11(),z$4=n$11(),H$5=n$1a(),G$4=.1;class F$7{constructor(){this.fovX=0,this.fovY=0,this.relativeWidthLimit=0,this.relativeHeightLimit=0,this.maxLod=0,this.angledSplitBias=0,this.aboveGround=!0;}}class X$2{constructor(e){this._numSubdivisionAtLevel=e,this.lij=[0,0,0],this._children=[null,null,null,null],this._dirty=!0,this._previouslyRendered=!1,this.extent=i$P(),this._elevationBounds=n$19(),this.layerInfo=[[],[]],this.extentInRadians=i$P(),this.centerAtSeaLevel=n$11(),this._center=[n$11(),_$o(),n$11()],this.up=i$1b(),this._isWithinClippingArea=!0,this._intersectsClippingArea=!0,this._maxTesselation=0,this._usedMemory=Z$3,this._mapTileMemory=0,this._mapDataRefCount=0,this._screenDepth=0,this.renderOrder=0,this._edgeLen=0,this._edgeLen2=0,this._curvatureHeight=0;}static prune(){Q$4.prune(0),J$5.prune(0),l$b.prune();}get usedMemory(){return this._usedMemory===Z$3&&this._updateMemoryUsed(),this._usedMemory+(this.isCached?0:this.mapTileMemory)}get cachedMemory(){return this.isCached?this.mapTileMemory:0}get mapTileMemory(){this._usedMemory===Z$3&&this._updateMemoryUsed();let e=this._mapTileMemory;for(const{data:t}of this.layerInfo[1])t instanceof d$15&&(e+=t.memoryUsage);return e}get isCached(){return !this.shouldLoad&&this._mapDataRefCount<=0}get maxTesselation(){return this._maxTesselation}get numSubdivisionsAtLevel(){return this._numSubdivisionAtLevel}get isWithinClippingArea(){return this._isWithinClippingArea}get intersectsClippingArea(){return this._intersectsClippingArea}get clippingArea(){return this._clippingArea}get parent(){return this._parent}get children(){return this._children}get surface(){return this._surface}get elevationBounds(){return this._elevationBounds}get level(){return this.lij[0]}get edgeLen(){return this._edgeLen}get radius(){return this._center[1][3]}get screenDepth(){return this._screenDepth}get visible(){if(this._dirty){this._dirty=!1;const e=this._isVisible(this.surface.frustum);e!==this._visible&&(this._visible=e,this._surface.emit("tiles-visibility-changed"),this._surface.renderer.setNeedsRender()),this.updateAgentSuspension();}return this._visible}get loadable(){return this.visible||this._surface.view.state.fixedContentCamera}get rendered(){const e=!!this.renderData;return e!==this._previouslyRendered&&(this._surface.emit("tiles-visibility-changed"),this._previouslyRendered=e,this._surface.renderer.setNeedsRender()),e}get shouldLoad(){if(!this.loadable)return !1;if(1===this._surface.lodSnapping){const e=this.level-this._surface.snapLevel;if(0===e)return !0;if(1===e)return !1}return this.isLeaf}init(e,t,i){this.lij[0]=e[0],this.lij[1]=e[1],this.lij[2]=e[2],this.ellipsoid=p$15(i.tilingScheme.spatialReference),i.tilingScheme.getExtent(e[0],e[1],e[2],this.extent),i.tilingScheme.convertExtentToRadians(this.extent,this.extentInRadians),this._isWithinClippingArea=!0,this._intersectsClippingArea=!0,this._clippingArea=null,this._mapDataRefCount=0,i.upsampleMapCache.pop(i$9(this)),this._edgeLen=0,this._edgeLen2=0,this._center[1][3]=0,this.vlevel=e?e[0]:0,t&&t.elevationBounds?a$13(this._elevationBounds,t.elevationBounds):r$18(this._elevationBounds,0,0),this._pendingUpdates=0,this.renderData=null,this._screenDepth=0,this._visible=!1,this._previouslyRendered=!1,this._parent=t,this.unsetChildren(),this._surface=i,this.updateVisibility();for(const s of o$Q){const e=i.numLayers(s),t=this.layerInfo[s];for(const i of t)i.release();t.length=e;for(let i=0;i<e;i++)t[i]=l$b.acquire(this._surface.upsampleInfoPool),0===s&&this.findElevationBoundsForLayer(i,-1);}this.computeElevationBounds(),this._maxTesselation=Math.min(i.tilingScheme.pixelSize,e$M);}release(){f$e(!this.renderData,"tile.renderData was not unloaded"),this._surface.upsampleMapCache.pop(i$9(this));for(const e of o$Q){for(const t of this.layerInfo[e])t.release();this.layerInfo[e].length=0;}this._parent=null,this._surface=null,this._usedMemory=Z$3;}refMapData(){++this._mapDataRefCount,this.isCached||this._surface.upsampleMapCache.pop(i$9(this));}unrefMapData(){if(--this._mapDataRefCount,this.isCached){const e=this.cachedMemory;e>0&&(this._surface.upsampleMapCache.put(i$9(this),this,e),this.setMemoryDirty());}}setMemoryDirty(){this._usedMemory=Z$3;}get cpuImageMemorySize(){const e=4,t=this._surface.tilingScheme.pixelSize;return t*t*e}_updateMemoryUsed(){this._usedMemory=0,this._mapTileMemory=0;const e=this.cpuImageMemorySize;for(const{data:t}of this.layerInfo[1])t instanceof t$q?this._mapTileMemory+=o$1c(t.texture):t instanceof HTMLImageElement||t instanceof Q$5?this._mapTileMemory+=e:t instanceof d$f&&(this._mapTileMemory+=t.memoryUsage);for(const t of this.layerInfo[0])this._usedMemory+=t.data?e:0;this.renderData&&(this._usedMemory+=this.renderData.estimatedGeometryMemoryUsage,this._mapTileMemory+=o$1c(this.renderData.textureDescriptor)),this.isCached&&this._surface.upsampleMapCache.updateSize(i$9(this),this,this.cachedMemory);}getUsedMemoryForLayer(e,t){const i=this.layerInfo[e][t];if(!i||!i.data)return 0;if(1!==e||this.isCached){if(0===e)return this.cpuImageMemorySize}else {const e=i.data;if(e instanceof t$q)return o$1c(e.texture);if(e instanceof HTMLImageElement||e instanceof Q$5)return this.cpuImageMemorySize;if(e instanceof d$15||e instanceof d$f)return e.memoryUsage}return 0}updateScreenDepth(e){r$Z(H$5,this._center[1]),H$5[3]=1,y$O(H$5,H$5,e),this._screenDepth=H$5[2]<0?0:H$5[2]/H$5[3];}shouldSplit(i,s,n){if(r$Y(i.frustum)&&!this._isVisible(i.frustum))return 0;const r=this.level;c$V(O$4,this._center[1],s);let a=p$12(O$4),o=1;c$V(k$4,this._center[0],s);const h=p$12(k$4);h<a&&(a=h,o=0),c$V(k$4,this._center[2],s);const l=p$12(k$4);if(l<a&&(a=l,o=2),this._edgeLen2>a&&r<i.maxLod)return 2;const m=Math.sqrt(a),_=i.fovX*m*2,y=this._edgeLen/_,v=()=>{const t=r+Math.ceil(-M$B(i.relativeWidthLimit/y));return t!==this.vlevel?(this.vlevel=t,4):1};if(1===n){if(1===this._surface.snapLevel-r)return r>=i.maxLod?v():2}const A=z$u(this.up,O$4),M=this._elevationBounds[1]-this._elevationBounds[0],L=M/this.edgeLen;if(i.aboveGround&&A>0&&L<.001){if(A/m-Math.sin(this._curvatureHeight/(this.edgeLen*Math.SQRT1_2)*Math.PI)-L>0)return 0}if(y<i.relativeWidthLimit)return this.vlevel!==this.level?(this.vlevel=this.level,4):0;if(r>=i.maxLod)return v();if(r>6){c$V(k$4,this._center[o],s),d$O(z$4,this.up,A),c$V(z$4,z$4,k$4);const e=p$12(z$4);if(e>this.radius*this.radius){d$O(z$4,z$4,this.radius/Math.sqrt(e)),u$S(z$4,z$4,this._center[o]),c$V(z$4,s,z$4);const t=Math.min(1,(Math.abs(z$u(z$4,this.up))+.5*M+this._curvatureHeight)/s$P(z$4)),n=G$4/i.angledSplitBias,r=i.fovY*m*2;if(t*(this._edgeLen/r)<n*i.relativeHeightLimit)return 0}}return 2}setChildren(e,t,i,s){f$e(!!(e&&t&&i&&s),"Null child passed"),this._children[0]=e,this._children[1]=t,this._children[2]=i,this._children[3]=s;}unsetChildren(){this._children[0]=null,this._children[1]=null,this._children[2]=null,this._children[3]=null;}load(e){this.refMapData();for(const t of o$Q)this._createOrUpdateAgents(0,t);e.loadTile(this);}unload(e){e.unloadTile(this);for(const t of o$Q){const e=this.layerInfo[t];for(const t of e)t.loadingAgent&&t.loadingAgent!==d$b&&(Y$2(t.loadingAgent),t.loadingAgent=null),t.pendingUpdates=0;}this.resetPendingUpdate(32),this.resetPendingUpdate(64),this.unrefMapData();}unloadMapData(){const e=this.layerInfo[1];for(const t of e)t.loadingAgent&&t.loadingAgent!==d$b&&(Y$2(t.loadingAgent),t.loadingAgent=null),t.pendingUpdates=0;this.renderData&&this.renderData.releaseTexture(),this.setMemoryDirty();}updateClippingStatus(e){if(G$q(e,this._clippingArea))return !1;const i=this._intersectsClippingArea,s=this._isWithinClippingArea;r$Y(e)?(this._intersectsClippingArea=this.intersectsExtent(e),this._isWithinClippingArea=this._isWithinExtent(e)):(this._intersectsClippingArea=!0,this._isWithinClippingArea=!0),this._clippingArea=e,this.updateVisibility();const n=s&&this._isWithinClippingArea,r=!(s||i||this._isWithinClippingArea||this._intersectsClippingArea);return !this.renderData||n||r||this.setPendingUpdate(32),!0}updateVisibility(){this._dirty=!0,this._surface.setTileTreeDirty();}getLayerInfo(e,t){return this.layerInfo[t][e]}hasLayerData(e,t){const i=this.layerInfo[t][e];return !(!i||!i.data||i.dataInvalidated)}get updating(){if(this.hasPendingUpdates)return !0;for(const e of o$Q){const t=this.layerInfo[e];for(const e of t)if(e.loadingAgent&&e.loadingAgent!==d$b&&e.loadingAgent.updating)return !0}return !1}isSuspended(e){return !!this.hasPendingUpdate(2)||0!==e&&!this.loadable}get hasPendingUpdates(){return 0!==this._pendingUpdates}hasPendingUpdate(e){return (this._pendingUpdates&e)===e}setPendingUpdate(e){this._pendingUpdates|=e,2===e||8===e?this._surface.setTileTreeDirty():this._surface.requestUpdate();}resetPendingUpdate(e){return !!this.hasPendingUpdate(e)&&(this._pendingUpdates&=~e,!0)}requestLayerData(e,t,s){const n=this.layerInfo[t][e];if(n.waitingAgents.has(s))return console.warn("agent already requested this piece of map data (tile %s, agent tile %s, layer: %d/%d)",this.lij.toString(),s.tile.lij.toString(),t,e),!0;if(n.waitingAgents.push(s),n.data&&!n.dataInvalidated)return console.warn("agent requested existing data (tile %s, agent tile %s, layer: %d/%d)",this.lij.toString(),s.tile.lij.toString(),t,e),s.dataArrived(this),!0;if(n.requestPromise)return !0;a$$(n.requestAbort),n.requestAbort=h$N();const a=this._surface.requestTileData(this,e,t,n.requestAbort);if(!a)return n.requestAbort=null,!1;const o=()=>{n.requestPromise===a&&(n.requestPromise=null,n.requestAbort=null);};return n.requestPromise=a,a.then(o,o),!0}get isLeaf(){return null==this._children[0]}hasLij(e){return this.lij[0]===e[0]&&this.lij[1]===e[1]&&this.lij[2]===e[2]}findByLij(e){if(this.hasLij(e))return this;if(this.isLeaf)return null;const t=this._children[0].findByLij(e)||this._children[1].findByLij(e)||this._children[2].findByLij(e)||this._children[3].findByLij(e);return t||null}distanceToSquared(e){return p$12(c$V(z$4,this._center[1],e))}containsPoint(e){const t=this.extent;return e[0]>=t[0]&&e[1]>=t[1]&&e[0]<=t[2]&&e[1]<=t[3]}unrequestLayerData(e,t,i){const s=this.layerInfo[t][e],n=s.waitingAgents,r=null!=n.removeUnordered(i);f$e(r,"agent has not requested this piece of map data"),n.length<1&&(s.abortRequest(),this._updateMemoryUsed());}dataArrived(e,t,i){const s=this.layerInfo[t][e];s.data=i,s.dataInvalidated=!1,s.waitingAgents.forAll((e=>e.dataArrived(this))),s.waitingAgents.clear(),this._updateMemoryUsed();}dataMissing(e,t,i){i.notInTilemap||console.error(`Tile ${this.lij.toString()} layer ${t}/${e} error ${i}`);const s=this.layerInfo[t][e];s.dataMissing=!0,s.waitingAgents.forAll((e=>e.dataMissing())),s.waitingAgents.clear(),this._updateMemoryUsed();}updateRenderData(e){switch(e){case 1:return this.updateTexture();case 0:return this.updateGeometry()}}updateTexture(){this.renderData&&this.setPendingUpdate(64);}updateGeometry(){this.setPendingUpdate(32);for(const e of this.layerInfo[0])e.pendingUpdates|=32;}invalidateLayerData(e,t){this.layerInfo[t][e].invalidateSourceData(),this.restartAgents(t);}computeElevationBounds(){r$18(this._elevationBounds,Number.MAX_VALUE,-Number.MAX_VALUE);const e=this.layerInfo[0];let i=!0;for(const s of e)r$Y(s.elevationBounds)&&(this._elevationBounds[0]=Math.min(this._elevationBounds[0],s.elevationBounds.min),this._elevationBounds[1]=Math.max(this._elevationBounds[1],s.elevationBounds.max),s.elevationBounds.hasNoDataValues||(i=!1));i&&(this._elevationBounds[0]=Math.min(this._elevationBounds[0],0),this._elevationBounds[1]=Math.max(this._elevationBounds[1],0)),this.updateRadiusAndCenter(),this._surface.setTileTreeDirty();}_updateCenter(){const e=.5*(this._elevationBounds[0]+this._elevationBounds[1]);d$O(z$4,this.up,e),u$S(this._center[1],this.centerAtSeaLevel,z$4),d$O(z$4,this.up,this._elevationBounds[0]),u$S(this._center[0],this.centerAtSeaLevel,z$4),d$O(z$4,this.up,this._elevationBounds[1]),u$S(this._center[2],this.centerAtSeaLevel,z$4);}findElevationBoundsForLayer(e,i){const n=this.layerInfo[0][e];if(r$Y(n.elevationBounds)&&n.elevationBounds.level>=i)return;const r=this._surface.layerViewByIndex(e,0),a=v$8(r);if(!o$h(this,a,!1))return;const o=K$5;let h=!1;if(n.data){const e=n.data;o.min=e.bounds[0],o.max=e.bounds[1],o.hasNoDataValues=e.hasNoDataValues,o.level=this.lij[0],h=!0;}else {let t,i,s=0;for(let n=this._parent;n&&(!i||s<E$v)&&(s=this.vlevel-n.level,t=i||t,i=n.layerInfo[0][e].data,!(!i&&t&&s>=E$v));n=n.parent);i=i||t,i&&(i.computeMinMaxValue(this.lij[0],this.lij[1],this.lij[2],o),o.min!==1/0&&(o.level=i.level,h=!0));}h&&(t$17(n.elevationBounds)&&(n.elevationBounds=new s$f),n.elevationBounds.copyFrom(o));}modifyLayers(e,t,i){const s=this.layerInfo[i];for(const a of s)a.loadingAgent&&a.loadingAgent!==d$b&&(Y$2(a.loadingAgent),a.loadingAgent=null),a.waitingAgents.clear();for(let a=0;a<s.length;++a)void 0===e[a]&&s[a].release();const n=new Array(...s),r=t.length;s.length=r;for(let a=0;a<r;a++){const e=t[a];s[a]=e>-1?n[e]:l$b.acquire(this._surface.upsampleInfoPool);}this._updateMemoryUsed();}restartAgents(e){this.renderData&&(this._createOrUpdateAgents(0,e),this.updateRenderData(e));}updateAgents(e){if(this.renderData){const t=this.layerInfo[e];for(const e of t)e.loadingAgent===d$b&&(e.loadingAgent=null);this._createOrUpdateAgents(0,e);}}updateAgentSuspension(){for(const e of o$Q){const t=this.isSuspended(e);for(const i of this.layerInfo[e])i.loadingAgent&&i.loadingAgent!==d$b&&(i.loadingAgent.setSuspension(t),i.loadingAgent===d$b&&this.updateRenderData(e));}}removeLayerAgent(e,t){const i=this.layerInfo[t][e];i.loadingAgent&&i.loadingAgent!==d$b&&i.loadingAgent.dispose(),i.loadingAgent=null;}agentDone(e,t){const i=this.layerInfo[t][e];i.loadingAgent=d$b,i.data||i.upsampleInfo||this._createOrUpdateAgents(e+1,t);}_createOrUpdateAgents(e,t){const i=this.isSuspended(t),s=this.layerInfo[t];for(let n=e;n<s.length;++n){const e=s[n];let r=!1;const a=this._surface.layerViewByIndex(n,t),o=v$8(a);if(e.loadingAgent?o$h(this,o,!1)?(e.loadingAgent!==d$b&&e.loadingAgent.setSuspension(i),e.loadingAgent!==d$b&&(r=e.loadingAgent.update())):e.dispose():o$h(this,o,!1)&&(e.loadingAgent=$$4(this,n,t,i),r=e.loadingAgent.startLoading(),r?e.loadingAgent===d$b&&this.setPendingUpdate(32):(Y$2(e.loadingAgent),e.loadingAgent=d$b)),e.loadingAgent===d$b&&this.updateRenderData(t),r&&a.isOpaque)return}}_isWithinExtent(e){const t=this.extent;return t[0]>=e[0]&&e[2]>=t[2]&&t[1]>=e[1]&&e[3]>=t[3]}intersectsExtent(e){const t=this.extent;return t[2]>=e[0]&&e[2]>=t[0]&&t[3]>=e[1]&&e[3]>=t[1]}get test(){return {cachedMemory:this.cachedMemory}}}function $$4(e,t,i,s){const n=0===i?J$5.acquire():Q$4.acquire();return n.init(e,t,i,s),n}function Y$2(e){e.dispose(),e instanceof r$f?J$5.release(e):e instanceof t$k&&Q$4.release(e);}const Q$4=new e$X(t$k),J$5=new e$X(r$f),K$5=new s$f,Z$3=-1;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class r$d extends X$2{constructor(t,e,i){super(r$d.NumSubdivisionsAtLevel),void 0!==t&&this.init(t,e,i);}init(e,i,s){super.init(e,i,s),this._edgeLen=this.extent[2]-this.extent[0],this._edgeLen2=this._edgeLen*this._edgeLen,this.centerAtSeaLevel[0]=m$V(this.extent[0],this.extent[2],.5),this.centerAtSeaLevel[1]=m$V(this.extent[1],this.extent[3],.5),this.centerAtSeaLevel[2]=0,this.updateRadiusAndCenter();}updateRadiusAndCenter(){this._updateCenter();const t=(this.extent[2]-this.extent[0])*Math.SQRT1_2,e=.5*(this.elevationBounds[0]-this.elevationBounds[1]);this._center[1][3]=Math.sqrt(t*t+e*e);}_isVisible(t){return this.intersectsClippingArea&&B$g(t,v$R(this.extent[0],this.extent[1],this.elevationBounds[0],this.extent[2],this.extent[3],this.elevationBounds[1]))}createGeometry(t,e){P$5(t,this.extent,e,this.renderData),this.setMemoryDirty();}}r$d.NumSubdivisionsAtLevel=[2,2,2,2,2,2,2,2];

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class m$b extends X$2{constructor(t,i,s){super(f$b),this.obb=new Array(8),this.isWebMercator=!1;for(let e=0;e<8;e++)this.obb[e]=n$11();void 0!==t&&this.init(t,i,s);}init(s,e,r){super.init(s,e,r),this.isWebMercator=r.tilingScheme.spatialReference.isWebMercator;const a=this.ellipsoid.radius,n=this.extentInRadians[0],l=this.extentInRadians[1],d=this.extentInRadians[2],p=this.extentInRadians[3],c=s[0],u=m$V(l,p,.5),m=m$V(n,d,.5),f=0===c?0:Math.min(Math.abs(l),Math.abs(p));this._edgeLen=(d-n)*Math.cos(f)*a,this._edgeLen2=this._edgeLen*this._edgeLen,this._curvatureHeight=a-Math.sqrt(a*a-this._edgeLen2/4),_n(this.centerAtSeaLevel,m,u,this.ellipsoid.radius,0);const _=e$11(this.centerAtSeaLevel);j$F(_,_),this.up=_,this._updateOBB(),this.updateRadiusAndCenter();}updateRadiusAndCenter(){if(0===this.lij[0])o$S(this._center[1],0,0,0),o$S(this._center[0],0,0,0),o$S(this._center[2],0,0,0),this.ellipsoid||(this.ellipsoid=p$15(this.surface.tilingScheme.spatialReference)),this._center[1][3]=this.ellipsoid.radius+this.elevationBounds[1];else {this._updateCenter();const t=Math.max(x$P(this._center[1],this.obb[0]),x$P(this._center[1],this.obb[1]));this._center[1][3]=Math.sqrt(t);}}_isVisible(t){if(!this.intersectsClippingArea)return !1;if(this.lij[0]<10)return R$n(t,this._center[1]);const i=this.obb;for(let s=0;s<6;s++){let e,r=t[s];for(4===s&&(r=b$D(r,_$5),_$5[3]-=this.surface.view.state.camera.near),e=0;e<8&&!J$k(r,i[e]);e++);if(8===e)return !1}return !0}computeElevationBounds(){super.computeElevationBounds(),this._updateOBB();}createGeometry(t,i){const s=this._isPole(this.lij[1],this.lij[0]);v$7(t,this.extent,i,this.renderData,this.extentInRadians,this.isWebMercator,this.ellipsoid,s),this.setMemoryDirty();}_updateOBB(){const t=this.extentInRadians,i=this.obb;for(let s=0;s<2;s++){const e=this.elevationBounds[s];let r=4*s;_n(i[r++],t[0],t[1],this.ellipsoid.radius,e),_n(i[r++],t[0],t[3],this.ellipsoid.radius,e),_n(i[r++],t[2],t[3],this.ellipsoid.radius,e),_n(i[r++],t[2],t[1],this.ellipsoid.radius,e);}if(this.isWebMercator){const t=this._isPole(this.lij[1],this.lij[0]);2===t?(o$S(i[1],0,0,this.ellipsoid.radius),o$S(i[2],0,0,this.ellipsoid.radius),o$S(i[5],0,0,this.ellipsoid.radius),o$S(i[6],0,0,this.ellipsoid.radius)):1===t&&(o$S(i[0],0,0,-this.ellipsoid.radius),o$S(i[3],0,0,-this.ellipsoid.radius),o$S(i[4],0,0,-this.ellipsoid.radius),o$S(i[7],0,0,-this.ellipsoid.radius));}}_isPole(t,i){let s=0;return t===(1<<i)-1&&(s+=1),0===t&&(s+=2),s}}const f$b=[128,64,32,16,16,8,8,4],_$5=p$11();

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
let x$6=class extends p$14{constructor(e){super(e),this._handles=new u$T;}initialize(){this._handles.add([this.layerViews.on("change",(()=>this.notifyChange("stencilEnabledExtents")))]);}destroy(){this._handles.destroy(),this._handles=null;}get layerViewsExtent(){return this._computeLayerViewsExtent()}get tiledLayersExtent(){return this._computeTiledLayersExtent()}get stencilEnabledExtents(){return this._computeStencilEnabledExtents()}set spatialReference(e){this.tilingScheme||this._set("spatialReference",e);}set tilingScheme(e){this._set("tilingScheme",e),this._set("spatialReference",e.spatialReference);}_computeStencilEnabledExtents(){const e=[];return this.layerViews.forEach((t=>{const s=t.layer;if("IntegratedMeshLayer"===s.operationalLayerType&&null!=this.spatialReference){const t=L$5(s.fullExtent,this.spatialReference);null!=t&&e.push(a$1m(t));}})),e}};function g$9(e,t){return 1===e?new _$4(t):new w$5(t)}e$Q([y$K({readOnly:!0,dependsOn:[]})],x$6.prototype,"layerViewsExtent",null),e$Q([y$K({readOnly:!0,dependsOn:["spatialReference","tilingScheme"]})],x$6.prototype,"tiledLayersExtent",null),e$Q([y$K({readOnly:!0,dependsOn:["spatialReference"]})],x$6.prototype,"stencilEnabledExtents",null),e$Q([y$K()],x$6.prototype,"spatialReference",null),e$Q([y$K()],x$6.prototype,"tilingScheme",null),e$Q([y$K()],x$6.prototype,"defaultTiledLayersExtent",void 0),e$Q([y$K({constructOnly:!0})],x$6.prototype,"layers",void 0),e$Q([y$K({constructOnly:!0})],x$6.prototype,"layerViews",void 0),x$6=e$Q([n$14("esri.views.3d.terrain.SurfaceExtentHelperBase")],x$6);let _$4=class extends x$6{_computeLayerViewsExtent(){return this._getGlobalExtent()}_computeTiledLayersExtent(){return this._getGlobalExtent()}_getGlobalExtent(){return this.spatialReference.isWebMercator?s$N:T$s}};e$Q([y$K({dependsOn:["spatialReference"]})],_$4.prototype,"layerViewsExtent",void 0),_$4=e$Q([n$14("esri.views.3d.terrain.SurfaceExtentHelperGlobal")],_$4);let w$5=class extends x$6{initialize(){this._handles.add([this.layers.on("change",(e=>this._handleLayersChanged(e))),this.layerViews.on("change",(()=>this.notifyChange("layerViewsExtent")))]);}_handleLayersChanged(e){for(const t of e.removed)this._handles.remove(t.uid);for(const t of e.added)this._handles.add(d$S(t,"loaded",(()=>this.notifyChange("tiledLayersExtent"))),t.uid);}_computeLayerViewsExtent(){const e=B$m(),t=this.spatialReference;this.layerViews.forEach((s=>{const r=s.layer;if(s.isResolved()&&("graphics"!==r.type||!r.internal)){const r=L$5("fullExtentInLocalViewSpatialReference"in s&&s.fullExtentInLocalViewSpatialReference||s.layer.fullExtent,t);r&&c$14(e,r);}}));const s=h$S(e)?e:null,r=this._get("layerViewsExtent");return G$q(s,r)?r:s}_computeTiledLayersExtent(){const e=this.tilingScheme;if(!e)return null;const t=this.spatialReference,s=B$m();this.layers.forEach((function(r){if(r.loaded&&e$N(r)){const{tileInfo:n,fullExtent:i}=C$4(r,t,2);(n&&I$7(r)&&i||n&&e.compatibleWith(n)&&i&&i.spatialReference.equals(t))&&c$14(s,i);}})),this.defaultTiledLayersExtent&&c$14(s,this.defaultTiledLayersExtent);const r=h$S(s)?s:null,n=this._get("tiledLayersExtent");return G$q(r,n)?n:r}};function L$5(e,t){return e&&!e.spatialReference.equals(t)&&(e=x$O(e.spatialReference,t)?g$11(e,t):null),e}w$5=e$Q([n$14("esri.views.3d.terrain.SurfaceExtentHelperLocal")],w$5);

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
let m$a=class extends p$14{constructor(e){super(e),this._handles=new u$T;}initialize(){this._handles.add(this.layers.on("change",(()=>this._update()))),this._handles.add(this.extentHelper.watch("layerViewsExtent",(()=>this._setAdHocTilingScheme()))),this._update(),this.tilingSchemeLocked||this._setAdHocTilingScheme();}destroy(){this._handles.destroy(),this._handles=null,this._waitTask=null;}_update(){if(this._waitTask=null,this.tilingSchemeLocked)return;let e;if(this._set("tilingSchemeDone",!1),this.layers.some((t=>!(!e$N(t)||t.isRejected())&&(!(t.isFulfilled()&&!S$5(t,this.viewSpatialReference,this.viewingMode))&&(e=t,!p$f(t)&&!I$7(t))))),e)if(e.isResolved()){const t=e,{tileInfo:i}=C$4(t,this.viewSpatialReference,this.viewingMode),s=new x$L(i);this._set("tilingSchemeDone",!0),this._lockTilingScheme(s);}else this._updateWhen(e);else this._set("tilingSchemeDone",!0);}_updateWhen(e){const t=e.when().catch((e=>e)).then((()=>{t!==this._waitTask||this.destroyed||this._update();}));this._waitTask=t;}_lockTilingScheme(e){if(1===this.viewingMode){const t=e.levels.length-1;e.spatialReference.isWebMercator?e=x$L.makeWebMercatorAuxiliarySphere(t):Zn(e.spatialReference)&&(e=x$L.makeGCSWithTileSize(e.spatialReference,e.pixelSize,t));}this.tilingSchemeLocked=!0,this.tilingScheme=e,this.extentHelper.tilingScheme=this.tilingScheme,this._updateTiledLayerExtent(),this._handles.removeAll(),this._handles.add(this.extentHelper.watch("tiledLayersExtent",(()=>this._updateTiledLayerExtent())));}_updateTiledLayerExtent(){this.extent=this.extentHelper.tiledLayersExtent;}_setAdHocTilingScheme(){if(1===this.viewingMode){const e=this.extentHelper.spatialReference,t=Zn(e)||k$y(e)||P$y(e);e.isWebMercator?this.tilingScheme=x$L.WebMercatorAuxiliarySphere:t&&(this.tilingScheme=x$L.makeGCSWithTileSize(e,256)),this.extent=this.extentHelper.layerViewsExtent;}else {const e=this.extentHelper.layerViewsExtent;e&&(this.tilingScheme=x$L.fromExtent(e,this.extentHelper.spatialReference),this.extent=e);}}};function S$5(e,t,i){return !!C$4(e,t,i).tileInfo}e$Q([y$K()],m$a.prototype,"tilingScheme",void 0),e$Q([y$K()],m$a.prototype,"extent",void 0),e$Q([y$K({value:!1})],m$a.prototype,"tilingSchemeLocked",void 0),e$Q([y$K({readOnly:!0,value:!1})],m$a.prototype,"tilingSchemeDone",void 0),e$Q([y$K({constructOnly:!0})],m$a.prototype,"viewSpatialReference",void 0),e$Q([y$K({constructOnly:!0})],m$a.prototype,"layers",void 0),e$Q([y$K({constructOnly:!0})],m$a.prototype,"extentHelper",void 0),e$Q([y$K({constructOnly:!0})],m$a.prototype,"viewingMode",void 0),m$a=e$Q([n$14("esri.views.3d.terrain.SurfaceTilingSchemeLogic")],m$a);

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class r$c{constructor(t){this._getFadeDuration=t,this._fadeStart=0,this._delayedTime=0;}clear(){this._current=l$W(this._current),this._next=l$W(this._next),this._waiting=l$W(this._waiting),this._delayed=l$W(this._delayed);}get current(){if(t$17(this._current))return null;if(!this._isFading){const t=this._delayed||this._waiting||this._next||this._current;t!==this._current&&(this._current=null,this.clear(),this._current=t);}let s=0;if(r$Y(this._delayed)&&(s=performance.now(),s>=this._delayedTime&&(this._push(this._delayed,0),this._delayed=null)),r$Y(this._next)){s=s||performance.now();const e=this._fadeDuration;s-this._fadeStart>=e&&(l$W(this._current),this._current=this._next,this._next=this._waiting,this._waiting=null,this._fadeStart=this._alignFadeStart(s));}return this._current}get next(){return this._next}get fadeFactor(){if(t$17(this._next))return 1;const t=Math.max(0,performance.now()-this._fadeStart),i=this._fadeDuration;return t>i?0:1-t/i}get isFading(){return r$Y(this._next)||r$Y(this._delayed)}push(e,s,r,a,h=0){this._delayed=l$W(this._delayed);const _=r$Y(e)?new n$h(e,s,r,a):null;this._push(_,h);}_push(i,s){if(this._isFading||this.clear(),t$17(this._current))return void(this._current=i);const r=performance.now();return 0!==s?(this._delayed=i,void(this._delayedTime=r+s)):t$17(this._next)?(this._next=i,void(this._fadeStart=this._alignFadeStart(r))):void(t$17(i)||(l$W(this._waiting),this._waiting=i))}get _fadeDuration(){return t$17(this._waiting)?this._getFadeDuration():.5*this._getFadeDuration()}_alignFadeStart(t){const e=this._getFadeDuration();return t+e-t%e}get _isFading(){return this._getFadeDuration()>0}}class n$h{constructor(t,e,i,r){this.texture=t,t.retain(),this.offsetAndScale=r$19(e,i,r,r);}destroy(){this.texture.release();}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class s$d{constructor(){this._scales=[-1,-1,-1,-1],this._offsets=[-1,-1,-1,-1];}clear(){this._scales[0]=this._scales[1]=this._scales[2]=this._scales[3]=-1,this._offsets[0]=this._offsets[1]=this._offsets[2]=this._offsets[3]=-1;}setScale(s,t,e){this._scales[2*s]=t,this._scales[2*s+1]=e;}setOffset(s,t,e){this._offsets[2*s]=t,this._offsets[2*s+1]=e;}get scales(){return this._scales}get offsets(){return this._offsets}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class g$8{constructor(){this.geometryInfo=new h$d,this._textureRef=new r$c((()=>this.tile.surface.textureFadeDuration)),this.overlay=new s$d;}init(e){this.tile=e,this.clear();const t=this.geometryInfo;t.indices=null,t.vertexAttributes=null,B$n(t.boundingBox),t.numSurfaceIndices=0,t.numSkirtIndices=0,t.numWithoutSkirtIndices=0,t.numVertsPerRow=0,this.geometryState={numVertsPerRow:0,samplerData:null,clippingArea:null,wireframe:!1},this.opacity=1,this.localOrigin=null,this.overlay.clear();}clear(){this.releaseGeometry(),this.releaseTexture(),this._textureRef.clear();}updateGeometry(e,t){return !!this._updateGeometryState(t)&&(this._releaseGeometry(),this._createGeometry(e),!0)}releaseGeometry(){return !!this._releaseGeometry()&&(this.geometryState={numVertsPerRow:0,samplerData:null,clippingArea:null,wireframe:!1},!0)}ensureTexture(e,t){return r$Y(this._texture)&&this._texture.descriptor.width!==e&&this.releaseTexture(),t$17(this._texture)&&(this._texture=t(),this.tile.setMemoryDirty()),this._texture}releaseTexture(){r$Y(this._texture)&&(this._texture.release(),this._texture=null,this.tile.setMemoryDirty());}_updateGeometryState(r){const i=this._getElevationInfo(),s=this.tile.level;let a=s<8?this.tile.numSubdivisionsAtLevel[s]+1:2;if(i.samplerData){const e=this.tile.vlevel-s,r=Math.max(s-i.maxTileLevel,E$v-e),o=this.tile.maxTesselation;a=o$R(1+(o>>r),2,o+1);}let o=this.tile.clippingArea;this.tile.intersectsClippingArea&&!this.tile.isWithinClippingArea||(o=null);const l=this.geometryState;let u=!1;return l.numVertsPerRow!==a&&(l.numVertsPerRow=a,u=!0),i.changed&&(l.samplerData=i.samplerData,u=!0),l$1g(l.clippingArea,o)||(l.clippingArea=o,u=!0),l.wireframe!==r&&(l.wireframe=r,u=!0),u}_createGeometry(e){this.tile.createGeometry(this.geometryState,this.localOrigin);const t=this.geometryInfo.vertexAttributes,r=this.geometryInfo.indices,i=e.gl;this._vao=new f$M(e,o$X,{geometry:t$16(t.layout)},{geometry:h$O.createVertex(e,i.STATIC_DRAW,t.buffer)},h$O.createIndex(e,i.STATIC_DRAW,r));}_releaseGeometry(){return !!this._vao&&(this._vao.dispose(),this._vao=null,w$6(this.geometryInfo),!0)}get vao(){return this._vao}setTextureReference(e,t,r,i,s=0){e!==this._texture&&this.releaseTexture(),this._textureRef.push(e,t,r,i,s);}get textureReference(){return this._textureRef.current}get nextTextureReference(){return this._textureRef.next}get textureFadeFactor(){return this._textureRef.fadeFactor}get textureIsFading(){return this._textureRef.isFading}_getElevationInfo(){const e=this.geometryState.samplerData,t=this.tile.layerInfo[0],r=t.length;let i=new Array(r),s=0,a=0,o=!1;for(let l=0;l<r;l++){const r=t[l];if(r.upsampleInfo){const t=r.upsampleInfo.tile,n=t.layerInfo[0][l].data,u=n&&n.samplerData;e&&e[s]===u||(o=!0),i[s++]=u,a=Math.max(a,t.lij[0]);}else if(r.data){const t=this.tile.surface.layerViewByIndex(l,0);if(o$h(this.tile,t.layer,!1)){const t=r.data;e&&e[s]===t.samplerData||(o=!0),i[s++]=t.samplerData,a=this.tile.lij[0];}}}return e&&e.length!==s&&(o=!0),s>0?i.length=s:i=null,{changed:o,samplerData:i,maxTileLevel:a}}get estimatedGeometryMemoryUsage(){return this.geometryInfo.indices.byteLength+this.geometryInfo.vertexAttributes.byteLength}get textureDescriptor(){return r$Y(this._texture)?this._texture.descriptor:null}get test(){return {hasTexture:null!=this._texture}}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
const r$b=.125;class s$c{constructor(){this._renderParams={context:null,drawPhase:1,state:new W$k({viewpoint:new u$17({targetGeometry:new b$G(0,0),scale:1,rotation:0}),size:[256,256]}),stationary:!0,pixelRatio:1,displayLevel:-1,requiredLevel:-1,globalOpacity:1,renderPass:"background",styleLayer:null,styleLayerUID:-1,painter:null,glyphMosaic:null,spriteMosaic:null,driverTestResult:null,profiler:null,renderingOptions:null,deltaTime:-1,timeline:null,time:0,hasClipping:!1,blendMode:null,dataUploadCounter:0,effects:null,inFadeTransition:!1,requireFBO:!1};}dispose(){this._renderParams=null;}render(e,t,i,s,l,a,n,o,p,d){const u=a.adjustLevel(t[0]),c=this._renderParams;c.context=e,c.painter=s,c.glyphMosaic=s.glyphMosaic,c.spriteMosaic=s.spriteMosaic,c.pixelRatio=d,c.displayLevel=u,c.requiredLevel=u;const m=a.getScale(t[0]),[g,y]=a.getShift(t,n*m),h=r$b*n*m/p,f=i.transforms.dvs;f[0]=h,f[4]=-h,f[6]=-1-g-o[0]*n*2,f[7]=1+y+(1-o[1])*n*2-2,c.state.size[0]=p,c.state.size[1]=p,i.stage||i.attachWithContext(e),i.triangleCount=0,s.drawTile(c,i,l);}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
function r$a(){const r=new n$15;return r.attributes.add("position","vec2"),r.attributes.add("uv0","vec2"),r.vertex.uniforms.add("scale","float"),r.vertex.uniforms.add("offset","vec2"),r.varyings.add("uv","vec2"),r.vertex.code.add(t$10`void main(void) {
gl_Position = vec4(position, 0.0, 1.0);
uv = uv0 * scale + offset;
}`),r.fragment.uniforms.add("tex","sampler2D"),r.fragment.uniforms.add("opacity","float"),r.fragment.code.add(t$10`void main() {
vec4 color = texture2D(tex, uv);
gl_FragColor = vec4(color.xyz, 1.0) * color.a * opacity;
}`),r}var t$j=Object.freeze({__proto__:null,build:r$a});

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class m$9 extends t$11{initializeProgram(e){const r=m$9.shader.get().build();return new n$16(e.rctx,r,o$X)}initializePipeline(){const e=2===this.configuration.mode?t$1e(1,771):1===this.configuration.mode?t$1e(0,770):null;return g$S({blending:e,colorWrite:r$13})}}m$9.shader=new t$12(t$j,(()=>import('./BlendLayers.glsl-cd69347c.js')));class g$7 extends e$S{constructor(){super(...arguments),this.mode=0;}}e$Q([r$12({count:3})],g$7.prototype,"mode",void 0);

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
function o$g(o){o.attributes.add("position","vec2"),o.attributes.add("uv0","vec2"),o.vertex.uniforms.add("u_scale","float"),o.vertex.uniforms.add("u_offset","vec2"),o.varyings.add("v_texcoord","vec2"),o.vertex.code.add(t$10`void main(void) {
v_texcoord = uv0 * u_scale + u_offset;
gl_Position = vec4(position, 0.0, 1.0);
}`);}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
function e$e(e){e.fragment.uniforms.add("u_colormap","sampler2D"),e.fragment.uniforms.add("u_colormapOffset","float"),e.fragment.uniforms.add("u_colormapMaxIndex","float"),e.fragment.code.add(t$10`vec4 colormap(vec4 currentPixel, bool isFloat) {
float clrIndex = isFloat ? currentPixel.r - u_colormapOffset : currentPixel.r * 255.0 - u_colormapOffset;
vec4 result;
if (currentPixel.a == 0.0 || clrIndex > u_colormapMaxIndex) {
result = vec4(0.0, 0.0, 0.0, 0.0);
} else {
vec2 clrPosition = vec2((clrIndex + 0.5) / (u_colormapMaxIndex + 1.0), 0.0);
vec4 color = texture2D(u_colormap, clrPosition);
result = vec4(color.rgb, 1.0) * color.a * u_opacity;
}
return result;
}`);}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
function o$f(o){o.fragment.uniforms.add("u_transformGrid","sampler2D"),o.fragment.uniforms.add("u_transformSpacing","vec2"),o.fragment.uniforms.add("u_transformGridSize","vec2"),o.fragment.uniforms.add("u_targetImageSize","vec2"),o.fragment.code.add(t$10`vec2 projectPixelLocation(vec2 coords) {
vec2 index_image = floor(coords * u_targetImageSize);
vec2 oneTransformPixel = vec2(0.25 / u_transformGridSize.s, 1.0 / u_transformGridSize.t);
vec2 index_transform = floor(index_image / u_transformSpacing) / u_transformGridSize;
vec2 pos = fract((index_image + vec2(0.5, 0.5)) / u_transformSpacing);
vec2 srcLocation;
vec2 transform_location = index_transform + oneTransformPixel * 0.5;
if (pos.s <= pos.t) {
vec4 ll_abc = texture2D(u_transformGrid, vec2(transform_location.s, transform_location.t));
vec4 ll_def = texture2D(u_transformGrid, vec2(transform_location.s + oneTransformPixel.s, transform_location.t));
srcLocation.s = dot(ll_abc.rgb, vec3(pos, 1.0));
srcLocation.t = dot(ll_def.rgb, vec3(pos, 1.0));
} else {
vec4 ur_abc = texture2D(u_transformGrid, vec2(transform_location.s + 2.0 * oneTransformPixel.s, transform_location.t));
vec4 ur_def = texture2D(u_transformGrid, vec2(transform_location.s + 3.0 * oneTransformPixel.s, transform_location.t));
srcLocation.s = dot(ur_abc.rgb, vec3(pos, 1.0));
srcLocation.t = dot(ur_def.rgb, vec3(pos, 1.0));
}
return srcLocation;;
}`);}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
function e$d(e){e.include(o$f),e.fragment.uniforms.add("u_image","sampler2D"),e.fragment.uniforms.add("u_isFloatTexture","bool"),e.fragment.uniforms.add("u_flipY","bool"),e.fragment.uniforms.add("u_applyTransform","bool"),e.fragment.uniforms.add("u_opacity","float"),e.fragment.code.add(t$10`vec2 getPixelLocation(vec2 coords) {
vec2 targetLocation = u_flipY ? vec2(coords.s, 1.0 - coords.t) : coords;
if (!u_applyTransform) {
return targetLocation;
}
return projectPixelLocation(targetLocation);
}
bool isOutside(vec2 coords){
if (coords.t>1.00001 ||coords.t<-0.00001 || coords.s>1.00001 ||coords.s<-0.00001) {
return true;
} else {
return false;
}
}
vec4 getPixel(vec2 pixelLocation) {
return texture2D(u_image, pixelLocation);
}`);}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
function r$9(o){const l=new n$15;return l.include(o$g),l.include(e$d),l.include(e$e),0===o.output?n$g(l,o.applyColormap):1===o.output?u$a(l):2===o.output&&f$a(l,o.applyColormap),l}function u$a(a){a.fragment.code.add(t$10`void main() {
vec2 pixelLocation = getPixelLocation(v_texcoord);
if (isOutside(pixelLocation)) {
gl_FragColor = vec4(0.0, 0.0, 0.0, 0.0);
return;
}
vec4 currentPixel = getPixel(pixelLocation);
gl_FragColor = colormap(currentPixel, true);
}`);}function n$g(a,e){a.fragment.uniforms.add("u_bandCount","int"),a.fragment.uniforms.add("u_minCutOff","float",3),a.fragment.uniforms.add("u_maxCutOff","float",3),a.fragment.uniforms.add("u_factor","float",3),a.fragment.uniforms.add("u_minOutput","float"),a.fragment.uniforms.add("u_maxOutput","float"),a.fragment.uniforms.add("u_useGamma","bool"),a.fragment.uniforms.add("u_gamma","float",3),a.fragment.uniforms.add("u_gammaCorrection","float",3),a.fragment.code.add(t$10`float stretchOneValue(float val, float minCutOff, float maxCutOff, float minOutput, float maxOutput, float factor, bool useGamma, float gamma, float gammaCorrection) {
if (val >= maxCutOff) {
return maxOutput;
} else if (val <= minCutOff) {
return minOutput;
}
float stretchedVal;
if (useGamma) {
float tempf = 1.0;
float outRange = maxOutput - minOutput;
float relativeVal = (val - minCutOff) / (maxCutOff - minCutOff);
if (gamma > 1.0) {
tempf -= pow(1.0 / outRange, relativeVal * gammaCorrection);
}
stretchedVal = (tempf * outRange * pow(relativeVal, 1.0 / gamma) + minOutput) / 255.0;
} else {
stretchedVal = minOutput + (val - minCutOff) * factor;
}
return stretchedVal;
}`);const t=e?t$10`gl_FragColor = colormap(vec4(grayVal, grayVal, grayVal, currentPixel.a), !u_useGamma);`:t$10`gl_FragColor = vec4(grayVal, grayVal, grayVal, 1.0) * currentPixel.a * u_opacity;`;a.fragment.code.add(t$10`
      void main() {
        vec2 pixelLocation = getPixelLocation(v_texcoord);
        if (isOutside(pixelLocation)) {
          gl_FragColor = vec4(0.0, 0.0, 0.0, 0.0);
          return;
        }

        vec4 currentPixel = getPixel(pixelLocation);
        if (currentPixel.a == 0.0) {
          gl_FragColor = vec4(0.0, 0.0, 0.0, 0.0);
          return;
        }

        if (u_bandCount == 1) {
          float grayVal = stretchOneValue(currentPixel.r, u_minCutOff[0], u_maxCutOff[0], u_minOutput, u_maxOutput, u_factor[0], u_useGamma, u_gamma[0], u_gammaCorrection[0]);
          ${t}
        } else {
          float redVal = stretchOneValue(currentPixel.r, u_minCutOff[0], u_maxCutOff[0], u_minOutput, u_maxOutput, u_factor[0], u_useGamma, u_gamma[0], u_gammaCorrection[0]);
          float greenVal = stretchOneValue(currentPixel.g, u_minCutOff[1], u_maxCutOff[1], u_minOutput, u_maxOutput, u_factor[1], u_useGamma, u_gamma[1], u_gammaCorrection[1]);
          float blueVal = stretchOneValue(currentPixel.b, u_minCutOff[2], u_maxCutOff[2], u_minOutput, u_maxOutput, u_factor[2], u_useGamma, u_gamma[2], u_gammaCorrection[2]);
          gl_FragColor = vec4(redVal, greenVal, blueVal, 1.0) * currentPixel.a * u_opacity;
        }
      }
    `);}function f$a(a,e){a.fragment.uniforms.add("u_hillshadeType","int"),a.fragment.uniforms.add("u_sinZcosAs","float",6),a.fragment.uniforms.add("u_sinZsinAs","float",6),a.fragment.uniforms.add("u_cosZs","float",6),a.fragment.uniforms.add("u_weights","float",6),a.fragment.uniforms.add("u_factor","vec2"),a.fragment.uniforms.add("u_applyColormap","bool"),a.fragment.uniforms.add("u_minValue","float"),a.fragment.uniforms.add("u_maxValue","float"),a.fragment.uniforms.add("u_srcImageSize","vec2"),a.fragment.include(e$U),a.fragment.code.add(t$10`vec4 overlay(float val, float minValue, float maxValue, float hillshade, float alpha) {
val = clamp((val - minValue) / (maxValue - minValue), 0.0, 1.0);
vec4 rgb = colormap(vec4(val, val, val, 1.0), false);
vec3 hsv = rgb2hsv(rgb.xyz);
hsv.z = hillshade;
return vec4(hsv2rgb(hsv) * alpha, alpha);
}`),a.fragment.code.add(t$10`float getNeighborHoodAlpha(float a, float b, float c, float d, float e, float f, float g, float h, float i){
if (a == 0.0 || a == 0.0 || a==0.0 || a == 0.0 || a == 0.0 || a==0.0 || a == 0.0 || a == 0.0 || a==0.0) {
return 0.0;
}  else {
return e;
}
}`);const t=e?t$10`gl_FragColor = overlay(ve.r, u_minValue, u_maxValue, hillshade, alpha);`:t$10`hillshade *= alpha;
gl_FragColor = vec4(hillshade, hillshade, hillshade, alpha);`;a.fragment.code.add(t$10`
    void main() {
      vec2 pixelLocation = getPixelLocation(v_texcoord);
      if (isOutside(pixelLocation)) {
        gl_FragColor = vec4(0.0, 0.0, 0.0, 0.0);
        return;
      }

      vec4 currentPixel = getPixel(pixelLocation);
      if (currentPixel.a == 0.0) {
        gl_FragColor = vec4(0.0, 0.0, 0.0, 0.0);
        return;
      }

      //mirror edge pixels
      vec2 axy = vec2(-1.0, -1.0);
      vec2 bxy = vec2(0.0, -1.0);
      vec2 cxy = vec2(1.0, -1.0);
      vec2 dxy = vec2(-1.0, 0.0);
      vec2 fxy = vec2(1.0, 0.0);
      vec2 gxy = vec2(-1.0, 1.0);
      vec2 hxy = vec2(0.0, 1.0);
      vec2 ixy = vec2(1.0, 1.0);
      vec2 onePixel = 1.0 / u_srcImageSize;
      if (pixelLocation.s < onePixel.s) {
        axy[0] = 1.0;
        dxy[0] = 1.0;
        gxy[0] = 1.0;
      }
      if (pixelLocation.t < onePixel.t) {
        axy[1] = 1.0;
        bxy[1] = 1.0;
        cxy[1] = 1.0;
      }
      if (pixelLocation.s > 1.0 - onePixel.s) {
        cxy[0] = -1.0;
        fxy[0] = -1.0;
        ixy[0] = -1.0;
      }
      if (pixelLocation.t > 1.0 - onePixel.t) {
        gxy[1] = -1.0;
        hxy[1] = -1.0;
        ixy[1] = -1.0;
      }

      // calculate hillshade
      vec4 va = texture2D(u_image, pixelLocation + onePixel * axy);
      vec4 vb = texture2D(u_image, pixelLocation + onePixel * bxy);
      vec4 vc = texture2D(u_image, pixelLocation + onePixel * cxy);
      vec4 vd = texture2D(u_image, pixelLocation + onePixel * dxy);
      vec4 ve = texture2D(u_image, pixelLocation);
      vec4 vf = texture2D(u_image, pixelLocation + onePixel * fxy);
      vec4 vg = texture2D(u_image, pixelLocation + onePixel * gxy);
      vec4 vh = texture2D(u_image, pixelLocation + onePixel * hxy);
      vec4 vi = texture2D(u_image, pixelLocation + onePixel * ixy);

      // calculate the rate of z change along the x, y, and diagonal direction
      float dzx = (vc + 2.0 * vf + vi - va - 2.0 * vd - vg).r * u_factor.s;
      float dzy = (vg + 2.0 * vh + vi - va - 2.0 * vb - vc).r * u_factor.t;
      float dzd = sqrt(1.0 + dzx * dzx + dzy * dzy);
      float hillshade = 0.0;

      // traditional single light source
      if (u_hillshadeType == 0){
        float cosDelta = u_sinZsinAs[0] * dzy - u_sinZcosAs[0] * dzx;
        float z = (u_cosZs[0] + cosDelta) / dzd;
        if (z < 0.0)  z = 0.0;
        hillshade = z;
      } else {
        // multi-directional with 6 light sources
        for (int k = 0; k < 6; k++) {
        float cosDelta = u_sinZsinAs[k] * dzy - u_sinZcosAs[k] * dzx;
        float z = (u_cosZs[k] + cosDelta) / dzd;
        if (z < 0.0) z = 0.0;
        hillshade = hillshade + z * u_weights[k];
        if (k == 5) break;
        }
      }

      // set color
      float alpha = getNeighborHoodAlpha(va.a, vb.a, vc.a, vd.a, ve.a, vf.a, vg.a, vh.a, vi.a);
      alpha *= u_opacity;
      ${t}
    }
  `);}var c$e=Object.freeze({__proto__:null,build:r$9});

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class f$9 extends t$11{get uniformLocationInfos(){return this._uniformLocationInfos||(this._uniformLocationInfos=m$10(this._context,this.program)),this._uniformLocationInfos}initializeProgram(o){const r=f$9.shader.get(),i=this.configuration,e=r.build({output:i.colorizerType,applyColormap:i.applyColormap});return this._context=o.rctx,new n$16(o.rctx,e,o$X)}initializePipeline(){const o=2===this.configuration.mode?t$1e(1,771):1===this.configuration.mode?t$1e(0,770):null;return g$S({blending:o,colorWrite:r$13})}bindPass(o){c$1a(this.program,this.uniformLocationInfos,o.basic),c$1a(this.program,this.uniformLocationInfos,o.common),r$Y(o.colormap)&&c$1a(this.program,this.uniformLocationInfos,o.colormap),0===this.configuration.colorizerType&&r$Y(o.stretch)?c$1a(this.program,this.uniformLocationInfos,o.stretch):2===this.configuration.colorizerType&&r$Y(o.hillshade)&&c$1a(this.program,this.uniformLocationInfos,o.hillshade);}}f$9.shader=new t$12(c$e,(()=>import('./RasterColorizer.glsl-921e5642.js')));class g$6 extends e$S{constructor(){super(...arguments),this.mode=2,this.colorizerType=0,this.applyColormap=!0;}}e$Q([r$12({count:3})],g$6.prototype,"mode",void 0),e$Q([r$12({count:3})],g$6.prototype,"colorizerType",void 0),e$Q([r$12()],g$6.prototype,"applyColormap",void 0);

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class o$e{constructor(e){this.renderingContext=e,this._pools=new Map;}acquire(e){return this.getPool(e).acquire()}release(e){this.getPool(e.width).release(e);}clear(){this._pools.forEach((e=>e.destroy())),this._pools.clear();}getPool(o){let r=this._pools.get(o);if(!r){const s=o$15.bind(o$15,this.renderingContext,{colorTarget:0,depthStencilTarget:1,width:o,height:o});r=new e$X(s),this._pools.set(o,r);}return r}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class R$5{constructor(e,t,r){this._rctx=e,this.tileSize=t,this._backgroundIsGrid=!1,this._backgroundTexture=null,this._backgroundColor=null,this._blackTex=null,this._vectorTileHelper=new s$c,this._maxAnisotropy=this._rctx.parameters.maxMaxAnisotropy,this._vaoQuad=i$T(this._rctx,s$1c);const a=new g$7;a.mode=2,this._blendLayersTechnique=r.acquire(m$9,a),a.mode=1,this._applyOpacityTechnique=r.acquire(m$9,a),this._techniqueRep=r,this._blackTex=new t$q(f$10(this._rctx,[0,0,0,1])),this._fboPool=new o$e(this._rctx);}dispose(){this._fboPool&&(this._fboPool.clear(),this._fboPool=null),this._vaoQuad=i$S(this._vaoQuad),this._backgroundTexture=h$U(this._backgroundTexture),this._blackTex=h$U(this._blackTex),this._blendLayersTechnique=i$S(this._blendLayersTechnique),this._applyOpacityTechnique=i$S(this._applyOpacityTechnique),this._vectorTileHelper=i$S(this._vectorTileHelper);}updateTileTexture(e){const t=e.layerInfo[1];for(const a of t)a.pendingUpdates&=-65;if(!e.renderData)return;const r=e.surface,i=r.baseOpacity;let o=0,n=0,l=this.tileSize,u=!1;const h=r.view.pixelRatio;let d=t.length,f=0;for(;f<t.length&&!u;f++){const s=r.layerViewByIndex(f,1),p=s.fullOpacity;if(P$4[f]=p,t$Z(s.layer)&&d>=t.length&&(d=f),0===p)continue;++n;const _=q$4(e,f,U$5);_&&(E$6(s)?l=Math.max(l,this.tileSize*h):1===i&&1===p&&(s.isOpaque||this._dataToTexture(_)&&r$Y(_.sourceLayerInfo.data)&&_.sourceLayerInfo.data.descriptor.isOpaque)&&(u=!0),++o);}this._cleanupFBOPool(h,t.length),l=j$5(l);const p=l/this.tileSize,_=f-1;if(0===o){let t=0;return (e.surface.view.layerViewManager.updating||n>0)&&(t=5e3),this._backgroundTexture&&t$17(e.renderData.textureReference)&&(t=0),void this._useBackgroundTexture(e,t)}1===o&&(u||this._backgroundIsGrid||r$Y(this._backgroundColor))&&this._useLayerTexture(e,_,d,P$4[_])||this._composeMapLayers(e,_,d,u,P$4,l,p);}setBackground(e,t){h$U(this._backgroundTexture),this._backgroundIsGrid=t,e instanceof HTMLImageElement?(this._backgroundTexture=this._buildTexture(e),this._backgroundColor=null):(this._backgroundTexture=new t$q(f$10(this._rctx,e)),this._backgroundColor=r$19(e[0]||0,e[1]||0,e[2]||0,e[3]||0));}get backgroundIsGrid(){return this._backgroundIsGrid}get backgroundColor(){return this._backgroundColor}_buildTexture(e,t=9987){if(t$17(e))return null;const r={target:3553,pixelFormat:6408,dataType:5121,wrapMode:33071,samplingMode:t,maxAnisotropy:this._maxAnisotropy,flipped:!0,hasMipmap:!0},a=this._rctx;let i;if("number"==typeof e)r.width=r.height=e,i=new t$q(new r$16(a,r));else if(e instanceof Q$5)r.isOpaque=e.isOpaque,i=new t$q(new r$16(a,r,e.image)),e.release();else try{i=new t$q(new r$16(a,r,e));}catch(n){i=new t$q(u$1b(a)),console.warn("TileRenderer: failed to execute 'texImage2D', cross-origin image may not be loaded.");}const o=a.bindTexture(i.texture,r$16.TEXTURE_UNIT_FOR_UPDATES);return i.generateMipmap(),a.bindTexture(o,r$16.TEXTURE_UNIT_FOR_UPDATES),i}_drawQuad(e){this._rctx.bindVAO(this._vaoQuad),e.assertCompatibleVertexAttributeLocations(this._vaoQuad),this._rctx.drawArrays(5,0,r$15(this._vaoQuad,"geometry"));}_drawRasterData(e,t,r,a,i=1){if(t$17(t))return;const o=this._rctx,n=e.program;o.setPipelineState(e.pipeline),o.useProgram(n),n.bindTexture(t,"tex"),n.setUniform1f("scale",r),n.setUniform2f("offset",a[0],a[1]),n.setUniform1f("opacity",i),this._drawQuad(n);}hasNearestInterpolation(e){const t=e.sourceLayerInfo.data;return !(t$17(t)||!t.source)&&"nearest"===t.interpolation}_drawImageryTileData(e,t=1){const r=e.sourceLayerInfo.data;if(t$17(r)||!r.source)return;e.tile.surface.layerViewByIndex(e.layerIndex,1).ensureSymbolizerParameters(r);const a=this._getRasterColorizerTechnique(r.symbolizerParameters.type,!!r.symbolizerParameters.colormap),i=this._rctx,o=a.program;if(i.setPipelineState(a.pipeline),i.useProgram(o),!r.bind(i))return;r.opacity=t,r.scale=e.scale,r.offset=e.offset;const{names:n,textures:l}=r.getTextures();n.forEach(((e,t)=>o.bindTexture(l[t],e))),a.bindPass(r.getUniforms()),this._drawQuad(o),i.bindVAO();}_getRasterColorizerTechnique(e,t){const r=["stretch","lut","hillshade"].indexOf(e);return this._rasterColorizerConfig||(this._rasterColorizerConfig=new g$6,this._rctx.gl.getExtension("WEBGL_color_buffer_float"),this._rctx.gl.getExtension("OES_texture_float")),this._rasterColorizerConfig.colorizerType=r,this._rasterColorizerConfig.applyColormap=t,this._rasterColorizerTechnique=this._techniqueRep.releaseAndAcquire(f$9,this._rasterColorizerConfig,this._rasterColorizerTechnique),this._rasterColorizerTechnique}_drawVectorData(e,t,r,i,o,n,l){const c=t.sourceLayerInfo.data;if(t$17(c))return l;const u=this._rctx,h=t.tile.surface.layerViewByIndex(t.layerIndex,1);let d;return u.setPipelineState(e.pipeline),i<1?(d=this._fboPool.acquire(o),u.bindFramebuffer(d),u.setClearColor(1,1,1,0),u.clearSafe(16640)):l&&u.clearSafe(256),this._vectorTileHelper.render(u,t.sourceLod,c,h.painter,h.layer.styleRepository,h.schemaHelper,Math.round(1/t.scale),t.offset,this.tileSize,r),!r$Y(d)||(u.bindFramebuffer(n),this._drawRasterData(e,d.colorTexture,1,[0,0],i),this._fboPool.release(d),l)}_useBackgroundTexture(e,t){e.renderData.opacity=e.surface.baseOpacity,e.renderData.compositeBackgroundInShader=!1,e.renderData.layerOpacity=1,e.renderData.baseOpacity=1,e.renderData.setTextureReference(this._backgroundTexture,0,0,1,t);}_useLayerTexture(e,t,r,a){const s=t<r;e.renderData.opacity=s?1:e.surface.baseOpacity,e.renderData.compositeBackgroundInShader=!0,e.renderData.layerOpacity=a,e.renderData.baseOpacity=s?e.surface.baseOpacity:1;const i=q$4(e,t,U$5);if(this._dataToTexture(i)){const t=i.offset;return e.renderData.setTextureReference(i.sourceLayerInfo.data,t[0],t[1],i.scale),!0}return !1}_composeMapLayers(e,t,r,s,i,o,l){const c=this._rctx,h=this._fboPool.acquire(o);c.bindFramebuffer(h),c.setViewport(0,0,o,o),c.setClearColor(0,0,0,0),c.setClearDepth(1),c.clearSafe(16640);let d=!1;!s&&r$Y(this._backgroundTexture)&&this._drawRasterData(this._blendLayersTechnique,this._backgroundTexture.texture,1,f$11);const f=e.surface.baseOpacity;let p=!1,_=9987;for(let u=t;u>=0;u--){const t=q$4(e,u,U$5);t&&(u<r&&f<1&&!p&&(this._drawRasterData(this._applyOpacityTechnique,this._blackTex.texture,1,f$11,f),p=!0),0!==i[u]&&(S$9(t)?d=this._drawVectorData(this._blendLayersTechnique,t,l,i[u],o,h,d):L$8(t)?(this._drawImageryTileData(t,i[u]),this.hasNearestInterpolation(t)&&(_=9728)):this._dataToTexture(t)&&r$Y(t.sourceLayerInfo.data)&&this._drawRasterData(this._blendLayersTechnique,t.sourceLayerInfo.data.texture,t.scale,t.offset,i[u])));}const m=e.renderData.ensureTexture(o,(()=>this._buildTexture(o,_))),T=c.bindTexture(m.texture,r$16.TEXTURE_UNIT_FOR_UPDATES),y=m.descriptor;c.gl.copyTexImage2D(c.gl.TEXTURE_2D,0,y.pixelFormat,0,0,y.width,y.height,0),m.generateMipmap(),c.bindTexture(T,r$16.TEXTURE_UNIT_FOR_UPDATES),c.bindFramebuffer(null),this._fboPool.release(h),e.renderData.opacity=p?1:f,e.renderData.compositeBackgroundInShader=!1,e.renderData.layerOpacity=1,e.renderData.baseOpacity=1,e.renderData.setTextureReference(m,0,0,1);}_dataToTexture(e){return j$9(e)&&this._rasterDataToTexture(e),M$9(e)}_rasterDataToTexture(e){const t=e.sourceLayerInfo;t.data=this._buildTexture(t.data),e.tile.setMemoryDirty();}_cleanupFBOPool(e,t){e===this._lastPixelRatio&&t===this._lastNumLayers||(this._fboPool.clear(),this._lastPixelRatio=e,this._lastNumLayers=t);}get test(){return {backgroundTexture:this._backgroundTexture}}}function j$5(t){const r=i$_(t),a=r*r,s=t*t;if(a===s)return t;const i=r/2;return a-s<s-i*i?r:i}function q$4(e,t,r){r.layerIndex=t;const a=e.layerInfo[1][t];if(a.data)return r$18(r.offset,0,0),r.tile=e,r.scale=1,r.sourceLod=e.lij,r.sourceLayerInfo=a,r;const s=a.upsampleInfo;if(s){const e=s.tile.layerInfo[1][t];return r.tile=s.tile,a$13(r.offset,s.offset),r.scale=s.scale,r.sourceLod=s.tile.lij,r.sourceLayerInfo=e,r}return null}const P$4=new Array,U$5={tile:null,sourceLayerInfo:null,sourceLod:null,offset:[0,0],scale:1,layerIndex:0};

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
function e$c(e,t){e.varyings.add("tbnTangent","vec3"),e.varyings.add("tbnBiTangent","vec3"),1===t.viewingMode?e.vertex.code.add(t$10`void forwardVertexTangent(vec3 n) {
tbnTangent = normalize(cross(vec3(0.0, 0.0, 1.0), n));
tbnBiTangent = normalize(cross(n, tbnTangent));
}`):e.vertex.code.add(t$10`void forwardVertexTangent(vec3 n) {
tbnTangent = vec3(1.0, 0.0, 0.0);
tbnBiTangent = normalize(cross(n, tbnTangent));
}`),e.fragment.code.add(t$10`mat3 getTBNMatrix(vec3 n) {
return mat3(tbnTangent, tbnBiTangent, n);
}`);}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
function a$c(a,t){a.extensions.add("GL_OES_standard_derivatives"),3!==t.pbrMode&&4!==t.pbrMode||a.include(a$v,t),a.vertex.uniforms.add("overlayTexOffset","vec4"),a.vertex.uniforms.add("overlayTexScale","vec4"),a.varyings.add("vtcOverlay","vec4"),a.vertex.code.add(t$10`void setOverlayVTC(in vec2 uv) {
vtcOverlay = vec4(uv, uv) * overlayTexScale + overlayTexOffset;
}`),a.fragment.uniforms.add("ovColorTex","sampler2D"),a.fragment.uniforms.add("overlayOpacity","float"),a.fragment.code.add(t$10`bool isValid(vec2 uv, vec2 dxdy) {
return (uv.x >= 0.0 + dxdy.x) && (uv.x <= 1.0 - dxdy.x) && (uv.y >= 0.0 + dxdy.y) && (uv.y <= 1.0 - dxdy.y);
}
vec4 getOverlayColor(sampler2D ov0Tex, vec4 texCoords) {
vec4 color0 = texture2D(ov0Tex, vec2(texCoords.x * 0.5, texCoords.y));
vec4 color1 = texture2D(ov0Tex, vec2(texCoords.z * 0.5 + 0.5, texCoords.w));
bool isValid0 = isValid(texCoords.xy, fwidth(texCoords.xy));
bool isValid1 = isValid(texCoords.zw, vec2(0.0, 0.0));
return mix(color1 * float(isValid1), color0, float(isValid0));
}`),a.fragment.code.add(t$10`vec4 getCombinedOverlayColor() {
return overlayOpacity * getOverlayColor(ovColorTex, vtcOverlay);
}`),3!==t.pbrMode&&4!==t.pbrMode||(a.include(n$1u),a.fragment.code.add(t$10`vec4 getOverlayWaterColor(vec4 maskInput, vec4 colorInput, vec3 vposEyeDir,
float shadow, vec3 localUp, mat3 tbn, vec3 position) {
vec3 n = normalize(tbn *  (2.0 * maskInput.rgb - vec3(1.0)));
vec3 v = vposEyeDir;
vec3 final = getSeaColor(n, v, lightingMainDirection, colorInput.rgb, lightingMainIntensity, localUp, 1.0 - shadow, maskInput.w, position);
return vec4(final, colorInput.w);
}`));}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
function v$6(v){v.vertex.code.add(t$10`vec3 applySkirts(inout vec2 uv, vec3 vpos, vec3 vnormal, float skirtScale) {
float skirtLength = 0.0;
if (uv.x >= 2.0) {
skirtLength = uv.y * skirtScale;
vec2 x = vec2(uv.x) - vec2(3.5, 4.5);
uv = clamp(vec2(1.5) - abs(x), vec2(0.0), vec2(1.0));
}
return vpos - vnormal * skirtLength;
}`);}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
function t$i(t,o){t.varyings.add("vtc","vec2"),t.vertex.uniforms.add("texOffsetAndScale","vec4"),t.fragment.uniforms.add("tex","sampler2D"),t.fragment.uniforms.add("compositeBackground","bool"),t.fragment.uniforms.add("textureOpacity","float"),t.fragment.uniforms.add("baseOpacity","float"),o.textureFadingEnabled&&(t.vertex.uniforms.add("nextTexOffsetAndScale","vec4"),t.varyings.add("nvtc","vec2"),t.fragment.uniforms.add("texNext","sampler2D"),t.fragment.uniforms.add("textureFadeFactor","float")),t.vertex.code.add(t$10`
  void forwardTextureCoordinates(in vec2 uv) {
    vtc = uv * texOffsetAndScale.zw + texOffsetAndScale.xy;
    ${o.textureFadingEnabled?t$10`nvtc = uv * nextTexOffsetAndScale.zw + nextTexOffsetAndScale.xy;`:t$10``}
  }
  `),o.useGrid?(t.fragment.code.add(t$10`float lineFactorAtPosition(float value) {
float pos = value * 129.0;
if(pos < 0.5 || pos > 128.5) {
return 1.0;
}
pos = pos + 0.5;
float modulo = mod(pos, 16.0);
return modulo <= 2.0 ?  1.0 - abs(modulo - 1.0) : 0.0;
}
float lineFactorAtUV(vec2 uv) {
return max(lineFactorAtPosition(uv.x), lineFactorAtPosition(uv.y));
}
float lineFactor(vec2 uv) {
vec2 offset = fwidth(uv) * 0.25;
return (lineFactorAtUV(vec2(uv.x + offset.x, uv.y + offset.y)) +
lineFactorAtUV(vec2(uv.x - offset.x, uv.y + offset.y)) +
lineFactorAtUV(vec2(uv.x + offset.x, uv.y - offset.y)) +
lineFactorAtUV(vec2(uv.x - offset.x, uv.y - offset.y))) / 4.0;
}`),t.fragment.code.add(t$10`
    vec4 getTileColor() {
      vec4 color = ${o.textureFadingEnabled?t$10`textureFadeFactor < 1.0 ? mix(texture2D(texNext, nvtc), texture2D(tex, vtc), textureFadeFactor) : texture2D(tex, vtc);`:t$10`texture2D(tex, vtc);`};
      if(!compositeBackground) {
        return color;
      }

      float line = lineFactor(vtc) * 0.1 + 0.9;
      vec4 gridColor = vec4(1.0, 0.972, 0.918, 1.0) * line * baseOpacity;
      float alpha = textureOpacity * color.a;
      return mix(gridColor, color, alpha);
    }`)):o.hasBackgroundColor?(t.fragment.uniforms.add("backgroundColor","vec4"),t.fragment.code.add(t$10`
    vec4 getTileColor() {
      vec4 color = ${o.textureFadingEnabled?t$10`textureFadeFactor < 1.0 ? mix(texture2D(texNext, nvtc), texture2D(tex, vtc), textureFadeFactor) : texture2D(tex, vtc);`:t$10`texture2D(tex, vtc);`};
      float alpha = textureOpacity * color.a;
      return compositeBackground ? mix(backgroundColor * baseOpacity, color, alpha) : color;
    }`)):t.fragment.code.add(t$10`
    vec4 getTileColor() {
      return ${o.textureFadingEnabled?t$10`textureFadeFactor < 1.0 ? mix(texture2D(texNext, nvtc), texture2D(tex, vtc), textureFadeFactor) : texture2D(tex, vtc);`:t$10`texture2D(tex, vtc);`}
  }
  `);}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
function g$5(g){const p=new n$15;if(p.include(u$1c,{name:"Terrain Shader",output:g.output}),p.include(v$6),p.attributes.add("position","vec3"),p.attributes.add("uv0","vec2"),p.vertex.uniforms.add("proj","mat4").add("view","mat4").add("origin","vec3").add("skirtScale","float"),0===g.output){p.include(r$11,{linearDepth:!1}),p.include(n$F,g),p.include(t$i,g);const a=0!==g.overlayMode,i=2===g.overlayMode;a&&p.include(a$c,{pbrMode:3,useCustomDTRExponentForWater:!1,ssrEnabled:g.ssrEnabled,highStepCount:g.highStepCount}),i&&p.include(e$c,g),p.varyings.add("vnormal","vec3"),p.varyings.add("vpos","vec3"),p.vertex.uniforms.add("viewNormal","mat4"),g.receiveShadows&&p.varyings.add("linearDepth","float"),g.tileBorders&&p.varyings.add("vuv","vec2"),g.atmosphere&&(p.vertex.uniforms.add("lightingMainDirection","vec3"),p.varyings.add("wnormal","vec3"),p.varyings.add("wlight","vec3")),g.screenSizePerspective&&(p.vertex.uniforms.add("screenSizePerspective","vec4"),p.varyings.add("screenSizeDistanceToCamera","float"),p.varyings.add("screenSizeCosAngle","float")),p.vertex.code.add(t$10`
      void main(void) {
        vpos = position;
        vnormal = getLocalUp(vpos, origin);

        vec2 uv = uv0;
        vpos = applySkirts(uv, vpos, vnormal, skirtScale);
        ${g.atmosphere?t$10`
        wnormal = (viewNormal * vec4(normalize(vpos + origin), 1.0)).xyz;
        wlight = (view  * vec4(lightingMainDirection, 1.0)).xyz;`:""}
        ${g.tileBorders?t$10`vuv = uv;`:""}
        ${g.screenSizePerspective?t$10`
        vec3 viewPos = (view * vec4(vpos, 1.0)).xyz;
        screenSizeDistanceToCamera = length(viewPos);
        vec3 viewSpaceNormal = (viewNormal * vec4(normalize(vpos + origin), 1.0)).xyz;
        screenSizeCosAngle = abs(viewSpaceNormal.z);`:""}
        gl_Position = transformPosition(proj, view, vpos);
        ${g.receiveShadows?t$10`linearDepth = gl_Position.w;`:""}
        forwardTextureCoordinates(uv);
        ${a?t$10`setOverlayVTC(uv);`:""}
        ${i?t$10`forwardVertexTangent(vnormal);`:t$10``}
      }
    `),p.extensions.add("GL_OES_standard_derivatives"),p.extensions.add("GL_EXT_shader_texture_lod"),p.include(c$$,g),p.include(l$1b,g),p.fragment.uniforms.add("camPos","vec3").add("viewDirection","vec3").add("ssaoTex","sampler2D").add("viewportPixelSz","vec4").add("opacity","float"),g.screenSizePerspective&&p.fragment.uniforms.add("screenSizePerspective","vec4"),i&&(p.fragment.uniforms.add("ovWaterTex","sampler2D"),p.fragment.uniforms.add("view","mat4")),p.fragment.code.add(t$10`const vec3 ambient = vec3(0.2, 0.2, 0.2);
const vec3 diffuse = vec3(0.8, 0.8, 0.8);
const float diffuseHardness = 2.5;
const float sliceOpacity = 0.2;
float lum(vec3 c) {
float max = max(max(c.r, c.g), c.b);
float min = min(min(c.r, c.g), c.b);
return (min + max) * 0.5;
}`),g.atmosphere&&p.fragment.code.add(t$10`vec3 atmosphere(vec3 lightPos, vec3 normal, vec3 view) {
vec3 surfaceColor   = vec3(0.0);
vec3 fuzzySpecColor = vec3(1.0);
vec3 subColor       = vec3(0.0);
float rollOff       = 1.0;
vec3 Ln = normalize(lightPos);
vec3 Nn = normalize(normal);
vec3 Hn = normalize(view + Ln);
float ldn = dot(Ln, Nn);
float diffComp = max(0.0, ldn);
float vdn = clamp(1.0 - dot(view, Nn), 0.0, 1.0);
float ndv = dot(view, Ln);
vec3 diffContrib = surfaceColor * diffComp;
float subLamb = max(0.0, smoothstep(-rollOff, 1.0, ldn) - smoothstep(0.0, 1.0, ldn));
vec3 subContrib = subLamb * subColor;
vec3 vecColor = vec3(vdn);
vec3 diffuseContrib = (subContrib + diffContrib);
vec3 specularContrib = (vecColor * fuzzySpecColor);
return (diffContrib + specularContrib) * rollOff;
}`),p.fragment.code.add(t$10`
      void main() {
        ${g.receiveShadows?t$10`float shadow = readShadowMap(vpos, linearDepth);`:t$10`float shadow = 0.0;`}
        float vndl = dot(normalize(vnormal), lightingMainDirection);
        float k = smoothstep(0.0, 1.0, clamp(vndl*diffuseHardness, 0.0, 1.0));
        vec3 d = (1.0 - shadow/1.8) * diffuse * k;

        float ssao = viewportPixelSz.w < .0 ? 1.0 : texture2D(ssaoTex, (gl_FragCoord.xy - viewportPixelSz.xy) * viewportPixelSz.zw).a;
        vec4 tileColor = getTileColor() * opacity;
        ${a?t$10`
            vec4 overlayColorOpaque = getOverlayColor(ovColorTex, vtcOverlay);
            vec4 overlayColor = overlayOpacity * overlayColorOpaque;
            vec4 groundColor = tileColor;
            tileColor = tileColor * (1.0 - overlayColor.a) + overlayColor;`:""}
        if (rejectBySlice(vpos)) {
          tileColor *= sliceOpacity;
        }
        vec3 atm = vec3(0.0);
        ${g.atmosphere?t$10`
            float ndotl = max(0.0, min(1.0, vndl));
            atm = atmosphere(wlight, wnormal, -viewDirection);
            atm *= max(0.0, min(1.0, (1.0-lum(tileColor.rgb)*1.5))); //avoid atmosphere on bright base maps
            atm *= max(0.0, min(1.0, ndotl*2.0)); // avoid atmosphere on dark side of the globe
            atm *= tileColor.a; // premultiply with tile alpha`:""}
        vec3 albedo = atm + tileColor.rgb;
        vec3 normal = normalize(vnormal);

        // heuristic shading function used in the old terrain, now used to add ambient lighting
        float additionalAmbientScale = smoothstep(0.0, 1.0, clamp(vndl*2.5, 0.0, 1.0));
        vec3 additionalLight = ssao * lightingMainIntensity * additionalAmbientScale * ambientBoostFactor * lightingGlobalFactor;

        gl_FragColor = vec4(evaluateSceneLighting(normal, albedo, shadow, 1.0 - ssao, additionalLight), tileColor.a);
        ${i?t$10`
            vec4 overlayWaterMask = getOverlayColor(ovWaterTex, vtcOverlay);
            float waterNormalLength = length(overlayWaterMask);
            if (waterNormalLength > 0.95) {
              mat3 tbnMatrix = mat3(tbnTangent, tbnBiTangent, vnormal);
              vec4 waterOverlayColor = vec4(overlayColor.w > 0.0 ? overlayColorOpaque.xyz/overlayColor.w : vec3(1.0), overlayColor.w);
              vec4 viewPosition = view*vec4(vpos, 1.0);
              vec4 waterColorLinear = getOverlayWaterColor(overlayWaterMask, waterOverlayColor, -normalize(vpos - camPos), shadow, vnormal, tbnMatrix, viewPosition.xyz);
              vec4 waterColorNonLinear = delinearizeGamma(vec4(waterColorLinear.xyz, 1.0));
              // un-gamma the ground color to mix in linear space
              gl_FragColor = mix(groundColor, waterColorNonLinear, waterColorLinear.w);
            }`:""}
        ${g.screenSizePerspective?t$10`
          float perspectiveScale = screenSizePerspectiveScaleFloat(1.0, screenSizeCosAngle, screenSizeDistanceToCamera, screenSizePerspective);
          if (perspectiveScale <= 0.25) {
            gl_FragColor = mix(gl_FragColor, vec4(1.0, 0.0, 0.0, 1.0), perspectiveScale * 4.0);
          }
          else if (perspectiveScale <= 0.5) {
            gl_FragColor = mix(gl_FragColor, vec4(0.0, 0.0, 1.0, 1.0), (perspectiveScale - 0.25) * 4.0);
          }
          else if (perspectiveScale >= 0.99) {
            gl_FragColor = mix(gl_FragColor, vec4(0.0, 1.0, 0.0, 1.0), 0.2);
          }
          else {
            gl_FragColor = mix(gl_FragColor, vec4(1.0, 0.0, 1.0, 1.0), (perspectiveScale - 0.5) * 2.0);
          }`:""}
        ${g.tileBorders?t$10`
            vec2 dVuv = fwidth(vuv);
            vec2 edgeFactors = smoothstep(vec2(0.0), 1.5 * dVuv, min(vuv, 1.0 - vuv));
            float edgeFactor = 1.0 - min(edgeFactors.x, edgeFactors.y);
            gl_FragColor = mix(gl_FragColor, vec4(1.0, 0.0, 0.0, 1.0), edgeFactor);`:""}
        gl_FragColor = highlightSlice(gl_FragColor, vpos);
      }
    `);}return 1!==g.output&&3!==g.output||(p.include(r$11,{linearDepth:!0}),p.include(e$14,{output:g.output}),p.include(n$F,g),p.varyings.add("linearDepth","float"),p.vertex.uniforms.add("nearFar","vec2"),p.vertex.code.add(t$10`void main(void) {
vec3 normal = getLocalUp(position, origin);
vec2 uv = uv0;
vec3 vpos = applySkirts(uv, position, normal.xyz, skirtScale);
gl_Position = transformPositionWithDepth(proj, view, vpos, nearFar, linearDepth);
}`),p.fragment.code.add(t$10`void main() {
outputDepth(linearDepth);
}`)),2===g.output&&(p.include(r$11,{linearDepth:!1}),p.include(n$F,g),p.varyings.add("vnormal","vec3"),p.varyings.add("vpos","vec3"),p.vertex.uniforms.add("viewNormal","mat4"),p.vertex.code.add(t$10`void main(void) {
vec3 normal = getLocalUp(position, origin);
vec2 uv = uv0;
vpos = applySkirts(uv, position, normal, skirtScale);
gl_Position = transformPosition(proj, view, vpos);
vnormal = normalize((viewNormal * vec4(normal, 1.0)).xyz);
}`),p.fragment.code.add(t$10`void main() {
vec3 normal = normalize(vnormal);
if (gl_FrontFacing == false) {
normal = -normal;
}
gl_FragColor = vec4(vec3(0.5) + 0.5 * normal, 0.0);
}`)),4===g.output&&(p.include(r$11,{linearDepth:!1}),p.include(n$F,g),p.include(a$c,{pbrMode:0}),p.vertex.code.add(t$10`void main() {
vec3 vnormal = getLocalUp(position, origin);
vec2 uv = uv0;
vec3 vpos = applySkirts(uv, position, vnormal, skirtScale);
setOverlayVTC(uv);
gl_Position = transformPosition(proj, view, vpos);
}`),p.include(r$1g),p.fragment.code.add(t$10`void main() {
vec4 overlayColor = getCombinedOverlayColor();
if (overlayColor.a == 0.0) {
gl_FragColor = vec4(0.0);
return;
}
outputHighlight();
}`)),p}var p$9=Object.freeze({__proto__:null,build:g$5});

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class b$6 extends t$11{initializeProgram(e){const r=b$6.shader.get(),o=this.configuration,t=r.build({overlayMode:o.overlayMode,output:o.output,viewingMode:e.viewingMode,slicePlaneEnabled:o.slicePlaneEnabled,sliceHighlightDisabled:!1,sliceEnabledForVertexPrograms:!1,textureFadingEnabled:o.textureFadingEnabled&&!o.renderOccluded,hasBackgroundColor:o.hasBackgroundColor,useGrid:o.useGrid,receiveShadows:o.receiveShadows&&!o.renderOccluded,receiveAmbientOcclusion:!1,atmosphere:o.atmosphere,tileBorders:o.tileBorders,screenSizePerspective:o.screenSizePerspective,pbrMode:0,ssrEnabled:o.ssrEnabled,highStepCount:!1});return new n$16(e.rctx,t,o$X)}initializePipeline(){const e=this.configuration,r=e.backfaceCullingEnabled&&!e.renderOccluded;return g$S({blending:e.renderOccluded?t$1e(1,771):null,culling:r&&i$Q,depthTest:!e.renderOccluded&&{func:513},depthWrite:!e.renderOccluded&&l$$,colorWrite:r$13,stencilTest:e.stencilEnabled?s$1d(1):null})}}b$6.shader=new t$12(p$9,(()=>import('./Terrain.glsl-bb9cf800.js')));class v$5 extends e$S{constructor(){super(...arguments),this.output=0,this.overlayMode=0,this.atmosphere=!1,this.receiveShadows=!1,this.slicePlaneEnabled=!1,this.backfaceCullingEnabled=!1,this.stencilEnabled=!1,this.textureFadingEnabled=!1,this.hasBackgroundColor=!1,this.useGrid=!1,this.renderOccluded=!1,this.ssrEnabled=!1,this.tileBorders=!1,this.screenSizePerspective=!1;}}e$Q([r$12({count:8})],v$5.prototype,"output",void 0),e$Q([r$12({count:3})],v$5.prototype,"overlayMode",void 0),e$Q([r$12()],v$5.prototype,"atmosphere",void 0),e$Q([r$12()],v$5.prototype,"receiveShadows",void 0),e$Q([r$12()],v$5.prototype,"slicePlaneEnabled",void 0),e$Q([r$12()],v$5.prototype,"backfaceCullingEnabled",void 0),e$Q([r$12()],v$5.prototype,"stencilEnabled",void 0),e$Q([r$12()],v$5.prototype,"textureFadingEnabled",void 0),e$Q([r$12()],v$5.prototype,"hasBackgroundColor",void 0),e$Q([r$12()],v$5.prototype,"useGrid",void 0),e$Q([r$12()],v$5.prototype,"renderOccluded",void 0),e$Q([r$12()],v$5.prototype,"ssrEnabled",void 0),e$Q([r$12()],v$5.prototype,"tileBorders",void 0),e$Q([r$12()],v$5.prototype,"screenSizePerspective",void 0);

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
const $$3=7,ee$1=10,te$1=a$1c(),ie=n$1a();class re$1{constructor(){this.extent=n$1a(),this.minLevel=0,this.maxLevel=0,this.callback=null;}}let se=class extends p$14{constructor(e){super(e),this.type="Terrain",this.isGround=!0,this.tileSize=256,this.rctx=null,this._isTransparent=!1,this.renderDataPool=new e$X(g$8),this._patchGroups=new n$1h({allocator:e=>e||{root:null,origin:null,patches:new n$1h},deallocator:e=>(e.root=null,e.origin=null,e.patches.clear(),e)}),this.patchGroupsDirty=!0,this.patchGroupsMap=new Map,this.tileIterator=new r$h,this.highestVisibleLODTile=null,this.visible=!0,this._opaque=!0,this._skirtScale=1,this._velvetOverground=!0,this.castShadows=!0,this._ssrEnabled=!1,this.emptyTex=null,this.tileRenderer=null,this.tileBackgroundInitialized=!1,this.tileBackgroundUpdating=!1,this.stencilEnabledLayerExtents=[],this.numTrianglesRendered=0,this.numTilesRendered=0,this.numTilesCulled=0,this.numOriginsRendered=0,this.clippingExtent=null,this.overlayOpacity=1,this.needsHighlight=!1,this.renderOccludedFlags=1,this.visibleScaleRangeQueries=new n$1h({initialSize:10}),this.visibleScaleRangeQueriesInvPtr=0,this.visibleScaleRangeQueryQueue=new n$1h({initialSize:30}),this.visibleScaleRangeQueryPool=new e$X(re$1);}get isGlobal(){return 1===this.stage.viewingMode}initialize(){const e=[2,7,9];this.stage.addRenderPlugin(e,this);}destroy(){this.stage.removeRenderPlugin(this),y$6();}get updating(){return !this.tileBackgroundInitialized||this.tileBackgroundUpdating}get canRender(){return this.visible&&!!this.rootTiles&&this.tileBackgroundInitialized&&!this.renderingDisabled}set renderingDisabled(e){this._set("renderingDisabled",!!e),this.setNeedsRender();}set opaque(e){this._opaque!==e&&(this._opaque=e,this.setNeedsRender());}get needsLinearDepth(){return this.overlayRenderer.hasWater}get opaque(){return this._opaque&&!this.shaderTechniqueConfig.slicePlaneEnabled}set isTransparent(e){this._isTransparent!==e&&(this._isTransparent=e,this.setNeedsRender());}get isTransparent(){return this._isTransparent}set skirtScale(e){e!==this._skirtScale&&(this._skirtScale=e,this.setNeedsRender());}get skirtScale(){return this._skirtScale}get renderPatchBorders(){return !!this.shaderTechniqueConfig.tileBorders}set renderPatchBorders(e){this.shaderTechniqueConfig.tileBorders!==e&&(this.shaderTechniqueConfig.tileBorders=e,this.setNeedsRender(),this.notifyChange("renderPatchBorders"));}get cullBackFaces(){return this.shaderTechniqueConfig.backfaceCullingEnabled}set cullBackFaces(e){this.shaderTechniqueConfig.backfaceCullingEnabled!==e&&(this.shaderTechniqueConfig.backfaceCullingEnabled=e,this.notifyChange("cullBackFaces"),this.setNeedsRender());}set renderOrder(e){this._set("renderOrder",e),this.setNeedsRender();}set velvetOverground(e){this._velvetOverground!==e&&(this._velvetOverground=e,this.setNeedsRender());}get intersectionHandlerId(){return O$B}get slicePlane(){return this.shaderTechniqueConfig.slicePlaneEnabled}set slicePlane(e){this.shaderTechniqueConfig.slicePlaneEnabled!==e&&(this.shaderTechniqueConfig.slicePlaneEnabled=e,this.setNeedsRender());}set textureFadingEnabled(e){this.shaderTechniqueConfig.textureFadingEnabled!==e&&(this.shaderTechniqueConfig.textureFadingEnabled=e,this.setNeedsRender());}setDebugScreenSizePerspective(e){this.shaderTechniqueConfig.screenSizePerspective!==e&&(this.shaderTechniqueConfig.screenSizePerspective=e,this.setNeedsRender());}setRootTiles(e){this.rootTiles=e,this.setNeedsRender();}setNeedsHighlight(e){this.needsHighlight=e,this.setNeedsRender();}setRenderOccludedOverlay(e){this.renderOccludedFlags=e?ee$6:1,this.setNeedsRender();}setStencilEnabledLayerExtents(e){this.stencilEnabledLayerExtents=e,this.setNeedsRender();}setTileSize(e){this.tileSize=e,this.tileRenderer&&(this.tileRenderer.tileSize=e),this.setNeedsRender();}loadTile(e){e.renderData||(e.renderData=this.renderDataPool.acquire(),e.renderData.init(e),e.renderData.localOrigin=this._getLocalOriginOfTile(e)),this.updateTileGeometry(e),this.updateTileTexture(e);}queryVisibleLevelRange(e,t,i,r){const s=this.visibleScaleRangeQueryPool.acquire();a$12(s.extent,e),s.minLevel=t||-Number.MAX_VALUE,s.maxLevel=null!=i?i:Number.MAX_VALUE,s.callback=r,this.visibleScaleRangeQueryQueue.push(s),this.setNeedsRender();}updateTileTexture(e){this.tileRenderer&&this.tileBackgroundInitialized&&(this.tileRenderer.updateTileTexture(e),this.setNeedsRender(),e.resetPendingUpdate(64));}updateTileGeometry(e){for(const t of e.layerInfo[0])t.pendingUpdates&=-33;e.resetPendingUpdate(32),e.renderData.updateGeometry(this.rctx,this.wireframe)&&this.setNeedsRender();}unloadTile(e){e.renderData&&(e.renderData.releaseGeometry()&&this.setNeedsRender(),this.renderDataPool.release(e.renderData),e.renderData.clear(),e.renderData=null,e.setMemoryDirty(),this.setNeedsRender());}_getLocalOriginOfTile(e){const t=ee$1-$$3,i=Math.max(0,Math.floor((e.lij[0]-t)/$$3)*$$3);if(this.isGlobal&&0===i)return f$R;for(;e.parent&&e.lij[0]>i;)e=e.parent;return e.centerAtSeaLevel}setVisibility(e){this.visible=e,this.setNeedsRender();}getStats(){return {numTilesRendered:this.numTilesRendered,numTilesCulled:this.numTilesCulled,numTrianglesRendered:this.numTrianglesRendered,numOriginsRendered:this.numOriginsRendered}}set wireframe(e){this._get("wireframe")!==e&&(this._set("wireframe",e),this.allTiles.forAll((t=>{var i;return null==(i=t.renderData)?void 0:i.updateGeometry(this.rctx,e)})),this.setNeedsRender());}setNeedsRender(e=1){this.patchGroupsDirty=!0,this.context.requestRender(e);}setTileBackground(e){this.tileBackground=e,this._updateTileBackground();}initializeRenderContext(e){this.context=e,this.rctx=e.renderContext.rctx,this.shaderTechniques=e.shaderTechniqueRep,this.shaderTechniqueConfig=new v$5,this.tileRenderer=new R$5(this.rctx,this.tileSize,this.shaderTechniques),this.tileBackground&&this._updateTileBackground(),this.emptyTex=u$1b(this.rctx);}uninitializeRenderContext(){null!=this.emptyTex&&(this.emptyTex.dispose(),this.emptyTex=null),this.tileRenderer&&(this.tileRenderer.dispose(),this.tileRenderer=null);}intersect(e,t,i,n){if(!this.rootTiles||e.options.selectOpaqueTerrainOnly&&e.options.selectionMode&&!this._opaque)return;const a=de,o=ce;c$V(a,n,i),o$S(o,1/a[0],1/a[1],1/a[2]);const l=e.results.min,h=e.results.max,d=e.results.ground,T=0===e.options.store,b=!!e.results.ground.target;let y;const x=V$r(e.verticalOffset),R=this.clippingExtent;this.allTiles.forAll((S=>{if(null===S.renderData||b&&this._useStencilForTile(S))return;if(e.options.invisibleTerrain){if(!S.visible&&R&&!S.intersectsExtent(R))return}else if(!S.visible)return;const O=S.renderData.geometryInfo;A$x(te$1,O.boundingBox);const _=S.renderData.localOrigin;r$Y(x)&&(x.localOrigin=_,x.applyToAabb(te$1));const C=-this._skirtScale*O.skirtLength;if(0!==C){const e=S.up;x$X(te$1,C*e[0],C*e[1],C*e[2]);}const D=te$1;c$V(ue,i,_);const w=T&&null!=l.dist?l.dist:1/0;if(!L$x(D,ue,o,e.tolerance,w))return;const U=(e,t,i,r)=>{e.set(void 0,i$9(t),i,r,a$10,void 0),e.intersector=ge,e.target={type:"external",metadata:{tile:t}};},j=(r,o)=>{if(r>=0&&(e.options.backfacesTerrain||z$u(o,a)<0)&&(e.options.invisibleTerrain||!e.options.selectionMode||null==t||t(i,n,r))){if((null==d.dist||r<d.dist)&&U(d,S,r,o),e.options.isFiltered)return;2===e.options.store&&(t$17(y)?(y=new j$y(e.ray),U(y,S,r,o),e.results.all.push(y)):r<y.dist&&U(y,S,r,o)),(null==l.dist||r<l.dist)&&U(l,S,r,o),0!==e.options.store&&(null==h.dist||r>h.dist)&&U(h,S,r,o);}},E=pe;c$V(E,n,_);const A=O.indices,M=O.vertexAttributes,N={data:M.getField("position",i$14).typedBuffer,size:3,stride:M.stride/4},I=O.numWithoutSkirtIndices/3;if(M$A(ue,E,0,I,A,N,null,x,j),0!==C){const e=this.isGlobal?e=>d$O(e,e,C/s$P(u$S(e,e,_))):e=>o$S(e,0,0,C),t=A.length/3;j$6(ue,E,I,t,A,M,e,x,j);}}));}prepareRender(){this.overlayOpacity<1&&this.updateOverlayOpacity();}render(e){if(9===e.slot){if(0==(e.renderOccludedMask&ee$6))return !1}else {const t=this.opaque?2:7;if(e.slot!==t)return !1}const t=e.pass,i=1===e.scenelightingData.globalFactor,r=this._updatePatchGroups();switch(t){case 0:{const t=e.shadowMap&&e.shadowMap.enabled;this.shaderTechniqueConfig.receiveShadows!==t&&(this.shaderTechniqueConfig.receiveShadows=t);const i=this.overlayRenderer.isEmpty()?0:this.overlayRenderer.hasWater?2:1;this.shaderTechniqueConfig.overlayMode!==i&&(this.shaderTechniqueConfig.overlayMode=i);const s=9===e.slot?3:1;this._renderMaterialPass(e,0,r,s);break}case 4:case 6:this.castShadows&&i&&this._renderAuxiliaryPass(e,3,r,0);break;case 2:this.isTransparent&&this.overlayRenderer.isEmpty()||this._renderAuxiliaryPass(e,1,r,0);break;case 3:this._renderAuxiliaryPass(e,2,r,0);break;case 5:this.needsHighlight&&(this._renderAuxiliaryPass(e,4,r,2),e.rctx.clearSafe(256));}return 0!==this.visibleScaleRangeQueryQueue.length&&this.setNeedsRender(),!0}_renderMaterialPass(e,t,i,r){const{rctx:s,camera:n}=e;this._ssrEnabled=e.ssrParams.ssrEnabled,this._setTerrainTechnique(t,3===r);const a=this.shaderTechnique.program;s.useProgram(a),0!==this.shaderTechniqueConfig.overlayMode&&1===r&&e.ssrParams&&i$n(a,e.ssrParams),e.shadowMap.bind(a),e.ssaoHelper.bind(a),this._bindOverlayData(a,r),a.setUniformMatrix4fv("viewNormal",n.viewInverseTransposeMatrix),t$15(a,n.projectionMatrix),e.scenelightingData.setUniforms(a,!0);const o=n.viewMatrix;o$S(he,o[12],o[13],o[14]),j$F(he,he),a.setUniform3fv("viewDirection",he),this.numTilesRendered=0,this.numTilesCulled=0,this.numTrianglesRendered=0,this.numOriginsRendered=0,this._prepareScaleRangeQueries(),this.opaque?this._renderPatchGroups(e,a,i,r):e.offscreenRenderingHelper.renderToTargets((()=>this._renderPatchGroups(e,a,i,r)),e.offscreenRenderingHelper.tmpColor,e.offscreenRenderingHelper.mainDepth,[0,0,0,0]),this._processScaleRangeQueries();}_renderAuxiliaryPass(e,t,i,r){this._setTerrainTechnique(t,3===r);const s=e.rctx,n=this.shaderTechnique.program;if(s.useProgram(n),5===e.pass){const t=e.offscreenRenderingHelper;n.bindTexture(t.depthTexture,"depthTex"),n.setUniform4f("highlightViewportPixelSz",0,0,1/t.width,1/t.height);}else n.setUniformMatrix4fv("viewNormal",e.camera.viewInverseTransposeMatrix),2!==e.pass&&4!==e.pass&&6!==e.pass||n.setUniform2fv("nearFar",e.camera.nearFar);this._renderPatchGroupsAuxiliary(e,n,i,r);}_updateTileBackground(){if(!this.tileRenderer)return;this.tileBackgroundUpdating=!0;const e=()=>{this.tileBackgroundInitialized=!0,this.tileBackgroundUpdating=!1,this.shaderTechniqueConfig.useGrid=this.tileRenderer.backgroundIsGrid,this.shaderTechniqueConfig.hasBackgroundColor=!this.tileRenderer.backgroundIsGrid&&!!r$Y(this.tileRenderer.backgroundColor),this.allTiles.forAll((e=>this.tileRenderer.updateTileTexture(e))),this.setNeedsRender();};if("string"==typeof this.tileBackground){const t=this.tileBackground;t$14(t).then((i=>{t===this.tileBackground&&this.tileRenderer&&(this.tileRenderer.setBackground(i,this.tileBackground===H$k),e());}));}else {const i=this.tileBackground?o$W.toUnitRGBA(this.tileBackground):[0,0,0,0];this.tileRenderer.setBackground(i,!1),e();}}_updatePatchGroups(){const e=this._patchGroups;if(!this.patchGroupsDirty)return e;if(this.highestVisibleLODTile=null,this._renderCollectOrigins(e),0!==this.renderOrder){for(let t=0;t<e.length;t++)a$d(this.renderOrder,e.data[t].patches);e.sort(((e,t)=>ae(e,t,this.renderOrder)));}return this.patchGroupsDirty=!1,e}_renderCollectOrigins(e){const t=this.rootTiles,i=this.isGlobal;e.clear();for(const r of t){const t=e.pushNew();t.root=r,t.origin=i?f$R:r.centerAtSeaLevel,t.patches.clear(),this._renderCollectOriginsForRoot(e,t);}e.filterInPlace((e=>e.patches.length>0));}_renderCollectOriginsForRoot(e,t){const i=this.tileIterator;i.resetOne(t.root);const r=this.patchGroupsMap;for(r.clear(),r.set(t.origin,t);!i.done;){const t=i.next(),s=t.renderData;if(!s||t.visible){if(t.lij[0]%$$3==0){const i=e.pushNew();i.root=t,i.origin=t.centerAtSeaLevel,r.set(t.centerAtSeaLevel,i),i.patches.clear();}if(t.rendered){if(s){const e=r.get(s.localOrigin);e&&e.patches.push(t),(!this.highestVisibleLODTile||t.vlevel>this.highestVisibleLODTile.vlevel)&&(this.highestVisibleLODTile=t),i.skipSubtree();}}else this.numTilesCulled++;}else this.numTilesCulled++,i.skipSubtree();}}_scaleQueriesForTile(e){const t=e.extent,i=e.lij[0];let r=0;for(;r<this.visibleScaleRangeQueriesInvPtr;){const e=this.visibleScaleRangeQueries.data[r],s=e.extent;i>=e.minLevel&&i<=e.maxLevel&&s[0]<=t[2]&&s[2]>=t[0]&&s[1]<=t[3]&&s[3]>=t[1]?(this.visibleScaleRangeQueries.swapElements(r,this.visibleScaleRangeQueriesInvPtr-1),this.visibleScaleRangeQueriesInvPtr--):r++;}}_useStencilForTile(e){for(const t of this.stencilEnabledLayerExtents)if(e.intersectsExtent(t))return !0;return !1}_renderPatchGroupsAuxiliary(e,t,i,r){this.shaderTechnique.bindPipelineState(e.rctx);const s=this.stencilEnabledLayerExtents.length>0;t.setUniformMatrix4fv("proj",e.camera.projectionMatrix),t.setUniform1f("skirtScale",this._skirtScale),0!==r&&this._bindOverlayData(t,r);for(let n=0;n<i.length;n++){const a=i.data[n];this._bindPatchGroupData(t,a,e.camera.eye,e.camera.viewMatrix);for(let i=0;i<a.patches.length;i++)this._renderPatch(e.rctx,t,a.patches.data[i],4,s,r);}e.rctx.bindVAO(null);}_renderPatchGroups(e,t,i,n){const a=e.rctx,o=e.camera,l=o.viewMatrix;if(this.shaderTechnique.bindPipelineState(a),this.shaderTechniqueConfig.screenSizePerspective&&this.pointsOfInterest){const e=i$19(this.stage.viewingMode,this.ellipsoidRadius),i=this.pointsOfInterest.centerOnSurfaceFrequent.distance;e.update({distance:i,fovY:o.fovY}),B$o(e,t,"screenSizePerspective");}const h=this.stencilEnabledLayerExtents.length>0,d=3===n;d&&(t.bindTexture(this.emptyTex,"tex"),t.setUniform1f("blend",1),t.setUniform4fv("texOffsetAndScale",_$q));const c=r$Y(this.tileRenderer.backgroundColor)?this.tileRenderer.backgroundColor:_$q;this.shaderTechniqueConfig.hasBackgroundColor&&t.setUniform4fv("backgroundColor",c);const u=d?0:this._skirtScale;t.setUniform1f("skirtScale",u);const p=this.wireframe?1:4;this.shaderTechniqueConfig.textureFadingEnabled&&t.bindTexture(this.emptyTex,"texNext");for(let g=0;g<i.length;g++){const c=i.data[g],u=c.patches;this._bindPatchGroupData(t,c,o.eye,l);const f=e.sliceHelper&&e.sliceHelper.plane;r$1u(t,this.shaderTechnique.configuration,f,c.origin),e.shadowMap&&e.shadowMap.bindView(t,c.origin),this.numOriginsRendered++;for(let e=0;e<u.length;e++){const i=u.data[e],o=i.renderData.textureReference;if(t$17(o))continue;if(!d){this._scaleQueriesForTile(i),oe(i.renderData.geometryInfo.uvOffsetAndScale,o.offsetAndScale,ie),t.setUniform4fv("texOffsetAndScale",ie),t.bindTexture(o.texture.texture,"tex");const e=i.renderData.textureFadeFactor,s=e<1?i.renderData.nextTextureReference:null;this.shaderTechniqueConfig.textureFadingEnabled&&r$Y(s)&&e<1?(oe(i.renderData.geometryInfo.uvOffsetAndScale,s.offsetAndScale,ie),t.setUniform1f("textureFadeFactor",e),t.setUniform4fv("nextTexOffsetAndScale",ie),t.bindTexture(s.texture.texture,"texNext")):t.setUniform1f("textureFadeFactor",1),i.renderData.textureIsFading&&this.setNeedsRender(),t.setUniform1f("opacity",i.renderData.opacity),t.setUniform1i("compositeBackground",i.renderData.compositeBackgroundInShader?1:0),t.setUniform1f("textureOpacity",i.renderData.layerOpacity),t.setUniform1f("baseOpacity",i.renderData.baseOpacity);}const l=this._renderPatch(a,t,i,p,h,n);i.renderOrder=this.numTilesRendered,this.numTilesRendered++,this.numTrianglesRendered+=l/3;}}a.bindVAO(null);}_renderPatch(e,t,i,r,n,a){if(t$17(i.renderData.vao.indexBuffer))return 0;0!==a&&this._bindOverlayPatchData(t,i.renderData.overlay),n&&(this._useStencilForTile(i)?this.stencilShaderTechnique.bindPipelineState(e):this.shaderTechnique.bindPipelineState(e));const o=0===this._skirtScale?i.renderData.geometryInfo.numWithoutSkirtIndices:i.renderData.vao.indexBuffer.size;return e.bindVAO(i.renderData.vao),t.assertCompatibleVertexAttributeLocations(i.renderData.vao),e.drawElements(r,o,i.renderData.vao.indexBuffer.indexType,0),o}_bindPatchGroupData(e,t,i,r){e.setUniform3fv("origin",t.origin),c$_(le,r,t.origin),e.setUniformMatrix4fv("view",le),e.setUniform3f("camPos",i[0]-t.origin[0],i[1]-t.origin[1],i[2]-t.origin[2]);}_bindOverlayData(e,t){if(0===this.shaderTechniqueConfig.overlayMode)return;e.setUniform1f("overlayOpacity",this.overlayOpacity);const i=this.overlayRenderer.overlays;if(i.length>0){const s=i[0],n=s.getColorTexture(t);if(e.bindTexture(r$Y(n)?n:this.emptyTex,"ovColorTex"),2===this.shaderTechniqueConfig.overlayMode){const i=s.getNormalTexture(t);e.bindTexture(r$Y(i)?i:this.emptyTex,"ovWaterTex");}}}_bindOverlayPatchData(e,t){e.setUniform4fv("overlayTexOffset",t.offsets),e.setUniform4fv("overlayTexScale",t.scales);}_setTerrainTechnique(e,t){this.shaderTechniqueConfig.output=e,0===e&&(this.shaderTechniqueConfig.atmosphere=this.isGlobal&&this._velvetOverground,this.shaderTechniqueConfig.ssrEnabled=this._ssrEnabled),this.shaderTechniqueConfig.renderOccluded=t,this.shaderTechniqueConfig.stencilEnabled=!1,this.shaderTechnique=this.shaderTechniques.releaseAndAcquire(b$6,this.shaderTechniqueConfig,this.shaderTechnique),this.shaderTechniqueConfig.stencilEnabled=!0,this.stencilShaderTechnique=this.shaderTechniques.releaseAndAcquire(b$6,this.shaderTechniqueConfig,this.stencilShaderTechnique);}_prepareScaleRangeQueries(){const e=this.visibleScaleRangeQueries,t=this.visibleScaleRangeQueryQueue;for(;e.length<e.data.length&&t.length>0;){const i=t.pop();e.push(i);}this.visibleScaleRangeQueriesInvPtr=e.length;}_processScaleRangeQueries(){const e=this.visibleScaleRangeQueries,t=this.visibleScaleRangeQueryPool;for(let i=0;i<e.length;i++){const r=e.data[i];t.release(r),r.callback(i>=this.visibleScaleRangeQueriesInvPtr),r.callback=null;}e.clear();}get test(){return {tileRenderer:this.tileRenderer}}};e$Q([y$K()],se.prototype,"tileBackgroundInitialized",void 0),e$Q([y$K()],se.prototype,"tileBackgroundUpdating",void 0),e$Q([y$K({constructOnly:!0})],se.prototype,"overlayRenderer",void 0),e$Q([y$K({constructOnly:!0})],se.prototype,"stage",void 0),e$Q([y$K({readOnly:!0})],se.prototype,"isGlobal",null),e$Q([y$K({constructOnly:!0})],se.prototype,"updateOverlayOpacity",void 0),e$Q([y$K({constructOnly:!0})],se.prototype,"allTiles",void 0),e$Q([y$K({constructOnly:!0})],se.prototype,"ellipsoidRadius",void 0),e$Q([y$K({readOnly:!0})],se.prototype,"updating",null),e$Q([y$K({value:!1})],se.prototype,"renderingDisabled",null),e$Q([y$K()],se.prototype,"renderPatchBorders",null),e$Q([y$K()],se.prototype,"cullBackFaces",null),e$Q([y$K({value:1})],se.prototype,"renderOrder",null),e$Q([y$K()],se.prototype,"wireframe",null),se=e$Q([n$14("esri.views.3d.terrain.TerrainRenderer")],se);var ne=se;function ae(e,t,i){return 0===e.patches.length?-i:0===t.patches.length?i:h$c(e.patches.data[0],t.patches.data[0],i)}function oe(e,t,i){const r=e[0]*t[2]+t[0],s=e[1]*t[3]+t[1],n=e[2]*t[2],a=e[3]*t[3];r$17(i,r,s,n,a);}const le=e$P(),he=n$11(),de=n$11(),ce=n$11(),ue=n$11(),pe=n$11(),ge="TerrainRenderer";

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class e$b{constructor(){this.numNodes=0,this.numLeaves=0,this.numVisible=0,this.numRendered=0,this.numSplit=0,this.numMerged=0,this.numRenderedPerLevel=new Array,this.numLoadedPerLevel=new Array;}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class t$h{constructor(){this.offset=n$19(),this.scale=0,this.tile=null;}init(s,t,i,e){this.tile=s,this.offset[0]=t,this.offset[1]=i,this.scale=e;}dispose(){this.tile=null,this.offset[0]=0,this.offset[1]=0,this.scale=0;}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
const Me=n$12.getLogger("esri.views.3d.terrain.TerrainSurface"),Ee=.25;let Oe=class extends(n$13.EventedMixin(p$14)){constructor(e){super(e),this._elevationBounds=new s$f,this._rootExtent=i$P(),this._iteratorPool=new e$X(r$h,(e=>e.remove=()=>this._iteratorPool.release(e))),this._postorderIterator=new s$e,this._hasPendingUpdates=!1,this._pendingUpdates=0,this._asyncWorkItems=0,this._allTilesDirty=!0,this._allTilesSorted=!0,this._visible=!1,this._usedMemory=Be$1,this._performanceInfo=new e$b,this._viewChanged=!1,this._inFrameTask=!1,this._viewChangeUpdateDirty=!1,this._overlayOpacity=1,this._eyePosRenderSR=n$11(),this._eyePosSurfaceSR=n$11(),this._splitLimits=new F$7,this._snapLevel=1/0,this._frustum=y$B(),this._viewProjectionMatrix=e$P(),this._layerViews=[new Array,new Array],this._layerIndexByUid=[new Map,new Map],this._basemapLayerViewHandles=new Map,this._handles=new u$T,this._watchUpdatingTracking=new l$V,this._allTiles=new n$1h,this._upsampleInfoPool=new e$X(t$h),this._getElevationData={spatialReference:null,rootTiles:null},this._maxNumUpdating=1,this.maxTextureScale=1.2,this.rootTiles=null,this.backgroundImage=H$k,this.backgroundColor=null,this._layerViewsDirty=!1;}initialize(){this._lercDecoder=n$1v(this.view.resourceController),this._tilePool=this.view.state.isLocal?new e$X(r$d):new e$X(m$b);const e=this.view.resourceController.memoryController;this._upsampleMapCache=e.getMemCache("esri.views.3d.terrain.upsample",(e=>e.unloadMapData())),this._elevationQueryCache=new t$o(e.getMemCache("elevation-query")),this._set("overlayManager",new se$1({surface:this})),this._handles.add([this.watch("overlayManager.hasHighlights",(e=>this._renderer.setNeedsHighlight(e))),this.watch("overlayManager.rendersOccluded",(e=>this._renderer.setRenderOccludedOverlay(e)))],"overlayManager"),this._renderer=new ne({overlayRenderer:this.overlayManager.renderer,ellipsoidRadius:p$15(this.view.spatialReference).radius,stage:this.view._stage,updateOverlayOpacity:()=>this.updateOverlayOpacity(),allTiles:this._allTiles}),this._handles.add([d$S(this,"baseOpacity",(e=>{this._handleLayerViewChanges(),this._updateBaseOpacity(e);}),!0),d$S(this,"_background",(()=>{this._handleLayerViewChanges(),this._renderer.setTileBackground(this._background);}),!0),this.view.watch("pointsOfInterest",(e=>{this._renderer.pointsOfInterest=e,this._watchUpdatingTracking.removeAll(),e&&this._watchUpdatingTracking.add(e.focus,"renderLocation",(()=>()=>this._allTilesSorted=!1));})),d$S(T$k,"TERRAIN_TILE_TREE_SHOW_TILES",(e=>{e&&!this._treeDebugger?import('./TerrainTileTree3DDebugger-7ca2dd1d.js').then((({TerrainTileTree3DDebugger:e})=>{!this._treeDebugger&&T$k.TERRAIN_TILE_TREE_SHOW_TILES&&(this._treeDebugger=new e({view:this.view}));})):e||!this._treeDebugger||T$k.TERRAIN_TILE_TREE_SHOW_TILES||(this._treeDebugger.destroy(),this._treeDebugger=null);}))]);const t={layers:this.view.map.allLayers,layerViews:this.view.allLayerViews,spatialReference:this.view.spatialReference};this.extentHelper=g$9(this.viewingMode,t),this._handles.add(d$S(this.extentHelper,"stencilEnabledExtents",(e=>this._renderer.setStencilEnabledLayerExtents(e))),"extentHelper");const i=this.view.defaultsFromMap?new p$1d({getCollections:()=>{var e,t,i;return null==(e=this.view)||null==(t=e.defaultsFromMap)||null==(i=t.mapCollectionPaths)?void 0:i.map((e=>this.view.map.get(e)))},getChildrenFunction:e=>e&&"layers"in e?e.layers:null}):this.view.map.allLayers,r=new m$a({layers:i,extentHelper:this.extentHelper,viewingMode:this.viewingMode,viewSpatialReference:this.view.spatialReference});this._set("tilingSchemeLogic",r),this._handles.add([this.tilingSchemeLogic.watch("tilingScheme",(()=>this._updateTilingSchemeAndExtent()),!0),this.tilingSchemeLogic.watch("extent",(()=>this._updateTilingSchemeAndExtent()),!0)],"tilingSchemeLogic"),this._updateTilingSchemeAndExtent(),this._elevationDataRequester=this.view.resourceController.createStreamDataRequester(0),this._mapDataRequester=this.view.resourceController.createStreamDataRequester(1);const a=this.view.resourceController.scheduler;this._frameTask=a.registerTask(p$H.TERRAIN_SURFACE,this),this.view.resourceController.memoryController.events.on("quality-changed",(()=>this._viewChangeUpdate())),this._handles.add([this.view.on("resize",(()=>this._viewChangeUpdate())),this.view.watch("state.camera",(()=>this._viewChangeUpdate()),!0),this.view.watch("state.contentCamera",(()=>this.view.state.fixedContentCamera&&this._viewChangeUpdate()),!0),this.view.watch("qualitySettings.tiledSurface.lodBias",(()=>this._viewChangeUpdate())),d$S(this.view,"qualitySettings.tiledSurface.textureFadeDuration",(e=>this._renderer.textureFadingEnabled=e>0)),this.view.watch("lodSnapping",(()=>this._viewChangeUpdate())),this.view.watch("clippingArea",(()=>this._clippingChanged()))]),this._handles.add(this.view.allLayerViews.on("after-changes",(()=>this._layerViewsDirty=!0))),this._layerViewsDirty=!0,this._handleLayerViewChanges(),this._updateClippingExtent(),this.notifyChange("extent");}destroy(){this._frameTask.remove(),this._handles.destroy(),this._watchUpdatingTracking.destroy(),this._lercDecoder=h$U(this._lercDecoder),this._removeAllTiles(),this._upsampleMapCache=l$W(this._upsampleMapCache),this._elevationQueryCache=l$W(this._elevationQueryCache),this._set("tilingSchemeLogic",l$W(this.tilingSchemeLogic)),this.extentHelper=l$W(this.extentHelper),this._basemapLayerViewHandles.forEach(((e,t)=>this._unregisterTiledLayerView(t))),this._elevationDataRequester=null,this._mapDataRequester=null,this._set("overlayManager",l$W(this.overlayManager)),this._tilePool=l$W(this._tilePool),X$2.prune(),this._treeDebugger&&(this._treeDebugger.destroy(),this._treeDebugger=null),this._renderer=l$W(this._renderer),this._iteratorPool=l$W(this._iteratorPool),this._set("view",null),this._upsampleInfoPool=l$W(this._upsampleInfoPool),u$1d(),h$a();}get renderer(){return this._renderer}get frustum(){return this._frustum}get snapLevel(){var e,t;const i=null==(e=this.view.pointsOfInterest)||null==(t=e.contentCameraOnSurface)?void 0:t.scale;if(i){const e=this.view.state.contentCamera;let t=ee$9(this.view,e.eye,e.viewForward,e.up).tilt;t>90&&(t=180-t);const r=2*(t/90)**2,s=ge$3(this.view,i)-r;Math.abs(this._snapLevel-s)>Ee&&(Math.round(s)!==Math.round(this._snapLevel)&&(this._viewChanged=!0),this._snapLevel=s);}return Math.round(this._snapLevel)}get lodSnapping(){return this.view.qualitySettings.tiledSurface.reduceTileLevelDifferences?1:0}get upsampleInfoPool(){return this._upsampleInfoPool}get upsampleMapCache(){return this._upsampleMapCache}get elevationQueryCache(){return this._elevationQueryCache}get mapTileRequester(){return this._mapDataRequester}get extent(){return c$W(this._clippingExtent,this._rootExtent)}get updating(){return this._hasPendingUpdates||(this._maxNumUpdating=1),!!((this._watchUpdatingTracking.updating||this._hasPendingUpdates||this._viewChanged||this._allTilesDirty||this._asyncWorkItems>0||!this._allTilesSorted||this._renderer.updating||this._layerViewsDirty)&&this.ready&&!this.suspended||this.overlayManager.updating||this._frameTask.updating)}get updatingProgressValue(){return this._maxNumUpdating=Math.max(this._pendingUpdates,this._maxNumUpdating),1-this._pendingUpdates/this._maxNumUpdating}get viewingMode(){return this.view.state.viewingMode}get ready(){return !!this.rootTiles}set renderOrder(e){this._renderer.renderOrder=e,this._set("renderOrder",e);}set skirtScale(e){this._renderer.skirtScale=e;}get skirtScale(){return this._renderer.skirtScale}get spatialReference(){var e,t;return null!=(e=null==(t=this.tilingScheme)?void 0:t.spatialReference)?e:null}get _background(){return null!=this.backgroundColor?this.backgroundColor:this.backgroundImage}set slicePlaneEnabled(e){var t,i;this._renderer.slicePlane=e,this._set("slicePlaneEnabled",e),null==(t=this.view)||null==(i=t._stage)||i.renderView.setRenderParameters({opaqueTerrain:this.opaque});}set velvetOverground(e){e!==this.velvetOverground&&(this._renderer.velvetOverground=e),this._set("velvetOverground",e);}set visible(e){e!==this._visible&&(this._visible=e,this._renderer.setVisibility(e),this.suspended=!e);}get opaque(){return this._renderer.opaque}set suspended(e){this._set("suspended",e),this._viewChangeUpdate();}intersect(e,t,i,r){this._renderer.intersect(e,t,i,r);}getElevation(e,t,i,r){const s=Fe,a=this.getTileWithElevation(e,t,i,r,s);return t$17(a)?null:i$a.sample(s[0],s[1],a.renderData.geometryState.samplerData)}getTileWithElevation(e,t,i,r,s=Fe){const a=this._getElevationData.rootTiles;if(!a||!a.length)return null;if(0===a[0].layerInfo[0].length)return null;if(s[0]=e,s[1]=t,s[2]=i,!wn(s,r,s,this._getElevationData.spatialReference))return Me.error("TerrainSurface.getElevation(): could not project given point to tiling scheme coordinate system"),null;for(let n of a){if(!n.containsPoint(s))continue;for(;n&&!n.rendered&&!n.isLeaf;){let e=0;s[0]>.5*(n.extent[0]+n.extent[2])&&(e+=1),s[1]<.5*(n.extent[1]+n.extent[3])&&(e+=2),n=n.children[e];}const e=n.renderData;return (e&&e.geometryState?e.geometryState.samplerData:null)?n:null}return null}get elevationBounds(){return this._elevationBounds}getScale(e){if(this.tilingScheme){if(!Rn(e,Fe,this.spatialReference))return Me.error("TerrainSurface.getElevation(): could not project given point to tiling scheme coordinate system"),null;const t=this.rootTiles;if(t)for(let e of t)if(e.containsPoint(Fe)){for(;null!=e.children[0];){let t=0;Fe[0]>e.children[0].extent[2]&&(t+=1),Fe[1]<e.children[0].extent[1]&&(t+=2),e=e.children[t];}return this._getLodBiasCorrectedScale(e.level)}}return 1e100}queryVisibleScaleRange(e,t,i,r){const s=t?this.tilingScheme.levelAtScale(t):0,a=i?this.tilingScheme.levelAtScale(i):1/0,n=this.lodBias;this._renderer.queryVisibleLevelRange(e,s+n,a+n,r);}_updateBaseOpacity(e){const t=this._renderer.opaque;this._renderer.opaque=e>=1,this._renderer.isTransparent=this._allTransparentSurfaceLayers();const i=t!==this._renderer.opaque;var r,s;i&&(null==(r=this.view)||null==(s=r._stage)||s.renderView.setRenderParameters({opaqueTerrain:this.opaque}));this._updateTileTextures(i);}_updateTilingSchemeAndExtent(){const e=this.tilingSchemeLogic.extent,t=e&&!G$q(e,this._dataExtent);t&&(r$Y(this._dataExtent)?A$y(this._dataExtent,e):this._dataExtent=i$P(e));const i=this.tilingSchemeLogic.tilingScheme,r=i!==this.tilingScheme;var s;r&&(f$e(!!i,"tiling scheme cannot be reset to undefined"),this.tilingScheme&&this._removeAllTiles(),this._set("tilingScheme",i),this._updateClippingExtent(),i&&(this._updateTiledLayers(),this._renderer.setTileSize(i.pixelSize),this.overlayManager.setSpatialReference(i.spatialReference)),this._getElevationData.spatialReference=null!=(s=null==i?void 0:i.spatialReference)?s:null);(t||r)&&this._updateRootTiles();}_acquireTile(e,t,i,r){const s=this._tilePool.acquire();return We[0]=e,We[1]=t,We[2]=i,s.init(We,r,this),s}_updateRootTiles(){const e=this._clippingExtent||this._dataExtent,t=this.tilingScheme;if(t$17(e)||!t)return;const i=He;let s=t.rootTilesInExtent(e,i,5*I$v);const a=e=>{const t=this._acquireTile(0,e[1],e[2],null);return 2===t.shouldSplit(this._splitLimits,this._eyePosRenderSR,this.lodSnapping)&&t.setPendingUpdate(2),this._loadTile(t),t};if(this.rootTiles){if(s.length>I$v)return void Me.warn(a$X);const e=this.rootTiles.map((e=>e.lij)),t=c$1b(e,s,ke$1);if(t.removed.length>0||t.added.length>0){const e=this.rootTiles.filter((e=>!(t.removed.findIndex(ke$1.bind(null,e.lij))>-1)||(this._purgeTile(e),!1)));t.added.forEach((t=>e.push(a(t)))),this._setRootTiles(e);}}else s.length>I$v&&(Me.warn(u$R),s=t.rootTilesInExtent(e,i,I$v)),this._setRootTiles(s.map((e=>a(e))));G$q(i,this._rootExtent)||(this._rootExtent=i$P(i),this._hasFixedExtent()||this.notifyChange("extent")),this.visible=!0,this._viewChangeUpdate(),this.overlayManager.setOverlayPlacementDirty(),this.notifyChange("ready");}_setRootTiles(e){if(this._set("rootTiles",e),this._allTiles.clear(),e){const t=this._iteratorPool.acquire();for(t.reset(e);!t.done;)this._allTiles.push(t.next());t.remove();}this._getElevationData.rootTiles=e,this._renderer.setRootTiles(this.rootTiles),this._updateTileVisibility(e);}_runViewChangeUpdateIfDirty(){this._viewChangeUpdateDirty&&(this._viewChangeUpdateDirty=!1,this._viewChangeUpdate());}_viewChangeUpdate(){this.view&&!this.suspended&&this.tilingScheme&&this._visible&&(this._inFrameTask?this._viewChangeUpdateDirty=!0:(this._viewChangeUpdateDirty=!1,this._updateViewDependentParameters(),this._updateSkirts(),this.updateOverlayOpacity(),this._updateTileVisibility(this.rootTiles)));}_updateClippingStatus(e){e.updateClippingStatus(this._clippingExtent)&&e.resetPendingUpdate(32)&&this._updateTileGeometry(e);}_updateTileVisibility(e){if(!e)return;const t=this._iteratorPool.acquire();t.reset(e);const i=m$c(e);let r=i?this._elevationBounds.min:1/0,s=i?this._elevationBounds.max:-1/0;for(;!t.done;){const e=t.next();this._updateClippingStatus(e),e.updateVisibility(),e.setPendingUpdate(16),e.loadable?(e.updateScreenDepth(this._viewProjectionMatrix),e.renderData&&(r=Math.min(e.elevationBounds[0],r),s=Math.max(e.elevationBounds[1],s))):t.skipSubtree();}t.remove(),this._viewChanged=!0,this._allTilesDirty=!0,isFinite(r)&&isFinite(s)&&(this._elevationBounds.min===r&&this._elevationBounds.max===s||(this._elevationBounds.min=r,this._elevationBounds.max=s,this.emit("elevation-bounds-change",null)));}_updateViewDependentParameters(){const e=this.view.state.camera,t=this.view.state.contentCamera,i=Math.tan(.5*t.fovX),r=Math.tan(.5*t.fovY),s=this.tilingScheme.pixelSize,a=2**-this.lodBias*e.pixelRatio;this._splitLimits.aboveGround=e.aboveGround,this._splitLimits.fovX=i,this._splitLimits.fovY=r,this._splitLimits.relativeWidthLimit=s/e.width*this.maxTextureScale*a,this._splitLimits.relativeHeightLimit=s/e.height*this.maxTextureScale*a,this._splitLimits.maxLod=this.tilingScheme.getMaxLod(),this._splitLimits.angledSplitBias=this.view.qualitySettings.tiledSurface.angledSplitBias,this.view.state.fixedContentCamera?(t$17(this._splitLimits.frustum)&&(this._splitLimits.frustum=y$B()),w$v(t.frustum,this._splitLimits.frustum)):this._splitLimits.frustum=null,w$v(e.frustum,this._frustum),e$V(this._viewProjectionMatrix,t.projectionMatrix,t.viewMatrix),r$Z(this._eyePosRenderSR,t.eye),wn(e.eye,this.view.renderSpatialReference,this._eyePosSurfaceSR,this.spatialReference);}_updateSkirts(){const e=this.view.state.camera,t=this.view.state.constraints.collision.enabled?0:1.11*e.near;this.skirtScale=m$g(this,this._eyePosSurfaceSR,t);}_updateRenderData(e){e.rendered&&!e.shouldLoad&&(qe$1(e)?this._loadChildren(e):Ae(e)&&this._loadParent(e));}_updateTileGeometry(e){e.updateVisibility(),this._renderer.updateTileGeometry(e),this._elevationUpdate(e),this._usedMemory=Be$1;}_elevationUpdate(e){Qe$1.spatialReference=this.spatialReference,Qe$1.tile=e,Qe$1.extent=e.extent,this.emit("elevation-change",Qe$1),g$U(e.extent,this._eyePosSurfaceSR)&&this._updateSkirts();}get running(){return this.updating&&this.ready&&!this.suspended}runTask(e){this._handleLayerViewChanges(e),this._frameTask.processQueue(e),this._inFrameTask=!0,this._pendingUpdates=0,this._hasPendingUpdates=!1,this._updateTileStatus(e),this._sortTiles(e);const t=!this.view.state.fixedContentCamera;this._mergeAndSplit(e,t),e.run((()=>this._updateElevation(e))),e.run((()=>this._updateTextures(e))),t||this._mergeAndSplit(e,!0),this._inFrameTask=!1,this._runViewChangeUpdateIfDirty(),e.done&&this.requestUpdate(),this.notifyChange("updatingProgressValue");}_updateTileStatus(e){if(!this._viewChanged||!this.rootTiles||e.done)return;this._viewChanged=!1;const t=this._iteratorPool.acquire();for(t.reset(this.rootTiles);!t.done;){const e=t.next();if(e.loadable){const i=e.shouldSplit(this._splitLimits,this._eyePosRenderSR,this.lodSnapping);if(2===i){e.resetPendingUpdate(8),e.isLeaf&&(e.setPendingUpdate(2),t.skipSubtree());continue}e.resetPendingUpdate(2)&&e.updateAgentSuspension(),4===i&&e.updateAgents(0);}if(t.skipSubtree(),!e.isLeaf){e.setPendingUpdate(8),e.resetPendingUpdate(2);const t=this._iteratorPool.acquire();t.resetOne(e);for(let e=t.next();!t.done;e=t.next())this._updateClippingStatus(e),e.updateVisibility(),e.loadable&&e.updateScreenDepth(this._viewProjectionMatrix);t.remove();}}t.remove(),this.requestUpdate(),e.madeProgress();}_sortTiles(e){e.done||this._allTilesSorted||(c$f(this._allTiles,this.view.pointsOfInterest.focus.renderLocation),this._allTilesSorted=!0,this._treeDebugger&&this._treeDebugger.update(),e.madeProgress());}_mergeAndSplit(e,t){if(this.suspended||!this._allTilesDirty||e.done)return;this._allTilesDirty=!1,this.requestUpdate();let i=0;for(;!e.done;){let r=!1;i=0;const s=!this._allTiles.some((s=>{if(i+=s.usedMemory,s.resetPendingUpdate(8)){if(!t)return s.setPendingUpdate(8),e.done;this._mergeTile(s),r=!0,e.madeProgress();}else s.resetPendingUpdate(2)&&(this._splitTile(s),r=!0,e.madeProgress());return s.resetPendingUpdate(16)&&(this._updateRenderData(s),e.madeProgress()),e.done}));if(r&&(this._allTilesSorted=!1,this._allTilesDirty=!0),s){if(this._usedMemory=i,!r)break}else this._allTilesDirty=!0;}0===i&&(this._allTilesDirty=!0),this._sortTiles(e);}_updateElevation(e){return this._allTiles.some((t=>(t.resetPendingUpdate(32)&&(this._updateTileGeometry(t),t.resetPendingUpdate(64)&&(this._renderer.updateTileTexture(t),this._usedMemory=Be$1),e.madeProgress()),e.done))),e.hasProgressed}_updateTextures(e){return this._allTiles.some((t=>(t.resetPendingUpdate(64)&&(this._renderer.updateTileTexture(t),this._usedMemory=Be$1,e.madeProgress()),e.done))),e.hasProgressed}_updateClippingExtent(){if(!this.spatialReference)return !1;const e=i$P();let t=null;return x$d(this.view.clippingArea,e,this.spatialReference)&&(t=e),!G$q(t,this._clippingExtent)&&(this._clippingExtent=t,this._renderer.clippingExtent=t,this.notifyChange("extent"),this.updateTileOverlayParams(),this.overlayManager.setOverlayPlacementDirty(),!0)}_clippingChanged(){this._updateClippingExtent()&&this._updateRootTiles();}get lodBias(){const e=this.view.resourceController.memoryController.memoryFactor;return this.view.qualitySettings.tiledSurface.lodBias-(1-e)*C$p}_getLodBiasCorrectedScale(e){const t=this.tilingScheme.levels,i=o$R(e-this.lodBias,0,t.length-1),r=i-Math.floor(i);return t[Math.floor(i)].scale*(1-r)+t[Math.ceil(i)].scale*r}_removeAllTiles(){this.rootTiles&&(this.rootTiles.forEach((e=>this._purgeTile(e))),this._setRootTiles(null),this.notifyChange("ready")),this._allTiles.clear(),this.visible=!1;}_purgeChildTiles(e){if(e.isLeaf)return !1;let t=this._purgeTile(e.children[0]);return t=this._purgeTile(e.children[1])||t,t=this._purgeTile(e.children[2])||t,t=this._purgeTile(e.children[3])||t,e.unsetChildren(),t}_purgeTile(e){const t=this._purgeChildTiles(e)||e.rendered;return this._allTiles.removeUnordered(e),e.unload(this._renderer),this._tilePool.release(e),t}_splitTile(e){f$e(e.isLeaf,"tile that is already split should not be split again!");const t=e.level+1,i=2*e.lij[1],r=2*e.lij[2];e.setChildren(this._createTile(t,i,r,e),this._createTile(t,i,r+1,e),this._createTile(t,i+1,r,e),this._createTile(t,i+1,r+1,e)),e.setPendingUpdate(16),e.updateAgentSuspension(),this._allTiles.pushArray(e.children),this._allTilesDirty=!0,this._emitTileScaleChange(e,t),++this._performanceInfo.numSplit;}_emitTileScaleChange(e,t=e.level){Ge.spatialReference=this.spatialReference,Ge.extent=e.extent,Ge.scale=this._getLodBiasCorrectedScale(t),this.emit("scale-change",Ge);}_createTile(e,t,i,r){f$e(!!r,"_createTile sanity check");const s=this._acquireTile(e,t,i,r);return s.updateClippingStatus(this._clippingExtent),s.loadable&&(s.updateScreenDepth(this._viewProjectionMatrix),2===s.shouldSplit(this._splitLimits,this._eyePosRenderSR,this.lodSnapping)&&s.setPendingUpdate(2)),s}_mergeTile(e){f$e(!e.hasPendingUpdate(2),"_mergeTile sanity check"),this._purgeChildTiles(e)&&(f$e(!e.renderData,"_mergeTile sanity check"),this._loadTile(e)),this._allTilesDirty=!0,++this._performanceInfo.numMerged,this._emitTileScaleChange(e);}_loadChildren(e){f$e(e.rendered,"parent should be rendered"),e.unload(this._renderer),this._loadTile(e.children[0]),this._loadTile(e.children[1]),this._loadTile(e.children[2]),this._loadTile(e.children[3]);}_loadParent(e){const t=e.parent;this._unloadChildren(t),this._loadTile(t);}_unloadChildren(e){e.isLeaf||(this._unloadChildren(e.children[0]),e.children[0].unload(this._renderer),this._unloadChildren(e.children[1]),e.children[1].unload(this._renderer),this._unloadChildren(e.children[2]),e.children[2].unload(this._renderer),this._unloadChildren(e.children[3]),e.children[3].unload(this._renderer));}_loadTile(e){e.load(this._renderer),e.setPendingUpdate(16),this.requestUpdate(),this.overlayManager&&this.overlayManager.hasOverlays&&this.overlayManager.setTileParameters(e),this._elevationUpdate(e);}_elevationDataArrived(e,t,i){const r=new i$a(e.lij,e.extent,i);e.dataArrived(t,0,r);const s=[e],a=e.level,n=this._iteratorPool.acquire();for(n.reset(s);!n.done;){const e=n.next();e.findElevationBoundsForLayer(t,a),e.computeElevationBounds();}n.remove(),this._updateTileVisibility(s);}_handleLayerViewChanges(e=N$f){if(!this._layerViewsDirty)return;this._layerViewsDirty=!1;let t=!1;const i=new Set;let r=-1;for(const s of this.view.allLayerViews.items)if(i.add(s.uid),g$e(s))if(this._basemapLayerViewHandles.has(s.uid)){const e=this.layerClassFromLayerView(s),i=this._layerIndexByUid[e].get(s.uid);i<r&&(t=!0),r=i;}else this._registerTiledLayerView(s),s.layer.loaded&&(t=!0);this._basemapLayerViewHandles.forEach(((e,r)=>{i.has(r)||(this._unregisterTiledLayerView(r),t=!0);})),t&&this._updateTiledLayers(),this._renderer.isTransparent=this._allTransparentSurfaceLayers(),e.madeProgress();}_allTransparentSurfaceLayers(){let e=0===this.view.map.ground.opacity;for(const t of this.view.allLayerViews.items)if(g$e(t)&&!h$g(t)&&!t$Z(t.layer)&&0!==t.fullOpacity)return e=!1,e;return e}layerClassFromLayerView(e){return h$g(e)?0:1}_registerTiledLayerView(e){const t=[],i=this.layerClassFromLayerView(e);t.push(e.watch("suspended",(()=>this._updateTiledLayers()))),t.push(e.watch("fullOpacity",(()=>this._updateTileTextures(!1)))),t.push(e.layer.watch("scaleRangeId",(()=>this._restartAllAgents(i)))),e.on("data-changed",(()=>{const t=this._layerIndexByUid[i].get(e.uid);null!=t&&this._invalidateLayerData(t,i);})),this._basemapLayerViewHandles.set(e.uid,t);}_unregisterTiledLayerView(e){const t=this._basemapLayerViewHandles.get(e);if(t){for(let e=0;e<t.length;e++)t[e].remove();this._basemapLayerViewHandles.delete(e);}}_updateTiledLayers(){if(!this.tilingScheme||this.view.suspended)return;const e=this.view.allLayerViews,t=[[],[]];let i=null;const r=B$m();e.forEach((e=>{const s=e.layer;if(!s||e.suspended||!g$e(e))return;const a=e.fullExtent;if(!a)return void Me.warn("Terrain: Map or elevation layer does not have fullExtent: "+s.id);if(!this.tilingScheme.compatibleWith(e.tileInfo))return void Me.warn("Terrain: tiling scheme of layer "+s.id+" is incompatible with other tiled layers, will not be drawn");c$14(r,a);const n=this.layerClassFromLayerView(e);if(1===n){const t=e.displayLevelRange;t.maxLevel!==1/0&&(null===i||t.maxLevel>i)&&(i=t.maxLevel);}t[n].push(e);}));for(const s of o$Q){const e=this._layerViews[s],i=t[s];i.reverse();const r=i.length;let a=e.length!==r;const n=new Array(r),l=new Array(e.length);this._layerIndexByUid[s].clear();for(let t=0;t<r;t++){const r=i[t].uid;this._layerIndexByUid[s].set(r,t);const o=e.indexOf(i[t]);n[t]=o,t!==o&&(a=!0),o>-1&&(l[o]=t);}if(a){const e=this._postorderIterator;for(e.reset(this.rootTiles);!e.done;)e.next().modifyLayers(l,n,s);this._layerViews[s]=i,this._restartAllAgents(s),this._updateTileVisibility(this.rootTiles);}}this.tilingScheme.ensureMaxLod(i)&&this._viewChangeUpdate();}_restartAllAgents(e){const t=this._postorderIterator;for(t.reset(this.rootTiles);!t.done;){const i=t.next();i.restartAgents(e),0===e&&i.computeElevationBounds();}}_hasFixedExtent(){return !!this._clippingExtent}layerViewByIndex(e,t){return this._layerViews[t][e]}numLayers(e){return this._layerViews[e].length}_updateTileTextures(e){this._allTiles.forAll((t=>{t.updateAgents(1),e?this.renderer.updateTileTexture(t):t.updateRenderData(1);})),this._renderer.isTransparent=this._allTransparentSurfaceLayers();}_invalidateLayerData(e,t){this._allTiles.forAll((i=>i.removeLayerAgent(e,t))),this._allTiles.forAll((i=>i.invalidateLayerData(e,t)));}setTileTreeDirty(){this._allTilesDirty=!0;}requestRender(e=1){this.renderer.setNeedsRender(e);}requestUpdate(){1==++this._pendingUpdates&&(this._hasPendingUpdates=!0);}requestTileData(e,t,i,r){const s=this.layerViewByIndex(t,i),a=s.layer;return !a.tilemapCache||E$6(s)?this._requestTileData(e,i,s,r):(++this._asyncWorkItems,a.tilemapCache.fetchAvailability(e.lij[0],e.lij[1],e.lij[2],{...r,timeout:6e3}).then((()=>--this._asyncWorkItems)).catch((t=>{throw --this._asyncWorkItems,g$T(t)||this._dataMissing(e,i,s,{notInTilemap:!0}),t})).then((()=>this._frameTask.schedule((()=>this._requestTileData(e,i,s,r)),r.signal))))}_requestTileData(e,t,i,r){return 0===t?this._requestElevationTileData(e,i,r):this._requestMapTileData(e,i,r)}_requestElevationTileData(e,t,i){if(!h$g(t))return void f$e(!1,"_requestElevationTileData can only be called for elevation layer views");const r=r=>{if(--this._asyncWorkItems,b$J(i))return;const s=this._layerIndexByUid[0].get(t.uid);null!=s?(this._usedMemory=Be$1,this.requestUpdate(),this._elevationDataArrived(e,s,r)):Me.warn("TerrainSurface: received data from unknown layer %d %s",0,e.lij.toString());},s=i=>{--this._asyncWorkItems,g$T(i)||(this._dataMissing(e,0,t,i),this.requestUpdate());};if(++this._asyncWorkItems,b$8(t.layer))return t.layer.fetchTile(e.lij[0],e.lij[1],e.lij[2],{noDataValue:n$10,signal:i.signal}).then((e=>{if(b$J(i))return Me.warnOnce("A call to fetchTile resolved even though the request was aborted. fetchTile should not resolve if options.signal.aborted is true."),void s(m$Y());this._frameTask.schedule((()=>r(e)),i.signal);}),s);const a=t.getTileUrl(e.lij[0],e.lij[1],e.lij[2]);return this._elevationDataRequester.request(a,"binary",i).then((e=>this._lercDecoder.decode(e,{noDataValue:n$10},i.signal))).then((e=>{r({values:e.pixelData,width:e.width,height:e.height,noDataValue:e.noDataValue,minValue:e.minValue,maxValue:e.maxValue});}),s)}_requestMapTileData(e,t,i){if(t instanceof p$d)return Promise.reject();++this._asyncWorkItems;const r=(r,s)=>{--this._asyncWorkItems,w$7(s),b$J(i)||(this._dataMissing(e,1,t,r),this.requestUpdate());},s=e=>t=>r(t,e),a=r=>this._frameTask.schedule((()=>{--this._asyncWorkItems,this.requestUpdate(),b$J(i)?w$7(r):this._mapTileDataArrived(e,t,r);}),i.signal,s(r)).catch(s(r)),n=(e,t=null)=>this._frameTask.schedule((()=>r(e,t))).catch(s(t));if(E$6(t)){const r=t.schemaHelper.getLevelRowColumn(e.lij);return t.fetchTile(r[0],r[1],r[2],i).then(a,n)}if(x$8(t))return t.fetchTile(e.lij[0],e.lij[1],e.lij[2],i).then(a,n);if(y$a(t)&&b$8(t.layer))return t.layer.fetchTile(e.lij[0],e.lij[1],e.lij[2],i).then((e=>{if(b$J(i))return Me.warnOnce("A call to fetchTile resolved even though the request was aborted. fetchTile should not resolve if options.signal.aborted is true."),void n(m$Y());a(e);}),n);let l=t.getTileUrl(e.lij[0],e.lij[1],e.lij[2]);Ie(t)&&t.refreshTimestamp&&(l+=`${l.indexOf("?")>-1?"&":"?"}_ts=${t.refreshTimestamp}`);const o=t.hasMixedImageFormats?"image+type":"image";return this._mapDataRequester.request(l,o,i).then(a,n)}_mapTileDataArrived(e,t,i){const r=this._layerIndexByUid[1].get(t.uid);null!=r?e.dataArrived(r,1,i):(w$7(i),Me.warn("TerrainSurface: received data from unknown layer"));}_dataMissing(e,t,i,r){const s=this._layerIndexByUid[t].get(i.uid);null!=s?e.dataMissing(s,t,r):Me.warn("TerrainSurface: received data from unknown layer");}updateTileOverlayParams(){this.rootTiles&&this.overlayManager&&(this._allTiles.forAll((e=>{e.renderData&&this.overlayManager.setTileParameters(e);})),this._renderer.setNeedsRender());}updateOverlayOpacity(){if(!this.overlayManager)return;const e=this._eyePosSurfaceSR[2],t=this.overlayManager.computeOpacity(e);this._overlayOpacity!==t&&(this._overlayOpacity=t,this._renderer.overlayOpacity=t,this._renderer.setNeedsRender());}get performanceInfo(){const e=this._performanceInfo;return e.numNodes=this._allTiles.length,e.numLeaves=e.numVisible=e.numRendered=e.numLoadedPerLevel.length=e.numRenderedPerLevel.length=0,this._allTiles.forAll((t=>{t.isLeaf&&e.numLeaves++;const i=t.level;t.renderData&&(e.numLoadedPerLevel[i]=(e.numLoadedPerLevel[i]||0)+1),t.visible&&(e.numVisible++,t.rendered&&(e.numRenderedPerLevel[i]=(e.numRenderedPerLevel[i]||0)+1,e.numRendered++));})),e}getUsedMemory(){return this.tilingScheme?(this._usedMemory===Be$1&&(this._usedMemory=0,this._allTiles.forAll((e=>this._usedMemory+=e.usedMemory))),this._usedMemory):0}getUsedMemoryForLayerView(e){let t=0;const i=this.layerClassFromLayerView(e),r=this._layerIndexByUid[i].get(e.uid);return this._allTiles.forAll((e=>t+=e.getUsedMemoryForLayer(i,r))),t}getTile(e){if(t$17(e))return null;const t=e.split("/").map((e=>+e));if(0===t[0])return this.rootTiles.find((e=>e.lij[1]===t[1]&&e.lij[2]===t[2]));const i=2**t[0],r=Math.floor(t[1]/i),s=Math.floor(t[2]/i);let a;if(this.rootTiles.some((e=>e.lij[1]===r&&e.lij[2]===s&&(a=e,!0))),a){let e=1<<t[0]-1;for(;a.lij[0]<t[0];){let i=t[1]&e?2:0;if((t[2]&e)>0&&i++,!a.children[i])return null;a=a.children[i],e>>=1;}return f$e(a.lij[0]===t[0]&&a.lij[1]===t[1]&&a.lij[2]===t[2],"not the right tile?"),a}return null}get test(){const e=this;return {renderer:e._renderer,lercDecoder:e._lercDecoder,forceReload:()=>{e._mergeTile(e.rootTiles[0]),e._viewChangeUpdate();},getTiles:()=>e._allTiles.toArray(),getRenderedTiles:()=>(Ne$1.clear(),e._allTiles.forAll((e=>{e.visible&&e.rendered&&Ne$1.push(e);})),a$d(e.renderOrder,Ne$1),Ne$1.toArray())}}};e$Q([y$K()],Oe.prototype,"_renderer",void 0),e$Q([y$K()],Oe.prototype,"_hasPendingUpdates",void 0),e$Q([y$K()],Oe.prototype,"_asyncWorkItems",void 0),e$Q([y$K()],Oe.prototype,"_allTilesDirty",void 0),e$Q([y$K()],Oe.prototype,"_allTilesSorted",void 0),e$Q([y$K()],Oe.prototype,"_viewChanged",void 0),e$Q([y$K({readOnly:!0})],Oe.prototype,"_watchUpdatingTracking",void 0),e$Q([y$K()],Oe.prototype,"_frameTask",void 0),e$Q([y$K({readOnly:!0})],Oe.prototype,"snapLevel",null),e$Q([y$K({readOnly:!0})],Oe.prototype,"lodSnapping",null),e$Q([y$K({constructOnly:!0})],Oe.prototype,"view",void 0),e$Q([o$1d("_renderer.cullBackFaces")],Oe.prototype,"cullBackFaces",void 0),e$Q([y$K({readOnly:!0,dependsOn:[]})],Oe.prototype,"extent",null),e$Q([y$K({readOnly:!0})],Oe.prototype,"updating",null),e$Q([y$K(t$n)],Oe.prototype,"updatingProgress",void 0),e$Q([y$K({readOnly:!0})],Oe.prototype,"updatingProgressValue",null),e$Q([y$K()],Oe.prototype,"_maxNumUpdating",void 0),e$Q([y$K({aliasOf:"view.map.ground.opacity"})],Oe.prototype,"baseOpacity",void 0),e$Q([y$K({readOnly:!0})],Oe.prototype,"overlayManager",void 0),e$Q([y$K({readOnly:!0})],Oe.prototype,"viewingMode",null),e$Q([y$K()],Oe.prototype,"maxTextureScale",void 0),e$Q([y$K({readOnly:!0})],Oe.prototype,"ready",null),e$Q([y$K({value:1})],Oe.prototype,"renderOrder",null),e$Q([y$K({readOnly:!0})],Oe.prototype,"rootTiles",void 0),e$Q([y$K({readOnly:!0})],Oe.prototype,"spatialReference",null),e$Q([y$K()],Oe.prototype,"backgroundImage",void 0),e$Q([y$K({type:o$W,aliasOf:"view.map.ground.surfaceColor"})],Oe.prototype,"backgroundColor",void 0),e$Q([y$K()],Oe.prototype,"_background",null),e$Q([y$K({value:!1})],Oe.prototype,"slicePlaneEnabled",null),e$Q([y$K({readOnly:!0})],Oe.prototype,"tilingScheme",void 0),e$Q([y$K({readOnly:!0,aliasOf:"tilingSchemeLogic.tilingSchemeLocked"})],Oe.prototype,"tilingSchemeLocked",void 0),e$Q([y$K({readOnly:!0,aliasOf:"tilingSchemeLogic.tilingSchemeDone"})],Oe.prototype,"tilingSchemeDone",void 0),e$Q([y$K({readOnly:!0})],Oe.prototype,"tilingSchemeLogic",void 0),e$Q([y$K({value:!0})],Oe.prototype,"velvetOverground",null),e$Q([o$1d("_renderer.wireframe")],Oe.prototype,"wireframe",void 0),e$Q([y$K({value:!1})],Oe.prototype,"suspended",null),e$Q([y$K({readOnly:!0,aliasOf:"view.qualitySettings.tiledSurface.textureFadeDuration"})],Oe.prototype,"textureFadeDuration",void 0),e$Q([y$K()],Oe.prototype,"_layerViewsDirty",void 0),e$Q([o$1d("_renderer.renderPatchBorders")],Oe.prototype,"renderPatchBorders",void 0),e$Q([o$1d("_renderer.renderingDisabled")],Oe.prototype,"renderingDisabled",void 0),Oe=e$Q([n$14("esri.views.3d.terrain.TerrainSurface")],Oe);var Ve=Oe;function ke$1(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]}function Ie(e){return null!=e.refreshInterval}function qe$1(e){return !e.isLeaf&&(e.children[0].shouldLoad||e.children[1].shouldLoad||e.children[2].shouldLoad||e.children[3].shouldLoad||qe$1(e.children[0])||qe$1(e.children[1])||qe$1(e.children[2])||qe$1(e.children[3]))}function Ae(e){return e.isLeaf&&e.parent&&e.parent.shouldLoad}const Be$1=-1,Fe=n$1a(),He=i$P(),We=[0,0,0],Ne$1=new n$1h,Qe$1={spatialReference:null,tile:null,extent:null,context:"ground"},Ge={spatialReference:null,extent:null,scale:0};

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
let m$8=class extends p$14{constructor(e){super(e),this._residentGeomRecords=new Map,this._dirtyGeomRecords=new Map,this.dirty=!1;}commit(e){this.dirty=!1,this._dirtyGeomRecords.forEach(((t,r)=>this.commitLayer(r,e)));}commitLayer(e,t){const r=this._dirtyGeomRecords.get(e);r&&(r.forEach(((r,o)=>{const s=this._ensureGeomRecord(e,o);r.forEach(((e,r)=>{const d=e[0],i=e[1],c=e[2];let m=!1;if(2&i){const e=s.get(r);if(e){const r=e[1];if(4&c){const e=this.model.getObject(o);this.model.updateRenderGeometryTransformation(e,d,r)&&(m=!0);}m||t.updates.push({renderGeometry:r,updateType:c});}else i$R(!1,"ModelDirtySet.getAddRemoveListFilteredByLayers: invalid update");}if(4&i||m){const e=s.get(r);e?(t.removes.push(e[1]),s.delete(r),e[0].disposed&&o$L.pool.release(e[0])):4===i&&i$R(!1,"ModelDirtySet.getAddRemoveListFilteredByLayers: invalid remove");}if(1&i||m){const e=this.model.getObject(o),i=this.model.getRenderGeometry(e,d),c=[d,i];t.adds.push(i),s.set(r,c);}})),0===s.size&&this._residentGeomRecords.get(e).delete(o);})),0===this._residentGeomRecords.get(e).size&&this._residentGeomRecords.delete(e),this._dirtyGeomRecords.delete(e));}getResidentRenderGeometries(e,t){const r=this._residentGeomRecords.get(e);r&&r.forEach((e=>e.forEach((e=>t.push(e[1])))));}_objectStateChanged(e,t){for(const r of t.geometryRecords)this._updateOrCreateDirtyRecord(t,r,null,2,0,0,2,5,e);}visibilityChanged(e){this._objectStateChanged(1,e);}highlightChanged(e){this._objectStateChanged(8,e);}occlusionChanged(e){this._objectStateChanged(16,e);}vertexAttrsUpdated(e){this._updateOrCreateDirtyRecord(e.object,e.record,null,2,0,0,2,5,2);}layerAdded(e){e.objects.forAll((t=>this._layerObjectAdded(e,t)));}layerRemoved(e){e.objects.forAll((t=>this._layerObjectRemoved(e,t)));}layerObjectAdded(e){this._layerObjectAdded(e.layer,e.object);}_layerObjectAdded(e,t){const r=e.id,o=t.geometryRecords;for(let s=0;s<o.length;s++)this._objectGeometryAdded(t,o[s],r);}layerObjectRemoved(e){this._layerObjectRemoved(e.layer,e.object);}layerObjectsAdded(e){for(const t of e.objects)this._layerObjectAdded(e.layer,t);}layerObjectsRemoved(e){for(const t of e.objects)this._layerObjectRemoved(e.layer,t);}_layerObjectRemoved(e,t){const r=e.id,o=t.geometryRecords;for(let s=0;s<o.length;s++)this._objectGeometryRemoved(t,o[s],r);}shaderTransformationChanged(e){const t=this._residentGeomRecords.get(e.id);t&&t.forEach(((e,t)=>{const r=this.model.getObject(t);r&&r.hasVolativeTransformation()&&e.forEach((e=>{e[1].shaderTransformationChanged();}));}));}objectTransformation(e){const t=this._getParentLayerId(e),r=e.id;this._ensureGeomRecord(t,r).forEach((r=>{this._updateOrCreateDirtyRecord(e,r[0],t,2,0,0,2,5,4);}));}objectGeometryAdded(e){this._objectGeometryAdded(e.object,e.record);}_objectGeometryAdded(e,t,r=null){this._updateOrCreateDirtyRecord(e,t,r,1,4,0,0,0);}objectGeometryRemoved(e){this._objectGeometryRemoved(e.object,e.record);}_objectGeometryRemoved(e,t,r=null){this._updateOrCreateDirtyRecord(e,t,r,4,1,2,0,0);}_updateOrCreateDirtyRecord(e,t,r,s,d,i,c,m,h){r=c$W(r,this._getParentLayerId(e));const l=e.id,y=t.id,p=this._ensureDirtyRecord(r,l),R=p.get(y);if(R){const e=R[1];e&d?(p.delete(y),R[0].disposed&&o$L.pool.release(R[0])):e&i?(R[1]=s,R[2]=h):e&c?R[2]|=h:e&m||i$R(!1,"ModelDirtySet.objectGeometryAdded: inconsistent state");}else p.set(y,[t,s,h]);this.dirty=this._hasDirtyGeometryRecords;}_ensureGeomRecord(e,t){let r=this._residentGeomRecords.get(e);r||(r=new Map,this._residentGeomRecords.set(e,r));let o=r.get(t);return o||(o=new Map,r.set(t,o)),o}get _hasDirtyGeometryRecords(){return n$1i(this._dirtyGeomRecords,(e=>n$1i(e,(e=>e&&e.size>0))))}_ensureDirtyRecord(e,t){let r=this._dirtyGeomRecords.get(e);r||(r=new Map,this._dirtyGeomRecords.set(e,r));let o=r.get(t);return o||(o=new Map,r.set(t,o)),o}_getParentLayerId(e){return r$Y(e.parentLayer)?e.parentLayer.id:n$1w}formatDebugInfo(){const e=["ADD","UPD",void 0,"REM"];let t="";return this._dirtyGeomRecords.forEach(((r,o)=>{r.forEach(((r,s)=>{t.length>0&&(t+="\n"),t+=o+"."+s;const d=[];r.forEach((e=>{const t=e[1];d[t]||(d[t]=[]),d[t].push(e[0].geometry.id);}));for(let o=0;o<d.length;o++)if(d[o]){t+=" "+e[o-1]+": ";for(let e=0;e<d[o].length;e++)t+=d[o][e]+", ";}}));})),t}get test(){const e=this;return {get residentLayerCount(){return e._residentGeomRecords.size},get residentObjectCount(){return Array.from(e._residentGeomRecords.values()).reduce(((e,t)=>e+t.size),0)}}}};e$Q([y$K({constructOnly:!0})],m$8.prototype,"model",void 0),e$Q([y$K()],m$8.prototype,"dirty",void 0),m$8=e$Q([n$14("esri.views.3d.webgl-engine.lib.ModelDirtySet")],m$8);var h$9=m$8;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
const l$a=i$R,m$7=q$v,h$8=1e4,p$8=10;let g$4=class extends p$14{constructor(){super(),this.dirtySet=new h$9({model:this}),this._id2origin=new Map,this._content=new Map;}getObject(t){return this._content.get(t)}add(t){const e=t.id;l$a(!this._content.has(e),"Model/Stage already contains object to be added"),this._content.set(e,t),l$w(t)&&this.dirtySet.layerAdded(t);}remove(t){l$a(this._content.has(t.id),"Model/Stage doesn't contain object to be removed"),this._content.delete(t.id),t.unload(),l$w(t)&&this.dirtySet.layerRemoved(t);}addMany(t){for(const e of t)l$a(!this._content.has(e.id),"Model/Stage already contains object to be added"),this._content.set(e.id,e);}removeMany(t){for(const e of t)l$a(this._content.has(e.id),"Model/Stage doesn't contain object to be removed"),this._content.delete(e.id),e.unload();}forEachOfType(t,e){this._content.forEach((o=>{o.type===t&&e(o);}));}_getOrigin(t){let e=0;const o=t[3]*p$8/h$8;o>1&&(e=Math.ceil(m$7(o,2)));const r=2**e*h$8,i=Math.round(t[0]/r),s=Math.round(t[1]/r),a=Math.round(t[2]/r),d=e+"_"+i+"_"+s+"_"+a;let c=this._id2origin.get(d);return null==c&&(c=c$y(i*r,s*r,a*r,d),this._id2origin.set(d,c)),c}getRenderGeometry(t,e){const{geometry:o,material:r,id:n,shaderTransformation:i,origin:a,instanceParameters:d}=e,c=new l$p(o,r,null,null,n,o.boundingInfo,i,t.castShadow);return c.updateTransformation((o=>t.getCombinedStaticTransformation(e,o))),c.origin=a||this._getOrigin(c.boundingSphere),c.instanceParameters=d,c}updateRenderGeometryTransformation(t,e,o){o.updateTransformation((o=>t.getCombinedStaticTransformation(e,o)));const r=this._getOrigin(o.boundingSphere);return o.origin!==r}getStats(){const t={},e=Array.from(this._content.values());for(let o=0;o<5;++o)t[o]=e.filter((t=>t.type===o)).length;return {contentTypes:t,dirtySet:this.dirtySet.formatDebugInfo()}}get test(){return {content:Array.from(this._content.values())}}};e$Q([y$K({constructOnly:!0})],g$4.prototype,"dirtySet",void 0),g$4=e$Q([n$14("esri.views.3d.webgl-engine.parts.Model")],g$4);

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
const t$g=1e-6,n$f=[0,0,0],r$8=[0,0,0];function i$8(t,i){const{data:s,size:e}=t,a=s.length/e;if(a<=0)return;const c=new H$4(t);L$4(n$f,c.minProj,c.maxProj),R$4(n$f,n$f,.5),Q$3(r$8,c.maxProj,c.minProj);const h=K$4(r$8),u=new J$4;u.quality=h,a<14&&(t={data:new Float64Array(c.buffer,112,42),size:3});const f=[0,0,0],m=[0,0,0],P=[0,0,0],j=[0,0,0],b=[0,0,0],x=[0,0,0],I=[0,0,0];switch(o$d(c,t,I,f,m,P,j,b,x,u)){case 1:return void z$3(n$f,r$8,i);case 2:return void G$3(t,j,i)}l$9(t,I,f,m,P,j,b,x,u),O$3(t,u.b0,u.b1,u.b2,Y$1,_$3);const N=[0,0,0];Q$3(N,_$3,Y$1),u.quality=K$4(N),u.quality<h?C$3(u.b0,u.b1,u.b2,Y$1,_$3,N,i):z$3(n$f,r$8,i);}function o$d(n,r,i,o,s,e,a,c,h,u){if(P$3(n,o,s),$$2(o,s)<t$g)return 1;Q$3(a,o,s),X$1(a,a);return b$5(r,o,a,e)<t$g?2:(Q$3(c,s,e),X$1(c,c),Q$3(h,e,o),X$1(h,h),W$3(i,c,a),X$1(i,i),d$a(r,i,a,c,h,u),0)}const s$b=[0,0,0],e$a=[0,0,0],a$b=[0,0,0],c$d=[0,0,0],h$7=[0,0,0],u$9=[0,0,0],f$8=[0,0,0],m$6=[0,0,0];function l$9(t,n,r,i,o,l,P,j,b){I$5(t,n,r,s$b,e$a),void 0!==s$b[0]&&(Q$3(a$b,s$b,r),X$1(a$b,a$b),Q$3(c$d,s$b,i),X$1(c$d,c$d),Q$3(h$7,s$b,o),X$1(h$7,h$7),W$3(u$9,c$d,l),X$1(u$9,u$9),W$3(f$8,h$7,P),X$1(f$8,f$8),W$3(m$6,a$b,j),X$1(m$6,m$6),d$a(t,u$9,l,c$d,a$b,b),d$a(t,f$8,P,h$7,c$d,b),d$a(t,m$6,j,a$b,h$7,b)),void 0!==e$a[0]&&(Q$3(a$b,e$a,r),X$1(a$b,a$b),Q$3(c$d,e$a,i),X$1(c$d,c$d),Q$3(h$7,e$a,o),X$1(h$7,h$7),W$3(u$9,c$d,l),X$1(u$9,u$9),W$3(f$8,h$7,P),X$1(f$8,f$8),W$3(m$6,a$b,j),X$1(m$6,m$6),d$a(t,u$9,l,c$d,a$b,b),d$a(t,f$8,P,h$7,c$d,b),d$a(t,m$6,j,a$b,h$7,b));}function P$3(t,n,r){let i=$$2(t.maxVert[0],t.minVert[0]),o=0;for(let s=1;s<7;++s){const n=$$2(t.maxVert[s],t.minVert[s]);n>i&&(i=n,o=s);}U$4(n,t.minVert[o]),U$4(r,t.maxVert[o]);}const j$4=[0,0,0];function b$5(t,n,r,i){const{data:o,size:s}=t;let e=Number.NEGATIVE_INFINITY,a=0;for(let c=0;c<o.length;c+=s){j$4[0]=o[c]-n[0],j$4[1]=o[c+1]-n[1],j$4[2]=o[c+2]-n[2];const t=r[0]*j$4[0]+r[1]*j$4[1]+r[2]*j$4[2],i=r[0]*r[0]+r[1]*r[1]+r[2]*r[2],s=j$4[0]*j$4[0]+j$4[1]*j$4[1]+j$4[2]*j$4[2]-t*t/i;s>e&&(e=s,a=c);}return U$4(i,o,a),e}const x$5=[0,0];function I$5(n,r,i,o,s){T$7(n,r,x$5,s,o);const e=tt$1(i,r);x$5[1]-t$g<=e&&(o[0]=void 0),x$5[0]+t$g>=e&&(s[0]=void 0);}const N$8=[0,0,0],V$3=[0,0,0],y$5=[0,0,0],q$3=[0,0,0],w$4=[0,0,0],A$4=[0,0,0];function d$a(n,r,i,o,s,e){if(Z$2(r)<t$g)return;W$3(N$8,i,r),W$3(V$3,o,r),W$3(y$5,s,r),F$6(n,r,x$5),w$4[1]=x$5[0],q$3[1]=x$5[1],A$4[1]=q$3[1]-w$4[1];const a=[i,o,s],c=[N$8,V$3,y$5];for(let t=0;t<3;++t){F$6(n,a[t],x$5),w$4[0]=x$5[0],q$3[0]=x$5[1],F$6(n,c[t],x$5),w$4[2]=x$5[0],q$3[2]=x$5[1],A$4[0]=q$3[0]-w$4[0],A$4[2]=q$3[2]-w$4[2];const i=K$4(A$4);i<e.quality&&(U$4(e.b0,a[t]),U$4(e.b1,r),U$4(e.b2,c[t]),e.quality=i);}}const M$7=[0,0,0];function F$6(t,n,r){const{data:i,size:o}=t;r[0]=Number.POSITIVE_INFINITY,r[1]=Number.NEGATIVE_INFINITY;for(let s=0;s<i.length;s+=o){const t=i[s]*n[0]+i[s+1]*n[1]+i[s+2]*n[2];r[0]=Math.min(r[0],t),r[1]=Math.max(r[1],t);}}function T$7(t,n,r,i,o){const{data:s,size:e}=t;U$4(i,s),U$4(o,i),r[0]=tt$1(M$7,n),r[1]=r[0];for(let a=e;a<s.length;a+=e){const t=s[a]*n[0]+s[a+1]*n[1]+s[a+2]*n[2];t<r[0]&&(r[0]=t,U$4(i,s,a)),t>r[1]&&(r[1]=t,U$4(o,s,a));}}function z$3(t,n,r){U$4(r.center,t),R$4(r.halfSize,n,.5),r.quaternion[0]=0,r.quaternion[1]=0,r.quaternion[2]=0,r.quaternion[3]=1;}const E$4=[0,0,0],v$4=[0,0,0],g$3=[0,0,0],Y$1=[0,0,0],_$3=[0,0,0],S$4=[0,0,0];function G$3(n,r,i){U$4(E$4,r),Math.abs(r[0])>Math.abs(r[1])&&Math.abs(r[0])>Math.abs(r[2])?E$4[0]=0:Math.abs(r[1])>Math.abs(r[2])?E$4[1]=0:E$4[2]=0,Z$2(E$4)<t$g&&(E$4[0]=E$4[1]=E$4[2]=1),W$3(v$4,r,E$4),X$1(v$4,v$4),W$3(g$3,r,v$4),X$1(g$3,g$3),O$3(n,r,v$4,g$3,Y$1,_$3),Q$3(S$4,_$3,Y$1),C$3(r,v$4,g$3,Y$1,_$3,S$4,i);}function O$3(t,n,r,i,o,s){F$6(t,n,x$5),o[0]=x$5[0],s[0]=x$5[1],F$6(t,r,x$5),o[1]=x$5[0],s[1]=x$5[1],F$6(t,i,x$5),o[2]=x$5[0],s[2]=x$5[1];}const p$7=[0,0,0],B$4=[1,0,0,0,1,0,0,0,1],k$3=[0,0,0];function C$3(t,n,r,i,o,s,e){B$4[0]=t[0],B$4[1]=t[1],B$4[2]=t[2],B$4[3]=n[0],B$4[4]=n[1],B$4[5]=n[2],B$4[6]=r[0],B$4[7]=r[1],B$4[8]=r[2],nt$1(e.quaternion,B$4),L$4(k$3,i,o),R$4(k$3,k$3,.5),R$4(e.center,t,k$3[0]),R$4(p$7,n,k$3[1]),L$4(e.center,e.center,p$7),R$4(p$7,r,k$3[2]),L$4(e.center,e.center,p$7),R$4(e.halfSize,s,.5);}const D$5=7;class H$4{constructor(t){this.minVert=new Array(D$5),this.maxVert=new Array(D$5);const n=64*D$5;this.buffer=new ArrayBuffer(n);let r=0;this.minProj=new Float64Array(this.buffer,r,D$5),r+=8*D$5,this.maxProj=new Float64Array(this.buffer,r,D$5),r+=8*D$5;for(let a=0;a<D$5;++a)this.minVert[a]=new Float64Array(this.buffer,r,3),r+=24;for(let a=0;a<D$5;++a)this.maxVert[a]=new Float64Array(this.buffer,r,3),r+=24;for(let a=0;a<D$5;++a)this.minProj[a]=Number.POSITIVE_INFINITY,this.maxProj[a]=Number.NEGATIVE_INFINITY;const i=new Array(D$5),o=new Array(D$5),{data:s,size:e}=t;for(let a=0;a<s.length;a+=e){let t=s[a];t<this.minProj[0]&&(this.minProj[0]=t,i[0]=a),t>this.maxProj[0]&&(this.maxProj[0]=t,o[0]=a),t=s[a+1],t<this.minProj[1]&&(this.minProj[1]=t,i[1]=a),t>this.maxProj[1]&&(this.maxProj[1]=t,o[1]=a),t=s[a+2],t<this.minProj[2]&&(this.minProj[2]=t,i[2]=a),t>this.maxProj[2]&&(this.maxProj[2]=t,o[2]=a),t=s[a]+s[a+1]+s[a+2],t<this.minProj[3]&&(this.minProj[3]=t,i[3]=a),t>this.maxProj[3]&&(this.maxProj[3]=t,o[3]=a),t=s[a]+s[a+1]-s[a+2],t<this.minProj[4]&&(this.minProj[4]=t,i[4]=a),t>this.maxProj[4]&&(this.maxProj[4]=t,o[4]=a),t=s[a]-s[a+1]+s[a+2],t<this.minProj[5]&&(this.minProj[5]=t,i[5]=a),t>this.maxProj[5]&&(this.maxProj[5]=t,o[5]=a),t=s[a]-s[a+1]-s[a+2],t<this.minProj[6]&&(this.minProj[6]=t,i[6]=a),t>this.maxProj[6]&&(this.maxProj[6]=t,o[6]=a);}for(let a=0;a<D$5;++a){let t=i[a];U$4(this.minVert[a],s,t),t=o[a],U$4(this.maxVert[a],s,t);}}}class J$4{constructor(){this.b0=[1,0,0],this.b1=[0,1,0],this.b2=[0,0,1],this.quality=0;}}function K$4(t){return t[0]*t[1]+t[0]*t[2]+t[1]*t[2]}function L$4(t,n,r){t[0]=n[0]+r[0],t[1]=n[1]+r[1],t[2]=n[2]+r[2];}function Q$3(t,n,r){t[0]=n[0]-r[0],t[1]=n[1]-r[1],t[2]=n[2]-r[2];}function R$4(t,n,r){t[0]=n[0]*r,t[1]=n[1]*r,t[2]=n[2]*r;}function U$4(t,n,r=0){t[0]=n[r+0],t[1]=n[r+1],t[2]=n[r+2];}function W$3(t,n,r){const i=n[0],o=n[1],s=n[2],e=r[0],a=r[1],c=r[2];t[0]=o*c-s*a,t[1]=s*e-i*c,t[2]=i*a-o*e;}function X$1(t,n){const r=n[0]*n[0]+n[1]*n[1]+n[2]*n[2];if(r>0){const i=1/Math.sqrt(r);t[0]=n[0]*i,t[1]=n[1]*i,t[2]=n[2]*i;}}function Z$2(t){return t[0]*t[0]+t[1]*t[1]+t[2]*t[2]}function $$2(t,n){const r=n[0]-t[0],i=n[1]-t[1],o=n[2]-t[2];return r*r+i*i+o*o}function tt$1(t,n){return t[0]*n[0]+t[1]*n[1]+t[2]*n[2]}function nt$1(t,n){const r=n[0]+n[4]+n[8];if(r>0){let i=Math.sqrt(r+1);t[3]=.5*i,i=.5/i,t[0]=(n[5]-n[7])*i,t[1]=(n[6]-n[2])*i,t[2]=(n[1]-n[3])*i;}else {let r=0;n[4]>n[0]&&(r=1),n[8]>n[3*r+r]&&(r=2);const i=(r+1)%3,o=(r+2)%3;let s=Math.sqrt(n[3*r+r]-n[3*i+i]-n[3*o+o]+1);t[r]=.5*s,s=.5/s,t[3]=(n[3*i+o]-n[3*o+i])*s,t[i]=(n[3*i+r]+n[3*r+i])*s,t[o]=(n[3*o+r]+n[3*r+o])*s;}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
const w$3=e$1a(),d$9=n$11(),A$3=n$11(),I$4=e$Z();class C$2{constructor(t){const e=56,a=0,n=24,r=36,f=t*e;this.buffer=new ArrayBuffer(f),this.obbs=new Array(t);for(let o=0;o<t;o++)this.obbs[o]={center:u$1e(this.buffer,e*o+a),halfSize:a$1n(this.buffer,e*o+n),quaternion:t$1r(this.buffer,e*o+r)};}}function D$4(t=[0,0,0],e=[-1,-1,-1],a=[0,0,0,1]){return {center:r$_(t),halfSize:r$14(e),quaternion:n$1x(a)}}function E$3(t){return D$4(t.center,t.halfSize,t.quaternion)}function F$5(t,e){r$Z(e.center,t.center),r$Z(e.halfSize,t.halfSize),F$D(e.quaternion,t.quaternion);}function G$2(t,e){return e=e||D$4(),i$8(t,e),e}function H$3(t,e){const a=R$s(e,t.center),n=T$6(t,W$j(e));return a>n?1:a<-n?-1:0}function J$3(e,a){a||(a=a$1c());const n=p$1e(I$4,e.quaternion),r=e.halfSize[0]*Math.abs(n[0])+e.halfSize[1]*Math.abs(n[3])+e.halfSize[2]*Math.abs(n[6]),s=e.halfSize[0]*Math.abs(n[1])+e.halfSize[1]*Math.abs(n[4])+e.halfSize[2]*Math.abs(n[7]),f=e.halfSize[0]*Math.abs(n[2])+e.halfSize[1]*Math.abs(n[5])+e.halfSize[2]*Math.abs(n[8]);return a[0]=e.center[0]-r,a[1]=e.center[1]-s,a[2]=e.center[2]-f,a[3]=e.center[0]+r,a[4]=e.center[1]+s,a[5]=e.center[2]+f,a}function K$3(t,e){return R$s(e,t.center)-T$6(t,W$j(e))}function L$3(t,e){return R$s(e,t.center)+T$6(t,W$j(e))}function N$7(t,e){return H$3(t,e[0])<=0&&H$3(t,e[1])<=0&&H$3(t,e[2])<=0&&H$3(t,e[3])<=0&&H$3(t,e[4])<=0&&H$3(t,e[5])<=0}function O$2(t,e,a,n=0){w$I(w$3,t.quaternion),c$V(d$9,e,t.center);const s=P$C(d$9,d$9,w$3),f=P$C(A$3,a,w$3);let o=-1/0,i=1/0;for(let r=0;r<3;r++)if(Math.abs(f[r])>1e-6){const e=(n+t.halfSize[r]-s[r])/f[r],a=(-n-t.halfSize[r]-s[r])/f[r];o=Math.max(o,Math.min(e,a)),i=Math.min(i,Math.max(e,a));}else if(s[r]>t.halfSize[r]+n||s[r]<-t.halfSize[r]-n)return !1;return o<=i}(()=>{const t=new Int8Array(162);let e=0;const a=a=>{for(let n=0;n<a.length;n++)t[e+n]=a[n];e+=6;};return a([6,2,3,1,5,4]),a([0,2,3,1,5,4]),a([0,2,3,7,5,4]),a([0,1,3,2,6,4]),a([0,1,3,2,0,0]),a([0,1,5,7,3,2]),a([0,1,3,7,6,4]),a([0,1,3,7,6,2]),a([0,1,5,7,6,2]),a([0,1,5,4,6,2]),a([0,1,5,4,0,0]),a([0,1,3,7,5,4]),a([0,2,6,4,0,0]),a([0,0,0,0,0,0]),a([1,3,7,5,0,0]),a([2,3,7,6,4,0]),a([2,3,7,6,0,0]),a([2,3,1,5,7,6]),a([0,1,5,7,6,2]),a([0,1,5,7,6,4]),a([0,1,3,7,6,4]),a([4,5,7,6,2,0]),a([4,5,7,6,0,0]),a([4,5,1,3,7,6]),a([0,2,3,7,5,4]),a([6,2,3,7,5,4]),a([6,2,3,1,5,4]),t})();function T$6(t,e){w$I(w$3,t.quaternion),P$C(d$9,e,w$3);const a=t.halfSize;return Math.abs(d$9[0]*a[0])+Math.abs(d$9[1]*a[1])+Math.abs(d$9[2]*a[2])}function U$3(t,e){for(let a=0;a<8;++a){const n=e[a];n[0]=1&a?-t.halfSize[0]:t.halfSize[0],n[1]=2&a?-t.halfSize[1]:t.halfSize[1],n[2]=4&a?-t.halfSize[2]:t.halfSize[2],P$C(n,n,t.quaternion),u$S(n,n,t.center);}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class t$f{constructor(t){this._totalCount=t,this._indexRanges=[0,t];}componentCount(){const t=this._indexRanges;let n=0;for(let e=0;e<t.length;e+=2)n+=t[e+1];return n}reset(t){"all"===t||t.length===this._totalCount?this._indexRanges=[0,this._totalCount]:this._indexRanges=n$e(t);}forEachComponent(t){const n=this._indexRanges;for(let e=0;e<n.length;e+=2){const s=n[e],o=s+n[e+1];for(let n=s;n<o;n++)if(!t(n))return !1}return !0}forEachComponentRange(t){const n=this._indexRanges;for(let e=0;e<n.length;e+=2){const s=n[e];if(!t(s,s+n[e+1]))return !1}return !0}computeOffsetRanges(t){const n=new Array(this._indexRanges.length),e=this._indexRanges;for(let s=0;s<e.length;s+=2){const o=e[s],r=o+e[s+1],h=t[o],i=t[r];n[s]=h,n[s+1]=i-h;}return n}}function n$e(t){const n=new Array;if(0===t.length)return n;let e=t[0],s=1;for(let o=1;o<t.length;o++){const r=t[o];e+s===r?s+=1:(n.push(e),n.push(s),e=r,s=1);}return n.push(e),n.push(s),n}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class a$a extends e$1b{constructor(t,e){super(),this.pickability=null,this.highlightCounts=null,this.cachedGeometryRanges=null,this.cachedHighlightRanges=null,this.cachedDefaultRanges=null,this.offsets=t$1n(e);const s=this.count;this.visibility=new t$f(s),this.materialDataBuffer=t.getBuffer(s),this.materialDataIndices=new Uint16Array(s);for(let h=0;h<s;h++)this.materialDataIndices[h]=this.materialDataBuffer.acquireIndex();}dispose(){super.dispose();for(let t=0;t<this.count;t++)this.materialDataBuffer.releaseIndex(this.materialDataIndices[t]);}get count(){return this.offsets.length-1}get geometryRanges(){return t$17(this.cachedGeometryRanges)&&(this.cachedGeometryRanges=this.visibility.computeOffsetRanges(this.offsets)),this.cachedGeometryRanges}get highlightRanges(){return t$17(this.highlightCounts)?null:(this.updateCachedHighlightRanges(),this.cachedHighlightRanges)}get defaultShadowMapRanges(){return t$17(this.highlightCounts)?this.geometryRanges:(this.updateCachedHighlightRanges(),this.cachedDefaultRanges)}highlightsDirty(){this.cachedHighlightRanges=null,this.cachedDefaultRanges=null;}visibilityDirty(){this.cachedGeometryRanges=null,this.highlightsDirty();}updateCachedHighlightRanges(){if((t$17(this.cachedHighlightRanges)||t$17(this.cachedDefaultRanges))&&r$Y(this.highlightCounts)){const{highlightRanges:t,defaultRanges:e}=n$d(this.highlightCounts,this.visibility,this.offsets);this.cachedHighlightRanges=t,this.cachedDefaultRanges=e;}}}function n$d(t,e,h){const i=[],s=[];let a=h.length,n=h.length;return e.forEachComponent((e=>(t[e]>0?(a!==e-1&&(i.length&&i.push(h[a+1]-i[i.length-1]),i.push(h[e])),a=e):(n!==e-1&&(s.length&&s.push(h[n+1]-s[s.length-1]),s.push(h[e])),n=e),!0))),i.length&&i.push(h[a+1]-i[i.length-1]),s.length&&s.push(h[n+1]-s[s.length-1]),{highlightRanges:i,defaultRanges:s}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
function n$c(n){return "function"==typeof n}const t$e=1;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class e$9 extends e$1b{constructor(){super(...arguments),this._bucket=null,this._bucketIndex=0;}get bucketKey(){return this._bucket.key}}class s$a{constructor(){this._buckets=new Map;}add(t,e){const s=this._getBucket(t);e._bucket=s,e._bucketIndex=s.count,s.data.push(e),++s.statistics.added;}remove(t){++t._bucket.statistics.removed;const e=t._bucket.data,s=e[e.length-1];e[t._bucketIndex]=s,s._bucketIndex=t._bucketIndex,e.pop(),t._bucket=null,t._bucketIndex=0;}updateKey(t,e){this.remove(t),this.add(e,t);}getBucket(t){return this._getBucket(t).data}getPerformanceInfo(t){return this._getBucket(t).statistics}forEach(t){this._buckets.forEach((e=>t(e.data,e.key)));}get count(){let t=0;return this._buckets.forEach((e=>t+=e.count)),t}_getBucket(t){const e=this._buckets.get(t);if(e)return e;const s=new c$c(t);return this._buckets.set(t,s),s}}class c$c{constructor(t){this.key=t,this.data=new Array,this.statistics={added:0,removed:0};}get count(){return this.data.length}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class s$9 extends e$9{get visible(){return !!(this.bucketKey&t$e)}}e$Q([i$11()],s$9.prototype,"renderable",void 0),e$Q([i$11()],s$9.prototype,"components",void 0);

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
const o$c=40,a$9=20,c$b=.8,f$7=15,h$6=1e-6;function u$8(t,i,e){const n=i,r=e;let s=0,o=1/0;for(let a=0;a<3;++a){{const i=t[a];if(n[a]<i){if(r[a]<=h$6)return !1;const t=(i-n[a])/r[a];s=Math.max(s,t);}else if(r[a]<=-h$6){const t=(i-n[a])/r[a];o=Math.min(o,t);}if(s>=o)return !1}{const i=t[a+3];if(n[a]>i){if(r[a]>=-h$6)return !1;const t=(i-n[a])/r[a];s=Math.max(s,t);}else if(r[a]>=h$6){const t=(i-n[a])/r[a];o=Math.min(o,t);}if(s>=o)return !1}}return !0}class l$8{constructor(t,i,e,n,r){this.aabb=t,this.axis=i,this.d=e,this.midStartIndex=n,this.rightStartIndex=r;}}class d$8{constructor(t,i,e,n){this.globalTriangleVertexIndices=t,this.firstTriangleIndex=i,this.positionAttribute=n,this.bspNodeTree=new Array,this.vertexPositionBuffer=n.data,this.vertexPositionStride=n.stride;const r=e-i,s=r<=R$3?new Uint16Array(r):new Uint32Array(r);this.indices=s;for(let o=0;o<r;++o)s[o]=o;{const o=T$5(t,i,e,n.data,n.stride),h=(t,i,e)=>{const n=p$6(s,o,t,i),r=i-t;if(r<=a$9){const e=new l$8(n,void 0,0,t,i);return this.bspNodeTree.push(e),e}const{axis:u,midValue:d}=b$4(n),m=N$6(s,o,t,i,u,d),x=(t,i)=>{if(e>f$7)return;const n=i-t;return n<a$9||n>=c$b*r?void 0:h(t,i,e+1)},g=new l$8(n,u,d,m.next,m.mid);return this.bspNodeTree.push(g),g.leftNode=x(t,m.next),g.rightNode=x(m.mid,i),g};h(0,r,0),this.triangleVertexIndices=I$3(s,t,i,e);}}intersectRayTriangleRange(t,i){{if(t>=i)return;const e=this.triangleVertexIndices,n=this.positionAttribute.data,r=this.positionAttribute.stride,o=this.rayOrigin,a=o[0],c=o[1],f=o[2],h=this.rayDirection,u=h[0],l=h[1],d=h[2];for(let m=t,g=3*t;m<i;++m){const t=e[g]*r,i=n[t],o=n[t+1],h=n[t+2],y=e[g+1]*r,N=n[y],p=n[y+1],b=n[y+2],T=e[g+2]*r,I=n[T],R=n[T+1],S=n[T+2];g+=3;const M=N-i,w=p-o,A=b-h,v=I-i,B=R-o,P=S-h,V=l*P-B*d,U=d*v-P*u,j=u*B-v*l,k=M*V+w*U+A*j;if(Math.abs(k)<=Number.EPSILON)continue;const F=a-i,O=c-o,D=f-h,E=F*V+O*U+D*j;if(k>0){if(E<0||E>k)continue}else if(E>0||E<k)continue;const L=O*A-w*D,q=D*M-A*F,z=F*w-M*O,C=u*L+l*q+d*z;if(k>0){if(C<0||E+C>k)continue}else if(C>0||E+C<k)continue;const G=(v*L+B*q+P*z)/k;if(G>=0){const t=this.indices[m]+this.firstTriangleIndex,i=T$w(M,w,A,v,B,P,x$4);this.callback(G,i,t);}}}d$8.numFacesTested+=i-t;}intersectRay(i,n){d$8.numFacesTested=0;const r=t$_(i.r0[0],i.r0[1],i.r0[2]),s=m$5(t$_(i.r1[0],i.r1[1],i.r1[2]),r);if(p$12(s)<h$6)return;this.rayOrigin=r,this.rayDirection=s;const o=this.triangleVertexIndices.length/3;this.callback=n;const a=this.bspNodeTree[0];this.intersectRayBSP(a,0,o);}intersectRayBSP(t,i,e){const n=this.rayOrigin,r=this.rayDirection;if(!u$8(t.aabb,n,r))return;const s=t.axis,o=t.d;if(n[s]<o||r[s]<0){const e=i,n=t.midStartIndex;if(e<n){const i=t.leftNode;void 0!==i?this.intersectRayBSP(i,e,n):this.intersectRayTriangleRange(e,n);}}if(this.intersectRayTriangleRange(t.midStartIndex,t.rightStartIndex),n[s]>o||r[s]>0){const i=t.rightStartIndex,n=e;if(i<n){const e=t.rightNode;void 0!==e?this.intersectRayBSP(e,i,n):this.intersectRayTriangleRange(i,n);}}}}function m$5(t,e){const r=n$11();return J$l(r,t,e),r}d$8.numFacesTested=0;const x$4=n$11(),g$2=t$_(1/0,1/0,1/0),y$4=t$_(-1/0,-1/0,-1/0);function N$6(t,i,e,n,r,s){let o=e,a=n;for(;o<a;){const e=t[o];i[6*e+r+3]<=s?++o:(--a,t[o]=t[a],t[a]=e);}let c=o;for(a=n;c<a;){const e=t[a-1];i[6*e+r]>=s?--a:(t[a-1]=t[c],t[c]=e,++c);}return {next:o,mid:c}}function p$6(t,i,e,n){if(n<=e)return u$14(NaN,NaN,NaN,NaN,NaN,NaN);{const n=6*t[e];for(let t=0;t<3;++t)g$2[t]=i[n+0+t],y$4[t]=i[n+3+t];}for(let r=e+1;r<n;++r){const e=6*t[r];for(let t=0;t<3;++t)g$2[t]=Math.min(g$2[t],i[e+0+t]),y$4[t]=Math.max(y$4[t],i[e+3+t]);}return u$14(g$2[0],g$2[1],g$2[2],y$4[0],y$4[1],y$4[2])}function b$4(t){const i=t[3]-t[0],e=t[4]-t[1],n=t[5]-t[2],r=i>e?i>n?0:e>n?1:2:e>n?1:n>i?2:0;return {axis:r,midValue:(t[r]+t[r+3])/2}}function T$5(t,i,e,n,r){const s=e-i,o=new Float32Array(6*s);for(let a=0;a<s;++a){const e=3*(a+i),s=t[e+0]*r,c=t[e+1]*r,f=t[e+2]*r;for(let t=0;t<3;++t){const i=n[s+t],e=n[c+t],r=n[f+t];o[6*a+t]=Math.min(i,e,r),o[6*a+3+t]=Math.max(i,e,r);}}return o}function I$3(t,i,e,n){const r=n-e;let s=0;for(let a=e;a<n;++a)for(let t=0;t<3;++t)s=Math.max(i[3*a+t],s);const o=s<=R$3?new Uint16Array(3*r):new Uint32Array(3*r);for(let a=0;a<r;++a){const n=3*(t[a]+e);for(let t=0;t<3;++t){const e=i[n+t];o[3*a+t]=e;}}return o}const R$3=65535;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
function t$d(t,n,e,l){if(e>=n)return t;null==t&&(t=i$7());const s=t.isVisibleBit;let a=t.data;const c=r$7(a),o=e/c|0,f=e-c*o,h=(n-1)/c|0,B=a,E=l===s;if(!(e<B.length*c)&&E){const t=1.5,n=o+1,i=Math.ceil(B.length*t),e=h+1;let r=Math.max(n,i);r=Math.min(r,e),a=new Uint32Array(r),a.set(B);}return o<a.length&&(a[o]=u$7(a[o],f,E)),t.data=a,t}function n$b(t,n){if(null==t)return !0;const{isVisibleBit:i,data:u}=t,l=r$7(u);return n<u.length*l?e$8(i,u,n,l):!t.isVisibleBit}function i$7(t=!0){return {isVisibleBit:!t,data:new Uint32Array(0)}}function e$8(t,n,i,e){const r=i/e|0,u=i-r*e;return l$7(n[r],u)===t}function r$7(t){const n=8;return t.BYTES_PER_ELEMENT*n}function u$7(t,n,i){return t&~(1<<n)|(i?1:0)<<n}function l$7(t,n){return 0!=(t&1<<n)}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class u$6{constructor(o,s){this._indices=r$Y(o.indices)?o.indices:l$U(o.positions.length/3),this._positions=new i$14(o.positions),this._components=s,this._componentIntersectionData=new Array(s.count);}getComponentAabb(o,s){if(r$Y(this._perComponentAabbs)){for(let t=0;t<6;t++)s[t]=this._perComponentAabbs[6*o+t];return s}return this._computePerComponentAabbs(),this.getComponentAabb(o,s)}getComponentPositions(t,o){o.indices=this._indices,o.data=this._positions.typedBuffer,o.stride=this._positions.typedBufferStride,o.startIndex=this._components.offsets[t],o.endIndex=this._components.offsets[t+1];}intersect(s,e,i,r,p,h){const u={data:this._positions.typedBuffer,stride:this._positions.typedBufferStride,size:3},l=this._indices,C=this._components.offsets,y=j$M(s,e,d$7);this._components.visibility.forEachComponent((f=>{if(!n$b(this._components.pickability,f))return !0;const d=this.getComponentAabb(f,A$2);if(r$Y(p)&&p.applyToAabb(d),!A$B(d,s,y,i))return !0;const g=C[f]/3,B=C[f+1]/3,j=(t,o,s)=>{h(f,t,L$u(o,o,r),s);},I=B-g;return t$17(p)&&I>o$c?(null==this._componentIntersectionData[f]&&(this._componentIntersectionData[f]=new d$8(this._indices,g,B,u)),this._componentIntersectionData[f].intersectRay({r0:s,r1:e},j)):M$A(s,e,g,B,l,u,void 0,p,j),!0}));}_computePerComponentAabbs(){const t=this._components.count;this._perComponentAabbs=new Float32Array(6*t);for(let o=0;o<t;o++)this._computeAABB(o);}_computeAABB(t){const o=this._indices,n=this._positions,i=this._components.offsets,r=i[t],p=i[t+1],m=[0,0,0],a=[1/0,1/0,1/0],c=[-1/0,-1/0,-1/0];for(let f=r;f<p;f++){const t=o[f];n.getVec(t,m),f$12(a,a,m),l$1h(c,c,m);}let h=6*t;this._perComponentAabbs[h++]=a[0],this._perComponentAabbs[h++]=a[1],this._perComponentAabbs[h++]=a[2],this._perComponentAabbs[h++]=c[0],this._perComponentAabbs[h++]=c[1],this._perComponentAabbs[h]=c[2];}get positions(){return this._positions}get indices(){return this._indices}}const d$7=n$11(),A$2=a$1c();

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class s$8{constructor(s,t,e,i){this.material=s,this.drawParameters=t,this.geometry=e,this.meta=i;}dispose(){this.material.dispose(),this.geometry.dispose();}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class o$b extends e$1b{constructor(s,t,i,o){super(),this.primitiveType=t,this.parameters=i,this.indexed=o,this.vao=s;}}e$Q([i$11()],o$b.prototype,"vao",void 0);

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
function r$6(r,n){return {near:r,far:n}}function n$a(n){return n?a$8(n,1/0,-1/0):r$6(1/0,-1/0)}function a$8(r,n,a){return r.near=n,r.far=a,r}function t$c(r,n,a=r){return a.near=Math.min(r.near,n.near),a.far=Math.max(r.far,n.far),a}function e$7(r,n){return r.near<=n&&n<=r.far}const f$6={near:0,far:0};

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
function z$2(t,n){const e=n$a(),{eye:o,frustum:r,viewForward:a}=t;for(let f=0;f<n.length;f++){const t=n[f].obb,l=z$u(J$l(E$2,t.center,o),a),u=T$6(t,a);if(e$7(e,l-u)&&e$7(e,l+u))continue;const i=R$2(t,r);if(-1===i)continue;if(0===i){q$2.far=l+u,q$2.near=l-u,t$c(e,q$2);continue}const h=S$3.pushNew();h.near=l-u,h.far=l+u,h.mask=i,h.object=n[f];}for(let f=0;f<S$3.length;f++){const t=S$3.data[f];if(e$7(e,t.near)&&e$7(e,t.far))continue;q$2.far=t.far,q$2.near=1/0;0===M$6(t.object.obb,o,x$3,(n=>{let e=A$1;for(let o=0;o<P$2&&n.length>0;o++){if(0==(t.mask&1<<o))continue;B$3(r[o],n,e);const a=n;n=e,e=a;}for(let t=0;t<n.length;t+=3){o$S(y$3,n.data[t+0],n.data[t+1],n.data[t+2]);const e=z$u(J$l(y$3,y$3,o),a);q$2.near=Math.min(q$2.near,e);}}))&&(q$2.near=0),t$c(e,q$2);}return S$3.length=0,e}const S$3=new n$1h({allocator:t=>t||{near:1/0,far:-1/0,mask:0,object:null},deallocator:t=>(t.object=null,t)}),q$2=n$a(),y$3=n$11(),v$3=n$11(),x$3=new n$1h({deallocator:null}),A$1=new n$1h({deallocator:null});function B$3(t,n,e){e.length=0;const o=n.length-3;F$4(y$3,n,o);const r=R$s(t,y$3);r<=0&&(e.push(y$3[0]),e.push(y$3[1]),e.push(y$3[2]));let a=0,s=r;for(;a<o;a+=3){F$4(v$3,n,a);const o=R$s(t,v$3);if(s*o<0){y$N(y$3,v$3,y$3,o/(o-s)),I$2(e,y$3);}o<=0&&I$2(e,v$3),s=o,r$Z(y$3,v$3);}if(s*r<0){F$4(v$3,n,o);y$N(y$3,v$3,y$3,r/(r-s)),I$2(e,y$3);}}function F$4(t,n,e){return o$S(t,n.data[e+0],n.data[e+1],n.data[e+2])}function I$2(t,n){t.push(n[0]),t.push(n[1]),t.push(n[2]);}function M$6(t,o,a,s){w$I(D$3,t.quaternion),J$l(E$2,o,t.center),P$C(E$2,E$2,D$3);const i=8*((E$2[0]<-t.halfSize[0]?-1:E$2[0]>t.halfSize[0]?1:0)+3*(E$2[1]<-t.halfSize[1]?-1:E$2[1]>t.halfSize[1]?1:0)+9*(E$2[2]<-t.halfSize[2]?-1:E$2[2]>t.halfSize[2]?1:0)+13),h=N$5[i];if(0===h)return h;p$1e(C$1,t.quaternion),f$13(C$1,C$1,t.halfSize);const p=(n,e)=>{const o=N$5[i+e+1];return o$S(n,((1&o)<<1)-1,(2&o)-1,((4&o)>>1)-1),L$u(n,n,C$1),u$S(n,t.center,n)};return a.length=0,I$2(a,p(G$1,0)),I$2(a,p(H$2,1)),I$2(a,p(E$2,2)),I$2(a,p(J$2,3)),s(a),1===h?h:(a.length=0,I$2(a,G$1),I$2(a,J$2),I$2(a,p(E$2,4)),I$2(a,p(K$2,5)),s(a),2===h||(a.length=0,I$2(a,G$1),I$2(a,K$2),I$2(a,p(E$2,6)),I$2(a,H$2),s(a)),h)}const N$5=(()=>{const t=new Int8Array(216);let n=0;const e=e=>{for(let o=0;o<e.length;o++)t[n+o]=e[o];n+=8;};return e([3,0,6,2,3,1,5,4]),e([2,0,2,3,1,5,4,0]),e([3,1,0,2,3,7,5,4]),e([2,0,1,3,2,6,4,0]),e([1,0,1,3,2,0,0,0]),e([2,1,5,7,3,2,0,0]),e([3,2,0,1,3,7,6,4]),e([2,2,0,1,3,7,6,0]),e([3,3,0,1,5,7,6,2]),e([2,0,1,5,4,6,2,0]),e([1,0,1,5,4,0,0,0]),e([2,1,3,7,5,4,0,0]),e([1,0,2,6,4,0,0,0]),e([0,0,0,0,0,0,0,0]),e([1,1,3,7,5,0,0,0]),e([2,2,3,7,6,4,0,0]),e([1,2,3,7,6,0,0,0]),e([2,3,1,5,7,6,2,0]),e([3,4,0,1,5,7,6,2]),e([2,5,7,6,4,0,1,0]),e([3,5,0,1,3,7,6,4]),e([2,4,5,7,6,2,0,0]),e([1,4,5,7,6,0,0,0]),e([2,5,1,3,7,6,4,0]),e([3,6,0,2,3,7,5,4]),e([2,6,2,3,7,5,4,0]),e([3,7,6,2,3,1,5,4]),t})(),P$2=4;function R$2(t,n){let e=0;for(let o=0;o<P$2;o++){const r=H$3(t,n[o]);if(r>0)return -1;0===r&&(e|=1<<o);}return e}const C$1=e$Z(),D$3=e$1a(),E$2=n$11(),G$1=n$11(),H$2=n$11(),J$2=n$11(),K$2=n$11();

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class e$6{constructor(t){this._objects=t;}submit(t,e){this._objects.preSubmit(e);const s=this._objects.visibleObjects;for(let i=0;i<s.length;i++){const e=s[i];e.renderable.material.submit(t,e);}}queryShadowCasterDepthRange(e){return this._objects.visibleObjects.length?z$2(e,this._objects.visibleObjects):null}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
function e$5(e){const r=A$u().vec3f("position");return e.normals&&r.vec2i16("normalCompressed",{glNormalized:!0}),1===e.textureCoordinates?r.vec2f("uv0"):2===e.textureCoordinates&&(r.vec2f("uv0"),r.vec4u16("uvRegion",{glNormalized:!0})),e.colors&&r.vec4u8("color",{glNormalized:!0}),r.alignTo(4)}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
function r$5(r,n){1===n.componentData&&(r.vertex.uniforms.add("uComponentColorTex","sampler2D"),r.vertex.uniforms.add("uComponentColorTexInvDim","vec2"),r.attributes.add("componentIndex","float"),r.varyings.add("vExternalColorMixMode","mediump float"),r.varyings.add("vExternalColor","vec4"),r.include(l$1i),r.vertex.code.add(t$10`vec4 _readComponentColor() {
float normalizedIndex = (componentIndex + 0.5) * uComponentColorTexInvDim.x;
vec2 indexCoord = vec2(
mod(normalizedIndex, 1.0),
(floor(normalizedIndex) + 0.5) * uComponentColorTexInvDim.y
);
return texture2D(uComponentColorTex, indexCoord);
}
vec4 forwardExternalColor(out bool castShadows) {
vec4 componentColor = _readComponentColor() * 255.0;
float shadowFlag = mod(componentColor.b * 255.0, 2.0);
componentColor.b -= shadowFlag;
castShadows = shadowFlag >= 1.0;
int decodedColorMixMode;
vExternalColor = decodeSymbolColor(componentColor, decodedColorMixMode) * 0.003921568627451;
vExternalColorMixMode = float(decodedColorMixMode) + 0.5;
return vExternalColor;
}`),r.fragment.code.add(t$10`void readExternalColor(out vec4 externalColor, out int externalColorMixMode) {
externalColor = vExternalColor;
externalColorMixMode = int(vExternalColorMixMode);
}`)),0===n.componentData&&(r.vertex.uniforms.add("uExternalColor","vec4"),r.fragment.uniforms.add("uExternalColorMixMode","int"),r.varyings.add("vExternalColor","vec4"),r.vertex.code.add(t$10`vec4 forwardExternalColor(out bool castShadows) {
vExternalColor = uExternalColor;
castShadows = true;
return uExternalColor;
}`),r.fragment.code.add(t$10`void readExternalColor(out vec4 externalColor, out int externalColorMixMode) {
externalColor = vExternalColor;
externalColorMixMode = uExternalColorMixMode;
}`));}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
function c$a(c,i){const a=c.vertex;switch(a.code.add(t$10`#define VERTEX_DISCARD_CUTOFF (1.0 - 1.0 / 255.0)`),i.vertexDiscardMode){case 0:a.code.add(t$10`#define vertexDiscardByOpacity(_opacity_) {}`);break;case 2:a.code.add(t$10`#define vertexDiscardByOpacity(_opacity_) { if (_opacity_ >  VERTEX_DISCARD_CUTOFF) {  gl_Position = vec4(1e38, 1e38, 1e38, 1.0); return; } }`);break;case 1:a.code.add(t$10`#define vertexDiscardByOpacity(_opacity_) { if (_opacity_ <= VERTEX_DISCARD_CUTOFF) {  gl_Position = vec4(1e38, 1e38, 1e38, 1.0); return; } }`);}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
function a$7(a,t){a.include(r$1m,t),a.fragment.include(i$1c);const l=a.fragment;l.uniforms.add("uBaseColor","vec4"),l.uniforms.add("uObjectOpacity","float"),t.attributeColor?l.code.add(t$10`vec3 _baseColor() {
return uBaseColor.rgb * vColor.rgb;
}
float _baseOpacity() {
return uBaseColor.a * vColor.a;
}`):l.code.add(t$10`vec3 _baseColor() {
return uBaseColor.rgb;
}
float _baseOpacity() {
return uBaseColor.a;
}`),l.code.add(t$10`vec4 computeMaterialColor(vec4 textureColor, vec4 externalColor, int externalColorMixMode) {
vec3 baseColor = _baseColor();
float baseOpacity = _baseOpacity();
vec3 color = mixExternalColor(
baseColor,
textureColor.rgb,
externalColor.rgb,
externalColorMixMode
);
float opacity = uObjectOpacity * mixExternalOpacity(
baseOpacity,
textureColor.a,
externalColor.a,
externalColorMixMode
);
return vec4(color, opacity);
}`);}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
function d$6(d,a){const i=d.fragment;0===a.doubleSidedMode?i.code.add(t$10`vec3 _adjustDoublesided(vec3 normal) {
return normal;
}`):1===a.doubleSidedMode?(d.include(d$18,a),i.uniforms.add("uTransform_ViewFromCameraLocal_T","vec3"),i.code.add(t$10`vec3 _adjustDoublesided(vec3 normal) {
vec3 viewDir = vPositionWorldCameraRelative + uTransform_ViewFromCameraLocal_T;
return dot(normal, viewDir) > 0.0 ? -normal : normal;
}`)):2===a.doubleSidedMode&&i.code.add(t$10`vec3 _adjustDoublesided(vec3 normal) {
return gl_FrontFacing ? normal : -normal;
}`),0===a.normalType||1===a.normalType?(d.include(l$1d,a),i.code.add(t$10`vec3 shadingNormalWorld() {
return _adjustDoublesided(normalize(vNormalWorld));
}
vec3 shadingNormal_view() {
vec3 normal = normalize(vNormalView);
return gl_FrontFacing ? normal : -normal;
}`)):3===a.normalType?(d.extensions.add("GL_OES_standard_derivatives"),d.include(d$18,a),i.code.add(t$10`vec3 shadingNormalWorld() {
return normalize(cross(
dFdx(vPositionWorldCameraRelative),
dFdy(vPositionWorldCameraRelative)
));
}
vec3 shadingNormal_view() {
return normalize(cross(dFdx(vPosition_view),dFdy(vPosition_view)));
}`)):2===a.normalType&&(1===a.viewingMode?(d.include(d$18,a),i.code.add(t$10`vec3 shadingNormalWorld() {
return normalize(positionWorld());
}`)):2===a.viewingMode&&i.code.add(t$10`vec3 shadingNormalWorld() {
return vec3(0.0, 0.0, 1.0);
}`),d.extensions.add("GL_OES_standard_derivatives"),i.code.add(t$10`vec3 shadingNormal_view() {
return normalize(cross(dFdx(vPosition_view),dFdy(vPosition_view))).xyz;
}`));}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
function t$b(t,u){const a=t.fragment;u.baseColorTexture?(t.include(u$1f,u),a.uniforms.add("uBaseColorTexture","sampler2D"),a.uniforms.add("uBaseColorTextureSize","vec2"),2===u.attributeTextureCoordinates?(t.include(t$1s),a.code.add(t$10`vec4 readBaseColorTexture() {
return textureAtlasLookup(
uBaseColorTexture,
uBaseColorTextureSize,
vuv0,
vuvRegion
);
}`)):a.code.add(t$10`vec4 readBaseColorTexture() {
return texture2D(uBaseColorTexture, vuv0);
}`)):a.code.add(t$10`vec4 readBaseColorTexture() { return vec4(1.0); }`);}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
const S$2=new Map([["position",0],["normal",1],["normalCompressed",1],["color",2],["uv0",3],["uvRegion",4],["componentIndex",5]]);function j$3(S){const j=new n$15;j.include(d$18,S),j.include(l$1d,S),j.include(r$1m,S),j.include(t$1t,S),j.include(a$1g,S),j.include(r$5,S),j.include(r$1v,S),j.include(c$$,S),j.include(t$b,S),j.include(c$a,S),j.fragment.uniforms.add("view","mat4"),1!==S.pbrMode&&2!==S.pbrMode||(j.include(r$1w,S),S.hasNormalTexture&&j.include(n$1y,S)),3===S.output&&1===S.componentData?j.vertex.code.add(t$10`#define discardShadows(castShadows) { if(!castShadows) { gl_Position = vec4(1e38, 1e38, 1e38, 1.0); return; } }`):j.vertex.code.add(t$10`#define discardShadows(castShadows) {}`);const N=S.overlayEnabled&&0===S.output&&4===S.pbrMode;return S.overlayEnabled&&(j.include(a$c,S),1===S.viewingMode?j.vertex.code.add(t$10`
      const float invEllipsoidRadius = ${t$10.float(1/(1===S.ellipsoidMode?s$R.radius:2===S.ellipsoidMode?t$1u.radius:e$1c.radius))};
      vec2 projectOverlay(vec3 pos) {
        return pos.xy / (1.0 + invEllipsoidRadius * pos.z);
      }
      `):j.vertex.code.add(t$10`vec2 projectOverlay(vec3 pos) { return pos.xy; }`)),N&&(j.varyings.add("tbnTangent","vec3"),j.varyings.add("tbnBiTangent","vec3"),j.varyings.add("groundNormal","vec3"),j.varyings.add("positionView","vec3")),j.vertex.code.add(t$10`
    void main() {
      bool castShadows;
      vec4 externalColor = forwardExternalColor(castShadows);
      discardShadows(castShadows);

      vertexDiscardByOpacity(externalColor.a);

      if (externalColor.a < ${t$10.float(o$10)}) {
        // Discard this vertex
        gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
        return;
      }
      forwardPosition();
      forwardNormal();
      ${N?t$10`
        positionView = position_view();
        ${1===S.viewingMode?t$10`
        groundNormal = normalize(positionWorld());
        tbnTangent = normalize(cross(vec3(0.0, 0.0, 1.0), groundNormal));
        tbnBiTangent = normalize(cross(groundNormal, tbnTangent));`:t$10`
        groundNormal = vec3(0.0, 0.0, 1.0);
        tbnTangent = vec3(1.0, 0.0, 0.0);
        tbnBiTangent = normalize(cross(groundNormal, tbnTangent));`}
        `:""}

      ${S.overlayEnabled?t$10`setOverlayVTC(projectOverlay(position));`:""}
      forwardTextureCoordinates();
      forwardVertexColor();
      forwardLinearDepth(); // depends on forwardPosition()
    }
  `),7===S.output&&(j.fragment.include(a$15),S.multipassTerrainEnabled&&j.include(r$1j,S),j.include(a$7,S),j.fragment.code.add(t$10`
      void main() {
        discardBySlice(vPositionWorldCameraRelative);
        ${S.multipassTerrainEnabled?t$10`terrainDepthTest(gl_FragCoord, vPosition_view.z);`:""}

        vec4 textureColor = readBaseColorTexture();
        discardOrAdjustAlpha(textureColor);

        vec4 externalColor;
        int externalColorMixMode;
        readExternalColor(externalColor, externalColorMixMode);

        vec4 materialColor = computeMaterialColor(
          textureColor,
          externalColor,
          externalColorMixMode
        );
        ${S.overlayEnabled?t$10`
        vec4 overlayColorOpaque = getOverlayColor(ovColorTex, vtcOverlay);
        vec4 overlayColor = overlayOpacity * overlayColorOpaque;
        materialColor = materialColor * (1.0 - overlayColor.a) + overlayColor;`:""}

        gl_FragColor = vec4(materialColor.a);
      }
    `)),0===S.output&&(j.fragment.include(a$15),S.multipassTerrainEnabled&&j.include(r$1j,S),j.include(a$7,S),j.include(d$6,S),j.include(l$1b,S),N&&j.fragment.uniforms.add("ovNormalTex","sampler2D"),S.receiveShadows?(j.include(t$1l,S),j.fragment.code.add(t$10`float evaluateShadow() {
return readShadowMap(vPositionWorldCameraRelative, linearDepth);
}`)):j.fragment.code.add(t$10`float evaluateShadow() { return 0.0; }`),j.fragment.code.add(t$10`
      void main() {
        discardBySlice(vPositionWorldCameraRelative);
        ${S.multipassTerrainEnabled?t$10`terrainDepthTest(gl_FragCoord, vPosition_view.z);`:""}

        vec4 textureColor = readBaseColorTexture();
        discardOrAdjustAlpha(textureColor);

        vec4 externalColor;
        int externalColorMixMode;
        readExternalColor(externalColor, externalColorMixMode);

        vec4 materialColor = computeMaterialColor(
          textureColor,
          externalColor,
          externalColorMixMode
        );
        ${S.overlayEnabled?t$10`
        vec4 overlayColorOpaque = getOverlayColor(ovColorTex, vtcOverlay);
        vec4 overlayColor = overlayOpacity * overlayColorOpaque;
        materialColor = materialColor * (1.0 - overlayColor.a) + overlayColor;`:""}
    `),1===S.pbrMode||2===S.pbrMode?(j.fragment.code.add(t$10`
        ${1===S.pbrMode?t$10`
        applyPBRFactors();
        if (int(externalColorMixMode) == 3) {
          mrr = vec3(0.0, 0.6, 0.2);
        }`:""}
        vec3 normalVertex = shadingNormalWorld();
        float additionalIrradiance = 0.02 * lightingMainIntensity[2];
      `),S.hasNormalTexture?j.fragment.code.add(t$10`mat3 tangentSpace = computeTangentSpace(normalVertex, vPositionWorldCameraRelative, vuv0);
vec3 shadingNormal = computeTextureNormal(tangentSpace, vuv0);`):j.fragment.code.add(t$10`vec3 shadingNormal = normalVertex;`),j.fragment.code.add(t$10`${1===S.viewingMode?t$10`vec3 normalGround = normalize(positionWorld());`:t$10`vec3 normalGround = vec3(0.0, 0.0, 1.0);`}
      `),j.fragment.code.add(t$10`vec3 viewDir = normalize(vPositionWorldCameraRelative);
float ssao = 1.0 - occlusion * (1.0 - evaluateAmbientOcclusion());
vec3 additionalLight = evaluateAdditionalLighting(ssao, positionWorld());
vec4 shadedColor = vec4(evaluateSceneLightingPBR(shadingNormal, materialColor.rgb, evaluateShadow(), ssao, additionalLight, viewDir, normalGround, mrr, emission, additionalIrradiance), materialColor.a);`)):(S.receiveShadows?j.fragment.code.add(t$10`float shadow = evaluateShadow();`):1===S.viewingMode?j.fragment.code.add(t$10`float additionalAmbientScale = additionalDirectedAmbientLight(positionWorld());
float shadow = lightingGlobalFactor * (1.0 - additionalAmbientScale);`):j.fragment.code.add(t$10`float shadow = 0.0;`),j.fragment.code.add(t$10`
      float ambientOcclusion = evaluateAmbientOcclusion();
      // At global scale we create some additional ambient light based on the main light to simulate global illumination
      vec3 additionalLight = evaluateAdditionalLighting(ambientOcclusion, positionWorld());
      vec4 shadedColor = vec4(evaluateSceneLighting(shadingNormalWorld(), materialColor.rgb, shadow, ambientOcclusion, additionalLight), materialColor.a);
      ${N?t$10`
          vec4 overlayWaterMask = getOverlayColor(ovNormalTex, vtcOverlay);
          float waterNormalLength = length(overlayWaterMask);
          if (waterNormalLength > 0.95) {
            mat3 tbnMatrix = mat3(tbnTangent, tbnBiTangent, groundNormal);
            vec4 waterOverlayColor = vec4(overlayColorOpaque.xyz, overlayColor.w);
            vec4 waterColorLinear = getOverlayWaterColor(overlayWaterMask, waterOverlayColor, -normalize(vPositionWorldCameraRelative), shadow, groundNormal, tbnMatrix, positionView);
            vec4 waterColorNonLinear = delinearizeGamma(vec4(waterColorLinear.xyz, 1.0));
            // un-gamma the ground color to mix in linear space
            shadedColor = mix(shadedColor, waterColorNonLinear, waterColorLinear.w);
          }`:""}
      `)),j.fragment.code.add(t$10`
        gl_FragColor = highlightSlice(shadedColor, vPositionWorldCameraRelative);
        ${S.OITEnabled?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""}
      }
    `)),1!==S.output&&3!==S.output||(j.include(e$14,S),j.fragment.code.add(t$10`void main() {
discardBySlice(vPositionWorldCameraRelative);
vec4 textureColor = readBaseColorTexture();
discardOrAdjustAlpha(textureColor);
outputDepth(linearDepth);
}`)),2===S.output&&(j.include(d$6,S),j.fragment.code.add(t$10`
      void main() {
        discardBySlice(vPositionWorldCameraRelative);

        vec4 textureColor = readBaseColorTexture();
        discardOrAdjustAlpha(textureColor);

        // note: the alpha component needs to be 1.0 in order for this material
        // to influence ambient occlusion, see the ssao fragment shader
        float alpha = ${2===S.normalType?"0.0":"1.0"};
        gl_FragColor = vec4(vec3(.5) + .5 * shadingNormal_view(), alpha);
      }
    `)),4===S.output&&(j.include(r$1g),j.fragment.code.add(t$10`
      void main() {
        discardBySlice(vPositionWorldCameraRelative);

        vec4 textureColor = readBaseColorTexture();
        discardOrAdjustAlpha(textureColor);

        ${S.overlayEnabled?t$10`
        vec4 overlayColor = getCombinedOverlayColor();

        if (overlayColor.a == 0.0) {
          gl_FragColor = vec4(0.0);
          return;
        }`:""}

        outputHighlight();
      }
    `)),j}var N$4=Object.freeze({__proto__:null,attributeLocations:S$2,build:j$3});

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class O$1 extends t$11{bindPass(e){const o=this.program;d$18.bindViewProjTransform(o,e.viewTransform),r$1u(this.program,this.configuration,e.slicePlane),0===e.identifier&&(void 0!==e.ssrParams&&i$n(this.program,e.ssrParams),o.setUniformMatrix3fv("uTransformNormal_ViewFromGlobal",e.transformNormal_ViewFromGlobal),2===e.subPass&&o.setUniform2fv("cameraNearFar",e.cameraNearFar),0===e.subPass&&e.lighting.setUniforms(this.program,e.integratedMesh)),1===e.identifier&&this.program.setUniform2fv("cameraNearFar",e.cameraNearFar);}bindMaterial(e,r){const t=this.program;t.setUniform4fv("uBaseColor",e.baseColor),t.setUniform1f("uObjectOpacity",e.objectOpacity),t.setUniform1f("textureAlphaCutoff",e.alphaCutoff),1===e.componentParameters.type?e.componentParameters.texture.bind(t,"uComponentColorTex","uComponentColorTexInvDim"):(t.setUniform4fv("uExternalColor",e.componentParameters.externalColor),t.setUniform1i("uExternalColorMixMode",e.componentParameters.externalColorMixMode)),r$Y(e.baseColorTexture)&&e.baseColorTexture.bind(t,"uBaseColorTexture","uBaseColorTextureSize"),0!==this.configuration.output&&7!==this.configuration.output||(a$1o(this.program,e,this.configuration.isSchematic),r$Y(e.metallicRoughnessTexture)&&e.metallicRoughnessTexture.bind(t,"texMetallicRoughness","texMetallicRoughnessSize"),r$Y(e.emissionTexture)&&e.emissionTexture.bind(t,"texEmission","texEmissionSize"),r$Y(e.occlusionTexture)&&e.occlusionTexture.bind(t,"texOcclusion","texOcclusionSize"),r$Y(e.normalTexture)&&e.normalTexture.bind(t,"normalTexture","normalTextureSize")),e.isIntegratedMesh&&(0===r.identifier&&0===r.subPass?(t.bindTexture(e.overlayColor,"ovColorTex"),t.bindTexture(e.overlayNormal,"ovNormalTex")):2===r.identifier&&t.bindTexture(e.overlayHighlight,"ovColorTex"),t.setUniform1f("overlayOpacity",1)),2===r.identifier&&g$V(this.program,r),0===r.identifier&&0===r.subPass&&(r.ambientOcclusionEnabled&&r.bindAmbientOcclusion(t),r.shadowsEnabled&&r.bindShadowMap(t)),0!==r.identifier||0!==r.subPass&&1!==r.subPass||!r.multipassTerrainParams.multipassTerrainEnabled||(this.program.setUniform2fv("cameraNearFar",r.cameraNearFar),t.setUniform2fv("inverseViewport",r.inverseViewport),r.multipassTerrainParams.terrainLinearDepthTexture&&t.bindTexture(r.multipassTerrainParams.terrainLinearDepthTexture,"terrainDepthTexture"));}bindDraw(e,o){if(d$18.bindModelTransform(this.program,e),this.program.setUniformMatrix3fv("uTransformNormal_GlobalFromModel",e.transformNormal_GlobalFromModel),this.program.rebindTextures(),o.isIntegratedMesh){const r=o.overlayTexScale,t=o.overlayTexOffset;this.program.setUniform4fv("overlayTexOffset",[e.toMapSpace[0]*r[0]+t[0],e.toMapSpace[1]*r[1]+t[1],e.toMapSpace[0]*r[2]+t[2],e.toMapSpace[1]*r[3]+t[3]]),this.program.setUniform4fv("overlayTexScale",[e.toMapSpace[2]*r[0],e.toMapSpace[3]*r[1],e.toMapSpace[2]*r[2],e.toMapSpace[3]*r[3]]);}}initializeProgram(e){const o=O$1.shader.get(),r=this.configuration,t=o.build({multipassTerrainEnabled:r.multipassTerrainEnabled,cullAboveGround:r.cullAboveGround,OITEnabled:0===r.transparencyPassType,output:r.output,normalType:0===r.integratedMeshMode?r.hasNormals?1:3:2,attributeColor:r.hasVertexColors,attributeTextureCoordinates:r.vertexTextureCoordinates,componentData:r.componentData,alphaDiscardMode:r.alphaDiscardMode,baseColorTexture:r.baseColorTexture,doubleSidedMode:r.doubleSidedMode,receiveAmbientOcclusion:r.receiveAmbientOcclusion,receiveShadows:r.receiveShadows,slicePlaneEnabled:r.slicePlaneEnabled,sliceHighlightDisabled:!1,sliceEnabledForVertexPrograms:!1,viewingMode:e.viewingMode,vertexDiscardMode:r.vertexDiscardMode,pbrMode:3===r.integratedMeshMode?4:r.usePBR?r.isSchematic?2:1:0,hasMetalnessAndRoughnessTexture:r.hasMetalnessAndRoughnessTexture,hasEmissionTexture:r.hasEmissionTexture,hasOcclusionTexture:r.hasOcclusionTexture,hasNormalTexture:r.hasNormalTexture,vertexTangents:!1,supportsTextureAtlas:!0,doublePrecisionRequiresObfuscation:o$1e(e.rctx),overlayEnabled:2===r.integratedMeshMode||3===r.integratedMeshMode,ssrEnabled:r.ssrEnabled,highStepCount:!1,ellipsoidMode:r.ellipsoidMode});return new n$16(e.rctx,t,o.attributeLocations)}setPipelineState(e){const o=this.configuration,r=0!==o.integratedMeshMode,t=3===e,s=2===e;return g$S({blending:0!==o.output&&7!==o.output||!o.blendingEnabled?null:t?u$$:c$11(e),culling:s$16(o.cullFace),depthTest:{func:a$1d(e)},depthWrite:t||s?l$$:null,colorWrite:r$13,stencilWrite:r||o.sceneHasOcludees?f$T:null,stencilTest:r?o$1f(1):o.sceneHasOcludees?c$15:null,polygonOffset:t||s?o.polygonOffsetEnabled?{factor:2,units:2}:null:i$$})}initializePipeline(){return this.setPipelineState(this.configuration.transparencyPassType)}}O$1.shader=new t$12(N$4,(()=>import('./ComponentShader.glsl-b7210229.js')));class j$2 extends d$18.ModelTransform{constructor(){super(...arguments),this.transformNormal_GlobalFromModel=e$Z(),this.toMapSpace=n$1a();}}class N$3 extends e$S{constructor(){super(...arguments),this.output=0,this.hasVertexColors=!1,this.hasNormals=!1,this.vertexTextureCoordinates=0,this.componentData=0,this.slicePlaneEnabled=!1,this.cullFace=2,this.baseColorTexture=!1,this.receiveAmbientOcclusion=!0,this.receiveShadows=!0,this.vertexDiscardMode=0,this.doubleSidedMode=2,this.blendingEnabled=!0,this.alphaDiscardMode=1,this.integratedMeshMode=0,this.ssrEnabled=!1,this.polygonOffsetEnabled=!1,this.usePBR=!1,this.isSchematic=!1,this.hasMetalnessAndRoughnessTexture=!1,this.hasEmissionTexture=!1,this.hasOcclusionTexture=!1,this.hasNormalTexture=!1,this.sceneHasOcludees=!1,this.transparencyPassType=3,this.ellipsoidMode=1,this.multipassTerrainEnabled=!1,this.cullAboveGround=!1;}}e$Q([r$12({count:8})],N$3.prototype,"output",void 0),e$Q([r$12()],N$3.prototype,"hasVertexColors",void 0),e$Q([r$12()],N$3.prototype,"hasNormals",void 0),e$Q([r$12({count:3})],N$3.prototype,"vertexTextureCoordinates",void 0),e$Q([r$12({count:2})],N$3.prototype,"componentData",void 0),e$Q([r$12()],N$3.prototype,"slicePlaneEnabled",void 0),e$Q([r$12({count:3})],N$3.prototype,"cullFace",void 0),e$Q([r$12()],N$3.prototype,"baseColorTexture",void 0),e$Q([r$12()],N$3.prototype,"receiveAmbientOcclusion",void 0),e$Q([r$12()],N$3.prototype,"receiveShadows",void 0),e$Q([r$12({count:3})],N$3.prototype,"vertexDiscardMode",void 0),e$Q([r$12({count:3})],N$3.prototype,"doubleSidedMode",void 0),e$Q([r$12()],N$3.prototype,"blendingEnabled",void 0),e$Q([r$12({count:4})],N$3.prototype,"alphaDiscardMode",void 0),e$Q([r$12({count:4})],N$3.prototype,"integratedMeshMode",void 0),e$Q([r$12()],N$3.prototype,"ssrEnabled",void 0),e$Q([r$12()],N$3.prototype,"polygonOffsetEnabled",void 0),e$Q([r$12()],N$3.prototype,"usePBR",void 0),e$Q([r$12()],N$3.prototype,"isSchematic",void 0),e$Q([r$12()],N$3.prototype,"hasMetalnessAndRoughnessTexture",void 0),e$Q([r$12()],N$3.prototype,"hasEmissionTexture",void 0),e$Q([r$12()],N$3.prototype,"hasOcclusionTexture",void 0),e$Q([r$12()],N$3.prototype,"hasNormalTexture",void 0),e$Q([r$12()],N$3.prototype,"sceneHasOcludees",void 0),e$Q([r$12({count:4})],N$3.prototype,"transparencyPassType",void 0),e$Q([r$12({count:4})],N$3.prototype,"ellipsoidMode",void 0),e$Q([r$12()],N$3.prototype,"multipassTerrainEnabled",void 0),e$Q([r$12()],N$3.prototype,"cullAboveGround",void 0);

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class t$a{constructor(){this._dirty=!0;}_setDirty(){this._dirty=!0;}_setClean(){if(this._dirty=!1,null!=this._parameterBlocks)for(const t of this._parameterBlocks)this[t]._setClean();}get dirty(){return this._dirty||this._checkParameterBlocksDirty()}_checkParameterBlocksDirty(){if(null==this._parameterBlocks)return !1;for(const t of this._parameterBlocks)if(this[t].dirty)return !0;return !1}}class r$4{constructor(){this._dirty=!0;}_setDirty(){this._dirty=!0;}_setClean(){this._dirty=!1;}get dirty(){return this._dirty}}function e$4(t={}){return (r,e)=>{var s;const i=null!=(s=r._parameterCount)?s:0;if(r._parameterCount=i+1,t.vectorOps){const s=t.vectorOps;Object.defineProperty(r,e,{get(){return this[i]},set(t){const r=this[i];if(null==r)this[i]=t;else {if(s.equals(r,t))return;s.copy(r,t);}this._setDirty();}});}else Object.defineProperty(r,e,{get(){return this[i]},set(r){this[i]!==r&&(t.dispose&&this[i]&&this[i].dispose(),this[i]=r,this._setDirty());}});}}function s$7(){return (t,r)=>{var e;const s=null!=(e=t._parameterCount)?e:0;t._parameterCount=s+1,t._parameterBlocks=t._parameterBlocks||[],t._parameterBlocks.push(s),Object.defineProperty(t,r,{get(){return this[s]},set(t){this[s]!==t&&(this[s]=t,this._setDirty());}});}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class x$2 extends t$a{constructor(){super(...arguments),this.baseColor=t$1q(1,1,1,1),this.usePBR=!1,this.hasParametersFromSource=!1,this.mrrFactors=t$13(1,1,.5),this.emissiveFactor=t$13(0,0,0),this.baseColorTexture=null,this.metallicRoughnessTexture=null,this.emissionTexture=null,this.occlusionTexture=null,this.normalTexture=null,this.overlayTexOffset=r$19(-1,-1,-1,-1),this.overlayTexScale=r$19(0,0,0,0),this.overlayColor=null,this.overlayHighlight=null,this.overlayNormal=null,this.objectOpacity=1,this.commonMaterialParameters=new g$1,this.componentParameters=new M$5,this.alphaCutoff=d$Z,this.alphaDiscardMode=1,this.isIntegratedMesh=!1,this.polygonOffsetEnabled=!1,this.ellipsoidMode=1,this.sceneHasOcludees=!1,this._techniqueConfig=new N$3;}dispose(){this._technique=h$U(this._technique),this.baseColorTexture=null,this.metallicRoughnessTexture=null,this.emissionTexture=null,this.occlusionTexture=null,this.normalTexture=null;}getTechnique(e,t,r){const o=this._techniqueConfig;if(o.hasVertexColors=r.colors,o.hasNormals=r.normals,o.vertexTextureCoordinates=r.textureCoordinates,o.usePBR=this.usePBR,o.hasMetalnessAndRoughnessTexture=r$Y(this.metallicRoughnessTexture),o.hasEmissionTexture=r$Y(this.emissionTexture),o.hasOcclusionTexture=r$Y(this.occlusionTexture),o.hasNormalTexture=r$Y(this.normalTexture),o.transparencyPassType=0===t.identifier&&null!=t.transparencyPassType?t.transparencyPassType:3,o.multipassTerrainEnabled=0===t.identifier&&null!=t.multipassTerrainParams&&t.multipassTerrainParams.multipassTerrainEnabled,o.cullAboveGround=0===t.identifier&&null!=t.multipassTerrainParams&&t.multipassTerrainParams.cullAboveGround,o.ellipsoidMode=this.ellipsoidMode,this.dirty){o.componentData=this.componentParameters.type,o.cullFace=this.commonMaterialParameters.cullFace,o.doubleSidedMode=this.commonMaterialParameters.doubleSided?1:0,o.baseColorTexture=r$Y(this.baseColorTexture),o.isSchematic=this.hasParametersFromSource&&!r$Y(this.baseColorTexture);const e=this._computeWhichMaterialPass();o.blendingEnabled=1===e||2===e,o.alphaDiscardMode=this.alphaDiscardMode,o.integratedMeshMode=this.isIntegratedMesh?this.overlayColor?this.overlayNormal?3:2:1:0,o.polygonOffsetEnabled=this.polygonOffsetEnabled,this._setClean();}return o.slicePlaneEnabled=t.slicePlaneEnabled&&this.commonMaterialParameters.slicePlaneEnabled,1===t.identifier?(o.output=3,o.vertexDiscardMode=0):2===t.identifier?(o.output=4,o.vertexDiscardMode=0):(2===this._computeWhichMaterialPass()?o.vertexDiscardMode=t.transparent?2:1:o.vertexDiscardMode=0,o.output=T$4(t.subPass),1===t.subPass&&(o.sceneHasOcludees=t.sceneHasOcludees),0===t.subPass?(o.receiveAmbientOcclusion=t.ambientOcclusionEnabled,o.sceneHasOcludees=t.sceneHasOcludees,o.receiveShadows=t.shadowsEnabled,o.ssrEnabled=t.ssrParams.ssrEnabled):(o.receiveAmbientOcclusion=!1,o.receiveShadows=!1)),this._technique=e.releaseAndAcquire(O$1,o,this._technique),this._technique}submit(e,t){if(0===this.objectOpacity)return;const r=t.renderable.geometry,o=t.components,a=t.renderable.drawParameters,i=t.renderable.meta.cameraDepthSquared,l=o.geometryRanges,n=o.highlightRanges,h=o.defaultShadowMapRanges;switch(this._computeWhichMaterialPass()){case 0:e.materialOpaque.submitDraw(this,r,l,a,i);break;case 1:e.materialTransparent.submitDraw(this,r,l,a,i);break;case 2:e.materialOpaque.submitDraw(this,r,l,a,i),e.materialTransparent.submitDraw(this,r,l,a,i);break;case 3:e.materialIntegratedMesh.submitDraw(this,r,l,a,i),this.overlayHighlight&&e.highlightIntegratedMesh.submitDraw(this,r,l,a,i);}r$Y(e.shadowMap)&&2!==this.componentParameters.castShadows&&e.shadowMap.submitDraw(this,r,l,a,i),r$Y(e.highlight)&&r$Y(n)&&e.highlight.submitDraw(this,r,n,a,i),r$Y(e.highlightShadowMap)&&2!==this.componentParameters.castShadows&&r$Y(n)&&e.highlightShadowMap.submitDraw(this,r,n,a,i),r$Y(e.defaultShadowMap)&&2!==this.componentParameters.castShadows&&r$Y(h)&&e.defaultShadowMap.submitDraw(this,r,h,a,i);}get attributeLocations(){return S$2}_computeWhichMaterialPass(){return this.isIntegratedMesh?3:this.objectOpacity<1?1:0===this.componentParameters.opaqueOverride?0:this.baseColor[3]<1||0===this.alphaDiscardMode||3===this.alphaDiscardMode?1:2===this.componentParameters.transparent?0:0===this.componentParameters.transparent?1:2}}e$Q([e$4({vectorOps:I$C})],x$2.prototype,"baseColor",void 0),e$Q([e$4()],x$2.prototype,"usePBR",void 0),e$Q([e$4()],x$2.prototype,"hasParametersFromSource",void 0),e$Q([e$4({vectorOps:T$x})],x$2.prototype,"mrrFactors",void 0),e$Q([e$4({vectorOps:T$x})],x$2.prototype,"emissiveFactor",void 0),e$Q([e$4({dispose:!0})],x$2.prototype,"baseColorTexture",void 0),e$Q([e$4({dispose:!0})],x$2.prototype,"metallicRoughnessTexture",void 0),e$Q([e$4({dispose:!0})],x$2.prototype,"emissionTexture",void 0),e$Q([e$4({dispose:!0})],x$2.prototype,"occlusionTexture",void 0),e$Q([e$4({dispose:!0})],x$2.prototype,"normalTexture",void 0),e$Q([e$4({vectorOps:{equals:D$s,copy:a$12}})],x$2.prototype,"overlayTexOffset",void 0),e$Q([e$4({vectorOps:{equals:D$s,copy:a$12}})],x$2.prototype,"overlayTexScale",void 0),e$Q([e$4()],x$2.prototype,"overlayColor",void 0),e$Q([e$4()],x$2.prototype,"overlayHighlight",void 0),e$Q([e$4()],x$2.prototype,"overlayNormal",void 0),e$Q([e$4()],x$2.prototype,"objectOpacity",void 0),e$Q([s$7()],x$2.prototype,"commonMaterialParameters",void 0),e$Q([s$7()],x$2.prototype,"componentParameters",void 0),e$Q([e$4()],x$2.prototype,"alphaCutoff",void 0),e$Q([e$4()],x$2.prototype,"alphaDiscardMode",void 0),e$Q([e$4()],x$2.prototype,"isIntegratedMesh",void 0),e$Q([e$4()],x$2.prototype,"polygonOffsetEnabled",void 0),e$Q([e$4()],x$2.prototype,"ellipsoidMode",void 0),e$Q([e$4()],x$2.prototype,"sceneHasOcludees",void 0);class g$1 extends r$4{constructor(){super(...arguments),this.doubleSided=!1,this.cullFace=2,this.slicePlaneEnabled=!0;}}e$Q([e$4()],g$1.prototype,"doubleSided",void 0),e$Q([e$4()],g$1.prototype,"cullFace",void 0),e$Q([e$4()],g$1.prototype,"slicePlaneEnabled",void 0);class M$5 extends r$4{constructor(){super(...arguments),this.externalColor=t$1q(1,1,1,1),this.externalColorMixMode=1,this.castShadows=0;}get transparent(){return this.externalColor[3]<1?0:2}get opaqueOverride(){return 3===this.externalColorMixMode&&1===this.externalColor[3]?0:2}get visible(){return this.externalColor[3]>0?0:2}get type(){return 0}}e$Q([e$4({vectorOps:I$C})],M$5.prototype,"externalColor",void 0),e$Q([e$4()],M$5.prototype,"externalColorMixMode",void 0),e$Q([e$4()],M$5.prototype,"castShadows",void 0);class f$5 extends r$4{constructor(){super(...arguments),this.texture=null,this.transparent=2,this.opaqueOverride=2,this.castShadows=2;}get type(){return 1}}function T$4(e){switch(e){case 0:return 0;case 1:return 7;case 2:return 1;case 3:return 2;case 4:return 8}}e$Q([e$4()],f$5.prototype,"texture",void 0),e$Q([e$4()],f$5.prototype,"transparent",void 0),e$Q([e$4()],f$5.prototype,"opaqueOverride",void 0),e$Q([e$4()],f$5.prototype,"castShadows",void 0);

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class c$9{constructor(s){this._low=n$17(),this._high=n$17(),s&&this.set(s);}get low(){return this._low}get high(){return this._high}set(h){const e=this._low,i=this._high;r$Z(e,h),J$l(i,h,e);}setElements(s,t,e){o$S(n$9,s,t,e),this.set(n$9);}get(s){return u$S(s,this._low,this._high)}getLowScaled(s){return d$O(s,this._low,1)}}const n$9=n$11();

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class e$3{constructor(e){this.maxCount=e,this._nextIndex=0,this.recycledIndices=[];}get activeCount(){return this._nextIndex-this.recycledIndices.length}get availableCount(){return this.recycledIndices.length+this.maxCount-this._nextIndex}acquire(){return this.recycledIndices.length>0?this.recycledIndices.pop():this.availableCount?this._nextIndex++:void 0}release(e){this.recycledIndices.push(e);}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class i$6{constructor(i,s=1){this.rctx=i,this.fieldCount=s,this.textureWidth=4096,this.dirty=!0,this.texture=new r$16(this.rctx,{target:3553,pixelFormat:6408,dataType:5121,samplingMode:9728,wrapMode:33071,width:this.textureWidth,height:1,flipped:!1}),this.data=new x$T(new ArrayBuffer(4*this.textureWidth));}dispose(){this.texture.dispose(),this.texture=void 0,this.data=void 0;}setData(t,e,i,s,r,h){const d=t*this.fieldCount+e;this.dirty=!0,this.data.set(d,0,i),this.data.set(d,1,s),this.data.set(d,2,r),this.data.set(d,3,h);}setDataElement(t,e,i,s){const r=t*this.fieldCount+e;this.dirty=!0,this.data.set(r,i,s);}resizeToFit(e){const i=e*this.fieldCount;if(i>=this.data.count){const e=Math.ceil((i+1)/this.textureWidth)*this.textureWidth,s=new x$T(new ArrayBuffer(4*e));s.typedBuffer.set(this.data.typedBuffer),this.data=s;}}updateTexture(){if(!this.dirty)return;const t=this.texture.descriptor.width,e=this.texture.descriptor.height;this.data.count>t*e&&this.texture.resize(t,this.data.count/t),this.texture.setData(this.data.typedBuffer),this.dirty=!1;}bind(t,e,i){t.bindTexture(this.texture,e),t.setUniform2f(i,1/this.texture.descriptor.width,1/this.texture.descriptor.height);}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
const r$3=65536;class i$5{constructor(i,a=1){this.textureBuffer=new i$6(i,a),this.indexManager=new e$3(r$3);}dispose(){this.textureBuffer.dispose(),this.textureBuffer=void 0;}get availableCount(){return this.indexManager.availableCount}get activeCount(){return this.indexManager.activeCount}acquireIndex(){const e=this.indexManager.acquire();return this.textureBuffer.resizeToFit(e),e}releaseIndex(e){this.indexManager.release(e);}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class r$2{constructor(t,e=1){this.rctx=t,this.fieldCount=e,this.buffers=[];}garbageCollect(){this.buffers=this.buffers.filter((t=>0!==t.activeCount||(t.dispose(),!1)));}destroy(){this.buffers.forEach((t=>t.dispose())),this.buffers=[];}getBuffer(r){for(const t of this.buffers)if(t.availableCount>=r)return t;if(r>r$3)return null;const s=new i$5(this.rctx,this.fieldCount);return this.buffers.push(s),s}updateTextures(){for(const t of this.buffers)t.textureBuffer.updateTexture();}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
const F$3=n$12.getLogger("esri.views.3d.webgl-engine.collections.Component.ComponentObjectCollection");class H$1{constructor(e){this._renderManager=e,this._objects=new s$a,this._renderSubmit=new e$6(this),this._renderManager.register(this._renderSubmit),this._componentBufferManager=new r$2(e.rctx);}dispose(){i$R(0===this._objects.count,"ObjectCollection should be empty upon disposal"),this._componentBufferManager.destroy();}createObject(e){const t=new s$9;return t.toMapSpace=e.toMapSpace.slice(),t.transform=e.transform,t.obb=E$3(e.obb),t.components=new a$a(this._componentBufferManager,e.geometry.componentOffsets),t.renderable=this._createRenderable(e,t.components),t.intersectionGeometry=new u$6(e.geometry.positionData,t.components),this._objects.add(e.visible?t$e:0,t),t}destroyObject(e){const t=e;this._objects.remove(t),t.dispose(),this._notifyDirty();}setObjectVisibility(e,t){const o=e;if(t!==o.visible){const e=t?o.bucketKey|t$e:o.bucketKey&~t$e;this._objects.updateKey(o,e),this._notifyDirty();}}preSubmit(e){const t=e.camera.eye;this._objects.forEach(((e,o)=>{o&t$e&&e.forEach((e=>{const o=x$P(t,e.obb.center);e.renderable.meta.cameraDepthSquared=o;}));}));}getMaterial(e){return e.renderable.material}updateMaterial(e,t){const o=e.renderable.material;t(o),o.dirty&&this._notifyDirty();}setAllComponentVisibilities(e,t){const o=e;o.components.visibility.reset(t),o.components.visibilityDirty(),this._notifyDirty();}forEachVisibleComponent(e,t){return e.components.visibility.forEachComponent(t)}getComponentCount(e){const t=e,o=t.components.visibility.componentCount();return {visible:o,invisible:t.components.count-o}}setComponentData(e,t){const o=e,r=o.renderable.material;if(n$c(t)){const e=o.components,n=e.materialDataBuffer,i=e.materialDataIndices,s={castShadows:!0,pickable:!0,externalColor:n$1B(),externalColorMixMode:1},a=n.textureBuffer,c=new Uint8Array(4),m=new Uint32Array(c.buffer);let l=0,p=0,h=0,f=!1,u=0;for(let o=0;o<e.count;o++)t(o,s),l+=+(s.externalColor[3]<1),p+=+(3===s.externalColorMixMode&&1===s.externalColor[3]),h+=+s.castShadows,n$y(s.externalColor,s.externalColorMixMode,c),c[2]=254&c[2]|+s.castShadows,a.setData(i[o],0,c[0],c[1],c[2],c[3]),f=f||o>0&&u!==m[0],u=m[0],s.pickable!==n$b(e.pickability,o)&&(e.pickability=t$d(e.pickability,e.count,o,s.pickable));f?(r.componentParameters=new f$5,r.componentParameters.castShadows=K$1(h,e.count),r.componentParameters.transparent=K$1(l,e.count),r.componentParameters.opaqueOverride=K$1(p,e.count),r.componentParameters.texture=a,a.updateTexture()):(r.componentParameters=new M$5,r.componentParameters.castShadows=s.castShadows?0:2,r.componentParameters.externalColor=s.externalColor,r.componentParameters.externalColorMixMode=s.externalColorMixMode);}else r.componentParameters=new M$5,r.componentParameters.castShadows=t.castShadows?0:2,r.componentParameters.externalColor=t.externalColor,r.componentParameters.externalColorMixMode=t.externalColorMixMode;this._notifyDirty();}getComponentAabb(e,t,o){return e.intersectionGeometry.getComponentAabb(t,o)}getComponentObb(e){return e.obb}getObjectTransform(e){return e.transform}getComponentPositions(e,t,o){return e.intersectionGeometry.getComponentPositions(t,o)}intersect(e,o,r,n,a,c){const m=e;r$Y(a)&&(a.localOrigin=m.transform.position);const l=u$12(N$2,m.transform.rotationScale);J$l(J$1,o,m.transform.position),J$l(Q$2,r,m.transform.position),L$u(J$1,J$1,l),L$u(Q$2,Q$2,l);const f=o$Z(N$2,l);return m.intersectionGeometry.intersect(J$1,Q$2,n,f,a,c)}addEdges(e,t,o,r){const n=e,{indices:i,positions:s}=n.intersectionGeometry,a=n.components.offsets;return t.addComponentObject(e,n.transform,n.obb.center,s,i,a,o,r)}addComponentHighlight(e,t){const r=e.components;t$17(r.highlightCounts)&&(r.highlightCounts=new Uint32Array(r.count+1));0===r.highlightCounts[t]++&&(r.highlightsDirty(),this._notifyDirty()),r.highlightCounts[r.count]++;}removeComponentHighlight(e,t){const r=e.components;if(t$17(r.highlightCounts))return void F$3.warn("Removing non-existing highlight.");const n=r.highlightCounts[t],i=r.highlightCounts[r.count];if(0!==n){if(n>1)return r.highlightCounts[t]=n-1,void(r.highlightCounts[r.count]=i-1);r.highlightCounts[t]=0,r.highlightsDirty(),this._notifyDirty(),1===i?r.highlightCounts=null:r.highlightCounts[r.count]=i-1;}else F$3.warn("Removing non-existing highlight.");}clearHighlights(e){const o=e.components;r$Y(o.highlightCounts)&&(o.highlightCounts=null,o.highlightsDirty(),this._notifyDirty());}getObjectGPUMemoryUsage(e){return e.renderable.meta.gpuMemoryEstimate}get visibleObjects(){return this._objects.getBucket(t$e)}get performanceInfo(){const e=this._objects.getPerformanceInfo(t$e);return {shown:e.added,hidden:e.removed}}_createRenderable(e,o){const m=this._renderManager.rctx,l=e.geometry,p=l.vertices.layoutParameters,h=h$O.createVertex(m,35044,l.vertices.data),u=o$17(l.indices,(e=>h$O.createIndex(m,35044,e))),b=t$16(e$5(p)),d=new Uint16Array(l.vertices.count);for(let r=0;r<o.count;r++){const e=o.offsets[r],n=o.offsets[r+1],i=o.materialDataIndices[r];if(r$Y(l.indices))for(let t=e;t<n;t++){d[l.indices[t]]=i;}else for(let t=e;t<n;t++)d[t]=i;}const y=h$O.createVertex(m,35044,d.buffer),j=new c$9(e.transform.position),w=n$1z(e.transform.rotationScale);u$12(w,w),o$Z(w,w);const M=new j$2;r$Z(M.worldFromModel_TL,j.low),r$Z(M.worldFromModel_TH,j.high),n$1A(M.worldFromModel_RS,e.transform.rotationScale),n$1A(M.transformNormal_GlobalFromModel,w),a$12(M.toMapSpace,e.toMapSpace);const x=new x$2,_=new f$M(m,x.attributeLocations,{data:b,componentIndices:z$1},{data:h,componentIndices:y},e$12(u)),S=new o$b(_,4,p,r$Y(u)),P={cameraDepthSquared:.5,gpuMemoryEstimate:h.byteSize+y.byteSize+(r$Y(u)?u.byteSize:0)};return new s$8(x,M,S,P)}_notifyDirty(){this._renderManager.notifyDirty();}}const z$1=t$16(A$u().u16("componentIndex"));function K$1(e,t){return e===t?0:0===e?2:1}const N$2=r$1x(),J$1=n$11(),Q$2=n$11();

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
function o$a(o){const t=new n$15;return t.include(o$u),t.fragment.uniforms.add("tex","sampler2D"),0===o.function&&(o.hasOpacityFactor?(t.fragment.uniforms.add("opacity","float"),t.fragment.code.add(t$10`void main() {
gl_FragColor = texture2D(tex, uv) * opacity;
}`)):t.fragment.code.add(t$10`void main() {
gl_FragColor = texture2D(tex, uv);
}`)),3===o.function&&(t.fragment.uniforms.add("overlayIdx","int"),o.hasOpacityFactor&&t.fragment.uniforms.add("opacity","float"),t.fragment.code.add(t$10`
      void main() {
        vec2 overlayUV = overlayIdx == 0 ? vec2(uv.x * 0.5, uv.y) : vec2(uv.x * 0.5+ 0.5, uv.y);
        gl_FragColor = texture2D(tex, overlayUV) ${o.hasOpacityFactor?"* opacity":""};
      }`)),1===o.function&&t.fragment.code.add(t$10`void main() {
gl_FragColor = vec4(1.0 - texture2D(tex, uv).a);
}`),2===o.function&&(t.fragment.uniforms.add("colorTexture","sampler2D"),t.fragment.uniforms.add("alphaTexture","sampler2D"),t.fragment.uniforms.add("frontFaceTexture","sampler2D"),t.fragment.code.add(t$10`void main() {
vec4 srcColor = texture2D(colorTexture, uv);
float srcAlpha = texture2D(alphaTexture, uv).r;
vec4 frontFace = texture2D(frontFaceTexture, uv);
if(srcColor.a <= 1e-5){
discard;
}
gl_FragColor = vec4(mix(srcColor.rgb/srcColor.a, frontFace.rgb, frontFace.a), 1.0 - srcAlpha);
}`)),t}var t$9=Object.freeze({__proto__:null,build:o$a});

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class p$5 extends t$11{initializeProgram(o){const r=p$5.shader.get().build(this.configuration);return new n$16(o.rctx,r,o$X)}initializePipeline(){if(1===this.configuration.function)return g$S({colorWrite:{r:!1,g:!0,b:!1,a:!1}});switch(this.configuration.alphaMode){case 0:return g$S({colorWrite:r$13});case 1:return g$S({blending:e$T(770,1,771,771),colorWrite:r$13});default:return g$S({blending:t$1e(1,771),colorWrite:r$13})}}}p$5.shader=new t$12(t$9,(()=>import('./Compositing.glsl-3b1932db.js')));class d$5 extends e$S{constructor(){super(...arguments),this.function=0,this.alphaMode=0,this.hasOpacityFactor=!1;}}e$Q([r$12({count:4})],d$5.prototype,"function",void 0),e$Q([r$12({count:3})],d$5.prototype,"alphaMode",void 0),e$Q([r$12()],d$5.prototype,"hasOpacityFactor",void 0);

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class a$6{constructor(t,r){this._rctx=t,this._techniqueRepository=r;}dispose(){this._vao=i$S(this._vao);}compositeTransparent(t,r,e,i=1){const a=this._rctx;c$8.alphaMode=1,c$8.function=2,c$8.hasOpacityFactor=1!==i;const n=this._techniqueRepository.acquire(p$5,c$8);a.useProgram(n.program),n.bindPipelineState(a),n.program.bindTexture(t,"colorTexture"),n.program.bindTexture(r,"alphaTexture"),n.program.bindTexture(e,"frontFaceTexture");const p=this.ensureVAO();a.bindVAO(p),a.drawArrays(5,0,r$15(p,"geometry")),n.release();}compositeSpecial(t,r){this.composite(t,0,1,r);}composite(t,r=0,e=1,i=0,a=0){const n=this._rctx;c$8.alphaMode=r,c$8.function=i,c$8.hasOpacityFactor=1!==e;const p=this._techniqueRepository.acquire(p$5,c$8);n.useProgram(p.program),p.bindPipelineState(n),p.program.bindTexture(t,"tex"),c$8.hasOpacityFactor&&p.program.setUniform1f("opacity",e),3===i&&p.program.setUniform1i("overlayIdx",a);const m=this.ensureVAO();n.bindVAO(m),n.drawArrays(5,0,r$15(m,"geometry")),p.release();}ensureVAO(){return t$17(this._vao)&&(this._vao=i$T(this._rctx)),this._vao}}const c$8=new d$5;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
const v$2=1e4,j$1=100,R$1=500,B$2=500,C=.1;function M$4(e,t,r){return F$E(t,e)*(r[1]-r[0])+r[0]}function A(e,t,r){if(t.size<v$2)return U$2.compute(e,t);const i=n$a();return r.forAll((t=>{t.isVisible&&t$c(i,S$1(e,t));})),i}function S$1(t,r){if(!r.isVisible)return;const i=n$a(),n=r.getSpatialQueryAccelerator();return r$Y(n)?y$2(i,t,n):I$1(i,t,r.objects),i}function y$2(e,t,r){const i=t.eye,n=t.viewForward,s=t.frustum,a=e=>e.isVisible,o=r.objectCount;if(o<R$1)a$8(N$1,t.near,Math.min(e.near,t.far)),r.forEachInDepthRange(i,n,1,N$1,((r,i)=>{P$1(e,t,r),N$1.far=e.near,i.setRange(N$1);}),s,a),a$8(N$1,Math.max(e.far,t.near),t.far),r.forEachInDepthRange(i,n,-1,N$1,((r,i)=>{P$1(e,t,r),N$1.near=e.far,i.setRange(N$1);}),s,a);else {const i=Math.max(Math.min(o,B$2),Math.ceil(o*C)),h=r.findClosest(n,1,s,a,i),f=r.findClosest(n,-1,s,a,i);h&&f&&(V$2(e,t,h.boundingVolumeWorldSpace.bounds),V$2(e,t,f.boundingVolumeWorldSpace.bounds));}}function I$1(e,t,r){T$3.clear(),r.forAll((e=>{e.isVisible&&0!==e.getNumGeometryRecords()&&T$3.add(e);})),T$3.empty||(T$3.sort(t),a$8(N$1,t.near,Math.min(e.near,t.far)),T$3.forEachInDepthRange(N$1,1,((r,i)=>{i<e.near&&P$1(e,t,r);})),a$8(N$1,Math.max(e.far,t.near),t.far),T$3.forEachInDepthRange(N$1,-1,((t,r,i)=>{e.far=Math.max(e.far,i);})));}function P$1(e,t,r){if(!r.isVisible)return;if(!R$n(t.frustum,r.boundingVolumeWorldSpace.bounds))return;const n=r.transformation,s=F$2;r.geometryRecords.forEach((r=>{e$V(s,n,r.getShaderTransformation());const a=d$T(s);x$1(e,t,r.geometry.boundingInfo,s,a);}));}function x$1(e,r,i,n,s){if(t$17(i))return;const o=r.eye,h=r.viewForward;I$x(k$2,i.center,n);const c=h[0]*(k$2[0]-o[0])+h[1]*(k$2[1]-o[1])+h[2]*(k$2[2]-o[2]);if(k$2[3]=i.radius*s,!(c-k$2[3]>e.near&&c+k$2[3]<e.far)&&R$n(r.frustum,k$2))if(i.radius>j$1&&i.getChildren()){const t=i.getChildren();for(let i=0;i<8;++i)t[i]&&x$1(e,r,t[i],n,s);}else L$2.unionDepthRangeWithAABB(e,r.viewProjectionMatrix,n,i.bbMin,i.bbMax);}function V$2(e,t,r){const i=t.eye,n=t.viewForward,s=(r[0]-i[0])*n[0]+(r[1]-i[1])*n[1]+(r[2]-i[2])*n[2];e.near=Math.min(e.near,s-r[3]),e.far=Math.max(e.far,s+r[3]);}class _$2{constructor(){this._items=new n$1h({allocator:e=>e||{obj:null,distance:0,near:0,far:0},deallocator:e=>(e.obj=null,e.distance=0,e.near=0,e.far=0,e)});}get length(){return this._items.length}get empty(){return 0===this._items.length}clear(){this._items.clear();}add(e){this._items.pushNew().obj=e;}sort(e){const t=e.eye,r=e.viewForward;this._items.forAll((e=>{const i=e.obj.boundingVolumeWorldSpace.bounds,n=(i[0]-t[0])*r[0]+(i[1]-t[1])*r[1]+(i[2]-t[2])*r[2];e.distance=n,e.near=n-i[3],e.far=n+i[3];})),this._items.sort(((e,t)=>e.distance-t.distance));}forEachInDepthRange(e,t,r){if(1===t)for(let i=0;i<this._items.length;++i){const t=this._items.data[i];t.far<e.near||t.near>e.far||r(t.obj,t.near,t.far);}else for(let i=this._items.length-1;i>=0;--i){const t=this._items.data[i];t.far<e.near||t.near>e.far||r(t.obj,t.near,t.far);}}}class D$2{constructor(){this.view=e$P(),this.viewProj=e$P(),this.frustum=y$B(),this.geometries=[],this.near=[],this.far=[],this.nearCandidates=[],this.farCandidates=[],this.range={near:0,far:0},this.looseRange={near:0,far:0};}compute(e,t){this.reset(),n$18(this.view,e.viewMatrix),e$V(this.viewProj,e.projectionMatrix,this.view),w$v(e.frustum,this.frustum);const r=this.view,s=r[2],a=r[6],o=r[10],h=r[14],f=this.range;let c=0;if(t.forEach((e=>{if(!e.instanceParameters.visible)return;if(!e.castShadow)return;let t;e.hasShaderTransformation?(e.computeBoundingSphere(e.getShaderTransformation(),k$2,1),t=k$2):t=e.boundingSphere;const r=s*t[0]+a*t[1]+o*t[2]+h,i=r-t[3],n=r+t[3];this.geometries[c]=e,this.near[c]=-n,this.far[c]=-i,++c;})),0===this.geometries.length)return f;for(let i=0;i<this.geometries.length;++i)this.near[i]>f.far&&(f.far=this.near[i]),this.near[i]>2&&this.far[i]<f.near&&(f.near=this.far[i]);const u=this.looseRange;u.near=Math.max(.5*f.near,2),u.far=2*f.far;let d=0,g=0;for(let i=0;i<this.geometries.length;++i)this.near[i]<f.near&&(this.near[i]>=u.near?f.near=this.near[i]:this.nearCandidates[d++]=i),this.far[i]>f.far&&(this.far[i]<=u.far?f.far=this.far[i]:this.farCandidates[g++]=i);if(0===this.nearCandidates.length&&0===this.farCandidates.length)return f;this.nearCandidates.sort(((e,t)=>this.near[e]<this.near[t]?-1:this.near[e]>this.near[t]?1:0)),this.farCandidates.sort(((e,t)=>this.far[e]<this.far[t]?1:this.far[e]>this.far[t]?-1:0));for(let i=0;i<this.nearCandidates.length;++i){const e=this.nearCandidates[i];if(this.near[e]<f.near){const t=this.geometries[e],r=t.boundingInfo;this.includeNearBoundingInfoRec(r,t.getShaderTransformation());}}for(let i=0;i<this.farCandidates.length;++i){const e=this.farCandidates[i];if(this.far[e]>f.far){const t=this.geometries[e],r=t.boundingInfo;this.includeFarBoundingInfoRec(r,t.getShaderTransformation());}}return f}reset(){this.geometries.length=0,this.near.length=0,this.far.length=0,this.nearCandidates.length=0,this.farCandidates.length=0,this.range.near=Number.MAX_VALUE,this.range.far=-Number.MAX_VALUE;}includeNearBoundingInfoRec(e,r){if(t$17(e))return;const i=e.getCenter();I$x(k$2,i,r);const n=d$T(r),s=k$2[0],o=k$2[1],h=k$2[2],f=e.getBSRadius()*n,c=this.frustum;if(c[0][0]*s+c[0][1]*o+c[0][2]*h+c[0][3]>f||c[1][0]*s+c[1][1]*o+c[1][2]*h+c[1][3]>f||c[2][0]*s+c[2][1]*o+c[2][2]*h+c[2][3]>f||c[3][0]*s+c[3][1]*o+c[3][2]*h+c[3][3]>f)return;const l=this.view[2]*s+this.view[6]*o+this.view[10]*h+this.view[14],u=l+f;if(!(-(l-f)<2||-u>=this.range.near))if(-u>this.looseRange.near)this.range.near=-u;else {if(f>j$1){const t=e.getChildren();if(void 0!==t){for(let e=0;e<8;++e)void 0!==t[e]&&this.includeNearBoundingInfoRec(t[e],r);return}}L$2.unionDepthRangeWithAABB(this.range,this.viewProj,r,e.getBBMin(),e.getBBMax());}}includeFarBoundingInfoRec(e,r){if(t$17(e))return;let i=e.getBSRadius();const n=e.getCenter();I$x(k$2,n,r);const s=d$T(r),o=k$2[0],h=k$2[1],f=k$2[2];i*=s;const c=this.frustum;if(c[0][0]*o+c[0][1]*h+c[0][2]*f+c[0][3]>i||c[1][0]*o+c[1][1]*h+c[1][2]*f+c[1][3]>i||c[2][0]*o+c[2][1]*h+c[2][2]*f+c[2][3]>i||c[3][0]*o+c[3][1]*h+c[3][2]*f+c[3][3]>i)return;const l=this.view[2]*o+this.view[6]*h+this.view[10]*f+this.view[14]-i;if(!(-l<=this.range.far))if(-l<this.looseRange.far)this.range.far=-l;else {if(i>j$1){const t=e.getChildren();if(void 0!==t){for(let e=0;e<8;++e)void 0!==t[e]&&this.includeFarBoundingInfoRec(t[e],r);return}}L$2.unionDepthRangeWithAABB(this.range,this.viewProj,r,e.getBBMin(),e.getBBMax());}}}class E$1{constructor(){this.modelViewProj=e$P(),this.clipPosition=[n$1a(),n$1a(),n$1a(),n$1a(),n$1a(),n$1a(),n$1a(),n$1a()];}unionDepthRangeWithAABB(e,t,r,n,s){const a=this.modelViewProj;e$V(a,t,r);let o=!1;for(let i=0;i<8;++i){const e=this.clipPosition[i],t=0===i||3===i||4===i||7===i?n[0]:s[0],r=0===i||1===i||4===i||5===i?n[1]:s[1],o=i<4?n[2]:s[2];e[0]=a[0]*t+a[4]*r+a[8]*o+a[12],e[1]=a[1]*t+a[5]*r+a[9]*o+a[13],e[2]=a[2]*t+a[6]*r+a[10]*o+a[14],e[3]=a[3]*t+a[7]*r+a[11]*o+a[15];}for(let i=0;i<12;++i){const t=this.clipPosition[W$2[i][0]],r=this.clipPosition[W$2[i][1]],n=this.clipPosition[W$2[i][2]],s=this.clipTriangle(t,r,n);let a=!0;for(let e=0;e<s.length;++e){if(s[e][3]>=2){a=!1;break}}if(!a){o=!0;for(let t=0;t<s.length;++t){const r=s[t][3];r<e.near&&(e.near=r),r>e.far&&(e.far=r);}}}return o}inside(e,t){return 0===t?e[0]>=-e[3]:1===t?e[1]>=-e[3]:2===t?e[0]<=e[3]:3===t?e[1]<=e[3]:void i$R(!1)}intersect(e,t,r){let i=0;return 0===r?i=(-e[3]-e[0])/(t[0]-e[0]+t[3]-e[3]):1===r?i=(-e[3]-e[1])/(t[1]-e[1]+t[3]-e[3]):2===r?i=(e[3]-e[0])/(t[0]-e[0]-t[3]+e[3]):3===r&&(i=(e[3]-e[1])/(t[1]-e[1]-t[3]+e[3])),j$N(n$1a(),e,t,i)}clipTriangle(e,t,r){let i=[e,t,r];for(let n=0;n<4;++n){const e=i;i=[];for(let t=0;t<e.length;++t){const r=e[t],s=e[(t+1)%e.length];this.inside(s,n)?(this.inside(r,n)||i.push(this.intersect(r,s,n)),i.push(s)):this.inside(r,n)&&i.push(this.intersect(r,s,n));}}return i}}const W$2=[[0,1,3],[2,3,1],[1,5,2],[6,2,5],[5,4,6],[7,6,4],[4,0,7],[3,7,0],[3,2,7],[6,7,2],[4,5,0],[1,0,5]],k$2=_$o(),F$2=e$P(),N$1=n$a(),T$3=new _$2,U$2=new D$2,L$2=new E$1;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
function o$9(){const o=new n$15;return o.attributes.add("position","vec2"),o.vertex.uniforms.add("proj","mat4"),o.vertex.uniforms.add("drawPosition","vec4"),o.varyings.add("vUV","vec2"),o.vertex.code.add(t$10`void main(void) {
vUV = position;
gl_Position = vec4(drawPosition.xy + vec2(position - 0.5) * drawPosition.zw, 0.0, 1.0);
}`),o.fragment.uniforms.add("textureInput","sampler2D"),o.fragment.uniforms.add("textureMask","sampler2D"),o.fragment.uniforms.add("textureOverlay","sampler2D"),o.fragment.uniforms.add("maskEnabled","bool"),o.fragment.uniforms.add("overlayEnabled","bool"),o.fragment.code.add(t$10`const float barrelFactor = 1.1;
vec2 barrel(vec2 uv) {
vec2 uvn = uv * 2.0 - 1.0;
if (uvn.x == 0.0 && uvn.y == 0.0) {
return vec2(0.5, 0.5);
}
float theta = atan(uvn.y, uvn.x);
float r = pow(length(uvn), barrelFactor);
return r * vec2(cos(theta), sin(theta)) * 0.5 + 0.5;
}
void main() {
float mask = maskEnabled ? texture2D(textureMask, vUV).a : 1.0;
vec4 inputColor = texture2D(textureInput, barrel(vUV)) * mask;
vec4 overlayColor = overlayEnabled ? texture2D(textureOverlay, vUV) : vec4(0);
gl_FragColor = overlayColor + (1.0 - overlayColor.a) * inputColor;
}`),o}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
let w$2=class extends p$14{constructor(){super(...arguments),this._handles=new u$T,this._magnifier=null,this._imageSources=null,this._imageLoadTask=null,this._resources=null,this.events=new n$13,this.attributeLocations=new Map([["position",0]]),this.tmpScreenPoint=i$U(),this.tmpRenderPoint=s$18();}get updating(){return t$17(this._imageSources)&&r$Y(this._imageLoadTask)&&!this._imageLoadTask.task.finished}get magnifier(){return this._magnifier}set magnifier(e){if(e===this._magnifier)return;this._handles.removeAll(),this._magnifier=e;const s=()=>{this.updateResourceLoading(),this.events.emit("request-render");};r$Y(this._magnifier)&&this._handles.add(this._magnifier.watch("version",s)),s();}get enabled(){return r$Y(this._validMagnifier)}get _validMagnifier(){return r$Y(this._magnifier)&&this._magnifier.visible&&r$Y(this._magnifier.position)&&this._magnifier.size>0?this._magnifier:null}get factor(){return r$Y(this._magnifier)&&this._magnifier.factor||1}dispose(){this._magnifier=null,this._handles.destroy(),r$Y(this._imageLoadTask)&&(this._imageLoadTask.task.abort(),this._imageLoadTask=null),this.disposeResources();}render(e,s){const t=this._validMagnifier;if(t$17(t))return;const r=s.camera.pixelRatio,a=Math.ceil(r*t.size);if(this.updateResources(e,a),t$17(this._resources))return;const n=this._resources.program;e.useProgram(n);const m=this._resources.textures,u=Math.ceil(1/this.factor*a);m.input.resize(u,u);const p=s.camera.fullWidth,c=s.camera.fullHeight;d$X(t.position,this.tmpScreenPoint);const h=s.camera.screenToRender(this.tmpScreenPoint,this.tmpRenderPoint),d=.5*u,g=.5*u;h[0]=o$R(h[0],d,p-d-1),h[1]=o$R(h[1],g,c-g-1);const f=Math.floor(h[0]-d),_=Math.floor(h[1]-g);n.bindTexture(m.input,"textureInput"),e.gl.copyTexImage2D(m.input.descriptor.target,0,m.input.descriptor.pixelFormat,f,_,u,u,0);const k=t.offset.x*r,v=t.offset.y*r,y=(h[0]+k)/p*2-1,b=(h[1]-v)/c*2-1,T=a/p*2,j=a/c*2;e.bindVAO(this._resources.vao),n.bindTexture(m.overlay,"textureOverlay"),n.bindTexture(m.mask,"textureMask"),n.setUniform4f("drawPosition",y,b,T,j),n.setUniform1i("maskEnabled",t.maskEnabled?1:0),n.setUniform1i("overlayEnabled",t.overlayEnabled?1:0),e.setPipelineState(this._resources.pipelineState),e.drawArrays(5,0,4);}updateResourceLoading(){const e=this._validMagnifier;if(t$17(e))return;const s=e.maskUrl,t=e.overlayUrl;!r$Y(this._imageLoadTask)||this._imageLoadTask.maskUrl===s&&this._imageLoadTask.overlayUrl===t||(this._imageLoadTask.task.abort(),this._imageLoadTask=null,this._imageSources=null),r$Y(this._imageSources)||r$Y(this._imageLoadTask)||(this._imageLoadTask={maskUrl:s,overlayUrl:t,task:G$n((async e=>{const r=t$17(s)||t$17(t)?s$1e(e):null,i=r$Y(s)?t$14(s,{signal:e}):r.then((e=>e.mask)),n=r$Y(t)?t$14(t,{signal:e}):r.then((e=>e.overlay));this._imageSources={mask:await i,overlay:await n},this.disposeResources(),this.events.emit("request-render");}))},this._imageLoadTask.task.promise.then((()=>this.notifyChange("updating")),(()=>this.notifyChange("updating"))));}updateResources(e,s){if(!this.enabled)return void this.disposeResources();if(r$Y(this._resources)){if(this._resources.textures.size!==s){const t=this.createTextureResources(e,s);if(t$17(t))return void this.disposeResources();this.disposeTextureResources(this._resources.textures),this._resources.textures=t;}return}const t=this.createTextureResources(e,s);t$17(t)||(this._resources={textures:t,program:this.createProgram(e),vao:i$T(e,i$1d,this.attributeLocations,0,1),pipelineState:g$S({blending:t$1e(1,771),depthTest:null,depthWrite:null,colorWrite:r$13})});}disposeResources(){t$17(this._resources)||(this.disposeTextureResources(this._resources.textures),this._resources.program.dispose(),this._resources.vao.dispose(),this._resources=null);}disposeTextureResources(e){e.mask.dispose(),e.overlay.dispose(),e.input.dispose();}createTextureResources(e,s){if(t$17(this._imageSources))return null;this._imageSources.overlay.width=s,this._imageSources.overlay.height=s,this._imageSources.mask.width=s,this._imageSources.mask.height=s;const t=new r$16(e,{target:3553,pixelFormat:6408,internalFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9729,flipped:!0,preMultiplyAlpha:!wt$1(this._imageSources.overlay.src)||!f$_(e).svgAlwaysPremultipliesAlpha},this._imageSources.overlay),r=new r$16(e,{target:3553,pixelFormat:6406,internalFormat:6406,dataType:5121,wrapMode:33071,samplingMode:9729,flipped:!0},this._imageSources.mask);return {input:new r$16(e,{target:3553,pixelFormat:6408,internalFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9729,flipped:!1}),mask:r,overlay:t,size:s}}createProgram(e){const s=o$9();return new n$16(e,s,this.attributeLocations)}};e$Q([y$K()],w$2.prototype,"_imageSources",void 0),e$Q([y$K()],w$2.prototype,"_imageLoadTask",void 0),e$Q([y$K({readOnly:!0})],w$2.prototype,"updating",null),w$2=e$Q([n$14("esri/views/3d/webgl-engine/lib/MagnifierHelper")],w$2);

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class t$8{constructor(t,s=.9){this._alpha=.9,this._startTime=0,this._count=0,this._sum=0,this._smooth=0,this._min=0,this._max=0,this._name=t,this._alpha=s,this.reset();}reset(){this._count=0,this._sum=0,this._smooth=0,this._min=1/0,this._max=0;}get name(){return this._name}get count(){return this._count}get average(){return this._count>0?this._sum/this._count:0}get smooth(){return this._smooth}get min(){return this._min}get max(){return this._max}begin(){this._startTime=performance.now();}end(){const t=performance.now()-this._startTime;this._count+=1,this._sum+=t,this._smooth=this._alpha*t+(1-this._alpha)*this._smooth,this._min=Math.min(this._min,t),this._max=Math.max(this._max,t);}toJSON(){return {name:this.name,count:this.count,average:this.average,smooth:this.smooth,min:this.min,max:this.max}}}!function(t){const s=1e3,i={},n={};function h(s){return s in i||(i[s]=new t(s)),i[s]}function o(t){h(t).begin();}function e(t,i=!0){h(t).end();const o=performance.now();i&&(!(t in n)||o>=n[t]+s)&&(m(t),n[t]=o);}function m(t){console.log(h(t).toJSON());}function a(){for(const t in i)m(t);}t.get=h,t.begin=o,t.end=e,t.log=m,t.logAll=a;}(t$8||(t$8={}));var s$6=t$8;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class a$5{constructor(){this.identifier=0,this.transparent=!1,this.integratedMesh=!1,this.viewTransform=new d$18.ViewProjectionTransform,this.transformNormal_ViewFromGlobal=e$Z(),this.cameraNearFar=n$19(),this.inverseViewport=n$19(),this.slicePlane=G$k(),this.slicePlaneEnabled=!0,this.ambientOcclusionEnabled=!0,this.shadowsEnabled=!0,this.sceneHasOcludees=!1,this.transparencyPassType=3;}}class n$8{constructor(){this.identifier=1,this.viewTransform=new d$18.ViewProjectionTransform,this.cameraNearFar=n$19(),this.slicePlane=G$k();}}class o$8{constructor(){this.identifier=2,this.viewTransform=new d$18.ViewProjectionTransform,this.slicePlane=G$k(),this.inverseViewport=n$19(),this.viewport=n$1a();}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class s$5{constructor(e,s,i=0){this._rctx=e,this._techniqueRepository=s,this._sorting=i,this._draws=new n$1h({initialSize:32,allocator:e=>e||{material:null,geometry:null,geometryRanges:null,bindDrawParams:null,depthSquaredHint:0,indexType:0}}),this._passBoundTechniques=new Set,this._previouslyBoundMaterials=new Map,this._previouslyBoundDraw=new Map;}submitDraw(t,s,i,r,a){const n=this._draws.pushNew();n.geometry=s,n.geometryRanges=i,n.material=t,n.bindDrawParams=r,n.depthSquaredHint=a,n.indexType=s.indexed?e$12(s.vao.indexBuffer).indexType:0;}dispatch(e){const t=this._rctx;this._passBoundTechniques.clear(),this._previouslyBoundMaterials.clear(),this._previouslyBoundDraw.clear();let s=null;const r=this._draws.length;for(let a=0;a<r;a++){const r=this._draws.data[a],n=r.geometry,o=r.material.getTechnique(this._techniqueRepository,e,n.parameters);o===s&&3===o.configuration.transparencyPassType||(t.useProgram(o.program),t.setPipelineState(o.pipeline),s=o),this._passBoundTechniques.has(o)||(o.bindPass(e),this._passBoundTechniques.add(o)),t.bindVAO(n.vao),this._previouslyBoundMaterials.get(o)!==r.material&&(o.bindMaterial(r.material,e),this._previouslyBoundMaterials.set(o,r.material)),this._previouslyBoundDraw.get(o)!==r.bindDrawParams&&(o.bindDraw(r.bindDrawParams,r.material,e),this._previouslyBoundDraw.set(o,r.bindDrawParams));const d=r.geometryRanges,l=d.length;if(0!==r.indexType){const e=i$4.get(r.indexType);for(let s=0;s<l;s+=2){const i=d[s],a=d[s+1];t.drawElements(n.primitiveType,a,r.indexType,i*e);}}else for(let e=0;e<l;e+=2){const s=d[e],i=d[e+1];t.drawArrays(n.primitiveType,s,i);}}}prepareSubmit(){this._draws.clear();}finishSubmit(){const e=0===this._sorting?1:-1;this._draws.sort(((t,s)=>{const i=e*(t.depthSquaredHint-s.depthSquaredHint);return 0!==i?i:t.geometry.vao.size-s.geometry.vao.size}));}get count(){return this._draws.length}}const i$4=new Map;i$4.set(5121,1),i$4.set(5123,2),i$4.set(5125,4);

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class b$3{constructor(s,a){this.rctx=s,this.shaderTechniqueRepository=a,this.canRender=!0,this._materialPassParams=new a$5,this._shadowPassParams=new n$8,this._highlightPassParams=new o$8,this._systems=new Set,this._passes=new Array,this._shadowMapPass=this._registerPass(new s$5(s,this.shaderTechniqueRepository)),this.passes={materialOpaque:this._registerPass(new s$5(s,this.shaderTechniqueRepository)),materialTransparent:this._registerPass(new s$5(s,this.shaderTechniqueRepository,1)),materialIntegratedMesh:this._registerPass(new s$5(s,this.shaderTechniqueRepository)),shadowMap:this._shadowMapPass,highlight:this._registerPass(new s$5(s,this.shaderTechniqueRepository)),highlightIntegratedMesh:this._registerPass(new s$5(s,this.shaderTechniqueRepository)),highlightShadowMap:this._registerPass(new s$5(s,this.shaderTechniqueRepository)),defaultShadowMap:this._registerPass(new s$5(s,this.shaderTechniqueRepository))};}register(s){this._systems.add(s);}prepareRender(s){0!==this._systems.size&&(this._passes.forEach((s=>s.prepareSubmit())),this._systems.forEach((a=>a.submit(this.passes,{camera:s}))),this._passes.forEach((s=>s.finishSubmit())),this.shaderTechniqueRepository.frameUpdate());}render(a){if(0===this._systems.size)return !1;if(4===a.slot)switch(this._configure(a),a.pass){case 0:this._materialPassParams.subPass=0,this._configureMaterialColorPass(a),this.passes.materialOpaque.dispatch(this._materialPassParams);break;case 2:this._materialPassParams.subPass=2,this.passes.materialOpaque.dispatch(this._materialPassParams);break;case 3:this._materialPassParams.subPass=3,this.passes.materialOpaque.dispatch(this._materialPassParams);break;case 5:this.passes.highlight.dispatch(this._highlightPassParams);break;case 4:this._shadowMapPass.dispatch(this._shadowPassParams);break;case 7:r$Y(this.passes.highlightShadowMap)&&this.passes.highlightShadowMap.dispatch(this._shadowPassParams);break;case 6:r$Y(this.passes.defaultShadowMap)&&this.passes.defaultShadowMap.dispatch(this._shadowPassParams);}if(6===a.slot)switch(this._configure(a),a.pass){case 0:this._materialPassParams.subPass=0,this._configureMaterialColorPass(a),this.passes.materialTransparent.dispatch(this._materialPassParams);break;case 1:this._materialPassParams.subPass=1,this._configureMaterialColorPass(a),this.passes.materialTransparent.dispatch(this._materialPassParams);break;case 2:this._materialPassParams.subPass=2,this.passes.materialTransparent.dispatch(this._materialPassParams);break;case 3:this._materialPassParams.subPass=3,this.passes.materialTransparent.dispatch(this._materialPassParams);}if(1===a.slot)switch(this._configure(a),a.pass){case 0:this._materialPassParams.subPass=0,this._configureMaterialColorPass(a),this._materialPassParams.ssrParams=a.ssrParams,this.passes.materialIntegratedMesh.dispatch(this._materialPassParams);break;case 2:this._materialPassParams.subPass=2,this.passes.materialIntegratedMesh.dispatch(this._materialPassParams);break;case 3:this._materialPassParams.subPass=3,this.passes.materialIntegratedMesh.dispatch(this._materialPassParams);break;case 5:this.passes.highlightIntegratedMesh.dispatch(this._highlightPassParams);}return !0}notifyDirty(){this.context.requestRender();}slots(){return [4,6,1]}initializeRenderContext(s){this.context=s;}uninitializeRenderContext(){}queryDepthRange(a){const e={near:1/0,far:-1/0};return this._systems.forEach((i=>{const t=i.queryShadowCasterDepthRange(a);r$Y(t)&&t$c(e,t,e);})),e}get shadowCastingEnabled(){return r$Y(this.passes.shadowMap)}set shadowCastingEnabled(s){s?(this._materialPassParams.shadowsEnabled=!0,this.passes.shadowMap=this._shadowMapPass):(this._materialPassParams.shadowsEnabled=!1,this.passes.shadowMap=null);}get screenSpaceReflectionsEnabled(){return r$Y(this._materialPassParams.ssrParams.ssrEnabled)}set screenSpaceReflectionsEnabled(s){this._materialPassParams.ssrParams.ssrEnabled=!!s;}_configureMaterialColorPass(s){this._materialPassParams.bindShadowMap=a=>{s.shadowMap.bind(a);const e=this._materialPassParams.viewTransform;u$S(M$3,e.worldFromView_TL,e.worldFromView_TH),s.shadowMap.bindView(a,M$3);},this._materialPassParams.bindAmbientOcclusion=a=>s.ssaoHelper.bind(a),this._materialPassParams.ambientOcclusionEnabled=!!s.ssaoHelper&&s.ssaoHelper.ready,this._materialPassParams.sceneHasOcludees=s.hasOccludees;}_configure(s){const a=4===s.pass||7===s.pass||6===s.pass?this._shadowPassParams:5===s.pass?this._highlightPassParams:this._materialPassParams;this._updateParameters(s,a);}_updateParameters(s,t){const m=s.camera,P=m.viewInverseTransposeMatrix;o$S(M$3,P[3],P[7],P[11]),y$1.set(M$3),r$Z(t.viewTransform.worldFromView_TH,y$1.high),r$Z(t.viewTransform.worldFromView_TL,y$1.low),a$19(t.viewTransform.viewFromCameraRelative_RS,m.viewMatrix),n$18(t.viewTransform.projFromView,m.projectionMatrix),0===t.identifier?(this._materialPassParams.transparent=6===s.slot,this._materialPassParams.integratedMesh=1===s.slot,this._materialPassParams.lighting=s.scenelightingData,o$Z(T$2,t.viewTransform.viewFromCameraRelative_RS),u$12(t.transformNormal_ViewFromGlobal,T$2),r$18(t.cameraNearFar,m.near,m.far)):1===t.identifier?r$18(t.cameraNearFar,m.near,m.far):2===t.identifier&&(t.highlightDepthTexture=s.highlightDepthTexture,a$12(t.viewport,m.fullViewport)),0!==t.identifier&&2!==t.identifier||(t.inverseViewport[0]=1/m.fullViewport[2],t.inverseViewport[1]=1/m.fullViewport[3]),H$l(s.sliceHelper.plane,t.slicePlane),c$V(t.slicePlane.origin,t.slicePlane.origin,M$3),t.slicePlaneEnabled=s.sliceHelper.isEnabled,this._materialPassParams.transparencyPassType=s.transparencyPassType,this._materialPassParams.multipassTerrainParams=s.multipassTerrainParams;}_registerPass(s){return this._passes.push(s),s}get needsHighlight(){return this.passes.highlight.count>0||this.passes.highlightIntegratedMesh.count>0}}const M$3=n$11(),T$2=e$Z(),y$1=new c$9;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
function t$7(t){const o=new n$15,r=o.vertex.code,l=o.fragment.code;return o.attributes.add("position","vec2"),2===t.highlightStage&&(r.add(t$10`void main() {
gl_Position = vec4(vec2(1.0) - position * 2.0, 0.0, 1.0);
}`),o.fragment.uniforms.add("tex","sampler2D"),o.fragment.uniforms.add("invFramebufferDim","vec2"),l.add(t$10`void main() {
vec2 coord = gl_FragCoord.xy * invFramebufferDim;
vec4 value = texture2D(tex, coord);
float mx = floor(max(value.g, value.b));
gl_FragColor = vec4(ceil(value.r), mx, mx, 1.0);
}`)),0===t.highlightStage&&(o.attributes.add("uv0","vec2"),t.gridOptimization?(o.vertex.uniforms.add("coverageTex","sampler2D"),o.fragment.uniforms.add("blurSize","vec2"),o.varyings.add("blurCoordinate","vec3")):(o.vertex.uniforms.add("blurSize","vec2"),o.varyings.add("blurCoordinates[5]","vec2")),r.add(t$10`
    void main() {
      gl_Position = vec4(position, 0.0, 1.0);
      ${t.gridOptimization?t$10`
      vec4 cov = texture2D(coverageTex, uv0);
      if (cov.r == 0.0) {
        gl_Position = vec4(0.0);
      }
      blurCoordinate = vec3(gl_Position.xy * 0.5 + vec2(0.5), max(cov.g, cov.b));
      `:t$10`
      vec2 uv = position.xy * 0.5 + vec2(0.5);
      blurCoordinates[0] = uv;
      blurCoordinates[1] = uv + blurSize * 1.407333;
      blurCoordinates[2] = uv - blurSize * 1.407333;
      blurCoordinates[3] = uv + blurSize * 3.294215;
      blurCoordinates[4] = uv - blurSize * 3.294215;
          `}
    }`),o.fragment.uniforms.add("tex","sampler2D"),l.add(t$10`
    void main() {
      ${t.gridOptimization?t$10`
          vec2 uv = blurCoordinate.xy;
          vec4 center = texture2D(tex, uv);

          // do not blur if no pixel or all pixels in neighborhood are set
          if (blurCoordinate.z == 1.0) {
            gl_FragColor = center;
          } else {
            vec4 sum = vec4(0.0);
            sum += center * 0.204164;
            sum += texture2D(tex, uv + blurSize * 1.407333) * 0.304005;
            sum += texture2D(tex, uv - blurSize * 1.407333) * 0.304005;
            sum += texture2D(tex, uv + blurSize * 3.294215) * 0.093913;
            sum += texture2D(tex, uv - blurSize * 3.294215) * 0.093913;
            gl_FragColor = sum;
          }`:t$10`
          vec4 sum = vec4(0.0);
          sum += texture2D(tex, blurCoordinates[0]) * 0.204164;
          sum += texture2D(tex, blurCoordinates[1]) * 0.304005;
          sum += texture2D(tex, blurCoordinates[2]) * 0.304005;
          sum += texture2D(tex, blurCoordinates[3]) * 0.093913;
          sum += texture2D(tex, blurCoordinates[4]) * 0.093913;
          gl_FragColor = sum;`}
    }`)),1===t.highlightStage&&(o.varyings.add("uv","vec2"),t.gridOptimization&&(o.attributes.add("uv0","vec2"),o.vertex.uniforms.add("coverageTex","sampler2D")),r.add(t$10`
      void main() {
        ${t.gridOptimization?t$10`
            vec4 cov = texture2D(coverageTex, uv0);
            // if no highlight pixel set in this block, hide block
            if (cov.r == 0.0) {
              gl_Position = vec4(0.0);
              return;
            }`:""}
        gl_Position = vec4(position, 0.0, 1.0);
        uv = position.xy * 0.5 + vec2(0.5);
      }`),o.fragment.uniforms.add("tex","sampler2D"),o.fragment.uniforms.add("origin","sampler2D"),o.fragment.uniforms.add("color","vec4"),o.fragment.uniforms.add("haloColor","vec4"),o.fragment.uniforms.add("outlineSize","float"),o.fragment.uniforms.add("blurSize","float"),o.fragment.uniforms.add("opacities","vec4"),l.add(t$10`void main() {
vec4 blurredHighlightValue = texture2D(tex, uv);
float highlightIntensity = blurredHighlightValue.a;
if (highlightIntensity == 0.0) {
discard;
}
vec4 origin_color = texture2D(origin, uv);
float outlineIntensity;
float fillIntensity;
if (blurredHighlightValue.g > blurredHighlightValue.b) {
outlineIntensity = haloColor.w * opacities[1];
fillIntensity = color.w * opacities[3];
}
else {
outlineIntensity = haloColor.w * opacities[0];
fillIntensity = color.w * opacities[2];
}
float inner = 1.0 - outlineSize / 9.0;
float outer = 1.0 - (outlineSize + blurSize) / 9.0;
float outlineFactor = smoothstep(outer, inner, highlightIntensity);
float fillFactor = any(notEqual(origin_color, vec4(0.0, 0.0, 0.0, 0.0))) ? 1.0 : 0.0;
float intensity = outlineIntensity * outlineFactor * (1.0 - fillFactor) + fillIntensity * fillFactor;
gl_FragColor = vec4(mix(haloColor.rgb, color.rgb, fillFactor), intensity);
}`)),o}var o$7=Object.freeze({__proto__:null,build:t$7});

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
const m$4=8.6,p$4=.4;class g extends t$11{initializeProgram(i){const o=g.shader.get().build(this.configuration);return new n$16(i.rctx,o,o$X)}bindApplyPass(i){this.program.setUniform4fv("color",i.color),this.program.setUniform4fv("haloColor",i.haloColor),this.program.setUniform1f("outlineSize",m$4),this.program.setUniform1f("blurSize",p$4),this.program.setUniform4f("opacities",i.haloOpacity,i.haloOpacityOccluded,i.fillOpacity,i.fillOpacityOccluded);}initializePipeline(){return 1===this.configuration.highlightStage?g$S({blending:e$T(770,1,771,771),colorWrite:r$13}):g$S({colorWrite:r$13})}get primitiveType(){return this.configuration.gridOptimization?4:5}}g.shader=new t$12(o$7,(()=>import('./HighlightComposition.glsl-2ae59842.js')));class d$4 extends e$S{constructor(){super(...arguments),this.highlightStage=0,this.gridOptimization=!1;}}e$Q([r$12({count:3})],d$4.prototype,"highlightStage",void 0),e$Q([r$12()],d$4.prototype,"gridOptimization",void 0);

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
const d$3=32;class b$2{constructor(e,i){this._techniqueRep=e,this._rctx=i,this.viewportToRestore=n$1a(),this.defaultOptions={color:t$1q(1,0,1,1),haloColor:t$1q(1,0,1,1),haloOpacity:1,fillOpacity:.2,haloOpacityOccluded:.25,fillOpacityOccluded:.05,shadowColor:t$1q(1,0,1,1),shadowOpacity:.15,occludedShadowOpacity:.075},this._grid={coverageMipmap:null,vao:null,verticalCellCount:0,horizontalCellCount:0,cellPixelSize:0,mipmapLevels:0,viewportWidth:0,viewportHeight:0};}assertResources(){if(this.quadVAO)return;this.quadVAO=i$T(this._rctx);const e={colorTarget:0,depthStencilTarget:0,width:0,height:0},i={target:3553,pixelFormat:6408,dataType:5121,samplingMode:9729,wrapMode:33071,width:0,height:0};this.blur0Fbo=new o$15(this._rctx,e,i),this.blur1Fbo=new o$15(this._rctx,e,i);const t=new d$4;t.highlightStage=0,t.gridOptimization=!1,this.blurTechnique=this._techniqueRep.acquire(g,t),t.highlightStage=0,t.gridOptimization=!0,this.blurGridTechnique=this._techniqueRep.acquire(g,t),t.highlightStage=1,t.gridOptimization=!1,this.applyTechnique=this._techniqueRep.acquire(g,t),t.highlightStage=1,t.gridOptimization=!0,this.applyGridTechnique=this._techniqueRep.acquire(g,t),t.highlightStage=2,t.gridOptimization=!1,this.downsampleTechnique=this._techniqueRep.acquire(g,t);}dispose(){if(this._grid.coverageMipmap)for(let e=1;e<this._grid.coverageMipmap.length;e++)this._grid.coverageMipmap[e].dispose();this._grid.vao&&this._grid.vao.dispose(!0),this.quadVAO&&(this.quadVAO.dispose(!0),this.quadVAO=null),this.blur0Fbo=i$S(this.blur0Fbo),this.blur1Fbo=i$S(this.blur1Fbo);}get profilingCallback(){return T$k.HIGHLIGHTS_PROFILE_TO_CONSOLE?e=>console.log(e):null}setDefaultOptions(e){this.defaultOptions=e;}render(e,i,r){const o=e.pixelRatio,s=T$k.HIGHLIGHTS_GRID_OPTIMIZATION_ENABLED,l=this._rctx;this.assertResources(),a$12(this.viewportToRestore,e.fullViewport);const h=e.fullWidth,p=e.fullHeight,c=Math.ceil(h/o),g=Math.ceil(p/o);this.blur0Fbo.resize(c,g),this.blur1Fbo.resize(c,g),l.bindVAO(this.quadVAO);let u=null;const n=s?this.blurGridTechnique:this.blurTechnique;n.bindPipelineState(l),l.useProgram(n.program),s?(this._gridUpdateResources(i,d$3),this._gridComputeMipmap(),u=this._grid.vao,n.program.bindTexture(this._grid.coverageMipmap[this._grid.mipmapLevels].colorTexture,"coverageTex")):u=this.quadVAO,l.bindVAO(u),l.bindFramebuffer(this.blur0Fbo),l.setViewport(0,0,c,g),l.setClearColor(0,0,0,0),l.clear(16384),n.program.bindTexture(i.colorTexture,"tex"),n.program.setUniform2f("blurSize",1/c,0),l.drawArrays(n.primitiveType,0,r$15(u,"geometry")),l.bindFramebuffer(this.blur1Fbo),l.clear(16384),n.program.bindTexture(this.blur0Fbo.colorTexture,"tex"),n.program.setUniform2f("blurSize",0,1/g),l.drawArrays(n.primitiveType,0,r$15(u,"geometry"));const b=s?this.applyGridTechnique:this.applyTechnique;if(l.bindFramebuffer(r),b.bindPipelineState(l),l.setViewport(this.viewportToRestore[0],this.viewportToRestore[1],this.viewportToRestore[2],this.viewportToRestore[3]),l.useProgram(b.program),b.program.bindTexture(this.blur1Fbo.colorTexture,"tex"),b.program.bindTexture(i.colorTexture,"origin"),s){const e=this._grid.coverageMipmap[this._grid.mipmapLevels].colorTexture;b.program.bindTexture(e,"coverageTex");}b.bindApplyPass(this.defaultOptions),l.drawArrays(b.primitiveType,0,r$15(u,"geometry")),l.bindVAO(null);}_gridUpdateResources(e,i){const t=this._rctx,r=this._grid;let o=!1;if(null===r.coverageMipmap&&(r.coverageMipmap=[e],o=!0),r.viewportWidth===e.width&&r.viewportHeight===e.height||(o=!0,r.viewportWidth=e.width,r.viewportHeight=e.height),r.coverageMipmap[0]=e,r.cellPixelSize!==i&&(r.cellPixelSize=i,o=!0),o){for(let e=1;e<r.coverageMipmap.length;e++)r.coverageMipmap[e].dispose();r.mipmapLevels=Math.ceil(Math.log(r.cellPixelSize)*Math.LOG2E),r.coverageMipmap.length=r.mipmapLevels+1;for(let e=0;e<r.mipmapLevels;e++){const i=r.coverageMipmap[e],o={target:3553,pixelFormat:6407,dataType:33635,samplingMode:9729,wrapMode:33071,width:Math.ceil(i.width/2),height:Math.ceil(i.height/2)},a={colorTarget:0,depthStencilTarget:0,width:Math.ceil(i.width/2),height:Math.ceil(i.height/2)};r.coverageMipmap[e+1]=new o$15(t,a,o);}}const a=Math.ceil(e.height/r.cellPixelSize),h=Math.ceil(e.width/r.cellPixelSize);if(!r.vao||r.verticalCellCount!==a||r.horizontalCellCount!==h){r.verticalCellCount=a,r.horizontalCellCount=h;const e=a+1,i=h+1,o=1/a,p=1/h,c=6,u=4,m=new Float32Array(c*u*e*i);let d=0;for(let t=0;t<e;t++)for(let e=0;e<i;e++)m[d+0]=(e-.5)*p*2-1,m[d+1]=(t-.5)*o*2-1,m[d+2]=e*p,m[d+3]=t*o,m[d+4]=(e+.5)*p*2-1,m[d+5]=(t-.5)*o*2-1,m[d+6]=e*p,m[d+7]=t*o,m[d+8]=(e-.5)*p*2-1,m[d+9]=(t+.5)*o*2-1,m[d+10]=e*p,m[d+11]=t*o,m[d+12]=(e-.5)*p*2-1,m[d+13]=(t+.5)*o*2-1,m[d+14]=e*p,m[d+15]=t*o,m[d+16]=(e+.5)*p*2-1,m[d+17]=(t-.5)*o*2-1,m[d+18]=e*p,m[d+19]=t*o,m[d+20]=(e+.5)*p*2-1,m[d+21]=(t+.5)*o*2-1,m[d+22]=e*p,m[d+23]=t*o,d+=c*u;r.vao&&r.vao.dispose(!0),r.vao=new f$M(t,o$X,{geometry:s$1c},{geometry:h$O.createVertex(t,35044,m)});}}_gridComputeMipmap(){const e=this._rctx,i=this._grid,t=this.downsampleTechnique.program;this.downsampleTechnique.bindPipelineState(e),e.bindVAO(this.quadVAO),e.useProgram(t);for(let r=0;r<i.mipmapLevels;r++){e.bindFramebuffer(i.coverageMipmap[r+1]),t.bindTexture(i.coverageMipmap[r].colorTexture,"tex");const o=i.coverageMipmap[r+1].width,a=i.coverageMipmap[r+1].height;t.setUniform2f("invFramebufferDim",1/o,1/a),e.setViewport(0,0,o,a),e.drawArrays(5,0,r$15(this.quadVAO,"geometry"));}}getGpuMemoryUsage(){let e=(r$Y(this.blur0Fbo)?this.blur0Fbo.gpuMemoryUsage:0)+(r$Y(this.blur1Fbo)?this.blur1Fbo.gpuMemoryUsage:0);if(this._grid.coverageMipmap)for(const i of this._grid.coverageMipmap)e+=i.gpuMemoryUsage;return e}get test(){return {coverage:this._grid.coverageMipmap,blur:[this.blur0Fbo,this.blur1Fbo]}}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
const s$4={dataType:5121,internalFormat:6408},h$5={};class d$2{constructor(e){this.rctx=e,this._activeTargets=new Set,this._depthTextures=new Map,this._depthBuffers=new Map,this._colorTextures=new Map,this._framebuffers=new Map,this._nextId=1,this.depthTextureSupported=e.capabilities.depthTexture;}dispose(){this._depthBuffers.forEach((e=>e.dispose())),this._depthBuffers.clear(),this._depthTextures.forEach((e=>e.dispose())),this._depthTextures.clear(),this._colorTextures.forEach((e=>e.dispose())),this._colorTextures.clear(),this._framebuffers.forEach((e=>e.dispose())),this._framebuffers.clear();}disposeTargetResource(e){const t=e.id;this._activeTargets.has(t)&&(this._activeTargets.delete(t),this.disposeWithFramebuffers(this._depthTextures,t),this.disposeWithFramebuffers(this._depthBuffers,t),this.disposeWithFramebuffers(this._colorTextures,t));}disposeWithFramebuffers(e,t){const r=e.get(t);r&&(this._framebuffers.forEach(((e,t)=>{e.colorAttachment!==r&&e.depthStencilAttachment!==r||(e.detachAll(),e.dispose(),this._framebuffers.delete(t));})),r.dispose(),e.delete(t));}getDepthTexture(e,t){if(!this.depthTextureSupported)return;let i=this._depthTextures.get(e.id);return i&&(i.descriptor.width===t.width&&i.descriptor.height===t.height||(i.dispose(),i=void 0)),i||(i=new r$16(this.rctx,{target:3553,pixelFormat:34041,dataType:34042,samplingMode:9728,wrapMode:33071,width:t.width,height:t.height}),this._depthTextures.set(e.id,i),this._activeTargets.add(e.id)),i}getAllocatedDepthTexture(e){return this._depthTextures.get(e.id)}getDepthBuffer(e,r){if(this.depthTextureSupported)return;let i=this._depthBuffers.get(e.id);return i?i.descriptor.width===r.width&&i.descriptor.height===r.height||i.resize(r.width,r.height):(i=new e$1d(this.rctx,{internalFormat:34041,...r}),this._depthBuffers.set(e.id,i),this._activeTargets.add(e.id)),i}getColorTexture(e,t){let i=this._colorTextures.get(e.id);return i&&(i.descriptor.width===t.width&&i.descriptor.height===t.height||(i.dispose(),i=void 0)),i||(i=new r$16(this.rctx,{target:3553,pixelFormat:6408,internalFormat:e.internalFormat,dataType:e.dataType,samplingMode:null!=e.samplingMode?e.samplingMode:9729,wrapMode:33071,width:t.width,height:t.height}),this._colorTextures.set(e.id,i),this._activeTargets.add(e.id)),i}getAllocatedColorTexture(e){return this._colorTextures.get(e.id)}registerDepthTarget(e={}){return {id:this._nextId++,...h$5,...e}}registerColorTarget(e={}){return {id:this._nextId++,...s$4,...e}}getFramebuffer(t,r,i){const s=this.getKey(r,i);let h=this._framebuffers.get(s);const d=this.getColorTexture(r,t);if(this.depthTextureSupported){const r=i?this.getDepthTexture(i,t):void 0;if(!h)return h=i?new o$15(this.rctx,{colorTarget:0,depthStencilTarget:4},d,r):new o$15(this.rctx,{colorTarget:0,depthStencilTarget:0},d),this._framebuffers.set(s,h),h;return (h.width!==t.width||h.height!==t.height||h.colorTexture!==d||h.depthStencilTexture!==r)&&(h.detachAll(),h.resize(t.width,t.height),h.attachColorTexture(d),h.attachDepthStencilTexture(r)),h}const o=i?this.getDepthBuffer(i,t):void 0;if(!h)return h=new o$15(this.rctx,{colorTarget:0,depthStencilTarget:i?3:0},d,o),this._framebuffers.set(s,h),h;return (h.width!==t.width||h.height!==t.height||h.colorTexture!==d)&&(h.detachAll(),h.resize(t.width,t.height),h.attachColorTexture(d),h.attachDepthStencilBuffer(o)),h}getKey(e,t){return `${e.id}_${t?t.id:"X"}_${e.name}${t?"_"+t.name:""}`}getGpuMemoryUsage(){let e=0;const t=new Set,r=r=>{t.has(r)||(t.add(r),e+=o$1c(r));};return this._depthTextures.forEach(r),this._colorTextures.forEach(r),this._depthBuffers.forEach(r),e}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class t$6{constructor(t,r){this._rctx=t,this._compositingHelper=r,this._currentRenderTarget=0,this.dimensions={width:4,height:4},this._needLastFrameColorTexture=!1,this._background={type:"color",color:[0,0,0,1]};const i=this._rctx,o="webgl2"===i.webglVersion;this.renderTargetHelper=new d$2(i);const s=this.renderTargetHelper;this.mainColorTarget0=s.registerColorTarget({name:"mainColorTarget0"}),this.mainColorTarget1=s.registerColorTarget({name:"mainColorTarget1"}),this.frontFaceTarget=s.registerColorTarget({name:"frontFaceTarget"});const a=e=>s.registerColorTarget({name:e,dataType:5126,internalFormat:o?34836:6408,samplingMode:9728});this.colorFloatTarget=a("colorFloatTarget"),this.alphaFloatTarget=a("alphaFloatTarget"),this.mainDepth=s.registerDepthTarget({name:"mainDepth"}),this.linearDepth=s.registerColorTarget({name:"linearDepth",samplingMode:9728}),this.terrainLinearDepth=s.registerColorTarget({name:"terrainLinearDepth"}),this.geometryLinearDepth=s.registerColorTarget({name:"geometryLinearDepth"}),this.normal=s.registerColorTarget({name:"normal"}),this.highlight=s.registerColorTarget({name:"highlight",internalFormat:o?32854:6408,dataType:32819}),this.hudVisibility=s.registerColorTarget({name:"hudVisibility",internalFormat:o?32854:6408,dataType:32819}),this.tmpColor=s.registerColorTarget({name:"tmpColor"}),this.tmpDepth=s.registerDepthTarget({name:"tmpDepth"}),this.hudColor=s.registerColorTarget({name:"hudColor"});}dispose(){this.renderTargetHelper.dispose();}get width(){return this.dimensions.width}get height(){return this.dimensions.height}set background(e){this._background=e;}get background(){return this._background}get currentColorTarget(){return 0===this._currentRenderTarget?this.mainColorTarget0:this.mainColorTarget1}get previousColorTarget(){return 0===this._currentRenderTarget?this.mainColorTarget1:this.mainColorTarget0}get currentRenderTarget(){return this._currentRenderTarget}get framebuffer(){return this.getFramebuffer(this.currentColorTarget,this.mainDepth)}getFramebuffer(e,t){return this.renderTargetHelper.getFramebuffer(this.dimensions,e,t)}get colorTexture(){return this.renderTargetHelper.getAllocatedColorTexture(this.currentColorTarget)}get depthTexture(){return this.renderTargetHelper.getAllocatedDepthTexture(this.mainDepth)}get linearDepthTexture(){return this.renderTargetHelper.getAllocatedColorTexture(this.linearDepth)}get terrainLinearDepthTexture(){return this.renderTargetHelper.getAllocatedColorTexture(this.terrainLinearDepth)}get geometryLinearDepthTexture(){return this.renderTargetHelper.getAllocatedColorTexture(this.geometryLinearDepth)}get lastFrameColorTexture(){return this.renderTargetHelper.getAllocatedColorTexture(this.previousColorTarget)}get normalTexture(){return this.renderTargetHelper.getAllocatedColorTexture(this.normal)}get highlightTexture(){return this.renderTargetHelper.getAllocatedColorTexture(this.highlight)}get hudVisibilityTexture(){return this.getColorTexture(this.hudVisibility)}get tmpColorTexture(){return this.getColorTexture(this.tmpColor)}get hudColorTexture(){return this.getColorTexture(this.hudColor)}get mainColorTexture(){return this.getColorTexture(this.currentColorTarget)}advanceCurrentRenderTarget(){this._currentRenderTarget=0===this._currentRenderTarget&&this._needLastFrameColorTexture?1:0;}initializeFrame(e){const t=this._rctx;this.dimensions.width=e.fullWidth,this.dimensions.height=e.fullHeight,this.bindTarget(this.currentColorTarget,this.mainDepth),t.setClearStencil(0);const r=this._background.color;t.setClearColor(r[0]*r[3],r[1]*r[3],r[2]*r[3],r[3]),t.clearSafe(17664);}composite(){this._compositingHelper.composite(this.colorTexture,0);}renderTmpAndCompositeToMain(e,t,i=!1){this.renderToTargets(e,this.tmpColor,i?this.tmpDepth:this.mainDepth,r$1),this._compositingHelper.composite(this.getColorTexture(this.tmpColor),t);}renderHUDVisibility(e,t=!1){this.renderToTargets(e,this.hudVisibility,t?this.tmpDepth:this.mainDepth,i$3);}compositeTransparentTerrainOntoHUDVisibility(){this.renderToTargets((()=>{this._compositingHelper.compositeSpecial(this.getColorTexture(this.tmpColor),1);}),this.hudVisibility,this.tmpDepth);}renderOITPass(e,t,r){let i,o;switch(t){case 0:i=this.colorFloatTarget,o=[0,0,0,0];break;case 1:i=this.alphaFloatTarget,o=[1,1,1,1];break;case 2:i=this.frontFaceTarget,o=[0,0,0,0];}r?this.renderToTargets(e,i,this.tmpDepth,o,!0,!0):this.renderToTargets(e,i,this.mainDepth,o,!1);}compositeTransparentTerrainOntoMain(){this.bindFramebuffer(),this._compositingHelper.composite(this.getColorTexture(this.tmpColor),2);}compositeOccludedOntoMain(e){this.bindFramebuffer(),this._compositingHelper.composite(this.getColorTexture(this.tmpColor),2,e);}compositeTransparentOntoOpaque(e){e?(this.bindTarget(this.hudColor,this.tmpDepth),this._rctx.setClearColor(0,0,0,1e-13),this._rctx.clearSafe(16384)):this.bindFramebuffer(),this._compositingHelper.compositeTransparent(this.getColorTexture(this.colorFloatTarget),this.getColorTexture(this.alphaFloatTarget),this.getColorTexture(this.frontFaceTarget));}bindFramebuffer(){this._rctx.bindFramebuffer(this.framebuffer);}renderDepthDetached(e){this.bindTarget(this.currentColorTarget),e(),this.bindTarget(this.currentColorTarget,this.mainDepth);}disposeTarget(e){this.renderTargetHelper.disposeTargetResource(e);}set needLastFrameColorTexture(e){!e&&this._needLastFrameColorTexture&&(this._currentRenderTarget=0,this.disposeTarget(this.mainColorTarget1)),this._needLastFrameColorTexture=e;}get needLastFrameColorTexture(){return this._needLastFrameColorTexture}renderToTargets(e,t,r,i,o=!1,s=!1){const a=this._rctx,h=this.bindTarget(t,r);let n=0;if(i){const e=1e-13,t=Math.max(e,i[3]);a.setClearColor(i[0],i[1],i[2],t),n|=16384;}return o&&(n|=256),!1===s?s=0:(!0===s&&(s=255),n|=1024),n&&a.clearSafe(n,s),e(),a.gl.flush(),this.bindTarget(this.currentColorTarget,this.mainDepth),h}bindTarget(e,t){const r=this.renderTargetHelper.getFramebuffer(this.dimensions,e,t);return this._rctx.bindFramebuffer(r),r}getColorTexture(e){return this.renderTargetHelper.getColorTexture(e,this.dimensions)}getGpuMemoryUsage(){let e=0;return this.renderTargetHelper&&(e+=this.renderTargetHelper.getGpuMemoryUsage()),e}}const r$1=[0,0,0,0],i$3=[0,1,0,1];

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class n$7{constructor(e){this.context=e,this.renderPlugins=new Array,this.slots=[];for(let t=0;t<23;++t)this.slots[t]=[];}add(t,r,n=null){const s=r.initializeRenderContext(this.context,n),i=()=>{this.renderPlugins.push(r);for(let e=0;e<t.length;++e){const n=t[e];this.slots[n].push(r);}this.context.requestRender();};if(z$z(s))return s.then(i);i();}remove(e){const t=this.renderPlugins.length;this.renderPlugins=this.renderPlugins.filter((t=>t!==e)),i$R(this.renderPlugins.length<t,"Removing non-added render plugin");for(let r=0;r<this.slots.length;++r)this.slots[r]=this.slots[r].filter((t=>t!==e));e.uninitializeRenderContext(),this.context.requestRender();}prepareRender(e,t){for(const r of this.renderPlugins)r.prepareRender&&r.prepareRender(e,t);}render(){const e=this.slots[this.context.renderContext.slot];let t=!1;for(const r of e)r.canRender&&r.render(this.context.renderContext)&&(t=!0);return t}queryDepthRange(e){const r=s$3;r.near=1/0,r.far=-1/0;for(const n of this.renderPlugins)if(n.queryDepthRange){const s=n.queryDepthRange(e);s&&t$c(r,s,r);}return r}get needsHighlight(){return this.renderPlugins.some((e=>e.needsHighlight))}get needsLinearDepth(){return this.renderPlugins.some((e=>e.needsLinearDepth))}get needsLaserlineWithContrastControl(){const e=this.slots[17];return !!e&&e.length>0}get renderOccludedFlags(){let e=0;return this.renderPlugins.forEach((t=>{t.renderOccludedFlags&&(e|=t.renderOccludedFlags);})),e}}const s$3={near:0,far:0};

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
function o$6(o){o.fragment.uniforms.add("projInfo","vec4"),o.fragment.uniforms.add("zScale","vec2"),o.fragment.code.add(t$10`vec3 reconstructPosition(vec2 fragCoord, float depth) {
return vec3((fragCoord * projInfo.xy + projInfo.zw) * (zScale.x * depth + zScale.y), depth);
}`);}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
const i$2=255,l$6=1/i$2;function n$6(n){const m=new n$15;m.fragment.include(a$16),m.fragment.include(a$15),m.include(o$6),m.include(o$u);const{pass:p}=n;if(1===p){const{visualization:e,bandsEnabled:a}=n;m.fragment.constants.add("inverseSampleValue","float",i$2),m.fragment.uniforms.add("shadowAccumulationMap","sampler2D"),m.fragment.uniforms.add("sampleScale","float"),m.fragment.uniforms.add("opacityFromElevation","float"),0===e?(m.fragment.uniforms.add("colorRamp","sampler2D"),m.fragment.uniforms.add("rampSize","float"),m.fragment.code.add(t$10`vec4 sampleColorRamp(sampler2D ramp, float rampSize, float u) {
float rampU = (u * (rampSize - 1.0) + 0.5) / rampSize;
return texture2D(ramp, vec2(rampU, 0.5));
}`),a&&m.fragment.uniforms.add("bandSize","float")):1===e&&(m.fragment.uniforms.add("threshold","float"),m.fragment.uniforms.add("colors","vec4",2)),m.fragment.code.add(t$10`
      void main(void) {
        vec4 record = texture2D(shadowAccumulationMap, uv);
        float pixelSamples = record.r * inverseSampleValue;

        if (pixelSamples < 1.0) {
          discard;
        }

        float strength = pixelSamples * sampleScale;

        ${0===e&&a?t$10`strength = ceil(strength / bandSize) * bandSize;`:""}

        gl_FragColor = ${0===e?t$10`sampleColorRamp(colorRamp, rampSize, strength)`:t$10`strength <= threshold ? colors[0] : colors[1]`};

        gl_FragColor.a *= opacityFromElevation;
      }
    `);}else 0!==p&&2!==p||(m.include(t$1l),m.fragment.uniforms.add("depthMap","sampler2D"),m.fragment.uniforms.add("inverseView","mat4"),m.fragment.uniforms.add("nearFar","vec2"),0===p?m.fragment.constants.add("sampleValue","float",l$6):m.fragment.constants.add("shadowColor","vec4",[0,0,0,.8]),m.fragment.code.add(t$10`
      void main(void) {

        float depth = rgba2float(texture2D(depthMap, uv));
        // 0.0 is the clear value of depthMap, which means nothing has been drawn there and we should discard
        if (depth == 0.0) {
          discard;
        }

        float currentPixelDepth = linearDepthFromFloat(depth, nearFar);

        if (-currentPixelDepth > nearFar.y || -currentPixelDepth < nearFar.x) {
          discard;
        }

        vec4 currentPixelPos = vec4(reconstructPosition(gl_FragCoord.xy, currentPixelDepth), 1.0);
        vec4 worldSpacePos = inverseView * currentPixelPos;

        mat4 shadowMatrix;
        float linearDepth = -currentPixelDepth;
        int i = chooseCascade(linearDepth, shadowMatrix);

        if (i >= uShadowMapNum) {
          discard;
        }

        vec3 lvpos = lightSpacePosition(worldSpacePos.xyz, shadowMatrix);

        // vertex completely outside? -> no shadow
        if (lvpos.z >= 1.0 || lvpos.x < 0.0 || lvpos.x > 1.0 || lvpos.y < 0.0 || lvpos.y > 1.0) {
          discard;
        }

        vec2 uvShadow = cascadeCoordinates(i, lvpos);

        float depthShadow = readShadowMapDepth(uvShadow, uShadowMapTex);
        bool shadow = depthShadow < lvpos.z;

        if (!shadow) {
          discard;
        }

        gl_FragColor = ${0===p?t$10`vec4(sampleValue)`:t$10`shadowColor`};
      }
    `));return m}var m$3=Object.freeze({__proto__:null,shadowAccumulationMaxSamples:i$2,build:n$6});

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class c$7 extends t$11{initializeProgram(i){const r=c$7.shader.get().build(this.configuration);return new n$16(i.rctx,r,o$X)}initializePipeline(i){return 0===this.configuration.pass?g$S({blending:e$T(1,1,1,1),colorWrite:r$13,depthTest:null,depthWrite:null}):1===this.configuration.pass||2===this.configuration.pass?g$S({blending:u$$,colorWrite:r$13,depthTest:null,depthWrite:null}):g$S({})}bindPass(i){if(0===this.configuration.pass||2===this.configuration.pass){const r=i;this.program.bindTexture(r.linearDepthTexture,"depthMap"),r.shadowMap.bind(this.program),r.shadowMap.bindView(this.program,r.camera.center),this.program.setUniform2fv("nearFar",r.camera.nearFar),this.program.setUniformMatrix4fv("inverseView",r.inverseView),this.program.setUniform4fv("projInfo",r.projInfo),this.program.setUniform2fv("zScale",r.zScale);}else if(1===this.configuration.pass){const r=i;if(this.program.bindTexture(r.shadowAccumulationMap,"shadowAccumulationMap"),this.program.setUniform1f("sampleScale",r.sampleScale),this.program.setUniform1f("opacityFromElevation",r.opacityFromElevation),0===this.configuration.visualization){const r=i;this.program.bindTexture(r.colorRamp,"colorRamp"),this.program.setUniform1f("rampSize",r.rampSize),this.configuration.bandsEnabled&&this.program.setUniform1f("bandSize",r.bandSize);}else if(1===this.configuration.visualization){const r=i;this.program.setUniform1f("threshold",r.threshold),this.program.setUniform4fv("colors",r.colors);}}}get primitiveType(){return 5}}c$7.shader=new t$12(m$3,(()=>import('./ShadowAccumulation.glsl-a08b4467.js')));class d$1 extends e$S{constructor(){super(...arguments),this.pass=0,this.visualization=0,this.bandsEnabled=!1;}}e$Q([r$12({count:3})],d$1.prototype,"pass",void 0),e$Q([r$12()],d$1.prototype,"visualization",void 0),e$Q([r$12()],d$1.prototype,"bandsEnabled",void 0);

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
const u$5=[r$19(.01,0,.25,0),r$19(.01,0,.25,1)],h$4=4e4,c$6=5e4,_$1=1/512;class m$2{constructor(t,e,l,h){this._techniqueRep=t,this._rctx=e,this._shadowAccumulator=l,this._requestRender=h,this._enabled=!1,this._vao=i$T(e),this._visualizationConfig=new d$1,this._visualizationConfig.pass=1,this._visualizationConfig.visualization=0,this._visualizeAccumulationTechnique=t.acquire(c$7,this._visualizationConfig);const c={target:3553,pixelFormat:6408,dataType:5121,samplingMode:9729,wrapMode:33071,width:u$5.length,height:1};this._colorRampTexture=new r$16(this._rctx,c,d(u$5)),this._visualizationParams={shadowAccumulationMap:this._accumulationTexture,sampleScale:0,colorRamp:this._colorRampTexture,rampSize:c.width,threshold:.5,bandSize:.1,colors:M$C([r$19(0,1,0,.5),r$19(1,0,0,.5)]),opacityFromElevation:1};}dispose(){this._stop(),this._vao=i$S(this._vao),this._visualizeAccumulationTechnique=i$S(this._visualizeAccumulationTechnique),this._colorRampTexture=i$S(this._colorRampTexture),this._shadowAccumulator=null;}render(){this._isRenderingVisualization&&(this._sampleScale=1/this._computedSamples,this._rctx.bindVAO(this._vao),this._rctx.useProgram(this._visualizeAccumulationTechnique.program),this._visualizeAccumulationTechnique.bindPipelineState(this._rctx),this._visualizeAccumulationTechnique.bindPass(this._visualizationParams),this._rctx.drawArrays(this._visualizeAccumulationTechnique.primitiveType,0,r$15(this._vao,"geometry")));}setOptions(i){void 0!==i.enabled&&this._setEnabled(i.enabled),void 0!==i.gradientColorRamp&&this._setColorRamp(i.gradientColorRamp),void 0!==i.threshold&&(this._threshold=i.threshold),void 0!==i.thresholdColors&&this._setThresholdColors(i.thresholdColors),void 0!==i.visualization&&(this._visualization=i.visualization),void 0!==i.bandSize&&(this._bandSize=i.bandSize),void 0!==i.bandsEnabled&&(this._bandsEnabled=i.bandsEnabled);}get opacityFromElevation(){return this._visualizationParams.opacityFromElevation}set opacityFromElevation(i){this._visualizationParams.opacityFromElevation=i;}get _isRenderingVisualization(){return this._enabled&&this._computedSamples>0&&this.opacityFromElevation>_$1}get _computedSamples(){return this._shadowAccumulator.computedSamples}get _accumulationTexture(){return this._shadowAccumulator.accumulationTexture}get _sampleScale(){return this._visualizationParams.sampleScale}set _sampleScale(i){this._visualizationParams.sampleScale=i;}get _threshold(){return this._visualizationParams.threshold}set _threshold(i){this._threshold!==i&&(this._visualizationParams.threshold=i,this._requestRenderIfRunning());}get _visualization(){return this._visualizationConfig.visualization}set _visualization(i){if(i===this._visualization)return;const t=this._visualizationConfig;t.visualization=i,this._visualizeAccumulationTechnique=this._techniqueRep.releaseAndAcquire(c$7,t,this._visualizeAccumulationTechnique),this._requestRenderIfRunning();}get _bandSize(){return this._visualizationParams.bandSize}set _bandSize(i){i!==this._bandSize&&(this._visualizationParams.bandSize=i,this._requestRenderIfRunning());}get _bandsEnabled(){return this._visualizationConfig.bandsEnabled}set _bandsEnabled(i){if(i===this._bandsEnabled)return;const t=this._visualizationConfig;t.bandsEnabled=i,this._visualizeAccumulationTechnique=this._techniqueRep.releaseAndAcquire(c$7,t,this._visualizeAccumulationTechnique),this._requestRenderIfRunning();}_setColorRamp(i){const t=i.length,e=d(i);this._colorRampTexture.resize(t,1),this._colorRampTexture.setData(e),this._visualizationParams.rampSize=t,this._requestRenderIfRunning();}_setThresholdColors(e){const s=this._visualizationParams.colors,a=M$C(e);l$1g(s,a)||(this._visualizationParams.colors=a,this._requestRenderIfRunning());}_setEnabled(i){i!==this._enabled&&(i?this._start():this._stop());}_requestRenderIfRunning(){this._enabled&&this._requestRender();}_start(){this._enabled=!0,this._requestRender();}_stop(){this._enabled=!1,this._requestRender();}}function d(i){const t=i.length,e=new Uint8Array(4*t);for(let s=0;s<t;++s){const t=i[s];e[4*s+0]=255*t[0],e[4*s+1]=255*t[1],e[4*s+2]=255*t[2],e[4*s+3]=255*t[3];}return e}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class L$1{constructor(){this.camera=new J$g,this.lightMat=e$P();}}class H{constructor(t,s,e=0){this.rctx=t,this.viewingMode=s,this._enabled=!1,this._snapshots=new Array,this.textureSize=0,this.maxTextureSize=0,this.numCascades=1,this.maxNumCascades=4,this.splitSchemeLambda=0,this.warp=!0,this.cascadeDistances=[0,0,0,0,0],this.cascades=[],this.maxTextureSize=this.rctx.parameters.maxTextureSize;for(let a=0;a<4;++a)this.cascades.push(new L$1);this.snapshotCount=e;}dispose(){this.discardDepthTexture(),this.discardAllSnapshots();}set maxCascades(s){this.maxNumCascades=o$R(Math.floor(s),1,4);}get maxCascades(){return this.maxNumCascades}set enabled(t){this._enabled=t,t||(this.discardDepthTexture(),this.discardAllSnapshots());}get enabled(){return this._enabled}get snapshotCount(){return this._snapshots.length}set snapshotCount(t){const s=this._snapshots.length;if(t>s){const e=t-s;this._snapshots.length=t;for(let t=0;t<e;++t)this._snapshots[s+t]=null;}else if(t<this.snapshotCount){const e=s-t;for(let s=0;s<e;++s)this.discardSnapshot(t+s);this._snapshots.length=t;}}getSnapshot(t){return this.enabled?this._snapshots[t]:null}getCascades(){for(let t=0;t<this.numCascades;++t)st[t]=this.cascades[t];return st.length=this.numCascades,st}start(t,s,e){i$R(this.enabled),this.textureSize=this.computeTextureSize(t.fullWidth,t.fullHeight),this.ensureDepthTexture();const{near:a,far:i}=this.clampNearFar(e);this.computeCascadeDistances(i,a),this.setupMatrices(t,s);const r=t.viewMatrix,h=t.projectionMatrix;for(let o=0;o<this.numCascades;++o)this.constructCascade(o,h,r,s);this.lastOrigin=null,this.clear();}finish(t){i$R(this.enabled),this.rctx.bindFramebuffer(t);}bind(t){this.enabled?(this._depthTextureUnit=t.bindTexture(this._depthTexture,"uShadowMapTex"),t.setUniform1f("uDepthHalfPixelSz",.5/this.textureSize),t.setUniform1i("uShadowMapNum",this.numCascades),t.setUniform4f("uShadowMapDistance",this.cascadeDistances[0],this.numCascades>1?this.cascadeDistances[1]:1/0,this.numCascades>2?this.cascadeDistances[2]:1/0,this.numCascades>3?this.cascadeDistances[3]:1/0)):t.setUniform1f("uDepthHalfPixelSz",-1);}bindView(t,s){if(!this.enabled)return;const e=this.lastOrigin;if(!(e&&e[0]===s[0]&&e[1]===s[1]&&e[2]===s[2])){this.lastOrigin=this.lastOrigin||n$11(),r$Z(this.lastOrigin,s);for(let t=0;t<this.numCascades;++t){c$_(et,this.cascades[t].lightMat,s);for(let s=0;s<16;++s)at[16*t+s]=et[s];}}t.setUniformMatrix4fv("uShadowMapMatrix",at);}takeCascadeSnapshotTo(t,s){i$R(this.enabled),this.ensureSnapshot(s),this._bindFbo();const e=this.rctx,a=e.bindTexture(this._snapshots[s],r$16.TEXTURE_UNIT_FOR_UPDATES);e.gl.copyTexSubImage2D(3553,0,t.camera.viewport[0],t.camera.viewport[1],t.camera.viewport[0],t.camera.viewport[1],t.camera.viewport[2],t.camera.viewport[3]),e.bindTexture(a,r$16.TEXTURE_UNIT_FOR_UPDATES);}clear(){const t=this.rctx;this._bindFbo(),t.setClearColor(1,1,1,1),t.clearSafe(16640);}computeTextureSize(t,s){const e=.5*Math.log(t*t+s*s)*Math.LOG2E,a=.35,i=2**Math.round(e+a);return Math.min(this.maxTextureSize,2*i)}ensureDepthTexture(){if(null!=this._depthTexture&&this._depthTexture.descriptor.width===this.textureSize)return;this.discardDepthTexture();const t={target:3553,pixelFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9728,flipped:!0,width:this.textureSize,height:this.textureSize};this._depthTexture=new r$16(this.rctx,t),this.fbo=new o$15(this.rctx,{colorTarget:0,depthStencilTarget:1,width:this.textureSize,height:this.textureSize},this._depthTexture);}ensureSnapshot(t){const s=this._snapshots[t];if(r$Y(s)&&s.descriptor.width===this.textureSize)return;this.discardSnapshot(t);const e={target:3553,pixelFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9728,flipped:!0,width:this.textureSize,height:this.textureSize};this._snapshots[t]=new r$16(this.rctx,e);}discardDepthTexture(){this.fbo=i$S(this.fbo),this._depthTexture=i$S(this._depthTexture);}discardSnapshot(t){this._snapshots[t]=i$S(this._snapshots[t]);}discardAllSnapshots(){for(let t=0;t<this.snapshotCount;++t)this.discardSnapshot(t);}_bindFbo(){const t=this.rctx;r$Y(this._depthTextureUnit)&&(t.bindTexture(null,this._depthTextureUnit),this._depthTextureUnit=null),t.bindFramebuffer(this.fbo);}constructCascade(t,s,e,a){const i=this.cascades[t],r=-this.cascadeDistances[t],c=-this.cascadeDistances[t+1],n=(s[10]*r+s[14])/Math.abs(s[11]*r+s[15]),u=(s[10]*c+s[14])/Math.abs(s[11]*c+s[15]);i$R(n<u);for(let h=0;h<8;++h){r$17(q$1,h%4==0||h%4==3?-1:1,h%4==0||h%4==1?-1:1,h<4?n:u,1),y$O(V$1[h],q$1,X);for(let t=0;t<3;++t)V$1[h][t]/=V$1[h][3];}v$N(tt,V$1[0]),c$_(I,$$1,tt),i.camera.viewMatrix=I;for(let h=0;h<8;++h)I$x(V$1[h],V$1[h],i.camera.viewMatrix);r$Z(W$1,V$1[0]),r$Z(B$1,V$1[0]);for(let h=1;h<8;++h)for(let t=0;t<3;++t)W$1[t]=Math.min(W$1[t],V$1[h][t]),B$1[t]=Math.max(B$1[t],V$1[h][t]);W$1[2]-=200,B$1[2]+=200,i.camera.near=-B$1[2],i.camera.far=-W$1[2],this.warp?this.constructTrapezoidalProjection(e,a,i):this.constructOrthogonalProjection(i),e$V(i.lightMat,i.camera.projectionMatrix,i.camera.viewMatrix);const d=this.textureSize/2;i.camera.viewport[0]=t%2==0?0:d,i.camera.viewport[1]=0===Math.floor(t/2)?0:d,i.camera.viewport[2]=d,i.camera.viewport[3]=d;}constructOrthogonalProjection(t){E$z(t.camera.projectionMatrix,W$1[0],B$1[0],W$1[1],B$1[1],t.camera.near,t.camera.far);}constructTrapezoidalProjection(t,e,a){const i=1/V$1[0][3],r=1/V$1[4][3];i$R(i<r);let h=i+Math.sqrt(i*r);const o=Math.sin(x$N(t[2]*e[0]+t[6]*e[1]+t[10]*e[2]));h/=o,lt(V$1,h,o,J,K,Q$1,Y,Z$1),Tt(J,K,Y,Z$1,a.camera.projectionMatrix),a.camera.projectionMatrix[10]=2/(W$1[2]-B$1[2]),a.camera.projectionMatrix[14]=-(W$1[2]+B$1[2])/(W$1[2]-B$1[2]);}setupMatrices(t,s){e$V(G,t.projectionMatrix,t.viewMatrix),h$L(X,G);const e=1===this.viewingMode?t.eye:o$S(tt,0,0,1);F$x($$1,[0,0,0],[-s[0],-s[1],-s[2]],e);}clampNearFar(t){let{near:s,far:e}=t;return s<2&&(s=2),e<2&&(e=2),s>=e&&(s=2,e=4),{near:s,far:e}}computeCascadeDistances(t,s){this.numCascades=Math.min(1+Math.floor(q$v(t/s,4)),this.maxNumCascades);const a=(t-s)/this.numCascades,i=(t/s)**(1/this.numCascades);let r=s,h=s;for(let o=0;o<this.numCascades+1;++o)this.cascadeDistances[o]=m$V(r,h,this.splitSchemeLambda),r*=i,h+=a;}getGpuMemoryUsage(){var t,s;return this._snapshots.reduce(((t,s)=>t+o$1c(s)),null!=(t=null==(s=this.fbo)?void 0:s.gpuMemoryUsage)?t:0)}get test(){const t=this;return {maxNumCascades:this.maxNumCascades,cascades:this.cascades,textureSize:this.textureSize,depthTexture:this._depthTexture,set splitSchemeLambda(s){t.splitSchemeLambda=s;},get splitSchemeLambda(){return t.splitSchemeLambda},set warp(s){t.warp=s;},get warp(){return t.warp}}}}const I=e$P(),G=e$P(),X=e$P(),q$1=n$1a(),V$1=[];for(let wt=0;wt<8;++wt)V$1.push(n$1a());const W$1=n$11(),B$1=n$11(),J=n$19(),K=n$19(),Q$1=n$19(),Y=n$19(),Z$1=n$19(),$$1=e$P(),tt=n$11(),st=[],et=e$P(),at=new Float32Array(64),it=n$19(),rt=n$19(),ht=[n$19(),n$19(),n$19(),n$19()],ot=n$19(),ct=n$19(),nt=n$19(),ut=n$19(),dt=n$19(),mt=n$19(),pt=n$19();function lt(t,s,e,a,i,r,h,o){r$18(it,0,0);for(let m=0;m<4;++m)s$15(it,it,t[m]);l$15(it,it,.25),r$18(rt,0,0);for(let m=4;m<8;++m)s$15(rt,rt,t[m]);l$15(rt,rt,.25),y$W(ht[0],t[4],t[5],.5),y$W(ht[1],t[5],t[6],.5),y$W(ht[2],t[6],t[7],.5),y$W(ht[3],t[7],t[4],.5);let c=0,n=q$w(ht[0],it);for(let m=1;m<4;++m){const t=q$w(ht[m],it);t<n&&(n=t,c=m);}o$18(ot,ht[c],t[c+4]);const u=ot[0];let d,M;ot[0]=-ot[1],ot[1]=u,o$18(ct,rt,it),_$r(ct,ot)<0&&p$1f(ot,ot),y$W(ot,ot,ct,e),g$$(ot,ot),d=M=_$r(o$18(nt,t[0],it),ot);for(let m=1;m<8;++m){const s=_$r(o$18(nt,t[m],it),ot);s<d?d=s:s>M&&(M=s);}a$13(a,it),l$15(nt,ot,d-s),s$15(a,a,nt);let _=-1,C=1,j=0,v=0;for(let m=0;m<8;++m){o$18(ut,t[m],a),g$$(ut,ut);const s=ot[0]*ut[1]-ot[1]*ut[0];s>0?s>_&&(_=s,j=m):s<C&&(C=s,v=m);}f$14(_>0,"leftArea"),f$14(C<0,"rightArea"),l$15(dt,ot,d),s$15(dt,dt,it),l$15(mt,ot,M),s$15(mt,mt,it),pt[0]=-ot[1],pt[1]=ot[0];const z=j$O(a,t[v],mt,s$15(nt,mt,pt),1,i),D=j$O(a,t[j],mt,nt,1,r),U=j$O(a,t[j],dt,s$15(nt,dt,pt),1,h),y=j$O(a,t[v],dt,nt,1,o);f$14(z,"rayRay"),f$14(D,"rayRay"),f$14(U,"rayRay"),f$14(y,"rayRay");}function ft(t,s){return 3*s+t}const xt=n$19();function bt(t,s){return r$18(xt,t[s],t[s+3]),xt}const St=n$19(),gt=e$Z();function Tt(t,s,e,a,i){o$18(St,e,a),l$15(St,St,.5),gt[0]=St[0],gt[1]=St[1],gt[2]=0,gt[3]=St[1],gt[4]=-St[0],gt[5]=0,gt[6]=St[0]*St[0]+St[1]*St[1],gt[7]=St[0]*St[1]-St[1]*St[0],gt[8]=1,gt[ft(0,2)]=-_$r(bt(gt,0),t),gt[ft(1,2)]=-_$r(bt(gt,1),t);let r=_$r(bt(gt,0),e)+gt[ft(0,2)],h=_$r(bt(gt,1),e)+gt[ft(1,2)],o=_$r(bt(gt,0),a)+gt[ft(0,2)],c=_$r(bt(gt,1),a)+gt[ft(1,2)];r=-(r+o)/(h+c),gt[ft(0,0)]+=gt[ft(1,0)]*r,gt[ft(0,1)]+=gt[ft(1,1)]*r,gt[ft(0,2)]+=gt[ft(1,2)]*r,r=1/(_$r(bt(gt,0),e)+gt[ft(0,2)]),h=1/(_$r(bt(gt,1),e)+gt[ft(1,2)]),gt[ft(0,0)]*=r,gt[ft(0,1)]*=r,gt[ft(0,2)]*=r,gt[ft(1,0)]*=h,gt[ft(1,1)]*=h,gt[ft(1,2)]*=h,gt[ft(2,0)]=gt[ft(1,0)],gt[ft(2,1)]=gt[ft(1,1)],gt[ft(2,2)]=gt[ft(1,2)],gt[ft(1,2)]+=1,r=_$r(bt(gt,1),s)+gt[ft(1,2)],h=_$r(bt(gt,2),s)+gt[ft(2,2)],o=_$r(bt(gt,1),e)+gt[ft(1,2)],c=_$r(bt(gt,2),e)+gt[ft(2,2)],r=-.5*(r/h+o/c),gt[ft(1,0)]+=gt[ft(2,0)]*r,gt[ft(1,1)]+=gt[ft(2,1)]*r,gt[ft(1,2)]+=gt[ft(2,2)]*r,r=_$r(bt(gt,1),s)+gt[ft(1,2)],h=_$r(bt(gt,2),s)+gt[ft(2,2)],o=-h/r,gt[ft(1,0)]*=o,gt[ft(1,1)]*=o,gt[ft(1,2)]*=o,i[0]=gt[0],i[1]=gt[1],i[2]=0,i[3]=gt[2],i[4]=gt[3],i[5]=gt[4],i[6]=0,i[7]=gt[5],i[8]=0,i[9]=0,i[10]=1,i[11]=0,i[12]=gt[6],i[13]=gt[7],i[14]=0,i[15]=gt[8];}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class M$2{constructor(e,i,r,o,n,_){this._rctx=e,this._stage=r,this._prepareForShadowMapPass=o,this._renderToShadowMap=n,this._requestRender=_,this._progress=0,this._sampleCount=0,this._cachedCamera=new J$g,this._contentCamera=new J$g,this._enabled=!1,this._cachedLightDirections=[],this._depthRange=f$6,this._previewing=!1,this._handles=new u$T,this._cameraForcedForScreenshot=!1,this._shadowMap=new H(e,r.viewingMode),this._shadowMap.enabled=!0,this._vao=i$T(e);const u={rctx:e,viewingMode:r.viewingMode},m=new d$1;m.pass=0,this._accumulationTechnique=new c$7(u,m);const v={colorTarget:0,depthStencilTarget:0,width:0,height:0},b={target:3553,pixelFormat:6408,dataType:5121,samplingMode:9729,wrapMode:33071,width:0,height:0};this._fbo=new o$15(e,v,b),this._accumulationParams={camera:this._cachedCamera,linearDepthTexture:null,shadowMap:this._shadowMap,inverseView:e$P(),projInfo:n$1a(),zScale:n$19()},this._accumulationRenderer=new m$2(i,e,this,_);const j=this._stage.resourceController.scheduler;this._handles.add(j.registerTask(p$H.SHADOW_ACCUMULATOR,this)),this._handles.add(l$1j((()=>r.renderView),(e=>{this._handles.remove(M$2.renderViewHandleKey),t$17(e)||this._handles.add(e.events.on("force-camera-for-screenshot",(()=>this._cameraForcedForScreenshot=!0)),M$2.renderViewHandleKey);})));}get computedSamples(){return this._progress}get accumulationTexture(){return this._fbo.colorTexture}get running(){return this._isRefining&&this._canAccumulate}get isAccumulating(){return this._isPreviewing||this._isRefining}get _isRefining(){return this._isActive&&!this._isDoneAccumulating&&!this._previewing}get _isPreviewing(){return this._isActive&&this._previewing}get _isActive(){return this._enabled&&this._sampleCount>0}get _canAccumulate(){return null!==this._accumulationParams.linearDepthTexture&&this._depthRange!==f$6&&this._opacityFromElevation>_$1}get _isDoneAccumulating(){return this._progress>=this._sampleCount}get _lightDirections(){return this._cachedLightDirections}set _lightDirections(t){const i=this._cachedLightDirections;if(l$1g(i,t,G$p))return;const s=t.length;i.length=s,this._sampleCount=Math.min(i$2,s);for(let e=0;e<s;++e){const s=t[e],r=i[e]||n$11();r$Z(r,s),i[e]=r;}this._invalidate();}get _projInfo(){return this._accumulationParams.projInfo}get _zScale(){return this._accumulationParams.zScale}get _inverseView(){return this._accumulationParams.inverseView}get _opacityFromElevation(){return this._accumulationRenderer.opacityFromElevation}set _opacityFromElevation(e){this._accumulationRenderer.opacityFromElevation=e;}runTask(e){for(this._prepareForShadowMapPass(this._cachedCamera,this._contentCamera);!e.done&&!this._isDoneAccumulating;)this._accumulateShadow(),e.madeProgress();this._requestRender();}accumulateFixedSamples(){if(!this.isAccumulating||!this._canAccumulate)return;(this._previewing||0===this._progress||this._cameraForcedForScreenshot)&&this._clear();const e=this._cameraForcedForScreenshot?this._sampleCount:Math.min(M$2.previewSamples,this._sampleCount-this._progress);for(let t=0;t<e;++t)this._accumulateShadow();this._cameraForcedForScreenshot=!1;}render(){this._accumulationRenderer.render();}dispose(){this._stop(),this._handles.destroy(),this._accumulationRenderer=i$S(this._accumulationRenderer),this._shadowMap=i$S(this._shadowMap),this._fbo=i$S(this._fbo),this._vao=i$S(this._vao),this._accumulationTechnique=i$S(this._accumulationTechnique),this._cachedLightDirections.length=0,this._sampleCount=0;}setOptions(e){void 0!==e.enabled&&this._setEnabled(e.enabled),void 0!==e.previewing&&this.setPreviewing(e.previewing),void 0!==e.lightDirections&&this.setLightDirections(e.lightDirections),this._accumulationRenderer.setOptions(e);}setPreviewing(e){this._previewing!==e&&(this._previewing=e,this._requestRenderIfEnabled());}setLightDirections(e){this._lightDirections=e;}setAccumulationDependencies(e,t,i,s){this._accumulationParams.linearDepthTexture=e,this._depthRange=t,this._updateCamera(i),this._contentCamera=s;}readAccumulatedShadow(e,t){if(!this._isActive||this._progress<1||e<0||e>this._fbo.width||t<0||t>this._fbo.height)return 0;const i=D$1;return this._fbo.readPixels(e,t,1,1,6408,5121,i),i[0]/this._progress}_start(){this._progress=0,this._enabled=!0;}_stop(){this._enabled=!1;}_invalidate(){this._progress=0,this._requestRenderIfEnabled();}_clear(){this._rctx.bindFramebuffer(this._fbo),this._rctx.setClearColor(0,0,0,0),this._rctx.clearSafe(16384),this._progress=0;}_accumulateShadow(){const e=this._lightDirections[this._progress],t=this._cachedCamera;this._renderToShadowMap(this._shadowMap,e,t,this._depthRange),this._rctx.bindFramebuffer(this._fbo),this._rctx.useProgram(this._accumulationTechnique.program),this._accumulationTechnique.bindPipelineState(this._rctx),this._accumulationTechnique.bindPass(this._accumulationParams),this._rctx.bindVAO(this._vao),this._rctx.drawArrays(this._accumulationTechnique.primitiveType,0,r$15(this._vao,"geometry")),this._progress++;}_updateCamera(e){if(e.equals(this._cachedCamera))return;const{fullWidth:t,fullHeight:s,projectionMatrix:r,viewMatrix:a,center:h}=e;this._cachedCamera.copyFrom(e),this._fbo.resize(t,s),K$l(r,t,s,this._projInfo,this._zScale),c$_(this._inverseView,a,h),h$L(this._inverseView,this._inverseView),this._opacityFromElevation=1-L$y(h$4,c$6,e.relativeElevation);}_setEnabled(e){e!==this._enabled&&(e?this._start():this._stop());}_requestRenderIfEnabled(){this._enabled&&this._requestRender();}}M$2.previewSamples=6,M$2.renderViewHandleKey="renderView";const D$1=new Uint8Array(4);

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
function h$3(h){const c=new n$15;return c.include(t$1l),c.fragment.include(a$16),c.fragment.include(a$15),c.include(o$6),c.include(o$u),c.fragment.uniforms.add("defaultDepthTex","sampler2D").add("highlightDepthTex","sampler2D").add("depthMap","sampler2D").add("highlightMap","sampler2D").add("color","vec4").add("nearFar","vec2").add("opacity","float").add("occludedOpacity","float").add("terminationFactor","float").add("inverseView","mat4").add("lightingMainDirectionView","vec3").add("texelSize","vec2"),c.fragment.constants.add("unoccludedHighlightFlag","vec4",o$1g).add("highlightedThreshold","float",h.highlightedThreshold).add("selfShadowThreshold","float",h.selfShadowThreshold),c.fragment.code.add(t$10`vec3 normalFromDepth(vec3 pixelPos, vec2 fragCoord, vec2 uv, vec2 texelSize, sampler2D depthMap, vec2 nearFar) {
float leftPixelDepth = linearDepthFromTexture(depthMap, uv + vec2(-1.0, 0.0) * texelSize, nearFar);
float rightPixelDepth = linearDepthFromTexture(depthMap, uv + vec2(1.0, 0.0) * texelSize, nearFar);
float bottomPixelDepth = linearDepthFromTexture(depthMap, uv + vec2(0.0, -1.0) * texelSize, nearFar);
float topPixelDepth = linearDepthFromTexture(depthMap, uv + vec2(0.0, 1.0) * texelSize, nearFar);
bool pickLeft = abs(pixelPos.z - leftPixelDepth) < abs(pixelPos.z - rightPixelDepth);
bool pickBottom = abs(pixelPos.z - bottomPixelDepth) < abs(pixelPos.z - topPixelDepth);
vec3 fragCoordHorizontal = pickLeft
? vec3(fragCoord + vec2(-1.0, 0.0), leftPixelDepth)
: vec3(fragCoord + vec2(1.0, 0.0), rightPixelDepth);
vec3 fragCoordVertical = pickBottom
? vec3(fragCoord + vec2(0.0, -1.0), bottomPixelDepth)
: vec3(fragCoord + vec2(0.0, 1.0), topPixelDepth);
vec3 verticalPixelPos = reconstructPosition(fragCoordHorizontal.xy, fragCoordHorizontal.z);
vec3 horizontalPixelPos = reconstructPosition(fragCoordVertical.xy, fragCoordVertical.z);
vec3 normal = normalize(cross(verticalPixelPos - pixelPos, horizontalPixelPos - pixelPos));
return pickLeft == pickBottom ? normal : -normal;
}`),c.fragment.code.add(t$10`void main(void) {
vec4 highlightInfo = texture2D(highlightMap, uv);
float visiblyHighlighted = (1.0 - clamp(distance(unoccludedHighlightFlag, highlightInfo), 0.0, 1.0)) * highlightInfo.a;
if (visiblyHighlighted > highlightedThreshold) {
discard;
}
float depth = rgba2float(texture2D(depthMap, uv));
if (depth == 0.0) {
discard;
}
float currentPixelDepth = linearDepthFromFloat(depth, nearFar);
if (-currentPixelDepth>nearFar.y || -currentPixelDepth<nearFar.x) {
discard;
}
vec4 currentPixelPos = vec4(reconstructPosition(gl_FragCoord.xy, currentPixelDepth), 1.0);
vec4 worldSpacePos = inverseView * currentPixelPos;
mat4 shadowMatrix;
float linearDepth = -currentPixelDepth;
int i = chooseCascade(linearDepth, shadowMatrix);
if (i >= uShadowMapNum) {
discard;
}
vec3 lvpos = lightSpacePosition(worldSpacePos.xyz, shadowMatrix);
if (lvpos.z >= 1.0 || lvpos.x < 0.0 || lvpos.x > 1.0 || lvpos.y < 0.0 || lvpos.y > 1.0) {
discard;
}
vec2 uvShadow = cascadeCoordinates(i, lvpos);
float depthHighlight = readShadowMapDepth(uvShadow, highlightDepthTex);
bool shadowHighlight = depthHighlight < lvpos.z;
if (!shadowHighlight) {
discard;
}
float depthDefault = readShadowMapDepth(uvShadow, defaultDepthTex);
bool shadowDefault = depthDefault < lvpos.z;
vec3 normal = normalFromDepth(currentPixelPos.xyz, gl_FragCoord.xy, uv, texelSize, depthMap, nearFar);
bool shaded = dot(normal, lightingMainDirectionView) < selfShadowThreshold;
float differenceOpacity = opacity;
float bothOpacity = occludedOpacity;
float fragOpacity = (shadowDefault || shaded) ? bothOpacity : differenceOpacity;
gl_FragColor = vec4(color.rgb, color.a * fragOpacity * terminationFactor);
}`),c}var c$5=Object.freeze({__proto__:null,build:h$3});

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
const M$1=4e4,j=5e4;class b$1 extends t$11{constructor(){super(...arguments),this.opacityElevation=1,this.dayNightTerminator=1,this.highlightShadowMapSlot=0,this.defaultSnapshotSlot=1;}initializeProgram(t){const i=b$1.shader.get();this._viewingMode=t.viewingMode;const r=i.build({highlightedThreshold:.99999,selfShadowThreshold:.025});return new n$16(t.rctx,r,o$X)}initializePipeline(t){return g$S({blending:e$T(770,1,771,771),colorWrite:r$13,depthTest:null,depthWrite:null})}bindPass(o,s){this.opacityElevation=1-L$y(M$1,j,s.camera.relativeElevation);const l=1===this._viewingMode?j$F(y,s.camera.center):o$S(y,0,0,1),c=z$u(l,s.lighting.lightingMainDirection);this.dayNightTerminator=L$y(0,1,o$R(30*c,0,1)),this.program.bindTexture(s.linearDepthTexture,"depthMap"),this.program.bindTexture(s.highlightColorTexture,"highlightMap"),I$x(U$1,s.lighting.lightingMainDirection,s.camera.viewInverseTransposeMatrix),j$F(U$1,U$1),K$l(s.camera.projectionMatrix,s.camera.fullWidth,s.camera.fullHeight,k$1,D),c$_(z,s.camera.viewMatrix,s.camera.center),h$L(z,z),this.program.setUniform4fv("color",o.shadowColor),this.program.setUniform1f("opacity",o.shadowOpacity),this.program.setUniform1f("occludedOpacity",o.occludedShadowOpacity),this.program.setUniform1f("terminationFactor",this.opacityElevation*this.dayNightTerminator),this.program.setUniform2fv("nearFar",s.camera.nearFar),this.program.setUniformMatrix4fv("inverseView",z),this.program.setUniform4fv("projInfo",k$1),this.program.setUniform2fv("zScale",D),this.program.setUniform3fv("lightingMainDirectionView",U$1),this.program.setUniform2f("texelSize",1/s.linearDepthTexture.descriptor.width,1/s.linearDepthTexture.descriptor.height),s.shadowMap.bind(this.program),s.shadowMap.bindView(this.program,s.camera.center);let g=s.shadowMap.getSnapshot(this.highlightShadowMapSlot);r$Y(g)&&this.program.bindTexture(g,"highlightDepthTex"),g=s.shadowMap.getSnapshot(this.defaultSnapshotSlot),r$Y(g)&&this.program.bindTexture(g,"defaultDepthTex");}get primitiveType(){return 5}}b$1.shader=new t$12(c$5,(()=>import('./ShadowHighlight.glsl-5ec8df1d.js')));const y=n$11(),U$1=n$11(),D=n$19(),k$1=n$1a(),z=e$P();

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
const a$4=.001953125;class o$5{constructor(t,h){this._rctx=t,this._maxOpacity=1,this._defaultOptions={shadowColor:t$1q(1,0,1,1),shadowOpacity:.2,occludedShadowOpacity:.1},this._technique=new b$1({rctx:t,viewingMode:h},null),this._vao=i$T(this._rctx);}render(t,i){t.shadowMap.enabled&&t.linearDepthTexture&&this.isVisible&&(this._rctx.bindFramebuffer(i),this._rctx.useProgram(this._technique.program),this._technique.bindPipelineState(this._rctx),this._technique.bindPass(this._defaultOptions,t),this._rctx.bindVAO(this._vao),this._rctx.drawArrays(this._technique.primitiveType,0,r$15(this._vao,"geometry")));}getGpuMemoryUsage(){return this._vao?this._vao.size:0}setDefaultOptions(t){this._defaultOptions=t,this._updateMaxOpacity();}get highlightShadowMapSlot(){return this._technique.highlightShadowMapSlot}get defaultSnapshotSlot(){return this._technique.defaultSnapshotSlot}dispose(){this._vao=i$S(this._vao),this._technique=i$S(this._technique);}get isVisible(){return this._maxOpacity*this._technique.opacityElevation*this._technique.dayNightTerminator>=a$4}_updateMaxOpacity(){const t=this._defaultOptions,i=t.shadowColor,e=Math.max(t.shadowOpacity,t.occludedShadowOpacity);this._maxOpacity=e*i[3];}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
const t$5=G$k();class n$5{constructor(){this._worldPlane=t$5;}get isEnabled(){return this.plane!==t$5}get plane(){return this._worldPlane}set plane(e){this._worldPlane=e||t$5;}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
function t$4(t){const r=new n$15;return 0===t.output&&(r.attributes.add("position","vec2"),r.vertex.uniforms.add("uResolution","vec4"),r.varyings.add("fTexCoord","vec2"),r.varyings.add("fOffset[3]","vec4"),r.vertex.code.add(t$10`void SMAAEdgeDetectionVS( vec2 texcoord ) {
fOffset[0] = texcoord.xyxy + uResolution.xyxy * vec4( -1.0, 0.0, 0.0,  1.0 );
fOffset[1] = texcoord.xyxy + uResolution.xyxy * vec4(  1.0, 0.0, 0.0, -1.0 );
fOffset[2] = texcoord.xyxy + uResolution.xyxy * vec4( -2.0, 0.0, 0.0,  2.0 );
}
void main() {
fTexCoord = (position + 1.0 ) * 0.5;
gl_Position = vec4(position, 0, 1);
SMAAEdgeDetectionVS( fTexCoord );
}`),r.fragment.uniforms.add("tColor","sampler2D"),r.fragment.code.add(t$10`
      vec4 SMAAColorEdgeDetectionPS( vec2 texcoord, vec4 offset[3], sampler2D colorTex ) {
        vec2 threshold = vec2( ${t$10.float(t.threshold)} );

        // Calculate color deltas:
        vec4 delta;
        vec3 C = texture2D( colorTex, texcoord ).rgb;

        vec3 Cleft = texture2D( colorTex, offset[0].xy ).rgb;
        vec3 t = abs( C - Cleft );
        delta.x = max( max( t.r, t.g ), t.b );

        vec3 Ctop = texture2D( colorTex, offset[0].zw ).rgb;
        t = abs( C - Ctop );
        delta.y = max( max( t.r, t.g ), t.b );

        // We do the usual threshold:
        vec2 edges = step( threshold, delta.xy );

        // Then discard if there is no edge:
        if ( dot( edges, vec2( 1.0, 1.0 ) ) == 0.0 )
            discard;

        // Calculate right and bottom deltas:
        vec3 Cright = texture2D( colorTex, offset[1].xy ).rgb;
        t = abs( C - Cright );
        delta.z = max( max( t.r, t.g ), t.b );

        vec3 Cbottom  = texture2D( colorTex, offset[1].zw ).rgb;
        t = abs( C - Cbottom );
        delta.w = max( max( t.r, t.g ), t.b );

        // Calculate the maximum delta in the direct neighborhood:
        float maxDelta = max( max( max( delta.x, delta.y ), delta.z ), delta.w );

        // Calculate left-left and top-top deltas:
        vec3 Cleftleft  = texture2D( colorTex, offset[2].xy ).rgb;
        t = abs( C - Cleftleft );
        delta.z = max( max( t.r, t.g ), t.b );

        vec3 Ctoptop = texture2D( colorTex, offset[2].zw ).rgb;
        t = abs( C - Ctoptop );
        delta.w = max( max( t.r, t.g ), t.b );

        // Calculate the final maximum delta:
        maxDelta = max( max( maxDelta, delta.z ), delta.w );

        // Local contrast adaptation in action:
        edges.xy *= step( maxDelta, float(${t$10.float(t.localConstrastAdaption)}) * delta.xy );

        return vec4( edges, 0.0, 0.0 );
      }

      void main() {
        gl_FragColor = SMAAColorEdgeDetectionPS( fTexCoord, fOffset, tColor );
      }
    `)),1===t.output&&(r.attributes.add("position","vec2"),r.vertex.uniforms.add("uResolution","vec4"),r.varyings.add("fTexCoord","vec2"),r.varyings.add("fOffset[3]","vec4"),r.varyings.add("fPixCoord","vec2"),r.vertex.code.add(t$10`
      void SMAABlendingWeightCalculationVS( vec2 texcoord ) {
        fPixCoord = texcoord * uResolution.zw;
        fOffset[0] = texcoord.xyxy + uResolution.xyxy * vec4( -0.25, 0.125, 1.25, 0.125 );
        fOffset[1] = texcoord.xyxy + uResolution.xyxy * vec4( -0.125, 0.25, -0.125, -1.25 );
        fOffset[2] = vec4( fOffset[0].xz, fOffset[1].yw ) + vec4( -2.0, 2.0, -2.0, 2.0 ) * uResolution.xxyy * float( ${t$10.int(t.maxSearchSteps)} );
      }

      void main() {
        fTexCoord = (position + 1.0 ) * 0.5;
        gl_Position = vec4(position, 0, 1);
        SMAABlendingWeightCalculationVS( fTexCoord );
      }
    `),r.fragment.uniforms.add("tEdges","sampler2D").add("tArea","sampler2D").add("tSearch","sampler2D").add("tColor","sampler2D").add("uResolution","vec4"),r.fragment.code.add(t$10`
      #define SMAA_AREATEX_PIXEL_SIZE ( 1.0 / vec2( 160.0, 560.0 ) )
      #define SMAA_AREATEX_SUBTEX_SIZE ( 1.0 / 7.0 )

      vec4 SMAASampleLevelZeroOffset(sampler2D tex, vec2 coord, vec2 offset) {
        return texture2D( tex, coord + offset.x * uResolution.xy, 0.0 );
      }

      vec2 round( vec2 x ) {
        return sign( x ) * floor( abs( x ) + 0.5 );
      }

      float SMAASearchLength( sampler2D searchTex, vec2 e, float bias, float scale ) {
        e.r = bias + e.r * scale;
        return 255.0 * texture2D( searchTex, e, 0.0 ).r;
      }

      float SMAASearchXLeft( sampler2D edgesTex, sampler2D searchTex, vec2 texcoord, float end ) {
        vec2 e = vec2( 0.0, 1.0 );
        for ( int i = 0; i < ${t$10.int(t.maxSearchSteps)}; i ++ ) {
          e = texture2D( edgesTex, texcoord, 0.0 ).rg;
          texcoord -= vec2( 2.0, 0.0 ) * uResolution.xy;
          if ( ! ( texcoord.x > end && e.g > 0.8281 && e.r == 0.0 ) ) break;
        }
        texcoord.x += 0.25 * uResolution.x;
        texcoord.x += uResolution.x;
        texcoord.x += 2.0 * uResolution.x;
        texcoord.x -= uResolution.x * SMAASearchLength(searchTex, e, 0.0, 0.5);
        return texcoord.x;
      }

      float SMAASearchXRight( sampler2D edgesTex, sampler2D searchTex, vec2 texcoord, float end ) {
        vec2 e = vec2( 0.0, 1.0 );
        for ( int i = 0; i < ${t$10.int(t.maxSearchSteps)}; i ++ ) {
          e = texture2D( edgesTex, texcoord, 0.0 ).rg;
          texcoord += vec2( 2.0, 0.0 ) * uResolution.xy;
          if ( ! ( texcoord.x < end && e.g > 0.8281 && e.r == 0.0 ) ) break;
        }
        texcoord.x -= 0.25 * uResolution.x;
        texcoord.x -= uResolution.x;
        texcoord.x -= 2.0 * uResolution.x;
        texcoord.x += uResolution.x * SMAASearchLength( searchTex, e, 0.5, 0.5 );
        return texcoord.x;
      }

      float SMAASearchYUp( sampler2D edgesTex, sampler2D searchTex, vec2 texcoord, float end ) {
        vec2 e = vec2( 1.0, 0.0 );
        for ( int i = 0; i < ${t$10.int(t.maxSearchSteps)}; i ++ ) {
          e = texture2D( edgesTex, texcoord, 0.0 ).rg;
          texcoord += vec2( 0.0, 2.0 ) * uResolution.xy;
          if ( ! ( texcoord.y > end && e.r > 0.8281 && e.g == 0.0 ) ) break;
        }
        texcoord.y -= 0.25 * uResolution.y;
        texcoord.y -= uResolution.y;
        texcoord.y -= 2.0 * uResolution.y;
        texcoord.y += uResolution.y * SMAASearchLength( searchTex, e.gr, 0.0, 0.5 );
        return texcoord.y;
      }

      float SMAASearchYDown( sampler2D edgesTex, sampler2D searchTex, vec2 texcoord, float end ) {
        vec2 e = vec2( 1.0, 0.0 );
        for ( int i = 0; i < ${t$10.int(t.maxSearchSteps)}; i ++ ) {
          e = texture2D( edgesTex, texcoord, 0.0 ).rg;
          texcoord -= vec2( 0.0, 2.0 ) * uResolution.xy;
          if ( ! ( texcoord.y < end && e.r > 0.8281 && e.g == 0.0 ) ) break;
        }
        texcoord.y += 0.25 * uResolution.y;
        texcoord.y += uResolution.y;
        texcoord.y += 2.0 * uResolution.y;
        texcoord.y -= uResolution.y * SMAASearchLength( searchTex, e.gr, 0.5, 0.5 );
        return texcoord.y;
      }

      vec2 SMAAArea( sampler2D areaTex, vec2 dist, float e1, float e2, float offset ) {
        vec2 texcoord = float( ${t$10.int(t.maxDistanceAreaTex)} ) * round( 4.0 * vec2( e1, e2 ) ) + dist;
        texcoord = SMAA_AREATEX_PIXEL_SIZE * texcoord + ( 0.5 * SMAA_AREATEX_PIXEL_SIZE );
        texcoord.y += SMAA_AREATEX_SUBTEX_SIZE * offset;
        return texture2D( areaTex, texcoord, 0.0 ).rg;
      }

      vec4 SMAABlendingWeightCalculationPS( vec2 texcoord, vec2 pixcoord, vec4 offset[ 3 ], sampler2D edgesTex, sampler2D areaTex, sampler2D searchTex, ivec4 subsampleIndices ) {
        vec4 weights = vec4( 0.0, 0.0, 0.0, 0.0 );
        vec2 e = texture2D( edgesTex, texcoord ).rg;
        if ( e.g > 0.0 ) {
          vec2 d;
          vec2 coords;
          coords.x = SMAASearchXLeft( edgesTex, searchTex, offset[ 0 ].xy, offset[ 2 ].x );
          coords.y = offset[ 1 ].y;
          d.x = coords.x;
          float e1 = texture2D( edgesTex, coords, 0.0 ).r;
          coords.x = SMAASearchXRight( edgesTex, searchTex, offset[ 0 ].zw, offset[ 2 ].y );
          d.y = coords.x;
          d = d * uResolution.z - pixcoord.x;
          vec2 sqrt_d = sqrt( abs( d ) );
          coords.y -= 1.0 * uResolution.y;
          float e2 = SMAASampleLevelZeroOffset( edgesTex, coords, vec2( 1.0, 0.0 ) ).r;
          weights.rg = SMAAArea( areaTex, sqrt_d, e1, e2, float( subsampleIndices.y ) );
        }

        if ( e.r > 0.0 ) {
          vec2 d;
          vec2 coords;
          coords.y = SMAASearchYUp( edgesTex, searchTex, offset[ 1 ].xy, offset[ 2 ].z );
          coords.x = offset[ 0 ].x;
          d.x = coords.y;
          float e1 = texture2D( edgesTex, coords, 0.0 ).g;
          coords.y = SMAASearchYDown( edgesTex, searchTex, offset[ 1 ].zw, offset[ 2 ].w );
          d.y = coords.y;
          d = d * uResolution.w - pixcoord.y;
          vec2 sqrt_d = sqrt( abs( d ) );
          coords.y -= 1.0 * uResolution.y;
          float e2 = SMAASampleLevelZeroOffset( edgesTex, coords, vec2( 0.0, 1.0 ) ).g;
          weights.ba = SMAAArea( areaTex, sqrt_d, e1, e2, float( subsampleIndices.x ) );

          // for some reason the following lines are necessary to prevent
          // texture lookup precision issues on some Intel integrated graphics chips
          vec4 dbg = (offset[ 0 ]+offset[ 1 ]+offset[ 2 ] + coords.xyyx);
          weights.r += 0.00000001 * dot(vec4(0,1,0,1),dbg);
        }
        return weights;
      }

      void main() {
        gl_FragColor = SMAABlendingWeightCalculationPS( fTexCoord, fPixCoord, fOffset, tEdges, tArea, tSearch, ivec4( 0.0 ) );
      }
    `)),2===t.output&&(r.attributes.add("position","vec2"),r.vertex.uniforms.add("uResolution","vec4"),r.varyings.add("fTexCoord","vec2"),r.varyings.add("fOffset[2]","vec4"),r.vertex.code.add(t$10`void SMAANeighborhoodBlendingVS( vec2 texcoord ) {
fOffset[0] = texcoord.xyxy + uResolution.xyxy * vec4( -1.0, 0.0, 0.0, 1.0 );
fOffset[1] = texcoord.xyxy + uResolution.xyxy * vec4( 1.0, 0.0, 0.0, -1.0 );
}
void main() {
fTexCoord = (position + 1.0 ) * 0.5;
gl_Position = vec4(position, 0, 1);
SMAANeighborhoodBlendingVS(fTexCoord);
}`),r.fragment.uniforms.add("tBlendWeights","sampler2D"),r.fragment.uniforms.add("tColor","sampler2D"),r.fragment.uniforms.add("uResolution","vec4"),r.fragment.code.add(t$10`vec4 SMAANeighborhoodBlendingPS( vec2 texcoord, vec4 offset[ 2 ], sampler2D colorTex, sampler2D blendTex ) {
vec4 a;
a.xz = texture2D( blendTex, texcoord ).xz;
a.y = texture2D( blendTex, offset[ 1 ].zw ).g;
a.w = texture2D( blendTex, offset[ 1 ].xy ).a;
if ( dot(a, vec4( 1.0, 1.0, 1.0, 1.0 )) < 1e-5 ) {
return texture2D( colorTex, texcoord, 0.0 );
} else {
vec2 offset;
offset.x = a.a > a.b ? a.a : -a.b;
offset.y = a.g > a.r ? -a.g : a.r;
if ( abs( offset.x ) > abs( offset.y )) {
offset.y = 0.0;
} else {
offset.x = 0.0;
}
vec4 C = texture2D( colorTex, texcoord, 0.0 );
texcoord += sign( offset ) * uResolution.xy;
vec4 Cop = texture2D( colorTex, texcoord, 0.0 );
float s = abs( offset.x ) > abs( offset.y ) ? abs( offset.x ) : abs( offset.y );
vec4 mixed = mix(C, Cop, s);
return mixed;
}
}
void main() {
gl_FragColor = SMAANeighborhoodBlendingPS( fTexCoord, fOffset, tColor, tBlendWeights );
}`)),r}var r=Object.freeze({__proto__:null,build:t$4});

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class h$2 extends t$11{initializeProgram(e){const r=h$2.shader.get(),t=this.configuration,o=r.build({output:t.output,threshold:.05,localConstrastAdaption:2,maxSearchSteps:8,maxDistanceAreaTex:16});return new n$16(e.rctx,o,o$X)}initializePipeline(){return g$S({colorWrite:r$13})}}h$2.shader=new t$12(r,(()=>import('./SMAA.glsl-74b93823.js')));class m$1 extends e$S{constructor(){super(...arguments),this.output=0;}}e$Q([r$12({count:3})],m$1.prototype,"output",void 0);

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class o$4{constructor(e,t){this.rctx=e,this._techniqueRep=t,this.resourceLoadingPromise=null,this.isEnabled=!1;}loadResources(e){if(!this.data||!this.textureArea||!this.textureSearch){const t=this.resourceLoadingPromise||this.loadDataModule().then((()=>this.loadTextures()));return e&&t.then(e),this.resourceLoadingPromise||(this.resourceLoadingPromise=t,t.then((()=>this.resourceLoadingPromise=null))),!1}return !0}loadDataModule(){return this.data?Promise.resolve():import('./SmaaRenderPassData-e461ea33.js').then((e=>{this.data=e;}))}loadTextures(){return Promise.all([this.loadTextureFromBase64(this.data.areaTexture,9729,6407),this.loadTextureFromBase64(this.data.searchTexure,9728,6409)]).then((([e,t])=>{this.textureArea=e,this.textureSearch=t;}))}get isLoadingResources(){return null!=this.resourceLoadingPromise}enable(){if(this.isEnabled)return !0;if(!this._edgeDetectTechnique||!this._blendWeights||!this._blur){const e=new m$1,t=(e,t)=>this._techniqueRep.releaseAndAcquire(h$2,e,t);e.output=0,this._edgeDetectTechnique=t(e,this._edgeDetectTechnique),e.output=1,this._blendWeights=t(e,this._blendWeights),e.output=2,this._blur=t(e,this._blur);}return !!this.loadResources()&&(this.vao=l$1k(this.rctx),this.edges=new o$15(this.rctx,{colorTarget:0,depthStencilTarget:0},{target:3553,pixelFormat:6407,dataType:5121,samplingMode:9729,wrapMode:33071,width:4,height:4}),this.blend=new o$15(this.rctx,{colorTarget:0,depthStencilTarget:0},{target:3553,pixelFormat:6408,dataType:5121,samplingMode:9729,wrapMode:33071,width:4,height:4}),this.isEnabled=!0,!0)}disable(){this.isEnabled&&(this.vao.dispose(),this.vao=null,this.textureArea.dispose(),this.textureArea=null,this.textureSearch.dispose(),this.textureSearch=null,this.blend.dispose(),this.blend=null,this.edges.dispose(),this.edges=null,this.isEnabled=!1);}render(e){this.enable();const t=this.rctx,r=t.getBoundFramebufferObject(),i={x:0,y:0,width:e.colorTexture.descriptor.width,height:e.colorTexture.descriptor.height};t.bindVAO(this.vao),t.setPipelineState(this._edgeDetectTechnique.pipeline),t.setViewport(i.x,i.y,i.width,i.height),this.edges.resize(i.width,i.height),t.bindFramebuffer(this.edges),t.setClearColor(0,0,0,1),t.clear(16384),t.useProgram(this._edgeDetectTechnique.program),this._edgeDetectTechnique.program.bindTexture(e.colorTexture,"tColor"),this._edgeDetectTechnique.program.setUniform4f("uResolution",1/i.width,1/i.height,i.width,i.height),t.drawArrays(4,0,3),this.blend.resize(i.width,i.height),t.bindFramebuffer(this.blend),t.setClearColor(0,0,1,1),t.clear(16384),t.useProgram(this._blendWeights.program),this._blendWeights.program.setUniform4f("uResolution",1/i.width,1/i.height,i.width,i.height),this._blendWeights.program.bindTexture(this.textureSearch,"tSearch"),this._blendWeights.program.bindTexture(this.textureArea,"tArea"),this._blendWeights.program.bindTexture(this.edges.colorTexture,"tEdges"),t.drawArrays(4,0,3),t.bindFramebuffer(r),t.setClearColor(0,1,0,1),t.clear(16384),t.useProgram(this._blur.program),this._blur.program.setUniform4f("uResolution",1/i.width,1/i.height,i.width,i.height),this._blur.program.bindTexture(e.colorTexture,"tColor"),this._blur.program.bindTexture(this.blend.colorTexture,"tBlendWeights"),t.drawArrays(4,0,3);}loadTextureFromBase64(t,r,i){const s=new r$16(this.rctx,{pixelFormat:i,dataType:5121,wrapMode:33071,samplingMode:r},null);return t$14(t).then((e=>(s.resize(e.width,e.height),s.setData(e),s)))}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
function n$4(n){const l=new n$15;return l.include(o$u),1===n.output&&(l.fragment.include(a$15),l.fragment.uniforms.add("normalMap","sampler2D").add("depthMap","sampler2D").add("tex","sampler2D").add("blurSize","vec2").add("g_BlurFalloff","float").add("projScale","float").add("nearFar","vec2").add("zScale","vec2"),l.fragment.code.add(t$10`
      float blurFunction(vec2 uv, float r, float center_d, inout float w_total, float sharpness) {
        float c = texture2D(tex, uv).r;
        float d = linearDepthFromTexture(depthMap, uv, nearFar);

        float ddiff = d - center_d;

        float w = exp(-r*r*g_BlurFalloff - ddiff*ddiff*sharpness);

        w_total += w;

        return w*c;
      }

      void main(void) {
        float b = 0.0;
        float w_total = 0.0;

        float center_d = linearDepthFromTexture(depthMap, uv, nearFar);

        float sharpness = -0.05 * projScale/(center_d*zScale.x+zScale.y);
        for (int r = -${t$10.int(n.radius)}; r <= ${t$10.int(n.radius)}; ++r) {
          float rf = float(r);
          vec2 uvOffset = uv + rf*blurSize;
          b += blurFunction(uvOffset, rf, center_d, w_total, sharpness);
        }

        gl_FragColor = vec4(b/w_total);
      }
    `)),0===n.output&&(l.fragment.include(a$15),l.include(o$6),l.fragment.uniforms.add("projMatrixInv","mat4").add("normalMap","sampler2D").add("depthMap","sampler2D").add("intensity","float").add("projScale","float").add("radius","float").add("nearFar","vec2").add("screenDimensions","vec2").add("rnmScale","vec2").add("rnm","sampler2D"),l.fragment.code.add(t$10`
    uniform vec3 pSphere[${t$10.int(n.samples)}];

    float fallOffFunction(float vv, float vn, float bias) {
      float radius2 = radius * radius;
      float f = max(radius2 - vv, 0.0);
      return f * f * f * max(vn-bias, 0.0);
    }
    `),l.fragment.code.add(t$10`float aoValueFromPositionsAndNormal(vec3 C, vec3 n_C, vec3 Q) {
vec3 v = Q - C;
float vv = dot(v, v);
float vn = dot(normalize(v), n_C);
return fallOffFunction(vv, vn, 0.1);
}`),l.fragment.code.add(t$10`
      void main(void) {
        vec3 fres = normalize((texture2D(rnm, uv * rnmScale).xyz * 2.0) - vec3(1.0));
        float currentPixelDepth = linearDepthFromTexture(depthMap, uv, nearFar);

        if (-currentPixelDepth>nearFar.y || -currentPixelDepth<nearFar.x) {
          gl_FragColor = vec4(0.0);
          return;
        }

        vec3 currentPixelPos = reconstructPosition(gl_FragCoord.xy,currentPixelDepth);

        // get the normal of current fragment
        vec4 norm4 = texture2D(normalMap, uv);
        vec3 norm = vec3(-1.0) + 2.0 * norm4.xyz;
        bool isTerrain = norm4.w<0.5;

        float sum = .0;

        vec4 occluderFragment;
        vec3 ray;

        vec3 tapPixelPos;

        // note: the factor 2.0 should not be necessary, but makes ssao much nicer.
        // bug or deviation from CE somewhere else?
        float ps = projScale/(2.0*currentPixelPos.z*zScale.x+zScale.y);

        for(int i = 0; i < ${t$10.int(n.samples)}; ++i) {
          // get a vector (randomized inside of a sphere with radius 1.0) from a texture and reflect it
          //float ssR;
          //vec2 unitOffset = tapLocation(i, randomPatternRotationAngle, ssR);
          // get the depth of the occluder fragment
          //vec2 offset = vec2(-unitOffset*radius*ssR*ps);

          vec2 unitOffset = reflect(pSphere[i], fres).xy;
          vec2 offset = vec2(-unitOffset*radius*ps);

          //don't use current or very nearby samples
          if ( abs(offset.x)<2.0 || abs(offset.y)<2.0) continue;

          vec2 tc = vec2(gl_FragCoord.xy + offset);
          if (tc.x < 0.0 || tc.y < 0.0 || tc.x > screenDimensions.x || tc.y > screenDimensions.y) continue;
          vec2 tcTap = tc/screenDimensions;
          float occluderFragmentDepth = linearDepthFromTexture(depthMap, tcTap, nearFar);

          if (isTerrain) {
            bool isTerrainTap = texture2D(normalMap, tcTap).w<0.5;
            if (isTerrainTap) {
              continue;
            }
          }

          tapPixelPos = reconstructPosition(tc, occluderFragmentDepth);

          sum+= aoValueFromPositionsAndNormal(currentPixelPos, norm, tapPixelPos);
        }

        // output the result

        float A = max(1.0-sum*intensity/float(${t$10.int(n.samples)}),0.0);

        // Anti-tone map to reduce contrast and drag dark region farther
        // (x^0.2 + 1.2 * x^4)/2.2
        A = (pow(A, 0.2) + 1.2 * A*A*A*A) / 2.2;

        //gl_FragColor = vec4(norm/2.0+0.5, 1.0);
        //gl_FragColor = vec4(-currentPixelDepth/1000.0);
        //gl_FragColor = vec4(tapPixelPos.x/100.0);
        gl_FragColor = vec4(A);
      }
    `)),l}var l$5=Object.freeze({__proto__:null,build:n$4});

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
const m=4;class l$4 extends t$11{initializeProgram(e){const r=l$4.shader.get(),s=this.configuration,t=3===s.samples?64:2===s.samples?32:1===s.samples?16:8,o=r.build({output:s.output,samples:t,radius:m});return new n$16(e.rctx,o,o$X)}initializePipeline(){return g$S({colorWrite:r$13})}}l$4.shader=new t$12(l$5,(()=>import('./SSAO.glsl-fbf00fa1.js')));class c$4 extends e$S{constructor(){super(...arguments),this.output=0,this.samples=3;}}e$Q([r$12({count:2})],c$4.prototype,"output",void 0),e$Q([r$12()],c$4.prototype,"samples",void 0);

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class f$4{constructor(e,t,s){this._techniqueRep=e,this._rctx=t,this._requestRender=s,this._enabled=!1,this._ssaoTechniqueConfig=new c$4,this.quadVAO=null,this._BLUR_F=2,this._attenuation=.5,this._radius=3,this._samples=16,this._viewportToRestore=n$1a();}dispose(){this.quadVAO=i$S(this.quadVAO);}set enabled(e){e?this._enable():this._disable();}get enabled(){return this._enabled}set attenuation(e){this._attenuation=e;}get attenuation(){return this._attenuation}set radius(e){this._radius=e;}get radius(){return this._radius}set samples(e){this._samples=e,this._enabled&&this._selectPrograms();}get samples(){return this._samples}get ready(){return this.enabled&&r$Y(this._noiseTexture)&&r$Y(this._ssaoFBO)&&r$Y(this._blur0FBO)&&r$Y(this._blur1FBO)}computeSSAO(e,t,i){if(!this.enabled||t$17(this._noiseTexture)||t$17(this._ssaoFBO)||t$17(this._blur0FBO)||t$17(this._blur1FBO))return;const a=this._rctx,h=e.fullViewport,_=h[2],l=h[3],p=_/this._BLUR_F,d=l/this._BLUR_F;this._ssaoFBO.resize(_,l),this._blur0FBO.resize(p,d),this._blur1FBO.resize(p,d);const f=1,g=1,T=_*f,O=l*g;a$12(this._viewportToRestore,e.fullViewport),a.bindFramebuffer(this._ssaoFBO),a.setViewport(0,0,_,l);const B=this._ssaoTechnique.program;a.useProgram(B),a.setPipelineState(this._ssaoTechnique.pipeline),B.setUniform2f("rnmScale",_/this._noiseTexture.descriptor.width,l/this._noiseTexture.descriptor.height),B.setUniform3fv("pSphere",this._samples<=8?this._data.random8:this._samples<=16?this._data.random16:this._samples<=32?this._data.random32:this._data.random64);const x=this._data.minDiscrepancy,U=this._samples<x.length?x[this._samples]:5779;B.setUniform1f("numSpiralTurns",U);const w=F$1,q=b;K$l(e.projectionMatrix,e.fullWidth,e.fullHeight,w,q),B.setUniform4fv("projInfo",w),B.setUniform2fv("zScale",q),B.setUniform2f("nearFar",e.near,e.far);let R=1/e.computeRenderPixelSizeAtDist(1);B.setUniform1f("projScale",R*f),B.setUniform2f("screenDimensions",T,O);const S=q$o(e.eye,e.center);let A=20*e.computeRenderPixelSizeAtDist(S);A=Math.max(.1,A),B.setUniform1f("radius",A),B.setUniform1f("intensity",4*this._attenuation/A**6),B.bindTexture(this._noiseTexture,"rnm"),B.bindTexture(i,"normalMap"),B.bindTexture(t,"depthMap"),t$17(this.quadVAO)&&(this.quadVAO=i$T(this._rctx));const j=this.quadVAO;a.bindVAO(j),a.drawArrays(5,0,r$15(j,"geometry"));const v=(m+1)/2,y=1/(2*v*v),M=this._blurTechnique.program;a.useProgram(M),M.bindTexture(this._ssaoFBO.colorTexture,"tex"),M.bindTexture(i,"normalMap"),M.bindTexture(t,"depthMap"),a.setViewport(0,0,T/this._BLUR_F,O/this._BLUR_F),a.bindFramebuffer(this._blur0FBO),M.setUniform2f("screenDimensions",T,O),M.setUniform2f("blurSize",0,this._BLUR_F*f/O),M.setUniform1i("radius",m),M.setUniform1f("g_BlurFalloff",y),M.setUniform2f("nearFar",e.near,e.far),S>5e4&&(R=Math.max(0,R-(S-5e4))),M.setUniform1f("projScale",R),M.setUniform2f("zScale",1,0),a.drawArrays(5,0,r$15(j,"geometry")),M.setUniform2f("blurSize",this._BLUR_F*g/T,0),a.bindFramebuffer(this._blur1FBO),M.bindTexture(this._blur0FBO.colorTexture,"tex"),a.drawArrays(5,0,r$15(j,"geometry")),a.setViewport(this._viewportToRestore[0],this._viewportToRestore[1],this._viewportToRestore[2],this._viewportToRestore[3]);}bind(e){this.enabled&&r$Y(this._blur1FBO)&&r$Y(this._ssaoFBO)?(e.bindTexture(this._blur1FBO.colorTexture,"ssaoTex"),e.setUniform4f("viewportPixelSz",this._viewportToRestore[0],this._viewportToRestore[1],1/this._ssaoFBO.width,1/this._ssaoFBO.height)):e.setUniform4f("viewportPixelSz",-1,-1,-1,-1);}_selectPrograms(){const e=this._samples<=8?0:this._samples<=16?1:this._samples<=32?2:3;this._ssaoTechniqueConfig.samples=e,this._ssaoTechniqueConfig.output=0,this._ssaoTechnique=this._techniqueRep.releaseAndAcquire(l$4,this._ssaoTechniqueConfig,this._ssaoTechnique),this._ssaoTechniqueConfig.output=1,this._blurTechnique=this._techniqueRep.releaseAndAcquire(l$4,this._ssaoTechniqueConfig,this._blurTechnique);}_enable(){this.enabled||(this._enabled=!0,this._loadResources((()=>{this._enabled&&this._initialize();})));}_loadResources(e){this._data?e():import('./SSAOHelperData-f80430e6.js').then((t=>{this._data=t,e();}));}_initialize(){const e={target:3553,pixelFormat:6408,dataType:5121,samplingMode:9729,wrapMode:33071,width:0,height:0},t={colorTarget:0,depthStencilTarget:0};t$14(this._data.noiseTexture).then((s=>{this._enabled&&(this._ssaoFBO=new o$15(this._rctx,t,e),this._blur0FBO=new o$15(this._rctx,t,e),this._blur1FBO=new o$15(this._rctx,t,e),this._noiseTexture=new r$16(this._rctx,{target:3553,pixelFormat:6408,dataType:5121,hasMipmap:!0,width:s.width,height:s.height},s),this._requestRender());})),this._selectPrograms();}_disable(){this._enabled=!1,this._noiseTexture=i$S(this._noiseTexture),this._blur1FBO=i$S(this._blur1FBO),this._blur0FBO=i$S(this._blur0FBO),this._ssaoFBO=i$S(this._ssaoFBO);}get gpuMemoryUsage(){return (r$Y(this._blur0FBO)?this._blur0FBO.gpuMemoryUsage:0)+(r$Y(this._blur1FBO)?this._blur1FBO.gpuMemoryUsage:0)+(r$Y(this._ssaoFBO)?this._ssaoFBO.gpuMemoryUsage:0)}get test(){return {ssao:this._ssaoFBO,blur:this._blur1FBO}}}const b=n$19(),F$1=n$1a();

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
function n$3(n,o){const t=o,c=-n[0],f=-n[1],i=-n[2],s=t[3],u=t[7],e=t[11],p=t[15];t[0]+=s*c,t[1]+=s*f,t[2]+=s*i,t[4]+=u*c,t[5]+=u*f,t[6]+=u*i,t[8]+=e*c,t[9]+=e*f,t[10]+=e*i,t[12]+=p*c,t[13]+=p*f,t[14]+=p*i;}function o$3(n,o){const t=o,c=n[0],f=n[1],i=n[2];t[12]+=c*t[0]+f*t[4]+i*t[8],t[13]+=c*t[1]+f*t[5]+i*t[9],t[14]+=c*t[2]+f*t[6]+i*t[10],t[14]+=c*t[3]+f*t[7]+i*t[11];}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class e$2{constructor(i){this.factory=i,this.originData=new Map;}acquire(i){return this.register(this.factory.getOrigin(i))}register(i){const r=this.originData.get(i.id);return r?(r.refCount++,r.origin):(this.originData.set(i.id,{refCount:1,viewMatrix:e$P(),origin:i}),i)}release(i){const t=this.originData.get(i.id);t&&(t.refCount--,0===t.refCount&&this.originData.delete(i.id));}updateViewMatrices(t){this.originData.forEach((e=>{n$18(e.viewMatrix,t),o$3(e.origin.vec3,e.viewMatrix);}));}getViewMatrix(i){return this.originData.get(i.id).viewMatrix}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
function o$2(o){const e=t$10`bool isNaN( float val )
{
return ( val < 0.0 || 0.0 < val || val == 0.0 ) ? false : true;
}`;o.code.add(e);}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
function a$3(a,t){a.vertex.include(o$2),a.include(d$18,t);const s=a.vertex;s.uniforms.add("uDepthBias","vec2"),s.uniforms.add("uViewportDimInv","vec2"),t.legacy?(s.uniforms.add("uView","mat4"),s.uniforms.add("uProj","mat4")):s.uniforms.add("uTransformNormal_ViewFromGlobal","mat3"),t.legacy?s.code.add(t$10`vec2 calculateProjectedBiasXY(vec4 projPos, vec3 globalNormal) {
float offsetXY = uDepthBias.x;
float offsetZ  = uDepthBias.y;
vec4 projNormal = uProj * uView * vec4(globalNormal, 0.0);
return offsetXY * projPos.w * 2.0 * uViewportDimInv * normalize(projNormal.xyz).xy;
}`):s.code.add(t$10`vec2 calculateProjectedBiasXY(vec4 projPos, vec3 globalNormal) {
float offsetXY = uDepthBias.x;
float offsetZ  = uDepthBias.y;
vec4 projNormal = uTransform_ProjFromView * vec4(uTransformNormal_ViewFromGlobal * globalNormal, 0.0);
return offsetXY * projPos.w * 2.0 * uViewportDimInv * normalize(projNormal.xyz).xy;
}`),s.code.add(t$10`float _calculateProjectedBiasZ(vec4 projPos) {
float offsetZ = uDepthBias.y;
return sqrt(projPos.z) * offsetZ;
}
vec4 adjustProjectedPosition(vec4 projPos, vec3 worldNormal, float lineWidth) {
vec2 offsetXY = calculateProjectedBiasXY(projPos, worldNormal);
if (!isNaN(offsetXY.x) && !isNaN(offsetXY.y)) {
projPos.xy += offsetXY;
}
projPos.z += _calculateProjectedBiasZ(projPos);
return projPos;
}`);}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
function a$2(a,r){const d=a.fragment;d.constants.add("coverageTestThreshold","float",.01),r.antialiasing?d.code.add(t$10`#define discardByCoverage(radius, coverage) { if (coverage < coverageTestThreshold) discard; }`):d.code.add(t$10`#define discardByCoverage(radius, coverage) { float coverageLimit = radius <= 0.5 ? coverageTestThreshold : 0.75; if (coverage < coverageLimit) discard; }`);}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
function o$1(o,r){const l=o.vertex;r.silhouette?(l.code.add(t$10`bool isSilhouetteEdge(vec3 viewDir, vec3 normalA, vec3 normalB) {
float faceAVisible = dot(viewDir, normalA);
float faceBVisible = dot(viewDir, normalB);
return faceAVisible * faceBVisible < 0.0;
}`),r.legacy?l.code.add(t$10`bool discardNonSilhouetteEdges(vec3 viewPos, vec3 worldPos) {
vec3 viewNormalA = _modelToViewNormal(normalA);
vec3 viewNormalB = _modelToViewNormal(normalB);
vec3 viewDir = -viewPos;
if (isSilhouetteEdge(viewDir, viewNormalA, viewNormalB)) {
return false;
}
gl_Position = vec4(10.0, 10.0, 10.0, 1.0);
return true;
}`):l.code.add(t$10`bool discardNonSilhouetteEdges(vec3 viewPos, vec3 worldPos) {
vec3 worldNormalA = _modelToWorldNormal(normalA);
vec3 worldNormalB = _modelToWorldNormal(normalB);
vec3 viewDir = -worldPos;
if (isSilhouetteEdge(viewDir, worldNormalA, worldNormalB)) {
return false;
}
gl_Position = vec4(10.0, 10.0, 10.0, 1.0);
return true;
}`)):l.code.add(t$10`bool discardNonSilhouetteEdges(vec3 viewPos, vec3 worldPos) {
return false;
}`);}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
function t$3(t,i){const d=t.vertex;switch(i.mode){case 1:d.code.add(t$10`#define discardShortEdges(unpackedAttributes, lineLengthPixels) { if (lineLengthPixels <= 3.0) { gl_Position = vec4(10.0, 10.0, 10.0, 1.0); return; }}`);break;case 2:d.code.add(t$10`#define discardShortEdges(unpackedAttributes, lineLengthPixels) { if (unpackedAttributes.type <= 0.0 && lineLengthPixels <= 3.0) { gl_Position = vec4(10.0, 10.0, 10.0, 1.0); return; }}`);break;case 0:d.code.add(t$10`#define discardShortEdges(unpackedAttributes, lineLengthPixels) {}`);}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
function t$2(t,n){const r=t.vertex;r.uniforms.add("uDistanceFalloffFactor","float"),r.code.add(t$10`float distanceBasedPerspectiveFactor(float distance) {
return clamp(sqrt(uDistanceFalloffFactor / distance), 0.0, 1.0);
}`),r.uniforms.add("uComponentDataTex","sampler2D"),r.uniforms.add("uComponentDataTexInvDim","vec2"),t.attributes.add("componentIndex","float"),r.constants.add("componentColorFieldOffset","float",0),r.constants.add("componentOtherFieldOffset","float",1),r.constants.add("componentFieldCount","float",2),r.constants.add("lineWidthFractionFactor","float",8),r.constants.add("extensionLengthOffset","float",128),r.constants.add("componentTexWidth","float",4096),r.code.add(t$10`vec2 _componentTextureCoords(float componentIndex, float fieldOffset) {
float fieldIndex = componentFieldCount * componentIndex + fieldOffset;
float rowIndex = floor(fieldIndex / componentTexWidth);
float colIndex = mod(fieldIndex, componentTexWidth);
vec2 linearIndex = vec2(
(colIndex + 0.5) / componentTexWidth,
(rowIndex + 0.5) * uComponentDataTexInvDim.y
);
return linearIndex;
}
struct ComponentData {
vec4 color;
float lineWidth;
float extensionLength;
float type;
};
ComponentData readComponentData() {
vec2 colorIndex = _componentTextureCoords(componentIndex, componentColorFieldOffset);
vec2 otherIndex = _componentTextureCoords(componentIndex, componentOtherFieldOffset);
vec4 colorValue = texture2D(uComponentDataTex, colorIndex);
vec4 otherValue = texture2D(uComponentDataTex, otherIndex);
return ComponentData(
vec4(colorValue.rgb, colorValue.a * otherValue.w),
otherValue.x * (255.0 / lineWidthFractionFactor),
otherValue.y * 255.0 - extensionLengthOffset,
-(otherValue.z * 255.0) + 0.5
);
}`),n.legacy?r.code.add(t$10`vec3 _modelToWorldNormal(vec3 normal) {
return (uModel * vec4(normal, 0.0)).xyz;
}
vec3 _modelToViewNormal(vec3 normal) {
return (uView * uModel * vec4(normal, 0.0)).xyz;
}`):(r.uniforms.add("uTransformNormal_GlobalFromModel ","mat3"),r.code.add(t$10`vec3 _modelToWorldNormal(vec3 normal) {
return uTransformNormal_GlobalFromModel * normal;
}`)),n.silhouette?(t.attributes.add("normalA","vec3"),t.attributes.add("normalB","vec3"),r.code.add(t$10`vec3 worldNormal() {
return _modelToWorldNormal(normalize(normalA + normalB));
}`)):(t.attributes.add("normal","vec3"),r.code.add(t$10`vec3 worldNormal() {
return _modelToWorldNormal(normal);
}`)),n.legacy?r.code.add(t$10`vec3 worldFromModelPosition(vec3 position) {
return (uModel * vec4(position, 1.0)).xyz;
}
vec3 viewFromModelPosition(vec3 position) {
return (uView * vec4(worldFromModelPosition(position), 1.0)).xyz;
}
vec4 projFromViewPosition(vec3 position) {
return uProj * vec4(position, 1.0);
}`):(t.vertex.include(r$1y,n),r.code.add(t$10`vec3 worldFromModelPosition(vec3 position) {
vec3 rotatedModelPosition = uTransform_WorldFromModel_RS * position;
vec3 transform_CameraRelativeFromModel = dpAdd(
uTransform_WorldFromModel_TL,
uTransform_WorldFromModel_TH,
-uTransform_WorldFromView_TL,
-uTransform_WorldFromView_TH
);
return transform_CameraRelativeFromModel + rotatedModelPosition;
}
vec3 viewFromModelPosition(vec3 position) {
return uTransform_ViewFromCameraRelative_RS * worldFromModelPosition(position);
}
vec4 projFromViewPosition(vec3 position) {
return uTransform_ProjFromView * vec4(position, 1.0);
}`)),r.code.add(t$10`float calculateExtensionLength(float extensionLength, float lineLength) {
return extensionLength / (log2(max(1.0, 256.0 / lineLength)) * 0.2 + 1.0);
}`);}!function(o){function e(o){return 1===o.mode||2===o.mode}function t(o){return 0===o.mode||2===o.mode}o.usesSketchLogic=e,o.usesSolidLogic=t;}(t$2||(t$2={}));

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
function t$1(t,s){const i=t.vertex;switch(t.include(t$2,s),t.attributes.add("sideness","vec2"),2===s.mode?i.code.add(t$10`struct UnpackedAttributes {
vec2 sideness;
vec2 sidenessNorm;
float lineWidthPixels;
float extensionLengthPixels;
float type;
};`):i.code.add(t$10`struct UnpackedAttributes {
vec2 sideness;
vec2 sidenessNorm;
float lineWidthPixels;
float extensionLengthPixels;
};`),s.mode){case 2:i.code.add(t$10`UnpackedAttributes unpackAttributes(ComponentData component) {
vec2 sidenessNorm = sideness;
vec2 sideness = sidenessNorm * 2.0 - 1.0;
float fType = component.type;
float extensionLengthPixels = component.extensionLength;
float lineWidth = component.lineWidth;
if (fType <= 0.0) {
extensionLengthPixels *= variantExtension * 2.0 - 1.0;
}
return UnpackedAttributes(sideness, sidenessNorm, lineWidth, extensionLengthPixels, fType);
}`);break;case 1:i.code.add(t$10`UnpackedAttributes unpackAttributes(ComponentData component) {
vec2 sidenessNorm = sideness;
vec2 sideness = sidenessNorm * 2.0 - 1.0;
float extensionLengthPixels = component.extensionLength;
extensionLengthPixels *= variantExtension * 2.0 - 1.0;
float lineWidth = component.lineWidth;
return UnpackedAttributes(sideness, sidenessNorm, lineWidth, extensionLengthPixels);
}`);break;case 0:i.code.add(t$10`UnpackedAttributes unpackAttributes(ComponentData component) {
vec2 sidenessNorm = sideness;
vec2 sideness = sidenessNorm * 2.0 - 1.0;
float extensionLengthPixels = component.extensionLength;
float lineWidth = component.lineWidth;
return UnpackedAttributes(sideness, sidenessNorm, lineWidth, extensionLengthPixels);
}`);}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
function u$4(u,a){const d=u.vertex;switch(u.include(t$1,a),t$2.usesSketchLogic(a)&&d.uniforms.add("uStrokesAmplitude","float"),a.mode){case 0:d.code.add(t$10`float calculateLineAmplitude(UnpackedAttributes unpackedAttributes) {
return 0.0;
}`);break;case 1:d.code.add(t$10`float calculateLineAmplitude(UnpackedAttributes unpackedAttributes) {
return uStrokesAmplitude;
}`);break;case 2:d.code.add(t$10`float calculateLineAmplitude(UnpackedAttributes unpackedAttributes) {
float type = unpackedAttributes.type;
if (type <= 0.0) {
return uStrokesAmplitude;
}
else {
return 0.0;
}
}`);}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
function u$3(u,s){const c=u.vertex;u.include(t$1,s);const l=u.fragment;switch(t$2.usesSketchLogic(s)&&(c.uniforms.add("uStrokesTextureScale","vec2"),c.uniforms.add("uStrokesLog2Resolution","float"),c.uniforms.add("uStrokeVariants","float"),u.varyings.add("vStrokeUV","vec2"),l.uniforms.add("uStrokesTexture","sampler2D"),l.uniforms.add("uStrokesNormalizationScale","float"),c.code.add(t$10`void calculateStyleOutputsSketch(float lineLength, UnpackedAttributes unpackedAttributes) {
vec2 sidenessNorm = unpackedAttributes.sidenessNorm;
float lineIndex = clamp(ceil(log2(lineLength)), 0.0, uStrokesLog2Resolution);
vStrokeUV = vec2(exp2(lineIndex) * sidenessNorm.y, lineIndex * uStrokeVariants + variantStroke + 0.5) * uStrokesTextureScale;
vStrokeUV.x += variantOffset;
}`),u.fragment.include(a$16),l.code.add(t$10`float calculateLineOffsetSketch() {
float offsetNorm = rgba2float(texture2D(uStrokesTexture, vStrokeUV));
return (offsetNorm - 0.5) * uStrokesNormalizationScale;
}
float calculateLinePressureSketch() {
return rgba2float(texture2D(uStrokesTexture, vStrokeUV + vec2(0.0, 0.5)));
}`)),s.mode){case 0:c.code.add(t$10`void calculateStyleOutputs(UnpackedAttributes unpackedAttributes) {}`),l.code.add(t$10`float calculateLineOffset() {
return 0.0;
}
float calculateLinePressure() {
return 1.0;
}`);break;case 1:c.code.add(t$10`void calculateStyleOutputs(UnpackedAttributes unpackedAttributes)
{
calculateStyleOutputsSketch(vLineLengthPixels, unpackedAttributes);
}`),l.code.add(t$10`float calculateLineOffset() {
return calculateLineOffsetSketch();
}
float calculateLinePressure() {
return calculateLinePressureSketch();
}`);break;case 2:u.varyings.add("vType","float"),c.code.add(t$10`void calculateStyleOutputs(UnpackedAttributes unpackedAttributes)
{
vType = unpackedAttributes.type;
if (unpackedAttributes.type <= 0.0) {
calculateStyleOutputsSketch(vLineLengthPixels, unpackedAttributes);
}
}`),l.code.add(t$10`float calculateLineOffset() {
if (vType <= 0.0) {
return calculateLineOffsetSketch();
}
else {
return 0.0;
}
}
float calculateLinePressure() {
if (vType <= 0.0) {
return calculateLinePressureSketch();
}
else {
return 1.0;
}
}`);}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
function p$3(p){const v=new n$15,g=v.vertex,f=v.fragment;return p.legacy&&g.uniforms.add("uModel","mat4"),p.antialiasing&&(g.code.add(t$10`#define ANTIALIASING 1`),f.code.add(t$10`#define ANTIALIASING 1`)),v.include(a$3,p),v.include(u$4,p),v.include(t$2,p),v.include(t$1,p),v.include(u$3,p),v.include(c$$,p),v.include(o$1,p),v.include(a$2,p),v.include(t$3,p),v.varyings.add("vColor","vec4"),v.varyings.add("vRadius","float"),v.varyings.add("vPosition","vec3"),v.varyings.add("vWorldPosition","vec3"),v.varyings.add("vViewPos","vec3"),v.varyings.add("vLineLengthPixels","float"),v.varyings.add("vSizeFalloffFactor","float"),g.uniforms.add("uPixelToNDC","vec2"),g.uniforms.add("uNDCToPixel","vec2"),g.uniforms.add("uPixelRatio","float"),v.attributes.add("position0","vec3"),v.attributes.add("position1","vec3"),v.attributes.add("variantOffset","float"),v.attributes.add("variantStroke","float"),v.attributes.add("variantExtension","float"),g.code.add(t$10`const float opaqueCutoff = 1.0 / 255.0;
void calculateGeometricOutputs(vec3 viewPosV0, vec3 viewPosV1, vec3 worldPosV0, vec3 worldPosV1, vec3 worldNormal, UnpackedAttributes unpackedAttributes) {
vec2 sideness = unpackedAttributes.sideness;
vec2 sidenessNorm = unpackedAttributes.sidenessNorm;
vWorldPosition = mix(worldPosV0, worldPosV1, sidenessNorm.y).xyz;
vec3 viewPos = mix(viewPosV0, viewPosV1, sidenessNorm.y);
vViewPos = viewPos;
vec4 projPosV0 = projFromViewPosition(viewPosV0);
vec4 projPosV1 = projFromViewPosition(viewPosV1);
vec4 projPos = projFromViewPosition(viewPos);
vec3 screenSpaceLineNDC = (projPosV1.xyz / projPosV1.w - projPosV0.xyz / projPosV0.w);
vec2 screenSpaceLinePixels = screenSpaceLineNDC.xy * uNDCToPixel;
float lineLengthPixels = length(screenSpaceLinePixels);
float dzPerPixel = screenSpaceLineNDC.z / lineLengthPixels;
vec2 screenSpaceDirection = screenSpaceLinePixels / lineLengthPixels;
vec2 perpendicularScreenSpaceDirection = vec2(screenSpaceDirection.y, -screenSpaceDirection.x) * sideness.x;
float falloffFactor = distanceBasedPerspectiveFactor(-viewPos.z) * uPixelRatio;
float lineWidthPixels = unpackedAttributes.lineWidthPixels * falloffFactor;
float extensionLengthPixels = calculateExtensionLength(unpackedAttributes.extensionLengthPixels, lineLengthPixels) * falloffFactor;
float lineAmplitudePixels = calculateLineAmplitude(unpackedAttributes) * uPixelRatio;
vSizeFalloffFactor = falloffFactor;
float lineWidthAndAmplitudePixels = lineWidthPixels + lineAmplitudePixels + lineAmplitudePixels;
float extendedLineLengthPixels = lineLengthPixels + extensionLengthPixels + extensionLengthPixels;
#ifdef ANTIALIASING
const float aaPaddingPixels = 1.0;
float halfAAPaddedLineWidthAndAmplitudePixels = lineWidthAndAmplitudePixels * 0.5 + aaPaddingPixels;
float aaPaddedRoundedCapSizePixels = lineWidthPixels * 0.5 + aaPaddingPixels;
#else
float halfAAPaddedLineWidthAndAmplitudePixels = max(lineWidthAndAmplitudePixels, 1.0) * 0.5;
float aaPaddedRoundedCapSizePixels = max(lineWidthPixels, 1.0) * 0.5;
#endif
vec2 halfAAPaddedLineWidthAndAmplitudeNDC = halfAAPaddedLineWidthAndAmplitudePixels * uPixelToNDC;
vec2 aaPaddedRoundedCapSizeNDC = aaPaddedRoundedCapSizePixels * uPixelToNDC;
vec2 extensionLengthNDC = extensionLengthPixels * uPixelToNDC;
vec2 ndcOffset = (
screenSpaceDirection * sideness.y * (aaPaddedRoundedCapSizeNDC + extensionLengthNDC)
+ perpendicularScreenSpaceDirection * halfAAPaddedLineWidthAndAmplitudeNDC
);
projPos.xy += ndcOffset * projPos.w;
projPos.z += (dzPerPixel * (aaPaddedRoundedCapSizePixels + extensionLengthPixels)) * sideness.y * projPos.w;
projPos = adjustProjectedPosition(projPos, worldNormal, 1.0 + max((lineWidthAndAmplitudePixels - 1.0) * 0.5, 0.0));
float aaPaddedLineWithCapsLengthPixels = extendedLineLengthPixels + aaPaddedRoundedCapSizePixels + aaPaddedRoundedCapSizePixels;
float pixelPositionAlongLine = aaPaddedLineWithCapsLengthPixels * sidenessNorm.y - aaPaddedRoundedCapSizePixels;
vPosition = vec3(
halfAAPaddedLineWidthAndAmplitudePixels * sideness.x,
pixelPositionAlongLine,
pixelPositionAlongLine / extendedLineLengthPixels
);
vRadius = lineWidthPixels * 0.5;
vLineLengthPixels = extendedLineLengthPixels;
discardShortEdges(unpackedAttributes, lineLengthPixels);
gl_Position = projPos;
}
void main() {
ComponentData component = readComponentData();
UnpackedAttributes unpackedAttributes = unpackAttributes(component);
vec3 worldPosV0 = worldFromModelPosition(position0);
vec3 worldPosV1 = worldFromModelPosition(position1);
vec3 viewPosV0 = viewFromModelPosition(position0);
vec3 viewPosV1 = viewFromModelPosition(position1);
vColor = component.color;
if (vColor.a < opaqueCutoff) {
gl_Position = vec4(10.0, 10.0, 10.0, 1.0);
return;
}
if (discardNonSilhouetteEdges(viewPosV0, worldPosV0)) {
return;
}
calculateGeometricOutputs(viewPosV0, viewPosV1, worldPosV0, worldPosV1, worldNormal(), unpackedAttributes);
calculateStyleOutputs(unpackedAttributes);
}`),p.multipassTerrainEnabled&&(v.fragment.include(a$15),v.include(r$1j,p)),v.fragment.code.add(t$10`
    vec2 lineWithCapsDistance(float radius, vec2 position, float lineLength) {
      float lineOffset = calculateLineOffset();
      float positionX = position.x - lineOffset;

      if (radius < 1.0) {
        // Handle this specifically for subpixel sizes:
        // 1. Compute correct coverage (note coverage is computed by
        //    0.5 - dist, so we make sure that that will lead to correct
        //    subpixel coverage
        // 2. Ignore rounded caps
        float coverageX = clamp(min(radius, positionX + 0.5) - max(-radius, positionX - 0.5), 0.0, 1.0);
        float coverageY = clamp(min(lineLength, position.y + 0.5) - max(0.0, position.y - 0.5), 0.0, 1.0);

        float coverage = min(coverageX, coverageY);

        return vec2(0.5 - coverage, 0.0);
      }
      else {
        // Between -radius -> 0 for start cap, 0 for line, 0 -> radius
        float positionOnCap = position.y - clamp(position.y, 0.0, lineLength);

        vec2 lineToPosition = vec2(positionX, positionOnCap);
        return vec2(length(lineToPosition) - radius, positionOnCap / radius);
      }
    }

    void main() {
      ${p.multipassTerrainEnabled?"terrainDepthTest(gl_FragCoord, vViewPos.z);":""}
      float radius = vRadius * calculateLinePressure();

      vec2 distance = lineWithCapsDistance(radius, vPosition.xy, vLineLengthPixels);
      float coverage = clamp(0.5 - distance.x, 0.0, 1.0);

      discardByCoverage(radius, coverage);
      discardBySlice(vWorldPosition);

      float alpha = vColor.a * coverage;

      gl_FragColor = vec4(vColor.rgb, alpha);

    }
  `),v}var v$1=Object.freeze({__proto__:null,build:p$3});

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
const f$3=-4e-4,p$2=.5;class h$1 extends t$11{bindPass(e){const i=this.program,{edgeRenderParameters:o,bindParameters:t}=e;d$18.bindViewProjTransform(i,o.viewProjectionTransform),i.setUniformMatrix3fv("uTransformNormal_ViewFromGlobal",o.transformNormal_ViewFromGlobal),i.setUniformMatrix4fv("uProj",t.camera.projectionMatrix),i.setUniform2f("uDepthBias",p$2,f$3),i.setUniform2f("uPixelToNDC",2/t.camera.fullViewport[2],2/t.camera.fullViewport[3]),i.setUniform2f("uNDCToPixel",t.camera.fullViewport[2]/2,t.camera.fullViewport[3]/2),i.setUniform1f("uDistanceFalloffFactor",o.distanceFalloffFactor),i.setUniform2f("uViewportDimInv",1/t.camera.fullViewport[2],1/t.camera.fullViewport[3]),i.setUniform1f("uPixelRatio",t.camera.pixelRatio||1);}initializeProgram(e){const r=h$1.shader.get(),i=this.configuration,o=r.build({slicePlaneEnabled:i.slicePlaneEnabled,sliceHighlightDisabled:!1,sliceEnabledForVertexPrograms:!1,silhouette:i.silhouette,legacy:i.legacy,antialiasing:i.antialiasing,mode:i.mode,doublePrecisionRequiresObfuscation:i.doublePrecisionRequiresObfuscation,multipassTerrainEnabled:i.multipassTerrainEnabled,cullAboveGround:i.cullAboveGround});return new n$16(e.rctx,o,p$1g)}initializePipeline(e){const r=e.rctx.capabilities.blendMinMax;return g$S(r?{blending:e$T(1,1,0,1,32774,r.MAX),depthTest:{func:515},colorWrite:r$13}:{depthTest:{func:515},depthWrite:l$$,colorWrite:r$13})}}h$1.shader=new t$12(v$1,(()=>import('./EdgeShaderProgram.glsl-e422ecf9.js'))),function(r){class i extends e$S{constructor(){super(...arguments),this.slicePlaneEnabled=!1,this.silhouette=!1,this.legacy=!1,this.antialiasing=!1,this.mode=0,this.doublePrecisionRequiresObfuscation=!1,this.multipassTerrainEnabled=!1,this.cullAboveGround=!1;}}e$Q([r$12()],i.prototype,"slicePlaneEnabled",void 0),e$Q([r$12()],i.prototype,"silhouette",void 0),e$Q([r$12()],i.prototype,"legacy",void 0),e$Q([r$12()],i.prototype,"antialiasing",void 0),e$Q([r$12({count:3})],i.prototype,"mode",void 0),e$Q([r$12()],i.prototype,"doublePrecisionRequiresObfuscation",void 0),e$Q([r$12()],i.prototype,"multipassTerrainEnabled",void 0),e$Q([r$12()],i.prototype,"cullAboveGround",void 0),r.Configuration=i;}(h$1||(h$1={}));

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
const T$1=8,R=128,v={type:"uber",slicePlaneEnabled:!1,sliceHighlightDisabled:!1,strokesTexture:null,legacy:!0};class x{constructor(){this._value=0;}get value(){return this._value}increment(){this._value++;}decrement(){this._value--;}}const P={solid:0,sketch:1,uber:2};class S{constructor(e,t,s){this.rctx=e,this.shaderTechniqueRepository=t,this.config=new h$1.Configuration,this.technique=null,this.refCount=new x,this.renderables=new Set,this.sortedRenderables={1:{1:new n$1h,2:new n$1h},2:{1:new n$1h,2:new n$1h}},this.renderablesDirty=!1,this.settings={...v,...s},this.key=S.getKey(this.settings.type,this.settings.slicePlaneEnabled,this.settings.legacy);const i=this.settings.strokesTexture.variants;this.writerSettings={variants:i,reducedPrecision:T$k.DISABLE_ELEVATION_ALIGNERS_ITERATIVE_UPDATES},this.config.legacy=this.settings.legacy,this.config.mode=P[this.settings.type],this.config.silhouette=!1,this.config.antialiasing=!!this.rctx.capabilities.blendMinMax,this.config.slicePlaneEnabled=this.settings.slicePlaneEnabled,this.config.doublePrecisionRequiresObfuscation=o$1e(e);}dispose(){this.technique=h$U(this.technique);}addRenderable(e){this.renderables.add(e),this.renderablesDirty=!0;}removeRenderable(e){this.renderables.delete(e),this.renderablesDirty=!0;}setRenderablesDirty(){this.renderablesDirty=!0;}forEachRenderable(e,t){this.renderablesDirty&&this.sortRenderables(),this.sortedRenderables[t][1].forAll(e),this.sortedRenderables[t][2].forAll(e);}setMultipassParameters(e){this.config.multipassTerrainEnabled=!!e.multipassTerrainEnabled&&e.multipassTerrainEnabled,this.config.cullAboveGround=!!e.cullAboveGround&&e.cullAboveGround;}bindRegularEdges(e,t){this.setMultipassParameters(e),this.config.silhouette=!1,this.technique=this.shaderTechniqueRepository.releaseAndAcquire(h$1,this.config,this.technique),this.technique.bindPass({bindParameters:e,edgeRenderParameters:t}),this.rctx.setPipelineState(this.technique.pipeline),this.rctx.useProgram(this.technique.program);}bindSilhouetteEdges(e,t){this.setMultipassParameters(e),this.config.silhouette=!0,this.technique=this.shaderTechniqueRepository.releaseAndAcquire(h$1,this.config,this.technique),this.technique.bindPass({bindParameters:e,edgeRenderParameters:t}),this.rctx.setPipelineState(this.technique.pipeline),this.rctx.useProgram(this.technique.program);}renderRegularEdges(e,t,s){this.render(e,e.regular.vao,t,s);}renderSilhouetteEdges(e,t,s){this.render(e,e.silhouette.vao,t,s);}render(e,t,s,r){this.setUniforms(e,s),this.rctx.bindVAO(t),this.rctx.capabilities.instancing.drawArraysInstanced(6,0,4,r);}setUniforms(e,t){const s=this.technique.program;if(e.components.buffer.textureBuffer.bind(s,w$1,E),t.multipassTerrainEnabled&&(s.setUniform2fv("cameraNearFar",t.camera.nearFar),s.setUniform2fv("inverseViewport",t.inverseViewport),t$1f(s,t)),"origin"in e.transform)s.setUniformMatrix4fv("uView",t.localViewMatrixForEdges),s.setUniformMatrix4fv("uModel",e.transform.modelMatrix),r$1u(s,this.settings,t.slicePlane,e.transform.origin.vec3);else {const r=new c$9(e.transform.position),a=o$Z(q,u$12(q,e.transform.rotationScale)),c=new j$2;r$Z(c.worldFromModel_TL,r.low),r$Z(c.worldFromModel_TH,r.high),n$1A(c.worldFromModel_RS,e.transform.rotationScale),n$1A(c.transformNormal_GlobalFromModel,a),d$18.bindModelTransform(s,c),s.setUniformMatrix3fv("uTransformNormal_GlobalFromModel",c.transformNormal_GlobalFromModel);const d=t.camera.viewInverseTransposeMatrix,g=o$S(M,d[3],d[7],d[11]);r$1u(s,this.settings,t.slicePlane,g);}"uber"!==this.settings.type&&"sketch"!==this.settings.type||this.setSketchUniforms(s),s.setUniform1f("uWorldLineRadiusPerDistance",Math.tan(t.camera.fovY/2)/(t.camera.fullViewport[3]/2));}setSketchUniforms(t){const r=this.settings.strokesTexture,i=r.texture;t$17(i)||(t.bindTexture(i,"uStrokesTexture"),t.setUniform2f("uStrokesTextureScale",1/i.descriptor.width,1/i.descriptor.height),t.setUniform1f("uStrokesLog2Resolution",M$B(r.resolution)),t.setUniform1f("uStrokesNormalizationScale",r.normalizationScale),t.setUniform1f("uStrokesAmplitude",r.amplitude),t.setUniform1f("uStrokeVariants",r.variants));}sortRenderables(){this.renderablesDirty=!1,this.sortedRenderables[1][1].clear(),this.sortedRenderables[1][2].clear(),this.sortedRenderables[2][1].clear(),this.sortedRenderables[2][2].clear(),this.renderables.forEach((e=>{0!==e.objectTransparency&&0!==e.edgeTransparency&&this.sortedRenderables[e.objectTransparency][e.edgeTransparency].push(e);}));const e=(e,t)=>"origin"in e.transform&&"origin"in t.transform?e.transform.origin.id<t.transform.origin.id?-1:e.transform.origin.id>t.transform.origin.id?1:0:0;this.sortedRenderables[1][1].sort(e),this.sortedRenderables[1][2].sort(e),this.sortedRenderables[2][1].sort(e),this.sortedRenderables[2][2].sort(e);}static getKey(e,t,s){return `edges-t:${e}:${t}:${s}`}}const w$1="uComponentDataTex",E="uComponentDataTexInvDim",q=r$1x(),M=n$11();

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class s$2 extends n$1C{constructor(e){super("EdgeProcessingWorker","wrappedWork",e);}async process(e,r,t){if(t)return f$15(e);const s=this._packInput(e),a=await this.invoke(s,r);return this._unpackOutput(a)}getTransferList(e){return [e.dataBuffer]}_packInput(r){return {dataBuffer:r.data.buffer,writerSettings:r.writerSettings,skipDeduplicate:r.skipDeduplicate,indicesBuffer:r.indices.buffer,indicesType:s$1f(r.indices)?"Uint32Array":"Uint16Array",indicesLength:r.indicesLength}}_unpackOutput(e){return {regular:{instancesData:D$v(e.regular.instancesData),lodInfo:{lengths:new Float32Array(e.regular.lodInfo.lengths)}},silhouette:{instancesData:D$v(e.silhouette.instancesData),lodInfo:{lengths:new Float32Array(e.silhouette.lodInfo.lengths)}},averageEdgeLength:e.averageEdgeLength}}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
function n$2(t){const s=4,n=p$1.resolution,i=n/2,a=new Uint8Array(s*n*n),c=s*n*i,h=p$1.amplitude,m=2*h,f=s*n,d=M$B(n)+1,g=p$1.strokes.length;let w=(d-1)*g*f;for(const{distance:e,pressure:o}of p$1.strokes){let t=e,n=o,i=w;for(let e=0;e<d;e++){0!==e&&(t=l$3(t,0),n=l$3(n,1));for(let e=0;e<p$1.resolution;e++){const o=.5+(t?t[e%t.length]/m:0),l=n?n[e%n.length]:1;D$t(o,a,i),D$t(l,a,i+c),i+=s;}i-=f*(g+1);}w+=f;}const M=new r$16(t,{pixelFormat:6408,dataType:5121,hasMipmap:!1,samplingMode:9729,width:n,height:n,wrapMode:10497},a);return new u$2(n,m,h,g,M)}function l$3(t,e){if(!t)return null;const s=t.length/2,r=a$1*s,o=new Array(s);let n=0;const i=1===e;for(let l=0;l<t.length;l+=2){const e=(t[l]+t[l+1])/2;o[n++]=i?Math.min(r,1-(1-e)*c$3):Math.min(r,e*c$3);}return o}const a$1=.1,c$3=.5;class u$2{constructor(t,e,s,r,o){this.resolution=t,this.normalizationScale=e,this.amplitude=s,this.variants=r,this.texture=o;}dispose(){this.texture=i$S(this.texture);}}const p$1={amplitude:8,resolution:256,strokes:[{distance:[-1.59027,-1.59426,-1.59674,-1.59766,-1.59702,-1.59479,-1.59095,-1.5855,-1.57843,-1.56973,-1.55942,-1.5475,-1.53398,-1.5189,-1.50226,-1.4841,-1.46446,-1.44337,-1.42088,-1.39703,-1.37188,-1.34547,-1.31786,-1.28912,-1.2593,-1.22847,-1.19668,-1.16402,-1.13053,-1.09629,-1.06137,-1.02582,-.98972,-.95313,-.91611,-.87872,-.84102,-.80306,-.76488,-.72654,-.68807,-.64952,-.61092,-.57232,-.53375,-.49527,-.45692,-.41874,-.38078,-.34309,-.3057,-.26867,-.23204,-.19585,-.16015,-.12497,-.09036,-.05634,-.02296,.00977,.04183,.07321,.10389,.13386,.16313,.19169,.21956,.24672,.27321,.299,.32413,.34858,.37237,.3955,.41798,.43981,.461,.48154,.50145,.52073,.53939,.55744,.57488,.5917,.6079,.62347,.63837,.65259,.66609,.67885,.69083,.70201,.71235,.72183,.73042,.73812,.7449,.75076,.7557,.75973,.76284,.76507,.76642,.76692,.76659,.76545,.76352,.76083,.7574,.75324,.74837,.74279,.73652,.72959,.72199,.71377,.70493,.69553,.68558,.67515,.66426,.65298,.64135,.62944,.6173,.60499,.59257,.58008,.56759,.55513,.54275,.5305,.51842,.50654,.4949,.48353,.47246,.4617,.45128,.44121,.43149,.42213,.41313,.40448,.39617,.38818,.3805,.37309,.36594,.35902,.35229,.34572,.33927,.33292,.32663,.32035,.31407,.30774,.30135,.29486,.28824,.28148,.27454,.26739,.26002,.25241,.24454,.23639,.22796,.21922,.21016,.20076,.19098,.18082,.17023,.1592,.14768,.13566,.1231,.10996,.09624,.08188,.06688,.05121,.03485,.01778,0,-.0185,-.03771,-.05763,-.07824,-.09952,-.12144,-.14396,-.16706,-.19069,-.21481,-.23938,-.26436,-.28971,-.31539,-.34136,-.36759,-.39404,-.42067,-.44746,-.47437,-.50136,-.52839,-.55544,-.58248,-.60948,-.63642,-.66329,-.6901,-.71684,-.74352,-.77015,-.79675,-.82332,-.84988,-.87644,-.90301,-.92958,-.95615,-.98272,-1.00926,-1.03575,-1.06217,-1.08847,-1.11463,-1.1406,-1.16633,-1.19178,-1.2169,-1.24164,-1.26595,-1.28979,-1.31312,-1.3359,-1.35809,-1.37963,-1.4005,-1.42064,-1.44,-1.45853,-1.47616,-1.49285,-1.50853,-1.52313,-1.53659,-1.54886,-1.55986,-1.56955,-1.57788,-1.5848],pressure:[-.01365,-.00206,.01025,.02327,.03696,.05129,.06619,.08163,.09755,.11393,.1307,.14784,.16531,.18308,.20111,.21938,.23786,.25651,.2753,.29419,.31315,.33215,.35115,.37015,.38913,.40806,.42694,.44576,.46449,.48313,.50167,.5201,.53839,.55653,.57448,.59222,.60971,.62692,.6438,.66033,.67648,.69221,.70753,.72242,.73688,.75093,.76456,.77779,.79063,.80309,.81517,.82686,.83817,.84911,.85967,.86987,.87972,.88924,.89845,.90734,.91594,.92425,.93229,.94005,.94754,.95475,.96166,.96826,.97451,.9804,.98588,.99092,.99549,.99957,.99685,.99381,.99131,.98936,.98796,.98711,.98681,.98706,.98787,.98923,.99113,.99357,.99654,1,.99607,.99171,.98695,.98181,.97634,.97057,.96452,.95824,.95175,.94506,.93818,.93113,.92389,.91647,.90887,.90109,.89314,.88501,.87672,.86831,.85978,.85119,.84256,.83393,.82533,.8168,.80836,.80002,.79181,.78374,.77582,.7681,.76059,.75331,.74629,.73955,.73311,.72697,.72116,.71568,.71054,.70572,.70121,.697,.69304,.68931,.68576,.68236,.67905,.67582,.67262,.66941,.66619,.66291,.65957,.65613,.65259,.64892,.6451,.6411,.6369,.63248,.62783,.62295,.61783,.61247,.60688,.60104,.59498,.58868,.58216,.57542,.56845,.56125,.5538,.5461,.53813,.52986,.52129,.51239,.50316,.49359,.4837,.47349,.46299,.45223,.44124,.43005,.41869,.40719,.39557,.38386,.37207,.36023,.34836,.33648,.32464,.31287,.30119,.28963,.27822,.26698,.25594,.2451,.23448,.22409,.21391,.20394,.19415,.18452,.17503,.16565,.15636,.14713,.13794,.1288,.11968,.11058,.10151,.09247,.08346,.07447,.06552,.05659,.0477,.03885,.03007,.02137,.01278,.00433,-.00393,-.012,-.01983,-.02738,-.03463,-.04155,-.0481,-.05429,-.0601,-.06553,-.07057,-.07524,-.07954,-.08347,-.08703,-.09022,-.09303,-.09544,-.09744,-.09898,-.10004,-.10059,-.1006,-.10005,-.09892,-.0972,-.09487,-.09192,-.08833,-.08409,-.07918,-.07357,-.06724,-.06019,-.0524,-.04386,-.03455,-.02448]},{distance:[-3.46259,-3.47131,-3.47668,-3.47863,-3.47712,-3.4721,-3.46352,-3.45138,-3.43566,-3.41635,-3.39347,-3.36704,-3.33709,-3.30368,-3.26684,-3.22667,-3.18322,-3.1366,-3.08689,-3.0342,-2.97865,-2.92036,-2.85946,-2.79607,-2.73034,-2.66241,-2.59242,-2.52052,-2.44686,-2.37159,-2.29485,-2.2168,-2.13757,-2.05731,-1.97616,-1.89426,-1.81174,-1.72875,-1.64543,-1.56191,-1.47833,-1.39483,-1.3115,-1.22847,-1.14581,-1.06361,-.98193,-.90083,-.82036,-.74054,-.66141,-.583,-.50532,-.4284,-.35228,-.277,-.20261,-.12916,-.05672,.01463,.08485,.15384,.22153,.28784,.35269,.41602,.47776,.53787,.59629,.653,.70799,.76123,.81274,.86253,.9106,.95698,1.0017,1.04477,1.0862,1.126,1.16415,1.20065,1.23546,1.26857,1.29994,1.32953,1.35731,1.38321,1.40719,1.42921,1.44922,1.46719,1.48309,1.49691,1.50862,1.51825,1.52581,1.53133,1.53486,1.53644,1.53616,1.53409,1.53031,1.52493,1.51803,1.50972,1.50009,1.48924,1.47725,1.46421,1.45019,1.43527,1.4195,1.40295,1.38568,1.36778,1.34929,1.3303,1.31087,1.29108,1.27099,1.25066,1.23018,1.2096,1.18898,1.16838,1.14785,1.12745,1.10721,1.08719,1.06741,1.04791,1.02871,1.00986,.99136,.97324,.95551,.93819,.92127,.90476,.88866,.87296,.85767,.84277,.82823,.81406,.80022,.7867,.77346,.76049,.74774,.73519,.72278,.71049,.69827,.68606,.67381,.66145,.64893,.63618,.62313,.60973,.5959,.5816,.56675,.5513,.53516,.51826,.50053,.4819,.46231,.44169,.42002,.39725,.37336,.34834,.32219,.2949,.2665,.23698,.20638,.17469,.14193,.10809,.07316,.03714,0,-.03827,-.07772,-.11836,-.16022,-.20332,-.24768,-.29332,-.34024,-.38844,-.43788,-.48854,-.54036,-.59329,-.64724,-.70211,-.75782,-.81425,-.87128,-.92881,-.98674,-1.04498,-1.10346,-1.1621,-1.22086,-1.27969,-1.33854,-1.3974,-1.45625,-1.51511,-1.57396,-1.63283,-1.69173,-1.75067,-1.80968,-1.86875,-1.9279,-1.98712,-2.04639,-2.10568,-2.16495,-2.22416,-2.28322,-2.34208,-2.40063,-2.4588,-2.51647,-2.57354,-2.62989,-2.68543,-2.74002,-2.79357,-2.84597,-2.89711,-2.94689,-2.99521,-3.04195,-3.087,-3.13023,-3.17152,-3.21075,-3.24779,-3.28252,-3.3148,-3.34451,-3.37154,-3.39577,-3.41709,-3.43539,-3.45059],pressure:[.87183,.87151,.87129,.87118,.87117,.87128,.87149,.87182,.87225,.8728,.87347,.87424,.87513,.87613,.87723,.87845,.87978,.88122,.88276,.88441,.88616,.88801,.88996,.892,.89414,.89637,.89868,.90108,.90356,.90611,.90874,.91144,.91421,.91704,.91993,.92287,.92587,.92892,.93201,.93514,.93831,.94151,.94474,.94799,.95126,.95456,.95786,.96118,.9645,.96783,.97116,.97448,.9778,.98111,.98441,.9877,.99096,.99421,.99742,.99938,.99622,.9931,.99001,.98697,.98397,.98101,.97811,.97526,.97246,.96972,.96703,.96441,.96185,.95935,.95691,.95455,.95225,.95002,.94786,.94577,.94376,.94182,.93995,.93817,.93646,.93483,.93328,.93181,.93042,.92911,.92788,.92673,.92566,.92467,.92376,.92293,.92217,.92149,.92088,.92034,.91987,.91947,.91913,.91886,.91864,.91849,.91838,.91833,.91834,.91839,.91849,.91863,.91883,.91907,.91935,.91968,.92005,.92046,.92092,.92142,.92195,.92253,.92314,.9238,.92449,.92521,.92598,.92677,.9276,.92847,.92936,.93029,.93125,.93224,.93325,.9343,.93537,.93646,.93758,.93872,.93988,.94106,.94225,.94346,.94469,.94593,.94718,.94844,.94971,.95098,.95226,.95354,.95482,.9561,.95738,.95867,.95995,.96122,.9625,.96377,.96504,.9663,.96757,.96883,.97009,.97135,.97261,.97387,.97513,.9764,.97767,.97895,.98023,.98153,.98284,.98416,.98549,.98684,.98821,.9896,.99101,.99244,.99389,.99537,.99688,.99842,1,.99839,.99675,.99508,.99336,.99161,.98982,.98799,.98613,.98422,.98228,.98029,.97827,.97622,.97414,.97202,.96987,.9677,.96551,.9633,.96107,.95882,.95656,.9543,.95202,.94975,.94747,.94519,.94292,.94065,.93838,.93613,.93388,.93164,.92941,.9272,.92499,.9228,.92062,.91846,.91631,.91418,.91207,.90998,.90792,.90588,.90387,.90189,.89995,.89804,.89617,.89434,.89256,.89083,.88914,.88752,.88595,.88443,.88299,.88161,.8803,.87907,.87791,.87683,.87584,.87494,.87412,.8734,.87278,.87225]},{distance:[.39335,.43437,.47737,.52234,.56923,.61801,.66864,.72109,.7753,.83123,.88882,.94801,1.00875,1.07097,1.13461,1.1996,1.26586,1.33333,1.40193,1.47158,1.54221,1.61373,1.68607,1.75913,1.83284,1.90711,1.98186,2.05699,2.13243,2.20809,2.28387,2.35971,2.4355,2.51117,2.58663,2.66179,2.73658,2.81092,2.88473,2.95792,3.03043,3.10217,3.17308,3.24309,3.31211,3.3801,3.44697,3.51267,3.57712,3.64028,3.70208,3.76247,3.8214,3.87881,3.93467,3.98892,4.04152,4.09244,4.14164,4.18908,4.23474,4.27859,4.32061,4.36077,4.39905,4.43544,4.46992,4.50249,4.53314,4.56185,4.58864,4.61349,4.63642,4.65745,4.67657,4.69381,4.7092,4.72274,4.73447,4.74441,4.75259,4.75903,4.76376,4.76682,4.76822,4.768,4.76618,4.76279,4.75786,4.75142,4.74348,4.73409,4.72326,4.71102,4.69739,4.68241,4.6661,4.64849,4.6296,4.60948,4.58816,4.56567,4.54204,4.51732,4.49154,4.46473,4.43694,4.4082,4.37854,4.348,4.31662,4.28443,4.25145,4.21773,4.1833,4.14819,4.11243,4.07606,4.03912,4.00162,3.96361,3.92512,3.88618,3.84683,3.80708,3.76697,3.72653,3.68579,3.64478,3.60351,3.56202,3.52033,3.47845,3.43642,3.39425,3.35196,3.30957,3.2671,3.22455,3.18196,3.13933,3.09668,3.05402,3.01136,2.96873,2.92613,2.88357,2.84108,2.79865,2.75631,2.71407,2.67195,2.62994,2.58807,2.54634,2.50477,2.46338,2.42216,2.38114,2.34032,2.29971,2.25933,2.21916,2.17923,2.13954,2.10008,2.06087,2.02189,1.98316,1.94468,1.90644,1.86845,1.83069,1.79316,1.75586,1.71877,1.68189,1.6452,1.60868,1.57232,1.53611,1.50004,1.46407,1.4282,1.39241,1.35668,1.321,1.28535,1.24972,1.2141,1.17849,1.14286,1.10723,1.07158,1.03593,1.00028,.96464,.92902,.89344,.85793,.8225,.78719,.75203,.71705,.68231,.64784,.61369,.57991,.54656,.51368,.48134,.44959,.41849,.3881,.35848,.32967,.30174,.27474,.24872,.22373,.19982,.17702,.15539,.13497,.11579,.09791,.08137,.06621,.05248,.04022,.02948,.02029,.01271,.00677,.00252,0,-76e-5,27e-5,.00314,.00788,.01451,.02307,.03357,.04604,.0605,.07697,.09546,.11599,.13858,.16322,.18992,.21869,.24952,.28241,.31735,.35434],pressure:[.95248,.95236,.95228,.95223,.95222,.95224,.95231,.95241,.95256,.95274,.95296,.95322,.95352,.95385,.95423,.95465,.9551,.9556,.95613,.9567,.95731,.95796,.95864,.95936,.96012,.96091,.96173,.96259,.96348,.9644,.96535,.96633,.96734,.96838,.96944,.97053,.97164,.97277,.97393,.9751,.97629,.9775,.97873,.97997,.98122,.98249,.98376,.98505,.98634,.98763,.98893,.99023,.99154,.99284,.99414,.99544,.99673,.99802,.9993,.99942,.99816,.99691,.99568,.99445,.99324,.99205,.99087,.98972,.98858,.98746,.98636,.98528,.98423,.9832,.98219,.98121,.98025,.97931,.9784,.97752,.97666,.97582,.97501,.97423,.97347,.97274,.97203,.97135,.9707,.97007,.96948,.9689,.96836,.96784,.96735,.96689,.96646,.96605,.96567,.96533,.965,.96471,.96445,.96421,.964,.96382,.96367,.96355,.96346,.96339,.96335,.96334,.96336,.9634,.96348,.96358,.9637,.96385,.96403,.96423,.96446,.96471,.96499,.96529,.96561,.96595,.96631,.96669,.96709,.96751,.96795,.9684,.96887,.96935,.96984,.97035,.97087,.9714,.97194,.97249,.97304,.97361,.97418,.97476,.97534,.97592,.97651,.97711,.9777,.9783,.9789,.9795,.9801,.9807,.9813,.9819,.9825,.98309,.98369,.98428,.98486,.98545,.98603,.98661,.98718,.98775,.98832,.98888,.98944,.99,.99056,.99112,.99167,.99223,.99279,.99335,.99392,.99449,.99507,.99565,.99624,.99684,.99745,.99807,.9987,.99934,1,.99933,.99866,.99797,.99727,.99656,.99583,.9951,.99435,.99359,.99283,.99205,.99126,.99046,.98966,.98885,.98803,.9872,.98637,.98554,.9847,.98387,.98303,.98219,.98134,.9805,.97967,.97883,.978,.97717,.97634,.97552,.97471,.97389,.97309,.97229,.9715,.97071,.96993,.96915,.96838,.96762,.96687,.96612,.96539,.96466,.96395,.96324,.96255,.96187,.9612,.96055,.95991,.95929,.95869,.95811,.95754,.957,.95648,.95599,.95552,.95508,.95467,.95428,.95393,.9536,.95331,.95305,.95283,.95264]},{distance:[2.85606,2.86149,2.86432,2.8645,2.862,2.85686,2.84912,2.83886,2.82618,2.81117,2.79393,2.77456,2.75314,2.72975,2.70447,2.67734,2.64844,2.61784,2.58564,2.55196,2.5169,2.48057,2.44305,2.40438,2.36462,2.32383,2.28208,2.23943,2.19591,2.15153,2.10628,2.06016,2.01321,1.96548,1.91702,1.86793,1.8183,1.76829,1.71803,1.66767,1.61737,1.56726,1.51746,1.46803,1.41902,1.37044,1.32228,1.27452,1.22716,1.18023,1.13376,1.08781,1.04244,.99769,.95357,.91003,.86701,.82447,.78238,.74069,.69938,.65836,.61758,.57699,.53656,.49627,.45611,.41611,.37632,.33683,.29776,.25924,.22141,.18441,.14839,.11346,.07972,.04727,.01619,-.01348,-.0417,-.0684,-.09351,-.11698,-.13875,-.1588,-.17713,-.19381,-.20889,-.22242,-.23444,-.24501,-.25421,-.26216,-.26897,-.27473,-.27951,-.28336,-.28631,-.28836,-.28948,-.28963,-.28873,-.28673,-.28355,-.27916,-.27354,-.26673,-.25878,-.2498,-.23992,-.22929,-.21802,-.20623,-.19398,-.18134,-.16836,-.1551,-.14163,-.12809,-.11461,-.1013,-.08826,-.07557,-.06335,-.0517,-.04077,-.03065,-.02143,-.01321,-.00606,0,.00496,.00888,.01181,.01385,.01511,.0157,.01574,.01533,.01458,.01358,.0124,.01112,.00979,.00851,.00738,.0065,.006,.00596,.00646,.00754,.00924,.01161,.01471,.01858,.02323,.02865,.03481,.04169,.0493,.05765,.06677,.07671,.08754,.09934,.11222,.12628,.14159,.15823,.17624,.19561,.21632,.23828,.26142,.28563,.31083,.33696,.36397,.39185,.42057,.4501,.48036,.51125,.54264,.5744,.60646,.63871,.67105,.70337,.73556,.76751,.79918,.83048,.86139,.8919,.92202,.95184,.98144,1.01094,1.04045,1.0701,1.10002,1.13029,1.16103,1.1923,1.22416,1.25664,1.28979,1.32364,1.35824,1.39363,1.42985,1.4669,1.50475,1.54332,1.58252,1.62227,1.6625,1.70312,1.744,1.78501,1.82598,1.8668,1.90734,1.94754,1.98732,2.02666,2.06555,2.10402,2.1421,2.17985,2.2173,2.25448,2.29139,2.328,2.36424,2.4,2.43515,2.46955,2.50309,2.53565,2.56717,2.59761,2.62692,2.65505,2.68191,2.7074,2.73138,2.75375,2.7744,2.79324,2.81017,2.82504,2.83772,2.8481],pressure:[.22758,.23641,.24578,.25568,.26609,.27699,.28835,.30016,.31237,.32495,.33789,.35113,.36466,.37843,.39241,.40658,.4209,.43535,.44989,.4645,.47916,.49385,.50853,.5232,.53784,.55243,.56696,.58141,.59578,.61004,.62419,.63821,.65209,.6658,.67934,.69268,.70582,.71873,.73139,.7438,.75594,.76779,.77935,.79061,.80156,.81221,.82254,.83258,.84231,.85176,.86091,.86978,.87837,.88669,.89473,.9025,.91,.91725,.92425,.931,.93752,.9438,.94985,.95566,.96124,.96658,.97168,.97652,.98109,.98539,.98939,.99309,.99646,.99949,.99783,.99552,.99361,.99209,.99098,.99029,.99003,.99019,.99079,.99181,.99324,.9951,.99735,1,.99698,.99361,.98992,.98592,.98163,.97709,.97231,.96731,.96212,.95676,.95122,.94554,.93973,.93378,.92773,.92157,.91532,.90899,.90258,.89612,.88961,.88308,.87653,.87,.8635,.85705,.85068,.8444,.83823,.83219,.82628,.82052,.81493,.80952,.8043,.79929,.7945,.78994,.78561,.78151,.77765,.77402,.77062,.76742,.76443,.76161,.75896,.75645,.75406,.75175,.74951,.7473,.74511,.74289,.74064,.73833,.73592,.73341,.73078,.728,.72507,.72197,.71869,.71522,.71156,.70769,.70363,.69936,.69489,.69021,.68533,.68023,.67492,.66939,.66363,.65765,.65145,.64501,.63833,.63143,.62428,.61691,.60931,.60148,.59344,.58521,.57679,.5682,.55948,.55063,.54167,.53264,.52354,.51439,.50522,.49603,.48686,.47773,.46865,.45964,.45072,.44192,.43324,.42469,.41629,.40804,.39994,.392,.3842,.37655,.36903,.36164,.35437,.3472,.34012,.33312,.3262,.31933,.31251,.30574,.299,.2923,.28563,.27899,.27239,.26583,.25933,.25288,.24652,.24025,.2341,.22808,.22221,.21653,.21104,.20576,.20072,.19592,.19138,.18712,.18313,.17943,.17602,.17292,.17013,.16766,.16551,.16369,.16222,.1611,.16036,.16001,.16007,.16055,.16148,.16286,.16471,.16705,.16988,.17321,.17706,.18144,.18636,.19182,.19785,.20443,.21158,.2193]},{distance:[-2.31317,-2.3191,-2.32189,-2.32154,-2.31811,-2.31174,-2.30254,-2.29062,-2.27609,-2.25904,-2.23954,-2.21767,-2.19355,-2.16732,-2.13907,-2.10885,-2.07672,-2.04268,-2.00677,-1.96911,-1.92985,-1.88914,-1.84713,-1.80397,-1.75979,-1.71467,-1.66864,-1.62171,-1.57395,-1.52546,-1.47625,-1.42628,-1.3755,-1.32384,-1.27131,-1.218,-1.16408,-1.10972,-1.05508,-1.00031,-.94551,-.89077,-.83615,-.7817,-.72757,-.6739,-.62076,-.56821,-.51625,-.46484,-.41397,-.36366,-.314,-.26506,-.21689,-.16957,-.12316,-.07766,-.03301,.01085,.05399,.09643,.13827,.17967,.22079,.26176,.30265,.34342,.38397,.42414,.46381,.50285,.54115,.57863,.61524,.65093,.6856,.71914,.75153,.78275,.81283,.84182,.86972,.89651,.92208,.94634,.96919,.99052,1.01025,1.02835,1.04484,1.05976,1.07309,1.08479,1.09492,1.1036,1.11096,1.11714,1.12224,1.12627,1.12916,1.13083,1.13125,1.13036,1.12816,1.12466,1.11992,1.11397,1.10677,1.09827,1.08849,1.07746,1.06527,1.05203,1.03786,1.02283,1.00695,.99025,.97279,.9546,.93573,.9163,.8965,.8765,.85647,.83652,.81687,.79775,.77939,.76199,.74568,.73049,.71635,.70316,.69082,.67925,.66834,.65804,.64831,.63911,.63032,.62184,.61363,.60564,.59788,.59036,.58308,.57597,.5689,.56177,.55447,.5469,.53896,.53062,.5219,.51283,.5034,.49355,.48335,.47287,.46223,.45154,.44085,.43012,.41923,.40805,.39648,.38441,.37176,.35849,.34458,.32999,.31461,.29833,.28109,.26288,.2437,.22361,.20265,.18082,.15807,.13434,.1096,.0838,.0569,.02894,0,-.0298,-.0604,-.09173,-.12364,-.15594,-.18843,-.22092,-.25331,-.28559,-.31781,-.35006,-.38244,-.41502,-.44785,-.48098,-.5144,-.54811,-.58218,-.61666,-.65153,-.68677,-.72232,-.75807,-.79397,-.83002,-.86628,-.90281,-.93968,-.97693,-1.01465,-1.05282,-1.09139,-1.13031,-1.16956,-1.20917,-1.24905,-1.28907,-1.32908,-1.36891,-1.40844,-1.44765,-1.48658,-1.52527,-1.56376,-1.60206,-1.64016,-1.67801,-1.71552,-1.75264,-1.78936,-1.8257,-1.86161,-1.89702,-1.93182,-1.96584,-1.99894,-2.03102,-2.06203,-2.0919,-2.12056,-2.14794,-2.17397,-2.19852,-2.22138,-2.24235,-2.26129,-2.27805,-2.29243,-2.30422],pressure:[.9681,.97424,.98046,.98674,.99309,.9995,.99404,.98754,.981,.97444,.96785,.96124,.95462,.94801,.94139,.93479,.92822,.92167,.91515,.90868,.90225,.89589,.88959,.88336,.87722,.87115,.86519,.85932,.85356,.84792,.84239,.83699,.83173,.8266,.82162,.81679,.81211,.80759,.80324,.79906,.79505,.79121,.78756,.78409,.78081,.77771,.77481,.77211,.76959,.76728,.76516,.76324,.76153,.76001,.75869,.75757,.75665,.75593,.7554,.75507,.75493,.75498,.75523,.75565,.75627,.75706,.75803,.75917,.76049,.76197,.76361,.76541,.76737,.76947,.77172,.77409,.7766,.77923,.78198,.78484,.7878,.79086,.79401,.79724,.80055,.80394,.8074,.81092,.8145,.81813,.82182,.82556,.82934,.83317,.83703,.84093,.84487,.84884,.85284,.85687,.86094,.86503,.86915,.87329,.87746,.88166,.88587,.89011,.89436,.89863,.90291,.9072,.91149,.91579,.92009,.92438,.92867,.93295,.9372,.94144,.94566,.94985,.954,.95812,.96219,.96623,.97021,.97415,.97802,.98184,.9856,.9893,.99293,.9965,1,.99657,.9932,.98991,.98668,.98352,.98042,.97738,.9744,.97148,.9686,.96577,.96298,.96023,.95751,.95482,.95214,.94949,.94684,.9442,.94156,.93892,.93627,.93361,.93094,.92825,.92555,.92284,.9201,.91735,.91458,.91179,.90899,.90616,.90332,.90047,.8976,.89472,.89183,.88893,.88603,.88314,.88024,.87735,.87448,.87162,.86878,.86597,.86319,.86044,.85774,.85508,.85247,.84993,.84744,.84503,.84269,.84042,.83825,.83616,.83417,.83227,.83048,.8288,.82724,.82578,.82445,.82324,.82215,.82119,.82037,.81967,.81911,.81868,.81839,.81824,.81823,.81835,.81862,.81903,.81957,.82026,.82109,.82206,.82317,.82443,.82583,.82737,.82906,.83089,.83287,.83499,.83726,.83968,.84223,.84494,.84778,.85077,.8539,.85717,.86058,.86412,.86781,.87163,.87559,.87968,.88391,.88826,.89275,.89737,.90211,.90698,.91198,.91709,.92233,.92768,.93315,.93873,.94441,.95019,.95607,.96205]},{distance:[4.72925,4.81721,4.9037,4.98859,5.07177,5.15311,5.23249,5.3098,5.38491,5.45772,5.52811,5.59598,5.66122,5.72375,5.78346,5.84028,5.8941,5.94486,5.99248,6.03689,6.07803,6.11584,6.15028,6.18128,6.20882,6.23285,6.25336,6.27031,6.28369,6.29348,6.29969,6.3023,6.30133,6.29678,6.28867,6.27703,6.26187,6.24324,6.22116,6.19567,6.16683,6.13468,6.09928,6.06068,6.01896,5.97417,5.92639,5.87569,5.82217,5.76589,5.70696,5.64545,5.58147,5.5151,5.44644,5.37559,5.30265,5.2277,5.15085,5.0722,4.99184,4.90987,4.82639,4.74151,4.65533,4.56794,4.47945,4.38996,4.29959,4.20843,4.11658,4.02416,3.93125,3.83796,3.74437,3.65057,3.55666,3.46272,3.36884,3.27509,3.18155,3.08831,2.99545,2.90303,2.81114,2.71984,2.62922,2.53933,2.45026,2.36207,2.27484,2.18862,2.10349,2.01951,1.93675,1.85528,1.77515,1.69644,1.61919,1.54348,1.46935,1.39685,1.32605,1.25698,1.18967,1.12417,1.06049,.99863,.93862,.88044,.82408,.76953,.71676,.66574,.61644,.56882,.52282,.47841,.43553,.39413,.35414,.31551,.27817,.24206,.20712,.17328,.14048,.10866,.07776,.04772,.01848,-.00999,-.03776,-.06487,-.09134,-.11721,-.14251,-.16725,-.19144,-.21509,-.2382,-.26076,-.28275,-.30416,-.32496,-.34511,-.36459,-.38334,-.40134,-.41852,-.43485,-.45026,-.46471,-.47815,-.49052,-.50179,-.51189,-.52081,-.52849,-.5349,-.54003,-.54383,-.54627,-.54734,-.54702,-.54528,-.54211,-.53752,-.53149,-.52403,-.51515,-.50487,-.4932,-.48015,-.46575,-.45001,-.43297,-.41463,-.39503,-.37419,-.35213,-.32887,-.30443,-.27885,-.25214,-.22432,-.19541,-.16544,-.13442,-.10235,-.06926,-.03514,0,.03616,.07336,.11159,.15088,.19125,.23272,.27531,.31906,.36401,.41019,.45764,.5064,.55651,.60802,.66096,.71538,.77129,.82874,.88776,.94836,1.01056,1.07438,1.13982,1.20687,1.27554,1.34581,1.41766,1.49107,1.56599,1.64239,1.72025,1.79951,1.88013,1.96209,2.04532,2.12979,2.21546,2.30226,2.39017,2.47911,2.56905,2.65991,2.75164,2.84416,2.93742,3.03133,3.12582,3.2208,3.31619,3.41191,3.50785,3.60393,3.70006,3.79612,3.89202,3.98765,4.08291,4.17767,4.27182,4.36525,4.45783,4.54944,4.63995],pressure:[.30942,.30838,.30765,.30724,.30715,.30738,.30795,.30884,.31007,.31164,.31354,.31578,.31837,.32129,.32455,.32815,.33209,.33636,.34097,.34591,.35117,.35675,.36265,.36887,.37539,.38221,.38933,.39674,.40442,.41238,.4206,.42907,.43779,.44675,.45593,.46533,.47493,.48473,.49471,.50486,.51517,.52563,.53623,.54694,.55777,.5687,.57971,.59079,.60194,.61313,.62435,.6356,.64686,.65811,.66935,.68056,.69174,.70286,.71391,.72489,.73579,.74659,.75728,.76785,.7783,.7886,.79876,.80877,.81861,.82827,.83776,.84706,.85617,.86507,.87378,.88227,.89056,.89863,.90649,.91412,.92153,.92872,.93568,.94241,.94892,.95519,.96122,.96702,.97258,.97791,.98299,.98783,.99242,.99677,.99911,.99525,.99164,.98827,.98515,.98228,.97966,.97728,.97514,.97324,.97159,.97017,.96898,.96801,.96727,.96674,.96641,.96629,.96635,.96661,.96703,.96762,.96838,.96928,.97032,.97149,.97279,.9742,.97572,.97734,.97905,.98085,.98273,.98468,.98669,.98877,.99091,.99311,.99535,.99765,1,.9976,.99516,.99267,.99014,.98755,.98491,.98222,.97947,.97666,.97378,.97083,.96781,.96471,.96153,.95826,.9549,.95144,.94787,.9442,.94042,.93651,.93249,.92834,.92407,.91966,.91512,.91045,.90564,.90069,.8956,.89037,.885,.87949,.87384,.86806,.86214,.85608,.84988,.84356,.83711,.83053,.82383,.81702,.81009,.80306,.79594,.78872,.78141,.77403,.76657,.75905,.75148,.74385,.73619,.72849,.72076,.71302,.70526,.69749,.68972,.68195,.67419,.66644,.65871,.65099,.64329,.63561,.62795,.62032,.61271,.60512,.59755,.59001,.58248,.57497,.56749,.56002,.55256,.54512,.5377,.5303,.52291,.51554,.50819,.50087,.49358,.48632,.4791,.47192,.4648,.45773,.45072,.44378,.43692,.43015,.42346,.41687,.41039,.40403,.39779,.39168,.38571,.37989,.37423,.36873,.36342,.35828,.35335,.34862,.34409,.3398,.33573,.3319,.32831,.32498,.32192,.31912,.3166,.31436,.31242,.31077]}]};

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
function e$1(t){let e=null;for(const r of t){const t=r.type;if(c$2(r))if(t$17(e))e=t;else if(e!==t)return "uber"}return r$Y(e)?e:"solid"}function o(t){let n=0;for(const{material:r}of t)if(c$2(r)){if(r.color[3]*r.opacity<1)return 1;n=2;}return n}function i$1(t){let n=0;for(const{material:r}of t)if(c$2(r)){switch(r.objectTransparency){case 1:case 0:return 1;case 2:if(r.opacity<1)return 1}n=2;}return n}function c$2(t){return t.size*t.color[3]*t.opacity>0}function f$2(t,n,r,e){return r*(e/t)*2*Math.tan(.5*n)}function u$1(n,r){const e=p$1h(n,r,!0);return -1===e?r<n[0]?0:n.length:e}function s$1(t,n,r){return t.length-u$1(t,n*r.minimumEdgeLength)}function l$2(t,n,r,e){for(let o=0;o<t.length;o++){const i=t[o].index,c=n[o],f=n[o+1];if(e)for(let t=c;t<f;t++){const n=e[t];r.set(n,i);}else for(let t=c;t<f;t++)r.set(t,i);}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
const Z=n$12.getLogger("esri.views.3d.webgl-engine.lib.edgeRendering.EdgeView");let $=class extends p$14{constructor(e){super(e),this.updatingHandles=new l$V,this.perObjectData=new Map,this.renderers=new Map,this.numberOfRenderedEdges=0,this.gpuMemoryUsage=0,this.workerAbort=h$N(),this.tmpModelPosition=n$11(),this.tmpCameraPosition=n$11(),this.localOrigins=new e$2(new d$r(e.renderSR));}initialize(){this.worker=new s$2(this.schedule),this.componentColorManager=new r$2(this.rctx,2);const e=i$1e.createBuffer(4);for(let t=0;t<4;t++)e.sideness.set(t,0,0===t||3===t?0:1),e.sideness.set(t,1,0===t||1===t?0:1);this.verticesBufferObject=h$O.createVertex(this.rctx,35044,e.buffer);}destroy(){this.destroyed||(this.perObjectData.forEach((e=>this._discardObjectEntry(e))),this.perObjectData.clear(),this.strokesTexture=i$S(this.strokesTexture),this.componentColorManager=l$W(this.componentColorManager),this.workerAbort.abort(),this.worker.destroy(),this.verticesBufferObject=i$S(this.verticesBufferObject),this.renderers.clear(),this.updatingHandles.destroy());}get updating(){return this.updatingHandles.updating}get usedMemory(){return this.gpuMemoryUsage}get numberOfRenderedPrimitives(){return this.numberOfRenderedEdges}shouldRender(){return this.renderers.size>0}async addComponentObject(e,t,r,s,o,i,n,a){if(this.hasObject(e))return;let c;const d=new re(new Promise((e=>c=e)),r);this.perObjectData.set(e,d),await this.updatingHandles.addPromise(this.addComponentGeometry(t,d,s,o,i,n,a)),this.setNeedsRender(),c();}async addOrUpdateObject3D(e,t,r,s){if(this.destroyed)return void Z.warn("Attempt to add an object to a destroyed instance");const o=this.perObjectData.get(e);let i;const n=new re(new Promise((e=>i=e)));this.perObjectData.set(e,n);const a=new Array;if(r.mergeGeometries&&e.geometries.length>1&&te(e))a.push(this.addObjectMergedGeometries(e,n,t,r,s));else for(let c=0;c<e.geometries.length;c++){const o=e.geometries[c],i=e.geometryRecords[c];i.material.supportsEdges&&a.push(this.addGeometry(e,n,o,i,t[0],r,s));}await this.updatingHandles.addPromise(Promise.all(a)),this._discardObjectEntry(o),this.setNeedsRender(),i();}_discardObjectEntry(e){e&&(e.renderables.length&&(e.renderables.forEach((e=>this.removeRenderable(e))),this.setNeedsRender()),e.loaded=null);}hasObject(e){return this.perObjectData.has(e)}async updateAllComponentOpacities(e,t){const r=t instanceof Array?e=>t[e]:()=>t;(await this.updatingHandles.addPromise(this.getObjectEntry(e))).renderables.forEach((e=>{const t=e.components.meta.length;for(let s=0;s<t;s++){const t=r(s),o=e.components.meta[s],i=o.index;o.material.opacity=t,e.components.buffer.textureBuffer.setDataElement(i,1,3,255*t);}this.updateTransparency(e);})),this.setNeedsRender();}async updateAllComponentMaterials(e,t,r,s){const o=e instanceof R$p,i=!!r.slicePlaneEnabled,n=e$1(t),a=S.getKey(n,i,o);(await this.updatingHandles.addPromise(this.getObjectEntry(e))).renderables.forEach((e=>{if(a!==e.rendererKey){const t=this.renderers.get(e.rendererKey),r=this.acquireRenderer(n,i,o);t.removeRenderable(e),t.refCount.decrement(),e.rendererKey=a,r.addRenderable(e);}for(let r=0;r<t.length;r++)e.components.meta[r].material=t[r];s&&this.updateComponentBuffer(e.components),this.updateTransparency(e);})),this.setNeedsRender();}async updateObjectVisibility(e,t){(await this.updatingHandles.addPromise(this.getObjectEntry(e))).renderables.forEach((e=>e.visible=t)),this.setNeedsRender();}removeObject(e){const t=this.perObjectData.get(e);t&&(this.perObjectData.delete(e),this._discardObjectEntry(t));}async getObjectEntry(e){const t=this.perObjectData.get(e);if(!t)throw "no object";return await t.loaded,t}removeAll(){this.perObjectData.forEach(((e,t)=>this.removeObject(t)));}render(e,t){if(t$17(this.componentColorManager))return;this.localOrigins.updateViewMatrices(e.camera.viewMatrix);const r=e.camera.viewInverseTransposeMatrix,s=n$11(),o=new c$9,i=new d$18.ViewProjectionTransform,n=e$Z();o$S(s,r[3],r[7],r[11]),o.set(s),r$Z(i.worldFromView_TH,o.high),r$Z(i.worldFromView_TL,o.low),a$19(i.viewFromCameraRelative_RS,e.camera.viewMatrix),n$18(i.projFromView,e.camera.projectionMatrix);const c=e$Z();o$Z(c,i.viewFromCameraRelative_RS),u$12(n,c);let d=0,l=0;if(this.renderers.forEach((e=>{0===e.refCount.value?(this.renderers.delete(e.key),e.dispose()):e.forEachRenderable((e=>{d+=e.statistics.averageEdgeLength,l++;}),t);})),this.componentColorManager.garbageCollect(),this.componentColorManager.updateTextures(),0===l)return;const m={distanceFalloffFactor:40*d/l,minimumEdgeLength:f$2(e.camera.fullViewport[3],e.camera.fovY,1,3.5*e.camera.pixelRatio),transparency:t,viewProjectionTransform:i,transformNormal_ViewFromGlobal:n};this.updateObjectCameraDistances(e),this.numberOfRenderedEdges=0,this.renderers.forEach((t=>{this.renderRegularEdges(t,e,m),this.renderSilhouetteEdges(t,e,m);}));}updateTransparency(e){const t=o(e.components.meta),r=i$1(e.components.meta);t===e.edgeTransparency&&r===e.objectTransparency||(e.edgeTransparency=t,e.objectTransparency=r,this.renderers.get(e.rendererKey).setRenderablesDirty());}computeModelTransformWithLocalOrigin(e,t,r){if(e.getCombinedStaticTransformation(t,r),r$Y(t.origin))this.localOrigins.register(t.origin);else {const e=o$S(this.tmpModelPosition,r[12],r[13],r[14]);t.origin=this.localOrigins.acquire(e);}return n$3(t.origin.vec3,r),t.origin}updateComponentBuffer(e){const{meta:t,buffer:r}=e;for(let s=0;s<t.length;s++){const e=t[s].material,i=t[s].index,n=o$R(Math.round(e.size*T$1),0,255),a=o$R(e.extensionLength,-R,255-R)+R,c="solid"===e.type?0:1,d=255*e.opacity,l=e.color,m=255*l[0],g=255*l[1],u=255*l[2],h=255*l[3];r.textureBuffer.setData(i,0,m,g,u,h),r.textureBuffer.setData(i,1,n,a,c,d);}}createComponentBuffers(e){if(t$17(this.componentColorManager))return null;const t=new Array,r=this.componentColorManager.getBuffer(e.length);for(let o=0;o<e.length;o++){const s=e[o],i=r.acquireIndex();t.push({index:i,material:s});}const s={meta:t,buffer:r};return this.updateComponentBuffer(s),s}extractEdges(e,t,r,s,o,i=o.length){return this.worker.process({data:t,indices:o,indicesLength:i,writerSettings:e,skipDeduplicate:r},this.workerAbort.signal,s)}createEdgeResources(e){const t={};if(t$17(this.verticesBufferObject))return t;if(e.regular.lodInfo.lengths.length>0){const r=new f$M(this.rctx,p$1g,{vertices:t$1v,instances:d$19.glLayout},{vertices:this.verticesBufferObject,instances:h$O.createVertex(this.rctx,35044,e.regular.instancesData.buffer)});t.regular={vao:r,lod:e.regular.lodInfo};}if(e.silhouette.lodInfo.lengths.length>0){const r=new f$M(this.rctx,p$1g,{vertices:t$1v,instances:w$J.glLayout},{vertices:this.verticesBufferObject,instances:h$O.createVertex(this.rctx,35044,e.silhouette.instancesData.buffer)});t.silhouette={vao:r,lod:e.silhouette.lodInfo};}return t}async addGeometry(e,t,r,s,o,i,n){const a=r.vertexAttributes.get("position"),c=r.indices.get("position"),d=e$P(),l={position:a,indices:c,modelTransform:d,origin:this.computeModelTransformWithLocalOrigin(e,s,d)};return this.addPositionData(t,l,r.edgeIndicesLength,o,i,n)}async addPositionData(e,t,r,s,o$1,i=!1){if(null==e.loaded)return;const n=this.createComponentBuffers([s]);if(t$17(n)||r<=0)return;const c=this.acquireRenderer(s.type,!!o$1.slicePlaneEnabled),{modelTransform:d,origin:l}=t,m=t.indices,g=t.position,u=g.data.length/g.size,h=e$1e.createBuffer(u);for(let a=0;a<u;a++)h.position.set(a,0,g.data[a*g.size+0]),h.position.set(a,1,g.data[a*g.size+1]),h.position.set(a,2,g.data[a*g.size+2]);l$2(n.meta,[0,h.componentIndex.count],h.componentIndex);const p=await this.updatingHandles.addPromise(this.extractEdges(c.writerSettings,h,!1,i,m,r));if(null==e.loaded)return;const{regular:f,silhouette:b}=this.createEdgeResources(p),y=(f?f.vao.size:0)+(b?b.vao.size:0),j={regular:f,silhouette:b,transform:{modelMatrix:d,origin:l},statistics:{gpuMemoryUsage:y,averageEdgeLength:p.averageEdgeLength},components:n,visible:!0,edgeTransparency:o(n.meta),objectTransparency:i$1(n.meta),distanceToCamera:0,rendererKey:c.key};e.renderables.push(j),c.addRenderable(j),this.gpuMemoryUsage+=y;}async addComponentGeometry(e,t,r,s,o$1,i,n){if(null==t.loaded)return;const c=this.createComponentBuffers(i);if(t$17(c))return;const d=e$1(i),l=this.acquireRenderer(d,n.slicePlaneEnabled||!1,!1),m=e$1e.createBuffer(r.count);e$1f(m.position,r),l$2(c.meta,o$1,m.componentIndex,s);const g=!0,u=l.writerSettings,h=await this.updatingHandles.addPromise(this.extractEdges(u,m,g,!1,s));if(null==t.loaded)return;const{regular:p,silhouette:f}=this.createEdgeResources(h),b=(p?p.vao.size:0)+(f?f.vao.size:0),y={regular:p,silhouette:f,transform:e,statistics:{gpuMemoryUsage:b,averageEdgeLength:h.averageEdgeLength},components:c,visible:!0,edgeTransparency:o(c.meta),objectTransparency:i$1(c.meta),distanceToCamera:0,rendererKey:l.key};t.renderables.push(y),l.addRenderable(y),this.gpuMemoryUsage+=b;}async addObjectMergedGeometries(e,t,r,s,o){const i=new Map;let n=0,a=null,c=null;for(let b=0;b<e.geometries.length;b++){const t=e.geometries[b],r=e.geometryRecords[b];if(!r.material.supportsEdges)continue;!c&&r.origin&&(c=r);const s=t.indices.get("position");n+=t.edgeIndicesLength,null!=a&&a!==Uint16Array||(a=i$1f(s)?Uint16Array:Uint32Array);}const d=n?new a(n):null,m=[];let g=0;for(let l=0;l<e.geometries.length;l++){const t=e.geometries[l];if(!e.geometryRecords[l].material.supportsEdges)continue;const r=t.vertexAttributes.get("position"),s=t.indices.get("position");let o=i.get(r.data);if(null==o){o=m.length/3;for(let e=0;e<r.data.length;e+=r.size)m.push(r.data[e+0]),m.push(r.data[e+1]),m.push(r.data[e+2]);i.set(r.data,o);}if(s)for(let e=0;e<t.edgeIndicesLength;e++)d[g++]=o+s[e];}const u=c||e.geometryRecords[0],h=e$P(),p=this.computeModelTransformWithLocalOrigin(e,u,h);for(let l=0;l<e.geometryRecords.length;l++)e.geometryRecords[l].origin=p;const f={position:{data:m,size:3},indices:d,modelTransform:h,origin:p};await this.updatingHandles.addPromise(this.addPositionData(t,f,d.length,r[0],s,o));}acquireRenderer(e,t,r=!0){const s=S.getKey(e,t,r);let o=this.renderers.get(s);return t$17(this.strokesTexture)&&(this.strokesTexture=n$2(this.rctx)),o||(o=new S(this.rctx,this.techniqueRepository,{type:e,slicePlaneEnabled:t,strokesTexture:this.strokesTexture,legacy:r}),this.renderers.set(s,o)),o.refCount.increment(),o}removeRenderable(e){ee(e);const t=this.renderers.get(e.rendererKey);if(t){t.removeRenderable(e),t.refCount.decrement(),"origin"in e.transform&&this.localOrigins.release(e.transform.origin),this.gpuMemoryUsage-=e.statistics.gpuMemoryUsage;for(const t of e.components.meta)e.components.buffer.releaseIndex(t.index);}}updateObjectCameraDistances(e){const t=e.camera.viewInverseTransposeMatrix;o$S(this.tmpCameraPosition,t[3],t[7],t[11]),this.perObjectData.forEach(((e,t)=>{const r=r$Y(e.center)?e.center:O$z(t.boundingVolumeWorldSpace.bounds),s=q$o(r,this.tmpCameraPosition);e.renderables.forEach((e=>e.distanceToCamera=s));}));}renderRegularEdges(e,t,r){e.bindRegularEdges(t,r);const s=r.transparency;e.forEachRenderable((s=>{if(!s.visible||!s.regular)return;const o=s$1(s.regular.lod.lengths,s.distanceToCamera,r);"origin"in s.transform&&(t.localViewMatrixForEdges=this.localOrigins.getViewMatrix(s.transform.origin)),e.renderRegularEdges(s,t,o),this.numberOfRenderedEdges+=o;}),s);}renderSilhouetteEdges(e,t,r){e.bindSilhouetteEdges(t,r);const s=r.transparency;e.forEachRenderable((s=>{if(!s.visible||!s.silhouette)return;const o=s$1(s.silhouette.lod.lengths,s.distanceToCamera,r);"origin"in s.transform&&(t.localViewMatrixForEdges=this.localOrigins.getViewMatrix(s.transform.origin)),e.renderSilhouetteEdges(s,t,o),this.numberOfRenderedEdges+=o;}),s);}};function ee(e){e.regular&&(e.regular.vao.vertexBuffers.instances.dispose(),e.regular.vao.dispose(!1),e.regular.vao=null),e.silhouette&&(e.silhouette.vao.vertexBuffers.instances.dispose(),e.silhouette.vao.dispose(!1),e.silhouette.vao=null);}function te(e){let t=null,s=null;for(let i=0;i<e.geometries.length;i++){var o;const n=e.geometryRecords[i];if(n.material.supportsEdges){if(t){if(!l$1g(t,n.transformation))return !1}else t=n.transformation;if(!s&&r$Y(n.origin))s=n;else if(r$Y(null==(o=s)?void 0:o.origin)&&r$Y(n.origin)&&s.origin.id!==n.origin.id)return !1}}return !0}e$Q([y$K({constructOnly:!0})],$.prototype,"rctx",void 0),e$Q([y$K({constructOnly:!0})],$.prototype,"renderSR",void 0),e$Q([y$K({constructOnly:!0})],$.prototype,"techniqueRepository",void 0),e$Q([y$K({constructOnly:!0})],$.prototype,"setNeedsRender",void 0),e$Q([y$K({constructOnly:!0})],$.prototype,"schedule",void 0),e$Q([y$K({readOnly:!0})],$.prototype,"updatingHandles",void 0),e$Q([y$K({readOnly:!0})],$.prototype,"updating",null),$=e$Q([n$14("esri.views.3d.webgl-engine.lib.edgeRendering.EdgeView")],$);class re{constructor(e,t=null){this.center=t,this.renderables=new Array,this.loaded=e,this.loaded.then((()=>{null!=this.loaded&&(this.loaded=!0);}));}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class F{constructor(r,t,s,n,i,a,h,o,l){this._materialRep=r,this._shaderTechniqueRepository=s,this._rctx=n,this._compositingHelper=i,this._magnifierHelper=a,this.requestRender=h,this._stage=l,this._materialRenderers=new Map,this._hasHighlights=!1,this._hasOccludees=!1,this._hasWater=!1,this._hasOverlayWater=!1,this._content=new Map,this._isRendering=!1,this._fallbackDepthStencilTexture=null,this.performanceInfo=new l$u,this._antialiasing=1,this._oitEnabled=!1,this._multipassTerrain=!0,this._opaqueTerrain=!0,this._lighting=new e$r,this._handles=new u$T,this.renderHiddenTransparentEdges=()=>{},this._smaaPass=new o$4(this._rctx,s),this._oitEnabled=this._hasOITSupport,this.requestRender(),this._offscreenRendering=new t$6(this._rctx,this._compositingHelper),this._sliceHelper=new n$5,this._shadowMap=new H(this._rctx,l.viewingMode,2),this._ssaoHelper=new f$4(s,this._rctx,(()=>this.requestRender())),this._highlightHelper=new b$2(s,this._rctx),this._shadowHighlightHelper=new o$5(this._rctx,l.viewingMode),this._shadowAccumulator=new M$2(this._rctx,s,l,((e,r)=>{this.renderPassManager.shadowCastingEnabled=!0,this._renderPlugins.prepareRender(e,r),this.renderPassManager.shadowCastingEnabled=this._shadowMap.enabled;}),((e,r,t,s)=>{e.start(t,r,s),this.renderShadowCascades(4,e),t.setGLViewport(this._rctx),this.ensureCameraBindParameters(t);}),(()=>this.requestRender())),this._bindParameters={slot:null,camera:null,inverseViewport:n$19(),shadowMap:this._shadowMap,shadowMappingEnabled:this._shadowMap.enabled,ssaoHelper:this._ssaoHelper,ssaoEnabled:this._ssaoHelper.enabled,origin:null,screenToWorldRatio:null,screenToWorldRatioGlobalWM:null,slicePlane:this._sliceHelper.plane,highlightDepthTexture:null,hasOccludees:!1,linearDepthTexture:null,terrainLinearDepthTexture:null,geometryLinearDepthTexture:null,multipassTerrainEnabled:!1,multipassGeometryEnabled:!1,cullAboveGround:!1,lastFrameColorTexture:null,reprojectionMat:null,ssrEnabled:!1,lighting:this._lighting,highlightColorTexture:null},this._renderContext=new t$B(this._rctx,this._offscreenRendering,this._lighting,this._shadowMap,this._ssaoHelper,this._sliceHelper),this._renderContext.multipassTerrainParams={camera:null,multipassTerrainEnabled:!1,cullAboveGround:!1,terrainLinearDepthTexture:null},this._renderContext.multipassGeometryParams={multipassGeometryEnabled:!1,geometryLinearDepthTexture:null},this._renderContext.ssrParams={camera:null,linearDepthTexture:null,lastFrameColorTexture:null,reprojectionMat:null,ssrEnabled:!1},this._renderPlugins=new n$7({renderContext:this._renderContext,shaderTechniqueRep:s,textureRep:t,materialRep:this._materialRep,requestRender:this.requestRender,schedule:o}),this.renderPassManager=new b$3(this._rctx,this._shaderTechniqueRepository),this._renderPlugins.add(this.renderPassManager.slots(),this.renderPassManager),this._handles.add([d$S(T$k,"EDGES_SHOW_HIDDEN_TRANSPARENT_EDGES",(e=>{this.renderHiddenTransparentEdges=e?()=>this.renderEdges(1):()=>{},this.requestRender();})),d$S(this._stage,"camera",(()=>this.requestRender()),!0)]);}get hasWater(){return this._hasWater||this._hasOverlayWater}get hasWaterReflection(){return this.hasWater&&this._waterReflectionEnabled}dispose(){this._handles.destroy(),this._smaaPass.disable(),this._materialRenderers.forEach((e=>e.dispose())),this._materialRenderers.clear(),this._edgeView=l$W(this._edgeView),this._offscreenRendering.dispose(),this._fallbackDepthStencilTexture=i$S(this._fallbackDepthStencilTexture),this._shadowMap.enabled=!1,this._shadowMap.dispose(),this._ssaoHelper.enabled=!1,this._ssaoHelper.dispose(),this._highlightHelper.dispose(),this._shadowHighlightHelper.dispose(),this._shadowAccumulator.dispose(),a$1p.prune(),this._content.clear();}get updating(){return 1===this._antialiasing&&this._smaaPass.isLoadingResources||r$Y(this._edgeView)&&this._edgeView.updating||this._shadowAccumulator.running||!this.isCameraFinal}ensureEdgeView(){return t$17(this._edgeView)&&(this._edgeView=new $({rctx:this._rctx,renderSR:this._stage.renderSR,techniqueRepository:this._shaderTechniqueRepository,setNeedsRender:()=>this.requestRender(),schedule:e=>this._stage.resourceController.schedule(e)}),this._handles.add(this._edgeView.watch("updating",(()=>this.requestRender()),!0)),this.requestRender()),this._edgeView}get edgeView(){return this._edgeView}get isCameraFinal(){return null===this._bindParameters.reprojectionMat||C$u(this._bindParameters.reprojectionMat,Q)}get hasShadowsEnabled(){var e;return !(null==(e=this._shadowMap)||!e.enabled)}setRenderParameters(e){const{renderPassManager:r,_shadowMap:t,_ssaoHelper:s}=this;void 0!==e.screenSpaceReflectionsEnabled&&r.screenSpaceReflectionsEnabled!==e.screenSpaceReflectionsEnabled&&(r.screenSpaceReflectionsEnabled=e.screenSpaceReflectionsEnabled,this.requestRender()),void 0===e.shadowMap||t.enabled===e.shadowMap&&r.shadowCastingEnabled===e.shadowMap||(t.enabled=e.shadowMap,r.shadowCastingEnabled=e.shadowMap,this.requestRender()),void 0!==e.shadowMapMaxCascades&&t.maxCascades!==e.shadowMapMaxCascades&&(t.maxCascades=e.shadowMapMaxCascades,this.requestRender()),void 0!==e.ssao&&s.enabled!==e.ssao&&(s.enabled=e.ssao,this.requestRender()),void 0!==e.ssaoAttenuation&&s.attenuation!==e.ssaoAttenuation&&(s.attenuation=e.ssaoAttenuation,this.requestRender()),void 0!==e.ssaoRadius&&s.radius!==e.ssaoRadius&&(s.radius=e.ssaoRadius,this.requestRender()),void 0!==e.ssaoSamples&&s.samples!==e.ssaoSamples&&(s.samples=e.ssaoSamples,this.requestRender()),e.background&&this._offscreenRendering.background!==e.background&&(this._offscreenRendering.background=e.background,this.requestRender());const n=e.antialiasingEnabled?1:0;void 0!==e.antialiasingEnabled&&this._antialiasing!==n&&(this._antialiasing=n,this.requestRender()),void 0!==e.highQualityTransparency&&this._multipassTerrain!==e.highQualityTransparency&&(this._multipassTerrain=e.highQualityTransparency,this._oitEnabled=e.highQualityTransparency&&this._hasOITSupport,this.requestRender()),void 0!==e.defaultHighlightOptions&&(this._highlightHelper.setDefaultOptions(e.defaultHighlightOptions),this._shadowHighlightHelper.setDefaultOptions(e.defaultHighlightOptions),this.requestRender()),void 0!==e.slicePlane&&this._sliceHelper.plane!==e.slicePlane&&(this._sliceHelper.plane=e$12(e.slicePlane),this.requestRender());const i=this._rctx.parameters.maxTextureImageUnits>=10&&e.waterReflectionEnabled;void 0!==e.waterReflectionEnabled&&this._waterReflectionEnabled!==i&&(this._waterReflectionEnabled=i,this.requestRender()),void 0!==e.opaqueTerrain&&this._opaqueTerrain!==e.opaqueTerrain&&(this._opaqueTerrain=e.opaqueTerrain,this.requestRender()),void 0!==e.hasOverlayWater&&this._hasOverlayWater!==e.hasOverlayWater&&(this._hasOverlayWater=e.hasOverlayWater,this.requestRender()),void 0!==e.shadowAccumulationOptions&&this._shadowAccumulator.setOptions(e.shadowAccumulationOptions);}get hasSlicePlane(){return !!this._sliceHelper.plane}get renderPlugins(){return this._renderPlugins}get _hasOITSupport(){return this._rctx.capabilities.textureFloat&&this._rctx.capabilities.textureFloat.textureFloat&&this._rctx.capabilities.colorBufferFloat&&this._rctx.capabilities.colorBufferFloat.textureFloat}modify(e){this._isRendering&&console.warn("Renderer.modify called while rendering");const{adds:t,removes:s,updates:n}=e;if(0===t.length&&0===s.length&&0===n.length)return;s.forAll((({id:e})=>this._content.delete(e))),t.forAll((e=>this._content.set(e.id,e)));const i=r$z(e);let a=!1;i.forEach(((e,r)=>{let t=this._materialRenderers.get(r);if(!t){if(!(e.adds.length>0))return;t=new v$o(this._rctx,this._materialRep,r),this._materialRenderers.set(r,t);}t.modify(e),t.isEmpty&&(a=!0);})),a&&this._materialRenderers.forEach(((e,r)=>{e.isEmpty&&(this._materialRenderers.delete(r),e.dispose());})),this._hasHighlights=n$1i(this._materialRenderers,(e=>e.hasHighlights)),this._hasOccludees=n$1i(this._materialRenderers,(e=>e.hasOccludees)),this._hasWater=n$1i(this._materialRenderers,(e=>e.hasWater)),this.requestRender();}updateLogic(e){let r=!1;return this._materialRenderers.forEach((t=>{t.updateLogic&&(r=t.updateLogic(e)||r);})),r}updateLightSources(e,r,t){this._lighting.groundLightingFactor=r,this._lighting.globalFactor=t,this._lighting.set(e);}render(e,r,t,s){this._isRendering=!0,this.performanceInfo.prerender(this._rctx),this._bindParameters.lighting=this._lighting,this._renderContext.hasOccludees=this._hasOccludees,this._renderContext.transparencyPassType=3,this._bindParameters.transparencyPassType=3;const n=this._offscreenRendering;n.needLastFrameColorTexture=this.hasWaterReflection,n.advanceCurrentRenderTarget();const a=this._sliceHelper.plane;s&&(this._sliceHelper.plane=null),this._rctx.bindFramebuffer(e),r.setGLViewport(this._rctx),this.needsShadowAccumulation&&(this.renderPassManager.shadowCastingEnabled=!0),this._renderPlugins.prepareRender(r,t),this.performanceInfo.advance(0);const h=this.computeDepthRange(r);this.renderShadowMap(e,r,this._lighting.lightingMainDirection,h),this.performanceInfo.advance(1),n.initializeFrame(r),this.ensureBindParameters(r),this.renderLinearDepth(),this.performanceInfo.advance(2),this.accumulateShadows(h,r,t),this.renderNormal(),this.performanceInfo.advance(3),this.ensureBindParametersSSR(),this._ssaoHelper.computeSSAO(r,n.linearDepthTexture,n.normalTexture),this.performanceInfo.advance(4),this.performanceInfo.stats.reset(),this._renderContext.pass=0,n.bindFramebuffer(),this.renderSlot(0),this.renderOpaqueGeometry(),this.performanceInfo.advance(5);const d=this._multipassTerrain&&!this._opaqueTerrain;this.renderTerrainLinearDepth(d),this.setMultipassFlags(d),this.setTerrainCulling(d),this.renderEdges(2),this.performanceInfo.advance(6),this.renderHiddenTransparentEdges(),this._oitEnabled?this.renderOrderIndependentTransparency((()=>this.renderTransparentGeometry()),!1):this.renderTransparentGeometry(),this.performanceInfo.advance(7),this.renderGeometryLinearDepth(d);const o={hudVisibility:!1,transparentTerrain:!1};o.hudVisibility=this.renderHUDVisibility(),d||this.renderInternalSlot(20),this.performanceInfo.advance(9),this.renderEdges(1,d),this.performanceInfo.advance(8),o.transparentTerrain=this.renderTransparentTerrain(),o.transparentTerrain&&o.hudVisibility&&(d?this.renderLineCallouts(0):n.compositeTransparentTerrainOntoHUDVisibility(),this.renderHUD(0,n.framebuffer),this.performanceInfo.advance(16)),this.performanceInfo.advance(10),this.setTerrainCulling(!1),o.transparentTerrain&&(n.compositeTransparentTerrainOntoMain(),d&&(this.renderEdges(2),this.performanceInfo.advance(6),this._oitEnabled?this.renderOrderIndependentTransparency((()=>this.renderTransparentGeometry()),!1):this.renderTransparentGeometry(),this.performanceInfo.advance(7),this.renderEdges(1),this.performanceInfo.advance(8))),d&&this.renderLineCallouts(1),this.setMultipassFlags(!1),this._shadowAccumulator.render(),n.renderToTargets((()=>{this.renderInternalSlot(8),this.renderSlot(15),this.renderSlot(16);}),n.currentColorTarget,n.mainDepth),this.performanceInfo.advance(11),this._renderPlugins.needsLaserlineWithContrastControl&&n.renderTmpAndCompositeToMain((()=>{this.renderSlot(17);}),2),this.performanceInfo.advance(12),this.renderOccluded(),this.performanceInfo.advance(13);const l=!s&&this._magnifierHelper.enabled,c=l&&t$17(e)?this._offscreenRendering.getFramebuffer(this._offscreenRendering.tmpColor,this._offscreenRendering.tmpDepth):e;this._rctx.bindFramebuffer(c),this.renderAntiAliasing(this._antialiasing,this._offscreenRendering.colorTexture)||this._compositingHelper.composite(this._offscreenRendering.colorTexture,0),this.performanceInfo.advance(14),this.renderHUD(1,c),this.performanceInfo.advance(17),this.renderHighlights(c,this._bindParameters),this.performanceInfo.advance(15),l&&this._magnifierHelper.render(this._rctx,this._bindParameters),c!==e&&(this._rctx.bindFramebuffer(e),this._compositingHelper.composite(this._offscreenRendering.tmpColorTexture,0)),this._renderContext.lastFrameCamera.copyFrom(this._renderContext.camera),this._sliceHelper.plane=a,this._isRendering=!1,this.onPostRender&&this.onPostRender(),this.performanceInfo.postrender();}readDepthPixels(e,r,t,s,n,i){const a=this._offscreenRendering.bindTarget(this._offscreenRendering.linearDepth,this._offscreenRendering.tmpDepth);if(!this._needsLinearDepth){this.ensureBindParameters(e),this._renderContext.camera.setGLViewport(this._rctx),this._rctx.setClearColor(0,0,0,0);const r=17664;this._rctx.clearSafe(r),this.renderGeometryAndTransparentTerrainPass(2);}a.readPixels(r,t,s,n,6408,5121,i);}readAccumulatedShadow(e,r){return this._shadowAccumulator.readAccumulatedShadow(e,r)}setMultipassFlags(e){this._renderContext.multipassTerrainParams.multipassTerrainEnabled=this._bindParameters.multipassTerrainEnabled=e,this._renderContext.multipassGeometryParams.multipassGeometryEnabled=this._bindParameters.multipassGeometryEnabled=e;}setTerrainCulling(e){this._renderContext.multipassTerrainParams.cullAboveGround=this._bindParameters.cullAboveGround=e;}renderSlot(e){return this._renderContext.slot=e,this._renderPlugins.render()}renderEdges(e,r=!1){const t=this._edgeView;r$Y(t)&&t.shouldRender()&&this._offscreenRendering.renderTmpAndCompositeToMain((()=>t.render(this._bindParameters,e)),1,r);}renderShadowMap(e,r,t,s){const n=this._shadowMap;if(n.enabled){if(T$k.ENABLE_PROFILE_DEPTH_RANGE&&s$6.begin("depthRange"),T$k.ENABLE_PROFILE_DEPTH_RANGE&&s$6.end("depthRange"),n.start(r,t,s),this.needsShadowHighlight){const e=this._shadowHighlightHelper;this.renderShadowCascades(7,this._shadowMap,(r=>n.takeCascadeSnapshotTo(r,e.highlightShadowMapSlot))),n.clear(),this.renderShadowCascades(6,this._shadowMap,(r=>{n.takeCascadeSnapshotTo(r,e.defaultSnapshotSlot),this.renderGeometryAndTransparentTerrainPass(7);}));}else this.renderShadowCascades(4);n.finish(e),r.setGLViewport(this._rctx);}}renderShadowCascades(e,r=this._shadowMap,t=(e=>{})){for(const s of r.getCascades())s.camera.setGLViewport(this._rctx),this.ensureCameraBindParameters(s.camera),this.renderGeometryAndTransparentTerrainPass(e),t(s);}get _needsLinearDepth(){return this._ssaoHelper.enabled||this._renderPlugins.needsLinearDepth||this._hasWater&&this._waterReflectionEnabled||this.needsShadowHighlight||this.needsShadowAccumulation}renderLinearDepth(){this._needsLinearDepth?this._offscreenRendering.renderToTargets((()=>this.renderGeometryAndTransparentTerrainPass(2)),this._offscreenRendering.linearDepth,this._offscreenRendering.tmpDepth,[0,0,0,0],!0,!0):this._offscreenRendering.disposeTarget(this._offscreenRendering.linearDepth),this._renderContext.ssrParams.linearDepthTexture=this._bindParameters.linearDepthTexture=this._offscreenRendering.linearDepthTexture;}renderTerrainLinearDepth(e){if(e){const e=this._renderContext.pass;this._renderContext.pass=2,this._offscreenRendering.renderToTargets((()=>this.renderTransparentTerrain()),this._offscreenRendering.terrainLinearDepth,this._offscreenRendering.tmpDepth,[-1e10,-1e10,-1e10,1],!0,!0),this._renderContext.pass=e;}else this._offscreenRendering.disposeTarget(this._offscreenRendering.terrainLinearDepth);this._renderContext.multipassTerrainParams.terrainLinearDepthTexture=this._bindParameters.terrainLinearDepthTexture=this._offscreenRendering.terrainLinearDepthTexture;}renderGeometryLinearDepth(e){if(e){const e=this._renderContext.pass;this._offscreenRendering.renderToTargets((()=>this.renderGeometryPass(2)),this._offscreenRendering.geometryLinearDepth,this._offscreenRendering.tmpDepth,[1,1,1,1],!0,!0),this._renderContext.pass=e;}else this._offscreenRendering.disposeTarget(this._offscreenRendering.geometryLinearDepth);this._renderContext.multipassGeometryParams.geometryLinearDepthTexture=this._bindParameters.geometryLinearDepthTexture=this._offscreenRendering.geometryLinearDepthTexture;}get needsNormal(){return this._ssaoHelper.enabled}renderNormal(){this.needsNormal?this._offscreenRendering.renderToTargets((()=>{this.renderGeometryAndTransparentTerrainPass(3);}),this._offscreenRendering.normal,this._offscreenRendering.tmpDepth,[0,0,0,0],!0,!0):this._offscreenRendering.disposeTarget(this._offscreenRendering.normal);}get needsDepthRange(){return this._shadowMap.enabled||this.needsShadowAccumulation}computeDepthRange(e){if(!this.needsDepthRange)return f$6;const r=A(e,this._content,this._stage.layers);return t$c(r,this.renderPlugins.queryDepthRange(e)),r.near=Math.max(e.near,r.near),r.far=Math.min(e.far,r.far),r}renderGeometryAndTransparentTerrainPass(e){this._renderContext.pass=e,this.renderGeometryPass(e),this.renderTransparentTerrain();}renderGeometryPass(e){this._renderContext.pass=e,this.renderOpaqueGeometry(),this.renderTransparentGeometry();}renderOpaqueGeometry(){this.renderSlot(1),this.renderSlot(2),this.renderInternalSlot(3),this.renderSlot(4),this.renderSlot(14);}renderTransparentGeometry(){this.renderInternalSlot(5),this.renderSlot(6);}renderTransparentTerrain(){return this.renderSlot(7)}renderHUDVisibility(){let e=!1;return this._renderContext.offscreenRenderingHelper&&this._renderContext.offscreenRenderingHelper.renderHUDVisibility((()=>{this._bindParameters.hudVisibilityTexture=this._renderContext.offscreenRenderingHelper?this._renderContext.offscreenRenderingHelper.hudVisibilityTexture:null,e=this.renderInternalSlot(12);}),this._multipassTerrain&&!this._opaqueTerrain),e}renderLineCallouts(e){this._bindParameters.renderTransparentlyOccludedHUD=e,0===e?this._offscreenRendering.renderToTargets((()=>this.renderInternalSlot(20)),this._offscreenRendering.currentColorTarget,this._offscreenRendering.tmpDepth,void 0,!0,!0):this.renderInternalSlot(20);}renderHUD(e,r){this._oitEnabled?(this.renderOrderIndependentTransparency((()=>this.renderHUDElements(e)),!0),this._rctx.bindFramebuffer(r),this._compositingHelper.composite(this._offscreenRendering.hudColorTexture,2)):0===e?this._offscreenRendering.renderToTargets((()=>this.renderHUDElements(0)),this._offscreenRendering.currentColorTarget,this._offscreenRendering.tmpDepth,void 0,!0,!0):this.renderHUDElements(e);}renderHUDElements(e){this._bindParameters.renderTransparentlyOccludedHUD=e,this.renderInternalSlot(21),this.renderInternalSlot(18),this.renderInternalSlot(19);}get needsHighlight(){return this._hasHighlights||this._renderPlugins.needsHighlight}get needsShadowHighlight(){return this._shadowMap.enabled&&this._shadowHighlightHelper.isVisible&&this.needsHighlight}renderHighlights(e,r){if(!this.needsHighlight)return void this._offscreenRendering.disposeTarget(this._offscreenRendering.highlight);const t=this._highlightHelper,s=t.profilingCallback&&e$t(this._renderContext.rctx);this._renderContext.highlightDepthTexture=r.highlightDepthTexture;const i=this._offscreenRendering.renderToTargets((()=>{this.renderGeometryAndTransparentTerrainPass(5),this._rctx.clearSafe(256),this.renderHUDElements(2);}),this._offscreenRendering.highlight,this._offscreenRendering.tmpDepth,[0,0,0,0],!0,!0);this._bindParameters.highlightColorTexture=i.colorTexture,this.needsShadowHighlight&&this._shadowHighlightHelper.render(r,e),t.render(this._renderContext.camera,i,e),r$Y(s)&&t.profilingCallback&&s.stop((e=>{t.profilingCallback&&t.profilingCallback(e);}));}get needsShadowAccumulation(){return this._shadowAccumulator.isAccumulating}accumulateShadows(e,r,t){this.needsShadowAccumulation&&(this._shadowAccumulator.setAccumulationDependencies(this._offscreenRendering.linearDepthTexture,e,r,t),this._shadowAccumulator.accumulateFixedSamples(),this.renderPassManager.shadowCastingEnabled=this._shadowMap.enabled);}renderOrderIndependentTransparency(e,r){const t=t=>{this._renderContext.transparencyPassType=t,this._bindParameters.transparencyPassType=this._renderContext.transparencyPassType,this._offscreenRendering.renderOITPass((()=>e()),t,r);},s=this._renderContext.pass;this._renderContext.pass=1,t(1),this._renderContext.pass=0,t(0),t(2),this._offscreenRendering.compositeTransparentOntoOpaque(r),this._renderContext.transparencyPassType=3,this._bindParameters.transparencyPassType=this._renderContext.transparencyPassType,this._renderContext.pass=s;}renderOccluded(){let e=0;this._materialRenderers.forEach(((r,t)=>{t&&t.isVisible()&&8===t.renderOccluded&&(e|=t.renderOccluded,U.push(t));}));const r=this._offscreenRendering,t=(t,s,n,i,a)=>{0!=(e&s)&&(r.renderToTargets(n,r.tmpColor,r.mainDepth,[0,0,0,0],i,a),r.compositeOccludedOntoMain(t));};0!==U.length&&(this.renderInternalSlot(10,U),t(.5,8,(()=>this.renderInternalSlot(11,U)),!1,!1),U.length=0),this._materialRenderers.forEach(((r,t)=>{t&&t.isVisible()&&(4===t.renderOccluded||2===t.renderOccluded||16===t.renderOccluded)&&(e|=t.renderOccluded,V.push(t));}));const s=this._renderPlugins.renderOccludedFlags;if(e|=s,!e)return;const n=e=>{this._renderContext.renderOccludedMask=e,s>1&&this.renderSlot(9),this.renderInternalSlot(3,V),this.renderInternalSlot(5,V),this.renderInternalSlot(8,V),this._renderContext.resetRenderOccludedMask();};this._renderContext.pass=0,t(.5,4,(()=>n(4)),!0,2),t(.5,2,(()=>n(2)),!0,2),t(1,16,(()=>n(16)),!0,2),V.length=0;}renderAntiAliasing(e,r){if(1===e){if(this._smaaPass.loadResources((()=>this.requestRender())),this._smaaPass.enable())return this._smaaPass.render({colorTexture:r}),!0}else this._smaaPass.disable();return !1}ensureCameraBindParameters(e){this._renderContext.camera=e,this._bindParameters.camera=this._renderContext.camera,this._bindParameters.inverseViewport[0]=1/this._renderContext.camera.fullViewport[2],this._bindParameters.inverseViewport[1]=1/this._renderContext.camera.fullViewport[3];}ensureBindParameters(e){var r;this.ensureCameraBindParameters(e);const t=this._renderContext.offscreenRenderingHelper;this._bindParameters.shadowMap=this._renderContext.shadowMap,this._bindParameters.shadowMappingEnabled=this._renderContext.shadowMap.enabled,this._bindParameters.ssaoHelper=this._renderContext.ssaoHelper,this._bindParameters.ssaoEnabled=this._renderContext.ssaoHelper.enabled,this._bindParameters.slicePlane=this._renderContext.sliceHelper.plane,this._bindParameters.hasOccludees=this._renderContext.hasOccludees,this._renderContext.multipassTerrainParams.camera=this._renderContext.camera,this._bindParameters.hudVisibilityTexture=t.hudVisibilityTexture,this._bindParameters.highlightDepthTexture=null!=(r=t.depthTexture)?r:this.getFallbackDepthTexture();}ensureBindParametersSSR(){this.hasWaterReflection?(this._renderContext.lastFrameCamera.equals(this._renderContext.camera)?this._renderContext.ssrParams.reprojectionMat=this._bindParameters.reprojectionMat=Q:(c$_(k,this._renderContext.lastFrameCamera.viewMatrix,this._bindParameters.origin?this._bindParameters.origin:[0,0,0]),c$_(B,this._renderContext.camera.viewMatrix,this._bindParameters.origin?this._bindParameters.origin:[0,0,0]),h$L(B,B),h$L(W,this._renderContext.camera.projectionMatrix),e$V(N,B,W),e$V(N,k,N),e$V(N,this._renderContext.lastFrameCamera.projectionMatrix,N),this._renderContext.ssrParams.reprojectionMat=this._bindParameters.reprojectionMat=N),this._renderContext.ssrParams.camera=this._renderContext.camera,this._renderContext.ssrParams.lastFrameColorTexture=this._bindParameters.lastFrameColorTexture=this._offscreenRendering.lastFrameColorTexture):this._renderContext.ssrParams.lastFrameColorTexture=this._bindParameters.lastFrameColorTexture=null,this._renderContext.ssrParams.ssrEnabled=this._bindParameters.ssrEnabled=this.hasWaterReflection;}renderInternalSlot(e,r){const t=0===this._renderContext.pass?this.performanceInfo.stats:null;let s=!1;return this._bindParameters.slot=e,r$Y(r)?r.forEach((r=>{if(!n$1n(r,this._renderContext))return;const t=this._materialRenderers.get(r);r$Y(t)&&(s=t.render(e,this._renderContext.pass,this._bindParameters)||s);})):this._materialRenderers.forEach(((r,n)=>{n$1n(n,this._renderContext)&&(s=r.render(e,this._renderContext.pass,this._bindParameters,t)||s);})),s}getFallbackDepthTexture(){return this._fallbackDepthStencilTexture||(this._fallbackDepthStencilTexture=g$X(this._rctx)),this._fallbackDepthStencilTexture}getGpuMemoryUsage(){return {offscreen:this._offscreenRendering?this._offscreenRendering.getGpuMemoryUsage():0,highlights:(this._highlightHelper?this._highlightHelper.getGpuMemoryUsage():0)+(this._shadowHighlightHelper?this._shadowHighlightHelper.getGpuMemoryUsage():0),shadows:this._shadowMap?this._shadowMap.getGpuMemoryUsage():0,ssao:this._ssaoHelper?this._ssaoHelper.gpuMemoryUsage:0}}get test(){const e=this;return {antialiasing:this._antialiasing,offscreen:this._offscreenRendering,shadowMap:this._shadowMap,ssao:this._ssaoHelper,highlight:this._highlightHelper,lighting:this._lighting,materialRenderers:this._materialRenderers,oitEnabled:this._oitEnabled,shadowHighlights:this._shadowHighlightHelper,getFramebufferTexture:r=>{var t;switch(r){case 0:return e._offscreenRendering.colorTexture;case 1:return e._offscreenRendering.linearDepthTexture;case 2:return e._offscreenRendering.normalTexture;case 3:return null==(t=e._shadowMap)?void 0:t.test.depthTexture;case 4:return e._offscreenRendering.hudVisibilityTexture;case 5:return e._offscreenRendering.highlightTexture}}}}}const V=[],U=[],k=e$P(),W=e$P(),B=e$P(),N=e$P(),Q=e$P();

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
const c$1=n$12.getLogger("esri.views.3d.webgl-engine.lib.TextureRepository"),T=8;class f$1{constructor(t,r,a){this._stage=t,this._rctx=a,this._idToRefCountedTexture=new Map,this._loadingCount=0,this._frameUpdates=new Map,this._fallbackTextureData=new Uint8Array(T*T*4),this._fallbackTextureTransparentData=new Uint8Array(T*T*4),this.events=new n$13,this._textureTechnique=r.acquire(u$t,new m$s);for(let e=0;e<this._fallbackTextureData.length;++e)this._fallbackTextureData[e]=255,this._fallbackTextureTransparentData[e]=(e+1)%4!=0?255:0;this._fallbackTextureDesc={target:3553,pixelFormat:6408,dataType:5121,samplingMode:9728,width:T,height:T,maxAnisotropy:this._rctx.parameters.maxMaxAnisotropy},this._frameTask=t.resourceController.scheduler.registerTask(p$H.TEXTURE_UNLOAD);}dispose(){this._frameTask.remove(),r$Y(this._fallbackTexture)&&(this._fallbackTexture.dispose(),this._fallbackTexture=null),r$Y(this._fallbackTextureTransparent)&&(this._fallbackTextureTransparent.dispose(),this._fallbackTextureTransparent=null),this._stage.forEachOfType(4,(e=>e.unload()));}get updating(){return this.loadingCount>0||this._frameTask.updating}acquire(e,t=!1,r){const a=this._getOrCreateRef(e,t,r);return a.ref(),a}update(){let e=!1;this._frameUpdates.forEach((t=>{const r=t.texture.frameUpdate(this._rctx,this._textureTechnique,t.previousToken);r>=0&&r!==t.previousToken&&(t.previousToken=r,e=!0);})),e&&this.events.emit("changed",0);}_getOrCreateRef(e,t,r){const a=this._idToRefCountedTexture.get(e);return a||this._createNewRef(e,t,r)}_createNewRef(e,t,r){const a=this._stage.getObject(e);i$R(void 0!==a);const n=a.events.on("unloaded",(()=>{n.remove(),this._onTextureUnloaded(e);})),o=new _;this._idToRefCountedTexture.set(e,o);const l=a.load(this._rctx,this._textureTechnique);this._loadingCount++;const h=t=>(this._loadingCount--,this._updateGLTexture(o,t),r&&r(o),a.requiresFrameUpdates&&this._frameUpdates.set(e,{texture:a,previousToken:-1}),o),T=e=>{this._loadingCount--,g$T(e)||c$1.error(e);};return U$q(l)?(this._updateGLTexture(o,t?this.fallbackTextureTransparent:this.fallbackTexture),l.then(h,T)):h(l),o}_updateGLTexture(e,t){e.glTexture=t,this.events.emit("changed",1);}release(e){const t=this._idToRefCountedTexture.get(e);if(t&&(t.unref(),t.isUnreferenced)){const r=this._stage.getObject(e);this._frameTask.schedule((()=>{t.isUnreferenced&&r.unload();}));}}getTexture(e){return this._stage.getObject(e)}get loadingCount(){return this._loadingCount}_onTextureUnloaded(e){this._idToRefCountedTexture.delete(e),this._frameUpdates.delete(e);}get fallbackTexture(){return t$17(this._fallbackTexture)&&(this._fallbackTexture=new r$16(this._rctx,this._fallbackTextureDesc,this._fallbackTextureData)),this._fallbackTexture}get fallbackTextureTransparent(){return t$17(this._fallbackTextureTransparent)&&(this._fallbackTextureTransparent=new r$16(this._rctx,this._fallbackTextureDesc,this._fallbackTextureTransparentData)),this._fallbackTextureTransparent}}class _{constructor(){this._refCount=0,this.glTexture=null;}get isUnreferenced(){return 0===this._refCount}ref(){++this._refCount;}unref(){0!==this._refCount?--this._refCount:c$1.error("Cannot dereference texture that has no references!");}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
const n$1=n$12.getLogger("esri.views.3d.webgl-engine.materials.internal.waterMaterialUtils");let l$1=class extends p$14{constructor(){super(...arguments),this._data=new Array,this.loadingState=0;}dispose(){this.loadingState=0,this._data.forEach((t=>t.dispose())),this._data.length=0;}get updating(){return 1===this.loadingState}get ready(){return 2===this.loadingState}loadTextures(t){const r=[a$1q("esri/images/materials/water/normals.jpg"),a$1q("esri/images/materials/water/perturbation.jpg")];this.loadingState=1,Promise.all(r.map((t=>t$14(t)))).then((e=>{e.forEach((e=>this._data.push(new r$16(t,{target:3553,pixelFormat:6408,dataType:5121,wrapMode:10497,samplingMode:9987,hasMipmap:!0,maxAnisotropy:8,width:e.width,height:e.height},e)))),this.loadingState=2;})).catch((t=>{n$1.error("Failed to load textures for water material.",t),this.loadingState=0;}));}bind(t){this._data.length>=2&&(t.bindTexture(this._data[0],"texWaveNormal"),t.bindTexture(this._data[1],"texWavePerturbation"));}};e$Q([y$K()],l$1.prototype,"loadingState",void 0),e$Q([y$K({type:Boolean,readOnly:!0})],l$1.prototype,"updating",null),l$1=e$Q([n$14("esri.views.3d.webgl-engine.materials.internal.WaterTextureRepository")],l$1);

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class h extends e$1b{constructor(e,t,r,s=null,i,o=!0){super(),this._rctx=e,this._renderScene=t,this._requestRenderScene=r,this._renderOverlay=s,this.forceCameraHook=i,this.supersample=o,this._screenshotQueue=[];}dispose(){this._rctx=null;}takeScreenshot(e){this._requestRenderScene();const r=D$r();return this._screenshotQueue.push({settings:e,resolver:r}),r.promise}update(e){if(0!==this._screenshotQueue.length){for(const t of this._screenshotQueue){if(this.isDisposed){t.resolver.reject();continue}const r={...t.settings,pixelRatio:t.settings.pixelRatio*e.viewCamera.pixelRatio},s=this._ensureScreenshotEncodeCanvas(),o=this._renderScreenshot(e,r),n=a$1r(o,r,s,{flipY:!0,premultipliedAlpha:!0});t.resolver(n);}this._screenshotQueue=[];}}_renderScreenshotOverlay(t,r,s){if(t$17(this._renderOverlay))return r;t.width=r.width,t.height=r.height;const i=t.getContext("2d"),o=s.pixelRatio;return i.save(),i.translate(0,r.height),i.scale(1,-1),s.region&&i.translate(-s.region.x,-s.region.y),i.scale(o,o),r=this._renderOverlay(t,r),i.restore(),r}_readbackScreenshot(e){return e.resample?this._readbackScreenshotResampled(e):this._readbackScreenshotImmediate(e)}_readbackScreenshotResampled(e){const{framebufferWidth:t,framebufferHeight:r,region:s,resample:i}=e,a=this._ensureScreenshotEncodeCanvas();let h=l$1l(t,r,a);this._rctx.gl.readPixels(0,0,t,r,6408,5121,new Uint8Array(h.data.buffer)),h=this._renderScreenshotOverlay(a,h,{...e,region:null});const c=l$1l(s.width,s.height,a);return d$1a(h,c,!0,i.region.x,r-(i.region.y+i.region.height),i.region.width,i.region.height)}_readbackScreenshotImmediate(e){const{framebufferHeight:t,region:r}=e,s=this._ensureScreenshotEncodeCanvas(),i=l$1l(r.width,r.height,s);return this._rctx.gl.readPixels(r.x,t-(r.y+r.height),r.width,r.height,6408,5121,new Uint8Array(i.data.buffer)),this._renderScreenshotOverlay(s,i,e)}_renderScreenshot(e,t){let s=null;const i=e.viewCamera,{framebufferWidth:o,framebufferHeight:n}=t;let h=!1;const c=t.disableDecorations&&e.frameHasDecorations,l=o!==i.fullWidth||n!==i.fullHeight,d=t.ignorePadding&&i.pixelRatio!==t.pixelRatio,f=l||c||d;if(f){const e=i.clone();if(t.ignorePadding){const s=t$1g(e.padding);for(let r=0;r<4;r++)s[r]=Math.round(s[r]/e.pixelRatio*t.pixelRatio);e.padding=s;}e.fullWidth=o,e.fullHeight=n,e.pixelRatio=t.pixelRatio;const c=i.fovX-e.fovX,l=i.fovY-e.fovY;c<0&&c<l?e.fovX=i.fovX:l<0&&l<c&&(e.fovY=i.fovY),this.forceCameraHook(e),h=!0,s=new o$15(this._rctx,{width:e.fullWidth,height:e.fullHeight,colorTarget:0,depthStencilTarget:3}),this._renderScene(s,e,t.disableDecorations);}const u=this._readbackScreenshot(t);if(f&&!this._rctx.contextAttributes.alpha)for(let r=3;r<u.data.length;r+=4)u.data[r]=255;return s&&s.dispose(),this._rctx.bindFramebuffer(null),h&&this.forceCameraHook(i),u}_ensureScreenshotEncodeCanvas(){return this._screenshotEncodeCanvas||(this._screenshotEncodeCanvas=document.createElement("canvas")),this._screenshotEncodeCanvas}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
const L=n$12.getLogger("esri.views.3d.webgl-engine.parts.View");let O=class extends(s$$(p$14)){constructor(e){super({}),this.events=new n$13,this.waterTextureRepository=new l$1,this._magnifierHelper=new w$2,this._componentObjectCollection=null,this._needsUpdate=!0,this._needsRender=!0,this._idleSuspend=!0,this._needsWaterReflectionUpdate=!1,this._logicUpdateLast=0,this._container=e.container,this._initializeContext(e.options),d$S(this.waterTextureRepository,"loadingState",(()=>this.setNeedsRender())),this._magnifierHelper.events.on("request-render",(()=>this.setNeedsRender())),this._stippleTextureRepository=new s$s(this._rctx),this._shaderTechniqueRepository=new s$x({rctx:this._rctx,viewingMode:e.viewingMode,stippleTextureRepository:this._stippleTextureRepository,waterTextureRepository:this.waterTextureRepository}),this._textureRepository=new f$1(e,this._shaderTechniqueRepository,this._rctx),this._textureRepository.events.on("changed",(e=>this.setNeedsRender(e))),this._materialRepository=new n$I(this._textureRepository,this._shaderTechniqueRepository,(()=>this.setNeedsRender())),this._compositingHelper=new a$6(this._rctx,this._shaderTechniqueRepository),this._renderer=new F(this._materialRepository,this._textureRepository,this._shaderTechniqueRepository,this._rctx,this._compositingHelper,this._magnifierHelper,((e=1)=>this.setNeedsRender(e)),((t,r)=>e.schedule(t,r)),e),this._screenshotManager=new h(this._rctx,((e,t,r)=>this._renderer.render(e,t,t,r)),(()=>this.setNeedsRender()),e.options.screenshot.renderOverlay,(e=>this.events.emit("force-camera-for-screenshot",e))),this._registerFrameTask(e);}normalizeCtorArgs(){return {}}dispose(){this._container.contains(this._canvas)&&this._container.removeChild(this._canvas),this._frameTask&&(this._frameTask.remove(),this._frameTask=null),this._shaderTechniqueRepository.dispose(),this._shaderTechniqueRepository=null,v$S(this._rctx),super.dispose(),this._tmpDepthBuffer=null,this._rctx=null;}get performanceInfo(){const e=this._rctx.gl;return {renderer:this._renderer.performanceInfo,textureMemory:void 0!==e.getUsedTextureMemory?e.getUsedTextureMemory():void 0,renderbufferMemory:void 0!==e.getUsedRenderbufferMemory?e.getUsedRenderbufferMemory():void 0,VBOMemory:void 0!==e.getUsedVBOMemory?e.getUsedVBOMemory():void 0}}setNeedsRender(e=1){1===e?this._needsUpdate||(this._needsUpdate=!0,this.notifyChange("updating")):this._needsRender=!0;}get needsUpdate(){return this._needsUpdate}get updating(){return this.evaluateUpdating()}evaluateUpdating(){return this.needsUpdate||this._needsWaterReflectionUpdate||this._renderer.updating||this._textureRepository.updating||this.waterTextureRepository.updating||this._magnifierHelper.updating}ensureEdgeView(){return this._renderer.ensureEdgeView()}get edgeView(){return this._renderer.edgeView}get textureRepository(){return this._textureRepository}get compositingHelper(){return this._compositingHelper}set magnifier(e){this._magnifierHelper.magnifier=e;}updateLightSources(e,t,r){this._renderer.updateLightSources(e,t,r),this.setNeedsRender();}setRenderParameters(e){void 0!==e.idleSuspend&&this._idleSuspend!==!!e.idleSuspend&&(this._idleSuspend=!!e.idleSuspend,this.setNeedsRender()),this._renderer.setRenderParameters(e);}get renderingContext(){return this._rctx}has(e){switch(e){case 0:return !!this._rctx.capabilities.compressedTextureETC;case 1:return !!this._rctx.capabilities.compressedTextureS3TC;case 2:return !!this._rctx.capabilities.shaderTextureLOD;case 3:return this._renderer.hasShadowsEnabled;default:return !1}}modify(e){this._renderer.modify(e),e.clear();}get canvas(){return this._canvas}takeScreenshot(e){return this._screenshotManager.takeScreenshot(e)}readAccumulatedShadow(e){return this._renderer.readAccumulatedShadow(e[0],e[1])}getMinimalDepthForArea(e,t,r,s,i=s){const o=r.constrainWindowSize(e,t,s*r.pixelRatio,i*r.pixelRatio),n=this._ensureDepthBuffer(o);this._renderer.readDepthPixels(r,o[0],o[1],o[2],o[3],n);let a=Number.MAX_VALUE;for(let d=0;d<o[2]*o[3];d++){const e=M$4(4*d,n,r.nearFar);a>e&&e!==r.nearFar[0]&&e!==r.nearFar[1]&&(a=e);}return a===Number.MAX_VALUE?void 0:a}_ensureDepthBuffer(e){const t=4*e[2]*e[3];return (t$17(this._tmpDepthBuffer)||this._tmpDepthBuffer.byteLength<t)&&(this._tmpDepthBuffer=new Uint8Array(t)),this._tmpDepthBuffer}get renderPlugins(){return this._renderer.renderPlugins}get test(){return {renderer:this._renderer}}getGpuMemoryUsage(){return this._renderer.getGpuMemoryUsage()}async hotReloadShaders(){e$f(),await this._shaderTechniqueRepository.hotReload(),this.setNeedsRender();}_registerFrameTask(e){const t=e.state,r={viewCamera:t.camera,frameHasDecorations:!1};let s=!1;const i={preRender:r=>{s=this.evaluateUpdating(),e.processSyncLayers();const i=n$1e(r.time-this._logicUpdateLast);if(i>r$i){const e={camera:t.camera,dt:i};this._logicUpdateLast=r.time,this._renderer.updateLogic(e)&&this.setNeedsRender(0);}},render:()=>{if((this.needsUpdate||this._needsRender||!this._idleSuspend||!this._renderer.isCameraFinal||this._needsWaterReflectionUpdate)&&t.camera.fullWidth>0&&t.camera.fullHeight>0){const e=this._needsUpdate&&this._idleSuspend&&this._renderer.isCameraFinal;this._needsRender=!1,this._needsUpdate=!1,this._needsWaterReflectionUpdate=!1,this._renderer.render(null,t.camera,t.contentCamera,!1),e&&this._renderer.hasWaterReflection&&(this.setNeedsRender(0),this._needsWaterReflectionUpdate=!0);}},postRender:()=>{s===this.updating&&s===this.evaluateUpdating()||this.notifyChange("updating");},update:()=>{r.viewCamera=t.camera,r.frameHasDecorations=this._renderer.hasSlicePlane||this._magnifierHelper.enabled,this._textureRepository.update(),this._screenshotManager.update(r);}};this._frameTask=A$D(i);}_initializeContext(e){this._canvas=e.canvas,this._canvas||(this._canvas=document.createElement("canvas")),this._canvas.setAttribute("style","width: 100%; height:100%; display:block;");const t={alpha:e.alpha||!1,premultipliedAlpha:!0,antialias:!1,depth:!0,stencil:null==e.stencil||e.stencil,powerPreference:"high-performance"},r=e$1g(this._canvas,t,e.renderContext),i={disabledExtensions:e.deactivatedWebGLExtensions||{},debugWebGLExtensions:e.debugWebGLExtensions||{},maxAnisotropy:8};this._rctx=new c$1c(r,i),f$_(this._rctx),this._loadShaderOnlyExtensions(this._rctx),!e.alpha&&this._rctx.contextAttributes.alpha&&L.error("WebGL context has alpha channel even though no alpha channel was requested"),!this._rctx.contextAttributes.alpha&&s$U("safari")>=11&&(this._container.style.backgroundColor="black"),this._container.appendChild(this._canvas);}_loadShaderOnlyExtensions(e){const t=e.capabilities;t.enable("standardDerivatives"),t.enable("shaderTextureLOD"),t.enable("textureFloat");}get componentObjectCollection(){return t$17(this._componentObjectCollection)&&(this._componentObjectCollection=new H$1(this._renderer.renderPassManager)),this._componentObjectCollection}set componentObjectCollection(e){this._componentObjectCollection=e;}};e$Q([y$K({type:Boolean,readOnly:!0})],O.prototype,"updating",null),e$Q([i$11()],O.prototype,"_rctx",void 0),e$Q([i$11()],O.prototype,"_container",void 0),e$Q([i$11()],O.prototype,"_canvas",void 0),e$Q([i$11()],O.prototype,"_stippleTextureRepository",void 0),e$Q([i$11(),y$K()],O.prototype,"waterTextureRepository",void 0),e$Q([i$11(),y$K()],O.prototype,"_magnifierHelper",void 0),e$Q([i$11(),y$K()],O.prototype,"_textureRepository",void 0),e$Q([i$11()],O.prototype,"_compositingHelper",void 0),e$Q([i$11()],O.prototype,"_renderer",void 0),e$Q([i$11()],O.prototype,"_screenshotManager",void 0),e$Q([i$11()],O.prototype,"componentObjectCollection",null),e$Q([i$11()],O.prototype,"_componentObjectCollection",void 0),O=e$Q([n$14("esri.views.3d.webgl-engine.parts.RenderView")],O);

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
var f;let w=f=class extends(s$$(p$14)){constructor(e){super(e),this._handles=new u$T,this._model=new g$4,this._layers=new n$1h,this._changeSet=new r$A,this._layerSyncSet=new Set;}initialize(){this._set("renderView",new O(this)),this._frameTask=this.resourceController.scheduler.registerTask(p$H.STAGE,this),this._handles.add(this._frameTask);}destroy(){o$L.pool.prune(0),this._handles.destroy(),this.dispose();}get viewingMode(){return this.state.viewingMode}get updating(){return this._model.dirtySet.dirty||this.renderView.updating}add(e){this._model.add(e),l$w(e)&&(e.attachStage(this),this._addLayer(e)),this.renderView.setNeedsRender();}remove(e){t$17(e)||(this.renderView.setNeedsRender(),this._model.remove(e),l$w(e)&&(this._removeLayer(e),e.detachStage()));}addMany(e){r$Y(e)&&(this._model.addMany(e),this.renderView.setNeedsRender());}removeMany(e){r$Y(e)&&(this._model.removeMany(e),this.renderView.setNeedsRender());}forEachOfType(e,t){this._model.forEachOfType(e,t);}handleEvent(e,t){this.destroyed||(this._model.dirtySet[e](t),this.renderView.setNeedsRender());}get running(){return this._model.dirtySet.dirty}runTask(e){this._frameTask.processQueue(e),e.done||this._commit();}_commit(){const e=this._model.dirtySet;f.DebugSettings.logDirtySet&&console.log("Dirty set: "+e.formatDebugInfo()),e.commit(this._changeSet),f.DebugSettings.logDirtySet&&(console.log("RGs add: "+this._changeSet.adds.map((e=>e.id))),console.log("RGs remove: "+this._changeSet.removes.map((e=>e.id)))),this._layerSyncSet.clear(),this.renderView.modify(this._changeSet),this.renderView.setNeedsRender();}schedule(e,t){return this._frameTask.schedule(e,t)}syncLayer(e){this._layerSyncSet.add(e),this.renderView.setNeedsRender();}processSyncLayers(){const e=this._model.dirtySet;this._layers.forAll((t=>{(this._layerSyncSet.has(t.id)||1===t.updatePolicy)&&(e.commitLayer(t.id,this._changeSet),this._layerSyncSet.delete(t.id));}));for(const t of this._layerSyncSet)e.commitLayer(t,this._changeSet);this._layerSyncSet.clear(),this.renderView.modify(this._changeSet);}getObject(e){return this._model.getObject(e)}get layers(){return this._layers}_addLayer(e){this._layers.some((t=>t===e))||this._layers.push(e);}_removeLayer(e){this._commit(),null!=this._layers.removeUnordered(e)&&(this._model.dirtySet.getResidentRenderGeometries(e.id,this._changeSet.removes),this.renderView.modify(this._changeSet));}addRenderPlugin(e,t,r){const s=this.renderView.renderPlugins.add(e,t,r),o=()=>{P$8(t)&&this.sceneIntersectionHelper.addIntersectionHandler(t);};if(z$z(s))return s.then(o);o();}removeRenderPlugin(e){P$8(e)&&this.sceneIntersectionHelper.removeIntersectionHandler(e),this.renderView.renderPlugins.remove(e);}get performanceInfo(){return {renderView:this.renderView.performanceInfo,model:this._model.getStats()}}get test(){const e=this;return {getCount:t=>e._model.test.content.filter((e=>e.type===t)).length,stopAnimations:t=>e._model.test.content.filter((e=>3===e.type)).forEach((e=>o$17(e.animation,(e=>e.stopAtTime(t))))),model:e._model}}};w.DebugSettings={endFrameContentValidation:!1,logDirtySet:!1},e$Q([y$K({constructOnly:!0})],w.prototype,"resourceController",void 0),e$Q([y$K({constructOnly:!0})],w.prototype,"options",void 0),e$Q([y$K({constructOnly:!0})],w.prototype,"state",void 0),e$Q([y$K({constructOnly:!0})],w.prototype,"sceneIntersectionHelper",void 0),e$Q([y$K({readOnly:!0})],w.prototype,"viewingMode",null),e$Q([y$K({constructOnly:!0})],w.prototype,"container",void 0),e$Q([y$K({constructOnly:!0})],w.prototype,"renderSR",void 0),e$Q([y$K({constructOnly:!0})],w.prototype,"_handles",void 0),e$Q([y$K({readOnly:!0})],w.prototype,"updating",null),e$Q([y$K({constructOnly:!0})],w.prototype,"_model",void 0),e$Q([i$11(),y$K()],w.prototype,"renderView",void 0),w=f=e$Q([n$14("esri.views.3d.webgl-engine.Stage")],w);

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
function a(e,r){if(!e.target)return null;switch(e.target.type){case"stage":return u(e.target.obj.metadata,r);case"external":switch(e.intersector){case"PointRenderer":return l(e.target,r);case"I3S":case"IM":case"LodRenderer":case"OverlayRenderer":return u(e.target.metadata,r);case"TerrainRenderer":return r.map&&r.map.ground}}return null}function n(e,r){if(!e.target)return null;switch(e.target.type){case"stage":return i(e.target.obj.metadata,r);case"external":switch(e.intersector){case"PointRenderer":return s(e.target);case"I3S":case"IM":case"LodRenderer":case"OverlayRenderer":return i(e.target.metadata,r)}}return null}function i(a,n){if(t$17(a))return null;const i=u(a,n);if(t$17(i))return null;if(i===n.graphics)return r$Y(n.graphicsView)?e$12(n.graphicsView.getGraphicFromGraphicUid(a.graphicUid)):null;const l=n.allLayerViews.find((e=>e.layer===i));return l?c(l,a):null}function c(e,r){return !e||e.suspended?null:"getGraphicFromIntersectorMetadata"in e&&r?e.getGraphicFromIntersectorMetadata(r):"getGraphicFromGraphicUid"in e&&null!=r.graphicUid?e.getGraphicFromGraphicUid(r.graphicUid):null}function u(t,a){return t$17(t)||null==t.layerUid?null:r$Y(a.graphicsView)&&t.layerUid===a.graphicsView.graphics3d.layer.id?a.graphics:a.map.findLayerByUid(t.layerUid)}function l(e,r){const t=e.metadata.layerUid;return null!=t?r.map.findLayerByUid(t):null}function s(e){return e.metadata.createGraphic()}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
async function t(t,s){if("2d"===t.type)return t.hitTest(s);const e=await t.hitTest(s),n=e.results[0],i=e.results.findIndex((t=>t.distance!==n.distance));return -1!==i&&(e.results=e.results.slice(0,i)),e}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
let e=class extends u$1g{constructor(o){super(o),this.components=["attribution","zoom","navigation-toggle","compass"];}};e$Q([y$K()],e.prototype,"components",void 0),e=e$Q([n$14("esri.views.ui.3d.DefaultUI3D")],e);var p=e;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
const qe=n$12.getLogger("esri.views.SceneView");let ze=class extends(m$11(_$s(a$1s(P$D)))){constructor(e){super(e),this._clippingArea=null,this._userClippingArea=null,this._initialDefaultSpatialReference=null,this._defaults={},this._externallySet={environment:!1},this._createGraphicsViewController=null,this._resolveWhenReady=[],this.propertiesPool=new o$m({slicePlane:z$s},this),this._resourceController=g$g(this),this._defaultToMapOptions={include:new Set},this._defaultHitTestOptions={exclude:new Set},this.deconflictor=new d$z({view:this}),this.labeler=new S$c({view:this,deconflictor:this.deconflictor.labels}),this.sharedSymbolResources=null,this.basemapTerrain=null,this.elevationProvider=null,this.camera=null,this.canvas=null,this.center=null,this.constraints=new a$V,this.environmentManager=new Q$j,this.extent=null,this.floors=new L$t,this.windowDevicePixelRatio=1,this.fullOpacity=1,this.graphicsView=null,this.groundView=null,this.navigating=!1,this.map=null,this.screenSizePerspectiveEnabled=!0,this.state=new C$7,this.scale=null,this.spatialReference=null,this.isHeightModelInfoRequired=!0,this.alphaCompositingEnabled=!1,this.supersampleScreenhotsEnabled=!0,this.type="3d",this.ui=new p,this._numUpdating=0,this._lastUpdateTime=0,this.updatingProgress=.5,this.viewpoint=null,this.zoom=null,this.highlightOptions=new e$j,m$12(),e&&e.environment||(this._defaults.environment=new l$N,this.environment=this._defaults.environment);const t=e=>{r$Y(e)&&4===e.type||(this.notifyChange("dataExtent"),this.updatingChanged(),this.map&&this.map.allLayers.forEach((async e=>{try{await e.when();}catch{}this.updatingChanged();})));};this.handles.add([C$q(this,"map.allLayers","after-changes",t,t,t,!0),this.allLayerViews.on("after-changes",(e=>this._updateUpdatingMonitors(e))),this.watch("map",(e=>{e&&e.load&&e.load().catch((()=>{}));}))]),this.inputManager=new k$j({view:this});const i=()=>{const e=window.devicePixelRatio;e!==this.windowDevicePixelRatio&&(this.windowDevicePixelRatio=e,this.notifyChange("pixelRatio"));};this.stateManager=new L$a({view:this,updateDevicePixelRatio:i});}initialize(){this.groundView=new l$S({view:this}),this._updateUpdatingMonitors();const e=()=>this._updateDefaultToMapOptions();this.handles.add(C$q(this,"map.allLayers","after-changes",e,e,e)),this.updatingHandles.add(this.qualitySettings,"memoryLimit",(e=>{this.resourceController&&(this.resourceController.memoryController.maxMemory=e);}),2),this.updatingHandles.add(this.qualitySettings,"additionalCacheMemory",(e=>{this.resourceController&&(this.resourceController.memoryController.additionalCacheMemory=e);}),2),this.updatingHandles.add(this.qualitySettings,"frameRate",(e=>F$F(e>0?1e3/Math.ceil(e):0)),2),this.updatingHandles.add(T$k,"SCENEVIEW_LOCKING_LOG",(e=>this.defaultsFromMap.logDebugInformation=e),2),this.updatingHandles.add(this,"map.ground",e,3),this.updatingHandles.add(this,"map.ground.opacity",(()=>this._updateDefaultHitTestOptions()),3),this.handles.add(this.watch("spatialReference",(()=>this.notifyChange("clippingArea")),!0));}destroy(){this.destroyed||(this.invalidate(),this.activeTool=null,this.layerViewManager.clear(),this._exitSurface(),this._disposeGraphicsView(),this.sharedSymbolResources&&(this.sharedSymbolResources.destroy(),this.sharedSymbolResources=null),this.labeler.destroy(),this._set("labeler",null),this.deconflictor.destroy(),this._set("deconflictor",null),this._resourceController.destroy(),this._resourceController=null,this.stateManager.destroy(),this._set("stateManager",null),this.inputManager.destroy(),this._set("inputManager",null),this.propertiesPool.destroy(),this.handles.remove("updatingMonitors"),this.environmentManager.destroy(),this._set("environmentManager",null),this.groundView.destroy(),this.groundView=null);}get renderSpatialReference(){return this.renderCoordsHelper&&this.renderCoordsHelper.spatialReference}get basemapSpatialReference(){return this.basemapTerrain&&this.basemapTerrain.spatialReference}installContentCameraReset(e={sticky:!1}){return this.stateManager.installContentCameraReset(e)}get clippingArea(){if("global"===this.viewingMode)return null;let e=this._userClippingArea||this.get("map.clippingArea");if(!(!!this._userClippingArea||this.get("map.clippingEnabled"))||!e)return this._clippingArea=null,null;if(!(e instanceof M$x))return qe.error("#clippingArea","only clippingArea geometries of type Extent are supported"),this._clippingArea;if(this.spatialReference){if(!x$O(e.spatialReference,this.spatialReference))return qe.error("#clippingArea","setting clippingArea with incompatible SpatialReference"),this._clippingArea;e=g$11(e,this.spatialReference);}return this._clippingArea&&e&&this._clippingArea.equals(e)?this._clippingArea:(this._clippingArea=e,e)}set clippingArea(e){this.ready&&"global"===this.viewingMode&&e?qe.error("#clippingArea=","Clipping area is only supported in local viewingMode"):(this._userClippingArea=e,this.notifyChange("clippingArea"));}get dataExtent(){const e=this.spatialReference||k$x.WGS84;let t,i=this.clippingArea;i&&(i=g$11(i,e));const r=r=>{let s=g$11(r,e);s&&(i&&(s=s.intersection(i),!s)||(r$Y(t)?t.union(s):t=s));},s=this.basemapTerrain;if(s&&s.spatialReference&&r(new M$x({xmin:s.extent[0],ymin:s.extent[1],zmin:0,xmax:s.extent[2],ymax:s.extent[3],zmax:0,spatialReference:s.spatialReference})),this.map){const e=e=>{!e.fullExtent||"graphics"===e.type&&e.internal||r(e.fullExtent);};this.map.allLayers.forEach((t=>e(t)));}return t$17(t)?new M$x({xmin:0,ymin:0,zmin:0,xmax:0,ymax:0,zmax:0,spatialReference:e}):(t.hasZ?(t.zmin=Math.min(0,t.zmin),t.zmax=Math.max(0,t.zmax)):(t.zmin=0,t.zmax=0),t)}set environment(e){e!==this._defaults.environment&&(this._externallySet.environment=!0),this._set("environment",e);}castEnvironment(e){return e?e instanceof l$N?e:e instanceof c$N?null!=this.environment?this.environment.cloneWithWebsceneEnvironment(e):l$N.fromWebsceneEnvironment(e):d$Q(l$N,e):new l$N}get pixelRatio(){return Math.min(this.windowDevicePixelRatio,this.maximumPixelRatio)}set pixelRatio(e){r$Y(e)?this._override("pixelRatio",e):this._clearOverride("pixelRatio");}get maximumPixelRatio(){let e=1/0;const{maximumPixelRatio:t,maximumRenderResolution:i}=this.qualitySettings;if(null!=t&&(e=Math.min(e,t)),null!=i){const t=i/Math.max(this.width,this.height);e=Math.min(e,t);}return e}set maximumPixelRatio(e){r$Y(e)?this._override("maximumPixelRatio",e):this._clearOverride("maximumPixelRatio");}get groundExtent(){const e=this._get("basemapTerrain");if(e&&e.spatialReference){const t=e.extent;return new M$x({xmin:t[0],ymin:t[1],xmax:t[2],ymax:t[3],spatialReference:e.spatialReference})}const t=this.spatialReference||k$x.WGS84;return new M$x({spatialReference:t})}get initialExtentRequired(){return this.stateManager&&!this.stateManager.hasInitialView}get interacting(){return this.navigating||r$Y(this.activeTool)}get stationary(){return !this.animation&&!this.resizing&&(t$17(this.state)||this.state.stationary)}set qualityProfile(e){o$l.isValidProfile(e)&&(o$l.apply(e,this.qualitySettings),this._set("qualityProfile",e));}get qualityProfile(){return this._get("qualityProfile")||o$l.getDefaultProfile()}set slicePlane(e){if(this._stage.renderView.setRenderParameters({slicePlane:e}),t$17(e))return void this._set("slicePlane",null);const t=this.propertiesPool.get("slicePlane");D$p(e,t),this._set("slicePlane",t);}get resolution(){return null!=this.spatialReference?i$W(this.scale,this.spatialReference):0}get heightModelInfo(){const e=this.getDefaultHeightModelInfo();return null!=e?v$T.deriveUnitFromSR(e,this.spatialReference):null}get updating(){var e,t,i;let r=0,s=this.layerViewManager.updating,n=s?this.layerViewManager.updatingRemaining:0;this.allLayerViews.forEach((e=>{if(e.isFulfilled()){if(e.updating){if(s=!0,e.suspended||g$e(e))return;++n,r+="updatingProgress"in e?e.updatingProgress:.5;}}else ++n;}));for(const a of [this.graphicsView,this.basemapView,this._resourceController,this._stage,this.featureTiles,this.pointsOfInterest,this.environmentManager,this.overlay,this.featureTreeDebugger,this.toolViewManager])if(r$Y(a)&&a.updating){const e=.1;n+=e,r+=.5*e;}for(const a of [this.deconflictor,this.labeler,this.basemapTerrain])r$Y(a)&&a.updating&&(++n,r+=a.updatingProgress);if(s=!!(s||n>0||this.updatingHandles.updating||!this.ready||!this.stationary||this._createGraphicsViewController||null!=(e=this.inputManager)&&e.hasPendingInputs||null!=(t=this.map)&&null!=(i=t.allLayers)&&i.some((e=>!e.isFulfilled()))),s?(this._numUpdating=Math.max(n,this._numUpdating),r+=this._numUpdating-n):this._numUpdating=0,this._numUpdating>0?r/=this._numUpdating:r=s?0:1,this._get("updatingProgress")!==r){const e=this._resourceController.scheduler.now;if(r<1){const t=Math.min((e-this._lastUpdateTime)/2e3,1);r=this.updatingProgress*(1-t)+r*t;}this._set("updatingProgress",r),this._lastUpdateTime=s&&r<1?e:0;}return s}get viewingMode(){const e=this.get("map.initialViewProperties.viewingMode");if(e)return e;const t=this.spatialReference;return !t||i$x(t,"global")?"global":"local"}set viewingMode(e){if(this.ready)qe.error("#viewingMode","viewingMode cannot be set once view is ready");else {["local","global"].indexOf(e)>=0?this._override("viewingMode",e):void 0===e&&this._clearOverride("viewingMode");}}get resourceController(){return this._resourceController}get performanceInfo(){return new s$h(this)}on(e,t,i,r){const s=this.viewEvents.on(e,t,i,r);return s||super.on(e,t)}hasEventListener(e){return super.hasEventListener(e)||this.viewEvents.hasHandler(e)}toMap(e,t){if(!this.ready)return qe.error("#toMap()","Scene view cannot be used before it is ready"),null;const i=t?this.externalToInternalIntersectOptions(t):this._defaultToMapOptions,r=r$Y(i.graphics)&&(r$Y(i.graphics.include)||r$Y(i.graphics.exclude)),s=i$1g(e)?n$1D(this,e):e,n$1=d$X(s);i.enableDraped=i.include&&!i.include.has(O$B)||i.exclude&&i.exclude.has(O$B);const a=this.sceneIntersectionHelper,o=new u$L(this.state.viewingMode);if(o.options.selectionMode=!0,o.options.store=r?2:0,a.intersectIntersectorScreen(n$1,o,i),r){for(const e of o.results.all){const t=n(e,this);if(t$17(t))return this._intersectResultToMapPoint(e);if(this._testGraphicUidFilter(i.graphics,t))return this._intersectResultToMapPoint(e)}return null}return this._intersectResultToMapPoint(o.results.min)}toScreen(e){if(!this.ready)return qe.error("#toScreen()","Scene view cannot be used before it is ready"),null;const t=c$W(null==e.z&&i$O(this.elevationProvider,e),0);return Rn(e,Be,this.renderSpatialReference,t),this.state.camera.projectToScreen(Be,$e),c$19($e[0],$e[1])}pixelSizeAt(e){return this.ready?e?(Rn(e,Be,this.renderSpatialReference),this.state.camera.computeScreenPixelSizeAt(Be)):0:(qe.error("#pixelSizeAt()","Scene view cannot be used before it is ready"),null)}overlayPixelSizeInMapUnits(e){const t=this.basemapTerrain.overlayManager;return t?t.overlayPixelSizeInMapUnits(e):1}hitTest(e,t){if(!this.ready)return qe.error("#hitTest()","Scene view cannot be used before it is ready"),null;const i=i$1g(e)?n$1D(this,e):e,r=i$U(i.x,i.y),s=t?this.externalToInternalIntersectOptions(t):this._defaultHitTestOptions;s.requiresGroundFeedback=!0,s.enableDraped=!0;const n=new u$L(this.state.viewingMode);n.options.selectionMode=!0,n.options.store=2,this.sceneIntersectionHelper.intersectIntersectorScreen(r,n,s);const a$1=this._intersectResultsToHits(n.results.all,s.graphics),o=n.results.ground,l=a(o,this),p=r$Y(l)&&"type"in l&&"integrated-mesh"===l.type?l:null,h={screenPoint:i,results:a$1,ground:{mapPoint:this._intersectResultToMapPoint(o),distance:o.hasIntersectionPoint?o.distanceInRenderSpace:0,layer:p}};return T$k.SCENEVIEW_HITTEST_RETURN_INTERSECTOR&&(h.intersector=n),Promise.resolve(h)}popupHitTest(e){return t(this,e).then((({results:t,ground:i})=>{let r=null;return !(0===t.length||Math.abs(t[0].distance-i.distance)<1e-5)||i.layer&&"integrated-mesh"===i.layer.type||(r=i.mapPoint),{results:t,screenPoint:e,mapPoint:r}}))}goTo(e,t){return this.updatingHandles.addPromise(this.stateManager.goTo(e,t))}whenLayerView(e){return super.whenLayerView(e)}takeScreenshot(e){return this.whenReady().then((()=>{const t=n$1E(e,this);return t.pixelRatio/=this.pixelRatio,this._stage.renderView.takeScreenshot(f$16(t,this.supersampleScreenhotsEnabled,this.padding))}))}addUpdatingPromise(e){return this.updatingHandles.addPromise(e)}importLayerView(e){return l$Q.importLayerView(e)}hasLayerViewModule(e){return l$Q.hasLayerViewModule(e)}forceDOMReadyCycle(){this.forceReadyCycle();}getDefaultSpatialReference(){return this.get("map.initialViewProperties.spatialReference")||this.get("defaultsFromMap.spatialReference")||this.get("defaultsFromMap.isSpatialReferenceDone")&&this._initialDefaultSpatialReference||null}async validate(){let e=s$1g();if(s$U("safari")&&s$U("safari")<9&&(e=new s$Q("sceneview:browser-not-supported","This browser is not supported by SceneView (Safari < 9)",{type:"safari",requiredVersion:9,detectedVersion:s$U("safari")})),r$Y(e))throw qe.warn("#validate()",e.message),e}isSpatialReferenceSupported(e,t,i){const r=e.isGeographic,s=e.isWebMercator,n=i$x(e,"global"),a="local"===this.viewingMode,o=!(!this._isOverridden("viewingMode")&&!this.get("map.initialViewProperties.viewingMode"));if(o){if(a&&r)return i?i(`Layer ${t.id} is ignored because it is GCS and viewing mode is local`):qe.warnOnce("Geographic coordinate systems are not supported in local viewing mode."),!1;if(!a&&!n)return i?i(`Layer ${t.id} is ignored because its spatial reference is not supported in global viewing mode`):qe.warnOnce("Spatial reference defined on view not supported in global viewing mode."),!1}else if(r&&!n)return i?i(`Layer ${t.id} is ignored because its spatial reference is geographic but unsupported`):qe.warnOnce("Spatial reference is geographic but not supported."),!1;if(t)if(e$N(t)){let r;if(o){r=null!=C$4(t,e,l$R(this.viewingMode)).tileInfo;}else {let i=C$4(t,e,1);null==i.tileInfo&&(i=C$4(t,e,2),null!=i.tileInfo&&s&&!this.ready&&(this.viewingMode="local")),r=null!=i.tileInfo;}if(!r)return i&&i(`Layer ${t.id} is ignored because it is tiled but\n            its tiling scheme is not supported or compatible with the viewing mode`),!1}else if((e.isWGS84||s)&&!a)return null==this._initialDefaultSpatialReference&&(this._initialDefaultSpatialReference=e),o||this.ready||(this.viewingMode="global",i&&i(`Viewing mode locked to global due to reprojectable layer ${t.id}`)),i&&i(`Layer ${t.id} is ignored because it supports server-side reprojection`),!1;return !0}whenReady(){return new Promise((e=>{this.ready?e(this):this._resolveWhenReady.push(e);}))}computeMapPointFromVec3d(e,t){let i=this.spatialReference||k$x.WGS84;return wn(e,this.renderSpatialReference,e,i)||(i=k$x.WGS84,wn(e,this.renderSpatialReference,e,i)),t?(t.x=e[0],t.y=e[1],t.z=e[2],t.spatialReference=i):t=new b$G(e,i),t}trackGraphicState(e){if(!e.graphic)return qe.error("trackGraphicState","GraphicState.graphic must not be null or undefined to start tracking"),null;const t=this.getViewForGraphic(e.graphic);let i=null,r=!1;const s=t=>{!r&&r$Y(t)&&"graphics3d"in t&&t.graphics3d&&t.graphics3d.graphicsCore&&(i=t.graphics3d.graphicsCore.trackGraphicState(e));};return r$Y(t)?s(t):this.whenViewForGraphic(e.graphic,{waitForLayer:!0}).then((e=>s(e)),(()=>{})).catch((()=>{})),{remove:()=>{r=!0,r$Y(i)&&(i.remove(),i=null);}}}highlight(e){if(Array.isArray(e))return r$1z(e.map((e=>this.highlight(e))));if(L$t.isCollection(e))return r$1z(e.toArray().map((e=>this.highlight(e))));const t=this.getViewForGraphic(e);return t&&"highlight"in t?t.highlight(e):n$1F()}maskOccludee(e){if(!e)return qe.error("maskOccludee","GraphicState.graphic must not be null or undefined to mask an occludee"),null;const t=this.getViewForGraphic(e);let i=null,r=!1;const s=t=>{!r&&r$Y(t)&&"graphics3d"in t&&t$1w(t)&&(i=t.maskOccludee(e));};return r$Y(t)?s(t):this.whenViewForGraphic(e,{waitForLayer:!0}).then((e=>s(e)),(()=>{})).catch((()=>{})),{remove:()=>{r=!0,r$Y(i)&&(i.remove(),i=null);}}}getViewForGraphic(e){return e.layer===this.graphics?this.graphicsView:e.layer?this.allLayerViews.find((t=>t.layer===e.layer)):null}graphicChanged(e){r$Y(this.graphicsView)&&this.graphicsView.graphicChanged(e);}async whenViewForGraphic(e,t){if(e.layer===this)return await j$K(this,"graphicsView"),this.graphicsView;if(!e.layer||!this.map)throw new s$Q("no-view-for-graphic");return t&&t.waitForLayer&&!this.map.allLayers.includes(e.layer)?new Promise(((t,i)=>{const r=this.map.allLayers.on("change",(s=>{-1!==s.added.indexOf(e.layer)&&(r.remove(),this.whenLayerView(e.layer).then(t,i));}));})):this.whenLayerView(e.layer)}externalToInternalIntersectOptions(e){const t=this._externalToInternalRenderItems(e.include,0),i=this._externalToInternalRenderItems(e.exclude,1);return {include:t.layerUids,exclude:i.layerUids,graphics:{include:t.graphicUids,exclude:i.graphicUids}}}_intersectResultToMapPoint(e,t){return e.getIntersectionPoint(Be)?(t=this.computeMapPointFromVec3d(Be,t),"TerrainRenderer"===e.intersector&&this.basemapTerrain&&(t.z=c$W(i$O(this.basemapTerrain,t),0)),t):null}_intersectResultsToHits(e,t){const i=new Array;let r=null;for(let s=0;s<e.length;s++){const n$1=e[s],a$1=a(n$1,this);if(r$Y(a$1)&&(a$1===this.map.ground||"type"in a$1&&"integrated-mesh"===a$1.type))break;const o=n(n$1,this);if(!r$Y(o))continue;if(t$17(r)&&s!==e.length-1&&(r=new Set),r$Y(r)){const e=this._getGraphicFilterUid(o);if(r.has(e))continue;r.add(e);}if(!this._testGraphicUidFilter(t,o))continue;const l=this._intersectResultToMapPoint(n$1),p=n$1.distanceInRenderSpace;i.push({graphic:o,mapPoint:l,distance:p});}return i}_getGraphicFilterUid(e){if(e.layer&&"objectIdField"in e.layer){const t=e.attributes[e.layer.objectIdField];if(t)return `o-${e.layer.id}-${t}`}return `u-${e.uid}`}_testGraphicUidFilter(e,t){const i=this._getGraphicFilterUid(t);return t$17(e)||(t$17(e.include)||e.include.has(i))&&(t$17(e.exclude)||!e.exclude.has(i))}_externalToInternalRenderItems(e,t,s={layerUids:null,graphicUids:null}){return e?(e instanceof h$R?(Ne(s,this._getGraphicFilterUid(e)),0===t&&(r$Y(this.graphicsView)&&e.layer===this?ke(s,this.graphicsView.graphics3d.layer.id):e.layer&&ke(s,e.layer.uid))):"forEach"in e?e.forEach((e=>{Array.isArray(e)?this._externalToInternalRenderItems(e,t,s):L$t.isCollection(e)?e===this.graphics&&r$Y(this.graphicsView)?ke(s,this.graphicsView.graphics3d.layer.id):this._externalToInternalRenderItems(e,t,s):e instanceof A$E?e===this.map.ground&&ke(s,O$B):this._externalToInternalRenderItems(e,t,s);})):ke(s,e.uid),s):s}_initBasemapTerrain(){this._set("basemapTerrain",new Ve({view:this})),this._set("elevationProvider",new p$i({view:this})),this.elevationProvider.register("ground",this.basemapTerrain);}_exitBasemapTerrain(){this.basemapTerrain&&(this.elevationProvider.unregister(this.basemapTerrain),this.elevationProvider.destroy(),this._set("elevationProvider",null),this.basemapTerrain.destroy(),this._set("basemapTerrain",null));}_initGlobe(){this._initCoordinateSystem(),this.state.createInitialCamera(),this._initBasemapTerrain(),this._set("pointsOfInterest",new U$6({view:this})),this._set("featureTiles",new O$7({renderCoordsHelper:this.renderCoordsHelper,cameraOnSurface:this.pointsOfInterest.contentCameraOnSurface,focus:this.pointsOfInterest.focus,tilingSchemeOwner:this.basemapTerrain,viewState:this.state,scheduler:this._resourceController.scheduler,terrain:this.basemapTerrain}));const e=()=>{const e=this.basemapTerrain&&this.basemapTerrain.extent;if(this.clippingArea||e)if(e&&this.basemapTerrain.spatialReference){const e=o$U(this.basemapTerrain.extent,this.basemapTerrain.spatialReference);this.clippingArea?this.featureTiles.filterExtent=e.intersection(this.clippingArea):this.featureTiles.filterExtent=e;}else this.featureTiles.filterExtent=this.clippingArea;else this.featureTiles.filterExtent=null;};this.handles.add([this.updatingHandles.add(T$k,"FEATURE_TILE_TREE_SHOW_TILES",(e=>{e&&this.featureTiles&&!this.featureTreeDebugger?this.updatingHandles.addPromise(import('./FeatureTileTree3DDebugger-a2fe8531.js')).then((({FeatureTileTree3DDebugger:e})=>{!this.featureTreeDebugger&&T$k.FEATURE_TILE_TREE_SHOW_TILES&&(this.featureTreeDebugger=new e({view:this}));})):e||!this.featureTreeDebugger||T$k.FEATURE_TILE_TREE_SHOW_TILES||(this.featureTreeDebugger.destroy(),this.featureTreeDebugger=null);}),3),this.updatingHandles.add(this,"clippingArea",e,3),this.updatingHandles.add(this,"basemapTerrain.extent",e,3)],"feature-tiles"),this.stateManager.init();}_exitGlobe(){this.state&&(this.stateManager.deinit(),this.handles.remove("render-coords-helper"),this.handles.remove("feature-tiles"),this.featureTiles.destroy(),this._set("featureTiles",null),this.pointsOfInterest.destroy(),this._set("pointsOfInterest",null),this._exitBasemapTerrain(),this.state.exit(),this._exitCoordinateSystem());}_initCoordinateSystem(){if(this.spatialReference){const e=this.spatialReference;this.mapCoordsHelper&&this.mapCoordsHelper.spatialReference.equals(e)||this._set("mapCoordsHelper",new c$k(this.map,e));const t=this.state.isGlobal,i=t?O$C(e):e;i!==this.renderSpatialReference&&(this._set("renderCoordsHelper",_$a.create(this.state.viewingMode,i)),t||this.handles.add(this.watch("basemapTerrain.extent",(e=>{0===e[0]&&0===e[1]&&0===e[2]&&0===e[3]||(this.renderCoordsHelper.extent=e);}),!0),"render-coords-helper"),this.sceneIntersectionHelper&&this.sceneIntersectionHelper.setTolerance(u$L.DEFAULT_TOLERANCE/this.renderCoordsHelper.unitInMeters));}else this._set("mapCoordsHelper",null),this._set("renderCoordsHelper",null);}_exitCoordinateSystem(){this.mapCoordsHelper&&(this.handles.remove("render-coords-helper"),this._set("renderCoordsHelper",null),this._set("mapCoordsHelper",null));}updatingChanged(){this.notifyChange("updating");}_updateUpdatingMonitors(e=null){r$Y(e)&&4===e.type||(this.handles.remove("updatingMonitors"),this.allLayerViews.forEach((e=>{e.destroyed||(this.handles.add([e.watch(["updating","updatingProgress"],(()=>this.updatingChanged()),!0)],"updatingMonitors"),e.when((()=>this.updatingChanged()),(()=>this.updatingChanged())));})),this.updatingChanged());}_renderScreenshotOverlay(e,t){if(!this.overlay||!this.overlay.hasVisibleItems)return t;const i=e.getContext("2d");return i.putImageData(t,0,0),this.overlay.renderCanvas(e),i.getImageData(0,0,t.width,t.height)}_initStage(){const e={renderContext:this.renderContext,deactivatedWebGLExtensions:this.deactivatedWebGLExtensions,debugWebGLExtensions:this.debugWebGLExtensions,alpha:this.alphaCompositingEnabled,canvas:this.renderCanvas,screenshot:{renderOverlay:(e,t)=>this._renderScreenshotOverlay(e,t)}},t=new v$a(this.state.viewingMode,{forEachLayer:e=>this._stage.layers.forAll(e)},this);this._set("sceneIntersectionHelper",t);const i=e$1h(this.surface),{resourceController:r,state:s,renderSpatialReference:n}=this;this._stage=new w({resourceController:r,container:i,options:e,state:s,sceneIntersectionHelper:t,renderSR:n}),this._lostWebGLContextHandle=r$1A(this._stage.renderView.canvas,"webglcontextlost",(()=>this.fatalError=new s$Q("webgl-context-lost"))),this.handles.add([this.updatingHandles.add(this.qualitySettings,"antialiasingEnabled",(()=>{this._stage.renderView.setRenderParameters({antialiasingEnabled:this.qualitySettings.antialiasingEnabled});}),2),this.updatingHandles.add(this.qualitySettings,"highQualityTransparency",(()=>{this._stage.renderView.setRenderParameters({highQualityTransparency:this.qualitySettings.highQualityTransparency});}),2),d$S(this,"magnifier",(e=>this._stage.renderView.magnifier=e),!0)],"stage");const p=()=>{this._stage.renderView.setRenderParameters({defaultHighlightOptions:e$j.toEngineOptions(this.highlightOptions)});};for(const a of ["highlightOptions","highlightOptions.color","highlightOptions.haloColor","highlightOptions.haloOpacity","highlightOptions.fillOpacity","highlightOptions.shadowOpacity","highlightOptions.shadowColor","highlightOptions.shadowDifference"])this.handles.add(this.updatingHandles.add(this,a,p),"stage");p(),this.renderCoordsHelper&&this.sceneIntersectionHelper.setTolerance(u$L.DEFAULT_TOLERANCE/this.renderCoordsHelper.unitInMeters),this._set("canvas",this._stage.renderView.canvas);}_exitStage(){this._set("sceneIntersectionHelper",null),this._stage.destroy(),this._stage=null,this._lostWebGLContextHandle.remove(),this._lostWebGLContextHandle=null,this.handles.remove("stage"),this._set("canvas",null);}_initSurface(e){this._exitSurface(),this.state.init(e,this.spatialReference),this._initStage(),this._initGlobe(),this.sharedSymbolResources=new c$h({view:this,viewingMode:e,resourceController:this._resourceController,pointsOfInterest:this.pointsOfInterest,viewState:this.state,objectResourceCache:new m$k});}_exitSurface(){this.sharedSymbolResources&&(this.sharedSymbolResources.objectResourceCache.destroy(),this.sharedSymbolResources.destroy(),this.sharedSymbolResources=null,this._exitGlobe(),this._exitStage());}_createGraphicsViewIfNeeded(){if(this.graphicsView||this._createGraphicsViewController)return;if(0===this.graphics.length)return;this.handles.remove("graphics-view"),this._createGraphicsViewController=h$N();const e=()=>{this._createGraphicsViewController=null,this.updatingChanged();};this._createGraphicsViewAsync(this._createGraphicsViewController.signal).then(e,e),this.updatingChanged();}async _createGraphicsViewAsync(e){const t=(await import('./GraphicsView3D-9fed6b30.js')).default;a$1i(e),await x$V(this.basemapTerrain,"ready",e),this._set("graphicsView",new t({view:this}));}_disposeGraphicsView(){this._createGraphicsViewController&&(this._createGraphicsViewController.abort(),this._createGraphicsViewController=null),this.handles.remove("graphics-view"),r$Y(this.graphicsView)&&(this.handles.remove(this.graphicsView.graphics3d.layer.id),this.graphicsView.destroy(),this._set("graphicsView",null));}_startup(){const e=l$R(this.viewingMode);if(1===e&&(this._clippingArea=null),this._set("ready",!0),this._initSurface(e),this.handles.add(C$q(this,"graphics","after-changes",(()=>this._createGraphicsViewIfNeeded())),"graphics-view"),this._createGraphicsViewIfNeeded(),!this._externallySet.environment){const e=this.get("map.initialViewProperties.environment");e&&(this.environment=e);}this.labeler.setup(),this.environmentManager.connectView(this),this.inputManager.connect();const t=this._resolveWhenReady;this._resolveWhenReady=[],t.forEach((e=>e(this)));}_teardown(){this._initialDefaultSpatialReference=null,this.inputManager.disconnect(),this.environmentManager.disconnectView(),this.labeler.dispose(),this._disposeGraphicsView(),this.handles.remove("graphics-view"),this._exitSurface(),this._set("ready",!1);}_updateDefaultToMapOptions(){if(this._defaultToMapOptions.include.clear(),this.map){this.map.ground&&this._defaultToMapOptions.include.add(O$B);for(const e of this.map.allLayers.items)"integrated-mesh"===e.type&&this._defaultToMapOptions.include.add(e.uid);}}_updateDefaultHitTestOptions(){if(this._defaultHitTestOptions.exclude.clear(),this.map){this.map.ground&&this.map.ground.opacity<1&&this._defaultHitTestOptions.exclude.add(O$B);for(const e of this.map.allLayers.items)"integrated-mesh"===e.type&&e.opacity<1&&this._defaultToMapOptions.exclude.add(e.uid);}}};function ke(e,t){e.layerUids||(e.layerUids=new Set),e.layerUids.add(t);}function Ne(e,t){e.graphicUids||(e.graphicUids=new Set),e.graphicUids.add(t);}e$Q([y$K()],ze.prototype,"_resourceController",void 0),e$Q([y$K()],ze.prototype,"_stage",void 0),e$Q([y$K({readOnly:!0})],ze.prototype,"deconflictor",void 0),e$Q([y$K({readOnly:!0})],ze.prototype,"labeler",void 0),e$Q([y$K({type:n$1f,readOnly:!0,aliasOf:"state.animation"})],ze.prototype,"animation",void 0),e$Q([y$K({readOnly:!0})],ze.prototype,"basemapTerrain",void 0),e$Q([y$K({readOnly:!0})],ze.prototype,"elevationProvider",void 0),e$Q([y$K({type:d$W,aliasOf:"stateManager.camera"})],ze.prototype,"camera",void 0),e$Q([y$K({type:d$W,aliasOf:"stateManager.contentCamera"})],ze.prototype,"contentCamera",void 0),e$Q([y$K({readOnly:!0})],ze.prototype,"canvas",void 0),e$Q([y$K({type:b$G,aliasOf:"stateManager.center"})],ze.prototype,"center",void 0),e$Q([y$K({type:M$x,dependsOn:["map.clippingArea?","map.clippingEnabled?","viewingMode"]})],ze.prototype,"clippingArea",null),e$Q([y$K({type:a$V})],ze.prototype,"constraints",void 0),e$Q([y$K({type:M$x,dependsOn:["basemapTerrain.extent","clippingArea","map"],readOnly:!0})],ze.prototype,"dataExtent",null),e$Q([y$K({value:null,type:l$N})],ze.prototype,"environment",null),e$Q([c$Y("environment")],ze.prototype,"castEnvironment",null),e$Q([y$K({readOnly:!0})],ze.prototype,"environmentManager",void 0),e$Q([y$K({type:M$x,aliasOf:"stateManager.extent"})],ze.prototype,"extent",void 0),e$Q([y$K()],ze.prototype,"floors",void 0),e$Q([y$K({readOnly:!0,aliasOf:"stateManager.screenCenter"})],ze.prototype,"screenCenter",void 0),e$Q([y$K({type:Number})],ze.prototype,"pixelRatio",null),e$Q([y$K({type:Number,dependsOn:["qualitySettings.maximumPixelRatio","qualitySettings.maximumRenderResolution","size"]})],ze.prototype,"maximumPixelRatio",null),e$Q([y$K({aliasOf:"stateManager.frustum"})],ze.prototype,"frustum",void 0),e$Q([y$K({type:Number,readOnly:!0})],ze.prototype,"fullOpacity",void 0),e$Q([y$K({readOnly:!0})],ze.prototype,"graphicsView",void 0),e$Q([y$K({type:M$x,dependsOn:["basemapTerrain.extent"],readOnly:!0})],ze.prototype,"groundExtent",null),e$Q([y$K()],ze.prototype,"groundView",void 0),e$Q([y$K({type:Boolean})],ze.prototype,"initialExtentRequired",null),e$Q([y$K({type:Boolean,readOnly:!0})],ze.prototype,"interacting",null),e$Q([y$K()],ze.prototype,"stationary",null),e$Q([y$K({aliasOf:"state.navigating"})],ze.prototype,"navigating",void 0),e$Q([y$K()],ze.prototype,"map",void 0),e$Q([y$K({readOnly:!0})],ze.prototype,"mapCoordsHelper",void 0),e$Q([y$K({aliasOf:"stateManager.padding"})],ze.prototype,"padding",void 0),e$Q([y$K({type:U$6,readOnly:!0})],ze.prototype,"pointsOfInterest",void 0),e$Q([y$K({type:O$7,readOnly:!0})],ze.prototype,"featureTiles",void 0),e$Q([y$K()],ze.prototype,"featureTreeDebugger",void 0),e$Q([y$K({type:Boolean})],ze.prototype,"screenSizePerspectiveEnabled",void 0),e$Q([y$K({constructOnly:!0})],ze.prototype,"deactivatedWebGLExtensions",void 0),e$Q([y$K({constructOnly:!0})],ze.prototype,"debugWebGLExtensions",void 0),e$Q([y$K({constructOnly:!0})],ze.prototype,"renderCanvas",void 0),e$Q([y$K({constructOnly:!0})],ze.prototype,"state",void 0),e$Q([y$K({readOnly:!0})],ze.prototype,"inputManager",void 0),e$Q([y$K({readOnly:!0})],ze.prototype,"stateManager",void 0),e$Q([y$K({type:["low","medium","high"]})],ze.prototype,"qualityProfile",null),e$Q([y$K({type:l$h,get(){let e=this._get("qualitySettings");return e||(e=new l$h,o$l.apply(this.qualityProfile,e)),e}})],ze.prototype,"qualitySettings",void 0),e$Q([y$K()],ze.prototype,"slicePlane",null),e$Q([y$K({dependsOn:["viewingMode"]})],ze.prototype,"preconditionsReady",void 0),e$Q([y$K({readOnly:!0})],ze.prototype,"renderCoordsHelper",void 0),e$Q([y$K({readOnly:!0})],ze.prototype,"sceneIntersectionHelper",void 0),e$Q([y$K({type:Number,dependsOn:["scale","spatialReference"],readOnly:!0})],ze.prototype,"resolution",null),e$Q([y$K({type:Number,aliasOf:"stateManager.scale"})],ze.prototype,"scale",void 0),e$Q([y$K({dependsOn:[]})],ze.prototype,"heightModelInfo",null),e$Q([y$K({dependsOn:["map.initialViewProperties?.spatialReference","defaultsFromMap.isSpatialReferenceDone"]})],ze.prototype,"spatialReference",void 0),e$Q([y$K({type:Boolean,constructOnly:!0})],ze.prototype,"alphaCompositingEnabled",void 0),e$Q([y$K({type:Boolean})],ze.prototype,"supersampleScreenhotsEnabled",void 0),e$Q([y$K({readOnly:!0})],ze.prototype,"type",void 0),e$Q([y$K({type:p})],ze.prototype,"ui",void 0),e$Q([y$K({type:Boolean,readOnly:!0,dependsOn:["graphicsView.updating","basemapView.updating","basemapTerrain.updating","layerViewManager.updating","layerViewManager.updatingRemaining","_resourceController.updating","_stage.updating","featureTiles.updating","pointsOfInterest.updating","environmentManager.updating","overlay.updating","updatingHandles.updating","featureTreeDebugger.updating","labeler.updating","deconflictor.updating","ready","stationary","inputManager.hasPendingInputs","toolViewManager.updating"]})],ze.prototype,"updating",null),e$Q([y$K({type:Number,readOnly:!0,dependsOn:["updating"]})],ze.prototype,"updatingProgress",void 0),e$Q([y$K({type:["global","local"],dependsOn:["map.initialViewProperties?.viewingMode","spatialReference"]})],ze.prototype,"viewingMode",null),e$Q([y$K({type:u$17,aliasOf:"stateManager.viewpoint"})],ze.prototype,"viewpoint",void 0),e$Q([y$K({type:Number,aliasOf:"stateManager.zoom"})],ze.prototype,"zoom",void 0),e$Q([y$K({type:e$j})],ze.prototype,"highlightOptions",void 0),ze=e$Q([n$14("esri.views.SceneView")],ze);const Be=n$11(),$e=i$U();var Qe=ze;

export { x$L as $, p$B as A, e$o as B, j$y as C, D$4 as D, a$Z as E, e$5 as F, G$2 as G, E$3 as H, u$f as I, D$g as J, y$B as K, h$s as L, o$B as M, N$f as N, O$2 as O, P$l as P, x$D as Q, R$j as R, S$n as S, T$k as T, U$3 as U, m$A as V, N$7 as W, R$n as X, n$n as Y, f$A as Z, p$b as _, c$n as a, a$y as a0, s$z as a1, E$8 as a2, o$o as a3, M$m as a4, n$z as a5, R$p as a6, b$h as a7, n as a8, F$5 as a9, o$a as aA, a$A as aB, l$z as aC, t$7 as aD, n$6 as aE, i$2 as aF, h$3 as aG, t$4 as aH, n$4 as aI, c$x as aJ, p$3 as aK, p$x as aL, n$x as aM, h$m as aN, m$n as aO, g$n as aP, Qe as aQ, J$3 as aa, H$3 as ab, C$2 as ac, r$O as ad, p$11 as ae, K$3 as af, L$3 as ag, v$J as ah, d$f as ai, B$k as aj, ps as ak, ms as al, K$j as am, G$k as an, g$5 as ao, t$S as ap, r$T as aq, i$I as ar, b$p as as, m$E as at, x$x as au, n$C as av, r$a as aw, r$9 as ax, S$2 as ay, j$3 as az, b$m as b, c$C as c, d$v as d, e$z as e, a$j as f, d$r as g, a$D as h, i$q as i, r$F as j, i$e as k, n$j as l, p$e as m, n$H as n, o$m as o, p$H as p, P$w as q, r$w as r, f$p as s, o$r as t, u$L as u, l$p as v, f$v as w, x$d as x, y$x as y, t$n as z };
