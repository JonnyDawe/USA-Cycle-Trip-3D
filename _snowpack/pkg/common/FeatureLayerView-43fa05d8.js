import { e, a } from './JSONSupport-9346590f.js';
import { A, s } from './promiseUtils-2ff2b194.js';
import { n as n$1, r, t } from './Message-70b34921.js';
import { d, C } from './watchUtils-06a91cc9.js';
import { y, n } from './subclass-fe5fcf78.js';
import { u } from './OperationalLayer-a01538e1.js';
import { p, I as I$1, a as a$1, L, A as A$1, V, E, g, F, f as fe } from './fieldUtils-22be41cd.js';
import { b } from './Query-619f76b0.js';
import { y as y$1 } from './FeatureFilter-04f2a9e6.js';
import { d as d$1, t as t$1 } from './popupUtils-fde61b0c.js';

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
var i;let c=i=class extends a{constructor(){super(...arguments),this.filter=null,this.includedEffect=null,this.excludedEffect=null,this.excludedLabelsVisible=!1;}clone(){return new i({filter:this.filter&&this.filter.clone(),includedEffect:this.includedEffect,excludedEffect:this.excludedEffect,excludedLabelsVisible:this.excludedLabelsVisible})}};e([y({type:y$1,json:{write:!0}})],c.prototype,"filter",void 0),e([y({json:{write:!0}})],c.prototype,"includedEffect",void 0),e([y({json:{write:!0}})],c.prototype,"excludedEffect",void 0),e([y({type:Boolean,json:{write:!0}})],c.prototype,"excludedLabelsVisible",void 0),c=i=e([n("esri.views.layers.support.FeatureEffect")],c);var l=c;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
const I=n$1.getLogger("esri.views.layers.FeatureLayerView"),R=r$1=>{let R=class extends r$1{constructor(...e){super(...e),this._updatingRequiredFieldsPromise=null,this.effect=null,this.filter=null,this.timeExtent=null,this.layer=null,this.requiredFields=[],this.view=null;}initialize(){d(this,["layer.renderer","layer.labelingInfo","layer.elevationInfo.featureExpressionInfo","layer.displayField","filter","effect","layer.timeInfo","layer.floorInfo","timeExtent"],(()=>this._handleRequiredFieldsChange()),!0),C(this,"view.floors","change",(()=>this._handleRequiredFieldsChange())),C(this,"layer.sublayer","change",(()=>this._handleRequiredFieldsChange()));}get availableFields(){const{layer:e,layer:{fieldsIndex:t},requiredFields:r}=this;return "outFields"in e&&e.outFields?p(t,[...I$1(t,e.outFields),...r]):p(t,r)}get maximumNumberOfFeatures(){return 0}set maximumNumberOfFeatures(e){I.error("#maximumNumberOfFeatures=","Setting maximum number of features is not supported");}get maximumNumberOfFeaturesExceeded(){return !1}highlight(e){throw new Error("missing implementation")}createQuery(){const e={outFields:["*"],returnGeometry:!0,outSpatialReference:this.view.spatialReference},t=r(this.filter)?this.filter.createQuery(e):new b(e);return r(this.timeExtent)&&(t.timeExtent=r(t.timeExtent)?t.timeExtent.intersection(this.timeExtent):this.timeExtent.clone()),t}queryFeatures(e,t){throw new Error("missing implementation")}queryObjectIds(e,t){throw new Error("missing implementation")}queryFeatureCount(e,t){throw new Error("missing implementation")}queryExtent(e,t){throw new Error("missing implementation")}_loadArcadeModules(e){if(e.get("expressionInfos.length"))return a$1()}_handleRequiredFieldsChange(){const e=this._updateRequiredFields();this._set("_updatingRequiredFieldsPromise",e),e.then((()=>{this._updatingRequiredFieldsPromise===e&&this._set("_updatingRequiredFieldsPromise",null);}));}async _updateRequiredFields(){if(!this.layer||!this.view)return;const e="3d"===this.view.type,{layer:t,layer:{fieldsIndex:r$1,objectIdField:s}}=this,n="renderer"in t&&t.renderer,l=t.featureReduction,a=new Set,u=await A([n?n.collectRequiredFields(a,r$1):null,L(a,t),e?A$1(a,t):null,r(this.filter)?V(a,t,this.filter):null,this.effect?V(a,t,this.effect.filter):null,l?E(a,t,l):null]);if(t.timeInfo&&this.timeExtent&&g(a,t.fieldsIndex,[t.timeInfo.startField,t.timeInfo.endField]),"feature"===t.type&&t.floorInfo&&g(a,t.fieldsIndex,[t.floorInfo.floorField]),"subtype-group"===t.type){F(a,r$1,t.subtypeField);const e=t.sublayers.map((e=>{var t;return Promise.all([null==(t=e.renderer)?void 0:t.collectRequiredFields(a,r$1),L(a,e)])}));await A(e);}for(const i of u)i.error&&I.error(i.error);F(a,r$1,s),e&&"displayField"in t&&t.displayField&&F(a,r$1,t.displayField);const p=Array.from(a).sort();this._set("requiredFields",p);}validateFetchPopupFeatures(e){if(t(e))return null;for(const r of e.clientGraphics){const i=r.layer;if("popupEnabled"in i&&!i.popupEnabled)return new s("featurelayerview:fetchPopupFeatures","Popups are disabled",{layer:i});if("popupTemplate"in i){if(!d$1(i,e))return new s("featurelayerview:fetchPopupFeatures","Layer does not define a popup template",{layer:i})}}}async fetchClientPopupFeatures(e){const t=r(e)?e.clientGraphics:null;if(!t||0===t.length)return Promise.resolve([]);const r$1=[],s=[],o=await this.createPopupQuery(e);for(const n of t){const{layer:t}=n;if(!("popupEnabled"in t))continue;const l=I$1(this.layer.fieldsIndex,o.outFields),a=d$1(t,e);if(!r(a))continue;const u=await this._loadArcadeModules(a);u&&u.arcadeUtils.hasGeometryOperations(a)||!fe(l,n)?s.push(n):r$1.push(n);}return "stream"===this.layer.type||0===s.length?Promise.resolve(r$1):(o.objectIds=s.map((e=>e.attributes[this.layer.objectIdField])),this.layer.queryFeatures(o).then((e=>r$1.concat(e.features))).catch((()=>s)))}async createPopupQuery(e){const t=this.layer.createQuery(),r$1=new Set;let s=!1;const o=r(e)&&e.clientGraphics?e.clientGraphics.map((e=>e.layer)):[this.layer];for(const n of o){if(!("popupEnabled"in n))continue;const t=d$1(n,e);if(!r(t))continue;const o=await this._loadArcadeModules(t),l=o&&o.arcadeUtils.hasGeometryOperations(t);s=!("point"!==this.layer.geometryType&&!l);const a=await t$1(this.layer,t);for(const e of a)r$1.add(e);}return t.returnGeometry=s,t.returnZ=s,t.returnM=s,t.outFields=Array.from(r$1),t.outSpatialReference=this.view.spatialReference,t}canResume(){return !!super.canResume()&&(!r(this.timeExtent)||!this.timeExtent.isEmpty)}};return e([y()],R.prototype,"_updatingRequiredFieldsPromise",void 0),e([y({readOnly:!0})],R.prototype,"availableFields",null),e([y({type:l})],R.prototype,"effect",void 0),e([y({type:y$1})],R.prototype,"filter",void 0),e([y(u)],R.prototype,"timeExtent",void 0),e([y()],R.prototype,"layer",void 0),e([y({type:Number})],R.prototype,"maximumNumberOfFeatures",null),e([y({readOnly:!0,type:Boolean})],R.prototype,"maximumNumberOfFeaturesExceeded",null),e([y({readOnly:!0})],R.prototype,"requiredFields",void 0),e([y()],R.prototype,"suspended",void 0),e([y()],R.prototype,"view",void 0),R=e([n("esri.views.layers.FeatureLayerView")],R),R};

export { R, l };
