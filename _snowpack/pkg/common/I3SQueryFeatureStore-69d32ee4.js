import { e, p as p$1, U as b, V as w } from './JSONSupport-9346590f.js';
import { n as n$3 } from './Loadable-d16b3d7d.js';
import { n as n$1, t, r } from './Message-70b34921.js';
import { L as L$1 } from './unitUtils-b17203be.js';
import { j } from './watchUtils-06a91cc9.js';
import { y as y$1, n as n$2 } from './subclass-fe5fcf78.js';
import { L as L$2, u as u$1, a as o } from './mathUtils-a477cc74.js';
import { WhereClause as f$1 } from './WhereClause-55dc94e0.js';
import { T as Tn, D as D$1, H as H$1, w as wn } from './projection-c73dd3c4.js';
import { a, G as G$1 } from './aaBoundingBox-c0155c39.js';
import { u, m as m$1, c, i, F } from './aaBoundingRect-68336c41.js';
import { x, g } from './Point-ee7951c3.js';
import { X, V as V$1, f as fe } from './I3SUtil-acd66c30.js';
import { y as y$2 } from './FeatureFilter-04f2a9e6.js';
import { k as k$1 } from './SpatialReference-843b1520.js';
import { s as s$1 } from './promiseUtils-2ff2b194.js';
import { u as u$2 } from './Handles-af859b7b.js';
import { M } from './Polyline-ccd8fb47.js';
import { H as H$2 } from './QueryEngine-fd0ee569.js';
import g$1 from './FeatureSet-d8329cbc.js';
import { b as b$1 } from './Query-619f76b0.js';
import { t as t$2 } from './centroid-80fbdb27.js';
import { a as t$1 } from './OptimizedFeature-ccef5b1d.js';
import { n as n$4 } from './DefaultMaterial_COLOR_GAMMA-7c4a23ef.js';

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
const v=n$1.getLogger("esri.views.3d.layers.i3s.I3SMeshViewFilter");let O,k=class extends p$1{constructor(e){super(e),this._projectionEngineLoaded=!1;}initialize(){j(this,"filter.geometry").then((()=>this.loadAsyncModule(W().then((e=>{this.destroyed||(this._geometryEngine=e,this.applyFilters());})))));}get sortedObjectIds(){if(t(this.filter.objectIds))return null;const e=new Float64Array(this.filter.objectIds);return e.sort(),e}get parsedWhereClause(){const e=r(this.filter)?this.filter.where:null;if(t(e)||!e)return null;try{return f$1.create(e,this.layerFieldsIndex)}catch(t){v.error(`Failed to parse filter where clause: ${t}`);}return null}addFilters(e,t,r$1,s){const n=this.sortedObjectIds;r(n)&&e.push((e=>X(n,!0,e))),this.addSqlFilter(e,this.parsedWhereClause);const i=this.parsedGeometry;if(r(i)){const n=this.spatialRelationship;e.push(((e,o)=>T(e,o,s,t,r$1,i,n)));}}isMBSGeoemtryVisible(e,t,r$1){const s=this.parsedGeometry;if(r(s)){const n=this.spatialRelationship,i=s[0].spatialReference||t;if(!Tn(e,r$1,V,i))return v.warnOnce("SceneLayerView.filter.geometry is using unsupported SpatialReference, skipping geometry filter for MBS"),!0;return A(V,s,i,n)}return !0}get parsedGeometry(){if(t(this.filter))return null;if(!this._geometryEngine)return null;const{geometry:e}=this.filter;if(t(e))return null;const{distance:t$1,units:r}=this.filter,s=this.spatialRelationship,n="mesh"===e.type?e.extent:e;if(t(t$1)||0===t$1)return C(n,s);const o=r||L$1(n.spatialReference);if(n.spatialReference.isWGS84){return C(this._geometryEngine.geodesicBuffer(n,t$1,o),s)}if(x(n,k$1.WGS84)){return C(g(this._geometryEngine.geodesicBuffer(g(n,k$1.WGS84),t$1,o),n.spatialReference),s)}if(!this._projectionEngineLoaded&&(this.loadAsyncModule(D$1().then((()=>this._projectionEngineLoaded=!0))),!this._projectionEngineLoaded))return null;let c=null;try{c=H$1(n,k$1.WGS84);}catch(l){}if(c)try{c=H$1(this._geometryEngine.geodesicBuffer(c,t$1,o),n.spatialReference);}catch(l){c=null;}return c||v.error(`Filter by geodesic buffer (distance) unsupported, failed to project input geometry (${n.spatialReference.wkid}) to WGS84.`),C(c,s)}get spatialRelationship(){return r(this.filter)?this.filter.spatialRelationship:"intersects"}static checkSupport(e){return e.timeExtent?(v.warn("Filters with a timeExtent are not supported for mesh scene layers"),!1):!!L(e.spatialRelationship)||(v.warn(`Filters with spatialRelationship other than ${B.join(", ")} are not supported for mesh scene layers`),!1)}};function G(){return !!O}async function W(){return G()||(O=await import('./geometryEngine-b7f060c5.js')),O}e([y$1({type:y$2})],k.prototype,"filter",void 0),e([y$1()],k.prototype,"layerFieldsIndex",void 0),e([y$1()],k.prototype,"loadAsyncModule",void 0),e([y$1()],k.prototype,"applyFilters",void 0),e([y$1()],k.prototype,"addSqlFilter",void 0),e([y$1({readOnly:!0})],k.prototype,"sortedObjectIds",null),e([y$1({readOnly:!0})],k.prototype,"parsedWhereClause",null),e([y$1({readOnly:!0})],k.prototype,"parsedGeometry",null),e([y$1({readOnly:!0})],k.prototype,"spatialRelationship",null),e([y$1()],k.prototype,"_projectionEngineLoaded",void 0),e([y$1()],k.prototype,"_geometryEngine",void 0),k=e([n$2("esri.views.3d.layers.i3s.I3SMeshViewFilter")],k);const B=(e=>e)(["contains","intersects","disjoint"]);function L(e){return null!=e&&B.indexOf(e)>=0}function C(e,t){if(!e)return null;if("disjoint"===t&&"polygon"===e.type){const t=new Array(e.rings.length);for(let r=0;r<e.rings.length;++r){const s=u(1/0,1/0,-1/0,-1/0);m$1(s,e.rings[r]),t[r]={type:"polygon",rings:[e.rings[r]],spatialReference:e.spatialReference,aabr:s};}t.sort(((e,t)=>e.aabr[0]-t.aabr[0]));const n=new Set,i=new w;for(let e=0;e<t.length;++e){const s=t[e];for(let r=e+1;r<t.length;++r){const e=t[r];if(e.aabr[0]>=s.aabr[2])break;n.add(e);}n.forEach((e=>{if(s!==e)if(e.aabr[2]<=s.aabr[0])n.delete(e);else if(O.intersects(s,e)){s.rings=s.rings.concat(e.rings),c(s.aabr,e.aabr),delete s._geVersion,n.delete(e);const o=b(t,e,t.length,i);t.splice(o,1);}})),n.add(s);}for(const e of t)delete e.aabr;return t}return [e]}function A(e,t,r,s){const n=q(e,r);return t.every((e=>1!==Z(e,n,s)))}function T(e,t,r,s,n,i,o){const a=i[0].spatialReference||s.spatialReference;if(!Tn(t.node.mbs,n,V,a))return void v.warnOnce("SceneLayerView.filter.geometry is using unsupported SpatialReference, skipping geometry filter");const c=q(V,a),l=U(o,s,a,r,t.objectHandle);for(const p of i){if(0===e.length)return;switch(Z(p,c,o)){case 1:return void(e.length=0);case 0:continue}V$1(e,t.featureIds,(e=>P(p,e,l)));}}const V=[0,0,0,0];function U(e,t,r,s,n){const i=t.renderSpatialReference,o=new Map,a={rings:[[[0,0,0],[0,0,0],[0,0,0],[0,0,0]]],hasZ:!1,hasM:!1,type:"polygon",spatialReference:r};a.rings[0][3]=a.rings[0][0];const c={indices:null,data:null,stride:0,startIndex:0,endIndex:0};let l,p;switch(e){case"intersects":l=(e,t)=>O.intersects(e,t)?0:2,p=$;break;case"contains":l=(e,t)=>O.contains(e,t)?2:1,p=$;break;case"disjoint":default:l=(e,t)=>O.disjoint(e,t)?2:1,p=z;}return {collection:s,object:n,type:e,maskSR:r,renderSR:i,aabbCache:o,triangle:a,positions:c,triangleTest:l,geometryTest:p}}function q(e,t){const r={x:e[0],y:e[1],hasZ:!1,hasM:!1,type:"point",spatialReference:t},s=!t.isWGS84&&!t.isWebMercator?O.buffer(r,e[3],1):O.geodesicBuffer(r,e[3],1);return s.type="polygon",s}function Z(e,t,r){switch(r){case"intersects":case"contains":return $(e,t);case"disjoint":return z(e,t)}}function $(e,t){return O.intersects(e,t)?O.contains(e,t)?0:2:1}function z(e,t){return O.intersects(e,t)?O.contains(e,t)?1:2:0}const H=2**-32;function P(e,t,r){const{collection:s,object:n,renderSR:i,maskSR:o$1,geometryTest:a,aabbCache:c}=r;let l=c.get(t);if(!l){const e=s.getObjectTransform(n);s.getComponentAabb(n,t,D);const r=[[D[0],D[1],0],[D[0],D[4],0],[D[3],D[4],0],[D[3],D[1],0]];for(let t=0;t<4;++t)L$2(r[t],r[t],e.rotationScale),u$1(r[t],r[t],e.position),wn(r[t],i,r[t],o$1);l={rings:[r],hasZ:!1,hasM:!1,type:"polygon",spatialReference:o$1},l.rings[0][4]=l.rings[0][0],c.set(t,l);}switch(a(e,l)){case 1:return !1;case 0:return !0}const{triangle:p,triangleTest:g,positions:h}=r,y=p.rings[0][0],m=p.rings[0][1],b=p.rings[0][2],S=s.getObjectTransform(n);s.getComponentPositions(n,t,h);const{indices:R,data:w,stride:F,startIndex:E,endIndex:I}=h;for(let x=E;x<I;x+=3){const t=F*R[x+0],r=F*R[x+1],s=F*R[x+2];o(y,w[t+0],w[t+1],w[t+2]),o(m,w[r+0],w[r+1],w[r+2]),o(b,w[s+0],w[s+1],w[s+2]),L$2(y,y,S.rotationScale),L$2(m,m,S.rotationScale),L$2(b,b,S.rotationScale),u$1(y,y,S.position),u$1(m,m,S.position),u$1(b,b,S.position),wn(y,i,y,o$1),wn(m,i,m,o$1),wn(b,i,b,o$1);const n=m[0]-y[0],a=m[1]-y[1],c=b[0]-y[0],l=b[1]-y[1];if(!(Math.abs(n*l-a*c)<H))switch(delete p._geVersion,g(e,p)){case 1:return !1;case 0:return !0}}switch(r.type){case"intersects":return !1;case"contains":case"disjoint":default:return !0}}const D=a();

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
const l$1=H$2;let p=class extends p$1{constructor(e){super(e),this._dataQueryEngineInstance=null,this._handles=new u$2;}get defaultQueryJSON(){return new b$1({outSpatialReference:this.spatialReference}).toJSON()}get dataQueryEngine(){return this.ensureDataQueryEngine()}initialize(){this._handles.add(this.layerView.on("visible-geometry-changed",(()=>this.spatialIndex.events.emit("changed"))));}destroy(){this._dataQueryEngineInstance&&(this._dataQueryEngineInstance.destroy(),this._dataQueryEngineInstance=null),this._handles&&(this._handles.destroy(),this._handles=null),this._set("layerView",null);}async executeQueryForCount(e,r){return this.dataQueryEngine.executeQueryForCount(this._ensureQueryJSON(e),r)}async executeQueryForExtent(e,r){const{count:t,extent:s}=await this.dataQueryEngine.executeQueryForExtent(this._ensureQueryJSON(e),r);return {count:t,extent:M.fromJSON(s)}}async executeQueryForIds(e,r){return this.dataQueryEngine.executeQueryForIds(this._ensureQueryJSON(e),r)}async executeQuery(e,r){const s=this._ensureQueryJSON(e);if(s.returnGeometry)throw new s$1("feature-store:unsupported-query","returnGeometry is not yet supported for mesh scene layer queries");if(s.returnCentroid)throw new s$1("feature-store:unsupported-query","returnCentroid is not yet supported for mesh scene layer queries");const n=await this.dataQueryEngine.executeQuery(s,r),o=g$1.fromJSON(n);return o.features.forEach((e=>{e.geometry=null;})),o}_ensureQueryJSON(e){if(t(e))return this.defaultQueryJSON;const r=e.toJSON();return r.outSpatialReference||(e.outSpatialReference=this.spatialReference),r}ensureDataQueryEngine(){if(this._dataQueryEngineInstance)return this._dataQueryEngineInstance;const e=this.layer.objectIdField||"OBJECTID",r="esriGeometryPolygon",t=this.layer.fields.map((e=>e.toJSON())),s=this.layerView.view.resourceController.scheduler,n=this.spatialReference.toJSON(),o=this.priority,i=this.spatialIndex;return this._dataQueryEngineInstance=new l$1({hasZ:!0,hasM:!1,geometryType:r,fields:t,timeInfo:null,spatialReference:n,objectIdField:e,featureStore:i,scheduler:s,priority:o}),this._dataQueryEngineInstance}};e([y$1({constructOnly:!0})],p.prototype,"layerView",void 0),e([y$1({constructOnly:!0})],p.prototype,"priority",void 0),e([y$1({constructOnly:!0})],p.prototype,"spatialIndex",void 0),e([y$1({readOnly:!0,aliasOf:"layerView.view.spatialReference"})],p.prototype,"spatialReference",void 0),e([y$1({readOnly:!0,aliasOf:"layerView.i3slayer"})],p.prototype,"layer",void 0),e([y$1({readOnly:!0})],p.prototype,"defaultQueryJSON",null),p=e([n$2("esri.views.3d.layers.i3s.I3SQueryEngine")],p);var d$1=p;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class n{constructor(t){this.objectIdField=t.objectIdField,this.getFeatureExtent=t.getFeatureExtent;}getObjectId(t){return t.id}getAttributes(e){const{meta:r$1,index:o}=e,n={};this.objectIdField&&(n[this.objectIdField]=e.id);const s=r(r$1.attributeInfo)&&r$1.attributeInfo.attributeData;if(r(s))for(const t of Object.keys(s))n[t]=fe(s[t],o);return n}getAttribute(e,r$1){if(r$1===this.objectIdField)return e.id;const{meta:o,index:n}=e,s=r(o.attributeInfo)&&o.attributeInfo.attributeData;return r(s)?fe(s[r$1],n):null}getGeometry(t){if(t.geometry)return t.geometry;const[e,r,i,n,a]=this.getFeatureExtent(t,s);return new t$1([5],[e,r,i,n,r,i,n,a,i,e,a,i,e,r,i])}getCentroid(t,e){if(t.geometry)return t$2(new t$1,t.geometry,e.hasZ,e.hasM);const[i,n,a,m,u,d]=this.getFeatureExtent(t,s);return new t$1([0],[(i+m)/2,(n+u)/2,(a+d)/2])}cloneWithGeometry(t,e){const{id:r,index:o,meta:i}=t;return {id:r,index:o,meta:i,geometry:e}}}const s=a();

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
let m=class extends p$1{constructor(e){super(e),this.events=new n$3;}destroy(){}forEach(e){this.forAllFeatures((r=>(e(r),1)));}forEachBounds(e,r,t){const o=this.getFeatureExtent;for(const s of e)r(o(s,t));}forEachInBounds(e,r){this.forAllFeatures((t=>{const o=this.getFeatureExtent(t,l);return F(e,G$1(o,d))&&r(t),1}),(r=>{if(Tn(r.node.mbs,this.sourceSpatialReference,f,this.viewSpatialReference),f[0]>=e[0]&&f[2]<=e[2]&&f[1]>=e[1]&&f[3]<=e[3])return 1;const t=Math.max(e[0],Math.min(f[0],e[2])),o=Math.max(e[1],Math.min(f[1],e[3])),s=f[0]-t,c=f[1]-o;return s*s+c*c<=f[3]*f[3]?1:2}));}};e([y$1({constructOnly:!0})],m.prototype,"featureAdapter",void 0),e([y$1({constructOnly:!0})],m.prototype,"forAllFeatures",void 0),e([y$1({constructOnly:!0})],m.prototype,"getFeatureExtent",void 0),e([y$1({constructOnly:!0})],m.prototype,"sourceSpatialReference",void 0),e([y$1({constructOnly:!0})],m.prototype,"viewSpatialReference",void 0),m=e([n$2("esri.views.3d.layers.i3s.I3SQueryFeatureStore")],m);const f=n$4(),l=a(),d=i();var y=m;

export { d$1 as d, k, n, y };
