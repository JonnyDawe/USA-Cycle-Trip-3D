import { e } from './JSONSupport-9346590f.js';
import { f, L, V } from './Loadable-d16b3d7d.js';
import { h } from './Graphic-bb07b7e4.js';
import { y as y$1 } from './TimeExtent-02acfb1c.js';
import { s as s$1 } from './promiseUtils-2ff2b194.js';
import { r, c as s, t, o as o$1 } from './Message-70b34921.js';
import { o } from './jsonMap-e142bd84.js';
import { y, n } from './subclass-fe5fcf78.js';
import { M } from './Polyline-ccd8fb47.js';
import { p } from './jsonUtils-f0a19240.js';
import { u } from './clientSideDefaults-b49b5cc7.js';
import { Q, a } from './QueryTask-55cf149f.js';
import { l } from './zscale-9df5d655.js';
import { k } from './SpatialReference-843b1520.js';
import './Point-ee7951c3.js';
import './reader-fa0f173d.js';
import './PopupTemplate-d97f5e88.js';
import './Collection-32506e74.js';
import './fieldUtils-22be41cd.js';
import './enumeration-7d0c165d.js';
import './intl-21ab9759.js';
import './locale-b874fc68.js';
import './assets-73c8998f.js';
import './Identifiable-3ad643f8.js';
import './symbols-9e680ec7.js';
import './SimpleLineSymbol-9959d1ea.js';
import './Color-ae84a22a.js';
import './mathUtils-a477cc74.js';
import './opacityUtils-b92214c2.js';
import './persistableUrlUtils-59858a7e.js';
import './collectionUtils-a13e45d8.js';
import './Portal-ff63481f.js';
import './uid-6beaca4c.js';
import './QueryEngineCapabilities-377cef5c.js';
import './defaultsJSON-0467bd38.js';
import './Query-619f76b0.js';
import './Field-728fb193.js';
import './fieldType-6799091f.js';
import './Task-41e0c8b8.js';
import './query-de9ba206.js';
import './normalizeUtils-5edbbb73.js';
import './pbfQueryUtils-9ef2116f.js';
import './pbf-9fd5cf83.js';
import './OptimizedFeature-ccef5b1d.js';
import './unitUtils-b17203be.js';
import './OptimizedFeatureSet-be12a9b8.js';
import './queryZScale-688c1e0e.js';
import './TopFeaturesQuery-b22907ac.js';
import './FeatureSet-d8329cbc.js';
import './compilerUtils-7bbb76dc.js';
import './featureConversionUtils-3ad98dca.js';

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
const q=new o({originalAndCurrentFeatures:"original-and-current-features",none:"none"});async function _(e){if("string"==typeof e){const t=V(e);return t||{data:e}}return new Promise(((t,r)=>{const s=new FileReader;s.readAsDataURL(e),s.onload=()=>t(V(s.result)),s.onerror=e=>r(e);}))}const I=new Set(["Feature Layer","Table"]);let O=class extends f{constructor(){super(...arguments),this.type="feature-layer";}load(e){const t=r(e)?e.signal:null;return this.addResolvingPromise(this._fetchService(t)),Promise.resolve(this)}get queryTask(){const{capabilities:{query:{supportsFormatPBF:e}},parsedUrl:t$1,dynamicDataSource:r,infoFor3D:s$1,gdbVersion:a,spatialReference:o,fieldsIndex:u}=this.layer,n=s("featurelayer-pbf")&&e&&t(s$1)?"pbf":"json";return new Q({url:t$1.path,format:n,fieldsIndex:u,infoFor3D:s$1,dynamicDataSource:r,gdbVersion:a,sourceSpatialReference:o})}async addAttachment(e,t){await this.load();const s=e.attributes[this.layer.objectIdField],a=this.layer.parsedUrl.path+"/"+s+"/addAttachment",i=this._getLayerRequestOptions(),o=this._getFormDataForAttachment(t,i.query);try{const e=await L(a,{body:o});return this._createFeatureEditResult(e.data.addAttachmentResult)}catch(u){throw this._createAttachmentErrorResult(s,u)}}async updateAttachment(e,t,s){await this.load();const a=e.attributes[this.layer.objectIdField],i=this.layer.parsedUrl.path+"/"+a+"/updateAttachment",o=this._getLayerRequestOptions({query:{attachmentId:t}}),u=this._getFormDataForAttachment(s,o.query);try{const e=await L(i,{body:u});return this._createFeatureEditResult(e.data.updateAttachmentResult)}catch(n){throw this._createAttachmentErrorResult(a,n)}}async applyEdits(e,t){await this.load();const s=e.addFeatures.map(this._serializeFeature,this),a=e.updateFeatures.map(this._serializeFeature,this),i=this._getFeatureIds(e.deleteFeatures,null==t?void 0:t.globalIdUsed);l(s,a,this.layer.spatialReference);const o=[],u=[],n=[...e.deleteAttachments];for(const r of e.addAttachments)o.push(await this._serializeAttachment(r));for(const r of e.updateAttachments)u.push(await this._serializeAttachment(r));const l$1=o.length||u.length||n.length?{adds:o,updates:u,deletes:n}:null,d={gdbVersion:(null==t?void 0:t.gdbVersion)||this.layer.gdbVersion,rollbackOnFailure:null==t?void 0:t.rollbackOnFailureEnabled,useGlobalIds:null==t?void 0:t.globalIdUsed,returnEditMoment:null==t?void 0:t.returnEditMoment,usePreviousEditMoment:null==t?void 0:t.usePreviousEditMoment,sessionId:null==t?void 0:t.sessionId};null!=t&&t.returnServiceEditsOption?(d.edits=JSON.stringify([{id:this.layer.layerId,adds:s,updates:a,deletes:i,attachments:l$1}]),d.returnServiceEditsOption=q.toJSON(null==t?void 0:t.returnServiceEditsOption),d.returnServiceEditsInSourceSR=null==t?void 0:t.returnServiceEditsInSourceSR):(d.adds=s.length?JSON.stringify(s):null,d.updates=a.length?JSON.stringify(a):null,d.deletes=i.length?null!=t&&t.globalIdUsed?JSON.stringify(i):i.join(","):null,d.attachments=l$1&&JSON.stringify(l$1));const c=this._getLayerRequestOptions({method:"post",query:d}),h=null!=t&&t.returnServiceEditsOption?this.layer.url:this.layer.parsedUrl.path,p=await L(h+"/applyEdits",c);return this._createEditsResult(p)}async deleteAttachments(e,t){await this.load();const s=e.attributes[this.layer.objectIdField],a=this.layer.parsedUrl.path+"/"+s+"/deleteAttachments";try{return (await L(a,this._getLayerRequestOptions({query:{attachmentIds:t.join(",")},method:"post"}))).data.deleteAttachmentResults.map(this._createFeatureEditResult)}catch(i){throw this._createAttachmentErrorResult(s,i)}}fetchRecomputedExtents(e={}){const t=e.signal;return this.load({signal:t}).then((async()=>{const t=this._getLayerRequestOptions({...e,query:{returnUpdates:!0}}),{layerId:a,url:i}=this.layer,{data:o}=await L(`${i}/${a}`,t),{id:u,extent:n,fullExtent:l,timeExtent:d}=o,c=n||l;return {id:u,fullExtent:c&&M.fromJSON(c),timeExtent:d&&y$1.fromJSON({start:d[0],end:d[1]})}}))}async queryAttachments(e,t={}){const{parsedUrl:s}=this.layer,a$1=s.path;await this.load();const i=this._getLayerRequestOptions(t);if(!this.layer.get("capabilities.operations.supportsQueryAttachments")){const{objectIds:t}=e,s=[];for(const e of t){const t=a$1+"/"+e+"/attachments";s.push(L(t,i));}return Promise.all(s).then((e=>t.map(((t,r)=>({parentObjectId:t,attachmentInfos:e[r].data.attachmentInfos}))))).then((e=>a(e,a$1)))}return this.queryTask.executeAttachmentQuery(e,i)}async queryFeatures(e,t){return await this.load(),this.queryTask.execute(e,{...t,query:this._createRequestQueryOptions(t)})}async queryFeaturesJSON(e,t){return await this.load(),this.queryTask.executeJSON(e,{...t,query:this._createRequestQueryOptions(t)})}async queryObjectIds(e,t){return await this.load(),this.queryTask.executeForIds(e,{...t,query:this._createRequestQueryOptions(t)})}async queryFeatureCount(e,t){return await this.load(),this.queryTask.executeForCount(e,{...t,query:this._createRequestQueryOptions(t)})}async queryExtent(e,t){return await this.load(),this.queryTask.executeForExtent(e,{...t,query:this._createRequestQueryOptions(t)})}async queryRelatedFeatures(e,t){return await this.load(),this.queryTask.executeRelationshipQuery(e,{...t,query:this._createRequestQueryOptions(t)})}async queryRelatedFeaturesCount(e,t){return await this.load(),this.queryTask.executeRelationshipQueryForCount(e,{...t,query:this._createRequestQueryOptions(t)})}async queryTopFeatures(e,t){return await this.load(),this.queryTask.executeTopFeaturesQuery(e,{...t,query:this._createRequestQueryOptions(t)})}async queryTopObjectIds(e,t){return await this.load(),this.queryTask.executeForTopIds(e,{...t,query:this._createRequestQueryOptions(t)})}async queryTopExtents(e,t){return await this.load(),this.queryTask.executeForTopExtents(e,{...t,query:this._createRequestQueryOptions(t)})}async queryTopCount(e,t){return await this.load(),this.queryTask.executeForTopCount(e,{...t,query:this._createRequestQueryOptions(t)})}_createRequestQueryOptions(e){return {...this.layer.customParameters,token:this.layer.apiKey,...null==e?void 0:e.query}}async _fetchService(e){let t=this.layer.sourceJSON;if(!t){const{data:s$1}=await L(this.layer.parsedUrl.path,this._getLayerRequestOptions({query:s("featurelayer-advanced-symbols")?{returnAdvancedSymbols:!0}:{},signal:e}));t=s$1;}this.sourceJSON=this._patchServiceJSON(t);const s$2=t.type;if(!I.has(s$2))throw new s$1("feature-layer-source:unsupported-type",`Source type "${s$2}" is not supported`)}_patchServiceJSON(e){var t;if("Table"!==e.type&&e.geometryType&&(null==e||null==(t=e.drawingInfo)||!t.renderer)&&!e.defaultSymbol){const t=u(e.geometryType).renderer;o$1("drawingInfo.renderer",t,e);}return "esriGeometryMultiPatch"===e.geometryType&&e.infoFor3D&&(e.geometryType="mesh"),e}_serializeFeature(e){const{geometry:t$1,attributes:r}=e;return t(t$1)?{attributes:r}:"mesh"===t$1.type||"extent"===t$1.type?null:{geometry:t$1.toJSON(),attributes:r}}async _serializeAttachment(e){const{feature:t,attachment:r}=e,{globalId:s,name:a,contentType:i,data:o,uploadId:u}=r,n={globalId:s,parentGlobalId:null,contentType:null,name:null,uploadId:null,data:null};if(t&&(n.parentGlobalId="attributes"in t?t.attributes&&t.attributes[this.layer.globalIdField]:t.globalId),u)n.uploadId=u;else if(o){const e=await _(o);n.contentType=e.mediaType,n.data=e.data,o instanceof File&&(n.name=o.name);}return a&&(n.name=a),i&&(n.contentType=i),n}_getFeatureIds(e,t){const r=e[0];return r?this._canUseGlobalIds(t,e)?this._getGlobalIdsFromFeatureIdentifier(e):"objectId"in r?this._getObjectIdsFromFeatureIdentifier(e):this._getIdsFromFeatures(e):[]}_getIdsFromFeatures(e){const t=this.layer.objectIdField;return e.map((e=>e.attributes&&e.attributes[t]))}_canUseGlobalIds(e,t){return e&&"globalId"in t[0]}_getObjectIdsFromFeatureIdentifier(e){return e.map((e=>e.objectId))}_getGlobalIdsFromFeatureIdentifier(e){return e.map((e=>e.globalId))}_createEditsResult(e){var t;const r=e.data,{layerId:s}=this.layer,a=[];let i=null;if(Array.isArray(r))for(const n of r)a.push({id:n.id,editedFeatures:n.editedFeatures}),n.id===s&&(i={addResults:n.addResults,updateResults:n.updateResults,deleteResults:n.deleteResults,attachments:n.attachments,editMoment:n.editMoment});else i=r;const o=null==(t=i)?void 0:t.attachments,u={addFeatureResults:i.addResults?i.addResults.map(this._createFeatureEditResult,this):[],updateFeatureResults:i.updateResults?i.updateResults.map(this._createFeatureEditResult,this):[],deleteFeatureResults:i.deleteResults?i.deleteResults.map(this._createFeatureEditResult,this):[],addAttachmentResults:o&&o.addResults?o.addResults.map(this._createFeatureEditResult,this):[],updateAttachmentResults:o&&o.updateResults?o.updateResults.map(this._createFeatureEditResult,this):[],deleteAttachmentResults:o&&o.deleteResults?o.deleteResults.map(this._createFeatureEditResult,this):[]};if(i.editMoment&&(u.editMoment=i.editMoment),a.length>0){u.editedFeatureResults=[];for(const e of a){const{adds:t,updates:r,deletes:s,spatialReference:a}=e.editedFeatures,i=a?new k(a):null;u.editedFeatureResults.push({layerId:e.id,editedFeatures:{adds:(null==t?void 0:t.map((e=>this._createEditedFeature(e,i))))||[],updates:(null==r?void 0:r.map((e=>({original:this._createEditedFeature(e[0],i),current:this._createEditedFeature(e[1],i)}))))||[],deletes:(null==s?void 0:s.map((e=>this._createEditedFeature(e,i))))||[],spatialReference:i}});}}return u}_createEditedFeature(e,r){return new h({attributes:e.attributes,geometry:p({...e.geometry,spatialReference:r})})}_createFeatureEditResult(e){const t=!0===e.success?null:e.error||{code:void 0,description:void 0};return {objectId:e.objectId,globalId:e.globalId,error:t?new s$1("feature-layer-source:edit-failure",t.description,{code:t.code}):null}}_createAttachmentErrorResult(e,t){const r=t.details.messages&&t.details.messages[0]||t.message,s=t.details.httpStatus||t.details.messageCode;return {objectId:e,globalId:null,error:new s$1("feature-layer-source:attachment-failure",r,{code:s})}}_getFormDataForAttachment(e,t){const r=e instanceof FormData?e:e&&e.elements?new FormData(e):null;if(r)for(const s in t){const e=t[s];null!=e&&(r.set?r.set(s,e):r.append(s,e));}return r}_getLayerRequestOptions(e={}){const{parsedUrl:t,gdbVersion:r,dynamicDataSource:s}=this.layer;return {...e,query:{gdbVersion:r,layer:s?JSON.stringify({source:s}):void 0,...t.query,f:"json",...this._createRequestQueryOptions(e)},responseType:"json"}}};e([y()],O.prototype,"type",void 0),e([y({constructOnly:!0})],O.prototype,"layer",void 0),e([y({readOnly:!0})],O.prototype,"queryTask",null),O=e([n("esri.layers.graphics.sources.FeatureLayerSource")],O);var j=O;

export default j;
